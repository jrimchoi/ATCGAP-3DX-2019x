define("DS/XCTInfServiceProxy/XCTInfServiceProxy",["UWA/Core","UWA/Class/Promise","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI","DS/XCTInfUtilsWeb/XCTLogger"],function(d,f,a,h,i,b){var j,g,c;var k={};var e={};e.getTenantId=function(){if(window.widget){var l=window.widget.getValue("tenantId");return l||window.widget.getValue("x3dPlatformId")}else{return"OnPremise"}};e.isCloudEnv=function(){var l=e.getTenantId();return l!==undefined&&l!=="OnPremise"};e.retrievePlatformUrl=function(){if(!j){var l=f.deferred();a.getServiceUrl({serviceName:"3DSpace",platformId:e.getTenantId(),onComplete:function(n){var p=d.Utils.parseUrl(n);var m=p.port;p.port="0";var o=d.Utils.composeUrl(p).replace(":0",":"+m);l.resolve(o)},onFailure:function(){j=undefined;g=undefined;c=undefined;l.reject("Failed to retrieve platform URI")}});j=l.promise}return j};e.retrieveDashboardUrl=function(){return e.retrieveServiceUrl("3DDashboard")};e.retrieveHypervisorServiceUrl=function(l){return e.retrieveServiceUrl(l).then(function(m){if(m){return m.replace(/(^\w+:|^)\/\//,"")+"/hypervisor"}return f.reject(new Error("Warning: Url could not be discovered!"))})};e.retrieveServiceUrl=function(n){var l=k[n];if(!l){var m=f.deferred();l=m.promise;k[n]=m.promise;a.getServiceUrl({serviceName:n,platformId:e.getTenantId(),onComplete:m.resolve,onFailure:function(){k[n]=undefined;m.reject("Failed to retrieve URI for service "+n)}})}return l};e.retrieveDataPrepRunUrl=function(){return e.retrieveHypervisorServiceUrl("datapreprun")};e.retrieveRaaSUrl=function(){return e.retrieveHypervisorServiceUrl("3drendering")};e.retrieveEmUrl=function(){return e.retrieveHypervisorServiceUrl("experiencemodeling")};e.retrieveLprUrl=function(){return e.retrieveHypervisorServiceUrl("3dlpr")};e.retrieveDataPrepAuthoringUrl=function(){return e.retrieveServiceUrl("dataprepauthoring").then(function(l){if(l){return"https://"+l.replace(/(^\w+:|^)\/\//,"")+"/3drdfpersist/"}return f.reject(new Error("Warning: DataPrepAuthoring URL not discovered!"))})};e.retrieveCollabSpaces=function(){if(!g){g=e.retrievePlatformUrl().then(function(n){var l=f.deferred();var o=d.Utils.parseUrl(n);var m=d.Utils.composeUrl(o)+"/resources/bps/cspaces";if(e.isCloudEnv()){m+="/?tenant="+encodeURIComponent(e.getTenantId().trim())}h.authenticatedRequest(m,{method:"GET",type:"json",onComplete:function(p){var q=p.hasOwnProperty("cspaces")?p.cspaces.concat():[];l.resolve(q)},onFailure:function(){l.reject("Failed to retrieve collab spaces.")}});return l.promise})}return g};e.addCollabSpacesToWidget=function(l,n,m){if(!c){l=l||"context";m=m||function(){return true};c=e.retrieveCollabSpaces().then(function(r){var q;var p=r.filter(m).map(function(s){q=s.name;return{label:s.displayName,value:s.name}});var o={type:"list",name:l,label:n||"CollabSpace",options:p,defaultValue:q};window.widget.addPreference(o);return window.widget.getValue(l)})}return c};e.getSelectedCollabSpace=function(l){return e.addCollabSpacesToWidget(l)};e.retrieveLoginTicket=function(l){return e.retrievePlatformUrl().then(function(o){var m=f.deferred();var n=o+"/ticket/get?";n+="runasctx="+encodeURIComponent(l.context?l.context.trim():"preferred");var p=o;p+="/resources/modeler/pno/person?current=true&select=preferredcredentials";if(e.isCloudEnv()){n+="&tenant="+encodeURIComponent(e.getTenantId().trim());p+="&tenant="+encodeURIComponent(e.getTenantId().trim())}b.log("url :"+n);h.proxifiedRequest(p,{method:"GET",type:"json",proxy:"passport",onComplete:function(q){b.log("onComplete response:");b.log(q);h.proxifiedRequest(n,{headers:{Accept:"application/json","Accept-Language":null},method:"GET",type:"json",proxy:"passport",onComplete:function(r){b.log("loginTicket: "+r.ticket);m.resolve(r.ticket)},onFailure:function(r){b.log(r);m.reject("Failed to retrieve login ticket")}})}});return m.promise})};e.getUser=function(){b.log("*** getting user ***");return e.retrievePlatformUrl().then(function(n){var l=f.deferred();var m=n;m+="/resources/modeler/pno/person?current=true&select=preferredcredentials";if(e.isCloudEnv()){m+="&tenant="+encodeURIComponent(e.getTenantId().trim())}b.log("url :"+m);h.proxifiedRequest(m,{method:"GET",type:"json",proxy:"passport",onComplete:function(o){l.resolve(o)}});return l.promise})};e.getSessionId=function(){if(this.sessionId){return this.sessionId}var l=i.getUser();if(!l){l={login:"user"+Date.now()}}this.sessionId=l.login+"_"+e.getTenantId();if(this._appSpecificSettings&&this._appSpecificSettings.csiClientName){this.sessionId=this.sessionId+"_"+this._appSpecificSettings.csiClientName}else{b.warn("CSI client name is not set up. On app initialization phase call setApplicationSpecificSettings method of XCTInfServiceProxy with object containing csiClientName")}return this.sessionId};e.getProductIds=function(l){return e.retrievePlatformUrl().then(function(n){var u=f.deferred();var t=e.isCloudEnv();var r,s="";s="(physicalid=='"+l+"')";r="&where="+encodeURIComponent(s);var m="type=*"+r;var p="select=name&select=revision&select=type";var q=t?"/resources/v1/model/":"/resources/v0/model/";var o=n+q+"bus?"+m+"&"+p;if(t){o+="&tenant="+encodeURIComponent(e.getTenantId().trim())}h.authenticatedRequest(o,{method:"GET",type:"json",onComplete:function(v){u.resolve(v.results)},onFailure:function(){u.reject()}});return u.promise})};e.getPhysicalId=function(m,n,l){return e.retrievePlatformUrl().then(function(q){var o=f.deferred();var s="type="+n+"&name="+m+"&revision="+l;var p="select=physicalid";var u=e.isCloudEnv();var t=u?"/resources/v1/model/":"/resources/v0/model/";var r=q+t+"bus?"+s+"&"+p;if(u){r+="&tenant="+encodeURIComponent(e.getTenantId().trim())}h.authenticatedRequest(r,{method:"GET",type:"json",onComplete:function(v){o.resolve(v.results)},onFailure:function(){o.reject()}});return o.promise})};e.retrieveTransientToken=function(l){return new f(function(o,n){var m=i.getApplicationConfiguration("app.urls.passport")+"/api/authenticated/cas/transient?service=";m+=encodeURIComponent("https://"+l.serviceUrl);if(e.isCloudEnv()){m+="&tenant="+encodeURIComponent(e.getTenantId().trim())}h.authenticatedRequest(m,{method:"GET",type:"json",onComplete:function(p){o(d.extend({x3ds_service_url:l.serviceUrl},p))},onFailure:n})})};e.isPhysicalProduct=function(l){return e.retrievePlatformUrl().then(function(o){const r=encodeURIComponent(l.name);var m="type=$1&name=$2&revision=$3";var n=m.replace("$1","VPMReference").replace("$2",r).replace("$3",l.revision);var p="select=physicalid";var u=e.isCloudEnv();var q=u?"/resources/v1/model/":"/resources/v0/model/";var s=o+q+"bus?"+n+"&"+p;if(u){s+="&tenant="+encodeURIComponent(e.getTenantId().trim())}var t=f.deferred();h.authenticatedRequest(s,{method:"GET",type:"json",onComplete:function(v){t.resolve(v.results.length>0)},onFailure:function(){t.reject(new Error("Failed to query 3DSpace"))}});return t.promise})};e.getThumbnailsInfosByPhysicalIds=function(l){if(!l||l.length===0){return f.reject(new Error())}return e.retrievePlatformUrl().then(function(n){var m=n+"/resources/enocsmrest/collabspaces/any/contents/previews?ids="+l.join(",");if(e.isCloudEnv()){m+="&tenant="+encodeURIComponent(e.getTenantId().trim())}return new f(function(p,o){h.authenticatedRequest(m,{method:"GET",type:"json",onComplete:function(q){p(q)},onFailure:function(q){o(q)}})})})};e.setApplicationSpecificSettings=function(l){if(!this._appSpecificSettings){this._appSpecificSettings={}}this._appSpecificSettings=d.extend({csiClientName:this._appSpecificSettings.csiClientName},l)};e.addTenantIdToWidget=function(){const l=e.getTenantId();window.widget.addPreference({type:"text",name:l,label:"Platform",defaultValue:l,disabled:true})};return e});