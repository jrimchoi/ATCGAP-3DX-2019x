define("DS/VisuUnstreamers/CGRUnstreamTask",["UWA/Class","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/VisuLoaders/CGRReader"],function(b,d,c,h){var e=null;var a=0;var i=[];var g=[];var f=b.extend({init:function(k,j){this.streamObject=k;this.targetNode=j;this.contextID=a++;i[this.contextID]={so:this.streamObject,target:this.targetNode};return this},run:function(o,j,l,k){i[this.contextID].cbProgress=o;i[this.contextID].cbError=l;i[this.contextID].cbDone=j;i[this.contextID].options=k;i[this.contextID].modelLoaded=false;var m=this;if(!this.targetNode){console.error("CGRUnstreamTask execution failed : target node undefined !");return}var n={launched:false};g[this.contextID]=n;if(e===null){e=new h()}if(e){this.internalLoad()}},internalLoad:function(){for(var j in g){if(g[j].launched===false){g[j].launched=true;this.loadCGR(j)}}},loadCGR:function(k){var m=i[k].so;var l=i[k].options;l.isBuffer=true;var j={readyCallback:i[this.contextID].cbProgress,errorCallback:i[this.contextID].cbError,doneCallback:i[this.contextID].cbDone};m.open();m.readAsArrayBuffer(function(n){e.load(n,j,l)})}});return UWA.namespace("THREEDS/CGRUnstreamTask",f)});define("VisuUnstreamers/CGRUnstreamTask",["DS/VisuUnstreamers/CGRUnstreamTask","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuUnstreamers/CGRUnstreamTask");return b});define("DS/VisuUnstreamers/UnstreamTaskDriver",["UWA/Class"],function(b){var a=b.singleton({init:function(){return this},getTask:function(g,e,c,f){var d="DS/VisuUnstreamers/"+g+"UnstreamTask";require([d],function(i){var h=new i(e,c);if(f){f(h)}})}});return UWA.namespace("THREEDS/UnstreamTaskDriver",a)});define("VisuUnstreamers/UnstreamTaskDriver",["DS/VisuUnstreamers/UnstreamTaskDriver","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuUnstreamers/UnstreamTaskDriver");return b});define("DS/VisuUnstreamers/StreamObject",["UWA/Class"],function(b){var a=b.extend({init:function(c,d){this.blob=c;this.filename=d;if(this.blob&&!this.blob.userData){this.blob.userData={}}return this},open:function(){},close:function(){},getUserData:function(){return this.blob?this.blob.userData:null},readAsArrayBuffer:function(){},readAsBlob:function(){},readAsText:function(){},readAsXML:function(){}});return UWA.namespace("THREEDS/StreamObject",a)});define("VisuUnstreamers/StreamObject",["DS/VisuUnstreamers/StreamObject","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuUnstreamers/StreamObject");return b});define("DS/VisuUnstreamers/FileInZipStreamObject",["DS/VisuUnstreamers/StreamObject","WebappsUtils/WebappsUtils","DS/ZipJS/zip-fs"],function(b,f,d){var e=2;var g=0;var a=[];var c=b.extend({init:function(h,i){this._parent(h,i);d.workerScriptsPath=f.getWebappsBaseUrl()+"ZipJS/";return this},open:function(){},close:function(){},read:function(l,i){var k=this;var m=function(){if(!k.blob.waitingEntries){k.blob.waitingEntries=[]}k.blob.waitingEntries.push({cb:l,type:i,context:k})};if(this.blob.zipEntries===undefined){this.blob.zipEntries="Loading";m();var h=new d.fs.FS();h.importBlob(this.blob,function(){k.blob.zipEntries=h;for(var o=0;o<k.blob.waitingEntries.length;o++){var n=k.blob.waitingEntries[o];n.context.read(n.cb,n.type)}})}else{if(this.blob.zipEntries==="Loading"){m()}else{var j=this.blob.zipEntries.find(this.filename);if(j){this._unzipData(j,i,l)}else{console.warn({msg:"Missing "+this.filename+" in the zip.",zip:this.blob.zipEntries});if(l){l(null)}}}}},readAsArrayBuffer:function(h){this.read(h,"arraybuffer")},readAsBlob:function(h){this.read(h,"blob")},readAsText:function(h){this.read(h,"text")},readAsXML:function(h){this.read(h,"xml")},_unzipData:function(k,h,j){var i=this;if(g<e){g++;if(h==="text"||h==="xml"){k.getText(function(l){i._popUnzipItem();if(j){if(h==="text"){j(l.target.result)}else{j(new DOMParser().parseFromString(l.target.result,"text/xml"))}}})}else{if(h==="arraybuffer"||h==="blob"){k.getBlob("text/plain",function(m){i._popUnzipItem();if(j){if(h==="arraybuffer"){var l=new FileReader();l.onload=function(n){j(n.target.result)};l.readAsArrayBuffer(m)}else{j(m)}}})}else{console.error("Unknown type to read : "+h)}}}else{a.push({entry:k,type:h,onsuccess:j})}},_popUnzipItem:function(){g--;if(a.length>0){var h=a[0];this._unzipData(h.entry,h.type,h.onsuccess);a.splice(0,1)}}});return UWA.namespace("THREEDS/FileInZipStreamObject",c)});define("VisuUnstreamers/FileInZipStreamObject",["DS/VisuUnstreamers/FileInZipStreamObject","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuUnstreamers/FileInZipStreamObject");return b});define("DS/VisuUnstreamers/BufferStreamObject",["UWA/Class","DS/VisuUnstreamers/StreamObject"],function(b,a){var c=a.extend({init:function(d,e){this._parent(d,e);return this},open:function(){},close:function(){},readAsArrayBuffer:function(f){var e;var d=new FileReader();d.onload=function(){e=this.result;if(f){f(e)}};d.readAsArrayBuffer(this.blob)}});return UWA.namespace("THREEDS/BufferStreamObject",c)});define("VisuUnstreamers/BufferStreamObject",["DS/VisuUnstreamers/BufferStreamObject","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuUnstreamers/BufferStreamObject");return b});define("DS/VisuUnstreamers/XMLMeshUnstreamTask",["UWA/Class","WebappsUtils/WebappsUtils","UWA/Utils","DS/Visualization/Utils","DS/VisuUnstreamers/UnstreamTaskDriver","DS/VisuUnstreamers/FileInZipStreamObject","DS/Mesh/MeshUtils","DS/Visualization/MaterialManager","DS/Visualization/Mesh3D"],function(b,e,k,c,j,g,d){var l=null;var m=false;var a=0;var i=[];var h=[];var f=false;var n=b.extend({init:function(p,o){this.streamObject=p;this.targetNode=o;this.contextID=a++;i[this.contextID]={so:this.streamObject,target:this.targetNode};return this},run:function(r,x,v){i[this.contextID].cbSuccess=x;i[this.contextID].cbError=v;i[this.contextID].cbProgress=r;i[this.contextID].nbMaterials=0;i[this.contextID].remainingMaterials=0;i[this.contextID].modelLoaded=false;console.log("running XMLMeshUnstreamTask");var t=this;if(!this.targetNode){console.error("XMLMeshUnstreamTask execution failed : target node undefined !");return}var p={launched:false};h[this.contextID]=p;if(l===null&&!f){f=true;var u=!k.matchUrl(e.getWebappsBaseUrl(),window.location)?"Passport":null;var w={provider:"FILE",filename:"AmdLoader.js",serverurl:e.getWebappsBaseUrl()+"AmdLoader/",requiredAuth:u};var q={provider:"FILE",filename:"EasySax.js",serverurl:e.getWebappsBaseUrl()+"EasySax/",requiredAuth:u};var o={provider:"FILE",filename:"ThreeJS_Base.js",serverurl:e.getWebappsBaseUrl()+"Mesh/",requiredAuth:u};var z={provider:"FILE",filename:"Mesh.js",serverurl:e.getWebappsBaseUrl()+"Mesh/",requiredAuth:u};var y={provider:"FILE",filename:"XMLV43Worker.js",serverurl:e.getWebappsBaseUrl()+"Workers/",requiredAuth:u};var s=[w,q,o,z,y];c.getWorkerFromSpecs(s,function(A){l=A;l.onmessage=function(I){var E=I.data;if(E.loaded){if(!m){m=true;t.internalLoad()}}else{var K=E.contextID;var B=null;if(E.rep.length>0){var C=[];for(var F=0;F<E.rep.length;F++){var J=E.rep[F];for(var D=0;D<J.drawingGroups.length;D++){var H=J.drawingGroups[D].material;if((H!==null)&&(H.file!=="")){C.push({dg:J.drawingGroups[D],name:H.file})}}}i[K].nbMaterials=C.length;i[K].remainingMaterials=C.length;for(var F=0;F<C.length;F++){var L=C[F];var G=new g(i[K].so.blob,L.name);j.getTask("XMLMaterial",G,null,function(M){return function(N){N.materialRefId=M.material.id;N.run(null,function(P){M.material=P;var O=i[K];O.remainingMaterials--;if(O.cbProgress){O.cbProgress({material:P,loaded:O.nbMaterials-O.remainingMaterials,total:O.nbMaterials})}if(!O.remainingMaterials&&O.modelLoaded&&O.cbSuccess){O.cbSuccess(B,true)}})}}(L.dg))}B=d.convertTo3js(E.rep)}else{B=d.createEmptyMesh()}i[K].target.add(B);i[K].so.close();if(i[K].cbSuccess){i[K].modelLoaded=true}delete h[K];t.internalLoad()}}})}else{if(m){this.internalLoad()}}},internalLoad:function(){for(var o in h){if(h[o].launched===false){h[o].launched=true;this.workerLoaded(o)}}},workerLoaded:function(o){var p=i[o].so;p.open();p.readAsText(function(q){l.postMessage({path:q,contextID:o})})}});return UWA.namespace("THREEDS/XMLMeshUnstreamTask",n)});define("VisuUnstreamers/XMLMeshUnstreamTask",["DS/VisuUnstreamers/XMLMeshUnstreamTask","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuUnstreamers/XMLMeshUnstreamTask");return b});define("DS/VisuUnstreamers/XMLMaterialUnstreamTask",["UWA/Class","WebappsUtils/WebappsUtils","DS/VisuUnstreamers/FileInZipStreamObject","DS/Mesh/MeshUtils","DS/Visualization/MaterialManager"],function(c,g,d,h,b){var e=0;var a=false;var f=c.extend({init:function(j,k){this.id=e++;this.streamObject=j;this.materialLibrary=k;this.materialRefId=-1;var i=this.streamObject?this.streamObject.getUserData():null;if(i&&!i.materialLibraryFiles){i.materialLibraryFiles={};i.graphicMaterialFiles={};i.imageLibraryFiles={};i.imageFiles={}}return this},run:function(n,j,l){if(this.materialRefId===-1){return}if(a){console.log("("+this.id+") running XMLMaterialUnstreamTask : materialRef <"+this.streamObject.filename+"> - id <"+this.materialRefId+">")}var m=this;var i=this.streamObject.getUserData();var k=i.materialLibraryFiles[this.streamObject.filename];if(!k){i.materialLibraryFiles[this.streamObject.filename]={state:"pending",tasks:[]};this.streamObject.open();if(a){console.log("("+this.id+") begin read material library "+this.streamObject.filename+" as XML")}this.streamObject.readAsXML(function(r){m.streamObject.close();if(a){console.log("("+m.id+") parse material library "+m.streamObject.filename)}var q=i.materialLibraryFiles[m.streamObject.filename];i.materialLibraryFiles[m.streamObject.filename]=m.parseMaterialReference(r);for(var p=0;p<q.tasks.length;p++){var o=q.tasks[p];if(a){console.log("("+o.task.id+") task start again after material library read (relaunched by task ("+m.id+"))")}o.cb.apply(o.task,o.args)}m.loadGraphicMaterial(n,j)})}else{if(k.state==="pending"){if(a){console.log("("+this.id+") task waiting for material library: "+m.streamObject.filename)}k.tasks.push({task:this,cb:this.loadGraphicMaterial,args:[n,j]})}else{this.loadGraphicMaterial(n,j)}}},parseMaterialReference:function(x){var w={};var s=x.firstChild;if(s.nodeName!=="Model_3dxml"){return}for(var t=0;t<s.childNodes.length;t++){var n=s.childNodes[t];if(n.nodeName=="CATMaterialRef"){for(var q=0;q<n.childNodes.length;q++){var u=n.childNodes[q];if((u.nodeName!=="CATMatReference")&&(u.nodeName!=="MaterialDomainInstance")&&(u.nodeName!=="MaterialDomain")){continue}var m=u.getAttribute("id");var l=u.getAttribute("name");switch(u.nodeName){case"CATMatReference":if(w[m]!==undefined){w[m].name=l}else{w[m]={name:l}}break;case"MaterialDomainInstance":var v=0;var z=0;for(var p=0;p<u.childNodes.length;p++){var r=u.childNodes[p];if(r.nodeName=="IsAggregatedBy"){v=r.textContent}else{if(r.nodeName=="IsInstanceOf"){z=r.textContent}}}w[m]={parent:v,instance:z};if(w[v]!==undefined){w[v].instance=m}else{w[v]={instance:m}}break;case"MaterialDomain":var o=u.getAttribute("associatedFile");var y=[];y=o.split("urn:3DXML:");o=y[1];if(w[m]!==undefined){w[m].filename=o}else{w[m]={filename:o}}break;default:break}}}}return w},loadGraphicMaterial:function(l,o){var n=this;var k=this.streamObject.getUserData();var p=k.materialLibraryFiles[this.streamObject.filename];var r=p[this.materialRefId];if(r===undefined){return null}var j=p[r.instance];if(j===undefined){return null}var q=p[j.instance];if(q===undefined){return null}if(q.filename){var i=k.graphicMaterialFiles[q.filename];if(!i){k.graphicMaterialFiles[q.filename]={state:"pending",tasks:[]};var m=new d(this.streamObject.blob,q.filename);m.open();if(a){console.log("("+this.id+") begin read material "+q.filename+" as XML")}m.readAsXML(function(v){m.close();if(a){console.log("("+n.id+") parse material "+q.filename)}var u=k.graphicMaterialFiles[q.filename];k.graphicMaterialFiles[q.filename]=n.parseGraphicMaterial(v);for(var t=0;t<u.tasks.length;t++){var s=u.tasks[t];if(a){console.log("("+s.task.id+") task start again after material read (relaunched by task ("+n.id+"))")}s.cb.apply(s.task,s.args)}n.loadRepresentationImage(q.filename,l,o)})}else{if(i.state==="pending"){if(a){console.log("("+this.id+") task waiting for material: "+q.filename)}i.tasks.push({task:this,cb:this.loadRepresentationImage,args:[q.filename,l,o]})}else{this.loadRepresentationImage(q.filename,l,o)}}}},parseGraphicMaterial:function(u){var o={type:"material3DXML"};o.shading="Phong";o.DiffuseMapWrap=[];o.DiffuseMapRepeat=[0,0];var q=u.firstChild;if(q.nodeName!=="Osm"){return}for(var r=0;r<q.childNodes.length;r++){var m=q.childNodes[r];if((m.nodeName=="Feature")&&(m.getAttribute("Alias")=="RenderingFeature")){for(var p=0;p<m.childNodes.length;p++){var s=m.childNodes[p];if(s.nodeName=="Attr"){var v=s.getAttribute("Type");var t=s.getAttribute("Value");var k=s.getAttribute("Name");switch(v){case"int":t=parseInt(t,10);o[k]=t;switch(k){case"WrappingModeU":if(t){o.DiffuseMapWrap[0]="repeat";o.DiffuseMapRepeat[0]=1}break;case"WrappingModeV":if(t){o.DiffuseMapWrap[1]="repeat";o.DiffuseMapRepeat[1]=1}break;case"PreviewType":var l=parseInt(t);switch(l){case 0:o.mappingFunction="SPHERICAL_ENV_MAP";break;case 2:o.mappingFunction="USER_MAPPING";break}break;default:break}break;case"double":switch(k){case"DiffuseColor":o.colorDiffuse=this.getColor(t);break;case"SpecularColor":o.colorSpecular=this.getColor(t);break;case"AmbientColor":o.colorAmbient=this.getColor(t);break;case"SpecularExponent":o.shininess=128*parseFloat(t);break;case"SpecularCoef":o.specularCoef=parseFloat(t);break;case"Reflectivity":o.reflectivityCoef=parseFloat(t);break;case"Transparency":o.transparency=parseFloat(t);o.transparent=(o.transparency>0);break;default:break}break;case"boolean":t=(t==="true");switch(k){case"AlphaTest":o.alphaTest=t?0.5:0;break;default:o[k]=t;break}break;case"external":var w=[];w=t.split("urn:3DXML:");t=w[1];w=t.split("#");t=w[0];var n=w[1];if(k=="TextureImage"){o.DiffuseMap={imageLib:t,id:n}}break;default:break}}}}}return o},loadRepresentationImage:function(i,n,s){var q=this;var k=this.streamObject.getUserData();var p=new b();var l=k.graphicMaterialFiles[i];var j=l.DiffuseMap;if(j&&j.imageLib){var m=k.imageLibraryFiles[j.imageLib];if(!m){k.imageLibraryFiles[j.imageLib]={state:"pending",tasks:[]};var o=new d(this.streamObject.blob,j.imageLib);o.open();if(a){console.log("("+this.id+") begin read image library "+j.imageLib+" as XML")}o.readAsXML(function(w){o.close();if(a){console.log("("+q.id+") parse image library "+o.filename)}var v=k.imageLibraryFiles[o.filename];k.imageLibraryFiles[o.filename]=q.parseRepresentationImage(w);for(var u=0;u<v.tasks.length;u++){var t=v.tasks[u];if(a){console.log("("+t.task.id+") task start again after image library read (relaunched by task ("+q.id+"))")}t.cb.apply(t.task,t.args)}q.loadImage(i,n,s)})}else{if(m.state==="pending"){if(a){console.log("("+this.id+") task waiting for image library "+j.imageLib)}m.tasks.push({task:this,cb:this.loadImage,args:[i,n,s]})}else{this.loadImage(i,n,s)}}}else{var r=p.getMaterial3DXML(l,"/","XMLV43");if(s){s(r)}}},parseRepresentationImage:function(u){var l={};var q=u.firstChild;if(q.nodeName!=="Model_3dxml"){return}for(var r=0;r<q.childNodes.length;r++){var n=q.childNodes[r];if(n.nodeName=="CATRepImage"){for(var p=0;p<n.childNodes.length;p++){var s=n.childNodes[p];if(s.nodeName=="CATRepresentationImage"){var m=s.getAttribute("id");var k=s.getAttribute("name");var t=s.getAttribute("format");var o=s.getAttribute("associatedFile");var v=o.split("urn:3DXML:");l[m]=v[1]}}}}return l},loadImage:function(i,o,s){var q=this;var k=this.streamObject.getUserData();var m=k.graphicMaterialFiles[i];var j=m.DiffuseMap;var r=k.imageLibraryFiles[j.imageLib][j.id];var n=k.imageFiles[r];if(!n){k.imageFiles[r]={state:"pending",tasks:[]};var p=new d(this.streamObject.blob,r);p.open();if(a){console.log("("+this.id+") begin read image "+r)}var u=/(?:\.([^.]+))?$/;var l=u.exec(r)[1];var t="blob";if(l=="dds"){p.readAsArrayBuffer(function(y){p.close();var x=k.imageFiles[r];k.imageFiles[r]=y;for(var w=0;w<x.tasks.length;w++){var v=x.tasks[w];if(a){console.log("("+v.task.id+") task start again after image read (relaunched by task ("+q.id+"))")}v.cb.apply(v.task,v.args)}m.DiffuseMap={filename:r,buffer:k.imageFiles[r]};q.createMaterial(i,o,s)})}else{p.readAsBlob(function(v){p.close();var y=k.imageFiles[r];k.imageFiles[r]=v;for(var x=0;x<y.tasks.length;x++){var w=y.tasks[x];if(a){console.log("("+w.task.id+") task start again after image read (relaunched by task ("+q.id+"))")}w.cb.apply(w.task,w.args)}q.createMaterial(i,r,o,s)})}}else{if(n.state==="pending"){if(a){console.log("("+this.id+") task waiting for image "+r)}n.tasks.push({task:this,cb:this.createMaterial,args:[i,r,o,s]})}else{this.createMaterial(i,r,o,s)}}},createMaterial:function(k,n,p,j){var o=new b();var i=this.streamObject.getUserData();var l=i.graphicMaterialFiles[k];l.DiffuseMap={filename:n,buffer:i.imageFiles[n]};var m=o.getMaterial3DXML(l,"/","XMLV43",null,j);if(p&&m.map){p(m)}},getColor:function(j){var l=[];var k=new RegExp(/\[([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*))\]/);var i=k.exec(j);if(i!=null){l[0]=parseFloat(RegExp.$1);l[1]=parseFloat(RegExp.$2);l[2]=parseFloat(RegExp.$3)}else{k=new RegExp(/\[([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*))\]/);i=k.exec(j);if(i!=null){l[0]=parseFloat(RegExp.$1);l[1]=parseFloat(RegExp.$2);l[2]=parseFloat(RegExp.$3);l[3]=parseFloat(RegExp.$4)}}return l}});return UWA.namespace("THREEDS/XMLMaterialUnstreamTask",f)});define("VisuUnstreamers/XMLMaterialUnstreamTask",["DS/VisuUnstreamers/XMLMaterialUnstreamTask","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuUnstreamers/XMLMaterialUnstreamTask");return b});