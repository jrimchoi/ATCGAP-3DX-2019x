/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationBaseCmds/panels/CAT3DAnnotationStandardsInfoPanel",["UWA/Core","UWA/Class","DS/Controls/Toggle","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/Tree/TreeListView","DS/Controls/Button","DS/Tree/TreeNodeModel","DS/CoreEvents/ModelEvents","DS/WebappsUtils/WebappsUtils","i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotStandardInfosPanel","text!DS/CAT3DAnnotationBaseCmds/assets/json/SemanticStandardsSymbols.json","css!DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationBaseCmds.css"],function(h,b,k,d,j,l,i,c,e,g,f){var a=b.extend({init:function(s){this._parent(s);var t,B,z,o,u,r,A;var w=[];var D;var E=new c();var p=JSON.parse(f);function C(I){var N=[];var J=I.length?null:I.children[0];var L,H,F,K,M,G;if(!J){for(L=0;L<I.length;L++){for(H=0;H<I[L].children.length;H++){J=I[L].children[H];if(J!==undefined&&J.semanticStandards!==undefined){for(F=0;F<J.semanticStandards.standards.length;F++){N.push({nameAnnot:J.name,code:J.semanticStandards.standards[F].code,title:J.semanticStandards.standards[F].title,year:J.semanticStandards.standards[F].year,standard:J.semanticStandards.stdName,namePart:I[L].name})}if(J.semanticStandards.defaultSpecs){for(K=0;K<J.semanticStandards.defaultSpecs.length;K++){G="";if(J.semanticStandards.defaultSpecs[K].symbols){for(M=0;M<J.semanticStandards.defaultSpecs[K].symbols.length;M++){if(p[J.semanticStandards.defaultSpecs[K].symbols[M]]){G=G+p[J.semanticStandards.defaultSpecs[K].symbols[M]].character}}}N.push({nameAnnot:J.name,code:J.semanticStandards.defaultSpecs[K].code,subtype:J.semanticStandards.defaultSpecs[K].subtype,type:J.semanticStandards.defaultSpecs[K].type,year:J.semanticStandards.defaultSpecs[K].year,standard:J.semanticStandards.stdName,symbols:G,namePart:I[L].name})}}}}}}else{if(J!==undefined&&J.semanticStandards!==undefined){for(F=0;F<J.semanticStandards.standards.length;F++){N.push({nameAnnot:J.name,code:J.semanticStandards.standards[F].code,title:J.semanticStandards.standards[F].title,year:J.semanticStandards.standards[F].year,standard:J.semanticStandards.stdName,namePart:I.name})}if(J.semanticStandards.defaultSpecs){for(K=0;K<J.semanticStandards.defaultSpecs.length;K++){G="";if(J.semanticStandards.defaultSpecs[K].symbols){for(M=0;M<J.semanticStandards.defaultSpecs[K].symbols.length;M++){if(p[J.semanticStandards.defaultSpecs[K].symbols[M]]){G=G+p[J.semanticStandards.defaultSpecs[K].symbols[M]].character}}}N.push({nameAnnot:J.name,code:J.semanticStandards.defaultSpecs[K].code,subtype:J.semanticStandards.defaultSpecs[K].subtype,type:J.semanticStandards.defaultSpecs[K].type,year:J.semanticStandards.defaultSpecs[K].year,standard:J.semanticStandards.stdName,symbols:G,namePart:I.name})}}}}return N}function x(M,Q){o=C(M);var K=[];var P;var F="";switch(Q){case"0":var G;var J=[];var N;var L;for(P=0;P<o.length;P++){if(o[P]){G=o[P].namePart+" / "+o[P].nameAnnot;F=o[P].symbols||"";if(J.indexOf(G)!==-1){N=new i({label:" ",icons:null,grid:{name:" ",code:o[P].code,title:o[P].title?o[P].title:g[o[P].type]+" "+g[o[P].subtype],year:o[P].year}});N.symbols=F;K[J.indexOf(G)].addChild(N)}else{N=new i({label:G,icons:null,grid:{name:G,standard:o[P].standard,}});L=new i({label:" ",icons:null,grid:{name:" ",code:o[P].code,title:o[P].title,year:o[P].year}});L.symbols=F;N.addChild(L);K.push(N);J.push(G)}}}break;case"1":var I;var O=[];for(P=0;P<o.length;P++){if(o[P]){I=o[P].code;F=o[P].symbols||"";if(O.indexOf(I)!==-1){N=new i({label:" ",icons:null,grid:{code:" ",name:o[P].namePart+" / "+o[P].nameAnnot,title:o[P].title?o[P].title:g[o[P].type]+" "+g[o[P].subtype],year:o[P].year}});N.symbols=F;K[O.indexOf(I)].addChild(N)}else{N=new i({label:I,icons:null,grid:{code:I,standard:o[P].standard,}});L=new i({label:" ",icons:null,grid:{code:" ",name:o[P].namePart+" / "+o[P].nameAnnot,title:o[P].title,year:o[P].year}});L.symbols=F;N.addChild(L);K.push(N);O.push(I)}}w.push(N)}break;case"2":var H;var R=[];for(P=1;P<o.length;P++){if(o[P]){H=o[P].standard;F=o[P].symbols||"";if(R.indexOf(H)!==-1){N=new i({label:" ",icons:null,grid:{name:o[P].namePart+" / "+o[P].nameAnnot,code:o[P].code,title:o[P].title?o[P].title:g[o[P].type]+" "+g[o[P].subtype],year:o[P].year}});N.symbols=F;K[R.indexOf(H)].addChild(N)}else{N=new i({label:H,icons:null,grid:{standard:H,}});L=new i({label:" ",icons:null,grid:{name:o[P].namePart+" / "+o[P].nameAnnot,code:o[P].code,title:o[P].title,year:o[P].year}});L.symbols=F;N.addChild(L);K.push(N);R.push(H)}}w.push(N)}break;default:break}w=K;return K}var q=function(G){for(var F=0;F<w.length;F++){if(w[F]){G?w[F].expand():w[F].collapse()}}};var v=function(G,F){return E.publish({event:G,data:F,context:this})};function n(F){var H=F.cellView.getParent().getManager().getTreeNodeModelFromRowID(F.cellModel.getRowID());var G;if(F.dataIndex==="title"&&F.view.innerHTML&&H.symbols){G=h.createElement("p",{"class":"CAT3DAnnotSymbol"});G.innerHTML=H.symbols;if(H.symbols[0]==="&"){G.setStyle("font-family","DSISO1")}if(G.innerHTML&&G.innerHTML!==" "){G.inject(F.view)}}}function m(J,G){if(t){t.destroy();t=null}var I=j.SETTINGS.STANDARD;I.height="auto";I.width=800;I.show.rowHeaders=false;I.selection.preSelection=true;I.performances.renderingMode="standard";I.enableActiveUI=true;I.enableKeyboardNavigation=true;I.defaultCellHeight=34;I.enableDragAndDrop=false;I.onContextualEvent={callback:function(K){if(!K.treeview.nodeModel){return undefined}else{if(K.treeview.virtualRowID===-1){return[{type:"PushItem",title:g.Autofit,action:{callback:function(){K.treeview.manager.sizeColumnToFit(K.treeview.dataIndex)}}}]}}return[{type:"PushItem",title:g.ExpandAll,action:{callback:function(){q(true)}}},{type:"PushItem",title:g.CollapseAll,action:{callback:function(){q(false)}}}]}};if(G==="0"){I.columns=[{text:"Name",dataIndex:"tree",width:D.columnSize.name,isSortable:true,isDraggable:false,isEditable:false},{text:"Standard",dataIndex:"standard",width:D.columnSize.standard,isSortable:true,isDraggable:false,isEditable:false},{text:"Code",dataIndex:"code",width:D.columnSize.code,isSortable:true,isDraggable:false,isEditable:false},{text:"Year",dataIndex:"year",width:D.columnSize.year,isSortable:true,isDraggable:false,isEditable:false},{text:"Title",dataIndex:"title",width:D.columnSize.title,isSortable:false,isDraggable:false,isEditable:false,isResizable:true},]}else{if(G==="1"){I.columns=[{text:"Code",dataIndex:"tree",width:D.columnSize.code,isSortable:true,isDraggable:false,isEditable:false},{text:"Name",dataIndex:"name",width:D.columnSize.name,isSortable:true,isDraggable:false,isEditable:false},{text:"Standard",dataIndex:"standard",width:D.columnSize.standard,isSortable:true,isDraggable:false,isEditable:false},{text:"Year",dataIndex:"year",width:D.columnSize.year,isSortable:true,isDraggable:false,isEditable:false},{text:"Title",dataIndex:"title",width:D.columnSize.title,isSortable:false,isDraggable:false,isEditable:false,isResizable:true},]}else{I.columns=[{text:"Standard",dataIndex:"tree",width:D.columnSize.standard,isSortable:true,isDraggable:false,isEditable:false},{text:"Name",dataIndex:"name",width:D.columnSize.name,isSortable:true,isDraggable:false,isEditable:false},{text:"Code",dataIndex:"code",width:D.columnSize.code,isSortable:true,isDraggable:false,isEditable:false},{text:"Year",dataIndex:"year",width:D.columnSize.year,isSortable:true,isDraggable:false,isEditable:false},{text:"Title",dataIndex:"title",width:D.columnSize.title,isSortable:false,isDraggable:false,isEditable:false,isResizable:true},]}}z=I.columns;t=new j(I);var F=x(J,G);for(var H=0;H<F.length;H++){t.addRoot(F[H])}if(F.length===1){t.getRoots()[0].expand()}t.getManager().onCellRequest(n);t.getManager().onColumnWidthUpdate(function(){switch(D.groupBy){case"0":D.columnSize={name:z[0].width,standard:z[1].width,code:z[2].width,year:z[3].width,title:z[4].width};break;case"1":D.columnSize={name:z[1].width,standard:z[2].width,code:z[0].width,year:z[3].width,title:z[4].width};break;case"2":D.columnSize={name:z[1].width,standard:z[0].width,code:z[2].width,year:z[3].width,title:z[4].width};break;default:break}v("onPreferenceModified",D)});return t}function y(F,G){D.groupBy=F;v("onPreferenceModified",D);t=m(G,D.groupBy);t.inject(B)}this.buildPanel=function(K,F,J){this.cleanPanel();A=K;D=JSON.parse(F);u=h.createElement("div",{id:"CAT3DAnnotInfoMainDiv","class":"CAT3DAnnotInfoMainDiv"});B=h.createElement("div",{"class":"CAT3DAnnotStdInfoTreeDiv"});var G=h.createElement("div",{"class":"CAT3DAnnotStdInfoRadioDiv"});var M=new k({type:"label",label:g.RadioLabel}).inject(G);var H=new k({type:"radio",value:"option1",label:g.RadioButtonName,checkFlag:D.groupBy==="0"}).inject(G);var L=new k({type:"radio",value:"option2",label:g.RadioButtonCode,checkFlag:D.groupBy==="1"}).inject(G);var I=new k({type:"radio",value:"option3",label:g.RadioButtonStandard,checkFlag:D.groupBy==="2"}).inject(G);if(J){r=new l({label:g.ShowAllButton,onClick:function(){v("onShowAllClick")}}).inject(G);r.getContent().setStyles({"margin-left":"320px",display:"inline-block"})}M.getContent().setStyle("display","inline-block");H.getContent().setStyles({"margin-left":"20px",display:"inline-block"});L.getContent().setStyles({"margin-left":"20px",display:"inline-block"});I.getContent().setStyles({"margin-left":"20px",display:"inline-block"});G.inject(u);H.addEventListener("buttonclick",function(){y("0",A)});L.addEventListener("buttonclick",function(){y("1",A)});I.addEventListener("buttonclick",function(){y("2",A)});t=m(K,D.groupBy);t.inject(B);B.inject(u);return u};this.updatePanel=function(F){A=F;if(r){r.getContent().setStyle("display","none")}t=m(F,D.groupBy);t.inject(B);B.inject(u);return u};this.cleanPanel=function(){if(t){t.destroy()}t=B=z=o=u=D=null;w.length=0};this.subscribe=function(G,F){if(!G||!F){return undefined}return E.subscribe({event:G},F)};this.unsubscribe=function(F){if(F===null||F===undefined){return}E.unsubscribe(F)}}});return a});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotStandardsInfoCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(a,b){var c=a.extend({init:function(e){this.beginExecute=function(){};var d=this._destroy;this._destroy=function(){}}});return c});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationBaseCmds",[],function(){});define("DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotSwitchOnOffController",["UWA/Class","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader"],function(a,c){var b=a.extend({init:function(h){this._parent(h);var h=h||{};var g=false;var i=h.ctxViewer;var f;this.setActiveState=function(k){g=k;var l=this;if(!f){var j=setInterval(function(){f=c.giveAnnotationModelLoader({context:i});if(f&&f.getLoaderType()!=="undefined"){clearInterval(j);return l.setActiveState(g)}},10);return}f.setGlobalFTAVisibilityFlag(!g)};this.getActiveState=function(){return g};this.clearController=function(){this.setActiveState(false);i=f=null}}});var e=[];var d=a.singleton({init:function(){},give3DAnnotSwitchOnOffController:function(g){if(g&&g.context){for(var f=0;f<e.length;f++){if(e[f].context===g.context){return e[f].controller}}}},get3DAnnotSwitchOnOffController:function(g){if(g&&g.context){var h=this.give3DAnnotSwitchOnOffController(g);if(h){return h}var f=new b({ctxViewer:g.context});h=Object.freeze({setActiveState:function(i){if(f){return f.setActiveState(i)}},getActiveState:function(){if(f){return f.getActiveState()}},clearController:function(){if(f){f.clearController();f=null}}});e.push({context:g.context,controller:h});return h}},unreference3DAnnotSwitchOnOffController:function(g){if(g&&g.context){for(var f=0;f<e.length;f++){if(e[f].context===g.context){e[f].controller.clearController();e.splice(f,1);break}}}}});return d});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationShowHideCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(g,d,f,h,c,b,e){var a=g.extend({init:function(i){this._parent(i,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false)},beginExecute:function(){var u=function(F){var D;if(F.getLastElement(true).getAnnotationClassType){var E=F;while(E){D=E.getLastElement(true);if(D.getAnnotationClassType&&D.getAnnotationClassType()==="tpsAnnotationSet"){return E}E=E.getParentPath()}return null}var B=F.getChildrenPathes();for(var C=0;C<B.length;C++){D=B[C].getLastElement(true);if(D.getAnnotationClassType&&D.getAnnotationClassType()==="tpsAnnotationSet"){return B[C]}}};var o=h.get();var m=0;if(o){this.ctxBarPosition=this.getFrameWindow().getContextualUIManager().getContextualBar().getPosition();this.ctxBarPosition=this.ctxBarPosition?{x:this.ctxBarPosition.x,y:this.ctxBarPosition.y}:{x:0,y:0};var y=c.giveAnnotationModelLoader({context:o});var s=d.get();var A=this.options.ID==="CAT3DAnnotationShowHdr"||this.options.ID==="CAT3DAnnotationSetShowHdr";for(var q=0;q<s.length;q++){var t=s[q].pathElement.clone();if(t.internalPath.length){while(t.internalPath.length){t=t.getParentPath()}}while(!e.isPLMNode(t.getLastElement(true))&&!t.getLastElement(true).getAnnotationClassType){t=t.getParentPath()}var i=u(t);var v=t.getLastElement(true);var x;if(v.getAnnotationClassType){v.setVisibility(A);var j=v.getAnnotationClassType();if(j==="tpsView"||j==="tpsCapture"){var r=v.getVisibleAnnotations(i,true);for(x=0;x<r.length;x++){r[x].getLastElement(true).setVisibility(A)}}else{if(j==="tpsAnnotationSet"&&A){y.loadFTALightModel(i.getParentPath())}}}else{if(e.is3DLeaf(v)){var p=false;if(i){p=true;i.getLastElement(true).setVisibility(A);if(A){y.loadFTALightModel(i.getParentPath())}}if(!p&&A){y.loadFTALightModel(t,true,false);m=500}}else{var n;if(e.getNodeType(v)==="CATProduct"){n=y.getDirectChildrenAnnotSets(t);if(n.length){for(x=0;x<n.length;x++){if(n[x].getLastElement(true).getContextType()===2||n[x].getParentPath().isEqual(t)){n[x].getLastElement(true).setVisibility(A)}}}if(A){y.loadFTALightModel(t,A,false);var k=b.getPreference("3DAnnotLoadARMPartsPref");if(k){y.loadFTALightModel(t,true,false,[2]);m=500}}}else{n=y.getDirectChildrenAnnotSets(t);if(n.length){for(x=0;x<n.length;x++){n[x].getLastElement(true).setVisibility(A)}}var l=t.getChildrenPathes();y.loadFTALightModel(t,true,false);for(x=0;x<l.length;x++){y.loadFTALightModel(l[q],true,false);var z=l[x].getChildrenPathes();if(z.length===1){y.loadFTALightModel(z[0],true,false)}}m=500}}}}o.getViewer().render()}var w=this;setTimeout(function(){w.end()},m)},endExecute:function(){var i=d.get();var k=[];for(var j=0;j<i.length;j++){k.push({pathElement:i[j].pathElement.clone()})}d.empty();f.empty();d.add(k);f.add(k);this.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:true,x:this.ctxBarPosition.x,y:this.ctxBarPosition.y});this.ctxBarPosition=null}});return a});define("DS/CAT3DAnnotationBaseCmds/panels/CAT3DAnnotationThumbnailPanel",["UWA/Core","UWA/Class","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationBaseUI/CAT3DAnnotationBrowserSection","DS/CATWebUXComponents/CATWebUXThumbnail","UWA/Controls/ThemedScroller","DS/WebappsUtils/WebappsUtils","DS/CATWebUXComponents/CATWebUXSectionHeader","i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotationBaseCmds","css!DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationBaseCmds.css"],function(e,a,b,i,h,g,c,j,d){var f=a.extend({init:function(w){this._parent(w);var s=false;var l=[];var m;var t;var o;var v=new b();var q;this.buildPanel=function(F){this.cleanPanel();var A=0;q=F.backgroundColor;for(var L=0;L<F.length;L++){for(var E=0;E<F[L].children.length;E++){if(F[L].children[E].isVisible){A++}}}if(A>0){if(!m){m=e.createElement("div",{id:"CAT3DAnnotThumbMainDiv"})}m.setStyles({height:"100%"});var H=e.createElement("div",{"class":"CAT3DAnnotSectionMainDiv"}).inject(m);H.setStyles({"background-color":"rgba(255, 255, 255, 0)",height:"100%"});var G=c.getWebappsAssetUrl("CAT3DAnnotationBaseCmds","icons/22/")+"I_CAT3DAnnotResetDisplayHistory.png";var C=[];if(w.additionalCmdAvailability){C.push({type:"button",nls:d.ResetDisplayHistoryLbl,icon:G,cb:function(){k("onDeleteDisplayHistory",{})}})}o=new j({fontIcon:"fonticon fonticon-viewBrowser",sectionLabel:d.CapturesAndViewsLbl,cmdList:C,doubleClickCB:function(){k("onBrowserPanelResized")}});H.appendChild(o.getContent());var B=e.createElement("div",{"class":"CAT3DAnnotThumbMainContainer"});var D=0;var y=false;var J=false;var I,L;for(L=0;L<F.length;L++){I=false;for(var E=0;E<F[L].children.length;E++){var K=F[L].children[E];if(K.isVisible){if(K.semanticStandards){if(K.semanticStandards.standards.length||K.semanticStandards.defaultSpecs.length){I=true}}var x={id:L,thumbnails:p(K,[L,E]),section:{idPath:[L,E],name:K.referenceLabel+" / "+K.name,icon:K.referenceIcon}};if(x.thumbnails.length){for(var z=0;z<x.thumbnails.length;z++){if(x.thumbnails[z].type===6){J=true}else{y=true}x.hasInfos=I}l.push(x);D+=x.thumbnails.length}}}}if(l.length){for(L=0;L<l.length;L++){l[L].section.view=new i({touchMode:false,name:l[L].section.name,icon:l[L].section.icon,children:l[L].thumbnails,id:l[L].id,displayInExpanders:l.length>1,displayInfoButton:l[L].hasInfos,onInfoButtonClick:function(N){k("onInfoClick",F[N])}});B.appendChild(l[L].section.view.getContent())}}if(!D){return null}var M=d.CapturesAndViewsLbl;if(y&&!J){M=d.ViewsLbl}if(!y&&J){M=d.CapturesLbl}o.setHeaderLabel(M+" ("+D+")");t=new g().inject(H);t.getInnerElement().setContent(B);t.getContent().setStyle("height","calc(100% - 40px)");r();return m}};var r=function(){var A=[];for(var y=0;y<l.length;y++){for(var z=0;z<l[y].thumbnails.length;z++){var B={idPath:l[y].thumbnails[z].idPath,dataTypes:[]};var x=false;if(!l[y].thumbnails[z].preview){x=true;B.dataTypes.push("preview")}if(l[y].thumbnails[z].displayFlag!==true&&l[y].thumbnails[z].displayFlag!==false){x=true;B.dataTypes.push("displayFlag")}if(x){A.push(B)}}}k("onAdditionalInfosRequired",A)};this.cleanPanel=function(){if(!m){return}for(var x=0;x<l.length;x++){if(l[x].section.view){l[x].section.view.clear()}for(var y=0;y<l[x].thumbnails.length;y++){l[x].thumbnails[y].view.clear()}}while(m.firstChild){m.removeChild(m.firstChild)}l.splice(0,l.length);if(o){o.clear()}if(t){t.destroy()}o=null;t=null};this.setDisplayOnlyCapturesFlag=function(x){s=x};this.getThumbnailsIDPaths=function(){var x=[];for(var y=0;y<l.length;y++){for(var z=0;z<l[y].thumbnails.length;z++){x.push(l[y].thumbnails[z].idPath)}}return x};this.setAdditionalInformations=function(D){for(var y=0;y<D.length;y++){var C=u(D[y].idPath);if(C){var x=C.thumbnail;var A=Object.keys(D[y].infos);var B=false;for(var z=0;z<A.length;z++){if(A[z]==="preview"){x.preview=D[y].infos[A[z]];x.view.setPreview(x.preview)}else{if(A[z]==="displayFlag"){x.displayFlag=D[y].infos[A[z]];x.view.setDisplayFlag(x.displayFlag,false);B=true}}}if(B&&C.section.view){C.section.view.updateShadingColor()}}}};var u=function(x){if(x.length!==4){return null}for(var y=0;y<l.length;y++){if(l[y].section.idPath[0]===x[0]&&l[y].section.idPath[1]===x[1]){for(var z=0;z<l[y].thumbnails.length;z++){if(l[y].thumbnails[z].idPath[2]===x[2]&&l[y].thumbnails[z].idPath[3]===x[3]){return{section:l[y].section,thumbnail:l[y].thumbnails[z]}}}}}};this.subscribe=function(y,x){if(!y||!x){return undefined}return v.subscribe({event:y},x)};this.unsubscribe=function(x){if(x===null||x===undefined){return}v.unsubscribe(x)};var n=function(y){if(o){o.closeContextualSectionHeader()}var x=u(y.data.idPath);x.thumbnail.displayFlag=true;if(!x.thumbnail.view.getDisplayFlag()){x.thumbnail.view.setDisplayFlag(true);if(x.section.view){x.section.view.updateShadingColor()}}k("onThumbnailSelected",y.data)};var p=function(O,B){var x=[];var M,N;for(var D=0;D<O.children.length;D++){if(O.children[D].type==="RootViews"){M=D}else{if(O.children[D].type==="RootCaptures"){N=D}}}if(s&&O.children[N].children.length){for(var D=0;D<O.children[N].children.length;D++){var H=O.children[N].children[D];var I={};I.idPath=[B[0],B[1],N,D];I.displayFlag=H.displayFlag;I.type=H.type;I.view=new h({id:"3DAnnotBrowserThumb_"+I.idPath[0]+"_"+I.idPath[1]+"_"+I.idPath[2]+"_"+I.idPath[3],width:154,height:118,data:{idPath:I.idPath,label:H.name,icon:H.icon},displayFlag:I.displayFlag,title:H.name,icon:H.icon,preview:H.preview,clickCB:n,backgroundColor:q});x.push(I)}}else{if(!s){for(var D=0;D<O.children[M].children.length;D++){var E=O.children[M].children[D];if(E.isSubView){continue}var I={};var J=null;var C=[B[0],B[1],M,D];var L=E.associatedCapture;I.displayFlag=E.displayFlag;I.type=E.type;var F=E.preview;if(L&&L.length){var G=O.children[N].children[L[0]-1];J=G.name;C=[B[0],B[1],N,L[0]-1];I.displayFlag=G.displayFlag;if(G.preview){F=G.preview}}I.idPath=C.slice(0,C.length);I.view=new h({id:"3DAnnotBrowserThumb_"+I.idPath[0]+"_"+I.idPath[1]+"_"+I.idPath[2]+"_"+I.idPath[3],width:154,height:118,data:{idPath:I.idPath,label:E.name,icon:E.icon},displayFlag:I.displayFlag,title:E.name,icon:E.icon,subtitle:J,preview:F,clickCB:n,backgroundColor:q});x.push(I);if(L.length>1){for(var K=1;K<L.length;K++){var H=O.children[N].children[L[K]-1];var I={};I.displayFlag=H.displayFlag;I.idPath=[B[0],B[1],N,L[K]-1];I.type=H.type;I.view=new h({id:"3DAnnotBrowserThumb_"+I.idPath[0]+"_"+I.idPath[1]+"_"+I.idPath[2]+"_"+I.idPath[3],width:154,height:118,data:{idPath:I.idPath,label:H.name,icon:H.icon},displayFlag:I.displayFlag,title:H.name,icon:H.icon,subtitle:E.name,preview:H.preview,clickCB:n,backgroundColor:q});x.push(I)}}if(E.isMultiSectionView){for(var K=0;K<E.multiSectionData.views.length;K++){var A=O.children[M].children[E.multiSectionData.views[K]-1];if(!A.isSubView){continue}var y=A.associatedCapture;if(!y||(y&&!y.length)){continue}for(var z=0;z<y.length;z++){var H=O.children[N].children[y[z]-1];var I={};I.displayFlag=H.displayFlag;I.idPath=[B[0],B[1],N,y[z]-1];I.type=H.type;I.view=new h({id:"3DAnnotBrowserThumb_"+I.idPath[0]+"_"+I.idPath[1]+"_"+I.idPath[2]+"_"+I.idPath[3],width:154,height:118,data:{idPath:I.idPath,label:H.name,icon:H.icon},displayFlag:I.displayFlag,title:H.name,icon:H.icon,subtitle:A.name,preview:H.preview,clickCB:n,backgroundColor:q});x.push(I)}}}}for(var D=0;D<O.children[N].children.length;D++){var H=O.children[N].children[D];if(!H.pointedView){var I={};I.displayFlag=H.displayFlag;I.idPath=[B[0],B[1],N,D];I.type=H.type;I.view=new h({id:"3DAnnotBrowserThumb_"+I.idPath[0]+"_"+I.idPath[1]+"_"+I.idPath[2]+"_"+I.idPath[3],width:154,height:118,data:{idPath:I.idPath,label:H.name,icon:H.icon},displayFlag:I.displayFlag,title:H.name,icon:H.icon,preview:H.preview,clickCB:n,backgroundColor:q});x.push(I)}}}}return x};var k=function(y,x){return v.publish({event:y,data:x,context:this})}}});return f});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationLevelSelectorCmd",["DS/ApplicationFrame/Command","DS/LevelSelector/LevelSelector","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(b,f,d,c,g,i){var h=function(k){if(!k){return false}var j=k;while(j){if(j.getLastElement(true).getAnnotationClassType){break}j=j.getParentPath()}return j};var e=function(j){if(!j){return null}var m=j.getLastElement(true).getAnnotationID!==undefined?j.getLastElement(true).getAnnotationID():null;var q=j.getParentPath().getParentPath();if(!q.getLastElement(true).getAnnotationClassType||q.getLastElement(true).getAnnotationClassType()!=="tpsAnnotationSet"){return null}var k=null;var o=q.getChildrenPathes();for(var r=0;r<o.length;r++){if(o[r].getLastElement(true).getAnnotationType()==="RootViews"){k=o[r];break}}if(k){var p=k.getChildrenPathes();for(var r=0;r<p.length;r++){var l=p[r].getLastElement(true).getTPSList();if(l&&l.length){for(var n=0;n<l.length;n++){if(l[n]===m){return p[r]}}}}}};var a=b.extend({init:function(l){this._parent(l,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false);var q=this;var p=g.get();var o;var j;var n=false;var m=0;var k={x:0,y:0};this.beginExecute=function(){m=d.onEmpty(function(){if(q._isRunning&&!n){q.end()}});var r=q.getFrameWindow().getContextualUIManager().getContextualBar();k=r&&r.getPosition()?r.getPosition():{x:0,y:0};if(r){k.x=k.x+r.elements.container.getDimensions().width-40*window.devicePixelRatio;k.y=k.y-r.elements.container.getDimensions().height/2-10*window.devicePixelRatio;r.hide()}},this.execute=function(){var t=o;if(!t){var w=d.get();o=w.length>0?w[w.length-1]:undefined;t=o}if(("pathElement" in t)&&t.pathElement){var v=t.pathElement;var s=h(v);var u;if(s){u=function(){var z=[];var B={levels:z};if(s.getLastElement(true).getAnnotationClassType&&s.getLastElement(true).getAnnotationClassType()==="tpsAnnotationSet"){return}z.push({pathElement:s,name:s.getLastElement(true).getAnnotationName(),icon:s.getLastElement(true).getAnnotationIcon()});var A=s.getParentPath();if(A.getLastElement(true).getAnnotationClassType&&A.getLastElement(true).getAnnotationClassType()==="tpsRoot"){var y=A.getLastElement(true).getAnnotationType?A.getLastElement(true).getAnnotationType():null;if(y&&(y!=="RootViews"&&y!=="RootCaptures"&&y!=="RootGeometries")){var x=e(s);if(x){z.push({pathElement:x,name:x.getLastElement(true).getAnnotationName(),icon:x.getLastElement(true).getAnnotationIcon()})}}A=A.getParentPath()}if(A.getLastElement(true).getAnnotationClassType&&A.getLastElement(true).getAnnotationClassType()==="tpsAnnotationSet"){z.push({pathElement:A,name:A.getLastElement(true).getAnnotationName(),icon:A.getLastElement(true).getAnnotationIcon()})}return B}}else{u=function(G){var H=[];var x=[],B=[];var y=v;while(y){var z=y.getLastElement(true);if(i.isPLMNode(z)&&(i.isReference(z)||i.is3DLeaf(z))){var I={pathElement:y,idRef:i.getNodeID(z)};H.push(I);x.push(I.idRef);B.push({node:y.getLastElement(true),id:I.idRef});var E=y.externalPath.length>1?y.externalPath[y.externalPath.length-2]:null;if(i.isPLMNode(E)&&i.isInstance(E)){x.push(I.idInst=i.getNodeID(E));B.push({node:E,id:I.idInst})}}y=y.getParentPath()}var D=function(J){H.forEach(function(K){K.name=J[K.idRef]?J[K.idRef]["ds6w:label"]:"";if(K.idInst&&J[K.idInst]&&J[K.idInst]["ds6w:label"]){K.name+=" ("+J[K.idInst]["ds6w:label"]+")"}K.icon=J[K.idRef]?J[K.idRef].type_icon_url:undefined;delete K.idRef;delete K.idInst});G(H)};if(i.getLoadedAssetType()==="3DXML"){var C=[];for(var F=0;F<B.length;F++){var A=i.getNodeInfos(B[F].node);C[B[F].id]={};C[B[F].id]["ds6w:label"]=A.name;C[B[F].id].type_icon_url=A.icon}D(C)}else{p.getController().getAttributes({ids:x,attributes:["ds6w:label","type_icon_url"],callbacks:{onComplete:D,onFailure:function(){G(H)}}})}return H}}var r={positionX:k.x,positionY:k.y,uiFrame:p.getFrameWindow().getUIFrame(),getLevels:u,onHover:function(x){c.empty();c.add(x)},onLeave:function(x){if(o){c.remove(x);c.add(o)}},onSelect:function(y){n=true;d.empty();c.empty();o.pathElement=y.pathElement;var x=o;setTimeout(function(){q.end();d.add(x);c.add(x);q.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:true})},0);n=false}};f.createView(r)}else{q.end()}};this.endExecute=function(){if(this._isRunning){o=undefined;j=undefined;f.destroyView()}d.unsubscribe(m)}}});return a});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationPreferencesCmd",["UWA/Core","DS/Controls/Toggle","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/ApplicationFrame/Command","DS/Controls/Button","DS/Windows/Dialog","DS/PADUtils/PADContext","DS/Controls/Expander"],function(c,n,f,s,m,h,o,j){var e="";var l="";var v="";var x="";var k="";var d="";var a="";var q="";var r="";var p="";var i="",g="",u="",t="";var b=[];require(["i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotationBaseCmds","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationAttributesCategories"],function(z,y){r=z.PrefAttributesTitle;p=z.AnnotationsAttrLbl;e=z.PreferencesLbl;x=z.DefaultParamsLbl;l=z.SaveLbl;v=z.CancelLbl;k=z.WhiteVecAsBlackLbl;d=z.LoadARMPartsLbl;q=z.UpdateThumbnailsLbl;a=z.DisplayCapturesLbl;i=z.FavoriteContextLabel;g=z.FavoriteContextOpen;u=z.FavoriteContextCheck;t=z.FavoriteContextIgnore;b=y});var w=s.extend({init:function(y){this._parent(y,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false)},beginExecute:function(){var D=this,A;var z=this.getPreferencePanel();z.buildAttrSection();var B=new m({emphasize:"primary",touchMode:true,label:l,onClick:function(){z.saveCB();if(A.close){A.close()}else{A.destroy()}}});var y=new m({label:x,touchMode:true,onClick:z.resetCB});var C=new m({label:v,touchMode:true,onClick:function(){if(A.close){A.close()}else{A.destroy()}}});A=new h({touchMode:true,modalFlag:true,ensureHeightDefinitionOnHierarchy:true,title:e,content:z.body,immersiveFrame:o.get().getFrameWindow().getImmersiveFrame(),buttons:{Cancel:C,Ok:B,Apply:y}});A.addEventListener("close",function(){D.end()})},endExecute:function(){},getPreferencePanel:function(){var S=f.getPreference("3DAnnotLoadARMPartsPref");var N=f.getPreference("3DAnnotDisplayCapturesPref");var W=f.getPreference("3DAnnotWhiteVectorAsBlack");var O=f.getPreference("3DAnnotUpdateThumbnailsPref");var X=f.getPreference("FavoriteContextLoadMode");var H=c.createElement("div");var F=new n({label:k,value:"3DAnnotWhiteVectorAsBlack",type:"checkbox",checkFlag:W}).inject(H);var B=new n({label:d,value:"3DAnnotLoadARMPartsPref",type:"checkbox",checkFlag:S}).inject(H);var V=new n({label:a,value:"3DAnnotDisplayCapturesPref",type:"checkbox",checkFlag:N}).inject(H);var C=new n({label:q,value:"3DAnnotUpdateThumbnailsPref",type:"checkbox",checkFlag:O}).inject(H);var I,R,z;c.createElement("label",{text:i,styles:{"margin-bottom":"0px",padding:"10px 0px"}}).inject(H);var Y=c.createElement("div",{styles:{"padding-bottom":"10px"}}).inject(H);I=new n({type:"radio",value:"option1",label:g,checkFlag:X==="0"}).inject(Y);R=new n({type:"radio",value:"option2",label:u,checkFlag:X==="1"}).inject(Y);z=new n({type:"radio",value:"option3",label:t,checkFlag:X==="2"}).inject(Y);I.getContent().setStyle("margin-left","20px");R.getContent().setStyle("margin-left","20px");z.getContent().setStyle("margin-left","20px");var M=c.createElement("div",{"class":"CAT3DAnnotAttrPrefAttrSection"});new j({header:r,body:M}).inject(H);var Q=[],E=[];var y,U;function T(){if(E.length===1){E[0].body.inject(M)}else{for(var Z=0;Z<E.length;Z++){new j(E[Z]).inject(M)}}}function D(){var aa="3DAnnotSemAttr_2";var ab=f.getPreference(aa);var ac=c.createElement("div");var Z=new n({label:b["2"],value:aa,type:"checkbox",checkFlag:ab}).inject(ac);M.insertBefore(ac,M.firstChild);Z.getContent().setStyles({"padding-bottom":"5px"});Q.push({toggle:Z,initValue:ab,name:aa})}function J(ad,ab){var aa=c.createElement("p",{"class":"CAT3DAnnotAttrPrefAttrSection"});for(var ac=0;ac<ad.length;ac++){y="3DAnnotSemAttr_"+ad[ac];U=f.getPreference(y);var Z=new n({label:b[ad[ac]],value:y,type:"checkbox",checkFlag:U}).inject(aa);Q.push({toggle:Z,initValue:U,name:y})}E.push({header:ab,body:aa})}var G=f.getPreference("3DAnnotAttributesOrderedList");var P=[];for(var L=0;L<G.length;L++){if(isNaN(parseFloat(G[L]))){P.push(G[L])}}J(P,p);function A(){var aa=B.checkFlag;if(aa!==S){f.setPreference("3DAnnotLoadARMPartsPref",aa)}aa=V.checkFlag;if(aa!==N){f.setPreference("3DAnnotDisplayCapturesPref",aa)}aa=F.checkFlag;if(aa!==W){f.setPreference("3DAnnotWhiteVectorAsBlack",aa)}aa=C.checkFlag;if(aa!==O){f.setPreference("3DAnnotUpdateThumbnailsPref",aa)}aa=I.checkFlag?"0":R.checkFlag?"1":z.checkFlag?"2":"1";if(aa!==X){f.setPreference("FavoriteContextLoadMode",aa)}for(var Z=0;Z<Q.length;Z++){if(Q[Z].toggle.checkFlag!==Q[Z].initValue){f.setPreference(Q[Z].name,Q[Z].toggle.checkFlag)}}}function K(){B.checkFlag=false;V.checkFlag=false;F.checkFlag=true;C.checkFlag=true;R.checkFlag=true;for(var Z=0;Z<Q.length;Z++){Q[Z].toggle.checkFlag=true}}return{body:H,saveCB:A,resetCB:K,addSubSection:J,addUserAttr:D,buildAttrSection:T}}});return w});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationResetDisplayHistoryCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/PADUtils/views/PADAlert"],function(d,e,c,a){var b="";require(["i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotationBaseCmds"],function(g){b=g.DisplayHistorySuccessfulLbl});var f=d.extend({init:function(g){this._parent(g,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false)},beginExecute:function(){var j=e.get();var i=c.giveAnnotationModelLoader({context:j});var g=i.getLoadedAnnotationSets(j.getRootBagPath());for(var k=0;k<g.length;k++){var h=g[k].getLastElement(true).getRootAnnotationNode("RootCaptures");if(h&&h.children&&h.children.length){for(var l=0;l<h.children.length;l++){h.children[l].setDisplayFlag(false)}}var h=g[k].getLastElement(true).getRootAnnotationNode("RootViews");if(h&&h.children&&h.children.length){for(var l=0;l<h.children.length;l++){h.children[l].setDisplayFlag(false)}}}a.displayNotification({eventID:"info",msg:b});this.end()}});return f});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationSwitchOnOffCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext","DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotSwitchOnOffController"],function(d,c,a){var b=d.extend({init:function(g){this._parent(g,{});var j=this;var h;var i=this.onStateChange(function(){if(!h){h=c.get()}a.get3DAnnotSwitchOnOffController({context:h}).setActiveState(j.getState());localStorage.setItem("CAT3DAnnotationSwitchOnOffCmd",j.getState()?"true":"false")});var f=this._destroy;this._destroy=function(){if(h){a.unreference3DAnnotSwitchOnOffController({context:h})}j._modelEvents.unsubscribe(i);f.call(j)};var e=localStorage.getItem("CAT3DAnnotationSwitchOnOffCmd");e=e==="true"?true:(e==="false"?false:undefined);this.setState(e===true?true:false,true)},_destroy:function(){this._parent()}});return b});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotStandardsInfoMgr",["UWA/Class","DS/PADUtils/PADContext","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationBaseCmds/panels/CAT3DAnnotationStandardsInfoPanel","DS/Windows/Dialog","DS/Controls/Button","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotStandardInfosPanel"],function(b,g,c,a,j,h,f,i,e){var d=b.extend({init:function(){this._parent();var p=this;var m=g.get();var n=f.giveAnnotationController({context:m});var o=i.giveAnnotationModelLoader({context:m});var l,k;this.build=function(r){var s;if(l){l.cleanPanel()}if(!n||!o){return}l=new a();l.subscribe("onPreferenceModified",function(x){c.setPreference("3DAnnotSemStd",JSON.stringify(x))});l.subscribe("onShowAllClick",function(){n.onAdditionalInfosRequired({cb:function(x){l.updatePanel(x)}})});var w=c.getPreference("3DAnnotSemStd");var v=true;if(o.getLoadedAnnotationSets().length===1){v=false}else{var u=0;for(var t=0;t<o.getLoadedAnnotationSets().length;t++){if(o.getLoadedAnnotationSets()[t].getLastElement().getSemanticStandards){u+=1}}if(u<2){v=false}}s=new h({emphasize:"primary",touchMode:true,label:e.CloseButton,onClick:function(){if(l){l.cleanPanel()}l=null;k.destroy()}});k=new j({modalFlag:true,maximizeButtonFlag:true,resizableFlag:true,width:750,height:800,ensureHeightDefinitionOnHierarchy:true,title:e.InfosPanelTitle,content:l.buildPanel(r,w?w:JSON.stringify({groupBy:"0",columnSize:{name:"200",code:"200",standard:"200",year:"200",title:"1000"}}),v),immersiveFrame:m.getFrameWindow().getImmersiveFrame(),buttons:{Close:s}});function q(y){if(k&&p){var x=y.keyCode||y.which;if(x===13||x===27){if(l){l.cleanPanel()}l=null;k.destroy()}}}k.addEventListener("close",function(){if(k&&p){if(l){l.cleanPanel()}l=null;k.destroy()}});k.addEventListener("keydown",function(x){q(x)});k.addEventListener("keypress",function(x){q(x)})};this.clearManager=function(){this.destroyPanel();l=p=m=n=o=null};this.destroyPanel=function(){if(l){l.cleanPanel()}if(k){k.destroy()}}}});return d});define("DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/CAT3DAnnotationBaseCmds/panels/CAT3DAnnotationThumbnailPanel","DS/CATWebUXComponents/CATWebUXPanel","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/WebappsUtils/WebappsUtils","DS/ApplicationFrame/CommandsManager","DS/Visualization/SceneGraphUtils","DS/Visualization/Viewpoint","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationBaseCmds/CAT3DAnnotStandardsInfoMgr","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Selection/HSOManager","DS/Visualization/PathElement","i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotationBaseCmds"],function(g,s,t,d,p,j,c,e,a,q,m,h,i,o,l,r,k){var f=s.extend({init:function(ac){this._parent(ac);var P=ac||{};var am=false;var K=false;var v=null;var X=null;var D;var V=true;var G=[];var L=P.ctxViewer;var ab;var Q;var H;var O;var I=false;var E={},ai={},aa={};var al=0,ad=0,af=0,ag=0;var Y=0;var u=0;var ae=150;var M=0;var w=this;var J=g.createElement("canvas");var ah,ak;var ao;this.setActiveState=function(at){am=at;if(!ab||!H){var ap=setInterval(function(){H=c.giveAnnotationModelLoader({context:L});ab=j.giveAnnotationController({context:L});if(ab&&H&&H.getLoaderType()!=="undefined"){clearInterval(ap);w.setActiveState(am);return}},10);return}if(!w.getDataModel){ab.onAdditionalInfosRequired({controller:"AnnotBrowser",cb:function(){w.setActiveState(am)}});return}u=0;if(am){if(!I){Q=new i();aa.onAnnotControllerActiveStateChanged=ab.subscribe("onAnnotControllerActiveStateChanged",function(au){if(au.state){R()}else{Z()}});E.onAnnotModelLoaderActiveStateChanged=H.subscribe("onAnnotModelLoaderActiveStateChanged",function(au){if(au.state){R()}else{Z()}});E.onAnnotationVisibilityModifiedToken=H.subscribe("onAnnotationVisibilityModified",function(au){if(au.annotNode.getAnnotationClassType()==="tpsAnnotationSet"){R()}});E.onAnnotationSetLoadedToken=H.subscribe("onAnnotationSetLoaded",function(){S(true);R();if(Q){Q.destroyPanel()}});E.onAnnotationSetPartiallyLoaded=H.subscribe("onAnnotationSetPartiallyLoaded",function(){S(true);R()});E.onAnnotationSetRemovedToken=H.subscribe("onAnnotationSetRemoved",function(){ae=0;R();if(Q){Q.destroyPanel()}});E.onAnnotationSetBeginLoadToken=H.subscribe("onAnnotationSetBeginLoad",function(){S(false)});E.onAnnotationSetLoadingFailedToken=H.subscribe("onAnnotationSetLoadingFailed",function(){S(true)});E.onNoAnnotationSetLoadedToken=H.subscribe("onNoAnnotationSetLoaded",function(au){if(au&&au.loadingAlreadyStarted){S(true)}});E.onAnnotationSetLoadingCanceledToken=H.subscribe("onAnnotationSetLoadingCanceled",function(){S(true)});D=h.getPreference("3DAnnotUpdateThumbnailsPref");T();ad=h.subscribe("onPreferenceModified",function(au){if(au.preference==="3DAnnotDisplayCapturesPref"){R()}if(au.preference==="3DAnnotUpdateThumbnailsPref"){D=au.value;T()}});E.onVisuModificationToken=H.subscribe("onAnnotationParentVisibilityModified",function(){R()});al=L.subscribe({event:"onModelUpdated"},x);af=L.getViewer().onBackgroundModify(x);ag=L.getViewer().onSwapVisibleSpace?L.getViewer().onSwapVisibleSpace(function(){K=L.getViewer().getVisibleSpace()===0;if(L.getViewer().getVisibleSpace()===1){R()}else{Z()}}):null;K=L.getViewer().getVisibleSpace()===0;ah=new m({viewer:L.getViewer()});I=true}R()}else{if(I){var ar=Object.keys(E),aq;for(aq=0;aq<ar.length;aq++){H.unsubscribe(E[ar[aq]])}ar=Object.keys(aa);for(aq=0;aq<ar.length;aq++){ab.unsubscribe(aa[ar[aq]])}if(ad){h.unsubscribe(ad)}if(af){L.getViewer().unsubscribe(af)}if(ag&&L.getViewer()){L.getViewer().unsubscribe(ag)}if(al){L.unsubscribe(al)}E={};aa={};ad=0;af=0;ag=0;al=0;Z();Q.clearManager();ah=null;I=false;Q=null}if(Y){clearTimeout(Y);Y=0}if(M){clearTimeout(M);M=0}}};this.getActiveState=function(){return am};this.clearController=function(){this.setActiveState(false);if(v){var aq=Object.keys(ai);for(var ap=0;ap<aq.length;ap++){v.unsubscribe(ai[aq[ap]])}}ai={};if(X){X.setPanelVisibilityFlag(false);X.clean()}v=X=G=L=ab=H=w=J=ah=ak=null;ao=null};this.setPanelVisibilityFlag=function(ap){V=ap;if(X&&v){X.setPanelVisibilityFlag(V&&v.getThumbnailsIDPaths().length!==0)}};this.getPanelVisibilityFlag=function(){return V};var x=function(){setTimeout(function(){if(am&&v){var ap=v.getThumbnailsIDPaths();for(var aq=0;aq<ap.length;aq++){var ar=aj(ap[aq]);if(ar&&ar.getLastElement(true).previewUpdated){ar.getLastElement(true).previewUpdated=false}}T()}},100)};var aj=function(ap){if(G&&G.length&&G[ap[0]]){if(G[ap[0]].children&&G[ap[0]].children[ap[1]]){if(G[ap[0]].children[ap[1]].path){var aq=G[ap[0]].children[ap[1]].path.getChildrenPathes();if(aq&&aq.length&&aq[ap[2]]){var ar=aq[ap[2]].getChildrenPathes();if(ar&&ar.length&&ar[ap[3]]){return ar[ap[3]]}}}}}return undefined};var T=function(){if(!aa.onViewOrCaptureDisplayed){aa.onViewOrCaptureDisplayed=ab.subscribe("onViewOrCaptureDisplayed",function(ap){ao=ap;if(!("requestIdleCallback" in window)&&D){F(ap.path)}if(v){v.setAdditionalInformations([{idPath:A(ap.path),infos:{displayFlag:true}}])}})}if(!aa.onFilteringAndClippingRemoved){aa.onFilteringAndClippingRemoved=ab.subscribe("onFilteringAndClippingRemoved",function(){ao=null})}if("requestIdleCallback" in window){window.requestIdleCallback(C)}};var C=function(aq){var at=function(){window.requestIdleCallback(C)};if(!am||!v||!D||K){return}if(!L.getFrameWindow().getViewpoint().isMoving()&&aq.timeRemaining()>0&&u>=0&&l.get().length===0){var ap=v.getThumbnailsIDPaths();for(var ar=0;ar<ap.length;ar++){var au=aj(ap[ar]);if(au&&!au.getLastElement(true).previewUpdated){F(au,at);return}}}else{setTimeout(at,500)}};var F=function(ap,aq){if(!ap.getLastElement(true).previewUpdated){ab.getFTAViewOrCaptureDisplayInfos({path:ap,cb:function(aQ){var aF;var aw=L.getViewer();var aN=[ap],aT=[];var ar;var av=H.getLoadedAnnotationSets(L.getRootBagPath());for(aF=0;aF<av.length;aF++){if(av[aF].isAParentOf(ap)){ar=av[aF];aN.push(ar)}aT.push(av[aF])}if(!ar){if(aq){aq()}return}var aU=aw.infinitePlane;aw.displayInfinitePlane(false);var aE=aw.useShadowPlane;aw.setShadowPlane(false);var ay=aw.useSSAO;aw.setSSAO(false);var az=aw.getShadow();aw.setShadow(false);var aV=aw.getGrid();aw.setGrid(false);var aJ=aw.getMirror(),aD=aw.blurryMirror;aw.setMirror(false,false);var aS=ap.getLastElement(true);var aB=ar.getChildrenPathes();for(aF=0;aF<aB.length;aF++){var aR=aB[aF].getChildrenPathes();for(var aP=0;aP<aR.length;aP++){aT.push(aR[aP])}}var aO=L.getRootBagPath().getChildrenPathes();for(aF=0;aF<aO.length;aF++){if(aO[aF].isAParentOf(ap)){aN.push(aO[aF])}else{aT.push(aO[aF])}}var aM=w.getOverloadedPaths();if(aM){if(aM.hiddenBodies&&aM.hiddenBodies.length&&aM.hiddenBodies[0].getLastElement){for(aF=0;aF<aM.hiddenBodies.length;aF++){if(q.getVisibilityFromPath&&!q.getVisibilityFromPath(aM.hiddenBodies[aF])){q.applyVisibilityToPath(aM.hiddenBodies[aF],1)}}}if(aM.visibleBodies&&aM.visibleBodies.length&&aM.visibleBodies[0].getLastElement){for(aF=0;aF<aM.visibleBodies.length;aF++){if(q.getVisibilityFromPath&&q.getVisibilityFromPath(aM.visibleBodies[aF])){q.applyVisibilityToPath(aM.visibleBodies[aF],0)}}}}var aK=[],aC=[];if((aQ.hiddenBodies&&aQ.hiddenBodies.length)||(aQ.visibleBodies&&aQ.visibleBodies.length)){if(aQ.visibleBodies&&aQ.visibleBodies.length){for(aF=0;aF<aQ.visibleBodies.length;aF++){if(q.getVisibilityFromPath&&!q.getVisibilityFromPath(aQ.visibleBodies[aF])){aC.push(aQ.visibleBodies[aF]);q.applyVisibilityToPath(aQ.visibleBodies[aF],1)}}}if(aQ.hiddenBodies&&aQ.hiddenBodies.length){for(aF=0;aF<aQ.hiddenBodies.length;aF++){if((q.getVisibilityFromPath&&q.getVisibilityFromPath(aQ.hiddenBodies[aF]))||!q.getVisibilityFromPath){aK.push(aQ.hiddenBodies[aF]);q.applyVisibilityToPath(aQ.hiddenBodies[aF],0)}}}}if(ao&&ao.visibleAssyComponents&&ao.visibleAssyComponents.length){aT=aT.concat(ao.visibleAssyComponents)}if(ao&&ao.hiddenAssyComponents&&ao.hiddenAssyComponents.length){aN=aN.concat(ao.hiddenAssyComponents)}if(aQ.visibleAnnotations&&aQ.visibleAnnotations.length){aN=aN.concat(aQ.visibleAnnotations)}if(aQ.hiddenAssyComponents&&aQ.hiddenAssyComponents.length){aT=aT.concat(aQ.hiddenAssyComponents)}if(aQ.visibleAssyComponents&&aQ.visibleAssyComponents.length){aN=aN.concat(aQ.visibleAssyComponents)}var aA=w.getCurrentClipping();w.removeClipping(aA);if(aQ.clippingInfos){w.addClipping(aQ.clippingInfos)}if(!ak){ak=new o(L.getRootBagPath().getLastElement(true))}aw.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(ak);var at=ak.createOverride({pathes:aT});if(at){at.setVisibility(false)}var ax=ak.createOverride({pathes:aN});if(ax){ax.setVisibility(true)}var aL=aw.getNodes();var aH=[],au;for(aF=0;aF<aL.length;aF++){if(aL[aF].name.indexOf("3D Grid")!==-1){aH.push(new o(aL[aF]));aw.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(aH[aH.length-1]);au=aH[aH.length-1].createOverride({pathes:[new r([aL[aF]])]});au.setVisibility(false)}}aw.addViewpoint(ah);ah.setProjectionType(L.getFrameWindow().getViewpoint().getProjectionType());w.reframe(ah,aQ.reframeInfos,0);var aI=B(ah,144,108);aS.setPreview(aI);aS.previewUpdated=true;v.setAdditionalInformations([{idPath:A(ap),infos:{preview:aI}}]);aw.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(ak);var aG=[];if(at){aG.push(at)}if(ax){aG.push(ax)}if(aG.length){ak.deleteOverrides(aG)}aw.removeViewpoint(aw.getViewpoints().length-1);for(aF=0;aF<aH.length;aF++){aw.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(aH[aF])}for(aF=0;aF<aK.length;aF++){q.applyVisibilityToPath(aK[aF],1)}for(aF=0;aF<aC.length;aF++){q.applyVisibilityToPath(aC[aF],0)}if(aM&&aM.hiddenBodies&&aM.hiddenBodies.length){for(aF=0;aF<aM.hiddenBodies.length;aF++){q.applyVisibilityToPath(aM.hiddenBodies[aF],0)}}if(aM&&aM.visibleBodies&&aM.visibleBodies.length){for(aF=0;aF<aM.visibleBodies.length;aF++){q.applyVisibilityToPath(aM.visibleBodies[aF],1)}}if(aU){aw.displayInfinitePlane(aU)}if(aE){aw.setShadowPlane(aE)}if(ay){aw.setSSAO(ay)}if(az){aw.setShadow(az)}if(aV){aw.setGrid(aV)}if(aJ||aD){aw.setMirror(aJ,aD)}if(aQ.clippingInfos){w.removeClipping(aQ.clippingInfos)}if(aA){w.addClipping(aA)}if(aq){aq()}}})}};var B=function(aA,ar,aq){var aw={data:null,width:Math.round(L.getViewer().SCREEN_WIDTH*window.devicePixelRatio),height:Math.round(L.getViewer().SCREEN_HEIGHT*window.devicePixelRatio)};L.getViewer().renderToTarget(aw,aA);var aB=aw.width/aw.height;if(aB>(ar/aq)){J.height=aq;J.width=J.height*aB}else{J.width=ar;J.height=J.width/aB}var av=2;J.width*=av;J.height*=av;var at=J.getContext("2d");at.clearRect(0,0,J.width,J.height);var ax=function(aG,aF,aI,aJ,aH){if(aH){aF=aJ-aF-1}return aI*Math.floor(aF)+Math.floor(aG)};var aD=at.getImageData(0,0,J.width,J.height);var aC=aw.width/aD.width,au=aw.height/aD.height;for(var ay=0;ay<aD.height;ay++){for(var aE=0;aE<aD.width;aE++){var ap=ax(aE,ay,aD.width,aD.height,false);var az=ax(aC*aE,au*ay,aw.width,aw.height,true);aD.data[4*ap]=aw.data[4*az];aD.data[4*ap+1]=aw.data[4*az+1];aD.data[4*ap+2]=aw.data[4*az+2];aD.data[4*ap+3]=aw.data[4*az+3]}}aw.data=null;aw=null;at.putImageData(aD,0,0);return J.toDataURL("image/jpeg",0.3)};var A=function(aw){for(var ar=0;ar<G.length;ar++){for(var at=0;at<G[ar].children.length;at++){var ap=G[ar].children[at].path;for(var au=0;au<ap.getChildrenPathes().length;au++){var aq=ap.getChildrenPathes()[au];for(var av=0;av<aq.getChildrenPathes().length;av++){if(aq.getChildrenPathes()[av].isEqual(aw)){return[ar,at,au,av]}}}}}return null};var S=function(ap){if(am){u+=ap===true?1:-1;if(M){clearTimeout(M);M=0}if(X){X.setEnableFlag(u>=0);if(u<0){M=setTimeout(function(){if(am&&X){X.setEnableFlag(true)}u=0},20000)}}}};var R=function(){if(!am||!ab.getActiveState()){return}if(K){var ap=setInterval(function(){if(!K){clearInterval(ap);R()}})}if(Y){clearTimeout(Y);Y=0}Y=setTimeout(function(){w._internalRefresh();ae=150;Y=0},ae)};var Z=function(){if(Y){clearTimeout(Y);Y=0}if(X){O=X.getWidth();X.clean();X=null}if(v){v.cleanPanel()}};this._internalRefresh=function(){if(!am||!w.getDataModel){Z();return}G.splice(0,G.length);w.getDataModel(function(av){if(!am){Z();return}G=av;for(var aq=0;aq<G.length;aq++){if(G[aq].children){for(var at=0;at<G[aq].children.length;at++){var ar=G[aq].children[at];if(ar.isVisible){for(var au=0;au<ar.children.length;au++){var ap=ar.children[au];if(ap.type==="RootViews"||ap.type==="RootCaptures"&&ap.children.length>0){z();if(X){X.setEnableFlag(u>=0)}return}}}}}}Z()})};var z=function(){if(!v){var av=a.getCommand("CAT3DAnnotationResetDisplayHistoryHdr",L.getCommandContext?L.getCommandContext():null);v=new d({additionalCmdAvailability:av!==undefined&&av!==null});ai={};ai.onBrowserPanelResized=v.subscribe("onBrowserPanelResized",U);ai.onInfoStandardsClicked=v.subscribe("onInfoClick",function(ax){Q.build(ax)});ai.onThumbnailSelected=v.subscribe("onThumbnailSelected",W);ai.onDeleteDisplayHistory=v.subscribe("onDeleteDisplayHistory",an);ai.onAdditionalInfosRequired=v.subscribe("onAdditionalInfosRequired",y)}v.setDisplayOnlyCapturesFlag(h.getPreference("3DAnnotDisplayCapturesPref"));G.backgroundColor="#"+new t.Color(L.getViewer().backgroundColor).getHexString();var at=v.buildPanel(G);if(at){var ar,ap=313;var aq=N();var aw=window&&window.widget?window.widget.id:"";if(sessionStorage.getItem("CAT3DAnnotBrowserExpFlag_"+aw)==="true"){ar=parseFloat(sessionStorage.getItem("CAT3DAnnotBrowserWidth_"+aw))}if(!ar){ar=O!==undefined?O:aq}ar=ar>=aq?ar:aq;if(!X){var au={id:"CAT3DAnnotBrowserPanel",className:"CAT3DAnnotBrowserSidePanel",title:k.BrowserPanelTitle,showTitleFlag:false,icon:e.getWebappsAssetUrl("CAT3DAnnotationBaseCmds","icons/32/")+"I_CAT3DAnnotBrowser.png",immersiveFrame:L.getFrameWindow().getImmersiveFrame(),content:at,minWidth:aq,width:ar,widthStep:165,minHeight:ap,height:ap,heightStep:129,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:P.defaultDockingSide==="right"?WUXDockAreaEnum.RightDockArea:WUXDockAreaEnum.LeftDockArea,onPanelResizedCB:function(ax){if(ax.currentDockArea===WUXDockAreaEnum.RightDockArea||ax.currentDockArea===WUXDockAreaEnum.LeftDockArea){O=ax.width;if(ax.widthModifiedInteractively){var ay=window&&window.widget?window.widget.id:"";sessionStorage.setItem("CAT3DAnnotBrowserExpFlag_"+ay,"true");sessionStorage.setItem("CAT3DAnnotBrowserWidth_"+ay,ax.width)}}}};X=new p(au)}else{X.setMinWidth(aq)}X.setEnableFlag(u>=0)}if(X&&v){X.setPanelVisibilityFlag(V&&v.getThumbnailsIDPaths().length!==0)}T()};var U=function(){var ar=window&&window.widget?window.widget.id:"";if(typeof sessionStorage!=="undefined"){var ap=sessionStorage.getItem("CAT3DAnnotBrowserExpFlag_"+ar);if(ap==="true"){sessionStorage.setItem("CAT3DAnnotBrowserExpFlag_"+ar,"false");X.setWidth(N())}else{var aq=parseFloat(sessionStorage.getItem("CAT3DAnnotBrowserWidth_"+ar));if(aq&&aq!==N()){sessionStorage.setItem("CAT3DAnnotBrowserExpFlag_"+ar,"true");X.setWidth(aq)}}}};var N=function(){var ap=0;for(var ar=0;ar<G.length;ar++){if(G[ar].children){for(var au=0;au<G[ar].children.length;au++){var at=G[ar].children[au];if(at.isVisible){for(var av=0;av<at.children.length;av++){var aq=at.children[av];if((aq.type==="RootViews"||aq.type==="RootCaptures")&&aq.children.length>0){ap++;break}}}}}}return(ap===0||ap===1)?186:211};var W=function(ap){var aq=aj(ap.idPath);if(aq){ab.displayFTAViewOrCapture({path:aq,data:aq.getLastElement(true).getAnnotationType()===6?{label:ap.label,icon:ap.icon.replace("icons/22/","icons/32/")}:null});if(D&&!("requestIdleCallback" in window)&&!aq.getLastElement(true).previewUpdated){v.setAdditionalInformations([{idPath:ap.idPath,infos:{preview:null}}])}}};var an=function(){var ar=a.getCommand("CAT3DAnnotationResetDisplayHistoryHdr",L.getCommandContext?L.getCommandContext():null);if(ar){ar.begin();var ap=v.getThumbnailsIDPaths();var at=[];for(var aq=0;aq<ap.length;aq++){at.push({idPath:ap[aq],infos:{displayFlag:false}})}if(at.length){v.setAdditionalInformations(at)}}};var y=function(au){if(!au){return}var ax=[];for(var ar=0;ar<au.length;ar++){var av=aj(au[ar].idPath);if(av){var aq=av.getLastElement(true);var ap=au[ar].dataTypes;var aw={idPath:au[ar].idPath,infos:{}};for(var at=0;at<ap.length;at++){if(ap[at]==="preview"){aw.infos.preview=aq.getPreview()}else{if(ap[at]==="displayFlag"){aw.infos.displayFlag=aq.getDisplayFlag()}}}ax.push(aw)}}v.setAdditionalInformations(ax)}}});var b=[];var n=s.singleton({init:function(){},give3DAnnotBrowserController:function(v){if(v&&v.context){for(var u=0;u<b.length;u++){if(b[u].context===v.context){return b[u].browserController}}}return undefined},get3DAnnotBrowserController:function(v){var w;if(v&&v.context){w=this.give3DAnnotBrowserController(v);if(!w){var u=new f({ctxViewer:v.context,defaultDockingSide:v.defaultDockingSide});w=Object.freeze({setActiveState:function(x){if(u){u.setActiveState(x)}},getActiveState:function(){if(u){return u.getActiveState()}return null},setPanelVisibilityFlag:function(x){if(u){u.setPanelVisibilityFlag(x)}},getPanelVisibilityFlag:function(){if(u){return u.getPanelVisibilityFlag()}return null},clearController:function(){if(u){u.clearController();u=null}},setDataModelMethods:function(z,y,B,A,x,C){if(u&&!u.dataModelInitialized){u.getDataModel=z;u.addClipping=y;u.removeClipping=B;u.getCurrentClipping=A;u.reframe=x;u.getOverloadedPaths=C;u.dataModelInitialized=true;if(u.getActiveState()){u._internalRefresh()}}}});b.push({context:v.context,browserController:w})}}return w},unreference3DAnnotBrowserController:function(v){if(v&&v.context){for(var u=0;u<b.length;u++){if(b[u].context===v.context){b[u].browserController.clearController();b.splice(u,1);break}}}}});return n});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationBrowserCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext","DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController"],function(d,b,a){var c=d.extend({init:function(g){this._parent(g,{});var j=this;var h;var i=this.onStateChange(function(){if(!h){h=b.get()}var k=j.options&&j.options["arguments"]&&j.options["arguments"].length===1&&j.options["arguments"][0].ID==="defaultDockingSide"?j.options["arguments"][0].Value:null;a.get3DAnnotBrowserController({context:h,defaultDockingSide:k}).setActiveState(j.getState());localStorage.setItem("CAT3DAnnotationBrowserCmd",j.getState()?"true":"false")});var f=this._destroy;this._destroy=function(){if(h){a.unreference3DAnnotBrowserController({context:h})}j._modelEvents.unsubscribe(i);f.call(j)};var e=localStorage.getItem("CAT3DAnnotationBrowserCmd");e=e==="true"?true:(e==="false"?false:undefined);this.setState(e===false?false:true,true)},_destroy:function(){this._parent()}});return c});