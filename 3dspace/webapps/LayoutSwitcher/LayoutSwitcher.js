define("DS/LayoutSwitcher/GridLayoutConverter",["UWA/Core"],function(b){function a(c,k){var l=[],v=[],u=[],p=c.elements.wrapper,d=p.getBoundingClientRect(),r=c.minWidgetWidth*c.cols/p.scrollWidth;function m(w){return Math.max(0,Math.round(r*(w.left-d.left)/c.minWidgetWidth-0.5))+1}function n(w){return Math.max(0,Math.round((w.top-d.top)/c.minWidgetHeight-0.5))+1}function i(w){return Math.min(Math.min(Math.max(c.minSizex,Math.ceil(r*w.width/c.minWidgetWidth-0.5)),c.cols))}function h(w){return Math.max(c.minSizey,Math.ceil(w.height/c.minWidgetHeight-0.5))}function q(x,w){return !(w.col>x.col-1+x.sizex||w.col-1+w.sizex<x.col||w.row>x.row-1+x.sizey||w.row-1+w.sizey<x.row)}function e(w){return w.col-1+w.sizex>c.cols}function t(z,y){var w=[],x=[];w[0]=Math.max(z.row,y.row);w[1]=Math.min(z.row+z.sizey-1,y.row+y.sizey-1);x[0]=Math.max(z.col,y.col);x[1]=Math.min(z.col+z.sizex-1,y.col+y.sizex-1);return{horizontal:Math.max(0,w[1]-w[0]),vertical:Math.max(0,x[1]-x[0])}}function g(y,w){var x=t(y,w);return q(y,w)&&x.horizontal>0&&x.horizontal>=x.vertical}function f(y,w){var x=t(y,w);return q(y,w)&&x.vertical>0&&x.vertical>=x.horizontal}function s(y){var w=[];function x(z){if(!z){return{col:1,row:1,sizex:c.cols}}return l.filter(function(A){return A.widgetId===z})[0]}v.forEach(function(A){var z;if(y.widgetId===A.w1){z=x(A.w2)}else{if(y.widgetId===A.w2){z=x(A.w1)}}if(z){w.push({side:A.side,position:z})}});return w}function j(x){var w=b.clone(x),y=s(w);l.forEach(function(z){if(z===x){return}while(g(w,z)){if(w.col>z.col){++w.col}else{if(w.sizex>c.minSizex){--w.sizex}else{break}}}while(f(w,z)){if(w.row>z.row){++w.row}else{if(w.sizey>c.minSizey){--w.sizey}else{break}}}});y.forEach(function(z){switch(z.side){case"left":w.sizex+=w.col-z.position.col;w.col=z.position.col;break;case"top":w.sizey+=w.row-z.position.row;w.row=z.position.row;break;case"right":if(w.col+c.minSizex-1<=c.cols){w.sizex=Math.max(z.position.col+z.position.sizex-w.col,c.minSizex)}break;case"bottom":w.sizey=Math.max(z.position.row+z.position.sizey-w.row,c.minSizey);break}});if(w.col+c.minSizex-1<=c.cols&&e(w)){w.sizex=c.cols-w.col+1}return w}function o(z){var x=b.clone(z),y=false;function w(A){if(z===A){return}while(e(x)||q(x,A)){if(e(x)){x.col=1;++x.row;y=true}else{++x.col}}}do{y=false;l.forEach(w)}while(y);return x}k.forEach(function(x,y){var w={left:x.left,top:x.top,width:x.width,height:x.height};w.widgetId=y;u.push(w)});u.forEach(function(w,x){function y(A,z,B){v.push({w1:A.widgetId,w2:z.widgetId,side:B})}if(Math.round(w.left)===Math.round(d.left)){y(w,{},"left")}if(Math.round(w.top)===Math.round(d.top)){y(w,{},"top")}if(Math.round(w.left+w.width)===Math.round(d.left+d.width)){y(w,{},"right")}u.forEach(function(z,A){if(A>=x){return}if(Math.round(w.left)===Math.round(z.left)){y(w,z,"left")}if(Math.round(w.top)===Math.round(z.top)){y(w,z,"top")}if(Math.round(w.left+w.width)===Math.round(z.left+z.width)){y(w,z,"right")}if(Math.round(w.top+w.height)===Math.round(z.top+z.height)){y(w,z,"bottom")}})});u.sort(function(x,w){return x.top-w.top||x.left-w.left}).forEach(function(w){l.push(j({widgetId:w.widgetId,col:m(w),row:n(w),sizex:i(w),sizey:h(w)}))});l.slice().forEach(function(w,x){l[x]=j(w);if(e(w)){l[x]=o(j(w));v=v.filter(function(y){return[y.w1,y.w2].indexOf(w.widgetId)===-1})}});return l}return{getGridCoordinates:a}});define("DS/LayoutSwitcher/SwitchableLayout",["UWA/Class"],function(a){function b(){throw new Error("Unimplemented abstract method")}var c=a.extend({name:"",init:function(d){this.widget=d.widget;this.switcher=d.switcher},setup:b,getDefaultConfig:b,refresh:b,serializeChildren:b,loadChild:b,addChild:b,removeChild:b,getChildCoordinates:b,getDuplicatedChildCoordinates:b,destroy:b,clean:b,buildFrom:b});c.getNew=function(e,d){return new (c.getClass(e))(d)};c.getClass=function(d){switch(d){case"grid":return require("DS/LayoutSwitcher/GridLayout");case"dock":return require("DS/LayoutSwitcher/DockLayout");default:throw new Error("Unkown layout type "+d)}};c.acceptsCoordinates=b;return c});define("DS/LayoutSwitcher/DockLayoutConverter",["DS/WebappsUtils/Map"],function(b){function a(l){var p=l.slice(),j;function x(C,B,A){for(var z=0;z<C.length;++z){if(C[z]===B){return}if(A(C[z],B)>0){C.splice(z,0,B);return}}C.push(B)}function s(B,A){var z=B.indexOf(A);if(z>-1){B.splice(z,1)}}function v(z){return{x:z.left+z.width/2,y:z.top+z.height/2}}function m(z,A){if(z===A){return true}if(!z.type){return false}return z.reduce(function(B,C){return B||m(C,A)},false)}function d(A,z,G,E){var F={x:z.x-A.x,y:z.y-A.y},B={x:E.x-G.x,y:E.y-G.y},D=F.x*B.y-F.y*B.x,C,I,H;if(D===0){return false}C={x:G.x-A.x,y:G.y-A.y};I=(C.x*B.y-C.y*B.x)/D;if(I<0||I>1){return false}H=(C.x*F.y-C.y*F.x)/D;if(H<0||H>1){return false}return true}function r(A,z){var C=v(A),B=v(z),D;D=p.filter(function(I){if(m(A,I)||m(z,I)){return false}var H={x:I.left,y:I.top},G={x:I.left+I.width-1,y:I.top},E={x:I.left,y:I.top+I.height-1},F={x:I.left+I.width-1,y:I.top+I.height-1};return d(C,B,H,G)||d(C,B,G,F)||d(C,B,F,E)||d(C,B,E,H)});return D.length===0}function i(B,A,C){var z=[];if(C==="horizontal"){z[0]=Math.max(B.top,A.top);z[1]=Math.min(B.top+B.height-1,A.top+A.height-1)}else{z[0]=Math.max(B.left,A.left);z[1]=Math.min(B.left+B.width-1,A.left+A.width-1)}return Math.max(0,z[1]-z[0])}function q(A,z){return !(z.left>A.left+A.width-1||z.left+z.width-1<A.left||z.top>A.top+A.height-1||z.top+z.height-1<A.top)}function w(B,A){var E=A.left>B.left?B:A,C=A.left>B.left?A:B,D,z={left:E.left+E.width,top:(D=Math.max(E.top,C.top)),width:C.left-(E.left+E.width),height:Math.min(E.top+E.height,C.top+C.height)-D,};return i(B,A,"horizontal")>0&&p.filter(function(F){return q(F,z)}).length===0}function g(B,A){var E=A.top>B.top?B:A,C=A.top>B.top?A:B,D,z={left:(D=Math.max(E.left,C.left)),top:E.top+E.height,width:Math.min(E.left+E.width,C.left+C.width)-D,height:C.top-(E.top+E.height),};return i(B,A,"vertical")>0&&p.filter(function(F){return q(F,z)}).length===0}function e(A,z){return A.top===z.top&&A.height===z.height&&w(A,z)}function h(A,z){return A.left===z.left&&A.width===z.width&&g(A,z)}function k(B,A,z){B.left=Math.min(A.left,z.left);B.top=Math.min(A.top,z.top);B.width=Math.max(A.left+A.width-z.left,z.left+z.width-A.left);B.height=Math.max(A.top+A.height-z.top,z.top+z.height-A.top)}function u(B,A,E){function D(G,F){var J=v(G),H=v(F),I=E==="row"?"x":"y";return J[I]-H[I]}var z=[],C;if(B.type===E&&A.type===E){A.forEach(function(F){x(B,F,D)});s(l,A);C=B}else{if(B.type===E){x(B,A,D);s(l,A);C=B}else{if(A.type===E){x(A,B,D);s(l,B);C=A}else{x(z,B,D);s(l,B);x(z,A,D);s(l,A);C=z;z.type=E;l.push(z)}}}j=true;k(C,B,A)}function f(A,z){if(e(A,z)){u(A,z,"row")}}function t(A,z){if(h(A,z)){u(A,z,"column")}}function o(){var z=false;[f,t].forEach(function(A){if(z){return}l.slice().forEach(function(B){l.slice().forEach(function(C){if(B===C||l.indexOf(B)===-1){return}A(B,C)})});z=j})}function n(){var G,F,I=new b(),H=0,B=Infinity,z=Infinity,D=[],A=[];function C(K,J){var N={horizontal:[],vertical:[]},L=I.get(K)||N,M=I.get(J)||N;return L.horizontal.length+L.vertical.length+M.horizontal.length+M.vertical.length}function E(K,J){return !(K.type||J.type)||r(K,J)&&!q(K,J)}l.forEach(function(J){I.set(J,{horizontal:[],vertical:[]});l.forEach(function(K){if(J===K){return}if(w(J,K)&&E(J,K)){I.get(J).horizontal.push(K)}else{if(g(J,K)&&E(J,K)){I.get(J).vertical.push(K)}}})});I.forEach(function(K,J){K.horizontal.concat(K.vertical).forEach(function(L){var N=C(J,L),M=Math.min(C(J),C(L));if(N<=B&&N>0&&M<z){B=N;z=M}})});I.forEach(function(K,J){K.horizontal.concat(K.vertical).forEach(function(L){if(C(J,L)===B&&Math.min(C(J),C(L))===z){D.push([J,L])}})});D.forEach(function(P){var M=P[0],L=P[1],O=w(M,L)?"horizontal":"vertical",N=O==="horizontal"?"height":"width",K=i(M,L,O)/Math.max(M[N],L[N]),J=false;if(A.filter(function(Q){return Q[0]===M&&Q[1]===L||Q[0]===L&&Q[1]===M}).length>0){return}I.get(M)[O==="horizontal"?"vertical":"horizontal"].forEach(function(Q){var R,S;R={};k(R,M,Q);S=i(R,L,O)/Math.max(R[N],L[N]);J=J||S>K;if(J){A.push(P)}});if(K>H&&!J){H=K;G=M;F=L}});if(!G||!F){return}u(G,F,w(G,F)?"row":"column")}function y(){var F=[],C=l.map(function(J){var I=v(J);I.rectangle=J;return I}),H,D,A,E,G,B;function z(I){return Math.sqrt(I.x*I.x+I.y*I.y)}C.forEach(function(J,I){C.forEach(function(L,K){if(K>=I){return}F.push({p1:J,p2:L,vector:{x:L.x-J.x,y:L.y-J.y}})})});F.sort(function(J,I){return z(J.vector)-z(I.vector)||J.p1.y-J.p2.y||J.p1.x-J.p2.x});H=F[0];D=H.p1.rectangle;A=H.p2.rectangle;G=i(D,A,"horizontal");B=i(D,A,"vertical");E=Math.acos(H.vector.x/z(H.vector));u(D,A,Math.max(G,B)>0?G>B?"row":"column":Math.abs(E)<Math.PI/4||Math.abs(E)>3*Math.PI/4?"row":"column")}j=true;l=l.slice();while(l.length>1&&j){l.sort(function(A,z){var C=v(A),B=v(z);return C.y-B.y||C.x-B.x});j=false;o();if(!j&&l.length>1){n();if(!j){y()}}}return l[0]}function c(f){var d=[];function e(i){var h={},j,g;if(!i){return{}}if(i.type){h.type=i.type;j=h.type==="row"?"width":"height";h.content=i.map(function(k){return e(k)});g=i.reduce(function(k,l){return k+l[j]},0);h.content.forEach(function(l,k){l.weight=100*i[k][j]/g})}else{h.type="item";h.content=i.widgetId}return h}f.forEach(function(g,h){d.push({widgetId:h,left:g.left,top:g.top,width:g.width,height:g.height})});return e(a(d))}return{getStructure:c}});define("DS/LayoutSwitcher/BreakpointUtils",["UWA/Core","UWA/Class","DS/UWPClientControls/Utils"],function(d,a,c){var b=a.extend({init:function(){this.breakpoint=c.getPlatform()},getPriorityMap:function(){return[this.breakpoint,"desktop","tablet","mobile"]},getBreakpointAwareData:function(f){var e;this.getPriorityMap().forEach(function(g){if(e==null){e=f[g]}});return e},getLayoutAndBreakpointAwareChildrenCoordinates:function(h,j){var i=this.getPriorityMap(),f=i.length,e={},g={};h.forEach(function(k){e[k.id]=j(JSON.parse(k.coordinates));i.forEach(function(l,m){if(e[k.id][l]!=null){f=Math.min(f,m)}})},this);h.forEach(function(k){g[k.id]=e[k.id][i[f]]});return g},getUpdatedCoordinates:function(f,g){var e={};e[this.breakpoint]=g;return d.extend(d.clone(f),e)},getBreakpointAgnosticStringifiedCoordinates:function(g){var f;try{f=JSON.parse(g)}catch(h){}if(f==null){g='"'+(g+"").trim()+'"'}else{if(this.getBreakpointAwareData(f)!=null){return g}}return'{"'+this.breakpoint+'":'+g+"}"}});return b});define("DS/LayoutSwitcher/GridLayout",["UWA/Core","DS/WebappsUtils/Map","DS/UWPClientControls/Grid","DS/LayoutSwitcher/SwitchableLayout","DS/LayoutSwitcher/GridLayoutConverter"],function(f,b,a,e,c){var d=e.extend({name:"grid",init:function(){this._parent.apply(this,arguments)},setup:function(j){var k=j.children,i=j.config,l={},h,m,g;this._widgetElToId=new b();if(this._previousLayoutCoordinates){h=new a(i);m=c.getGridCoordinates(h,this._previousLayoutCoordinates);h.destroy();this._previousLayoutCoordinates=undefined;m.forEach(function(n){var o=f.clone(n);delete o.widgetId;l[n.widgetId]={};l[n.widgetId][this.switcher.breakpoint]=o},this)}k.forEach(function(q){var n=this.widget.body.getElement(".wi-"+q.id),o;q.el=n||q.el;this._widgetElToId.set(q.el,q.id);try{q.parsedCoordinates=f.extend(f.clone(i.defaultCoordinates||{}),l[q.id]||q.parsedCoordinates||(this.switcher.getLayoutSpecificCoordinates(JSON.parse(q.coordinates))||{})[this.switcher.breakpoint]||{});o=f.extend({el:q.el},q.parsedCoordinates);i.widgets.push(o)}catch(p){i.widgets.push({el:q.el})}},this);this.grid=new a(i);if(this.grid.breakpoint.name){g=this.grid.breakpoint.name;k.sort(function(o,n){if(!o.parsedCoordinates||!n.parsedCoordinates){return 0}return(o.parsedCoordinates[g]&&o.parsedCoordinates[g].row)-(n.parsedCoordinates[g]&&n.parsedCoordinates[g].row)})}return this.grid},getDefaultConfig:function(){this.refresh();return{el:this.widget.body,handle:".moduleHeader *",widgets:[],serialize:(function(h,g){return{id:this._widgetElToId.get(h),coordinates:JSON.stringify(g)}}).bind(this),containerWidth:this.gridWidth,baseX:this.gridOffsets.x,baseY:this.gridOffsets.y,events:{onDrop:this.switcher.reorder.bind(this.switcher),onResize:this.switcher.reorder.bind(this.switcher)}}},refresh:function(){this.gridOffsets=this.widget.body.getOffsets();this.gridWidth=this.widget.body.getSize().width},serializeChildren:function(){if(!this.grid){return}return this.grid.serialize().map(function(h){var g=JSON.parse(h.coordinates);return{id:h.id,coordinates:g[this.switcher.breakpoint]||g}},this)},loadChild:function(){},addChild:function(g){this.grid.add(f.extend({el:g.el},g.coordinates||{}));this._widgetElToId.set(g.el,g.id)},removeChild:function(g){this.grid.remove({widget:g});this._widgetElToId["delete"](g)},getChildCoordinates:function(g){var h=f.extend({},this.grid.findWidget(g));delete h.el;return h[this.switcher.breakpoint]||h},getDuplicatedChildCoordinates:function(g){return this.getChildCoordinates(g)},destroy:function(){this.grid&&this.grid.destroy()},clean:function(){var g=this.grid;this.widget.body.getElements("."+g.options.widgetClassName).forEach(d.cleanupWidget.bind(null,g));g.elements.container.removeClassName(g.name)},buildFrom:function(g,h){this._previousLayoutCoordinates=h}});d.cleanupWidget=function(g,h){var i=g.options;h.removeClassName(i.widgetClassName);["data-col","data-row","data-sizex","data-sizey"].forEach(function(j){h.removeAttribute(j)});h.getElements("."+i.resizeClassName).forEach(function(j){j.remove()})};d.acceptsCoordinates=function(k){var j=true;try{for(var g=0;g<k.length&&j;++g){j=j&&k[g].col>0&&k[g].row>0&&k[g].sizex>0&&k[g].sizey>0}}catch(h){j=false}return j};return d});define("DS/LayoutSwitcher/DockLayout",["UWA/Core","DS/WebappsUtils/Map","DS/UWPClientControls/DockLayout/Manager","DS/LayoutSwitcher/SwitchableLayout","DS/LayoutSwitcher/DockLayoutConverter"],function(d,c,g,b,i){function e(q){var p={};function o(s,t,r){if(s.type==="item"){p[s.content]={weight:s.weight,index:r,containers:t}}else{s.content.forEach(function(v,u){o(v,[{type:s.type,index:r||0,weight:s.weight}].concat(t||[]),u)})}}q&&o(q);return p}function m(p){var o={content:[]};Object.keys(p).forEach(function(u){var s=p[u],v=s.containers.slice(0).reverse(),t={type:"item",content:u,weight:s.weight},r,w,q=o;for(r=0;r<v.length;++r){w=v[r];q.content[w.index]=q.content[w.index]||{type:w.type,content:[],weight:w.weight};q=q.content[w.index]}q.content[s.index]=t});return o.content[0]}function k(r){var o={};function q(s){return typeof s==="number"?Math.round(s):1}function p(s){return s.charAt(0)}Object.keys(r).forEach(function(t){var s=r[t];o[t]=((s.index||0)+" "+q(s.weight)+" "+(s.containers||[]).map(function(u){return(p(u.type)+" "+u.index+" "+q(u.weight))}).join(" ")).trim().replace(/( |^)0 [0-9]+$/,"")});return o}function f(q){var p={};function o(r){if(r==="r"){return"row"}if(r==="c"){return"column"}throw new Error("Invalid compressed type "+r)}Object.keys(q).forEach(function(r){var s=(q[r]+" 0 1").trim().split(" ");p[r]={index:parseInt(s.shift()),weight:parseInt(s.shift()),containers:[]};while(s.length){p[r].containers.push({type:o(s.shift()),index:parseInt(s.shift()),weight:parseInt(s.shift())})}});return p}function n(o){return d.createElement("div",{"class":"dock-placeholder",id:"placeholder-"+o})}function j(r,q,p){var o=r.dockItem;o.swapElement(q);o.content=p;q.classList.remove("dock-placeholder")}var h=false,a=false,l;l=b.extend({name:"dock",init:function(){this._parent.apply(this,arguments)},setup:function(p){var q=p.children,o=p.config;this._widgetIdToEl=new c();this._deletedWidgetIds=[];this._consecutivePossibleCleanUndo=0;this._consecutiveUndoableResize=0;this._idsUnknownToBreakpoint=[];o.structure=this._convertedStructure||this._deserializeChildren(q);this._convertedStructure=undefined;o.leafReviver=(function(s){var r=this._widgetIdToEl.get(s);if(h){h=false;return n(s)}if(a){return r}if(!r){return n(s)}return r}).bind(this);q.forEach(function(r){this._widgetIdToEl.set(r.id,r.el)},this);this.manager=new g(o);this._idsUnknownToBreakpoint.forEach(function(r){this.addChild({id:r,el:this._widgetIdToEl.get(r)})},this);this._idsUnknownToBreakpoint=undefined;return this.manager},getDefaultConfig:function(){return{container:this.widget.body,onChange:(function(o){if(o==="remove"){++this._consecutivePossibleCleanUndo}else{if(o==="addChild"&&a){this._consecutivePossibleCleanUndo=Math.max(this._consecutivePossibleCleanUndo-1,0)}else{if(o!=="resize"){this._consecutivePossibleCleanUndo=0}}}if(o==="resize"){++this._consecutiveUndoableResize}else{this._consecutiveUndoableResize=0}if(["addChild","removeChild","reorder","resize"].indexOf(o)!==-1){this.switcher.reorder()}}).bind(this)}},refresh:function(){},serializeChildren:function(){if(!this.manager){return}var o=this.manager.serialize(),q,p;if(!o){return[]}q=e(JSON.parse(o||"null"));p=k(q);return Object.keys(p).map(function(r){return{id:r,coordinates:p[r]}})},_deserializeChildren:function(p){var o={};p.forEach(function(q){o[q.id]=q.parsedCoordinates},this);Object.keys(o).forEach(function(q){if(o[q]==null){this._idsUnknownToBreakpoint.push(q);delete o[q]}},this);return m(f(o))},addChild:function(p){var s=this.widget.body.getElement(".dock-placeholder"),t=p.id,r=p.el,o=this._deletedWidgetIds.indexOf(t);if(s){s.parentElement.appendChild(r);r.dockItem=s.dockItem;s.removeClassName("dock-placeholder")}else{this._widgetIdToEl.set(t,r);if(o===0){this._deletedWidgetIds.shift();a=true;if(o===0&&this._consecutivePossibleCleanUndo>0){for(var q=0;q<this._consecutiveUndoableResize+1;++q){this.manager.undo(true)}this.manager.paint()}else{this._addItemAtTheTop(t)}a=false}else{this._addItemAtTheTop(t);this._deletedWidgetIds=[]}this.manager.paint()}setTimeout((function(){if(s){j(s,r,t);s.remove()}this._widgetIdToEl.set(t,r);if(o===-1){this.manager.onChange("addChild")}}).bind(this))},_addItemAtTheTop:function(o){(this.manager.root.content||this.manager.root).getDropTargets().filter(function(p){return["top","root"].indexOf(p.name)!==-1})[0].createItems([o])},loadChild:function(q){var p=this.widget.body.getElement("#placeholder-"+q),o=this._widgetIdToEl.get(q);if(!p){return}p.parentElement.appendChild(o);o.setAttribute("style",p.getAttribute("style"));o.addClassName("dock-item");j(p,o,q);p.remove()},removeChild:function(o){var p=o.dockItem,q=p.content;this._deletedWidgetIds.unshift(q);this._widgetIdToEl["delete"](q);p.remove(true)},getChildCoordinates:function(o){var p;this._widgetIdToEl.forEach(function(q,r){if(o===q){p=r}});return this.serializeChildren().filter(function(q){return q.id===p})[0].coordinates},getDuplicatedChildCoordinates:function(o){h=true;var p="_duplicate"+Date.now(),q=o.dockItem.duplicate(true);q.content=p;return this.serializeChildren().filter(function(r){return r.id===p})[0].coordinates},destroy:function(){if(!this._widgetIdToEl){return}this.clean();this._widgetIdToEl=undefined},clean:function(){this.manager.freeze();this.widget.body.getElements(".dock-item").forEach(function(o){l.cleanupWidget(o);o.removeAttribute("style")})},buildFrom:function(o,p){this._convertedStructure=i.getStructure(p);if(Object.keys(this._convertedStructure).length===0){this._convertedStructure=undefined}}});l.cleanupWidget=function(o){o.removeClassName("dock-item");o.removeClassName("dock-dragging");o.removeClassName("dock-maximized");o.removeClassName("dock-minimized")};l.acceptsCoordinates=function(p){try{m(f(p))}catch(o){return false}return true};return l});define("DS/LayoutSwitcher/Switcher",["UWA/Core","UWA/Class","DS/UWPClientCode/Data/Widgets","DS/UWPClientCode/PublicAPI","DS/UWPClientCode/WidgetFactory","DS/UWPClientControls/LazyLoader","DS/PubSub/PubSub","DS/WebappsUtils/Map","DS/LayoutSwitcher/BreakpointUtils","DS/LayoutSwitcher/SwitchableLayout","DS/LayoutSwitcher/GridLayout","DS/LayoutSwitcher/DockLayout"],function(i,c,m,b,g,l,o,d,h,a){function j(){}function k(q,r){return q.filter(function(s){return s.id===r},this)[0]}function n(r){var q=r.data;Object.defineProperty(r,"data",{get:function(){return q},set:function(){}});r._dataHasChanged=false;r.getValue=function(s){return r.data[s]};r.setValue=function(s,t){r._dataHasChanged=true;return(r.data[s]=t)};r.setValues=function(s){Object.keys(s).forEach(function(t){r.setValue(t,s[t])})};r.deleteValue=function(s){r._dataHasChanged=true;delete r.data[s]}}function p(){return{init:undefined,onBeforeLoad:j,onAfterLoad:j,onDestroy:j,onAddChild:j,onRemoveChild:undefined,onShow:j,onHide:j,onBeforeConvert:j,onAfterConvert:j}}function e(q,r){q.forEach(function(s){if(s.widget){s.widget.environment.setVisible(r)}})}var f=c.extend({init:function(q){this.widget=q.widget;n(this.widget);this.env=this.widget.environment;this.wp=this.env.wp;this.contextType=this.wp.allowedChildrenContextType;this.breakpointUtils=new h();this.breakpoint=this.breakpointUtils.breakpoint;this.nonMutatedParent={id:this.wp.id,name:this.wp.name,isEditable:this.wp.isEditable};this.module=p();this.wp.children=[];this._migrateLayout2018xFD05ToFD06();this.activeLayout=this._getNewActiveLayout();this.show=(function(){this.module.onShow.call(this,this.widget);e(this.wp.children,true)}).bind(this);this.hide=(function(){this.module.onHide.call(this,this.widget);e(this.wp.children,false)}).bind(this);if(this.contextType){b.getActiveContext({type:this.contextType,success:this.setup.bind(this),failure:this.setup.bind(this)})}else{this.setup()}},setup:function(r){var q=this.widget.getValue("module");this.contextId=r&&r.modelId;this.activeLayout.refresh();if(!this.contextId||!this.contextType){this.contextType=null;this.contextId=null}if(q){require([q],(function(s){Object.keys(s).forEach(function(t){this.module[t]=s[t]},this);if(i.is(this.module.init,"function")){this.module.init.call(this,this.widget,this.refresh.bind(this))}else{this.refresh()}}).bind(this),this.refresh)}else{this.refresh()}},refresh:function(){if(this.wp.isVisible){this.activeLayout.refresh();this.clean();this.display()}},display:function(){if(this.widget.getValue("isTransientMode")){this.parse({})}else{if(this.contextId||this.contextType){b.getContext({id:this.contextId,type:this.contextType,success:(function(q){m.getWidgetInstanceChildren({id:this.nonMutatedParent.id,contextType:this.contextType,contextId:this.contextId,cacheId:((window.wap||{}).widgetInstancesCacheId||"")+q.cacheId,success:this.parse.bind(this)})}).bind(this),failure:function(q){throw q}})}else{m.getWidgetInstanceChildren({id:this.nonMutatedParent.id,cacheId:(window.wap||{}).widgetInstancesCacheId,success:this.parse.bind(this)})}}},getLayoutSpecificCoordinates:function(r){var q=this.widget.getValue("layout"),s={};Object.keys(q).forEach(function(t){if(q[t]===this.activeLayout.name&&t in r){s[t]=r[t]}},this);return s},parse:function(q){var s=q.children||[],r;this._setChildrenParsedCoordinates(s);this._fixDesyncBetweenLayoutAndCoordinates(q.children);this.env.setEditable(this.wp.isEditable||false);if(!o.has("widget-"+this.widget.id)){o.add("widget-"+this.widget.id,(function(u,t){this[u+"Widget"](t[0],this.reorder.bind(this))}).bind(this))}r=this.activeLayout.getDefaultConfig();this.module.onBeforeLoad.call(this,this.activeLayout.name,r,s,this.widget);this.setupChildren(s);this.layoutInstance=this.activeLayout.setup({children:s,config:r});this.loadChildren(s);this.module.onAfterLoad.call(this,this.activeLayout.name,this.layoutInstance,this.widget)},setupChildren:function(q){this.lazy&&l.init(this.lazy);q.forEach(function(r){r.el=r.el||i.createElement("div",{"class":"module"});r.parent=this.widget.environment;r.callback=r.callback||j;this.wp.children.push(r)},this)},loadChildren:function(q){if(this.lazy){q.forEach(function(r){l.track({element:r.el,widget:r,callback:(function(){g.load(r,function(){r.callback.apply(r,arguments);l.revalidate()},r.customEnvironment);this.activeLayout.loadChild(r.id)}).bind(this)})},this);setTimeout(function(){l.revalidate()},100)}else{q.forEach(function(r){g.load(r,r.callback,r.customEnvironment);this.activeLayout.loadChild(r.id)},this)}},clean:function(){this.module.onDestroy.call(this,this.widget);this.wp.children.forEach(function(q){if(q.widget&&q.widget.environment){q.widget.environment.destroy()}l.untrack(q.el)},this);this.wp.children=[];this.activeLayout.destroy();this.widget.body.empty();o.remove("widget-"+this.widget.id)},reorder:function(){if(!this.activeLayout){return false}var r=this.activeLayout.serializeChildren();if(!r||r.length===0){return}var q=r.map(function(s){var t=k(this.wp.children,s.id);if(!t){return null}return{id:s.id,coordinates:JSON.stringify(this.breakpointUtils.getUpdatedCoordinates(JSON.parse(t.coordinates||"{}"),s.coordinates))}},this).filter(function(s){return s});if(!q.length){return}if(!this.widget.getValue("layout")[this.breakpoint]){this._setCurrentBreakpointLayout(this.activeLayout.name)}m.reorderWidgetInstances({parentId:this.widget.id,children:q});if(this.widget._dataHasChanged){this.widget._dataHasChanged=false;m.editWidgetInstance({id:this.widget.id,data:this.widget.data})}return r},addWidget:function(q){var r;if(q.configId){i.merge(q,b.getWidgetConfiguration(q.configId)||{})}r={widgetIdOrUrl:q.widgetIdOrUrl||q.widgetId,parentId:this.widget.id,coordinates:this.breakpointUtils.getBreakpointAgnosticStringifiedCoordinates(q.coordinates)};i.merge(r,q);b.addWidgetInstance(r)},showWidget:function(q,s){var r;q.el=i.createElement("div",{"class":"module"});q.parent=this.widget.environment;this.wp.children.push(q);this.activeLayout.addChild({el:q.el,id:q.id,coordinates:this.breakpointUtils.getBreakpointAwareData(JSON.parse(q.coordinates))});if(q.sourceId){r=k(this.wp.children,q.sourceId);q.initialView=r&&r.widget.getView()}g.load(q,s);this.module.onAddChild.call(this,q,this.widget)},duplicateWidget:function(t){var r,q,s;r=k(this.wp.children,t);if(!r||!r.widget){return}q=r.widget.environment;s=JSON.stringify(this.breakpointUtils.getUpdatedCoordinates({},this.activeLayout.getDuplicatedChildCoordinates(q.html.module)));b.copyWidgetInstance({sourceId:t,coordinates:s,name:q.wp.name})},removeWidget:function(t){var s,r,q;s=k(this.wp.children,t);if(!s||!s.widget){return}r=s.widget.environment;q=(function(){this.wp.children=this.wp.children.filter(function(u){return u.id!==t});if(!r.wp){r.wp={id:t}}r.removeWidget(this.reorder.bind(this))}).bind(this);if(i.is(this.module.onRemoveChild,"function")){this.module.onRemoveChild.call(this,s,this.widget,q)}else{q()}},convertTo:function(v){var u=this,q=new d(),r,s,t;r=u.activeLayout;u.activeLayout=a.getNew(v,{widget:u.widget,switcher:u});s=u.activeLayout.getDefaultConfig();return u.module.onBeforeConvert.call(u,r.name,v,s,u.wp.children,u.layoutInstance,u.widget).then(function(){t=u.wp.children;t.forEach(function(w){if(!w.el.parentElement){return}q.set(w.id,w.el.getBoundingClientRect())});u._setCurrentBreakpointLayout(v);u.activeLayout.buildFrom(r,q);u.layoutInstance=u.activeLayout.setup({children:t,config:s});r.clean()}).then(function(){u.module.onAfterConvert.call(u,r.name,v,u.layoutInstance,u.widget)}).then(function(){u.reorder()})},_migrateLayout2018xFD05ToFD06:function(){var r=this.widget.getValue("layout"),q={};if(r==null){q[this.breakpoint]="grid";this.widget.setValue("layout",q)}else{if(typeof r==="string"){this.widget.setValue("layout",{desktop:r,tablet:r,mobile:r})}}},_getCurrentBreakpointLayout:function(){return this.breakpointUtils.getBreakpointAwareData(this.widget.getValue("layout"))||"grid"},_setCurrentBreakpointLayout:function(r){var q={};q[this.breakpoint]=r;this.widget.setValue("layout",i.extend(i.clone(this.widget.getValue("layout")),q))},_getNewActiveLayout:function(){return a.getNew(this._getCurrentBreakpointLayout(),{widget:this.widget,switcher:this})},_fixDesyncBetweenLayoutAndCoordinates:function(s,q){var w=(function(x){this._setCurrentBreakpointLayout(x);this.activeLayout=this._getNewActiveLayout()}).bind(this);var r=this._getCurrentBreakpointLayout(),v=(s||this.wp.children).map(function(x){return x.parsedCoordinates}),u={grid:a.getClass("grid").acceptsCoordinates(v),dock:a.getClass("dock").acceptsCoordinates(v)},t=r==="grid"?"dock":"grid";if(u[r]){return}if(!u[t]){if(!q){w(t);this._setChildrenParsedCoordinates(s);this._fixDesyncBetweenLayoutAndCoordinates(s,true);return}else{t="grid"}}if(this._getCurrentBreakpointLayout()!==t){w(t)}this.activeLayout.refresh();this.clean()},_setChildrenParsedCoordinates:function(q){var r;q.forEach(function(s){s.coordinates=this.breakpointUtils.getBreakpointAgnosticStringifiedCoordinates(s.coordinates)},this);r=this.breakpointUtils.getLayoutAndBreakpointAwareChildrenCoordinates(q,this.getLayoutSpecificCoordinates.bind(this));q.forEach(function(s){s.parsedCoordinates=r[s.id]})}});return f});