/*!  COPYRIGHT DASSAULT SYSTEMES 2017   */
define("DS/3DPlayNavigationScenario/NavigationService",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/VisuEvents/EventsManager","DS/WebUtils/Clock","DS/WebUtils/Joystick","DS/WebRunloop/Runloop","DS/3DPlay/3DPlay","DS/WebSystem/Nls","DS/WebInfraUI/Notification","DS/3DPlayAnnotation3D/AnnotationUtils","DS/Core/PointerEvents","DS/ApplicationFrame/CommandsManager"],function(d,k,e,c,h,f,j,n,l,m,g,b){var o=Math.PI;var i;var a=d.extend({init:function(p){i=this;this._parent(p);this.sensitivity=3;this.defaultRotationSpeed=0.001;this.speedSliderCB=p.speedSliderCB;this.frameWindow=p.frameWindow;this.setSelectionCallBack=p.setSelectionCallBack;this.ctx=this.frameWindow.options.context;if(e._isInit===undefined){e.init()}this._position={x:0,y:0};this._picking={};this._prePicking={};this.setNavigationStates();this.createReframe();this.hideReframe();this._setBBox()},_setBBox:function(){this.bBox=this.frameWindow.getViewer().getNodes()[0].bBox},setNavigationStates:function(){this._navigationState={pause:false,pitch_up:false,pitch_down:false,yaw_right:false,yaw_left:false,roll_left:false,roll_right:false,move_forward_keyboard:false,move_backward_keyboard:false,move_forward_mouse:false,move_backward_mouse:false,move_forward_touch:false,move_backward_touch:false,speed:50};this.touchModeActive=false},runloopCallBack:function(){if(this.TOUCH_JOYSTICKS_ACTIVE===false&&this.clock&&this.navigate===true&&this.mouseMove===true){this.update(this.clock.getDelta())}},updatePostionFromMouseEvent:function(p){if(!this._webGLV6Viewer||!p){return false}if(this.TOUCH_JOYSTICKS_ACTIVE===false&&this.navigate){var q=this._webGLV6Viewer.getMousePosition(p.from[0].getCurrentPosition());this._position.x=q.x;this._position.y=q.y}},updatePostionFromTouchEvent:function(q){if(this.TOUCH_JOYSTICKS_ACTIVE===true){var p=this._webGLV6Viewer.getMousePosition(new k.Vector2(q.x,q.y));this._position.x=p.x;this._position.y=p.y;this.update(0,true)}},updatePostionFromKeybdEvent:function(){console.error("3DPlay : keyboard navigation not available")},update:function(C,z){var v=this;var u=this._currentViewpoint.getUpDirection();var E=this._currentViewpoint.getSightDirection();var D=this._currentViewpoint.getTargetDistance();var x=this._currentViewpoint.getTarget();var q=this._currentViewpoint.getEyePosition();var y=z?this.defaultRotationSpeed:(C*80/100);if(!v.isInsideBboxLimits()||!v.tranlationSpeed){v.tranlationSpeed=(q.distanceTo(v._originalTarget)/180)}var A=v.tranlationSpeed?v.tranlationSpeed:1;if(this._navigationState.speed){A=v.tranlationSpeed*(this._navigationState.speed/100)}if(A<0){A=1}var s=new k.Vector3(0,0,0);s.crossVectors(u,E);var B=(o/2)*y*this._position.x;var r=(o/2)*y*this._position.y;B=-B;r=-r;if(this.NAVIGATION_MODE==="Walk"){r=0}E.applyAxisAngle(u,B);s.applyAxisAngle(u,B);E.applyAxisAngle(s,r);if(this._navigationState.move_forward_mouse===true||this._navigationState.move_backward_mouse===true||this._navigationState.move_forward_touch===true||this._navigationState.move_backward_touch===true){var w=new k.Vector3(0,0,0);w.z=A;if(this._navigationState.move_forward_mouse||this._navigationState.move_forward_touch){w.z=-w.z}var p=this._currentViewpoint.camera.matrixWorld;q=w.applyMatrix4(p)}var t={eyePosition:q,sightDirection:E,distanceToTarget:D,duration:C};this._currentViewpoint.moveTo(t);this.checkLookAt()},checkLookAt:function(){var r=this.frameWindow.getViewer();this.bSphere=this.frameWindow.getViewer().getNodes()[0].bSphere;var u=m.onScreenProjection([this.bSphere.center],r);if(!this.bBox){this.bBox=this.frameWindow.getViewer().getNodes()[0].bBox}var p=m.onScreenProjection(this.bBox.getPoints(),r);this.bBoxViewerFrame=this.frameWindow.getViewerFrame().getBoundingClientRect();var s=this._currentViewpoint.getCameraPosition();var x=false;var w={x:50,y:50,angle:0};if((this.bBoxViewerFrame.left<u[0].x&&u[0].x<this.bBoxViewerFrame.right)&&(this.bBoxViewerFrame.top<u[0].y&&u[0].y<this.bBoxViewerFrame.bottom)){x=true;w.x=u[0].x%this.bBoxViewerFrame.bottom;w.y=u[0].y%this.bBoxViewerFrame.bottom}var q=this.bSphere.center.addScalar(this.bSphere.radius);var v=m.onScreenProjection([q],r);var t=Math.sqrt((v[0].x-u[0].x)*(v[0].x-u[0].x)+(v[0].y-u[0].y)*(v[0].y-u[0].y));if(t/this.bBoxViewerFrame.width<0.025){x=false}if(i.isInsideBboxLimits()){x=true}if(x){this.hideReframe()}else{if(this.bBoxViewerFrame.left<=u[0].x&&u[0].x<=this.bBoxViewerFrame.right){w.x=u[0].x}else{if(u[0].x<this.bBoxViewerFrame.left){w.x=this.bBoxViewerFrame.left;w.angle=90}else{if(this.bBoxViewerFrame.right<u[0].x){w.x=this.bBoxViewerFrame.right-100;w.angle=-90}}}if(this.bBoxViewerFrame.top<=u[0].y&&u[0].y<=this.bBoxViewerFrame.bottom){w.y=u[0].y}else{if(u[0].y<this.bBoxViewerFrame.top){w.y=this.bBoxViewerFrame.top;w.angle=180}else{if(this.bBoxViewerFrame.bottom<u[0].y){w.y=this.bBoxViewerFrame.bottom-100;w.angle=0}}}this.showReframe(w)}},isInsideBboxLimits:function(){if(!this.bBox){this.bBox=this.frameWindow.getViewer().getNodes()[0].bBox}var t=this._currentViewpoint.getCameraPosition();var r=this.bBox.max.x-this.bBox.min.x;var v=this.bBox.max.x+r*0.05;var y=this.bBox.min.x-r*0.05;var q=this.bBox.max.y-this.bBox.min.y;var u=this.bBox.max.y+q*0.05;var x=this.bBox.min.y-q*0.05;var p=this.bBox.max.z-this.bBox.min.z;var s=this.bBox.max.z+p*0.05;var w=this.bBox.min.z-p*0.05;if((y<t.x&&t.x<v)&&(x<t.y&&t.y<u)&&(w<t.z&&t.z<s)){console.log("Inside");return true}else{return false}},updateHeight:function(){var t=this._currentViewpoint.getUpDirection();var u=this._currentViewpoint.getSightDirection();var r=this._currentViewpoint.getTargetDistance();var v=this._currentViewpoint.getTarget();var s=this._currentViewpoint.getEyePosition();var q=this._heightConstraint;var p=new k.Vector3(0,0,0);p.y=q-this._previousHeight;if((q-this._previousHeight)!==0){s.setZ(s.z+((q-this._previousHeight)*(r/250)));this._previousHeight=q;this._currentViewpoint.moveTo({eyePosition:s});i.checkLookAt()}},beginNavigation:function(p){var q=this;this._viewerFrame=this.frameWindow.getViewerFrame();this._webGLV6Viewer=this.frameWindow.getViewer();this._currentViewpoint=this._webGLV6Viewer.currentViewpoint;if(!this._originalTarget){this._originalTarget=this._currentViewpoint.getTarget()}this._currentViewpoint.setControlActive(false);this.setPickingForNavigation();if(this.frameWindow.experience){this.frameWindow.experience.hideRefAxis()}q.NAVIGATION_MODE="Fly";q.TOUCH_JOYSTICKS_ACTIVE=false;this._heightConstraint=0;this._previousHeight=0;this.setKeybdEventsMap();this.runloop=new f({name:"flyWalkNavigation",data:this,func:this.runloopCallBack});this.clock=new c();this.runloop.start();this._currentViewpoint.onCenterCamera(function(){});if(p.touchMode===true){this.beginTouchModeNavigation()}else{this.beginMouseModeNavigation()}},setPickingForNavigation:function(){if(this._webGLV6Viewer.picking){this._picking.activated=this._webGLV6Viewer.picking.activated;this._picking.displayHL=this._webGLV6Viewer.picking.displayHL;this._picking.trapSelection=this._webGLV6Viewer.picking.trapSelection;this._picking.defaultPicking=this._webGLV6Viewer.getDefaultPicking();this._webGLV6Viewer.setPicking({activated:false,displayHL:false,trapSelection:this._picking.trapSelection===true?false:undefined},false)}if(this._webGLV6Viewer.pPicking){this._prePicking.activated=this._webGLV6Viewer.pPicking.activated;this._prePicking.displayHL=this._webGLV6Viewer.pPicking.displayHL;this._prePicking.trapSelection=this._webGLV6Viewer.pPicking.trapSelection;this._webGLV6Viewer.setPrePicking({activated:false,displayHL:false,trapSelection:this._picking.trapSelection===true?false:undefined},false)}this.pickingOff=true},unsetPickingForNavigation:function(){if(UWA.is(this._webGLV6Viewer.picking,"object")&&UWA.is(this._picking,"object")&&UWA.is(this._picking.activated,"boolean")&&UWA.is(this._picking.displayHL,"boolean")&&UWA.is(this._picking.trapSelection,"boolean")&&UWA.is(this._picking.defaultPicking,"boolean")){this._webGLV6Viewer.setPicking({activated:this._picking.activated,displayHL:this._picking.displayHL,trapSelection:this._picking.trapSelection===true?true:undefined},this._picking.defaultPicking)}if(UWA.is(this._webGLV6Viewer.pPicking,"object")&&UWA.is(this._prePicking,"object")&&UWA.is(this._prePicking.activated,"boolean")&&UWA.is(this._prePicking.displayHL,"boolean")&&UWA.is(this._prePicking.trapSelection,"boolean")){this._webGLV6Viewer.setPrePicking({activated:this._prePicking.activated,displayHL:this._prePicking.displayHL,trapSelection:this._picking.trapSelection===true?true:undefined},this._picking.defaultPicking)}this.pickingOff=false},endNavigation:function(){this._currentViewpoint.onCenterCamera(null);this.NAVIGATION_MODE="Fly";this.TOUCH_JOYSTICKS_ACTIVE=false;this.endTouchModeNavigation();this.endMouseModeNavigation();this.unsetKeybdEventsMap();this.displayJoySticks(false);this.destroyReframe();this.clock.stop();this.clock=undefined;this.runloop.stop();this.runloop.dispose();this.runloop=undefined;this._currentViewpoint.setControlActive(true);this.unsetPickingForNavigation();if(this.frameWindow.experience){this.frameWindow.experience.showRefAxis()}this.ctx=undefined},beginMouseModeNavigation:function(){this.setNavigationStates();this.setMouseEventsMap()},endMouseModeNavigation:function(){this.hideReframe();this.setNavigationStates();this.unsetMouseEventsMap()},beginTouchModeNavigation:function(){this.reframeNavigation();this._heightConstraint=0;this._previousHeight=0;this._position.x=0;this._position.y=0;this.setNavigationStates();this.displayJoySticks(true);this.setTouchEventsMap();this.setSelectionCallBack({id:"TouchMode",state:true})},endTouchModeNavigation:function(){this.unsetTouchEventsMap();this.displayJoySticks(false)},displayJoySticks:function(p){var t=this;if(p){this._joystickContainer=UWA.createElement("div",{id:"PlayWeb-joystick-ui-container",styles:{width:t._webGLV6Viewer.SCREEN_WIDTH,height:t._webGLV6Viewer.SCREEN_HEIGHT,"pointer-events":"none"}}).inject(t.frameWindow.getUIFrame());var r=UWA.createElement("div",{id:"PlayWeb-joystick-ui-container-left",styles:{width:t._webGLV6Viewer.SCREEN_WIDTH/2,height:t._webGLV6Viewer.SCREEN_HEIGHT}}).inject(t._joystickContainer);var q=UWA.createElement("div",{id:"PlayWeb-joystick-ui-container-right",styles:{width:t._webGLV6Viewer.SCREEN_WIDTH/2,height:t._webGLV6Viewer.SCREEN_HEIGHT}}).inject(t._joystickContainer);UWA.createElement("div",{id:"PlayWeb-joystick-ui-container-right-zone","pointer-events":"auto"}).inject(q);UWA.createElement("div",{id:"PlayWeb-joystick-ui-container-left-zone","pointer-events":"auto"}).inject(r);var s={left:{zone:document.getElementById("PlayWeb-joystick-ui-container-left-zone"),color:"black",mode:"static",position:{left:"15%",top:"75%"}},right:{zone:document.getElementById("PlayWeb-joystick-ui-container-right-zone"),color:"black",mode:"static",position:{left:"85%",top:"75%"}}};this._joystickLinearMove=new h.create(s.left);this._joystickAngularMove=new h.create(s.right);document.getElementById("PlayWeb-joystick-ui-container-left-zone").setStyle("pointer-events","auto");document.getElementById("PlayWeb-joystick-ui-container-right-zone").setStyle("pointer-events","auto");this.TOUCH_JOYSTICKS_ACTIVE=true}else{if(this._joystickLinearMove){this._joystickLinearMove.destroy()}if(this._joystickAngularMove){this._joystickAngularMove.destroy()}if(this._joystickContainer){this._joystickContainer.destroy()}this._joystickContainer=undefined;this._joystickLinearMove=undefined;this._joystickAngularMove=undefined;this.TOUCH_JOYSTICKS_ACTIVE=false}},createReframe:function(){this.reframeUIMainContainer=UWA.createElement("div",{id:"PlayWeb-reframe-ui-main-container"}).inject(this.frameWindow.getUIFrame());this.reframeUIContainer=UWA.createElement("div",{id:"PlayWeb-reframe-ui-container"}).inject(this.reframeUIMainContainer);this.reframeUIContainer.addEvent(g.POINTERDOWN,this.lookAt)},destroyReframe:function(){if(this.reframeUIMainContainer){this.reframeUIContainer.removeEvent("click",this.lookAt);this.reframeUIMainContainer.destroy()}this.reframeUIMainContainer=undefined},showReframe:function(p){if(p){this.reframeUIContainer.setStyle("top",p.y+"px");this.reframeUIContainer.setStyle("left",p.x+"px");this.reframeUIContainer.style.transform="rotate("+p.angle+"deg)"}this.reframeUIMainContainer.show();this.reframeUIContainer.show()},hideReframe:function(){this.reframeUIMainContainer.hide();this.reframeUIContainer.hide()},setMouseEventsMap:function(){var p=this;this.evtTokenMouse=[];this.evtTokenMouse.push(e.addEvent(this._viewerFrame,"onLeftMouseDown",function(q){p.navigate=true;p.mouseMove=true;p.clock.start();p.updatePostionFromMouseEvent(q);p._navigationState.move_forward_mouse=true}));this.evtTokenMouse.push(e.addEvent(this._viewerFrame,"onLeftMouseUp",function(q){p.updatePostionFromMouseEvent(q);p.clock.stop();p._navigationState.move_forward_mouse=false;p.navigate=false;p.mouseMove=false}));this.evtTokenMouse.push(e.addEvent(this._viewerFrame,"onRightMouseDown",function(q){p.navigate=true;p.mouseMove=true;p.clock.start();p.updatePostionFromMouseEvent(q);p._navigationState.move_backward_mouse=true}));this.evtTokenMouse.push(e.addEvent(this._viewerFrame,"onRightMouseUp",function(q){p.updatePostionFromMouseEvent(q);p.clock.stop();p._navigationState.move_backward_mouse=false;p.navigate=false;p.mouseMove=false}));this.evtTokenMouse.push(e.addEvent(this._viewerFrame,"onMouseMove",function(q){if(p.navigate==true){p.mouseMove=true;p.clock.start();p.updatePostionFromMouseEvent(q)}}));this.evtTokenMouse.push(e.addEvent(this._viewerFrame,"onMiddleMouseDown",function(q){p.navigate=true}));this.evtTokenMouse.push(e.addEvent(this._viewerFrame,"onMiddleMouseUp",function(q){p.checkLookAt();p.clock.stop();p.navigate=false;p.mouseMove=false}))},setKeybdEventsMap:function(){var p=this;this.evtTokenKeybd=[];this.evtTokenKeybd.push(e.addEvent(this._viewerFrame,"onKeyDown",function(q){switch(q.gesture.events[0].event.code||q.gesture.events[0].event.keyCode){case"KeyW":console.log("KeyW");break;case"KeyS":console.log("KeyS");break;case"KeyA":console.log("KeyA");break;case"KeyD":console.log("KeyD");break;case"KeyI":console.log("KeyI");break;case"KeyK":console.log("KeyK");break;case"KeyJ":console.log("KeyJ");break;case"KeyL":console.log("KeyL");break}switch(q.gesture.key){case 107:case 187:p.updateSpeed(5);break;case 109:case 189:p.updateSpeed(-5);break;case 37:break;case 38:break;case 39:break;case 40:break}}))},updateSpeed:function(p){if((typeof p=="number")&&i._navigationState.speed&&(i._navigationState.speed+p>0)&&(i._navigationState.speed+p<=100)){i._navigationState.speed+=p;this.speedSliderCB(i._navigationState.speed)}},setSpeed:function(p){if(i._navigationState.speed&&p>0&&p<=100){i._navigationState.speed=p}},setTouchEventsMap:function(){var w=this;var p={x:0,y:0};p.x=w._webGLV6Viewer.SCREEN_WIDTH/2;p.y=w._webGLV6Viewer.SCREEN_HEIGHT/2;var q=false;var t=null;this._joystickLinearMove.on("start",function(x,y){p.x=w._webGLV6Viewer.SCREEN_WIDTH/2;p.y=w._webGLV6Viewer.SCREEN_HEIGHT/2;w._navigationState.move_forward_touch=false;w._navigationState.move_backward_touch=false;w.updatePostionFromTouchEvent(p);var y={distance:50};t=setInterval(function(z){if(q){if(w._navigationState.roll_left==true||w._navigationState.roll_right==true){w.joystickLinearMoveLeftRight(y)}else{w.updatePostionFromTouchEvent(z)}}},1,p)});this._joystickLinearMove.on("move",function(x,y){if(y&&y.direction&&y.distance){q=(y.distance===50)?true:false;if(y.direction.y==="up"&&y.direction.angle==="up"){w._navigationState.move_forward_touch=true;w._navigationState.move_backward_touch=false;w._navigationState.roll_left=false;w._navigationState.roll_right=false;w.updatePostionFromTouchEvent(p)}if(y.direction.y==="down"&&y.direction.angle==="down"){w._navigationState.move_forward_touch=false;w._navigationState.move_backward_touch=true;w._navigationState.roll_left=false;w._navigationState.roll_right=false;w.updatePostionFromTouchEvent(p)}if(y.direction.x==="left"&&y.direction.angle==="left"){w._navigationState.roll_left=true;w._navigationState.roll_right=false;w.joystickLinearMoveLeftRight(y)}if(y.direction.x==="right"&&y.direction.angle==="right"){w._navigationState.roll_left=false;w._navigationState.roll_right=true;w.joystickLinearMoveLeftRight(y)}}});this._joystickLinearMove.on("end",function(x,y){p.x=w._webGLV6Viewer.SCREEN_WIDTH/2;p.y=w._webGLV6Viewer.SCREEN_HEIGHT/2;w._navigationState.move_forward_touch=false;w._navigationState.move_backward_touch=false;w._navigationState.roll_left=false;w._navigationState.roll_right=false;w.updatePostionFromTouchEvent(p);if(t){clearInterval(t)}});var u=false;var s=null;var v=0;var r={direction:false};this._joystickAngularMove.on("start",function(x,y){p.x=w._webGLV6Viewer.SCREEN_WIDTH/2;p.y=w._webGLV6Viewer.SCREEN_HEIGHT/2;w.updatePostionFromTouchEvent(p);s=setInterval(function(z){if(u){w.updatePostionFromTouchEvent(z)}},1,p)});this._joystickAngularMove.on("move dir",function(x,y){if(y&&y.direction&&y.distance&&y.distance>0){u=(y.distance===50)?true:false;if(r.angle!==y.direction.angle){p.x=w._webGLV6Viewer.SCREEN_WIDTH/2;p.y=w._webGLV6Viewer.SCREEN_HEIGHT/2;w.updatePostionFromTouchEvent(p);r.angle=y.direction.angle}if(y.direction.y==="up"&&y.direction.angle==="up"){p.y=p.y-y.distance/w.sensitivity;w.updatePostionFromTouchEvent(p)}if(y.direction.y==="down"&&y.direction.angle==="down"){p.y=p.y+y.distance/w.sensitivity;w.updatePostionFromTouchEvent(p)}if(y.direction.x==="left"&&y.direction.angle==="left"){p.x=p.x-y.distance/w.sensitivity;w.updatePostionFromTouchEvent(p)}if(y.direction.x==="right"&&y.direction.angle==="right"){p.x=p.x+y.distance/w.sensitivity;w.updatePostionFromTouchEvent(p)}}});this._joystickAngularMove.on("end",function(x,y){p.x=w._webGLV6Viewer.SCREEN_WIDTH/2;p.y=w._webGLV6Viewer.SCREEN_HEIGHT/2;w.updatePostionFromTouchEvent(p);if(s){clearInterval(s)}})},joystickLinearMoveLeftRight:function(t){i._navigationState.move_forward_touch=false;i._navigationState.move_backward_touch=false;var v=new k.Vector3(),u,q,p;if(i._navigationState.roll_left==true){v.x=(-t.distance/100)}else{if(i._navigationState.roll_right==true){v.x=(t.distance/100)}}v.applyQuaternion(i._currentViewpoint.getControl().orientation);v.setLength(0.05*i._currentViewpoint.getControl().distanceToTarget);u=i._currentViewpoint.getTarget().add(v);q=i._currentViewpoint.getControl().orientation.clone();p=i._currentViewpoint.getTargetDistance();var s=i._currentViewpoint.getCamera().getLookAt().clone();var r=new k.Vector3().addVectors(u,s.normalize().multiplyScalar(-p));i._currentViewpoint.moveTo({eyePosition:r,duration:100});i.checkLookAt()},unsetTouchEventsMap:function(){},unsetMouseEventsMap:function(){if(this.evtTokenMouse){this.evtTokenMouse.forEach(function(p){e.removeEventFromToken(p)});this.evtTokenMouse=undefined}},unsetKeybdEventsMap:function(){if(this.evtTokenKeybd){this.evtTokenKeybd.forEach(function(p){e.removeEventFromToken(p)});this.evtTokenKeybd=undefined}},levelViewPointwithGround:function(){var u=500;var r=this._currentViewpoint.getUpDirection();var s=this._currentViewpoint.getSightDirection();var q=r.clone();if(q.z<0){q.z*=-1;var p=q.x;q.x=q.y;q.y=p;var t={sightDirection:s,upDirection:q,duration:u};this._currentViewpoint.moveTo(t);setTimeout(function(){i.levelGround()},600)}else{i.levelGround()}},levelGround:function(){var s=1200;var r=i._currentViewpoint.getCameraPosition();var p=new k.Vector3(0,0,1).normalize();var q={eyePosition:r,upDirection:p,duration:s};i._currentViewpoint.moveTo(q);i.checkLookAt()},getPauseValue:function(){return this._navigationState.pause},setPauseValue:function(p){this._navigationState.pause=p;if(p){this.clock.stop()}else{this.clock.start()}},lookAt:function(){i.reframeNavigation();i.hideReframe();if(i.NAVIGATION_MODE==="Walk"){var p=b.getCommand("FlyWalk",i.frameWindow.experience.ctx);if(p){p.reloadWalkMode()}}},reframeNavigation:function(){i.frameWindow.getViewpoint().reframe()},centerToObject:function(){this._currentViewpoint.centerCamera(this._originalTarget)}});return a});define("DS/3DPlayNavigationScenario/3DPlayNavigationScenario",["DS/3DPlay/3DPlayScenario","DS/ApplicationFrame/CommandsManager"],function(b,a){return b.extend({init:function(c){if(c!==undefined){if(c.scenarioManager){this._exp=c.scenarioManager.getExperience()}}this._parent(c)},launch:function(){if(!(this._exp&&this._exp.frmWindow)){console.error("3DPlay : Navigation Scenario --> Cound not launch.");return}this.loadWorkbench({module:"3DPlayNavigationScenario",name:"3DPlayNavigationScenario"},true,{sections:[{id:"FlyWalk",nls:"3DPlayNavigationScenario/3DPlayNavigationScenario",rsc:"3DPlayNavigationScenario/3DPlayNavigationScenario"}]});var h=this;h._viewer=this._exp.frmWindow.getViewer();if(this._exp){this._exp.showContextualMenu(false);if(this._exp.isSpecTreeAllowed()){var g=this._exp.frmWindow.getImmersiveFrame();g.hide();this.isImmersiveFrameHidden=true}var f=this._exp.frmWindow.getActionBar();var e=f.onActionBarReady(function(){var i=a.getCommand("FlyWalk",h._exp.ctx);if(i&&!i.isRunning()){if(i.navgationService){i.navgationService._originalTarget=h._exp.frmWindow.getViewer().currentViewpoint.getTarget()}i.begin()}f.removeCallback(e)});if(h._viewer.currentViewpoint.getProjectionType()===1){h._viewer.currentViewpoint.setProjectionType(0);h._previousProjection=1}var d=a.getCommand("VisuPerspectiveView",h._exp.ctx);if(d){d.disable()}var c=a.getCommand("VisuOrthographicView",h._exp.ctx);if(c){c.disable()}}},stop:function(){if(!(this._exp&&this._exp.frmWindow)){console.error("3DPlay : Navigation Scenario --> Cound not stop.");return}var f=this;f._viewer=this._exp.frmWindow.getViewer();if(this._exp){if(this.isImmersiveFrameHidden){var e=this._exp.frmWindow.getImmersiveFrame();e.show()}this._exp.showContextualMenu(true);if(f._previousProjection===1){f._viewer.currentViewpoint.setProjectionType(1);f._previousProjection=undefined}var d=a.getCommand("VisuPerspectiveView",f._exp.ctx);if(d){d.enable()}var c=a.getCommand("VisuOrthographicView",f._exp.ctx);if(c){c.enable()}this._viewer=undefined}},isMobileCompatible:function(){return true}})});define("DS/3DPlayNavigationScenario/CmdFlyWalk",["DS/ApplicationFrame/Command","css!DS/3DPlayNavigationScenario/3DPlayNavigationScenario","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Controls/Slider","DS/Windows/Dialog","DS/WebInfraUI/ContextualBarManager","DS/3DPlayNavigationScenario/NavigationService","DS/WebSystem/Settings","DS/WebUtils/Tracker","DS/CoreEvents/Events"],function(d,k,f,h,c,i,n,g,m,b,j,e){var o=Math.PI;var l;var a=d.extend({init:function(p){this._parent(p,{isAsynchronous:true})},beginExecute:function(){j.inc("command-"+this.getId());var u=this;l=this;this.flywalkWidgetFullscreenDisable=e.subscribe({event:"3DPLAY/MOBILEACTIONBAR/DISABLE"},function(v){if(u._sliderMainContainer){u._sliderMainContainer.setAttribute("id","PlayWeb-slider-container_MAB")}if(u._speedSliderMainContainer){u._speedSliderMainContainer.setAttribute("id","PlayWeb-speed-slider-container_MAB")}});this.flywalkWidgetFullscreenEnable=e.subscribe({event:"3DPLAY/MOBILEACTIONBAR/ENABLE"},function(v){if(u._sliderMainContainer){u._sliderMainContainer.setAttribute("id","PlayWeb-slider-container")}if(u._speedSliderMainContainer){u._speedSliderMainContainer.setAttribute("id","PlayWeb-speed-slider-container")}});var t=this.getFrameWindow().getActionBar();t.close();var r=t.onActionBarReady(function(){if(u.isRunning()){t.close()}});var q=t.onActionBarOpen(function(){t.removeCallback(r);t.removeCallback(q);u.end()});f.empty();h.empty();c.empty();function p(v){if(u._contextualMenu){u._contextualMenu.setSelected(v)}}this.navgationService=new m({frameWindow:this.getFrameWindow(),setSelectionCallBack:p,speedSliderCB:this.speedSliderCB});var s=false;if("ontouchstart" in document.documentElement){s=true}this.displayRightContextualMenu(true,s);this.navgationService.beginNavigation({touchMode:s})},endExecute:function(){e.unsubscribe(this.flywalkWidgetFullscreenDisable);e.unsubscribe(this.flywalkWidgetFullscreenEnable);this.navgationService.endNavigation();this.navgationService=undefined;this.distroySpeedSlider();this.displayWalkHeightSlider(false);this.displayRightContextualMenu(false);var p=this.getFrameWindow().getActionBar();p.open();if(p.MAB){p.MAB.showFlyout(0)}},displayRightContextualMenu:function(q,s){var t=this;if(q){this._contextualMenu=new g({frameWindow:this.getFrameWindow()});var p=true;var r=[!p?{}:{type:t._contextualMenu.Button.Radio,onclickCB:function(u){if(u.id==="Fly"&&t.navgationService.NAVIGATION_MODE!="Fly"){t.navgationService.NAVIGATION_MODE="Fly";t.displayWalkHeightSlider(false);t.hideSpeedSlider()}else{if(u.id==="Walk"&&t.navgationService.NAVIGATION_MODE!="Walk"){t.navgationService.NAVIGATION_MODE="Walk";t.hideSpeedSlider();t.displayWalkHeightSlider(true);t.navgationService.centerToObject();t.levelViewPointwithGround()}}},content:[{id:"Fly",rsc:"3DPlayNavigationScenario/3DPlayNavigationScenario",nls:"3DPlayNavigationScenario/3DPlayNavigationScenario",selected:t.navgationService.NAVIGATION_MODE==="Fly"?true:false},{id:"Walk",rsc:"3DPlayNavigationScenario/3DPlayNavigationScenario",nls:"3DPlayNavigationScenario/3DPlayNavigationScenario",selected:t.navgationService.NAVIGATION_MODE==="Walk"?true:false}]},!p?{}:{type:t._contextualMenu.Button.Check,onclickCB:function(u){if(u.state){t.hideSpeedSlider();console.log("Ground Level");t.levelViewPointwithGround();t.groundLevel=u;setTimeout(function(){t.groundLevel.uncheck()},1000)}else{console.log("Deletion of the Ground Level")}},id:"GroundLevel",rsc:"3DPlayNavigationScenario/3DPlayNavigationScenario",nls:"3DPlayNavigationScenario/3DPlayNavigationScenario"},{type:t._contextualMenu.Button.Check,onclickCB:function(u){t.speedSlider=u;if(u.state){console.log("Creation of the settings panel");t.createSpeedSlider()}else{console.log("Deletion of the settings panel");t.hideSpeedSlider()}},id:"SpeedSettings",rsc:"3DPlayNavigationScenario/3DPlayNavigationScenario",nls:"3DPlayNavigationScenario/3DPlayNavigationScenario"},{type:t._contextualMenu.Button.Master,id:"ExitNavigation",rsc:"3DPlayNavigationScenario/3DPlayNavigationScenario",nls:"3DPlayNavigationScenario/3DPlayNavigationScenario",onclickCB:function(){t.end()}},{type:t._contextualMenu.Button.MasterCheck,onclickCB:function(u){if(t.navgationService.NAVIGATION_MODE==="Walk"){t.reloadWalkMode()}t.distroySpeedSlider();if(u.state===false){t.navgationService.endTouchModeNavigation();t.navgationService.beginMouseModeNavigation()}else{t.navgationService.endMouseModeNavigation();t.navgationService.beginTouchModeNavigation()}},id:"TouchMode",rsc:"3DPlayNavigationScenario/3DPlayNavigationScenario",nls:"3DPlayNavigationScenario/3DPlayNavigationScenario",selected:s===true?true:false}];r=r.filter(function(u){if(Object.keys(u).length!==0){return u}});this._contextualMenuToken=this._contextualMenu.addButtons(r,{barType:this._contextualMenu.Toolbar.New,showContextBarBackground:true})}else{this._contextualMenu.removeButtons(this._contextualMenuToken);this._contextualMenu.dispose();this._contextualMenu=undefined}},displayWalkHeightSlider:function(p){var r=this;if(p){var q=this.getFrameWindow().getActionBar();if(q.MAB&&q.MAB.state&&q.MAB.state.visible==true){this._sliderMainContainer=UWA.createElement("div",{id:"PlayWeb-slider-container_MAB","pointer-events":"none"}).inject(this.getFrameWindow().getUIFrame())}else{this._sliderMainContainer=UWA.createElement("div",{id:"PlayWeb-slider-container","pointer-events":"none"}).inject(this.getFrameWindow().getUIFrame())}this._walkSlider=new i({minValue:-100,maxValue:100,stepValue:1,value:r.navgationService._heightConstraint,displayStyle:"vertical"}).inject(this._sliderMainContainer);this._walkSlider.addEventListener("change",function(t){if(t.preventDefault){t.preventDefault()}t.cancelBubble=true;var s=t.dsModel;r.navgationService._heightConstraint=s.value;r.navgationService.updateHeight()})}else{this.distroyWalkSlider()}},distroyWalkSlider:function(){if(this._sliderMainContainer){this._sliderMainContainer.destroy()}this._sliderMainContainer=undefined;this._walkSlider=undefined;if(this.navgationService){this.navgationService._heightConstraint=0;this.navgationService._previousHeight=0}},reloadWalkMode:function(){this.distroyWalkSlider();this.distroySpeedSlider();this.displayWalkHeightSlider(true);this.navgationService.centerToObject();this.levelViewPointwithGround()},createSpeedSlider:function(){var q=this;if(!this._speedSliderMainContainer){var p=this.getFrameWindow().getActionBar();if(p.MAB&&p.MAB.state&&p.MAB.state.visible==true){this._speedSliderMainContainer=UWA.createElement("div",{id:"PlayWeb-speed-slider-container_MAB","pointer-events":"none"}).inject(this.getFrameWindow().getUIFrame())}else{this._speedSliderMainContainer=UWA.createElement("div",{id:"PlayWeb-speed-slider-container","pointer-events":"none"}).inject(this.getFrameWindow().getUIFrame())}this._speedSlider=new i({minValue:1,maxValue:100,stepValue:1,value:q.navgationService._navigationState.speed,displayStyle:"vertical"}).inject(this._speedSliderMainContainer);this._speedSlider.addEventListener("change",function(s){if(s.preventDefault){s.preventDefault()}s.cancelBubble=true;var r=s.dsModel;q.navgationService.setSpeed(r.value)})}q.showSpeedSlider()},hideSpeedSlider:function(){if(this.speedSlider&&this.speedSlider.state){this.speedSlider.uncheck();this.speedSlider.state=false}if(this._speedSliderMainContainer){this._speedSliderMainContainer.hide()}if(this._walkSlider&&this.navgationService&&this.navgationService.NAVIGATION_MODE=="Walk"){this._sliderMainContainer.show();this._walkSlider.show()}},showSpeedSlider:function(){if(this._walkSlider){this._sliderMainContainer.hide();this._walkSlider.hide()}this._speedSliderMainContainer.show()},distroySpeedSlider:function(){this.hideSpeedSlider();if(this._speedSliderMainContainer){this._speedSliderMainContainer.destroy()}this._speedSliderMainContainer=undefined;this._speedSlider=undefined},speedSliderCB:function(p){if(l._speedSlider){l._speedSlider.value=p}},levelViewPointwithGround:function(){this.navgationService.levelViewPointwithGround()},alignAndReframeNavigation:function(){var p=this;p.navgationService.levelViewPointwithGround();setTimeout(function(){p.navgationService.centerToObject()},1800)},reframeNavigation:function(){this.navgationService.centerToObject()}});return a});