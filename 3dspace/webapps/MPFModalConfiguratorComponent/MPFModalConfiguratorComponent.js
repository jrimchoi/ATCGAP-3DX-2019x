define("DS/MPFModalConfiguratorComponent/OrderPaymentMethodSection",["UWA/Core","DS/MPFOrderComponent/OrderConfirmationSection","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Select","DS/MPFView/FieldTextInputV2","DS/MPFPaymentCardTokenModel/PaymentCardTokenCollection","DS/MPFModelFactory/CartFactory","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","DS/MPFPspModel/PspModel","DS/MPFServices/ObjectService","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(k,c,i,a,b,e,m,d,l,j,g,h,n){var f;f=c.extend({setup:function(o){o||(o={});h.requiredOfPrototype(o.tokenCards,e,"options.tokenCards must be a PaymentCardTokenCollection");h.requiredOfPrototype(o.cart,d,"options.cart must be a CartModel");h.requiredOfPrototype(o.cartFactory,m,"options.cartFactory must be a CartFactory");h.requiredOfPrototype(o.cartPsp,g,"options.cartPsp must be a PspModel");this.cart=o.cart;this.cartFactory=o.cartFactory;this.cartPsp=o.cartPsp;this.service=o.service;this.tokenCards=o.tokenCards;this.bankTransferActive=o.bankTransferActive;this._parent(o);this._initCBOption();if(this.bankTransferActive){this._initBankTransfertOption()}},render:function(){this._fillBody();this._parent();this._displayBTOption();return this},_fillBody:function(){var o=k.createElement("div",{"class":"mpf-payment-method mpf-horizontal",html:[k.createElement("div",{"class":"mpf-payment-cb",html:[this.cbToggle,this.selectCB,this.saveCB,this.purchaseOrderField.render(),this.expenseFinancialLineField.render()]}),k.createElement("div",{"class":"mpf-payment-bank-transfer",html:this.bankTransfToggle})]});this.body.push(o)},getPaymentMethod:function(){var q=this;var o={};var p;if(this.cbToggle.isChecked()){o.method="CB";o.value=this.selectCB.getValue()[0];if(o.value==="addCB"){o.CreditCardTokenMultiUse=this.saveCB.isChecked()?"1":"0"}else{p=this.tokenCards.filter(function(r){return q.selectCB.getValue()[0]===r.getCardId()}).shift();o.CreditCardToken=p}}else{o.method="bankTransfer"}return o},_initCBOption:function(){var r=this;var p="addCB";var q=this._getCBTokens();var o=this.cart.getPaymentMethod();if(q.length>0){p=q[q.length-1].value}this.cbToggle=new i({value:n.get("cbChoiceLabel"),className:"primary cb",checked:!o||o==="CC",events:{onChange:function(){if(this.isChecked()){r._cbOptionSelected()}}}});this.saveCB=new i({type:"checkbox",name:"save-CB",value:n.get("saveCB"),className:"primary cb-save",checked:true});this.selectCB=new a({placeholder:n.get("selectCB"),value:p,options:q,disabled:!this.cbToggle.isChecked(),events:{onChange:function(){r.dispatchEvent("new-height");r._displayCheckboxSaveCB(r.service==="3DPrint"&&this.getValue()[0]==="addCB");if(this.getValue()[0]!==""){r.dispatchEvent("validSection")}else{r.dispatchEvent("invalidSection")}},onClick:function(){r.dispatchEvent("new-height",parseInt(this.elements.dropdown.getStyle("height")))}}});this.purchaseOrderField=this._createBankCardPurchaseOrderField();this.expenseFinancialLineField=this._createBankCardExpenseFinancialLineField();this._updateBankCardAdditionnalFieldsVisibility();this._displayCheckboxSaveCB(this.service==="3DPrint"&&this.cbToggle.isChecked()&&this.selectCB.getValue()[0]==="addCB")},_createBankCardPurchaseOrderField:function(){return new b({model:this.cart,fieldName:d.Fields.PURCHASE_ORDER_NUMBER,fieldLabel:n.get("referenceMention"),dynamicValidation:true,saveOnChange:true,maxlength:30})},_createBankCardExpenseFinancialLineField:function(){return new b({model:this.cart,fieldName:d.Fields.EXPENSE_FINANCIAL_LINE,fieldLabel:n.get("expenseFinancialLine"),dynamicValidation:true,saveOnChange:true})},_updateBankCardAdditionnalFieldsVisibility:function(){if(this.cbToggle.isChecked()){this.purchaseOrderField.show();this.expenseFinancialLineField.show()}else{this.purchaseOrderField.hide();this.expenseFinancialLineField.hide()}},_cbOptionSelected:function(){var o=this;this.bankTransfToggle.setCheck(false);this.selectCB.enable();this._updateBankCardAdditionnalFieldsVisibility();if(this.service==="3DPrint"){this._displayCheckboxSaveCB(this.selectCB.getValue()[0]==="addCB")}return this._setPayementMethodOnCart("CC").then(function(){if(o.selectCB.getValue()[0]!==""){o.dispatchEvent("validSection")}else{o.dispatchEvent("invalidSection")}})["catch"](function(){o.dispatchEvent("invalidSection")})},_getCBTokens:function(){var p=[];var s;var r;var o;var q;s=this.cartPsp.getPsp();r=this.cartPsp.getCountryPlatform();o=s===g.Psp.HIPAY;q=s===g.Psp.STRIPE;p.push({value:"addCB",label:n.get("createCB")});this.tokenCards.forEach(function(t){if(t.getPsp()===s){if(o||(q&&t.getPlatform()===r)){p.push({value:t.getCardId(),label:"xxxx-xxxx-xxxx-"+t.getCardNumber()+", "+t.getCardExpMonth()+"/"+t.getCardExpYear()})}}});return p},_initBankTransfertOption:function(){var q=this;var o;var p;if(!this.cart.isDirectPurchase()){o=this.cartPsp.getPsp()===g.Psp.STRIPE&&this.cartPsp.getCountryPlatform()===g.Platform.STRIPE_US;p=o?n.get("btChoiceACHLabel"):n.get("btChoiceLabel");this.bankTransfToggle=new i({value:p,className:"primary bank",checked:this.cart.getPaymentMethod()==="DBT",events:{onChange:function(){if(this.isChecked()){q._bankTransferOptionSelected()}}}})}},_bankTransferOptionSelected:function(){var o=this;this.cbToggle.setCheck(false);this.selectCB.disable();this._updateBankCardAdditionnalFieldsVisibility();this._displayCheckboxSaveCB(false);return this._setPayementMethodOnCart("DBT").then(function(){o.dispatchEvent("validSection")})["catch"](function(){o.dispatchEvent("invalidSection")})},_displayBTOption:function(){var o;var p;if(this.bankTransferActive&&!this.cart.isDirectPurchase()){if(this.cartPsp.getPaymentMethod().indexOf(g.PaymentMethod.BANK_TRANSFER)!==-1){o=this.cartPsp.getPsp()===g.Psp.STRIPE&&this.cartPsp.getCountryPlatform()===g.Platform.STRIPE_US;p=o?n.get("btChoiceACHLabel"):n.get("btChoiceLabel");this.bankTransfToggle.setValue(p);this.bankTransfToggle.show()}else{this.bankTransfToggle.hide()}}},_displayCheckboxSaveCB:function(o){if(o){this.saveCB.show()}else{this.saveCB.hide()}},isValid:function(){if(k.is(this.bankTransfToggle)){return this.bankTransfToggle.isChecked()||(this.cbToggle.isChecked()&&this.selectCB.getValue()[0]!=="")}else{return this.cbToggle.isChecked()&&this.selectCB.getValue()[0]!==""}},_setPayementMethodOnCart:function(o){var r;var q;var p={};p[d.Fields.PAYMENT_METHOD]=o;q=new j(j.Operations.modify,"/",p);r=new l();r.add(q);this.cart.dataProxy=this.cartFactory.getDataProxy("cart");return this.cart.megaPatch(r)}});return f});define("DS/MPFModalConfiguratorComponent/ConfirmMakeBankTransferPage",["UWA/Core","UWA/Promise","UWA/Class/View","DS/PlatformAPI/PlatformAPI","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Button","DS/UIKIT/Alert","DS/UIKIT/Mask","DS/MPFServices/ObjectService","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFPurchaseOrderComponent/PurchaseOrderUploadForm","DS/MPFPurchaseOrderModel/PurchaseOrderModel","DS/MPFPurchaseOrderModel/PurchaseOrderDocumentModel","DS/MPFModelFactory/CartFactory","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent","css!DS/MPFModalConfiguratorComponent/MPFModalConfiguratorComponent"],function(k,c,s,d,n,m,i,h,q,a,o,p,b,l,t,g,f,r){var j;var e={};e.CONFIRM_BANK_TRANSFER="confirmBankTransfer";e.UPLOAD_PURCHASE_ORDER="uploadPurchaseOrder";j=s.extend({className:"mpf-confirm-bank-transfer-make",setup:function(u){u||(u={});q.requiredOfPrototype(u.cart,t,"options.cart must be a CartModel");q.requiredOfPrototype(u.cartFactory,l,"options.cartFactory must be a CartFactory");q.requiredOfPrototype(u.purchaseOrderDocument,b,"options.purchaseOrderDocument must be a PurchaseOrderDocumentModel");q.requiredOfPrototype(this.model,p,"this.model must be a PurchaseOrderModel");this.purchaseOrderDocument=u.purchaseOrderDocument;this.cart=u.cart;this.cartFactory=u.cartFactory;this.stateMachine=this._createStateMachine();this.confirmDeferredPaymentMessage=this._createConfirmDeferredPaymentMessage();this.learnMoreLink=this._createLearnMoreLink();this.uploadPurchaseOrderButton=this._createUploadPurchaseOrderButton();this.uploadLaterButton=this._createUploadLaterButton();this.purchaseOrderUploadForm=new o({model:this.model,purchaseOrderDocument:this.purchaseOrderDocument,cart:this.cart});this.listenTo(this.purchaseOrderUploadForm,"purchaseOrderUploaded",this._onPurchaseOrderUploaded.bind(this))},render:function(){var u;u=this.stateMachine.getState();if(u===e.UPLOAD_PURCHASE_ORDER){this.container.setContent([this.purchaseOrderUploadForm.render()])}else{this.container.setContent([this.confirmDeferredPaymentMessage,this.learnMoreLink,this.uploadPurchaseOrderButton,this.uploadLaterButton])}return this},save:function(){var u;var v;v=this.stateMachine.getState();if(v===e.UPLOAD_PURCHASE_ORDER){u=this.purchaseOrderUploadForm.save()}return c.cast(u)},_createConfirmDeferredPaymentMessage:function(){return k.createElement("p",{text:r.get("confirmDeferredPaymentMessage")})},_createLearnMoreLink:function(){return k.createElement("a",{href:"/faq/proceed-to-deferred-payment",text:r.get("learnMoreAboutDeferredPayment"),target:"_blank"})},_createUploadPurchaseOrderButton:function(){return new m({className:"primary mpf-uploadPurchaseOrderButton",value:r.get("uploadPurchaseOrder"),events:{onClick:this._onUploadPurchaseOrder.bind(this)}})},_onUploadPurchaseOrder:function(){this.stateMachine.changeState(e.UPLOAD_PURCHASE_ORDER);this.dispatchEvent("showSaveButton");this.render()},_createUploadLaterButton:function(){return new m({className:"primary mpf-uploadLaterButton",value:r.get("uploadPurchaseOrderLater"),events:{onClick:this._onUploadPurchaseOrderLater.bind(this)}})},_onUploadPurchaseOrderLater:function(){var u=this;h.mask(this.container);this._updateCart().then(function(){u.dispatchEvent("endPurchaseOrderStep");d.publish("MPCartTimeline",{event:"refresh",cartId:u.cart.id})})["catch"](function(v){new i({messageClassName:"error",closable:true,visible:true,messages:r.get("error")}).inject(u.container,"top")})["finally"](function(v){h.unmask(u.container)})},_updateCart:function(){var u={};u[t.Fields.BLOCKED]="TRUE";this.cart.dataProxy=this.cartFactory.getDataProxy("cart");return this.cart.savePromise(u,{patch:true,partialRefresh:true})},_onPurchaseOrderUploaded:function(){this.dispatchEvent("endPurchaseOrderStep")},_createStateMachine:function(){return new a({state:e.CONFIRM_BANK_TRANSFER,states:[e.CONFIRM_BANK_TRANSFER,e.UPLOAD_PURCHASE_ORDER],transitions:[{from:e.CONFIRM_BANK_TRANSFER,to:e.UPLOAD_PURCHASE_ORDER}]})}});return j});define("DS/MPFModalConfiguratorComponent/OrderRecapPerYearSection",["UWA/Core","UWA/String","DS/MPFOrderComponent/OrderConfirmationSection","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(b,e,c,d){var a;var f;f={QSC:d.get("quarterly"),YSC:d.get("yearly")};a=c.extend({setup:function(g){this._parent(g);this.currency=g.currency;this.currencyDecimals=g.currencyDecimals;this.locale=g.locale||"fr-FR";this.totalPrice="0 "+this.currency;this.licensingScheme=d.get("yearly")},render:function(){var g;this.body=[];g=b.createElement("div",{"class":"mpf-total",html:[b.createElement("div",{"class":"mpf-info-total col-xs-6",text:e.format(d.get("infoSubs"),this.licensingScheme)}),b.createElement("div",{"class":"mpf-total-price col-xs-6",html:[b.createElement("span",{"class":"mpf-price",text:this.totalPrice}),"&nbsp;",b.createElement("span",{"class":"mpf-tax",text:d.get("taxExcl")})]})]});this.body.push(g);this._parent();return this},updateTotalPrice:function(h,g,k,j){var i;if(j==="YSC"){this.title=d.get("totalYear")}else{this.title=d.get("totalQuarter")}i=(h*100)*k;i=(i/100).toLocaleString(this.locale,{style:"currency",currency:this.currency,currencyDisplay:"code"}).replace(this.currency,"").trim();this.dispatchEvent("priceUpdated",parseFloat(i));i=i+" "+this.currency;this.totalPrice=i;this.licensingScheme=f[j];this.render()}});return a});define("DS/MPFModalConfiguratorComponent/SalesConditionsBuyerPaymentSection",["UWA/Core","UWA/Class/View","UWA/Class/Promise","DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFShopModel/ShopModel","DS/MPFCartModel/CartItemCollection","DS/MPFTCContractModel/TCContractModel","DS/MPFModelFactory/TCDocumentFactory","DS/MPFModelFactory/TCContractFactory","DS/MPFTcContractComponent/SalesConditionsBuyerPayment","DS/MPFServices/MarketplaceServices","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(l,b,i,c,j,m,g,h,f,d,a,k,n){var e;e=b.extend({setup:function(o){o||(o={});this._checkPrototypes(o);this._parent(o);this.buyer=o.buyer;this.shopModel=o.shopModel;this.tcDocumentFactory=o.tcDocumentFactory;this.tcContractFactory=o.tcContractFactory;this.cartItems=o.cartItems;this.request=this._getRequest();this.whenReady=this._findContract()},render:function(){var o=this;this.dispatchEvent("invalidSection");this.whenReady.then(function(){if(l.is(o.tcContract)&&o.tcContract.getCurrentState()===h.STATUS.draft){o.checkbox=new a({shopModel:o.shopModel,tcDocumentFactory:o.tcDocumentFactory,tcContractFactory:o.tcContractFactory,tcContract:o.tcContract});o._initListeners();o.container.setContent(o.checkbox.render())}else{o.dispatchEvent("validSection")}})["catch"](function(){new c({className:"error",messageClassName:"error",messages:n.get("errorTC"),visible:true,attributes:{style:"height: 60px"}}).inject(o.container)});return this},isChecked:function(){if(l.is(this.checkbox)){return this.checkbox.isChecked()}else{return true}},save:function(){if(l.is(this.checkbox)){return this.checkbox.signContract()}else{return i.resolve()}},_initListeners:function(){this.listenTo(this.checkbox,"checked",function(){this.dispatchEvent("validSection")});this.listenTo(this.checkbox,"unchecked",function(){this.dispatchEvent("invalidSection")})},_getRequest:function(){var o;o=this.cartItems.filter(function(p){return p.getType()==="MP3DP_PrintRequest"}).shift();if(l.is(o)){this.service=k.MAKE;return o}o=this.cartItems.filter(function(p){return p.getType()==="MPENG_EngineeringItem"}).shift();if(l.is(o)){this.service=k.ENGINEERING;return o}return o},_findContract:function(){return this._findInCartItemsContracts(this.request)},_findInCartItemsContracts:function(p){var q=this;var o;o=q.tcContractFactory.createCollection("cartItem-contracts",[],{parentResourceId:p.id});return o.fetchPromise().then(function(){q.tcContract=o.filter(function(r){return r.getDocumentType()===h.DOCUMENT_TYPES.SPECIFIC_SALES_CONDITIONS&&r.getCurrentState()!==h.STATUS.archived}).shift();if(l.is(q.tcContract)){return i.resolve()}else{return q._findInConsumedContracts()}})},_findInConsumedContracts:function(){var p=this;var o;o=p.tcContractFactory.createCollection("consumed-contracts");return o.fetchPromise().then(function(){var q;q=p.shopModel.get("owner").match(/[A-Z0-9]{32}$/)[0];if(l.is(o)){p.tcContract=o.filter(function(r){return r.getConsumerID()===p.buyer.get("id")&&r.getDocumentType()===h.DOCUMENT_TYPES.DEFAULT_SALES_CONDITIONS&&r.getSupplierID()===q&&r.getCurrentState()!==h.STATUS.archived&&r.getSigningRevision()===r.getActiveRevision()}).shift()}if(l.is(p.tcContract)){return i.resolve()}else{return p._createContract(q)}})},_createContract:function(o){var p=this.shopModel.getService(this.service)["contract-documents"];if(!l.is(p)){return i.reject()}else{if(p.length===0){return i.resolve()}else{if(p.length>0){this.tcContract=this.tcContractFactory.createModel("existing-document",{documentID:p[0].id,supplierID:o,consumerID:this.buyer.get("id"),currentState:h.STATUS.draft});return this.tcContract.savePromise()}}}},_checkPrototypes:function(o){j.requiredOfPrototype(o.shopModel,m,"options.shopModel must be a ShopModel");j.requiredOfPrototype(o.tcDocumentFactory,f,"options.tcDocumentFactory must be a TCDocumentFactory");j.requiredOfPrototype(o.tcContractFactory,d,"options.tcContractFactory must be a TCContractFactory");j.requiredOfPrototype(o.cartItems,g,"options.cartItems must be a CartItemCollection")}});return e});define("DS/MPFModalConfiguratorComponent/PaymentInformationSupportSection",["UWA/Core","DS/MPFView/MPFView","DS/UIKIT/Input/Button","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(c,d,b,e){var a;a=d.extend({className:"mpf-payment-info",setup:function(f){f||(f={});this._parent(f)},render:function(){this.container.setContent([c.createElement("div",{"class":"mpf-infos",html:[c.createElement("div",{text:e.get("emailLink")}),c.createElement("a",{text:e.get("contactSupport"),href:"mailto:marketplace.make@3ds.com"})]}),c.createElement("div",{"class":"mpf-infos",html:[c.createElement("div",{text:e.get("orderDeploy")}),c.createElement("div",{text:e.get("bankTransfer")})]})]);return this}});return a});define("DS/MPFModalConfiguratorComponent/RenewalSubscriptionSection",["UWA/Core","UWA/String","DS/MPFView/MPFView","DS/MPFCartModel/CartItemCollection","DS/MPFServices/ObjectService","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(d,f,g,a,b,e){var c;c=g.extend({className:"mpf-order-subscriptions",setup:function(h){h=(h||{});b.requiredOfPrototype(h.cartItems,a,"options.cartItems must be a CartItemCollection");this.cartItems=h.cartItems;this.currency=h.currency;this.currencyDecimals=h.currencyDecimals;this.periodicitiesAlreadyPurchased=h.periodicitiesAlreadyPurchased;this.locale=h.locale||"fr-FR";this._parent(h)},render:function(){var k=this.cartItems.first();var l;var i;var j=k.getLicensingScheme();var h=k.getTotalNetAmount().toLocaleString(this.locale,{style:"currency",currency:this.currency,currencyDisplay:"code"}).replace(this.currency,"").trim();if(Array.isArray(this.periodicitiesAlreadyPurchased)&&this.periodicitiesAlreadyPurchased.indexOf(j)!==-1){l=k.getEndDate().split(" ")[0];this.container.setContent(f.format(e.get("infoTotal"),l,h+" "+this.currency))}else{i=j==="YSC"?e.get("yearly"):e.get("quarterly");this.container.setContent(f.format(e.get("infoFirstPurchase"),i))}this._parent();return this}});return c});define("DS/MPFModalConfiguratorComponent/CompanyInformationSection",["UWA/Core","UWA/Promise","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCompanyComponent/CompanyNameInput","DS/MPFCompanyComponent/CompanyTaxRegistrationIdInput","DS/MPFCompanyComponent/CompanyRegistrationIdInput","DS/MPFView/FieldSelectInputV2","DS/MPFCountryModel/CountryCollection","DS/MPFCompanyModel/CompanyModel","i18n!DS/MPFCompanyComponent/assets/nls/CompanyComponent"],function(h,i,c,j,d,k,b,e,g,a,f){var l=c.extend({className:"mpf-form mpf-company-information mpf-horizontal",setup:function(m){m||(m={});j.requiredOfPrototype(m.countryCollection,g,"options.countryCollection must be a CountryCollection");j.requiredOfPrototype(this.model,a,"this.model must be a CompanyModel");this._parent(m);this.countryCollection=m.countryCollection;this.companyNameInput=this._createCompanyName();this.countrySelect=this._createCountrySelect();this.taxRegistrationInput=this._createTaxRegistrationID();this.companyRegistrationInput=this._createCompanyRegistrationID()},render:function(){this.container.setContent([this.companyNameInput.render(),this.countrySelect.render(),this.taxRegistrationInput.render(),this.companyRegistrationInput.render()]);return this},save:function(){var n={};var m=null;if(this.validate()){if(!this.model.isNew()){m=this.model.getPendingChanges();n.patch=true;if(m.taxRegistrationId){m.taxId=m.taxRegistrationId;delete m.taxRegistrationId}}if(this.model.isNew()||Object.keys(m).length!==0){return this.model.savePromise(m,n)}else{return i.resolve()}}else{return i.reject()}},validate:function(){var p=this.companyNameInput.validate().isValid;var n=this.countrySelect.validate().isValid;var m=this.taxRegistrationInput.validate().isValid;var o=this.companyRegistrationInput.validate().isValid;return p&&n&&m&&o},clearForm:function(){this.companyNameInput.resetValue();this.countrySelect.resetValue();this.taxRegistrationInput.resetValue();this.companyRegistrationInput.resetValue()},_createCompanyName:function(){return new d({model:this.model,dynamicValidation:true,readOnly:!this.model.isNew(),required:true})},_createCountrySelect:function(){return new e({model:this.model,required:true,dynamicValidation:true,silent:false,fieldName:a.Fields.COUNTRY,fieldLabel:f.get("country"),readOnly:this.model.has(a.Fields.COUNTRY)&&this.model.getCountry()!=="",placeholder:f.get("selectCountry"),selectableOptions:this._getCountriesOptions()})},_createTaxRegistrationID:function(){var m=false;if(this.model.has(a.Fields.TAX_REGISTRATION_ID)&&this.model.getTaxRegistrationId()!==""){m=this.model.validTaxRegID(this.model.getTaxRegistrationId(),this.model.getCountry())}return new k({model:this.model,readOnly:m,required:true})},_createCompanyRegistrationID:function(){var m=false;m=this.model.has(a.Fields.REGISTRATION_ID)&&this.model.getRegistrationId()!=="";return new b({model:this.model,readOnly:m,required:false})},_getCountriesOptions:function(){var n=this;var m=[];this.countryCollection.forEach(function(p){var o={value:p.getIso3(),label:p.getName()};o.selected=p.getIso3()===n.model.getCountry();m.push(o)});return m},destroy:function(){this.model=null;this._parent();this.container=null}});return l});define("DS/MPFModalConfiguratorComponent/OrderInformationSection",["UWA/Core","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(c,d,a,b,e){var f;f=d.extend({setup:function(g){g||(g={});a.requiredOfPrototype(this.model,b,"this.model must be a CartModel");this._parent(g);this.locale=g.locale||"fr-FR"},render:function(){var g;var h;g=c.createElement("div",{"class":"mpf-order-number",html:[c.createElement("span",{text:e.get("order")}),"&nbsp;","# "+this.model.getName()]});h=c.createElement("div",{"class":"mpf-order-total",html:[c.createElement("span",{text:e.get("amount")}),"&nbsp;",this.model.get("GrossAmountTotal").toLocaleString(this.locale,{style:"currency",currency:this.model.getCurrency(),currencyDisplay:"code"}).replace(this.model.getCurrency(),"").trim(),"&nbsp;",this.model.getCurrency()]});Array.prototype.push.apply(this.body,[g,h]);this._parent();return this}});return f});define("DS/MPFModalConfiguratorComponent/BuyerCard",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,h,d,c,b,g,f){var a=h.extend({className:"mpf-buyer-card",domEvents:{click:"cardClicked"},setup:function(i){i||(i={});if(!(e.is(i.buyerType))){throw new Error("options.buyerType is required")}d.requiredOfPrototype(i.buyerType,c,"options.buyerType must be a BuyerType");if(!(g.prototype.isPrototypeOf(this.model)||b.prototype.isPrototypeOf(this.model))){throw new Error("BuyerCard model must be a CompanyModel or a PersonModel")}this._parent(i);this.buyerType=i.buyerType;this.country=i.country},render:function(){if(e.equals(this.buyerType,c.INDIVIDUAL)){this.container.setContent(this._renderPerson())}else{this.container.setContent(this._renderCompany())}return this},_renderCompany:function(){var k;var i;var j;var l;k=this.model.get("name");i=this.model.get("taxRegistrationId");j=this.model.get("registrationId");l=e.is(this.country)?this.country:this.model.get("country");return[e.createElement("div",{"class":"mpf-buyer-line",html:[f.get("company"),{tag:"span",text:k}]}),e.createElement("div",{"class":"mpf-buyer-line",html:[f.get("country"),{tag:"span",text:l}]}),e.createElement("div",{"class":"mpf-buyer-line",html:[f.get("taxRegistrationId"),{tag:"span",text:i}]}),e.createElement("div",{"class":"mpf-buyer-line",html:[f.get("companyRegistration"),{tag:"span",text:j}]})]},_renderPerson:function(){var j;var i;j=this.model.get("firstName");i=this.model.get("lastName");return e.createElement("div",{"class":"mpf-buyer-line",text:j+" "+i})},destroy:function(){this.model=null;this._parent();this.container=null},cardClicked:function(){this.dispatchEvent("onSelected",this.model)}});return a});define("DS/MPFModalConfiguratorComponent/OrderAgreementsSection",["UWA/Core","UWA/Class/View","UWA/String","UWA/Utils/Client","DS/MPFServices/ObjectService","DS/UIKIT/Input/Toggle","DS/UIKIT/Alert","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemCollection","DS/MPFTCContractModel/TCContractModel","DS/MPFModelFactory/TCContractFactory","DS/MPFTCContractModel/SoftwareAgreementModel","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(k,e,n,i,l,o,c,g,f,j,d,m,h,b,p){var a;a=e.extend({className:"mpf-agreements-order",setup:function(q){q||(q={});l.requiredOfPrototype(q.cart,g,"options.cart must be a CartModel");l.requiredOfPrototype(q.cartItems,f,"options.cartItems must be a CartItemCollection");l.requiredOfPrototype(q.tcContractFactory,d,"options.tcContractFactory must be a TCContractFactory");l.requiredOfPrototype(q.softwareAgreement,m,"options.softwareAgreement must be a SoftwareAgreementModel");l.requiredOfPrototype(q.onlineServiceAgreement,m,"options.onlineServiceAgreement must be a SoftwareAgreementModel");if(!(b.prototype.isPrototypeOf(q.buyer)||h.prototype.isPrototypeOf(q.buyer))){throw new Error("OrderAgreementsSection options.buyer must be a CompanyModel or a PersonModel")}this._parent(q);this.cart=q.cart;this.cartItems=q.cartItems;this.buyer=q.buyer;this.tcContractFactory=q.tcContractFactory;this.softwareAgreement=q.softwareAgreement;this.onlineServiceAgreement=q.onlineServiceAgreement;this.chechbox=this._createToggle()},render:function(){var q=this;this.onlineServiceAgreement.set("language",i.Locale.lang);Promise.all([this.softwareAgreement.fetchPromise({cartId:this.cart.get("id")}),this.onlineServiceAgreement.fetchPromise()]).then(function(){q.dsMarketplaceTC=k.createElement("a",{"class":"marketplaceTC",target:"_blank",href:q.softwareAgreement.get("url"),text:p.get("dsmptc")});q.onlineTC=k.createElement("a",{"class":"onlineTC",target:"_blank",href:q.onlineServiceAgreement.get("url"),text:p.get("onlineAgreements")});q.privacyPolicy=k.createElement("a",{"class":"privacyPolicy",target:"_blank",href:"https://www.3ds.com/privacy-policy/",text:p.get("privacyPolicy")});q.container.setContent([q.chechbox,k.createElement("div",{"class":"mpf-switch-label",html:n.format(p.get("agreementsMy3DExp"),q.dsMarketplaceTC.outerHTML,q.privacyPolicy.outerHTML,q.onlineTC.outerHTML)})]);q.dispatchEvent("onRender")})["catch"](function(){new c({className:"error",messages:{className:"error",message:p.get("errorLoadingTC")},icon:true,closable:true,visible:true}).inject(q.container.getElement(".mpf-body"),"top")});return this},save:function(){this.tcContract=this.tcContractFactory.createModel("existing-document",{documentID:this.softwareAgreement.get("id"),currentState:j.STATUS.inEffect,consumerID:this.buyer.get("id"),cartItemID:this.cartItems.first().get("id")});this.onlineAgreementContract=this.tcContractFactory.createModel("existing-document",{documentID:this.onlineServiceAgreement.get("id"),currentState:j.STATUS.inEffect,consumerID:this.buyer.get("id"),cartItemID:this.cartItems.first().get("id")});return Promise.all([this.onlineAgreementContract.savePromise(null,{}),this.tcContract.savePromise(null,{})])},_createToggle:function(){var q=this;return new o({type:"switch",className:"primary",value:"",events:{onChange:function(){if(this.isChecked()){q.dispatchEvent("validSection")}else{q.dispatchEvent("invalidSection")}}}})},isChecked:function(){return this.chechbox.isChecked()}});return a});define("DS/MPFModalConfiguratorComponent/BankAccountInformationSection",["UWA/Core","DS/MPFServices/ObjectService","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFVirtualIbanModel/VirtualIbanModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(c,b,e,d,f){var a;a=e.extend({setup:function(g){g||(g={});this._parent(g);b.requiredOfPrototype(g.virtualIban,d,"options.virtualIban must be a VirtualIbanModel");this.virtualIban=g.virtualIban},render:function(){this.body.push(c.createElement("div",{"class":"mpf-iban",text:f.get("iban")+" "+this.virtualIban.get("Iban")}),c.createElement("div",{"class":"mpf-bic",text:f.get("bic")+" "+this.virtualIban.get("Bic")}));this._parent();return this}});return a});define("DS/MPFModalConfiguratorComponent/RecapCBTokenSection",["UWA/Core","UWA/Class/Listener","DS/MPFServices/ObjectService","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFPaymentCardTokenModel/PaymentCardTokenModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(d,g,c,e,a,f){var b;b=e.extend({setup:function(h){c.requiredOfPrototype(h.token,a,"options.token must be a PaymentCardTokenModel");this._parent(h);this.token=h.token},render:function(){this.body.push(d.createElement("div",{"class":"mpf-cc-owner",html:[{tag:"span",text:f.get("ccOwner"),"class":"mpf-cc-name"}," "+this.token.getCardName()]}),d.createElement("div",{"class":"mpf-cc-number",html:[{tag:"span",text:f.get("ccNumber"),"class":"mpf-cc-label"}," xxxx-xxxx-xxxx-"+this.token.getCardNumber()]}),d.createElement("div",{"class":"mpf-cc-expDate",html:[{tag:"span",text:f.get("ccExpDate"),"class":"mpf-cc-label"}," "+this.token.getCardExpMonth()+"/"+this.token.getCardExpYear()]}),d.createElement("div",{"class":"mpf-cc-type",html:[{tag:"span",text:f.get("ccType"),"class":"mpf-cc-label"}," "+this.token.getCardType()]}));this._parent();return this}});return b});define("DS/MPFModalConfiguratorComponent/OrderSummarySection",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(f,e,b,c,d){var a;a=e.extend({className:"mpf-summary-order",setup:function(g){g||(g={});b.requiredOfPrototype(g.cart,c,"options.cart must be a CartModel");this._parent(g);this.cart=g.cart;this.locale=g.locale||"fr-FR"},render:function(){this.container.setContent([this._getDetailAmount(),this._getTotal()]);return this},_getTotal:function(){var g=this.cart.getCurrency();return f.createElement("div",{"class":"mpf-order-total",html:[f.createElement("div",{text:d.get("orderTotal")}),f.createElement("div",{text:this._getGrossAmountTotal()+" "+g})]})},_getDetailAmount:function(){var g=this.cart.getCurrency();return f.createElement("div",{"class":"mpf-order-detail",html:[f.createElement("div",{"class":"mpf-order-subtotal",html:[f.createElement("div",{text:d.get("subtotal")}),f.createElement("div",{text:this._getNetAmountTotal()+" "+g})]}),f.createElement("div",{"class":"mpf-order-taxes",html:[f.createElement("div",{text:d.get("taxes")}),f.createElement("div",{text:this._getTaxesAmountTotal()+" "+g})]})]})},_getGrossAmountTotal:function(){var g=this.cart.getCurrency();return this.cart.getGrossAmountTotal().toLocaleString(this.locale,{style:"currency",currency:g,currencyDisplay:"code"}).replace(g,"").trim()},_getNetAmountTotal:function(){var g=this.cart.getCurrency();return this.cart.getNetAmountTotal().toLocaleString(this.locale,{style:"currency",currency:g,currencyDisplay:"code"}).replace(g,"").trim()},_getTaxesAmountTotal:function(){var g=this.cart.getCurrency();return this.cart.getTaxesAmountTotal().toLocaleString(this.locale,{style:"currency",currency:g,currencyDisplay:"code"}).replace(g,"").trim()}});return a});define("DS/MPFModalConfiguratorComponent/PaymentAgreementsSection",["DS/MPFView/MPFView","DS/UIKIT/Input/Toggle","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(b,d,c){var a;a=b.extend({className:"mpf-payment-agreements",setup:function(e){e||(e={});this._parent(e)},render:function(){var e=this;this.container.setContent(new d({type:"checkbox",label:c.get("agreeAndProceed"),className:"primary",events:{onChange:function(){if(this.isChecked()){e.dispatchEvent("validSection")}else{e.dispatchEvent("invalidSection")}}}}));return this}});return a});define("DS/MPFModalConfiguratorComponent/QuantityOfferSelectionSection",["UWA/Core","DS/MPFOrderComponent/OrderConfirmationSection","DS/UIKIT/Input/Number","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(b,c,a,d){var e;e=c.extend({setup:function(f){this.product=f.product;this._parent(f)},render:function(){var f;f=b.createElement("div",{"class":"mpf-quantity",html:this._createQuantityInput()});this.body.push(f);this._parent();return this},_createQuantityInput:function(){var g=this;var h;var f;h=b.createElement("span",{"class":"mpf-mult",text:"25 GB X"});this.quantity=new a({placeholder:false,min:1,max:99,step:1,value:1,decimalPrecision:1,events:{onClick:g._updateQuantity.bind(g),onChange:g._updateQuantity.bind(g)}});f=b.createElement("span",{"class":"mpf-result",text:"= 25 GB"});if(this.product==="PGB"){return[h,this.quantity,f]}else{return this.quantity}},_updateQuantity:function(){var g;var f=this.container.getElement(".mpf-result");g=this.getValue()*25;if(b.is(f)){f.setContent("= "+g.toString()+" GB")}this.dispatchEvent("onChange")},getValue:function(){if(b.is(this.quantity)){return this.quantity.getValue()}else{return 1}}});return e});define("DS/MPFModalConfiguratorComponent/OfferCardComponent",["UWA/Core","DS/MPFView/MPFView","DS/MPFServices/ObjectService","DS/MPFSoftwareProductModel/SoftwareProductModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(g,d,a,c,e){var f;var b;f={QSC:"3",YSC:"12"};b=d.extend({className:"mpf-offer",setup:function(h){h||(h={});a.requiredOfPrototype(this.model,c,"this.model must be a SoftwareProductModel");this._parent(h);this.currency=this.model.getPricelist()[0].currency;this.currencyDecimals=this.model.getPricelist()[0].currencyDecimals;this.product=h.product;this.locale=h.locale||"fr-FR"},domEvents:{click:"_handleSelectionOffer"},render:function(){var j;var i;var h;i=this.model.getLicensingScheme();h=this.model.getPricelist()[0].price;j=(this.model.getPricelist()[0].monthlyDisplay).toLocaleString(this.locale,{style:"currency",currency:this.currency,currencyDisplay:"code"}).replace(this.currency,"").trim();this.container.setContent(this._createOfferCard(j,i));this.container.setData("totalPrice",h);this.container.setData("currency",this.currency);this.container.setData("id",this.model.get("id"));this.container.setData("licensingScheme",i);return this},_createOfferCard:function(j,i){var h=this.product==="PGB"?"/ "+e.get("month")+" / 25 GB":"/ "+e.get("user")+" / "+e.get("month");var k=[];k.push(g.createElement("div",{"class":"engagement-period",html:{tag:"span",html:f[i]+"&nbsp;"+e.get("months")}}),g.createElement("div",{"class":"unit-price-label",text:e.get("unitPrice")}),g.createElement("div",{"class":"unit-price",html:j+"&nbsp;"+this.currency}),g.createElement("div",{"class":"units",text:h}));return k},_handleSelectionOffer:function(){if(this.isSelected()){this.unselectOffer();this.dispatchEvent("isNotSelected")}else{this.selectOffer();this.dispatchEvent("isSelected")}},isSelected:function(){return this.container.classList.contains("mpf-selected-offer")},selectOffer:function(){var h;this.container.classList.add("mpf-selected-offer");h=g.createElement("span",{"class":"fonticon fonticon-check "});h.inject(this.container.getElement(".engagement-period"))},unselectOffer:function(){var h;h=this.container.getElement(".fonticon");if(h){this.container.classList.remove("mpf-selected-offer");h.outerHTML=""}}});return b});define("DS/MPFModalConfiguratorComponent/OrderNumberSection",["UWA/Core","DS/MPFServices/ObjectService","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFCartModel/CartModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(c,a,e,b,f){var d;d=e.extend({setup:function(g){this._parent(g);a.requiredOfPrototype(this.model,b,"this.model must be a CartModel")},render:function(){this.body.push(c.createElement("div",{"class":"mpf-order-id",text:this.model.get("name")}));this._parent();return this}});return d});define("DS/MPFModalConfiguratorComponent/ThanksPurchasingPage",["UWA/Class/View","UWA/Core","DS/MPFUrl/UrlUtils","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent","css!DS/MPFModalConfiguratorComponent/MPFModalConfiguratorComponent"],function(e,b,a,c){var d;d=e.extend({className:"mpf-end-purchasing",setup:function(f){f||(f={});this.paymentOK=false;this.product=f.product},render:function(){var g;var i;var f;if(this.paymentOK){this.renderOK();f=c.get("purchaseComplete")}else{this.renderKO();f=c.get("purchaseFailure")}g=document.body.getElement(".mpf-configurator-offer");if(!b.is(g)){try{g=window.parent.document.body.getElement(".mpf-configurator-offer")}catch(h){g=null}}if(b.is(g)){g.getElement(".modal-content").setStyle("height","490px");if(b.is(g.getElement("iframe"))){g.getElement("iframe").setStyle("height","350px")}g.getElement(".modal-header h4").setText(f);i=g.getElements(".modal-footer button")[1];i.style.display="inline-block";i.innerHTML=c.get("close")}this.dispatchEvent("onRender");return this},isPaymentByCBCompleted:function(){var f;var g;f=new a(window.location.href);g=f.getValueParameter("state","error");this.paymentOK=(g==="completed")},setPayment:function(f){this.paymentOK=f},renderOK:function(){this.container.setContent([this._displayCheckFonticon(),this._displayOKInfo()])},renderKO:function(){this.container.setContent([this._displayWrongFonticon(),this._displayKOInfo()])},_displayCheckFonticon:function(){return b.createElement("div",{"class":"fonticon fonticon-5x fonticon-check"})},_displayWrongFonticon:function(){return b.createElement("div",{"class":"fonticon fonticon-5x fonticon-wrong"})},_displayOKInfo:function(){var f;var i;var h;var g;if(this.product==="PGB"){g=c.get("PGBPurchase")}else{if(b.is(this.product)){g=c.get("LicensesPurchase")}else{g=c.get("Purchase")}}f=b.createElement("div",{"class":"mpf-thanks-purchase",text:c.get("thanksPurchase")});i=b.createElement("div",{"class":"mpf-licence-purchase",text:g});h=b.createElement("div",{"class":"mpf-email-purchase",text:c.get("emailPurchase")});return b.createElement("div",{"class":"mpf-end-purchase-info",html:[f,i,h]})},_displayKOInfo:function(){var f;var g;f=b.createElement("div",{"class":"mpf-error-payment",text:c.get("errorPayment")});g=b.createElement("div",{"class":"mpf-support-contact",text:c.get("supportDS")});return b.createElement("div",{"class":"mpf-end-purchase-info",html:[f,g]})}});return d});define("DS/MPFModalConfiguratorComponent/BillingAddressFormSection",["UWA/Core","UWA/Promise","DS/MPFServices/ObjectService","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFAddressFormComponent/AddressFormComponentV2","DS/MPFAddressFormComponent/AddressCard","DS/MPFBuyer/BuyerType","DS/MPFCountryModel/CountryCollection","DS/MPFAddressModel/AddressCollection","DS/MPFAddressModel/AddressModel","DS/MPFModelFactory/AddressFactory","DS/MPFCompanyModel/CompanyModel","DS/MPFPersonModel/PersonModel","DS/MPFError/BadArgumentError","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(m,k,l,c,o,j,d,h,e,i,g,b,f,n,p){var a;a=c.extend({className:"mpf-billing-address-section",setup:function(s){s||(s={});var r;var q={};if(!(b.prototype.isPrototypeOf(s.buyer)||f.prototype.isPrototypeOf(s.buyer))){throw new n("BillingAddressFormSection options.buyer must be a CompanyModel or a PersonModel")}l.requiredOfPrototype(s.buyerType,d,"options.buyerType must be a BuyerType");l.requiredOfPrototype(s.addresses,e,"options.addresses must be an AddressCollection");l.requiredOfPrototype(s.addressFactory,g,"options.addressFactory must be an AddressFactory");l.requiredOfPrototype(s.countries,h,"options.countries must be a CountryCollection");this._parent(s);this.countries=s.countries;this.buyerType=s.buyerType;this.buyer=s.buyer;this.addresses=s.addresses;this.addressFactory=s.addressFactory;this.addressCards=[];q[i.Fields.IS_BILL_TO]="TRUE";q[i.Fields.IS_SHIP_TO]="TRUE";if(m.equals(this.buyerType,d.INDIVIDUAL)){r=this.addressFactory.createModel("me",q)}else{r=this.addressFactory.createModel("company",q);if(m.is(this.buyer.get("country"))){r.set("country",this.buyer.get("country"))}}this.newAddressForm=new o({addressModel:r,addressConstraints:this.addressFactory.addressesConstraints,countryReadOnly:m.equals(d.COMPANY,this.buyerType),countries:this.countries,horizontalLayout:true})},render:function(){var q=this;this.body=[];this.addressCards=[];if(this.addresses.hasBillingAddresses()){this.addresses.filter(function(r){return r.isBillTo()}).forEach(function(s){var r=new j({model:s,legalEntity:q.buyer});q.addressCards.push(r.render())});this.body.push(this.addressCards);this.newAddress=false}else{this.body.push(this.newAddressForm.render());this.newAddress=true}this._parent();return this},save:function(){if(this.newAddress){this.newAddressForm.addressModel.parentResourceId=this.buyer.get("id");return this.newAddressForm.savePromise()}else{return k.resolve()}},validate:function(){if(this.newAddress){return this.newAddressForm.validate()}else{return true}},updateCountryAddress:function(){this.newAddressForm.countrySelectComponent.setReadOnly(false);this.newAddressForm.countrySelectComponent.setValue(this.buyer.get("country"));this.newAddressForm.countrySelectComponent.setReadOnly(true)}});return a});define("DS/MPFModalConfiguratorComponent/BillingInformationSection",["UWA/Core","UWA/String","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFOrderComponent/OrderConfirmationSectionCommand","DS/UIKIT/Input/Select","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/MPFAddressFormComponent/AddressCard","DS/MPFModalConfiguratorComponent/BuyerCard","DS/MPFAddressFormComponent/AddressFormComponentV2","DS/MPFCartModel/CartPatchOperation","DS/MPFCartModel/CartPatchArray","DS/MPFAddressModel/AddressCollection","DS/MPFAddressModel/AddressModel","DS/MPFModelFactory/AddressFactory","DS/MPFCartModel/CartModel","DS/MPFModelFactory/CartFactory","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","DS/MPFPspModel/PspModel","DS/MPFCountryModel/CountryCollection","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFError/BadArgumentError","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(t,b,q,m,w,x,o,B,j,r,i,g,e,h,y,k,f,A,n,z,c,u,s,a,p,l){var v;var d={};d.ADDRESS_SELECTION="addressSelection";d.ADDRESS_DETAILS="addressDetails";d.NEW_ADDRESS_FORM="newAddressForm";v=w.extend({className:"mpf-billing-information-section mpf-section",setup:function(C){C||(C={});if(!(c.prototype.isPrototypeOf(C.buyer)||z.prototype.isPrototypeOf(C.buyer))){throw new p("BillingInformationSection options.buyer must be a CompanyModel or a PersonModel")}q.requiredOfPrototype(C.buyerType,m,"options.buyerType must be a BuyerType");q.requiredOfPrototype(C.addresses,y,"options.addresses must be an AddressCollection");q.requiredOfPrototype(C.addressFactory,f,"options.addressFactory must be an AddressFactory");q.requiredOfPrototype(C.cart,A,"options.cart must be a CartModel");q.requiredOfPrototype(C.cartPsp,u,"options.cartPsp must be a PspModel");q.requiredOfPrototype(C.cartFactory,n,"options.cartFactory must be a CartFactory");q.requiredOfPrototype(C.countries,s,"options.countries must be a CountryCollection");this._parent(C);this.cart=C.cart;this.cartPsp=C.cartPsp;this.cartFactory=C.cartFactory;this.addressFactory=C.addressFactory;this.addresses=C.addresses;this.buyerType=C.buyerType;this.buyer=C.buyer;this.countries=C.countries;this.selectedAddress=null;this._createAddressForm();this.alert=new j({messsageClassName:"error",icon:true,closable:true,visible:true,maximumVisibleMessage:1});this.stateMachine=this._createStateMachine()},render:function(){this.body=[];this._getCommands();this._getAddressSelect();this.body.push(t.createElement("div",{"class":"mpf-billing-infos",html:[this.alert,this.selectAddresses]}));this._parent();this._initListeners();this._saveAddressCommand();this.commands[0].hide();return this},isValid:function(){return t.is(this.selectedAddress)},_getAddressSelect:function(){var D=this;var C;var E;E=this.cart.getBillingAddress();if(t.is(E)){this.selectedAddress=E}else{this.selectedAddress=D.addresses.last();this._updateCart({BillTo:this.selectedAddress.id})}C=this.addresses.filter(function(F){return F.isBillTo()}).map(function(F){var G={value:F.get("id"),label:D._getAddressTitle(F)};if((F.id===D.selectedAddress.id)){G.selected=true}return G});this.selectAddresses=new o({placeholder:false,options:C,events:{onChange:function(){var F=D.addresses.find(function(G){return G.get("id")===D.selectAddresses.getValue()[0]});if(!(t.is(D.selectedAddress))){D.dispatchEvent("invalidSection")}else{if(F.id!==D.selectedAddress.id){D.selectedAddress=F;D._updateCart({BillTo:D.selectedAddress.id})}else{D.dispatchEvent("validSection")}}}}});if(t.is(E)){D.dispatchEvent("validSection")}},_updateCart:function(C){var F=this;var D;var E;if(t.is(this.selectedAddress)){F.dispatchEvent("updatingCart");this.cart.dataProxy=this.cartFactory.getDataProxy("CART");D=new e(e.Operations.modify,"/",C);E=new h();E.add(D);return this.cart.megaPatch(E).then(this.cartPsp.fetchPromise.bind(this.cartPsp)).then(function(){F.dispatchEvent("validSection")})["catch"](F._displayAlert.bind(F))}},_displayAlert:function(){this.dispatchEvent("errorPatchCart");this.alert.add({className:"error",message:l.get("errorBillingInfo")})},_getAddressTitle:function(C){var D="";["addressLine1","addressLine2","addressLine3","addressLine4","city","county","state","postalCode","country"].map(function(E){return C.get(E)}).filter(function(E){return E&&E.length>0}).map(function(E){D=D+" "+E+",";return D});return b.truncate(D,D.length-1,"")},_getCommands:function(){this.commands=[new x({icon:"floppy",iconOff:"floppy",label:l.get("save"),labelOff:l.get("save")}).render(),new x({icon:"plus",iconOff:"view-list",label:l.get("addAddress"),labelOff:l.get("listAddress")}).render(),new x({icon:"eye",iconOff:"eye-off",label:l.get("details"),labelOff:l.get("hideDetails")}).render()]},_saveAddressCommand:function(){var C=this;this.listenTo(this.commands[0],"commandOn",function(){var E;var D=C.container.getElement(".mpf-billing-infos");B.mask(C.container);C.dispatchEvent("invalidSection");C.newAddressForm.savePromise().then(function(F){C.dispatchEvent("renderEntirePage");C.addresses.add(F);E={value:F.get("id"),label:C._getAddressTitle(F)};C.selectAddresses.add(E);C.selectAddresses.setValue(E);C._createAddressForm();D.setContent(C.selectAddresses);C.commands[0].setOff();C.commands[0].hide();C.commands[1].setOff();C.commands[2].setOff();C.commands[2].show();C.stateMachine.changeState(d.ADDRESS_SELECTION)})["catch"](function(F){var G;if(Error.prototype.isPrototypeOf(F)&&(F.message.length>0)){G=F.message}else{G=l.get("errorBillingInfo")}C.alert.add({className:"error",message:G})})["finally"](function(){B.unmask(C.container)})})},_initListeners:function(){var D=this;var C=this.container.getElement(".mpf-billing-infos");this.listenTo(this.commands[1],"commandOn",function(){C.setContent([D.alert,D.newAddressForm.render()]);D.commands[0].show();D.commands[2].hide();D.dispatchEvent("newAddress");D.dispatchEvent("invalidSection");D.stateMachine.changeState(d.NEW_ADDRESS_FORM)});this.listenTo(this.commands[1],"commandOff",this.cancelAddAddress);this.listenTo(this.commands[2],"commandOn",this._displayDetails);this.listenTo(this.commands[2],"commandOff",function(){C.setContent([D.selectAddresses]);D.stateMachine.changeState(d.ADDRESS_SELECTION)});this.listenTo(this,"validSection",function(){if(D.commands[2].isOn()){D._displayDetails()}})},cancelAddAddress:function(){var C=this.container.getElement(".mpf-billing-infos");C.setContent(this.selectAddresses);this.commands[2].setOff();this.commands[0].hide();this.commands[2].show();if(t.is(this.newAddressForm)){this.newAddressForm.clear()}this.dispatchEvent("renderEntirePage");this.dispatchEvent("validSection");this.stateMachine.changeState(d.ADDRESS_SELECTION)},_displayDetails:function(){var E=this;var C=this.container.getElement(".mpf-billing-infos");var F;var D;F=this.selectedAddress.getCountry();if(F.test(/^[A-Z]{3}$/)){D=this.countries.filter(function(G){return G.getIso3()===E.selectedAddress.getCountry()}).shift().getName()}else{D=F}if(t.is(this.selectedAddress)){C.setContent([new i({model:this.buyer,buyerType:this.buyerType,country:D}).render(),new r({model:this.selectedAddress,legalEntity:this.buyer,country:D}).render()])}else{C.setContent([new i({model:this.buyer,buyerType:this.buyerType}).render(),this.selectAddresses])}this.stateMachine.changeState(d.ADDRESS_DETAILS)},_createAddressForm:function(){var D;var E;var C={};C[k.Fields.IS_BILL_TO]="TRUE";C[k.Fields.IS_SHIP_TO]="TRUE";if(t.equals(this.buyerType,m.INDIVIDUAL)){D=this.addressFactory.createModel("me",C)}else{D=this.addressFactory.createModel("company",C);D.parentResourceId=this.buyer.get("id");D.set("country",this.buyer.get("country"));E=this.buyer.get("country")&&this.buyer.get("country")!==""}this.newAddressForm=new g({addressModel:D,addressConstraints:this.addressFactory.addressesConstraints,countryReadOnly:E,countries:this.countries,horizontalLayout:true})},_createStateMachine:function(){return new a({state:d.ADDRESS_SELECTION,states:[d.ADDRESS_SELECTION,d.NEW_ADDRESS_FORM,d.ADDRESS_DETAILS],transitions:[{from:d.ADDRESS_SELECTION,to:d.NEW_ADDRESS_FORM},{from:d.ADDRESS_SELECTION,to:d.ADDRESS_DETAILS},{from:d.NEW_ADDRESS_FORM,to:d.ADDRESS_SELECTION},{from:d.ADDRESS_DETAILS,to:d.ADDRESS_SELECTION},{from:d.ADDRESS_DETAILS,to:d.NEW_ADDRESS_FORM}]})}});return v});define("DS/MPFModalConfiguratorComponent/OrderSummaryDetailsSection",["UWA/Core","DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFOrderComponent/OrderDetailsComponent","DS/MPFModalConfiguratorComponent/OrderSummarySection","DS/MPFOrderComponent/OrderConfirmationSectionCommand","DS/MPFCartModel/CartModel","DS/MPFModelFactory/CartItemFactory","DS/MPFFiniteStateMachine/FiniteStateMachine","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(k,b,l,e,h,i,c,g,j,f,m){var a;var d={};d.ORDER_DETAILS_DISPLAYED="orderDetailsDisplayed";d.ORDER_DETAILS_NOT_DISPLAYED="orderDetailsNotDisplayed";d.LOADING="loading";a=e.extend({setup:function(n){n||(n={});l.requiredOfPrototype(n.cart,g,"options.cart must be a CartModel");l.requiredOfPrototype(n.cartItemFactory,j,"options.cartItemFactory must be a CartItemFactory");this._parent(n);this.service=n.service;this.orderDetailed=this.service==="3DStore";this.cart=n.cart;this.cartItemFactory=n.cartItemFactory;this.locale=n.locale||"fr-FR";this.orderDetailsSection=null;this.orderSummarySection=null;this.idxCommands={};this.commands=this._initCommands();this.stateMachine=this._createStateMachine()},render:function(){var n=this;this.stateMachine.changeState(d.LOADING);this.cart.fetchPromise({expand:["cart-items"]}).then(function(){var o;o=n.cart.get("IsPriceDetailsDisplay")==="TRUE";n.cartItems=n.cartItemFactory.createCollection("",n.cart.getItems());if(n.orderDetailed&&o){n.orderDetailsSection=new h({cart:n.cart,cartItems:n.cartItems,locale:n.locale});n.body=n.orderDetailsSection.render();n.stateMachine.changeState(d.ORDER_DETAILS_DISPLAYED)}else{n.orderSummarySection=new i({cart:n.cart,locale:n.locale});n.body=n.orderSummarySection.render();n.stateMachine.changeState(d.ORDER_DETAILS_NOT_DISPLAYED)}n.renderParent();n._initListeners();n.dispatchEvent("onRender")})["catch"](function(){n.renderParent();new b({className:"error",messages:{className:"error",message:m.get("errorCartItems")},icon:true,closable:true,visible:true}).inject(n.container.getElement(".mpf-body"),"top");n.dispatchEvent("onRenderError")});return this},_updateBody:function(){var o=this.stateMachine.getState();var n=this.container.getElement(".mpf-body");if(o===d.ORDER_DETAILS_DISPLAYED){if(!k.is(this.orderDetailsSection)){this.orderDetailsSection=new h({cart:this.cart,cartItems:this.cartItems,locale:this.locale})}n.setContent(this.orderDetailsSection.render())}else{if(o===d.ORDER_DETAILS_NOT_DISPLAYED){if(!k.is(this.orderSummarySection)){this.orderSummarySection=new i({cart:this.cart,locale:this.locale})}n.setContent(this.orderSummarySection.render())}}},renderParent:function(){var q=[];var o;var r;var n;var p;p=this.cart&&(this.cart.get("IsPriceDetailsDisplay")==="TRUE")&&this.service!=="3DStore";r=k.createElement("h5",{"class":"mpf-title",text:this.title});q.push(r);if(p){n=k.createElement("div",{"class":"mpf-commands",html:this.commands});q.push(n)}o=k.createElement("div",{"class":"mpf-body",html:this.body});q.push(o);this.container.setContent(q);return this},_initListeners:function(){var n=this;if(k.is(this.idxCommands.details)){this.listenTo(this.commands[this.idxCommands.details],"commandOn",function(){n.orderDetailed=true;n.stateMachine.changeState(d.ORDER_DETAILS_DISPLAYED);n._updateBody()});this.listenTo(this.commands[this.idxCommands.details],"commandOff",function(){n.orderDetailed=false;n.stateMachine.changeState(d.ORDER_DETAILS_NOT_DISPLAYED);n._updateBody()})}},_initCommands:function(){var n=[];if(this.service!=="3DStore"){n.push(new c({icon:"eye",iconOff:"eye-off",label:m.get("details"),labelOff:m.get("hideDetails")}).render());this.idxCommands.details=n.length-1}return n},_createStateMachine:function(){return new f({state:this.orderDetailed?d.ORDER_DETAILS_DISPLAYED:d.ORDER_DETAILS_NOT_DISPLAYED,states:[d.ORDER_DETAILS_DISPLAYED,d.ORDER_DETAILS_NOT_DISPLAYED,d.LOADING],transitions:[{from:d.ORDER_DETAILS_DISPLAYED,to:d.ORDER_DETAILS_NOT_DISPLAYED},{from:d.ORDER_DETAILS_NOT_DISPLAYED,to:d.ORDER_DETAILS_DISPLAYED},{from:d.ORDER_DETAILS_DISPLAYED,to:d.LOADING},{from:d.ORDER_DETAILS_NOT_DISPLAYED,to:d.LOADING},{from:d.LOADING,to:d.ORDER_DETAILS_DISPLAYED},{from:d.LOADING,to:d.ORDER_DETAILS_NOT_DISPLAYED}]})}});return a});define("DS/MPFModalConfiguratorComponent/SecurePaymentPage",["UWA/Core","UWA/Promise","UWA/Class/View","UWA/String","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","DS/MPFModalConfiguratorComponent/BankAccountInformationSection","DS/MPFModalConfiguratorComponent/OrderNumberSection","DS/MPFModalConfiguratorComponent/PaymentInformationSupportSection","DS/MPFModalConfiguratorComponent/PaymentAgreementsSection","DS/MPFModalConfiguratorComponent/ThanksPurchasingPage","DS/MPFCartModel/CartModel","DS/MPFVirtualIbanModel/VirtualIbanModel","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(m,d,f,a,k,h,e,c,s,i,l,j,o,r,n,q,b,g){var p;p=f.extend({className:"mpf-secure-payment-page",setup:function(t){t||(t={});k.requiredOfPrototype(t.buyerType,h,"options.buyerType must be a BuyerType");k.requiredOfPrototype(t.cart,r,"options.cart must be a CartModel");k.requiredOfPrototype(t.virtualIban,n,"options.virtualIban must be a VirtualIbanModel");this.buyerType=h.prototype.isPrototypeOf(t.buyerType)?t.buyerType:h.INDIVIDUAL;this.cart=t.cart;this.virtualIban=t.virtualIban;this.currency=this.cart.get("currency");this.product=t.product;this.cartPaid=t.cartPaid},render:function(){this._initSections();this.container.setContent([this.sections[0].render(),this.sections[1].render(),this.sections[2].render()]);if(m.is(this.sections[3])){this.container.addContent(this.sections[3].render());this._initListeners()}return this},save:function(){var v=this;var u=d.deferred();var w=new c("modify","/",{currentState:"PENDING_PAYMENT",VirtualIbanId:this.virtualIban.get("Id")});var x=new e();var t;if(m.is(this.product)){t=new o({product:this.product})}else{t=new o()}x.add(w);this.cart.megaPatch(x).then(function(){t.setPayment(true);v.container.setContent(t.render());v.dispatchEvent("IbanOperation","Complete");u.resolve()})["catch"](function(){t.setPayment(false);v.container.setContent(t.render());v.dispatchEvent("IbanOperation","Failure");u.reject()});return u.promise},_initSections:function(){this.sections=[new s({title:a.format(g.get("countdownTransfer"),this.cart.get("GrossAmountTotal")+" "+this.currency),virtualIban:this.virtualIban}),new i({title:g.get("mentionOrderNumber"),model:this.cart}),new l()];if(!this.cartPaid){this.sections.push(new j())}},_initListeners:function(){var t=this;this.listenTo(this.sections[3],"validSection",function(){t.dispatchEvent("valid")});this.listenTo(this.sections[3],"invalidSection",function(){t.dispatchEvent("invalid")})}});return p});define("DS/MPFModalConfiguratorComponent/BillingInformationFormSection",["UWA/Core","DS/MPFServices/ObjectService","DS/MPFError/BadArgumentError","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFModalConfiguratorComponent/CompanyInformationSection","DS/MPFPersonComponent/PersonNameForm","DS/MPFBuyer/BuyerType","DS/MPFBuyerAddressComponent/BuyerTypeSelectorInput","DS/MPFCompanyModel/CompanyModel","DS/MPFPersonModel/PersonModel","DS/MPFCountryModel/CountryCollection","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(j,i,l,b,k,d,c,f,a,g,h,m){var e;e=b.extend({setup:function(o){o||(o={});if(!(a.prototype.isPrototypeOf(o.buyer)||g.prototype.isPrototypeOf(o.buyer))){throw new l("BillingInformationFormSection options.buyer must be a CompanyModel or a PersonModel")}i.requiredOfPrototype(o.buyerType,c,"options.buyerType must be a BuyerType");i.requiredOfPrototype(o.countries,h,"options.countries must be a CountryCollection");var n;this._parent(o);this.buyer=o.buyer;this.countries=o.countries;this.buyerType=o.buyerType;this.service=o.service;if(j.equals(c.COMPANY,this.buyerType)){this.companyInformationSection=new k({model:this.buyer,countryCollection:this.countries});n=true}else{this.personInformationSection=new d({model:this.buyer,readOnly:true,required:true,horizontalLayout:true});n=this.buyer.get("buyerType")!=="none"}if(this.service==="3DPrint"&&!n){this.companyFactory=o.companyFactory;this.company=this.companyFactory.createModel("me");this.buyerTypeInput=new f({model:this.buyer,readOnly:n});this.companyInformationSection=new k({model:this.company,countryCollection:this.countries});this.listenTo(this.buyerTypeInput,"onChange",this.onBuyerTypeChange)}},render:function(){this.body=[];if(this.buyerTypeInput){this.body.push(this.buyerTypeInput.render())}if(j.equals(c.COMPANY,this.buyerType)){this.body.push(this.companyInformationSection.render())}else{this.body.push({tag:"div","class":"mpf-person-form",html:this.personInformationSection.render()})}this._parent();return this},validate:function(){if(j.equals(c.COMPANY,this.buyerType)){return this.companyInformationSection.validate()}else{return this.personInformationSection.validate()}},save:function(){if(j.equals(c.COMPANY,this.buyerType)){return this.companyInformationSection.save()}},onBuyerTypeChange:function(n){if(n==="company"){this.company.unset(a.Fields.COUNTRY);this.company.unset(a.Fields.TAX_REGISTRATION_ID);this.buyerType=c.COMPANY}else{this.buyerType=c.INDIVIDUAL;this.companyInformationSection.clearForm()}this.dispatchEvent("onTypeChange",{buyerType:this.buyerType,company:this.company})}});return e});define("DS/MPFModalConfiguratorComponent/ConfirmMy3dExperienceBankTransferPage",["UWA/Core","UWA/Class/View","UWA/String","UWA/Promise","DS/UIKIT/Form","DS/UIKIT/Input/Toggle","DS/MPFServices/ObjectService","DS/MPFPurchaseOrderModel/PurchaseOrderModel","DS/MPFCartQuoteModel/CartQuoteModel","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","DS/MPFCartModel/CartModel","DS/MPFVirtualIbanModel/VirtualIbanModel","DS/MPFModalConfiguratorComponent/ThanksPurchasingPage","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(l,e,c,h,g,i,j,d,p,n,k,f,b,m,o){var a;a=e.extend({className:"mpf-confirm-bank-transfer-my3dexperience",setup:function(q){q||(q={});j.requiredOfPrototype(q.cart,f,"options.cart must be a CartModel");j.requiredOfPrototype(q.cartQuote,p,"options.cartQuote must be a CartQuoteModel");j.requiredOfPrototype(q.virtualIban,b,"options.virtualIban must be a VirtualIbanModel");j.requiredOfPrototype(this.model,d,"this.model must be a PurchaseOrderModel");this.cartQuote=q.cartQuote;this.product=q.product;this.cart=q.cart;this.virtualIban=q.virtualIban},render:function(){this.container.setContent([this._createDeployMessage(),this._createInvoiceInput(),this._createToggle(),this._createAfterSubmissionMessage(),this._createDelayPaymentMessage(),this._createSupportMessage()]);this.dispatchEvent("valid");return this},save:function(){var q=h.deferred();if(this.validate()){if(this.toggle.isChecked()){this._patchCartPendingPayment().then(this._deferredPaymentValidated.bind(this,q))["catch"](function(){q.reject("PurchaseOrderNumber")})}else{this.model.setNumber(this.invoiceInput.getValue("invoice-input"));this.model.savePromise().then(this._patchCartPendingPayment.bind(this,this.model.getNumber())).then(this._deferredPaymentValidated.bind(this,q))["catch"](function(){q.reject("PurchaseOrderNumber")})}}else{q.reject("PurchaseOrderNumber")}return q.promise},validate:function(){if(this.toggle.isChecked()){return true}else{return this.invoiceInput.getValue("invoice-input").length>0}},_patchCartPendingPayment:function(q){var r={currentState:f.STATUS.pendingPayment,VirtualIbanId:this.virtualIban.getId()};var s;var t;if(l.is(q)){r.PurchaseOrderNumber=q}s=new k("modify","/",r);t=new n();t.add(s);return this.cart.megaPatch(t)},_displayValidationPage:function(){var q;q=new m({product:this.product});q.setPayment(true);this.container.setContent(q.render())},_deferredPaymentValidated:function(q){q.resolve();this.dispatchEvent("deferredPaymentComplete");this._displayValidationPage()},_createSupportMessage:function(){return l.createElement("p",{"class":"mpf-contact-support",html:c.format(o.get("supportMessage"),this._createSupportLink().outerHTML)})},_createSupportLink:function(){return l.createElement("a",{href:"mailto:marketplace.my3dexperience@3ds.com",text:o.get("support")})},_createToggle:function(){var q=this;this.toggle=new i({type:"switch",label:o.get("noNeedAnOrderReference"),events:{onChange:function(){if(this.isChecked()){q.invoiceInput.disable()}else{q.invoiceInput.enable()}}}});return this.toggle},_createDeployMessage:function(){return l.createElement("p",{html:c.format(o.get("providingPOMessage"),this._getQuoteLink().outerHTML)})},_createAfterSubmissionMessage:function(){return l.createElement("p",{text:o.get("afterSubmissionMessage")})},_createDelayPaymentMessage:function(){return l.createElement("p",{"class":"bank-transfer-delay",text:o.get("bankTransfer30days")})},_getQuoteLink:function(){return l.createElement("a",{href:this.cartQuote.getUrl(),target:"_blank",text:o.get("quote")})},_createInvoiceInput:function(){this.invoiceInput=new g({className:"horizontal",fields:[{name:"invoice-input",type:"text",label:o.get("referenceMention"),errorText:o.get("errorPO")}]});if(l.is(this.cart.get("PurchaseOrderNumber"))){this.invoiceInput.setValue("invoice-input",this.cart.get("PurchaseOrderNumber"))}return this.invoiceInput}});return a});define("DS/MPFModalConfiguratorComponent/BillingInformationPage",["UWA/Core","UWA/Class/View","UWA/Promise","DS/MPFBuyer/BuyerType","DS/MPFModalConfiguratorComponent/BillingInformationFormSection","DS/MPFModalConfiguratorComponent/BillingAddressFormSection","DS/MPFCompanyModel/CompanyModel","DS/MPFCountryModel/CountryCollection","DS/MPFPersonModel/PersonModel","DS/MPFAddressModel/AddressCollection","DS/MPFModelFactory/AddressFactory","DS/MPFModelFactory/CompanyFactory","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFError/BadArgumentError","DS/MPFError/ValidationError","DS/MPFServices/ObjectService","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(n,p,e,k,b,q,c,o,s,r,g,h,a,l,i,m,j){var f;var d={};d.INDIVIDUAL_VIEW="individualView";d.COMPANY_VIEW="companyView";f=p.extend({className:"mpf-billing-info-page",setup:function(t){t||(t={});m.requiredOfPrototype(t.buyerType,k,"options.buyerType must be a BuyerType");m.requiredOfPrototype(t.countries,o,"options.countries must be a CountryCollection");m.requiredOfPrototype(t.me,s,"options.me must be a PersonModel");m.requiredOfPrototype(t.addresses,r,"options.addresses must be an AddressCollection");m.requiredOfPrototype(t.addressFactory,g,"options.addressFactory must be an AddressFactory");if(n.equals(k.COMPANY,t.buyerType)){m.requiredOfPrototype(t.company,c,"options.company must be a CompanyModel")}if(t.service==="3DPrint"){m.requiredOfPrototype(t.companyFactory,h,"options.companyFactory must be a CompanyFactory");this.companyFactory=t.companyFactory}this.buyerType=k.prototype.isPrototypeOf(t.buyerType)?t.buyerType:k.INDIVIDUAL;this.me=t.me;this.company=t.company;this.addresses=t.addresses;this.addressFactory=t.addressFactory;this.countries=t.countries;this.service=t.service;if(n.equals(k.COMPANY,this.buyerType)){this.buyer=this.company;this.stateMachine=this._createStateMachine(d.COMPANY_VIEW)}else{this.buyer=this.me;this.stateMachine=this._createStateMachine(d.INDIVIDUAL_VIEW)}this._initSections()},render:function(){this.container.setContent([this.sections[0].render(),this.sections[1].render(),this._requiredFieldsLabel()]);this.dispatchEvent("valid");return this},save:function(){var u=this;var v=false;var t=false;t=this.sections[0].validate();v=this.sections[1].validate();if(t&&v){if(n.equals(k.COMPANY,this.buyerType)){return this.sections[0].save().then(u.sections[1].save.bind(u.sections[1])).then(function(w){u.addresses.add(w);return w})}else{return this.sections[1].save().then(function(w){u.addresses.add(w);return w})}}else{u.dispatchEvent("invalidPage");return e.reject(new i(j.get("errorFieldsInfo")))}},isValid:function(){var t;var x;var v;var w=false;var u=false;if(n.is(this.addresses)){u=this.addresses.hasBillingAddresses()}if(n.equals(k.COMPANY,this.buyerType)){t=this.company.getName()&&this.company.getName()!=="";x=this.company.getCountry()&&this.company.getCountry()!=="";v=this.company.getTaxRegistrationId()&&this.company.getTaxRegistrationId()!==""&&this.company.validTaxRegID(this.company.getTaxRegistrationId(),this.company.getCountry());w=t&&x&&v;return u&&w}else{return u}},_initSections:function(){this.sections=[new b({title:j.get("billInfo"),buyer:this.buyer,addresses:this.addresses,countries:this.countries,buyerType:this.buyerType,service:this.service,companyFactory:this.companyFactory}),new q({title:j.get("billAddress"),addresses:this.addresses,addressFactory:this.addressFactory,buyer:this.buyer,buyerType:this.buyerType,countries:this.countries})];this._initListeners()},_initListeners:function(){this.listenTo(this.sections[0],"onTypeChange",this._adaptAddressFormToBuyerType.bind(this));this._initListenerBuyerCountry()},_adaptAddressFormToBuyerType:function(t){this.buyerType=t.buyerType;if(n.equals(this.buyerType,k.COMPANY)){this.buyer=t.company;this.company=t.company;this.addresses=this.addressFactory.createCollection("company");this.stateMachine.changeState(d.COMPANY_VIEW)}else{this.buyer=this.me;this.addresses=this.addressFactory.createCollection("me");this.stateMachine.changeState(d.INDIVIDUAL_VIEW)}this.addresses.parentResourceId=this.buyer.get("id");this.sections[1]=new q({title:j.get("billAddress"),addresses:this.addresses,addressFactory:this.addressFactory,buyer:this.buyer,buyerType:this.buyerType,countries:this.countries});this.render();this._initListenerBuyerCountry()},_initListenerBuyerCountry:function(){if(n.equals(k.COMPANY,this.buyerType)){this.listenTo(this.buyer,"onChange:country",this.sections[1].updateCountryAddress.bind(this.sections[1]))}},_requiredFieldsLabel:function(){return n.createElement("div",{"class":"mpf-required-fields",html:[n.createElement("em",{"class":"mpf-required",html:"*"}),n.createElement("span",{html:j.get("requiredFields")})]})},_createStateMachine:function(t){return new a({state:t,states:[d.INDIVIDUAL_VIEW,d.COMPANY_VIEW],transitions:[{from:d.INDIVIDUAL_VIEW,to:d.COMPANY_VIEW},{from:d.COMPANY_VIEW,to:d.INDIVIDUAL_VIEW}]})}});return f});define("DS/MPFModalConfiguratorComponent/EngagementPeriodSection",["UWA/Core","UWA/Class/Listener","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFModalConfiguratorComponent/OfferCardComponent","DS/MPFSoftwareProductModel/SoftwareProductCollection","DS/MPFSoftwareProductModel/SoftwareProductModel","DS/MPFServices/ObjectService","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(g,h,b,c,e,a,f,i){var d;d=b.extend({setup:function(j){f.requiredOfPrototype(j.offers,e,"options.offers must be a SoftwareProductCollection");this._parent(j);this.offers=j.offers;this.offerCards=[];this.selectedOffer=null;this.product=this.offers.product;this.locale=j.locale||"fr-FR"},render:function(){var j=this;this.offers.forEach(function(k){j.offerCards.push(new c({model:k,product:j.product,locale:j.locale}).render())});this.body.push(g.createElement("div",{"class":"mpf-offers",html:j.offerCards}));this._parent();this._initListeners();return this},getIdOffer:function(){return this.selectedOffer.container.getData("id")},isAnOfferSelected:function(){return g.is(this.selectedOffer)},getTotalPriceSelectedOffer:function(){return this.selectedOffer.container.getData("totalPrice")},getCurrencySelectedOffer:function(){return this.selectedOffer.container.getData("currency")},getLicensingSchemeSelectedOffer:function(){return this.selectedOffer.container.getData("licensingScheme")},selectYearlyOfferByDefault:function(){var j=this;this.offerCards.forEach(function(k){if(k.container.getData("licensingScheme")===a.LicensingScheme.YEARLY){k.selectOffer();j.selectedOffer=k;j.dispatchEvent("offerSelectionUpdated")}})},_initListeners:function(){var j=this;this.offerCards.forEach(function(k){new h().listenTo(k,"isSelected",function(){j.offerCards.forEach(function(l){if(l.container.getData("id")!==k.container.getData("id")){l.unselectOffer()}});j.selectedOffer=k;j.dispatchEvent("offerSelectionUpdated")});new h().listenTo(k,"isNotSelected",function(){j.selectedOffer=null;j.dispatchEvent("offerSelectionUpdated")})})}});return d});define("DS/MPFModalConfiguratorComponent/CBTokenPaymentConfirmationPage",["UWA/Core","UWA/Promise","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFPaymentCardTokenModel/PaymentCardTokenModel","DS/MPFModalConfiguratorComponent/RecapCBTokenSection","DS/MPFModalConfiguratorComponent/OrderInformationSection","DS/MPFModelFactory/CartFactory","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","DS/MPFModalConfiguratorComponent/ThanksPurchasingPage","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(i,e,a,g,f,b,c,l,d,k,h,j,n){var m;m=a.extend({className:"mpf-cbtoken-page",setup:function(o){o||(o={});g.requiredOfPrototype(o.token,f,"options.token must be a PaymentCardTokenModel");g.requiredOfPrototype(o.cart,d,"options.cart must be a CartModel");g.requiredOfPrototype(o.cartFactory,l,"options.cartFactory must be a CartFactory");this.cart=o.cart;this.cartFactory=o.cartFactory;this.token=o.token;this.product=o.product;this.locale=o.locale||"fr-FR"},render:function(){this._initSections();this.container.setContent([this.sections[0].render(),this.sections[1].render()]);this.dispatchEvent("valid");return this},save:function(){var q=this;var p=e.deferred();var o;if(i.is(this.product)){o=new j({product:this.product})}else{o=new j()}this._updateCart().then(function(){if(q.service!=="3DPrint"){o.setPayment(true);q.container.setContent(o.render())}q.dispatchEvent("PaymentTokenOperation","Complete");p.resolve()})["catch"](function(){if(q.service!=="3DPrint"){o.setPayment(false);q.container.setContent(o.render())}q.dispatchEvent("PaymentTokenOperation","Failure");p.resolve()});return p.promise},_updateCart:function(o){var p=new h(h.Operations.modify,"/",{currentState:"PENDING_PAYMENT",CreditCardTokenId:this.token.getCardId()});var q=new k();this.cart.dataProxy=this.cartFactory.getDataProxy("cart");q.add(p);return this.cart.megaPatch(q)},_initSections:function(){this.sections=[new c({title:n.get("orderInformation"),model:this.cart,locale:this.locale}),new b({title:n.get("titleCBToken"),token:this.token})]}});return m});define("DS/MPFModalConfiguratorComponent/ConfiguratorPage",["UWA/Class/View","UWA/Promise","DS/MPFBuyer/BuyerType","DS/MPFModalConfiguratorComponent/EngagementPeriodSection","DS/MPFModalConfiguratorComponent/QuantityOfferSelectionSection","DS/MPFModalConfiguratorComponent/OrderRecapPerYearSection","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","DS/MPFSoftwareProductModel/SoftwareProductCollection","DS/MPFSoftwareProductModel/SoftwareProductModel","DS/MPFCartModel/CartModel","DS/MPFCartQuoteModel/CartQuoteModel","DS/MPFModelFactory/CartFactory","DS/MPFPurchaseOrderModel/PurchaseOrderModel","DS/MPFPspModel/PspModel","DS/MPFUtils/MPFUtils","DS/MPFServices/ObjectService","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(q,c,h,l,a,f,e,d,j,b,s,o,i,m,p,r,n,g){var k;k=q.extend({className:"mpf-configurator-page",setup:function(t){t||(t={});n.requiredOfPrototype(t.cart,s,"options.cart must be a CartModel");n.requiredOfPrototype(t.buyerType,h,"options.buyerType must be a BuyerType");n.requiredOfPrototype(t.offers,j,"options.offers must be a SoftwareProductCollection");n.requiredOfPrototype(t.cartQuote,o,"options.cartQuote must be a CartQuoteModel");n.requiredOfPrototype(t.cartFactory,i,"options.cartFactory must be a CartFactory");n.requiredOfPrototype(t.purchaseOrderModel,m,"options.purchaseOrderModel must be a PurchaseOrderModel");n.requiredOfPrototype(t.cartPsp,p,"options.cartPsp must be a PspModel");this.buyerType=h.prototype.isPrototypeOf(t.buyerType)?t.buyerType:h.INDIVIDUAL;this.offers=t.offers;this.cart=t.cart;this.cartQuote=t.cartQuote;this.cartFactory=t.cartFactory;this.platform=t.platform;this.purchaseOrderModel=t.purchaseOrderModel;this.cartPsp=t.cartPsp;this.currency=this.offers.first().getPricelist()[0].currency;this.currencyDecimals=this.offers.first().getPricelist()[0].currencyDecimals;this.locale=t.locale||"fr-FR";this.sections=[new l({title:g.get("chooseOffer"),offers:this.offers,locale:this.locale}),new a({title:g.get("quantity"),product:this.offers.product}),new f({title:g.get("totalYear"),currency:this.currency,currencyDecimals:this.currencyDecimals,locale:this.locale})]},render:function(){this.container.setContent([this.sections[0].render(),this.sections[1].render(),this.sections[2].render()]);this._initListeners();this.sections[0].selectYearlyOfferByDefault();return this},save:function(){var u=this;var w;var v;var t=c.deferred();if(this.cart.get("id")!==""){this.cart.dataProxy=this.cartFactory.getDataProxy("me");this.cart.defaults.items=[];this.cart.defaults.timelineItems=[];this.cart.set(this.cart.defaults);this.cart.billingAddress=null;this.cart.unset("totalNetPrice");this.cart.unset("companyID")}this.cart.unset("id");this.cart.set({currency:this.sections[0].getCurrencySelectedOffer(),onlineInstance:this.platform,licensingScheme:this.sections[0].getLicensingSchemeSelectedOffer()});this.cart.savePromise().then(function(){w=new e();v=new d(d.Operations.add,"/cart-items",{OfferID:u.sections[0].getIdOffer(),OnlineInstanceId:u.cart.getOnlineInstance(),type:s.Types.SOFTWARE_REQUEST,Quantity:parseInt(u.sections[1].getValue(),10),TempUUID:r.generateUUID()});w.add(v);u.cart.dataProxy=u.cartFactory.getDataProxy("cart");return u.cart.megaPatch(w,{})}).then(u._getCartPSP.bind(u)).then(function(){u.cartQuote.setParentResourceId(u.cart.id);u.purchaseOrderModel.setParentResourceId(u.cart.id);t.resolve()})["catch"](function(){t.reject("CartItemsCreation")});return t.promise},_getCartPSP:function(){this.cartPsp.setParentResourceId(this.cart.id);return this.cartPsp.fetchPromise()},_initListeners:function(){var t=this;this.listenTo(this.sections[0],"offerSelectionUpdated",function(){if(t.sections[0].isAnOfferSelected()){t.sections[2].updateTotalPrice(t.sections[0].getTotalPriceSelectedOffer(),t.sections[0].getCurrencySelectedOffer(),t.sections[1].getValue(),t.sections[0].getLicensingSchemeSelectedOffer())}else{t.sections[2].updateTotalPrice(0,t.currency,0,b.LicensingScheme.YEARLY)}});this.listenTo(this.sections[1],"onChange",function(){if(t.sections[0].isAnOfferSelected()){t.sections[2].updateTotalPrice(t.sections[0].getTotalPriceSelectedOffer(),t.sections[0].getCurrencySelectedOffer(),t.sections[1].getValue(),t.sections[0].getLicensingSchemeSelectedOffer())}else{t.sections[2].updateTotalPrice(0,t.currency,0,b.LicensingScheme.YEARLY)}});this.listenTo(this.sections[2],"priceUpdated",function(u){if(u>0){t.dispatchEvent("valid")}else{t.dispatchEvent("invalid")}})}});return k});define("DS/MPFModalConfiguratorComponent/ModalConfiguratorComponent",["UWA/Core","UWA/Promise","UWA/Class/View","DS/UIKIT/Modal","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/UIKIT/Scroller","DS/MPFServices/MarketplaceServices","DS/MPFOrderComponent/OrderConfirmationPage","DS/MPFModalConfiguratorComponent/ConfiguratorPage","DS/MPFModalConfiguratorComponent/SecurePaymentPage","DS/MPFModalConfiguratorComponent/ConfirmMakeBankTransferPage","DS/MPFModalConfiguratorComponent/ConfirmMy3dExperienceBankTransferPage","DS/MPFModalConfiguratorComponent/BillingInformationPage","DS/MPFModalConfiguratorComponent/CBTokenPaymentConfirmationPage","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemCollection","DS/MPFModelFactory/CartFactory","DS/MPFModelFactory/CartItemFactory","DS/MPFAddressModel/AddressCollection","DS/MPFModelFactory/AddressFactory","DS/MPFTCContractModel/SoftwareAgreementModel","DS/MPFModelFactory/TCContractFactory","DS/MPFPaymentCardTokenModel/PaymentCardTokenCollection","DS/MPFModelFactory/VirtualIbanFactory","DS/MPFSoftwareProductModel/SoftwareProductCollection","DS/MPFCompanyModel/CompanyModel","DS/MPFCountryModel/CountryCollection","DS/MPFShopModel/ShopModel","DS/MPFModelFactory/TCDocumentFactory","DS/MPFTCContractModel/TCContractModel","DS/MPFModelFactory/CompanyFactory","DS/MPFModelFactory/PaymentCardTokenFactory","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","DS/MPFCartQuoteModel/CartQuoteModel","DS/MPFPurchaseOrderModel/PurchaseOrderModel","DS/MPFPurchaseOrderModel/PurchaseOrderDocumentModel","DS/MPFPspModel/PspModel","DS/MPFServices/ObjectService","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFError/ValidationError","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent","css!DS/MPFModalConfiguratorComponent/MPFModalConfiguratorComponent"],function(I,y,S,g,O,J,w,P,u,t,n,c,i,E,x,U,q,p,f,R,z,e,G,F,r,M,A,d,H,b,Q,s,D,k,j,l,N,a,C,T,B,h,K,o,v,V){var m={};m.PAGE_DISPLAYED="pageDisplayed";m.IFRAME_DISPLAYED="iframeDisplayed";m.SAVING_PAGE="savingPage";var L=S.extend({setup:function(W){W||(W={});this._checkPrototypes(W);this._parent(W);this.serviceRequest=I.is(W.serviceRequest)?W.serviceRequest:u.MAKE;this.service=W.service;this.me=W.me;this.buyerType=W.buyerType;this.cart=W.cart;this.cartQuote=W.cartQuote;this.cartFactory=W.cartFactory;this.cartItemFactory=W.cartItemFactory;this.company=W.company;this.addresses=W.addresses;this.addressFactory=W.addressFactory;this.countries=W.countries;this.tcContractFactory=W.tcContractFactory;this.tokenCards=W.tokenCards;this.virtualIbanFactory=W.virtualIbanFactory;this.platform=W.platform;this.paymentCardTokenFactory=W.paymentCardTokenFactory;this.bankTransferActive=I.is(W.bankTransferActive)?W.bankTransferActive:true;this.purchaseOrderModel=W.purchaseOrderModel;this.periodicitiesAlreadyPurchased=W.periodicitiesAlreadyPurchased;this.cartPsp=W.cartPsp;this.isPaymentSent=false;this.locale=W.locale||"fr-FR";if(I.equals(q.COMPANY,this.buyerType)){this.buyer=this.company}else{this.buyer=this.me}this.alert=new w({messsageClassName:"error",icon:true,closable:true,visible:true,hideDelay:5000,maximumVisibleMessages:1,autoHide:true});this.stateMachine=this._createStateMachine()},render:function(W){this._initPages();this._createModal();this.modal.inject(W);this.displayNextPage();return this},_initPages:function(){var X=this;var W;var Y;this.pages=[];this.titlePages=[];this.labelNextButton=[];this.idxPages={};this.currentPage=-1;if(this.stateMachine.getState()===m.IFRAME_DISPLAYED){this._initIframe(I.createElement("iframe",{src:this.cart.getPaymentUrl()}))}else{if(this.service==="3DStore"){W=new n({buyerType:this.buyerType,offers:this.offers,cart:this.cart,cartQuote:this.cartQuote,cartFactory:this.cartFactory,purchaseOrderModel:this.purchaseOrderModel,cartPsp:this.cartPsp,platform:this.platform,locale:this.locale});this.pages.push(W);this.titlePages.push(this.productName);this.labelNextButton.push(V.get("checkoutButton"));this.idxPages.configuratorPage=this.pages.length-1}Y=new x({me:this.me,buyerType:this.buyerType,company:this.company,addresses:this.addresses,addressFactory:this.addressFactory,countries:this.countries,service:this.service,companyFactory:this.companyFactory});if(!Y.isValid()){this.pages.push(Y);this.titlePages.push(V.get("billingInformationTitle"));this.labelNextButton.push(V.get("saveBillInfo"));this.idxPages.billingInformationPage=this.pages.length-1;this.listenTo(this.pages[this.idxPages.billingInformationPage],"invalidPage",function(){J.unmask(X.modal.getBody())})}else{this._initCheckoutPage()}}},_initCheckoutPageListeners:function(){var W=this;this.listenTo(this.pages[this.idxPages.checkoutPage1],"newAddress",function(){W.nextButton.hide()});this.listenTo(this.pages[this.idxPages.checkoutPage1],"renderEntirePageCheckout",function(){W.nextButton.show()});this.listenTo(this.pages[this.idxPages.checkoutPage1],"bankTransferInitiated",this.doBankTransfer);this.listenTo(this.pages[this.idxPages.checkoutPage1],"paymentByToken",this._paymentByToken);this.listenTo(this.pages[this.idxPages.checkoutPage1],"displayIframe",function(X){W.stateMachine.changeState(m.IFRAME_DISPLAYED);W._initIframe(X);W.displayNextPage()})},_paymentByToken:function(Z){var Y=this;var W={cart:this.cart,cartFactory:this.cartFactory,locale:this.locale};var X;if(I.is(this.offers)&&I.is(this.offers.product)){W.product=this.offers.product}W.token=Z;J.unmask(this.modal.getBody());X=new U(W);this.pages.push(X);this.titlePages.push(V.get("checkoutTitle2"));this.labelNextButton.push(V.get("paymentButton"));this.idxPages.cbTokenRecapPage=this.pages.length-1;this.listenTo(X,"PaymentTokenOperation",function(aa){if(Y.service==="3DPrint"){Y.isPaymentSent=true;Y.modal.hide();Y._dispatchStatePayment(aa==="Complete")}else{J.unmask(Y.modal.getBody());Y.nextButton.hide();Y.cancelButton.setValue(V.get("close"));Y.modal.setHeader({tag:"h4",text:V.get("purchase"+aa)})}})},_initIframe:function(W){var X=this;this.pages.push(W);this.idxPages.iframe=this.pages.length-1;this.titlePages.push(V.get("checkoutTitle2"));W.addEventListener("load",function(){var aa;var Y;var Z;aa=X.service==="3DPrint";try{Y=this.contentWindow.location.pathname.indexOf("paymentConfirmation.html")!==-1}catch(ab){Y=false}if(aa&&Y){Z=this.contentWindow.location.href.indexOf("state=completed")!==-1;X._dispatchStatePayment(Z);X.currentPage+=1;X.isPaymentSent=Z;X.modal.hide()}})},_dispatchStatePayment:function(W){if(W){this.dispatchEvent("paymentCompleted")}else{this.dispatchEvent("paymentDeclined")}},displayNextPage:function(){var W;W=this.stateMachine.getState();if(this.currentPage+1<this.pages.length){this.currentPage+=1;this.nextButton.disable();this._initButtonListeners(this.pages[this.currentPage]);this.modal.setHeader({tag:"h4",text:this.titlePages[this.currentPage]});this.nextButton.setValue(this.labelNextButton[this.currentPage]);if(W===m.IFRAME_DISPLAYED){J.unmask(this.modal.getBody());this.modal.setBody([this.alert,this.pages[this.currentPage]]);this.nextButton.hide();this.cancelButton.hide();this.modal.elements.wrapper.setStyle("height","unset");this.modal.elements.content.setStyle("max-height","unset")}else{if(W===m.PAGE_DISPLAYED){J.unmask(this.modal.getBody());this.modal.setBody(I.createElement("div",{"class":"mpf-scroll",html:[this.alert,this.pages[this.currentPage].render()]}));this.scroller=new P({element:this.modal.getBody().getElement(".mpf-scroll")});this.scroller.inject(this.modal.getBody());this.pages[this.currentPage].scroller=this.scroller}}}},doBankTransfer:function(Z){var Y=this;var W;if(this.service==="3DPrint"){W=new i({model:this.purchaseOrderModel,cart:this.cart,cartFactory:this.cartFactory,purchaseOrderDocument:this.purchaseOrderDocument});this.nextButton.hide();this.listenTo(W,"endPurchaseOrderStep",function(){Y.isPaymentSent=true;Y.modal.hide()});this.listenTo(W,"showSaveButton",function(){Y.nextButton.setValue(V.get("save"));Y.nextButton.enable();Y.nextButton.show()})}if(this.service==="3DStore"){var X={model:this.purchaseOrderModel,cartQuote:this.cartQuote,virtualIban:Z.first(),cart:this.cart};if(I.is(this.offers)){X.product=this.offers.product}W=new E(X);this.labelNextButton.push(V.get("submit"));this.listenTo(W,"deferredPaymentComplete",function(){J.unmask(Y.modal.getBody());Y.nextButton.hide();Y.cancelButton.setValue(V.get("close"));Y.modal.setHeader({tag:"h4",text:V.get("purchaseComplete")})})}this.pages.push(W);this.titlePages.push(V.get("checkoutTitle2"));this.idxPages.checkoutPage2=this.pages.length-1},_initButtonListeners:function(W){this.listenTo(W,"valid",this.nextButton.enable.bind(this.nextButton));this.listenTo(W,"invalid",this.nextButton.disable.bind(this.nextButton))},_initCheckoutPage:function(){var W;W=new t({serviceRequest:this.serviceRequest,service:this.service,me:this.me,buyerType:this.buyerType,cart:this.cart,cartQuote:this.cartQuote,addresses:this.addresses,buyer:this.buyer,addressFactory:this.addressFactory,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory,softwareAgreement:this.softwareAgreement,onlineServiceAgreement:this.onlineServiceAgreement,tcContractFactory:this.tcContractFactory,tokenCards:this.tokenCards,virtualIbanFactory:this.virtualIbanFactory,shopModel:this.shopModel,tcDocumentFactory:this.tcDocumentFactory,bankTransferActive:this.bankTransferActive,countries:this.countries,periodicitiesAlreadyPurchased:this.periodicitiesAlreadyPurchased,cartPsp:this.cartPsp,locale:this.locale});this.pages.push(W);this.titlePages.push(V.get("checkoutTitle1"));this.labelNextButton.push(V.get("paymentButton"));this.idxPages.checkoutPage1=this.pages.length-1;this._initCheckoutPageListeners()},_createModal:function(){this.modal=new g({className:"mpf-configurator-offer",visible:true,closable:true,footer:this._initFooterModal()});this.listenTo(this.modal,"onHide",this._onHideHandlerModal.bind(this))},_onHideHandlerModal:function(){var X=this;var W;if(this.service==="3DPrint"){if(this.cart.isDirectPurchase()&&!(this.isPaymentSent)){W=f.STATUS.draft}else{if((this.currentPage===this.idxPages.iframe)&&(this.cart.getState()!==f.STATUS.submitted)){W=f.STATUS.submitted}}}if(W){this.cart.updateState(W).then(function(){J.unmask(X.modal.getBody());X.modal.destroy()})["catch"](function(){J.unmask(X.modal.getBody());X._displayAlertMessage("error",V.get("errorTryLater"))})}else{this.modal.destroy()}},_initFooterModal:function(){this.nextButton=new O({value:this.labelNextButton[this.currentPage],className:"primary",disabled:true,events:{onClick:this._nextButtonHandler.bind(this)}});this.cancelButton=new O({value:V.get("cancel"),events:{onClick:this._cancelButtonHandler.bind(this)}});return[this.nextButton,this.cancelButton]},_cancelButtonHandler:function(){var W;var X=this.pages[this.idxPages.checkoutPage1];if(I.is(X)){W=X.sections[X.idxSections.BillingInformationSection]}if(this.currentPage===this.idxPages.checkoutPage1&&W.commands[1].isOn()){W.cancelAddAddress();W.commands[1].setOff()}else{this.modal.hide()}},_nextButtonHandler:function(){var X=this;var W;J.mask(this.modal.getBody());this.stateMachine.changeState(m.SAVING_PAGE);return this.pages[this.currentPage].save().then(function(){if(!I.is(X.pages[X.idxPages.checkoutPage1])&&X.currentPage===X.idxPages.billingInformationPage){X._getResourcesCheckoutPage().then(function(){X._initCheckoutPage();X.stateMachine.changeState(m.PAGE_DISPLAYED);X.displayNextPage()})}else{X.stateMachine.changeState(m.PAGE_DISPLAYED);X.displayNextPage()}})["catch"](function(Z){var Y;J.unmask(X.modal.getBody());if(!(v.prototype.isPrototypeOf(Z))){Y=typeof Z==="string"?Z:"";if(I.is(V["error"+Y])){W=V.get("error"+Y)}else{W=V.get("error")}X._displayAlertMessage("error",W)}})},_getResourcesCheckoutPage:function(){this.buyerType=this.pages[this.idxPages.billingInformationPage].buyerType;this.buyer=this.pages[this.idxPages.billingInformationPage].buyer;this.addresses=this.pages[this.idxPages.billingInformationPage].addresses;this.tokenCards=this.paymentCardTokenFactory.createCollection("me");return this.tokenCards.fetchPromise()},_displayAlertMessage:function(Z,X){var Y=this;var W;W=this.alert.getMessages();if(W.length>0){W.forEach(function(aa){Y.alert.remove(aa)})}this.alert.add({className:Z,message:X})},_isCartPaymentUrlAvailable:function(){return I.is(this.cart.getPaymentUrl())&&(this.cart.getState()===f.STATUS.paymentInitiated||this.cart.getState()===f.STATUS.paymentRefused)},_createStateMachine:function(){var W;W=this._isCartPaymentUrlAvailable()?m.IFRAME_DISPLAYED:m.PAGE_DISPLAYED;return new o({state:W,states:[m.PAGE_DISPLAYED,m.IFRAME_DISPLAYED,m.SAVING_PAGE],transitions:[{from:m.PAGE_DISPLAYED,to:m.SAVING_PAGE},{from:m.SAVING_PAGE,to:m.PAGE_DISPLAYED},{from:m.SAVING_PAGE,to:m.IFRAME_DISPLAYED},{from:m.IFRAME_DISPLAYED,to:m.SAVING_PAGE}]})},_checkPrototypes:function(W){K.requiredOfPrototype(W.buyerType,q,"options.buyerType must be a BuyerType");K.requiredOfPrototype(W.me,p,"options.me must be a PersonModel");K.requiredOfPrototype(W.cart,f,"options.cart must be a CartModel");K.requiredOfPrototype(W.cartQuote,C,"options.cartQuote must be a CartQuoteModel");K.requiredOfPrototype(W.cartFactory,z,"options.cartFactory must be a CartFactory");K.requiredOfPrototype(W.cartItemFactory,e,"options.cartItemFactory must be a CartItemFactory");K.requiredOfPrototype(W.addresses,G,"options.addresses must be an AddressCollection");K.requiredOfPrototype(W.addressFactory,F,"options.addressFactory must be an AddressFactory");K.requiredOfPrototype(W.tcContractFactory,M,"options.tcContractFactory must be a TCContractFactory");K.requiredOfPrototype(W.tokenCards,A,"options.tokenCards must be a PaymentCardTokenCollection");K.requiredOfPrototype(W.paymentCardTokenFactory,l,"options.paymentCardTokenFactory must be a PaymentCardTokenFactory");K.requiredOfPrototype(W.virtualIbanFactory,d,"options.virtualIbanFactory must be a VirtualIbanFactory");K.requiredOfPrototype(W.countries,Q,"options.countries must be a CountryCollection");K.requiredOfPrototype(W.purchaseOrderModel,T,"options.purchaseOrderModel must be a PurchaseOrderModel");K.requiredOfPrototype(W.cartPsp,h,"options.cartPsp must be a PspModel");if(W.service==="3DStore"){K.requiredOfPrototype(W.offers,H,"options.offers must be a SoftwareProductCollection");K.requiredOfPrototype(W.softwareAgreement,r,"options.softwareAgreement must be a SoftwareAgreementModel");K.requiredOfPrototype(W.onlineServiceAgreement,r,"options.onlineServiceAgreement must be a SoftwareAgreementModel");this.offers=W.offers;this.softwareAgreement=W.softwareAgreement;this.onlineServiceAgreement=W.onlineServiceAgreement;this.productName=this.offers.product==="PGB"?V.get("PGB"):W.productName}else{if(W.service==="3DPrint"){K.requiredOfPrototype(W.shopModel,s,"options.shopModel must be a ShopModel");K.requiredOfPrototype(W.tcDocumentFactory,D,"options.tcDocumentFactory must be a TCDocumentFactory");K.requiredOfPrototype(W.companyFactory,j,"options.companyFactory must be a CompanyFactory");K.requiredOfPrototype(W.purchaseOrderDocument,B,"options.purchaseOrderDocument must be a PurchaseOrderDocumentModel");this.shopModel=W.shopModel;this.tcDocumentFactory=W.tcDocumentFactory;this.companyFactory=W.companyFactory;this.purchaseOrderDocument=W.purchaseOrderDocument}}if(I.equals(W.buyerType,q.COMPANY)){K.requiredOfPrototype(W.company,b,"options.company must be a CompanyModel")}}});L.renderError=function(W){var X;X=new g({className:"mpf-configurator-offer",visible:true,closable:true,header:{tag:"h4",text:V.get("errorLoading")},body:V.get("noContent")});X.inject(W);return X};L.noOfferAvailable=function(W,Y){var X;X=new g({className:"mpf-configurator-offer mpf-configurator-nooffer",visible:true,closable:true,header:{tag:"h4",text:Y},body:V.get("noOffer")});X.inject(W);return X};L.onLoad=function(W,X){var Y;var Z=I.is(X)?X:V.get("loading");Y=new g({className:"mpf-configurator-offer mpf-configurator-loading",visible:true,closable:false,header:{tag:"h4",text:Z}});Y.inject(W);J.mask(Y.getBody());return Y};L.displayIbanPaymentRecap=function(W){var X;X=new g({className:"mpf-configurator-offer",visible:true,closable:true,header:{tag:"h4",text:V.get("checkoutTitle2")},body:new c({cart:W.cart,virtualIban:W.virtualIban,buyerType:W.buyerType,cartPaid:true}).render()});X.setFooter([new O({value:V.get("alreadyPaid"),className:"primary",disabled:true}),new O({value:V.get("close"),events:{onClick:X.destroy.bind(X)}})]);X.inject(W.container);return X};return L});define("DS/MPFModalConfiguratorComponent/CheckoutLauncherFactory",["UWA/Core","UWA/Class","UWA/Promise","UWA/Utils","UWA/Class/Listener","UWA/Class/Events","DS/MPFDataProxy/AppsConnector","DS/MPFDataProxy/MarketplaceConnector","DS/MPFServices/MarketplaceServices","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFModalConfiguratorComponent/ModalConfiguratorComponent","DS/MPFModelFactory/CartQuoteFactory","DS/MPFModelFactory/PurchaseOrderFactory","DS/MPFModelFactory/PurchaseOrderDocumentFactory","DS/MPFCartModel/CartModel","DS/MPFShopModel/ShopModel","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/MePersonDataProxy","DS/MPFPspModel/PspModel","DS/MPFAppsPlatform/PublicPlatformsDataProxy","DS/MPFAppsPlatform/PlatformCollection","DS/MPFAppsPlatform/ServiceEnum"],function(r,v,g,i,h,o,u,t,e,p,m,f,c,j,w,l,n,q,s,a,x,b){var d={};d.PRINT="3DPrint";var k=v.extend(h,o,{init:function(y){y=(y||{});this.serviceRequest=r.is(y.serviceRequest)?y.serviceRequest:e.MAKE;this.service=y.service;this.container=(y.container||document.body);this.deferred=g.deferred();this.promise=this.deferred.promise;if(this.service===e.MAKE||this.service===d.PRINT){this.idCart=y.idCart}if(this.service===e.STORE){this.platform=y.platform;this.product=y.product;this.productName=y.productName;this.periodicitiesAlreadyPurchased=y.periodicitiesAlreadyPurchased}},whenReady:function(){this._fetchResources(this.deferred);return this.promise},show:function(){this.modal.render(this.container);this.deferred=g.deferred();this.promise=this.deferred.promise},_initFactories:function(y){var z=this;this.factoryDispenser=p.getInstance(y);return g.all([this.factoryDispenser.getFactory(p.Types.CART),this.factoryDispenser.getFactory(p.Types.CART_ITEM),this.factoryDispenser.getFactory(p.Types.CART_QUOTE),this.factoryDispenser.getFactory(p.Types.PERSON),this.factoryDispenser.getFactory(p.Types.COUNTRY),this.factoryDispenser.getFactory(p.Types.PAYMENT_CARD_TOKEN),this.factoryDispenser.getFactory(p.Types.TC_CONTRACT),this.factoryDispenser.getFactory(p.Types.TC_DOCUMENT),this.factoryDispenser.getFactory(p.Types.SHOP),this.factoryDispenser.getFactory(p.Types.VIRTUAL_IBAN),this.factoryDispenser.getFactory(p.Types.PURCHASE_ORDER),this.factoryDispenser.getFactory(p.Types.PURCHASE_ORDER_DOCUMENT),this.factoryDispenser.getFactory(p.Types.SOFTWARE_PRODUCT),this.factoryDispenser.getFactory(p.Types.SOFTWARE_AGREEMENT),this.factoryDispenser.getFactory(p.Types.PSP),this.factoryDispenser.getFactory(p.Types.COMPANY),this.factoryDispenser.getFactory(p.Types.ADDRESS)]).then(function(A){z.cartFactory=A[0];z.cartItemFactory=A[1];z.cartQuoteFactory=A[2];z.personFactory=A[3];z.countryFactory=A[4];z.paymentCardTokenFactory=A[5];z.tcContractFactory=A[6];z.tcDocumentFactory=A[7];z.shopFactory=A[8];z.virtualIbanFactory=A[9];z.purchaseOrderFactory=A[10];z.purchaseOrderDocumentFactory=A[11];z.softwareProductFactory=A[12];z.softwareAgreementFactory=A[13];z.pspFactory=A[14];z.companyFactory=A[15];z.addressFactory=A[16];z.companyFactory.addressFactory=z.addressFactory;return z.addressFactory.whenReady()})["catch"](function(){return g.reject("error init factories")})},_initModal:function(y){this.onLoadModal.destroy();this.modal=new m(this._getOptions());if(this.service==="3DPrint"){this.listenTo(this.modal,"paymentCompleted",function(){this.dispatchEvent("paymentCompleted")});this.listenTo(this.modal,"paymentDeclined",function(){this.dispatchEvent("paymentDeclined")})}y.resolve()},_getOptions:function(){var y={};y.locale=i.Client.Locale.lang;y.serviceRequest=this.serviceRequest;y.service=this.service;y.me=this.me;y.cart=this.cart;y.cartQuote=this.cartQuote;y.cartFactory=this.cartFactory;y.cartItemFactory=this.cartItemFactory;y.company=this.company;y.addresses=this.addresses;y.addressFactory=this.addressFactory;y.buyerType=this.buyerType;y.countries=this.countries;y.tokenCards=this.tokenCards;y.purchaseOrderModel=this.purchaseOrderModel;y.virtualIbanFactory=this.virtualIbanFactory;y.paymentCardTokenFactory=this.paymentCardTokenFactory;y.tcContractFactory=this.tcContractFactory;y.bankTransferActive=this._isBankTranferActive();if(this.service===e.MAKE||this.service===d.PRINT){y.shopModel=this.shopModel;y.companyFactory=this.companyFactory;y.tcDocumentFactory=this.tcDocumentFactory;y.purchaseOrderDocument=this.purchaseOrderDocument;y.cartPsp=this.cartPsp}if(this.service===e.STORE){y.platform=this.platform;y.offers=this.offers;y.productName=this.productName;y.softwareAgreement=this.softwareAgreement;y.onlineServiceAgreement=this.onlineServiceAgreement;y.periodicitiesAlreadyPurchased=this.periodicitiesAlreadyPurchased;y.cartPsp=this.pspFactory.createModel("cartPsp")}return y},_fetchResources:function(y){var z=this;this._getConnector().then(function(A){z.onLoadModal=m.onLoad(z.container,z.productName);return z._initFactories(A)}).then(function(){z.me=z.personFactory.createModel("me");z.countries=z.countryFactory.createCollection("buyer");z.cartQuote=z.cartQuoteFactory.createModel(f.Types.CART_QUOTE);z.purchaseOrderModel=z.purchaseOrderFactory.createModel(c.Types.CART_PURCHASE_ORDER);if(z.service===e.MAKE||z.service===d.PRINT){return z._getPrintResources(y)}if(z.service===e.STORE){return z._getStoreResources(y)}})["catch"](function(A){z._manageError(A,y)})},_getStoreResources:function(y){var z=this;var A={};this.offers=this.softwareProductFactory.createCollection();this.offers.onlineInstanceId=this.platform;this.offers.product=this.product;this.cart=this.cartFactory.createModel("me",{onlineInstance:this.platform});this.tokenCards=this.paymentCardTokenFactory.createCollection("me");this.softwareAgreement=this.softwareAgreementFactory.createModel();this.onlineServiceAgreement=this.softwareAgreementFactory.createModel("byLanguage");A[q.Params.ALLOW_CREATION]=true;return this.me.fetchPromise(A).then(function(){return g.all([z.offers.fetchPromise(),z.countries.fetchPromise(),z.me.fetchPromise()])}).then(function(){return g.all([z._getCompany(),z._getTokenPaymentCards()])}).then(function(){z.addresses=z.company.addresses}).then(z._initModal.bind(z,y))},_getCompany:function(){var y;var z;if(this.service===e.STORE&&this.offers.size()===0){return g.reject("noOffer")}else{this.buyerType=n.COMPANY;if(this.service===e.STORE){y=this.offers.first().get("companyID")}if(this.service===e.MAKE||this.service===d.PRINT){z=this.me.getCompany();y=z.match(/\/([0-9A-F]{32})$/)[1]}this.company=this.companyFactory.createModel("company",{id:y});return this.company.fetchPromise()}},_getTokenPaymentCards:function(){this.tokenCards=this.paymentCardTokenFactory.createCollection("me");return this.tokenCards.fetchPromise()},_getPrintResources:function(y){var z=this;this.cart=this.cartFactory.createModel("cart",{id:this.idCart});this.cartQuote.parentResourceId=this.idCart;this.purchaseOrderModel.parentResourceId=this.idCart;this.purchaseOrderDocument=this.purchaseOrderDocumentFactory.createModel(j.Types.CART_PURCHASE_ORDER_DOCUMENT);this.purchaseOrderDocument.parentResourceId=this.idCart;return g.all([this.countries.fetchPromise(),this.me.fetchPromise(),this.cart.fetchPromise({expand:[w.Expands.CART_ITEMS]})]).then(z._getCartPSP.bind(z)).then(z._fetchBuyerAddressesTokenCardsAndShop.bind(z)).then(z._initModal.bind(z,y))},_getCartPSP:function(){this.cartPsp=this.pspFactory.createModel("cartPsp");this.cartPsp.setParentResourceId(this.idCart);return this.cartPsp.fetchPromise()},_fetchBuyerAddressesTokenCardsAndShop:function(){var y=this;var z;z=this.me.getCompany();this.shopModel=this.shopFactory.createModel("shop",{id:this.cart.getShopId()});if(r.is(z)){return g.all([this._getCompany(),this._getTokenPaymentCards(),this.shopModel.fetchPromise({expand:[l.Expands.SHOP_SERVICES]})]).then(function(){y.addresses=y.company.addresses})}else{this.buyerType=n.INDIVIDUAL;this.addresses=this.addressFactory.createCollection("me");if(this.me.get("buyerType")==="none"){this.tokenCards=this.paymentCardTokenFactory.createCollection("me");return this.shopModel.fetchPromise({expand:[l.Expands.SHOP_SERVICES]})}else{return g.all([this._getTokenPaymentCards(),this.addresses.fetchPromise(),this.shopModel.fetchPromise({expand:[l.Expands.SHOP_SERVICES]})])}}},_manageError:function(z,y){this.onLoadModal.destroy();if(z==="noOffer"){m.noOfferAvailable(this.container,this.productName)}else{m.renderError(this.container)}y.reject()},_isBankTranferActive:function(){var y=false;if(this.service===e.MAKE||this.service===d.PRINT){y=true}return y},_getConnector:function(){if(this.service===e.MAKE||this.service===d.PRINT){return t.fetchPromise({service:this.serviceRequest})}if(this.service===e.STORE){return this._getMy3DExpConnector()}},_getMy3DExpConnector:function(){var C;var z;var B;var y;C=window.location.origin.replace("-ifwe","-apps");z=new u(C+"/enovia/resources/AppsMngt");B=new a(z);y=new x([],{dataProxy:B});function A(E){return E.services.get(b.MARKETPLACE.name)}function D(E){return E.filter(A).pop()}return y.fetchPromise().then(D).then(function(F){var E;var G;var H;E=F.services.get(b.MARKETPLACE.name);H=E.getUrl();H+="/resources";G=new t(H,F.id,{service:e.STORE});return G})}});return k});define("DS/MPFModalConfiguratorComponent/ModaleCheckoutPrintWrapper",["UWA/Core","UWA/Class","UWA/Promise","UWA/Class/Listener","UWA/Class/Events","DS/MPFDataProxy/MarketplaceConnector","DS/MPFModalConfiguratorComponent/ModalConfiguratorComponent","DS/MPFModalConfiguratorComponent/CheckoutLauncherFactory","DS/MPFModelFactory/MPFFactories","DS/MPFBuyer/BuyerType","DS/MPFTCContractModel/TCContractModel","DS/MPFCartModel/CartModel","DS/MPFModelFactory/CartQuoteFactory","DS/MPFModelFactory/PurchaseOrderFactory","DS/MPFModelFactory/PurchaseOrderDocumentFactory"],function(l,m,i,o,p,d,k,n,f,b,h,e,g,a,c){var j=m.extend(o,p,{init:function(q){q=(q||{});this.container=(q.container||document.body);this.deferred=i.deferred();this.promise=this.deferred.promise;this.idCart=q.idCart},openModal:function(){this.checkout.show()},whenReady:function(){this.checkout=new n({service:"3DPrint",container:this.container,idCart:this.idCart});this.listenTo(this.checkout,"paymentCompleted",function(){this.dispatchEvent("paymentCompleted")});this.listenTo(this.checkout,"paymentDeclined",function(){this.dispatchEvent("paymentDeclined")});return this.checkout.whenReady()}});return j});define("DS/MPFModalConfiguratorComponent/ModaleConfiguratorWrapper",["UWA/Core","UWA/Class","DS/MPFDataProxy/MarketplaceConnector","DS/MPFModelFactory/MPFFactories","DS/MPFDataProxy/AppsConnector","DS/MPFAppsPlatform/PublicPlatformsDataProxy","DS/MPFAppsPlatform/PlatformCollection","DS/MPFAppsPlatform/ServiceEnum","DS/MPFModalConfiguratorComponent/CheckoutLauncherFactory","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(g,i,c,d,e,a,b,j,h,k){var f=i.extend({init:function(l){l=(l||{});this.platform=l.platform;this.product=l.product;this.productName=l.productName;this.container=(l.container||document.body)},isActivated:function(){return true},openModal:function(){this.checkout.show()},whenReady:function(){var l=this;return this._isItFirstPurchase().then(function(m){l.checkout=new h({service:"3DStore",platform:l.platform,product:l.product,productName:l.productName,container:l.container,firstPurchase:m});return l.checkout.whenReady()})},_isItFirstPurchase:function(){var l=this;var n;var m;return this._fetchMarketplaceConnector().then(function(o){try{d.init(o)}catch(p){console.warn(p)}l.catalogueFactory=d.getFactory(d.types.catalogue);l.catalogue=l.catalogueFactory.createModel("catalogue",{});l.catalogue.onlineInstanceId=l.platform;return l.catalogue.fetchPromise()}).then(function(){n=l.catalogue.getProducts();m=!n.some(function(o){return o.getProductTrigram()===l.product});return m})},_fetchMarketplaceConnector:function(){var p;var m;var o;var l;p=window.location.origin.replace("-ifwe","-apps");m=new e(p+"/enovia/resources/AppsMngt");o=new a(m);l=new b([],{dataProxy:o});function n(r){return r.services.get(j.MARKETPLACE.name)}function q(r){return r.filter(n).pop()}return l.fetchPromise().then(q).then(function(s){var r;var t;var u;r=s.services.get(j.MARKETPLACE.name);u=r.getUrl();u+="/resources";t=new c(u,s.id,{service:"3DStore"});return t})}});return f});