define("DS/ENOFilterBIUX_Fetch/Fetch_FBIComponentProxy",["UWA/Core","UWA/Controls/Abstract","UWA/Class/Events","DS/Windows/Dialog","DS/Windows/ImmersiveFrame","DS/Controls/Button","DS/Controls/Toggle","DS/TagNavigatorProxy/TagNavigatorProxy","DS/ENOFilterBIUX/Abstract_FBIComponentProxy","DS/ENOFilterBIUX/BIEngine","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/FBISettings","DS/ENOFilterBIUX/FBIProxyServices","DS/ENOFilterBIUX/NGFServices","UWA/Promise","DS/PlatformAPI/PlatformAPI","i18n!DS/ENOFilterBIUX/assets/nls/ENOFilterBIUX"],function(n,o,g,d,i,j,q,h,p,m,f,c,l,k,b,a,e){var r=p.extend({init:function(s){this._parent(s)},_setDataModel:function(s){this._summary=(this._volatileTags?this._volatileTags.concat(s.summary):s.summary);this._odtSummary=(this._volatileTags?this._volatileTags.concat(s.summary):s.summary);this._grouped=s.grouped},setPathTags:function(s,x){var y=this,u=[];this._nodesIN=s.nodes;this._tree=[];this._nodesForCustoBI=s.nodes;if(this._allNodes&&(this._allNodes.length<s.nodes.length)){for(var w=0;w<s.nodes.length;w++){if(this._allNodes.indexOf(s.nodes[w])<=-1){this._allNodes.push(s.nodes[w])}}}else{if(!this._allNodes||(this._allNodes&&0===this._allNodes.length)){this._allNodes=s.nodes}}u=f.convertFromIndexToPID(s.nodes,s.paths);for(var t=0;t<s.paths.length;t++){this._tree.push({id:u[t],path:s.paths[t]});if(this._unFilteredPathIDs.indexOf(u[t])<0){this._unFilteredPathIDs.push(u[t])}}var v=f.convertFromPIDToIndexAsync(this._allNodes,this._unFilteredPathIDs,this,function(B){this._unfilteredTree=[];for(var z=0;z<B.length;z++){this._unfilteredTree.push({id:this._unFilteredPathIDs[z],path:B[z]})}if(s.nodes.length){f._setTree(y._tree);f._setNodes(s.nodes);y.checkBeforeFetch(s.nodes).then(function(C){if(C){y.launchFetch(y._predicates,s.nodes,y._tree).then(function(D){D.summary=(y._volatileTags?y._volatileTags.concat(D.summary):D.summary);y.setTags(null,D.summary);if(x){x()}},function(D){console.log("RCIIIIIIIIIIII erreur dans setpathtags")})}})}else{var A={summary:[],suggested:[]};y._setDataModel(A);y.setTags(null,A.summary);if(x){x()}}})},onApplyNGFilter:function(t){var s=this.optionsToKeep.appId;if(t.appId!==s){console.log("debug RCI , currentAppId = "+s+" , widget NG Filter = "+t.appId)}else{if(t.CVQuery){if(t.empty){this._cleanRootsInSession(t.filterRootIds)}else{this._keepRootsInSession(t.filterRootIds);t=this.completeCVQueryWithAppParams(t,this._expandIterParam,this._expandSynthesisON)}this._currentNGFilter=t.CVQuery;console.log(t);this.dispatchEvent("ApplyNGFilterAbstract",t)}}},_filtering:function(t,s,x){if(Object.keys(s).length){if(this._grouped){t=this._filterPredicatesAndTags(s);x.filteredSubjectList=this._computeFilters(t,s);x.filteredPathIDList=f.convertFromIndexToPID(this._allNodes,x.filteredSubjectList)}else{x.nodes=this._allNodes;x.filteredSubjectList=[];x.filteredPathIDList=[]}}else{x.nodes=this._allNodes;x.filteredSubjectList=f.convertFromPIDToIndex(this._allNodes,this._unFilteredPathIDs);x.filteredPathIDList=this._unFilteredPathIDs}x.nodes=this._allNodes;this._filteredData.nodes=x.nodes;this._filteredData.paths=x.filteredSubjectList;var A=false,u=[],z;if(x.filteredPathIDList&&x.filteredPathIDList.length){for(var v=0;v<x.filteredPathIDList.length;v++){var C=f.splitListOfPID(x.filteredPathIDList[v]);for(var y=0;y<C.length;y++){z=false;for(var B=0;B<u.length;B++){if(n.equals(C[y],u[B])){z=true}}if(false===z||0===u.length){u.push(C[y])}}}}if(this._nodesIN.length){if(u.length===this._nodesIN.length){for(var w=0;w<this._nodesIN.length;w++){var D=false;for(var E=0;E<x.nodes.length;E++){if(u[E]===this._nodesIN[w]){D=true;break}}if(false===D){A=true;break}}}else{A=true}}else{if(u.length){A=true}}if(A){this.dispatchEvent("FilterBIFilteringEvent",x)}else{if(this.myTagProxy){this.myTagProxy.filters=this.myTagProxy.getCurrentFilter()}if(this.myTagProxy.filters){this._filterBIToKeep=this.myTagProxy.filters}this.myTagProxy.setTags(null,this._summary)}},displayWarningPanel:function(){var s=this;var t=new i();t.inject(document.body);return new b(function(y,x){if(sessionStorage.getItem("FBI_toggleWarningHugeStructure")){y(sessionStorage.getItem("FBI_choiceWarningOK"));return}var v=n.createElement("div",{html:"<p>"+e.get("hugeNumberodfObjects")+"<br><br>"+e.get("validProceedforFetch")+"<br></p>"});var u=new WUXToggle({label:e.get("DoNotAskAgain"),checkFlag:false});u.inject(v);u.addEventListener("buttonclick",function(z){if(sessionStorage.getItem("FBI_toggleWarningHugeStructure")){sessionStorage.removeItem("FBI_toggleWarningHugeStructure")}else{sessionStorage.setItem("FBI_toggleWarningHugeStructure",true)}});var w=new d({title:"Warning",content:v,immersiveFrame:t,buttons:{Ok:new j({emphasize:"primary",onClick:function(B){var z=B.dsModel;var A=z.dialog;A.close();sessionStorage.setItem("FBI_choiceWarningOK",true);y(true)}}),Cancel:new j({onClick:function(B){var z=B.dsModel;var A=z.dialog;A.close();s.myTagProxy.setTags(null,null);sessionStorage.setItem("FBI_choiceWarningOK",false);y(false)}})}});w.inject(document.body)})},checkBeforeFetch:function(t){var u=c.getOption("ENO_FBI_NB_PAGERESULT");var x=this,w=true,s=t.length/u,v=Number.isInteger(s)?s:parseInt(s)+1;return new b(function(y){if(v>1){w=false;x.displayWarningPanel().then(function(z){w=z;y(w)})}else{y(w)}})},launchFetch:function(t,u,s){var v=this;return new b(function(x,w){f.fetch(t,u,s).then(function(y){if(!y){y={summary:[],suggested:[]}}if(y.response){v._setDataModel(y)}x(y)},function(y){w(y)})})},filterBIFilter:function(v,t){var y=this,z=v.allfilters,w=t||null;var A=this.checkVolatileTags(z);if(A.isVolatileTag){if(this._filterBIToKeep&&this._filterBIToKeep.filteredPathIDList){v.previousFilteredIds=this._filterBIToKeep.filteredPathIDList}else{if(this._filterBIToKeep){}}v.predicateName=A.predicateName;this._currentlyDispatchingAVolatileFilterEvent=true;this.dispatchEvent("FilterVolatileEvent",v);this.isCurrentVolatile=A.isVolatileTag;return}v.volatileFilters=n.clone(v.allfilters,"false");for(var s in v.allfilters){if(v.allfilters.hasOwnProperty(s)){if(this._keepVolatileTags.indexOf(s)!==-1){delete v.allfilters[s]}}}this._filteredData={};var x=false,u=false;if(this._filterBIToKeep&&this._filterBIToKeep.allfilters){if(Object.keys(z).length&&(Object.keys(z).length<Object.keys(this._filterBIToKeep.allfilters).length)){x=true}if(0===Object.keys(z).length&&Object.keys(this._filterBIToKeep.allfilters).length){u=true}}if((x||u)&&0!==this._unfilteredTree.length){f._groupedData={};this.checkBeforeFetch(this._allNodes).then(function(B){if(B){y.launchFetch(y._predicates,y._allNodes,y._unfilteredTree).then(function(C){y.manageFiltering(v)},function(C){})}})}else{this.manageFiltering(v)}},manageFiltering:function(u){var t=this,s=u.allfilters;var v={};this._isFetchCustoDone=false;this._filtering(v,s,u)},_filterPredicatesAndTags:function(u){var w={},x=[],t=false,C,D;for(var s in u){if(u.hasOwnProperty(s)){x=u[s];if(s.indexOf("sixw")===0){s=s.substring(5);t=true}var A=this.checkBIRuleFiltering(s);if(!A){w[s]={}}for(var z=0;z<x.length;z++){if(t){C=this._getMatchingAttribute(s,x[z]);if(C.length){for(var y=0;y<C.length;y++){w[s][C[y].key]=C[y].value}}}else{if(x[z].type==="date"){D=this._grouped[s];for(var v in D){if(D.hasOwnProperty(v)){if(v.indexOf(x[z].object)!==-1){w[s][v]=D[v]}}}}else{if(this._grouped&&this._grouped[s]){if(Array.isArray(x[z].object)){var B=f._buildValueForHierarchicalTags(x[z].object);w[s][x[z].object]=this._predicatesToKeepForHierarchicalTags(s,B)}else{if(this._grouped[s][x[z].object]){w[s][x[z].object]=this._grouped[s][x[z].object]}}}}}}t=false}}return w},_predicatesToKeepForHierarchicalTags:function(v,w){var s={};for(var u in this._grouped){if(v===u&&this._grouped.hasOwnProperty(u)){for(var t in this._grouped[u]){if(this._grouped[u].hasOwnProperty(t)){if(t.contains(w)){n.extend(s,this._grouped[v][t])}}}}}return s},_getMatchingAttribute:function(s,t){var u=[];for(var v in this._grouped[s]){if(this._grouped[s].hasOwnProperty(v)){if(this._valuesMatch(v,t)){u.push({key:v,value:this._grouped[s][v]})}}}return u},_valuesMatch:function(u,t){var s=false;switch(t.type){case"string":s=this._valuesMatchString(u,t.object);break;case"date":s=this._valuesMatchDate(u,t.object);break}return s},_valuesMatchString:function(t,s){return(t.indexOf(s)>=0)},_valuesMatchDate:function(v,u){var s=false,t=new Date(v),w=u.from||u.to;w=new Date(w);if(u.from){s=(t>w)}else{if(u.to){s=(t<w)}}return s},_computeFilters:function(y,w){var x=[],u=[];for(var t in y){if(y.hasOwnProperty(t)){for(var s in y[t]){if(y[t].hasOwnProperty(s)){for(var v in y[t][s]){if(y[t][s].hasOwnProperty(v)&&n.is(y[t][s][v],"object")){if(this._applyFilter(v,y,w)){u.push(y[t][s][v].pathID)}}}}}}}if(u.length){x=f.convertFromPIDToIndex(this._allNodes,u)}return x},_applyFilter:function(v,w,u){var x=true;for(var t in u){if(u.hasOwnProperty(t)){x=false;for(var s in w[t]){if(w[t].hasOwnProperty(s)){if(w[t][s][v]){x=true}}}}if(false===x){return x}}return x},filterBIColorize:function(v){if(v.tagColors&&v.tagColors.length>0){var s=false;for(var w=0;w<this._keepVolatileTags.length;w++){if(v.tagColors[0].predicate.contains(this._keepVolatileTags[w])){s=true;v.predicateName=this._keepVolatileTags[w];break}}if(s){this.dispatchEvent("ColorizeVolatileEvent",v);return}}this._colorizedData={};if(this._tree.length){var y=this;var A=this._grouped,C=v.tagColors,z=[];for(var u=0;u<C.length;u++){var D=[];var B=f.findColoredPaths(A,C[u]);for(var t in B){if(B.hasOwnProperty(t)){if(n.is(B[t],"object")){D.push(B[t].pathID)}}}var x=f.convertFromPIDToIndex(y._allNodes,D);for(var E in x){if(x.hasOwnProperty(E)){z.push({path:x[E],color:C[u].color})}}v.coloredSubjects=z;v.nodes=this._allNodes;this._colorizedData.nodes=v.nodes;this._colorizedData.coloredSubjects=v.coloredSubjects;this.dispatchEvent("FilterBIColorizeEvent",v)}}else{this.dispatchEvent("FilterBIColorizeEvent",v)}},_parseRules:function(){var s=new m();s.getBIRules();return s},_computeRules:function(t,s){this._biEngine.computeBIRule(this._grouped,t,this._allNodes,s)},checkCustoBITagInFilter:function(u){var s={};s.custoTag=false;for(var t in u){if(u.hasOwnProperty(t)){var v=this.checkIsCustoBIRule(t);if(v){s.pred=t;s.custoTag=true;return s}}}return s},checkBIRuleFiltering:function(t){var s=false;var v=this;var u=t;if(t.indexOf("/")>=0){u=t.slice(t.indexOf("/")+1,t.length)}if(v._biEngine&&v._biEngine._biPredCriteriaMatchingBIPredLabel[u]&&"NoCriteria"===v._biEngine._biPredCriteriaMatchingBIPredLabel[u][0]){s=true}return s},});return r});