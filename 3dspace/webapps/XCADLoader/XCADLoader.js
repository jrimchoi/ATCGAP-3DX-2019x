define("DS/XCADLoader/XCADGeomLoader",["DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS","DS/XCADInputDocuments/XCADInputDocument","DS/XCADInputDocuments/XCADRepresentation","DS/XCADInputDocuments/XCADTessellatedRepresentation"],function(f,d,c,e,b){var a=function(){this.DEFAULT_COLOR=new f.Color(0.825,0.825,1);d.EventDispatcher.call(this);this.currentObject=new f.PrimitiveGroup();this.posBuffer=new f.Buffer();this.normBuffer=new f.Buffer();this.posIdxBuffer=new f.Buffer();this.normIdxBuffer=new f.Buffer();this.meshNb=0};a.prototype={constructor:a,load:function(g,h){this.geomRepresentation=g;this.progressCB=h;this.currentObject.fillAttr=new f.FillAttributes();this.currentObject.lineAttr=new f.LineAttributes();this.currentObject.PointAttr=new f.PointAttributes();this.meshNb=0;switch(this.geomRepresentation.getRepresentationType()){case e.XCAD_TESSELLATED_REPRESENTATION:this.processTessRep();break;default:break}return this.currentObject},startNewMesh:function(g){this.posBuffer=new f.Buffer();this.posBuffer.component=f.VertexComponentEnum.POSITION;this.posBuffer.format=f.DataTypeEnum.FLOAT;this.posBuffer.dimension=3;this.normBuffer=new f.Buffer();this.normBuffer.component=f.VertexComponentEnum.NORMAL;this.normBuffer.format=f.DataTypeEnum.FLOAT;this.normBuffer.dimension=3;this.currentObject.addBuffer(4*this.meshNb,this.posBuffer);this.currentObject.addBuffer(4*this.meshNb+1,this.normBuffer);if(!this.geomRepresentation.isIndexed||this.geomRepresentation.isIndexed()){this.posIdxBuffer=new f.Buffer();this.posIdxBuffer.indexBuffer=true;this.posIdxBuffer.format=f.DataTypeEnum.UINT;this.posIdxBuffer.dimension=1;this.normIdxBuffer=new f.Buffer();this.normIdxBuffer.indexBuffer=true;this.normIdxBuffer.format=f.DataTypeEnum.UINT;this.normIdxBuffer.dimension=1;this.currentObject.addBuffer(4*this.meshNb+2,this.posIdxBuffer);this.currentObject.addBuffer(4*this.meshNb+3,this.normIdxBuffer)}},finishCurrentMesh:function(){this.meshNb++},processTessRep:function(){var j=this.geomRepresentation.getRootNodesCount();for(var h=0;h<j;h++){if(this.progressCB){this.progressCB({loaded:h,total:j})}var i=this.geomRepresentation.getRootNode(h);var g=this.geomRepresentation.getNodeType(i);switch(g){case b.KindOfNode.NOD_ContainerNode:this.processTessContainer(i);break;case b.KindOfNode.NOD_SolidNode:this.processTessSolid(i);break}}},processTessContainer:function(k){var i=this.geomRepresentation.getChildCount(k);for(var j=0;j<i;j++){var g=this.geomRepresentation.getChild(k,j);var h=this.geomRepresentation.getNodeType(g);switch(h){case b.KindOfNode.NOD_ContainerNode:this.processTessContainer(g);break;case b.KindOfNode.NOD_SolidNode:this.processTessSolid(g);break}}},processTessSolid:function(m){var l=this.geomRepresentation.getNodeColor(m);var i=this.geomRepresentation.getChildCount(m);for(var k=0;k<i;k++){var n=this.geomRepresentation.getChild(m,k);var g=this.geomRepresentation.getNodeType(n);var h=this.geomRepresentation.getNodeColor(n);if(h===undefined){h=l}switch(g){case b.KindOfNode.NOD_GP:var j=this.geomRepresentation.getGPType(n);switch(j){case b.KindOfGP.GP_Face:this.processTriangulatedFace(n,new f.Color(h[0],h[1],h[2],h[3]));break}break}}},processTriangulatedFace:function(h,x){var v=this.geomRepresentation.getFaceData(h);this.startNewMesh(v);this.posBuffer.size=v.vertices.length;this.posBuffer.data=new Float32Array(this.posBuffer.size);this.posBuffer.data=v.vertices;this.normBuffer.size=v.normals.length;this.normBuffer.data=new Float32Array(this.normBuffer.size);this.normBuffer.data=v.normals;var t=0;for(var m=0;m<v.nbVertexPerStripTriangle.length;m++){t+=v.nbVertexPerStripTriangle[m]}for(var m=0;m<v.nbVertexPerFanTriangle.length;m++){t+=v.nbVertexPerFanTriangle[m]}t+=v.singleTrianglesIndices.length;this.posIdxBuffer.size=t;this.posIdxBuffer.data=new Uint16Array(this.posIdxBuffer.size);var n=true;this.normIdxBuffer.size=this.posIdxBuffer.size;this.normIdxBuffer.data=new Uint16Array(this.normIdxBuffer.size);var o=0,q=0;var l,s;var i=0;for(var m=0;m<v.nbVertexPerStripTriangle.length;m++){var j=v.nbVertexPerStripTriangle[m];var y=new f.Primitive();y.nbIndices=j;y.connectivity=f.ConnectivityTypeEnum.TRIANGLE_STRIP;y.attr={fill:new f.FillAttributes((x===undefined)?this.DEFAULT_COLOR:x),line:new f.LineAttributes(),point:new f.PointAttributes()};l=new f.VertexComponent();l.component=f.VertexComponentEnum.POSITION;l.nbVertices=j;l.nbValuesPerVertex=3;l.format=f.DataTypeEnum.FLOAT;l.cardinality=0;l.bufferId=4*this.meshNb;l.indices=new f.IndexArray();l.indices.format=f.DataTypeEnum.UINT;l.indices.bufferId=4*this.meshNb+2;l.indices.offset=o;if(n){s=new f.VertexComponent();s.component=f.VertexComponentEnum.NORMAL;s.nbVertices=j;s.nbValuesPerVertex=3;s.format=f.DataTypeEnum.FLOAT;s.cardinality=0;s.bufferId=4*this.meshNb+1;s.indices=new f.IndexArray();s.indices.format=f.DataTypeEnum.UINT;s.indices.bufferId=4*this.meshNb+3;s.indices.offset=q}for(var w=0;w<j;w++){var p=v.stripTrianglesIndices[i+w];this.posIdxBuffer.data[o++]=p;if(n){this.normIdxBuffer.data[q++]=p}}y.addVertexComponent(l);if(n){y.addVertexComponent(s)}if(y.nbVertexComponents>0){this.currentObject.addPrimitive(y)}i+=j}var k=0;for(var m=0;m<v.nbVertexPerFanTriangle.length;m++){var r=v.nbVertexPerFanTriangle[m];var y=new f.Primitive();y.nbIndices=r;y.connectivity=f.ConnectivityTypeEnum.TRIANGLE_FAN;y.attr={fill:new f.FillAttributes((x===undefined)?this.DEFAULT_COLOR:x),line:new f.LineAttributes(),point:new f.PointAttributes()};l=new f.VertexComponent();l.component=f.VertexComponentEnum.POSITION;l.nbVertices=r;l.nbValuesPerVertex=3;l.format=f.DataTypeEnum.FLOAT;l.cardinality=0;l.bufferId=4*this.meshNb;l.indices=new f.IndexArray();l.indices.format=f.DataTypeEnum.UINT;l.indices.bufferId=4*this.meshNb+2;l.indices.offset=o;if(n){s=new f.VertexComponent();s.component=f.VertexComponentEnum.NORMAL;s.nbVertices=r;s.nbValuesPerVertex=3;s.format=f.DataTypeEnum.FLOAT;s.cardinality=0;s.bufferId=4*this.meshNb+1;s.indices=new f.IndexArray();s.indices.format=f.DataTypeEnum.UINT;s.indices.bufferId=4*this.meshNb+3;s.indices.offset=q}for(var w=0;w<r;w++){var p=v.fanTrianglesIndices[k+w];this.posIdxBuffer.data[o++]=p;if(n){this.normIdxBuffer.data[q++]=p}}y.addVertexComponent(l);if(n){y.addVertexComponent(s)}if(y.nbVertexComponents>0){this.currentObject.addPrimitive(y)}k+=r}var u=0;for(var m=0;m<v.singleTrianglesIndices.length;m=m+3){var g=3;var y=new f.Primitive();y.nbIndices=g;y.connectivity=f.ConnectivityTypeEnum.TRIANGLES;y.attr={fill:new f.FillAttributes((x===undefined)?this.DEFAULT_COLOR:x),line:new f.LineAttributes(),point:new f.PointAttributes()};l=new f.VertexComponent();l.component=f.VertexComponentEnum.POSITION;l.nbVertices=g;l.nbValuesPerVertex=3;l.format=f.DataTypeEnum.FLOAT;l.cardinality=0;l.bufferId=4*this.meshNb;l.indices=new f.IndexArray();l.indices.format=f.DataTypeEnum.UINT;l.indices.bufferId=4*this.meshNb+2;l.indices.offset=o;if(n){s=new f.VertexComponent();s.component=f.VertexComponentEnum.NORMAL;s.nbVertices=g;s.nbValuesPerVertex=3;s.format=f.DataTypeEnum.FLOAT;s.cardinality=0;s.bufferId=4*this.meshNb+1;s.indices=new f.IndexArray();s.indices.format=f.DataTypeEnum.UINT;s.indices.bufferId=4*this.meshNb+3;s.indices.offset=q}for(var w=0;w<g;w++){var p=v.singleTrianglesIndices[u+w];this.posIdxBuffer.data[o++]=p;if(n){this.normIdxBuffer.data[q++]=p}}y.addVertexComponent(l);if(n){y.addVertexComponent(s)}if(y.nbVertexComponents>0){this.currentObject.addPrimitive(y)}u+=g}if(this.geomRepresentation.isIndexed&&this.geomRepresentation.isIndexed()==false){var y=new f.Primitive();y.geomType="FACE";y.nbIndices=v.vertices.length/3;y.connectivity=f.ConnectivityTypeEnum.TRIANGLES;y.attr={fill:new f.FillAttributes((x===undefined)?this.DEFAULT_COLOR:x),line:new f.LineAttributes(),point:new f.PointAttributes()};var l=new f.VertexComponent();l.component=f.VertexComponentEnum.POSITION;l.nbVertices=v.vertices.length/3;l.nbValuesPerVertex=3;l.format=f.DataTypeEnum.FLOAT;l.cardinality=0;l.bufferId=4*this.meshNb;l.indices=null;var s=new f.VertexComponent();s.component=f.VertexComponentEnum.NORMAL;s.nbVertices=v.normals.length/3;s.nbValuesPerVertex=3;s.format=f.DataTypeEnum.FLOAT;s.cardinality=0;s.bufferId=4*this.meshNb+1;s.indices=null;y.addVertexComponent(l);y.addVertexComponent(s);this.currentObject.addPrimitive(y)}this.finishCurrentMesh()},};return a});define("DS/XCADLoader/IModelLoaderPlug",[],function(){var a={isManagedType:function(b){},loadModel:function(h,k,g,b,i,e,d,f,c,j){}};return a});define("DS/XCADLoader/XCADError",["DS/WebInfraUI/Notification"],function(b){function a(){this.rsc="";this.url="";this.type="";this.level=""}a.prototype={constructor:a,setError:function(f,d,e,c){this.rsc=f;this.url=d;this.type=e;switch(c){case"info":this.level=b.info;break;case"fatal":this.level=b.fatal;break;case"error":this.level=b.error;break;case"warning":this.level=b.warning;break;case"success":this.level=b.success;break}},};return a});define("DS/XCADLoader/XCADLoader",["DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SceneGraphFactory","DS/XCADInputDocuments/XCADRepresentation","DS/XCADLoader/XCADGeomLoader","DS/Visualization/ThreeJS_DS","DS/ZipJS/zip","DS/WAFData/WAFData","DS/Visualization/Utils","DS/VisuDataAccess/ProxyAbstraction","DS/XCADLoader/XCADError"],function(d,i,e,l,j,h,b,g,a,k,f){var c=function(){var t=null;var r=null;var o=null;var u=null;var s;var n;var q=null;var m=[];function p(){t=null;r=null;o=null;u=null;q=null;s="";m=[]}this.load=function(x,B,M,v,E,D,A,O,I,H){p();s=B;n=B.substr(B.lastIndexOf(".")+1).toUpperCase();t=M;r=v;o=E;u=D;if(O){console.error(B+" : "+n+" Zipped file are not supported");var C=new f("XCADLoader_errors",null,"NO_ZIP","fatal");if(u){u(C)}return}var R=new d();var K=x;var F=new h.MeshBasicMaterial({side:h.DoubleSide,transparent:false});if(!B.startsWith("blob")){H.proxyurl=null}var P=new k();a.setProxyFromSpec(H,P);var Q=H.serverurl?H.serverurl:"";Q+=H.filename?H.filename:"";P.executeGetHttpRequest(Q,I,null,function(T){w(T)});function N(U,W){var T=new Blob([U]);var V=new FileReader();V.onload=function(X){W(X.target.result)};V.readAsText(T)}function w(X){var W=new f();var Z=K.initialize(X);if(Z instanceof f){if(u){u(Z)}if(t){t(R)}if(o){o()}return}var aa=false;var V=K.getRepresentation(l.XCAD_TESSELLATED_REPRESENTATION);if(V!==undefined){var T=new j();var U=T.load(V,r);if(!V.isIndexed||V.isIndexed()){R=e.createMeshNode(U,F)}else{R=e.createMeshNode(U,F,0,"mono")}R.productType="Reference3D";R.mesh3js.sceneGraph.children[0].solid=1}else{V=K.getRepresentation(l.XCAD_PRODUCT_REPRESENTATION);if(V!==undefined){var ab=V.getRootProducts();for(var Y=0;Y<ab.length;Y++){R=G(ab[Y],r);if(R.children.length===0&&R.mesh3js==undefined){aa=true;console.error(B+" : "+n+" Root with no supported Geometry");W.setError("XCADLoader/XCADLoader_errors",null,"EMPTY_ROOT","error");if(u){u(W)}}A.add(R)}}else{aa=true;console.error(B+" : "+n+" file with no supported representation");W.setError("XCADLoader/XCADLoader_errors",null,"NO_REP","error");if(u){u(W)}}}K.close();if(t){t(R)}if(!aa){if(o){o()}}}function G(ad,ab){var ac;var X=new f();var aa=ad.getProductAttributes();var af=aa[0];var Y=ad.getInstanceList();var W=ad.getFilePath();if(W!==undefined){console.log(B+" has an external reference: "+W);console.error(n+" file with external reference are not supported");X.setError("XCADLoader/XCADLoader_errors",null,"EXT_REF","error");if(u){u(X)}}else{if(af!==""){var ah=m[af];if(ah!==undefined&&ah!==null){if(ah.getNodeType()==="Mesh3D"){return ah.clone()}}var Z=ad.getDocument();if(Z!==undefined){Z.initialize("");var V=Z.getRepresentation(l.XCAD_TESSELLATED_REPRESENTATION);if(V!==undefined){console.log("XCADLoader - Loading geometry: "+af);var U=new j();var T=U.load(V,null);ac=e.createMeshNode(T,F);ac.name=af;ac.productType="Instance3D";m[af]=ac}else{console.warn(B+" : "+n+" file with empty representation");X.setError("XCADLoader/XCADLoader_errors",null,"NO_REP","warning");if(u){u(X)}}Z.close()}}if(Y.length>0){console.log("XCADLoader - product["+af+"]: "+Y.length+" instance(s)");if(ac===undefined){ac=new d(af);ac.productType="Reference3D";m[af]=ac}}for(var ag=0;ag<Y.length;ag++){if(ab){ab({loaded:ag,total:Y.length})}var ae=z(Y[ag]);if(ae!==undefined){ac.add(ae)}}if(ac&&(ac.productType==="Reference3D")&&(ac.children.length===0)){console.warn(B+" : "+n+" Product with empty Geometry");X.setError("XCADLoader/XCADLoader_errors",null,"EMPTY_PROD","warning");if(u){u(X)}}}return ac}function z(Y){var U=Y.getTransformation();var X=new h.Matrix4();if(U!==undefined&&U instanceof h.Matrix4){X=U}else{var V=U[1];var T=U[0];X.set(T[0][0],T[0][1],T[0][2],V[0],T[1][0],T[1][1],T[1][2],V[1],T[2][0],T[2][1],T[2][2],V[2],0,0,0,1)}var W=G(Y.getReferenceProduct(),null);if(W!==undefined){W.setMatrix(X)}return W}function J(T){alert(T)}function y(V){var U=window.webkitRequestFileSystem||window.mozRequestFileSystem||window.requestFileSystem;var T="tmp.dat";U(window.TEMPORARY,4*1024*1024*1024,function(X){function W(){X.root.getFile(T,{create:true},function(Y){V(Y)})}X.root.getFile(T,null,function(Y){Y.remove(W,W)},W)})}function S(T){if(T.length===0){}else{if(T.length===1&&!T[0].directory){T[0].getData(new b.BlobWriter(),function(U){var V=new FileReader();V.onload=function(W){w(W.target.result)};V.readAsText(U)})}else{y(function(U){U.foreach(function(X){var W=X;var V=new b.FileWriter(W);X.getData(V)})})}}}function L(V){var U=new Blob([V],{type:"application/zip"});var T=new b.BlobReader(U);b.createReader(T,function(W){W.getEntries(S)},J)}}};return c});define("DS/XCADLoader/XCADModelLoaderPlug",["DS/XCADLoader/IModelLoaderPlug","DS/XCADLoader/XCADLoader","DS/XCADSTEPDocument/STEPInputDocument","DS/XCADSTPDocument/STPInputDocument","DS/XCADSTPZDocument/STPZInputDocument","DS/XCADSTLDocument/STLInputDocument",],function(g,c,e,a,f,b){var d=function(){this.converter=null};d.prototype=Object.create(g);d.prototype.isManagedType=function(i){var h=i.toUpperCase()+"InputDocument";if(i=="obj"){h="XCAD"+i.toUpperCase()+"InputDocument"}if(typeof(require("DS/XCAD"+i.toUpperCase()+"Document/"+h))!=="undefined"){return true}else{return false}};d.prototype.loadModel=function(p,v,o,h,s,l,k,m,i,u,r,t){var q=p.toUpperCase()+"InputDocument";if(p=="obj"){q="XCAD"+p.toUpperCase()+"InputDocument"}var j=require("DS/XCAD"+p.toUpperCase()+"Document/"+q);if(typeof(j)==="undefined"){return false}if(this.converter===null){this.converter=new c()}var n=new j();this.converter.load(n,h,s,l,k,m,r,n.zipped,n.requestResponseType,t);n=null;return true};return d});