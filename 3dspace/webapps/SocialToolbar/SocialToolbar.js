define("DS/SocialToolbar/Utils/SocialToolbarSharedOptions",["UWA/Core","UWA/Array","UWA/Promise","UWA/Class/Options","UWA/Class/Events"],function(g,d,e,b,a){var c={NORMAL:"normal",LIGHT:"light"};var f=a.extend(b,{_lastActiveEditor:null,loaded:false,loadingFailure:false,defaultOptions:{"3DSwymUrl":"","3DSwymServerToken":null,tenantId:null,userLogin:null,userName:"",userIsAdmin:false,serviceUrl:""},init:function(h){this._parent.apply(this,arguments);if(h){this.configure(h)}},_removeEndingSlash:function(h){if(g.is(h,"string")&&(h.length>0)&&(h.charAt(h.length-1)==="/")){return h.slice(0,h.length-1)}else{return h}},_getUserInfo:function(){var i=this,h=e.deferred();if(this.options.userLogin&&this.options.userName){i.setOptions({userLogin:this.options.userLogin,userName:this.options.userName});h.resolve()}else{require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(k){try{k.getUser({platformId:i.options.tenantId,onComplete:function(l){i.setOptions({userLogin:l.id,userName:l.firstname+" "+l.lastname,userIsAdmin:l.admin});h.resolve()},onFailure:function(){h.reject("Error retrieving user information. Please make sure that the TopFrame is correctly configured and that 3DCompass is up and running.")}})}catch(j){h.reject("Error trying to call 3DCompass: "+j.message)}})}return h.promise},_get3DSwymUrl:function(){var i=this,h=e.deferred();if(this.options["3DSwymUrl"]){i.setOption("3DSwymUrl",this.options["3DSwymUrl"]);h.resolve()}else{require(["DS/i3DXCompassServices/i3DXCompassServices"],function(j){try{j.getPlatformServices({onComplete:function(m){var l=i.getOption("tenantId");if(d.isArray(m)){m.forEach(function(n){if(n.platformId===l){i.setOption("3DSwymUrl",i._removeEndingSlash(n["3DSwym"]))}})}h.resolve()},onFailure:function(){h.resolve()}})}catch(k){h.reject("Error trying to call 3DCompass: "+k.message)}})}return h.promise},configure:function(h){if(this.loaded===false){var i=this;delete this.options;this.loadingFailure=false;if(h&&h.serviceUrl){h.serviceUrl=this._removeEndingSlash(h.serviceUrl)}this.setOptions(h);if(!this.options.tenantId){throw new Error("Tenant ID is required")}if(!this.options.serviceUrl){throw new Error("Web service URL is required")}e.all([this._getUserInfo(),this._get3DSwymUrl()]).then(function(){i.loaded=true;i.loadingFailure=false;i.dispatchEvent("onReady")},function(j){i.loadingFailure=true;i.dispatchEvent("onError",[j])})}},getUserInfo:function(){return{login:this.options.userLogin,displayName:this.options.userName}},executeWhenReady:function(i,h){if(this.loaded===true){i.apply(this)}if(this.loadingFailure===true){if(h){h.apply(this)}}else{this.addEventOnce("onReady",function(){if(h){this.removeEvent("onError",h)}i.apply(this,arguments)});this.addEventOnce("onError",function(){this.removeEvent("onReady",i);if(h){h.apply(this,arguments)}})}},setLastActiveEditor:function(h){this._lastActiveEditor=h},getLastActiveEditor:function(){return this._lastActiveEditor}});f.MODE=c;return f});define("DS/SocialToolbar/Utils/Generic",["UWA/Core"],function(b){var a={debounce:function(d,c){if(typeof d==="function"){return(function(){var g=null,h=null,i=c||30,j=null,f=function(){d.apply(h,g)},e=function(){h=this;g=arguments;if(j){clearTimeout(j)}j=setTimeout(f,i)};return e})()}else{throw new Error("First argument is supposed to be a function")}}};return a});define("DS/SocialToolbar/Utils/Media",["UWA/Core","UWA/String","DS/Logger/Logger"],function(f,e,b){var a="3dcomment",c="annotation",d={DEFAULT_MEDIA_SOURCE:a,ANNOTATION_TYPE:c,getMediaHtml:function(g){var h="",i=this;if(g&&g.length>0){h=g.reduce(function(j,k){if(k.file){if(!i.isValidBlob(k.file)){b.error("Please provide a Blob representation of the file to be uploaded")}else{if(!k.type){b.error("A type needs to be specified for a media that will be uploaded in 3DComment")}else{if(k.type===c){if(!i.isValidBlob(k.data.annotationFile)){b.error("Please provide a Blob representation of the annotation data file")}else{k.source=a;k.uri=null;k.file=URL.createObjectURL(k.file);k.data.annotationFile=URL.createObjectURL(k.data.annotationFile);j+=('<img data-media-type="'+e.escapeHTML(k.type)+'" data-file="'+e.escapeHTML(k.file)+'" data-data="'+e.escapeHTML(JSON.stringify(k.data))+'" data-source="'+e.escapeHTML(k.source)+'"/>')}}else{b.error("Only an annotation type media can be currently uploaded in 3DComment")}}}}else{if(!k.source){b.error('Media "source" is missing')}else{if(!f.is(k.uri,"string")){b.error("Please provide a valid media URI")}else{j+=('<img data-uri="'+e.escapeHTML(k.uri)+'" data-source="'+e.escapeHTML(k.source)+'"/>')}}}return j},"")}h="<div>"+h+"</div>";return h},isValidBlob:function(g){return((g instanceof Blob)||(g.constructor&&g.constructor.name&&(g.constructor.name.toLowerCase()==="blob"))||(g.size&&g.type))},isValidBlobUrl:function(g){return(f.is(g,"string")&&(g.indexOf("blob")===0))},getMediaData:function(i){var j=[],g,h=this;if(i){g=f.createElement("div",{html:i}).getElements("img");if(g.length>0){j=g.reduce(function(l,k){var m={uri:k.dataset.uri,source:k.dataset.source,mediaType:k.dataset.mediaType};if(m.source){if(m.uri){l.push(m)}else{if(m.mediaType===c){m.file=k.dataset.file;m.data=JSON.parse(k.dataset.data);l.push(m)}}}return l},[])}}return j}};return d});define("DS/SocialToolbar/Utils/MessageBus",["UWA/Core","UWA/Class/Events"],function(c,a){var b=a.singleton({});return b});define("DS/SocialToolbar/Mixins/CompositeUI",["UWA/Core","UWA/Utils","UWA/Array","DS/WebAppsFoundations/Views/Plugins/Set"],function(f,b,a,c){var e=c.extend({_parentComponent:null,_stackItem:function(h,g){if(!h[g]){h[g]=b.getUUID()}if(typeof(h.setTopLevelComponent)==="function"){h.setTopLevelComponent(this._parentComponent.getTopLevelComponent())}return this._parent.apply(this,arguments)},setup:function(g,h){if(!h||!h.parentComponent){throw new Error("Parent component is required!")}this._parentComponent=h.parentComponent},addMap:function(g,i){var j;if(f.is(g,"object")){for(var h in g){if(g.hasOwnProperty(h)){j=this.get(h);if(j&&(g[h]!==j)){j.destroy()}}}}return this._parent.apply(this,arguments)},reset:function(g,h){var i=(!h)?{}:f.clone(h,false);if(i.hashMap!==false){i.hashMap=true}return this._parent.call(this,g,i)},onRemove:function(g){try{if(!(f.is(g.isDestroyed,"function")&&g.isDestroyed())){g.destroy()}}catch(h){}},onReset:function(k,g){if(g&&g.previousItems&&g.previousItems.length>0){var h,j;for(h=g.previousItems.length-1;h>=0;h--){j=g.previousItems[h];if(!(f.is(j.isDestroyed,"function")&&j.isDestroyed())){j.destroy()}}}}}),d={_rendered:false,_destroyed:false,_inPage:false,_topLevelComponent:null,options:null,components:null,_createContent:function(){},className:function(){return this.getClassNames()},init:function(g){var h=g&&g.componentsOptions?f.clone(g.componentsOptions,false):{};h.parentComponent=this;if(g&&g.parentComponent){this.setTopLevelComponent(g.parentComponent.getTopLevelComponent())}this.components=new e(null,h);return this},_propagateInPageValueToInnerComponents:function(){if(this.components){this.components.forEach(function(g){if(g.container&&f.is(g._inPage)){g.dispatchEvent("onInPageChangeRequest",[this._inPage])}},this)}},render:function(){this.dispatchEvent("onBeforeRender");this.container.setContent(this._createContent());this._rendered=true;this._propagateInPageValueToInnerComponents();this.dispatchEvent("onRender");return this},inject:function(){if(!this._rendered){this.render()}return this},setTopLevelComponent:function(g){this._topLevelComponent=g;if(this.components){this.components.forEach(function(h){if(typeof(h.setTopLevelComponent)==="function"){h.setTopLevelComponent(this._topLevelComponent)}},this)}},getTopLevelComponent:function(){return this._topLevelComponent||this},isRendered:function(){return this._rendered},isDestroyed:function(){return this._destroyed},isInPage:function(){return this._inPage},onInPageChangeRequest:function(g){if((g!==this._inPage)&&f.is(g,"boolean")){this._inPage=g;this._propagateInPageValueToInnerComponents()}},onPostInject:function(){var g=false;if(this.container&&document.body.contains(this.container)){g=true}this.dispatchEvent("onInPageChangeRequest",[g])},onInjected:function(){this._inPage=true},onRemoved:function(){this._inPage=false},destroy:function(g){if((this._destroyed!==true)||(g&&g.force===true)){this._destroyed=true;this.components.remove(this.components.toArray());this.components.reset(null,{silent:true});this.components=null;this._topLevelComponent=null;this.container=null;this.tagName=null;this.className=null;this.attributes=null;this.domEvents=null;this.options=null}return this}};return d});define("DS/SocialToolbar/Controls/ResponsiveButtonTooltip",["UWA/Core","DS/UIKIT/Tooltip"],function(c,b){var a=b.extend({defaultOptions:{btnMaxWidth:42},show:function(){if(this.getOption("target")&&this.getOption("target").getSize().width<=this.getOption("btnMaxWidth")){return this._parent.apply(this,arguments)}}});return a});define("DS/SocialToolbar/Utils/Sprite",["UWA/Core","UWA/Utils","UWA/Class","DS/WebappsUtils/WebappsUtils","DS/Logger/Logger"],function(f,b,e,d,a){var c=e.singleton({_normalPictureSelector:'img[data-type="ENoPicture"]',_miniPictureSelector:'img[data-type="EMiPicture"]',_nonReloadedImagesSelector:'[data-status="NonReloaded"]',_reloadUserPicturesWithoutSprites:function(h){if(!h||!h.el){throw new Error("An HTMLElement is required if you want to reload user pictures")}if(!h.swymUrl){return this}var m,l,q="",p,s,j,k=h.selector,g=h.el,r=h.format||"normal",o=f.extendElement(g).getElements(k),n=o.length;if(n>0){for(m=0;m<n;m++){j=o[m];p=j.getAttribute("data-login");s=h.clsOver||j.getAttribute("data-cls_over");if(s){addClassOnOver(j,s)}if(!p){continue}j.onload="";if(p){l=j.getAttribute("data-fingerprint")||"";if(p){q=["/api/user/getpicture/login/",p,"/format/",r,l?("/update/"+l):""].join("")}j.src=h.swymUrl+q;j.setAttribute("data-status","Reloaded")}}}},_reloadUserPicturesWithSprite:function(D){if(!D||!D.el){throw new Error("An HTMLElement is required if you want to reload user pictures")}if(!D.swymUrl){return this}var y=D.selector,h=D.el,A=D.format||"normal",r=f.extendElement(h).getElements(y),B;if(r.length===1&&D.useSprite!==true){return this._reloadUserPicturesWithoutSprites.call(this,D)}if(r.length>0){var E,l,C,t,v,w,q,z,u,s,g,n,p,k=[],o,x,m;switch(A){default:case"normal":w=123;o=7;break;case"mini":w=34;o=6;break}t=v=w;if(D.spritesMaxLength){while((B=r.length)){k.push(r.splice(0,D.spritesMaxLength))}}else{k.push(r)}for(x=0,p=k.length;x<p;x++){r=k[x];E=0;l=0;C="";m=D.swymUrl+"/api/media/streammediasprite/idList/";for(z=0,B=r.length;z<B;z++){u=r[z];s=u.getAttribute("data-login");n=D.clsOver||u.getAttribute("data-cls_over");if(n){addClassOnOver(u,n)}if(s){m+=((z===0?"":"=")+[s,o,6,v,t,"1"].join(":"))}g=u.getAttribute("data-fingerprint")||"";if(g){C+=g}}if(C){m+="/update/"+b.getCheckSum(C)}q="101% "+(B*100)+"%";for(z=0;z<B;z++){u=r[z];E+=l;if(u.getAttribute("data-login")){u.set({onload:"","data-status":"Reloaded",styles:{display:"inline-block","background-image":'url("'+m+'")',"background-size":q,"background-position":"0px "+(E*100)/((B-1)*t)+"%"}})}l=t}}}},_reloadUserPictures:function(g){if(!g){g={}}if(typeof g.format!=="string"){g.format="normal"}g.format=g.format.toLowerCase();switch(g.format){default:case"normal":g.selector=this._normalPictureSelector;break;case"mini":g.selector=this._miniPictureSelector;break}if(g.nonReloadedImagesOnly!==false){g.selector=g.selector+this._nonReloadedImagesSelector}return this._reloadUserPicturesWithSprite(g)},getUserPictureAttributes:function(h){if(h){var i,g,j;if(typeof h.format!=="string"){h.format="normal"}h.format=h.format.toLowerCase();switch(h.format){default:case"normal":i="ENoPicture";g="st-e-nopicture";break;case"mini":i="EMiPicture";g="st-e-mipicture";break}if(h.swymUrl){j={"data-type":i,"data-model_name":"user","class":[g," ",h.cls||""].join(""),src:[d.getWebappsBaseUrl(),"SocialToolbar/assets/s.gif"].join(""),"data-status":"NonReloaded"}}else{j={"data-type":i,"data-model_name":"user","class":[g," fonticon fonticon-user ",h.cls||""].join("")}}if(h.title){j.title=h.title}if(h.login){j["data-login"]=h.login}else{a.warn("User login is required if you want to display his/her profile picture")}if(h.clsOver){j["data-cls_over"]=h.clsOver}if(h.imageFingerprint){j["data-fingerprint"]=h.imageFingerprint}else{j["data-fingerprint"]=""}return j}else{return{}}},renderUserPicture:function(g){return f.createElement(g.swymUrl?"img":"span",this.getUserPictureAttributes(g))},reloadUserPictures:function(g){if(!g){g={}}if(!g.swymUrl){return this}g.format="normal";this._reloadUserPictures(g);g.format="mini";this._reloadUserPictures(g)}});return c});define("DS/SocialToolbar/Models/BaseModel",["UWA/Core","UWA/Json","UWA/Utils","UWA/Class/Model","DS/Logger/Logger","DS/WAFData/WAFData"],function(e,d,c,b,a,f){function i(j,l){var k=undefined;if(j){k=j[l];if(e.is(k,"function")){k=k.call(j)}}return k}function h(j){return(!j.contains("?")?"?":(j.endsWith("?")?"":"&"))}var g=b.extend({_getResponseHeader:function(k,j){var m=null,l=k.request;if(e.is(l&&l.getResponseHeader,"function")){m=l.getResponseHeader(j)}else{if(e.is(l&&l.xhr&&l.xhr.getResponseHeader,"function")){m=l.xhr.getResponseHeader(j)}else{if(k.responseHeaders){m=k.responseHeaders[j]}}}return m},sync:function(p,k,j){var m=j||{},o=m.onComplete,n=m.onFailure,l=e.is(this.getSubject,"function")?this.getSubject():this;m.ajax=f.authenticatedRequest;m.headers=m.headers||{};if(e.is(m.data,"object")&&(p==="read"||(m.method&&m.method.toLowerCase()==="get"))){m.url+=h(m.url)+c.toQueryString(m.data);m.data=null}else{if(!m.headers["Content-Type"]&!m.dataType){m.headers["Content-Type"]="application/json;charset=utf-8"}}if(!m.headers["X-Requested-With"]){m.headers["X-Requested-With"]="XMLHttpRequest"}if(!m.url){m.url=(i(k,"url"))}if(m.url&&m.url.indexOf("tenant=")===-1){if(e.is(l.getSharedOptions,"function")){m.url+=h(m.url)+"tenant="+l.getSharedOptions().getOption("tenantId")}else{a.warn("Tenant Id is missing")}}if(o){m.onComplete=function(q,s){var r=!e.is(q,"string")?q:d.decode(q);return o.call(this,e.is(r&&r.result)?r.result:r,s)}}if(n){m.onFailure=function(r,q,t){var s=!e.is(q,"string")?q:d.decode(q);return n.call(this,r,e.is(s&&s.result)?s.result:s,t)}}this._parent.call(this,p,k,m)}});return g});define("DS/SocialToolbar/Utils/Date",["UWA/Core","DS/UWPClientCode/I18n","i18n!DS/SocialToolbar/assets/nls/utils/date"],function(d,b,c){var a={prettyDate:function(h){if(h){if(typeof(h)==="string"&&h.match(/(\/|&#x2F;)/g)){h=h.replace("-"," ").replace(/(\/|&#x2F;)/g,"-")}var e;if(!d.is(h,"number")){var n=new Date(h);e=n.getTime()+n.getTimezoneOffset()*60000}else{e=new Date(h+new Date().getTimezoneOffset()*60000)}var f=new Date(new Date().valueOf()+new Date().getTimezoneOffset()*60000);var l=(e>f)?true:false;var m=((f.getTime()-e)/1000),g;if(l){m=-m}g=Math.floor(m/86400);if(isNaN(g)||g<0){return c.justnow}if(g>=31){var o=new Date(e);var k=o.getDate();var i=(o.getMonth()+1);var j=o.getFullYear();k=k<10?"0"+k:k;i=i<10?"0"+i:i;return[j,"-",i,"-",k].join("")}if(!l){return g===0&&(m<60&&c.justnow||m<120&&c.oneminago||m<3600&&b.replace(c.minutesCountminsago,{minutesCount:Math.floor(m/60)})||m<7200&&c.onehrago||m<86400&&Math.floor(m/3600)===1&&c.onehrago||m<86400&&b.replace(c.hoursCounthrsago,{hoursCount:Math.floor(m/3600)}))||g==1&&c.yesterday||g<7&&b.replace(c.daysCountdaysago,{daysCount:g})||g<31&&Math.ceil(g/7)==1&&b.replace(c.weekCountweekago,{weeksCount:Math.ceil(g/7)})||g<31&&Math.ceil(g/7)>1&&b.replace(c.weeksCountweekago,{weeksCount:Math.ceil(g/7)})}else{if(g===0){if(m<60){return c.justnow}}return""}}else{return c.justnow}}};return a});define("DS/SocialToolbar/Mixins/Commentable",["UWA/Core"],function(b){var a={_comments:null,_commenters:null,COMMENTS_ATTRIBUTE:"comments",COMMENTS_COUNT_ATTRIBUTE:"nbComments",CommentCollection:null,defaults:{comments:null},_onCommentsChange:function(d,c){if(this._comments){this.setComments(c)}},_onNbCommentsChange:function(d,c){if(this._comments&&!this._comments.hasBeenFetched()){this._comments.setTotalRecords(this.getCommentsTotalCount())}},setComments:function(c){this.getComments().reset(c)},getComments:function(){if(!this._comments){this._comments=new this.CommentCollection(this.get("comments"),{target:this,targetInteractionCountAttr:this.COMMENTS_COUNT_ATTRIBUTE,subject:b.is(this.getSubject,"function")?this.getSubject():this})}return this._comments},getCommentsTotalCount:function(){return this.get(this.COMMENTS_COUNT_ATTRIBUTE)},getCommenters:function(){var c=this.getComments();if(!this._commenters){this._commenters=c.getAuthors()}else{this._commenters.add(c.getAuthorArray())}return this._commenters},init:function(c){var d={};this._parent.apply(this,arguments);d["onChange:"+this.COMMENTS_ATTRIBUTE]=this._onCommentsChange;d["onChange:"+this.COMMENTS_COUNT_ATTRIBUTE]=this._onNbCommentsChange;this.addEvents(d)},clean:function(){if(this._comments){this._comments.clean();this._comments=null}if(this._commenters){this._commenters.clean();this._commenters=null}return this._parent.apply(this,arguments)}};return a});define("DS/SocialToolbar/Views/BaseView",["UWA/Core","UWA/Class/View","DS/SocialToolbar/Mixins/CompositeUI"],function(d,c,b){var a=c.extend(b,{init:function(){this._parent.apply(this,arguments);this._previous.apply(this,arguments)},render:function(){return this._previous.apply(this,arguments)},inject:function(){this._parent.apply(this,arguments);this._previous.apply(this,arguments);return this},onInjected:function(){this._parent.apply(this,arguments);this._previous.apply(this,arguments)},destroy:function(){if(this._destroyed!==true){this._destroyed=true;this.dispatchEvent("onDestroy",[this]);this.model=null;this.collection=null;this._parent.apply(this,arguments);this._previous.call(this,{force:true});this.stopListening()}return this}});return a});define("DS/SocialToolbar/Collections/BaseCollection",["UWA/Core","UWA/Json","DS/WebAppsFoundations/Collections/PageableCollection","UWA/Class/Model","DS/SocialToolbar/Models/BaseModel","DS/SocialToolbar/Utils/Generic"],function(g,d,b,f,a,e){var c=b.extend({_mainRangeName:null,_stateModel:null,_fetched:false,_beingFetched:false,ranges:null,defaultOptions:{stateParseMode:"headers",state:{baseOffset:0,firstPage:0,currentPage:0},queryParams:{currentPage:"page_number",pageSize:"page_size"}},_executePostInitInstructions:function(){var h=this,i=e.debounce(function(){var j=[];if(arguments.length>=2){j=[].concat(arguments).slice(arguments.length-2)}h.dispatchEvent("onCollectionChange",j)});this.addEventOnce("onSync",function(j){if(j===this){this._fetched=true}});this.addEvents({onAdd:i,onRemove:i,onSort:i,onReset:i,onRequest:function(j){if(this===j){this._beingFetched=true}},onSync:function(j){if(this===j){this._beingFetched=false}},onError:function(j){if(this===j){this._beingFetched=false}}})},_computeTotalPages:function(i,h){if(this.state&&(this.state.baseOffset>0)&&(i>=this.state.baseOffset)){return Math.ceil((i-this.state.baseOffset)/h)}else{return this._parent.apply(this,arguments)}},_getPageValueConsistentWithCurrentState:function(h){if(!h){h={}}var l=this.state||{},m=g.is(h.totalRecords,"number")?h.totalRecords:l.totalRecords,i=g.is(h.collectionSize,"number")?h.collectionSize:this.length,k=this._computeTotalPages(m,l.pageSize),j=(k?Math.max(l.firstPage,Math.ceil((i-this.state.baseOffset)/l.pageSize)-(l.firstPage===0?1:0)):l.firstPage);return j},_updateCurrentPageState:function(){this.state=this._checkState(g.extend(this.state||{},{currentPage:this._getPageValueConsistentWithCurrentState()}))},_updateStateModel:function(){if(!this._stateModel){this._stateModel=new f();this.listenTo(this._stateModel,{onAnyEvent:function(k,j,i,h){this.dispatchEvent(k+"State",[j,i,h])}})}this._stateModel.set(this.state)},_checkState:function(){var h=this._parent.apply(this,arguments);setTimeout(this._updateStateModel,0);return h},_getResponseHeader:function(i,h){var j=null;if(g.is(i.request&&i.request.getResponseHeader,"function")){j=i.request.getResponseHeader(h)}else{if(i.responseHeaders){j=i.responseHeaders[h]}}return j},init:function(){this.ranges={};this._updateStateModel=this._updateStateModel.bind(this);this._parent.apply(this,arguments);this._executePostInitInstructions()},parseRanges:function(i,h){return{}},parseHeadersForStateUpdate:function(l,i,j,h){var k={};g.extend(this.ranges,this.parseRanges(l,h));return k},setTotalRecords:function(i,h){this.state=this._checkState(g.merge({totalRecords:i,currentPage:this._getPageValueConsistentWithCurrentState({totalRecords:i,collectionSize:h&&h.collectionSize})},this.state));this._updateStateModel();return this},getTotalRecords:function(){return this.state.totalRecords},sync:function(j,i,h){return a.prototype.sync.apply(this,arguments)},hasBeenFetched:function(){return this._fetched},isBeingFetched:function(){return this._beingFetched},onAdd:function(){this._updateCurrentPageState()},onRemove:function(){this._updateCurrentPageState()},onReset:function(){this._updateCurrentPageState()},onCollectionChange:function(i,h){if(!this._beingFetched&&(!this.state.totalRecords||this.length>this.state.totalRecords)){this.setTotalRecords(this.length)}},clean:function(){this.reset([])}});return c});define("DS/SocialToolbar/Views/BaseCollectionView",["UWA/Core","DS/WebAppsFoundations/Views/CollectionView","DS/SocialToolbar/Mixins/CompositeUI"],function(d,b,c){var a=b.extend(c,{init:function(){this._parent.apply(this,arguments);this._previous.apply(this,arguments)},buildItemView:function(e,f){return new f({model:e,parentComponent:this})},render:function(){return this._parent.apply(this,arguments)},inject:function(){this._parent.apply(this,arguments);this._previous.apply(this,arguments);return this},onInjected:function(){this._parent.apply(this,arguments);this._previous.apply(this,arguments)},destroy:function(){if(this._destroyed!==true){this.dispatchEvent("onDestroy",[this]);this._parent.apply(this,arguments);this._previous.apply(this,arguments);this.stopListening()}return this}});return a});define("DS/SocialToolbar/Models/Media",["UWA/Core","UWA/Promise","DS/SocialToolbar/Models/BaseModel","DS/SocialToolbar/Utils/Media"],function(d,c,a,e){var b=a.extend({name:"media",defaults:{uri:null,source:null,mediaType:null,thumbnailUrl:"",redirectionUrl:""},idAttribute:"uri",init:function(){this._parent.apply(this,arguments)}});return b});define("DS/SocialToolbar/Models/User",["UWA/Core","DS/SocialToolbar/Models/BaseModel"],function(b,a){var c=a.extend({name:"user",defaults:{login:null,displayName:""},idAttribute:"login",getFullName:function(){return(this.get("firstName")&&this.get("lastName"))?(this.get("firstName")+" "+this.get("lastName")):(this.get("displayName")||"")}});return c});define("DS/SocialToolbar/Views/MediaView",["UWA/Core","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Utils/Media","DS/WebappsUtils/WebappsUtils","DS/Logger/Logger"],function(e,b,f,c,a){var d=b.extend({name:"st-media",_editMode:false,domEvents:{"click span.fonticon-cancel":"_onRemove"},defaultOptions:{editMode:false},init:function(g){this._parent.apply(this,arguments);if(e.is(this.getOption("editMode"),"boolean")){this._editMode=this.getOption("editMode")}if(!this.model){throw new Error("Media model is missing")}this.listenTo(this.model,"onChange:thumbnailUrl",this._updateImageBg);return this},_updateImageBg:function(){if(this.elements.imgTag&&this.model&&this.model.get("thumbnailUrl")){this.elements.imgTag.setStyle("background-image","url("+this.model.get("thumbnailUrl")+")")}},_createContent:function(){var h,g,i=this.model;if(i.get("thumbnailUrl")){h=i.get("thumbnailUrl")}else{if((i.get("mediaType")===f.ANNOTATION_TYPE)&&i.get("thumbnailFile")){g=i.get("thumbnailFile");if(f.isValidBlobUrl(g)){h=g}}else{h=(c.getWebappsBaseUrl()+"SocialToolbar/assets/thumb.png")}}this.elements.imgTag=e.createElement("img",{src:h,"data-source":i.get("source"),"data-uri":i.get("uri")});return[this.elements.imgTag,(this._editMode?this.getRemoveIcon():"")]},getRemoveIcon:function(){return{tag:"span","class":"fonticon fonticon-cancel"}},_onRemove:function(){var g=this.model;if(g&&g.collection){this.dispatchEvent("onMediaRemoval",[g]);g.collection.remove(g)}},onRender:function(){this._parent.apply(this,arguments);var h=this,g=this.model,i=g.get("source");if(!g.get("thumbnailUrl")){if(g.get("source")!==f.DEFAULT_MEDIA_SOURCE){require(["DS/SocialToolbarCustomization/script/source/"+i],function(j){if(!h.isDestroyed()){j.getThumbnailUrlFromContentUri({contentUri:g.get("uri"),callback:function(k){g.set("thumbnailUrl",k)}})}},function(){a.error("No customization module for media from source:",i)})}}}});return d});define("DS/SocialToolbar/Collections/UserCollection",["UWA/Core","DS/SocialToolbar/Collections/BaseCollection","DS/SocialToolbar/Models/User"],function(c,b,d){var a=b.extend({model:d,name:"user-collection"});return a});define("DS/SocialToolbar/Models/Interaction",["UWA/Core","DS/SocialToolbar/Models/BaseModel","DS/SocialToolbar/Models/User"],function(c,a,d){var b=a.extend({defaults:{},_author:null,_subject:null,_target:null,init:function(f,e){this._parent.apply(this,arguments);if(e){if(e.subject){this._subject=e.subject}if(e.target){this._target=e.target}}return this},setAuthor:function(e){this.getAuthor().set(e)},getAuthor:function(){if(!this._author){this._author=new d(this.get("author"))}return this._author},getSubject:function(){if(this.collection){return this.collection.getSubject()}else{return this._subject}},getTarget:function(){if(this.collection){return this.collection.getTarget()}else{return this._target}},"onChange:author":function(e,f){this.setAuthor(f)}});return b});define("DS/SocialToolbar/Models/Endorsement",["UWA/Core","DS/SocialToolbar/Models/Interaction"],function(c,b){var a=b.extend({name:"endorsement",idAttribute:"endorseUri",urlRoot:function(){return this.getTarget().url()+"/endorses"},url:function(){if(this.isNew()){return this.urlRoot()+"/me"}else{return this._parent.apply(this,arguments)}}});return a});define("DS/SocialToolbar/Collections/InteractorCollection",["UWA/Core","DS/SocialToolbar/Collections/UserCollection"],function(c,b){var a=b.extend({_subject:null,_interactions:null,name:"interactor-collection",init:function(e,d){if(d){if(d.subject){this._subject=d.subject}if(d.interactions){this._interactions=d.interactions}}return this._parent.apply(this,arguments)},getSubject:function(){return this._subject||(this._interactions&&this._interactions.getSubject())},getTarget:function(){return(this._interactions&&this._interactions.getTarget()||this.getSubject())},getInteractions:function(){return this._interactions},changeTotalRecordsBy:function(d){this.setTotalRecords((this.state.totalRecords||0)+d)}});return a});define("DS/SocialToolbar/Collections/InteractionCollection",["UWA/Core","DS/SocialToolbar/Collections/BaseCollection","DS/SocialToolbar/Collections/UserCollection"],function(d,c,b){var a=c.extend({_authors:null,_subject:null,_target:null,_targetInteractionCountAttr:null,AuthorCollection:b,defaultOptions:{state:{pageSize:10,order:1}},_updateAuthorList:function(){if(!this._authors){this._authors=new (this.AuthorCollection)(this.getAuthorArray(),{interactions:this})}else{this._authors.add(this.getAuthorArray())}return this._authors},init:function(f,e){this._parent.apply(this,arguments);if(e&&e.subject){this._subject=e.subject;if(e.target){this._target=e.target;if(e.targetInteractionCountAttr){this._targetInteractionCountAttr=e.targetInteractionCountAttr;this.setTotalRecords(this._target.get(this._targetInteractionCountAttr))}else{throw new Error("The target attribute which contains the interaction count is required when initializing this collection")}}else{throw new Error("The target of the interaction is required when initializing this collection")}}else{throw new Error("A subject is required when initializing this collection")}return this},getAuthorArray:function(){return this.pluck("author")},getAuthors:function(){if(!this._authors){this._authors=this._updateAuthorList()}return this._authors},getSubject:function(){return this._subject},getTarget:function(){return this._target},changeTotalRecordsBy:function(e){var f,g=this._target;if(this.hasBeenFetched()){this.setTotalRecords((this.state.totalRecords||0)+e,{collectionSize:this.length+e})}else{f=parseInt(g.get(this._targetInteractionCountAttr),10);if((f+e)>=0){this.setTotalRecords(f+e,{collectionSize:this.length+e})}}},onCollectionChange:function(){this._parent.apply(this,arguments);this._updateAuthorList()},"onChange:totalRecordsState":function(e,f){f=parseInt(f,10);if(f>=0){this._target.set(this._targetInteractionCountAttr,f)}},clean:function(){this._authors=null;return this._parent.apply(this,arguments)}});return a});define("DS/SocialToolbar/Collections/EndorserCollection",["UWA/Core","DS/SocialToolbar/Collections/InteractorCollection"],function(c,a){var b=a.extend({name:"endorser-collection",url:function(){return this.getTarget().url()+"/endorses/users"}});return b});define("DS/SocialToolbar/Mixins/InlineEditor",["UWA/Core","DS/SocialToolbar/Utils/Generic"],function(c,d){var e=16,h=17,a=42,f=10,i="#cke_",g=a+f;var b={CKEDITOR_TOOLBAR_HEIGHT:a,CKEDITOR_TOOLBAR_EDITOR_PADDING:f,CKEDITOR_TOOLBAR_HEIGHT_WITH_PADDING:g,_onKeyUp:d.debounce(function(k){var j,m,l=k.ctrlKey||k.metaKey;if((k.keyCode===e)||(k.keyCode===h)||(k.shiftKey)||(l)){j=window.getSelection();m=j.toString();if(m.length>0){this._displayContextualToolbarForTextSelection();return this}}this._hideRTEToolbar()},250),_onWindowMouseUp:function(k){document.body.removeEvent("mouseup",this._onWindowMouseUpBound);var j=window.getSelection(),l=j.toString();if((l.length>0)||((j.rangeCount>0)&&!(k&&c.extendElement(k.target).match("img")))){setTimeout(this._displayContextualToolbarForTextSelection.bind(this),0)}else{this._hideRTEToolbar()}},_onMouseDown:function(){if(!this._onWindowMouseUpBound){this._onWindowMouseUpBound=this._onWindowMouseUp.bind(this)}c.extendElement(document.body).addEvent("mouseup",this._onWindowMouseUpBound);this._hideRTEToolbar()},_getTextAreaId:function(){throw new Error("This method is meant to be overridden")},_getEditorToolbarIdSelector:function(){return i+this._getTextAreaId()},_hideRTEToolbar:function(){c.extendElement(document.body);var j=document.body.getElement(this._getEditorToolbarIdSelector());if(j){j.addClassName("hidden")}},_showRTEToolbar:function(){c.extendElement(document.body);var j=document.body.getElement(this._getEditorToolbarIdSelector());if(j&&j.hasClassName("hidden")){j.removeClassName("hidden")}},_positionRTEToolbar:function(l,k){c.extendElement(document.body);var j=document.body.getElement(this._getEditorToolbarIdSelector());if(j){j.style.setProperty("top",l+"px","important");j.style.setProperty("left",k+"px","important");j.setStyle("position","absolute")}},_displayContextualToolbarForTextSelection:function(){c.extendElement(document.body);var p,s,r,j,o,q,l;var t=window.getSelection(),n=t.toString();if((n.length>0)||(t.rangeCount>0)){p=t.getRangeAt(0);if(n.length<=0&&t.rangeCount>0){var m=p.cloneContents();var k=document.createElement("div");k.appendChild(m);if(k.innerHTML.length<=0){return}}s=p.getBoundingClientRect();r=s.top;j=s.bottom;o=s.left;if(r>g){l=r-g}else{q=document.body.getSize().height;if((q-j)>a){l=j+f}else{l=f}}this._positionRTEToolbar(l,o);this._showRTEToolbar()}}};return b});define("DS/SocialToolbar/Views/InteractorSmallView",["UWA/Core","DS/SocialToolbar/Views/BaseView"],function(b,a){var c=a.extend({name:"st-interactor-small",_createContent:function(){return this.model.getFullName()}});return c});define("DS/SocialToolbar/Views/AnnotationView",["UWA/Core","UWA/Promise","DS/SocialToolbar/Views/MediaView","DS/UIKIT/Spinner"],function(e,a,c,b){var d=c.extend({className:function(){return this._parent()+(this.isClickable()?" clickable":"")},isClickable:function(){return !Boolean(this.getOption("editMode"))},domEvents:{"click img":"onAnnotationThumbnailClick","click span.fonticon-trash":"_onRemove"},getRemoveIcon:function(){return{tag:"span","class":"fonticon fonticon-trash"}},_onRemove:function(){this.model.deleteAnnotation();this._parent.apply(this,arguments)},onAnnotationThumbnailClick:function(f){if(this.isClickable()&&f&&!f.data){f.data={view:this}}},getDataOnClick:function(){var f=this.model,g=new b({className:"downloading-spinner"});g.inject(this.container).show();return a.all([f.getAnnotationFile(),f.getThumbnailFile()]).then(function(i){var j=i[0],h=i[1];g.remove().destroy();return{type:"annotation",file:h,data:{annotationFile:j}}})}});return d});define("DS/SocialToolbar/Collections/CommenterCollection",["UWA/Core","DS/SocialToolbar/Collections/InteractorCollection"],function(c,b){var a=b.extend({name:"commenter-collection",url:function(){return this.getTarget().url()+"/comments/users"},parseState:function(h,f,g,e){var d=this._parent.apply(this,arguments);if(!c.is(d&&d.totalRecords)&&(g&&g.pageSize>0)&&(h&&h.length===g.pageSize)){if(!d){d={}}d.totalRecords=this.length+h.length+1}return d}});return a});define("DS/SocialToolbar/Models/Annotation",["UWA/Core","UWA/Promise","UWA/String","DS/SocialToolbar/Models/Media","DS/SocialToolbar/Utils/Media","DS/WAFData/WAFData"],function(e,g,c,i,d,h){var f=function(j){if(window.fetch){return window.fetch(j).then(function(k){return k.blob()})}else{return new g(function(l,k){var m=new XMLHttpRequest();m.open("GET",j,true);m.responseType="blob";m.onload=function(n){if(this.status===200){l(this.response)}else{k(this.response)}};m.send()})}},a=function(j){return new g(function(l,k){h.authenticatedRequest(j,{method:"GET",responseType:"blob",onComplete:function(m){l(m)},onFailure:function(){k("Error downloading annotation file")},onTimeout:function(){k("Time out while trying to download annotation file")}})})},b=i.extend({name:"annotation",_subject:null,defaults:{thumbnailFile:null,annotationFile:null},upload:function(){var k={},j=this;return f(j.get("annotationFile")).then(function(l){k.annotationFile=l}).then(function(){return f(j.get("thumbnailFile")).then(function(l){k.thumbnailFile=l})}).then(function(){return new g(function(m,l){j.save({},{url:j.getUploadUrl(),data:(function(){var n=new FormData();if(k.thumbnailFile.type==="image/png"){n.append("altFile",k.thumbnailFile,"annotation_thumbnail.png")}else{if(k.thumbnailFile.type==="image/jpeg"){n.append("altFile",k.thumbnailFile,"annotation_thumbnail.jpg")}else{throw new Error("The annotation thumbnail can only be a png or jpg")}}n.append("userFile",k.annotationFile,"annotation.3dplayannotation");return n})(),dataType:"formData",onComplete:function(o,n){j.onUpload(o,n);m()},onFailure:function(){l()}})})})},init:function(j,k){if(!k||!k.subject){throw new Error("Subject URI is needed for an annotation")}this._preprocessAttributes(j);this._parent.apply(this,arguments);this._subject=k.subject;if(!this.isNew()){this.set("thumbnailUrl",this.getAnnotationThumbnailURL())}else{if(!this.get("thumbnailFile")||!this.get("annotationFile")){throw new Error("For a new annotation, the thumbnail and annotation file need to be provided")}}},_preprocessAttributes:function(j){if(!j){throw new Error("Cannot create an empty annotation")}else{if(d.isValidBlobUrl(j.file)){j.thumbnailFile=j.file;delete j.file}if(j.data&&d.isValidBlobUrl(j.data.annotationFile)){j.annotationFile=j.data.annotationFile;delete j.data.annotationFile}}},getSubject:function(){return this._subject},urlRoot:function(){return this.getSubject().url()+"/media"},getUploadUrl:function(){return this.urlRoot()},getDeleteUrl:function(){return this.urlRoot()+"/"+this.get("uri")},getAnnotationThumbnailURL:function(){var j=this.get("uri");if(j){return this.urlRoot()+"/"+j+"/type/thumb/key/original"}else{throw new Error("Annotation URI is needed for generating its thumbnail URL")}},getAnnotationURL:function(){var j=this.get("uri");if(j){return this.urlRoot()+"/"+j+"/type/original"}else{throw new Error("Annotation URI is needed for generating its URL")}},onUpload:function(k,j){this.set("uri",j.mediaUri);this.set("thumbnailUrl",this.getAnnotationThumbnailURL())},deleteAnnotation:function(){var k,j=this;if(!this.isNew()){k=new g(function(m,l){j.destroy({url:j.getDeleteUrl(),onComplete:m,onFailure:l})})}else{k=g.resolve()}return k},getAnnotationFile:function(){var j=this,k;if(j.isNew()){k=j.get("annotationFile")}else{k=j.getAnnotationURL()}return a(k)},getThumbnailFile:function(){var j=this,k;if(j.isNew()){k=j.get("thumbnailFile")}else{k=j.getAnnotationThumbnailURL()}return a(k)},getHtml:function(){var j=this;if(j.isNew()){return"<img"+(' data-media-type="'+c.escapeHTML(j.get("mediaType")))+'" data-file="'+c.escapeHTML(j.get("thumbnailFile"))+'" data-data="'+c.escapeHTML(JSON.stringify({annotationFile:j.get("annotationFile")}))+'" data-source="'+j.get("source")+'"/>'}else{return'<img data-uri="'+j.get("uri")+('" data-media-type="'+j.get("mediaType"))+'" data-source="'+j.get("source")+'" />'}}});return b});define("DS/SocialToolbar/Views/InteractorSmallListView",["UWA/Core","DS/SocialToolbar/Views/BaseCollectionView","DS/SocialToolbar/Views/InteractorSmallView"],function(c,a,d){var b=a.extend({name:"st-interactor-small-list",domEvents:{},_ItemView:d});return b});define("DS/SocialToolbar/Views/PreviousCommentsLoaderView",["UWA/Core","DS/UIKIT/Mask","DS/SocialToolbar/Views/BaseView","i18n!DS/SocialToolbar/assets/nls/social-toolbar"],function(e,d,a,c){var b=a.extend({name:"st-previous-comments-loader",domEvents:{"click .st-fake-link":"_onClick"},_masked:false,_createContent:function(){var i,l=this.collection,h=l.length,m=(this.model instanceof l.model),k=this.model.getCommentsTotalCount(),f,j,g=false;if((h<k)){f=l.getDefaultPageSize();j=k-h;if(j<=f){g=true}else{j=f}i={tag:"span","class":"st-fake-link",html:((j===1)?(m?c.get("ViewFirstReply"):c.get("ViewFirstComment")):((g===true)?(m?c.get("ViewFirstNReplies"):c.get("ViewFirstNComments")):(m?c.get("ViewPreviousNReplies"):c.get("ViewPreviousNComments"))).format(j))}}else{i=null}return i},_onClick:function(){var f=this,g=this.collection;if(this._masked!==true){this.mask();g.loadPreviousComments(g.getDefaultPageSize(),{onComplete:function(){f.unmask()},onFailure:function(){f.unmask()}})}},init:function(f){this._parent.apply(this,arguments);this.listenTo(this.collection,{onCollectionChange:this.render});this.listenTo(this.model,{"onChange:nbEndorses":this.render})},mask:function(){this._masked=true;if(this.container){d.mask(this.container,"")}},unmask:function(){this._masked=false;if(this.container){d.unmask(this.container)}}});return b});define("DS/SocialToolbar/Models/Contributions",["UWA/Core","DS/SocialToolbar/Models/BaseModel"],function(b,a){return a.extend({name:"contributions",idAttribute:"subjectUri",defaults:{subjectUri:null,currentUserEndorse:null,nbEndorses:null,nbReplies:null,comments:null,metas:null},parse:function(e,c){var d;if(!e){e={}}if(!e.metas){e.metas={}}if(!b.is(e.metas["X-3DComment-Has-Moderation-Rights"])){d=this._getResponseHeader(c,"X-3DComment-Has-Moderation-Rights");if(b.is(d)){e.metas["X-3DComment-Has-Moderation-Rights"]=d}}return e}})});define("DS/SocialToolbar/Collections/MediaCollection",["UWA/Core","UWA/Promise","DS/SocialToolbar/Collections/BaseCollection","DS/SocialToolbar/Models/Media","DS/SocialToolbar/Models/Annotation","DS/SocialToolbar/Utils/Media"],function(f,b,c,a,e,g){var d=c.extend({name:"media-collection",init:function(i,h){this._parent.apply(this,arguments)},model:function(h,i){if(h&&(h.mediaType===g.ANNOTATION_TYPE)){return new e(h,i)}else{return new a(h,i)}},uploadAllNewAnnotations:function(){var h=this;return new b.all(h.reduce(function(i,j){if(j instanceof e&&j.isNew()){i.push(j.upload())}return i},[]))},deleteAllAnnotations:function(){var h=this.filter(function(i){return(i instanceof e)}).map(function(i){return i.deleteAnnotation()});return new b.all(h)}});return d});define("DS/SocialToolbar/Views/InteractorTooltipView",["UWA/Core","DS/UIKIT/Mask","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Views/InteractorSmallListView","i18n!DS/SocialToolbar/assets/nls/social-toolbar"],function(f,e,a,c,d){var b=a.extend({_masked:false,name:"st-interactor-tooltip-view",defaultOptions:{tooltipLimit:10},domEvents:{},_showLoadingSpinner:function(g){if(!g||this.collection===g){this.mask()}},_hideLoadingSpinner:function(g){if(!g||this.collection===g){this.unmask()}},_createContent:function(){var h=this,g=this.collection,i=[this.components.reset({interactorSmallList:new c({collection:g,filterer:function(j){return(this.collection.indexOf(j)<h.options.tooltipLimit)}})}).interactorSmallList];if(this.options.tooltipLimit<this.collection.getTotalRecords()){i.push({tag:"span",html:d.andMore})}return i},init:function(g){this._parent.apply(this,arguments);this.listenTo(this.collection,{"onChange:totalRecordsState":this.render,onCollectionChange:this.render,onRequest:this._showLoadingSpinner,onSync:this._hideLoadingSpinner,onError:this._hideLoadingSpinner})},render:function(){this.dispatchEvent("onBeforeRender",[this]);return this._parent.apply(this,arguments)},mask:function(){this._masked=true;if(this.container){e.mask(this.container,"")}},unmask:function(){this._masked=false;if(this.container){e.unmask(this.container)}},onBeforeRender:function(){if(!this.collection.hasBeenFetched()){this._showLoadingSpinner()}}});return b});define("DS/SocialToolbar/Views/CountView",["UWA/Core","UWA/Utils/Client","DS/Logger/Logger","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Views/InteractorTooltipView","i18n!DS/SocialToolbar/assets/nls/social-toolbar","DS/UIKIT/Tooltip","DS/UIKIT/SuperModal","DS/UIKIT/Input/Button"],function(j,l,b,f,i,e,k,a,h){var g=null,d=a.extend({defaultOptions:{className:"st-interactor-modal"},destroy:function(){var o,n=this.modals,p;if(n){o=n.current;if(j.is(n.queue,"array")){for(var m=n.queue.length-1;m>=0;m--){p=n.queue[m];if(p&&p.elements&&p.elements.container&&p.elements.container.hasClassName("st-interactor-modal")){p.destroy()}}n.queue=[]}if(o){try{n.current=null;if(o&&o.elements&&o.elements.container&&o.elements.container.hasClassName("st-interactor-modal")){o.destroy()}}catch(q){}}}return this}}),c=f.extend({tagName:"span",name:"st-count",className:"st-counter",domEvents:{"click .st-counter-value":"onClick"},defaultOptions:{modalTitle:"",interactorCountAtInit:10},_getCount:function(){},_createContent:function(){var m=this._getCount(),n=j.is(m,"number")?String(m):"";if(!this.elements.counterValue){this.elements.counterValue=j.createElement("span",{"class":"st-counter-value",html:n})}else{this.elements.counterValue.setContent(n)}return this.elements.counterValue},_showModal:function(){var o=this.components.get("modal"),n=this.collection.getSubject().getSharedOptions(),m=new g({collection:this.collection,events:{onInfiniteScroll:function(){var q,r=this,s=this.collection;function p(){if(r.scrollView){r.scrollView.endLoading();r.scrollView.useInfiniteScroll(false)}}q={reset:false,add:true,remove:false,onComplete:function(){if(r.scrollView){r.scrollView.endLoading();try{if(s.hasNextPage()){r.scrollView.useInfiniteScroll(true)}else{r.scrollView.useInfiniteScroll(false)}}catch(t){b.error("Something went wrong...")}}},onFailure:p};if(!s.hasBeenFetched()&&(s.length===0)){s.getFirstPage(q)}else{if(s.hasNextPage()){s.getNextPage(q)}else{p()}}}}});m.render();this.components.addMap({interactorListViewWithScroller:m});if(!o){o=new d({renderTo:(window.widget&&window.widget.body)||document.body});o.addEvent("onHide",function(){this.getOption("interactorListViewWithScroller").destroy()});this.components.addMap({modal:o})}o.setOption("interactorListViewWithScroller",m);m.container.addEvent("click *[data-login]",function(p){n.dispatchEvent("onUserLinkClick",p);o.next()});o.dialog({title:this.getOption("modalTitle"),body:m})},init:function(m){this._parent.apply(this,arguments);if(!this.getOption("modalTitle")){throw new Error("Modal title is required")}},onBeforeRender:function(){if(this.components.get("modal")){this.components.get("modal").next()}},onRender:function(){var n,m,o="bottom";if(!this._getCount()){this.container.removeClassName("not-zero")}else{this.container.addClassName("not-zero")}if(!l.Features.touchEvents){if(!this.components.get("tooltip")){m=new i({model:this.model,collection:this.collection,tooltipLimit:this.getOption("interactorCountAtInit")});this.components.addMap({interactorTooltipView:m});n=new k({target:this.elements.counterValue,position:o,className:"st-interactor-tooltip",body:m,offset:{x:0,y:5},interactorTooltipView:m,events:{onShow:this.onTooltipShow.bind(this)}});this.components.addMap({tooltip:n});n.getContent().addEvent("resize",n.updatePosition.bind(n,o))}}},onTooltipShow:function(){var m=this.collection;if(!(m&&(m.hasBeenFetched()||m.isBeingFetched()))){m.setPageSize(this.getOption("interactorCountAtInit"),{first:true})}},onClick:function(){var m=this;if(!g){require(["DS/W3DXComponents/Views/Layout/NestedScrollView","DS/SocialToolbar/Views/InteractorListView"],function(o,n){g=o.extend({name:"st-interactor-list-scroll",nested:n});m._showModal()})}else{this._showModal()}}});return c});define("DS/SocialToolbar/Views/InteractorView",["UWA/Core","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Utils/Sprite"],function(d,c,b){var a=c.extend({name:"st-interactor",getClassNames:function(){return this._parent.apply(this,arguments)+" col-xs-12 col-sm-6"},domEvents:{},_renderUserPicture:function(){var e=this.model,f=this.model.collection;return b.renderUserPicture({cls:"st-user-picture",format:"normal",login:e.get("login"),swymUrl:(f?f.getSubject().getSharedOptions().getOption("3DSwymUrl"):"")})},_createContent:function(){var e=this.model;return[this._renderUserPicture(),{"class":"st-user-info",html:[{html:[{tag:"span","class":"st-fake-link","data-login":e.get("login"),html:e.getFullName()}]}]}]}});return a});define("DS/SocialToolbar/Views/InteractorListView",["UWA/Core","DS/SocialToolbar/Views/BaseCollectionView","DS/SocialToolbar/Views/InteractorView","DS/SocialToolbar/Utils/Sprite"],function(e,b,a,d){var c=b.extend({_ItemView:a,name:"st-interactor-list",domEvents:{},init:function(){this._parent.apply(this,arguments);if(this.collection){this.listenTo(this.collection,{onCollectionChange:function(){d.reloadUserPictures({el:this.container,swymUrl:this.collection.getSubject().getSharedOptions().getOption("3DSwymUrl")})}})}else{throw new Error("Collection is required")}},onRender:function(){d.reloadUserPictures({el:this.container,swymUrl:this.collection.getSubject().getSharedOptions().getOption("3DSwymUrl")})}});return c});define("DS/SocialToolbar/Views/EndorserCountView",["UWA/Core","DS/SocialToolbar/Views/CountView","i18n!DS/SocialToolbar/assets/nls/social-toolbar"],function(d,b,c){var a=b.extend({name:"st-endorser-count",defaultOptions:{modalTitle:c.get("PeopleWhoEndorseThis")},_getCount:function(){return this.collection.getTotalRecords()},init:function(e){this._parent.apply(this,arguments);this.listenTo(this.collection,{"onChange:totalRecordsState":this.render})}});return a});define("DS/SocialToolbar/Views/CommentCountView",["UWA/Core","DS/SocialToolbar/Views/CountView","i18n!DS/SocialToolbar/assets/nls/social-toolbar"],function(d,a,b){var c=a.extend({name:"st-comment-count",defaultOptions:{modalTitle:b.get("PeopleWhoCommentedThis")},_getCount:function(){return this.model.getCommentsTotalCount()},init:function(e){var f={};this._parent.apply(this,arguments);f["onChange:"+this.model.COMMENTS_COUNT_ATTRIBUTE]=this.render;this.listenTo(this.model,f)}});return c});define("DS/SocialToolbar/Collections/EndorsementCollection",["UWA/Core","DS/SocialToolbar/Collections/InteractionCollection","DS/SocialToolbar/Collections/EndorserCollection","DS/SocialToolbar/Models/Endorsement"],function(e,b,d,a){var c=b.extend({_mainRangeName:"endorses",name:"endorsement-collection",model:a,url:a.prototype.urlRoot,AuthorCollection:d});return c});define("DS/SocialToolbar/Mixins/Endorsable",["UWA/Core","DS/SocialToolbar/Collections/EndorsementCollection","DS/SocialToolbar/Collections/EndorserCollection","DS/SocialToolbar/Models/Endorsement"],function(e,c,d,a){var b={_endorsements:null,_endorsers:null,ENDORSEMENT_COUNT_ATTRIBUTE:"nbEndorses",defaults:{endorsements:null},_getUserInfo:function(){var f=e.is(this.getSubject,"function")?this.getSubject():this;return f.getSharedOptions().getUserInfo()},_updateTotalRecordsIfNotfetched:function(g,f){if(g&&!g.hasBeenFetched()){g.setTotalRecords(f)}},setEndorsements:function(f){this.getEndorsements().reset(f)},getEndorsements:function(){if(!this._endorsements){this._endorsements=new c(this.get("endorsements"),{target:this,targetInteractionCountAttr:this.ENDORSEMENT_COUNT_ATTRIBUTE,subject:e.is(this.getSubject,"function")?this.getSubject():this})}return this._endorsements},getEndorsers:function(){var f=this.getEndorsements();if(!this._endorsers){this._endorsers=f.getAuthors()}else{this._endorsers.add(f.getAuthorArray())}this._updateTotalRecordsIfNotfetched(this._endorsers,this.getEndorsementsTotalCount());return this._endorsers},getUserEndorseId:function(){return((this.get("currentUserEndorse")&&this.get("currentUserEndorse").endorseUri)||"me")},getEndorsementsTotalCount:function(){return this.get(this.ENDORSEMENT_COUNT_ATTRIBUTE)},endorse:function(h){var g,i=this,l=null,k=this.getEndorsements(),f=this.getEndorsers(),j=this.isEndorsed();if(!j){this.dispatchEvent("onBeforeEndorse",[this]);this.set("_endorsedByCurrentUser",true);k.changeTotalRecordsBy(1);g=this._getUserInfo();f.add(g);l=k.create({author:g},{at:0,onComplete:function(){i.set("currentUserEndorse",l.toJSON());i.dispatchEvent("onAfterEndorse",[this]);i.dispatchEvent("onEndorseSuccess",i)},onFailure:function(){k.changeTotalRecordsBy(-1);k.remove(l);f.remove(g.login);i.set({_endorsedByCurrentUser:false,currentUserEndorse:null});i.dispatchEvent("onAfterEndorse",[this]);require(["DS/UWPClientControls/PlatformNotify"],function(m){m.error(h)})}})}},unendorse:function(i){var o=-1,h=this,n,l=null,f=this.getEndorsements(),k=this.getEndorsers(),g=this.isEndorsed(),j=e.is(this.getSubject,"function")?this.getSubject():this,p=j.getSharedOptions().getUserInfo(),m=this.getUserEndorseId();if(g){l=f.find(function(q){return q.get("author").login===p.login});if(l){o=f.indexOf(l)}else{if(m){l=new a({endorseUri:m,author:p},{subject:j,target:this})}}if(l){this.dispatchEvent("onBeforeUnendorse",[this]);this.set("_endorsedByCurrentUser",false);f.changeTotalRecordsBy(-1);n=k.remove(p.login);l.destroy({onComplete:function(){h.dispatchEvent("onAfterUnendorse",[this]);h.dispatchEvent("onUnendorseSuccess",h)},onFailure:function(){f.changeTotalRecordsBy(1);if(o>=0){f.add(l,{at:o})}if(n){k.add(n,{at:(o>=0)?o:0})}h.set({_endorsedByCurrentUser:true,currentUserEndorse:l.toJSON()});h.dispatchEvent("onAfterUnendorse",[this]);require(["DS/UWPClientControls/PlatformNotify"],function(q){q.error(i)})}})}}},isEndorsed:function(){return e.is(this.get("_endorsedByCurrentUser"),"boolean")?this.get("_endorsedByCurrentUser"):e.is(this.get("currentUserEndorse"))},"onChange:endorsements":function(f,g){if(this._endorsements){this.setEndorsements(g)}},"onChange:nbEndorses":function(g,f){var h=this.getEndorsementsTotalCount();if(this._endorsers){this._endorsers.setTotalRecords(h)}if(this._endorsements){this._endorsements.setTotalRecords(h)}},clean:function(){if(this._endorsers){this._endorsers.clean();this._endorsers=null}if(this._endorsements){this._endorsements.clean();this._endorsements=null}return this._parent.apply(this,arguments)}};return b});define("DS/SocialToolbar/Collections/CommentCollection",["UWA/Core","DS/SocialToolbar/Mixins/Endorsable","DS/SocialToolbar/Mixins/Commentable","DS/SocialToolbar/Models/Interaction","DS/SocialToolbar/Collections/InteractionCollection","DS/SocialToolbar/Collections/CommenterCollection"],function(k,c,a,f,b,m){var h="reverse_time",j="nbReplies",g={ACTIVE:"active",DELETED:"deleted"},l={NOT_MODERATED:"notModerated",MODERATED_BY_AUTHOR:"moderatedByAuthor",MODERATED_BY_ADMIN:"moderatedByAdmin"},i={NOT_MODERATED:"notModerated",EDITED_BY_AUTHOR:"editedByAuthor",EDITED_BY_ADMIN:"editedByAdmin",DELETED:"deleted"};var e=f.extend(c,a,{COMMENTS_COUNT_ATTRIBUTE:j,ACCESS_STATE:g,MODERATION_STATE:l,MODERATION_STATE_FOR_UI:i,_parentComment:null,name:"comment",defaults:{commentUri:null,parentCommentUri:null,richMessage:"",moderationState:null,accessState:null},idAttribute:"commentUri",urlRoot:function(){return this.getSubject().url()+"/comments"},init:function(o,n){this.CommentCollection=d;this._parent.apply(this,arguments);this._previous.apply(this,arguments);if(n&&n.parentComment){this.setParentComment(n.parentComment)}},getParentComment:function(){var n=this.get("parentCommentUri");if(this._parentComment){return this._parentComment}else{if(n){window.console.warn("Parent comment could not been found. A new instance will be created.");return new this.constructor({commentUri:n})}else{return null}}},setParentComment:function(n){this._parentComment=n;this.set("parentCommentUri",n.get("commentUri"))},getModerationState:function(){var n=this.get("moderationState"),o=this.get("accessState");switch(o){case g.DELETED:return i.DELETED;case g.ACTIVE:switch(n){case l.MODERATED_BY_AUTHOR:return i.EDITED_BY_AUTHOR;case l.MODERATED_BY_ADMIN:return i.EDITED_BY_ADMIN;default:break}break;default:break}return i.NOT_MODERATED},hasBeenDeleted:function(){return(this.getModerationState()===i.DELETED)},canBeModerated:function(n){var q,p=false,o;if(!this.hasBeenDeleted()){if((!n||n.canBeModeratedIfAuthor!==false)&&(this.getSubject().getSharedOptions().getOption("userLogin")===this.getAuthor().get("login"))){p=true}else{o=this.collection&&this.collection.canBeModerated();p=o;if(!k.is(o,"boolean")){q=this.getParentComment();if(q){p=q.canBeModerated({canBeModeratedIfAuthor:false})}}}}return p}});var d=b.extend({_userHasSpecialModerationRights:null,name:"comment-collection",model:e,AuthorCollection:m,_prepareModel:function(o,n){var p=n||{};if(this._target&&(this._target instanceof this.model)){p.parentComment=this._target}return this._parent.call(this,o,p)},_getModerationRightsUrl:function(){return this.getSubject().url()+"/moderationrights"},_getNbCommentsToLoadToCompleteCurrentPage:function(n){if(!k.is(n,"number")){n=this.getDefaultPageSize()}return Math.min(this.getSubject().getCommentsTotalCount(),n*(this.state.currentPage+(this.state.firstPage===0?1:0)))-this.length},getDefaultPageSize:function(){return this.defaultOptions.state.pageSize},url:function(){if(this._target&&(this._target!==this._subject)){return this.getSubject().url()+"/comments/"+this._target.get("commentUri")}return this.model.prototype.urlRoot.call(this)},fetch:function(n){var o=n||{};if(!o.data){o.data={}}o.data.order_by=h;return this._parent.call(this,o)},parseHeadersForStateUpdate:function(s,p,q,n){var r=this._parent.apply(this,arguments),o=this._getResponseHeader(n,"X-3DComment-Has-Moderation-Rights");if(k.is(o)){this._userHasSpecialModerationRights=o}return r},canBeModerated:function(){switch(this._userHasSpecialModerationRights){case"true":return true;case"false":return false;default:return null}},getCommentModerationRights:function(n){var q,r=this,p=this.getSubject(),o=k.clone(n,false);if(!k.is(o,"object")){o={}}q=o.onComplete;o.onComplete=function(s){if(k.is(s,"boolean")){r._userHasSpecialModerationRights=s+""}if(q){q.apply(this,arguments)}};o.url=this._getModerationRightsUrl();p.sync("read-moderationrights",p,o)},loadPreviousComments:function(o,p){var q,n=false,s=null,r=this.length;if(!k.is(o,"number")){o=this.getDefaultPageSize()}s=(this.length%o);s=((s>=0)?s:0);q=k.extend({at:0,reset:false,add:true,remove:false,data:{offset:((r>0)?r:undefined)}},p,true);if(s!==this.state.baseOffset){n=true;this.state.baseOffset=s}if(this.state.pageSize!==o){this.setPageSize(o,q)}else{if(n===true){this.getFirstPage(q)}else{if(this._getNbCommentsToLoadToCompleteCurrentPage(o)>0){this.getPage(this.state.currentPage,q)}else{this.getNextPage(q)}}}}});d.COMMENTS_ORDER=h;return d});define("DS/SocialToolbar/Collections/ContributionsCollection",["UWA/Core","DS/Logger/Logger","DS/SocialToolbar/Collections/BaseCollection","DS/SocialToolbar/Models/Contributions","DS/SocialToolbar/Collections/CommentCollection"],function(f,b,a,g,c){var d={},h={"1":"time","-1":"reverse_time"},i=10;d[h["1"]]="1";d[h["-1"]]="-1";var e=a.extend({name:"contribution-collection",model:g,defaultOptions:{tenantId:null,serviceUrl:"",subjectUris:null,state:{pageSize:2,sortKey:"time",order:d[c.COMMENTS_ORDER]},queryParams:{order:"order_by",sortKey:"sort_by",directions:h}},_executePostInitInstructions:function(){var j=this.getOption("subjectUris");if(!this.getOption("tenantId")){throw new Error("Tenant (online instance) ID is required")}if(!this.getOption("serviceUrl")){throw new Error("Service URL is required")}if(!f.is(j,"array")||(j.length===0)){throw new Error("Subjects URIs are required")}if(j.length>i){throw new Error("The number of Subject URIs exceeds the maximum authorized which is: "+i)}},url:function(){return this.getOption("serviceUrl")+"/commentproxy/subjects/"+this.getOption("subjectUris").join(",")+"/contributions"},parseRecords:function(m,k){var j=m;if(k.subjectUris){j=[];if(f.is(m,"object")){if(k.subjectUris.length===1){m.subjectUri=k.subjectUris[0];j.push(m)}else{if(k.subjectUris.length>1){for(var l in m){if(m.hasOwnProperty(l)){m[l].subjectUri=l;j.push(m[l])}}}}}}return j},fetch:function(j){var k=j||{};if(!k.onFailure){k.onFailure=function(){b.error("Failed to retrieve contributions")}}k.subjectUris=this.getOption("subjectUris");k.data=k.data||{};k.data.tenant=this.getOption("tenantId");return this._parent.call(this,k)}});e.MAX_NB_SUBJECTS=i;return e});define("DS/SocialToolbar/CallMutualizer",["UWA/Core","UWA/Utils","UWA/Class/Events","UWA/Class/Options","DS/SocialToolbar/Collections/ContributionsCollection","DS/Logger/Logger"],function(g,d,m,i,f,b){var h=false,a=null,c={},j={},e=[],l=f.MAX_NB_SUBJECTS;var k=m.singleton(i,{init:function(){this.setOptions();this._parent.apply(this,arguments);this._previous.apply(this,arguments);var o=function(){var r;if(h===true){h=false}if(e.length>0){r=e.shift();this.openCallWindow(r)}}.bind(this),q=function(){var u=this,r,v,s=this.options,t=d.getUUID();r=Object.keys(a);if(h&&this.getOption("nbInitCallsToMutualize")===r.length){o();if(r.length>0){j[t]=[].concat(r);v=new f([],{tenantId:s.tenantId,serviceUrl:s.serviceUrl,subjectUris:r});v.setPageSize(g.is(s.commentsNumberAtInit,"number")?s.commentsNumberAtInit:5,{onComplete:function(){var w;v.toJSON().forEach(function(x){w=x.subjectUri;c[w]=x;u.dispatchEvent("onContributionsFetch:"+w,[x]);c[w]=null;delete a[w]});delete j[t];q()},onFailure:function(){b.error("Failed to retrieve contributions");r.forEach(function(w){u.dispatchEvent("onContributionsFetchFailure:"+w);delete a[w]});delete j[t]}})}}}.bind(this),n=function(v){var r;if(!g.is(v)){throw new Error("subjectURI is required")}if(!h){return null}var u,t=false,s=this.getOption("nbInitCallsToMutualize");if(a[v]!==true){u=Object.keys(a).length;if(u<s){if(u===(s-1)){t=true}a[v]=true}else{t=true}}r=(a[v]===true);if(t){q()}return r}.bind(this),p=function(s){for(var r in j){if(j.hasOwnProperty(r)){if(j[r].indexOf(s)>=0){return true}}}return false}.bind(this);this.getContributions=function(s,z,t,v){var x=this,r=null,y=h,w=undefined,u=undefined;if(typeof(z)!=="function"){throw new Error("Provided callback is not valid!")}if((v!==true)&&(n(s)===false)){return false}r=c[s];if(r){z.call(null,r)}else{if(y||p(s)){w=function(){if(u){x.removeEvent("onContributionsFetchFailure:"+s,u)}x.getContributions.call(x,s,z,null,true)};this.addEventOnce("onContributionsFetch:"+s,w);if(typeof(t)==="function"){u=function(){x.removeEvent("onContributionsFetch:"+s,w);t.call(null)};this.addEventOnce("onContributionsFetchFailure:"+s,u)}}else{return false}}return true};this.modifyCallWindowSizeBy=function(u){var t,s,r;if((u===0)||!g.is(u,"number")||(u!==parseInt(u,10))){throw new Error("`difference` option is either missing or invalid")}if(h===false){console.warn("Call window is closed");return false}if(u>0){this.openCallWindow(g.extend(g.clone(this.options,false),{nbInitCallsToMutualize:u}))}else{s=e.length;if(s>0){r=e[s-1];r.nbInitCallsToMutualize+=u;if(r.nbInitCallsToMutualize===0){e.pop()}}else{t=this.getOption("nbInitCallsToMutualize")+u;if(t>0){this.setOption("nbInitCallsToMutualize",t);if(Object.keys(a).length>=t){q()}}else{if(t===0){this.setOption("nbInitCallsToMutualize",null);h=false}}}}}},defaultOptions:{tenantId:null,serviceUrl:"",commentsNumberAtInit:5,nbInitCallsToMutualize:null},openCallWindow:function(n){var p=0,o=g.clone(n,false);if(!g.is(o.nbInitCallsToMutualize,"number")){throw new Error("Number of calls to mutualize, is required")}if(o.nbInitCallsToMutualize>l){console.warn("Maximum number of calls to mutualize should not exceed "+l);p=o.nbInitCallsToMutualize-l;o.nbInitCallsToMutualize=l}if(!o.tenantId){throw new Error("Tenant ID is required")}if(!o.serviceUrl){throw new Error("ServiceUrl ID is required")}if(!(o.nbInitCallsToMutualize>0)){throw new Error("`nbInitCallsToMutualize` option is supposed to be strictly positive")}if(h===true){e.push(o)}else{h=true;a={};this.setOptions.call(this,o)}if(p>0){this.openCallWindow(g.merge({nbInitCallsToMutualize:p},o))}}});k.init();return k});define("DS/SocialToolbar/Models/Subject",["UWA/Core","DS/Logger/Logger","DS/SocialToolbar/Models/BaseModel","DS/SocialToolbar/Mixins/Endorsable","DS/SocialToolbar/Mixins/Commentable","DS/SocialToolbar/Collections/CommentCollection","DS/SocialToolbar/Collections/ContributionsCollection","DS/SocialToolbar/CallMutualizer"],function(g,c,h,d,a,e,f,i){var b=h.extend(d,a,{_populated:false,_failedToFetchContributions:false,_sharedOptions:null,name:"subject",idAttribute:"subjectUri",CommentCollection:e,defaults:{subjectUri:null,currentUserEndorse:null,nbEndorses:null,nbComments:null},init:function(k,j){this._parent.apply(this,arguments);this._previous.apply(this,arguments);if(j){if(j.sharedOptions){this._sharedOptions=j.sharedOptions}else{throw new Error("Shared options are missing")}}},urlRoot:function(){return(this.getSharedOptions().getOption("serviceUrl")+"/commentproxy/subjects")},_storeContributionsData:function(k){var l=this.getComments(),j=g.clone(k,false);delete j.metas;delete j.comments;this.set(k);this._populated=true;this._failedToFetchContributions=false;l.setTotalRecords(this.get("nbComments"));l.reset(k.comments,{parse:true,responseHeaders:{"X-3DComment-Has-Moderation-Rights":k.metas&&k.metas["X-3DComment-Has-Moderation-Rights"]}});l.dispatchEvent("onSync",[l,{result:k.comments},{}]);this.dispatchEvent("onPopulate",[this])},_onContributionsFetchFailure:function(){this._failedToFetchContributions=true;this.dispatchEvent("onContributionsFetchFailure")},fetchContributions:function(l,o,k){var m,p,n=this,r,j=this.get("subjectUri"),q=this.getSharedOptions();this._failedToFetchContributions=false;if((o!==true)||(i.getContributions(j,this._storeContributionsData.bind(this),this._onContributionsFetchFailure.bind(this))===false)){m=n.getComments();r=n.getCommentsTotalCount();if((k===true)||(!m.hasBeenFetched()||(l<r))){p=new f([],{tenantId:q.getOption("tenantId"),serviceUrl:q.getOption("serviceUrl"),subjectUris:[this.get("subjectUri")]});p.setPageSize(l,{onComplete:function(s){n._storeContributionsData(s.toJSON()[0])},onFailure:function(){this.dispatchEvent("onPopulate",[this]);c.error("Failed to retrieve contributions");n._onContributionsFetchFailure()}.bind(this)})}}},hasBeenPopulated:function(){return this._populated},hasFailedToFetchContributions:function(){return this._failedToFetchContributions},getSharedOptions:function(){return this._sharedOptions}});return b});define("DS/SocialToolbar/Views/ActionToolbarView",["UWA/Core","UWA/Utils/Client","DS/UIKIT/Input/Button","DS/SocialToolbar/Controls/ResponsiveButtonTooltip","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Views/CommentCountView","DS/SocialToolbar/Views/EndorserCountView","DS/SocialToolbar/Models/Endorsement","DS/SocialToolbar/Models/Subject","i18n!DS/SocialToolbar/assets/nls/social-toolbar"],function(e,i,d,j,c,g,f,m,a,b){var l=500,k=300,h=c.extend({_ignoreEndorseBtnClick:false,_lightMode:false,name:"st-action-toolbar",getClassNames:function(){return this._parent.apply(this,arguments)+" st-small-size"},domEvents:{resize:"_onResize","click .st-endorse-btn":"_onEndorseButtonClick","click .st-reply-btn":"_onCommentButtonClick"},defaultOptions:{mode:"normal",enableShare:true,enableComment:true,enableLike:true},_onResize:function(){var n;if(this.container){n=this.container.getSize();if(n.width<k){this.container.addClassName("st-ultra-small-size");this.container.removeClassName("st-small-size")}else{if(n.width<l){this.container.addClassName("st-small-size");this.container.removeClassName("st-ultra-small-size")}else{this.container.removeClassName("st-ultra-small-size");this.container.removeClassName("st-small-size")}}}},_onEndorseButtonClick:function(){if(this._ignoreEndorseBtnClick!==true){var n=this.model;if(!n.isEndorsed()){n.endorse((n instanceof a)?b.SorryTheContentCouldNotBeEndorsed:b.SorryTheCommentCouldNotBeEndorsed)}else{n.unendorse((n instanceof a)?b.SorryTheContentCouldNotBeUnendorsed:b.SorryTheCommentCouldNotBeUnendorsed)}this.dispatchEvent("onEndorseButtonClick")}},_onCommentButtonClick:function(n){if(n){n.preventDefault();n.stopPropagation()}this.dispatchEvent("onCommentButtonClick")},_getCustomNls:function(q,o){var p=this.model,r,n;if(p){if(p instanceof a){r=p}else{r=p.getSubject()}n=r.getSharedOptions().getOption(q);if(e.is(n,"string")){return n}}return o},_getEndorseNls:function(){return this._getCustomNls("endorseNls",b.Endorse)},_getUnendorseNls:function(){return this._getCustomNls("unendorseNls",b.Unendorse)},_createLightActionSection:function(){var r=[],p=this.model,q,n,o=parseInt(p.get("nbReplies"));if(this.getOption("enableLike")===true){q=parseInt(p.getEndorsementsTotalCount());r.push({tag:"span","class":"st-endorse-btn st-fake-link",html:(p.isEndorsed()?this._getUnendorseNls():this._getEndorseNls())});if(q>0){n=new f({model:this.model,collection:this.model.getEndorsers(),modalTitle:b.get("PeopleWhoEndorseThisComment")});n.container.addClassName("st-fake-link st-detail-with-separator");this.components.addMap({endorserCountView:n});r.push(n)}r.push({tag:"span","class":"st-detail",html:" - "})}r.push({tag:"span","class":"st-reply-btn st-fake-link",html:b.Reply});if(o>0){r.push({tag:"span","class":"st-detail st-detail-with-separator",html:o})}return r},_getCounter:function(n){return e.is(n,"number")?String(n):"&nbsp;"},_createContent:function(){var q=this,p=this.model,u={},r={},v={},n,w,t="bottom",o=null,s=null;if(this._lightMode===true){return this._createLightActionSection()}else{n=p.isEndorsed();if(this.getOption("enableComment")!==false){r["comment-button"]=new d({icon:"comment",className:"default st-reply-btn",value:b.Comment});s=new g({model:this.model,collection:this.model.getCommenters()});u.commentCountView=s;if(!i.Features.touchEvents){v.commentBtnTooltip=new j({target:r["comment-button"].getContent(),position:t,body:b.Comment,offset:{x:0,y:5}})}}if(this.getOption("enableShare")!==false){r["share-button"]=new d({icon:"forward",className:"default st-share-btn",value:b.Share,events:{onClick:function(){q.dispatchEvent("onShareButtonClick")}}});if(!i.Features.touchEvents){v.shareBtnTooltip=new j({target:r["share-button"].getContent(),position:t,body:b.Share,offset:{x:0,y:5}})}}if(this.getOption("enableLike")!==false){w=(n?this._getUnendorseNls():this._getEndorseNls());r["endorse-button"]=new d({icon:"thumbs-up",className:"default st-endorse-btn"+(n?" st-highlighted":"")+(this._ignoreEndorseBtnClick?" st-ignore-clicks":""),value:w});o=new f({model:this.model,collection:this.model.getEndorsers()});u.endorserCountView=o;if(!i.Features.touchEvents){v.endorseBtnTooltip=new j({target:r["endorse-button"].getContent(),position:t,body:w,offset:{x:0,y:5}})}}this.components.reset(r);this.components.addMap(u);if(!i.Features.touchEvents){this.components.addMap(v)}return{"class":"st-action-toolbar-buttons",html:[(r["endorse-button"]?{"class":"st-btn-wrapper st-endorse-btn-wrapper",html:[r["endorse-button"],o]}:null),(s?{"class":"st-btn-wrapper st-reply-btn-wrapper",html:[r["comment-button"],s]}:null),(r["share-button"]?{"class":"st-btn-wrapper st-share-btn-wrapper",html:r["share-button"]}:null)]}}},_startIgnoringEndorseBtnClick:function(){var n=this.getElement(".st-endorse-btn");if(n){n.addClassName("st-ignore-clicks");if(n.match("button")){n.disabled=true}}this._ignoreEndorseBtnClick=true},_stopIgnoringEndorseBtnClick:function(){var n=this.getElement(".st-endorse-btn");if(n){n.removeClassName("st-ignore-clicks");if(n.match("button")){n.disabled=false}}this._ignoreEndorseBtnClick=false},_updateEndorseButton:function(n){var p=this.model.isEndorsed(),q=(this._lightMode===true)?this.getElement(".st-endorse-btn"):this.components.get("endorse-button"),o=(this._lightMode===true)?null:this.components.get("endorseBtnTooltip");if(!(n&&n.stopIgnoringEndorseBtnClick===false)){this._stopIgnoringEndorseBtnClick()}if(q){if(this._lightMode===true){q.setContent(p?this._getUnendorseNls():this._getEndorseNls())}else{if(p){q.setValue(this._getUnendorseNls());q.getContent().addClassName("st-highlighted");if(o){o.setBody(this._getUnendorseNls())}}else{q.setValue(this._getEndorseNls());q.getContent().removeClassName("st-highlighted");if(o){o.setBody(this._getEndorseNls())}}}}},_updateDisplayedInfo:function(){if(this._lightMode===true){this.render()}},init:function(){this._parent.apply(this,arguments);var o,n=this.model;if(n){o={"onChange:_endorsedByCurrentUser":this._updateEndorseButton.bind(this,{stopIgnoringEndorseBtnClick:false}),onBeforeEndorse:this._startIgnoringEndorseBtnClick,onAfterEndorse:this._stopIgnoringEndorseBtnClick,onBeforeUnendorse:this._startIgnoringEndorseBtnClick,onAfterUnendorse:this._stopIgnoringEndorseBtnClick,onEndorseSuccess:this._onEndorseSuccess,onUnendorseSuccess:this._onUnendorseSuccess};if(n instanceof a){if(!n.hasBeenPopulated()){o.onPopulate=this._updateEndorseButton;this._startIgnoringEndorseBtnClick()}}else{this._lightMode=true;this.container.addClassName("st-light");o["onChange:nbEndorses"]=o["onChange:nbReplies"]=this._updateDisplayedInfo}this.listenTo(n,o)}else{throw new Error("Model is required.")}},_onEndorseSuccess:function(n){this.dispatchEvent("onEndorseSuccess",n)},_onUnendorseSuccess:function(n){this.dispatchEvent("onUnendorseSuccess",n)},getTotalNumberOfLikes:function(){return this.model.getEndorsementsTotalCount()},disableCommentButton:function(){var n=this.components.get("comment-button");if(n){n.disable()}},enableCommentButton:function(){var n=this.components.get("comment-button");if(n){n.enable()}}});return h});define("DS/SocialToolbar/Views/MediaListView",["UWA/Core","DS/SocialToolbar/Views/BaseCollectionView","DS/SocialToolbar/Views/MediaView","DS/SocialToolbar/Views/AnnotationView","DS/SocialToolbar/Utils/Media"],function(e,a,c,d,f){var b=a.extend({_ItemView:c,name:"st-media-list",domEvents:{},defaultOptions:{mediaViewsOptions:null},getItemView:function(h){var g={};if(this.options&&this.options.mediaViewsOptions){g.defaultOptions=this.options.mediaViewsOptions}if(h&&(h.get("source")===f.DEFAULT_MEDIA_SOURCE)&&(h.get("mediaType")===f.ANNOTATION_TYPE)){return d.extend(g)}else{return c.extend(g)}},init:function(g){if(g&&g.mediaViewsOptions){this._ItemView=c.extend({defaultOptions:g.mediaViewsOptions})}this._parent.apply(this,arguments);if(!this.collection){throw new Error("Collection is required")}this.listenTo(this.children,{onMediaRemoval:function(h){this.dispatchEvent("onMediaRemoval",[h])}})}});return b});define("DS/SocialToolbar/Views/BaseCommentMediaListWrapperView",["UWA/Core","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Views/MediaListView","DS/SocialToolbar/Utils/Media","DS/SocialToolbar/Collections/MediaCollection"],function(e,b,a,f,d){var c=b.extend({_getMediaListToDisplay:function(j,i){var h=this.components.get("mediaList"),k=(e.is(j,"string")?j:(this.model&&this.model.get("richMessage")||"")),g=f.getMediaData(k);if(this.model){i=i||{};i.subject=i.subject||this.model.getSubject()}if(!h){if(g.length===0){h=""}else{h=new a({collection:new d(g,i),mediaViewsOptions:this.getOption("mediaViewsOptions")});this.components.addMap({mediaList:h})}}else{h.collection.reset(g,i)}return h},getMediaCollection:function(){var g=this.components.get("mediaList");return g&&g.collection}});return c});define("DS/SocialToolbar/Views/CommentEditorView",["UWA/Core","UWA/Event","UWA/Promise","UWA/Utils/Client","DS/UWPClientCode/I18n","DS/SocialToolbar/Mixins/InlineEditor","DS/SocialToolbar/Views/BaseCommentMediaListWrapperView","DS/SocialToolbar/Utils/Date","DS/SocialToolbar/Utils/Media","DS/SocialToolbar/Utils/MessageBus","i18n!DS/SocialToolbar/assets/nls/social-toolbar","DS/UIKIT/Input/Text","DS/UIKIT/Input/Button","DS/UIKIT/Tooltip","DS/Logger/Logger"],function(b,d,g,u,k,o,j,f,s,v,m,c,n,t,w){var e=null,h=null,r=null,q="div",p="data-generated-by-rte",a=q+"["+p+"]",i=("br;p{*};i{*};u{*};s{*};strike{*};em{*};strong{*};b{*};a[class,data-login,data-users-group-uri,href,target,contenteditable](*);img[data-uri,data-source,data-media-id,data-media-type];"),l=j.extend(o,{_rteReady:false,_lastKnownCursorPosition:null,name:"st-comment-editor",rte:null,defaultOptions:{richMode:false,creationMode:true,parentComment:null,showRteOnDOMInjection:false,mediaViewsOptions:{editMode:true}},domEvents:{"keyup .st-text-editor":"_onKeyUp","keydown .st-text-editor":"_onKeyDown","mousedown .st-text-editor":"_onMouseDown","click .st-text-editor":"_onFocusIn","focusin .st-text-editor":"_onFocusIn","focusout .st-text-editor":"_onFocusOut","click .st-rte-media-attach-btn":"_onOpenMediaLibraryRequest","mousedown .st-comment-cancel-link .st-fake-link":"cancelEdition"},_onFocusIn:function(x){var y=this;if(!u.Features.touchEvents){this.container.addClassName("show-long-msg")}this._setLastActiveEditor(this);if(this.options.richMode===true&&!this.rte){setTimeout(function(){y._lastKnownCursorPosition=y._getCursorPosition();y.addEventOnce("onRteReady",y._placeCursorAtlastKnownPosition);y._showRTE()},0)}},_onFocusOut:function(x){this.container.removeClassName("show-long-msg")},_onKeyUp:function(z){var x,y=(d.whichKey(z)==="return");x=this._parent.apply(this,arguments);if(y===true){z.preventDefault();z.stopPropagation();x=false}return x},_onKeyDown:function(y){var x=d.whichKey(y);if(x==="return"){this.saveComment();y.preventDefault();y.stopPropagation();return false}if(x==="esc"){if(y.currentTarget===d.getElement(y)){this.cancelEdition()}}return true},_onKeyDownOnRte:function(z){var y,x=this._getDomEventFromEditorEvent(z);if(x){y=this._onKeyDown(x);if(!y){z.cancel();return false}}},_onPaste:function(){},_onOpenMediaLibraryRequest:function(){},init:function(){this._onFocusIn=this._onFocusIn.bind(this);this._onFocusOut=this._onFocusOut.bind(this);this._parent.apply(this,arguments);if(this.options.creationMode!==false){this.container.addClassName("st-creation")}this.listenToOnce(v,"onBeforeCKEditorLoad",this._onBeforeCKEditorLoad);this.listenToOnce(v,"onAfterCKEditorLoad",this._onAfterCKEditorLoad);this.listenTo(this.components,{onMediaRemoval:this.placeCursorAt});if(!e){this.addEventOnce("onInjected",this._loadCKE)}},_getDomEventFromEditorEvent:function(x){return x.data&&x.data.domEvent&&x.data.domEvent.$},_getTextAreaId:function(){return"st-comment-editor-"+this.cid},_getSubject:function(){var x=this.collection||this.model;if(!x){throw new Error("This was not supposed to happen...")}return x.getSubject()},_getSharedOptions:function(){return this._getSubject().getSharedOptions()},_setLastActiveEditor:function(x){this._getSharedOptions().setLastActiveEditor(x)},_getMediaHtmlToSave:function(){var x=this.components.get("mediaList");if(!x){return""}return x.collection.reduce(function(y,A){var z={uri:A.get("uri"),source:A.get("source"),mediaType:(A.get("mediaType")===s.ANNOTATION_TYPE)?A.get("mediaType"):undefined};if(!z.uri){throw new Error("Media URI is missing")}if(!z.source){throw new Error("Media source is missing")}return(y+'<img data-uri="'+z.uri+(z.mediaType?('" data-media-type="'+z.mediaType):"")+'" data-source="'+z.source+'" />')},"")},_getMediaHtmlFromMediaList:function(){var x=this.components.get("mediaList");if(!x){return""}return x.collection.reduce(function(y,C){var z=C.get("mediaType"),A=C.get("uri"),B=C.get("source");if(!B){throw new Error("Media source is missing")}else{if(!(A)&&(z===s.ANNOTATION_TYPE)){return y+C.getHtml()}else{if(A){return(y+'<img data-uri="'+A+(z?('" data-media-type="'+z):"")+'" data-source="'+B+'" />')}else{throw new Error("Media uri or file is missing")}}}},"")},_createContent:function(){var y=b.createElement("div",{id:this._getTextAreaId(),contenteditable:"true","class":"form-control st-text-editor"+(this.getOption("parentComment")?" input-sm":""),"data-placeholder":(this.getOption("parentComment")?m.get("Write a reply..."):m.CommentPlaceHolder),html:this._getMessageToDisplay()}),A=b.createElement("div",{"class":"st-rte-media-attach-btn",html:{tag:"span","class":"fonticon fonticon-attach"}}),z=b.createElement("div",{"class":"st-text-editor-container",html:[y,A,{"class":"st-media-list-editor",html:this._getMediaListToDisplay()}]}),x=b.createElement("div",{"class":"st-btn st-comment-cancel-link",html:[{tag:"span","class":"st-long-msg",html:m.PleaseClickOnEscapeToCancelHtml.format('<span class="st-fake-link">',"</span>")},{tag:"span","class":"st-short-msg st-fake-link",html:m.Cancel}]});this.elements.textEditor=y;this.elements.textEditorContainer=z;this.elements.cancelLinks=x;this.components.addMap({attachmentIconTooltip:new t({target:A,body:m.AddMedia})});return[z,{"class":"st-editor-footer",html:[x]}]},_getEditorElement:function(){return this.elements.textEditor},_getEditorContent:function(){var x=this._getEditorElement();if(x){return x.getHTML()}return""},_getUnwrappedMessage:function(y){var z,x;if(b.is(y,"string")){z=y}else{z=this.model&&this.model.get("richMessage");if(b.is(z,"string")){x=b.createElement("div",{html:z}).getElement(a);if(x){z=x.getHTML()}}else{z=(u.Engine.firefox||u.Engine.ie)?"<p><br></p>":""}}return z},_getMessageToDisplay:function(x){return this._getUnwrappedMessage(x)},_filterContent:function(z,y){if(!e){throw new Error("CKEditor has not been loaded yet")}if(!z){return""}var A=new e.htmlParser.basicWriter(),x=new e.htmlParser.fragment.fromHtml(z,undefined,false);new e.filter(y).applyTo(x);x.writeHtml(A);return A.getHtml()},_setRteData:function(y){var x=this;if(this.rte){this.rte.setData(this._filterContent(y,this.extraAllowedContent),function(){x.dispatchEvent("onSetRTEData")})}},_updateEditorContent:function(y){if(this._rendered){var z,A=this._getMessageToDisplay(y),x=this.getElement(".st-media-list-editor");if(this.options.richMode===true&&this._rteReady){this._setRteData(A)}else{this._getEditorElement().setContent(A)}this._handlePlaceholderVisibility();if(x){z=this._getMediaListToDisplay(y,{subject:this._getSubject()});if(z&&b.is(z.inject,"function")){x.empty();z.inject(x)}else{x.setContent((z&&z.container)||z)}}}},_onBeforeCKEditorLoad:function(){if(this.elements.textEditor){this.elements.textEditor.setAttribute("contenteditable","false")}},_onAfterCKEditorLoad:function(){if(this.elements.textEditor){this.elements.textEditor.setAttribute("contenteditable","true")}},_handlePlaceholderVisibility:function(){if(this._isEditorEmpty()){this.container.addClassName("st-show-placeholder")}else{this.container.removeClassName("st-show-placeholder")}},_loadCKE:function(x){v.dispatchEvent("onBeforeCKEditorLoad");require(["DS/CKEditor/CKEditor"],function(y){e=y;e.disableAutoInline=true;e.on("dialogDefinition",function(A){var C,B,F=[],z=[],D=undefined,E=A.data.definition;if((A.editor.name.indexOf("st-comment-editor")===0)&&(A.data.name==="link")){E.removeContents("target");B=E.getContents("info").get("linkType").items;if(B){B.forEach(function(G){switch(G[1]){case"url":case"email":F.push(G);break;default:break}});B.splice(0);F.forEach(function(G){B.push(G)})}if(E.onShow){D=E.onShow}E.onShow=function(){var G=this.commitContent;this.commitContent=function(I){var H=Array.prototype.slice.call(arguments);if(!I.target){I.target={}}I.target.type="_blank";I.target.name="_blank";H[0]=I;return G.apply(this,H)};if(D){return D.apply(this,arguments)}};C=E.getContents("info").get("protocol").items;if(C){C.forEach(function(G){switch(G[1]){case"http://":case"https://":case"ftp://":z.push(G);break;default:break}});C.splice(0);z.forEach(function(G){C.push(G)})}}});v.dispatchEvent("onAfterCKEditorLoad");if(b.is(x,"function")){x.call()}})},_showRTE:function(){var z,A,x=this,y=this._getEditorElement();if(this.options.richMode!==true){return this}if(!this._inPage){this.addEventOnce("onInjected",this._showRTE);return this}if(y&&!this.rte){z=this._getEditorContent();A=function(){var D,C=x.rte,B=x._handlePlaceholderVisibility.bind(x);r=b.extend(b.clone(e.config),{title:false,removePlugins:"elementspath,magicline",removeButtons:"Subscript,Superscript",disableNativeSpellChecker:false,language:k.getCurrentLanguage(),extraAllowedContent:i,toolbar:[{name:"basicstyles",groups:["basicstyles","cleanup"],items:["Bold","Italic","Underline","Strike","-","RemoveFormat"]},{name:"links",items:["Link","Unlink"]}],on:{paste:function(E){x._onPaste(E);var H=E.data,F=E.editor.dataProcessor,G=new e.filter(i);H.dataValue=F.toHtml(H.dataValue,{filter:G,fixForBody:false})},customConfigLoaded:function(E){E.editor.config.removeButtons="Subscript,Superscript"}}});if(x.collection||x.model){D=b.extend(b.clone(r,false),x.getTopLevelComponent().getOption("RTEConfig")||{})}else{D=b.clone(r,false)}x.extraAllowedContent=D.extraAllowedContent;D.on.contentDom=function(E){var G=E.editor,F=x._getEditorElement();x._hideRTEToolbar();if(x._lastKnownCursorPosition===null){x._lastKnownCursorPosition=x._getCursorPosition()}x.dispatchEvent("onRteReady");x._handlePlaceholderVisibility();if(F){F.addEvent(u.Engine.ie?"keyup":"input",B)}G.editable().on("contextmenu",function(I){var H=G.getSelection();if(!(H&&!H.isLocked)){return}I.cancel()},null,null,1)};D.on.key=x._onKeyDownOnRte.bind(x);D.on.change=B;if(y&&!(C&&C.element.$===y)&&y.isInjected()){C=x.rte=e.inline(y,D);x._setRteData(z)}};if(e){A.call()}else{this._loadCKE(A)}}},_destroyRte:function(){var y=this.rte;if(y){this.rte=null;try{y.destroy()}catch(x){if(x){w.error(x)}}}},_isMessageEmpty:function(y,x){return(!y||y==="<p></p>"||y==="<p>\u200B<br></p>"||y==="<p><br></p>"||y==="<p><br/></p>"||(x&&(x.checkWhitespaces===true)&&(y.replace(/<(?:.|\n)*?>|\s|&nbsp;|\u200B|&#8203;/gm,"").trim()==="")))},_isEditorEmpty:function(x){return this._isMessageEmpty(b.is(x&&x.editorContent,"string")?x.editorContent:this._getEditorContent(),x)},_getMessageToSave:function(){return this._getEditorContent()},_getRangeSize:function(x){return(x.toString().length+(u.Engine.chrome?0:b.createElement("div",{html:x.cloneContents()}).getElements("br").length))},_findCursorPositionFromRangeSize:function(y,G,A){var x,E=null,D=undefined,F=y.childNodes,C=F.length;if(!A){A=document.createRange();A.selectNodeContents(y)}if(C===0){if(y.nodeType===y.TEXT_NODE){return{childPosition:G,childNode:y}}E=y;if(y.tagName==="BR"){G=0;if(!u.Engine.chrome){E=y.parentNode.insertBefore(document.createTextNode(u.Engine.ie?"":"\u200B"),y)}}return{childPosition:G,childNode:E}}for(var z=0,B=C;z<B;z++){x=F[z];A.selectNodeContents(x);A.setStart(y,0);if(this._getRangeSize(A)>=G){E=x;if(E.tagName==="BR"){return this._findCursorPositionFromRangeSize(E,0,A)}if(E.previousSibling){A.selectNodeContents(E.previousSibling);A.setStart(y,0);D=G-this._getRangeSize(A)}else{D=G}break}}if(E){return this._findCursorPositionFromRangeSize(E,D,A)}E=F[C-1];A.selectNodeContents(E);return{childPosition:A.endOffset,childNode:A.endContainer}},_getCursorPosition:function(y,B,z){var x,E,D,C,A=this._getEditorElement();if(!A||((document.activeElement!==A)&&!A.contains(document.activeElement))){return{}}if(!y&&!B&&(!z||(z.lastPositionIfUnspecifiedPosition!==true))){D=document.getSelection();if(!D||(D.rangeCount===0)){return null}B=A;x=D.getRangeAt(0);E=x.cloneRange();E.selectNodeContents(A);E.setEnd(x.endContainer,x.endOffset);y={sizeOfRangeFromEditorStart:this._getRangeSize(E)}}else{if(!B){B=A}if((B!==A)&&!A.contains(B)){B=A;y=undefined}C=b.typeOf(y);if((C==="object")&&b.is(y.sizeOfRangeFromEditorStart,"number")){return this._findCursorPositionFromRangeSize(A,y.sizeOfRangeFromEditorStart)}else{if(C!=="number"){if(B.lastElementChild&&B.lastElementChild.childNodes.length>0){B=B.lastElementChild.lastChild;if(B){y=(B.nodeValue&&B.nodeValue.length);if(!b.is(y,"number")){if(B.tagName==="BR"){return this._findCursorPositionFromRangeSize(B,0)}y=B.childNodes.length}}}else{y=0}}}}return{childPosition:y,childNode:B}},_placeCursorAtlastKnownPosition:function(){var x=this._lastKnownCursorPosition;this._lastKnownCursorPosition=null;return this.placeCursorAt(x&&x.childPosition,x&&x.childNode)},isInRichMode:function(){return this.getOption("richMode")===true},isRteReady:function(){return this._rteReady===true},enterRichMode:function(){var x=this.elements.textEditor;if(this.options.richMode!==true){this.options.richMode=true;this.container.addClassName("st-rich");x.addClassName("st-rich");if(this.rte){this._showRTE()}}return this},resetEditorContent:function(x){this._hideRTEToolbar();this._updateEditorContent(x)},updateEditorContentWhenRteIsReady:function(D,A,z){var y,C,B,x;if(!this._rteReady){this.addEventOnce("onRteReady",this.updateEditorContentWhenRteIsReady.bind(this,D,A,z));this._showRTE()}else{if(z&&z.allowedContent){D=this._filterContent(D,z.allowedContent)}x=b.is(D,"string");B=x?D:"";if(!z||z.replace!==false){B+=s.getMediaHtml(A)}else{y=this._getEditorContent();C=this._isEditorEmpty({editorContent:y});B=((C?"":y)+((z&&z.insertNewLineIfEditorEmpty===false)||C?"":"<br>")+B+(this._getMediaHtmlFromMediaList()+s.getMediaHtml(A)))}if(!x&&(B==="")){B=undefined}this.resetEditorContent(B)}return this},cancelEdition:function(){this.resetEditorContent();this.dispatchEvent("onCancelEdition",[this])},focus:function(){var y=null,x=null;if(this.elements.textEditor&&(document.activeElement!==this.elements.textEditor)){if(u.Engine.firefox&&this.rte&&this.rte.getSelection()===null){x=this.rte.editable();y=new CKEDITOR.dom.selection(x);y.selectElement(x);this.rte.lockSelection(y)}if(u.Platform.ios){this.elements.textEditor.scrollIntoView()}if(y){this.rte.once("focus",function(){this.unlockSelection(y)},undefined,undefined,100)}else{this.elements.textEditor.focus()}}if(!this._inPage||!this.rte){this.addEventOnce("onRteReady",this.focus)}else{this.rte.focus()}return this},blur:function(){if(this.elements&&this.elements.textEditor&&this.elements.textEditor.blur){this.elements.textEditor.blur()}return this},placeCursorAt:function(z,B,A){this.focus();try{var x,y=document.createRange(),C=document.getSelection();if(C){x=this._getCursorPosition(z,B,{lastPositionIfUnspecifiedPosition:true});if(b.is(x.childNode)&&b.is(x.childPosition,"number")){y.setStart(x.childNode,x.childPosition);y.collapse(true);C.removeAllRanges();C.addRange(y)}}}catch(D){console.error(D)}},saveSnapShot:function(){if(!this.isDestroyed()&&this.rte){this.rte.fire("saveSnapshot");return this}return null},onRender:function(){var y=this,x=this._getSharedOptions();if(this.elements.textEditor){if(u.Engine.firefox){this.elements.textEditor.addEvents({focus:this._onFocusIn,blur:this._onFocusOut})}}this._handlePlaceholderVisibility();this.enterRichMode();if(x.getOption("3DSwymUrl")){require(["DS/SocialUserMention/SocialUserMention"],function(z){h=z;if(!y.isDestroyed()){var A=function(){if(y.elements&&y.elements.textEditor){h.enableFeature({editableElement:y.elements.textEditor,tenantId:x.getOption("tenantId"),"3DSwymUrl":x.getOption("3DSwymUrl"),"3DSwymServerToken":x.getOption("3DSwymServerToken"),userLogin:x.getOption("userLogin"),userName:x.getOption("userName"),events:{onInsert:function(){y.saveSnapShot()}}})}};if(y.elements.textEditor){if(y.elements.textEditor.getAttribute("contenteditable")==="true"){A()}else{y.listenToOnce(v,"onAfterCKEditorLoad",function(){try{A()}catch(B){w.error(B)}})}}}})}},onInjected:function(){this._parent.apply(this,arguments);if(this.options.showRteOnDOMInjection===true){this._lastKnownCursorPosition=this._getCursorPosition();this.executeWhenRteIsReady(this._placeCursorAtlastKnownPosition);this._showRTE()}return this},onRteReady:function(){this._rteReady=true},executeWhenRteIsReady:function(x){if(this._rteReady){x.call(this)}else{this.addEventOnce("onRteReady",x)}},saveComment:function(){var F=this,x,I,K,G,B,D=this.model,E=this.collection,y=new Date().toISOString(),A=this._getMessageToSave(),C,H=this.components.get("mediaList"),J=H&&H.collection,z=this._isMessageEmpty(A,{checkWhitespaces:true});((J&&J.uploadAllNewAnnotations())||g.resolve()).then(function(){if(z){A=""}C=F._getMediaHtmlToSave();if(!z||C){A=A+C;if(D){x=D.get("richMessage");D.save({richMessage:A},{onFailure:function(){var L=D.get("richMessage");require(["DS/UWPClientControls/PlatformNotify"],function(M){M.error(m.SorryYourCommentCouldNotBeSaved)});D.set("richMessage",x);F.dispatchEvent("onCommentSaveFailure",[F,L])},onComplete:function(){F.dispatchEvent("onCommentEditSuccess",D)}});D.set({modificationDate:y})}else{K=E.getSubject().getSharedOptions().getUserInfo();G=E.getTarget().getCommenters();B=G.get(K.login);if(!B){G.add(K)}E.changeTotalRecordsBy(1);I={richMessage:A,author:K};if(F.getOption("parentComment")){I.parentCommentUri=F.getOption("parentComment").get("commentUri")}D=E.create(I,{onFailure:function(){var L=D.collection;if(L){L.changeTotalRecordsBy(-1);L.remove(D)}if(!B){G.remove(K.login)}require(["DS/UWPClientControls/PlatformNotify"],function(M){M.error(m.SorryYourCommentCouldNotBeCreated)});F.dispatchEvent("onCommentSaveFailure",[F,D.get("richMessage")])},onComplete:function(L){F.dispatchEvent("onCommentCreateSuccess",L)}});D.set({creationDate:y,modificationDate:y});F.dispatchEvent("onCommentPrePublish",[F,D])}F.dispatchEvent("onCommentSaved",[F])}})},destroy:function(){if(h&&this.elements.textEditor){h.disableFeature({editableElement:this.elements.textEditor})}this._destroyRte();return this._parent.apply(this,arguments)}});return l});define("DS/SocialToolbar/Views/CommentView",["UWA/Core","UWA/Array","UWA/Utils/Client","DS/SocialToolbar/Utils/Sprite","DS/SocialToolbar/Utils/Date","DS/SocialToolbar/Views/CommentEditorView","DS/SocialToolbar/Views/ActionToolbarView","DS/SocialToolbar/Views/BaseCommentMediaListWrapperView","i18n!DS/SocialToolbar/assets/nls/social-toolbar","DS/UIKIT/DropdownMenu","DS/UIKIT/SuperModal","DS/UIKIT/Tooltip"],function(a,o,q,l,c,i,b,f,j,m,n,p){var d=null;require(["DS/SocialToolbar/Views/CommentZoneView"],function(s){d=s});var h={edit:{name:"edit",text:j.Edit,fonticon:"pencil"},"delete":{name:"delete",text:j.Delete,fonticon:"trash"},_loading:{name:"_loading",text:j.get("Loading"),disabled:true},_noAvailableAction:{name:"_noAvailableAction",text:j.get("NoAvailableAction"),disabled:true},_errorLoadingActions:{name:"_errorLoadingActions",text:j.get("ErrorLoadingActions"),disabled:true}},g=function(s){if(h[s]){return a.clone(h[s],false)}throw new Error('Menu item "'+s+'" is not supported!')},r=m.extend({show:function(){if(this.items&&this.items.length===0){this.addItem(g("_loading"))}return this._parent.apply(this,arguments)}});var k=["edit","delete"],e=f.extend({_editMode:false,_expandedReplies:false,_commentExpanded:false,_showSummary:true,name:"st-comment",domEvents:{"click .st-comment-main-section > .st-comment-main-section-footer > .st-show-replies .st-fake-link":"_onShowRepliesButtonClick","click > .st-comment-main-section > .st-comment-main-section-body .st-msg":"_exitSummaryMode",resize:"_checkMessageHeight"},init:function(){var s;this._parent.apply(this,arguments);if(this.model){s={"onChange:richMessage":this._onRichMessageChange,"onChange:modificationDate":this._onModificationDateChange,"onChange:accessState":this.updateMainSection,"onChange:moderationState":this.updateMainSection,onRequest:this._hideActionButtons,onSync:this._showActionButtons,onError:this._showActionButtons};s["onChange:"+this.model.COMMENTS_COUNT_ATTRIBUTE]=this._updateShowRepliesSection;s["onChange:"+this.model.idAttribute]=this._handleActionToolbarVisibility;this.listenTo(this.model,s);this._handleActionToolbarVisibility();this._updateShowSummaryProperty(this.model.get("parentCommentUri")?false:this.getTopLevelComponent().getOption("showCommentsSummaryFirst"))}this.listenTo(this.components,{onCommentSaved:this._onCommentSaved,onCommentSaveFailure:this._onCommentSaveFailure,onCancelEdition:this._onCancelEdition,onCommentButtonClick:this._onReplyButtonClick,onCommentEditSuccess:this._onCommentEditSuccess})},_onCommentEditSuccess:function(s){this.dispatchEvent("onCommentEditSuccess",s)},_handleSummaryMode:function(){if(this.container){if(this._showSummary===true){this.container.addClassName("st-summary-mode")}else{this.container.removeClassName("st-summary-mode")}}},_updateShowSummaryProperty:function(s){this._showSummary=s===true;this._handleSummaryMode()},_exitSummaryMode:function(){if(this._showSummary){this._commentExpanded=true;this._updateShowSummaryProperty(false)}},_checkMessageHeight:function(){if(this.container){if(this._showSummary&&this.elements&&this.elements.commentMessage&&this.elements.commentMessage.scrollHeight>Math.ceil(parseFloat(this.elements.commentMessage.clientHeight))){this.container.addClassName("st-overflowing-content")}else{this.container.removeClassName("st-overflowing-content")}}},_handleActionToolbarVisibility:function(){if(this.model.isNew()){this.container.addClassName("st-hidden-action-toolbar")}else{this.container.removeClassName("st-hidden-action-toolbar")}},_hideActionButtons:function(){this.container.addClassName("st-hidden-action-buttons")},_showActionButtons:function(){this.container.removeClassName("st-hidden-action-buttons")},_handleRepliesDisplay:function(){var t,s,v=this.model.getComments(),u=parseInt(this.model.get("nbReplies"),10),w=this.elements.showRepliesSection;if(w){t=w.getElement(".st-fake-link");s=w.getElement(".fonticon");if(t){t.setContent(this._expandedReplies===true?j.HideReplies:j.ShowReplies)}if(s){if(this._expandedReplies===true){s.removeClassName("fonticon-right-open-big");s.addClassName("fonticon-down-open-big")}else{s.removeClassName("fonticon-down-open-big");s.addClassName("fonticon-right-open-big")}}}if(this._expandedReplies===true&&u>0&&v.length<u&&!v.isBeingFetched()&&!v.hasBeenFetched()){v.getFirstPage()}},_onShowRepliesButtonClick:function(){this._expandedReplies=!this._expandedReplies;this._handleRepliesDisplay();if(this._expandedReplies===true){this._showRepliesAndReplyCreator(false)}else{this._hideRepliesAndReplyCreator()}},_onReplyButtonClick:function(){if(!this.model.get("parentCommentUri")){this._expandedReplies=true;this._handleRepliesDisplay();this._showRepliesAndReplyCreator(true)}this.dispatchEvent("onReplyButtonClick",[this])},_showRepliesAndReplyCreator:function(u,v){var t=this,s=function(z){if(!t.isDestroyed()){var w,y,x=t.components.get("commentZone");if(!x){x=new z({model:t.model,parentComment:t.model,collection:t.model.getComments(),commentToScrollTo:v&&v.commentToScrollTo});t.components.addMap({commentZone:x});x.inject(t.getElement(".st-comment-main-section-footer"),"bottom");w=x.getCommentCreator()}else{w=x.getCommentCreator()}y=w.getCommentEditor();w.show();x.show();y.updateEditorContentWhenRteIsReady();if(q.Platform.ios&&u===true&&y.isInPage()){w.focus()}y.executeWhenRteIsReady(function(){if(u===true){y.placeCursorAt()}t.dispatchEvent("onShowRepliesAndReplyCreator",[this])})}};this.removeEvent("onShowRepliesAndReplyCreator",this._hideRepliesAndReplyCreator);if(d){s(d)}else{require(["DS/SocialToolbar/Views/CommentZoneView"],s)}},_hideRepliesAndReplyCreator:function(s){var t=this.components.get("commentZone");if(t){t.hide()}else{this.addEventOnce("onShowRepliesAndReplyCreator",this._hideRepliesAndReplyCreator)}},_getDropDownMenuItemFromActionList:function(s){return s.map(function(t){return g(t)},this)},_createDropDownMenu:function(u,v){var s=this,t=this._getDropDownMenuItemFromActionList(v);return this.components.addMap({dropdownMenu:new r({className:"st-comment-actions-dropdown",target:u,items:t,events:{onClick:function(x,w){switch(w.name){case"edit":s.enterEditMode();break;case"delete":s.deleteComment();break;default:break}},onShow:function(){var z=this,x=s.model&&s.model.collection,w=function(A){var B=z.items&&z.items.length===1;z.removeItem("_loading");z.removeItem("_noAvailableAction");z.removeItem("_errorLoadingActions");if(B&&A&&A.replacementItem&&(z.items&&z.items.length===0)){z.addItem(A.replacementItem)}},y=function(B){var A=[];if(B===true){k.forEach(function(C){if(!o.detect(z.items,function(D){return D.name===C})){A.push(C)}});if(A.length>0){z.addItem(s._getDropDownMenuItemFromActionList(A))}w()}else{w({replacementItem:g("_noAvailableAction")})}z.updatePosition()};if(x&&!a.is(s._hasUserEditionRight(),"boolean")){x.getCommentModerationRights({onComplete:function(A){y(A)},onFailure:function(){w({replacementItem:g("_errorLoadingActions")})}})}else{y(s._hasUserEditionRight())}}}})})},_createShowRepliesSection:function(){var t=this.model,s=parseInt(t.get("nbReplies"),10);return !t.get("parentCommentUri")&&s>0?[{tag:"span","class":"fonticon fonticon-"+(this._expandedReplies===true?"down-open-big":"right-open-big")},{tag:"span","class":"st-fake-link",html:this._expandedReplies===true?j.HideReplies:j.ShowReplies}]:null},_updateShowRepliesSection:function(){if(this.elements.showRepliesSection){this.elements.showRepliesSection.setContent(this._createShowRepliesSection())}},_getModerationMessage:function(){var s=this.model;switch(s.getModerationState()){case s.MODERATION_STATE_FOR_UI.EDITED_BY_AUTHOR:return j.edited;case s.MODERATION_STATE_FOR_UI.EDITED_BY_ADMIN:return j.moderated;default:return""}},_getModerationMessageForTooltip:function(){var s=this.model;switch(s.getModerationState()){case s.MODERATION_STATE_FOR_UI.EDITED_BY_AUTHOR:return j.EditedOnAGivenDate;case s.MODERATION_STATE_FOR_UI.EDITED_BY_ADMIN:return j.ModeratedOnAGivenDate;default:return""}},_getMessageToDisplay:function(){return this.model.get("richMessage")},_getMessageDeleted:function(){return j.ThisCommentHasBeenDeleted},_hasUserEditionRight:function(){return this.model.canBeModerated()},_shouldFooterBeShown:function(){return(!this.model.hasBeenDeleted())},_shouldActionMenuBeCreated:function(){return this._hasUserEditionRight()!==false},_shouldCommentHeaderBeShown:function(){return true},_createMainSection:function(){var y=this.model,v=y.getAuthor(),s=this._hasUserEditionRight(),A=this._shouldActionMenuBeCreated(),w=y.hasBeenDeleted(),x=this._getCreationDate(),u=this._getModerationMessage(),z=u?a.createElement("span",{"class":"st-detail st-moderation-status",html:"- "+u}):null,t=A?a.createElement("span",{"class":"fonticon fonticon-down-open-big"}):"";if(A){this._createDropDownMenu(t,s===true?k:[])}this._updateModerationTooltip(z);this.elements.commentMessage=a.createElement("div",{"class":"st-msg",html:w?{tag:"p","class":"st-comment-deleted",html:this._getMessageDeleted()}:this._getMessageToDisplay()});return{"class":"st-comment-main-section",html:[{"class":"st-comment-main-section-body",html:[{"class":"st-comment-info",html:[this._shouldCommentHeaderBeShown()===true?{"class":"st-comment-header",html:[{tag:"span","class":"st-fake-link","data-login":v.get("login"),html:v.getFullName().escapeHTML()},x?{tag:"span","class":"st-detail st-date",html:x}:null,z]}:false,this.elements.commentMessage]},{"class":"st-comment-actions",html:t}]},{"class":"st-media-zone",html:this._getMediaListToDisplay()},this.getTopLevelComponent().getOption("enableReply")&&this._createFooterSection()]}},_createFooterSection:function(){var u=this.model,s=this.components.get("commentZone"),t=new b({model:u,enableLike:this.getTopLevelComponent().getOption("enableCommentLike")});this.components.addMap({actionToolbar:t});this.elements.showRepliesSection=a.createElement("div",{"class":"st-show-replies",html:this._createShowRepliesSection()});return this._shouldFooterBeShown()?{"class":"st-comment-main-section-footer",html:[t,this.elements.showRepliesSection,s]}:null},_renderUserPicture:function(){return l.renderUserPicture({cls:"st-user-picture",format:this.model.get("parentCommentUri")?"mini":"normal",login:this.model.getAuthor().get("login"),swymUrl:this.model.getSubject().getSharedOptions().getOption("3DSwymUrl")})},_createContent:function(){return[this._renderUserPicture(),this._createMainSection()]},_onCommentSaved:function(s){if(q.Engine.ie){setTimeout(function(){if(!s.isDestroyed()){s.blur()}},50)}this.enterViewMode();this.dispatchEvent("onCommentSaved",[this])},_onCommentSaveFailure:function(s,t){this.enterEditMode();s.resetEditorContent(t);s.placeCursorAt();this.dispatchEvent("onCommentSaveFailure",[this])},_onCancelEdition:function(){this.enterViewMode();this.dispatchEvent("onCancelEdition",[this])},_onRichMessageChange:function(){var t,u=this.getElement(".st-comment-info .st-msg"),s=this.getElement(".st-comment-main-section .st-media-zone");if(u){u.setContent(this._getMessageToDisplay())}if(s){t=this._getMediaListToDisplay();s.setContent((t&&t.container)||t)}},_getModificationDate:function(){var s=c.prettyDate(this.model.get("modificationDate"));return s||""},_getCreationDate:function(){var s=c.prettyDate(this.model.get("creationDate"));return s?"- "+s:""},_updateModerationTooltip:function(s){var t=this._getModificationDate();if(s){if(t){this.components.addMap({moderationTooltip:new p({target:s,body:j.replace(j.get(this._getModerationMessageForTooltip()),{onAGivenDate:t}),position:"bottom"})})}else{this.components.remove("moderationTooltip")}}},_onModificationDateChange:function(){this._updateModerationTooltip(this.getElement(".st-moderation-status"))},_deleteComment:function(){var t=this,y=this.model,u=t.getMediaCollection(),x=y.collection,s=x&&x.indexOf(y),w={accessState:y.get("accessState"),moderationState:y.get("moderationState")},v={accessState:y.ACCESS_STATE.DELETED,moderationState:y.getAuthor().get("login")===y.getSubject().getSharedOptions().getOption("userLogin")?y.MODERATION_STATE.MODERATED_BY_AUTHOR:y.MODERATION_STATE.MODERATED_BY_ADMIN};if(x){x.changeTotalRecordsBy(-1)}y.destroy({data:v,onComplete:function(){var z=(x||y).getSubject().getCommenters();y.set(v);if(z.hasBeenFetched()){z.getFirstPage()}u&&u.deleteAllAnnotations()},onFailure:function(){if(s>=0){x.changeTotalRecordsBy(1);x.add(y,{at:s})}y.set(w);require(["DS/UWPClientControls/PlatformNotify"],function(z){z.error(j.get("SorryTheCommentCouldNotBeDeleted"))})}})},enterEditMode:function(){var s,t;if(this._editMode!==true){if(this.model){t=this.model.getSubject().getSharedOptions();t.dispatchEvent("onCommentViewEnterEditMode",[this]);this.listenTo(t,"onCommentViewEnterEditMode",this.enterViewMode)}this._editMode=true;this.container.addClassName("st-edit");s=this.components.get("commentEditor");if(!s){s=new i({model:this.model,parentComment:this.model.getParentComment(),collection:this.collection,creationMode:false,showRteOnDOMInjection:true});this.components.addMap({commentEditor:s})}else{s.placeCursorAt()}if(!s.container.isInjected(this.container)){s.inject(this.getElement(".st-comment-main-section"),"after")}}},enterViewMode:function(){var s;if(this._editMode===true){this._editMode=false;this.container.removeClassName("st-edit");if(this.model){s=this.model.getSubject().getSharedOptions();s.dispatchEvent("onCommentViewEnterViewMode",[this]);this.stopListening(this.model.getSubject().getSharedOptions(),"onCommentViewEnterEditMode",this.enterViewMode)}}},_getDeleteConfirmationMessage:function(){return j.get("AreYouSureYouWantToDeleteThisComment")},deleteComment:function(){var s=this.components.get("modal");if(!s){s=new n({className:"",renderTo:(window.widget&&window.widget.body)||document.body});this.components.addMap({modal:s})}s.confirm(this._getDeleteConfirmationMessage(),j.Confirmation,function(t){if(t===true){this._deleteComment()}}.bind(this))},updateMainSection:function(){var s,t=this.getElement(".st-comment-main-section");if(t){s=a.createElement("div",this._createMainSection());t.hide();s.inject(t,"before");t.destroy()}},scrollToReply:function(s){if(!this.model.get("parentCommentUri")){this._expandedReplies=true;this._handleRepliesDisplay();this._showRepliesAndReplyCreator(false,{commentToScrollTo:{commentUri:s}})}},onInjected:function(){var s=this;this._parent.apply(this,arguments);setTimeout(function(){if(!s.isDestroyed()&&s.model){l.reloadUserPictures({el:s.container,swymUrl:s.model.getSubject().getSharedOptions().getOption("3DSwymUrl")})}},50)}});return e});define("DS/SocialToolbar/Views/CommentCreatorView",["UWA/Core","UWA/Utils/Client","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Utils/Sprite","DS/SocialToolbar/Views/CommentEditorView"],function(f,c,d,b,e){var a=d.extend({name:"st-comment-creator",defaultOptions:{parentComment:null},_createContent:function(){var h=this.collection.getSubject().getSharedOptions(),g=new e({parentComment:this.getOption("parentComment"),collection:this.collection});this.components.addMap({commentEditor:g});return[b.renderUserPicture({cls:"st-user-picture",format:"normal",login:h.getOption("userLogin"),swymUrl:h.getOption("3DSwymUrl")}),g]},_onCommentSaved:function(g){g.resetEditorContent("");if(c.Features.touchEvents){console.info("Calling commentEditor.blur() on _onCommentSaved for debug.");console.info("Browser: ",c.Engine.name);console.info("Browser version: ",c.Engine.fullVersion);g.blur()}this.dispatchEvent("onCommentSaved",[this])},_onCommentSaveFailure:function(g,h){g.resetEditorContent(h);g.placeCursorAt();this.dispatchEvent("onCommentSaveFailure",[this])},_onCancelEdition:function(g){g.resetEditorContent("");this.dispatchEvent("onCancelEdition",[this])},init:function(){this._parent.apply(this,arguments);this.listenTo(this.components,{onCommentSaved:this._onCommentSaved,onCommentSaveFailure:this._onCommentSaveFailure,onCancelEdition:this._onCancelEdition,onCommentCreateSuccess:this._onCommentCreateSuccess})},_onCommentCreateSuccess:function(g){this.dispatchEvent("onCommentCreateSuccess",g)},getCommentEditor:function(){return this.components.get("commentEditor")},focus:function(){var g=this.getCommentEditor();if(g){g.focus()}return g},onRender:function(){b.reloadUserPictures({el:this.container,swymUrl:this.collection.getSubject().getSharedOptions().getOption("3DSwymUrl")})}});return a});define("DS/SocialToolbar/Views/CommentListView",["UWA/Core","DS/SocialToolbar/Views/BaseCollectionView","DS/SocialToolbar/Views/CommentView","DS/SocialToolbar/Utils/Sprite","i18n!DS/SocialToolbar/assets/nls/social-toolbar"],function(g,a,b,c,e){var f=100,d=a.extend({name:"st-comment-list",domEvents:{},defaultOptions:{commentToScrollTo:null},_ItemView:b,_onReplyButtonClick:function(h){return this.dispatchEvent("onReplyButtonClick",[h])},init:function(){this._parent.apply(this,arguments);if(this.collection){this.listenTo(this.collection,{onCollectionChange:function(){c.reloadUserPictures({el:this.container,swymUrl:this.collection.getSubject().getSharedOptions().getOption("3DSwymUrl")})},onDestroy:this._onCommentDeleteSuccess});this.listenTo(this.children,{onReplyButtonClick:this._onReplyButtonClick,onCommentEditSuccess:this._onCommentEditSuccess})}else{throw new Error("Collection is required")}},_onCommentEditSuccess:function(h){this.dispatchEvent("onCommentEditSuccess",h)},_onCommentDeleteSuccess:function(h){if(h&&(h.name==="comment")){this.dispatchEvent("onCommentDeleteSuccess",h)}},scrollToComment:function(j){var i=this,k=null,h=j.commentUri;if(h&&!this.isDestroyed()){if(g.is(this.model.getCommentsTotalCount(),"number")&&!this.collection.isBeingFetched()){k=this.children.find(function(l){if(l.model.get("commentUri")===h){return true}return false});if(k){setTimeout(function(){if(!k.isDestroyed()){k.container.scrollIntoView(false);if(j.replyUri&&!k.model.get("parentCommentUri")){k.scrollToReply(j.replyUri)}else{k.container.addClassName("st-fade-in-out");setTimeout(function(){if(k.container){k.container.removeClassName("st-fade-in-out")}},5000)}}},500)}else{if((this.model.getCommentsTotalCount()-this.collection.length)>0){this.collection.loadPreviousComments(f,{onComplete:function(){i.scrollToComment(j)}})}else{require(["DS/UWPClientControls/PlatformNotify"],function(l){l.info(e.get((i.model&&i.collection&&i.collection.getSubject()!==i.model)?"TheReplyYouAreLookingForCouldNotBeFoundItMayHaveBeenRemoved":"TheCommentYouAreLookingForCouldNotBeFoundItMayHaveBeenRemoved"))})}}}else{this.collection.addEventOnce("onSync",function(){i.scrollToComment(j)})}}},onRender:function(){c.reloadUserPictures({el:this.container,swymUrl:this.collection.getSubject().getSharedOptions().getOption("3DSwymUrl")});if(this.options.commentToScrollTo){this.scrollToComment(this.options.commentToScrollTo);this.options.commentToScrollTo=null}}});return d});define("DS/SocialToolbar/Views/CommentZoneView",["UWA/Core","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Views/PreviousCommentsLoaderView","DS/SocialToolbar/Views/CommentListView","DS/SocialToolbar/Views/CommentCreatorView"],function(f,b,d,c,a){var e=b.extend({_lockedDisplay:false,name:"st-comment-zone",domEvents:{},defaultOptions:{parentComment:null,lockedDisplay:false,commentToScrollTo:null},_createContent:function(){this.components.reset({previousCommentsLoader:new d({model:this.model,collection:this.collection}),commentList:new c({model:this.model,collection:this.collection,commentToScrollTo:this.getOption("commentToScrollTo")}),commentCreator:new a({parentComment:this.getOption("parentComment"),collection:this.collection})});return this.components.toArray()},_showLoadingSpinner:function(g){if(!g||this.collection===g){var h=this.components.get("previousCommentsLoader");if(h){h.mask()}}},_hideLoadingSpinner:function(g){if(!g||this.collection===g){var h=this.components.get("previousCommentsLoader");if(h){h.unmask()}}},_onReplyButtonClick:function(k){var g,j,i,l=k.model,h=l.getAuthor();if(k.model.get("parentCommentUri")){j=this.getCommentCreator();i=j.getCommentEditor();j.show();i.focus();require(["DS/SocialUserMention/SocialUserMention"],function(m){g=m.getMention({object:{value:h.get("login"),label:h.getFullName()}});i.resetEditorContent(g);i.placeCursorAt();if(i.isInRichMode()&&!i.isRteReady()){i.addEventOnce("onRteReady",function(){if(!i.isDestroyed()){i.placeCursorAt()}})}}.bind(this))}},_onCancelEdition:function(g){if(this.getOption("parentComment")&&(g instanceof a)&&this.collection.length===0){g.hide()}},init:function(g){this._parent.apply(this,arguments);if(this.collection){this.listenTo(this.collection,{onRequest:this._showLoadingSpinner,onSync:this._hideLoadingSpinner,onError:this._hideLoadingSpinner});this.listenTo(this.components,{onReplyButtonClick:this._onReplyButtonClick,onCancelEdition:this._onCancelEdition,onCommentCreateSuccess:this._onCommentCreateSuccess,onCommentEditSuccess:this._onCommentEditSuccess,onCommentDeleteSuccess:this._onCommentDeleteSuccess})}else{throw new Error("Collection is required")}if(g&&g.lockedDisplay===true){this._lockedDisplay=true}},_onCommentCreateSuccess:function(g){this.dispatchEvent("onCommentCreateSuccess",g)},_onCommentEditSuccess:function(g){this.dispatchEvent("onCommentEditSuccess",g)},_onCommentDeleteSuccess:function(g){this.dispatchEvent("onCommentDeleteSuccess",g)},getCommentCreator:function(){return this.components.get("commentCreator")},getTotalNumberOfComments:function(){return this.collection.getTotalRecords()},unlockDisplay:function(){this._lockedDisplay=false},show:function(){if(this._lockedDisplay!==true){this._parent.apply(this,arguments)}return this},onRender:function(){this.options.commentToScrollTo=null;if(this.collection.isBeingFetched()){this._showLoadingSpinner()}}});return e});define("DS/SocialToolbar/SocialToolbar",["UWA/Core","UWA/Event","UWA/Utils/Client","DS/Logger/Logger","DS/SocialToolbar/Utils/SocialToolbarSharedOptions","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Views/ActionToolbarView","DS/SocialToolbar/Views/CommentZoneView","DS/SocialToolbar/Models/Subject","DS/SocialToolbar/Utils/Media","DS/SocialToolbar/CallMutualizer","i18n!DS/SocialToolbar/assets/nls/social-toolbar","css!DS/UIKIT/UIKIT","css!DS/SocialToolbar/SocialToolbar"],function(l,m,d,c,j,i,o,n,b,k,p,g){var h=null,f={},a="X3DPRFL_AP";var e=i.extend({name:"social-toolbar",_successFullInit:false,_rendered:false,domEvents:{"click *[data-login]":"_onUserLinkClick","click *[data-users-group-uri]":"_onUsersGroupLinkClick","click .st-media img[data-source]":"_onMediaClick","mouseover .st-media img[data-source]":"_onMediaHover"},defaultOptions:{subjectUri:null,enableShare:true,enableComment:true,enableLike:true,enableReply:true,enableCommentLike:false,supportedMedia:{annotation:false},mode:"normal",showUserProfile:null,commentsNumberAtInit:5,enableUpload:false,RTEConfig:null,showCommentsSummaryFirst:true,sendInitCallInPool:false,sendInitCallEvenIfSubjectIsInCache:true,commentToScrollToAtInit:null,commentButtonClickEventIsOverrided:false},_createCommentZone:function(){var q=this.getOption("commentToScrollToAtInit");return this.components.addMap({commentZone:new n({model:this.model,collection:this.model.getComments(),lockedDisplay:(this.getOption("mode")===j.MODE.LIGHT)&&!q,commentToScrollTo:q&&q.commentUri?{commentUri:q.parentCommentUri||q.commentUri,replyUri:q.parentCommentUri&&q.commentUri}:null})}).commentZone},_createContent:function(){var s=null,q=this,r=this.getOption("commentToScrollToAtInit");this.components.reset(this.model?{actionToolbar:new o({model:this.model,mode:this.getOption("mode"),enableShare:this.getOption("enableShare"),enableComment:this.getOption("enableComment"),enableLike:this.getOption("enableLike")})}:null);if(this.getOption("enableComment")){this.components.addMap({errorAlert:new h({closable:false,closeOnClick:false,visible:false,fullWidth:true,className:"st-error-msg",messageClassName:"primary",messages:[g.get("CommentsAreNotAvailable")],events:{onInjected:function(){if(!q._successFullInit||(q.model&&q.model.hasFailedToFetchContributions())){this.show()}else{this.hide()}},onShow:function(){if(q.container){q.container.addClassName("st-loading-error")}},onHide:function(){if(q.container){q.container.removeClassName("st-loading-error")}}}})})}if(this.getOption("enableComment")&&this.model&&(this.getOption("mode")!==j.MODE.LIGHT)){s=this._createCommentZone();s.listenTo(this.model,{onContributionsFetchSuccess:s.show,onContributionsFetchFailure:s.hide});if(!this._successFullInit||this.model.hasFailedToFetchContributions()){s.hide()}}return this.components.toArray()},_applyMode:function(){if(this.getOption("mode")===j.MODE.LIGHT){this.container.addClassName("st-light")}else{this.container.removeClassName("st-light")}if(this.getOption("enableUpload")===true){this.container.addClassName("st-upload-enabled")}else{this.container.removeClassName("st-upload-enabled")}},_onUserLinkClick:function(q){var r,s=m.getElement(q).getAttribute("data-login");if(s){if(this.options.showUserProfile){this.options.showUserProfile.call(this,s)}else{r=this.model.getSharedOptions().getOption("3DSwymUrl");if(r){require(["DS/TransientWidget/TransientWidget"],function(t){t.showWidget(a,"",{login:s,url:r})})}}}},_onUsersGroupLinkClick:function(q){var r=this,s=m.getElement(q).getAttribute("data-users-group-uri");if(s){require(["DS/i3DXRDFGroupViewer/js/GroupViewer","DS/UWPClientCode/I18n","DS/UIKIT/Modal"],function(v,u,t){var w=new v({language:u.getCurrentLanguage(),groupId:s,platformId:r.getOption("tenantId")});w.render();r.components.addMap({usersGroupModal:new t({body:w,className:"st-usersgroup-modal"})}).usersGroupModal.show()},function(){console.error("Viewer module is not present on disk!")})}},_onMediaClick:function(q){var s=this,u=m.getElement(q),t=u.dataset.source,r=u.dataset.uri;if(l.is(t,"string")&&t&&(t!==k.DEFAULT_MEDIA_SOURCE)&&r){if(this.hasEvent("onMediaClick")){this.dispatchEvent("onMediaClick",[{contentUri:r,contentSource:t}])}else{require(["DS/SocialToolbarCustomization/script/source/"+t],function(v){v.getRedirectionUrlFromContentUri({contentUri:r,callback:function(w){window.open(w,"_blank")}})},function(){c.warn("No callback for media from source: ",t)})}}else{if(l.is(t,"string")&&t&&(t===k.DEFAULT_MEDIA_SOURCE)){if(q&&q.data&&q.data.view&&q.data.view.getDataOnClick){q.data.view.getDataOnClick().then(function(v){s.dispatchEvent("onMediaClick",[v])})}}}},_onMediaHover:function(q){var t=m.getElement(q),s=t.dataset.source,r=t.dataset.uri;if(l.is(s,"string")&&s&&(s!==k.DEFAULT_MEDIA_SOURCE)&&r&&!t.hasClassName("st-interactive")){if(this.hasEvent("onMediaClick")){t.addClassName("st-interactive")}else{require(["DS/SocialToolbarCustomization/script/source/"+s],function(u){if(typeof(u.getRedirectionUrlFromContentUri)==="function"){t.addClassName("st-interactive")}},function(){})}}},_onContributionsFetchSuccess:function(){if(!this.isDestroyed()){this.dispatchEvent("onPopulate",[this]);var q=this.components.get("actionToolbar"),s=this.components.get("commentZone"),r=this.components.get("errorAlert");if(q){q.enableCommentButton()}if(s){s.show()}if(r){r.hide()}this.dispatchEvent("onSocialToolbarLoaded")}},_onContributionsFetchFailure:function(){if(!this.isDestroyed()){var q=this.components.get("actionToolbar"),s=this.components.get("commentZone"),r=this.components.get("errorAlert");if(q){q.disableCommentButton()}if(s){s.hide()}if(r){r.show()}}},_onCommentButtonClick:function(){var r,q;if(!this.model.hasFailedToFetchContributions()){r=this.components.get("commentZone");if(!r&&(this.getOption("mode")===j.MODE.LIGHT)){r=this._createCommentZone();r.inject(this.container,"bottom")}if(r){q=this._getCommentCreator();r.unlockDisplay();r.show();if(q){q.focus()}else{c.warn("Could not put focus on comment creator")}}else{c.warn("Could not show comment zone")}}},_getCommentCreator:function(){var q=this.components.get("commentZone");if(q){return q.getCommentCreator()}else{c.warn("Comment zone view could not be found")}},getNumberOfComments:function(){var q=this.components.get("commentZone");if(q){return q.getTotalNumberOfComments()}else{c.warn("The comments have not yet been loaded")}},getNumberOfLikes:function(){var q=this.components.get("actionToolbar");if(q){return q.getTotalNumberOfLikes()}else{c.warn("The likes have not yet been loaded")}},init:function(q){var r;if(q){if(l.is(q.subjectURI)&&!l.is(q.subjectUri)){q.subjectUri=q.subjectURI}if(l.is(q.serviceURL)&&!l.is(q.serviceUrl)){q.serviceUrl=q.serviceURL}if(l.is(q["3DSwymURL"])&&!l.is(q["3DSwymUrl"])){q["3DSwymUrl"]=q["3DSwymURL"]}}this._parent.call(this,q);if(!this.getOption("subjectUri")){throw new Error("Subject URI is required")}this._onContributionsFetchSuccess=this._onContributionsFetchSuccess.bind(this);this._onContributionsFetchFailure=this._onContributionsFetchFailure.bind(this);this.listenTo(this.components,{onCommentButtonClick:function(){if(this.getOption("commentButtonClickEventIsOverrided")===true){this.dispatchEvent("onCommentButtonClick",[this])}else{this._onCommentButtonClick()}},onShareButtonClick:function(){this.dispatchEvent("onShareRequest",[this])},onEndorseButtonClick:function(){this.dispatchEvent("onEndorseButtonClick",[this])},onCommentCreateSuccess:function(s){this.dispatchEvent("onCommentCreated")},onCommentEditSuccess:function(s){this.dispatchEvent("onCommentEdited")},onCommentDeleteSuccess:function(s){this.dispatchEvent("onCommentDeleted")},onEndorseSuccess:function(s){if(s&&(s.name==="subject")){this.dispatchEvent("onSubjectLiked")}},onUnendorseSuccess:function(s){if(s&&(s.name==="subject")){this.dispatchEvent("onSubjectUnliked")}}});if(d.Features.touchEvents){this.container.addClassName("st-touch")}r=this.getOption("commentToScrollToAtInit");if(r&&r.commentUri){this.setOption("mode",j.MODE.NORMAL)}this._applyMode()},render:function(){var r,t=this,q,s=function(u){t._successFullInit=false;r();if(l.is(u)){c.error(u)}};if(this._rendered===false){this._rendered=true;r=this._parent.bind(this,arguments);q=new j({"3DSwymUrl":this.options["3DSwymUrl"],"3DSwymServerToken":this.options["3DSwymServerToken"],tenantId:this.options.tenantId,userLogin:this.options.userLogin,userName:this.options.userName,serviceUrl:this.options.serviceUrl});require(["DS/UIKIT/Alert"],function(u){h=u;q.executeWhenReady(function(){var v,w;if(!t.isDestroyed()){if(!f[t.getOption("subjectUri")]){v=new b({subjectUri:t.getOption("subjectUri")},{sharedOptions:q});t.listenTo(v,{onPopulate:t._onContributionsFetchSuccess,onContributionsFetchFailure:t._onContributionsFetchFailure});f[t.getOption("subjectUri")]={subject:v,nbUseCases:1};v.fetchContributions(t.getOption("commentsNumberAtInit"),t.getOption("sendInitCallInPool"))}else{v=f[t.getOption("subjectUri")].subject;t.listenTo(v,{onPopulate:t._onContributionsFetchSuccess,onContributionsFetchFailure:t._onContributionsFetchFailure});++f[t.getOption("subjectUri")].nbUseCases;w=v.getComments();if((t.getOption("sendInitCallEvenIfSubjectIsInCache")===true)||((w.hasBeenFetched()===false)||((w.length<t.getOption("commentsNumberAtInit"))&&(w.length<v.getCommentsTotalCount())))){v.fetchContributions(t.getOption("commentsNumberAtInit"),t.getOption("sendInitCallInPool"),true)}else{if((t.getOption("sendInitCallInPool")===true)){p.modifyCallWindowSizeBy(-1)}}}t._successFullInit=true;t.model=v;r();this.options.commentToScrollToAtInit=null;t.listenTo(q,"onUserLinkClick",t._onUserLinkClick)}},s)})}return this},setActiveFieldContent:function(q){var t,s,u,r;if(!q){throw new Error("Options are missing")}if(!this.model){throw new Error("Comment subject is not available")}if(this._rendered!==true){throw new Error("Please render the view before using this method")}if(this._destroyed===true){throw new Error("You can't use this instance of SocialToolbar anymore. It has been destroyed")}s=this.model.getSharedOptions();t=s.getLastActiveEditor();if(!t||t.isDestroyed()||(l.extendElement(t.container)&&((t.container.getStyle("display")==="none")||l.equals(t.container.getSize(),{width:0,height:0})))){r=this._getCommentCreator();if(r){t=r.getCommentEditor()}}if(!t){throw new Error("Something went wrong...")}s.setLastActiveEditor(t);u=q.message;t.updateEditorContentWhenRteIsReady(u,q.media,{replace:(q.replace!==false),allowedContent:"p;br;strong;b;s;u;em;a[href,target]",insertNewLineIfEditorEmpty:(q.replace===false),subjectUri:this.options.subjectURI});return this},destroy:function(){var q=this.getOption("subjectUri");if(f[q]){--f[q].nbUseCases;if(f[q].nbUseCases===0){f[q].subject.clean();f[q]=null}}return this._parent.apply(this,arguments)}});return e});