define("DS/WebApplication/WebApplication",["DS/WebUtils/FunctionDisposer","DS/WebSystem/Scripting","DS/WebSystem/Environment","DS/WebRunloop/Runloop","DS/WebUtils/Profiler","DS/WebApplicationBase/W3AManagerSet","DS/WebSystem/Context","DS/VCXWebExperienceBase/VCXExperienceBase","DS/WebUtils/Statistics","DS/Visualization/ModelLoader","DS/Visualization/Node3D","UWA/Promise"],function(d,e,j,c,i,l,k,f,b,a,g,h){return e.extend({init:function(o){this._parent();this.context=k.createContext();this.options=UWA.extend({},o,true);if(this.options.container){if(typeof this.options.container==="string"){this.options.container=document.getElementById(this.options.container)}}else{if(this.options.options.frmWindow){this.options.container=this.options.options.frmWindow.getUIFrame()}}this.disposeFunctions=new d();var p=this;var n=function(r){p.app=new r(p.options);p.options.__ODT_onAppInitialize&&p.options.__ODT_onAppInitialize(p);var q=function(s){s.createDom();s.stats=new b();if(s.stats){s.stats.set({container:s.options.container})}s.viewer=s.frmWindow.getViewer?s.frmWindow.getViewer():null;if(s.options.Async||window.useAsyncExperienceBase){s.requestNewExperienceBaseAsync()}else{s.requestNewExperienceBase()}};if(p.app.onPreCreate!==undefined){p.app.onPreCreate(p,function(s){if(s===0){q(p)}})}else{q(p)}};var m=function(r){if(r.requireType=="scripterror"){var q=r.requireModules.join(",");console.error("3DPlay ScripNotFoundError: ",q)}else{console.error(r)}};this.disposeFunctions.add(function(){p=null;n=null;m=null});if(this.options.application===undefined){this.options.application="DS/3DPlayApplication/3DPlayApplication"}if(!window.extensionDictionaryApp){window.extensionDictionaryApp={}}if(!window.interfaceDictionaryApp){window.interfaceDictionaryApp={}}if(!window.componentDictionaryApp){window.componentDictionaryApp={}}require([this.options.application],n,m)},requestNewExperienceBaseAsync:function(){var m=this;return new h(function(p,o){if(m.runloop){m.runloop.stop();m.runloop.dispose();m.runloop=null}var n=m.experienceBase&&m.app.disposeExperienceBase?m.app.disposeExperienceBase():new h(function(q){q()});n.then(function(){var q=m.experienceBase&&m.experienceBase._ManagerSet&&m.experienceBase._ManagerSet.unInitialize();if(!q){q=new h(function(r){r()})}q.then(function(){if(m.experienceBase){m.experienceBase.Clean();m.experienceBase.webApplication=null;m.experienceBase=null}m.experienceBase=new f(null);m.experienceBase.webApplication=m;if(m.viewer){m.experienceBase.modelLoader=m.getModelLoader()}m.app.onPostCreate(m.experienceBase).then(function(r){var s=m.experienceBase._ManagerSet.initialize();s.then(function(){var t=m.experienceBase._ManagerSet.getManager("VCXContextManager");if(t&&m.viewer){t.setFrameWindow(m.frmWindow)}m.frmWindow._experienceBase=m.experienceBase;m.experienceBase._ManagerSet.postInitialize().then(function(){var u=m.app.onFinished&&m.app.onFinished(m.experienceBase);if(!u){u=new h(function(v){v()})}u.then(function(){m.profileFrame=i.start("webApplication::frame");m.runloop=new c({data:m,func:m.runloopFunc});m.runloop.start();p(m.experienceBase);m=null})})})})})})})},requestNewExperienceBase:function(){if(this.experienceBase){this.app.disposeExperienceBase&&this.app.disposeExperienceBase();this.experienceBase.Clean();this.experienceBase.webApplication=null;this.experienceBase.modelLoader=null;this.experienceBase=null;if(this.runloop){this.runloop.stop();this.runloop.dispose();this.runloop=null}}this.experienceBase=new f(null);this.experienceBase.webApplication=this;var m=this;if(m.viewer){m.experienceBase.modelLoader=m.getModelLoader()}this.app.onPostCreate(this.experienceBase,function(n){if(n===0){m.experienceBase._ManagerSet.initialize();var o=m.experienceBase._ManagerSet.getManager("VCXContextManager");if(o&&m.viewer){o.setFrameWindow(m.frmWindow)}m.frmWindow._experienceBase=m.experienceBase;m.experienceBase._ManagerSet.postInitialize();m.profileFrame=i.start("webApplication::frame");m.runloop=new c({data:m,func:m.runloopFunc});m.runloop.start();m.app.onFinished&&m.app.onFinished(m.experienceBase);m=null}});return this.experienceBase},getModelLoader:function(){if(this.app&&this.app.getModelLoader){return this.app.getModelLoader()}this.model=true;var o=this.frmWindow.getViewer();var n=new g("RootBag");o.addNode(n);var m=new a({node:n,viewer:o});return m},getContext:function(){return this.context},createDom:function(n){if(!this.frmWindow){if(n&&n.frmWindow){this.frmWindow=n.frmWindow}else{var o,m;if(n===undefined){o=this.options.FrameWindow}else{o=n.frameWindowCtor;m=n.options}if(m===undefined){m={};m.uiOptions=this.options.ui||{displayTree:false};var m={context:this.getContext()};if(this.app.getOptions){m=UWA.extend(m,this.app.getOptions(),true)}if(this.app.getWorkBench){var q=this.app.getWorkBench();if(Array.isArray(q)){q=q[0]}m.workbenchModule=q.module;m.workbench=q.name+".xml";if(q.defaultCommand!==undefined){m.defaultCommand=q.defaultCommand}}}if(!m.viewerOptions){m.viewerOptions={}}m.viewerOptions.defaultAnimationLoop=false;this.frmWindow=new o(m).inject(this.options.container)}if(this.frmWindow.getActionBar()){var p=this;this.callbackActionBar=this.frmWindow.getActionBar().onActionBarReady(function(){if(p.app.onActionBarReady){p.app.onActionBarReady()}})}}return this.frmWindow},runloopFunc:function(o){this.useCallback=this.useCallback!==undefined?this.useCallback:true;this.profileFrame.start();var n=this.experienceBase._ManagerSet.getManager("VCXContextManager");var m=UWA.extend(this.viewer?{viewer:n.getMainViewer()}:{viewer:null},o,true);m.profiler=this.profileFrame.addProfile("managerSet::update");var p=this;this.experienceBase._ManagerSet.update(m);if(this.skipFrame){this.skipFrame=false}else{n.applyToViewers(function(q){if(q._modelEvent&&!q.registredCBs){q.registredCBs={preToken:q._modelEvent.subscribe({event:"PreRender"},function(r){r.profiler=p.profile_animate.addProfile("preRender");p.experienceBase._ManagerSet.preRender(r);p.profile_render=p.profile_animate.addProfile("render")}),postToken:q._modelEvent.subscribe({event:"PostRender"},function(r){r.renderingTime=p.profile_render.stop();r.profiler=p.profile_animate.addProfile("postRender");p.experienceBase._ManagerSet.postRender(r)})};q.defaultAnimationLoop=false;p.disposeFunctions.add(function(){p=null})}p.profile_animate=p.profileFrame.addProfile("viewer["+q.id+"]::animate");q.animate();p.profile_animate.stop()})}m.viewer=this.viewer?n.getMainViewer():null;m.profiler=this.profileFrame.addProfile("managerSet::postUpdate");this.experienceBase._ManagerSet.postUpdate(m);this.profileFrame.stop();if(this.stats){this.stats.postProcess()}},dispose:function(n){var o=this.experienceBase._ManagerSet.getManager("VCXContextManager");o.applyToViewers(function(r){if(r.registredCBs){r.defaultAnimationLoop=true;if(!r.disposed){r._modelEvent.unsubscribe(r.registredCBs.preToken);r._modelEvent.unsubscribe(r.registredCBs.postToken)}delete r.registredCBs;r.animate()}});if(this.model===true){this.experienceBase.modelLoader.dispose()}var m=this.frmWindow.getActionBar();if(m){m.removeCallback(this.callbackActionBar)}this.experienceBase.modelLoader=null;this.frmWindow._experienceBase=null;this.experienceBase.frmWindow=null;this.experienceBase.webApplication=null;var q=this.experienceBase&&this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.unInitialize();if(!q){q=new h(function(r){r()})}var p=this;q.then(function(){p.experienceBase.Clean();p.experienceBase=null;p.disposeFunctions.dispose();p.disposeFunctions=null;p.runloop.stop();p.runloop.dispose();p.runloop=null;p.options=null;p.viewer=null;p.app.dispose();p.app=null;if(!n.disposeFrameWindow===undefined||n.disposeFrameWindow===true){p.frmWindow.dispose()}p.frmWindow=null;p.stats.dispose();p.stats=null;p=null});p._parent()}})});