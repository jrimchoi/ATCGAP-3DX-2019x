define("DS/3DPlayDrawingExperience/DrawingAnnotationManager",["UWA/Class","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events"],function(b,g,e,d,a){var c="#A9A9A9";var f=b.extend({init:function(h){this._parent(h);this._annotCount=0;this.frameWindow=h.frameWindow;this.exp=this.frameWindow.experience;this._rootNode=this.exp.getRootBag();this._annotGroupNode=new e("annotGroupNode");this._rootNode.add(this._annotGroupNode)},getVisibleAnnotationGroups:function(){return[this.exp.getCurrentSheet()]},getAnnotationBag:function(){return this._annotGroupNode},getModel:function(){var h=this.exp.getCurrentSheet();if(h){return h.node}},deleteAllAnnotations:function(){var n=this.exp.sheets;for(var l=0;l<n.length;l++){var k=n[l];var m=k.annotList;for(var h=0;h<m.length;h++){m[h].dispose();m.splice(h,1)}}},dispose:function(){this.deleteAllAnnotations();this._rootNode.remove(this._annotGroupNode);this._annotGroupNode=undefined;this._model=undefined;this._rootNode=undefined;this.exp=undefined;this.frameWindow=undefined},addAnnotViewpointToList:function(h){return this.exp.getCurrentSheet().id},updateViewPoint:function(k){var j=false;var h=this.exp.getCurrentSheet().id;if(k.direction==="left"){for(var l=h-1;l>=0;l--){if(this.exp.sheets[l].annotList.length>0){this.exp.setCurrentSheet(l);j=true;break}}if(!j){for(var l=this.exp.sheets.length-1;l>h;l--){if(this.exp.sheets[l].annotList.length>0){this.exp.setCurrentSheet(l);break}}}}else{if(k.direction==="right"){for(var l=h+1;l<this.exp.sheets.length;l++){if(this.exp.sheets[l].annotList.length>0){this.exp.setCurrentSheet(l);j=true;break}}if(!j){for(var l=0;l<h;l++){if(this.exp.sheets[l].annotList.length>0){this.exp.setCurrentSheet(l);break}}}}}},hideAnnotationsOfCurrentSheet:function(){var h=this.exp.getCurrentSheet();var k=h.annotList;for(var j=0;j<k.length;j++){k[j].repBag.setVisibility(false)}},showAnnotationsOfCurrentSheet:function(){var h=this.exp.getCurrentSheet();var k=h.annotList;for(var j=0;j<k.length;j++){k[j].repBag.setVisibility(true)}},deleteAnnotationWithID:function(p){var o=this.exp.sheets;var h=false;for(var m=0;m<o.length;m++){var l=o[m];var n=l.annotList;for(var k=0;k<n.length;k++){if(n[k].id===p){this._annotGroupNode.remove(n[k].repBag);n[k].dispose();n.splice(k,1);h=true;this._annotCount-=1;break}}if(this._annotCount===0){a.publish({event:"3DPLAY/ANNONATIONTOUR/DISABLE",data:{}})}if(h){return}}},setLowlightAnnotationID:function(p){var o=this.exp.sheets;for(var l=0;l<o.length;l++){var k=o[l];var n=k.annotList;for(var h=0;h<n.length;h++){var m=n[h];if(m.id===p){if(m.type==="text"){m.repBag.children[0].mesh3js.material.setValues({color:c})}else{m.repBag.children[0].mesh3js.material.updatePDSFXUniform("Color",new d.Color(c))}return}}}},addToAnnotGroupNode:function(i){var j=this.exp.sheets;var h=this.exp.getCurrentSheet();this._annotGroupNode.addChild(i.repBag);h.annotList.push(i);this.frameWindow.getViewer().render();this._annotCount+=1;if(this._annotCount>=1&&j.length>1){a.publish({event:"3DPLAY/ANNONATIONTOUR/ENABLE",data:{}})}},getCurrentAnnotViewpoint:function(){return this.exp.getCurrentSheet()},saveAnnotationsToJSON:function(){console.log("Annotation save and reopen functionality is currently not supported for Drawings");return{}},drawAnnotationsFromJSON:function(h){console.log("Annotation save and reopen functionality is currently not supported for Drawings")}});return f});define("DS/3DPlayDrawingExperience/CmdScrollSheet",["DS/ApplicationFrame/Command"],function(b){var a=b.extend({init:function(c){this._parent(c,{isAsynchronous:false});for(var d in c.arguments){if(c.arguments[d].ID=="ScrollSheet"){this.scrollDir=c.arguments[d].Value}}var e=this;this._exp=this.getFrameWindow().experience;this.loadingCompletedToken=this._exp.subscribe("ASSET/LOADINGFINISHED/",function(){if(e._exp&&e._exp.sheets&&e._exp.sheets.length>1){e.enable()}else{e.disable()}})},execute:function(){if(this.scrollDir==="Previous"){this._exp.scrollToPreviousSheet()}else{if(this.scrollDir==="Next"){this._exp.scrollToNextSheet()}}},_destroy:function(){if(this._exp){this._exp.unsubscribe(this.loadingCompletedToken);this.loadingCompletedToken=undefined;this._exp=undefined;this._parent()}}});return a});define("DS/3DPlayDrawingExperience/CmdScale",["UWA/Core","DS/ApplicationFrame/Command"],function(d,b){var a=[25,50,75,100,125,150,200,300,400,500];var c=b.extend({init:function(e){this._parent(e,{isAsynchronous:false});for(var f in e.arguments){if(e.arguments[f].ID=="Scale"){this.scaleMode=e.arguments[f].Value}}},execute:function(){var g=this.getFrameWindow();if(g&&g.experience){var f=g.experience.getZoomScale();var e=this.getScale(f);g.experience.setZoomScale(e)}},getScale:function(g){var h;if(g>500){h=500}else{if(g<25){h=25}else{h=g}}if(this.scaleMode=="+"){for(var e=0;e<a.length-1;++e){if(g<a[e]){h=a[e];break}else{if(g===a[e]){h=a[++e];break}}}}else{for(var f=a.length-1;f>=1;--f){if(g>a[f]){h=a[f];break}else{if(g===a[f]){h=a[--f];break}}}}return h}});return c});var t=["DS/PADUtils/PADUtilsServices"];define("DS/3DPlayDrawingExperience/3DPlayDrawingExperience",["DS/3DPlayExperienceModule/PlayExperience3D","DS/SVGLoader/SVGNode","DS/WebSystem/Settings","DS/3DPlay/3DPlay","DS/WebSystem/Nls","DS/CoreEvents/Events","DS/3DPlayDrawingExperience/DrawingAnnotationManager","DS/WebUtils/ContextedSingleton"].concat(t),function(c,h,a,f,j,k,i,b,d){var e;var g=c.extend({init:function(l){this._parent(l);l.workbenchs=[];l.workbenchs.unshift({name:"3DPlayDocumentViewerPrint",module:"3DPlayDocumentViewer"});l.workbenchs.unshift({name:"3DPlayDrawingExperience",module:"3DPlayDrawingExperience"});e=this;this.loadingCompletedToken=this.subscribe("ASSET/LOADINGFINISHED",function(){e.sheetCameraDistance=e.frmWindow.getViewpoint().getTargetDistance();e.zoomScale=100;e.annotationManager=new i({frameWindow:e.frmWindow,context:e.ctx});b.add(e.ctx,"ANNOTATION_MANAGER",e.annotationManager)});this.viewpointChangedToken=k.subscribe({event:"/VISU/"},function(n){if(e.sheetCameraDistance&&e.zoomScale){if(n.eventType=="@onViewpointEndMove"||n.eventType=="@onViewpointChange"){var m=e.frmWindow.getViewpoint().getTargetDistance();e.zoomScale=Math.floor(100*(e.sheetCameraDistance/m))}}})},onPreCreate:function(){this._parent();this.mabModel={speeddial:[{id:"AnnotationCommands",rsc:"3DPlay/3DPlayExperience3D"},{id:"Reframe",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"Share",icon:"3DPlay/assets/icons/32/I_3DSHAREShare.png",flyout:[]}],sections:[{id:"ScaleP",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience",nls:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"ScaleM",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience",nls:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"Previous",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience",nls:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"Next",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience",nls:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"AnnotationTour",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D"},{id:"Print2DRealSize",rsc:"3DPlayDocumentViewer/3DPlayDocumentViewer",nls:"3DPlayDocumentViewer/3DPlayDocumentViewer"}]};if(this._iOS){this.mabModel.speeddial[2].flyout=[{id:"ShareTo3DSwYm",rsc:"3DPlay/3DPlay"},{id:"SharePrint",rsc:"3DPlay/3DPlay"}]}else{this.mabModel.speeddial[2].flyout=[{id:"ShareTo3DSwYm",rsc:"3DPlay/3DPlay"},{id:"ShareDownload",rsc:"3DPlay/3DPlay"},{id:"SharePrint",rsc:"3DPlay/3DPlay"}]}},dispose:function(){if(this.viewpointChangedToken){k.unsubscribe(this.viewpointChangedToken);this.viewpointChangedToken=undefined}if(this.loadingCompletedToken){this.unsubscribe(this.loadingCompletedToken);this.loadingCompletedToken=undefined}if(this.annotationManager){this.annotationManager=undefined}e=undefined;this._parent()},loadAsset:function(m){if(m.asset.type=="V6Drawing"&&m.asset.backup_type){m.asset.type=m.asset.backup_type;m.asset.backup_type=undefined}if(m.asset.dtype=="V6Drawing"&&m.asset.backup_dtype){m.asset.dtype=m.asset.backup_dtype;m.asset.backup_dtype=undefined}var n=m.asset.physicalid;if(m){e.onModelLoadingStarted();d.updatePlatformId(m.asset.tenant);var l=this.pad3DViewer.getController();l.getAttributes({ids:[n],attributes:["svg"],callbacks:{onComplete:function(o){if(o[n]&&o[n].svg&&o[n].svg!==""){var p=new XMLHttpRequest();p.onload=e._loadSvg;p.open("GET",o[n].svg,true);p.send(null)}else{j.nls("3DPlay/Core","LoadingError_NO_GEOMETRY",function(q){f.displayNotification({ctx:e.ctx,msg:q})})}},onFailure:function(o){j.nls("3DPlay/Core","LoadingError_NO_GEOMETRY",function(p){f.displayNotification({ctx:e.ctx,msg:p})})}}})}},_loadSvg:function(s){var u=e.frmWindow.experience.getRootBag();var l=new DOMParser();e.rawSVG=s.currentTarget.responseText;var w=l.parseFromString(s.currentTarget.responseText,"image/svg+xml");var q=(w.children)?w.children[0]:w.childNodes[1];var n=false;var v=0;e.sheets=[];e.currentSheetIndex=0;var m=function(z,y){var x=this;this.id=z;this.node=y;this.annotList=[];this.onClickCB=function(A){e.setCurrentSheet(x.id)}};var r=(q.children)?q.children:q.childNodes;for(var p=0;p<r.length;p++){if(r[p].nodeName==="svg"){n=true;var o=new h(r[p],r[p].id);u.addChild(o);e.sheets.push(new m(v,o));v++}}if(!n){var o=new h(q,0);u.addChild(o);e.sheets.push(new m(p,o))}if(a.get("3DPlay.ShowLeftPanelForDrawings")){require(["DS/3DPlayUtils/LeftPanel"],function(x){e.listOfSheets=new x({items:e.sheets,container:e.frmWindow.getUIFrame()})})}e.updateView();e.modelLoader.onLoadedCB()},getSource:function(){return this.rawSVG},getCurrentSheetIndex:function(){return this.currentSheetIndex},getNumberOfSheets:function(){return this.sheets.length},scrollToNextSheet:function(){if(this.currentSheetIndex<this.sheets.length-1){this.annotationManager.hideAnnotationsOfCurrentSheet();this.currentSheetIndex=this.currentSheetIndex+1;this.annotationManager.showAnnotationsOfCurrentSheet();this.updateView()}},scrollToPreviousSheet:function(){if(this.currentSheetIndex>0){this.annotationManager.hideAnnotationsOfCurrentSheet();this.currentSheetIndex=this.currentSheetIndex-1;this.annotationManager.showAnnotationsOfCurrentSheet();this.updateView()}},setCurrentSheet:function(l){if(l>=0&&l<this.sheets.length){this.annotationManager.hideAnnotationsOfCurrentSheet();this.currentSheetIndex=l;this.annotationManager.showAnnotationsOfCurrentSheet();this.updateView()}},getCurrentSheet:function(){return this.sheets[this.currentSheetIndex]},setZoomScale:function(n){this.zoomScale=n;var l=this.frmWindow.getViewpoint();var m=(this.sheetCameraDistance*100)/this.zoomScale;l.moveTo({distanceToTarget:m,duration:200});this.frmWindow.getViewer().render()},getZoomScale:function(){return this.zoomScale},updateView:function(){for(var l=0;l<this.sheets.length;l++){if(l===this.currentSheetIndex){this.sheets[l].node.setVisibility(true)}else{this.sheets[l].node.setVisibility(false)}}this.frmWindow.getViewer().render()},onPostCreate:function(){var l=this.frmWindow.getViewer();l.setPicking({activated:false,trapSelection:false,displayHL:false});l.setPrePicking({activated:false,displayHL:false});l.set2DMode(true);this._parent()}});return g});define("DS/3DPlayDrawingExperience/3DPlayDrawingPreview",["DS/3DPlayDrawingExperience/3DPlayDrawingExperience"],function(b){var a=b.extend({init:function(c){this._parent(c);c.workbenchs=[];c.workbenchs.unshift({name:"3DPlayDrawingPreview",module:"3DPlayDrawingExperience"})},dispose:function(){this._parent()},onPreCreate:function(){this.args.visu={picking:false};this._parent();var c=this;this.args.ui={keepActionbarClosed:true,onActionBarReady:function(){if(c&&c.frmWindow){c.frmWindow.getActionBar().close();c=undefined}}};this.mabModel={speeddial:[{id:"Reframe",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"Previous",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"Next",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience"}]}}});return a});