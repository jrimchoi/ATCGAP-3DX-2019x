define("DS/CfgRuleExpressionComponent/Presenter/CfgRuleExpressionComponentExpressionGenerator",["DS/CfgDictionary/CfgDictionaryTypeEnum","DS/CfgDictionary/CfgDictionaryOperatorEnum"],function(b,a){var c={};c.generateRawExpression=function(m){var j="";if(m&&m&&m.length!==0){var e=0;var h=false;var d=false;var n=false;var o=false;var k=null;var g=null;var l=null;var f=false;for(e=0;e<m.length;e+=1){f=false;g=m[e].type;l=m[e+1]?m[e+1].type:null;k=m[e];if(g===b.VARIANT&&l===b.VALUE){d=true;f=true}else{if(g===b.VALUE&&l===b.VALUE){n=false;f=false}else{if(g===b.VALUE&&l!==b.VALUE){f=false;n=true}}}if(!f){if(g===b.VALUE){if(d){j+=" (";d=false}if(!n){j+=k.id+" OR "}else{j+=k.id}if(n){j+=") ";n=false}}else{if(g===a.binary_operator||g===a.unary_operator||g===a.opening_separator||g===a.closing_separator){j+=" "+k.value}else{j+=" "+k.id}}}}j=j.replace(/  +/g," ");j=(j[0]===" ")?j.substr(1):j;return j}};c.generateExpression=function(g){var d="";var h="EREV1:";var f="1.0.1";var i="";var e={};e.version=f;i=c.generateRawExpression(g);e.expression=i;d=h+JSON.stringify(e);return d};c.generateDependencies=function(h){var j=[];var f=0;var g=[];for(f=0;f<h.length;f+=1){if(h[f].type===b.VARIANT||h[f].type===b.VALUE||h[f].type===b.OPTION||h[f].type===b.PACK){var d=h[f].id;if(g.indexOf(d)<0){g.push(d)}}}var e={};for(f=0;f<g.length;f+=1){e={};e.id=g[f];j.push(e)}return j};return c});define("DS/CfgRuleExpressionComponent/Model/CfgRuleExpressionModel",["UWA/Class/Model"],function(a){var b=a.extend({editable:null,fullDictionary:null,autoCompleteRuleModel:null,languageInformation:null,solverKey:null});return b});define("DS/CfgRuleExpressionComponent/Presenter/CfgRuleExpressionPresenter",["DS/CfgRuleExpressionComponent/Model/CfgRuleExpressionModel","DS/CfgAutoCompleteComponent/Presenter/CfgAutoCompletePresenter","DS/CfgLanguageInformationComponent/Presenter/CfgLanguageInformationPresenter","DS/CfgDictionary/CfgDictionaryMapperUtils","DS/Core/ModelEvents","DS/UIKIT/Input/Button","DS/UIKIT/Input/ButtonGroup","DS/UIKIT/Spinner","DS/UIKIT/Popover","DS/UIKIT/Iconbar","DS/UIKIT/SuperModal","DS/ENOXSplitViewVertical/js/ENOXSplitViewVertical","DS/UIKIT/Mask","DS/Handlebars/Handlebars","DS/CfgRuleExpressionComponent/Presenter/CfgRuleExpressionComponentExpressionGenerator","DS/CfgSolver/CfgSolverServices","i18n!DS/CfgRuleExpressionComponent/assets/nls/CfgRuleExpressionComponent","text!DS/CfgRuleExpressionComponent/View/CfgRuleExpressionTemplate.html","css!DS/CfgRuleExpressionComponent/View/CfgRuleExpressionComponent.css"],function(d,t,q,b,n,m,o,i,r,c,p,k,u,e,f,g,s,l,j){var a=false;var h=function(w,v){this._ruleExpressionModel=w;this._fullDictionary=w.fullDictionary;this._mapDico=b.dicoMinifiedV3ToMap(this._fullDictionary);this._solverKey=w.solverKey;this._languageInformation=w.languageInformation;this._ruleExpressionExpression=w.autoCompleteRuleModel;this._ruleName=v.ruleName?v.ruleName:s._rule;this._editable=(v&&v.editable===false)?false:true;this._isInConflict=null;this._initialExpression=JSON.parse(JSON.stringify(w.autoCompleteRuleModel));this._localModelEvents=v.localModelEvents?v.localModelEvents:new n();this._initLanguageInformation();this._initAutoComplete();this._initInternalActions();this._createOKCancelActions();this._initDiv()};h.prototype._initAutoComplete=function(){this._cfgAutoCompleteRulePresenter=null;var v={};v.currentExpression=this._ruleExpressionExpression;v.dictionary=this._fullDictionary;v.withAdvancedOperator=true;v._localModelEvent=this._localModelEvents;v.solverKey=this._solverKey;v.editable=this._editable;v.dictionary_mapped=this._mapDico;this._cfgAutoCompleteRulePresenter=new t(v)};h.prototype._initLanguageInformation=function(){this._cfgLanguageInformationPresenter=null;var v={};v._givenModel=this._languageInformation;v._localModelEvent=this._localModelEvents;this._cfgLanguageInformationPresenter=new q(v)};h.prototype._initDiv=function(){var v=e.compile(l);var w=v();this._container=document.createElement("div");this._container.innerHTML=w;this._container=this._container.firstElementChild;UWA.extendElement(this._container);this._splitViewVertical=new k();var x={originalTop:60,sizeType:"px",resizable:true};this._splitViewVertical.init(x);this._splitViewVertical.setMaxHeightOnTop(2500);this._splitViewVertical.setNumberTop(60);this._splitViewVertical.inject(this._container.querySelector(".ruleexpression-frame"));this._cfgAutoCompleteRulePresenter.inject(this._splitViewVertical.getTop());this._cfgAutoCompleteRulePresenter.render();this._cfgLanguageInformationPresenter.inject(this._splitViewVertical.getBot());this._cfgLanguageInformationPresenter.render();this._actionBar=new c({renderTo:this._container.querySelector(".ruleexpression-header-content"),items:this._actions});this._localModelEvents.subscribe({event:"onChangeExpression"},this._checkSolverCompatibility.bind(this));this._localModelEvents.subscribe({event:"onCheckExpression"},this._checkSolverCompatibility.bind(this));this._subResize();this._OkCancel.inject(this._container.querySelector(".ruleexpression-footer-content"))};h.prototype._initInternalActions=function(){this._actions=[];var y=null;var x=this;var w={text:"Solver computing",title:"Solver computing",icon:"progress-0",fonticon:"progress-0",selected:false,handler:function(A,z){if(a){console.log("button should be not clickable")}}};var v={text:s.conflict_with_existing_rules,title:s.conflict_with_existing_rules,icon:"attention",fonticon:"attention",selected:false,handler:function(C,A){if(y==null){UWA.extendElement(x._internalActionConflictContainer);y=new r({target:x._internalActionConflictContainer,position:"left",body:s.under_computation+"...",title:s.conflicting_additional_information});y.elements.container.setAttribute("tabindex","-1");y.elements.container.onblur=function(){y.hide()}}if(a){console.log("calculating conflict reason on "+x._solverKey+" "+f.generateExpression(x._cfgAutoCompleteRulePresenter.getExpression()))}var z=x._getSolverObject(true);if(a){console.log(z)}var B=function(H,G){x._internalActionConflictContainer.setStyle("pointerEvents","auto");x._internalActionLoaderContainer.classList.add("displaynone");y.show();y.elements.container.focus();if("string"===typeof H){H=JSON.parse(H)}if(H==undefined||(H._rc!=="OK"&&H._rc!=="S_FALSE"&&H._rc!=="Validity_KO")){if(a){if(H){(H._rc)?console.log(H._rc):console.log("error")}}y.setBody(s._internal_error);return}else{if(H===""){x._isInConflict=false;x._internalActionConflictContainer.classList.add("displaynone")}else{var E="";var F=0;for(F=0;F<H._data.conflictingRules.length;F+=1){if(F>0){E+=", "}var D=H._data.conflictingRules[F].substring(0,32);E+=(x._mapDico[D])?x._mapDico[D].name:H._data.conflictingRules[F]}if(E!==""){y.setBody(s.invalid_expression_due_to+" : "+E)}else{y.setBody(s.invalid_expression_without_reason)}}}};x._internalActionConflictContainer.setStyle("pointerEvents","none");x._internalActionLoaderContainer.classList.remove("displaynone");y.setBody(s.under_computation+"...");y.show();y.elements.container.focus();if(x._solverKey&&z){g.computeAnswer(z,x._solverKey,null,true).then(B)}else{B("",null)}}};this._actions.push(w);this._actions.push(v)};h.prototype._createOKCancelActions=function(){this._OkCancelIsDisplayed=false;var C=this;var A=function(){if(C._OkCancelIsDisplayed){}else{C._container.querySelector(".ruleexpression-footer-content").classList.remove("displaynone");C._localModelEvents.publish({event:"onResize",data:null});C._splitViewVertical._resize(C._splitViewVertical.getTop().clientHeight-40)}C._OkCancelIsDisplayed=true};var B=function(E){u.unmask(C._container);C._container.querySelector(".ruleexpression-footer-content").classList.add("displaynone");C._localModelEvents.publish({event:"onResize",data:null});C._splitViewVertical._resize(C._splitViewVertical.getTop().clientHeight+40);C._OkCancelIsDisplayed=false;if(E){C._initialExpression=JSON.parse(JSON.stringify(C.getExpression()))}else{C._cfgAutoCompleteRulePresenter.setExpression(JSON.parse(JSON.stringify(C._initialExpression)));C._cfgAutoCompleteRulePresenter.createInitialExpression();C._localModelEvents.publish({event:"onCheckExpression",data:null})}};var w=function(){u.unmask(C._container)};C._localModelEvents.subscribe({event:"onChangeExpression"},A);C._localModelEvents.subscribe({event:"onDone"},B);C._localModelEvents.subscribe({event:"onFailSave"},w);var y=new m({value:s.save,className:"primary"});var v=function(){u.mask(C._container);var E=function(G){if(G===true){if(a){console.log("trying to save rule")}C._localModelEvents.publish({event:"onSave",data:C.getExpression()})}else{C._localModelEvents.publish({event:"onFailSave"})}};if(C.containsError()&&C.isInConflict()===true){}else{if(C.containsError()){var F=new p({renderTo:C._container});F.confirm(s._confirmation_save_rule+" "+C._ruleName+"? "+s._error_confirmation_message,s._save_rule,E)}else{if(C._cfgRuleExpressionPresenter&&C._cfgRuleExpressionPresenter.isInConflict()===true){var F=new p({renderTo:C._container});F.confirm(s._confirmation_save_rule+" "+C._ruleName+"? "+s._conflict_confirmation_message,s._save_rule,E)}else{E(true)}}}};y.addEvent("onClick",v);var D=new m({value:s._undo,className:"default"});var x=function(){B(false)};D.addEvent("onClick",x);var z=new o({buttons:[y,D]});C._OkCancel=z};h.prototype.inject=function(v){v.appendChild(this._container);this._triggerResizeInit();this._localModelEvents.publish({event:"onCheckExpression",data:null})};h.prototype._subResize=function(){var w=this;var v=function(){var x=w._container.querySelector(".ruleexpression-frame");var B=w._container.querySelector(".ruleexpression-language-information").clientHeight;var A=w._container.querySelector(".ruleexpression-header-content").clientHeight;var z=w._container.querySelector(".ruleexpression-footer-content").clientHeight;var y=B+A+z;x.style.height="calc(100% - "+y+"px)"};w._localModelEvents.subscribe({event:"onResize"},v);w._localModelEvents.subscribe({event:"onResizeLIP"},function(x){var y=w._container.querySelector(".ruleexpression-frame").clientHeight;if(x){w._splitViewVertical._resize(y/2)}else{w._splitViewVertical._resize(y-60);w._cfgLanguageInformationPresenter._accordion.unselectAll()}})};h.prototype._getSolverObject=function(y){var B=this;var w=f.generateRawExpression(B._cfgAutoCompleteRulePresenter.getExpression());var C=(y)?"true":"false";var E={};var D={};var v={};v.expression=w;v.computeCause=C;if(w===""){return null}var x="checkExpressionValidity";var z="solverRule";var A="CfgRuleExpressionPresenter";D._data=v;D._from=A;D._to=z;D._request=x;return D};h.prototype.getExpression=function(){return this._cfgAutoCompleteRulePresenter.getExpression()};h.prototype._checkSolverCompatibility=function(){var x=this;x._internalActionConflictContainer=x._container.querySelectorAll(".iconbar li")[1];x._internalActionLoaderContainer=x._container.querySelectorAll(".iconbar li")[0];var v=!x._cfgAutoCompleteRulePresenter.isThereError();if(v){var w=x._getSolverObject(false);var y=function(A,z){if(A!==""){A=JSON.parse(A)}x._internalActionConflictContainer.setStyle("pointerEvents","auto");x._internalActionLoaderContainer.classList.add("displaynone");if(A==undefined||(A._rc!=="OK"&&A._rc!=="S_FALSE"&&A._rc!=="Validity_KO")){if(a){if(A){(A._rc)?console.log(A._rc):console.log("error")}}x._internalActionConflictContainer.classList.add("displaynone");x._isInConflict=null;return}else{if(A===""){x._isInConflict=false;x._internalActionConflictContainer.classList.add("displaynone")}else{if(A._rc==="OK"||A._rc==="S_FALSE"){x._isInConflict=false;x._internalActionConflictContainer.classList.add("displaynone")}else{x._isInConflict=true;x._internalActionConflictContainer.classList.remove("displaynone")}}}};if(x._solverKey&&w){x._internalActionConflictContainer.setStyle("pointerEvents","none");x._internalActionLoaderContainer.classList.remove("displaynone");g.computeAnswer(w,x._solverKey,null,true).then(y)}else{y("",null)}}else{x._isInConflict=false;x._internalActionConflictContainer.classList.add("displaynone")}};h.prototype._triggerResizeInit=function(){this._localModelEvents.publish({event:"onResize",data:null});if(this._cfgLanguageInformationPresenter._isOpen){this._localModelEvents.publish({event:"onResizeLIP",data:true})}else{this._localModelEvents.publish({event:"onResizeLIP",data:false})}};h.prototype.addToolBarAction=function(w){this._actions.push(w);this._container.querySelector(".ruleexpression-header-content").innerHTML="";this._actionBar=new c({renderTo:this._container.querySelector(".ruleexpression-header-content"),items:this._actions});var v=this;v._internalActionConflictContainer=v._container.querySelectorAll(".iconbar li")[1];v._internalActionLoaderContainer=v._container.querySelectorAll(".iconbar li")[0];v._internalActionLoaderContainer.style.pointerEvents="none";v._internalActionLoaderContainer.style.color="white";var x=new i().inject(v._internalActionLoaderContainer).show();x.elements.container.style.position="absolute";x.elements.container.style.left="8px";x.elements.container.style.top="4px"};h.prototype.isInConflict=function(){return this._isInConflict};h.prototype.containsError=function(){return this._cfgAutoCompleteRulePresenter.isThereError()};return h});