/*!  COPYRIGHT DASSAULT SYSTEMES 2014   */
/*! based on Three.js Copyright Â© 2010-2014 three.js authors */
/*! Uses SMAA. Copyright (C) 2011 by Jorge Jimenez, Jose I. Echevarria,
Belen Masia, Fernando Navarro and Diego Gutierrez. */
(function(){var a=["UWA/Core","UWA/Class"];if(window.location.protocol!=="file:"){a.push("text!DS/QualityManager/assets/mdl_GIVisualQualityPresets.json")}define("DS/QualityManager/QMGIPresetStreamer",a,function(b,d,c){var e=d.singleton({init:function(){this.GIQualityPresets=this.getQualityPresets();if(!b.is(this.GIQualityPresets)){return}},setItem:function(j,l){if(!b.is(localStorage)||!b.is(this.GIQualityPresets)){return}var k=this.GIQualityPresets;var f=j.split("/");var g=f.length;for(var h=0;h<g;h++){if(h==g-1){if(b.is(k)){k[f[h]]=l}}else{if(b.is(k)){k=k[f[h]]}}}},getItem:function(j){if(!b.is(localStorage)||!b.is(this.GIQualityPresets)){return null}var k=this.GIQualityPresets;var f=j.split("/");var g=f.length;for(var h=0;h<g;h++){if(b.is(k)){k=k[f[h]]}}return k},getQualityPresets:function(){var f=null;if(!b.is(localStorage)){return f}var g=localStorage.getItem("GIQualityPresets");if(b.is(g)){try{f=JSON.parse(g)}catch(h){console.error("Error parsing GIQualityPresets:",h)}}else{f=this.buidQualityPresets()}return f},commit:function(){if(!b.is(localStorage)||!b.is(this.GIQualityPresets)){return}localStorage.setItem("GIQualityPresets",JSON.stringify(this.GIQualityPresets))},retoreDB:function(){this.GIQualityPresets=this.getQualityPresets()},buidQualityPresets:function(){this.GIQualityPresets=c?JSON.parse(c):null;if(b.is(this.GIQualityPresets)){this.commit()}return this.GIQualityPresets},});return e})})();(function(){var a=["UWA/Core","UWA/Class"];if(window.location.protocol!=="file:"){a.push("text!DS/QualityManager/assets/mdl_QualityManagerPreset.json")}define("DS/QualityManager/QMPresetStreamer",a,function(b,d,c){var e=d.singleton({init:function(){this.databaseKey=null;this.qualityPresets=null},initDataBase:function(f){this.databaseKey=f;if(this.databaseKey==null){this.databaseKey="default_qualityPresets"}this.qualityPresets=this.getQualityPresets();if(!b.is(this.qualityPresets)){return}},setItem:function(j,l){if(!b.is(localStorage)||!b.is(this.qualityPresets)){return}var k=this.qualityPresets;var f=j.split("/");var g=f.length;for(var h=0;h<g;h++){if(h==g-1){if(b.is(k)){k[f[h]]=l}}else{if(b.is(k)){k=k[f[h]]}}}},getItem:function(j){if(!b.is(localStorage)||!b.is(this.qualityPresets)){return null}var k=this.qualityPresets;var f=j.split("/");var g=f.length;for(var h=0;h<g;h++){if(b.is(k)){k=k[f[h]]}}return k},getQualityPresets:function(){var f=null;if(!b.is(localStorage)){return f}var g=localStorage.getItem(this.databaseKey);if(b.is(g)){try{f=JSON.parse(g)}catch(h){console.error("Error parsing qualityPresets:",h)}}else{f=this.buidQualityPresets()}return f},commit:function(){if(!b.is(localStorage)||!b.is(this.qualityPresets)){return}localStorage.setItem(this.databaseKey,JSON.stringify(this.qualityPresets))},retoreDB:function(){this.qualityPresets=this.getQualityPresets()},buidQualityPresets:function(){this.qualityPresets=c?JSON.parse(c):null;if(b.is(this.qualityPresets)){this.commit()}return this.qualityPresets},});return e})})();var Stats=function(){var I,P,C=0,B=0,H=Date.now(),v=H,A=H,E=0,z=1000,y=0,L,G,K,O=[[16,16,48],[0,255,255]],D=0,x=1000,w=0,M,F,J,N=[[16,48,16],[0,255,0]];I=document.createElement("div");I.style.cursor="pointer";I.style.width="80px";I.style.opacity="0.9";I.style.zIndex="10001";I.addEventListener("mousedown",function(b){b.preventDefault();C=(C+1)%2;C==0?(L.style.display="block",M.style.display="none"):(L.style.display="none",M.style.display="block")},!1);L=document.createElement("div");L.style.textAlign="left";L.style.lineHeight="1.2em";L.style.backgroundColor="rgb("+Math.floor(O[0][0]/2)+","+Math.floor(O[0][1]/2)+","+Math.floor(O[0][2]/2)+")";L.style.padding="0 0 3px 3px";I.appendChild(L);G=document.createElement("div");G.style.fontFamily="Helvetica, Arial, sans-serif";G.style.fontSize="9px";G.style.color="rgb("+O[1][0]+","+O[1][1]+","+O[1][2]+")";G.style.fontWeight="bold";G.innerHTML="FPS";L.appendChild(G);K=document.createElement("div");K.style.position="relative";K.style.width="74px";K.style.height="30px";K.style.backgroundColor="rgb("+O[1][0]+","+O[1][1]+","+O[1][2]+")";for(L.appendChild(K);K.children.length<74;){P=document.createElement("span"),P.style.width="1px",P.style.height="30px",P.style.cssFloat="left",P.style.backgroundColor="rgb("+O[0][0]+","+O[0][1]+","+O[0][2]+")",K.appendChild(P)}M=document.createElement("div");M.style.textAlign="left";M.style.lineHeight="1.2em";M.style.backgroundColor="rgb("+Math.floor(N[0][0]/2)+","+Math.floor(N[0][1]/2)+","+Math.floor(N[0][2]/2)+")";M.style.padding="0 0 3px 3px";M.style.display="none";I.appendChild(M);F=document.createElement("div");F.style.fontFamily="Helvetica, Arial, sans-serif";F.style.fontSize="9px";F.style.color="rgb("+N[1][0]+","+N[1][1]+","+N[1][2]+")";F.style.fontWeight="bold";F.innerHTML="MS";M.appendChild(F);J=document.createElement("div");J.style.position="relative";J.style.width="74px";J.style.height="30px";J.style.backgroundColor="rgb("+N[1][0]+","+N[1][1]+","+N[1][2]+")";for(M.appendChild(J);J.children.length<74;){P=document.createElement("span"),P.style.width="1px",P.style.height=Math.random()*30+"px",P.style.cssFloat="left",P.style.backgroundColor="rgb("+N[0][0]+","+N[0][1]+","+N[0][2]+")",J.appendChild(P)}return{domElement:I,update:function(){H=Date.now();D=H-v;x=Math.min(x,D);w=Math.max(w,D);F.textContent=D+" MS ("+x+"-"+w+")";var b=Math.min(30,30-D/200*30);J.appendChild(J.firstChild).style.height=b+"px";v=H;B++;if(H>A+1000){E=Math.round(B*1000/(H-A)),z=Math.min(z,E),y=Math.max(y,E),G.textContent=E+" FPS ("+z+"-"+y+")",b=Math.min(30,30-E/100*30),K.appendChild(K.firstChild).style.height=b+"px",A=H,B=0}}}};define("DS/VisuUnstreamers/StreamObject",["UWA/Class"],function(b){var a=b.extend({init:function(c,d){this.blob=c;this.filename=d;if(this.blob&&!this.blob.userData){this.blob.userData={}}return this},open:function(){},close:function(){},getUserData:function(){return this.blob?this.blob.userData:null},readAsArrayBuffer:function(){},readAsBlob:function(){},readAsText:function(){},readAsXML:function(){}});return UWA.namespace("THREEDS/StreamObject",a)});define("VisuUnstreamers/StreamObject",["DS/VisuUnstreamers/StreamObject","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuUnstreamers/StreamObject");return b});define("DS/Visualization/Measurable",["UWA/Class","DS/Visualization/ThreeJS_R57"],function(c,k){var e=6,j=7,h=7,b=4,q=6,o=7,m=8,l=[0,8,8,2,2],n=[0,2,2,1,2],g=new Uint8Array(4),a=new DataView(g.buffer,0,4),p=new Uint8Array(8),f=new DataView(p.buffer,0,8);var d=c.extend({init:function(s){this.sgNode=s;this.size=0;if(s.decoration){if(s.decoration instanceof Array){this.string=s.decoration;this.size=this.string[0]}else{if(s&&s.group&&s.group.geometry){if(s.group.geometry.decorations&&s.group.geometry.decorations.length){var r=s.group.geometry.decorations;var u=s.decoration-1;this.size=r[u]+1;this.string=new Array(this.size);for(var t=0;t<this.size;t++){this.string[t]=r[u++]}}else{this.string=[]}}}}else{this.string=[]}this.type=d.TYPEUNKNOWN;this.version=0;this.conversion=true},getType:function(){if(this.size>0){this.readHeader()}else{this.type=d.TYPEUNKNOWN}return this.type},readHeader:function(){var s=0;if(this.size>=l[3]){if(this.string[1]==0){if(this.size>=l[1]){var r=this.readInt(1,2);this.version=r[0];this.type=r[1];return}}else{if(this.string[1]=="2".charCodeAt(0)){this.version=2}else{if(this.string[1]=="3".charCodeAt(0)){this.version=3}else{if(this.string[1]=="4".charCodeAt(0)){this.version=4}}}s=this.string[2]}switch(s){case 49:this.type=d.TYPEUNKNOWN;break;case 50:this.type=d.TYPEPLANE;break;case 51:this.type=d.TYPECYLINDER;break;case 52:this.type=d.TYPECONE;break;case 53:this.type=d.TYPESPHERE;break;case 54:this.type=d.TYPELINE;break;case 55:this.type=d.TYPECIRCLE;break;case 56:this.type=d.TYPETORUS;break;default:break}}},getPlane:function(){if(this.type==d.TYPEPLANE){return this.readPlane()}return null},getCone:function(){if(this.type==d.TYPECONE){return this.readCone()}return null},getSphere:function(){if(this.type==d.TYPESPHERE){return this.readSphere()}return null},getCircle:function(){if(this.type==d.TYPECIRCLE){return this.readCircle()}return null},getCylinder:function(){if(this.type==d.TYPECYLINDER){return this.readCylinder()}return null},getLine:function(){if(this.type==d.TYPELINE){return this.readLine()}return null},getTorus:function(){if(this.type==d.TYPETORUS){return this.readTorus()}return null},readTorus:function(){var r=[0,0,0];var v=[0,0,1];var J=0;var F=0;var D=[];if(this.version==3){D=this.readFloat(l[this.version]+1,m);var I=D[0];var H=D[1];var G=D[2];var u=D[3];var t=D[4];var K=D[5];var E=D[6];var w=1-u*u-t*t;var s=(w>=0)?Math.sqrt(w):0;if(K<0){s=-s;K=-K}r=[I,H,G];v=[u,t,s];J=E;F=K}else{if(this.version==1||this.version==2||this.version==4){D=this.readDouble(l[this.version]+1,m);r=[D[0],D[1],D[2]];v=[D[3],D[4],D[5]];J=D[7];F=D[6]}}return{center:r,axis:v,maxRadius:F,minRadius:J}},readCone:function(){var r=[0,0,0];var v=[0,0,1];var I=0;var E=[];if(this.version==3){E=this.readFloat(l[this.version]+1,h);var H=E[0];var G=E[1];var F=E[2];var u=E[3];var t=E[4];var w=E[5];var D=1-u*u-t*t;var s=(D>=0)?Math.sqrt(D):0;if(w<0){s=-s;w=-w}var r=[H,G,F];var v=[u,t,s];var I=w}else{if(this.version==1||this.version==2||this.version==4){E=this.readDouble(l[this.version]+1,h);r=[E[0],E[1],E[2]];v=[E[3],E[4],E[5]];I=E[6]}}return{center:r,axis:v,semiAngle:I}},readCircle:function(){var r=[0,0,0];var t=[0,0,1];var y=0;var u=[];if(this.version==3){u=this.readFloat(l[this.version]+1,o);r=[u[0],u[1],u[2]];y=u[3];var s=this.sgNode.start;var A=this.sgNode.group.geometry;var x=A.vertexIndexArray[s];var B=[A.vertexPositionArray[x*3],A.vertexPositionArray[x*3+1],A.vertexPositionArray[x*3+2]];var x=A.vertexIndexArray[s+1];var z=[A.vertexPositionArray[x*3],A.vertexPositionArray[x*3+1],A.vertexPositionArray[x*3+2]];var w=new k.Vector3(B[0],B[1],B[2]);var v=new k.Vector3(z[0],z[1],z[2]);var C=new k.Vector3(r[0],r[1],r[2]);v.sub(w);C.sub(w);v.cross(C);v.normalize();t=[v.x,v.y,v.z]}else{if(this.version==1||this.version==2||this.version==4){u=this.readDouble(l[this.version]+1,o);r=[u[0],u[1],u[2]];t=[u[3],u[4],u[5]];y=u[6]}}return{center:r,axis:t,radius:y}},readCylinder:function(){var r=[0,0,0];var v=[0,0,1];var E=0;var D=[];if(this.version==3){D=this.readFloat(l[this.version]+1,j);var H=D[0];var G=D[1];var F=D[2];var u=D[3];var t=D[4];E=D[5];var w=1-u*u-t*t;var s=(w>=0)?Math.sqrt(w):0;if(E<0){s=-s;E=-E}r=[H,G,F];v=[u,t,s]}else{if(this.version==1||this.version==2||this.version==4){D=this.readDouble(l[this.version]+1,j);r=[D[0],D[1],D[2]];v=[D[3],D[4],D[5]];E=D[6]}}return{center:r,axis:v,radius:E}},readSphere:function(){var t=[0,0,0];var s=0;var u=[];if(this.version==3){u=this.readFloat(l[this.version]+1,b);var r=u[0];var w=u[1];var v=u[2];s=u[3];t=[r,w,v]}else{if(this.version==1||this.version==2||this.version==4){u=this.readDouble(l[this.version]+1,b);t=[u[0],u[1],u[2]];s=u[3]}}return{center:t,radius:s}},readLine:function(){var s=[0,0,0];var t=[1,0,0];var r=[];if(this.version==3){var w=this.sgNode.start;var u=this.sgNode.group.geometry;var v=u.vertexIndexArray[w];s=[u.vertexPositionArray[v*3],u.vertexPositionArray[v*3+1],u.vertexPositionArray[v*3+2]];var v=u.vertexIndexArray[w+1];t=[u.vertexPositionArray[v*3],u.vertexPositionArray[v*3+1],u.vertexPositionArray[v*3+2]]}else{if(this.version==1||this.version==2||this.version==4){r=this.readDouble(l[this.version]+1,q);s=[r[0],r[1],r[2]];t=[r[3],r[4],r[5]]}}return{startPosition:s,endPosition:t}},readPlane:function(){var r=[0,0,0];var t=[1,0,0];var s=[];if(this.version==3){var w=this.sgNode.start;var u=this.sgNode.group.geometry;var v=u.vertexIndexArray[w];r=[u.vertexPositionArray[v*3],u.vertexPositionArray[v*3+1],u.vertexPositionArray[v*3+2]];t=[u.vertexNormalArray[v*3],u.vertexNormalArray[v*3+1],u.vertexNormalArray[v*3+2]]}else{if(this.version==1||this.version==2||this.version==4){s=this.readDouble(l[this.version]+1,e);r=[s[0],s[1],s[2]];t=[s[3],s[4],s[5]]}}return{normal:t,position:r}},readFloat:function(u,t){var r=new Array(t);for(var s=0;s<t;s++){g[3]=this.string[u+s*4];g[2]=this.string[u+s*4+1];g[1]=this.string[u+s*4+2];g[0]=this.string[u+s*4+3];r[s]=a.getFloat32(0,this.conversion)}return r},readInt:function(u,s){var r=new Array(s);for(var t=0;t<s;t++){g[3]=this.string[u+t*4];g[2]=this.string[u+t*4+1];g[1]=this.string[u+t*4+2];g[0]=this.string[u+t*4+3];r[t]=a.getUint32(0,this.conversion)}return r},readDouble:function(u,t){var r=new Array(t);for(var s=0;s<t;s++){p[7]=this.string[u+s*8];p[6]=this.string[u+s*8+1];p[5]=this.string[u+s*8+2];p[4]=this.string[u+s*8+3];p[3]=this.string[u+s*8+4];p[2]=this.string[u+s*8+5];p[1]=this.string[u+s*8+6];p[0]=this.string[u+s*8+7];r[s]=f.getFloat64(0,this.conversion)}return r}});d.TYPEUNKNOWN=1;d.TYPEPLANE=2;d.TYPECYLINDER=3;d.TYPECONE=4;d.TYPESPHERE=5;d.TYPELINE=7;d.TYPECIRCLE=8;d.TYPETORUS=9;return UWA.namespace("THREEDS/Measurable",d)});define("Visualization/Measurable",["DS/Visualization/Measurable","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/Measurable");return b});(function(){var a=window.location.protocol!=="file:"?"text!Visualization/assets/svgmode.json":null;define("DS/Visualization/GetSVGMode",[a],function(c){var b=c&&JSON.parse(c);return{getWebGLMode:function(){return((b&&b.svgMode==="svg")||window.v6ViewerSVGBrowserMode)?false:true}}})})();define("DS/VisuStateOverride/SceneGraphState",["DS/SceneGraphOverrides/SceneGraphState"],function(a){return a});define("VisuStateOverride/SceneGraphState",["DS/SceneGraphOverrides/SceneGraphState"],function(a){return a});define("DS/VisuDataAccess/Ox4XHRWithProxyAbstraction",["UWA/Class","UWA/Data","UWA/Utils","UWA/Utils/Client","UWA/Ajax","UWA/Json","DS/WAFData/WAFData"],function(d,f,g,h,e,c,a){var b=function(){this.executeGetHttpRequest=function(l,q,n,p){if(b.proxyUsage===2){console.log("gestion WAFData");var k=new Object();k.headers=new Object();k.data=new Object();k.data.GET=n;k.method="GET";k.async=true;k.proxy=b.proxymode;k.authentication=b.authentication;k.onComplete=p;k.type=q;var m=a.handleRequest(l,k)}else{if(b.proxyUsage===1){l=j(l,b.server,b.sport)}var o=new XMLHttpRequest();o.open("GET",l,true);o.onload=function(r){p(this.response)};o.setRequestHeader("X-Requested-With","XMLHttpRequest");if(q==="arraybuffer"){o.responseType=q}o.send(n)}};this.executePostHttpRequest=function(l,q,p,o){if(b.proxyUsage==2){console.log("gestion WAFData");var k={timeout:300000,method:"POST",data:p,type:"text",proxy:b.proxymode,authentication:b.authentication,headers:{"Content-type":q,Accept:"text/plain",},onComplete:o,onFailure:function(r){UWA.log("arguments onFailure");UWA.log(arguments)}};if(b.securityToken){k.headers.SecurityToken=b.securityToken}var m=a.handleRequest(l,k)}else{if(b.proxyUsage==1){l=j(l,b.server,b.sport)}var n=new XMLHttpRequest();n.open("POST",l);n.onload=function(r){o(this.response)};n.setRequestHeader("Content-type",q);n.setRequestHeader("Accept","text/plain");n.send(p)}};this.executePostHttpRequestWithOptions=function(l,k){if(b.proxyUsage==2){k.timeout=300000;k.method="POST";k.type=k.type?k.type:"text";k.proxy=b.proxymode;k.authentication=b.authentication;k.onFailure=k.onFailure?k.onFailure:function(o){UWA.log("arguments onFailure");UWA.log(arguments)};k.headers?k.headers:{};k.headers.Accept?k.headers.Accept:"text/plain";var m=a.handleRequest(l,k)}else{if(b.proxyUsage==1){l=j(l,b.server,b.sport)}var n=new XMLHttpRequest();n.open("POST",l);n.onload=function(o){callback(this.response)};n.setRequestHeader("Content-type",k.headers.Content-type);n.setRequestHeader("Accept",k.headers.Accept?k.headers.Accept:"text/plain");n.send(postParams)}};this.executePostHttpRequest2=function(m,r,q,p,l){if(b.proxyUsage==2){console.log("gestion WAFData");var k={timeout:300000,method:"POST",data:q,type:"text",proxy:b.proxymode,authentication:b.authentication,headers:{"Content-type":r,Accept:"text/plain",},onComplete:p,onFailure:function(s){UWA.log("arguments onFailure");UWA.log(arguments)}};if(l.responseType!=null){k.type=l.responseType}var n=a.handleRequest(m,k)}else{if(b.proxyUsage==1){m=j(m,b.server,b.sport)}var o=new XMLHttpRequest();o.open("POST",m);o.onload=function(s){p(this.response)};o.setRequestHeader("Content-type",r);o.setRequestHeader("Accept","application/octet-stream");if(l.responseType!=null){o.responseType=l.responseType}o.send(q)}};this.executeSyncPostHttpRequest=function(m,q,p){if(b.proxyUsage==2){console.log("gestion WAFData");var k;var l={timeout:300000,method:"POST",data:p,type:"text",proxy:b.proxymode,authentication:b.authentication,async:false,headers:{"Content-type":q,Accept:"text/plain",},onComplete:function(r){console.warn("retour >data",r);k=r},onFailure:function(r){console.log("arguments onFailure");console.log(arguments)}};if(b.securityToken){l.headers.SecurityToken=b.securityToken}var n=a.handleRequest(m,l);return k}else{if(b.proxyUsage==1){m=j(m,b.server,b.sport)}var o=new XMLHttpRequest();o.open("POST",m,false);o.setRequestHeader("Content-type",q);o.setRequestHeader("Accept","text/plain");o.send(p);return o.responseText}return""};this.transformUrlIntoRealUrl=function(l){if(b.proxyUsage==2){console.log("WAFData No Proxyfication");var k=new Object();return l}else{if(b.proxyUsage==1){l=j(l,b.server,b.sport);return l}}return l};this.asyncTransformFCSUrlIntoRealUrl=function(l,k,p){var m=l.url;var n=l.data;var o="application/xml";if(typeof(k)==="boolean"&&k){o="application/xmql"}this.executePostHttpRequest(m,o,n,function(s){var w=/\{\{([^\}]*)\}\{([^\}]*)\}\}/;var u=w.exec(s);var t=u[1];var v=u[2];var q=v;var r="posthttp:"+q+":postparams:__fcs__jobTicket="+encodeURIComponent(t);p(l,r)})};var j=function(m,n,l){var k=m.indexOf("/");var p=m.indexOf("/",k+2);var o=m.slice(0,k)+"//"+n+":"+l+m.slice(p,m.length);return o}};b.useNoProxy=function(){b.proxyUsage=0;b.server=null;b.sport=null};b.useProxyDefinedBy=function(k,j){b.proxyUsage=1;b.server=k;b.sport=j};b.useUWAProxy=function(j){b.proxyUsage=2;b.server=null;b.sport=null;b.proxymode=j.proxymode;b.authentication=j.proxymode;if(j.contextid&&j.login){b.securityToken=j.login+"|"+j.contextid}};return b});define("VisuDataAccess/Ox4XHRWithProxyAbstraction",["DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/Ox4XHRWithProxyAbstraction");return b});define("DS/Shaders/AdvancedHighlightShader",["DS/Visualization/ThreeJS_R57"],function(e){var d={uniforms:e.UniformsUtils.merge([e.UniformsLib.clipPlanes,e.UniformsLib.skinning,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new e.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new e.Vector4(1,1)},colorHighlight:{type:"v4",value:new e.Vector4(0,0.6,1,1)}}]),vertexShaderPars:["varying float reflectionFactor;","uniform vec4 colorHighlight;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif",].join("\n"),vertexShaderBody:["    vec3 I = normalize( -mvPosition.xyz );","    reflectionFactor = abs( dot( I, mvNormal ) );","    float alpha = (1.0 - reflectionFactor);","    alpha *= alpha;","    reflectionFactor = (0.6 * alpha + 0.2) * colorHighlight.a * 2.0;","#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif",].join("\n"),fragmentShaderPars:["varying float reflectionFactor;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","uniform vec4 colorHighlight;",].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vUvMap ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","    gl_FragColor = vec4( colorHighlight.xyz, reflectionFactor );",].join("\n"),vertexShader:[e.ShaderChunk.clip_pars_vertex,e.ShaderChunk.skinning_pars_vertex,"const vec3 vOrthoDir = vec3(0.0, 0.0, 1.0);","varying float reflectionFactor;","uniform vec4 colorHighlight;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","void main() {",e.ShaderChunk.PDSFX_start_vertex,e.ShaderChunk.skinbase_vertex,e.ShaderChunk.skinnormal_vertex,e.ShaderChunk.defaultnormal_vertex,e.ShaderChunk.skinning_vertex,e.ShaderChunk.default_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif","    vec3 I = vOrthoDir;","    if (!(projectionMatrix[3][3] > 0.0)) {","       I = normalize( -mvPosition.xyz );","    }","    reflectionFactor = abs( dot( I, transformedNormal ) );","    float alpha = (1.0 - reflectionFactor);","    alpha *= alpha;","    reflectionFactor = (0.6 * alpha + 0.2) * colorHighlight.a * 2.0;","#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif","    gl_Position = projectionMatrix * mvPosition;",e.ShaderChunk.clip_vertex,e.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[e.ShaderChunk.clip_pars_fragment,"varying float reflectionFactor;","uniform vec4 colorHighlight;","float finalReflectionFactor;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","void main() {","finalReflectionFactor = reflectionFactor;","#ifdef PDSFX","ComputeCommonValues();",e.ShaderChunk.PDSFX_discard_fragment,e.ShaderChunk.PDSFX_viewNormal_fragment,"vec3 mvPosition = ComputeViewPosition();","    vec3 I = vec3(0.0, 0.0, 1.0);","    if (!(projectionMatrix[3][3] > 0.0)) {","       I = normalize( -mvPosition.xyz );","    }","    finalReflectionFactor = abs( dot( I, _DSvNormal ) );","    float refAlpha = (1.0 - finalReflectionFactor);","    refAlpha *= refAlpha;","    finalReflectionFactor = (0.6 * refAlpha + 0.2) * colorHighlight.a * 2.0;","#endif",e.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vUvMap ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","  gl_FragColor = vec4( colorHighlight.xyz, finalReflectionFactor );","}"].join("\n")};var h={uniforms:e.UniformsUtils.merge([e.UniformsLib.clipPlanes,e.UniformsLib.lines,{colorHighlight:{type:"v4",value:new e.Vector4(0,0.6,1,1)}}]),vertexShaderPars:[].join("\n"),vertexShaderBody:[].join("\n"),fragmentShaderPars:["uniform vec4 colorHighlight;",].join("\n"),fragmentShaderBody:["  gl_FragColor = vec4( colorHighlight.xyz, 0.8 * colorHighlight.a * 2.0 );",].join("\n"),vertexShader:[e.ShaderChunk.clip_pars_vertex,e.ShaderChunk.lines_pars_vertex,"void main() {",e.ShaderChunk.PDSFX_start_vertex,e.ShaderChunk.default_vertex,e.ShaderChunk.clip_vertex,e.ShaderChunk.lines_vertex,e.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[e.ShaderChunk.clip_pars_fragment,e.ShaderChunk.lines_pars_fragment,"uniform vec4 colorHighlight;","void main() {","#ifdef PDSFX","ComputeCommonValues();",e.ShaderChunk.PDSFX_discard_fragment,"#endif",e.ShaderChunk.clip_fragment,e.ShaderChunk.lines_fragment,"    gl_FragColor = vec4( colorHighlight.xyz, 0.8 * colorHighlight.a * 2.0);","}"].join("\n")};var a={uniforms:e.UniformsUtils.merge([e.UniformsLib.clipPlanes,{map:{type:"t",value:null},size:{type:"f",value:1},colorHighlight:{type:"v4",value:new e.Vector4(0,0.6,1,1)},scale:{type:"f",value:500},offsetAlphaMap:{type:"v2",value:new e.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new e.Vector4(1,1)}}]),vertexShaderPars:["uniform float size;","uniform float scale;"].join("\n"),vertexShaderBody:["#ifdef USE_SIZEATTENUATION","gl_PointSize = size * ( scale / length( mvPosition.xyz ) );","#else","gl_PointSize = size;","#endif"].join("\n"),fragmentShaderPars:["uniform vec4 colorHighlight;","#ifdef USE_MAP_ALPHATEST","uniform sampler2D map;","#endif"].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","    gl_FragColor = vec4( colorHighlight.xyz, 0.8 * colorHighlight.a * 2.0  );"].join("\n"),vertexShader:[e.ShaderChunk.clip_pars_vertex,"uniform float size;","uniform float scale;","#ifdef USE_MAP_ALPHATEST","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","void main() {",e.ShaderChunk.PDSFX_start_particle_vertex,e.ShaderChunk.PDSFX_start_vertex,e.ShaderChunk.default_vertex,e.ShaderChunk.PDSFX_point_size_vertex,e.ShaderChunk.clip_vertex,e.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[e.ShaderChunk.clip_pars_fragment,"uniform vec4 colorHighlight;","#ifdef USE_MAP_ALPHATEST","uniform sampler2D map;","#endif","void main() {","#ifdef PDSFX","ComputeCommonValues();",e.ShaderChunk.PDSFX_discard_fragment,"#endif","#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).w;","   if ( alpha < ALPHATEST ) discard;","#endif",e.ShaderChunk.clip_fragment,"    gl_FragColor = vec4( colorHighlight.xyz, 0.8 * colorHighlight.a * 2.0);","}"].join("\n")};var g={uniforms:e.UniformsUtils.merge([e.UniformsLib.clipPlanes,e.UniformsLib.skinning,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new e.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new e.Vector4(1,1)},colorHighlight:{type:"v4",value:new e.Vector4(0,1,1,1)},}]),vertexShaderPars:["varying float reflectionFactor;","uniform vec4 colorHighlight;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif",].join("\n"),vertexShaderBody:["    vec3 I = normalize( -mvPosition.xyz );","    reflectionFactor = abs( dot( I, mvNormal ) );","    float alpha = (1.0 - reflectionFactor);","    alpha *= alpha;","    reflectionFactor = (0.6 * alpha + 0.2) * colorHighlight.a * 2.0;","#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif",].join("\n"),fragmentShaderPars:["varying float reflectionFactor;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","uniform vec4 colorHighlight;",].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vUvMap ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","    gl_FragColor = vec4( colorHighlight.xyz, 1.0 );",].join("\n"),vertexShader:[e.ShaderChunk.clip_pars_vertex,e.ShaderChunk.skinning_pars_vertex,"const vec3 vOrthoDir = vec3(0.0, 0.0, 1.0);","varying float reflectionFactor;","uniform vec4 colorHighlight;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","void main() {",e.ShaderChunk.PDSFX_start_vertex,e.ShaderChunk.skinbase_vertex,e.ShaderChunk.skinnormal_vertex,e.ShaderChunk.defaultnormal_vertex,e.ShaderChunk.skinning_vertex,e.ShaderChunk.default_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif","    vec3 I = vOrthoDir;","    if (!(projectionMatrix[3][3] > 0.0)) {","       I = normalize( -mvPosition.xyz );","    }","    reflectionFactor = abs( dot( I, transformedNormal ) );","    float alpha = (1.0 - reflectionFactor);","    alpha *= alpha;","    reflectionFactor = (0.6 * alpha + 0.2) * colorHighlight.a * 2.0;","#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif","    gl_Position = projectionMatrix * mvPosition;",e.ShaderChunk.clip_vertex,e.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[e.ShaderChunk.clip_pars_fragment,"varying float reflectionFactor;","uniform vec4 colorHighlight;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","void main() {","#ifdef PDSFX","ComputeCommonValues();",e.ShaderChunk.PDSFX_discard_fragment,"#endif",e.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vUvMap ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","    gl_FragColor = vec4( colorHighlight.xyz, 1.0 );","}"].join("\n")};var j={uniforms:e.UniformsUtils.merge([e.UniformsLib.clipPlanes,e.UniformsLib.lines,{colorHighlight:{type:"v4",value:new e.Vector4(0,1,1,1)}}]),vertexShaderPars:[].join("\n"),vertexShaderBody:[].join("\n"),fragmentShaderPars:["uniform vec4 colorHighlight;",].join("\n"),fragmentShaderBody:["    gl_FragColor = vec4( colorHighlight.xyz, 1.0);",].join("\n"),vertexShader:[e.ShaderChunk.clip_pars_vertex,e.ShaderChunk.lines_pars_vertex,"void main() {",e.ShaderChunk.PDSFX_start_vertex,e.ShaderChunk.default_vertex,e.ShaderChunk.clip_vertex,e.ShaderChunk.lines_vertex,e.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[e.ShaderChunk.clip_pars_fragment,e.ShaderChunk.lines_pars_fragment,"uniform vec4 colorHighlight;","void main() {","#ifdef PDSFX","ComputeCommonValues();",e.ShaderChunk.PDSFX_discard_fragment,"#endif",e.ShaderChunk.clip_fragment,e.ShaderChunk.lines_fragment,"    gl_FragColor = vec4( colorHighlight.xyz, 1.0);","}"].join("\n")};var f={uniforms:e.UniformsUtils.merge([e.UniformsLib.clipPlanes,{map:{type:"t",value:null},size:{type:"f",value:1},scale:{type:"f",value:500},offsetAlphaMap:{type:"v2",value:new e.Vector4(0,0)},colorHighlight:{type:"v4",value:new e.Vector4(0,1,1,1)},repeatAlphaMap:{type:"v2",value:new e.Vector4(1,1)}}]),vertexShaderPars:["uniform float size;","uniform float scale;"].join("\n"),vertexShaderBody:["#ifdef USE_SIZEATTENUATION","gl_PointSize = size * ( scale / length( mvPosition.xyz ) );","#else","gl_PointSize = size;","#endif"].join("\n"),fragmentShaderPars:["uniform vec4 colorHighlight;","#ifdef USE_MAP_ALPHATEST","uniform sampler2D map;","#endif"].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","    gl_FragColor = vec4( colorHighlight.xyz, 1.0 );",].join("\n"),vertexShader:[e.ShaderChunk.clip_pars_vertex,"uniform float size;","uniform float scale;","#ifdef USE_MAP_ALPHATEST","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","void main() {",e.ShaderChunk.PDSFX_start_vertex,e._DefaultShaderChunk.model_view_transformation_vertex,"#ifdef PDSFX","_viewTangentSpace.Position = mvPosition.xyz;","ProcessViewTangentSpace(_viewTangentSpace);","mvPosition.xyz = _viewTangentSpace.Position;","#endif","#ifdef USE_SIZEATTENUATION","gl_PointSize = size * ( scale / length( mvPosition.xyz ) );","#else","gl_PointSize = size;","#endif","    gl_Position = projectionMatrix * mvPosition;",e.ShaderChunk.clip_vertex,e.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[e.ShaderChunk.clip_pars_fragment,"#ifdef USE_MAP_ALPHATEST","uniform sampler2D map;","#endif","uniform vec4 colorHighlight;","void main() {","#ifdef PDSFX","ComputeCommonValues();",e.ShaderChunk.PDSFX_discard_fragment,"#endif","#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).w;","   if ( alpha < ALPHATEST ) discard;","#endif",e.ShaderChunk.clip_fragment,"    gl_FragColor = vec4( colorHighlight.xyz, 1.0 );","}"].join("\n")};var c={defines:{POSTPRO:1},uniforms:{tAdd:{type:"t",value:null},tDiffuse:{type:"t",value:null},h:{type:"f",value:1/1024},v:{type:"f",value:1/1024},poisson:{type:"fv1",value:[]},invNumBlur:{type:"f",value:0.0833333333333333},iHaloColor:{type:"v4",value:new e.Vector4(0,0.6,1,1)},iHaloIntensity:{type:"f",value:2},iScanEffectIntensity:{type:"f",value:1},iOutlineColor2:{type:"v4",value:new e.Vector4(0,1,1,1)},iOutlineColor:{type:"v4",value:new e.Vector4(0,0.6,1,1)},iScanEffectColor:{type:"v4",value:new e.Vector4(0,0.6,1,1)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#if (POSTPRO == 1)","uniform sampler2D tDiffuse;","#endif","uniform sampler2D tAdd;","uniform float h;","uniform float v;","uniform float poisson[24];","uniform float invNumBlur;","uniform float iHaloIntensity;","uniform float iScanEffectIntensity;","uniform vec4 iOutlineColor2;","uniform vec4 iOutlineColor;","uniform vec4 iScanEffectColor;","uniform vec4 iHaloColor;","varying vec2 vUv;","void main() {","vec4 result = texture2D(tAdd, vUv);","float boardThin = 1.0;","float board = 1.0;","float center = 1.0 - result.r;","vec4 up = vec4(1.0 - texture2D(tAdd, vec2( vUv.x + h, vUv.y    ) ).r, ","1.0 - texture2D(tAdd, vec2( vUv.x - h, vUv.y + v) ).r, ","1.0 - texture2D(tAdd, vec2( vUv.x    , vUv.y + v) ).r, ","1.0 - texture2D(tAdd, vec2( vUv.x + h, vUv.y + v) ).r  ",");","vec4 down = vec4(1.0 - texture2D(tAdd, vec2( vUv.x - h, vUv.y - v) ).r, ","1.0 - texture2D(tAdd, vec2( vUv.x    , vUv.y - v) ).r, ","1.0 - texture2D(tAdd, vec2( vUv.x + h, vUv.y - v) ).r, ","1.0 - texture2D(tAdd, vec2( vUv.x - h, vUv.y    ) ).r  ",");","boardThin *= up.x   * up.y   * up.z   * up.w;","boardThin *= down.x * down.y * down.z * down.w;","board *= (1.0 - up.x)   * (1.0 - up.y)   * (1.0 - up.z)   * (1.0 - up.w);","board *= (1.0 - down.x) * (1.0 - down.y) * (1.0 - down.z) * (1.0 - down.w);","float isOutline = center  * (1.0 - boardThin) + (1.0 - center) * (1.0 - board);","if (isOutline == 1.0) {","result = iOutlineColor * center * (1.0 - boardThin) + iOutlineColor2 * (1.0 - center) * (1.0 - board);","} else {","if (result.r != 1.0) {","result   = iHaloColor;","result.a = 0.0;","result.a += 1.0 - texture2D( tAdd, vec2( vUv.x + 4.0 * h * poisson[0], vUv.y + 4.0 * v * poisson[1] ) ).r;","result.a += 1.0 - texture2D( tAdd, vec2( vUv.x + 4.0 * h * poisson[2], vUv.y + 4.0 * v * poisson[3] ) ).r;","result.a += 1.0 - texture2D( tAdd, vec2( vUv.x + 4.0 * h * poisson[4], vUv.y + 4.0 * v * poisson[5] ) ).r;","result.a += 1.0 - texture2D( tAdd, vec2( vUv.x + 4.0 * h * poisson[6], vUv.y + 4.0 * v * poisson[7] ) ).r;","result.a += 1.0 - texture2D( tAdd, vec2( vUv.x + 4.0 * h * poisson[8], vUv.y + 4.0 * v * poisson[9] ) ).r;","result.a += 1.0 - texture2D( tAdd, vec2( vUv.x + 4.0 * h * poisson[10], vUv.y + 4.0 * v * poisson[11] ) ).r;","result.a += 1.0 - texture2D( tAdd, vec2( vUv.x + 4.0 * h * poisson[12], vUv.y + 4.0 * v * poisson[13] ) ).r;","result.a += 1.0 - texture2D( tAdd, vec2( vUv.x + 4.0 * h * poisson[14], vUv.y + 4.0 * v * poisson[15] ) ).r;","result.a += 1.0 - texture2D( tAdd, vec2( vUv.x + 4.0 * h * poisson[16], vUv.y + 4.0 * v * poisson[17] ) ).r;","result.a += 1.0 - texture2D( tAdd, vec2( vUv.x + 4.0 * h * poisson[18], vUv.y + 4.0 * v * poisson[19] ) ).r;","result.a += 1.0 - texture2D( tAdd, vec2( vUv.x + 4.0 * h * poisson[20], vUv.y + 4.0 * v * poisson[21] ) ).r;","result.a += 1.0 - texture2D( tAdd, vec2( vUv.x + 4.0 * h * poisson[22], vUv.y + 4.0 * v * poisson[23] ) ).r;","result.a = (1.0 - result.a * invNumBlur) * iHaloIntensity;","} else {","float alpha = result.a;","result = vec4(iScanEffectColor.xyz, alpha);","}","}","float coef = result.a;","#if (POSTPRO == 1)","vec4 add = texture2D( tDiffuse, vUv );","gl_FragColor = vec4(coef * result.rgb + (1.0 - coef) * add.rgb, add.a);","#else","gl_FragColor = vec4(result.rgb, coef);","#endif","}"].join("\n")};var b={defines:{POSTPRO:1},uniforms:{tAdd:{type:"t",value:null},tAdd2:{type:"t",value:null},tDiffuse:{type:"t",value:null},h:{type:"f",value:1/1024},v:{type:"f",value:1/1024},poisson:{type:"fv1",value:[]},invNumBlur:{type:"f",value:0.0833333333333333},iHaloIntensity:{type:"f",value:2}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#if (POSTPRO == 1)","uniform sampler2D tDiffuse;","#endif","uniform sampler2D tAdd;","uniform sampler2D tAdd2;","uniform float h;","uniform float v;","uniform float poisson[24];","uniform float invNumBlur;","uniform float iHaloIntensity;","varying vec2 vUv;","void main() {","vec4 result= texture2D(tAdd, vUv);","vec4 resultTAdd2 = texture2D(tAdd2, vUv);","float scanEffectIntensity = 1.0;","vec4  northWest1 = texture2D( tAdd2, vec2( vUv.x - h, vUv.y + v));","vec4  north1     = texture2D( tAdd2, vec2( vUv.x    , vUv.y + v));","vec4  northEast1 = texture2D( tAdd2, vec2( vUv.x + h, vUv.y + v));","vec4  west1      = texture2D( tAdd2, vec2( vUv.x - h, vUv.y));","vec3  center    = resultTAdd2.xyz;","vec4  east1      = texture2D( tAdd2, vec2( vUv.x + h, vUv.y));","vec4  southWest1 = texture2D( tAdd2, vec2( vUv.x - h, vUv.y - v));","vec4  south1     = texture2D( tAdd2, vec2( vUv.x    , vUv.y - v));","vec4  southEast1 = texture2D( tAdd2, vec2( vUv.x + h, vUv.y - v));","bool r1 = all(bvec3(all(equal(center , northWest1.xyz)),all(equal(center , north1.xyz)),all(equal(center , northEast1.xyz))));","bool r2 = all(bvec3(all(equal(center , west1.xyz))     ,all(equal(center , east1.xyz)) ,true));","bool r3 = all(bvec3(all(equal(center , southWest1.xyz)),all(equal(center , south1.xyz)),all(equal(center , southEast1.xyz))));","bool isNotOutline = all(bvec3(r1,r2,r3));","if (isNotOutline == false) {","if (resultTAdd2.a != 0.0) {","result = vec4(center.xyz, 1.0);","} else {","vec4  northWest = texture2D( tAdd, vec2( vUv.x - h, vUv.y + v));","vec4  north     = texture2D( tAdd, vec2( vUv.x    , vUv.y + v));","vec4  northEast = texture2D( tAdd, vec2( vUv.x + h, vUv.y + v));","vec4  west      = texture2D( tAdd, vec2( vUv.x - h, vUv.y));","vec4  east      = texture2D( tAdd, vec2( vUv.x + h, vUv.y));","vec4  southWest = texture2D( tAdd, vec2( vUv.x - h, vUv.y - v));","vec4  south     = texture2D( tAdd, vec2( vUv.x    , vUv.y - v));","vec4  southEast = texture2D( tAdd, vec2( vUv.x + h, vUv.y - v));","vec3 tmpColor = vec3(0.0);","float countColor = 0.0;","tmpColor += northWest1.a * northWest.xyz;","countColor += (1.0 * northWest1.a);","tmpColor += north1.a * north.xyz;","countColor += (1.0 * north1.a);","tmpColor += northEast1.a * northEast.xyz;","countColor += (1.0 * northEast1.a);","tmpColor += west1.a * west.xyz;","countColor += (1.0 * west1.a);","tmpColor += east1.a * east.xyz;","countColor += (1.0 * east1.a);","tmpColor += southWest1.a * southWest.xyz;","countColor += (1.0 * southWest1.a);","tmpColor += south1.a * south.xyz;","countColor += (1.0 * south1.a);","tmpColor += southEast1.a * southEast.xyz;","countColor += (1.0 * southEast1.a);","tmpColor = tmpColor / countColor;","result = vec4(tmpColor, 1.0);","}","}","else {","if (result.a == 0.0) {","vec3 tmpColor = vec3(0.0);","vec4 tmpPixel = vec4(0.0);","vec4 tmpPixel1= vec4(0.0);","float countColor = 0.0;","result   = vec4(0.0,0.0,0.0,0.0);","result.a = 0.0;","tmpPixel = texture2D( tAdd, vec2( vUv.x + 4.0 * h *  poisson[0], vUv.y + 4.0 * v *  poisson[1] ) );","tmpPixel1 = texture2D( tAdd2, vec2( vUv.x + 4.0 * h *  poisson[0], vUv.y + 4.0 * v *  poisson[1] ) );","tmpColor += tmpPixel1.a * tmpPixel.xyz;","countColor += (1.0 * tmpPixel1.a);","result.a += (1.0 - tmpPixel1.a);","tmpPixel = texture2D( tAdd, vec2( vUv.x + 4.0 * h *  poisson[2], vUv.y + 4.0 * v *  poisson[3] ) );","tmpPixel1 = texture2D( tAdd2, vec2( vUv.x + 4.0 * h *  poisson[2], vUv.y + 4.0 * v *  poisson[3] ) );","tmpColor += tmpPixel1.a * tmpPixel.xyz;","countColor += (1.0 * tmpPixel1.a);","result.a += (1.0 - tmpPixel1.a);","tmpPixel = texture2D( tAdd, vec2( vUv.x + 4.0 * h *  poisson[4], vUv.y + 4.0 * v *  poisson[5] ) );","tmpPixel = texture2D( tAdd2, vec2( vUv.x + 4.0 * h *  poisson[4], vUv.y + 4.0 * v *  poisson[5] ) );","tmpColor += tmpPixel1.a * tmpPixel.xyz;","countColor += (1.0 * tmpPixel1.a);","result.a += (1.0 - tmpPixel1.a);","tmpPixel = texture2D( tAdd, vec2( vUv.x + 4.0 * h *  poisson[6], vUv.y + 4.0 * v *  poisson[7] ) );","tmpPixel1 = texture2D( tAdd2, vec2( vUv.x + 4.0 * h *  poisson[6], vUv.y + 4.0 * v *  poisson[7] ) );","tmpColor += tmpPixel1.a * tmpPixel.xyz;","countColor += (1.0 * tmpPixel1.a);","result.a += (1.0 - tmpPixel1.a);","tmpPixel = texture2D( tAdd, vec2( vUv.x + 4.0 * h *  poisson[8], vUv.y + 4.0 * v *  poisson[9] ) );","tmpPixel1 = texture2D( tAdd2, vec2( vUv.x + 4.0 * h *  poisson[8], vUv.y + 4.0 * v *  poisson[9] ) );","tmpColor += tmpPixel1.a * tmpPixel.xyz;","countColor += (1.0 * tmpPixel1.a);","result.a += (1.0 - tmpPixel1.a);","tmpPixel = texture2D( tAdd, vec2( vUv.x + 4.0 * h *  poisson[10], vUv.y + 4.0 * v *  poisson[11] ) );","tmpPixel1 = texture2D( tAdd2, vec2( vUv.x + 4.0 * h *  poisson[10], vUv.y + 4.0 * v *  poisson[11] ) );","tmpColor += tmpPixel1.a * tmpPixel.xyz;","countColor += (1.0 * tmpPixel1.a);","result.a += (1.0 - tmpPixel1.a);","tmpPixel = texture2D( tAdd, vec2( vUv.x + 4.0 * h *  poisson[12], vUv.y + 4.0 * v *  poisson[13] ) );","tmpPixel1 = texture2D( tAdd2, vec2( vUv.x + 4.0 * h *  poisson[12], vUv.y + 4.0 * v *  poisson[13] ) );","tmpColor += tmpPixel1.a * tmpPixel.xyz;","countColor += (1.0 * tmpPixel1.a);","result.a += (1.0 - tmpPixel1.a);","tmpPixel = texture2D( tAdd, vec2( vUv.x + 4.0 * h *  poisson[14], vUv.y + 4.0 * v *  poisson[15] ) );","tmpPixel1 = texture2D( tAdd2, vec2( vUv.x + 4.0 * h *  poisson[14], vUv.y + 4.0 * v *  poisson[15] ) );","tmpColor += tmpPixel1.a * tmpPixel.xyz;","countColor += (1.0 * tmpPixel1.a);","result.a += (1.0 - tmpPixel1.a);","tmpPixel = texture2D( tAdd, vec2( vUv.x + 4.0 * h *  poisson[16], vUv.y + 4.0 * v *  poisson[17] ) );","tmpPixel1 = texture2D( tAdd2, vec2( vUv.x + 4.0 * h *  poisson[16], vUv.y + 4.0 * v *  poisson[17] ) );","tmpColor += tmpPixel1.a * tmpPixel.xyz;","countColor += (1.0 * tmpPixel1.a);","result.a += (1.0 - tmpPixel1.a);","tmpPixel = texture2D( tAdd, vec2( vUv.x + 4.0 * h *  poisson[18], vUv.y + 4.0 * v *  poisson[19] ) );","tmpPixel1 = texture2D( tAdd2, vec2( vUv.x + 4.0 * h *  poisson[18], vUv.y + 4.0 * v *  poisson[19] ) );","tmpColor += tmpPixel1.a * tmpPixel.xyz;","countColor += (1.0 * tmpPixel1.a);","result.a += (1.0 - tmpPixel1.a);","tmpPixel = texture2D( tAdd, vec2( vUv.x + 4.0 * h *  poisson[20], vUv.y + 4.0 * v *  poisson[21] ) );","tmpPixel1 = texture2D( tAdd2, vec2( vUv.x + 4.0 * h *  poisson[20], vUv.y + 4.0 * v *  poisson[21] ) );","tmpColor += tmpPixel1.a * tmpPixel.xyz;","countColor += (1.0 * tmpPixel1.a);","result.a += (1.0 - tmpPixel1.a);","tmpPixel = texture2D( tAdd, vec2( vUv.x + 4.0 * h *  poisson[22], vUv.y + 4.0 * v *  poisson[23] ) );","tmpPixel1 = texture2D( tAdd2, vec2( vUv.x + 4.0 * h *  poisson[22], vUv.y + 4.0 * v *  poisson[23] ) );","tmpColor += tmpPixel1.a * tmpPixel.xyz;","countColor += (1.0 * tmpPixel1.a);","result.a += (1.0 - tmpPixel1.a);"," if( countColor > 0.0) {","tmpColor /= countColor;","result.xyz = tmpColor;","}","result.a = (1.0 - result.a * invNumBlur) * iHaloIntensity;","} else {","result = vec4(texture2D(tAdd, vUv).xyz, result.a);","}","}","float coef = result.a;","#if (POSTPRO == 1)","vec4 add = texture2D( tDiffuse, vUv );","gl_FragColor = vec4(coef * result.rgb + (1.0 - coef) * add.rgb, add.a);","#else","gl_FragColor = vec4(result.rgb, coef);","#endif","}"].join("\n")};return{HighlightFace:d,HighlightEdge:h,HighlightPoint:a,OutlineHighlightFace:g,OutlineHighlightEdge:j,OutlineHighlightPoint:f,FinalBlending:c,FinalBlendingMultiHL:b}});define("Shaders/AdvancedHighlightShader",["DS/Shaders/AdvancedHighlightShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/AdvancedHighlightShader");return b});define("DS/Visualization/OccurrencePath",["UWA/Class"],function(a){var b=a.extend({init:function(c){this.path=[];this.setFromArray(c)},getSize:function(){return this.path.length},getNodeName:function(c){if((c<0)||(c>=this.path.length)){return null}return this.path[c]},add:function(c){this.path.push(c)},setFromArray:function(c){var d;if((c!==undefined)&&(c instanceof Array)){for(d=0;d<c.length;d++){if(c[d]!==""){this.path.push(c[d])}}}},isEqual:function(c){var d;if(this.path.length!==c.path.length){return false}for(d=0;d<c.path.length;d++){if(this.path[d]!==c.path[d]){return false}}return true},isIncludedIn:function(c){var g=false,f,e,d;for(e=0;e<this.path.length;e++){f=this.path[e];g=false;for(d=0;d<c.path.length;d++){if(f===c.path[d]){g=true;break}}if(!g){return false}}return true}});return UWA.namespace("THREEDS/OccurrencePath",b)});define("Visualization/OccurrencePath",["DS/Visualization/OccurrencePath","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/OccurrencePath");return b});define("DS/QualityManager/QMController",["UWA/Core","UWA/Class","DS/QualityManager/QMPresetStreamer"],function(b,c,d){var a=c.singleton({init:function(){this.isInitialized=true;d.init();this.currentUser=null;this.currentPreset=null;this.isLinked=null;this.prestToModify=null;this._webGLV6Viewers=[]},linkToViewer:function(e){this._webGLV6Viewers.push(e)},initPresetDB:function(e){d.initDataBase(e);this.currentUser=d.getItem("currentUser");var f="Users/"+this.currentUser+"/currentPreset";this.currentPreset=d.getItem(f);var f="Users/"+this.currentUser+"/isLinked";this.isLinked=d.getItem(f);this.prestToModify="Custom"},setCurrentUser:function(f){var g="Users/"+f;var e=d.getItem(g);if(b.is(e)){d.setItem("currentUser",f);this.currentUser=f}else{}},setCurrentRenderMode:function(g){var f="Users/"+this.currentUser+"/currentPreset";var e=d.getItem(f);if(b.is(e)){d.setItem(f,g);this.currentPreset=g}else{}},getCurrentRenderMode:function(){var f="Users/"+this.currentUser+"/currentPreset";var e=d.getItem(f);return e},setLinkedPresetStatus:function(g){var f="Users/"+this.currentUser+"/isLinked";var e=d.getItem(f);if(b.is(e)){d.setItem(f,g);this.isLinked=g}else{}},getLinkedPresetStatus:function(){var e="Users/"+this.currentUser+"/isLinked";var f=d.getItem(e);return f},getCurrentUserPresetQuery:function(){var e="Users/"+this.currentUser+"/Preset/";return e},validateAttribute:function(e,g){var f=true;if(e=="ReflectionsOnGround"||e=="Preset"){f=false}return f},setAttribute:function(j,f,e,g,h){this.setAttributeOnViewer(j,g,h);this.setAttributeOnDB(j,f,e,g,h)},setAttributeOnViewer:function(l,j,m){if(!this.validateAttribute(j,m)){return false}var k=false;var o=(l==="Dynamic")?"dynamicValue":"staticValue";var n;if(typeof m==="string"){n=JSON.parse('{"'+j+'":"'+m+'"}')}else{n=JSON.parse('{"'+j+'":'+m+"}")}for(var h=0;h<this._webGLV6Viewers.length;h++){var g=this._webGLV6Viewers[h];var e=g._getQMSetting(j);if(e[o]!==m){g._setQMSettings(n,l);var f=g._getQMSetting(j);if(f[o]!==e[o]){k=true}}}return k},setAttributeOnDB:function(m,g,e,h,l){var j=this.getCurrentUserPresetQuery()+m+"/"+this.prestToModify+"/"+e+"/";var k=j+h;d.setItem(k,l);var f=j+"Preset";d.setItem(f,g)},setAttributeOnDynamicMode:function(l,f,e,g,k){var h=this.getCurrentUserPresetQuery()+l+"/"+f+"/"+e+"/";var j=h+g;d.setItem(j,k)},setProperty:function(g,f,e){this.setPropertyOnViewer(g,f,e);this.setPropertyOnDB(g,f,e)},setPropertyOnViewer:function(m,g,f){var k=this.getCurrentUserPresetQuery()+m+"/"+g;var l=d.getItem(k);if(!b.is(l)){return false}var e=l[f];if(!b.is(e)){return false}for(var j in e){if(e.hasOwnProperty(j)){var h=e[j];this.setAttributeOnViewer(m,j,h)}}},setPropertyOnDB:function(m,g,f){var k=this.getCurrentUserPresetQuery()+m+"/"+g;var l=d.getItem(k);if(!b.is(l)){return false}var e=l[f];if(!b.is(e)){return false}for(var j in e){if(e.hasOwnProperty(j)){var h=e[j];this.setAttributeOnDB(m,g,f,j,h)}}},setGlobalPreset:function(g,f,e){this.setGlobalPresetOnViewer(g,f);this.setGlobalPresetOnDB(g,f,e)},setGlobalPresetOnViewer:function(j,f){var g=this.getCurrentUserPresetQuery()+j+"/"+f;var h=d.getItem(g);if(!b.is(h)){return false}for(var e in h){if(h.hasOwnProperty(e)){this.setPropertyOnViewer(j,f,e)}}},setGlobalPresetOnDB:function(k,g,e){var h=this.getCurrentUserPresetQuery()+k+"/currentGlobalPreset";d.setItem(h,g);if(!e){return}h=this.getCurrentUserPresetQuery()+k+"/"+g;var j=d.getItem(h);if(!b.is(j)){return false}for(var f in j){if(j.hasOwnProperty(f)){this.setPropertyOnDB(k,g,f)}}},getCurrentGlobalPreset:function(g){var f=this.getCurrentUserPresetQuery()+g+"/currentGlobalPreset";var e=d.getItem(f);return e},getPresetValue:function(h,e){var g=this.getCurrentUserPresetQuery()+h+"/"+e;var f=d.getItem(g);return f},commitToDB:function(){d.commit()},restoreFromDB:function(){d.retoreDB();var f=this.getCurrentRenderMode();var e=this.getCurrentGlobalPreset(f);this.setGlobalPreset(f,e,false)},dispose:function(){this._webGLV6Viewers=[]}});return a});define("DS/VisuDataAccess/Ox4DataAccessObjectFactory",[],function(){var a=function(){};a.createServerDefinition2=function(f,b,e,d){var c=new Object();if(typeof(f)==="undefined"){console.log("No Hostname in CreateServerDefinition");return null}c.hostname=f;if(typeof(b)==="undefined"){console.log("No RootUri in CreateServerDefinition");return null}c.rooturi=b;c.isSecure=false;if(typeof(e)!="undefined"){if(e){c.isSecure=true}}c.port=-1;if(typeof(d)!="undefined"){c.port=d}c.xmqlServiceUri=function(h){var j="http://";if(this.isSecure){j="https://"}var g=j+this.hostname;if(this.port!=-1){g+=":"+this.port}g+="/"+this.rooturi+"/i3dx/services/xmql";if(typeof(h)==="boolean"&&h){g+="?raw=true"}return g};return c};a.createServerDefinition=function(e,d,b){var c=new Object();c.hostname=e;c.port=d;c.rooturi=b;c.xmqlServiceUri=function(){return"http://"+this.hostname+":"+this.port+"/"+this.rooturi+"/i3dx/services/xmql?raw=true"};return c};a.createDisplayObjectSpecification=function(c,d){var b=new Object();b.physicalid=c;b.serverdefinition=d;return b};return a});define("VisuDataAccess/Ox4DataAccessObjectFactory",["DS/VisuDataAccess/Ox4DataAccessObjectFactory","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/Ox4DataAccessObjectFactory");return b});define("DS/VisuDataAccess/Ox4TaskPlanner",[],function(){var a=function(){var c=new Array();var b=0;var d=null;this.addSequentialTask=function(f){var e=new Array();e.push(f);c.push(e)};this.addEndingTask=function(e){d=e};this.endingTask=function(){return d};this.next=function(){if(b<c.length){b=b+1;return c[b-1]}return null};this.resetIterator=function(){b=0};this.tasksCount=function(){return c.length};this.currentTaskIndex=function(){return b}};return a});define("VisuDataAccess/Ox4TaskPlanner",["DS/VisuDataAccess/Ox4TaskPlanner","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/Ox4TaskPlanner");return b});define("DS/Shaders/AdvancedPreHighlightShader",["DS/Visualization/ThreeJS_R57"],function(c){var d={uniforms:c.UniformsUtils.merge([c.UniformsLib.clipPlanes,c.UniformsLib.skinning,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new c.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new c.Vector4(1,1)},}]),vertexShaderPars:["varying float reflectionFactor;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif",].join("\n"),vertexShaderBody:["    vec3 I = normalize( -mvPosition.xyz );","    reflectionFactor = abs( dot( I, mvNormal ) );","#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif","    gl_Position = projectionMatrix * mvPosition;"].join("\n"),fragmentShaderPars:["varying float reflectionFactor;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif",].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vUvMap ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","    gl_FragColor = vec4( 0.0, reflectionFactor, 0.0, 1.0 );",].join("\n"),vertexShader:[c.ShaderChunk.clip_pars_vertex,c.ShaderChunk.skinning_pars_vertex,"varying float reflectionFactor;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","void main() {",c.ShaderChunk.PDSFX_start_vertex,c.ShaderChunk.skinbase_vertex,c.ShaderChunk.skinnormal_vertex,c.ShaderChunk.defaultnormal_vertex,c.ShaderChunk.skinning_vertex,c.ShaderChunk.default_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif","    vec3 I = normalize( -mvPosition.xyz );","    reflectionFactor = abs( dot( I, transformedNormal ) );","#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif","    gl_Position = projectionMatrix * mvPosition;",c.ShaderChunk.clip_vertex,c.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[c.ShaderChunk.clip_pars_fragment,"varying float reflectionFactor;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","void main() {","#ifdef PDSFX","ComputeCommonValues();",c.ShaderChunk.PDSFX_discard_fragment,"#endif",c.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vUvMap ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","    gl_FragColor = vec4( 0.0, reflectionFactor, 0.0, 1.0 );","}"].join("\n")};var b={uniforms:c.UniformsUtils.merge([c.UniformsLib.clipPlanes,c.UniformsLib.lines]),vertexShaderPars:[].join("\n"),vertexShaderBody:[].join("\n"),fragmentShaderPars:[].join("\n"),fragmentShaderBody:["    gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );",].join("\n"),vertexShader:[c.ShaderChunk.clip_pars_vertex,c.ShaderChunk.lines_pars_vertex,"void main() {",c.ShaderChunk.PDSFX_start_vertex,c.ShaderChunk.default_vertex,c.ShaderChunk.clip_vertex,c.ShaderChunk.lines_vertex,c.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[c.ShaderChunk.clip_pars_fragment,c.ShaderChunk.lines_pars_fragment,"void main() {","#ifdef PDSFX","ComputeCommonValues();",c.ShaderChunk.PDSFX_discard_fragment,"#endif",c.ShaderChunk.clip_fragment,c.ShaderChunk.lines_fragment,"    gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );","}"].join("\n")};var e={uniforms:c.UniformsUtils.merge([c.UniformsLib.clipPlanes,{map:{type:"t",value:null},size:{type:"f",value:1},scale:{type:"f",value:500},offsetAlphaMap:{type:"v2",value:new c.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new c.Vector4(1,1)}}]),vertexShaderPars:["uniform float size;","uniform float scale;"].join("\n"),vertexShaderBody:["#ifdef USE_SIZEATTENUATION","gl_PointSize = size * ( scale / length( mvPosition.xyz ) );","#else","gl_PointSize = size;","#endif"].join("\n"),fragmentShaderPars:["#ifdef USE_MAP_ALPHATEST","uniform sampler2D map;","#endif"].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","    gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );",].join("\n"),vertexShader:[c.ShaderChunk.clip_pars_vertex,"uniform float size;","uniform float scale;","void main() {",c.ShaderChunk.PDSFX_start_particle_vertex,c.ShaderChunk.PDSFX_start_vertex,c.ShaderChunk.default_vertex,c.ShaderChunk.PDSFX_point_size_vertex,c.ShaderChunk.clip_vertex,c.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[c.ShaderChunk.clip_pars_fragment,"#ifdef USE_MAP_ALPHATEST","uniform sampler2D map;","#endif","void main() {","#ifdef PDSFX","ComputeCommonValues();",c.ShaderChunk.PDSFX_discard_fragment,"#endif","#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).w;","   if ( alpha < ALPHATEST ) discard;","#endif",c.ShaderChunk.clip_fragment,"    gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );","}"].join("\n")};var a={defines:{POSTPRO:1},uniforms:{tAdd:{type:"t",value:null},tDiffuse:{type:"t",value:null},h:{type:"f",value:1/1024},v:{type:"f",value:1/1024},invNumBlur:{type:"f",value:0.0833333333333333},iHaloColor:{type:"v4",value:new c.Vector4(0,0.6,1,1)},iHaloIntensity:{type:"f",value:2},iScanEffectIntensity:{type:"f",value:1},iOutlineColor2:{type:"v4",value:new c.Vector4(0,1,1,1)},iOutlineColor:{type:"v4",value:new c.Vector4(0,0.6,1,1)},iScanEffectColor:{type:"v4",value:new c.Vector4(0,0.6,1,1)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",c._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#if (POSTPRO == 1)","uniform sampler2D tDiffuse;","#endif","uniform sampler2D tAdd;","uniform float h;","uniform float v;","uniform float invNumBlur;","uniform float iHaloIntensity;","uniform float iScanEffectIntensity;","uniform vec4 iOutlineColor2;","uniform vec4 iOutlineColor;","uniform vec4 iScanEffectColor;","uniform vec4 iHaloColor;","varying vec2 vUv;","void main() {","float boardThin = 1.0;","float board = 1.0;","float center = texture2D( tAdd, vUv ).r;","vec4 up = vec4(texture2D( tAdd, vec2( vUv.x + h, vUv.y    ) ).r, ","texture2D( tAdd, vec2( vUv.x - h, vUv.y + v) ).r, ","texture2D( tAdd, vec2( vUv.x    , vUv.y + v) ).r, ","texture2D( tAdd, vec2( vUv.x + h, vUv.y + v) ).r  ",");","vec4 down = vec4(texture2D( tAdd, vec2( vUv.x - h, vUv.y - v) ).r, ","texture2D( tAdd, vec2( vUv.x    , vUv.y - v) ).r, ","texture2D( tAdd, vec2( vUv.x + h, vUv.y - v) ).r, ","texture2D( tAdd, vec2( vUv.x - h, vUv.y    ) ).r  ",");","boardThin *= up.x   * up.y   * up.z   * up.w;","boardThin *= down.x * down.y * down.z * down.w;","board *= (1.0 - up.x)   * (1.0 - up.y)   * (1.0 - up.z)   * (1.0 - up.w);","board *= (1.0 - down.x) * (1.0 - down.y) * (1.0 - down.z) * (1.0 - down.w);","float isOutline = center * (1.0 - boardThin) + (1.0 - center) * (1.0 - board);","if (isOutline == 1.0) {","gl_FragColor = iOutlineColor * center * (1.0 - boardThin) + iOutlineColor2 * (1.0 - center) * (1.0 - board);","} else {","#if (POSTPRO == 1)","gl_FragColor = texture2D( tDiffuse, vUv );","#else","gl_FragColor = vec4(0.0);","#endif","}","}"].join("\n")};return{HighlightFace:d,HighlightEdge:b,HighlightPoint:e,FinalBlending:a}});define("Shaders/AdvancedPreHighlightShader",["DS/Shaders/AdvancedPreHighlightShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/AdvancedPreHighlightShader");return b});define("DS/Visualization/SessionNodesWithSectionProfile",[],function(){var b=function(){this.nodes=[];this.maxPolyLineSize=0};b.prototype.addNode=function(c){var d=this.nodes[c.id];if(!d){d={polyLineSize:null};this.nodes[c.id]=d}this.updateNode(c)};b.prototype.removeNode=function(c){var d=this.nodes[c.id];if(d){delete this.nodes[c.id];this._updateMax()}};b.prototype.updateNode=function(c){var d=this.nodes[c.id];if(d){if(c.clipPolyLine){d.polyLineSize=c.clipPolyLine.polyLineSize}else{delete this.nodes[c.id]}this._updateMax()}};b.prototype._updateMax=function(){var d;var c=0;for(d in this.nodes){if(this.nodes[d].polyLineSize>c){c=this.nodes[d].polyLineSize}}this.maxPolyLineSize=c};var a=new b();return a});define("DS/VisuDataAccess/Ox4StreamUnStreamerTaskDefinition",[],function(){var a=function(c,d,e){var b=c;this.streamReceived=d;this.streamsNumber=e;this.responseType=null;this.typeRequested=function(){return b}};return a});define("DS/Plugins/UserRenderList",["UWA/Class"],function(a){var c=0;var b=a.extend({init:function(d){this.name=d;this.id=c++},_getIdString:function(){return"_userIdString_"+this.id+(this.name?"_"+this.name:"")}});return b});define("DS/VisuDataAccess/Ox4TreeTarget",[],function(){var a=function(e,h){var f={};var b={};var d=e;var c=h;f[d.physicalid]=c("Node");f[d.physicalid].id=d.physicalid;var g=f[d.physicalid];g.ident=d.physicalid;g.isrel=false;if(d.dtype!=null){g.plmtype=d.dtype}this.FindRootNodeWorkType=function(){if(d.typeHelper.IsBusA(g.plmtype,d.shapeType)){g.worktype=d.shapeType}else{if(d.typeHelper.IsBusA(g.plmtype,"VPMReference")){g.worktype="VPMReference"}}b[g.plmtype]=[g];if(g.worktype!==g.plmtype){b[g.worktype]=[g]}};this.rootNode=function(){return g};this.registerRelationship=function(l){var k=this.findNodeByPhysicalId(l.phyid);k.boid=l.ident;k.id=l.phyid;k.plmtype=l.plmtype;k.worktype=l.plmtype;k.title=l.title;k.plmexternalId=l.realName;k.owner=l.owner;k.isrel=true;var j=this.findNodeByPhysicalId(l.to.phyid);j.boid=l.to.ident;j.id=l.to.phyid;j.plmtype=l.to.plmtype;j.worktype=j.plmtype;j.title=l.to.title;j.plmexternalId=l.to.realName;j.owner=l.to.owner;j.isrel=false;l.from.add(k);k.add(j)};this.countObjects=function(){var k=0;for(var j in f){if(f.hasOwnProperty(j)){k++}}return k};this.dumpObjects=function(){var k=0;for(var j in f){if(f.hasOwnProperty(j)){console.log(f[j])}}return k};this.FindWorkTypes=function(j,k){d.typeHelper.RegisterParentsTypes(j,function(){for(var n in f){if(f[n].isrel){if(d.typeHelper.IsRelA(f[n].plmtype,d.instanceType)){f[n].worktype=d.instanceType}}else{if(d.referenceType&&d.typeHelper.IsBusA(f[n].plmtype,d.referenceType)){f[n].worktype=d.referenceType}else{if(d.typeHelper.IsBusA(f[n].plmtype,d.shapeType)){f[n].worktype=d.shapeType}}}var l=f[n].plmtype;var m=f[n].worktype;if(!b.hasOwnProperty(l)){b[l]=[]}b[l].push(f[n]);if(m!==l){if(!b.hasOwnProperty(m)){b[m]=[]}b[m].push(f[n])}}k()})};this.findNodeByPhysicalId=function(j){var k=f[j];if(k===undefined){f[j]=c("Node");f[j].id=j}return f[j]};this.findNodeByType=function(j){var k=[];if(b.hasOwnProperty(j)){k=b[j]}return k};this.findNodeByPLMTypeExpressedAsPhyIdSeparatedByComma=function(j){var k=[];if(b.hasOwnProperty(j)){k=b[j]}var l="";k.forEach(function(n,m){l+=n.id;if(m<k.length-1){l+=","}});return l};this.findNodeByPLMTypeExpressedAsPhyIdAsJSON=function(k){var l=this.findNodeByType(k);var j=[];if(l.length>0){l.forEach(function(n,m){j.push(n.id)});return JSON.stringify(j)}else{return[]}}};return a});define("VisuDataAccess/Ox4TreeTarget",["DS/VisuDataAccess/Ox4TreeTarget","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/Ox4TreeTarget");return b});define("DS/Visualization/SubsurfaceGenerator",["DS/Visualization/ThreeJS_R57"],function(a){var b=function(){this.loaded=true;this.computedTextures=new Map();this.size=128;this.ready=true;var e=this.utilities.linspace(0.5,1/16,this.size);this.r=this.utilities.applyToArray(e,function(f){return 1/f});this.s=this.utilities.linspace(0.5,16,this.size);var d=this.utilities.linspace(-1,1,this.size);this.theta=this.utilities.applyToArray(d,function(f){return Math.acos(f)});this.sinTheta=this.utilities.applyToArray(this.theta,function(f){if(f>0.5*Math.PI){return 0}return Math.sin(f)});this.aux=Math.PI*Math.PI*Math.sqrt(0.31830988618)/this.size};var c=function(h,g){var f=Math.abs(h.scatteringCoeffs[0]-g.scatteringCoeffs[0])<0.000001&&Math.abs(h.scatteringCoeffs[1]-g.scatteringCoeffs[1])<0.000001&&Math.abs(h.scatteringCoeffs[2]-g.scatteringCoeffs[2])<0.000001;var e=Math.abs(h.absorptionCoeffs[0]-g.absorptionCoeffs[0])<0.000001&&Math.abs(h.absorptionCoeffs[1]-g.absorptionCoeffs[1])<0.000001&&Math.abs(h.absorptionCoeffs[2]-g.absorptionCoeffs[2])<0.000001;var d=Math.abs(h.eta-g.eta)<0.000001;return f&&e&&d};b.prototype={constructor:b,modelFunction:function(n){var f=this.utilities.sumArray(n.absorptionCoeffs,n.scatteringCoeffs);var j=this.utilities.applyToArray(this.utilities.multiplyArray(n.absorptionCoeffs,f),function(o){return Math.sqrt(3*o)});var e=this.utilities.applyToArray(f,function(o){return 0.33333/o});var l=-1.44/(n.eta*n.eta)+0.71/n.eta+0.668+0.0636*n.eta;var k=this.utilities.applyToArray(f,function(o){return 1/o});var m=this.utilities.applyToArray(e,function(o){return 4*(1+l)/(1-l)*o});var h=this.utilities.sumArray(m,k);var d=function(q,p,o){return(p*q+1)*Math.exp(-p*q)/(q*q*q*o)};var g=function(w,q){var v=Math.sqrt(q*q+k[w]*k[w]);var u=Math.sqrt(q*q+h[w]*h[w]);var s=j[w];var p=f[w];var o=0.25*(d(v,s,p)+h[w]*d(u,s,p))/Math.PI;return o};return{red:function(o){return g(0,o)},green:function(o){return g(1,o)},blue:function(o){return g(2,o)}}},sssLUTBuilder:function(f,e,g){var d=function(k){var l=Math.max(Math.cos(g+k),0);var j=f(Math.abs(2*e*Math.sin(k/2)));return l*j};var h=function(j){return f(Math.abs(2*e*Math.sin(j/2)))};return this.utilities.integrate(d,-Math.PI,Math.PI)/this.utilities.integrate(h,-Math.PI,Math.PI)},translucencyLUTBuilder:function(e,f){var d=function(g){var h=2*Math.PI*g*e(Math.sqrt(g*g+f*f));return h};return this.utilities.integrate(d,0,64)},setTexture:function(g,e,d){var f=new a.DataTexture(g,e,d,a.RGBFormat,a.FloatType);f.minFilter=a.NearestFilter;f.magFilter=a.NearestFilter;f.generateMipmaps=false;f.flipY=false;f.needsUpdate=true;return f},decreaseUseCount:function(d){if(this.computedTextures.has(d)){var e=this.computedTextures.get(d);e.useCount--;if(e.useCount===0){e.textures.sssLUT.dispose();e.textures.translucencyLUT.dispose();e.textures.sssIBLLUT.dispose();this.computedTextures["delete"](d)}}},dispose:function(){this.computedTextures.forEach(function(e,d,f){e.textures.sssLUT.dispose();e.textures.translucencyLUT.dispose();e.textures.sssIBLLUT.dispose()});this.computedTextures.clear()},_getComputedTextures:function(d){var e=-1;this.computedTextures.forEach(function(g,f,h){if(c(g.options,d)){g.useCount++;e=f}});if(e>-1){return this.computedTextures.get(e).textures}return null},compute:function(g){var d=this._getComputedTextures(g);if(d!==null){return d}var m=Date.now();var q=new Float32Array(this.size*this.size*3),A=new Float32Array(this.size*6),l=new Float32Array(this.size*6);var h=this.modelFunction(g);for(var z=0;z<this.size;z++){var k=this.r[z];var E=this.s[z];var x=0,t=0,u=0;var w,C,D;w=this.translucencyLUTBuilder(h.red,E);C=this.translucencyLUTBuilder(h.green,E);D=this.translucencyLUTBuilder(h.blue,E);A[3*z+0]=w;A[3*z+1]=C;A[3*z+2]=D;A[3*this.size+3*z+0]=w;A[3*this.size+3*z+1]=C;A[3*this.size+3*z+2]=D;for(var y=0;y<this.size;y++){var B=this.theta[y];var s,r,p;s=this.sssLUTBuilder(h.red,k,B);p=this.sssLUTBuilder(h.green,k,B);r=this.sssLUTBuilder(h.blue,k,B);q[3*this.size*z+3*y+0]=s;q[3*this.size*z+3*y+1]=p;q[3*this.size*z+3*y+2]=r;x+=s*this.sinTheta[y];t+=p*this.sinTheta[y];u+=r*this.sinTheta[y]}x*=this.aux;t*=this.aux;u*=this.aux;l[3*z+0]=x;l[3*z+1]=t;l[3*z+2]=u;l[3*this.size+3*z+0]=x;l[3*this.size+3*z+1]=t;l[3*this.size+3*z+2]=u}var o=this.setTexture(q,this.size,this.size),f=this.setTexture(A,this.size,2),v=this.setTexture(l,this.size,2);var n=Date.now();console.log((n-m)/1000);var e={sssLUT:o,translucencyLUT:f,sssIBLLUT:v};this.computedTextures.set(o.id,{textures:e,options:{eta:g.eta,absorptionCoeffs:g.absorptionCoeffs.slice(0),scatteringCoeffs:g.scatteringCoeffs.slice(0)},useCount:1});return e},toImage:function(){var e=document.createElement("canvas");document.body.appendChild(e);var d=e.getContext("2d");var g=this;var f=function(l,o,k,n){e.height=k;e.width=o;for(var p=0;p<k;++p){for(var j=0;j<o;++j){d.fillStyle="rgb("+255*l[3*g.size*p+3*j]+", "+255*l[3*g.size*p+3*j+1]+",+"+255*l[3*g.size*p+3*j+2]+")";d.fillRect(j,p,1,1)}}var m=e.toDataURL("image/png");var h=document.createElement("a");h.download=n;h.innerHTML="Download File";h.href=m;h.click()};this.computedTextures.forEach(function(j,h,k){f(j.textures.sssLUT.image.data,j.textures.sssLUT.image.width,j.textures.sssLUT.image.height,"Scattering");f(j.textures.translucencyLUT.image.data,j.textures.translucencyLUT.image.width,j.textures.translucencyLUT.image.height,"Translucency");f(j.textures.sssIBLLUT.image.data,j.textures.sssIBLLUT.image.width,j.textures.sssIBLLUT.image.height,"IBL")})},utilities:{linspace:function(g,f,k){var d=Math.floor(k);if(d<=1){return[f]}var e=(f-g)/(k-1);var j=[];for(var h=0;h<d;h++){j[h]=g+h*e}return j},sumElements:function(f){var e=0;for(var d=0;d<f.length;d++){e+=f[d]}return e},multiplyArray:function(h,g){var d=Math.min(g.length,h.length);var f=[];for(var e=0;e<d;e++){f[e]=h[e]*g[e]}return f},sumArray:function(h,g){var d=Math.min(g.length,h.length);var f=[];for(var e=0;e<d;e++){f[e]=h[e]+g[e]}return f},applyToArray:function(g,f){var e=[];for(var d=0;d<g.length;d++){e[d]=f(g[d])}return e},integrate:function(k,j,g){var e=128;var d=this.linspace(j,g,e);var h=this.applyToArray(d,k);var f=0.5*(g-j)/e;return f*(2*this.sumElements(h)-h[e-1]-h[0])}}};return b});window.disposedViewers=[];var __WebGLViewer_prereqs=["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/Viewpoint","DS/Visualization/InternalSceneGraph","DS/Mesh/MeshUtils","DS/Animation/AnimationEngine","DS/Visualization/WebGLV6Renderer","DS/Visualization/OccurrencePath","UWA/Controls/Abstract","DS/Magnifier/Magnifier","DS/Visualization/TrapSelection","DS/Visualization/MaterialManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/SubElement","DS/VisuEvents/EventsManager","DS/Manipulators/ManipulatorManager","DS/Visualization/SceneGraph","DS/Visualization/SceneGraphUtils","DS/Visualization/SceneGraphFactory","DS/Visualization/HighlightSelection","DS/Visualization/SessionNodesWithSectionProfile","DS/CoreEvents/ModelEvents","DS/Plugins/UserPassManager","DS/Effects/BlurShadowEffect","DS/Effects/ESMEffect","DS/Visualization/PlaneGrid","DS/Manipulators/TrapSelectionManipulator","DS/Visualization/ClippingContext","DS/Visualization/GetSVGMode","DS/Visualization/RenderPriorityManager","DS/WebRecordEnabler/Adapter","DS/Effects/ConvertCubemapToLatlong","DS/Visualization/Ambience","DS/Visualization/RenderMode","DS/Visualization/RenderStyle","DS/Visualization/BudgetedRenderManager"];if(window.location.protocol!=="file:"){__WebGLViewer_prereqs.push("text!Visualization/assets/ambiences.json")}define("DS/Visualization/WebGLViewer",__WebGLViewer_prereqs,function(h,M,J,o,Q,T,O,j,N,q,e,c,Y,X,n,C,L,s,t,b,W,B,z,l,I,P,U,p,u,a,V,v,y,G,m,d,k,D,K,A,S,g,w,f){var r=null;if(f){r=JSON.parse(f)}var R=function(ab){var Z=document.getElementsByTagName("script"),ad,ac,ae;for(ad=0;ad<Z.length;ad++){ac=Z.item(ad);ae=ac.getAttribute("src");if(ae&&ae.match(ab)){return ae.substring(0,ae.lastIndexOf("/")+1)}}return"scripts/ThreeDS/Visualization/"};var F=0;var H=0.0001;var x=0;var E=X.extend({init:function(am){this.id=F++;window.debugWebGLV6Viewer=this;var ah=this,ae;if(am.uniqueName){this.uniqueName=am.uniqueName}this.clearThis=function(){ah=null};this.version="9.0";this._parent();this._manipulators={};this.trapSelectionManipulator=null;this.disposed=false;this._fillXSOMode=true;am=am||{};this._svgMode=am.svgMode?true:false;this._2DMode=false;this.div=null;this.divCssElement=null;this.materialManager=null;this.context2D=null;this._nearFarBigScale=window.nearFarBigScale?true:false;this._sceneGraph=null;this._sceneGraphOverrideSetManager=null;this._sceneGraphStateVersion=null;this._userPassManager=new a(this);this._renderPriorityManager=null;this._modelEvent=new u();this.trapSelection=null;this._renderStyle=null;this._forceSceneMinValue=null;if(am.capturer){this.capturer=am.capturer;this.capturer.setViewer(this);am.preserveDrawingBuffer=true}if(am.div!==undefined){this.div=am.div}if(am.divCssElement!==undefined){this.divCssElement=am.divCssElement}this.buildSkeleton();this.buildSkeletonCss();if(window.DSWebRecord){console.log("registering viewer#"+this.id);B._record_registerObject(this,"WebGLV6Viewer",[this.canvas,this.divTrap])}this.previousMaxSectionPolyLineSize=0;this.ODTMode=am.ODTMode||false;if(this.ODTMode&&am.ODTAmbiences){r=JSON.parse(am.ODTAmbiences)}this.mobile=am.mobile!==undefined?am.mobile:(navigator.userAgent.match(/(Android|iPhone|iPad)/i)?true:false);M.mobileVersion=this.mobile;this.useHDR=am.hdr!==undefined?am.hdr:true;this.multiViewer=am.multiViewer!==undefined?am.multiViewer:false;this.multiViewerFix=true;this.defaultAnimationLoop=am.defaultAnimationLoop!==undefined?am.defaultAnimationLoop:true;if(D.isReplaying()){this.defaultAnimationLoop=false}this.autoUpdateFrustum=am.autoUpdateFrustum!==undefined?am.autoUpdateFrustum:true;this.autoUpdateLights=true;this.triLights=am.triLights!==undefined?am.triLights:false;this.ambience=new A({viewer:this});this.ambience.setBackgroundColor((am.backgroundColor!==undefined?am.backgroundColor:0));this.ambience.setBackgroundAlpha((am.backgroundAlpha!==undefined?am.backgroundAlpha:1));this.__tempBackgroundColorODT=(am.backgroundColor!==undefined?am.backgroundColor:0);this.planeColor=new M.Color(15658734);this.gridColor=new M.Color(15658734);this.showBgAlpha=this.ambience.getBackgroundAlpha();this.noShowColor=new M.Color().setRGB(150/255,185/255,165/255);this.noShowAlpha=0.5;this.saturationRatio=1;this.blendingRatio=0.5;this.showBgColor=this.ambience.getBackgroundColor().getHex();this.showPlaneColor=new M.Color(this.planeColor.getHex());this.showGridColor=new M.Color(this.gridColor.getHex());this.showGradientBackground=[];this.visibleSpace=am.visibleSpace!==undefined?am.visibleSpace:1;this.axisFilterStatus=false;this.pointsFilterStatus=true;this.linesFilterStatus=true;this.lockedRenderMode=new Map();this.sceneGraphState=null;this.cameraSystem=null;this.cameraSystemUpdated=false;this.lastNbTexturesBeingLoaded=0;this.highlightColor=null;this.highlightSets=[];this.picking={activated:true,trapSelection:false,displayHL:true,gpu:true,computeNormalDepth:true,primitive:false,tolerance:2};if(am.highlight!==undefined){this.setPicking(am.highlight)}this.pPicking={activated:false,trapSelection:false,displayHL:true,gpu:true,computeNormalDepth:false,primitive:false,disableWhileMoving:true,tolerance:2};if(am.pHighlight!==undefined){this.setPrePicking(am.pHighlight)}this.lastAddedToPSO=null;if((am.usePicking!==undefined)||(am.usePickingGPU!==undefined)){console.log("usePicking and usePickingGPU parameters are deprecated.\n Use highlight and pHighlight objects instead.")}if(am.usePicking!==undefined){this.picking.activated=am.usePicking}if(am.usePickingGPU!==undefined){this.picking.gpu=am.usePickingGPU}this.infinitePlane=(am.infinitePlane!==undefined?am.infinitePlane:true);this._infinitePlane=this.infinitePlane;this.displayGrid=(am.displayGrid!==undefined?am.displayGrid:false);this._displayGrid=this.displayGrid;this.displayGridFromBelow=false;this.autoUpdatePlane=am.autoUpdatePlane!==undefined?am.autoUpdatePlane:true;this.useMirror=am.mirror!==undefined?(!this.mobile&&am.mirror):false;this.blurryMirror=false;this.planeAttenuation=false;this.useShadowPlane=this._infinitePlane;this.useDefaultLights=am.defaultLights!==undefined?am.defaultLights:true;this.useGroundShadow=am.useGroundShadow!==undefined?am.useGroundShadow:false;this.useShadowMap=am.useShadowMap!==undefined?am.useShadowMap:true;if(this.mobile){this.useShadowMap=false}this.shadowFilter="PCF";this.shadowQuality="Low";this.shadowMapWidth=am.shadowMapWidth!==undefined?am.shadowMapWidth:4096;this.shadowMapHeight=am.shadowMapHeight!==undefined?am.shadowMapHeight:4096;this.deferred=am.deferred!==undefined?am.deferred:false;this.antiAliasing=am.antiAliasing!==undefined?am.antiAliasing:"NoAA";if(this.antiAliasing===true){this.antiAliasing="SMAA"}else{if(this.antiAliasing===false){this.antiAliasing="NoAA"}}this.useOIT=am.useOIT!==undefined?am.useOIT&&!this.mobile:false;if(am.svgMode){this.useOIT=false}this.forceRender=false;this.visuEnv="None";if(am.displayHighlight!==undefined){this.displayHighlight=am.displayHighlight;this.setPicking({activated:this.displayHighlight,displayHL:this.displayHighlight})}this.useVignetting=am.useVignetting!==undefined?am.useVignetting:false;this.useSSAO=am.ssao!==undefined?am.ssao:false;this.useSSAOIterative=am.ssaoIterative!==undefined?am.ssaoIterative:false;this.useSSLR=am.sslr!==undefined?am.sslr:false;this.useBloom=am.bloom!==undefined?am.bloom:false;this.useFlare=am.flare!==undefined?am.flare:false;this.useDOF=am.dof!==undefined?am.dof:false;this._effectSettings={AntiAliasing:{"static":this.antiAliasing,dynamic:(this.antiAliasing!=="MSAA")?this.antiAliasing:"SMAA"},Outline:{"static":true,dynamic:false},PixelCulling:{"static":4.5,dynamic:4.5},Transparency:{"static":this.useOIT?"WeightedAverage":"AlphaBlending",dynamic:this.useOIT?"WeightedAverage":"AlphaBlending",},GroundShadows:{"static":this.useGroundShadow,dynamic:this.useGroundShadow},InterObjectShadows:{"static":this.useShadowMap,dynamic:this.useShadowMap},ShadowQuality:{"static":this.shadowQuality,dynamic:this.shadowQuality},ShadowFilter:{"static":this.shadowFilter,dynamic:this.shadowFilter},GroundReflection:{"static":this.useMirror,dynamic:this.useMirror},SSAO:{"static":this.useSSAO,dynamic:this.useSSAO},Bloom:{"static":this.useBloom,dynamic:this.useBloom},DepthOfField:{"static":this.useDOF,dynamic:this.useDOF},ZPrePass:{"static":false,dynamic:false}};this.magnifier=null;this.debugShadowLight=am.debugShadowLight!==undefined?am.debugShadowLight:false;this.debugBSphere=am.debugBSphere!==undefined?am.debugBSphere:false;this.debugPrimitiveBSphere=am.debugPrimitiveBSphere!==undefined?am.debugPrimitiveBSphere:false;this.debugRepBBox=am.debugRepBBox!==undefined?am.debugRepBBox:false;this.debugPicking=am.debugPicking!==undefined?am.debugPicking:false;this.debugNormals=am.debugNormals!==undefined?am.debugNormals:false;this.debugBackfaceCulling=am.debugBackfaceCulling!==undefined?am.debugBackfaceCulling:false;this.debugPickHybrid=false;var ad=null;this.debugPostProcessing=false;this.debugShadowMaps=false;this.debugEvents=0;this.debugFPS=false;this.debugFPSInfos={fpsCounter:null,fpsArray:[],fpsIndex:0,fpsValue:30,fpsCumul:1200,fpsWindow:40,fpsLastTime:0};this.viewpoints=[];this.currentViewpoint=null;this.trackingViewpoint=null;this.internalSceneGraph=null;this.manipulatorManager=null;this.temporaryEmptyScene=new M.Scene();this.centerMouseDownCB=null;this.mouseMoveCB=null;this.centerMouseUpCB=null;this.leftMouseDownCB=null;this.leftMouseUpCB=null;this.rightMouseUpCB=null;this._defaultPicking=null;this.setDefaultPicking(true);this.pickingPriorityMapping=null;this.forceMultiSel=false;this.sceneBackground=new M.Scene();this.sceneBackground.isBackground=true;this.cameraBackgroundNear=0.0001;this.cameraBackgroundFar=1;this.cameraBackground=new M.PerspectiveCamera();this.sceneBackground.add(this.cameraBackground);this.cameraReflected=new M.PerspectiveCamera();this.infPlane=null;this.infPlaneSmall=null;this.planeSize=200;this.grid=null;this.bigGrid=null;this.gridSize=200;this.gridUnit=1;this.gridStep=0.005;this.gridNbSteps=5;this.offsetPlaneSmall=new M.Vector3();this.offsetPlaneBackground=new M.Vector3();this.planeV2=am.planeV2!==undefined?am.planeV2:false;this.planeGrid=this.planeV2?new y(this):null;this.ground=null;this.envMap=null;this.envMap2=null;this.envMapExposure=1;this.envMapOffset=0;this.envMapBlur=0;this.sphereEnv=null;this.isRenderIteration=true;this._lockRenderIteration=false;this.renderIteration=0;this.timeIter0=0;this.delayBeforeIteration=500;this.devicePixelRatio=window.devicePixelRatio||1;this.SCREEN_WIDTH=800;this.SCREEN_HEIGHT=600;this.lazyResize=am.lazyResize!==undefined?am.lazyResize:false;this.lazyResizeTime=300;this.oldCanvasSize={width:this.SCREEN_WIDTH,height:this.SCREEN_HEIGHT,dpr:this.devicePixelRatio,time:new Date().getTime()};this.initMousePos=null;this.currMousePos=null;this.bSphere=null;this.bBox=null;this.primitiveBSphere=null;this.debugPickingNode=new M.Object3D();this.debugNormalNode=new M.Object3D();this.renderer=null;this._requestRender=false;this._onlyPostProcess=true;this._renderParams=[];this.renderFrameCB=null;this.beginRenderFrameCB=null;this.ambientLight=new M.AmbientLight(new M.Color(0));this.directionalLight=null;this.directionalLight2=null;this.directionalLight3=null;this.dirLightGroundShadow=null;this.probeLight=null;this.dirLightLatitude=0.25;this.dirLightVector=new M.Vector3(2,1.5,2.5);this.dirLight2Vector=new M.Vector3(0,0,1);this.dirLight3Vector=new M.Vector3(0,0,1);this.dirLightType=[false,false,false];this.lights=[];M.intensityCorrection=false;this.budgetedRenderManager=new w(this);ae=new Date();this._oldTime=ae.getTime();this.overrideCursors=true;this._changeCursorDelay=null;this._temporaryCursorData=null;this._forcePRZ=false;this.startPan=function(an){var ao=this.currentViewpoint.getControl();if(ao!==null){ao.startPan(an)}this._forcePRZ=true};this.startRotate=function(an){var ao=this.currentViewpoint.getControl();if(ao!==null){ao.startRotate(an)}this._forcePRZ=true};this.startZoom=function(an){var ao=this.currentViewpoint.getControl();if(ao!==null){ao.startZoom(an)}this._forcePRZ=true};this.endPan=function(an){var ao=this.currentViewpoint.getControl();if(ao!==null){ao.endPan(an);this.setCursor("Auto",0)}this._forcePRZ=false};this.endRotate=function(an){var ao=this.currentViewpoint.getControl();if(ao!==null){ao.endRotate(an);this.setCursor("Auto",0)}this._forcePRZ=false};this.endZoom=function(an){var ao=this.currentViewpoint.getControl();if(ao!==null){ao.endZoom(an);this.setCursor("Auto",0)}this._forcePRZ=false};this._getPaths=function(ar,au,aq,at){var ap,an;if(au.count==au.stop){at.push(aq.slice(0));return}au.count++;aq.push(ar);var ao=ar.children;an=ao.length;for(ap=0;ap<an;ap++){this._getPaths(ao[ap],au,aq,at)}aq.pop();au.count--},this.addPathToHso=function(ao){var ap=[];var aq=t;this._getPaths(this.getRootNode().children[0],{count:0,stop:ao},[],ap);for(var an=0;an<ap.length;an++){aq.add({pathElement:new O(ap[an])})}return ap};this.render=function(an){if(ah==null){return}if(an===undefined){an={}}if(an.budgeted){ah.budgetedRenderManager._askForRender(an);return}else{if(an.budgeted===undefined){ah.budgetedRenderManager._resetShift()}}ah._renderParams.push(an);ah._requestRender=true;if(!an||!an.onlyPostProcess){ah._onlyPostProcess=false}};this.glRender=function(bm){if(this.budgetedRenderManager._isActive){this.budgetedRenderManager._setAsRenderFrame()}if(this.beginRenderFrameCB){this.beginRenderFrameCB()}if(p.maxPolyLineSize!==this.previousMaxSectionPolyLineSize){this.previousMaxSectionPolyLineSize=p.maxPolyLineSize;this.renderer&&this.renderer.recompileAllShaders()}if(M.webGLStats){M.webGLStats.reset()}var aP,aG,bx,a8,aL,aK,ap,az,ay,aW,bf,aJ,au,bo,bl,aQ,at,ba,a7,aC,aX,aV,aU,aS,bd;var aQ=false,a9=null;var ba=false;var bu=false;var bo=ah.currentViewpoint;var aR=true;var br=!!bm.length;var aY=!!bm.length;var bA=false;var aD=512;var be=0;var bq=0;var bn=false;for(aV=0;aV<bm.length;aV++){if(bm[aV].needReframe!==undefined){aQ=bm[aV].needReframe}if(bm[aV].reframeSpace!==undefined){a9=bm[aV].reframeSpace}if(bm[aV].updateInfinitePlane!==undefined){ba=ba||bm[aV].updateInfinitePlane}if(bm[aV].updateInfinitePlaneFast!==undefined){bu=bu||bm[aV].updateInfinitePlaneFast}if(bm[aV].renderIteration!==undefined){bq=bm[aV].renderIteration}if(bm[aV].isStillFrame!==undefined){bn=bm[aV].isStillFrame}if(bm[aV].viewpoint!==undefined){bo=bm[aV].viewpoint}if(bm[aV].toScreen!==undefined){aR=bm[aV].toScreen}if(!bm[aV].onlyPostProcess){br=false}if(!bm[aV].onlyForward){aY=false}if(bm[aV].cubemap!==undefined){bA=bm[aV].cubemap}if(bm[aV].cubemapResolution!==undefined){aD=bm[aV].cubemapResolution}if(bm[aV].cubeFace!==undefined){be=bm[aV].cubeFace}}var bp=(bq===0)?"dynamic":"static";ah._setPixelCulling(bp);ah._setAntiAliasing(bp);ah._setShadow(bp);ah._setShadowFilter(bp);ah._setShadowQuality(bp);ah._setGroundShadow(bp);ah._setOIT(bp);ah._enableZPrePass(bp);ah._setMirror(bp);ah._setSSAO(bp);ah._setBloom(bp);ah._setDOF(bp);ah._modelEvent.publish({event:"PreRender",data:{viewer:ah,viewpoint:ah.currentViewpoint,onlyPostProcess:br}});bl=bo.camera;aJ=(ah.internalSceneGraph===null)?ah.temporaryEmptyScene:ah.internalSceneGraph.scene;au=(ah.internalSceneGraph===null)?new M.Sphere(new M.Vector3(0,0,0),100):ah.getSceneBoundingSphere(this.visibleSpace?"visibleSpace":"invisibleSpace");if(au.pixelRadius>0){var bh=bl.getWorldSizeFromPixelSize(1,au.center,this.div.clientHeight);if(typeof bl.fullWidth!=="undefined"&&bl.fullWidth>0){var bi=Math.max(bl.width*1/bl.fullWidth,bl.height*1/bl.fullHeight);bh*=bi}au.radius+=bh*au.pixelRadius}if(bo!==null){bl.updateMatrix();bl.matrixWorld.copy(bl.matrix);bl.matrixWorldInverse.getInverse(bl.matrixWorld);this.ambience.update();if(this.sphereEnv){this.ambience.updateCamera(bo,this.renderer,bl)}}if(ah.directionalLight){ah.directionalLight.shadowCameraVisible=ah.debugShadowLight}if(ah.debugBSphere){if(ah.bSphere){ah.bSphere.visibilityFree=true;ah.bSphere.visible=true;ah.bSphere.matrix=new M.Matrix4();aP=new M.Matrix4();aP.makeScale(au.radius,au.radius,au.radius);aP.setPosition(au.center);ah.bSphere.setMatrix(aP)}else{if(aJ!==null){bx=new M.MeshPhongMaterial({color:16729156,opacity:0.2,transparent:true,force:true});var aN=P.createSphereNode({radius:1,sag:32,material:bx});aN.setPickable(2);ah.bSphere=aN._occurrences[0].renderable;ah.bSphere.frustumCulled=false;ah.bSphere.drawInHLRender=false;aJ.add(ah.bSphere)}}}else{if(ah.bSphere){ah.bSphere.visibilityFree=true;ah.bSphere.visible=false}}if(ah.debugPrimitiveBSphere){var a2=null;var aZ=null;var bg=WUX.Selection.HSOManager.get();if(bg[0]){var ar=bg[0].pathElement;var a6=ar.getLastElement();if(a6.sgNode&&a6.sgNode.boundingSphere){a2=a6.sgNode.boundingSphere;aZ=ar.getWorldMatrix(this)}}if(a2){if(ah.primitiveBSphere){ah.primitiveBSphere.visible=true;ah.primitiveBSphere.matrix=new M.Matrix4();aP=new M.Matrix4();aP.makeScale(a2.radius,a2.radius,a2.radius);aP.setPosition({x:a2.center[0],y:a2.center[1],z:a2.center[2]});aZ.multiplyMatrices(aZ,aP);ah.primitiveBSphere.setMatrix(aZ)}else{if(aJ!==null){bx=new M.MeshPhongMaterial({color:16729156,opacity:0.3,transparent:true,force:true});var aN=P.createSphereNode({radius:1,sag:32,material:bx});aN.setPickable(2);ah.primitiveBSphere=aN._occurrences[0].renderable;ah.primitiveBSphere.frustumCulled=false;aJ.add(ah.primitiveBSphere)}}}else{if(ah.primitiveBSphere){ah.primitiveBSphere.visible=false}}}if(ah.debugRepBSphere){var a5=null;var aZ=null;var bg=WUX.Selection.HSOManager.get();if(bg[0]){var ar=bg[0].pathElement;var a6=ar.getLastElement();if(a6.sgNode&&a6.sgNode.rep&&a6.sgNode.rep.boundingSphere){a5=a6.sgNode.rep.boundingSphere;aZ=ar.getWorldMatrix(this)}}if(a5){if(ah.repBSphere){ah.repBSphere.visible=true;ah.repBSphere.matrix=new M.Matrix4();aP=new M.Matrix4();aP.makeScale(a5.radius,a5.radius,a5.radius);aP.setPosition({x:a5.center[0],y:a5.center[1],z:a5.center[2]});aZ.multiplyMatrices(aZ,aP);ah.repBSphere.setMatrix(aZ)}else{if(aJ!==null){bx=new M.MeshPhongMaterial({color:16729156,opacity:0.3,transparent:true,force:true});var aN=P.createSphereNode({radius:1,sag:32,material:bx});aN.setPickable(2);ah.repBSphere=aN._occurrences[0].renderable;ah.repBSphere.frustumCulled=false;aJ.add(ah.repBSphere)}}}else{if(ah.repBSphere){ah.repBSphere.visible=false}}}if(ah.debugRepBBox){var aF=null;var aZ=null;var bg=WUX.Selection.HSOManager.get();if(bg[0]){var ar=bg[0].pathElement;var a6=ar.getLastElement();if(a6.getBoundingBox()){aF=a6.getBoundingBox();aZ=ar.getWorldMatrix(this)}}else{aF=this.getSceneBoundingBox();aZ=this.internalSceneGraph.root.getMatrix()}if(aF){if(ah.bBox){ah.bBox.visible=true;ah.bBox.matrix=new M.Matrix4();aP=new M.Matrix4();aP.makeScale(aF.max.x-aF.min.x,aF.max.y-aF.min.y,aF.max.z-aF.min.z);aP.setPosition({x:aF.min.x+(aF.max.x-aF.min.x)/2,y:aF.min.y+(aF.max.y-aF.min.y)/2,z:aF.min.z+(aF.max.z-aF.min.z)/2});aZ.multiplyMatrices(aZ,aP);ah.bBox.setMatrix(aZ)}else{if(aJ!==null){bx=new M.MeshPhongMaterial({color:16729156,opacity:0.3,transparent:true,force:true});var bw=P.createCuboidNode({cornerPoint:new M.Vector3(-0.5,-0.5,-0.5),firstAxis:new M.Vector3(1,0,0),secondAxis:new M.Vector3(0,1,0),thirdAxis:new M.Vector3(0,0,1),material:bx});ah.bBox=bw._occurrences[0].renderable;ah.bBox.frustumCulled=false;ah.bBox.pickable=false;aJ.add(ah.bBox)}}}}else{if(ah.bBox){ah.bBox.visible=false}}if(ah.debugLocalBBox){var aq=new M.Matrix4().identity();if(ah.debugHandleMatrix){aq.copy(ah.currentViewpoint.camera.matrix)}var bg=WUX.Selection.HSOManager.get();var bs=[];for(var aV=0;aV<bg.length;aV++){bs.push(bg[aV].pathElement)}var a4=I.getOrientedBoundingBoxFromPathElements(bs,aq,ah).localBBox;if(a4){if(ah.localBBox){ah.localBBox.visible=true;ah.localBBox.matrix=new M.Matrix4();aP=new M.Matrix4();aP.makeScale(a4.max.x-a4.min.x,a4.max.y-a4.min.y,a4.max.z-a4.min.z);aP.setPosition({x:a4.min.x+0.5*(a4.max.x-a4.min.x),y:a4.min.y+0.5*(a4.max.y-a4.min.y),z:a4.min.z+0.5*(a4.max.z-a4.min.z)});aq.multiplyMatrices(aq,aP);ah.localBBox.setMatrix(aq)}else{if(aJ){bx=new M.MeshPhongMaterial({color:16729156,opacity:0.3,transparent:true,force:true});var bw=P.createCuboidNode({cornerPoint:new M.Vector3(-0.5,-0.5,-0.5),firstAxis:new M.Vector3(1,0,0),secondAxis:new M.Vector3(0,1,0),thirdAxis:new M.Vector3(0,0,1),material:bx});bw.setPickable(2);ah.localBBox=bw._occurrences[0].renderable;ah.localBBox.frustumCulled=false;aJ.add(ah.localBBox)}}}else{if(ah.localBBox){ah.localBBox.visible=false}}}if(ah.debugBBox){var aq=new M.Matrix4().identity();if(ah.debugHandleMatrix){aq.copy(ah.currentViewpoint.camera.matrix)}var an=this.computeSceneAccurateBoundingBox(ah.visibleSpace?"visibleSpace":"invisibleSpace",ah.debugHandleMatrix?aq:null);if(an){if(ah.BBox){ah.BBox.visible=true;ah.BBox.matrix=new M.Matrix4();aP=new M.Matrix4();aP.makeScale(an.max.x-an.min.x,an.max.y-an.min.y,an.max.z-an.min.z);aP.setPosition({x:an.min.x+0.5*(an.max.x-an.min.x),y:an.min.y+0.5*(an.max.y-an.min.y),z:an.min.z+0.5*(an.max.z-an.min.z)});aq.multiplyMatrices(aq,aP);ah.BBox.setMatrix(aq)}else{if(aJ){bx=new M.MeshPhongMaterial({color:16729156,opacity:0.3,transparent:true,force:true});var bw=P.createCuboidNode({cornerPoint:new M.Vector3(-0.5,-0.5,-0.5),firstAxis:new M.Vector3(1,0,0),secondAxis:new M.Vector3(0,1,0),thirdAxis:new M.Vector3(0,0,1),material:bx});bw.setPickable(2);ah.BBox=bw._occurrences[0].renderable;ah.BBox.frustumCulled=false;aJ.add(ah.BBox)}}}else{if(ah.BBox){ah.BBox.visible=false}}}else{if(ah.BBox){ah.BBox.visible=false}}if(ah.debugPicking){aJ.add(ah.debugPickingNode)}else{aJ.remove(ah.debugPickingNode)}if(ah.debugNormals){if(!ah.debugNormalNode.children.length){ak()}aJ.add(ah.debugNormalNode)}else{aJ.remove(ah.debugNormalNode);ah.debugNormalNode.children=[]}for(var aV=0;aV<aJ.__lights.length;aV++){var a8=aJ.__lights[aV];var aw=false;if(a8._occurrence){aw=a8._occurrence.node._attachedToVpt}if(aw){a8._vptPosition=bo.getEyePosition();if(a8.hasOwnProperty("target")){aC=bl.getLookAt();ap=bo.getEyePosition().add(aC);a8.target.position=ap}}}if(ah.useDefaultLights){a8=ah.directionalLight;aL=ah.directionalLight2;aK=ah.directionalLight3;if(au!==null){if(ah.triLights){var aO=bo.getUpDirection();var aI=bo.getSightDirection();var a3=new M.Vector3().crossVectors(aI,aO);if(ah.autoUpdateLights){ap=new M.Vector3(2*au.radius,2*au.radius,2*au.radius);a8.position=new M.Vector3().copy(au.center).add(ap);a8.lookAt(au.center);az=new M.Vector3().copy(aO).sub(aI).sub(a3).multiplyScalar(2*au.radius);aL.position=new M.Vector3().copy(au.center).add(az);aL.lookAt(au.center);ay=new M.Vector3().copy(a3).sub(aI).multiplyScalar(2*au.radius);aK.position=new M.Vector3().copy(au.center).add(ay);aK.lookAt(au.center)}else{if(!ah.dirLightType[0]){ap=new M.Vector3().copy(ah.dirLightVector).multiplyScalar(au.radius)}else{ap=new M.Vector3(a3.x*ah.dirLightVector.x+aO.x*ah.dirLightVector.y-aI.x*ah.dirLightVector.z,a3.y*ah.dirLightVector.x+aO.y*ah.dirLightVector.y-aI.y*ah.dirLightVector.z,a3.z*ah.dirLightVector.x+aO.z*ah.dirLightVector.y-aI.z*ah.dirLightVector.z).multiplyScalar(au.radius);a8.updateShadowMap=true}a8.position=new M.Vector3().copy(au.center).add(ap);a8.lookAt(au.center);if(!ah.dirLightType[1]){az=new M.Vector3().copy(ah.dirLight2Vector).multiplyScalar(au.radius)}else{az=new M.Vector3(a3.x*ah.dirLight2Vector.x+aO.x*ah.dirLight2Vector.y-aI.x*ah.dirLight2Vector.z,a3.y*ah.dirLight2Vector.x+aO.y*ah.dirLight2Vector.y-aI.y*ah.dirLight2Vector.z,a3.z*ah.dirLight2Vector.x+aO.z*ah.dirLight2Vector.y-aI.z*ah.dirLight2Vector.z).multiplyScalar(au.radius)}aL.position=new M.Vector3().copy(au.center).add(az);aL.lookAt(au.center);if(!ah.dirLightType[2]){ay=new M.Vector3().copy(ah.dirLight3Vector).multiplyScalar(au.radius)}else{ay=new M.Vector3(a3.x*ah.dirLight3Vector.x+aO.x*ah.dirLight3Vector.y-aI.x*ah.dirLight3Vector.z,a3.y*ah.dirLight3Vector.x+aO.y*ah.dirLight3Vector.y-aI.y*ah.dirLight3Vector.z,a3.z*ah.dirLight3Vector.x+aO.z*ah.dirLight3Vector.y-aI.z*ah.dirLight3Vector.z).multiplyScalar(au.radius)}aK.position=new M.Vector3().copy(au.center).add(ay);aK.lookAt(au.center)}}else{if(ah.autoUpdateLights){if(ah.dirLightType[0]){aC=bl.getLookAt();ap=new M.Vector3(-2*aC.x*au.radius,-2*aC.y*au.radius,-2*aC.z*au.radius);a8.position=new M.Vector3().copy(au.center).add(ap)}else{ah.dirLightVector.set(2,1.5,2.5);a8.position=new M.Vector3().copy(ah.dirLightVector).multiplyScalar(au.radius).add(au.center)}az=new M.Vector3(-2*au.radius,1.5*au.radius,2.5*au.radius);aL.position=new M.Vector3().copy(au.center).add(az)}else{a8.position=new M.Vector3().copy(ah.dirLightVector).multiplyScalar(2*au.radius).add(au.center);az=new M.Vector3(-2*au.radius,1.5*au.radius,2.5*au.radius);aL.position=new M.Vector3().copy(au.center).add(az)}}a8.lookAt(au.center);a8.target.position.copy(au.center);a8.target.updateMatrixWorld();aL.target.position.copy(au.center);aL.target.updateMatrixWorld();if(aK){aK.target.position.copy(au.center);aK.target.updateMatrixWorld()}}if(ah.useShadowMap){a8.castShadow=true;if(au!==null){aW=a8.position.distanceTo(au.center);var aE=Math.PI*Math.max(0.1,0.5-ah.dirLightLatitude);var by=Math.sin(aE)+(Math.cos(aE)+1)/Math.tan(aE);if(a8.shadowCamera&&!a8.LiSPSM){a8.updateShadowMap=a8.updateShadowMap||(a8.shadowCamera.top!==au.radius);a8.shadowCamera.far=aW+by*au.radius;a8.shadowCamera.near=Math.max(0.001*a8.shadowCamera.far,aW-au.radius);a8.shadowCamera.left=-au.radius;a8.shadowCamera.right=au.radius;a8.shadowCamera.bottom=-au.radius;a8.shadowCamera.top=au.radius;a8.shadowCamera.updateProjectionMatrix()}else{a8.shadowCameraFar=aW+by*au.radius;a8.shadowCameraNear=Math.max(0.001*a8.shadowCameraFar,aW-au.radius);a8.updateShadowMap=true}}}else{a8.castShadow=false}}if(ah._infinitePlane||ah._displayGrid){ah.updateBackgroundLights()}if(!this._2DMode){if(this.ambience.getBackground().isActivated()){var av=bo?bo.camera.position:this.currentViewpoint.camera.position;if(!this.sphereEnv){this._setSphereEnv(this.ambience.getSphere())}this.internalSceneGraph.scene.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(true);this.ambience.updateSphere(0.9*ah.cameraBackgroundFar,av,this.sphereEnv)}else{ah.removeEnvMap()}if(this.ambience.getGround().isActivated()){if(this.ambience.getGround().getType()=="physical"){if(!this.ground){this._setPhysicalGround(this.ambience.createGroundGeometry())}this.ambience.updateGround(this.ground)}else{if(this.ground){this.ground.visible=false}}}else{if(this.ground){this.ground.visible=false}}}if(this.ambience.needUpdateIBL){var bz=this.ambience.getIblMap();var a0=this.ambience.getRoughnessMap();var ao=false;var bv=(!!ah.internalSceneGraph.scene.envMipMap[0])&&(!!ah.internalSceneGraph.scene.envMipMap[1]);if(bz){this.internalSceneGraph.scene.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(true);ao=!bv;ah.internalSceneGraph.scene.envMipMap[0]=bz;ah.internalSceneGraph.scene.envMipMap[1]=a0}else{ao=bv;ah.internalSceneGraph.scene.envMipMap=[]}if(ah.internalSceneGraph.scene.envMipMapID){ah.renderer.renderer.ambianceGenerators.decreaseUseCount(ah.internalSceneGraph.scene.envMipMapID);ah.internalSceneGraph.scene.envMipMapID=null}if(ao){ah.renderer&&ah.renderer.recompileAllShaders()}this.ambience.needUpdateIBL=false}if(!ah._displayGrid&&((ah.grid!==null&&ah.grid.visible)||(ah.bigGrid!==null&&ah.bigGrid.visible))){ah._removeGrid()}at=100;if((bo!==null)&&(au!==null)&&(ah._displayGrid||ah._infinitePlane||ah.useShadowPlane||ah.ambience.getGround().isActivated()||ah.ambience.isFiniteMode())){ah.offsetPlaneSmall.x=au.center.x;ah.offsetPlaneSmall.y=au.center.y;var bc=2*au.radius;ah._updateOffsetPlane(au,bl,ba,ah._forceSceneMinValue,ah.internalSceneGraph,bu);var aH=ah._getPlaneSize(au,bl,ah.gridUnit,ah.gridStep);if(aH!==ah.planeSize){ah.planeSize=aH;ah._updateNearFar()}bf=-bl.getLookAt().z;at=bl.isOrtho?bf:bl.position.z-ah.offsetPlaneBackground.z;if((at>0)&&ah.useShadowPlane&&!ah._2DMode){var aM=new M.Vector3().copy(ah.offsetPlaneSmall);aM.z-=0.001*at;var aE=Math.PI*Math.max(0.1,0.5-ah.dirLightLatitude);var by=Math.sin(aE)+(Math.cos(aE)+1)/Math.tan(aE);bc*=by;ah.createInfinitePlane(ah.infPlaneSmall,0,bc,aM)}else{ah._removeInfinitePlane(ah.infPlaneSmall)}if(ah.planeV2&&ah.planeGrid){ah.planeGrid.createPlaneGrid(ah.planeSize,ah.offsetPlaneBackground,bo,ah.ambience.isAutoGroundOffset())}else{if(ah._infinitePlane){ah.createInfinitePlane(ah.infPlane,1,ah.planeSize,ah.offsetPlaneBackground)}if(ah._displayGrid){if((at>0)||this.displayGridFromBelow){ah.createGrid(ah.planeSize,ah.offsetPlaneBackground,Math.abs(bl.position.z-ah.offsetPlaneBackground.z),Math.abs(bf),ba)}else{ah._removeGrid()}}aX=new M.Vector3().copy(ah.offsetPlaneBackground);aX.applyMatrix4(bl.matrixWorldInverse);if(this.grid!==null){this.grid.material.uniforms.gridCenter.value.copy(aX);if(this.bigGrid!==null){this.bigGrid.material.uniforms.gridCenter.value.copy(aX)}}}if(ah.useGroundShadow){var aB=ah.dirLightGroundShadow;var aO=bo.getUpDirection();var aI=bo.getSightDirection();var a3=new M.Vector3().crossVectors(aI,aO);ap=new M.Vector3(0,0,2*au.radius);aB.position=new M.Vector3().copy(au.center).add(ap);aB.lookAt(au.center);aB.target.position.copy(au.center);aB.target.updateMatrixWorld();aB.castGroundShadow=true;aW=aB.position.distanceTo(au.center);if(aB.shadowCamera){aB.updateShadowMap=!aB.blockUpdate&&(aB.updateShadowMap||(aB.shadowCamera.top!==0.5*bc));aB.shadowCamera.far=aW+au.radius;aB.shadowCamera.near=Math.max(0.001*aB.shadowCamera.far,aW-au.radius);aB.shadowCamera.left=-0.5*bc;aB.shadowCamera.right=0.5*bc;aB.shadowCamera.bottom=-0.5*bc;aB.shadowCamera.top=0.5*bc;aB.shadowCamera.updateProjectionMatrix()}else{aB.shadowCameraFar=aW+au.radius;aB.shadowCameraNear=Math.max(0.001*aB.shadowCameraFar,aW-au.radius);aB.shadowCameraLeft=-0.5*bc;aB.shadowCameraRight=0.5*bc;aB.shadowCameraBottom=-0.5*bc;aB.shadowCameraTop=0.5*bc;aB.updateShadowMap=true}}else{ah.dirLightGroundShadow.castGroundShadow=false}}if(ah.useGroundShadow&&ah.useShadowPlane&&!ah._2DMode){ah.__setGroundShadow()}if(!this.cameraSystem){this.renderCamera(bl,null,aR,br,aY,bA,aD,be,bq,bn,"main",at)}else{var bj,ax,aT=this.trackingViewpoint||bo;bj=this.cameraSystem.computeCameraArray(bo,aT.camera.near,aT.camera.far);if(this.cameraSystem.useExternalProjectionMatrix){var a1=H*this.cameraBackgroundFar;if(this._nearFarBigScale){a1=Math.min(0.001,a1)}ax=this.cameraSystem.computeCameraArray(bo,a1,this.cameraBackgroundFar)}var bk=[],bt=this.renderer.renderer.getViewportSize();for(aV=0;aV<bj.length;aV++){this.renderer.renderer.cameraSystem_cameraIndex=aV;bk.push("cameraSystem"+aV);if(this.mobile||!this.useHDR){this.renderer.renderer.setSplitScreenMode(aV*bt.width,0)}else{this.renderer.renderer.removeSplitScreenMode()}if(this.sphereEnv&&this.sphereEnv.material){var aA=this.sphereEnv.material.uniforms;if(aA&&aA.cameraSight){if(bj[aV].fullWidth){aA.invScreenSize.value.x=1/bj[aV].width;aA.invScreenSize.value.y=1/bj[aV].height;aA.startOffset.value.x=bj[aV].x/bj[aV].fullWidth;aA.startOffset.value.y=bj[aV].y/bj[aV].fullHeight;aA.endOffset.value.x=(bj[aV].x+bj[aV].width)/bj[aV].fullWidth;aA.endOffset.value.y=(bj[aV].y+bj[aV].height)/bj[aV].fullHeight}else{aA.invScreenSize.value.x=1/bt.width;aA.invScreenSize.value.y=1/bt.height;aA.startOffset.value.x=0;aA.startOffset.value.y=0;aA.endOffset.value.x=1;aA.endOffset.value.y=1}}}this.renderCamera(bj[aV],ax&&ax[aV],false,br,aY,bA,aD,be,bq,bn,bk[aV],at)}if(!this.mobile&&this.useHDR){if(!this.renderer.combineResults(bk,aR,this.cameraSystem)){this.render()}}else{this.renderer.renderer.enableScissorTest(false)}}if((bo!==null)&&aQ&&(au!==null)){bo.resetCameraOrientation();bo.reframe(undefined,undefined,undefined,a9)}if(this.ODTMode){if(M.ImageUtils.nbTexturesBeingLoaded>0){ah.render()}else{if(ah.renderFrameCB){ah.renderFrameCB()}}}else{if(ah.renderFrameCB){ah.renderFrameCB()}}if(M.webGLStats){M.webGLStats.dump()}};this.renderCamera=function(aC,ap,aD,aI,az,aH,aG,aF,aq,ao,aA,aB){var aw=this.currentViewpoint;aw._renderedCamera=aC;if(this.internalSceneGraph&&aw){this.internalSceneGraph.selectionHL.updateHighlight(aw);this.internalSceneGraph.selectionPreHL.updateHighlight(aw);this.renderer.updateEffects(this.internalSceneGraph,this.currentViewpoint,aq,aI)}if(ap){this.sceneBackground.remove(this.cameraBackground);this.cameraBackground=ap;this.sceneBackground.add(this.cameraBackground)}else{if((!this.cameraBackground.isOrtho&&!aC.isOrtho)||(this.cameraBackground.isOrtho&&aC.isOrtho)){aC.clone(this.cameraBackground)}else{this.sceneBackground.remove(this.cameraBackground);this.cameraBackground=aC.clone();this.sceneBackground.add(this.cameraBackground)}var av=H*this.cameraBackgroundFar;if(this._nearFarBigScale){av=Math.min(0.001,av)}this.cameraBackground.near=av;this.cameraBackground.far=this.cameraBackgroundFar;if(this.cameraBackground.isOrtho){this.cameraBackground.near=this.cameraBackgroundNear}this.cameraBackground.updateProjectionMatrix();this.cameraBackground.projectionMatrixInverse.getInverse(this.cameraBackground.projectionMatrix)}if((!this.cameraReflected.isOrtho&&!aC.isOrtho)||(this.cameraReflected.isOrtho&&aC.isOrtho)){aC.clone(this.cameraReflected)}else{this.cameraReflected=aC.clone()}this.cameraReflected.matrixAutoUpdate=false;var ax=new M.Matrix4(1,0,0,0,0,1,0,0,0,0,-1,2*this.offsetPlaneBackground.z,0,0,0,1);var aE=new M.Matrix4().copy(aC.matrixWorld);ax.multiply(aE);this.cameraReflected.setMatrix(ax);if(this.SCREEN_WIDTH&&this.SCREEN_HEIGHT){var ay=(aB>0)&&this.useMirror;var at=(this._infinitePlane||this._displayGrid||this.ambience.getBackground().isActivated()||ay);var au=(this.useDefaultLights&&this.useShadowMap)||this.isShadowMap();var aw=this.currentViewpoint;aw._updateRobotCamera(this.internalSceneGraph);this.planeGrid&&this.planeGrid.updateLabels(aw);var aJ={main:aC,cameraBackground:this.cameraBackground,connectedRobotCamera:aw.connectedRobotCamera,robotCameraOrtho:aw.robotCameraOrtho,mirrorCamera:this.cameraReflected};this.renderer.render(at,ay,au,this.sceneBackground,aJ,this.internalSceneGraph,this.infPlaneSmall,this.ambience.getGroundGlossiness(),aD,aI,this.hasSceneGraphOverrideSet(),az,aH,aG,aF,aq,ao,aA);if(window.__debugLoop__){var ar=performance.now();var an=0;while(an<600){an=performance.now()-ar}}}};this.renderToTarget=function(aI,a2,ap){var aR=false;if(!ah.SCREEN_WIDTH||!ah.SCREEN_HEIGHT){return}var aS=window.devicePixelRatio||1;var az=Math.floor(aS*ah.SCREEN_WIDTH);var a1=Math.floor(aS*ah.SCREEN_HEIGHT);if(!aI){aI={data:null,width:az,height:a1,bufferWidth:0,bufferHeight:0,x:0,y:0}}if((aI.width>az)||(aI.height>a1)){aR=true}if((aI.data===null)||(aI.bufferWidth<aI.width)||(aI.bufferHeight<aI.height)){aI.data=new Uint8Array(4*aI.width*aI.height);aI.bufferWidth=aI.width;aI.bufferHeight=aI.height}if(!aI.x){aI.x=0}if(!aI.y){aI.y=0}if(ah.autoUpdateFrustum){ah._updateNearFar()}var aE=a2.camera;aE.updateProjectionMatrix();aE.projectionMatrixInverse.getInverse(aE.projectionMatrix);var ax=ah.getWebGLContext();var aV=ah.getRenderer();aV.removeSplitScreenMode();if(aR){var a0=az;var ba=a1;var aU=Math.ceil(aI.width/a0);var aT=Math.ceil(aI.height/ba);var aH=aI.width;var ay=aI.height;var a7=aH-aU*a0;var ao=ay-aT*ba;var aL=0;var aM=0;var au=aH;var aJ=ay;var aB=a0;var aK=ba;if(a2.camera.fullWidth){var a3={fullWidth:a2.camera.fullWidth,fullHeight:a2.camera.fullHeight,x:a2.camera.x,y:a2.camera.y,width:a2.camera.width,height:a2.camera.height};var aD=a3.width/aH;var aG=a3.height/ay;au=a3.fullWidth;aJ=a3.fullHeight;aL=a3.x;aM=a3.y;aB*=aD;aK*=aG}var a4=a2.camera;var av=new Uint8Array(4*a0*ba);for(var a8=0;a8<aT;a8++){for(var a9=0;a9<aU;a9++){var bd=Math.min(a0,aI.width-a9*a0);var ar=Math.min(ba,aI.height-a8*ba);var aF=a4.clone();aF.setViewOffset(au,aJ,a9*aB+aL,a8*aK+aM,aB,aK);a2.camera=aF;ah.glRender([{viewpoint:a2,toScreen:false}]);ax.readPixels(0,0,a0,ba,ax.RGBA,ax.UNSIGNED_BYTE,av);var aq=aT-a8-1;var aZ=0;if(aq>0){aZ=aq*ba+ao}for(var a6=0;a6<ar;a6++){for(var a5=0;a5<bd;a5++){var aA=aH*(aZ+a6)+a9*a0+a5;var aO=(ba-ar+a6)*a0+a5;var aC=a6*aH+a5;aI.data[4*aA]=av[4*aO];aI.data[4*aA+1]=av[4*aO+1];aI.data[4*aA+2]=av[4*aO+2];aI.data[4*aA+3]=av[4*aO+3]}}}}a2.camera=a4}else{if(ap){var aW={xMin:Math.max(0,-aI.x),xMax:Math.max(0,aI.x+aI.width-az),yMin:Math.max(0,-aI.y),yMax:Math.max(0,aI.y+aI.height-a1)};var aw=(aW.xMin>0)||(aW.xMax>0)||(aW.yMin>0)||(aW.yMax>0);var aY=aI.x;var aX=aI.y;if(aw){var a4=a2.camera;var bc=a4.clone();bc.setViewOffsetInternal(az,a1,(aW.xMin>0)?-aW.xMin:((aW.xMax>0)?aW.xMax:0),(aW.yMin>0)?aW.yMin:((aW.yMax>0)?-aW.yMax:0),az,a1);a2.camera=bc;aY=(aW.xMin>0)?0:((aW.xMax>0)?az-aI.width:aI.x);aX=(aW.yMin>0)?0:((aW.yMax>0)?a1-aI.height:aI.y)}aV.setScissor(aY,aX,aI.width,aI.height);aV.enableScissorTest(true);ah.glRender([{viewpoint:a2,toScreen:false}]);aV.enableScissorTest(false);if(aw){a2.camera=a4}ax.readPixels(aY,aX,aI.width,aI.height,ax.RGBA,ax.UNSIGNED_BYTE,aI.data)}else{var a4=a2.camera;var bc=a4.clone();var aY=0.5*(az-aI.width);var aX=0.5*(a1-aI.height);if(a4.fullWidth){aY=0;aX=a1-aI.height;var aN=aI.width/aI.height;var an=aN*a4.height;bc.x-=0.5*(an-bc.width);bc.width=an;var aQ=az/aI.width;var aP=a1/aI.height;bc.width*=aQ;bc.height*=aP}else{var at=Math.tan(M.Math.degToRad(a4.fov*0.5))*a4.near;bc.fov=M.Math.radToDeg(2*Math.atan((a1/aI.height)*at/a4.near))}bc.updateProjectionMatrix();bc.projectionMatrixInverse.getInverse(bc.projectionMatrix);a2.camera=bc;aV.setScissor(aY,aX,aI.width,aI.height);aV.enableScissorTest(true);ah.glRender([{viewpoint:a2,toScreen:false}]);aV.enableScissorTest(false);a2.camera=a4;ax.readPixels(aY,aX,aI.width,aI.height,ax.RGBA,ax.UNSIGNED_BYTE,aI.data)}}if(ah.mobile){ah.glRender([{viewpoint:a2,onlyPostProcess:false}])}else{ah.render({onlyPostProcess:false})}};this._renderToCanvas=function(ap,aq){var ax,av;if(this.svgRootNode){var an;var at=this.svgRootNode;an=at.cloneNode(true);an.setAttributeNS(null,"width",this.canvas.width);an.setAttributeNS(null,"height",this.canvas.height);an.style.left=0;an.style.top=0;an.style.width=this.canvas.width+"px";an.style.height=this.canvas.height+"px";var ar=(an.outerHTML)?an.outerHTML:(new XMLSerializer()).serializeToString(an);var aF=new Blob([ar],{type:"image/svg+xml;charset=utf-8"});var aD=window.URL.createObjectURL(aF);var aH=new Image();var ay=this;aH.onload=function(){ax=ay.canvas.width;av=ay.canvas.height;aH.width=ax;aH.height=av;var aL={width:ax,height:av,data:null};ay.renderToTarget(aL,ay.currentViewpoint);var aQ=document.createElement("canvas");aQ.width=ax;aQ.height=av;var aJ=aQ.getContext("2d");var aP=aJ.createImageData(ax,av);var aO=aP.data;for(var aK=0;aK<aP.height;aK++){for(var aM=0;aM<aP.width;aM++){var aI=aM+aK*ax;var aN=aM+(av-aK-1)*ax;aO[4*aI]=aL.data[4*aN];aO[4*aI+1]=aL.data[4*aN+1];aO[4*aI+2]=aL.data[4*aN+2];aO[4*aI+3]=aL.data[4*aN+3]}}aJ.putImageData(aP,0,0);setTimeout(function(){var aS=document.createElement("canvas");aS.width=ax;aS.height=av;var aR=aS.getContext("2d");aR.drawImage(aH,0,0);aR.drawImage(aQ,0,0);window.URL.revokeObjectURL(aD);ap(aS)},100)};aH.onerror=function(){window.URL.revokeObjectURL(aD);aq()};aH.src=aD}else{ax=this.canvas.width;av=this.canvas.height;var az={width:ax,height:av,data:null};this.renderToTarget(az,this.currentViewpoint);var aE=document.createElement("canvas");aE.width=ax;aE.height=av;var aC=aE.getContext("2d");var aw=aC.createImageData(ax,av);var aG=aw.data;for(var aA=0;aA<aw.height;aA++){for(var aB=0;aB<aw.width;aB++){var ao=aB+aA*ax;var au=aB+(av-aA-1)*ax;aG[4*ao]=az.data[4*au];aG[4*ao+1]=az.data[4*au+1];aG[4*ao+2]=az.data[4*au+2];aG[4*ao+3]=az.data[4*au+3]}}aC.putImageData(aw,0,0);ap(aE)}};this.renderCubemap=function(aw,at,ar,ax,aq){var aB;var ao=function(aD,aC){aB=UWA.createElement("canvas");aB.setStyles({position:"absolute",top:"0px",left:"0px",width:aD+"px",height:aC+"px"});webGLV6Viewer.div.appendChild(aB);aB.width=aD;aB.height=aC};var az=function(aH,aE,aR,aD,aP){console.log("display map, width="+aE+" height="+aR);function aJ(aV,aU,aT,aW,aX){if(aX){aU=aW-aU}return aT*Math.floor(aU)+Math.floor(aV)}var aS=aB.getContext("2d");var aO=aS.getImageData(0,0,aD,aP);var aM=aO.data;var aN=(aE-1)/(aD-1);var aF=(aR-1)/(aP-1);for(var aG=0;aG<aP;aG++){for(var aI=0;aI<aD;aI++){var aC=aJ(aI,aG,aD,aP,false);var aQ=aN*aI;var aK=aF*aG;var aL=aJ(aQ,aK,aE,aR,true);aM[4*aC]=255*aH[4*aL];aM[4*aC+1]=255*aH[4*aL+1];aM[4*aC+2]=255*aH[4*aL+2];aM[4*aC+3]=255}}aS.putImageData(aO,0,0,0,0,aD,aP)};var au=new j(this,90,undefined,undefined,false);var ay=au.camera;ay.aspect=1;ay.position=aw;ay.useQuaternion=true;var ap=new M.Vector3();for(var av=0;av<6;av++){switch(av){case 0:ay.up.set(0,-1,0);ay.lookAt(ap.addVectors(aw,new M.Vector3(1,0,0)));break;case 1:ay.up.set(0,-1,0);ay.lookAt(ap.addVectors(aw,new M.Vector3(-1,0,0)));break;case 2:ay.up.set(0,0,1);ay.lookAt(ap.addVectors(aw,new M.Vector3(0,1,0)));break;case 3:ay.up.set(0,0,-1);ay.lookAt(ap.addVectors(aw,new M.Vector3(0,-1,0)));break;case 4:ay.up.set(0,-1,0);ay.lookAt(ap.addVectors(aw,new M.Vector3(0,0,1)));break;case 5:ay.up.set(0,-1,0);ay.lookAt(ap.addVectors(aw,new M.Vector3(0,0,-1)));break;default:break}ay.updateMatrix();if(ah.autoUpdateFrustum){ah._updateNearFar()}ay.updateProjectionMatrix();ay.projectionMatrixInverse.getInverse(ay.projectionMatrix);ah.glRender([{viewpoint:au,toScreen:false,onlyForward:true,cubemap:true,cubemapResolution:at,cubeFace:av}])}var an=this.renderer.compForwardComposerContext.renderResults.main;var aA=["DS/EffectsDebug/ConvertCubemapToLatlong","DS/Visualization/AmbianceGenerator"];require(aA,function(aD,aF){if(!ah.renderer.compConvertCubeMapToLatLong){ah.renderer.compConvertCubeMapToLatLong=new aD(ah.renderer.renderer,ah.renderer.renderTargetPool)}if(ar){ah.renderer.compConvertCubeMapToLatLong.setEnvMap(an);var aE=ah.getRenderer().ambianceGenerators;if(!aE.manager){aE.manager=new aF(aE.cb)}var aH=ah.renderer.compConvertCubeMapToLatLong.composers[1];var aC="shoot360";var aG=aE.manager._getGenerator(aC,false);var aI=function(){var aL=ah.renderer.compConvertCubeMapToLatLong.saveComposer.composerContext.getResult(undefined,true);aL.hdr=true;aL.mapping=new M.LatLongReflectionMapping();var aK=aG._getResult();if(ax){var aJ={map0:aL,map1:aK,position:ax.position,geomProxy:new M.Box3(ax.minAABB,ax.maxAABB)};ah.internalSceneGraph.scene.reflectionProbes.push(aJ);ah.internalSceneGraph.scene.recompileShaders()}else{ah.internalSceneGraph.scene.envMipMap[0]=aL;ah.internalSceneGraph.scene.envMipMap[1]=aK}if(ah.internalSceneGraph.scene.envMipMapID){ah.renderer.renderer.ambianceGenerators.decreaseUseCount(ah.internalSceneGraph.scene.envMipMapID);ah.internalSceneGraph.scene.envMipMapID=null}aq&&aq()};aG.setCallBack(aI);aG.setValues(aH);ah.renderer.compConvertCubeMapToLatLong.execute();ah.renderer.compConvertCubeMapToLatLong.encodeRGBE();aG.execute();aE.manager._disposeGenerator(aC,false)}else{ah.renderer.compConvertCubeMapToLatLong.setEnvMap(an);ah.renderer.compConvertCubeMapToLatLong.execute();ah.renderer.compConvertCubeMapToLatLong.renderToScreen();ah.renderer.compConvertCubeMapToLatLong.saveAsHDR("reflection");aq&&aq()}})};this.grabDepthBuffer=function(an){if(!ah.SCREEN_WIDTH||!ah.SCREEN_HEIGHT){return}var ar=window.devicePixelRatio||1;var ao=Math.floor(ar*ah.SCREEN_WIDTH);var ap=Math.floor(ar*ah.SCREEN_HEIGHT);if(!an){an={data:null,_dataUint8:null,width:ao,height:ap,bufferWidth:0,bufferHeight:0}}if((an.width>ao)||(an.height>ap)){an.width=ao;an.height=ap}if(!an._dataUint8||(an.bufferWidth<an.width)||(an.bufferHeight<an.height)){an._dataUint8=new Uint8Array(4*an.width*an.height);an.data=null;an.bufferWidth=an.width;an.bufferHeight=an.height}var aq=ah.getWebGLContext();this.renderer.computeDepthBuffer(this.internalSceneGraph,this.currentViewpoint,true);aq.readPixels(0,0,an.width,an.height,aq.RGBA,aq.UNSIGNED_BYTE,an._dataUint8);an.data=new Float32Array(an._dataUint8.buffer);return an};if(!this.useOffscreenCanvas){this.SCREEN_WIDTH=this.canvas.offsetWidth;this.SCREEN_HEIGHT=this.canvas.offsetHeight}else{this.SCREEN_WIDTH=this.canvas.width;this.SCREEN_HEIGHT=this.canvas.height}this.initResources(this.canvas);this.onWebGLContextLost=function ag(an){console.log("WebGL context Lost !");an.preventDefault()};this.canvas.addEventListener("webglcontextlost",this.onWebGLContextLost,false);this.onWebGLContextRestore=function ai(){window.__debugLoop__=false;ah.renderer.renderer.restoreGLContext();ah.render()};this.canvas.addEventListener("webglcontextrestored",this.onWebGLContextRestore,false);this.renderer=new c({canvas:this.canvas,context:this.materialManager.getContext(),divCSS:this.divCss3DElement,useOffscreenCanvas:this.useOffscreenCanvas,deferred:this.deferred,useCompositing:!this.mobile&&this.useHDR,tonemapping:1,bgColor:this.ambience.getBackgroundColor().getHex(),bgAlpha:this.ambience.getBackgroundAlpha(),viewer:this,visibleSpace:this.visibleSpace,antiAliasing:((!this.useHDR||this.mobile)&&this.antiAliasing&&(this.antiAliasing!=="NoAA"))?true:"NoAA",preserveDrawingBuffer:am.preserveDrawingBuffer,debugContext:am.debugContext});this.renderer.renderer.precomputedTexture1=this.materialManager.precomputedTexture1;this.renderer.renderer.precomputedTexture2=this.materialManager.precomputedTexture2;this.renderer.renderer.precomputedTexture3=this.materialManager.precomputedTexture3;this.renderer.renderer.precomputedAreaGGX1texture=this.materialManager.precomputedAreaGGX1texture;this.renderer.renderer.precomputedAreaGGX2texture=this.materialManager.precomputedAreaGGX2texture;this.renderer.renderer.precomputedAreaSheentexture=this.materialManager.precomputedAreaSheentexture;this.renderer.renderer.ambianceGenerators=M._AmbianceGenerators;this.renderer.renderer.ambianceGenerators.viewers.push(this);this.renderer.renderer.visibleSpace=this.visibleSpace;this.renderer.renderer.newMaterialInheritance=window.newMaterialInheritance;switch(this.antiAliasing){case"NoAA":break;case"FXAA":this.renderer.setEffect("FXAA",true);break;case"MLAA":this.renderer.setEffect("MLAA",true);break;case"SMAA":this.renderer.setEffect("SMAA",true);break;case"MSAA":this.renderer.setEffect("MSAA",true);break;case"FSAA":case"SSAA":this.renderer.setEffect("FSAA",true);break;default:break}this.renderer.setEffect("Vignetting",this.useVignetting);this.renderer.setEffect("SSAO",this.useSSAO&&!this.useSSAOIterative);this.renderer.setEffect("SSAOIterative",this.useSSAO&&this.useSSAOIterative);this.renderer.setEffect("SSLR",this.useSSLR);this.renderer.setEffect("DOF",this.useDOF);this.renderer.setEffect("Bloom",this.useBloom);this.renderer.setEffect("Flare",this.useFlare);this.renderer.setEffect("OIT",this.useOIT);this.useOIT=this.renderer.useOIT;this.setPicking({});this.setPrePicking({});if(this.useDefaultLights){al()}this.setIntensityCorrection(true);aj();ab.apply(this);if(this.defaultAnimationLoop){ac(0,false)}function aj(){ah.dirLightGroundShadow=new M.DirectionalLight(16777215,0);var an=ah.dirLightGroundShadow;an.position.set(0,0,40);an.castGroundShadow=ah.useGroundShadow;an.onlyShadow=true;an.shadowCascade=false;an.shadowMapWidth=ah.shadowMapWidth;an.shadowMapHeight=ah.shadowMapHeight;an.shadowCameraNear=40;an.shadowCameraFar=150;an.shadowBias=-0.001;an.shadowDarkness=0.65}function al(){ah.setAmbientLight(2236962);ah.directionalLight=new M.DirectionalLight(16777215,0.9);var an=ah.directionalLight;an.position.set(40,40,40);an.castShadow=ah.useShadowMap;an.shadowCameraNear=40;an.shadowCameraFar=150;an.shadowBias=-0.001;an.shadowDarkness=0.65;an.shadowMapWidth=ah.shadowMapWidth;an.shadowMapHeight=ah.shadowMapHeight;ah.renderer.renderer.shadowMapAutoUpdate=true;an.shadowCascade=false;if(ah.triLights){an.intensity=0.7;an.shadowDarkness=0.3;ah.directionalLight2=new M.DirectionalLight(16777215,0.7);ah.directionalLight3=new M.DirectionalLight(16777215,0.7);ah.directionalLight3.position.set(40,-40,40)}else{ah.directionalLight2=new M.DirectionalLight(3827071,1)}ah.directionalLight2.position.set(40,-40,40)}function ab(){this.div.appendChild(this.renderer.renderer.domElement);if(B._isInit===undefined){B.init()}this.manipulatorManager=new z(this)}function ac(au,av){if(!ah){return}if(ah.fpsCounter){ah.fpsCounter.onAnimate()}if(B.RecordEventsManager){B.RecordEventsManager.pushRecordAnimateEvent(ah)}if(!av&&ah.defaultAnimationLoop){requestAnimationFrame(ac)}if(!ah.isRenderIteration){ah.renderIteration=0}if(ah.capturer){ah.capturer.capture(ah.canvas,ah.renderIteration)}var aF,aw,an,ax,aH,aG,ar=new e(),aI=new Date(),ap=aI.getTime()-ah._oldTime;ah._oldTime=aI.getTime();ar.step(ap);aH=false;var ay,aD,aC;aC=window.devicePixelRatio||1;if(!ah.useOffscreenCanvas){ay=ah.div.offsetWidth||1;aD=ah.div.offsetHeight||1}else{ay=ah.canvas.width||1;aD=ah.canvas.height||1}var aL=false;if(ah.lazyResize){if((ah.oldCanvasSize.width!==ay)||(ah.oldCanvasSize.height!==aD)||(ah.oldCanvasSize.dpr!==aC)){ah.oldCanvasSize.width=ay;ah.oldCanvasSize.height=aD;ah.oldCanvasSize.dpr=aC;ah.oldCanvasSize.time=new Date().getTime();aH=true}else{if((ah.oldCanvasSize.time>=0)&&(new Date().getTime()-ah.oldCanvasSize.time>300)){ah.oldCanvasSize.time=-1;aL=true}}}else{if((ah.SCREEN_WIDTH!==ay)||(ah.SCREEN_HEIGHT!==aD)||(ah.devicePixelRatio!==aC)){aL=true;aH=true}}if(aH&&ah.currentViewpoint){ah.currentViewpoint.camera._hasChanged=true}if(ah.cameraSystemUpdated){ah.cameraSystemUpdated=false;aL=2}if(aL){Z(undefined,aL===2)}if(ah.currentViewpoint===null){return}aw=ah.currentViewpoint.getControl();if(aw!==null){aw.update()}aF=ah.currentViewpoint.camera;if(aF){aF.updateMatrix();aF.matrixWorld.copy(aF.matrix);aF.matrixWorldInverse.getInverse(aF.matrixWorld)}if(ah.autoUpdateFrustum){var aA=ah._updateNearFar();if(aA){ah.renderIteration=0}}aF.updateProjectionMatrix();aF.projectionMatrixInverse.getInverse(aF.projectionMatrix);an=aF.getLookAt();an.add(aF.position);if(aH){h.publish({event:"/VISU/onWindowResized",data:{eventChannel:"/VISU/onWindowResized",eventType:"@onWindowResized",viewpoint:ah.currentViewpoint,cameraEye:aF.position,cameraTarget:an,cameraUp:aF.up}});ah._modelEvent.publish({event:"Resize",data:{width:ay,height:aD}})}if(M.ImageUtils.nbTexturesBeingLoaded<ah.lastNbTexturesBeingLoaded){ah.render()}ah.lastNbTexturesBeingLoaded=M.ImageUtils.nbTexturesBeingLoaded;var az=ah._requestRender;if(az&&!ah._onlyPostProcess){ah.renderIteration=0}ah._onlyPostProcess=true;var aB=false;ah._setAntiAliasing((ah.renderIteration>0)?"static":"dynamic");if(ah.renderIteration<ah.renderer.getMaxIterationEffects()){aB=true}var aE=(aI.getTime()-ah.timeIter0>ah.delayBeforeIteration);var aK=aE&&(ah.renderIteration===1);var at=aE&&(ah.renderIteration>0);if(az||(at&&aB)||ah.forceRender||aK){ah.forceRender=false;ah._requestRender=false;aG=ah._renderParams;ah._renderParams=[];if(aG.length){aG[0].renderIteration=ah.renderIteration;aG[0].isStillFrame=at;aG[0].onlyPostProcess=aG[0].onlyPostProcess&&!aB}else{aG.push({renderIteration:ah.renderIteration,isStillFrame:at})}if(ah.debugFPS){var aJ=performance.now()-ah.debugFPSInfos.fpsLastTime;ah.debugFPSInfos.fpsLastTime=performance.now();var aq=1000/Math.max(aJ,0.1);ah.debugFPSInfos.fpsCumul+=aq;ah.debugFPSInfos.fpsCumul-=ah.debugFPSInfos.fpsArray[ah.debugFPSInfos.fpsIndex];ah.debugFPSInfos.fpsValue=ah.debugFPSInfos.fpsCumul/ah.debugFPSInfos.fpsWindow;ah.debugFPSInfos.fpsArray[ah.debugFPSInfos.fpsIndex]=aq;ah.debugFPSInfos.fpsIndex=(ah.debugFPSInfos.fpsIndex+1)%ah.debugFPSInfos.fpsWindow;ah.debugFPSInfos.fpsCounter.setHTML(Math.ceil(ah.debugFPSInfos.fpsValue).toString())}ah.glRender(aG);if(!ah){return}if(ah.renderIteration===0){ah.timeIter0=aI.getTime()}ah.renderIteration++;if(ah.multiViewer){var ao=ah.materialManager.getCanvas();ah.context2D.globalCompositeOperation="copy";ah.context2D.drawImage(ao,0,ao.height-ah.canvas.height,ah.canvas.width,ah.canvas.height,0,0,ah.canvas.width,ah.canvas.height)}ah._modelEvent.publish({event:"PostRender",data:{viewer:ah,viewpoint:ah.currentViewpoint}})}}function Z(ar,au){ah.devicePixelRatio=window.devicePixelRatio||1;if(!ah.useOffscreenCanvas){ah.SCREEN_WIDTH=ah.div.offsetWidth||1;ah.SCREEN_HEIGHT=ah.div.offsetHeight||1}else{ah.SCREEN_WIDTH=ah.canvas.width||1;ah.SCREEN_HEIGHT=ah.canvas.height||1}if(ah.svgRoot){ah._updateSVGVisu()}if(ah.multiViewer){var aq=Math.floor(ah.devicePixelRatio*ah.SCREEN_WIDTH);var at=Math.floor(ah.devicePixelRatio*ah.SCREEN_HEIGHT);ah.materialManager.setCanvasSize(aq,at)}var ao,ap;if(!ah.cameraSystem){ao=ah.SCREEN_WIDTH;ap=ah.SCREEN_HEIGHT}else{var an=ah.cameraSystem.getViewportSize(ah.SCREEN_WIDTH,ah.SCREEN_HEIGHT);ao=an.width;ap=an.height}ah.renderer.setRendererSize(ah.SCREEN_WIDTH,ah.SCREEN_HEIGHT,ah.useOffscreenCanvas||au,ao,ap,ah.devicePixelRatio);if(ah.currentViewpoint!==null){ah.currentViewpoint.camera.aspect=ao/(ap);ah.currentViewpoint.camera.updateProjectionMatrix();ah.currentViewpoint.connectedRobotCamera.aspect=ao/(ap);ah.currentViewpoint.connectedRobotCamera.updateProjectionMatrix();ah.currentViewpoint.robotCameraOrtho.aspect=ao/(ap);ah.currentViewpoint.robotCameraOrtho.setVisualizedHeight(null,ah.currentViewpoint.robotCameraOrtho.aspect);ah.currentViewpoint.robotCameraOrtho.updateProjectionMatrix();ah.currentViewpoint.resize(ao,ap)}ah.ambience.resize(ao,ap,ah.devicePixelRatio);ah.renderIteration=0;ah.render()}this.animate=ac;function ak(){if(ah.internalSceneGraph===null){return}var an,aE,ap,aD,ao,at,ay,aw,ax,aH,aq,au,av,az,aF=ah.internalSceneGraph.scene,ar=aF.getMeshInstances(),aG,aC,aB,aA;for(aC=0;aC<ar.length;aC++){an=ar[aC];aE=0.05*an.boundingSphere.radius;ap=null;aD=0;if(an.geometry.length>=0){ap=an.geometry[0];aD=an.geometry.length}else{if(an.geometry._type===2){ap=an.geometry;aD=1}}ao=[];for(aA=0;aA<aD;aA++){at=ap.vertexPositionArray;ay=ap.vertexNormalArray;if(ay!==null){for(aB=0;aB<at.length;aB+=3){ao.push({x:at[aB],y:at[aB+1],z:at[aB+2]});ao.push({x:at[aB]+aE*ay[aB],y:at[aB+1]+aE*ay[aB+1],z:at[aB+2]+aE*ay[aB+2]})}}ap=an.geometry[aA+1]}if(ao.length){aw=new q.PrimitiveGroup();aw.fillAttr=new q.FillAttributes();aw.lineAttr=new q.LineAttributes();aw.pointAttr=new q.PointAttributes();ax=new q.Buffer();ax.size=3*ao.length;ax.component=q.VertexComponentEnum.POSITION;ax.format=q.DataTypeEnum.FLOAT;ax.dimension=3;ax.data=new Float32Array(ax.size);aw.addBuffer(0,ax);aG=ax.data;aA=0;for(aB=0;aB<ao.length;aB++){aG[aA++]=ao[aB].x;aG[aA++]=ao[aB].y;aG[aA++]=ao[aB].z}aH=Math.ceil(ao.length/65534);aq=0;for(aB=0;aB<aH;aB++){au=new q.Primitive();au.nbIndices=Math.min(ao.length-aq,65534);au.connectivity=q.ConnectivityTypeEnum.LINES;au.attr={fill:new q.FillAttributes(),line:new q.LineAttributes(new q.Color(0,0,1,1)),point:new q.PointAttributes()};av=new q.VertexComponent();av.component=q.VertexComponentEnum.POSITION;av.nbVertices=3*Math.min(ao.length-aq,65534);av.nbValuesPerVertex=3;av.format=q.DataTypeEnum.FLOAT;av.cardinality=0;av.bufferId=0;av.offset=aq;av.indices=null;au.addVertexComponent(av);aw.addPrimitive(au);aq+=65534}az=P.createMeshNode(aw);az.mesh3js.setMatrix(new M.Matrix4().copy(an.matrixWorld));az.setPickable(false);az.mesh3js.castShadow=false;az.mesh3js.receiveShadow=false;ah.debugNormalNode.add(az.mesh3js)}}}this.addEvent("onPostInject",function af(){ac(0,true)});console.log("DS WebGL Viewer R"+this.version);this.internalSceneGraph=new N(this,this.multiViewerFix,am.showReferenceAxisSystem?false:true);if(this.mobile){this.setScanIntensity(1)}if(this.currentViewpoint!==null){this.internalSceneGraph.scene.add(this.currentViewpoint.getCamera())}this.internalSceneGraph.scene.add(this.ambientLight);if(this.useDefaultLights){this.internalSceneGraph.scene.add(this.directionalLight);this.internalSceneGraph.scene.add(this.directionalLight2);if(this.triLights){this.internalSceneGraph.scene.add(this.directionalLight3)}}this.internalSceneGraph.scene.add(this.dirLightGroundShadow);this._glFPSCounter=null;this._glInfoCounter=null;this._glNodeCounter=null;this.fpsCounter=null;this.blurShadowEffect=null;this.displayHighlight=false;this.name="";this.debugLocalBBox=false;this.debugBBox=false;this.debugHandleMatrix=false;this.localBBox=null;this.BBox=null;return this},buildSkeleton:function(){if(this.div===null){this.elements.container=UWA.createElement("div");this.div=this.elements.container;this.div.setStyles({width:"100%",height:"100%"})}else{this.elements.container=UWA.extendElement(this.div)}this.div.style["-ms-touch-action"]="none";this.canvas=UWA.createElement("canvas");if(D.isActive()){this.canvas.setAttribute("data-rec-id","FakeRecManager");D.registerElement(this.canvas,"DS/WebVisuRecord/FakeRec",true)}var Z={width:"100%",height:"100%"};if(this._svgMode&&!d.getWebGLMode()){Z.zIndex=10;Z.position="absolute";Z.left="0px";var ab=document.createElementNS(this.getSvgNS(),"svg");ab.setAttribute("xmlns","http://www.w3.org/2000/svg");ab.style.position="absolute";ab.style.width="100%";ab.style.height="100%";ab.style.top="0px";ab.style.left="0px";ab.style.backgroundColor="white";ab.style.zIndex=0;this.svgRootNode=ab;this.svgRoot=document.createElementNS(this.getSvgNS(),"g");this.svgRootNode.appendChild(this.svgRoot);this.div.appendChild(this.svgRootNode)}this.canvas.setStyles(Z);if(this.useOffscreenCanvas){this.canvas.width=this.div.width;this.canvas.height=this.div.height}this.div.appendChild(this.canvas);if(D.isActive()){this.canvas.webGLViewer=this;this.canvas.isWebGLCanvas=function(){return true}}},getSvgNS:function(){return"http://www.w3.org/2000/svg"},addBackgroundSVGNode:function(ab){if(!ab||!ab._cssSVGNode){return}this.renderer.resetGSSOCache();var Z=this.internalSceneGraph.svgRoot;Z.addChild(ab);this._updateSVGVisu()},removeBackgroundSVGNode:function(ab){if(!ab||!ab._cssSVGNode){return}this.renderer.resetGSSOCache();var Z=this.internalSceneGraph.svgRoot;Z.removeChild(ab);this._updateSVGVisu()},getAllBackgroundSVGNodes:function(){var Z=this.internalSceneGraph.svgRoot;return Z.children.concat([])},clearBackgroundSVGNodes:function(){this.renderer.resetGSSOCache();var ab=this.getAllBackgroundSVGNodes();var Z;for(Z=0;Z<ab.length;Z++){this.removeBackgroundSVGNode(ab[Z])}},buildSkeletonCss:function(){if(this.divCssElement===null){this.divCssElement=UWA.createElement("div");this.divCssElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"});this.div.appendChild(this.divCssElement)}else{this.divCssElement=UWA.extendElement(this.divCssElement)}this.divCssElement.style.WebkitTransformStyle="preserve-3d";this.divCssElement.style.MozTransformStyle="preserve-3d";this.divCssElement.style.oTransformStyle="preserve-3d";this.divCssElement.style.transformStyle="preserve-3d";this.divCssElement.id="divCssElement";this.divCss3DElement=UWA.createElement("div");this.divCss3DElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"});this.divCss3DElement.style.WebkitTransformStyle="preserve-3d";this.divCss3DElement.style.MozTransformStyle="preserve-3d";this.divCss3DElement.style.oTransformStyle="preserve-3d";this.divCss3DElement.style.transformStyle="preserve-3d";this.divCss3DElement.id="divCss3DElement";this.divCssElement.appendChild(this.divCss3DElement);this.divCss2DElement=UWA.createElement("div");this.divCss2DElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"});this.divCss2DElement.id="divCss2DElement";this.divCssElement.appendChild(this.divCss2DElement);this.divTrap=UWA.createElement("div",{id:"trapSelection"});this.div.appendChild(this.divTrap)},initResources:function(Z){var ab=(!this.useHDR||this.mobile)&&this.antiAliasing&&(this.antiAliasing!=="NoAA");this.materialManager=new L(c.testMode.testMode,this.multiViewer,ab,this);if(this.multiViewer){this.materialManager.setCanvasSize(Z.offsetWidth,Z.offsetHeight);this.context2D=Z.getContext("2d")}},onBackgroundModify:function(Z){return this._modelEvent.subscribe({event:"VisuBackgroundColor",data:this.ambience.getBackgroundColor().getHex()},Z)},onSwapVisibleSpace:function(Z){return this._modelEvent.subscribe({event:"SwapVisibleSpace",},Z)},onViewerResize:function(Z){return this._modelEvent.subscribe({event:"Resize"},Z)},onPreRender:function(Z){return this._modelEvent.subscribe({event:"PreRender"},Z)},onPostRender:function(Z){return this._modelEvent.subscribe({event:"PostRender"},Z)},onActivate:function(Z){return this._modelEvent.subscribe({event:"Activate"},Z)},onPreactivate:function(Z){return this._modelEvent.subscribe({event:"Preactivate"},Z)},onContext:function(Z){return this._modelEvent.subscribe({event:"Context"},Z)},unsubscribe:function(Z){this._modelEvent.unsubscribe(Z)},setMaterialMode:function(Z){this.renderer.resetGSSOCache();this.renderer.renderer.materialMode=Z;if(this._renderStyle){this._renderStyle._faceMode=Z?g.FaceModes.MATERIAL:g.FaceModes.GAS}this.internalSceneGraph.root.forceUpdate()},setGasLookMode:function(Z){this.renderer.resetGSSOCache();this.renderer.renderer.gasLookMode=Z},setDefaultPicking:function(ab){this._defaultPicking=ab?true:false;var ac=null;if(ab){var Z=WUX.Selection.PSOManager;this.centerMouseDownCB=function(ae,ad){};this.mouseMoveCB=function(ak,ai){var al=ak.view;if(B.RecordEventsManager&&!al){return}var an=ak.path&&this.canvas.impl?this.canvas.impl:this.canvas;if((al!==an)&&!al.renderable){while((al!==an)&&al.parentElement&&!al.renderable){al=al.parentElement}if(!al.renderable){if(this.lastAddedToPSO&&!this.lastAddedToPSO.ownedByUser){Z.remove(this.lastAddedToPSO);this.lastAddedToPSO=null}return}}if(!ai||ai.isMiddleButtonPressed()){return}var am,ae,ap,ao;am=this.getMousePosition(ak.getCurrentPosition(this.canvas));if(this.pPicking.activated&&(!this.manipulatorManager||!this.manipulatorManager.isInManipulation(true,true))&&(!this.pPicking.disableWhileMoving||(this.pPicking.disableWhileMoving&&this.currentViewpoint&&!this.currentViewpoint.isMoving()))){ao="mesh";if(this.pPicking.gpu){if(this.picking.primitive===2){ao="repHybrid"}else{if(this.pPicking.primitive){ao="primHybrid"}else{ao="mesh"}}}else{if(this.picking.primitive===2){ao="rep"}else{if(this.pPicking.primitive){ao="prim"}else{ao="mesh"}}}ae=this.pick(am,ao,this.pPicking.computeNormalDepth);ap=false;if(!Z.isEmpty()||ae.path.length){ap=true}if(this._fillXSOMode){if(!ae.path.length){if(!Z.isEmpty()){this.lastAddedToPSO=null;Z.empty()}}else{if(this.pPicking.displayHL){var au=null;if(ae.path[0]){au=ae.path[0].getLastElement(true)}if(au instanceof T){if(!(au._getExcludeFromPreHL())&&!(au._getExcludeFromPSO())){var ad=ae.path[0];while(ad&&ad.getLastElement(true).getPickParent()){ad=ad.getParentPath()}if(!this.multiViewerFix&&!window.userRootOutOfPathElements){var at;at=ad;if(at&&at.externalPath.length>1){var aj=at.externalPath.concat([]);aj.shift();ad=new O();if(at.instanceId!==undefined){ad.instanceId=at.instanceId}ad.setFromArray(aj,at.internalPath)}}var ah={pathElement:ad,event:ak};if(!Z.isIn(ah)||Z.get().length>1){var ar=Z.get().slice();Z.remove(ar);Z.add(ah)}this.lastAddedToPSO=ah}}}}}this._modelEvent.publish({event:"Preactivate",data:{viewer:this,event:ak,pickingResult:ae,ctrl:ai.isCtrlKeyPressed(),shift:ai.isShiftKeyPressed()}})}if(ap){this.render({onlyPostProcess:true})}var aq="@pickNothing";var ag;if(ae&&ae.path.length){var af=ae.path[0].getLastElement();if(af instanceof THREEDS.SubElement){if(af.getType()==="primitive"){aq="@pickPrimitive"}else{if(af.getType()==="rep"){aq="@pickRep"}}}else{if(af!==null){aq="@pickMesh"}}}if(aq==="@pickNothing"){ag={eventChannel:"/VISU/",eventType:"@onMoveEvent",eventID:aq,event:ak}}else{ag={eventChannel:"/VISU/",eventType:"@onMoveEvent",eventID:aq,event:ak,from:ae.path[0],point:ae.position,normal:ae.normal,tangent:ae.tangent,uv:ae.uv,ray:ae.ray}}h.publish({event:"/VISU/",data:ag});if(this.debugEvents>=6){console.log(ag)}};this.centerMouseUpCB=function(ag,af){if(!af||!af.isMiddleClick()){return}var ad,ah;ad=this.getMousePosition(ag.getCurrentPosition(this.canvas));if(!af.lockPan&&!af.lockReframeOnDblTap&&this.currentViewpoint!==null){ah=this.pick(ad,"mesh",true);if(ah.position!==null){this.currentViewpoint.centerCamera(ah.position)}else{if(af._2DMode){this.currentViewpoint.centerCameraSVG(new M.Vector2(this.div.clientWidth*0.5,this.div.clientHeight*0.5),new M.Vector2(ad.xPix,ad.yPix))}}}var ae={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@middleClick",event:ag};h.publish({event:"/VISU/",data:ae});if(this.debugEvents>=6){console.log(ae)}};this.leftMouseDownCB=function(aj,ai){var ak=aj.view;if(B.RecordEventsManager&&!ak){return}var af=aj.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap;var am=aj.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(ak===af){ak=am}if((ak!==am)&&!ak.renderable){while((ak!==am)&&ak.parentElement&&!ak.renderable){ak=ak.parentElement}if(!ak.renderable){return}}if(!ai||ai.isMiddleButtonPressed()||!ai.isLeftClick()){return}if(this.picking.trapSelection&&this.trapSelection){var al=this.getMousePosition(aj.getCurrentPosition(this.canvas));var ad=this.pick(al,"mesh",false);if(ad&&ad.path&&ad.path.length){var ae=ad.path[0].externalPath;for(var ah=0;ah<ae.length;ah++){if(ae[ah].getIsManipulator()){this.trapSelection.interrupt();break}}}}var ag={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@leftClickDown",event:aj};h.publish({event:"/VISU/",data:ag});if(this.debugEvents>=6){console.log(ag)}};this.leftMouseUpCB=function(ae,ad){this._doPickingFromMouseEvent(ae,ad,null)},this._doPickingFromMouseEvent=function(aC,ar,ax){if(!this._defaultPicking){return}var an=ax||this.trapSelection;var au;var aF=aC.view;if(B.RecordEventsManager&&!aF){return}var aD=aC.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap;var ad=aC.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(aF===aD){aF=ad}var ae=false;if(this.picking.trapSelection&&an){au=an.getExtremities();ae=((au.pt!==undefined)&&((au.xPix!=au.pt.xPix)||(au.yPix!=au.pt.yPix)))}if(!ae&&(aF!==ad)&&!aF.renderable){while((aF!==ad)&&aF.parentElement&&!aF.renderable){aF=aF.parentElement}if(!aF.renderable){ac=null;return}}if(!ar||ar.isMiddleButtonPressed()){ac=null;return}if(this.picking.activated){var aq,al,av,ay,aG,ap,am,ah;ay=null;aG=null;ap=null;am=null;if(!ae){au=this.getMousePosition(aC.getCurrentPosition(this.canvas))}var af=an&&an.isActive;var aw=this.magnifier&&this.magnifier.active&&(aC.getType()==="Touch");var aA=aC.contextButton?ar.isRightClick():ar.isLeftClick();if(!af&&(!aw||(window.magnifierCheckDistance&&!this.magnifier.displayed))&&!aA){return}if(window.magnifierCheckDistance&&aw&&this.magnifier.displayed){this.magnifier.displayed=false;if(!this.magnifier.enableSelection){return}this.magnifier.enableSelection=false}if(!ax&&this.manipulatorManager&&this.manipulatorManager.isInManipulation()){return}if(aF!==ad){au.event=aC}ah="mesh";if(ae&&(this.picking.trapSelectionMesh||this.picking.trapSelection)){if(this.picking.trapSelection&&!this.picking.trapSelectionMesh&&this.picking.primitive){ah="primCPU"}else{ah="meshCPU"}}else{if(this.picking.gpu){if(this.picking.primitive===2){ah="repHybrid"}else{if(this.picking.primitive){ah="primHybrid"}else{ah="mesh"}}}else{if(this.picking.primitive===2){ah="rep"}else{if(this.picking.primitive){ah="prim"}else{if(an&&au.pt){ah="meshCPU"}else{ah="mesh"}}}}}aq=this.pick(au,ah,this.picking.computeNormalDepth,undefined,ax);var aj=ar.isShiftKeyPressed();var ak=(ar.isCtrlKeyPressed()||this.forceMultiSel);var ae=((au.pt!==undefined)&&((au.xPix!=au.pt.xPix)||(au.yPix!=au.pt.yPix)));var ao=0,aB;if(!this.multiViewerFix&&!window.userRootOutOfPathElements){for(ao=0;ao<aq.path.length;ao++){aB=aq.path[ao];if(aB&&aB.externalPath.length>1){var ai=aB.externalPath.concat([]);ai.shift();aq.path[ao]=new O();aq.path[ao].setFromArray(ai,aB.internalPath);if(aB.instanceId!==undefined){aq.path[ao].instanceId=aB.instanceId}}}}var at;if(this._fillXSOMode){at=this.addToCSOHSO(aq,{event:aC,multiSel:ak,additiveMode:aj,trapSel:ae})}if(this.internalSceneGraph!==null){if(this._fillXSOMode){var az="@pickNothing";if(aq.path.length){var ag=aq.path[0].getLastElement();if(ag instanceof THREEDS.SubElement){if(ag.getType()==="primitive"){az="@pickPrimitive"}else{if(ag.getType()==="rep"){az="@pickRep"}}}else{if(ag!==null){az="@pickMesh"}}}var aE={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:az,event:aC,from:aq.path[0],addedToCSO:at.addedToCSO,removedFromCSO:at.removedFromCSO,point:aq.position,normal:aq.normal,tangent:aq.tangent,uv:aq.uv,ray:aq.ray};h.publish({event:"/VISU/",data:aE});if(this.debugEvents>=6){console.log(aE)}}this._modelEvent.publish({event:"Activate",data:{viewer:this,event:aC,pickingResult:aq,ctrl:ar.isCtrlKeyPressed(),shift:ar.isShiftKeyPressed(),trapSelection:ae,contextButton:aC.contextButton?true:false}})}this.render({onlyPostProcess:true})}else{var al=WUX.Selection.HSOManager;if(!al.isEmpty()){al.empty();this.render({onlyPostProcess:true})}}ac=null};this.rightMouseUpCB=function(af,ae){if(af.view!==this.canvas){return}if(!ae||ae.isMiddleButtonPressed()||ae.isLeftButtonPressed()||!ae.isRightClick()){return}if(this.picking.contextPick){af.contextButton=true;this.leftMouseUpCB(af,ae)}var ad={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@rightClick",event:af};h.publish({event:"/VISU/",data:ad});this._modelEvent.publish({event:"Context",data:{viewer:this,event:af,ctrl:ae.isCtrlKeyPressed()}});if(this.debugEvents>=6){console.log(ad)}}}else{this.centerMouseDownCB=null;this.mouseMoveCB=null;this.leftMouseDownCB=null;this.leftMouseUpCB=function(ah,ag){var af=ah.view;if(B.RecordEventsManager&&!af){return}var ae=ah.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap;var ad=ah.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(af===ae){af=ad}if((af!==ad)&&!af.renderable){while((af!==ad)&&af.parentElement&&!af.renderable){af=af.parentElement}if(!af.renderable){return}}if(!ag||ag.isMiddleButtonPressed()){return}if((!this.trapSelection||(this.trapSelection&&!this.trapSelection.isActive))&&!ag.isLeftClick()){return}if(this.manipulatorManager&&this.manipulatorManager.isInManipulation()){return}this._modelEvent.publish({event:"Activate",data:{viewer:this,event:ah,ctrl:ag.isCtrlKeyPressed(),shift:ag.isShiftKeyPressed()}})};this.rightMouseUpCB=null}},getDefaultPicking:function(){return this._defaultPicking},setCurrentHighlightSet:function(ab){this.renderer.resetGSSOCache();if(!ab){this.highlightColor=null;return}var Z=ab.sceneHL.colorHighlight;this.highlightColor=Z},setAmbience:function(ab,Z){this.renderer.resetGSSOCache();this.ambience=ab;this.ambience.resize(this.SCREEN_WIDTH,this.SCREEN_HEIGHT,this.devicePixelRatio);if(Z){this.setGroundOptions({groundSize:100,groundShadow:false,displayPlane:false,displayGrid:false,displayGridFromBelow:false,gridNbSteps:5,gridLabels:null,gridLabelCallback:null,gridDisplayLabelCallback:null,planeMirror:false,blurryMirror:false,planeColor:"#EEEEEE",planeOpacity:1,planeTexture:null,planeTextureScale:1,gridColor:"#EEEEEE",gridFalloff:0,planeFalloff:0,planeBorder:false,planeBorderColor:"#FFFFFF",});this.setGroundOptions(ab.getGroundOptions())}this.ambience.updateAmbience()},removeAmbience:function(){this.removeEnvMap();var Z=new A({viewer:this});this.setAmbience(Z,true)},createHighlightSet:function(Z,ad){if(this.mobile){return null}var ab=this._getHighlightSet(Z,ad);if(ab){return ab}ab=new U(this.internalSceneGraph);ab.setColorHighlight(Z);ab.setMultiColorMode(true);var ac=this.getEffect("Highlight");ac.addScene(ab);if(!ad){ab.detachToHSO()}this.internalSceneGraph.selectionHL.sceneHL.colorHighlight={color:new M.Color().setRGB(0,0.6,1),outlineColor:new M.Color().setRGB(0,1,1),intensity:0.5,polygonOffsetParameters:{activated:false,factor:1,unit:1}};this.highlightSets.push(ab);return ab},removeHighlightSet:function(Z){this.renderer.resetGSSOCache();var ac=this._removeHighlightSet(Z.getColorHighlight(),Z.linkToHSO);var ab=this.getEffect("Highlight");ab.removeScene(Z);Z.detachToHSO();Z.clearAll()},_getHighlightSet:function(Z,ad){var ac=this.highlightSets;for(var ab=0;ab<ac.length;ab++){var ae=ac[ab];if((ae.linkToHSO==ad)&&(ae.isEqualColor(Z))){return ae}}return null},_removeHighlightSet:function(Z,ad){var ac=this.highlightSets;for(var ab=0;ab<ac.length;ab++){var ae=ac[ab];if((ae.linkToHSO==ad)&&(ae.isEqualColor(Z))){ac.splice(ab,1);return true}}return false},addToCSOHSO:function(Z,al){function ab(at){var aq,az,ay,ax=[],am=[],au=false;for(aq=0;aq<Z.path.length&&!au;aq++){az=Z.path[aq];ay=az.getLastElement(true);if(!(ay._excludeFromCSO)){ax.push(az);if(!at){au=true}}}if(!ax.length&&Z.path.length){return null}var aw={CSO:[],HSO:[]};var ao=[],av;var ap,ar,an;for(aq=0;aq<ax.length;aq++){az=ax[aq];av=false;while(az.getLastElement(true).getPickParent()){az=az.getParentPath();av=true}ar=false;if(av){for(ap=0;ap<ao.length;ap++){if(ao[ap].isEqual(az)){ar=true}}if(!ar){ao.push(az)}}if(!ar){aw.CSO.push(az);an=az.getLastElement(true);if(!(an._excludeFromHL)&&!(an._excludeFromHSO)){aw.HSO.push(az)}}}return aw}function ah(am){var aq=am.get();var ap=[];for(var an=0;an<aq.length;an++){var ao=aq[an];var ar=ao.pathElement;if(!ar&&ao.options){ar=ao.options.pathElement}if(ar){ap.push(ar)}}return ap}function ak(aw,ap,av,an){var au={removed:[],added:[]};if(av){au.removed=ah(ap);ap.empty()}var at,aq;var am,aB,ax=[],ao=[],az={highlightColor:af.highlightColor};am=ap.get();var aA,ar,ay;for(at=0;at<aw.length;at++){aB=aw[at];aA=false;for(aq=0;aq<am.length&&!aA;aq++){ar=am[aq];ay=ar.pathElement;if(!ay&&ar.options){ay=ar.options.pathElement}if(aB.isEqual(am[aq].pathElement)){ax.push(am[aq]);aA=true}}if(!aA){ao.push({pathElement:aB,event:al.event,parameters:az})}}if(an){if(ax.length>0){ap.remove(ax)}for(at=0;at<ax.length;at++){au.removed.push(ax[at].pathElement)}}if(ao.length>0){ap.add(ao)}for(at=0;at<ao.length;at++){au.added.push(ao[at].pathElement)}return au}var af=this;var ai=WUX.Selection.HSOManager;var ag=WUX.Selection.CSOManager;var aj=ab(al.trapSel);if(!aj){return{addedToCSO:[],removedFromCSO:[]}}var ae=!al.multiSel;var ac=!al.additiveMode;var ad=ak(aj.CSO,ag,ae,ac);if(this.picking.displayHL){ak(aj.HSO,ai,ae,ac)}return{addedToCSO:ad.added,removedFromCSO:ad.removed}},getVersion:function(){return this.version},getWebGLContext:function(){return this.renderer.renderer.getContext()},getRenderer:function(){return this.renderer.renderer},getInfos:function(){return this.renderer.getInfos()},addViewpoint:function(Z){if(Z!==null){Z._setNode(this.internalSceneGraph.root);if(this._2DMode){Z._set2DMode(true)}this.viewpoints.push(Z)}if(this.viewpoints.length===1){this.selectViewpoint(0)}this.internalSceneGraph.onAddViewpoint()},removeViewpoint:function(Z){if(Z<0||Z>=this.viewpoints.length){return}if(this.viewpoints[Z]==this.currentViewpoint){if(this.internalSceneGraph!==null){this.internalSceneGraph.scene.remove(this.currentViewpoint.getCamera())}this.currentViewpoint=null}this.viewpoints.splice(Z,1);if(this.viewpoints.length>0){this.selectViewpoint(0)}},selectViewpoint:function(Z){if(Z<0||Z>=this.viewpoints.length){return}if((this.currentViewpoint!==null)&&(this.internalSceneGraph!==null)){this.internalSceneGraph.scene.remove(this.currentViewpoint.getCamera())}this.currentViewpoint=this.viewpoints[Z];this.internalSceneGraph.onSelectViewpoint();if(this.internalSceneGraph!==null){this.internalSceneGraph.scene.add(this.currentViewpoint.getCamera())}this.render({updateInfinitePlane:true})},getViewpoints:function(){return this.viewpoints},setTrackingViewpoint:function(Z){this.trackingViewpoint=Z},getTrackingViewpoint:function(){return this.trackingViewpoint},attachScene:function(ab){if(ab===null){return}if(ab.passcode!=="I solemnly swear that I am up to no good."){Q.DEPRECATED_SceneGraph(new Error())}ab.parentSceneGraph=this.internalSceneGraph;var Z=this._sceneGraph;this._sceneGraph=null;if(Z){this.removeNode(Z)}this.addNode(ab._private_root);this._sceneGraph=ab},addNode:function(Z,ab){if(Z instanceof l){throw new Error("addNode with SceneGraph")}else{this.internalSceneGraph&&this.internalSceneGraph.addUserNode(Z,this._sceneGraph!==null)}this.render({updateInfinitePlane:!!ab})},removeNode:function(Z,ab){if(this.internalSceneGraph){this.internalSceneGraph.removeUserNode(Z,this._sceneGraph!==null);this.render({updateInfinitePlane:!!ab})}},getNodes:function(){if(this.internalSceneGraph){return this.internalSceneGraph.getUserNodes(this._sceneGraph!==null)}return null},getRootNode:function(){if(this.internalSceneGraph){return this.internalSceneGraph.getUserRoot(this._sceneGraph!==null)}return null},setClippingPlanes:function(Z){this.renderer.resetGSSOCache();var ac=this.getRenderer();if(ac===null){return false}if(Z&&!ac.clipPlanes.length){return false}var ab=ac.clipPlanesEnabled;ac.clipPlanesEnabled=Z;if(ab!==Z){if(this.internalSceneGraph!==null){this.render()}}return true},getClippingPlanes:function(){var Z=this.getRenderer();if(Z===null){return null}return Z.clipPlanes},addClippingPlane:function(Z,ab){this.renderer.resetGSSOCache();this._addClippingPlane(Z);this.setSectionCappingMaterial(Z,ab);return true},setSectionCappingMaterial:function(Z,ab){this.renderer.resetGSSOCache();var ad=this.getRenderer();var ac;if(!Z.clippingContext){Z.clippingContext={}}if(!Z.clippingContext[ad.id]){Z.clippingContext[ad.id]={useCount:0}}ac=Z.clippingContext[ad.id];if(!ab&&ab!==0){ac.sectionCappingMaterial=new M.MeshPhongMaterial({color:new M.Color(0)});ac.sectionCappingMaterial.clipPlaneUseModelMaterial=true}else{if(ab instanceof M.Material){ac.sectionCappingMaterial=ab.clone()}else{ac.sectionCappingMaterial=new M.MeshBasicMaterial({color:new M.Color(ab)})}}this.renderer.resetClippingScene()},removeClippingPlane:function(Z){this.renderer.resetGSSOCache();this._removeClippingPlane(Z)},setClippingPlaneUpVector:function(Z,ab){Z.upVector=ab.clone();Z.upVector.normalize()},setSectionCapping:function(Z){this.renderer.resetGSSOCache();if(Z&&this.getRenderPriority()){console.warn("Section capping is not compatible with render priority mode");return false}this.renderer.sectionCappingEnabled=Z?true:false;this.render();return true},getSectionCapping:function(){return this.renderer.sectionCappingEnabled},_updateShadowMaps:function(){if(!(this.internalSceneGraph!==null&&typeof this.internalSceneGraph!==undefined)){return}var Z=this.internalSceneGraph.root3js;if(Z!==null&&typeof Z!==undefined){for(var ab=0;ab<Z.parent.__lights.length;ab++){Z.parent.__lights[ab].updateShadowMap=true}}},getVisibleSpace:function(){return this.visibleSpace},swapVisibleSpace:function(){this.renderer.resetGSSOCache();this.visibleSpace=(this.visibleSpace+1)%2;this.renderer.visibleSpace=this.visibleSpace;this.renderer.renderer.visibleSpace=this.visibleSpace;var ae=new M.Color(this.showBgColor);this.ambience.setBackgroundAlpha(this.showBgAlpha);if(!this.visibleSpace){ae.desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio)}this.ambience.setBackgroundColor(ae.getHex());this._setBackgroundColor();var ad,Z;if(this._svgMode&&this.svgRootNode){Z="#"+this.noShowColor.getHexString();this.svgRootNode.style.backgroundColor=this.visibleSpace?"#ffffff":Z;for(ad=0;ad<this.internalSceneGraph.svgRoot.children.length;ad++){this.internalSceneGraph.svgRoot.children[ad]._updateSVGVisibility()}}if(this.ambience.getBackground().hasGradient()){var ab=this.ambience.getBackground().getColors();var ac=[];for(ad=0;ad<ab.length;ad++){if(this.visibleSpace){ac.push(new M.Color(this.showGradientBackground[ad].getHex()))}else{ac.push(ab[ad].desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio))}}this.ambience.getBackground().setColors(ac)}if(this._displayGrid){if(this.visibleSpace){this.gridColor.copy(this.showGridColor)}else{this.gridColor.desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio)}}if(this._infinitePlane){if(this.visibleSpace){this.planeColor.copy(this.showPlaneColor)}else{this.planeColor.desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio)}}if(this.getRobot()&&this.getRobot().isTargetGone(this.visibleSpace)){this.getRobot().setConnectionState(false)}this._updateShadowMaps();this.render({updateInfinitePlane:this._infinitePlane});this._modelEvent.publish({event:"SwapVisibleSpace",data:{viewer:this,visibleSpace:this.visibleSpace}})},getMousePosition:function(ab){if(!(ab instanceof M.Vector2)){console.warn("DEPRECATED: WebGLViewer.getMousePosition() now only accepts THREEDS.Core.Vector2 2D position on the screen as argument.");if(ab.changedTouches){var ac=ab.changedTouches.length?ab.changedTouches[0]:ab;var ae=this.canvas.getBoundingClientRect();var af=ac.pageX-ae.left;var ad=ac.pageY-ae.top;ab=new M.Vector2(af,ad)}}var Z=window.devicePixelRatio||1;return{x:(ab.x/this.canvas.offsetWidth)*2-1,y:-(ab.y/this.canvas.offsetHeight)*2+1,xPix:ab.x*Z,yPix:ab.y*Z}},computeDistanceFromCamera:function(Z){var ab=this.renderer.computePositionGPU(this.internalSceneGraph,this.currentViewpoint,Z);return ab.distanceTo(this.currentViewpoint.camera.position)},invalidatePickingBuffer:function(){if(this.renderer.pickingGPUComposerContext){this.renderer.pickingGPUComposerContext.needsUpdate=true;this.renderer.meshesGPU={}}},setPickingPriority:function(Z){this.pickingPriorityMapping=Z},pick:function(al,ad,Z,ai,aj,ah){var aq,ak,an,ag,ar,ae={ray:null},ao;var ap=ai?ai:this.pickingPriorityMapping;var am=false;if(this.infPlaneSmall&&ap){am=this.infPlaneSmall.visible;this.infPlaneSmall.visible=false}ag={path:[],position:null,normal:null,tangent:null,uv:null,ray:null};this.renderer.overrideUpdate(this.internalSceneGraph,this.getCurrentSceneGraphState());switch(ad){case"mesh":aq=this.computeIntersection(al,true,false,Z,ae,ap,aj,ah);for(ao=0;ao<aq.length;++ao){if(aq[ao].object&&aq[ao].object.pickable){aq[ao].path=new O();aq[ao].path.setFromOccurrence(aq[ao].object._occurrence)}else{aq[ao].path=null}}break;case"meshCPU":aq=this.computeIntersection(al,false,false,Z,ae,ap,aj,ah);for(ao=0;ao<aq.length;++ao){if(aq[ao].object&&aq[ao].object.pickable){aq[ao].path=new O();aq[ao].path.setFromOccurrence(aq[ao].object._occurrence)}else{aq[ao].path=null}}break;case"primCPU":aq=this.computeIntersection(al,false,true,Z,ae,ap,aj,ah);for(ao=0;ao<aq.length;++ao){if(aq[ao].primitive&&aq[ao].object._occurrence){aq[ao].path=new O();aq[ao].path.setFromOccurrence(aq[ao].object._occurrence,THREEDS.SubElement.getFromSGNode(aq[ao].primitive))}else{aq[ao].path=null}}break;case"primHybrid":aq=this.computeIntersection(al,true,true,Z,ae,ap,aj,ah);for(ao=0;ao<aq.length;++ao){var ab=aq[ao].object?aq[ao].object._occurrence:null;if(aq[ao].primitive&&ab){var af=(aq[ao].primitive===true)?null:THREEDS.SubElement.getFromSGNode(aq[ao].primitive);aq[ao].path=new O();aq[ao].path.setFromOccurrence(ab,af)}else{if(aq[ao].object&&aq[ao].object._instancingInfos&&aq[ao].object._instancingInfos.isInstanceNode3D){if(aq[ao].object.pickable){aq[ao].path=new O();aq[ao].path.setFromOccurrence(ab)}}else{if(ab&&ab.node&&(ab.node.primitivePicking===false)){aq[ao].path=new O();aq[ao].path.setFromOccurrence(ab)}else{aq[ao].path=null}}}}break;case"prim":aq=this.computeIntersection(al,false,true,Z,ae,ap,aj,ah);for(ao=0;ao<aq.length;++ao){if(aq[ao].primitive&&aq[ao].object._occurrence){var af=(aq[ao].primitive===true)?null:THREEDS.SubElement.getFromSGNode(aq[ao].primitive);aq[ao].path=new O();aq[ao].path.setFromOccurrence(aq[ao].object._occurrence,af)}else{aq[ao].path=null}}break;case"rep":aq=this.computeIntersection(al,false,true,Z,ae,ap,aj,ah);for(ao=0;ao<aq.length;++ao){if(aq[ao].primitive&&aq[ao].object._occurrence){var af=(aq[ao].primitive===true)?null:THREEDS.SubElement.getFromSGNode(aq[ao].primitive.rep);aq[ao].path=new O();aq[ao].path.setFromOccurrence(aq[ao].object._occurrence,af)}else{aq[ao].path=null}}break;case"repHybrid":aq=this.computeIntersection(al,true,true,false,ae,ap,aj,ah);for(ao=0;ao<aq.length;++ao){if(aq[ao].primitive&&aq[ao].object._occurrence){var af=(aq[ao].primitive===true)?null:THREEDS.SubElement.getFromSGNode(aq[ao].primitive.rep);aq[ao].path=new O();aq[ao].path.setFromOccurrence(aq[ao].object._occurrence,af)}else{if(aq[ao].object&&aq[ao].object._instancingInfos&&aq[ao].object._instancingInfos.isInstanceNode3D){if(aq[ao].object.pickable){aq[ao].path=new O();aq[ao].path.setFromOccurrence(aq[ao].object._occurrence)}}else{aq[ao].path=null}}}break;default:break}if(ad!=="mesh"){aq=this._filterClippedIntersections(aq)}ag.ray=ae.ray;if(aq.length){ag.position=aq[0].point;ag.normal=aq[0].normal;if(aq[0].path===null){if((this._displayGrid||this._infinitePlane)&&ag.ray&&(ag.ray.direction.z<0)){ag.normal=new M.Vector3(0,0,1);var ac=new M.Plane(ag.normal,this.offsetPlaneSmall.z);ag.position=ag.ray.intersectPlane(ac)}}else{ag.tangent=aq[0].tangent;ag.uv=aq[0].uv}}for(ao=0;ao<aq.length;++ao){if(aq[ao].path!==null){if(aq[ao].instanceId!==undefined){aq[ao].path.instanceId=aq[ao].instanceId}ag.path.push(aq[ao].path)}}if(this.infPlaneSmall&&ap){this.infPlaneSmall.visible=am}return ag},pickInVolume:function(ah,ag,aq){if(!ah||!ag){return{inside:[],partial:[],outside:[]}}var aA=this.internalSceneGraph.scene;var af=[];if(aq){af=af.concat(aq._getRenderableOccurrences(this,false))}else{if(aA instanceof M.Mesh){af=[aA]}else{var ar=this._getUserPassManager()._getActiveRenderLists();var ak=[];for(var aw=0;aw<ar.length;aw++){ak=ak.concat(aA.getWebGLObjects(ar[aw],0))}for(var aw=0;aw<ak.length;aw++){if(ak[aw]!==null){af.push(ak[aw].object)}}}}var az=(this.renderer.renderer.pickFacesMode===1)||((this.renderer.renderer.pickFacesMode===2)&&this.renderer.renderer.renderFaces)||((this.renderer.renderer.pickFacesMode===3)&&!this.renderer.renderer.renderFaces);var ay=(this.renderer.renderer.pickLinesMode===1)||((this.renderer.renderer.pickLinesMode===2)&&this.renderer.renderer.renderLineMode)||((this.renderer.renderer.pickLinesMode===3)&&!this.renderer.renderer.renderLineMode);var an=(this.renderer.renderer.pickPointsMode===1)||this.renderer.renderer.renderPoints;var av=new M.Sphere();if(ah instanceof M.Box3){var ai=ah;var au=ai.getPoints(ag);var ap=[[0,2,1],[4,0,5],[6,4,7],[2,6,3],[5,1,7],[4,6,0]];var ao=[];var am=new M.Vector3();var al=new M.Vector3();for(var aw=0;aw<ap.length;aw++){var ae=ap[aw];am.copy(au[ae[1]]).sub(au[ae[0]]);al.copy(au[ae[2]]).sub(au[ae[0]]);am.cross(al).normalize();ao.push(new M.Plane().setFromNormalAndCoplanarPoint(am,au[ae[0]]))}av=new M.Frustum(ao[0],ao[1],ao[2],ao[3],ao[4],ao[5])}else{if(ah instanceof M.Sphere){av=ah.clone();av.applyMatrix4(ag)}else{return{inside:[],partial:[],outside:[]}}}var aj=[{path:[]},{path:[]},{path:[]}];var ax=[];var aB=[];var ab=[];var ac=[ax,aB,ab];for(var aw=0;aw<af.length;aw++){var ad=true;var Z=af[aw];if(Z.visibilityFree){ad=Z.visible}else{ad=this.visibleSpace?Z.visible:!Z.visible}if(!ad){continue}if((Z.pickable!==undefined)&&!Z.pickable){continue}Z._intersectVolume(av,az,an,ay,ax,aB,ab)}for(var at=0;at<ac.length;at++){var aC=ac[at];for(var aw=0;aw<aC.length;++aw){if(aC[aw].object&&aC[aw].object.pickable){aC[aw].path=new O();aC[aw].path.setFromOccurrence(aC[aw].object._occurrence)}else{aC[aw].path=null}}}for(var at=0;at<ac.length;at++){var aC=ac[at];for(var aw=0;aw<aC.length;++aw){if(aC[aw].path!==null){if(aC[aw].instanceId!==undefined){aC[aw].path.instanceId=aC[aw].instanceId}aj[at].path.push(aC[aw].path)}}}return{inside:aj[0],outside:aj[1],partial:aj[2]}},computeIntersection:function(bl,bf,bd,aU,bq,a1,aB,af){var a9=this.trapSelection||aB;var a5,a6,ac,av,bp,bc,am,a2,a0,ap,ah,at,br,aM,ay,ax,ao,bi,bt,az=[];a6=new M.Projector();ap=bf!==undefined?bf:false;am=bd!==undefined?bd:false;aM=aU!==undefined?aU:false;if(this.debugPickHybrid){aM=true}bi=(((this.picking.trapSelection&&a9)||false)&&(bl.pt!==undefined)&&(bl.pt.xPix!==bl.xPix||bl.pt.yPix!==bl.yPix));if((this.currentViewpoint===null)||(this.internalSceneGraph===null)){return az}var an=window.devicePixelRatio||1;a5=new M.Vector2(bl.xPix/an,bl.yPix/an);ac=this.currentViewpoint.create3DRayFrom2DPoint(a5);if((bq!==undefined)&&(bq.ray!==undefined)){bq.ray=ac}if(!bi&&bl.event){var au=bl.event.getView();var bh=au.renderable;if(!bh){while(au!==this.canvas&&(au.parentElement||au.parentNode)&&!bh){au=au.parentElement||au.parentNode;bh=au.renderable}}if(bh&&bh.drawInHLRender){var a8,aK;if(bh instanceof M.CSS3DNode){var aP=new M.Matrix4().multiplyMatrices(bh.matrixWorld,bh.scaleCSS);var aw=bl.event.getCurrentPosition(au);a8=new M.Vector3(aw.x,aw.y,0);a8.applyMatrix4(aP);var bj=aP.elements;aK=new M.Vector3(bj[8],bj[9],bj[10])}else{var aC=bh.position.clone();var a3=this.currentViewpoint.camera.getLookAt();var aZ=new M.Plane().setFromNormalAndCoplanarPoint(this.currentViewpoint.camera.getLookAt(),aC);var bu=bh.element.getBoundingClientRect();var Z=this.getMousePosition(new M.Vector2(bl.xPix,bl.yPix));Z=new M.Vector3(Z.x,Z.y,1);a6.unprojectVector(Z,this.currentViewpoint.camera);var ar=new M.Ray(this.currentViewpoint.camera.position,Z.clone().sub(this.currentViewpoint.camera.position).normalize());a8=ar.intersectPlane(aZ);aK=aZ.normal}az[0]={object:bh,primitive:!!(bh&&bh.primitive),point:a8,normal:aK};return az}}if(bi){if(bl.x===bl.pt.x||bl.y===bl.pt.y){return az}ax=new M.Vector3(bl.pt.x,bl.pt.y,1);var aV,ad,a4,ak,aE,aA;var bk=this.currentViewpoint.camera;var ae=bk.position;var bm=bk.getLookAt();aE=new M.Plane().setFromNormalAndCoplanarPoint(bm,ae.clone().add(bm.clone().multiplyScalar(bk.near)));aA=new M.Plane().setFromNormalAndCoplanarPoint(bm.clone().multiplyScalar(-1),ae.clone().add(bm.clone().multiplyScalar(bk.far)));if(this.currentViewpoint.getProjectionType()===j.PERSPECTIVE){var aS=new M.Vector3(bl.x,bl.y,1);a6.unprojectVector(aS,bk);aS.sub(ae).normalize();var aR=new M.Vector3(bl.pt.x,bl.y,1);a6.unprojectVector(aR,bk);aR.sub(ae).normalize();var aO=new M.Vector3(bl.pt.x,bl.pt.y,1);a6.unprojectVector(aO,bk);aO.sub(ae).normalize();var aL=new M.Vector3(bl.x,bl.pt.y,1);a6.unprojectVector(aL,bk);aL.sub(ae).normalize();var aJ=new M.Vector3();aJ.copy(aS);a4=new M.Plane().setFromNormalAndCoplanarPoint(aS.cross(aR).normalize(),ae);ad=new M.Plane().setFromNormalAndCoplanarPoint(aR.cross(aO).normalize(),ae);ak=new M.Plane().setFromNormalAndCoplanarPoint(aO.cross(aL).normalize(),ae);aV=new M.Plane().setFromNormalAndCoplanarPoint(aL.cross(aJ).normalize(),ae)}else{var aF=bk.up.clone();var aT=new M.Vector3(1,0,0).applyQuaternion(bk.quaternion);var ai=new M.Vector3(bl.x,bl.y,1);a6.unprojectVector(ai,bk);var bg=new M.Vector3(bl.pt.x,bl.pt.y,1);a6.unprojectVector(bg,bk);a4=new M.Plane().setFromNormalAndCoplanarPoint(aF.clone().negate(),ai);ad=new M.Plane().setFromNormalAndCoplanarPoint(aT.clone().negate(),bg);ak=new M.Plane().setFromNormalAndCoplanarPoint(aF,bg);aV=new M.Plane().setFromNormalAndCoplanarPoint(aT,ai)}ay=new M.Frustum(aV,ad,a4,ak,aE,aA)}var ba=(this.renderer.renderer.pickFacesMode===1)||((this.renderer.renderer.pickFacesMode===2)&&this.renderer.renderer.renderFaceMode)||((this.renderer.renderer.pickFacesMode===3)&&!this.renderer.renderer.renderFaceMode);var aI=(this.renderer.renderer.pickLinesMode===1)||((this.renderer.renderer.pickLinesMode===2)&&this.renderer.renderer.renderLineMode)||((this.renderer.renderer.pickLinesMode===3)&&!this.renderer.renderer.renderLineMode);var bn=(this.renderer.renderer.pickPointsMode===1)||this.renderer.renderer.renderPoints;var ag=this.renderer.renderer.getPickingRenderPointMode();var be;if(ap){this.currentViewpoint._updateRobotCamera(this.internalSceneGraph);if(this.renderer.smallTargetPicking){az=this.renderer.computeIntersectionGPUSmallTarget(this.internalSceneGraph,this.currentViewpoint,bl,aM,bi,ba,(aI===true)?M.ShowAllRenderLineMode:aI,bn,ag,a1,ap&&am);if(this.currentViewpoint.camera.fullWidth){this.lockRenderIteration();this.internalSceneGraph.onViewpointChange();this.unlockRenderIteration()}}else{az=this.renderer.computeIntersectionGPU(this.internalSceneGraph,this.currentViewpoint,bl,aM,bi,ba,(aI===true)?M.ShowAllRenderLineMode:aI,bn,ag,a1,ap&&am)}if(az.length&&am&&!(az[0].object&&az[0].object._instancingInfos&&az[0].object._instancingInfos.isInstanceNode3D)){var aX=[];for(var aH=0;aH<az.length;++aH){if(az[aH].object instanceof M.Mesh&&az[aH].object.pickable&&(!az[aH].object._occurrence||!az[aH].object._occurrence.node||az[aH].object._occurrence.node.primitivePicking!==false)){be=this._getUserPassManager()._getActiveRenderLists();if(bi){aX=aX.concat(ac.intersectMeshInstancesZones3D(az[aH].object,this.currentViewpoint.camera,new M.Vector3(bl.x,bl.y,1),ax,ay,bd,ba,aI,bn,this.renderer.deviceWidth,this.renderer.deviceHeight,be,true,this.visibleSpace))}else{aX=aX.concat(ac.intersectMeshInstances(az[aH],this.currentViewpoint.camera,new M.Vector3(bl.x,bl.y,1),ba,aI,bn,this.renderer.deviceWidth,this.renderer.deviceHeight,this.picking.tolerance,this.debugPickHybrid,be,this.visibleSpace))}}}if(aX.length){az=aX}}}else{be=this._getUserPassManager()._getActiveRenderLists();if(bi){az=az.concat(ac.intersectMeshInstancesZones3D(this.internalSceneGraph.scene,this.currentViewpoint.camera,new M.Vector3(bl.x,bl.y,1),ax,ay,bd,(ba===true)?S.facesMask:ba,(aI===true)?S.linesMask:aI,(bn===true)?S.pointsMask:bn,this.renderer.deviceWidth,this.renderer.deviceHeight,be,!a9.forwardSelect,this.visibleSpace))}else{az=ac.intersectMeshInstances({object:this.internalSceneGraph.scene},this.currentViewpoint.camera,new M.Vector3(bl.x,bl.y,1),ba,aI,bn,this.renderer.deviceWidth,this.renderer.deviceHeight,this.picking.tolerance,undefined,be,this.visibleSpace)}if(a1){var bo=[];for(var aG=0;aG<a1.length;aG++){bo[a1[aG].id]=a1[aG].priority}var aN=function(bw,bv){var bz=0;var bx=0;if(bw.object.pickingPriorityID){var bA=bw.object.pickingPriorityID.points;if(!bw.primitive||(bw.primitive.group.glType>=4)){bA=bw.object.pickingPriorityID.faces}else{if(bw.primitive.group.glType>=1){bA=bw.object.pickingPriorityID.edges}}if(bA&&bo[bA]){bz=bo[bA]}}if(bv.object.pickingPriorityID){var by=bv.object.pickingPriorityID.points;if(!bv.primitive||(bv.primitive.group.glType>=4)){by=bv.object.pickingPriorityID.faces}else{if(bv.primitive.group.glType>=1){by=bv.object.pickingPriorityID.edges}}if(by&&bo[by]){bx=bo[by]}}if(bz>bx){return -1}else{if(bz<bx){return 1}}return bw.distance-bv.distance};az.sort(aN)}}if(this.debugPicking&&(az.length>0)){bp=new M.MeshPhongMaterial({color:16729156,opacity:1,transparent:false,force:true});bc=new M.MeshPhongMaterial({color:4474111,opacity:1,transparent:false,force:true});var aD=P.createSphereNode({radius:1,sag:32,material:bp});a2=aD._occurrences[0].renderable;a2.frustumCulled=false;a2.pickable=false;a2.drawInHLRender=false;a2.setMatrix(new M.Matrix4().setPosition(az[0].point));console.log(" x "+az[0].point.x+" y "+az[0].point.y+" z "+az[0].point.z);a0=new M.Mesh(a2.geometry,bc);a0.frustumCulled=false;a0.pickable=false;a0.drawInHLRender=false;a0.setMatrix(new M.Matrix4().setPosition(this.currentViewpoint.camera.position));this.debugPickingNode.add(a0);var a7=az[0].primitive;if(a7&&a7.boundingSphere){var aQ=new M.MeshPhongMaterial({color:4521796,opacity:1,transparent:false,force:true});var al=new M.Mesh(a2.geometry,aQ);al.frustumCulled=false;al.pickable=false;al.drawInHLRender=false;var aj=new M.Sphere(new M.Vector3(a7.boundingSphere.center[0],a7.boundingSphere.center[1],a7.boundingSphere.center[2]),a7.boundingSphere.radius);aj.applyMatrix4(az[0].object.matrix);var bs=new M.Matrix4().setPosition(aj.center);bs.scale(new M.Vector3(aj.radius,aj.radius,aj.radius));al.setMatrix(bs);this.debugPickingNode.add(al)}var aW=new M.MeshBasicMaterial({color:16729156,opacity:1,force:true});var aY=P.createLineNode({points:[new M.Vector3(ac.origin.x-10000*ac.direction.x,ac.origin.y-10000*ac.direction.y,ac.origin.z-10000*ac.direction.z),ac.origin,new M.Vector3(ac.origin.x+10000*ac.direction.x,ac.origin.y+10000*ac.direction.y,ac.origin.z+10000*ac.direction.z)],material:aW});at=aY._occurrences[0].renderable;at.frustumCulled=false;at.drawInHLRender=false;this.debugPickingNode.add(at)}for(var aH=0;aH<az.length;aH++){var aq=az[aH];if(aq.object&&aq.primitive){var ab=aq.object.getSelectionGroup(aq.primitive);if(ab){aq.primitive=ab}}}return az},_updateSVGVisu:function(){if(this._svgMode&&this.svgRoot&&this._2DMode){var ag=this.currentViewpoint.camera;var af=this.SCREEN_HEIGHT/ag.visualizedHeight;var ah=af;var am=0;var al=0;var ak=(1-ah)*am;var ai=(1-ah)*al;var ao="matrix("+ah+" 0 0 "+ah+" "+ak+" "+ai+") ";var Z=0.5*this.SCREEN_WIDTH-ag.position.x*af;var an=0.5*this.SCREEN_HEIGHT+ag.position.y*af;var ae=Z+am*af;var ac=an-al*af;var ad=ae-am;var ab=ac-al;var aj="translate ("+ad+" "+ab+") ";this.svgRoot.setAttribute("transform",aj+ao)}},_updateOffsetPlane:function(ad,ab,ac,af){if(ac){if(this.ambience.isAutoGroundOffset()){if(this._forceSceneMinValue!==null){ag=this._forceSceneMinValue}else{var ag=(this.internalSceneGraph===null)?0:this.internalSceneGraph.getSceneMin(af)}if(ag!==null){this.ambience.updateScene(new M.Vector3(ad.center.x,ad.center.y,ag))}}}this.offsetPlaneBackground.copy(this.ambience.getGroundPosition());if(this.ambience.isAutoGroundOffset()){if(!this.ambience.isFiniteMode()){var Z=ab.getLookAt();if(this.planeV2){this.offsetPlaneBackground.x=ad.center.x;this.offsetPlaneBackground.y=ad.center.y}else{var ae=(Math.abs(Z.z)>0.0001)?1/Z.z:0;this.offsetPlaneBackground.x=0.5*(ad.center.x+ab.position.x-(ab.position.z-this.offsetPlaneBackground.z)*Z.x*ae);this.offsetPlaneBackground.y=0.5*(ad.center.y+ab.position.y-(ab.position.z-this.offsetPlaneBackground.z)*Z.y*ae)}}}this.offsetPlaneBackground.z+=this.ambience.getOffset();this.offsetPlaneSmall.z=this.offsetPlaneBackground.z;return},_getPlaneSize:function(ae,ad,ac,ab){var Z=0;if(this.ambience.isAutoGroundOffset()){if(this.planeV2){Z=20*ae.radius}else{Z=Math.max(20*(this.offsetPlaneBackground.distanceTo(ae.center)+ae.radius),5*this.offsetPlaneBackground.distanceTo(ad.position))}}else{if(this.planeV2&&this.planeGrid){Z=this.planeGrid.size}else{Z=this.gridUnit/this.gridStep}}return Z},_castRayFunc:function(aj,Z,ah,al){var aw=al?al:{};var ac=ah==="mesh";var ad=aw.intersectFaces===null||aw.intersectFaces===undefined?true:aw.intersectFaces;var ag=aw.intersectEdges;var ax=aw.intersectPoints;var ar=aw.edgeTolerance?aw.edgeTolerance:0.1;var ay=aw.pointTolerance?aw.pointTolerance:0.1;var ak=Z;var au=0;var at=0;var ai=0;var az=null;var ab=[];for(au=0,ai=ak.length;au<ai;au++){if(ak[au]===null){continue}az=ak[au].object?ak[au].object:ak[au];var af=az.worldCenter;var ao=az.worldRadius;var ae=aj.distanceToPoint(af);if(ae<=ao){var av,aq,an;if(ad){if((az.geometry._type===2)||(az.geometry.length>=0)){av=aj._castRayIntoBufferGeom(az,ac)}else{var ap=new M.Raycaster(this.origin,this.direction,0,Infinity);av=ap.intersectObject(az,false)}for(at=0;at<av.length;at++){var am=new O();if(av[at].primitive){am.setFromOccurrence(av[at].object._occurrence,THREEDS.SubElement.getFromSGNode(av[at].primitive))}else{am.setFromOccurrence(av[at].object._occurrence);av[at].distance=aj.direction.dot(new M.Vector3().subVectors(af,aj.origin))}av[at].pathElement=am}ab=ab.concat(av)}if(ag&&(!ac||(ac&&!av))){aq=aj._castRayIntoBufferGeomEdge(az,ar,ac);for(at=0;at<aq.length;at++){var am=new O();if(aq[at].primitive){am.setFromOccurrence(aq[at].object._occurrence,THREEDS.SubElement.getFromSGNode(aq[at].primitive))}else{am.setFromOccurrence(aq[at].object._occurrence);aq[at].distance=aj.direction.dot(new M.Vector3().subVectors(af,aj.origin))}aq[at].pathElement=am}ab=ab.concat(aq)}if(ax&&(!ac||(ac&&!aq))){an=aj._castRayIntoBufferGeomPoint(az,ay,ac);for(at=0;at<an.length;at++){var am=new O();if(an[at].primitive){am.setFromOccurrence(an[at].object._occurrence,THREEDS.SubElement.getFromSGNode(an[at].primitive))}else{am.setFromOccurrence(an[at].object._occurrence);an[at].distance=aj.direction.dot(new M.Vector3().subVectors(af,aj.origin))}an[at].pathElement=am}ab=ab.concat(an)}}}ab.sort(function(aB,aA){return aB.distance-aA.distance});return ab},castRay:function(ad,af,ai,ag){var ab=0;var ac=0;var ah=["main","noz","afterHighlightNoZ"];var Z=[];if(!af){var ae=this.internalSceneGraph.scene;for(ac=0;ac<ah.length;ac++){Z=Z.concat(ae.getWebGLObjects(ah[ac],0))}}else{for(ab=0;ab<af._occurrences.length;ab++){Z=Z.concat(af._occurrences[ab]._getRenderableOccurrences())}}return this._castRayFunc(ad,Z,ai,ag)},castRayOnOccurrence:function(ad,ah,ai,af){var ac=0;var ag=["main","noz","afterHighlightNoZ"];var Z=[];if(!ah){var ae=this.internalSceneGraph.scene;for(ac=0;ac<ag.length;ac++){Z=Z.concat(ae.getWebGLObjects(ag[ac],0))}}else{Z=ah._getRenderableOccurrences(this,false);var ab=ah._getUniqueOccurrence(this);if(ab===null){console.log("castRayIntoOccurrences ERROR: the path element is either invalid or doesn't define a unique occurrence.")}else{ab.node._tryOverridesUpdate(this)}}return this._castRayFunc(ad,Z,ai,af)},displayFaces:function(Z){this.renderer.resetGSSOCache();this._DEPRECATED_setRenderFooMode(new Error());this._setInternalRenderFaceMode(Z?M.ShowAllFaces:M.HideAllModelFaces)},displayLines:function(Z){this.renderer.resetGSSOCache();this._DEPRECATED_setRenderFooMode(new Error());this._setInternalRenderLineMode(Z?M.ShowAllRenderLineMode:M.HideAllRenderLineMode)},displayHiddenEdges:function(Z){this.renderer.resetGSSOCache();this.renderer.renderer.renderHiddenEdges=Z},setRenderLineMode:function(Z){this.renderer.resetGSSOCache();this._DEPRECATED_setRenderFooMode(new Error());this._setInternalRenderLineMode(Z)},addRenderModeLock:function(ab,Z){this.lockedRenderMode.set(ab,Z)},removeRenderModeLock:function(Z){if(this.lockedRenderMode.has(Z)){this.lockedRenderMode["delete"](Z)}},clearRenderModeLock:function(){this.lockedRenderMode.clear()},applyRenderModeLock:function(){var Z=this;this.lockedRenderMode.forEach(function(ab,ac,ad){Z._setRenderMode(ac,ab)})},getAxisFilter:function(){return this.axisFilterStatus},setAxisFilter:function(Z){this.axisFilterStatus=Z;var ac=this.getBagNode?this.getBagNode():this.getRootNode?this.getRootNode():null;if(ac){var ab=ac.getChildrenByName("AxisSystems");if(ab&&ab.length>0){ab.forEach(function(ae){ae.setVisibility(Z);ae.setVisibilityFree(!Z)})}var ad=ac.getChildrenByName("RefPlanes");if(ad&&ad.length>0){ad.forEach(function(ae){ae.setVisibility(Z);ae.setVisibilityFree(!Z)})}}this.addRenderModeLock("InfiniteFace",Z);this.addRenderModeLock("AxisSystem",Z);this.applyRenderModeLock();this.render();this._modelEvent.publish({event:"AxisFilterMode",data:{viewer:this,state:this.axisFilterStatus}});this._modelEvent.publish({event:"RefPlaneFilterMode",data:{viewer:this,state:this.axisFilterStatus}})},onAxisFilterChange:function(Z){return this._modelEvent.subscribe({event:"AxisFilterMode",},Z)},getLinesFilter:function(){return this.linesFilterStatus},setLinesFilter:function(Z){this.linesFilterStatus=Z;this.addRenderModeLock("WireEdge",Z);this.applyRenderModeLock();this.render();this._modelEvent.publish({event:"LinesFilterMode",data:{viewer:this,state:this.linesFilterStatus}})},onLinesFilterChange:function(Z){return this._modelEvent.subscribe({event:"LinesFilterMode",},Z)},getPointsFilter:function(){return this.pointsFilterStatus},setPointsFilter:function(Z){this.pointsFilterStatus=Z;this.addRenderModeLock("@Point",Z);this.addRenderModeLock("SurfacicPoint",false);this.applyRenderModeLock();this.render();this._modelEvent.publish({event:"PointsFilterMode",data:{viewer:this,state:this.pointsFilterStatus}})},onPointsFilterChange:function(Z){return this._modelEvent.subscribe({event:"PointsFilterMode",},Z)},_setRenderMode:function(ab,Z){this.renderer.resetGSSOCache();var ac=new S();ac._setFromMasks(this.renderer.renderer.renderPointMode,this._getInternalRenderLineMode(),this._getInternalRenderFaceMode());ac.setRenderMode(ab,Z);this.renderer.renderer.renderPointMode=ac._mask&S.pointsMask;this._setInternalRenderFaceMode(ac._mask&S.facesMask);this._setInternalRenderLineMode(ac._mask&S.linesMask)},setRenderMode:function(ab,Z){this._setRenderMode(ab,Z);this.applyRenderModeLock()},setRenderStyle:function(Z){this._renderStyle=Z.clone();var ab=Z._renderMode;this.renderer.renderer.renderPointMode=ab._mask&S.pointsMask;this.renderer.renderer.outlineWidth=ab._outlineWidth;this._setInternalRenderFaceMode(ab._mask&S.facesMask);this._setInternalRenderLineMode(ab._mask&S.linesMask);this.applyRenderModeLock();this.internalSceneGraph.root.forceUpdate()},setRenderFaceMode:function(Z){this.renderer.resetGSSOCache();this._DEPRECATED_setRenderFooMode(new Error());this._setInternalRenderFaceMode(Z)},displayPoints:function(Z){this.renderer.resetGSSOCache();this.renderer.renderer.renderPoints=Z},displaySurfacicPoints:function(Z){this.renderer.resetGSSOCache();this.setRenderMode("SurfacicPoint",Z)},_setGradientBackgroundShader:function(){var ag;if(this.sphereEnv!==null){var ab=this.ambience.getBackground().getColors();switch(ab){case 2:ag=M.GradientBackgroundShader2;break;case 3:ag=M.GradientBackgroundShader3;break;case 4:ag=M.GradientBackgroundShader4;break;default:this.removeEnvMap();return}var af={fragmentShader:ag.fragmentShader,vertexShader:ag.vertexShader,uniforms:ag.uniforms},ae=new M.ShaderMaterial(af);ae.force=true;ae.side=M.DoubleSide;ae.forceSide=true;ae.depthTest=false;ae.uniforms.colors.value=[];var Z=ae.uniforms.colors.value;for(var ad=0;ad<ab.length;ad++){var ac=ab[ad];Z.push(ac.r);Z.push(ac.g);Z.push(ac.b)}this.sphereEnv.material=ae}},setGradientBackground:function(Z){this.renderer.resetGSSOCache();this.showGradientBackground=[];if(!Z||((Z.length<2)||(Z.length>4))){this.removeEnvMap();return}var ac=[];for(var ad=0;ad<Z.length;ad++){var ab=new M.Color(Z[ad]);if(!this.visibleSpace){ab.desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio)}this.showGradientBackground.push(new M.Color(Z[ad]));ac.push(ab)}this.ambience.getBackground().setColors(ac)},_setBackgroundColor:function(){if(this._svgMode&&this._2DMode&&!d.getWebGLMode()){this.renderer.setBackgroundColor(0,0)}else{this.renderer.setBackgroundColor(this.ambience.getBackgroundColor().getHex(),this.ambience.getBackgroundAlpha())}this._modelEvent.publish({event:"VisuBackgroundColor",data:this.ambience.getBackgroundColor().getHex()})},setBackgroundColor:function(ab,ac){this.__tempBackgroundColorODT=ab;this.renderer.resetGSSOCache();this.ambience.setBackgroundAlpha((ac!==undefined)?ac:1);this.showBgColor=new M.Color(ab).getHex();this.showBgAlpha=this.ambience.getBackgroundAlpha();if(!this.visibleSpace){var Z=new M.Color(ab);Z.desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio);this.ambience.setBackgroundColor(Z.getHex())}else{this.ambience.setBackgroundColor(ab)}this._setBackgroundColor();this.render()},setPlaneColor:function(Z){this.renderer.resetGSSOCache();this.planeColor.set(Z);this.showPlaneColor.set(Z);if(!this.visibleSpace){this.planeColor.desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio)}this.render()},setGridColor:function(Z){this.renderer.resetGSSOCache();this.gridColor.set(Z);this.showGridColor.set(Z);if(!this.visibleSpace){this.gridColor.desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio)}this.render()},setSecondaryLightColor:function(ab){this.renderer.resetGSSOCache();var Z;if(typeof(ab)==="number"||typeof(ab)==="string"){Z=new M.Color(ab)}else{if(ab){Z=ab}}if(this.directionalLight2!==null){this.directionalLight2.color.copyGammaToLinear(Z)}this.render()},setShadow:function(ab,ae,ag){var Z=this.directionalLight;if(Z!==null){Z.LiSPSM=ae;if(Z.shadowCascade){for(var ad=0;ad<Z.shadowCascadeArray.length;ad++){Z.shadowCascadeArray[ad].LiSPSM=ae}}}var af=ag?[ag]:["static","dynamic"];for(var ad=0;ad<af.length;ad++){var ac=af[ad];if(!this._qmSetShadow||this._qmSetShadow(ab,ac)){this._effectSettings.InterObjectShadows[ac]=ab}}},_setShadow:function(Z){if(this.mobile){return}if(this.useShadowMap!==this._effectSettings.InterObjectShadows[Z]){this.renderer.resetGSSOCache();this.useShadowMap=this._effectSettings.InterObjectShadows[Z];this.renderer&&this.renderer.recompileAllShaders()}},setOIT:function(Z,ae){var ad=ae?[ae]:["static","dynamic"];for(var ac=0;ac<ad.length;ac++){var ab=ad[ac];if(!this._qmSetOIT||this._qmSetOIT(Z,ab)){this._effectSettings.Transparency[ab]=Z?"WeightedAverage":"AlphaBlending"}}},_setOIT:function(ab){var Z=(this._effectSettings.Transparency[ab]==="WeightedAverage");if(Z&&this.getRenderPriority()){console.warn("Warning: OIT is not compatible with render priority");return}if(this.useOIT!==Z&&!this.mobile&&this.renderer&&!this._svgMode){this.renderer.resetGSSOCache();this.renderer.setEffect("OIT",Z);this.useOIT=this.renderer.useOIT;this.renderer.recompileAllShaders()}},enableZPrePass:function(Z,ae){var ad=ae?[ae]:["static","dynamic"];for(var ac=0;ac<ad.length;ac++){var ab=ad[ac];if(!this._qmEnableZPrePass||this._qmEnableZPrePass(Z,ab)){this._effectSettings.ZPrePass[ab]=Z}}this.render()},_enableZPrePass:function(ab){var Z=(this._effectSettings.ZPrePass[ab]);this.renderer._enableZPrePass(Z)},setShadowFilter:function(ac,ae){var ad=ae?[ae]:["static","dynamic"];for(var ab=0;ab<ad.length;ab++){var Z=ad[ab];this._qmSetShadowFilter&&this._qmSetShadowFilter(ac,Z);this._effectSettings.ShadowFilter[Z]=ac}},_setShadowFilter:function(Z){if(this._effectSettings.ShadowFilter[Z]===this.shadowFilter){return}this.shadowFilter=this._effectSettings.ShadowFilter[Z];switch(this.shadowFilter){case"PCF":this.renderer.renderer.shadowMapType=M.PCFShadowMap;break;case"PCFInterpol":this.renderer.renderer.shadowMapType=M.PCFInterpolShadowMap;break;case"PCFPoisson":this.renderer.renderer.shadowMapType=M.PCFPoissonShadowMap;break;case"PCFOptimized":this.renderer.renderer.shadowMapType=M.PCFOptimizedShadowMap;break;case"ESM":this.renderer.renderer.shadowMapType=M.ESMShadowMap;if(!this.renderer.renderer.esmEffect){this.renderer.renderer.esmEffect=new v(this.renderer.renderer,this.renderer.renderTargetPool)}break;default:this.renderer.renderer.shadowMapType=M.BasicShadowMap;break}this.internalSceneGraph.scene.recompileShaders();this._updateShadowMaps()},setShadowQuality:function(Z,ae){var ad=ae?[ae]:["static","dynamic"];for(var ac=0;ac<ad.length;ac++){var ab=ad[ac];this._qmSetShadowQuality&&this._qmSetShadowQuality(Z,ab);this._effectSettings.ShadowQuality[ab]=Z}},_setShadowQuality:function(Z){if(this._effectSettings.ShadowQuality[Z]===this.shadowQuality){return}this.shadowQuality=this._effectSettings.ShadowQuality[Z];if(this.shadowQuality==="Medium"){this.renderer.renderer.shadowMapQuality=M.MediumQuality}else{if(this.shadowQuality==="High"){this.renderer.renderer.shadowMapQuality=M.HighQuality}else{this.renderer.renderer.shadowMapQuality=M.LowQuality}}this.internalSceneGraph.scene.recompileShaders();this._updateShadowMaps()},getShadowFilter:function(){return this.shadowFilter},getShadowQuality:function(){return this.shadowQuality},setShadowCascade:function(ad,af,Z){this.renderer.resetGSSOCache();var ac=this.directionalLight;var ah=af?af:1024;var ag=false;if(ac!==null){if(this.getRenderer()){this.getRenderer().shadowMapCascade=ad}if((this.shadowMapWidth!==ah)||(this.shadowMapHeight!==ah)){ag=true;this.shadowMapWidth=ah;this.shadowMapHeight=ah;if(!ad){ac.shadowMap=null;ac.shadowMapWidth=ah;ac.shadowMapHeight=ah}}ac.shadowCascade=ad;ac.shadowCascadeCount=Z?Z:3;ac.shadowCascadeWidth=[];ac.shadowCascadeHeight=[];ac.shadowCascadeBias=[];ac.shadowCascadeNearZ=[];ac.shadowCascadeFarZ=[];for(var ae=0;ae<ac.shadowCascadeCount;ae++){ac.shadowCascadeWidth[ae]=ah;ac.shadowCascadeHeight[ae]=ah;ac.shadowCascadeBias[ae]=-0.005}ac.shadowCascadeOffset.set(0,0,-10);if(ag&&ac.shadowCascadeArray){for(var ae=0;ae<ac.shadowCascadeArray.length;ae++){var ab=ac.shadowCascadeArray[ae];ab.shadowMap=null;ab.shadowMapWidth=ah;ab.shadowMapHeight=ah;ab.shadowBias=-0.005}}this.renderer&&this.renderer.recompileAllShaders()}},setGroundShadow:function(Z,ae){var ad=ae?[ae]:["static","dynamic"];for(var ac=0;ac<ad.length;ac++){var ab=ad[ac];if(!this._qmSetGroundShadow||this._qmSetGroundShadow(Z,ab)){this._effectSettings.GroundShadows[ab]=Z}}},_setGroundShadow:function(Z){if(this.mobile){return}if(this.useGroundShadow===this._effectSettings.GroundShadows[Z]){return}this.useGroundShadow=this._effectSettings.GroundShadows[Z];this.renderer.resetGSSOCache();if(this.dirLightGroundShadow.groundMaterial){if(!this.useGroundShadow){delete this.dirLightGroundShadow.groundMaterial.defines.GROUND_SHADOW}else{this.dirLightGroundShadow.groundMaterial.defines.GROUND_SHADOW=true}this.dirLightGroundShadow.groundMaterial.needsUpdate=true}},setGroundShadowAutomaticUpdate:function(Z){this.dirLightGroundShadow.blockUpdate=!Z;if(Z){this.dirLightGroundShadow.updateShadowMap=true}},__setGroundShadow:function(){if(!this.blurShadowEffect){this.blurShadowEffect=new V(this.renderer.renderer,this.renderer.renderTargetPool);this.dirLightGroundShadow.blurShadowEffect=this.blurShadowEffect}var Z=this.dirLightGroundShadow.groundMaterial;if(!Z){return}if(!Z.uniforms.groundShadow.value){Z.defines.GROUND_SHADOW=true;Z.needsUpdate=true}},setGrid:function(Z,ab){this.renderer.resetGSSOCache();this.displayGrid=Z;this._updateGridDisplay();if(ab!==undefined){this.displayGridFromBelow=ab;if(this.planeV2){this.planeGrid.displayGridFromBelow=ab?1:0}}this.render()},_updateGridDisplay:function(){var Z=!this._2DMode&&this.displayGrid;if(this._displayGrid!==Z){this._displayGrid=Z;if(this.planeV2){this.planeGrid.displayGrid=Z?1:0}h.publish({event:"/WUX/AFR/CMD/VisuGrid/"+(Z?"BEGIN":"END")})}},getGridUnit:function(){if(this.planeV2&&this.planeGrid){return this.planeGrid.gridUnit}return this.gridUnit},displayInfinitePlane:function(Z,ab){this.renderer.resetGSSOCache();this.infinitePlane=Z;this.planeAttenuation=(ab!==undefined)?ab:false;this._updateInfinitePlaneDisplay()},_updateInfinitePlaneDisplay:function(){this._infinitePlane=!this._2DMode&&this.infinitePlane;if(this.planeV2){this.planeGrid.displayPlane=this._infinitePlane?1:0}if(!this._infinitePlane){!this.planeV2&&this._removeInfinitePlane(this.infPlane)}else{this.render({updateInfinitePlane:true});this.useShadowPlane=true}},setShadowPlane:function(Z){this.renderer.resetGSSOCache();this.useShadowPlane=Z;this._updateShadowPlaneDisplay()},_updateShadowPlaneDisplay:function(ab){var Z=!this._2DMode&&this.useShadowPlane;if(!Z){!this._infinitePlane&&this._removeInfinitePlane(this.infPlaneSmall)}else{this.render({updateInfinitePlane:true})}},setAutomaticPlaneUpdate:function(Z){this.ambience.setAutoGroundOffset(Z)},setPlanePositionAndScale:function(ab,Z){this.offsetPlaneBackground.copy(ab);this.offsetPlaneSmall.z=ab.z;this.ambience.updateScene(ab);this.gridUnit=Z},setGridNbSteps:function(Z){this.renderer.resetGSSOCache();this.gridNbSteps=Math.min(Math.max(Z,1),10);if(this.planeV2){this.planeGrid.setGridNbSteps(this.gridNbSteps)}else{if(!this.bigGrid){return}this._createBigGridGeometry()}},setGroundOptions:function(Z){this.renderer.resetGSSOCache();if(Z.groundCenter!==undefined){this.offsetPlaneBackground.copy(Z.groundCenter);this.offsetPlaneSmall.z=Z.groundCenter.z;this.ambience.updateScene(Z.groundCenter)}if((Z.groundSize!==undefined)&&this.planeV2){this.planeGrid.size=Z.groundSize}if(Z.groundShadow!==undefined){this.setGroundShadow(!!Z.groundShadow)}if(Z.displayPlane!==undefined){this.displayInfinitePlane(!!Z.displayPlane,Z.planeAttenuation)}if(Z.displayGrid!==undefined){this.setGrid(!!Z.displayGrid,Z.displayGridFromBelow)}else{if(Z.displayGridFromBelow!==undefined){this.setGrid(this.displayGrid,Z.displayGridFromBelow)}}if(Z.gridNbSteps!==undefined){this.setGridNbSteps(Z.gridNbSteps)}if(Z.gridLabels!==undefined){if(this.planeV2&&this.planeGrid){this.planeGrid.setLabels(Z.gridLabels)}}if(Z.gridLabelColor!==undefined){if(this.planeV2&&this.planeGrid){this.planeGrid.setLabelColor(Z.gridLabelColor)}}if(Z.gridLabelCallback!==undefined){if(this.planeV2&&this.planeGrid){this.planeGrid.setLabelCallback(Z.gridLabelCallback)}}if(Z.gridDisplayLabelCallback!==undefined){if(this.planeV2&&this.planeGrid){this.planeGrid.setDisplayLabelCallback(Z.gridDisplayLabelCallback)}}if(Z.planeMirror!==undefined){this.setMirror(!!Z.planeMirror,Z.blurryMirror)}if(Z.planeColor!==undefined){this.setPlaneColor(Z.planeColor)}if(this.planeV2&&this.planeGrid){if(Z.planeOpacity!==undefined){this.planeGrid.planeOpacity=Z.planeOpacity}if(Z.planeTexture!==undefined){this.planeGrid.planeTexture=Z.planeTexture}if(Z.planeTextureScale!==undefined){this.planeGrid.planeTextureScale=Z.planeTextureScale}if(Z.planeFalloff!==undefined){this.planeGrid.planeFalloff=Z.planeFalloff}if(Z.gridFalloff!==undefined){this.planeGrid.gridFalloff=Z.gridFalloff}if(Z.planeBorder!==undefined){this.planeGrid.planeBorder=Z.planeBorder}if(Z.planeBorderColor!==undefined){this.planeGrid.edgeColor.set(Z.planeBorderColor)}}if(Z.gridColor!==undefined){this.setGridColor(Z.gridColor)}},getGroundOptions:function(){return{groundCenter:this.offsetPlaneBackground,groundSize:this.planeGrid?this.planeGrid.size:undefined,groundShadow:this.useGroundShadow,displayPlane:this.infinitePlane,displayGrid:this.displayGrid,displayGridFromBelow:this.displayGridFromBelow,gridNbSteps:this.gridNbSteps,gridLabels:this.planeGrid?this.planeGrid.displayLabels:false,planeMirror:this.useMirror,blurryMirror:this.blurryMirror,planeColor:this.planeColor.getHexString(),gridColor:this.gridColor.getHexString(),gridFalloff:this.planeGrid?this.planeGrid.gridFalloff:undefined,planeFalloff:this.planeGrid?this.planeGrid.planeFalloff:undefined,planeBorder:this.planeGrid?this.planeGrid.planeBorder:false,planeBorderColor:this.planeGrid?this.planeGrid.edgeColor.getHexString():undefined}},_getGroundOptions:function(){return{groundCenter:this.offsetPlaneBackground,groundSize:this.planeGrid?this.planeGrid.size:undefined,groundShadow:this.useGroundShadow,displayPlane:this.infinitePlane,displayGrid:this.displayGrid,displayGridFromBelow:this.displayGridFromBelow,gridNbSteps:this.gridNbSteps,gridLabels:this.planeGrid?this.planeGrid.displayLabels:null,gridLabelCallback:this.planeGrid?this.planeGrid.labelCB:null,gridDisplayLabelCallback:this.planeGrid?this.planeGrid.displayLabelCB:null,planeMirror:this.useMirror,blurryMirror:this.blurryMirror,planeColor:"#"+this.planeColor.getHexString(),planeOpacity:this.planeGrid?this.planeGrid.planeOpacity:1,planeTexture:this.planeGrid?this.planeGrid.planeTexture:null,planeTextureScale:this.planeGrid?this.planeGrid.planeTextureScale:1,gridColor:"#"+this.gridColor.getHexString(),gridFalloff:this.planeGrid?this.planeGrid.gridFalloff:undefined,planeFalloff:this.planeGrid?this.planeGrid.planeFalloff:undefined,planeBorder:this.planeGrid?this.planeGrid.planeBorder:false,planeBorderColor:this.planeGrid?"#"+this.planeGrid.edgeColor.getHexString():undefined}},setMirror:function(Z,ad,ah,af,ac){af=(af!==undefined)?af:0.3;ac=(ac!==undefined)?ac:0.85;ad=(ad!==undefined)?ad:this.blurryMirror;this._setMirrorReflectivity(af);this.blurryMirror=ad;this.blurryMirror&&this.ambience.setGroundGlossiness(ac);var ag=ah?[ah]:["static","dynamic"];for(var ae=0;ae<ag.length;ae++){var ab=ag[ae];if(!this._qmSetMirror||this._qmSetMirror(Z,ab)){this._effectSettings.GroundReflection[ab]=Z}}},_setMirrorReflectivity:function(Z){if(this.renderer&&this.renderer.mirrorBlendPass){this.renderer.mirrorBlendPass.uniforms.reflectivity.value=Z}},_setMirror:function(Z){if(this.mobile){return}if(this.useMirror!==this._effectSettings.GroundReflection[Z]){this.renderer.resetGSSOCache();this.useMirror=this._effectSettings.GroundReflection[Z]}},setVignetting:function(Z){if(this.useVignetting!==Z){this.renderer.setEffect("Vignetting",Z);this.useVignetting=Z;this.render()}},setHighlight:function(Z){if(this.displayHighlight!==Z){this.displayHighlight=Z;this.setPicking({activated:Z,displayHL:Z});this.renderer.setEffect("Highlight",Z);this.render()}},setRenderIteration:function(Z){this.isRenderIteration=Z},lockRenderIteration:function(){this._lockRenderIteration=true},unlockRenderIteration:function(){this._lockRenderIteration=false},setAntiAliasing:function(ac,ae){var ad=ae?[ae]:["static","dynamic"];for(var ab=0;ab<ad.length;ab++){var Z=ad[ab];if(ac==="SMAA"||ac==="MLAA"||ac==="FXAA"||ac==="FSAA"||ac==="MSAA"||ac==="SSAA"){this._effectSettings.AntiAliasing[Z]=((Z==="dynamic")&&(ac==="MSAA"))?"SMAA":ac}else{if(ac==="NoAA"||ac===false){this._effectSettings.AntiAliasing[Z]="NoAA"}else{if(ac===true){this._effectSettings.AntiAliasing[Z]="SMAA"}else{if(ac==="MSMAA"){console.warn("MSMAA is deprecated");if(Z==="dynamic"){this._effectSettings.AntiAliasing[Z]="SMAA"}else{this._effectSettings.AntiAliasing[Z]="MSAA"}}}}}this._qmSetAntiAliasing&&this._qmSetAntiAliasing(this._effectSettings.AntiAliasing[Z],Z)}},_setAntiAliasing:function(Z){if(this.antiAliasing!==this._effectSettings.AntiAliasing[Z]){this.renderer.setEffect(this.antiAliasing,false);this.antiAliasing=this._effectSettings.AntiAliasing[Z];this.renderer.setEffect(this.antiAliasing,true)}},setPixelCulling:function(ae,ad){var ac=ad?[ad]:["static","dynamic"];for(var ab=0;ab<ac.length;ab++){var Z=ac[ab];this._qmSetPixelCulling&&this._qmSetPixelCulling(ae,Z);this._effectSettings.PixelCulling[Z]=ae}},_setPixelCulling:function(Z){this.currentViewpoint&&this.currentViewpoint._setPixelCulling(this._effectSettings.PixelCulling[Z])},setSSAO:function(Z,ae){var ad=ae?[ae]:["static","dynamic"];for(var ac=0;ac<ad.length;ac++){var ab=ad[ac];if(!this._qmSetSSAO||this._qmSetSSAO(Z,ab)){this._effectSettings.SSAO[ab]=Z}}},_setSSAO:function(ab){var Z=(this._effectSettings.AntiAliasing[ab]==="MSAA");this.useSSAO=this._effectSettings.SSAO[ab];this.renderer.setEffect("SSAO",this.useSSAO&&!this.useSSAOIterative);this.renderer.setEffect("SSAOIterative",this.useSSAO&&this.useSSAOIterative&&Z)},setIterativeSSAO:function(Z){this.useSSAOIterative=Z},setDOF:function(Z,ae){var ad=ae?[ae]:["static","dynamic"];for(var ac=0;ac<ad.length;ac++){var ab=ad[ac];if(!this._qmSetDOF||this._qmSetDOF(Z,ab)){this._effectSettings.DepthOfField[ab]=Z;if(Z&&!this.getEffect("DOF")){this.renderer.setEffect("DOF",true);this.renderer.setEffect("DOF",false)}}}},setIterativeDOF:function(Z){this.useDOFIterative=Z},_setDOF:function(ac){if(this.useDOF!==this._effectSettings.DepthOfField[ac]){this.useDOF=this._effectSettings.DepthOfField[ac];this.renderer.setEffect("DOF",this.useDOF)}if(ac==="static"){var ab=(this._effectSettings.AntiAliasing[ac]==="MSAA");var Z=this.getEffect("DOF");Z&&Z.setIterative(this.useDOFIterative&&ab)}},setBloom:function(Z,ae){var ad=ae?[ae]:["static","dynamic"];for(var ac=0;ac<ad.length;ac++){var ab=ad[ac];if(!this._qmSetBloom||this._qmSetBloom(Z,ab)){this._effectSettings.Bloom[ab]=Z}}},_setBloom:function(Z){if(this.useBloom!==this._effectSettings.Bloom[Z]){this.useBloom=this._effectSettings.Bloom[Z];this.renderer.setEffect("Bloom",this.useBloom)}},setScanIntensity:function(Z){if(this.internalSceneGraph&&this.internalSceneGraph.selectionHL&&this.internalSceneGraph.selectionHL.colorHighlight){this.internalSceneGraph.selectionHL.colorHighlight.intensity=Z}},setPreHighlightColor:function(ab,Z){var ae,ad,ac=this.getEffect("PreHighlight");if(ac){if(ab instanceof M.Color){ae=new M.Vector4(ab.r,ab.g,ab.b,1)}if(Z instanceof M.Color){ad=new M.Vector4(Z.r,Z.g,Z.b,1)}ac.setColor(ae,ad)}},getEffect:function(Z){var ab=null;switch(Z){case"ToneMapping":case"Bloom":ab=this.renderer.ToneMappingEffect;break;case"DOF":ab=this.renderer.BokehDOFEffect;break;case"SSLR":ab=this.renderer.SSLREffect;break;case"SSAO":ab=this.renderer.SSAOEffect;break;case"SSAOIterative":ab=this.renderer.SSAOIterativeEffect;break;case"PreHighlight":ab=this.renderer.PreHighlightEffect;break;case"Highlight":ab=this.renderer.HighlightEffect;break;default:break}return ab},setFlare:function(Z){if(this.useFlare!==Z){this.renderer.setEffect("Flare",Z);this.useFlare=Z;this.render()}},setMagnifier:function(Z){if(!Z.viewer){Z.viewer=this}if(this.magnifier===null){this.magnifier=new n(Z)}else{this.magnifier.setOption(Z)}if(!this.pPicking.activated){this.setPrePicking({activated:true,displayHL:false,gpu:false,computeNormalDepth:true,})}},setFillXSOMode:function(Z){this._fillXSOMode=Z},setPicking:function(ab,ad){if(typeof(ab)==="boolean"){console.log("boolean is DEPRECATED in setPicking() method.\n Use object instead.")}if(ab.activated!==undefined){this.picking.activated=ab.activated}var ac=function(ae){if(window.enableNewTrapSelection){console.log("WebGLViewer: new trap selection mode is ON!");if(ae){if(!this.trapSelectionManipulator){this.trapSelectionManipulator=new G(this);this.trapSelectionManipulator._linkToViewer()}this.trapSelectionManipulator.enable();this.trapSelectionManipulator.setAdvanced(ae==="advanced")}else{if(this.trapSelectionManipulator){this.trapSelectionManipulator.disable()}}}else{if(!this.trapSelection){this.trapSelection=new C(this)}this.trapSelection.set(ae)}};if(ab.contextPick!==undefined){this.picking.contextPick=ab.contextPick}if(ab.trapSelection!==undefined){this.picking.trapSelection=ab.trapSelection;ac.call(this,ab.trapSelection)}if(ab.trapSelectionMesh!==undefined){this.picking.trapSelectionMesh=ab.trapSelectionMesh;this.picking.trapSelection=ab.trapSelectionMesh;ac.call(this,ab.trapSelectionMesh)}if(ab.displayHL!==undefined){this.picking.displayHL=ab.displayHL}if(ab.gpu!==undefined){this.picking.gpu=ab.gpu}if(ab.computeNormalDepth!==undefined){this.picking.computeNormalDepth=ab.computeNormalDepth}if(ab.primitive!==undefined){this.picking.primitive=ab.primitive}if(ab.pickingTolerance!==undefined){this.renderer.gpuPickingTolerance=ab.pickingTolerance;this.picking.tolerance=ab.pickingTolerance}if(this.renderer){this.renderer.setEffect("Highlight",this.picking.activated&&this.picking.displayHL)}var Z=true;if(ad!==undefined){Z=ad}this.setDefaultPicking(Z)},setPrePicking:function(ab,ac){if(ab.activated!==undefined){this.pPicking.activated=ab.activated}if(ab.trapSelection!==undefined){this.pPicking.trapSelection=ab.trapSelection}if(ab.displayHL!==undefined){this.pPicking.displayHL=ab.displayHL}if(ab.gpu!==undefined){this.pPicking.gpu=ab.gpu}if(ab.computeNormalDepth!==undefined){this.pPicking.computeNormalDepth=ab.computeNormalDepth}if(ab.primitive!==undefined){this.pPicking.primitive=ab.primitive}if(ab.disableWhileMoving!==undefined){this.pPicking.disableWhileMoving=ab.disableWhileMoving}if(this.renderer){this.renderer.setEffect("PreHighlight",this.pPicking.activated&&this.pPicking.displayHL)}var Z=true;if(ac!==undefined){Z=ac}this.setDefaultPicking(Z)},setPickingGPU:function(Z){if(this.picking.gpu!==Z){this.picking.gpu=Z}},setSmallRenderTargetPicking:function(Z){if(this.renderer.smallTargetPicking!==Z){this.renderer.smallTargetPicking=Z}},setIntensityCorrection:function(Z){if(M.intensityCorrection!==Z){M.intensityCorrection=Z;if(Z){if(this.directionalLight){this.directionalLight.intensity*=this.directionalLight.intensity}if(this.directionalLight2){this.directionalLight2.intensity*=this.directionalLight2.intensity}if(this.directionalLight3){this.directionalLight3.intensity*=this.directionalLight3.intensity}}else{if(this.directionalLight){this.directionalLight.intensity=Math.sqrt(this.directionalLight.intensity)}if(this.directionalLight2){this.directionalLight2.intensity=Math.sqrt(this.directionalLight2.intensity)}if(this.directionalLight3){this.directionalLight3.intensity=Math.sqrt(this.directionalLight3.intensity)}}}},activateNoMeshInRAM:function(Z){console.warn("DEPRECATED: noMeshInRAM should be activated on the modelLoader")},setManipulators:function(Z){if(!this.manipulatorManager){return false}if(Z.activated!==undefined){this.manipulatorManager.setActivate(Z.activated)}if(Z.preActivate!==undefined){this.manipulatorManager.setPreActivate(Z.preActivate)}},getManipulators:function(){if(!this.manipulatorManager){return false}return this.manipulatorManager.getActivate()},setOverrideCursors:function(Z){this.overrideCursors=Z},getCursor:function(){return this.canvas.style.cursor},setCursor:function(ae,Z,ab){if(!this.overrideCursors){return}var ah=this;var af=["auto","-webkit-grabbing","pointer"];var ac="auto";if(af.indexOf(ae)!==-1){ac=ae}else{if(ae!=="Auto"){if(ab){ac=ae}else{var ag=J.getWebappsAssetUrl("Visualization","")+"icons/";ac="url('"+ag+"WebViewer"+ae+".png'), url('"+ag+"WebViewer"+ae+".cur'), auto"}}}if(this._changeCursorDelay){clearTimeout(this._changeCursorDelay);this._changeCursorDelay=null}var ad=function(ai){ah.canvas.style.cursor=ai};if(Z>0){this._changeCursorDelay=setTimeout(function(){ad(ac)},Z)}else{ad(ac)}},setTemporaryCursor:function(ac){var Z=this._temporaryCursorData;if(!Z){var ab=this.getCursor()||null;Z={oldCursor:ab};this._temporaryCursorData=Z;this.setCursor(ac)}},unsetTemporaryCursor:function(){var Z=this._temporaryCursorData;if(Z){var ab=Z.oldCursor||"auto";this.setCursor(ab,0,true);this._temporaryCursorData=null}},setForceMultiSelection:function(Z){this.forceMultiSel=Z},setForcePickingFaces:function(Z){if(this.renderer.renderer){this.renderer.renderer.pickFacesMode=Z?1:2}},setForcePickingLines:function(Z){if(this.renderer.renderer){this.renderer.renderer.pickLinesMode=Z?1:2}},setForcePickingPoints:function(Z){if(this.renderer.renderer){this.renderer.renderer.pickPointsMode=Z?1:2}},setFacePickingMode:function(Z){if(Z!==this.renderer.renderer.pickFacesMode){this.renderer.renderer.pickFacesMode=Z;this.invalidatePickingBuffer()}},setLinePickingMode:function(Z){if(Z!==this.renderer.renderer.pickLinesMode){this.renderer.renderer.pickLinesMode=Z;this.invalidatePickingBuffer()}},setPointPickingMode:function(Z){if(Z!==this.renderer.renderer.pickPointsMode){this.renderer.renderer.pickPointsMode=Z;this.invalidatePickingBuffer()}},setDebugPostProcessing:function(Z){if(this.debugPostProcessing!==Z){this.renderer.setEffect("DebugPass",Z);this.debugPostProcessing=Z;this.render()}},showPerfo:function(ad,ac,ab,Z,ae){if(ad&&!this._glFPSCounter){var af=this;require(["DS/VisuTools/FPSCounter"],function(ag){if(ae){ag.setAutoRefresh(false)}af._glFPSCounter=ag;af._glFPSCounter.setActivated(af,true,ab);window.webVisuPerfo.setEnabled(ac?true:false);if(Z){Z()}})}else{if(this._glFPSCounter){this._glFPSCounter.setActivated(this,ad,ab);window.webVisuPerfo.setEnabled(ac?true:false)}}},showInfos:function(ab,Z){if(ab&&!this._glInfoCounter){var ac=this;require(["DS/VisuTools/InfoCounter"],function(ad){ac._glInfoCounter=new ad(ac,Z)})}else{if(this._glInfoCounter){this._glInfoCounter.activate(ab)}}},showNodeCounter:function(ab,Z){if(ab&&!this._glNodeCounter){var ac=this;require(["DS/VisuTools/NodeCounter"],function(ad){ac._glNodeCounter=new ad(ac,Z)})}else{if(this._glNodeCounter){this._glNodeCounter.activate(ab)}}},setDebugFPS:function(Z,ac){this.debugFPS=Z;this.debugFPSInfos.fpsLastTime=performance.now();this.debugFPSInfos.fpsWindow=ac||40;this.debugFPSInfos.fpsIndex=0;this.debugFPSInfos.fpsCumul=30*this.debugFPSInfos.fpsWindow;this.debugFPSInfos.fpsValue=30;this.debugFPSInfos.fpsArray=[];for(var ab=0;ab<this.debugFPSInfos.fpsWindow;ab++){this.debugFPSInfos.fpsArray[ab]=30}if(Z){if(!this.debugFPSInfos.fpsCounter){this.debugFPSInfos.fpsCounter=new UWA.Element("div",{html:"FPS",styles:{fontFamily:"arial, sans-serif",fontSize:"20px",position:"absolute",top:"20px",right:"10px",textAlign:"left",verticalAlign:"middle",backgroundColor:"#333",color:"white"}});this.div.appendChild(this.debugFPSInfos.fpsCounter)}else{this.debugFPSInfos.fpsCounter.show()}}else{this.debugFPSInfos.fpsCounter&&this.debugFPSInfos.fpsCounter.hide()}},setDebugShadowMaps:function(Z){if(this.debugShadowMaps!==Z){this.renderer.setEffect("DebugShadowMaps",Z);this.debugShadowMaps=Z;this.render()}},setDebugEvents:function(Z){this.debugEvents=Z;B.setDebugEvents(Z)},getDisplayFaces:function(){return this.renderer.renderer.renderFaces},getDisplayLines:function(){return this.renderer.renderer.renderLineMode!==M.HideAllRenderLineMode},getDisplayPoints:function(){return this.renderer.renderer.renderPoints},getShadow:function(){return this.useShadowMap},getOIT:function(){return this.useOIT},getGrid:function(){return this.displayGrid},getInfinitePlane:function(){return this.infinitePlane},getMirror:function(){return this.useMirror},createInfinitePlane:function(ad,ag,aj,ah){var af,ae,ai,ab,ac=(this.internalSceneGraph===null)?this.temporaryEmptyScene:this.internalSceneGraph.scene;if(ad!==null){ad.visible=true;ad.visibilityFree=true;ad.position.set(ah.x-0.5*aj,ah.y-0.5*aj,ah.z);ad.scale.set(aj,aj,1);if((ag===1)&&ad.material){ad.material.uniforms.diffuse.value.copyGammaToLinear(this.planeColor);ad.material.uniforms.border.value.copy(this.ambience.getBackgroundColor());ad.material.uniforms.attenuation.value=this.planeAttenuation?1:0}ad.updateMatrix();return}if(ag===1){ae=this.mobile?M.InfinitePlaneShaderSimple:M.InfinitePlaneShader;ai={defines:{},fragmentShader:(!this.mobile&&this.triLights)?ae.fragmentShaderFirstDirOnly:ae.fragmentShader,vertexShader:ae.vertexShader,uniforms:ae.uniforms};ab=new M.ShaderMaterial(ai);ab.lights=!this.mobile;ab.useBlending=true;ab.depthTest=false;ab.depthWrite=false;ab.side=M.DoubleSide;ab.force=true;ab.uniforms.ambient.value.copyGammaToLinear(new M.Color(328965));ab.uniforms.diffuse.value.copyGammaToLinear(this.planeColor);ab.uniforms.border.value.copy(this.ambience.getBackgroundColor());ab.uniforms.attenuation.value=this.planeAttenuation?1:0;var Z=P.createRectangleNode({width:1,height:1,fill:true,noEdge:true,material:ab});this.infPlane=Z._occurrences[0].renderable;ad=this.infPlane;ad.receiveShadow=false;ad.renderDepth=1;this.sceneBackground.add(ad)}else{if(ag===0){ae=M.SmallPlaneShader;ai={defines:{},fragmentShader:ae.fragmentShader,vertexShader:ae.vertexShader,uniforms:ae.uniforms};ab=new M.ShaderMaterial(ai);ab.lights=true;ab.useBlending=true;ab.blending=M.MultiplyBlending;ab.depthWrite=false;ab.side=M.DoubleSide;ab.force=true;ab.polygonOffset=true;ab.polygonOffsetFactor=2;ab.polygonOffsetUnits=1;ab.enableClipPlanes=false;ab.updateDeferredMaterials();ab._deferredMaterials[M.MaterialToUse.pickingMaterial].depthWrite=false;this.dirLightGroundShadow.groundMaterial=ab;var Z=P.createRectangleNode({width:1,height:1,fill:true,noEdge:true,material:ab});this.infPlaneSmall=Z._occurrences[0].renderable;ad=this.infPlaneSmall;ad.receiveShadow=true;ad.castShadow=false;ad.renderDepth=-Number.MAX_VALUE;ac.add(ad)}}ad.pickable=false;ad.frustumCulled=false;ad.visibilityFree=true;ad.position.set(ah.x-0.5*aj,ah.y-0.5*aj,ah.z);ad.scale.set(aj,aj,1);ad.updateMatrix()},_removeInfinitePlane:function(Z){if((Z!==null)&&Z.visible){Z.visible=false;this.render()}},createGrid:function(ah,ar,ag,ao,ad){ao=Math.pow(Math.max(0,ao),0.4);var aA=this.mobile;var av,aD,ay,aH,aF,at,aC,am,ac,aG,af=function(aM){var aL=Math.tan(0.125*Math.PI);aL*=aM/ah;return Math.ceil(100*aL)},ae=function(aO){var aN=0.25*aO;var aP=0.0002;var aM=0;while(aP<aN){var aL=aM%3;switch(aL){case 0:aP*=2;break;case 1:aP*=2.5;break;case 2:aP*=2;break}aM++}return aP};av=af(ag);aD=this.ambience.isAutoGroundOffset()?ae(ah*av):ah;if(this.grid!==null){this.grid.visibilityFree=true;this.grid.material.uniforms.diffuse.value.copyGammaToLinear(this.gridColor)}if(this.bigGrid!==null){this.bigGrid.visibilityFree=true;this.bigGrid.material.uniforms.diffuse.value.copyGammaToLinear(this.gridColor)}this.gridSize=aD;this.gridUnit=aD*this.gridStep;var an=new M.Vector3(0,0,ar.z);an.x=(this.gridNbSteps*this.gridUnit)*Math.floor(ar.x/(this.gridNbSteps*this.gridUnit));an.y=(this.gridNbSteps*this.gridUnit)*Math.floor(ar.y/(this.gridNbSteps*this.gridUnit));if(this.grid!==null){this.grid.scale.set(aD,aD,1);if(aA){this.grid.position.set(an.x-0.5*aD,an.y-0.5*aD,an.z)}else{this.grid.position.set(an.x,an.y,an.z)}this.grid.visibilityFree=true;this.grid.updateMatrix();this.grid.material.uniforms.gridSize.value=ah;this.grid.material.uniforms.attenuation.value=ao;this.grid.visible=true;this.grid._distanceToCameraForLargeScale=ag/this.grid.worldRadius;this.grid._computeLargeScaleStatus();if(this.bigGrid!==null){this.bigGrid.scale.set(aD,aD,1);this.bigGrid.position.set(an.x,an.y,an.z);this.bigGrid.visibilityFree=true;this.bigGrid.updateMatrix();this.bigGrid.material.uniforms.gridSize.value=ah;this.bigGrid.material.uniforms.attenuation.value=ao;this.bigGrid.visible=true;this.bigGrid._distanceToCameraForLargeScale=ag/this.bigGrid.worldRadius;this.bigGrid._computeLargeScaleStatus()}return true}aH=aA?M.TexturedGridShader:M.GridShader;aF={fragmentShader:aH.fragmentShader,vertexShader:aH.vertexShader,uniforms:M.UniformsUtils.clone(aH.uniforms)};var aq;at=new M.ShaderMaterial(aF);if(aA){var aI=J.getWebappsAssetUrl("Visualization","");aq=new M.ImageUtils.loadTexture(aI+"grid512.png",undefined,null,null,M.ImageUtils.crossOriginPolicy);aq.wrapS=M.RepeatWrapping;aq.wrapT=M.RepeatWrapping;aq.anisotropy=8;at.map=aq;at.uniforms.map.value=aq;at.uniforms.repeatBumpMap.value=new M.Vector2(0.2/this.gridStep,0.2/this.gridStep)}else{at.lights=true}at.useBlending=true;at.depthTest=false;at.force=true;at.uniforms.gridSize.value=ah;at.uniforms.attenuation.value=ao;if(aA){var aK=P.createRectangleNode({width:1,height:1,fill:true,noEdge:true,material:at});this.grid=aK._occurrences[0].renderable;this.grid.frustumCulled=false}else{var az=new q.PrimitiveGroup();var ai=2/this.gridStep;var ab=6*ai;var Z=8*ai;var aw=new q.Buffer({component:q.VertexComponentEnum.POSITION,data:new Float32Array(3*ab)});var au=new Uint16Array(Z);var aE=new q.Buffer({indexBuffer:true,data:au});az.addBuffer(0,aw);az.addBuffer(1,aE);var ap=0,aj=0;var ak=aw.data;var aB=aE.data;for(aG=0;aG<ai;aG++){ak[ap++]=aG*this.gridStep-1;ak[ap++]=-1;ak[ap++]=0;ak[ap++]=aG*this.gridStep-1;ak[ap++]=0;ak[ap++]=0;ak[ap++]=aG*this.gridStep-1;ak[ap++]=1;ak[ap++]=0;ak[ap++]=-1;ak[ap++]=aG*this.gridStep-1;ak[ap++]=0;ak[ap++]=0;ak[ap++]=aG*this.gridStep-1;ak[ap++]=0;ak[ap++]=1;ak[ap++]=aG*this.gridStep-1;ak[ap++]=0}for(aG=0;aG<4*ai;aG++){aB[aj++]=3*aG;aB[aj++]=3*aG+1;aB[aj++]=3*aG+1;aB[aj++]=3*aG+2}var al=new q.Primitive({nbIndices:Z,connectivity:q.ConnectivityTypeEnum.LINES,fillGAS:new q.FillAttributes(new q.Color(0.2,0.2,0.2,1))});var aJ=new q.VertexComponent({nbVertices:ab,bufferId:0,indices:new q.IndexArray({bufferId:1,offset:0})});al.addVertexComponent(aJ);az.addPrimitive(al);var ax=P.createMeshNode(az,at);this.grid=ax._occurrences[0].renderable;this.grid.frustumCulled=false}this.grid.pickable=false;this.grid.receiveShadow=true;this.grid.renderDepth=0;this.grid.visibilityFree=true;this.sceneBackground.add(this.grid);if(aA){}else{this._createBigGridGeometry();this.bigGrid.scale.set(aD,aD,1);this.bigGrid.position.set(an.x,an.y,an.z);this.bigGrid.updateMatrix();this.bigGrid.material.uniforms.gridSize.value=ah;this.bigGrid.material.uniforms.attenuation.value=ao;this.bigGrid.material.uniforms.diffuse.value.copyGammaToLinear(this.gridColor);this.bigGrid._distanceToCameraForLargeScale=ag/this.bigGrid.worldRadius;this.bigGrid._computeLargeScaleStatus()}this.grid.scale.set(aD,aD,1);if(aA){this.grid.position.set(an.x-0.5*aD,an.y-0.5*aD,an.z)}else{this.grid.position.set(an.x,an.y,an.z)}this.grid.updateMatrix();this.grid.material.uniforms.diffuse.value.copyGammaToLinear(this.gridColor);this.grid._distanceToCameraForLargeScale=ag/this.grid.worldRadius;this.grid._computeLargeScaleStatus();return true},_createBigGridGeometry:function(){if(this.bigGrid){this.sceneBackground.remove(this.bigGrid)}var Z=M.BigGridShader;var ai={fragmentShader:Z.fragmentShader,vertexShader:Z.vertexShader,uniforms:M.UniformsUtils.clone(Z.uniforms)};var aq=new M.ShaderMaterial(ai);aq.useBlending=true;aq.lights=true;aq.side=M.DoubleSide;aq.depthTest=false;aq.force=true;var ax=this.gridNbSteps*this.gridStep;var ac=0.02*this.gridStep;var aj=new q.PrimitiveGroup();var ay=2/this.gridStep;var ae=12*ay;var ad=24*ay;var at=new q.Buffer({component:q.VertexComponentEnum.POSITION,data:new Float32Array(3*ae)});var an=new q.Buffer({component:q.VertexComponentEnum.NORMAL,data:new Float32Array(3)});var ab=new q.Buffer({indexBuffer:true,data:new Uint16Array(ad)});var ap=new q.Buffer({indexBuffer:true,data:new Uint16Array(ad)});aj.addBuffer(0,at);aj.addBuffer(1,an);aj.addBuffer(2,ab);aj.addBuffer(3,ap);var aA=0,ak=0,am=0;var al=at.data;var ag=ab.data;var av=an.data;var ah=ap.data;av[0]=0;av[1]=0;av[2]=1;for(var az=0;az<ay;az++){al[aA++]=az*ax-1-ac;al[aA++]=-1;al[aA++]=0;al[aA++]=az*ax-1-ac;al[aA++]=0;al[aA++]=0;al[aA++]=az*ax-1-ac;al[aA++]=1;al[aA++]=0;al[aA++]=az*ax-1+ac;al[aA++]=1;al[aA++]=0;al[aA++]=az*ax-1+ac;al[aA++]=0;al[aA++]=0;al[aA++]=az*ax-1+ac;al[aA++]=-1;al[aA++]=0;al[aA++]=-1;al[aA++]=az*ax-1-ac;al[aA++]=0;al[aA++]=0;al[aA++]=az*ax-1-ac;al[aA++]=0;al[aA++]=1;al[aA++]=az*ax-1-ac;al[aA++]=0;al[aA++]=1;al[aA++]=az*ax-1+ac;al[aA++]=0;al[aA++]=0;al[aA++]=az*ax-1+ac;al[aA++]=0;al[aA++]=-1;al[aA++]=az*ax-1+ac;al[aA++]=0}for(var az=0;az<24*ay;az++){ah[am++]=0}var af=0;for(var az=0;az<ay;az++){ag[ak++]=af;ag[ak++]=af+4;ag[ak++]=af+1;ag[ak++]=af;ag[ak++]=af+5;ag[ak++]=af+4;ag[ak++]=af+1;ag[ak++]=af+3;ag[ak++]=af+2;ag[ak++]=af+1;ag[ak++]=af+4;ag[ak++]=af+3;af+=6;ag[ak++]=af;ag[ak++]=af+1;ag[ak++]=af+4;ag[ak++]=af;ag[ak++]=af+4;ag[ak++]=af+5;ag[ak++]=af+1;ag[ak++]=af+2;ag[ak++]=af+3;ag[ak++]=af+1;ag[ak++]=af+3;ag[ak++]=af+4;af+=6}var au=new q.Primitive({nbIndices:ad,connectivity:q.ConnectivityTypeEnum.TRIANGLES,fillGAS:new q.FillAttributes(new q.Color(0.2,0.2,0.2,1))});var ao=new q.VertexComponent({nbVertices:ae,bufferId:0,indices:new q.IndexArray({bufferId:2,offset:0})});var aw=new q.VertexComponent({nbVertices:1,bufferId:1,indices:new q.IndexArray({bufferId:3,offset:0})});au.addVertexComponent(ao);au.addVertexComponent(aw);aj.addPrimitive(au);var ar=P.createMeshNode(aj,aq);this.bigGrid=ar._occurrences[0].renderable;this.bigGrid.frustumCulled=false;this.bigGrid.visibilityFree=true;this.bigGrid.pickable=false;this.bigGrid.receiveShadow=true;this.bigGrid.renderDepth=0;this.sceneBackground.add(this.bigGrid)},_removeGrid:function(){var Z=false;if(this.grid!==null){this.grid.visible=false;Z=true}if(this.bigGrid!==null){this.bigGrid.visible=false;Z=true}return Z},setAmbientLight:function(Z){if(typeof(Z)==="number"||typeof(Z)==="string"){this.ambientLight.color=new M.Color(Z)}else{if(Z){this.ambientLight.color=Z}}},setDirectionalLight:function(ag,af,ac,Z){this.renderer.resetGSSOCache();this.autoUpdateLights=false;this.dirLightLatitude=ag;var ab=this.directionalLight,ae=(this.internalSceneGraph===null)?100:this.internalSceneGraph.getBoundingSphere().radius,ad=(this.internalSceneGraph===null)?new M.Vector3(0,0,0):this.internalSceneGraph.getBoundingSphere().center;this.dirLightVector.set(Math.sin(Math.PI*ag)*Math.cos(2*Math.PI*af),Math.sin(Math.PI*ag)*Math.sin(2*Math.PI*af),Math.cos(Math.PI*ag));if(this.useDefaultLights){ab.position=new M.Vector3().copy(this.dirLightVector).multiplyScalar(2*ae).add(ad);ab.lookAt(ad);ab.target.position=ad;ab.target.updateMatrixWorld();if(typeof(ac)==="number"||typeof(ac)==="string"){ab.color=new M.Color(ac)}else{if(ac){ab.color=ac}}ab.intensity=Z;ab.updateShadowMap=true}this.renderer.resetClippingScene();this.render()},setLightParameters:function(af){var ad=[this.directionalLight,this.directionalLight2,this.directionalLight3];var ae=[this.dirLightVector,this.dirLight2Vector,this.dirLight3Vector];var ac=af.lightIndex?af.lightIndex:0;var ab=ad[ac];var Z=ae[ac];if(!ab){return false}this.autoUpdateLights=false;if(af.color){ab.color=new M.Color(af.color)}if(af.intensity!==undefined){ab.intensity=af.intensity}if(af.direction){Z.copy(af.direction);if(ac===0){ab.updateShadowMap=true}}if(af.directionType){this.dirLightType[ac]=(af.directionType==="camera");if(ac===0){ab.updateShadowMap=true}}this.render();return true},setAutoUpdateLights:function(Z){this.renderer.resetGSSOCache();this.autoUpdateLights=Z},setLightOnViewpoint:function(Z){this.renderer.resetGSSOCache();this.dirLightType[0]=Z},setToneMapping:function(ac){var Z=this.renderer.ToneMappingEffect;if(!Z){return}var ab=true;if(ac.gamma!==undefined){Z.setGamma(ac.gamma);ab=(ac.gamma===2)}if(ac.enable!==undefined){if(ac.enable){Z.setToneMapping(ab?1:2)}else{Z.setToneMapping(0)}}},setV6Ambience:function(){var Z=(window.__karma__&&!this.ODTMode)?"V6":"None";this.setVisuEnv(Z)},getVisuEnv:function(){return this.visuEnv},setVisuEnv:function(ai){this.renderer.resetGSSOCache();this.setGradientBackground();var Z="SMAA";var ag=true;var al=null;if(r&&r.effects){al=r.effects}switch(ai){case"None":if(this.ODTMode&&al&&!al.force){this.setGrid(false);this.displayInfinitePlane(false);this.setShadowPlane(false);this.setBackgroundColor(14414586);this.setSSAO(false);this.setShadow(false);this.setMirror(false,false);ag=false;break}var an=false;var aj=false;var ab=false;var ac=false;var ah=false;var ad=new M.Color();var ao=new M.Color();var am=new M.Color();if(al){var af=al.BackgroundColor;if(al.AntiAliasing==="false"){Z="NoAA"}an=(al.Plane!=="false");aj=(al.Grid!=="false");ab=(al.Mirror!=="false");ac=(al.Shadow!=="false");ah=(al.SSAO!=="false");if(af){ad.r=(af.red!==undefined)?af.red:1;ad.g=(af.green!==undefined)?af.green:1;ad.b=(af.blue!==undefined)?af.blue:1}}this.setGrid(aj);this.displayInfinitePlane(an);this.setShadowPlane(an);var ae=Math.min(Math.max(0,0.2126*ad.r+0.7152*ad.g+0.0722*ad.b),1);var ak=ae>=0.5?0:1;ao.r=0.4*ak+0.6*ad.r;ao.g=0.4*ak+0.6*ad.g;ao.b=0.4*ak+0.6*ad.b;am.r=0.05*ak+0.95*ad.r;am.g=0.05*ak+0.95*ad.g;am.b=0.05*ak+0.95*ad.b;this.setBackgroundColor(ad.getHex());this.setPlaneColor(am.getHex());this.setGridColor(ao.getHex());this.setSSAO(ah);this.setShadow(ac);this.setMirror(ab,true);break;case"V6":this.setGrid(true);this.displayInfinitePlane(true,false);this.setBackgroundColor(15527148);this.setPlaneColor(16514043);this.setGridColor(13421772);this.setSSAO(true);this.setShadow(true);this.setMirror(true,true);break;case"CleanSpace":this.setGrid(false);this.displayInfinitePlane(true,false);this.setBackgroundColor(15527148);this.setPlaneColor(16514043);this.setSSAO(true);this.setShadow(false);this.setMirror(false,false);break;case"DarkBlue":this.setGrid(true);this.displayInfinitePlane(false);this.setBackgroundColor(3958400);this.setGradientBackground([6728399,3958400,1848912]);this.setGridColor(8362924);this.setSSAO(false);this.setShadow(false);this.setMirror(false,false);break;case"DarkGrey":this.setGrid(true);this.displayInfinitePlane(true,false);this.setBackgroundColor(3881787);this.setPlaneColor(2960685);this.setGridColor(7303023);this.setSSAO(false);this.setShadow(false);this.setMirror(false,false);break;case"Shiny":this.setGrid(false);this.displayInfinitePlane(true,true);this.setBackgroundColor(1118481);this.setGradientBackground([6710886,2105376,0]);this.setPlaneColor(6710886);this.setSSAO(true);this.setShadow(true);this.setMirror(true,true);break;case"Studio":this.setGrid(false);this.displayInfinitePlane(false);this.setBackgroundColor(15527148);this.setGradientBackground([7497556,15131615,9668981]);this.setPlaneColor(16119027);this.setSSAO(true);this.setShadow(false);this.setMirror(true,true);break;default:return}this.visuEnv=ai;this.ODTMode&&this.setAntiAliasing(Z);this.setTriLights(ag);if(!this.triLights){this.setSecondaryLightColor(15527148);this.setDirectionalLight(0.34,0.16,16777215,0.95)}else{this.dirLightLatitude=0.34}},setTriLights:function(ad){if(ad===this.triLights){return}this.triLights=ad;var ae=this.directionalLight;var ac=this.directionalLight2;var ab=this.directionalLight3;if(ad){if(ae){ae.intensity=M.intensityCorrection?0.49:0.7;ae.shadowDarkness=0.3}if(ac){ac.intensity=M.intensityCorrection?0.49:0.7;ac.color=new M.Color(16777215)}if(!ab){if(M.intensityCorrection){this.directionalLight3=new M.DirectionalLight(16777215,0.49)}else{this.directionalLight3=new M.DirectionalLight(16777215,0.7)}ab=this.directionalLight3}ab.position.set(40,-40,40);ab.target=new M.Object3D();this.internalSceneGraph&&this.internalSceneGraph.scene.add(ab)}else{if(ae){ae.intensity=M.intensityCorrection?0.81:0.9;ae.shadowDarkness=0.65}if(ac){ac.intensity=1;ac.color=new M.Color(3827071)}if(ab){this.internalSceneGraph&&this.internalSceneGraph.scene.remove(ab)}}if(this.infPlane&&this.infPlane.material){var af=this.mobile?M.InfinitePlaneShaderSimple:M.InfinitePlaneShader;var Z=(!this.mobile&&ad)?af.fragmentShaderFirstDirOnly:af.fragmentShader;this.infPlane.material.fragmentShader=Z;this.infPlane.material.needsUpdate=true}},setLightProbe:function(Z){if(Z===null){if(this.probeLight!==null){this.internalSceneGraph.scene.remove(this.probeLight);this.renderer.recompileAllShaders()}return}M.ImageUtils.computeSphericalHarmonics(Z);if(this.probeLight===null){this.probeLight=new M.ProbeLight(Z)}else{this.probeLight.envMap=Z}this.internalSceneGraph.scene.add(this.probeLight);this.renderer.recompileAllShaders()},showEnvMap:function(ab){this.renderer.resetGSSOCache();var Z=this.ambience.getBackground();if(Z.isActivated()===ab){return}if(ab){if(Z.withImage()||Z.hasGradient()){Z.setActivated(ab)}}else{Z.setActivated(ab)}},setEnvMap:function(ae,ab,ah){this.renderer.resetGSSOCache();if(ab===2){console.warn("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation.");var ag=this;var af=0;var ad=(ae.length===2)?ae[0]:null;var ac=(ae.length===2)?ae[1]:null;if(!ad){ad=M.ImageUtils.loadHDRTexture(ae+".hdr",new M.LatLongReflectionMapping())}ad.minFilter=M.NearestFilter;ad.magFilter=M.NearestFilter;ad.wrapS=M.RepeatWrapping;ad.wrapT=M.RepeatWrapping;if(!ac){ac=M.ImageUtils.loadHDRTexture(ae+"_rmips.hdr",new M.LatLongReflectionMapping())}ac.minFilter=M.NearestFilter;ac.magFilter=M.NearestFilter;ac.wrapS=M.RepeatWrapping;ac.wrapT=M.RepeatWrapping;var Z=function(){af++;if(af===2){ag.internalSceneGraph.scene.envMipMap[0]=ad;ag.internalSceneGraph.scene.envMipMap[1]=ac;if(ag.internalSceneGraph.scene.envMipMapID){ag.renderer.renderer.ambianceGenerators.decreaseUseCount(ag.internalSceneGraph.scene.envMipMapID);ag.internalSceneGraph.scene.envMipMapID=null}ag.render();ah&&ah()}};ad&&ad.onLoadCallbacks.push(Z);ac&&ac.onLoadCallbacks.push(Z);return ad}if(ae===null){console.warn("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation.");return}if(!ae.length&&!(ae instanceof M.Texture)){this._setEnvMap(ae);return}console.warn("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation.");if(ae.length===2){this.ambience.setBackGroundMap({texture:ae[0]});this.ambience.setRoughnessMap({texture:ae[1]})}else{this.ambience.setBackGroundMap({texture:ae})}},_setSphereEnv:function(Z){if(Z){this.sphereEnv=Z;this.sceneBackground.add(Z)}},_setPhysicalGround:function(Z){if(Z){this.ground=Z;this.sceneBackground.add(Z)}},_setEnvMap:function(ac){var af=this;var ag=null;var aj=null;var ab=null;var ai=undefined;var ae=undefined;var Z=0;var ad=0;var al=function(){ad++;if(ad===Z){ac.doneCallback&&ac.doneCallback()}};if(ac.roughnessMap instanceof M.Texture){Z++;this.ambience.setRoughnessMap({texture:ac.roughnessMap,doneCallback:al});ae=true}else{if(ac.roughnessMap===null){ae=null}}var ah=false;if(ac.IBLMap){if(ac.IBLMap instanceof M.Texture){Z++;this.ambience.setIblMap({texture:ac.IBLMap,doneCallback:al})}else{if(ac.IBLMap!==""){var ak=(o.getExtension(ac.IBLMap)==="dds");Z++;if(ak){this.ambience.setReflectionMap({url:ac.IBLMap,doneCallback:al})}else{this.ambience.setIblMap({url:ac.IBLMap+".hdr",mapping:new M.LatLongReflectionMapping(),hdr:true,doneCallback:al})}if(!ae&&!ak){Z++;this.ambience.setRoughnessMap({url:ac.IBLMap+"_rmips.hdr",doneCallback:al})}}}}else{if(ac.IBLMap===null){ai=null;ae=null}}if(ac.envMap){if(ac.envMap instanceof M.Texture){Z++;this.ambience.setBackGroundMap({texture:ac.envMap,doneCallback:al})}else{if(ac.envMap!==""){var ak=(o.getExtension(ac.envMap)==="dds");if(ak){if(!ah){Z++;this.ambience.setBackGroundMap({url:ac.envMap,hdr:true,mapping:new M.LatLongEnvMapping(),doneCallback:al})}}else{Z++;this.ambience.setBackGroundMap({url:ac.envMap+".hdr",hdr:true,mapping:new M.LatLongEnvMapping(),doneCallback:al})}}}}},setEnvMapBlur:function(Z){this.envMapBlur=Z;this.ambience.setEnvMapBlur(Z)},setEnvMapOffset:function(Z){},setEnvMapExposure:function(Z){this.envMapExposure=Z;this.ambience.setExposure(Z);if(this.sphereEnv&&this.sphereEnv.material&&this.sphereEnv.material.uniforms.envMapExposure){this.sphereEnv.material.uniforms.envMapExposure.value=Z}if(this.internalSceneGraph.scene.envMipMap[0]){this.internalSceneGraph.scene.envMipMap[0].envMapExposure=Z}},addReflectionProbe:function(ah,ad,Z,ai,ag){var ae=this;var af=M.ImageUtils.loadHDRTexture(ah+".hdr",new M.LatLongReflectionMapping(),ag);af.onLoadCallbacks.push(function(){ae.render()});af.minFilter=M.NearestFilter;af.magFilter=M.NearestFilter;af.wrapS=M.RepeatWrapping;af.wrapT=M.RepeatWrapping;var ac=M.ImageUtils.loadHDRTexture(ah+"_rmips.hdr",new M.LatLongReflectionMapping());ac.onLoadCallbacks.push(function(){ae.render()});ac.minFilter=M.NearestFilter;ac.magFilter=M.NearestFilter;ac.wrapS=M.RepeatWrapping;ac.wrapT=M.RepeatWrapping;var ab={map0:af,map1:ac,position:ad,geomProxy:new M.Box3(Z,ai)};this.internalSceneGraph.scene.reflectionProbes.push(ab)},removeReflectionProbes:function(){this.internalSceneGraph.scene.reflectionProbes=[]},setEnvMapAmbient:function(Z){if(this.sphereEnv&&this.sphereEnv.material){this.sphereEnv.material.uniforms.ambient.value.copyGammaToLinear(Z)}},createEnvMap:function(ad,ai){if((this.envMap===null)&&!this.ambience.getBackground().getColors().length){return}var ae,Z,af,aj,ag=ai?ai.camera.position:this.currentViewpoint.camera.position;if(this.ambience!==null){this.ambience.updateSphere(ad,ag);return}if(this.sphereEnv!==null){this.sphereEnv.scale.set(ad,ad,ad);this.sphereEnv.position.set(ag.x,ag.y,ag.z);this.sphereEnv.updateMatrix();this.sphereEnv.visible=true;this.sphereEnv.visibilityFree=true;return}if(this.envMap===null){switch(this.gradientBackground.length){case 2:Z=M.GradientBackgroundShader2;break;case 3:Z=M.GradientBackgroundShader3;break;case 4:Z=M.GradientBackgroundShader4;break;default:return}}else{Z=M.CubeMapShader;var al=null;if(this.envMap.mapping instanceof M.LightProbeEnvMapping){Z=M.LightProbeMapShader}else{if((this.envMap.mapping instanceof M.LatLongEnvMapping)||(this.envMap.mapping instanceof M.LatLongReflectionMapping)){Z=M.LatLongMapShader;this.envMap.wrapS=M.RepeatWrapping;this.envMap.wrapT=M.RepeatWrapping;if(this.envMap2){this.envMap2.wrapS=M.RepeatWrapping;this.envMap2.wrapT=M.RepeatWrapping}}else{if(!(this.envMap.mapping instanceof M.CubeEnvMapping)){var am;var ak;var ah=this.envMap.image.width/this.envMap.image.height;var ab=this.SCREEN_WIDTH/this.SCREEN_HEIGHT;var at=0;var ar=0;if(this.envMap.mapping instanceof M.SimpleEnvMapping){am=this.SCREEN_WIDTH;ak=this.SCREEN_HEIGHT}else{if(this.envMap.mapping instanceof M.SimpleEnvMappingPreserveRatio){if(ah>ab){ak=this.SCREEN_HEIGHT;am=ak*ah}else{am=this.SCREEN_WIDTH;ak=am/ah}}else{if(this.envMap.mapping instanceof M.SimpleEnvMappingFit){if(ah>ab){am=this.SCREEN_WIDTH;ak=this.SCREEN_WIDTH/ah;ar=0.5*(this.SCREEN_HEIGHT-ak)}else{am=this.SCREEN_HEIGHT*ah;ak=this.SCREEN_HEIGHT;at=0.5*(this.SCREEN_WIDTH-am)}}}}Z=M.SimpleMapShader;al=M.UniformsUtils.clone(M.SimpleMapShader.uniforms);al.offset.value.set((this.devicePixelRatio*at),(this.devicePixelRatio*ar));al.invSize.value.set(1/(this.devicePixelRatio*am),1/(this.devicePixelRatio*ak))}}}}if(Z.defines&&(Z.defines.sRGB!==undefined)){Z.defines.sRGB=!!this.envMap.sRGB}if(Z.defines&&(Z.defines.HDR!==undefined)){Z.defines.HDR=!!this.envMap.hdr}af={fragmentShader:Z.fragmentShader,vertexShader:Z.vertexShader,uniforms:al?al:Z.uniforms,defines:Z.defines};if(Z.defines&&this.envMap2){Z.defines.ENVMAP2=true}aj=new M.ShaderMaterial(af);aj.side=M.DoubleSide;aj.forceSide=true;aj.force=true;aj.depthTest=false;if(this.envMap&&this.envMap.hdr&&this.envMap.image){if(this.envMap.image.width){aj.uniforms.envMapHDRSize.value.x=parseInt(this.envMap.image.width);aj.uniforms.envMapHDRSize.value.y=parseInt(this.envMap.image.height)}else{var ao=this;this.envMap.onLoadCallbacks.push(function(){aj.uniforms.envMapHDRSize.value.x=parseInt(ao.envMap.image.width);aj.uniforms.envMapHDRSize.value.y=parseInt(ao.envMap.image.height)})}}if(this.envMap===null){aj.uniforms.colors.value=[];var aq=aj.uniforms.colors.value;for(var ap=0;ap<this.gradientBackground.length;ap++){var an=this.gradientBackground[ap];aq.push(an.r);aq.push(an.g);aq.push(an.b)}}else{aj.uniforms.tEnvMap.value=this.envMap;if(this.envMap2){aj.uniforms.tEnvMap2.value=this.envMap2;aj.uniforms.blurCoef.value=this.envMapBlur}if(aj.uniforms.envMapExposure){aj.uniforms.envMapExposure.value=this.envMapExposure}if((this.envMap.mapping instanceof M.LatLongEnvMapping)||(this.envMap.mapping instanceof M.LatLongReflectionMapping)){aj.uniforms.offsetPhi.value=this.envMapOffset}}var ac=P.createSphereNode({radius:1,sag:64,material:aj});this.sphereEnv=ac._occurrences[0].renderable;this.sphereEnv.frustumCulled=false;this.sphereEnv.renderDepth=2;this.sphereEnv.scale.set(ad,ad,ad);this.sphereEnv.position.set(ag.x,ag.y,ag.z);this.sphereEnv.updateMatrix();this.sphereEnv.visible=true;this.sphereEnv.visibilityFree=true;this.sceneBackground.add(this.sphereEnv)},removeEnvMap:function(){var Z=false;if(this.ambience.getBackground().isActivated()){Z=true;this.ambience.getBackground().setActivated(false)}if(this.sphereEnv!==null){this.sphereEnv.visible=false}return Z},updateBackgroundLights:function(){var af=(this.internalSceneGraph===null)?this.temporaryEmptyScene:this.internalSceneGraph.scene;var ab=af.__lights;var ag=[];for(var ae=0;ae<ab.length;ae++){var ad=ab[ae];var ah=-1;if(ad.isVirtual){continue}for(var ac=0;ac<this.lights.length;ac++){if(this.lights[ac].fgLight===ad){ah=ac;break}}if(ah===-1){var Z=ad.clone();Z.castShadow=false;this.sceneBackground.add(Z);ag.push({fgLight:ad,bgLight:Z})}else{var aj=this.lights[ah].bgLight;ad.clone(aj);aj.castShadow=false}}for(var ae=0;ae<ag.length;ae++){var ai=ag[ae];this.lights.push(ai)}},getSceneBoundingSphere:function(ac,ab){if(ac==="show"){console.warn("DEPRECATED: use visibleSpace instead of show");ac="visibleSpace"}if(ac==="noShow"){console.warn("DEPRECATED: use invisibleSpace instead of noShow");ac="invisibleSpace"}if(!this.internalSceneGraph){return ab?null:new M.Sphere()}var Z=this.internalSceneGraph.root;Z._tryOverridesUpdate(this);return this.internalSceneGraph.getBoundingSphere(ac,ab)},getSceneBoundingBox:function(ab){if(ab==="show"){console.warn("DEPRECATED: use visibleSpace instead of show");ab="visibleSpace"}if(ab==="noShow"){console.warn("DEPRECATED: use invisibleSpace instead of noShow");ab="invisibleSpace"}if(!this.internalSceneGraph){return new M.Box3()}var Z=this.internalSceneGraph.root;Z._tryOverridesUpdate(this);return Z._occurrences[0].getBoundingBox(ab)},computeSceneAccurateBoundingBox:function(ac,ab){if(!this.internalSceneGraph){return new M.Box3()}var Z=this.internalSceneGraph.root;Z._tryOverridesUpdate(this);return Z._occurrences[0].computeAccurateBoundingBox(ac,ab,0,0,[])},_updateNearFar:function(){var ap=this.trackingViewpoint?this.trackingViewpoint:this.currentViewpoint;var av=ap.camera;if(!av){return false}var ay=av.near;var ao=av.far;var an=(this.internalSceneGraph===null)?new M.Sphere(new M.Vector3(0,0,0),100):this.getSceneBoundingSphere(this.visibleSpace?"visibleSpace":"invisibleSpace");if(!an){return false}var aj=0;if(an.pixelRadius>0){var aq=av.getWorldSizeFromPixelSize(1,an.center,this.div.clientHeight);if(typeof av.fullWidth!=="undefined"&&av.fullWidth>0){var ak=Math.max(av.width*1/av.fullWidth,av.height*1/av.fullHeight);aq*=ak}aj=aq*an.pixelRadius}this._updateOffsetPlane(an,av,false);var aw=this._getPlaneSize(an,av,this.gridUnit,this.gridStep);if(aw!==this.planeSize){this.planeSize=aw}var af=new M.Vector3().subVectors(an.center,av.position);var al=new M.Vector3().subVectors(this.offsetPlaneBackground,av.position);var ad=av.getLookAt();var am=af.dot(ad);var ah=al.dot(ad);var az=am;var ax=Math.PI*Math.max(0.1,0.5-this.dirLightLatitude);var ac=Math.sin(ax)+(Math.cos(ax)+1)/Math.tan(ax);var Z=(this._infinitePlane||this._displayGrid);if(Z){this.cameraBackgroundFar=Math.max(ah+this.planeSize,am+an.radius);if(this._nearFarBigScale){var au=new M.Sphere().copy(an);au.center.z-=an.radius;var ab=new M.Sphere();an.mergeWithSphere(au,ab);af.subVectors(ab.center,av.position);az=af.dot(ad)}else{af.z-=an.radius;az=af.dot(ad)}}this.cameraBackgroundNear=ah-this.planeSize;if(this._nearFarBigScale){this.cameraBackgroundNear=Math.max(this.cameraBackgroundNear,0.001)}if(this.ambience.getBackground().isActivated()&&!this._2DMode){if(this.ambience.isFiniteMode()){var ar=this.ambience.getRadiusEnvMap();var ai=ac*ar;this.cameraBackgroundFar=az+ai;var ae=Math.max(az-ai,0.001*this.cameraBackgroundFar);if(ae>this.cameraBackgroundNear){this.cameraBackgroundNear=ae}if(this.internalSceneGraph.scene.useFiniteEnvMap==false){this.internalSceneGraph.scene.useFiniteEnvMap=true;this.renderer&&this.renderer.recompileAllShaders()}this.internalSceneGraph.scene.parallaxCorrectionParameters.sphereCenter=this.ambience.getCenter();this.internalSceneGraph.scene.parallaxCorrectionParameters.sphereRadius=this.ambience.getRadius();this.internalSceneGraph.scene.parallaxCorrectionParameters.projectionCenter=this.ambience.getProjectionCenter()}else{if(this.internalSceneGraph.scene.useFiniteEnvMap==true){this.internalSceneGraph.scene.useFiniteEnvMap=false;this.renderer&&this.renderer.recompileAllShaders()}this.cameraBackgroundFar=Math.max(ah+this.planeSize,am+an.radius)}}var at;if(this._nearFarBigScale){at=ac*(Z?ab.radius+aj:an.radius+aj)}else{at=ac*(an.radius+aj)}av.far=az+at;av.near=Math.max(az-at,0.001*av.far);if(this._nearFarBigScale){var ag=ap.control.distanceToTarget;var aA=Math.max(0,az-at);if(ag>50){av.near=Math.min(Math.max(ag/50,aA),av.near)}else{av.near=Math.min(Math.max(0.1,aA),av.near)}}if(av.isOrtho){av.near=az-at}else{if(av.far<0){av.near=5;av.far=50}}return(ay!==av.near||ao!==av.far)},isShadowMap:function(){var ac=(this.internalSceneGraph===null)?this.temporaryEmptyScene:this.internalSceneGraph.scene;var Z=ac.__lights;for(var ab=0;ab<Z.length;ab++){if(Z[ab].isVirtual){continue}if(Z[ab].castShadow||Z[ab].castGroundShadow){return true}}return false},dispose:function(){disposedViewers.push(this.id);this.canvas.removeEventListener("webglcontextlost",this.onWebGLContextLost);this.canvas.removeEventListener("webglcontextrestored",this.onWebGLContextRestore);this.disposed=true;this.setDefaultPicking(false);if(this.infPlane){this.infPlane.dispose()}if(this.infPlaneSmall){this.infPlaneSmall.dispose()}if(this.grid){this.grid.dispose()}if(this.bigGrid){this.bigGrid.dispose()}if(this.internalSceneGraph){this.internalSceneGraph.dispose();this.internalSceneGraph=null}this.sceneBackground.dispose();this.sceneBackground=null;if(this.manipulatorManager){this.manipulatorManager._detachEvents();this.manipulatorManager=null}this.renderer.renderer.ambianceGenerators.dispose(this);for(var Z=0;Z<this.viewpoints.length;Z++){this.viewpoints[Z].setDefaultController(false);this.viewpoints[Z]._setNode(null)}this.materialManager.cleanAll();this.materialManager=null;this._userPassManager._dispose();if(this.renderer){this.renderer.dispose()}this.renderer=null;B.disconnectFrom(this.canvas);B._dispose();window.debugWebGLV6Viewer=null;if(this.div){if(this.canvas&&(this.div===this.canvas.parentNode)){this.div.removeChild(this.canvas)}if(this.divCssElement&&(this.div===this.divCssElement.parentNode)){this.div.removeChild(this.divCssElement)}if(this.divTrap&&(this.div===this.divTrap.parentNode)){this.div.removeChild(this.divTrap)}if(this.svgRootNode&&(this.div===this.svgRootNode.parentNode)){this.div.removeChild(this.svgRootNode)}}if(this.canvas.webGLV6Viewer){delete this.canvas.webGLV6Viewer}this.canvas=null;this.infPlane=null;this.infPlaneSmall=null;this.grid=null;this.bigGrid=null;this.sceneBackground=null;this.cameraBackground=null;this.ambientLight=null;this.directionalLight=null;this.directionalLight2=null;this.directionalLight3=null;this.dirLightGroundShadow=null;this.probeLight=null;this.lights=[];this.currentViewpoint=null;this.viewpoints=[];this.trackingViewpoint=null;this.materialManager=null;this.cameraReflected=null;this.renderer=null;this.debugPickingNode=null;this.debugNormalNode=null;this.temporaryEmptyScene=null;this._modelEvent.destroy();this.trapSelectionManipulator=null;this.clearThis()},setRenderFrameCB:function(Z,ab){this.renderFrameCB=Z;this.beginRenderFrameCB=ab},getCurrentSceneGraphState:function(){return this.sceneGraphState},getSceneGraphOverrideSetManager:function(){return this._sceneGraphOverrideSetManager},hasSceneGraphOverrideSet:function(){if(this.sceneGraphState||(this._sceneGraphOverrideSetManager&&this._sceneGraphOverrideSetManager.hasSceneGraphOverrideSet())){return true}else{return false}},getUserPassManager:function(){return this._getUserPassManager()},clearScene:function(ab,Z){this.empty(ab,Z)},empty:function(ab,Z){this.internalSceneGraph&&this.internalSceneGraph.clearScene(ab,Z,this._sceneGraph?"deprecated":undefined);if(ab){this.render({updateInfinitePlane:Z,needReframe:Z})}this.divCss2DElement.empty()},isEmpty:function(){if(this._sceneGraph){return this._sceneGraph._private_root.children.length===0}else{if(this.internalSceneGraph){return this.internalSceneGraph.userRoot.children.length===0}}},setDisableBackFaceCulling:function(Z){this.renderer.setDisableBackFaceCulling(Z)},setCameraSystem:function(Z){if(Z!==this.cameraSystem){this.cameraSystem=Z;this.renderer.clearCameraSystemData();this.cameraSystemUpdated=true}if(!Z){this.renderer.renderer.removeSplitScreenMode()}},set2DMode:function(Z){this._2DMode=Z;this._setBackgroundColor();this._updateGridDisplay();this._updateInfinitePlaneDisplay();this._updateShadowPlaneDisplay();if(this.currentViewpoint){this.currentViewpoint._set2DMode(Z)}this._updateSVGVisu()},get2DMode:function(Z){return this._2DMode},getCameraSystem:function(){return this.cameraSystem},_updateShaders:function(){this.internalSceneGraph&&this.internalSceneGraph.updateShaders()},_addRobot:function(ab,Z){Z.addRobotNode(ab)},addDebugPoint:function(Z,ad){var ae=P.createSphereNode({radius:3,material:new M.MeshBasicMaterial({color:ad,force:true,enableClipPlanes:false})});ae.setNoZ(true);var ac=P.createFixedSizeNode();ac.addChild(ae);this.internalSceneGraph.addDebugNode(ac);ac.setPickable(q.NODRAWHL);var af=this;function ab(ah){var ag=new M.Matrix4();if(ah instanceof Array){ah={x:ah[0],y:ah[1],z:ah[2]}}ag.setPosition(ah);ac.setMatrix(ag)}ab(Z);return{setPosition:function(ag){ab(ag)},remove:function(){af.internalSceneGraph.removeDebugNode(ac)},add:function(){af.internalSceneGraph.addDebugNode(ac)}}},restoreVisualizationMode:function(al){var af=0,ah=M.ShowAllFaces,ad=M.ShowAllRenderLineMode,aj=0;if(al){if(al.materialMode!==undefined&&al.materialMode!==null){af=al.materialMode}if(al.renderFaceMode!==undefined&&al.renderFaceMode!==null){ah=al.renderFaceMode}if(al.renderLineMode!==undefined&&al.renderLineMode!==null){ad=al.renderLineMode}if(al.displayHiddenEdges!==undefined&&al.displayHiddenEdges!==null){aj=al.displayHiddenEdges}}if(localStorage.getItem("materialMode")&&(localStorage.getItem("materialMode")==="BACKGROUND"||localStorage.getItem("materialMode")==="ZONLY")){var am=new g();am.setFaceMode(localStorage.getItem("materialMode"));this.setRenderStyle(am)}else{var ab=localStorage.getItem("materialMode")?parseInt(localStorage.getItem("materialMode"),10):af;this.setMaterialMode(ab)}var ae=localStorage.getItem("renderFaceMode")?parseInt(localStorage.getItem("renderFaceMode"),10):ah;var Z=localStorage.getItem("renderLineMode")?parseInt(localStorage.getItem("renderLineMode"),10):ad;this._setInternalRenderFaceMode(ae);this._setInternalRenderLineMode(Z);var ag=localStorage.getItem("displayHiddenEdges")?parseInt(localStorage.getItem("displayHiddenEdges"),10):aj;this.displayHiddenEdges(ag);var ac=localStorage.getItem("axisState");if(ac){this.setAxisFilter(ac==="true")}var ak=localStorage.getItem("linesState");if(ak){this.setLinesFilter(ak==="true")}var ai=localStorage.getItem("pointsState");if(ai){this.setPointsFilter(ai==="true")}},restoreProjectionMode:function(){if(this.currentViewpoint&&localStorage.getItem("projectionMode")&&!this._2DMode){this.currentViewpoint.setProjectionType(parseInt(localStorage.getItem("projectionMode"),10))}},restoreAmbiance:function(){if(localStorage.getItem("visuEnv")){this.setVisuEnv(localStorage.getItem("visuEnv"))}else{this.setV6Ambience()}},setRobotAndRefAxisSystemEnabled:function(Z){this.internalSceneGraph.setRobotAndRefAxisSystemEnabled(Z)},getRobotAndRefAxisSystemEnabled:function(){var Z=this.getRobot();return Z&&Z._isEnabled()},setRenderPriority:function(Z){this.renderer.resetGSSOCache();if(Z&&this.getSectionCapping()){console.warn("Render priority mode is not compatible with section capping");return false}if(Z){this.setOIT(false)}if(!this._renderPriorityManager){this._renderPriorityManager=new k(this)}this._renderPriorityManager.setEnabled(Z);return true},getRenderPriority:function(){return(this._renderPriorityManager&&this._renderPriorityManager.enabled)?true:false},setRenderPriorityDefaultOpacity:function(Z){var ab=this.getRenderer();ab.renderPriorityDefaultOpacity=Z},_forceSceneMin:function(Z){this._forceSceneMinValue=Z},_addClippingPlane:function(Z){var ab=this.getRenderer();if(!Z.clippingContext){Z.clippingContext={}}if(!Z.clippingContext[ab.id]){Z.clippingContext[ab.id]={useCount:0}}if(ab===null){return false}if(!Z.upVector){Z.upVector=new M.Vector3(0,0,1)}Z.clippingContext[ab.id].useCount++;if(ab.clipPlanes.indexOf(Z)<0){ab.clipPlanes.push(Z);Z.clippingContext[ab.id].clippingPlaneAdded=true;if(!Z.clippingContext[ab.id].sectionCappingMaterial){this.setSectionCappingMaterial(Z,null)}else{this.renderer.resetClippingScene()}if(ab.clipPlanes.length===1){this.renderer.shadowPass.plugin.updateShaders();if(this.internalSceneGraph!==null){this.internalSceneGraph.updateShaders()}}if(this.directionalLight){this.directionalLight.updateShadowMap=true}}},_removeClippingPlane:function(ab){if(!ab||!ab.clippingContext){return}var ae=this.getRenderer();var ad=ab.clippingContext[ae.id];ad.useCount--;if(ad.useCount<=0){for(var ac=0;ac<ae.clipPlanes.length;ac++){var Z=ae.clipPlanes[ac];if(Z===ab){delete ad.clippingMeshIndex;delete ad.clippingPlaneAdded;this.renderer.resetClippingScene();ae.clipPlanes.splice(ac,1);if(!ae.clipPlanes.length){ae.clipPlanesEnabled=false}if(ae.clipPlanes.length===0){this.renderer.shadowPass.plugin.updateShaders();if(this.internalSceneGraph!==null){this.internalSceneGraph.updateShaders()}}if(this.directionalLight){this.directionalLight.updateShadowMap=true}return}}}},_addManipulator:function(Z,ab){this._manipulators[ab]=Z},_removeManipulator:function(Z){delete this._manipulators[Z]},_filterClippedIntersections:function(ad){var ac=[];var af=this.getRenderer();var Z;if(af.clipPlanesEnabled){Z=new m(af.clipPlanes)}var ae;var ab=0,ag,ah;for(ab=0;ab<ad.length;ab++){ag=ad[ab];ae=ag.object&&(Z||ag.object._occurrence.clippingContext);if(!ae||!ag.point||ae.isPointVisible(ag.point)){ac.push(ag)}}return ac},_getUserPassManager:function(){return this._userPassManager},_setInternalRenderFaceMode:function(Z){this.renderer.renderer.renderFaceMode=Z},_getInternalRenderFaceMode:function(){return this.renderer.renderer.renderFaceMode},_setInternalRenderLineMode:function(Z){this.renderer.renderer.renderLineMode=Z},_getInternalRenderLineMode:function(){return this.renderer.renderer.renderLineMode},_DEPRECATED_setRenderFooMode:function(Z){if(x<30){console.warn("[WebGLViewer] Deprecated setRenderLineMode/setRenderFaceMode method.\nUse setRenderMode() instead\n"+Z.stack)}}});Object.defineProperty(E.prototype,"backgroundColor",{get:function(){return(this.__tempBackgroundColorODT)}});Object.defineProperty(E.prototype,"sceneGraph",{get:function(){Q.DEPRECATED_SceneGraph(new Error(),true);return this.getRootNode()}});return UWA.namespace("THREEDS/WebGLViewer",E)});define("DS/Shaders/DeferredShaders",["DS/Visualization/ThreeJS_R57"],function(j){var l={encode_float:["float shift_right(float v, float amt) {","v = floor(v) + 0.5;","return floor(v / exp2(amt));","}","float shift_left(float v, float amt) {","return floor(v * exp2(amt) + 0.5);","}","float mask_last(float v, float bits) {","return mod(v, shift_left(1.0, bits));","}","float extract_bits(float num, float from, float to) {","from = floor(from + 0.5);","to = floor(to + 0.5);","return mask_last(shift_right(num, from), to - from);","}","vec4 encode_float(float val) {","if (val == 0.0)","return vec4(0, 0, 0, 0);","float sign = val > 0.0 ? 0.0 : 1.0;","val = abs(val);","float exponent = floor(log2(val));","float biased_exponent = exponent + 127.0;","float fraction = ((val / exp2(exponent)) - 1.0) * 8388608.0;","float t = biased_exponent / 2.0;","float last_bit_of_biased_exponent = fract(t) * 2.0;","float remaining_bits_of_biased_exponent = floor(t);","float byte4 = extract_bits(fraction, 0.0, 8.0) / 255.0;","float byte3 = extract_bits(fraction, 8.0, 16.0) / 255.0;","float byte2 = (last_bit_of_biased_exponent * 128.0 + extract_bits(fraction, 16.0, 23.0)) / 255.0;","float byte1 = (sign * 128.0 + remaining_bits_of_biased_exponent) / 255.0;","return vec4(byte4, byte3, byte2, byte1);","}",].join("\n"),unpackFloat:["vec3 float_to_vec3( float data ) {","vec3 uncompressed;","uncompressed.x = fract( data );","float zInt = floor( data / 255.0 );","uncompressed.z = fract( zInt / 255.0 );","uncompressed.y = fract( floor( data - ( zInt * 255.0 ) ) / 255.0 );","return uncompressed;","}"].join("\n"),picking_instancing_vertex:["if (instanceId > 16777215.0) vInstancePickingColor = vec3(0.0);","else {","vInstancePickingColor.r = floor(instanceId / 65536.0);","vInstancePickingColor.g = floor((instanceId - vInstancePickingColor.r * 65536.0) / 256.0);","vInstancePickingColor.b = floor(instanceId - vInstancePickingColor.r * 65536.0 - vInstancePickingColor.g * 256.0);","vInstancePickingColor /= 255.0;","}"].join("\n"),picking_instancing_fragment:["gl_FragColor = vec4(vInstancePickingColor, 1.0);"].join("\n"),};var h={uniforms:j.UniformsUtils.merge([j.UniformsLib.clipPlanes,j.UniformsLib.skinning,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new j.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new j.Vector4(1,1)}}]),vertexShaderPars:["#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif"].join("\n"),vertexShaderBody:["#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif",].join("\n"),fragmentShaderPars:["#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","uniform vec3 pickingColor;"].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","   if ( alpha < ALPHATEST ) discard;","#endif","   gl_FragColor = vec4( pickingColor, 1.0 );"].join("\n"),vertexShader:[j.ShaderChunk.clip_pars_vertex,j.ShaderChunk.skinning_pars_vertex,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","void main() {",j.ShaderChunk.PDSFX_start_vertex,j.ShaderChunk.skinbase_vertex,j.ShaderChunk.skinning_vertex,j.ShaderChunk.default_vertex,"#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif",j.ShaderChunk.clip_vertex,j.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[j.ShaderChunk.clip_pars_fragment,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","uniform vec3 pickingColor;","void main() {","#ifdef PDSFX","ComputeCommonValues();",j.ShaderChunk.PDSFX_discard_fragment,"#endif",j.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","   if ( alpha < ALPHATEST ) discard;","#endif","   gl_FragColor = vec4( pickingColor, 1.0 );","}"].join("\n")};var k={uniforms:j.UniformsUtils.merge([j.UniformsLib.clipPlanes,j.UniformsLib.skinning,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new j.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new j.Vector4(1,1)}}]),vertexShader:[j.ShaderChunk.clip_pars_vertex,j.ShaderChunk.skinning_pars_vertex,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","varying vec3 vInstancePickingColor;","void main() {",j.ShaderChunk.PDSFX_start_vertex,j.ShaderChunk.skinbase_vertex,j.ShaderChunk.skinning_vertex,j.ShaderChunk.default_vertex,"#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif",j.ShaderChunk.clip_vertex,j.ShaderChunk.PDSFX_end_vertex,l.picking_instancing_vertex,"}"].join("\n"),fragmentShader:[j.ShaderChunk.clip_pars_fragment,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","varying vec3 vInstancePickingColor;","void main() {","#ifdef PDSFX","ComputeCommonValues();",j.ShaderChunk.PDSFX_discard_fragment,"#endif",j.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","   if ( alpha < ALPHATEST ) discard;","#endif",l.picking_instancing_fragment,"}"].join("\n")};var b={uniforms:j.UniformsUtils.merge([j.UniformsLib.clipPlanes,{map:{type:"t",value:null},size:{type:"f",value:1},scale:{type:"f",value:500},offsetAlphaMap:{type:"v2",value:new j.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new j.Vector4(1,1)}}]),vertexShaderPars:["uniform float size;","uniform float scale;","#ifdef USE_MAP_ALPHATEST","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif"].join("\n"),vertexShaderBody:["#ifdef USE_SIZEATTENUATION","gl_PointSize = size * ( scale / length( mvPosition.xyz ) );","#else","gl_PointSize = size;","#endif",].join("\n"),fragmentShaderPars:["#ifdef USE_MAP_ALPHATEST","uniform sampler2D map;","#endif","uniform vec3 pickingColor;"].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","   gl_FragColor = vec4( pickingColor, 1.0 );"].join("\n"),vertexShader:[j.ShaderChunk.clip_pars_vertex,"uniform float size;","uniform float scale;","#ifdef USE_MAP_ALPHATEST","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","void main() {",j.ShaderChunk.PDSFX_start_particle_vertex,j.ShaderChunk.PDSFX_start_vertex,j.ShaderChunk.default_vertex,j.ShaderChunk.PDSFX_point_size_vertex,j.ShaderChunk.clip_vertex,j.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[j.ShaderChunk.clip_pars_fragment,"#ifdef USE_MAP_ALPHATEST","uniform sampler2D map;","#endif","uniform vec3 pickingColor;","void main() {","#ifdef PDSFX","ComputeCommonValues();",j.ShaderChunk.PDSFX_discard_fragment,"#endif",j.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","   gl_FragColor = vec4( pickingColor, 1.0 );","}"].join("\n")};var a={uniforms:j.UniformsUtils.merge([j.UniformsLib.clipPlanes,{map:{type:"t",value:null},size:{type:"f",value:1},scale:{type:"f",value:500},offsetAlphaMap:{type:"v2",value:new j.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new j.Vector4(1,1)}}]),vertexShader:[j.ShaderChunk.clip_pars_vertex,"uniform float size;","uniform float scale;","#ifdef USE_MAP_ALPHATEST","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","varying vec3 vInstancePickingColor;","void main() {",j.ShaderChunk.PDSFX_start_particle_vertex,j.ShaderChunk.PDSFX_start_vertex,j.ShaderChunk.default_vertex,j.ShaderChunk.PDSFX_point_size_vertex,j.ShaderChunk.clip_vertex,j.ShaderChunk.PDSFX_end_vertex,l.picking_instancing_vertex,"}"].join("\n"),fragmentShader:[j.ShaderChunk.clip_pars_fragment,"#ifdef USE_MAP_ALPHATEST","uniform sampler2D map;","#endif","varying vec3 vInstancePickingColor;","void main() {","#ifdef PDSFX","ComputeCommonValues();",j.ShaderChunk.PDSFX_discard_fragment,"#endif",j.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).w;","   if ( alpha < ALPHATEST ) discard;","#endif",l.picking_instancing_fragment,"}"].join("\n")};var e={uniforms:j.UniformsUtils.merge([j.UniformsLib.clipPlanes,j.UniformsLib.skinning,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new j.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new j.Vector4(1,1)}}]),fragmentShaderPars:[l.encode_float,"varying vec4 clipPos;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif"].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","   if ( alpha < ALPHATEST ) discard;","#endif","	float tmp = 0.5 + 0.5 * clipPos.z / clipPos.w;","	vec4 encode = encode_float(tmp);","   gl_FragColor = encode;"].join("\n"),vertexShaderPars:["varying vec4 clipPos;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif"].join("\n"),vertexShaderBody:["#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif","   clipPos = gl_Position;"].join("\n"),fragmentShader:[j.ShaderChunk.clip_pars_fragment,l.encode_float,"varying vec4 clipPos;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","void main() {","#ifdef PDSFX","ComputeCommonValues();",j.ShaderChunk.PDSFX_discard_fragment,"#endif",j.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","   if ( alpha < ALPHATEST ) discard;","#endif","	#ifdef PDSFX","	float tmp = 0.5 + 0.5 * _DSclipPosition.z / _DSclipPosition.w;","	#else","	float tmp = 0.5 + 0.5 * clipPos.z / clipPos.w;","	#endif","	vec4 encode = encode_float(tmp);","   gl_FragColor = encode;","}"].join("\n"),vertexShader:[j.ShaderChunk.clip_pars_vertex,j.ShaderChunk.skinning_pars_vertex,"varying vec4 clipPos;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","void main() {",j.ShaderChunk.PDSFX_start_vertex,j.ShaderChunk.skinbase_vertex,j.ShaderChunk.skinning_vertex,j.ShaderChunk.default_vertex,"#ifdef USE_MAP_ALPHATEST","   vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif",j.ShaderChunk.clip_vertex,"   clipPos = gl_Position;",j.ShaderChunk.PDSFX_end_vertex,"}"].join("\n")};var c={uniforms:j.UniformsUtils.merge([j.UniformsLib.clipPlanes,{size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new j.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new j.Vector4(1,1)}}]),fragmentShader:[j.ShaderChunk.clip_pars_fragment,l.encode_float,"varying vec4 clipPos;","uniform float size;","uniform float scale;","#ifdef USE_MAP_ALPHATEST","uniform sampler2D map;","#endif","void main() {","#ifdef PDSFX","ComputeCommonValues();",j.ShaderChunk.PDSFX_discard_fragment,"#endif",j.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","	#ifdef PDSFX","	float tmp = 0.5 + 0.5 * _DSclipPosition.z / _DSclipPosition.w;","	#else","	float tmp = 0.5 + 0.5 * clipPos.z / clipPos.w;","	#endif","	vec4 encode = encode_float(tmp);","   gl_FragColor = encode;","}"].join("\n"),vertexShader:[j.ShaderChunk.clip_pars_vertex,"uniform float size;","uniform float scale;","#ifdef USE_MAP_ALPHATEST","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","varying vec4 clipPos;","void main() {",j.ShaderChunk.PDSFX_start_particle_vertex,j.ShaderChunk.PDSFX_start_vertex,j.ShaderChunk.default_vertex,j.ShaderChunk.PDSFX_point_size_vertex,j.ShaderChunk.clip_vertex,"   clipPos = gl_Position;",j.ShaderChunk.PDSFX_end_vertex,"}"].join("\n")};var g={uniforms:j.UniformsUtils.merge([j.UniformsLib.clipPlanes,j.UniformsLib.lines]),vertexShader:[j.ShaderChunk.clip_pars_vertex,j.ShaderChunk.lines_pars_vertex,"varying vec4 clipPos;","void main() {",j.ShaderChunk.PDSFX_start_vertex,j.ShaderChunk.default_vertex,j.ShaderChunk.clip_vertex,j.ShaderChunk.lines_vertex,"   clipPos = gl_Position;",j.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[j.ShaderChunk.clip_pars_fragment,j.ShaderChunk.lines_pars_fragment,l.encode_float,"varying vec4 clipPos;","void main() {","#ifdef PDSFX","ComputeCommonValues();",j.ShaderChunk.PDSFX_discard_fragment,"#endif",j.ShaderChunk.clip_fragment,j.ShaderChunk.lines_fragment,"	#ifdef PDSFX","	float tmp = 0.5 + 0.5 * _DSclipPosition.z / _DSclipPosition.w;","	#else","	float tmp = 0.5 + 0.5 * clipPos.z / clipPos.w;","	#endif","	vec4 encode = encode_float(tmp);","   gl_FragColor = encode;","}"].join("\n")};var n={uniforms:j.UniformsUtils.merge([j.UniformsLib.clipPlanes,j.UniformsLib.skinning,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new j.Vector2(0,0)},repeatAlphaMap:{type:"v2",value:new j.Vector2(1,1)},bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1},offsetBumpMap:{type:"v2",value:new j.Vector2(0,0)},repeatBumpMap:{type:"v2",value:new j.Vector2(1,1)}}]),fragmentShaderPars:["varying vec3 normalView;"].join("\n"),fragmentShaderBody:["   vec3 normal = normalize( normalView );","   #ifdef DOUBLE_SIDED","       normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","   #endif","   gl_FragColor.xyz = normal * 0.5 + 0.5;"].join("\n"),vertexShaderPars:["varying vec3 normalView;"].join("\n"),vertexShaderBody:["   normalView = normalize( mvNormal );"].join("\n"),fragmentShader:[j.ShaderChunk.clip_pars_fragment,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","#ifdef USE_BUMPMAP","   varying vec2 vUv;","	#ifndef PDSFX","   varying vec3 vViewPosition;","	#else","   vec3 vViewPosition;","	#endif",j.ShaderChunk.bumpmap_pars_fragment,"#endif","varying vec3 normalView;","void main() {","#ifdef PDSFX","ComputeCommonValues();",j.ShaderChunk.PDSFX_discard_fragment,j.ShaderChunk.PDSFX_viewNormal_fragment,"#ifdef USE_BUMPMAP","vViewPosition = -ComputeViewPosition();","#endif","#endif",j.ShaderChunk.clip_fragment,"   #ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","       if ( alpha < ALPHATEST ) discard;","   #endif","#ifdef PDSFX","   vec3 normal = ComputeViewNormal();","#else","   vec3 normal = normalize( normalView );","#endif","   #ifdef DOUBLE_SIDED","       normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","   #endif","   #ifdef USE_BUMPMAP","       normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","   #endif","   gl_FragColor.xyz = normal * 0.5 + 0.5;","}"].join("\n"),vertexShader:[j.ShaderChunk.clip_pars_vertex,"varying vec3 normalView;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","#ifdef USE_BUMPMAP","   varying vec2 vUv;","	#ifndef PDSFX","   varying vec3 vViewPosition;","	#endif","   uniform vec2 offsetBumpMap;","   uniform vec2 repeatBumpMap;","#endif",j.ShaderChunk.morphtarget_pars_vertex,j.ShaderChunk.skinning_pars_vertex,"void main() {",j.ShaderChunk.PDSFX_start_vertex,j.ShaderChunk.morphnormal_vertex,j.ShaderChunk.skinbase_vertex,j.ShaderChunk.skinnormal_vertex,j.ShaderChunk.defaultnormal_vertex,j.ShaderChunk.morphtarget_vertex,j.ShaderChunk.skinning_vertex,j.ShaderChunk.default_vertex,j.ShaderChunk.clip_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif","   normalView = transformedNormal;","   #ifdef USE_MAP_ALPHATEST","vUvMap = uv * repeatAlphaMap.xy + offsetAlphaMap.xy;","   #endif","   #ifdef USE_BUMPMAP","       vUv = uv * repeatBumpMap.xy + offsetBumpMap.xy;","       vViewPosition = -mvPosition.xyz;","   #endif",j.ShaderChunk.PDSFX_end_vertex,"}"].join("\n")};var d={uniforms:j.UniformsUtils.merge([j.UniformsLib.clipPlanes,{size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new j.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new j.Vector4(1,1)}}]),fragmentShader:[j.ShaderChunk.clip_pars_fragment,"#ifdef USE_MAP_ALPHATEST","uniform sampler2D map;","#endif","void main() {","#ifdef PDSFX","ComputeCommonValues();",j.ShaderChunk.PDSFX_discard_fragment,"#endif",j.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","   gl_FragColor.xyz = vec3(1.0, 0.0, 0.0);","}"].join("\n"),vertexShader:[j.ShaderChunk.clip_pars_vertex,"uniform float size;","uniform float scale;","#ifdef USE_MAP_ALPHATEST","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","void main() {",j.ShaderChunk.PDSFX_start_particle_vertex,j.ShaderChunk.PDSFX_start_vertex,j.ShaderChunk.default_vertex,j.ShaderChunk.clip_vertex,"	#ifdef PDSFX","   gl_PointSize = ComputePointSize();","	#else","   gl_PointSize = size * scale / length(mvPosition.xyz);","	#endif",j.ShaderChunk.PDSFX_end_vertex,"}"].join("\n")};var f={uniforms:j.UniformsUtils.merge([j.UniformsLib.clipPlanes,j.UniformsLib.skinning,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new j.Vector2(0,0)},repeatAlphaMap:{type:"v2",value:new j.Vector2(1,1)},bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1},offsetBumpMap:{type:"v2",value:new j.Vector2(0,0)},repeatBumpMap:{type:"v2",value:new j.Vector2(1,1)},reflectionCoef:{type:"f",value:0}}]),fragmentShaderPars:["#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","uniform float reflectionCoef;","varying vec3 normalView;","varying vec4 clipPos;"].join("\n"),fragmentShaderBody:["   #ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","       if ( alpha < ALPHATEST ) discard;","   #endif","   vec3 normal = normalView;","   #ifdef DOUBLE_SIDED","       normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","   #endif","   if ((dot(normal, normal) < 0.5) || (dot(normal.xy, normal.xy) < 0.000001)) gl_FragColor.xy = vec2(0.0);","   else { gl_FragColor.xy = normalize(normal.xy) * sqrt(0.5 * normal.z + 0.5); }","   gl_FragColor.z = reflectionCoef;","   gl_FragColor.w = 0.5 + 0.5 * clipPos.z / clipPos.w;"].join("\n"),vertexShaderPars:["varying vec3 normalView;","varying vec4 clipPos;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif"].join("\n"),vertexShaderBody:["   normalView = normalize( mvNormal );","   #ifdef USE_MAP_ALPHATEST","vUvMap = uv * repeatAlphaMap.xy + offsetAlphaMap.xy;","   #endif","   clipPos = gl_Position;"].join("\n"),fragmentShader:[j.ShaderChunk.clip_pars_fragment,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","#ifdef USE_BUMPMAP","   varying vec2 vUv;","   varying vec3 vViewPosition;",j.ShaderChunk.bumpmap_pars_fragment,"#endif","uniform float reflectionCoef;","varying vec3 normalView;","varying vec4 clipPos;","void main() {","#ifdef PDSFX","ComputeCommonValues();",j.ShaderChunk.PDSFX_discard_fragment,j.ShaderChunk.PDSFX_viewNormal_fragment,"#ifdef USE_BUMPMAP","vViewPosition = -ComputeViewPosition();","#endif","#endif",j.ShaderChunk.clip_fragment,"   #ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","       if ( alpha < ALPHATEST ) discard;","   #endif","#ifdef PDSFX","   vec3 normal = ComputeViewNormal();","#else","   vec3 normal = normalView;","#endif","   #ifdef DOUBLE_SIDED","       normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","   #endif","   #ifdef USE_BUMPMAP","       normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","   #endif","  vec2 tmpV;","   if ((dot(normal, normal) < 0.5) || (dot(normal.xy, normal.xy) < 0.000001)) tmpV = vec2(0.0);","   else tmpV = normalize(normal.xy) * sqrt(0.5 * normal.z + 0.5);",window.webVRBypass?"  gl_FragColor.xy = vec2(0.5,0.5)+0.5*tmpV;":"  gl_FragColor.xy = tmpV;","   gl_FragColor.z = reflectionCoef;","#ifdef PDSFX","   gl_FragColor.w = 0.5 + 0.5 * _DSclipPosition.z / _DSclipPosition.w;","#else","   gl_FragColor.w = 0.5 + 0.5 * clipPos.z / clipPos.w;","#endif","}"].join("\n"),vertexShader:[j.ShaderChunk.clip_pars_vertex,"varying vec3 normalView;","varying vec4 clipPos;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","#ifdef USE_BUMPMAP","   varying vec2 vUv;","   varying vec3 vViewPosition;","   uniform vec2 offsetBumpMap;","   uniform vec2 repeatBumpMap;","#endif",j.ShaderChunk.morphtarget_pars_vertex,j.ShaderChunk.skinning_pars_vertex,"void main() {",j.ShaderChunk.PDSFX_start_vertex,j.ShaderChunk.morphnormal_vertex,j.ShaderChunk.skinbase_vertex,j.ShaderChunk.skinnormal_vertex,j.ShaderChunk.defaultnormal_vertex,j.ShaderChunk.morphtarget_vertex,j.ShaderChunk.skinning_vertex,j.ShaderChunk.default_vertex,j.ShaderChunk.clip_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif","   normalView = transformedNormal;","   #ifdef USE_MAP_ALPHATEST","vUvMap = uv * repeatAlphaMap.xy + offsetAlphaMap.xy;","   #endif","   #ifdef USE_BUMPMAP","       vUv = uv * repeatBumpMap.xy + offsetBumpMap.xy;","       vViewPosition = -mvPosition.xyz;","   #endif","   clipPos = gl_Position;",j.ShaderChunk.PDSFX_end_vertex,"}"].join("\n")};var m={uniforms:j.UniformsUtils.merge([j.UniformsLib.clipPlanes,{size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new j.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new j.Vector4(1,1)}}]),fragmentShader:[j.ShaderChunk.clip_pars_fragment,"varying vec4 clipPos;","uniform float size;","uniform float scale;","#ifdef USE_MAP_ALPHATEST","uniform sampler2D map;","#endif","void main() {","#ifdef PDSFX","ComputeCommonValues();",j.ShaderChunk.PDSFX_discard_fragment,"#endif",j.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","   gl_FragColor.xyz = vec3(1.0, 0.0, 0.0);","#ifdef PDSFX","   gl_FragColor.w = 0.5 + 0.5 * _DSclipPosition.z / _DSclipPosition.w;","#else","   gl_FragColor.w = 0.5 + 0.5 * clipPos.z / clipPos.w;","#endif","}"].join("\n"),vertexShader:[j.ShaderChunk.clip_pars_vertex,"uniform float size;","uniform float scale;","varying vec4 clipPos;","#ifdef USE_MAP_ALPHATEST","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","void main() {",j.ShaderChunk.PDSFX_start_particle_vertex,j.ShaderChunk.PDSFX_start_vertex,j.ShaderChunk.default_vertex,j.ShaderChunk.clip_vertex,"   clipPos = gl_Position;",j.ShaderChunk.PDSFX_point_size_vertex,j.ShaderChunk.PDSFX_end_vertex,"}"].join("\n")};return{NormalDepth:f,NormalDepthParticle:m,Normal:n,NormalParticle:d,Depth:e,DepthParticle:c,DepthEdge:g,PickingFragment:h,PickingFragmentInstancing:k,PickingPointFragmentInstancing:a,PickingPointFragment:b,Chunks:l}});define("Shaders/DeferredShaders",["DS/Shaders/DeferredShaders","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/DeferredShaders");return b});define("DS/VisuDataAccess/Ox4SelectTask",[],function(){var a=function(c,j){var k=c;var e=null;var b=j;var g=function(o,p,t,s){var r=o;var q=p;var m=function(z){var A=/[^\r\n]+/g;var u=/^paths:.*/g;var y=-1;var w=false;var v="fetch";var x;while(((x=A.exec(t))!==null)&&(!w)){if(r.hasPathAttrs()&&v==="fetch"&&u.exec(x[0])!==null){v="path"}n(r,v,x[0]);if(A.lastIndex===y){w=true}y=A.lastIndex}s()};var n=function(y,B,A){var x=/\{(.*?)\}[\s\}]/g;A=A.substring(1,(A.length-1));var v=-1;var w=false;var C;var z=0;var u=new Array();while(((C=x.exec(A))!==null)&&(!w)){C[0]=C[0].trim();if(C[0].indexOf("{{")==0){C[0]=C[0].substring(2,C[0].length)}if(C[0].indexOf("{")==0){C[0]=C[0].substring(1,C[0].length)}if(C[0].indexOf("}")==(C[0].length-1)){C[0]=C[0].substring(0,C[0].length-1)}while(C[0].startsWith("{")||C[0].endsWith("}")){if(C[0].startsWith("{")){C[0]=C[0].substring(1,C[0].length)}if(C[0].endsWith("}")){C[0]=C[0].substring(0,C[0].length-1)}}u.push(C[0]);z=z+1;if(x.lastIndex===v){isILinenfiniteLoop=true}v=x.lastIndex}r.injectRowInto(B,u,q)};m(t)};var d=function(){return b.rawmode?f():l()};var f=function(){var m="start transaction ;\n";if(k.boOrRel==0){m+="query connection type %1  where \"physicalid matchlist '%2'','\"  select %3 dump | tcl;\n"}else{m+="temporary query businessobject  %1 * *  where \"physicalid matchlist '%2'','\"  select %3 dump | tcl;\n"}m+="abort transaction ;\n";return m};var l=function(){var m='<?xml version="1.0" encoding="utf-8"?>\n';m+='<executeSequence xmlns="http://www.3ds.com/xmql/query">\n';m+="\t<execute>\n";if(k.boOrRel==0){m+="\t\t<function>query_connection_set"}else{m+="\t\t<function>query_bus_set"}if(k.hasPathAttrs()){m+="_sr"}m+="</function>\n";m+="\t\t<version>2.0.0</version>\n";m+="\t\t<params>\n";m+='\t\t\t<param name="label">fetch</param>\n';m+='\t\t\t<param name="setname">%s</param>\n';if(k.boOrRel!=0){m+='\t\t\t<param name="name">*</param>\n';m+='\t\t\t<param name="revision">*</param>\n'}m+='\t\t\t<param name="vault">*</param>\n';m+='\t\t\t<param name="orderbykw"/>\n';m+='\t\t\t<param name="orderby"/>\n';m+='\t\t\t<param name="limitkw"/>\n';m+='\t\t\t<param name="limit"/>\n';m+='\t\t\t<param name="rootids">%2</param>\n';m+='\t\t\t<param name="select">%3</param>\n';m+='\t\t\t<param name="type">%1</param>\n';if(k.hasPathAttrs()){m+='\t\t\t<param name="labelSR">paths</param>\n';m+='\t\t\t<param name="selectpath">%4</param>\n'}m+='\t\t\t<param name="notsubstitute">true</param>\n';m+='\t\t\t<param name="dump">|</param>\n';m+="\t\t</params>\n";m+="\t</execute>\n";m+="</executeSequence>\n";return m};var h=d();this.run=function(s,p,r,u,t){e=s;console.log("running Ox4xMQLSelectTask");var n=b.xmqlServiceUri();var m=k.typeRequested();var o=s.findNodeByPLMTypeExpressedAsPhyIdAsJSON(m);if(o.length>0){var q=h.replace("%s",p.SetName);q=q.replace("%1",m);q=q.replace("%2",o);q=q.replace("%3",k.marshallAsMQLListOfFetchAttributesAsJSON());if(k.hasPathAttrs()){q=q.replace("%4",k.marshallAsMQLListOfPathAttributesAsJSON())}p.executePostHttpRequest(n,b.rawmode,q,function(w){var v=new g(k,s,w,function(){u(this)})})}else{u(this)}}};return a});define("VisuDataAccess/Ox4SelectTask",["DS/VisuDataAccess/Ox4SelectTask","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/Ox4SelectTask");return b});define("DS/Visualization/OccurrenceRenderingOverride",["UWA/Class","DS/Visualization/ThreeJS_R57"],function(b,d){var a;var e=function(g,h){this.id=a.getNewId();if(h instanceof e){this.materialOverride=h.materialOverride}else{this.materialOverride=h}this.opacity=g.opacity;this.renderPriorityActivated=false};e.prototype.getOpacity=function(){return this.materialOverride?this.materialOverride.getOpacity():null};e.prototype.getColor=function(){return this.materialOverride?this.materialOverride.getColor():null};e.prototype.getFullMaterial=function(){return this.materialOverride?this.materialOverride.getFullMaterial():null};e.prototype.clone=function(){var g=new e({opacity:this.opacity},this.materialOverride);return g};e.prototype.getRenderPriorityOpacity=function(){return this.opacity===null?null:this.opacity};e.prototype.hasTransparency=function(){var g=this.getOpacity();return g!==null&&g<1};var c=0;var f=b.extend({init:function(){this.id=c++;this.clipPlanes=[];this.clippingSettings=null;this.clipPolyLine=null;this.materialOverride=null;this.sectionCappingMaterials=null;this.readOnly=false;this.sectionLinesProperties=null;window.sealWebVisuObjects&&Object.seal(this)},clone:function(){var g=new f();g.clipPlanes=this.clipPlanes;g.clippingSettings=this.clippingSettings;g.clipPolyLine=this.clipPolyLine;g.sectionLinesProperties=this.sectionLinesProperties;if(this.materialOverride instanceof e){g.materialOverride=this.materialOverride.clone()}else{g.materialOverride=this.materialOverride}return g},getFullMaterial:function(){return this.materialOverride&&this.materialOverride.getFullMaterial()},setReadOnly:function(){this.readOnly=true},setRenderPriority:function(g){if(g&&g.opacity!==null){this.materialOverride=new e(g,this.materialOverride)}},getOverrideColor:function(h){if(!this.materialOverride){return null}if(h&&!h.overridable){return h.overridable}var g=this.getFullMaterial();if(g&&!g.overridable){return g.color}var j=this.materialOverride.getColor();if(j!==0&&j){return new d.Color(j)}return null}});f.setOverrideLink2Class=function(g){a=g};return f});define("Visualization/OccurrenceRenderingOverride",["DS/Visualization/OccurrenceRenderingOverride","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/OccurrenceRenderingOverride");return b});define("DS/QualityManager/QMGIController",["UWA/Core","UWA/Class","DS/QualityManager/QMGIPresetStreamer"],function(a,b,d){var c=b.singleton({init:function(){this.isInitialized=true;this.initPresetDB();this.properties={};this._QMSettings={MaxSamples:{value:{Static:true,Batch:false}},MinSamples:{value:{Static:true,Batch:false}},Clamping:{value:{Static:true,Batch:true}},GaussFilter:{value:{Static:true,Batch:true}},Size:{value:{Static:true,Batch:true}},CenterWeight:{value:{Static:true,Batch:true}},MAxTraceDepth:{value:{Static:true,Batch:true}},GlossyThreshold:{value:{Static:true,Batch:true}},RenderRefractiveShadow:{value:{Static:true,Batch:true}},LocationBasedSampling:{value:{Static:true,Batch:true}},Distribution:{value:{Static:true,Batch:true}},Factor:{value:{Static:true,Batch:true}},PathTerminationDepth:{value:{Static:true,Batch:true}},VisualizationMode:{value:{Static:true,Batch:false}},EnableFinalGathering:{value:{Static:true,Batch:true}},NoOfPhotons:{value:{Static:true,Batch:true}},PathDepth:{value:{Static:true,Batch:true}},PhotonRadius:{value:{Static:true,Batch:true}},RefineMap:{value:{Static:true,Batch:true}},PrecalculateIrradiance:{value:{Static:true,Batch:true}},Caustics:{value:{Static:true,Batch:true}},CausticsPhotonNumber:{value:{Static:true,Batch:true}},CausticsPathDepth:{value:{Static:true,Batch:true}},CausticRadius:{value:{Static:true,Batch:true}},CausticRefinePhotonMap:{value:{Static:true,Batch:true}},RayOffset:{value:{Static:true,Batch:true}},AllowGroundShadows:{value:{Static:true,Batch:true}},AllowReflectionsOnGround:{value:{Static:true,Batch:true}},AllowBloom:{value:{Static:true,Batch:true}},AllowDepthOfField:{value:{Static:true,Batch:true}},DownsamplingFctor:{value:{Static:true,Batch:false}},}},initPresetDB:function(){d.init();this.currentUser=d.getItem("currentUser");var e="Users/"+this.currentUser+"/currentPreset";this.currentPreset=d.getItem(e);this.prestToModify="Custom"},setCurrentUser:function(f){var g="Users/"+f;var e=d.getItem(g);if(a.is(e)){d.setItem("currentUser",f);this.currentUser=f}else{}},setCurrentPreset:function(g){var f="Users/"+this.currentUser+"/currentPreset";var e=d.getItem(f);if(a.is(e)){d.setItem(f,g);this.currentPreset=g}else{}},getCurrentUserPresetQuery:function(){var e="Users/"+this.currentUser+"/Preset/";return e},getCurrentPreset:function(){var f="Users/"+this.currentUser+"/currentPreset";var e=d.getItem(f);return e},validateAttribute:function(e,g){var f=true;if(e=="ReflectionsOnGround"||e=="Preset"){f=false}return f},setAttribute:function(j,f,e,g,h){this.setAttributeOnDB(j,f,e,g,h)},setAttributeOnDB:function(m,g,e,h,l){var j=this.getCurrentUserPresetQuery()+m+"/"+this.prestToModify+"/"+e+"/";var k=j+h;d.setItem(k,l);var f=j+"Preset";d.setItem(f,g)},setProperty:function(g,f,e){this.setPropertyOnDB(g,f,e)},setPropertyOnDB:function(m,g,f){var k=this.getCurrentUserPresetQuery()+m+"/"+g;var l=d.getItem(k);if(!a.is(l)){return false}var e=l[f];if(!a.is(e)){return false}for(var j in e){if(e.hasOwnProperty(j)){var h=e[j];this.setAttributeOnDB(m,g,f,j,h)}}},setGlobalPreset:function(g,f,e){this.setGlobalPresetOnDB(g,f,e)},setGlobalPresetOnDB:function(k,g,e){var h=this.getCurrentUserPresetQuery()+k+"/currentGlobalPreset";d.setItem(h,g);if(!e){return}h=this.getCurrentUserPresetQuery()+k+"/"+g;var j=d.getItem(h);if(!a.is(j)){return false}for(var f in j){if(j.hasOwnProperty(f)){this.setPropertyOnDB(k,g,f)}}},getCurrentGlobalPreset:function(g){var f=this.getCurrentUserPresetQuery()+g+"/currentGlobalPreset";var e=d.getItem(f);return e},getPresetValue:function(h,e){var g=this.getCurrentUserPresetQuery()+h+"/"+e;var f=d.getItem(g);return f},commitToDB:function(){d.commit()},restoreFromDB:function(){d.retoreDB();var f=this.getCurrentPreset();var e=this.getCurrentGlobalPreset(f);this.setGlobalPreset(f,e,false)},setQMsetting:function(f,h,g){var e=this._QMSettings[f];if(g=="true"){e.value[h]=true}else{e.value[h]=false}},getQMsetting:function(f,g){var e=this._QMSettings[f];return e.value[g]},});return c});define("DS/VisuLoaders/WebSocketLoader",[],function(){var a=window.mySocket;var b=function(g,e,f,d){this.msg=g;this.msgData=e;this.answer=f;this.onCompletedCB=d};b.emit=function(){};var c=function(){this.pendingRequests=[];this.pending=0;this.maxPending=5};c.prototype.isEnabled=function(){return a?true:false};c.prototype.emit=function(h,e,g,d){if(this.pending<this.maxPending){this._emit(h,e,g,d)}else{var f=new b(h,e,g,d);this.pendingRequests.push(f)}};c.prototype._emitNext=function(){if(this.pending<this.maxPending&&this.pendingRequests.length>0){var d=this.pendingRequests.shift();this._emit(d.msg,d.msgData,d.answer,d.onCompletedCB)}};c.prototype._emit=function(g,e,f,d){this.pending++;a.emit(g,e);var h=this;a.on(f,function(j){d(j);h.pending--;h._emitNext()})};return new c()});define("DS/VisuDataAccess/Ox4ExpandTask",[],function(){var a=function(g,e,j){this.oid=g;this.serverdefinition=e;this.relationship=j;var h=null;this.generateMQL=function(){return this.serverdefinition.rawmode?this.generateRawMQL():this.generateProcMQL()};this.generateRawMQL=function(){var k="start transaction ;\n";k+="expand businessobject  %oid% from relationship "+this.relationship+"  recurse to all size 1000 terse select bus physicalid type select relationship id physicalid dump | tcl;\n";k+="abort transaction ;\n";return k};this.generateProcMQL=function(){var k='<?xml version="1.0" encoding="utf-8"?>\n';k+='<executeSequence xmlns="http://www.3ds.com/xmql/query">\n';k+="\t<execute>\n";k+="\t\t<function>expand_bus</function>\n";k+="\t\t<version>2.0.0</version>\n";k+="\t\t<params>\n";k+='\t\t\t<param name="label">expand</param>\n';k+='\t\t\t<param name="rootid">%oid%</param>\n';k+='\t\t\t<param name="from">true</param>\n';k+='\t\t\t<param name="to"></param>\n';k+='\t\t\t<param name="typepattern">*</param>\n';k+='\t\t\t<param name="relpattern">'+this.relationship+"</param>\n";k+='\t\t\t<param name="fixedpointskw"/>\n';k+='\t\t\t<param name="fixedpointsids">[]</param>\n';k+='\t\t\t<param name="withroots">true</param>\n';k+='\t\t\t<param name="preventduplicates">false</param>\n';k+='\t\t\t<param name="recurselevel">all</param>\n';k+='\t\t\t<param name="size">1000</param>\n';k+='\t\t\t<param name="terse">true</param>\n';k+='\t\t\t<param name="selectbo"> ["physicalid", "type", "attribute[PLMEntity.V_Name]", "attribute[PLMEntity.PLM_ExternalID]", "owner"]</param>\n';k+='\t\t\t<param name="wherebokw"/>\n';k+='\t\t\t<param name="wherebo"/>\n';k+='\t\t\t<param name="selectrel">["id","physicalid", "attribute[PLMInstance.V_Name]", "attribute[PLMInstance.PLM_ExternalID]", "owner"]</param>\n';k+='\t\t\t<param name="whererel"/>\n';k+='\t\t\t<param name="dump">|</param>\n';k+='\t\t\t<param name="notsubstitute">true</param>\n';k+="\t\t</params>\n";k+="\t</execute>\n";k+="</executeSequence>\n";return k};var f=this.generateMQL();this.run=function(m,n,p,k,q){h=m;console.log("running Ox4xMQLExpandTask");var l=e.xmqlServiceUri();var o=f.replace("%oid%",this.oid);n.executePostHttpRequest(l,e.rawmode,o,function(s){console.log("callback has been called");var r=new d(g,m,s,function(){k(this)})})};this.dataSet=function(){return h};var c={bus:[],rel:[]};var b=function(m,o){var n=o;var l=m;var k=new Array();this.setFatherLevel=function(r){var q=(k.length-1);if(r>q){}else{if(r<=q){var p=q;while(p!=r){k.pop();p=p-1}k.pop()}}};this.lastNode=function(){return k[k.length-1]};this.pushNode=function(p){k.push(p)};this.getRootNode=function(){return n.rootNode()};this.pushNode(n.rootNode());this.registerRelationship=function(r,q){n.registerRelationship(q);var p=n.findNodeByPhysicalId(q.to.phyid);this.pushNode(p)}};var d=function(k,n,q,p){var o=new b(k,n);var l=function(u){var v=/[^\r\n]+/g;var t=-1;var r=false;var s;while(((s=v.exec(q))!==null)&&(!r)){m(s[0]);if(v.lastIndex===t){r=true}t=v.lastIndex}n.FindWorkTypes(c,function(){p()})};var m=function(y){var v=/\{([^\{\}]*)}/g;var s=-1;var u=false;var A;var w=0;var x=new Object();x.to=new Object();var r=-1;while(((A=v.exec(y))!==null)&&(!u)){var t=A[1];if(r==="0"){if(w===6){o.getRootNode().title=t}else{if(w===7){o.getRootNode().plmexternalId=t}else{if(w===8){o.getRootNode().owner=t}}}}else{if(w===0){r=t;if(r==="0"){w=w+1;continue}o.setFatherLevel(r)}else{if(w===1){x.plmtype=t;if(c.rel.indexOf(t)===-1){c.rel.push(t)}}else{if(w===2){}else{if(w===3){x.to.ident=t}else{if(w===4){x.to.phyid=t}else{if(w===5){x.to.plmtype=t;if(c.bus.indexOf(t)===-1){c.bus.push(t)}}else{if(w===6){x.to.title=t}else{if(w===7){x.to.realName=t}else{if(w===8){x.to.owner=t}else{if(w===9){x.ident=t}else{if(w===10){x.phyid=t}else{if(w===11){x.title=t}else{if(w===12){x.realName=t}else{if(w===13){x.owner=t}}}}}}}}}}}}}}}w=w+1;if(v.lastIndex===s){isILinenfiniteLoop=true}s=v.lastIndex}if(r!=="0"){if(x.phyid!==undefined){var z=o.lastNode();x.from=z;o.registerRelationship(r,x)}}};l(q)}};return a});define("VisuDataAccess/Ox4ExpandTask",["DS/VisuDataAccess/Ox4ExpandTask","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/Ox4ExpandTask");return b});define("DS/Animation/ANIM",[],function(){var a={assert:function(b){if(!b){throw"ANIM.assert failed"}},assertX:function(b,c){if(!b){throw"ANIM.assert failed:"+c}}};a.State={RUNNING:0,STOPPED:1,PAUSED:2};a.Direction={FORWARD:0,BACKWARD:1};return a});define("Animation/ANIM",["DS/Animation/ANIM","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Animation/ANIM");return b});define("DS/Effects/SaveAsHDR",[],function(){var a={writeHDRHeader:function(b,k){var l=function(p,o,n){for(var m=0;m<o.length;m++){p[n++]=o.charCodeAt(m)}return n};var c="#?RADIANCE";var h="# Made with Dassault Systemes HDR mipmap roughness generator - TZW";var e="FORMAT=32-bit_rle_rgbe";var d="-Y "+k+" +X "+b;var j=c.length+1+h.length+1+e.length+2+d.length+1;var g=new Uint8Array(j+b*k*4);var f=0;f=l(g,c,f);g[f++]=10;f=l(g,h,f);g[f++]=10;f=l(g,e,f);g[f++]=10;g[f++]=10;f=l(g,d,f);g[f++]=10;return{buffer:g,offset:f,width:b,height:k}},writeTexture:function(b,l,n,m){var f=4*l.width*m;var g=4*n;var h=b.height-1;for(var d=0;d<b.height;d++){var o=b.width-1;for(var e=0;e<b.width;e++){for(var c=0;c<4;c++){l.buffer[l.offset+f+g+4*e+c]=255*b.buffer[4*(b.width*h+o)+c]}o--}f+=4*l.width;h--}},compressHDR:function(r){var s=function(k){var j=new Uint8Array(2*k.length);for(var c=0;c<k.length;c++){j[c]=k[c]}return j};var h=r.offset;var p=h;var v=new Uint8Array(r.buffer.length);for(var n=0;n<h;n++){v[n]=r.buffer[n]}var w=new Uint8Array(4+5*r.width);for(var l=0;l<r.height;l++){var f=0;w[f++]=2;w[f++]=2;w[f++]=r.width>>8;w[f++]=r.width&255;for(var t=0;t<4;t++){var u=[];var n=0;while(n<r.width){var e=0;var q=r.buffer[h+4*(l*r.width+n)+t];var d=q;while(n<r.width&&d===q&&e<127){e++;n++;q=d;d=r.buffer[h+4*(l*r.width+n)+t]}if(e>3){if(u.length){w[f++]=u.length;for(var g=0;g<u.length;g++){w[f++]=u[g]}u=[]}w[f++]=128+e;w[f++]=q}else{if(u.length+e>127){w[f++]=u.length;for(var g=0;g<u.length;g++){w[f++]=u[g]}u=[]}u.push(q);if(e>1){u.push(q)}if(e>2){u.push(q)}}}if(u.length){w[f++]=u.length;for(var g=0;g<u.length;g++){w[f++]=u[g]}}}if(p+f>=v.length){v=s(v)}for(var b=0;b<f;b++){v[p++]=w[b]}}var o=new Uint8Array(p);for(var n=0;n<p;n++){o[n]=v[n]}r.buffer=o}};return a});define("DS/VisuDataAccess/Ox4SetTask",[],function(){var a=function(g,j){var h=this;var b=g;var c=j;var d=function(){return c.rawmode?e():k()};var e=function(){var l="start transaction ;\n";if(b){l+="label deleteset delete set %1"}else{l+="label addset add set %1 type temporary hidden;"}l+="commit transaction;";return l};var k=function(){var l='<?xml version="1.0" encoding="utf-8"?>\n';l+='<executeSequence xmlns="http://www.3ds.com/xmql/query">\n';l+="\t<execute>\n";if(b){l+="\t\t<function>delete_set</function>\n"}else{l+="\t\t<function>add_set</function>\n"}l+="\t\t<version>2.0.0</version>\n";l+="\t\t<params>\n";if(b){l+='\t\t\t<param name="label">deleteset</param>\n'}else{l+='\t\t\t<param name="label">addset</param>\n'}l+='\t\t\t<param name="setname">%1</param>\n';l+="\t\t</params>\n";l+="\t</execute>\n";l+="</executeSequence>\n";return l};var f=d();this.run=function(n,o,q,l,r){console.log("running Ox4MQLSetTask");var m=c.xmqlServiceUri();var p=f.replace("%1",o.SetName);o.executePostHttpRequest(m,c.rawmode,p,function(s){console.log((b?"Delete":"Add")+" Set: OK!");l(this)})}};return a});define("DS/VisuDataAccess/Ox4TicketGeneratorTask",[],function(){var a=function(e,b){var d=e;var c=b;this.generateRequest=function(){var f={url:c.xmqlServiceUri(),data:d};return f}};return a});define("VisuDataAccess/Ox4TicketGeneratorTask",["DS/VisuDataAccess/Ox4TicketGeneratorTask","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/Ox4TicketGeneratorTask");return b});define("DS/VisuDataAccess/Ox4DECSelectTask",[],function(){var a=function(c,j,k){var l=c;var e=null;var b=j;var g=function(q,r,v,u){var t=q;var s=r;var o=function(z){var A=/[^\r\n]+/g;var y=-1;var w=false;var x;while(((x=A.exec(v))!==null)&&(!w)){p(t,x[0]);if(A.lastIndex===y){w=true}y=A.lastIndex}u()};var p=function(D,x){var C=/\{([^\}]*)}/g;x=x.substring(1,(x.length-1));var z=-1;var w=false;var B;var A=0;var y=new Array();while(((B=C.exec(x))!==null)&&(!w)){if(B[0].indexOf("{{")==0){B[0]=B[0].substring(2,B[0].length)}if(B[0].indexOf("{")==0){B[0]=B[0].substring(1,B[0].length)}if(B[0].indexOf("}")==(B[0].length-1)){B[0]=B[0].substring(0,B[0].length-1)}y.push(B[0]);A=A+1;if(C.lastIndex===z){isILinenfiniteLoop=true}z=C.lastIndex}t.injectRowInto(y,s)};o(v)};var d=function(){return b.rawmode?f():n()};var f=function(){var o="start transaction ;\n";if(l.boOrRel==0){o+="query connection type '%1'  where \"physicalid matchlist '%2'','\"  select %3 dump | tcl;\n"}else{if(l.boOrRel==1){o+="temporary query businessobject  '%1' * *  where \"physicalid matchlist '%2'','\"  select %3 dump | tcl;\n"}else{if(l.boOrRel==2){o+="temporary query businessobject  * * *  where \"physicalid matchlist '"+k+"'','\"  select %3 dump | tcl;\n"}else{o+=" expand businessobject "+k+' from relationship "CAD SubComponent" recurse to all size 1000 terse select bus physicalid name dump | tcl;\n'}}}o+="abort transaction ;\n";return o};var n=function(){var o='<?xml version="1.0" encoding="utf-8"?>\n';o+='<executeSequence xmlns="http://www.3ds.com/xmql/query">\n';o+="\t<execute>\n";if(l.boOrRel>=0&&l.boOrRel<=2){if(l.boOrRel==0){o+="\t\t<function>query_connection</function>\n"}else{o+="\t\t<function>query_bus</function>\n"}o+="\t\t<version>2.2.1</version>\n";o+="\t\t<params>\n";o+='\t\t\t<param name="label">select</param>\n';if(l.boOrRel!=0){o+='\t\t\t<param name="name">*</param>\n';o+='\t\t\t<param name="revision">*</param>\n'}o+='\t\t\t<param name="vault">*</param>\n';o+='\t\t\t<param name="orderbykw"/>\n';o+='\t\t\t<param name="orderby"/>\n';o+='\t\t\t<param name="limitkw"/>\n';o+='\t\t\t<param name="limit"/>\n';o+='\t\t\t<param name="where">where</param>\n';o+='\t\t\t<param name="select">%3</param>\n';if(l.boOrRel==2){o+='\t\t\t<param name="type">*</param>\n';o+='\t\t\t<param name="where">physicalid matchlist \''+k+"'','</param>\n"}else{o+='\t\t\t<param name="type">%1</param>\n';o+="\t\t\t<param name=\"where\">physicalid matchlist '%2'','</param>\n"}o+='\t\t\t<param name="notsubstitute">true</param>\n';o+='\t\t\t<param name="dump">|</param>\n';o+="\t\t</params>\n"}else{o+="\t\t<function>expand_bus</function>\n";o+="\t\t<version>2.0.0</version>\n";o+="\t\t<params>\n";o+='\t\t\t<param name="label">expand</param>\n';o+='\t\t\t<param name="rootid">'+k+"</param>\n";o+='\t\t\t<param name="from">true</param>\n';o+='\t\t\t<param name="to"/>\n';o+='\t\t\t<param name="typepattern">*</param>\n';o+='\t\t\t<param name="relpattern">"CAD SubComponent"</param>\n';o+='\t\t\t<param name="fixedpointskw"/>\n';o+='\t\t\t<param name="fixedpointsids">[]</param>\n';o+='\t\t\t<param name="withroots">false</param>\n';o+='\t\t\t<param name="preventduplicates">false</param>\n';o+='\t\t\t<param name="recurselevel">all</param>\n';o+='\t\t\t<param name="selectbo"> ["physicalid", "name"]</param>\n';o+='\t\t\t<param name="wherebo"/>\n';o+='\t\t\t<param name="selectrel"/>\n';o+='\t\t\t<param name="whererelkw"/>\n';o+='\t\t\t<param name="whererel"/>\n';o+='\t\t\t<param name="dump">|</param>\n';o+="\t\t</params>\n"}o+="\t</execute>\n";o+="</executeSequence>\n";return o};var h=d();this.run=function(u,r,t,w,v){e=u;console.log("running Ox4xMQLSelectTask");var p=b.xmqlServiceUri();var o=l.typeRequested();var q=u.findNodeByPLMTypeExpressedAsPhyIdSeparatedByComma(o);if(q.length>0){var s=h.replace("%1",o);s=s.replace("%3",l.marshallAsMQLListOfFetchAttributesAsJSON());s=s.replace("%2",q);r.executePostHttpRequest(p,b.rawmode,s,function(x){m(x,u,w)})}else{w(this)}};var m=function(q,r,p){var o=new g(l,r,q,function(){p(this)})}};return a});define("VisuDataAccess/Ox4DECSelectTask",["DS/VisuDataAccess/Ox4DECSelectTask","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/Ox4DECSelectTask");return b});define("DS/Shaders/CompositeShader",[],function(){var a={defines:{USE_BLOOM:0},uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDiffuse4:{type:"t",value:null},tDiffuse5:{type:"t",value:null},tDiffuse6:{type:"t",value:null},brightness:{type:"f",value:1},bloomFactor:{type:"f",value:0.9},gamma:{type:"f",value:2.2}},fragmentShader:["varying vec2 texCoord;","uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform sampler2D tDiffuse4;","uniform sampler2D tDiffuse5;","uniform sampler2D tDiffuse6;","uniform float brightness;","uniform float bloomFactor;","uniform float gamma;","#if defined (TONEMAP_FILMIC_NRE) || defined (TONEMAP_FILMIC_NRE_APPROXIMATE)","	#define FILMIC_NRE_A 0.22","	#define FILMIC_NRE_B 0.3","	#define FILMIC_NRE_C 0.1","	#define FILMIC_NRE_D 0.2","	#define FILMIC_NRE_E 0.01","	#define FILMIC_NRE_F 0.3","	#define FILMIC_NRE_W 11.2","#endif","#if defined (TONEMAP_PHOTOGRAPHIC_NRE)","	#define PHOTO_NRE_CRUSHBLACKS /*0.75*/0.0","	#define PHOTO_NRE_BURNHIGHLIGHTS /*0.25*/0.0","	#define PHOTO_NRE_SATURATION 1.0","	#define PHOTO_NRE_COLORCORRECTION_X 1.0","	#define PHOTO_NRE_COLORCORRECTION_Y 1.0","	#define PHOTO_NRE_COLORCORRECTION_Z 1.0","   float luminance_RGB (vec3 iColor) {","		vec3 luminance_weight=vec3(0.176204,0.812985,0.0108109);","		return dot(iColor,luminance_weight);","	}","#endif","#ifdef TONEMAP_UNCHARTED","   const float A = 0.15;","   const float B = 0.50;","   const float C = 0.10;","   const float D = 0.20;","   const float E = 0.02;","   const float F = 0.30;","   const float W = 11.2;","   vec3 Uncharted2Tonemap( vec3 x ) {","       return ( ( x * ( A * x + C * B ) + D * E ) / ( x * ( A * x + B ) + D * F ) ) - E / F;","   }","#endif","float dither = 0.004;","float random(vec3 scale, float seed) {","  return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","vec3 Random3D(float seed) {","vec3 res;","res.x = random(vec3(12.9898, 78.233, 151.7182), seed);","res.y = random(vec3(63.7264, 10.873, 623.6736), seed);","res.z = random(vec3(125.5736, 34.485, 437.2873), seed);","return res;","}","vec4 chromaticAberration(const in sampler2D tex, const in vec2 uv, const in float factor) {","vec2 dist = uv - 0.5;","vec2 offset = factor * dist * length(dist);","vec4 col;","col.r  = texture2D(tex, uv - offset).r;","col.ga = texture2D(tex, uv).ga;","col.b  = texture2D(tex, uv + offset).b;","return col;","}","float RGBToL(const in vec3 color) {","float fmin = min(min(color.r, color.g), color.b);","float fmax = max(max(color.r, color.g), color.b);","return (fmax + fmin) / 2.0;","}","vec3 colorBalance(const in vec3 color, const in vec3 lrgb, const in vec3 mrgb, const in vec3 hrgb) {","float lightness = RGBToL(color);","lightness = (1.5 * lightness) / (lightness + 0.5);","float a = 0.25;","float b = 0.333;","float scale = 0.7;","vec3 low = lrgb * clamp((lightness - b) / -a + 0.5, 0.0, 1.0);","vec3 mid = mrgb * clamp((lightness - b) / a + 0.5, 0.0, 1.0) * clamp((lightness + b - 1.0) / -a + 0.5, 0.0, 1.0);","vec3 high = hrgb * clamp((lightness + b - 1.0) / a + 0.5, 0.0, 1.0);","vec3 newColor = color + (low + mid + high) * scale;","newColor = clamp(newColor, 0.0, 1.0);","return normalize(newColor) * length(color);","}","void main() {","   vec4 inColorAlpha = texture2D( tDiffuse, texCoord );","   vec3 inColor = inColorAlpha.xyz;","   inColor *= brightness;","#if (USE_BLOOM == 1)","    vec4 bloom1 = texture2D( tDiffuse2, texCoord );","    vec4 bloom2 = texture2D( tDiffuse3, texCoord );","    vec4 bloom3 = texture2D( tDiffuse4, texCoord );","    vec4 bloom4 = texture2D( tDiffuse5, texCoord );","    vec4 bloom5 = texture2D( tDiffuse6, texCoord );","    vec3 bloom = 0.5 * bloom1.rgb + 0.5 * bloom2.rgb + 0.5 * bloom3.rgb + 0.5 * bloom4.rgb + 0.5 * bloom5.rgb;","	 inColor += bloomFactor * bloom;","#endif","   vec3 outColor;","   #if defined( TONEMAP_SIMPLE )","       outColor = sqrt( inColor );","   #elif defined( TONEMAP_LINEAR )","       outColor = pow( inColor, vec3( 1.0 / gamma ) );","   #elif defined( TONEMAP_REINHARD )","       inColor = inColor / ( 1.0 + inColor );","       outColor = pow( inColor, vec3( 1.0 / gamma ) );","   #elif defined( TONEMAP_FILMIC )","       vec3 x = max( vec3( 0.0 ), inColor - 0.004 );","       outColor = ( x * ( 6.2 * x + 0.5 ) ) / ( x * ( 6.2 * x + 1.7 ) + 0.06 );","   #elif defined( TONEMAP_UNCHARTED )","       float ExposureBias = 2.0;","       vec3 curr = Uncharted2Tonemap( ExposureBias * inColor );","       vec3 whiteScale = vec3( 1.0 ) / Uncharted2Tonemap( vec3( W ) );","       vec3 color = curr * whiteScale;","       outColor = pow( color, vec3( 1.0 / gamma ) );","   #elif defined( TONEMAP_FILMIC_NRE )","		vec4 tmpCol = vec4(inColor.xyz, FILMIC_NRE_W);","		tmpCol = ((tmpCol*(FILMIC_NRE_A*tmpCol+FILMIC_NRE_C*FILMIC_NRE_B)+FILMIC_NRE_D*FILMIC_NRE_E)","		/(tmpCol*(FILMIC_NRE_A*tmpCol+FILMIC_NRE_B)+FILMIC_NRE_D*FILMIC_NRE_F))","		-FILMIC_NRE_E/FILMIC_NRE_F;","		tmpCol.xyz = tmpCol.xyz/tmpCol.w;","		outColor.x = (tmpCol.x < 0.0031308)  ? (tmpCol.x*12.92) : 1.055*pow(tmpCol.x, 0.41666) - 0.055;","		outColor.y = (tmpCol.y < 0.0031308)  ? (tmpCol.y*12.92) : 1.055*pow(tmpCol.y, 0.41666) - 0.055;","		outColor.z = (tmpCol.z < 0.0031308)  ? (tmpCol.z*12.92) : 1.055*pow(tmpCol.z, 0.41666) - 0.055;","   #elif defined( TONEMAP_FILMIC_NRE_APPROXIMATE )","		vec4 tmpCol = vec4(inColor.xyz, FILMIC_NRE_W);","		tmpCol = ((tmpCol*(FILMIC_NRE_A*tmpCol+FILMIC_NRE_C*FILMIC_NRE_B)+FILMIC_NRE_D*FILMIC_NRE_E)","		/(tmpCol*(FILMIC_NRE_A*tmpCol+FILMIC_NRE_B)+FILMIC_NRE_D*FILMIC_NRE_F))","		-FILMIC_NRE_E/FILMIC_NRE_F;","		tmpCol.xyz = tmpCol.xyz/tmpCol.w;","       vec3 S1 = sqrt(tmpCol.xyz);","       vec3 S2 = sqrt(S1);","       vec3 S3 = sqrt(S2);","		outColor = 0.585122381 * S1 + 0.783140355 * S2 - 0.358252735 *S3;","   #elif defined( TONEMAP_PHOTOGRAPHIC_NRE )","		vec3 c = inColor.xyz * vec3(PHOTO_NRE_COLORCORRECTION_X,PHOTO_NRE_COLORCORRECTION_Y,PHOTO_NRE_COLORCORRECTION_Z);","		c *= (c*PHOTO_NRE_BURNHIGHLIGHTS+1.0)/(c+1.0); ","		c = mix(vec3(luminance_RGB(c)),c,PHOTO_NRE_SATURATION);","		float intens = luminance_RGB(c);","		if(intens<1.0){","			float crushblacks = 2.0* PHOTO_NRE_CRUSHBLACKS +1.0;","			intens = sqrt(intens);","			float oms2 = 1.0 - intens;"," 			c.x = c.x*intens + pow(c.x,crushblacks)*oms2;","			c.y = c.y*intens + pow(c.y,crushblacks)*oms2;"," 			c.z = c.z*intens + pow(c.z,crushblacks)*oms2;","		}","		outColor.x = (c.x < 0.0031308)  ? (c.x*12.92) : 1.055*pow(c.x, 0.41666) - 0.055;","		outColor.y = (c.y < 0.0031308)  ? (c.y*12.92) : 1.055*pow(c.y, 0.41666) - 0.055;","		outColor.z = (c.z < 0.0031308)  ? (c.z*12.92) : 1.055*pow(c.z, 0.41666) - 0.055;","   #elif defined( TONEMAP_LINEAR_NRE )","		vec3 c = inColor.xyz ;","		outColor.x = (c.x < 0.0031308)  ? (c.x*12.92) : 1.055*pow(c.x, 0.41666) - 0.055;","		outColor.y = (c.y < 0.0031308)  ? (c.y*12.92) : 1.055*pow(c.y, 0.41666) - 0.055;","		outColor.z = (c.z < 0.0031308)  ? (c.z*12.92) : 1.055*pow(c.z, 0.41666) - 0.055;","   #else","       outColor = inColor;","   #endif","   outColor += 2.0 * dither * (Random3D(texCoord.x + texCoord.y) - vec3(0.5));","   gl_FragColor = vec4( outColor, inColorAlpha.a );","}"].join("\n"),vertexShader:["varying vec2 texCoord;","void main() {","   vec4 pos = vec4( sign( position.xy ), 0.0, 1.0 );","   texCoord = pos.xy * vec2( 0.5 ) + 0.5;","   gl_Position = pos;","}"].join("\n")};return a});define("Shaders/CompositeShader",["DS/Shaders/CompositeShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/CompositeShader");return b});define("DS/Visualization/Detector",[],function(){var a={canvas:!!window.CanvasRenderingContext2D,webgl:(function(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(b){return false}})(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var b;if(!this.webgl){if(window.WebGLRenderingContext){b='Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />'}else{b='Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>'}b+='Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'}return b}};return a});define("Visualization/Detector",["DS/Visualization/Detector","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/Detector");return b});define("DS/Shaders/AdvancedHighlightShaderSinglePass",["DS/Visualization/ThreeJS_R57"],function(c){var d={uniforms:c.UniformsUtils.merge([c.UniformsLib.clipPlanes,c.UniformsLib.skinning,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new c.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new c.Vector4(1,1)},iScanEffectIntensity:{type:"f",value:1},iOutlineColor2:{type:"v4",value:new c.Vector4(0,1,1,1)},iOutlineColor:{type:"v4",value:new c.Vector4(0,0.6,1,1)},iScanEffectColor:{type:"v4",value:new c.Vector4(0,0.6,1,1)},},]),vertexShaderPars:[c.ShaderChunk.clip_pars_vertex,"varying float reflectionFactor;",].join("\n"),vertexShaderBody:["    vec3 I = normalize( -mvPosition.xyz );","    reflectionFactor = abs( dot( I, mvNormal ) );",c.ShaderChunk.clip_vertex].join("\n"),fragmentShaderPars:[c.ShaderChunk.clip_pars_fragment,"varying float reflectionFactor;","uniform float iScanEffectIntensity;","uniform vec4 iScanEffectColor;",].join("\n"),fragmentShaderBody:[c.ShaderChunk.clip_fragment,"   float alpha = 1.0 - pow(reflectionFactor, 2.0);","   alpha *= alpha;","	gl_FragColor = vec4(iScanEffectColor.xyz, 0.6 * alpha + 0.2);",].join("\n"),vertexShader:[c.ShaderChunk.clip_pars_vertex,c.ShaderChunk.skinning_pars_vertex,"varying float reflectionFactor;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","void main() {",c.ShaderChunk.PDSFX_start_vertex,c.ShaderChunk.skinbase_vertex,c.ShaderChunk.skinnormal_vertex,c.ShaderChunk.defaultnormal_vertex,c.ShaderChunk.skinning_vertex,c.ShaderChunk.default_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif","    vec3 I = normalize( -mvPosition.xyz );","    reflectionFactor = abs( dot( I, transformedNormal ) );","#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif","    gl_Position = projectionMatrix * mvPosition;",c.ShaderChunk.clip_vertex,c.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[c.ShaderChunk.clip_pars_fragment,"varying float reflectionFactor;","float finalReflectionFactor;","uniform float iScanEffectIntensity;","uniform vec4 iScanEffectColor;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","void main() {","finalReflectionFactor = reflectionFactor;","#ifdef PDSFX","ComputeCommonValues();",c.ShaderChunk.PDSFX_discard_fragment,c.ShaderChunk.PDSFX_viewNormal_fragment,"vec3 mvPosition = ComputeViewPosition();","    vec3 I = normalize( -mvPosition.xyz );","    finalReflectionFactor = abs( dot( I, _DSvNormal ) );","#endif",c.ShaderChunk.clip_fragment,"   float alpha = 1.0 - pow(finalReflectionFactor, 2.0);","   alpha *= alpha;","#ifdef USE_MAP_ALPHATEST","   float alpha2 = texture2D( map, vUvMap ).w;","   if ( alpha2 < ALPHATEST ) discard;","#endif","   gl_FragColor = vec4(iScanEffectColor.xyz, (0.6 * alpha + 0.2) * iScanEffectIntensity);","}"].join("\n")};var b={uniforms:c.UniformsUtils.merge([c.UniformsLib.clipPlanes,c.UniformsLib.lines,{iScanEffectColor:{type:"v4",value:new c.Vector4(0,0.7,1,1)}}]),vertexShaderPars:[c.ShaderChunk.clip_pars_vertex,c.ShaderChunk.lines_pars_vertex,].join("\n"),vertexShaderBody:[c.ShaderChunk.clip_vertex,c.ShaderChunk.lines_vertex].join("\n"),fragmentShaderPars:[c.ShaderChunk.clip_pars_fragment,c.ShaderChunk.lines_pars_fragment,"uniform vec4 iScanEffectColor;",].join("\n"),fragmentShaderBody:[c.ShaderChunk.clip_fragment,c.ShaderChunk.lines_fragment,"	gl_FragColor = vec4( iScanEffectColor.xyz, 1.0 );",].join("\n"),vertexShader:[c.ShaderChunk.clip_pars_vertex,c.ShaderChunk.lines_pars_vertex,"void main() {",c.ShaderChunk.PDSFX_start_vertex,c.ShaderChunk.default_vertex,c.ShaderChunk.clip_vertex,c.ShaderChunk.lines_vertex,c.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[c.ShaderChunk.clip_pars_fragment,c.ShaderChunk.lines_pars_fragment,"uniform vec4 iScanEffectColor;","void main() {","#ifdef PDSFX","ComputeCommonValues();",c.ShaderChunk.PDSFX_discard_fragment,"#endif",c.ShaderChunk.clip_fragment,c.ShaderChunk.lines_fragment,"	gl_FragColor = vec4( iScanEffectColor.xyz, 1.0 );","}"].join("\n")};var a={uniforms:c.UniformsUtils.merge([c.UniformsLib.clipPlanes,{map:{type:"t",value:null},size:{type:"f",value:1},scale:{type:"f",value:500},offsetAlphaMap:{type:"v2",value:new c.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new c.Vector4(1,1)},iScanEffectColor:{type:"v4",value:new c.Vector4(0,0.7,1,1)}}]),vertexShaderPars:[c.ShaderChunk.clip_pars_vertex,"uniform float size;","uniform float scale;"].join("\n"),vertexShaderBody:[c.ShaderChunk.clip_vertex,"#ifdef USE_SIZEATTENUATION","gl_PointSize = size * ( scale / length( mvPosition.xyz ) );","#else","gl_PointSize = size;","#endif"].join("\n"),fragmentShaderPars:[c.ShaderChunk.clip_pars_fragment,"uniform vec4 iScanEffectColor;","#ifdef USE_MAP_ALPHATEST","uniform sampler2D map;","#endif"].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).w;","   if ( alpha < ALPHATEST ) discard;","#endif",c.ShaderChunk.clip_fragment,"    gl_FragColor = vec4( iScanEffectColor.xyz, 1.0 );"].join("\n"),vertexShader:[c.ShaderChunk.clip_pars_vertex,"uniform float size;","uniform float scale;","#ifdef USE_MAP_ALPHATEST","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","void main() {",c.ShaderChunk.PDSFX_start_vertex,c.ShaderChunk.default_vertex,c.ShaderChunk.PDSFX_point_size_vertex,c.ShaderChunk.clip_vertex,c.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[c.ShaderChunk.clip_pars_fragment,"uniform vec4 iScanEffectColor;","#ifdef USE_MAP_ALPHATEST","uniform sampler2D map;","#endif","void main() {","#ifdef PDSFX","ComputeCommonValues();",c.ShaderChunk.PDSFX_discard_fragment,"#endif","#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).w;","   if ( alpha < ALPHATEST ) discard;","#endif",c.ShaderChunk.clip_fragment,"    gl_FragColor = vec4( iScanEffectColor.xyz, 1.0 );","}"].join("\n")};return{HighlightFace:d,HighlightEdge:b,HighlightPoint:a}});define("Shaders/AdvancedHighlightShaderSinglePass",["DS/Shaders/AdvancedHighlightShaderSinglePass","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/AdvancedHighlightShaderSinglePass");return b});define("DS/VisuDataAccess/Ox4xMQLSelectTaskDefinition",[],function(){var a=function(e,b,h,c){var d=e;var g=b;this.boOrRel=c;this.injectRowInto=h;var f=function(j){var l="";for(var k=0;k<j.length;k++){l=l+" "+j[k]}return l};this.typeRequested=function(){return d};this.attributes=function(){return listOfAttributes};this.marshallAsMQLListOfFetchAttributes=function(){if(g.Fetch===null){throw"no fetch attributes selected"}return f(g.Fetch)};this.marshallAsMQLListOfFetchAttributesAsJSON=function(){if(g.Fetch===null){throw"no fetch attributes selected"}return JSON.stringify(g.Fetch)};this.hasPathAttrs=function(){return(typeof(g.Path)!=="undefined"&&g.Path!==null)};this.marshallAsMQLListOfPathAttributes=function(){if(g.Path===null){throw"no path attributes selected"}return f(g.Path)};this.marshallAsMQLListOfPathAttributesAsJSON=function(){if(g.Fetch===null){throw"no fetch attributes selected"}return JSON.stringify(g.Path)}};return a});define("VisuDataAccess/Ox4xMQLSelectTaskDefinition",["DS/VisuDataAccess/Ox4xMQLSelectTaskDefinition","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/Ox4xMQLSelectTaskDefinition");return b});define("DS/VisuDataAccess/Ox4PLMDataHelper",[],function(){var a=function(m){var b=m;var c=b.threedexpServiceUri();var h=function(){return b.rawmode?k():r()};var k=function(){var s="start transaction ;\n";s+="get checkout ticket nozip mcsurl %1 \n";s+=" store %2 \n";s+="businessobjectproxy physicalid %3 format %4 filename %5 tcl;\n";s+="abort transaction ;\n";return s};var r=function(){var s='<?xml version="1.0" encoding="utf-8"?>\n';s+='<executeSequence xmlns="http://www.3ds.com/xmql/query">\n';s+="\t<execute>\n";s+="\t\t<function>get_checkout_ticket</function>\n";s+="\t\t<version>2.0.0</version>\n";s+="\t\t<params>\n";s+='\t\t\t<param name="label">checkout</param>\n';s+='\t\t\t<param name="zipkw">nozip</param>\n';s+='\t\t\t<param name="mcsurl">%1</param>\n';s+='\t\t\t<param name="bops">[{"store": "%2", "bops": [{"physicalid": "%3", "format": "%4", "filename": "%5"}]}]</param>\n';s+="\t\t</params>\n";s+="\t</execute>\n";s+="</executeSequence>\n";return s};var p=h();this.transformSelectedFileIntoTicketRequest=function(u,s,t,v){return g(u,t,s,v)};this.transformSelectedSDByRoleAndFormatIntoTicketRequest=function(w,x,v,t,s,u){if(x.indexOf("SDv2")==0){return this.transformSelectedSDv2ByRoleAndFormatIntoTicketRequest(w,x,v,t,s,u)}if(x.indexOf("SDV0")==0){return this.transformSelectedSDv0ByRoleAndFormatIntoTicketRequest(w,x,v,t,s,u)}return"E_NOTIMPLEMENTED"};this.transformSelectedSDv0ByRoleAndFormatIntoTicketRequest=function(x,s,y,u,t,z){var w=e(s);var v=d(w,y,u,t);var A=null;if(v!==null){A=n(x,v,z)}return A};this.transformSelectedSDv2ByRoleAndFormatIntoTicketRequest=function(x,s,y,u,t,z){var w=j(s);var v=d(w,y,u,t);var A=null;if(v!==null){A=n(x,v,z)}return A};var n=function(u,v,t){var w=""+u+"_"+v.role+"."+v.format;if(v.persistancyname!==undefined&&v.persistancyname.length>0){w+="="+v.persistancyname}w+="";var s=p.replace("%1",c);var s=s.replace("%2",t);var s=s.replace("%3",u);var s=s.replace("%4",v.format);var s=s.replace("%5",w);return s};var g=function(u,t,v,w){var s=p.replace("%1",c);var s=s.replace("%2",t);var s=s.replace("%3",u);var s=s.replace("%4",v);var s=s.replace("%5",w);return s};var d=function(w,v,z,s){for(var t=0;t<s.length;t++){var y=s[t];for(var u=0;u<w.length;u++){var x=w[u];if((x.role==z)&&(x.format==y)&&(x.latetype==v)){return x}}}return null};var e=function(t){var x=/[^:]+/g;var u=-1;var s=false;var w;var v=0;var y=[];while(((w=x.exec(t))!==null)&&(!s)){var z=q(w[0]);y.push(z);v=v+1;if(x.lastIndex===u){isILinenfiniteLoop=true}u=x.lastIndex}return y};var q=function(s){var t=s.slice(3,4);var u=s.slice(5,s.length-1);return l(t,u)};function l(x,t){var y=/[^,]+/g;var u=-1;var s=false;var w;var v=0;var z=new Object();z.sdtype=x;while(((w=y.exec(t))!==null)&&(!s)){if(v===0){z.format=w[0]}else{if(v===1){z.role=w[0]}else{if(v===2){z.latetype=w[0]}else{if(v===3){z.watermarkstamp=w[0]}}}}v=v+1;if(y.lastIndex===u){isILinenfiniteLoop=true}u=y.lastIndex}return z}var j=function(t){var x=/[^:]+/g;var u=-1;var s=false;var w;var v=0;var y=[];while(((w=x.exec(t))!==null)&&(!s)){var z=o(w[0]);y.push(z);v=v+1;if(x.lastIndex===u){isILinenfiniteLoop=true}u=x.lastIndex}return y};var o=function(s){var t=s.slice(3,4);var u=s.slice(5,s.length-1);return f(t,u)};function f(x,t){var y=/[^,]+/g;var u=-1;var s=false;var w;var v=0;var z=new Object();z.sdtype=x;while(((w=y.exec(t))!==null)&&(!s)){if(v===0){z.format=w[0]}else{if(v===1){z.role=w[0]}else{if(v===2){z.latetype=w[0]}else{if(v===3){z.watermarkstamp=w[0]}else{if(v===4){z.synchrostamp=w[0]}else{if(v===5){z.persistancytype=w[0].replace(/[']+/g,"")}else{if(v===6){z.persistancyname=w[0].replace(/[']+/g,"")}}}}}}}v=v+1;if(y.lastIndex===u){isILinenfiniteLoop=true}u=y.lastIndex}return z}};return a});define("VisuDataAccess/Ox4PLMDataHelper",["DS/VisuDataAccess/Ox4PLMDataHelper","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/Ox4PLMDataHelper");return b});define("DS/Plugins/UserPass",["UWA/Class"],function(b){var c=0;var a=b.extend({init:function(d){this.id=c++;this.manager=d.manager;this.name=d.name;this.renderList=null||d.renderList;this.enabled=true;this._passes=[];this._inserted=false},enable:function(d){this.enabled=d?true:false;var e;for(e=0;e<this._passes.length;e++){this._passes[e].disabledByDefault=this.enabled?false:true}this.manager._getMainComposer().enableCustomPassNEW(this._passes)},_setupPasses:function(){var d;for(d=0;d<this._passes.length-1;d++){this._passes[d].userPass=this}}});return a});define("DS/Visualization/FixedSizeArrayPool",function(a){var a=function(){this.bySizePools={};this.pool5=this.bySizePools[5]={list:[],nextAvailable:0,lastCount:0};this.timerClean=undefined};a.prototype.makeArraysReusable=function(){var d;for(d in this.bySizePools){var e=this.bySizePools[d];var f=parseInt(d);for(var c=e.nextAvailable;c<e.lastCount;++c){for(var b=0;b<f;++b){e.list[c][b]=undefined}}e.lastCount=e.nextAvailable}for(d in this.bySizePools){this.bySizePools[d].nextAvailable=0}};a.prototype.get2=function(d,c){var f=this.bySizePools[2];if(!f){f={list:[],nextAvailable:0,lastCount:0};this.bySizePools[2]=f}var g,e;if(f.list.length>f.nextAvailable){g=f.list[f.nextAvailable++];g[0]=d;g[1]=c}else{g={0:d,1:c,next:null};f.list.push(g);f.nextAvailable++}return g};a.prototype.get5=function(g,f,n,m,l){var j=this.pool5;var k,h;if(j.list.length>j.nextAvailable){k=j.list[j.nextAvailable++];k[0]=g;k[1]=f;k[2]=n;k[3]=m;k[4]=l}else{k={0:g,1:f,2:n,3:m,4:l,next:null};j.list.push(k);j.nextAvailable++}return k};return a});define("Visualization/FixedSizeArrayPool",["DS/Visualization/FixedSizeArrayPool","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/FixedSizeArrayPool");return b});define("DS/VisuIdentification/Pattern",["UWA/Class"],function(a){var b=a.extend({init:function(e,d,c){this.space=e;this.context=d;this.shared=c;return this},getSpace:function(){return this.space},getContext:function(){return this.context},getSharability:function(){return this.shared},setSpace:function(c){this.space=c},setContext:function(c){this.context=c},setSharability:function(c){this.shared=c},copy:function(c){this.space=c.space;this.context=c.context;this.shared=c.shared;return this},isEqual:function(c){return(this.space===c.space&&this.context===c.context&&this.shared===c.shared)}});return UWA.namespace("THREEDS/Identification/Pattern",b)});if(typeof exports==="object"&&this==exports){module.exports=EasySAXParser}function EasySAXParser(){if(!this){return null}function t(){}var p=t,w=t,o=t,x=t,h=t,n,l,b;var v,q,z;var k=false,A,g,a,u={xmlns:a},c=false;this.on=function(D,C){if(typeof C!=="function"){if(C!==null){return}}switch(D){case"error":h=C||t;break;case"startNode":w=C||t;break;case"endNode":o=C||t;break;case"textNode":p=C||t;break;case"cdata":x=C||t;break;case"comment":n=C;v=!!C;break;case"question":l=C;q=!!C;break;case"attention":b=C;z=!!C;break}};this.ns=function(D,I){if(!D||typeof D!=="string"||!I){return}var F,C={},H,E,G;for(G in I){E=I[G];if(typeof E==="string"){if(D===E){H=true}C[G]=E}}if(H){k=true;g=D;A=C}};this.parse=function(C){if(typeof C!=="string"){return}if(k){u={xmlns:g};r(C);u=false}else{r(C)}s=true};var m={constructor:false,hasOwnProperty:false,isPrototypeOf:false,propertyIsEnumerable:false,toLocaleString:false,toString:false,valueOf:false,quot:'"',QUOT:'"',amp:"&",AMP:"&",nbsp:"\u00A0",apos:"'",lt:"<",LT:"<",gt:">",GT:">",copy:"\u00A9",laquo:"\u00AB",raquo:"\u00BB",reg:"\u00AE",deg:"\u00B0",plusmn:"\u00B1",sup2:"\u00B2",sup3:"\u00B3",micro:"\u00B5",para:"\u00B6"};function e(D,F,C,E){if(E){return m[E]||"\x01"}if(F){return String.fromCharCode(F)}return String.fromCharCode(parseInt(C,16))}function y(D,C){D=String(D);if(D.length>3&&D.indexOf("&")!==-1){if(D.indexOf("&gt;")!==-1){D=D.replace(/&gt;/g,">")}if(D.indexOf("&lt;")!==-1){D=D.replace(/&lt;/g,"<")}if(D.indexOf("&quot;")!==-1){D=D.replace(/&quot;/g,'"')}if(D.indexOf("&")!==-1){D=D.replace(/&#(\d+);|&#x([0123456789abcdef]+);|&(\w+);/ig,e)}}return D}var j="";var f=0;var s;var B=/[^\w:-]+/g;function d(){if(s!==null){return s}var O,K={},S=j,H=f,F=S.length,J=c?[]:false,C,N="",L=false,G,M,Q,E,D,I,R;aa:for(;H<F;H++){M=S.charCodeAt(H);if(M===32||(M<14&&M>8)){continue}if(M<65||M>122||(M>90&&M<97)){return s=false}for(G=H+1;G<F;G++){M=S.charCodeAt(G);if(M>96&&M<123||M>64&&M<91||M>47&&M<59||M===45||M===95){continue}var P=G;while(M===32){M=S.charCodeAt(++P)}if(M!==61){return s=false}break}C=S.substring(H,G);G=P;L=true;if(C==="xmlns:xmlns"){return s=false}M=S.charCodeAt(G+1);while(M==32){M=S.charCodeAt(++G+1)}if(M===34){G=S.indexOf('"',H=G+2)}else{if(M===39){G=S.indexOf("'",H=G+2)}else{return s=false}}if(G===-1){return s=false}if(G+1<F){M=S.charCodeAt(G+1);if(M>32||M<9||(M<32&&M>13)){return s=false}}N=S.substring(H,G);H=G+1;if(k){if(c){if(R=C==="xmlns"?"xmlns":C.charCodeAt(0)===120&&C.substr(0,6)==="xmlns:"&&C.substr(6)){I=A[y(N)];if(I){if(u[R]!==I){if(!D){D=true;Q={};for(E in u){Q[E]=u[E]}u=Q}u[R]=I}}else{if(u[R]){if(!D){D=true;Q={};for(E in u){Q[E]=u[E]}u=Q}u[R]=false}}K[C]=N;continue}J.push(C,N);continue}M=C.length;while(--M){if(C.charCodeAt(M)===58){if(M=u[C.substring(0,M)]){K[M+C.substr(M)]=N}continue aa}}}K[C]=N}if(!L){return s=true}if(c){bb:for(H=0,F=J.length;H<F;H++){C=J[H++];M=C.length;while(--M){if(C.charCodeAt(M)===58){if(M=u[C.substring(0,M)]){K[M+C.substr(M)]=J[H]}continue bb;break}}K[C]=J[H]}}return s=K}function r(E){var K,E=String(E),M=[],Q=[],T,O=false,L=false,R=0,S=0,H,G,N,I,C,F=0,P,U,J;function D(){return E.substring(S,R+1)}while(R!==-1){P=F>0;if(E.charCodeAt(R)===60){S=R}else{S=E.indexOf("<",R)}if(S===-1){if(M.length){h("end file");return}return}if(R!==S&&!P){J=p(E.substring(R,S),y);if(J===false){return}}I=E.charCodeAt(S+1);if(I===33){I=E.charCodeAt(S+2);if(I===91&&E.substr(S+3,6)==="CDATA["){R=E.indexOf("]]>",S);if(R===-1){h("cdata");return}if(!P){J=x(E.substring(S+9,R),false);if(J===false){return}}R+=3;continue}if(I===45&&E.charCodeAt(S+3)===45){R=E.indexOf("-->",S);if(R===-1){h("expected -->");return}if(v&&!P){J=n(E.substring(S+4,R),y);if(J===false){return}}R+=3;continue}R=E.indexOf(">",S+1);if(R===-1){h('expected ">"');return}if(z&&!P){J=b(E.substring(S,R+1),y);if(J===false){return}}R+=1;continue}else{if(I===63){R=E.indexOf("?>",S);if(R===-1){h("...?>");return}if(q){J=l(E.substring(S,R+2));if(J===false){return}}R+=2;continue}}R=E.indexOf(">",S+1);if(R==-1){h("...>");return}s=true;if(I===47){L=false;O=true;H=T=M.pop();N=S+2+H.length;if(E.substring(S+2,N)!==H){h("close tagname");return}for(;N<R;N++){I=E.charCodeAt(N);if(I===32||(I>8&&I<14)){continue}h("close tag");return}}else{if(E.charCodeAt(R-1)===47){H=T=E.substring(S+1,R-1);L=true;O=true}else{H=T=E.substring(S+1,R);L=true;O=false}if(!(I>96&&I<123||I>64&&I<91)){h("first char nodeName");return}for(N=1,G=H.length;N<G;N++){I=H.charCodeAt(N);if(I>96&&I<123||I>64&&I<91||I>47&&I<59||I===45||I===95){continue}if(I===32||(I<14&&I>8)){T=H.substring(0,N);s=null;break}h("invalid nodeName");return}if(!O){M.push(T)}}if(k){if(P){if(O){if(!L){if(--F===0){u=Q.pop()}}}else{F+=1}R+=1;continue}U=u;if(!O){Q.push(u);if(s!==true){if(c=H.indexOf("xmlns",N)!==-1){j=H;f=N;d();c=false}}}I=T.indexOf(":");if(I!==-1){C=u[T.substring(0,I)];T=T.substr(I+1)}else{C=u.xmlns}if(!C){if(O){if(L){u=U}else{u=Q.pop()}}else{F=1;s=true}R+=1;continue}T=C+":"+T}if(L){j=H;f=N;J=w(T,d,y,O,D);if(J===false){return}s=true}if(O){J=o(T,y,L,D);if(J===false){return}if(k){if(L){u=U}else{u=Q.pop()}}}R+=1}}}define("DS/EasySax/EasySax",function(){return EasySAXParser});define("EasySax/EasySax",["DS/EasySax/EasySax","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("EasySax/EasySax");return b});define("DS/Mesh/ThreeJS_Base",function(){var b=b||{REVISION:"57"};b.extend=function(h,g){if(Object.keys){var f=Object.keys(g);for(var e=0,d=f.length;e<d;e++){var j=f[e];Object.defineProperty(h,j,Object.getOwnPropertyDescriptor(g,j))}}else{var c={}.hasOwnProperty;for(var j in g){if(c.call(g,j)){h[j]=g[j]}}}return h};b._jsLevel_do_not_use_you_are_dead_if_you_use_it_out_of_techno=421;b.getWebVisualizationLevel=function(){return b._jsLevel_do_not_use_you_are_dead_if_you_use_it_out_of_techno};b.GeomTypeEnum={EDGE:1,WIRE_EDGE:1<<1,BOUNDARY_EDGE:1<<2,SHARP_EDGE:1<<3,SMOOTH_EDGE:1<<4,HIDDEN_SEAM_EDGE:1<<5,BOUNDARY_POINT:1<<6,SHARP_POINT:1<<7,SMOOTH_POINT:1<<8,SURFACIC_POINT:1<<9,FREE_POINT:1<<10,HIDDEN_SEAM_POINT:1<<11,INFINITE_FACE:1<<12,FACE:1<<13,UNKNOWN:1<<14,_OUTLINE:1<<15,_SECTION_LINE:1<<16,AXIS_SYSTEM:1<<17};b.FixedSizeFiltering={Include:0,Exclude:1,CenterOnly:2};b.PolygonOffsetForceStatus={DEFAULT:0,ENABLED:1,DISABLED:2,};b.ProgramIDs={LARGE_SCALE:1,OIT:1<<1,OIT_ACCUM:1<<2,OIT_REVEAL:1<<3,COMPRESSED_VERTICES:1<<4,COMPRESSED_NORMALS:1<<5,FIXED_SIZE:1<<6,FIXED_SIZE_CENTER:1<<7,};b.AssetSource={MANUAL:0,MATERIAL_MANAGER:1,};b.Quaternion=function(c,f,e,d){this.x=c||0;this.y=f||0;this.z=e||0;this.w=(d!==undefined)?d:1};b.Quaternion.prototype={constructor:b.Quaternion,set:function(c,f,e,d){this.x=c;this.y=f;this.z=e;this.w=d;return this},copy:function(c){this.x=c.x;this.y=c.y;this.z=c.z;this.w=c.w;return this},createJSON:function(){return{x:this.x,y:this.y,z:this.z,w:this.w}},setFromJSON:function(c){this.x=c.x;this.y=c.y;this.z=c.z;this.w=c.w},setFromEuler:function(e,c){var k=Math.cos(e.x/2);var j=Math.cos(e.y/2);var g=Math.cos(e.z/2);var h=Math.sin(e.x/2);var f=Math.sin(e.y/2);var d=Math.sin(e.z/2);if(c===undefined||c==="XYZ"){this.x=h*j*g+k*f*d;this.y=k*f*g-h*j*d;this.z=k*j*d+h*f*g;this.w=k*j*g-h*f*d}else{if(c==="YXZ"){this.x=h*j*g+k*f*d;this.y=k*f*g-h*j*d;this.z=k*j*d-h*f*g;this.w=k*j*g+h*f*d}else{if(c==="ZXY"){this.x=h*j*g-k*f*d;this.y=k*f*g+h*j*d;this.z=k*j*d+h*f*g;this.w=k*j*g-h*f*d}else{if(c==="ZYX"){this.x=h*j*g-k*f*d;this.y=k*f*g+h*j*d;this.z=k*j*d-h*f*g;this.w=k*j*g+h*f*d}else{if(c==="YZX"){this.x=h*j*g+k*f*d;this.y=k*f*g+h*j*d;this.z=k*j*d-h*f*g;this.w=k*j*g-h*f*d}else{if(c==="XZY"){this.x=h*j*g-k*f*d;this.y=k*f*g-h*j*d;this.z=k*j*d+h*f*g;this.w=k*j*g+h*f*d}}}}}}return this},setFromAxisAngle:function(e,f){var c=f/2,d=Math.sin(c);this.x=e.x*d;this.y=e.y*d;this.z=e.z*d;this.w=Math.cos(c);return this},setFromRotationMatrix:function(g){var f=g.elements,l=f[0],k=f[4],j=f[8],e=f[1],d=f[5],c=f[9],p=f[2],o=f[6],n=f[10],h=l+d+n,q;if(h>0){q=0.5/Math.sqrt(h+1);this.w=0.25/q;this.x=(o-c)*q;this.y=(j-p)*q;this.z=(e-k)*q}else{if(l>d&&l>n){q=2*Math.sqrt(1+l-d-n);this.w=(o-c)/q;this.x=0.25*q;this.y=(k+e)/q;this.z=(j+p)/q}else{if(d>n){q=2*Math.sqrt(1+d-l-n);this.w=(j-p)/q;this.x=(k+e)/q;this.y=0.25*q;this.z=(c+o)/q}else{q=2*Math.sqrt(1+n-l-d);this.w=(e-k)/q;this.x=(j+p)/q;this.y=(c+o)/q;this.z=0.25*q}}}return this},toRotationMatrix:function(){var j=2*this.x;var h=2*this.y;var g=2*this.z;var n=j*this.w;var m=h*this.w;var l=g*this.w;var e=j*this.x;var d=h*this.x;var c=g*this.x;var q=h*this.y;var p=g*this.y;var k=g*this.z;var o=new b.Matrix3();var f=o.elements;return new b.Vector3(c-m,p+n,1-(e+q))},inverse:function(){this.conjugate().normalize();return this},conjugate:function(){this.x*=-1;this.y*=-1;this.z*=-1;return this},dot:function(c){return this.x*c.x+this.y*c.y+this.z*c.z+this.w*c.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var c=this.length();if(c===0){this.x=0;this.y=0;this.z=0;this.w=1}else{c=1/c;this.x=this.x*c;this.y=this.y*c;this.z=this.z*c;this.w=this.w*c}return this},add:function(c){this.x+=c.x;this.y+=c.y;this.z+=c.z;this.w+=c.w;return this},sub:function(c){this.x-=c.x;this.y-=c.y;this.z-=c.z;this.w-=c.w;return this},multiply:function(c,d){if(d!==undefined){console.warn("DEPRECATED: Quaternion's .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead.");return this.multiplyQuaternions(c,d)}return this.multiplyQuaternions(this,c)},multiplyQuaternions:function(m,l){var j=m.x,h=m.y,g=m.z,k=m.w;var e=l.x,d=l.y,c=l.z,f=l.w;this.x=j*f+k*e+h*c-g*d;this.y=h*f+k*d+g*e-j*c;this.z=g*f+k*c+j*d-h*e;this.w=k*f-j*e-h*d-g*c;return this},multiplyScalar:function(c){this.x*=c;this.y*=c;this.z*=c;this.w*=c;return this},multiplyVector3:function(c){console.warn("DEPRECATED: Quaternion's .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead.");return c.applyQuaternion(this)},log:function(){if(Math.abs(this.w)>=1){this.w=0;return this}var e=Math.acos(this.w);var c=Math.sin(e);this.w=0;if(Math.abs(c)<0.001){return this}var d=e/c;this.x*=d;this.y*=d;this.z*=d;return this},exp:function(){var e=this.length();this.w=Math.cos(e);var c=Math.sin(e);if(Math.abs(e)<0.001){return this}var d=c/e;this.x*=d;this.y*=d;this.z*=d;return this},slerp:function(e,n){var l=this.x,k=this.y,j=this.z,m=this.w;var d=m*e.w+l*e.x+k*e.y+j*e.z;if(d<0){this.w=-e.w;this.x=-e.x;this.y=-e.y;this.z=-e.z;d=-d}else{this.copy(e)}if(d>=1){this.w=m;this.x=l;this.y=k;this.z=j;return this}var f=Math.acos(d);var c=Math.sqrt(1-d*d);if(Math.abs(c)<0.001){this.w=0.5*(m+this.w);this.x=0.5*(l+this.x);this.y=0.5*(k+this.y);this.z=0.5*(j+this.z);return this}var h=Math.sin((1-n)*f)/c,g=Math.sin(n*f)/c;this.w=(m*h+this.w*g);this.x=(l*h+this.x*g);this.y=(k*h+this.y*g);this.z=(j*h+this.z*g);return this},intermediatePoint:function(){var d,c;return function(f,e,g){if(!d){d=new b.Quaternion()}if(!c){c=new b.Quaternion()}d.copy(e).inverse().multiply(f).log();c.copy(e).inverse().multiply(g).log();d.add(c).multiplyScalar(-0.25);this.copy(e).multiply(d.exp());this.normalize();return this}}(),squad:function(d,e,c,j,g){this.copy(d).slerp(j,g,false);this.normalize();var f=new b.Quaternion().copy(e).slerp(c,g);f.normalize();return this.slerp(f,2*g*(1-g)).normalize()},equals:function(c){return((c.x===this.x)&&(c.y===this.y)&&(c.z===this.z)&&(c.w===this.w))},clone:function(){return new b.Quaternion(this.x,this.y,this.z,this.w)}};b.Quaternion.slerp=function(f,e,d,c){return d.copy(f).slerp(e,c)};b.Curve=function(){};b.Curve.prototype.getPoint=function(c){console.log("Warning, getPoint() not implemented!");return null};b.Curve.prototype.getPointAt=function(c,e){var d=this.getUtoTmapping(c,e);return this.getPoint(d)};b.Curve.prototype.getPoints=function(c){if(!c){c=5}var f,e=[];for(f=0;f<=c;f++){e.push(this.getPoint(f/c))}return e};b.Curve.prototype.getSpacedPoints=function(c){if(!c){c=5}var f,e=[];for(f=0;f<=c;f++){e.push(this.getPointAt(f/c))}return e};b.Curve.prototype.getLength=function(e){var g=this.getLengths();if(e!==undefined){var f=e*(g.length-1);var d=Math.floor(f);var c=f-d;if(d+1>=g.length){return g[d]}else{return(1-c)*g[d]+c*g[d+1]}}else{return g[g.length-1]}};b.Curve.prototype.getLengths=function(d){if(!d){d=(this.__arcLengthDivisions)?(this.__arcLengthDivisions):200}if(this.cacheArcLengths&&(this.cacheArcLengths.length==d+1)&&!this.needsUpdate){return this.cacheArcLengths}this.needsUpdate=false;var c=[];var h,f=this.getPoint(0);var g,e=0;c.push(0);for(g=1;g<=d;g++){h=this.getPoint(g/d);e+=h.distanceTo(f);c.push(e);f=h}this.cacheArcLengths=c;return c};b.Curve.prototype.updateArcLengths=function(){this.needsUpdate=true;this.getLengths()};b.Curve.prototype.getUtoTmapping=function(o,c){var d=this.getLengths();var g=0,l=d.length;var m;if(c){m=c}else{m=o*d[l-1]}var k=0,f=l-1,n;while(k<=f){g=Math.floor(k+(f-k)/2);n=d[g]-m;if(n<0){k=g+1;continue}else{if(n>0){f=g-1;continue}else{f=g;break}}}g=f;if(d[g]==m){var q=g/(l-1);return q}var h=d[g];var p=d[g+1];var e=p-h;var j=(m-h)/e;var q=(g+j)/(l-1);return q};b.Curve.prototype.getTangent=function(d){var j=0.0001;var f=d-j;var e=d+j;if(f<0){f=0}if(e>1){e=1}var h=this.getPoint(f);var g=this.getPoint(e);var c=g.clone().sub(h);return c.normalize()};b.Curve.prototype.getTangentAt=function(c){var d=this.getUtoTmapping(c);return this.getTangent(d)};b.QuaternionSpline=function(c){this.controlPts=[];this.tangentPts=[];this.setPoints(c)};b.QuaternionSpline.prototype={constructor:b.QuaternionSpline,setPoints:function(c){this.controlPts=c;if(c){this._updateTangents()}},clear:function(){this.controlPts=[];this.tangentPts=[]},getNbPoints:function(){return this.controlPts.length},addPoint:function(c){this.controlPts.push(c);this._updateTangents()},insertPoint:function(c,d){if(c<0||c>this.controlPts.length){return false}this.controlPts.splice(c,0,d);this._updateTangents();return true},updatePoint:function(c,d){if(c<0||c>=this.controlPts.length){return false}this.controlPts[c]=d;this._updateTangents();return true},removePoint:function(c){if(c<0||c>=this.controlPts.length){return false}this.controlPts.splice(c,1);this._updateTangents();return true},interpolate:function(d){var e=d*(this.controlPts.length-1);var c=Math.floor(e);return this._interpolate(c,e-c)},_interpolate:function(c,d){if(c===this.controlPts.length-1){return this.controlPts[c]}if(d===0){return this.controlPts[c]}else{if(d===1){return this.controlPts[c+1]}}return new b.Quaternion().squad(this.controlPts[c],this.tangentPts[c],this.tangentPts[c+1],this.controlPts[c+1],d)},_updateTangents:function(){var f=this.controlPts.length;if(f<2){return}this.controlPts[f-1].normalize();for(var e=f-1;e>0;e--){this.controlPts[e-1].normalize();if(this.controlPts[e-1].dot(this.controlPts[e])<=0){this.controlPts[e-1].multiplyScalar(-1)}}var h=this.controlPts[0].equals(this.controlPts[f-1]);for(var e=0;e<f;++e){var d,g;var c=this.controlPts[e];if(!e){g=this.controlPts[1];if(h){d=this.controlPts[f-2]}else{d=c}}else{if(e===f-1){d=this.controlPts[e-1];if(h){g=this.controlPts[1]}else{g=c}}else{d=this.controlPts[e-1];g=this.controlPts[e+1]}}if(!this.tangentPts[e]){this.tangentPts[e]=new b.Quaternion()}this.tangentPts[e].intermediatePoint(d,c,g)}}};b.PositionSpline=function(c){this.controlPts=[];if(c){this.setPoints(c)}};b.PositionSpline.prototype={constructor:b.PositionSpline,getPointAt:b.Curve.prototype.getPointAt,getLength:b.Curve.prototype.getLength,getLengths:b.Curve.prototype.getLengths,updateArcLengths:b.Curve.prototype.updateArcLengths,getUtoTmapping:b.Curve.prototype.getUtoTmapping,getPoint:function(d){var e=d*(this.controlPts.length-1);var c=Math.floor(e);return this._interpolate(c,e-c)},getNbPoints:function(){return this.controlPts.length},setPoints:function(c){this.controlPts=c;this._updateCurve()},clear:function(){this.controlPts=[];this._updateCurve()},addPoint:function(c){this.controlPts.push(c);this._updateCurve()},insertPoint:function(c,d){if(c<0||c>this.controlPts.length){return false}this.controlPts.splice(c,0,d);this._updateCurve();return true},updatePoint:function(c,d){if(c<0||c>=this.controlPts.length){return false}this.controlPts[c]=d;this._updateCurve();return true},removePoint:function(c){if(c<0||c>=this.controlPts.length){return false}this.controlPts.splice(c,1);this._updateCurve();return true},_updateCurve:function(){this.updateArcLengths()},_interpolate:function(f,m){var d=this.controlPts.length;if(d<2){return null}if(f===d-1){return this.controlPts[f]}if(m===0){return this.controlPts[f]}else{if(m===1){return this.controlPts[f+1]}}var c=this.controlPts[0].equals(this.controlPts[d-1]);var l,j,h;var k=this.controlPts[f];if(c){l=!f?this.controlPts[d-2]:this.controlPts[f-1];j=(f>d-2)?this.controlPts[1]:this.controlPts[f+1];h=(f===d-1)?this.controlPts[2]:((f===d-2)?this.controlPts[1]:this.controlPts[f+2])}else{l=!f?k:this.controlPts[f-1];j=(f>d-2)?k:this.controlPts[f+1];h=(f>d-3)?j:this.controlPts[f+2]}var e=(this.controlPts[0].w!==undefined);var g=e?new b.Vector4():new b.Vector3();g.x=this._CatmullInterpolate(l.x,k.x,j.x,h.x,m);g.y=this._CatmullInterpolate(l.y,k.y,j.y,h.y,m);g.z=this._CatmullInterpolate(l.z,k.z,j.z,h.z,m);if(e){g.w=this._CatmullInterpolate(l.w,k.w,j.w,h.w,m)}return g},_CatmullInterpolate:function(k,j,g,f,l){var h=(g-k)*0.5;var e=(f-j)*0.5;var d=l*l;var c=l*d;return(2*j-2*g+h+e)*c+(-3*j+3*g-2*h-e)*d+h*l+j}};b.Vector2=function(c,d){this.x=c||0;this.y=d||0};b.Vector2.prototype={constructor:b.Vector2,set:function(c,d){this.x=c;this.y=d;return this},setX:function(c){this.x=c;return this},setY:function(c){this.y=c;return this},setComponent:function(c,d){switch(c){case 0:this.x=d;break;case 1:this.y=d;break;default:throw new Error("index is out of range: "+c)}},getComponent:function(c){switch(c){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+c)}},copy:function(c){this.x=c.x;this.y=c.y;return this},add:function(d,c){if(c!==undefined){console.warn("DEPRECATED: Vector2's .add() now only accepts one argument. Use .addVectors( a, b ) instead.");return this.addVectors(d,c)}this.x+=d.x;this.y+=d.y;return this},addVectors:function(d,c){this.x=d.x+c.x;this.y=d.y+c.y;return this},addScalar:function(c){this.x+=c;this.y+=c;return this},sub:function(d,c){if(c!==undefined){console.warn("DEPRECATED: Vector2's .sub() now only accepts one argument. Use .subVectors( a, b ) instead.");return this.subVectors(d,c)}this.x-=d.x;this.y-=d.y;return this},subVectors:function(d,c){this.x=d.x-c.x;this.y=d.y-c.y;return this},multiplyScalar:function(c){this.x*=c;this.y*=c;return this},divideScalar:function(c){if(c!==0){this.x/=c;this.y/=c}else{this.set(0,0)}return this},min:function(c){if(this.x>c.x){this.x=c.x}if(this.y>c.y){this.y=c.y}return this},max:function(c){if(this.x<c.x){this.x=c.x}if(this.y<c.y){this.y=c.y}return this},clamp:function(d,c){if(this.x<d.x){this.x=d.x}else{if(this.x>c.x){this.x=c.x}}if(this.y<d.y){this.y=d.y}else{if(this.y>c.y){this.y=c.y}}return this},negate:function(){return this.multiplyScalar(-1)},dot:function(c){return this.x*c.x+this.y*c.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(c){return Math.sqrt(this.distanceToSquared(c))},distanceToSquared:function(e){var d=this.x-e.x,c=this.y-e.y;return d*d+c*c},setLength:function(c){var d=this.length();if(d!==0&&c!==d){this.multiplyScalar(c/d)}return this},lerp:function(c,d){this.x+=(c.x-this.x)*d;this.y+=(c.y-this.y)*d;return this},equals:function(c){return((c.x===this.x)&&(c.y===this.y))},toArray:function(){return[this.x,this.y]},clone:function(){return new b.Vector2(this.x,this.y)}};b.Vector3=function(c,e,d){this.x=c||0;this.y=e||0;this.z=d||0};b.Vector3.prototype={constructor:b.Vector3,set:function(c,e,d){this.x=c;this.y=e;this.z=d;return this},setX:function(c){this.x=c;return this},setY:function(c){this.y=c;return this},setZ:function(c){this.z=c;return this},barycentricCoordinates:function(k,j,h){var g=new b.Vector3().subVectors(k,this);var f=new b.Vector3().subVectors(j,this);var e=new b.Vector3().subVectors(h,this);var d=new b.Vector3().subVectors(k,j);var o=new b.Vector3().subVectors(k,h);var m=1/new b.Vector3().crossVectors(d,o).length();var p=new b.Vector3().crossVectors(f,e).length();var n=new b.Vector3().crossVectors(e,g).length();var l=new b.Vector3().crossVectors(g,f).length();return{alpha:p,beta:n,gamma:l,normalisationFactor:m}},setFromJSON:function(c){this.x=c.x;this.y=c.y;this.z=c.z},createJSON:function(){return{x:this.x,y:this.y,z:this.z}},setComponent:function(c,d){switch(c){case 0:this.x=d;break;case 1:this.y=d;break;case 2:this.z=d;break;default:throw new Error("index is out of range: "+c)}},getComponent:function(c){switch(c){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+c)}},copy:function(c){this.x=c.x;this.y=c.y;this.z=c.z;return this},add:function(d,c){if(c!==undefined){console.warn("DEPRECATED: Vector3's .add() now only accepts one argument. Use .addVectors( a, b ) instead.");return this.addVectors(d,c)}this.x+=d.x;this.y+=d.y;this.z+=d.z;return this},addScalar:function(c){this.x+=c;this.y+=c;this.z+=c;return this},addVectors:function(d,c){this.x=d.x+c.x;this.y=d.y+c.y;this.z=d.z+c.z;return this},sub:function(d,c){if(c!==undefined){console.warn("DEPRECATED: Vector3's .sub() now only accepts one argument. Use .subVectors( a, b ) instead.");return this.subVectors(d,c)}this.x-=d.x;this.y-=d.y;this.z-=d.z;return this},subVectors:function(d,c){this.x=d.x-c.x;this.y=d.y-c.y;this.z=d.z-c.z;return this},multiply:function(d,c){if(c!==undefined){console.warn("DEPRECATED: Vector3's .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead.");return this.multiplyVectors(d,c)}this.x*=d.x;this.y*=d.y;this.z*=d.z;return this},multiplyScalar:function(c){this.x*=c;this.y*=c;this.z*=c;return this},multiplyVectors:function(d,c){this.x=d.x*c.x;this.y=d.y*c.y;this.z=d.z*c.z;return this},applyMatrix3:function(d){var c=this.x;var h=this.y;var g=this.z;var f=d.elements;this.x=f[0]*c+f[3]*h+f[6]*g;this.y=f[1]*c+f[4]*h+f[7]*g;this.z=f[2]*c+f[5]*h+f[8]*g;return this},applyMatrix4:function(d){if(!d){return this}var c=this.x,h=this.y,g=this.z;var f=d.elements;this.x=f[0]*c+f[4]*h+f[8]*g+f[12];this.y=f[1]*c+f[5]*h+f[9]*g+f[13];this.z=f[2]*c+f[6]*h+f[10]*g+f[14];return this},applyProjection:function(f){var c=this.x,k=this.y,j=this.z;var g=f.elements;var h=1/(g[3]*c+g[7]*k+g[11]*j+g[15]);this.x=(g[0]*c+g[4]*k+g[8]*j+g[12])*h;this.y=(g[1]*c+g[5]*k+g[9]*j+g[13])*h;this.z=(g[2]*c+g[6]*k+g[10]*j+g[14])*h;return this},applyQuaternion:function(c){var o=this.x;var n=this.y;var m=this.z;var k=c.x;var j=c.y;var h=c.z;var l=c.w;var f=l*o+j*m-h*n;var e=l*n+h*o-k*m;var d=l*m+k*n-j*o;var g=-k*o-j*n-h*m;this.x=f*l+g*-k+e*-h-d*-j;this.y=e*l+g*-j+d*-k-f*-h;this.z=d*l+g*-h+f*-j-e*-k;return this},transformDirection:function(d){var c=this.x,h=this.y,g=this.z;var f=d.elements;this.x=f[0]*c+f[4]*h+f[8]*g;this.y=f[1]*c+f[5]*h+f[9]*g;this.z=f[2]*c+f[6]*h+f[10]*g;this.normalize();return this},divide:function(c){this.x/=c.x;this.y/=c.y;this.z/=c.z;return this},divideScalar:function(c){if(c!==0){this.x/=c;this.y/=c;this.z/=c}else{this.x=0;this.y=0;this.z=0}return this},min:function(c){if(this.x>c.x){this.x=c.x}if(this.y>c.y){this.y=c.y}if(this.z>c.z){this.z=c.z}return this},max:function(c){if(this.x<c.x){this.x=c.x}if(this.y<c.y){this.y=c.y}if(this.z<c.z){this.z=c.z}return this},clamp:function(d,c){if(this.x<d.x){this.x=d.x}else{if(this.x>c.x){this.x=c.x}}if(this.y<d.y){this.y=d.y}else{if(this.y>c.y){this.y=c.y}}if(this.z<d.z){this.z=d.z}else{if(this.z>c.z){this.z=c.z}}return this},negate:function(){return this.multiplyScalar(-1)},dot:function(c){return this.x*c.x+this.y*c.y+this.z*c.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(c){var d=this.length();if(d!==0&&c!==d){this.multiplyScalar(c/d)}return this},lerp:function(c,d){this.x+=(c.x-this.x)*d;this.y+=(c.y-this.y)*d;this.z+=(c.z-this.z)*d;return this},cross:function(e,d){if(d!==undefined){console.warn("DEPRECATED: Vector3's .cross() now only accepts one argument. Use .crossVectors( a, b ) instead.");return this.crossVectors(e,d)}var c=this.x,g=this.y,f=this.z;this.x=g*e.z-f*e.y;this.y=f*e.x-c*e.z;this.z=c*e.y-g*e.x;return this},crossVectors:function(d,c){this.x=d.y*c.z-d.z*c.y;this.y=d.z*c.x-d.x*c.z;this.z=d.x*c.y-d.y*c.x;return this},applyAxisAngle:function(){var c;return function(d,e){if(c===undefined){c=new b.Quaternion()}this.applyQuaternion(c.setFromAxisAngle(d,e));return this}}(),projectOnVector:function(){var d,c;return function(e){if(d===undefined){d=new b.Vector3()}d.copy(e).normalize();c=this.dot(d);return this.copy(d).multiplyScalar(c)}}(),projectOnPlane:function(){var c;return function(d){if(c===undefined){c=new b.Vector3()}c.copy(this).projectOnVector(d);return this.sub(c)}}(),reflect:function(){var c;return function(d){if(c===undefined){c=new b.Vector3()}return this.sub(c.copy(d).multiplyScalar(2*this.dot(d)))}}(),angleTo:function(c){var d=this.dot(c)/(this.length()*c.length());return Math.acos(b.Math.clamp(d,-1,1))},distanceTo:function(c){return Math.sqrt(this.distanceToSquared(c))},distanceToSquared:function(f){var e=this.x-f.x;var d=this.y-f.y;var c=this.z-f.z;return e*e+d*d+c*c},getPositionFromMatrix:function(c){this.x=c.elements[12];this.y=c.elements[13];this.z=c.elements[14];return this},getColumnFromMatrix:function(d,c){var f=d*4;var e=c.elements;this.x=e[f];this.y=e[f+1];this.z=e[f+2];return this},setEulerFromRotationMatrix:function(g,h){function l(m){return Math.min(Math.max(m,-1),1)}var f=g.elements;var n=f[0],k=f[4],j=f[8];var e=f[1],d=f[5],c=f[9];var q=f[2],p=f[6],o=f[10];if(h===undefined||h==="XYZ"){this.y=Math.asin(l(j));if(Math.abs(j)<0.99999){this.x=Math.atan2(-c,o);this.z=Math.atan2(-k,n)}else{this.x=Math.atan2(p,d);this.z=0}}else{if(h==="YXZ"){this.x=Math.asin(-l(c));if(Math.abs(c)<0.99999){this.y=Math.atan2(j,o);this.z=Math.atan2(e,d)}else{this.y=Math.atan2(-q,n);this.z=0}}else{if(h==="ZXY"){this.x=Math.asin(l(p));if(Math.abs(p)<0.99999){this.y=Math.atan2(-q,o);this.z=Math.atan2(-k,d)}else{this.y=0;this.z=Math.atan2(e,n)}}else{if(h==="ZYX"){this.y=Math.asin(-l(q));if(Math.abs(q)<0.99999){this.x=Math.atan2(p,o);this.z=Math.atan2(e,n)}else{this.x=0;this.z=Math.atan2(-k,d)}}else{if(h==="YZX"){this.z=Math.asin(l(e));if(Math.abs(e)<0.99999){this.x=Math.atan2(-c,d);this.y=Math.atan2(-q,n)}else{this.x=0;this.y=Math.atan2(j,o)}}else{if(h==="XZY"){this.z=Math.asin(-l(k));if(Math.abs(k)<0.99999){this.x=Math.atan2(p,d);this.y=Math.atan2(j,n)}else{this.x=Math.atan2(-c,o);this.y=0}}}}}}}return this},setEulerFromQuaternion:function(f,c){function j(k){return Math.min(Math.max(k,-1),1)}var g=f.x*f.x;var e=f.y*f.y;var d=f.z*f.z;var h=f.w*f.w;if(c===undefined||c==="XYZ"){this.x=Math.atan2(2*(f.x*f.w-f.y*f.z),(h-g-e+d));this.y=Math.asin(j(2*(f.x*f.z+f.y*f.w)));this.z=Math.atan2(2*(f.z*f.w-f.x*f.y),(h+g-e-d))}else{if(c==="YXZ"){this.x=Math.asin(j(2*(f.x*f.w-f.y*f.z)));this.y=Math.atan2(2*(f.x*f.z+f.y*f.w),(h-g-e+d));this.z=Math.atan2(2*(f.x*f.y+f.z*f.w),(h-g+e-d))}else{if(c==="ZXY"){this.x=Math.asin(j(2*(f.x*f.w+f.y*f.z)));this.y=Math.atan2(2*(f.y*f.w-f.z*f.x),(h-g-e+d));this.z=Math.atan2(2*(f.z*f.w-f.x*f.y),(h-g+e-d))}else{if(c==="ZYX"){this.x=Math.atan2(2*(f.x*f.w+f.z*f.y),(h-g-e+d));this.y=Math.asin(j(2*(f.y*f.w-f.x*f.z)));this.z=Math.atan2(2*(f.x*f.y+f.z*f.w),(h+g-e-d))}else{if(c==="YZX"){this.x=Math.atan2(2*(f.x*f.w-f.z*f.y),(h-g+e-d));this.y=Math.atan2(2*(f.y*f.w-f.x*f.z),(h+g-e-d));this.z=Math.asin(j(2*(f.x*f.y+f.z*f.w)))}else{if(c==="XZY"){this.x=Math.atan2(2*(f.x*f.w+f.y*f.z),(h-g+e-d));this.y=Math.atan2(2*(f.x*f.z+f.y*f.w),(h+g-e-d));this.z=Math.asin(j(2*(f.z*f.w-f.x*f.y)))}}}}}}return this},getScaleFromMatrix:function(c){var f=this.set(c.elements[0],c.elements[1],c.elements[2]).length();var e=this.set(c.elements[4],c.elements[5],c.elements[6]).length();var d=this.set(c.elements[8],c.elements[9],c.elements[10]).length();this.x=f;this.y=e;this.z=d;return this},equals:function(c){return((c.x===this.x)&&(c.y===this.y)&&(c.z===this.z))},toArray:function(){return[this.x,this.y,this.z]},clone:function(){return new b.Vector3(this.x,this.y,this.z)},isNaN:function(){if(!isFinite(this.x)||!isFinite(this.y)||!isFinite(this.z)){return true}else{return false}}};b.Vector4=function(c,f,e,d){this.x=c||0;this.y=f||0;this.z=e||0;this.w=(d!==undefined)?d:1};b.Vector4.prototype={constructor:b.Vector4,set:function(c,f,e,d){this.x=c;this.y=f;this.z=e;this.w=d;return this},setX:function(c){this.x=c;return this},setY:function(c){this.y=c;return this},setZ:function(c){this.z=c;return this},setW:function(c){this.w=c;return this},setComponent:function(c,d){switch(c){case 0:this.x=d;break;case 1:this.y=d;break;case 2:this.z=d;break;case 3:this.w=d;break;default:throw new Error("index is out of range: "+c)}},getComponent:function(c){switch(c){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+c)}},copy:function(c){this.x=c.x;this.y=c.y;this.z=c.z;this.w=(c.w!==undefined)?c.w:1;return this},add:function(d,c){if(c!==undefined){console.warn("DEPRECATED: Vector4's .add() now only accepts one argument. Use .addVectors( a, b ) instead.");return this.addVectors(d,c)}this.x+=d.x;this.y+=d.y;this.z+=d.z;this.w+=d.w;return this},addScalar:function(c){this.x+=c;this.y+=c;this.z+=c;this.w+=c;return this},addVectors:function(d,c){this.x=d.x+c.x;this.y=d.y+c.y;this.z=d.z+c.z;this.w=d.w+c.w;return this},sub:function(d,c){if(c!==undefined){console.warn("DEPRECATED: Vector4's .sub() now only accepts one argument. Use .subVectors( a, b ) instead.");return this.subVectors(d,c)}this.x-=d.x;this.y-=d.y;this.z-=d.z;this.w-=d.w;return this},subVectors:function(d,c){this.x=d.x-c.x;this.y=d.y-c.y;this.z=d.z-c.z;this.w=d.w-c.w;return this},multiplyScalar:function(c){this.x*=c;this.y*=c;this.z*=c;this.w*=c;return this},applyMatrix4:function(d){if(!d){return this}var c=this.x;var j=this.y;var h=this.z;var f=this.w;var g=d.elements;this.x=g[0]*c+g[4]*j+g[8]*h+g[12]*f;this.y=g[1]*c+g[5]*j+g[9]*h+g[13]*f;this.z=g[2]*c+g[6]*j+g[10]*h+g[14]*f;this.w=g[3]*c+g[7]*j+g[11]*h+g[15]*f;return this},divideScalar:function(c){if(c!==0){this.x/=c;this.y/=c;this.z/=c;this.w/=c}else{this.x=0;this.y=0;this.z=0;this.w=1}return this},setAxisAngleFromQuaternion:function(d){this.w=2*Math.acos(d.w);var c=Math.sqrt(1-d.w*d.w);if(c<0.0001){this.x=1;this.y=0;this.z=0}else{this.x=d.x/c;this.y=d.y/c;this.z=d.z/c}return this},setAxisAngleFromRotationMatrix:function(w){var A,n,l,k,F=0.01,o=0.1,j=w.elements,E=j[0],C=j[4],B=j[8],g=j[1],e=j[5],c=j[9],v=j[2],t=j[6],q=j[10];if((Math.abs(C-g)<F)&&(Math.abs(B-v)<F)&&(Math.abs(c-t)<F)){if((Math.abs(C+g)<o)&&(Math.abs(B+v)<o)&&(Math.abs(c+t)<o)&&(Math.abs(E+e+q-3)<o)){this.set(1,0,0,0);return this}A=Math.PI;var h=(E+1)/2;var u=(e+1)/2;var D=(q+1)/2;var f=(C+g)/4;var d=(B+v)/4;var r=(c+t)/4;if((h>u)&&(h>D)){if(h<F){n=0;l=0.707106781;k=0.707106781}else{n=Math.sqrt(h);l=f/n;k=d/n}}else{if(u>D){if(u<F){n=0.707106781;l=0;k=0.707106781}else{l=Math.sqrt(u);n=f/l;k=r/l}}else{if(D<F){n=0.707106781;l=0.707106781;k=0}else{k=Math.sqrt(D);n=d/k;l=r/k}}}this.set(n,l,k,A);return this}var p=Math.sqrt((t-c)*(t-c)+(B-v)*(B-v)+(g-C)*(g-C));if(Math.abs(p)<0.001){p=1}this.x=(t-c)/p;this.y=(B-v)/p;this.z=(g-C)/p;this.w=Math.acos((E+e+q-1)/2);return this},getColumnFromMatrix:function(d,c){var f=d*4;var e=c.elements;this.x=e[f];this.y=e[f+1];this.z=e[f+2];this.w=1;return this},min:function(c){if(this.x>c.x){this.x=c.x}if(this.y>c.y){this.y=c.y}if(this.z>c.z){this.z=c.z}if(this.w>c.w){this.w=c.w}return this},max:function(c){if(this.x<c.x){this.x=c.x}if(this.y<c.y){this.y=c.y}if(this.z<c.z){this.z=c.z}if(this.w<c.w){this.w=c.w}return this},clamp:function(d,c){if(this.x<d.x){this.x=d.x}else{if(this.x>c.x){this.x=c.x}}if(this.y<d.y){this.y=d.y}else{if(this.y>c.y){this.y=c.y}}if(this.z<d.z){this.z=d.z}else{if(this.z>c.z){this.z=c.z}}if(this.w<d.w){this.w=d.w}else{if(this.w>c.w){this.w=c.w}}return this},negate:function(){return this.multiplyScalar(-1)},dot:function(c){return this.x*c.x+this.y*c.y+this.z*c.z+this.w*c.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(c,d){return Math.sqrt(this.distanceToSquared(c,d))},distanceToSquared:function(g,h){var f=this.x-g.x;var e=this.y-g.y;var d=this.z-g.z;var c=f*f+e*e+d*d;if(h){c+=this.w-g.w}return c},setLength:function(c){var d=this.length();if(d!==0&&c!==d){this.multiplyScalar(c/d)}return this},lerp:function(c,d){this.x+=(c.x-this.x)*d;this.y+=(c.y-this.y)*d;this.z+=(c.z-this.z)*d;this.w+=(c.w-this.w)*d;return this},equals:function(c){return((c.x===this.x)&&(c.y===this.y)&&(c.z===this.z)&&(c.w===this.w))},toArray:function(){return[this.x,this.y,this.z,this.w]},clone:function(){return new b.Vector4(this.x,this.y,this.z,this.w)}};b.Matrix3=function(j,h,g,f,e,d,c,l,k){this.elements=new Float32Array(9);this.set((j!==undefined)?j:1,h||0,g||0,f||0,(e!==undefined)?e:1,d||0,c||0,l||0,(k!==undefined)?k:1)};b.Matrix3.prototype={constructor:b.Matrix3,set:function(k,j,h,g,f,e,c,m,l){var d=this.elements;d[0]=k;d[3]=j;d[6]=h;d[1]=g;d[4]=f;d[7]=e;d[2]=c;d[5]=m;d[8]=l;return this},identity:function(){this.set(1,0,0,0,1,0,0,0,1);return this},copy:function(c){var d=c.elements;this.set(d[0],d[3],d[6],d[1],d[4],d[7],d[2],d[5],d[8]);return this},multiplyVector3:function(c){console.warn("DEPRECATED: Matrix3's .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead.");return c.applyMatrix3(this)},multiplyVector3Array:function(){var c=new b.Vector3();return function(d){for(var f=0,e=d.length;f<e;f+=3){c.x=d[f];c.y=d[f+1];c.z=d[f+2];c.applyMatrix3(this);d[f]=c.x;d[f+1]=c.y;d[f+2]=c.z}return d}}(),multiplyScalar:function(c){var d=this.elements;d[0]*=c;d[3]*=c;d[6]*=c;d[1]*=c;d[4]*=c;d[7]*=c;d[2]*=c;d[5]*=c;d[8]*=c;return this},multiplyMatrices:function(w,v){if(!v){this.copy(w);return this}var u=w.elements;var f=v.elements;var k=this.elements;var j=u[0],h=u[3],g=u[6];var q=u[1],p=u[4],o=u[7];var z=u[2],y=u[5],x=u[8];var t=f[0],s=f[3],r=f[6];var e=f[1],d=f[4],c=f[7];var n=f[2],m=f[5],l=f[8];k[0]=j*t+h*e+g*n;k[3]=j*s+h*d+g*m;k[6]=j*r+h*c+g*l;k[1]=q*t+p*e+o*n;k[4]=q*s+p*d+o*m;k[7]=q*r+p*c+o*l;k[2]=z*t+y*e+x*n;k[5]=z*s+y*d+x*m;k[8]=z*r+y*c+x*l;return this},determinant:function(){var j=this.elements;var s=j[0],r=j[1],q=j[2],p=j[3],o=j[4],n=j[5],m=j[6],l=j[7],k=j[8];return s*o*k-s*n*l-r*p*k+r*n*m+q*p*l-q*o*m},getInverse:function(d,c){var f=d.elements;var h=this.elements;h[0]=f[10]*f[5]-f[6]*f[9];h[1]=-f[10]*f[1]+f[2]*f[9];h[2]=f[6]*f[1]-f[2]*f[5];h[3]=-f[10]*f[4]+f[6]*f[8];h[4]=f[10]*f[0]-f[2]*f[8];h[5]=-f[6]*f[0]+f[2]*f[4];h[6]=f[9]*f[4]-f[5]*f[8];h[7]=-f[9]*f[0]+f[1]*f[8];h[8]=f[5]*f[0]-f[1]*f[4];var e=f[0]*h[0]+f[1]*h[3]+f[2]*h[6];if(e===0){var g="Matrix3.getInverse(): can't invert matrix, determinant is 0";if(c||false){throw new Error(g)}else{console.warn(g)}this.identity();return this}this.multiplyScalar(1/e);return this},transpose:function(){var d,c=this.elements;d=c[1];c[1]=c[3];c[3]=d;d=c[2];c[2]=c[6];c[6]=d;d=c[5];c[5]=c[7];c[7]=d;return this},getNormalMatrix:function(c){this.getInverse(c).transpose();return this},transposeIntoArray:function(d){var c=this.elements;d[0]=c[0];d[1]=c[3];d[2]=c[6];d[3]=c[1];d[4]=c[4];d[5]=c[7];d[6]=c[2];d[7]=c[5];d[8]=c[8];return this},clone:function(){var c=this.elements;return new b.Matrix3(c[0],c[3],c[6],c[1],c[4],c[7],c[2],c[5],c[8])},flattenToArray:function(d){var c=this.elements;d[0]=c[0];d[1]=c[1];d[2]=c[2];d[3]=c[3];d[4]=c[4];d[5]=c[5];d[6]=c[6];d[7]=c[7];d[8]=c[8];return d},scale:function(d){var e=this.elements;var c=d.x,f=d.y;e[0]*=c;e[3]*=f;e[1]*=c;e[4]*=f;e[2]*=c;e[5]*=f;return this},getMatrix4:function(){var c=this.elements;return new Matrix4(c[0],c[3],c[6],0,c[1],c[4],c[7],0,c[2],c[5],c[8],0,0,0,0,1)}};b._Float32Matrix4=function(q,p,n,l,h,g,f,e,c,t,s,r,o,m,k,j){var d=this.elements=new Float32Array(16)};b._Float32Matrix4.prototype={constructor:b._Float32Matrix4,set:function(q,p,n,l,h,g,f,e,c,t,s,r,o,m,k,j){var d=this.elements;d[0]=q;d[4]=p;d[8]=n;d[12]=l;d[1]=h;d[5]=g;d[9]=f;d[13]=e;d[2]=c;d[6]=t;d[10]=s;d[14]=r;d[3]=o;d[7]=m;d[11]=k;d[15]=j;return this},_multiplyDoubleMatricesMV:function(C,A){var z=C.elements;var g=A.elements;var m=this.elements;var l=z[0],k=z[4],j=z[8],h=z[12];var u=z[1],t=z[5],s=z[9],r=z[13];var F=z[2],E=z[6],D=z[10],B=z[14];var y=g[0],x=g[4],w=g[8],v=g[12];var f=g[1],e=g[5],d=g[9],c=g[13];var q=g[2],p=g[6],o=g[10],n=g[14];m[0]=l*y+k*f+j*q;m[4]=l*x+k*e+j*p;m[8]=l*w+k*d+j*o;m[12]=l*v+k*c+j*n+h;m[1]=u*y+t*f+s*q;m[5]=u*x+t*e+s*p;m[9]=u*w+t*d+s*o;m[13]=u*v+t*c+s*n+r;m[2]=F*y+E*f+D*q;m[6]=F*x+E*e+D*p;m[10]=F*w+E*d+D*o;m[14]=F*v+E*c+D*n+B;m[3]=0;m[7]=0;m[11]=0;m[15]=1;return this},multiplyDoubleMatricesAndInverse:function(d,c){var e=new b.Matrix4().multiplyMatrices(d,c);return this.getInverseOfDoubleMatrix(e)},transpose:function(){var d=this.elements;var c;c=d[1];d[1]=d[4];d[4]=c;c=d[2];d[2]=d[8];d[8]=c;c=d[6];d[6]=d[9];d[9]=c;c=d[3];d[3]=d[12];d[12]=c;c=d[7];d[7]=d[13];d[13]=c;c=d[11];d[11]=d[14];d[14]=c;return this},getInverseOfDoubleMatrix:function(u,k){var j=this.elements;var z=u.elements;var s=z[0],q=z[4],o=z[8],l=z[12];var y=z[1],x=z[5],w=z[9],v=z[13];var f=z[2],e=z[6],d=z[10],c=z[14];var t=z[3],r=z[7],p=z[11],n=z[15];j[0]=w*c*r-v*d*r+v*e*p-x*c*p-w*e*n+x*d*n;j[4]=l*d*r-o*c*r-l*e*p+q*c*p+o*e*n-q*d*n;j[8]=o*v*r-l*w*r+l*x*p-q*v*p-o*x*n+q*w*n;j[12]=l*w*e-o*v*e-l*x*d+q*v*d+o*x*c-q*w*c;j[1]=v*d*t-w*c*t-v*f*p+y*c*p+w*f*n-y*d*n;j[5]=o*c*t-l*d*t+l*f*p-s*c*p-o*f*n+s*d*n;j[9]=l*w*t-o*v*t-l*y*p+s*v*p+o*y*n-s*w*n;j[13]=o*v*f-l*w*f+l*y*d-s*v*d-o*y*c+s*w*c;j[2]=x*c*t-v*e*t+v*f*r-y*c*r-x*f*n+y*e*n;j[6]=l*e*t-q*c*t-l*f*r+s*c*r+q*f*n-s*e*n;j[10]=q*v*t-l*x*t+l*y*r-s*v*r-q*y*n+s*x*n;j[14]=l*x*f-q*v*f-l*y*e+s*v*e+q*y*c-s*x*c;j[3]=w*e*t-x*d*t-w*f*r+y*d*r+x*f*p-y*e*p;j[7]=q*d*t-o*e*t+o*f*r-s*d*r-q*f*p+s*e*p;j[11]=o*x*t-q*w*t-o*y*r+s*w*r+q*y*p-s*x*p;j[15]=q*w*f-o*x*f+o*y*e-s*w*e-q*y*d+s*x*d;var g=z[0]*j[0]+z[1]*j[4]+z[2]*j[8]+z[3]*j[12];if(g==0){var h="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(k||false){throw new Error(h)}else{console.warn(h)}this.identity();return this}this.multiplyScalar(1/g);return this},multiplyScalar:function(c){var d=this.elements;d[0]*=c;d[4]*=c;d[8]*=c;d[12]*=c;d[1]*=c;d[5]*=c;d[9]*=c;d[13]*=c;d[2]*=c;d[6]*=c;d[10]*=c;d[14]*=c;d[3]*=c;d[7]*=c;d[11]*=c;d[15]*=c;return this},};var a=false;b.Matrix4=function(p,o,m,k,g,f,e,d,c,s,r,q,n,l,j,h){if(p!==undefined){this.elements=[p,g,c,n,o,f,s,l,m,e,r,j,k,d,q,h]}else{this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}};b.Matrix4.prototype={constructor:b.Matrix4,set:function(q,p,n,l,h,g,f,e,c,t,s,r,o,m,k,j){var d=this.elements;d[0]=q;d[4]=p;d[8]=n;d[12]=l;d[1]=h;d[5]=g;d[9]=f;d[13]=e;d[2]=c;d[6]=t;d[10]=s;d[14]=r;d[3]=o;d[7]=m;d[11]=k;d[15]=j;return this},getValue:function(c,d){return this.elements[(d-1)*4+c-1]},identity:function(){this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return this},isIdentity:function(){var c=this.elements;return(c[0]===1&&c[1]===0&&c[2]===0&&c[3]===0&&c[4]===0&&c[5]===1&&c[6]===0&&c[7]===0&&c[8]===0&&c[9]===0&&c[10]===1&&c[11]===0&&c[12]===0&&c[13]===0&&c[14]===0&&c[15]===1)},copy:function(c){var d=c.elements;this.set(d[0],d[4],d[8],d[12],d[1],d[5],d[9],d[13],d[2],d[6],d[10],d[14],d[3],d[7],d[11],d[15]);return this},createJSON:function(){if(this.isIdentity()){return"identity"}var d=[];var c,e=this.elements;if(e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[15]===1){d.push(e[12]);d.push(e[13]);d.push(e[14])}else{for(c=0;c<16;c++){d.push(this.elements[c])}}return d},setFromJSON:function(d){if(d==="identity"){this.identity()}else{if(d.length===3){this.identity();this.elements[12]=d[0];this.elements[13]=d[1];this.elements[14]=d[2]}else{var c;for(c=0;c<16;c++){this.elements[c]=d[c]}}}},setRotationFromEuler:function(p,s){var l=this.elements;var o=p.x,n=p.y,m=p.z;var I=Math.cos(o),H=Math.sin(o);var F=Math.cos(n),C=Math.sin(n);var w=Math.cos(m),t=Math.sin(m);if(s===undefined||s==="XYZ"){var B=I*w,u=I*t,h=H*w,g=H*t;l[0]=F*w;l[4]=-F*t;l[8]=C;l[1]=u+h*C;l[5]=B-g*C;l[9]=-H*F;l[2]=g-B*C;l[6]=h+u*C;l[10]=I*F}else{if(s==="YXZ"){var r=F*w,q=F*t,E=C*w,A=C*t;l[0]=r+A*H;l[4]=E*H-q;l[8]=I*C;l[1]=I*t;l[5]=I*w;l[9]=-H;l[2]=q*H-E;l[6]=A+r*H;l[10]=I*F}else{if(s==="ZXY"){var r=F*w,q=F*t,E=C*w,A=C*t;l[0]=r-A*H;l[4]=-I*t;l[8]=E+q*H;l[1]=q+E*H;l[5]=I*w;l[9]=A-r*H;l[2]=-I*C;l[6]=H;l[10]=I*F}else{if(s==="ZYX"){var B=I*w,u=I*t,h=H*w,g=H*t;l[0]=F*w;l[4]=h*C-u;l[8]=B*C+g;l[1]=F*t;l[5]=g*C+B;l[9]=u*C-h;l[2]=-C;l[6]=H*F;l[10]=I*F}else{if(s==="YZX"){var G=I*F,D=I*C,k=H*F,j=H*C;l[0]=F*w;l[4]=j-G*t;l[8]=k*t+D;l[1]=t;l[5]=I*w;l[9]=-H*w;l[2]=-C*w;l[6]=D*t+k;l[10]=G-j*t}else{if(s==="XZY"){var G=I*F,D=I*C,k=H*F,j=H*C;l[0]=F*w;l[4]=-t;l[8]=C*w;l[1]=G*t+j;l[5]=I*w;l[9]=D*t-k;l[2]=k*t-D;l[6]=H*w;l[10]=j*t+G}}}}}}return this},setRotationFromQuaternion:function(o){var g=this.elements;var k=o.x,j=o.y,h=o.z,l=o.w;var r=k+k,c=j+j,m=h+h;var f=k*r,e=k*c,d=k*m;var p=j*c,n=j*m,u=h*m;var v=l*r,t=l*c,s=l*m;g[0]=1-(p+u);g[4]=e-s;g[8]=d+t;g[1]=e+s;g[5]=1-(f+u);g[9]=n-v;g[2]=d-t;g[6]=n+v;g[10]=1-(f+p);return this},makeRotationFromQuaternion:function(o){var g=this.elements;var k=o.x,j=o.y,h=o.z,l=o.w;var r=k+k,c=j+j,m=h+h;var f=k*r,e=k*c,d=k*m;var p=j*c,n=j*m,u=h*m;var v=l*r,t=l*c,s=l*m;g[0]=1-(p+u);g[4]=e-s;g[8]=d+t;g[1]=e+s;g[5]=1-(f+u);g[9]=n-v;g[2]=d-t;g[6]=n+v;g[10]=1-(f+p);g[3]=0;g[7]=0;g[11]=0;g[12]=0;g[13]=0;g[14]=0;g[15]=1;return this},lookAt:function(){var c=new b.Vector3();var e=new b.Vector3();var d=new b.Vector3();return function(g,h,f){var j=this.elements;d.subVectors(g,h).normalize();if(d.length()===0){d.z=1}c.crossVectors(f,d).normalize();if(c.length()===0){d.x+=0.0001;c.crossVectors(f,d).normalize()}e.crossVectors(d,c);j[0]=c.x;j[4]=e.x;j[8]=d.x;j[1]=c.y;j[5]=e.y;j[9]=d.y;j[2]=c.z;j[6]=e.z;j[10]=d.z;return this}}(),multiply:function(c,d){if(d!==undefined){console.warn("DEPRECATED: Matrix4's .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead.");return this.multiplyMatrices(c,d)}return this.multiplyMatrices(this,c)},multiplyMatrices:function(N,M){if(!M){this.copy(N);return this}var t=N.elements;var L=M.elements;var c=this.elements;var q=t[0],o=t[4],n=t[8],m=t[12];var K=t[1],J=t[5],I=t[9],H=t[13];var C=t[2],B=t[6],A=t[10],z=t[14];var u=t[3],s=t[7],r=t[11],p=t[15];var j=L[0],g=L[4],e=L[8],d=L[12];var G=L[1],F=L[5],E=L[9],D=L[13];var y=L[2],x=L[6],w=L[10],v=L[14];var l=L[3],k=L[7],h=L[11],f=L[15];c[0]=q*j+o*G+n*y+m*l;c[4]=q*g+o*F+n*x+m*k;c[8]=q*e+o*E+n*w+m*h;c[12]=q*d+o*D+n*v+m*f;c[1]=K*j+J*G+I*y+H*l;c[5]=K*g+J*F+I*x+H*k;c[9]=K*e+J*E+I*w+H*h;c[13]=K*d+J*D+I*v+H*f;c[2]=C*j+B*G+A*y+z*l;c[6]=C*g+B*F+A*x+z*k;c[10]=C*e+B*E+A*w+z*h;c[14]=C*d+B*D+A*v+z*f;c[3]=u*j+s*G+r*y+p*l;c[7]=u*g+s*F+r*x+p*k;c[11]=u*e+s*E+r*w+p*h;c[15]=u*d+s*D+r*v+p*f;return this},multiplyToArray:function(d,c,e){var f=this.elements;this.multiplyMatrices(d,c);e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[3];e[4]=f[4];e[5]=f[5];e[6]=f[6];e[7]=f[7];e[8]=f[8];e[9]=f[9];e[10]=f[10];e[11]=f[11];e[12]=f[12];e[13]=f[13];e[14]=f[14];e[15]=f[15];return this},multiplyScalar:function(c){var d=this.elements;d[0]*=c;d[4]*=c;d[8]*=c;d[12]*=c;d[1]*=c;d[5]*=c;d[9]*=c;d[13]*=c;d[2]*=c;d[6]*=c;d[10]*=c;d[14]*=c;d[3]*=c;d[7]*=c;d[11]*=c;d[15]*=c;return this},multiplyVector3:function(c){console.warn("DEPRECATED: Matrix4's .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) or vector.applyProjection( matrix ) instead.");return c.applyProjection(this)},multiplyVector4:function(c){console.warn("DEPRECATED: Matrix4's .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead.");return c.applyMatrix4(this)},multiplyVector3Array:function(){var c=new b.Vector3();return function(d){for(var f=0,e=d.length;f<e;f+=3){c.x=d[f];c.y=d[f+1];c.z=d[f+2];c.applyProjection(this);d[f]=c.x;d[f+1]=c.y;d[f+2]=c.z}return d}}(),rotateAxis:function(c){console.warn("DEPRECATED: Matrix4's .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead.");c.transformDirection(this)},crossVector:function(c){var e=this.elements;var d=new b.Vector4();d.x=e[0]*c.x+e[4]*c.y+e[8]*c.z+e[12]*c.w;d.y=e[1]*c.x+e[5]*c.y+e[9]*c.z+e[13]*c.w;d.z=e[2]*c.x+e[6]*c.y+e[10]*c.z+e[14]*c.w;d.w=(c.w)?e[3]*c.x+e[7]*c.y+e[11]*c.z+e[15]*c.w:1;return d},determinant:function(){var e=this.elements;var q=e[0],p=e[4],n=e[8],l=e[12];var h=e[1],g=e[5],f=e[9],d=e[13];var c=e[2],t=e[6],s=e[10],r=e[14];var o=e[3],m=e[7],k=e[11],j=e[15];return(o*(+l*f*t-n*d*t-l*g*s+p*d*s+n*g*r-p*f*r)+m*(+q*f*r-q*d*s+l*h*s-n*h*r+n*d*c-l*f*c)+k*(+q*d*t-q*g*r-l*h*t+p*h*r+l*g*c-p*d*c)+j*(-n*g*c-q*f*t+q*g*s+n*h*t-p*h*s+p*f*c))},transpose:function(){var d=this.elements;var c;c=d[1];d[1]=d[4];d[4]=c;c=d[2];d[2]=d[8];d[8]=c;c=d[6];d[6]=d[9];d[9]=c;c=d[3];d[3]=d[12];d[12]=c;c=d[7];d[7]=d[13];d[13]=c;c=d[11];d[11]=d[14];d[14]=c;return this},flattenToArray:function(d){var c=this.elements;d[0]=c[0];d[1]=c[1];d[2]=c[2];d[3]=c[3];d[4]=c[4];d[5]=c[5];d[6]=c[6];d[7]=c[7];d[8]=c[8];d[9]=c[9];d[10]=c[10];d[11]=c[11];d[12]=c[12];d[13]=c[13];d[14]=c[14];d[15]=c[15];return d},setFromArray:function(d){var c=this.elements;c[0]=d[0];c[1]=d[1];c[2]=d[2];c[3]=d[3];c[4]=d[4];c[5]=d[5];c[6]=d[6];c[7]=d[7];c[8]=d[8];c[9]=d[9];c[10]=d[10];c[11]=d[11];c[12]=d[12];c[13]=d[13];c[14]=d[14];c[15]=d[15];return this},flattenToArrayOffset:function(e,d){var c=this.elements;e[d]=c[0];e[d+1]=c[1];e[d+2]=c[2];e[d+3]=c[3];e[d+4]=c[4];e[d+5]=c[5];e[d+6]=c[6];e[d+7]=c[7];e[d+8]=c[8];e[d+9]=c[9];e[d+10]=c[10];e[d+11]=c[11];e[d+12]=c[12];e[d+13]=c[13];e[d+14]=c[14];e[d+15]=c[15];return e},getPosition:function(){var c=new b.Vector3();return function(){console.warn("DEPRECATED: Matrix4's .getPosition() has been removed. Use Vector3.getPositionFromMatrix( matrix ) instead.");var d=this.elements;return c.set(d[12],d[13],d[14])}}(),setPosition:function(c){var d=this.elements;d[12]=c.x;d[13]=c.y;d[14]=c.z;return this},getInverse:function(u,k){var j=this.elements;var z=u.elements;var s=z[0],q=z[4],o=z[8],l=z[12];var y=z[1],x=z[5],w=z[9],v=z[13];var f=z[2],e=z[6],d=z[10],c=z[14];var t=z[3],r=z[7],p=z[11],n=z[15];j[0]=w*c*r-v*d*r+v*e*p-x*c*p-w*e*n+x*d*n;j[4]=l*d*r-o*c*r-l*e*p+q*c*p+o*e*n-q*d*n;j[8]=o*v*r-l*w*r+l*x*p-q*v*p-o*x*n+q*w*n;j[12]=l*w*e-o*v*e-l*x*d+q*v*d+o*x*c-q*w*c;j[1]=v*d*t-w*c*t-v*f*p+y*c*p+w*f*n-y*d*n;j[5]=o*c*t-l*d*t+l*f*p-s*c*p-o*f*n+s*d*n;j[9]=l*w*t-o*v*t-l*y*p+s*v*p+o*y*n-s*w*n;j[13]=o*v*f-l*w*f+l*y*d-s*v*d-o*y*c+s*w*c;j[2]=x*c*t-v*e*t+v*f*r-y*c*r-x*f*n+y*e*n;j[6]=l*e*t-q*c*t-l*f*r+s*c*r+q*f*n-s*e*n;j[10]=q*v*t-l*x*t+l*y*r-s*v*r-q*y*n+s*x*n;j[14]=l*x*f-q*v*f-l*y*e+s*v*e+q*y*c-s*x*c;j[3]=w*e*t-x*d*t-w*f*r+y*d*r+x*f*p-y*e*p;j[7]=q*d*t-o*e*t+o*f*r-s*d*r-q*f*p+s*e*p;j[11]=o*x*t-q*w*t-o*y*r+s*w*r+q*y*p-s*x*p;j[15]=q*w*f-o*x*f+o*y*e-s*w*e-q*y*d+s*x*d;var g=z[0]*j[0]+z[1]*j[4]+z[2]*j[8]+z[3]*j[12];if(g==0){var h="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(k||false){throw new Error(h)}else{console.warn(h)}this.identity();return this}this.multiplyScalar(1/g);return this},extractBasis:function(d,c,e){var f=this.elements;d.set(f[0],f[1],f[2]);c.set(f[4],f[5],f[6]);e.set(f[8],f[9],f[10]);return this},makeBasis:function(d,c,e){this.set(d.x,c.x,e.x,0,d.y,c.y,e.y,0,d.z,c.z,e.z,0,0,0,0,1);return this},extractPosition:function(c){var e=this.elements;var d=c.elements;e[12]=d[12];e[13]=d[13];e[14]=d[14];return this},extractRotation:function(c){var d=new b.Vector3();return function(e){var k=this.elements;var j=e.elements;var h=1/d.set(j[0],j[1],j[2]).length();var g=1/d.set(j[4],j[5],j[6]).length();var f=1/d.set(j[8],j[9],j[10]).length();k[0]=j[0]*h;k[1]=j[1]*h;k[2]=j[2]*h;k[4]=j[4]*g;k[5]=j[5]*g;k[6]=j[6]*g;k[8]=j[8]*f;k[9]=j[9]*f;k[10]=j[10]*f;return this}}(),translate:function(d){var f=this.elements;var c=d.x,g=d.y,e=d.z;f[12]=f[0]*c+f[4]*g+f[8]*e+f[12];f[13]=f[1]*c+f[5]*g+f[9]*e+f[13];f[14]=f[2]*c+f[6]*g+f[10]*e+f[14];f[15]=f[3]*c+f[7]*g+f[11]*e+f[15];return this},rotateX:function(g){var f=this.elements;var l=f[4];var e=f[5];var o=f[6];var k=f[7];var j=f[8];var d=f[9];var n=f[10];var h=f[11];var m=Math.cos(g);var p=Math.sin(g);f[4]=m*l+p*j;f[5]=m*e+p*d;f[6]=m*o+p*n;f[7]=m*k+p*h;f[8]=m*j-p*l;f[9]=m*d-p*e;f[10]=m*n-p*o;f[11]=m*h-p*k;return this},rotateY:function(g){var f=this.elements;var l=f[0];var e=f[1];var o=f[2];var k=f[3];var j=f[8];var d=f[9];var n=f[10];var h=f[11];var m=Math.cos(g);var p=Math.sin(g);f[0]=m*l-p*j;f[1]=m*e-p*d;f[2]=m*o-p*n;f[3]=m*k-p*h;f[8]=m*j+p*l;f[9]=m*d+p*e;f[10]=m*n+p*o;f[11]=m*h+p*k;return this},rotateZ:function(g){var f=this.elements;var l=f[0];var e=f[1];var o=f[2];var k=f[3];var j=f[4];var d=f[5];var n=f[6];var h=f[7];var m=Math.cos(g);var p=Math.sin(g);f[0]=m*l+p*j;f[1]=m*e+p*d;f[2]=m*o+p*n;f[3]=m*k+p*h;f[4]=m*j-p*l;f[5]=m*d-p*e;f[6]=m*n-p*o;f[7]=m*h-p*k;return this},rotateByAxis:function(q,p){var d=this.elements;if(q.x===1&&q.y===0&&q.z===0){return this.rotateX(p)}else{if(q.x===0&&q.y===1&&q.z===0){return this.rotateY(p)}else{if(q.x===0&&q.y===0&&q.z===1){return this.rotateZ(p)}}}var I=q.x,H=q.y,G=q.z;var K=Math.sqrt(I*I+H*H+G*G);I/=K;H/=K;G/=K;var B=I*I,j=H*H,R=G*G;var T=Math.cos(p);var J=Math.sin(p);var r=1-T;var A=I*H*r;var w=I*G*r;var h=H*G*r;var D=I*J;var o=H*J;var W=G*J;var m=B+(1-B)*T;var V=A+W;var F=w-o;var l=A-W;var U=j+(1-j)*T;var E=h+D;var k=w+o;var S=h-D;var C=R+(1-R)*T;var O=d[0],v=d[1],g=d[2],Q=d[3];var M=d[4],u=d[5],f=d[6],P=d[7];var L=d[8],t=d[9],e=d[10],N=d[11];d[0]=m*O+V*M+F*L;d[1]=m*v+V*u+F*t;d[2]=m*g+V*f+F*e;d[3]=m*Q+V*P+F*N;d[4]=l*O+U*M+E*L;d[5]=l*v+U*u+E*t;d[6]=l*g+U*f+E*e;d[7]=l*Q+U*P+E*N;d[8]=k*O+S*M+C*L;d[9]=k*v+S*u+C*t;d[10]=k*g+S*f+C*e;d[11]=k*Q+S*P+C*N;return this},scale:function(d){var f=this.elements;var c=d.x,g=d.y,e=d.z;f[0]*=c;f[4]*=g;f[8]*=e;f[1]*=c;f[5]*=g;f[9]*=e;f[2]*=c;f[6]*=g;f[10]*=e;f[3]*=c;f[7]*=g;f[11]*=e;return this},getMaxScaleOnAxis:function(){var e=this.elements;var f=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];var d=e[4]*e[4]+e[5]*e[5]+e[6]*e[6];var c=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(f,Math.max(d,c)))},makeTranslation:function(c,e,d){this.set(1,0,0,c,0,1,0,e,0,0,1,d,0,0,0,1);return this},makeRotationX:function(d){var f=Math.cos(d),e=Math.sin(d);this.set(1,0,0,0,0,f,-e,0,0,e,f,0,0,0,0,1);return this},makeRotationY:function(d){var f=Math.cos(d),e=Math.sin(d);this.set(f,0,e,0,0,1,0,0,-e,0,f,0,0,0,0,1);return this},makeRotationZ:function(d){var f=Math.cos(d),e=Math.sin(d);this.set(f,-e,0,0,e,f,0,0,0,0,1,0,0,0,0,1);return this},makeRotationAxis:function(d,e){var h=Math.cos(e);var n=Math.sin(e);var m=1-h;var l=d.x,k=d.y,j=d.z;var g=m*l,f=m*k;this.set(g*l+h,g*k-n*j,g*j+n*k,0,g*k+n*j,f*k+h,f*j-n*l,0,g*j-n*k,f*j+n*l,m*j*j+h,0,0,0,0,1);return this},makeScale:function(c,e,d){this.set(c,0,0,0,0,e,0,0,0,0,d,0,0,0,0,1);return this},makeFrustum:function(g,r,e,o,j,h){var f=this.elements;var q=2*j/(r-g);var n=2*j/(o-e);var p=(r+g)/(r-g);var m=(o+e)/(o-e);var l=-(h+j)/(h-j);var k=-2*h*j/(h-j);f[0]=q;f[4]=0;f[8]=p;f[12]=0;f[1]=0;f[5]=n;f[9]=m;f[13]=0;f[2]=0;f[6]=0;f[10]=l;f[14]=k;f[3]=0;f[7]=0;f[11]=-1;f[15]=0;return this},makePerspective:function(g,c,j,h,m,l){var e=j*Math.tan(b.Math.degToRad(g*0.5));var k=-e;var d=k*c;var f=e*c;if(m){m*=Math.abs(f-d);d+=m;f+=m}if(l){l*=Math.abs(e-k);k+=l;e+=l}return this.makeFrustum(d,f,k,e,j,h)},makeOrthographic:function(f,r,n,c,k,j){var e=this.elements;var q=r-f;var g=n-c;var d=j-k;var o=(r+f)/q;var m=(n+c)/g;var l=(j+k)/d;e[0]=2/q;e[4]=0;e[8]=0;e[12]=-o;e[1]=0;e[5]=2/g;e[9]=0;e[13]=-m;e[2]=0;e[6]=0;e[10]=-2/d;e[14]=-l;e[3]=0;e[7]=0;e[11]=0;e[15]=1;return this},clone:function(){var c=this.elements;return new b.Matrix4(c[0],c[4],c[8],c[12],c[1],c[5],c[9],c[13],c[2],c[6],c[10],c[14],c[3],c[7],c[11],c[15])}};b.extend(b.Matrix4.prototype,{compose:function(){var d=new b.Matrix4();var c=new b.Matrix4();return function(e,f,h){var g=this.elements;d.identity();d.setRotationFromQuaternion(f);c.makeScale(h.x,h.y,h.z);this.multiplyMatrices(d,c);g[12]=e.x;g[13]=e.y;g[14]=e.z;return this}}(),decompose:function(){var c=new b.Vector3();var f=new b.Vector3();var e=new b.Vector3();var d=new b.Matrix4();return function(g,h,k){var j=this.elements;c.set(j[0],j[1],j[2]);f.set(j[4],j[5],j[6]);e.set(j[8],j[9],j[10]);g=(g instanceof b.Vector3)?g:new b.Vector3();h=(h instanceof b.Quaternion)?h:new b.Quaternion();k=(k instanceof b.Vector3)?k:new b.Vector3();k.x=c.length();k.y=f.length();k.z=e.length();g.x=j[12];g.y=j[13];g.z=j[14];d.copy(this);d.elements[0]/=k.x;d.elements[1]/=k.x;d.elements[2]/=k.x;d.elements[4]/=k.y;d.elements[5]/=k.y;d.elements[6]/=k.y;d.elements[8]/=k.z;d.elements[9]/=k.z;d.elements[10]/=k.z;h.setFromRotationMatrix(d);return[g,h,k]}}()});b.Color=function(c){if(c!==undefined){this.set(c)}return this};b.Color.prototype={constructor:b.Color,r:1,g:1,b:1,set:function(c){switch(typeof c){case"number":this.setHex(c);break;case"string":this.setStyle(c);break;case"object":this.copy(c);break}},setHex:function(c){c=Math.floor(c);this.r=(c>>16&255)/255;this.g=(c>>8&255)/255;this.b=(c&255)/255;return this},setRGB:function(e,d,c){this.r=e;this.g=d;this.b=c;return this},setHSV:function(e,d,c){console.log("DEPRECATED: Color's .setHSV() will be removed. Use .setHSL( h, s, l ) instead.");return this.setHSL(e,d*c/((e=(2-d)*c)<1?e:2-e),e/2)},setHSL:function(f,e,d){if(e===0){this.r=this.g=this.b=d}else{var c=function(l,k,h){if(h<0){h+=1}if(h>1){h-=1}if(h<1/6){return l+(k-l)*6*h}if(h<1/2){return k}if(h<2/3){return l+(k-l)*6*(2/3-h)}return l};var j=d<=0.5?d*(1+e):d+e-(d*e);var g=(2*d)-j;this.r=c(g,j,f+1/3);this.g=c(g,j,f);this.b=c(g,j,f-1/3)}return this},setStyle:function(d){if(/^rgb\((\d+),(\d+),(\d+)\)$/i.test(d)){var c=/^rgb\((\d+),(\d+),(\d+)\)$/i.exec(d);this.r=Math.min(255,parseInt(c[1],10))/255;this.g=Math.min(255,parseInt(c[2],10))/255;this.b=Math.min(255,parseInt(c[3],10))/255;return this}if(/^rgb\((\d+)\%,(\d+)\%,(\d+)\%\)$/i.test(d)){var c=/^rgb\((\d+)\%,(\d+)\%,(\d+)\%\)$/i.exec(d);this.r=Math.min(100,parseInt(c[1],10))/100;this.g=Math.min(100,parseInt(c[2],10))/100;this.b=Math.min(100,parseInt(c[3],10))/100;return this}if(/^\#([0-9a-f]{6})$/i.test(d)){var c=/^\#([0-9a-f]{6})$/i.exec(d);this.setHex(parseInt(c[1],16));return this}if(/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.test(d)){var c=/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(d);this.setHex(parseInt(c[1]+c[1]+c[2]+c[2]+c[3]+c[3],16));return this}if(/^(\w+)$/i.test(d)){this.setHex(b.ColorKeywords[d]);return this}},copy:function(c){this.r=c.r;this.g=c.g;this.b=c.b;return this},copyGammaToLinearNRECompatible:function(c){this.r=(c.r<0.04045)?(c.r/12.92):Math.pow((c.r+0.055)/1.055,2.4);this.g=(c.g<0.04045)?(c.g/12.92):Math.pow((c.g+0.055)/1.055,2.4);this.b=(c.b<0.04045)?(c.b/12.92):Math.pow((c.b+0.055)/1.055,2.4);return this},copyGammaToLinear:function(c){this.r=c.r*c.r;this.g=c.g*c.g;this.b=c.b*c.b;return this},copyLinearToGamma:function(c){this.r=Math.sqrt(c.r);this.g=Math.sqrt(c.g);this.b=Math.sqrt(c.b);return this},convertGammaToLinear:function(){var e=this.r,d=this.g,c=this.b;this.r=e*e;this.g=d*d;this.b=c*c;return this},convertLinearToGamma:function(){this.r=Math.sqrt(this.r);this.g=Math.sqrt(this.g);this.b=Math.sqrt(this.b);return this},getHex:function(){return(this.r*255)<<16^(this.g*255)<<8^(this.b*255)<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(){var c={h:0,s:0,l:0};return function(){var d=this.r,h=this.g,k=this.b;var l=Math.max(d,h,k);var e=Math.min(d,h,k);var j,f;var n=(e+l)/2;if(e===l){j=0;f=0}else{var m=l-e;f=n<=0.5?m/(l+e):m/(2-l-e);switch(l){case d:j=(h-k)/m+(h<k?6:0);break;case h:j=(k-d)/m+2;break;case k:j=(d-h)/m+4;break}j/=6}c.h=j;c.s=f;c.l=n;return c}}(),getStyle:function(){return"rgb("+((this.r*255)|0)+","+((this.g*255)|0)+","+((this.b*255)|0)+")"},offsetHSL:function(f,e,c){var d=this.getHSL();d.h+=f;d.s+=e;d.l+=c;this.setHSL(d.h,d.s,d.l);return this},add:function(c){this.r+=c.r;this.g+=c.g;this.b+=c.b;return this},addColors:function(d,c){this.r=d.r+c.r;this.g=d.g+c.g;this.b=d.b+c.b;return this},addScalar:function(c){this.r+=c;this.g+=c;this.b+=c;return this},multiply:function(c){this.r*=c.r;this.g*=c.g;this.b*=c.b;return this},multiplyScalar:function(c){this.r*=c;this.g*=c;this.b*=c;return this},desaturate:function(d){var c=0.587*this.g+0.299*this.r+0.114*this.b;var e=Math.min(Math.max(1-d,0.00001),1);this.r=this.r*e+d*c;this.g=this.g*e+d*c;this.b=this.b*e+d*c;return this},saturate:function(d){var c=0.587*this.g+0.299*this.r+0.114*this.b;var e=1/Math.min(Math.max(1-d,0.00001),1);this.r=(this.r-d*c)*e;this.g=(this.g-d*c)*e;this.b=(this.b-d*c)*e;return this},alphaBlend:function(c,d){d=Math.min(Math.max(d,0),0.99999);var e=1-d;this.r=c.r*d+this.r*e;this.g=c.g*d+this.g*e;this.b=c.b*d+this.b*e;return this},negative:function(){this.r=1-this.r;this.g=1-this.g;this.b=1-this.b;return this},lerp:function(c,d){this.r+=(c.r-this.r)*d;this.g+=(c.g-this.g)*d;this.b+=(c.b-this.b)*d;return this},equals:function(d){return(d.r===this.r)&&(d.g===this.g)&&(d.b===this.b)},clone:function(){return new b.Color().setRGB(this.r,this.g,this.b)},toArray:function(){return[this.r,this.g,this.b]}};b.ColorKeywords={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};return b});define("Mesh/ThreeJS_Base",["DS/Mesh/ThreeJS_Base","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Mesh/ThreeJS_Base");return b});define("DS/Visualization/SectionCappingPassCreator",["UWA/Class"],function(b){var a=b.extend({init:function(){},setupViewer:function(c){}});return a});define("Visualization/SectionCappingPassCreator",["DS/Visualization/SectionCappingPassCreator","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/SectionCappingPassCreator");return b});define("DS/VisuDataAccess/Ox4FeatureModeler",["DS/ZipJS/zip"],function(c){var a={rootFeature:new (function(){this.startupFacade=function d(){this.attributes={}};this.featureFacade=new this.startupFacade()})(),fmZipReader:function(e){var d=this;d.archive=new c.BlobReader(e);d.entries=null;d.entriesCount=0;d.entriesRead=0;d.readNextEntry=function(f,g){var h=d.entries[d.entriesRead];(function(j){h.getData(new c.TextWriter(),function(k){f(j,k.target.result);if(++d.entriesRead==d.entriesCount){g()}else{d.readNextEntry(f,g)}})})(h.filename)};d.read=function(f,g){c.createReader(d.archive,function(h){h.getEntries(function(j){d.entries=j;d.entriesCount=j.length;d.readNextEntry(f,g)})})}},unstreamDocument:function(d,g){var f={containers:{},links:{},features:{}};if(a.representations.hasOwnProperty(d.representationId)){console.log("[E] FM: representation already loaded");return}a.representations[d.representationId]={uuid:{},component:{},specobject:{}};var e=new a.fmZipReader(d.stream);e.read(function(j,m){var q=/91ACA40B\\0\.8\\(data.json)/g;var o=/D182A118\\0\.8\\(data.json)/g;var h=/BFC0DC13\\0\.8\\(data.json)/g;var k,n,p;var l=(k=q.exec(j))!==null?"containers":(n=o.exec(j))!==null?"links":(p=h.exec(j))!==null?"features":null;if(l){a.unstreamDomain[l]({domainDependencyTable:f[l],externalDependencies:function(r,s){return f[r][s]},representationId:d.representationId,repRef:d.repRef,stream:m})}},g)},unstreamDomain:{containers:function(e){var f=(undefined!==e.resourceName)?a.resources[e.resourceName]:a.representations[e.representationId];f.containers=e.stream?JSON.parse(e.stream):undefined;var d;for(d in f.containers){e.domainDependencyTable[d]=f.containers[d]}},links:function(d){var e=(undefined!==d.resourceName)?a.resources[d.resourceName]:a.representations[d.representationId];e.links=d.stream?JSON.parse(d.stream):undefined;var g;for(g in e.links){var f=e.links[g];f.relationTarget=d.repRef.SemanticRelations[f.RelationId];d.domainDependencyTable[g]=f}},features:function(e){var d=null;try{d=JSON.parse(e.stream)}catch(f){throw ("[F] FM: JSON error)")}var j={};var h;for(h in d){var g=d[h];j[h]=new a.Feature(g,j,e)}for(h in d){a.unstreamFeature2(j[h],j,e)}}},unstreamFeature2:function(n,m,g){var j=(undefined!=g.resourceName)?a.resources[g.resourceName]:a.representations[g.representationId];var l;var h;for(l in n.data.attributes){var e=n.data.attributes[l];var f=(e.value instanceof Array)?e.value:[e.value];switch(e.type){case"external":if(undefined!==g.representationId){for(h=0;h<f.length;h++){f[h]=(null!==f[h])?g.externalDependencies("links",f[h].id):undefined}}break;case"component":case"specobject":for(h=0;h<f.length;h++){var k=(null!==f[h])?m[f[h].id]:undefined;if(k){f[h]=k.featureFacade;var d=k.data.uuid;if("component"===e.type&&j[e.type][d]){throw"[F] FM: AGG error"}if(!j[e.type][d]){j[e.type][d]=[]}j[e.type][d].push({source:n,attrName:l})}}break;default:}if(e.value instanceof Array){Object.freeze(e.value)}else{e.value=f[0]}}},Feature:function(h,j,e){var g=this;g.data={properties:h.properties,attributes:h.values,startupProperties:h.startup,name:h.system.name,diezele:h.readonly.diezele,uuid:h.readonly.uuid};if(h.hasOwnProperty("ancestor")){if(h.ancestor.hasOwnProperty("resource")){g.data.ancestor=a.rootFeature}else{g.data.ancestor=j[h.ancestor.id]}}else{g.data.ancestor=a.rootFeature}g.featureFacade=new g.data.ancestor.featureFacade.constructor();g.featureFacade.name=g.data.name;g.featureFacade.attributes=Object.create(g.data.ancestor.featureFacade.attributes);var d=function(l){var k={get:function(){return a.getValue(g.data.attributes[l])},enumerable:true};return k};Object.defineProperty(g.featureFacade,"name",{get:function(){return g.data.name},enumerable:true});var f;for(f in g.data.attributes){Object.defineProperty(g.featureFacade.attributes,f,(function(k){return{get:function(){return a.getValue(g.data.attributes[k])},enumerable:true}})(f))}if(g.data.uuid in a.representations[e.representationId].uuid){throw"[F] FM: uuid already defined in same scope"}a.representations[e.representationId].uuid[g.data.uuid]=g},getValue:function(f){var e=f.value;var d;switch(f.type){case"external":var g=(e instanceof Array)?e:[e];for(d=0;d<g.length;d++){g[d]=g[d].relationTarget}if(!e instanceof Array){e=g[0]}break;default:}return e},};var b={init:function(){a.representations={}},loadRepresentation:function(d,e,f,g){a.unstreamDocument({stream:f,representationId:e,repRef:d},g)},loadResource:function(d,e){a.unstreamDocument({stream:e,resourceName:d})},listRootFeatures:function(f){var g=[],e;for(e in a.representations[f].uuid){if(undefined===a.representations[f].component[e]){var d=a.representations[f].uuid[e];g.push(d.featureFacade)}}return g},containFeatures:function(d){return a.representations.hasOwnProperty(d)}};return b});define("DS/Visualization/ProxyAbstraction",["UWA/Class","DS/WAFData/WAFData"],function(b,a){var c=function(){this.useNoProxy=function(d){this.proxyUsage=0;this.server=null;this.sport=null;this.withCredentials=d};this.useProxyDefinedBy=function(e,d){this.proxyUsage=1;this.server=e;this.sport=d};this.useUWAProxy=function(d){this.proxyUsage=2;this.server=null;this.sport=null;this.proxymode=d.proxymode;this.requestsOptions=d.requestsOptions};this.rewriteUrlUsingProxyDef=function(f,g,e){var d=f.indexOf("/");var j=f.indexOf("/",d+2);var h=f.slice(0,d)+"//"+g+":"+e+f.slice(j,f.length);return h};this.executeGetHttpRequest=function(e,j,l,k,g,d){var h=function(p,o){return function(q){if(p){p({url:o,type:"LOAD",responseCode:q})}}}(g,e);if(this.proxyUsage===2){var n=this.requestsOptions||{};n.headers=n.headers||new Object();if(d){n.headers.Accept=d}if(n.data){n.data.GET=n.data.GET||l}n.method=n.method||"GET";n.timeout=3600000;n.async=true;n.onComplete=k;n.onFailure=function(o){var r=o.message.split('"');var q=null;for(var p=0;p<(r.length-1);p++){if(r[p].search("return ResponseCode with value")!=-1){q=parseInt(r[p+1])}}if(q){h(q)}},n.onTimeout=function(o){h(408)},n.type=j;if(n.proxymode){n.authentication=n.proxymode}var f=a.handleRequest(e,n)}else{if(this.proxyUsage===1){e=this.rewriteUrlUsingProxyDef(e,this.server,this.sport)}var m=new XMLHttpRequest();m.open("GET",e,true);m.onload=function(p){var o=m.status;if((o===200)||((o===0)&&(this.response&&this.response.byteLength>0))){k(this.response)}else{h(o)}};m.onerror=function(o){h(m.status)};m.ontimeout=function(o){h(408)};m.timeout=3600000;m.setRequestHeader("X-Requested-With","XMLHttpRequest");if(this.withCredentials){m.withCredentials=true}if(j==="arraybuffer"){m.responseType=j}if(j==="blob"){m.responseType=j}m.send(l)}}};return c});define("DS/VisuUnstreamers/UnstreamTaskDriver",["UWA/Class"],function(b){var a=b.singleton({init:function(){return this},getTask:function(g,e,c,f){var d="DS/VisuUnstreamers/"+g+"UnstreamTask";require([d],function(j){var h=new j(e,c);if(f){f(h)}})}});return UWA.namespace("THREEDS/UnstreamTaskDriver",a)});define("VisuUnstreamers/UnstreamTaskDriver",["DS/VisuUnstreamers/UnstreamTaskDriver","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuUnstreamers/UnstreamTaskDriver");return b});define("DS/DSMigration/DSMigration",function(){var a=function(){this.deprecateModule=function(e){console.log("DS AMD module migration : use 'DS/"+e+"' instead of '"+e+"' in your define/require calls. Modules that still reference '"+e+"' :");if(!requirejs||!requirejs.s||!requirejs.s.contexts||!requirejs.s.contexts._.registry){return}var b=requirejs.s.contexts._.registry;for(var f in b){if(b[f]){if(b[f].depMaps){var d=b[f].depMaps;if(d&&d.length){for(var c=0;c<d.length;++c){if(d[c]&&d[c].id==e){console.log("     "+f)}}}}}}}};return new a()});define("DS/Visualization/OccurrenceInterfaceFactory",["UWA/Class"],function(a){var b=a.extend({init:function(c,d){this._occurrenceExplorer=c;this.viewer=d},getOccurrenceItf:function(c){var d=c._getUniqueOccurrence(this.viewer);if(d){return this._occurrenceExplorer.getOccurrenceInterface(d)}else{return null}},getOccurrenceItfMulti:function(e){var f=e._getOccurrences(this.viewer);var c=[];var d;for(d=0;d<f.length;d++){c.push(this._occurrenceExplorer.getOccurrenceInterface(f[d]))}return c},getUserRootOccurrenceItf:function(){var c=this.viewer.internalSceneGraph.userRoot._occurrences[0];return this._occurrenceExplorer.getOccurrenceInterface(c)}});return b});define("DS/Visualization/ClippingContext",["UWA/Class"],function(b){var a=b.extend({init:function(c){this.planes=c||[];this.excludeFromClippingPlanes=[];this.clippingSettings=null;this.sectionCappingMaterials=null;this.sectionLinesProperties=null;window.sealWebVisuObjects&&Object.seal(this)},setPlanes:function(c,e){this.planes=c||[];if(e){var d;for(d=this.planes.length-1;d>=0;d--){if(e.indexOf(this.planes[d])>=0){this.planes.splice(d,1)}}}},setExcludeFromClippingPlanes:function(c){this.excludeFromClippingPlanes=c||[]},setFrontAndBackOpacity:function(d,c){if(d===null||c===null){this.clippingSettings=null}else{this.clippingSettings={frontOpacity:d,backOpacity:c}}},getFrontOpacity:function(){return this.frontOpacity},getBackOpacity:function(){return this.backOpacity},setSectionCappingMaterial:function(g,e){if(!this.sectionCappingMaterials){this.sectionCappingMaterials=[];this.sectionCappingMaterials.defaultMaterial=null}var d=e||null;if(!d){this.sectionCappingMaterials.defaultMaterial=g}else{var f=0,c=-1;for(f=0;c===-1&&f<this.sectionCappingMaterials.length;f++){if(this.sectionCappingMaterials[f].clippingPlane===d){c=f}}if(c>=0){this.sectionCappingMaterials[c].material=g}else{this.sectionCappingMaterials.push({clippingPlane:d,material:g})}}},setSectionLinesProperties:function(c){if(c){this.sectionLinesProperties={color:c.color===undefined?null:c.color,width:c.width}}else{this.sectionLinesProperties=null}},getSectionCappingMaterial:function(c){if(this.sectionCappingMaterials){if(!c){return this.sectionCappingMaterials.defaultMaterial}else{var d;for(d=0;d<this.sectionCappingMaterials.length;d++){if(this.sectionCappingMaterials[d].clippingPlane===c){return this.sectionCappingMaterials[d].material}}}}return null},removeSectionCappingMaterial:function(d){if(!this.sectionCappingMaterials){return}var c=d||null;var e=0;for(e=0;e<this.sectionCappingMaterials.length;e++){if(this.sectionCappingMaterials[e].clippingPlane===c){this.sectionCappingMaterials.splice(e,1)}}if(!this.sectionCappingMaterials.length){this.sectionCappingMaterials=null}},clone:function(){var e=new a(this.planes);e.excludeFromClippingPlanes=[].concat(this.excludeFromClippingPlanes);if(this.clippingSettings){e.clippingSettings={frontOpacity:this.clippingSettings.frontOpacity,backOpacity:this.clippingSettings.backOpacity}}if(this.sectionCappingMaterials){e.sectionCappingMaterials=[];e.sectionCappingMaterials.defaultMaterial=this.sectionCappingMaterials.defaultMaterial;var c,d;for(c=0;c<this.sectionCappingMaterials.length;c++){d=this.sectionCappingMaterials[c];e.sectionCappingMaterials.push({clippingPlane:d.clippingPlane,material:d.material})}}e.sectionLinesProperties=this.sectionLinesProperties;return e},addPlane:function(c){if(this.planes.indexOf(c)<0){this.planes.push(c);return true}return false},removePlane:function(c){var d=this.planes.indexOf(c);if(d>=0){this.planes.splice(d,1);return true}return false},isPointVisible:function(c){var g=this.clippingSettings&&this.clippingSettings.frontOpacity<0.5;var f,e,d;for(f=0;f<this.planes.length;f++){e=this.planes[f];if(this.excludeFromClippingPlanes.indexOf(e)<0){if(e.distanceToPoint(c)<0){return g?true:false}}}return g?false:true},_mergeWithParent:function(l){if(!l){return this}var h=new a();var e=[].concat(this.planes);var f;for(f=0;f<l.planes.length;f++){if(e.indexOf(l.planes[f])<0){e.push(l.planes[f])}}h.setPlanes(e,this.excludeFromClippingPlanes);h.clippingSettings=this.clippingSettings||l.clippingSettings;var c=null;if(this.sectionCappingMaterials&&l.sectionCappingMaterials){var c=[].concat(this.sectionCappingMaterials||[]);c.defaultMaterials=this.sectionCappingMaterials.defaultMaterial||l.sectionCappingMaterials.defaultMaterial;var k=l.sectionCappingMaterials||[];var d;var g;for(f=0;f<k.length;f++){g=false;for(d=0;d<c.length&&!g;d++){if(c[d].clippingPlane===k[f].clippingPlane){g=true}}if(!g){c.push(k[f])}}}else{c=this.sectionCappingMaterials||l.sectionCappingMaterials}h.sectionCappingMaterials=c;return h},setAntiPlanes:function(){this.setExcludeFromClippingPlanes.apply(this,arguments)}});return a});define("DS/Visualization/ThreeJS_R57",["DS/Mesh/ThreeJS_Base","DS/Visualization/FixedSizeArrayPool","DS/Visualization/SessionNodesWithSectionProfile","DS/Visualization/OutlineBuilder","DS/Visualization/SectionBuilder","UWA/Data"],function(s,d,k,c,r,f){var a={};a.FrontSide=0;a.BackSide=1;a.DoubleSide=2;a.BoundaryPointRenderPointMask=s.GeomTypeEnum.BOUNDARY_POINT;a.SharpPointRenderPointMask=s.GeomTypeEnum.SHARP_POINT;a.SmoothPointRenderPointMask=s.GeomTypeEnum.SMOOTH_POINT;a.SurfacicPointRenderPointMask=s.GeomTypeEnum.SURFACIC_POINT;a.FreePointRenderPointMask=s.GeomTypeEnum.FREE_POINT;a.AllPointsRenderPointMask=a.BoundaryPointRenderPointMask|a.SharpPointRenderPointMask|a.SmoothPointRenderPointMask|a.SurfacicPointRenderPointMask|a.FreePointRenderPointMask;a.AllPointsButSurfacicPointsRenderPointMask=a.BoundaryPointRenderPointMask|a.SharpPointRenderPointMask|a.SmoothPointRenderPointMask|a.FreePointRenderPointMask;a.vertexComponentBits={POSITION:1,NORMAL:2,UV:4,UV2:8,COLOR:16,TANGENT:32,BINORMAL:64,PREVIOUSPOS:128,NEXTPOS:256,SIDEEXTR:512,LINEDIST:1024,SKININDEX:2048,SKINWEIGHT:4096};s.Constants=a;s.FrontSide=0;s.BackSide=1;s.DoubleSide=2;s.disableJHGDev=true;self.console=self.console||{info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}};self.Int32Array=self.Int32Array||Array;self.Float32Array=self.Float32Array||Array;String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")};String.prototype.hashCode=function(){var w=0,u,v;if(this.length===0){return w}for(u=0;u<this.length;u++){v=this.charCodeAt(u);w=((w<<5)-w)+v;w|=0}return w};(function(){var v=0;var w=["ms","moz","webkit","o"];for(var u=0;u<w.length&&!window.requestAnimationFrame;++u){window.requestAnimationFrame=window[w[u]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[w[u]+"CancelAnimationFrame"]||window[w[u]+"CancelRequestAnimationFrame"]}if(window.requestAnimationFrame===undefined){window.requestAnimationFrame=function(A){var x=Date.now(),y=Math.max(0,16-(x-v));var z=window.setTimeout(function(){A(x+y,false)},y);v=x+y;return z}}window.cancelAnimationFrame=window.cancelAnimationFrame||function(x){window.clearTimeout(x)}}());s.__renderTargetID=0;s.CullFaceNone=0;s.CullFaceBack=1;s.CullFaceFront=2;s.CullFaceFrontBack=3;s.FrontFaceDirectionCW=0;s.FrontFaceDirectionCCW=1;s.BasicShadowMap=0;s.PCFShadowMap=1;s.PCFSoftShadowMap=2;s.PCFInterpolShadowMap=3;s.PCFPoissonShadowMap=4;s.PCFOptimizedShadowMap=5;s.ESMShadowMap=6;s.ESMImprovedShadowMap=7;s.LowQuality=0;s.MediumQuality=1;s.HighQuality=2;s.NoShading=0;s.FlatShading=1;s.SmoothShading=2;s.FrontToBack=0;s.BackToFront=1;s.NoColors=0;s.FaceColors=1;s.VertexColors=2;s.VertexColorsRGBA=s.VertexColors;s.VertexColorsRGB=3;s.VertexColorsA=4;s.NoBlending=0;s.NormalBlending=1;s.AdditiveBlending=2;s.SubtractiveBlending=3;s.MultiplyBlending=4;s.CustomBlending=5;s.NormalDepthBlending=6;s.AlphaBlending=7;s.AddEquation=100;s.SubtractEquation=101;s.ReverseSubtractEquation=102;s.MinEquation=103;s.MaxEquation=104;s.ZeroFactor=200;s.OneFactor=201;s.SrcColorFactor=202;s.OneMinusSrcColorFactor=203;s.SrcAlphaFactor=204;s.OneMinusSrcAlphaFactor=205;s.DstAlphaFactor=206;s.OneMinusDstAlphaFactor=207;s.DstColorFactor=208;s.OneMinusDstColorFactor=209;s.SrcAlphaSaturateFactor=210;s.MultiplyOperation=0;s.MixOperation=1;s.AddOperation=2;s.UVMapping=function(){};s.CubeReflectionMapping=function(){};s.CubeRefractionMapping=function(){};s.SphericalReflectionMapping=function(){};s.SphericalRefractionMapping=function(){};s.LatLongReflectionMapping=function(){};s.LatLongRefractionMapping=function(){};s.SimpleEnvMapping=function(){};s.SimpleEnvMappingPreserveRatio=function(){};s.SimpleEnvMappingFit=function(){};s.SimpleEnvMappingFitWidth=function(){};s.SimpleEnvMappingFitHeight=function(){};s.SimpleEnvMappingCustom=function(){};s.CubeEnvMapping=function(){};s.LightProbeEnvMapping=function(){};s.LatLongEnvMapping=function(){};s.RepeatWrapping=1000;s.ClampToEdgeWrapping=1001;s.MirroredRepeatWrapping=1002;s.NearestFilter=1003;s.NearestMipMapNearestFilter=1004;s.NearestMipMapLinearFilter=1005;s.LinearFilter=1006;s.LinearMipMapNearestFilter=1007;s.LinearMipMapLinearFilter=1008;s.UnsignedByteType=1009;s.ByteType=1010;s.ShortType=1011;s.UnsignedShortType=1012;s.IntType=1013;s.UnsignedIntType=1014;s.FloatType=1015;s.UnsignedShort4444Type=1016;s.UnsignedShort5551Type=1017;s.UnsignedShort565Type=1018;s.AlphaFormat=1019;s.RGBFormat=1020;s.RGBAFormat=1021;s.LuminanceFormat=1022;s.LuminanceAlphaFormat=1023;s.RGB_S3TC_DXT1_Format=2001;s.RGBA_S3TC_DXT1_Format=2002;s.RGBA_S3TC_DXT3_Format=2003;s.RGBA_S3TC_DXT5_Format=2004;s.SmoothEdgeRenderLineModeMask=s.GeomTypeEnum.SMOOTH_EDGE;s.SharpEdgeRenderLineModeMask=s.GeomTypeEnum.SHARP_EDGE;s.WireEdgeRenderLineModeMask=s.GeomTypeEnum.WIRE_EDGE;s.BoundaryEdgeRenderLineModeMask=s.GeomTypeEnum.BOUNDARY_EDGE;s.HideAllRenderLineMode=0;s.OutlineMask=s.GeomTypeEnum._OUTLINE;s.SectionLineMask=s.GeomTypeEnum._SECTION_LINE;s.HideWireEdgesRenderLineMode=s.SmoothEdgeRenderLineModeMask|s.SharpEdgeRenderLineModeMask|s.BoundaryEdgeRenderLineModeMask;s.HideSmoothEdgesRenderLineMode=s.SharpEdgeRenderLineModeMask|s.WireEdgeRenderLineModeMask|s.BoundaryEdgeRenderLineModeMask;s.HideInternalEdgesRenderLineMode=s.WireEdgeRenderLineModeMask|s.BoundaryEdgeRenderLineModeMask;s.ShowAllRenderLineMode=s.SmoothEdgeRenderLineModeMask|s.SharpEdgeRenderLineModeMask|s.WireEdgeRenderLineModeMask|s.BoundaryEdgeRenderLineModeMask;s.ShowOutlinesAndEdgesRenderLineMode=s.OutlineMask|s.ShowAllRenderLineMode;s.ShowOutlinesHideEdgesRenderLineMode=s.OutlineMask|s.HideAllRenderLineMode;s.HideAllModelFaces=0;s.ShowAllFaces=s.GeomTypeEnum.FACE|s.GeomTypeEnum.INFINITE_FACE|s.GeomTypeEnum.AXIS_SYSTEM;s.BoundaryPointRenderPointMask=s.GeomTypeEnum.BOUNDARY_POINT;s.SharpPointRenderPointMask=s.GeomTypeEnum.SHARP_POINT;s.SmoothPointRenderPointMask=s.GeomTypeEnum.SMOOTH_POINT;s.SurfacicPointRenderPointMask=s.GeomTypeEnum.SURFACIC_POINT;s.FreePointRenderPointMask=s.GeomTypeEnum.FREE_POINT;s.AllPointsRenderPointMask=s.BoundaryPointRenderPointMask|s.SharpPointRenderPointMask|s.SmoothPointRenderPointMask|s.SurfacicPointRenderPointMask|s.FreePointRenderPointMask;s.AllPointsButSurfacicPointsRenderPointMask=s.BoundaryPointRenderPointMask|s.SharpPointRenderPointMask|s.SmoothPointRenderPointMask|s.FreePointRenderPointMask;s.loadingModels=false;s.IdentityMatrix=new s.Matrix4();var h=[];h.push(new s.Vector2(-0.770613,-0.239161));h.push(new s.Vector2(0.654029,-0.712337));h.push(new s.Vector2(-0.307109,0.184156));h.push(new s.Vector2(0.511665,0.311578));h.push(new s.Vector2(0.950228,-0.256954));h.push(new s.Vector2(-0.00583136,-0.537149));h.push(new s.Vector2(-0.692077,0.433278));h.push(new s.Vector2(-0.357517,0.88078));h.push(new s.Vector2(0.278742,0.859941));h.push(new s.Vector2(-0.631555,-0.471973));h.push(new s.Vector2(-0.480475,-0.732053));h.push(new s.Vector2(-0.486058,0.576291));h.push(new s.Vector2(0.190138,-0.625394));h.push(new s.Vector2(-0.176393,-0.166675));h.push(new s.Vector2(0.0663065,-0.333703));h.push(new s.Vector2(0.348117,-0.812683));h.push(new s.Vector2(0.0817859,0.0594559));h.push(new s.Vector2(0.375191,-0.0632498));h.push(new s.Vector2(0.770788,-0.0723965));h.push(new s.Vector2(0.800971,0.431381));h.push(new s.Vector2(-0.100114,0.320657));h.push(new s.Vector2(0.285262,0.61499));h.push(new s.Vector2(-0.579148,0.219349));h.push(new s.Vector2(-0.684372,-0.0462647));h.push(new s.Vector2(-0.313914,-0.939188));h.push(new s.Vector2(-0.414696,0.367707));h.push(new s.Vector2(0.698927,0.219188));h.push(new s.Vector2(0.971183,0.130313));h.push(new s.Vector2(0.0822042,0.526062));h.push(new s.Vector2(-0.214193,0.522263));h.push(new s.Vector2(-0.0751906,0.901432));h.push(new s.Vector2(0.488676,-0.253098));h.push(new s.Vector2(-0.580828,0.778049));h.push(new s.Vector2(0.816108,-0.536974));h.push(new s.Vector2(0.51456,0.543311));h.push(new s.Vector2(-0.213744,-0.428735));h.push(new s.Vector2(0.293803,-0.405018));h.push(new s.Vector2(0.169169,0.259656));h.push(new s.Vector2(0.445091,-0.594255));h.push(new s.Vector2(-0.453123,-0.1009));h.push(new s.Vector2(-0.420509,-0.388243));h.push(new s.Vector2(0.576791,0.0184982));h.push(new s.Vector2(0.610535,0.759891));h.push(new s.Vector2(0.692311,-0.348235));h.push(new s.Vector2(0.0912182,0.752741));h.push(new s.Vector2(-0.840539,0.203544));h.push(new s.Vector2(0.0673295,-0.961926));h.push(new s.Vector2(-0.951943,0.0129663));h.push(new s.Vector2(-0.14793,-0.811125));s._AmbianceGenerators={viewers:[],loading:false,manager:null,needsUpdate:false,cb:null,errorCount:0,init:function(u){if(this.loading||this.manager){return}if(!this.available(u)){return}if(this.manager===null){this.loading=true;var v=this;require(["DS/Visualization/AmbianceGenerator"],function(w){v.loading=false;v.manager=new w(v.cb)})}},available:function(v){var u=s.supportedExtensions.vertexTextureUnits>8&&s.supportedExtensions.fragmentTextureUnits>8&&!!s.supportedExtensions.textureFloat;if(!u){if(v===0&&this.errorCount<10){console.warn("Warning: device does not support automatic mip map generation for hdrs, please set one yourself")}else{if(v===1&&this.errorCount<11){console.warn("Warning: device does not support fabrics under ibl")}}this.errorCount++}return u},getAmbiance:function(u,v,w,x){if(!this.manager){return null}return this.manager.getAmbiance(u,v,w,x)},update:function(v,u){if(!this.manager){return}this.needsUpdate=false;this.manager.update(v,u)},decreaseUseCount:function(u){if(!this.manager){return}this.manager.decreaseUseCount(u)},setCallBack:function(u){this.cb=u;if(this.manager){this.manager._setCB(u)}},dispose:function(v){if(!this.manager){return}var u=this.viewers.indexOf(v);if(u>-1){this.viewers.splice(u,1)}if(this.viewers.length===0){this.manager.dispose();this.manager=null}}};s.MemoryInfo=function(){this.reset()};s.MemoryInfo.prototype.reset=function(){this.programs=0;this.geometries=0;this.textures=0;this.sharedbuffers=0};s.MemoryInfo.prototype.copyTo=function(u){u.programs=this.programs;u.geometries=this.geometries;u.textures=this.textures;u.sharedbuffers=this.sharedbuffers};s.RenderInfo=function(){this.reset()};s.RenderInfo.prototype.reset=function(){this.calls=0;this.vertices=0;this.faces=0;this.lines=0;this.points=0;this.meshes=0;this.culledMeshes=0;this.culledGeometries=0;this.culledDGTriangles=0;this.culledDGLines=0;this.nbDGs=0;this.nbReps=0;this.nbTriangles=0;this.nbDGsSSBProcessed=0};s.RenderInfo.prototype.copyTo=function(u){u.calls=this.calls;u.vertices=this.vertices;u.faces=this.faces;u.lines=this.lines;u.points=this.points;u.meshes=this.meshes;u.culledMeshes=this.culledMeshes;u.culledGeometries=this.culledGeometries;u.culledDGTriangles=this.culledDGTriangles;u.culledDGLines=this.culledDGLines;u.nbDGs=this.nbDGs;u.nbReps=this.nbReps;u.nbTriangles=this.nbTriangles;u.nbDGsSSBProcessed=this.nbDGsSSBProcessed};s.ObjectUniformLocations=function(){this.modelMatrix=null;this.modelViewMatrix=null;this.modelViewInvTranspMatrix=null;this.modelInvTranspMatrix=null;this.shadowMatrix=null;this.normalMatrix=null;this.quantizedVector=null;this.offsetVector=null;this.use_normal_matrix=null;this.fixedSizeRatio=null;this.fixedSizeCenterRatio=null};s.ProgramObject=function(){this.program=null;this.id=0;this.uniformLocations=null;this.objectUniformLocations=null;this.attributes={position:-1,normal:-1,uv:-1,uv2:-1,tangent:-1,binormal:-1,color:-1,skinIndex:-1,skinWeight:-1,lineDistance:-1,previousPos:-1,followingPos:-1,sideExtrusion:-1,};this.uvOrBinOrTan=false;this.instanceAttributes={};this.flattenedUniformArrays={};this._clipPlanesVersion=-1;this._lightsKey=0};s.glStates={currentFramebuffer:undefined,currentWidth:0,currentHeight:0};s.MaterialToUse={originalMaterial:0,normalMaterial:1,depthMaterial:2,normalDepthMaterial:3,shadowMapDepthMaterial:4,highlightMaterial:5,outlineHighlightMaterial:6,preHighlightMaterial:7,pickingMaterial:8,pickingMaterialInstancing:9,oitAccumMaterial:10,oitRevealMaterial:11,ZOnlyMaterial:12,gasLookMaterial:13,totalMaterial:14};s.ShaderIDs={none:-1,basic:0,phong:1,lambert:2,line:3,particle_basic:4,physicalDS:5,line2D:6,normal:7};s.ShaderIDsToName=["basic","phong","lambert","line","particle_basic","physicalDS","line2D","normal"];s.MaterialHasPriority=[false,true,true,true,true,true,true,true,true,true,false,false,false,false];s.Line3=function(v,u){this.start=(v!==undefined)?v:new s.Vector3();this.end=(u!==undefined)?u:new s.Vector3()};s.Line3.prototype={constructor:s.Line3,set:function(v,u){this.start.copy(v);this.end.copy(u);return this},copy:function(u){this.start.copy(u.start);this.end.copy(u.end);return this},center:function(v){var u=v||new s.Vector3();return u.addVectors(this.start,this.end).multiplyScalar(0.5)},delta:function(v){var u=v||new s.Vector3();return u.subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(w,v){var u=v||new s.Vector3();return this.delta(u).multiplyScalar(w).add(this.start)},closestPointToPointParameter:function(){var v=new s.Vector3();var u=new s.Vector3();return function(w,A){v.subVectors(w,this.start);u.subVectors(this.end,this.start);var z=u.dot(u);var y=u.dot(v);var x=y/z;if(A){x=s.Math.clamp(x,0,1)}return x}}(),closestPointToPoint:function(v,y,x){var w=this.closestPointToPointParameter(v,y);var u=x||new s.Vector3();return this.delta(u).multiplyScalar(w).add(this.start)},applyMatrix4:function(u){this.start.applyMatrix4(u);this.end.applyMatrix4(u);return this},equals:function(u){return u.start.equals(this.start)&&u.end.equals(this.end)},clone:function(){return new s.Line3().copy(this)}};s.Box2=function(v,u){this.min=(v!==undefined)?v:new s.Vector2(Infinity,Infinity);this.max=(u!==undefined)?u:new s.Vector2(-Infinity,-Infinity)};s.Box2.prototype={constructor:s.Box2,set:function(v,u){this.min.copy(v);this.max.copy(u);return this},setFromPoints:function(x){if(x.length>0){var u=x[0];this.min.copy(u);this.max.copy(u);for(var w=1,v=x.length;w<v;w++){u=x[w];if(u.x<this.min.x){this.min.x=u.x}else{if(u.x>this.max.x){this.max.x=u.x}}if(u.y<this.min.y){this.min.y=u.y}else{if(u.y>this.max.y){this.max.y=u.y}}}}else{this.makeEmpty()}return this},setFromCenterAndSize:function(){var u=new s.Vector2();return function(v,x){var w=u.copy(x).multiplyScalar(0.5);this.min.copy(v).sub(w);this.max.copy(v).add(w);return this}}(),copy:function(u){this.min.copy(u.min);this.max.copy(u.max);return this},makeEmpty:function(){this.min.x=this.min.y=Infinity;this.max.x=this.max.y=-Infinity;return this},empty:function(){return(this.max.x<this.min.x)||(this.max.y<this.min.y)},singlePoint:function(){return(this.max.x<=this.min.x)&&(this.max.y<=this.min.y)},center:function(v){var u=v||new s.Vector2();return u.addVectors(this.min,this.max).multiplyScalar(0.5)},size:function(v){var u=v||new s.Vector2();return u.subVectors(this.max,this.min)},expandByPoint:function(u){this.min.min(u);this.max.max(u);return this},expandByVector:function(u){this.min.sub(u);this.max.add(u);return this},expandByScalar:function(u){this.min.addScalar(-u);this.max.addScalar(u);return this},containsPoint:function(u){if(u.x<this.min.x||u.x>this.max.x||u.y<this.min.y||u.y>this.max.y){return false}return true},containsBox:function(u){if((this.min.x<=u.min.x)&&(u.max.x<=this.max.x)&&(this.min.y<=u.min.y)&&(u.max.y<=this.max.y)){return true}return false},getParameter:function(u){return new s.Vector2((u.x-this.min.x)/(this.max.x-this.min.x),(u.y-this.min.y)/(this.max.y-this.min.y))},isIntersectionBox:function(u){if(u.max.x<this.min.x||u.min.x>this.max.x||u.max.y<this.min.y||u.min.y>this.max.y){return false}return true},clampPoint:function(v,w){var u=w||new s.Vector2();return u.copy(v).clamp(this.min,this.max)},distanceToPoint:function(){var u=new s.Vector2();return function(v){var w=u.copy(v).clamp(this.min,this.max);return w.sub(v).length()}}(),intersect:function(u){this.min.max(u.min);this.max.min(u.max);return this},union:function(u){this.min.min(u.min);this.max.max(u.max);return this},translate:function(u){this.min.add(u);this.max.add(u);return this},equals:function(u){return u.min.equals(this.min)&&u.max.equals(this.max)},clone:function(){return new s.Box2().copy(this)}};s.Box3=function(v,u){this.min=(v!==undefined)?v:new s.Vector3(Infinity,Infinity,Infinity);this.max=(u!==undefined)?u:new s.Vector3(-Infinity,-Infinity,-Infinity)};s.Box3.prototype={constructor:s.Box3,set:function(v,u){this.min.copy(v);this.max.copy(u);return this},setFromPoints:function(x){if(x.length>0){var u=x[0];this.min.copy(u);this.max.copy(u);for(var w=1,v=x.length;w<v;w++){u=x[w];if(u.x<this.min.x){this.min.x=u.x}else{if(u.x>this.max.x){this.max.x=u.x}}if(u.y<this.min.y){this.min.y=u.y}else{if(u.y>this.max.y){this.max.y=u.y}}if(u.z<this.min.z){this.min.z=u.z}else{if(u.z>this.max.z){this.max.z=u.z}}}}else{this.makeEmpty()}return this},setFromCenterAndSize:function(){var u=new s.Vector3();return function(v,x){var w=u.copy(x).multiplyScalar(0.5);this.min.copy(v).sub(w);this.max.copy(v).add(w);return this}}(),createJSON:function(){return[this.min.x,this.min.y,this.min.z,this.max.x,this.max.y,this.max.z]},setFromJSON:function(u){this.min.set(u[0],u[1],u[2]);this.max.set(u[3],u[4],u[5])},copy:function(u){this.min.copy(u.min);this.max.copy(u.max);return this},makeEmpty:function(){this.min.x=this.min.y=this.min.z=Infinity;this.max.x=this.max.y=this.max.z=-Infinity;return this},empty:function(){return(this.max.x<this.min.x)||(this.max.y<this.min.y)||(this.max.z<this.min.z)},singlePoint:function(){return(this.max.x<=this.min.x)&&(this.max.y<=this.min.y)&&(this.max.z<=this.min.z)},center:function(v){var u=v||new s.Vector3();return u.addVectors(this.min,this.max).multiplyScalar(0.5)},size:function(v){var u=v||new s.Vector3();return u.subVectors(this.max,this.min)},expandByPoint:function(u){this.min.min(u);this.max.max(u);return this},expandByVector:function(u){this.min.sub(u);this.max.add(u);return this},expandByScalar:function(u){this.min.addScalar(-u);this.max.addScalar(u);return this},containsPoint:function(u){if(u.x<this.min.x||u.x>this.max.x||u.y<this.min.y||u.y>this.max.y||u.z<this.min.z||u.z>this.max.z){return false}return true},containsBox:function(u){if((this.min.x<=u.min.x)&&(u.max.x<=this.max.x)&&(this.min.y<=u.min.y)&&(u.max.y<=this.max.y)&&(this.min.z<=u.min.z)&&(u.max.z<=this.max.z)){return true}return false},getParameter:function(u){return new s.Vector3((u.x-this.min.x)/(this.max.x-this.min.x),(u.y-this.min.y)/(this.max.y-this.min.y),(u.z-this.min.z)/(this.max.z-this.min.z))},isIntersectionBox:function(u){if(u.max.x<this.min.x||u.min.x>this.max.x||u.max.y<this.min.y||u.min.y>this.max.y||u.max.z<this.min.z||u.min.z>this.max.z){return false}return true},clampPoint:function(v,w){var u=w||new s.Vector3();return u.copy(v).clamp(this.min,this.max)},distanceToPoint:function(){var u=new s.Vector3();return function(v){var w=u.copy(v).clamp(this.min,this.max);return w.sub(v).length()}}(),getBoundingSphere:function(){var u=new s.Vector3();return function(w){var v=w||new s.Sphere();v.center=this.center();v.radius=this.size(u).length()*0.5;return v}}(),intersect:function(u){this.min.max(u.min);this.max.min(u.max);return this},union:function(u){this.min.min(u.min);this.max.max(u.max);return this},applyMatrix4:function(){var u=[new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3()];return function(v){u[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(v);u[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(v);u[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(v);u[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(v);u[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(v);u[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(v);u[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(v);u[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(v);this.makeEmpty();this.setFromPoints(u);return this}}(),getPoints:function(){var u=[new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3()];return function(v){u[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(v);u[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(v);u[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(v);u[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(v);u[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(v);u[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(v);u[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(v);u[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(v);return u}}(),translate:function(u){this.min.add(u);this.max.add(u);return this},equals:function(u){return u.min.equals(this.min)&&u.max.equals(this.max)},clone:function(){return new s.Box3().copy(this)},mergeWithBox:function(u){this.expandByPoint(u.min);this.expandByPoint(u.max)},isNaN:function(){if(this.min.isNaN()||this.max.isNaN()){return true}else{return false}},fromDGBoundingBoxArray:function(z){var B=this;var u=z.length;if(u>1){var v=function(D){var F=z[0];for(var E=1;E<u;E++){var C=z[E];if(F.fastBBox.min[D]>C.fastBBox.min[D]){F=C}}return F};var A=function(D){var F=z[0];for(var E=1;E<u;E++){var C=z[E];if(F.fastBBox.max[D]<C.fastBBox.max[D]){F=C}}return F};var x=function(C){var D=v(C);while(B.min[C]>=D.fastBBox.min[C]){D.flagMinAttr(C);B.min[C]=Math.min(D.getMinAttr(C),B.min[C]);D=v(C)}};x("x");x("y");x("z");var y=function(C){var D=A(C);while(B.max[C]<=D.fastBBox.max[C]){D.flagMaxAttr(C);B.max[C]=Math.max(D.getMaxAttr(C),B.max[C]);D=A(C)}};y("x");y("y");y("z")}else{if(u>0){var w=z[0];this.union(w.getRealBBox())}}return this}};s.DGBoundingBoxArray=function(u){this.fastBBox=u.fastBBox.clone();this._realBBox=u.fastBBox.singlePoint()?u.fastBBox.clone():null;this.matrix=u.matrix.clone();this.renderable=u.renderable;this.obj=[]};s.DGBoundingBoxArray.prototype.computeFunction=function(){var v=new s.Box3();for(var u=0;u<this.obj.length;u++){var x=this.obj[u];var w=x.computeOrientedBoundingBox(this.matrix);v.union(w)}this._realBBox=v};s.DGBoundingBoxArray.prototype.getRealBBox=function(){if(this._realBBox===null){this.computeFunction()}return this._realBBox};s.DGBoundingBoxArray.prototype.getMinAttr=function(u){if(this._realBBox===null){this.computeFunction()}return this._realBBox.min[u]};s.DGBoundingBoxArray.prototype.getMaxAttr=function(u){if(this._realBBox===null){this.computeFunction()}return this._realBBox.max[u]};s.DGBoundingBoxArray.prototype.flagMaxAttr=function(u){this.fastBBox.max[u]=-Infinity};s.DGBoundingBoxArray.prototype.flagMinAttr=function(u){this.fastBBox.min[u]=Infinity};s.DGBoundingBoxArray.prototype.addDG=function(u){this.obj.push(u)};s.DGBoundingBoxArray.prototype.setDGs=function(u){this.obj=u};s.DGBoundingBoxArray.prototype.empty=function(){return this.obj.length===0};s.Ray=function(u,v){this.origin=(u!==undefined)?u:new s.Vector3();this.direction=(v!==undefined)?v:new s.Vector3()};s.Ray.prototype={constructor:s.Ray,set:function(u,v){this.origin.copy(u);this.direction.copy(v);return this},copy:function(u){this.origin.copy(u.origin);this.direction.copy(u.direction);return this},at:function(w,v){var u=v||new s.Vector3();return u.copy(this.direction).multiplyScalar(w).add(this.origin)},recast:function(){var u=new s.Vector3();return function(v){this.origin.copy(this.at(v,u));return this}}(),closestPointToPoint:function(v,w){var u=w||new s.Vector3();u.subVectors(v,this.origin);var x=u.dot(this.direction);return u.copy(this.direction).multiplyScalar(x).add(this.origin)},distanceToPoint:function(){var u=new s.Vector3();return function(v){var w=u.subVectors(v,this.origin).dot(this.direction);u.copy(this.direction).multiplyScalar(w).add(this.origin);return u.distanceTo(v)}}(),distanceSqToSegment:function(){var w=new s.Vector3();var v=new s.Vector3();var x=new s.Vector3();return function u(K,G,H,A){w.copy(K).add(G).multiplyScalar(0.5);v.copy(G).sub(K).normalize();x.copy(this.origin).sub(w);var C=K.distanceTo(G)*0.5;var y=-this.direction.dot(v);var I=x.dot(this.direction);var F=-x.dot(v);var E=x.lengthSq();var D=Math.abs(1-y*y);var M,J,z,L;if(D>0){M=y*F-I;J=y*I-F;L=C*D;if(M>=0){if(J>=-L){if(J<=L){var B=1/D;M*=B;J*=B;z=M*(M+y*J+2*I)+J*(y*M+J+2*F)+E}else{J=C;M=Math.max(0,-(y*J+I));z=-M*M+J*(J+2*F)+E}}else{J=-C;M=Math.max(0,-(y*J+I));z=-M*M+J*(J+2*F)+E}}else{if(J<=-L){M=Math.max(0,-(-y*C+I));J=(M>0)?-C:Math.min(Math.max(-C,-F),C);z=-M*M+J*(J+2*F)+E}else{if(J<=L){M=0;J=Math.min(Math.max(-C,-F),C);z=J*(J+2*F)+E}else{M=Math.max(0,-(y*C+I));J=(M>0)?C:Math.min(Math.max(-C,-F),C);z=-M*M+J*(J+2*F)+E}}}}else{J=(y>0)?-C:C;M=Math.max(0,-(y*J+I));z=-M*M+J*(J+2*F)+E}if(H){H.copy(this.direction).multiplyScalar(M).add(this.origin)}if(A){A.copy(v).multiplyScalar(J).add(w)}return z}}(),isIntersectionSphere:function(u){return(this.distanceToPoint(u.center)<=u.radius)},isIntersectionPlane:function(u){var v=u.normal.dot(this.direction);if(v!=0){return true}if(u.distanceToPoint(this.origin)==0){return true}return false},distanceToPlane:function(u){var w=u.normal.dot(this.direction);if(w==0){if(u.distanceToPoint(this.origin)==0){return 0}return undefined}var v=-(this.origin.dot(u.normal)+u.constant)/w;return v},intersectPlane:function(u,w){var v=this.distanceToPlane(u);if(v===undefined){return undefined}return this.at(v,w)},intersectBox:function(z,F){var w,A,C,u,B,E;var y=1/this.direction.x,x=1/this.direction.y,v=1/this.direction.z;var D=this.origin;if(y>=0){w=(z.min.x-D.x)*y;A=(z.max.x-D.x)*y}else{w=(z.max.x-D.x)*y;A=(z.min.x-D.x)*y}if(x>=0){C=(z.min.y-D.y)*x;u=(z.max.y-D.y)*x}else{C=(z.max.y-D.y)*x;u=(z.min.y-D.y)*x}if((w>u)||(C>A)){return null}if(C>w||w!==w){w=C}if(u<A||A!==A){A=u}if(v>=0){B=(z.min.z-D.z)*v;E=(z.max.z-D.z)*v}else{B=(z.max.z-D.z)*v;E=(z.min.z-D.z)*v}if((w>E)||(B>A)){return null}if(B>w||w!==w){w=B}if(E<A||A!==A){A=E}if(A<0){return null}return this.at(w>=0?w:A,F)},applyMatrix4:function(u){this.direction.add(this.origin).applyMatrix4(u);this.origin.applyMatrix4(u);this.direction.sub(this.origin);this.direction.normalize();return this},equals:function(u){return u.origin.equals(this.origin)&&u.direction.equals(this.direction)},clone:function(){return new s.Ray().copy(this)}};s.Sphere=function(v,u){this.center=(v!==undefined)?v:new s.Vector3();this.radius=(u!==undefined)?u:0;this.pixelRadius=0};s.Sphere.prototype={constructor:s.Sphere,set:function(v,u){this.center.copy(v);this.radius=u;return this},createJSON:function(){var u=[this.center.x,this.center.y,this.center.z,this.radius];return u},setFromJSON:function(u){this.center.set(u[0],u[1],u[2]);this.radius=u[3]},setFromCenterAndPoints:function(u,z){var v=0;for(var y=0,w=z.length;y<w;y++){var x=u.distanceToSquared(z[y]);v=Math.max(v,x)}this.center=u;this.radius=Math.sqrt(v);return this},copy:function(u){this.center.copy(u.center);this.radius=u.radius;this.pixelRadius=u.pixelRadius;return this},empty:function(){return(this.radius<=0)},containsPoint:function(u){return(u.distanceToSquared(this.center)<=(this.radius*this.radius)+0.000001)},distanceToPoint:function(u){return(u.distanceTo(this.center)-this.radius)},containsSphere:function(u){return this.center.distanceTo(u.center)<=this.radius-u.radius},intersectsSphere:function(u){var v=this.radius+u.radius;return u.center.distanceToSquared(this.center)<=(v*v)},intersectsLine:function(v){var A=v[1].clone().sub(v[0]);var y=this.center.clone().sub(v[0]);var w=A.dot(y);var z=A.dot(A);var x=v[0].clone().add(A.clone().multiplyScalar(w/z));if(!this.containsPoint(x)){return false}var u=x.sub(v[0]).dot(A);if(u>=0&&u<=z){return true}return false},intersectsTriangle:function(u){return this.intersectsLine([u[0],u[1]])||this.intersectsLine([u[1],u[2]])||this.intersectsLine([u[2],u[0]])},clampPoint:function(v,x){var w=this.center.distanceToSquared(v);var u=x||new s.Vector3();u.copy(v);if(w>(this.radius*this.radius)){u.sub(this.center).normalize();u.multiplyScalar(this.radius).add(this.center)}return u},getBoundingBox:function(u){var v=u||new s.Box3();v.set(this.center,this.center);v.expandByScalar(this.radius);return v},applyMatrix4:function(u){if(u){this.center.applyMatrix4(u);this.radius=this.radius*u.getMaxScaleOnAxis()}return this},translate:function(u){this.center.add(u);return this},equals:function(u){return u.center.equals(this.center)&&(u.radius===this.radius)},clone:function(){return new s.Sphere().copy(this)},mergeWithSphere:function(v,A){var u,z;if(this.radius<v.radius){u=this;z=v}else{u=v;z=this}var x;var B=z.center.distanceTo(u.center),w;var y=Math.max(v.pixelRadius,A.pixelRadius);if(B+u.radius<=z.radius){A.copy(z)}else{x=0.5*(u.radius+z.radius+B);w=(x-z.radius)/B;A.radius=x;A.center.x=w*u.center.x+(1-w)*z.center.x;A.center.y=w*u.center.y+(1-w)*z.center.y;A.center.z=w*u.center.z+(1-w)*z.center.z}A.pixelRadius=y},isNaN:function(){if(!isFinite(this.radius)||this.center.isNaN()){return true}else{return false}},_updateRatio:function(u){if(u===0){return}this.pixelRadius+=this.center.length()*u;this.set(new s.Vector3(),this.radius+this.center.length());this.radius*=u;this.pixelRadius=Math.max(this.pixelRadius,this.radius);this.radius=0},};s.Frustum=function(z,y,x,w,v,u){this.planes=[(z!==undefined)?z:new s.Plane(),(y!==undefined)?y:new s.Plane(),(x!==undefined)?x:new s.Plane(),(w!==undefined)?w:new s.Plane(),(v!==undefined)?v:new s.Plane(),(u!==undefined)?u:new s.Plane()]};s.Frustum.prototype={constructor:s.Frustum,set:function(A,z,y,x,w,v){var u=this.planes;u[0].copy(A);u[1].copy(z);u[2].copy(y);u[3].copy(x);u[4].copy(w);u[5].copy(v);return this},copy:function(w){var u=this.planes;for(var v=0;v<6;v++){u[v].copy(w.planes[v])}return this},setFromMatrix:function(H){var B=this.planes;var M=H.elements;var F=M[0],D=M[1],C=M[2],A=M[3];var z=M[4],y=M[5],x=M[6],w=M[7];var v=M[8],u=M[9],L=M[10],K=M[11];var J=M[12],I=M[13],G=M[14],E=M[15];B[0].setComponents(A-F,w-z,K-v,E-J).normalize();B[1].setComponents(A+F,w+z,K+v,E+J).normalize();B[2].setComponents(A+D,w+y,K+u,E+I).normalize();B[3].setComponents(A-D,w-y,K-u,E-I).normalize();B[4].setComponents(A-C,w-x,K-L,E-G).normalize();B[5].setComponents(A+C,w+x,K+L,E+G).normalize();return this},intersectsObject:function(){var u=new s.Vector3();return function(y){var w=y._getMMMatrix();var x=this.planes;var v=-y.geometry.boundingSphere.radius*w.getMaxScaleOnAxis();u.getPositionFromMatrix(w);for(var z=0;z<6;z++){var A=x[z].distanceToPoint(u);if(A<v){return false}}return true}}(),intersectsSphere:function(w){var x=this.planes;var u=w.center;var v=-w.radius;for(var y=0;y<6;y++){var z=x[y].distanceToPoint(u);if(z<v){return false}}return true},containsSphere:function(u){var v=this.planes;for(var w=0;w<6;w++){if(v[w].distanceToPoint(u.center)-u.radius<0){return false}}return true},containsPoint:function(u){var v=this.planes;for(var w=0;w<6;w++){if(v[w].distanceToPoint(u)<0){return false}}return true},clone:function(){return new s.Frustum().copy(this)},computeOutcode:function(u){var v=0;if(u.dot(this.planes[0].normal)+this.planes[0].constant<0){v|=1}if(u.dot(this.planes[1].normal)+this.planes[1].constant<0){v|=2}if(u.dot(this.planes[2].normal)+this.planes[2].constant<0){v|=4}if(u.dot(this.planes[3].normal)+this.planes[3].constant<0){v|=8}if(u.dot(this.planes[4].normal)+this.planes[4].constant<0){v|=16}if(u.dot(this.planes[5].normal)+this.planes[5].constant<0){v|=32}return v},intersectsLine:function(v){var w=[],A=[new s.Vector3(),new s.Vector3()];A[0].copy(v[0]);A[1].copy(v[1]);w[0]=this.computeOutcode(A[0]);w[1]=this.computeOutcode(A[1]);for(var y=0;y<4;y++){if(w[0]===0||w[1]===0){return true}if((w[0]&w[1])!==0){break}var z=new s.Vector3(A[0].x-A[1].x,A[0].y-A[1].y,A[0].z-A[1].z);var x=0;var u=null;if(w[0]&1){u=this.planes[0]}else{if(w[0]&2){u=this.planes[1]}else{if(w[0]&4){u=this.planes[2]}else{if(w[0]&8){u=this.planes[3]}else{if(w[0]&16){u=this.planes[4]}else{if(w[0]&32){u=this.planes[5]}}}}}}if(u){x=-(A[0].dot(u.normal)+u.constant)/z.dot(u.normal)}A[0].add(z.multiplyScalar(x));w[0]=this.computeOutcode(A[0])}return false},intersectsTriangle:function(u){return this.intersectsLine([u[0],u[1]])||this.intersectsLine([u[1],u[2]])||this.intersectsLine([u[2],u[0]])}};s.Plane=function(v,u){this.normal=(v!==undefined)?v:new s.Vector3(1,0,0);this.constant=(u!==undefined)?u:0};s.Plane.prototype={constructor:s.Plane,set:function(v,u){this.normal.copy(v);this.constant=u;return this},setComponents:function(u,B,A,v){this.normal.set(u,B,A);this.constant=v;return this},setFromNormalAndCoplanarPoint:function(v,u){this.normal.copy(v);this.constant=-u.dot(this.normal);return this},setFromCoplanarPoints:function(){var v=new s.Vector3();var u=new s.Vector3();return function(x,w,z){var y=v.subVectors(z,w).cross(u.subVectors(x,w)).normalize();this.setFromNormalAndCoplanarPoint(y,x);return this}}(),copy:function(u){this.normal.copy(u.normal);this.constant=u.constant;return this},normalize:function(){var u=1/this.normal.length();this.normal.multiplyScalar(u);this.constant*=u;return this},negate:function(){this.constant*=-1;this.normal.negate();return this},distanceToPoint:function(u){return this.normal.dot(u)+this.constant},distanceToSphere:function(u){return this.distanceToPoint(u.center)-u.radius},projectPoint:function(u,v){return this.orthoPoint(u,v).sub(u).negate()},orthoPoint:function(v,x){var w=this.distanceToPoint(v);var u=x||new s.Vector3();return u.copy(this.normal).multiplyScalar(w)},isIntersectionLine:function(u){var w=this.distanceToPoint(u.start);var v=this.distanceToPoint(u.end);return(w<0&&v>0)||(v<0&&w>0)},intersectLine:function(){var u=new s.Vector3();return function(w,y){var v=y||new s.Vector3();var z=w.delta(u);var A=this.normal.dot(z);if(A==0){if(this.distanceToPoint(w.start)==0){return v.copy(w.start)}return undefined}var x=-(w.start.dot(this.normal)+this.constant)/A;if(x<0||x>1){return undefined}return v.copy(z).multiplyScalar(x).add(w.start)}}(),coplanarPoint:function(v){var u=v||new s.Vector3();return u.copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var v=new s.Vector3();var u=new s.Vector3();return function(x,y){y=y||new s.Matrix3().getInverse(x).transpose();var z=v.copy(this.normal).applyMatrix3(y);var w=this.coplanarPoint(u);w.applyMatrix4(x);this.setFromNormalAndCoplanarPoint(z,w);return this}}(),translate:function(u){this.constant=this.constant-u.dot(this.normal);return this},equals:function(u){return u.normal.equals(this.normal)&&(u.constant==this.constant)},clone:function(){return new s.Plane().copy(this)}};s.Math={clamp:function(v,w,u){return(v<w)?w:((v>u)?u:v)},clampBottom:function(u,v){return u<v?v:u},mapLinear:function(v,w,u,z,y){return z+(v-w)*(y-z)/(u-w)},smoothstep:function(v,w,u){if(v<=w){return 0}if(v>=u){return 1}v=(v-w)/(u-w);return v*v*(3-2*v)},smootherstep:function(v,w,u){if(v<=w){return 0}if(v>=u){return 1}v=(v-w)/(u-w);return v*v*v*(v*(v*6-15)+10)},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(u,v){return u+Math.floor(Math.random()*(v-u+1))},randFloat:function(u,v){return u+Math.random()*(v-u)},randFloatSpread:function(u){return u*(0.5-Math.random())},sign:function(u){return(u<0)?-1:((u>0)?1:0)},degToRad:function(){var u=Math.PI/180;return function(v){return v*u}}(),radToDeg:function(){var u=180/Math.PI;return function(v){return v*u}}()};s.Spline=function(G){this.points=G;var A=[],C={x:0,y:0,z:0},F,u,x,w,v,E,D,B,z;this.initFromArray=function(H){this.points=[];for(var I=0;I<H.length;I++){this.points[I]={x:H[I][0],y:H[I][1],z:H[I][2]}}};this.getPoint=function(H){F=(this.points.length-1)*H;u=Math.floor(F);x=F-u;A[0]=u===0?u:u-1;A[1]=u;A[2]=u>this.points.length-2?this.points.length-1:u+1;A[3]=u>this.points.length-3?this.points.length-1:u+2;E=this.points[A[0]];D=this.points[A[1]];B=this.points[A[2]];z=this.points[A[3]];w=x*x;v=x*w;C.x=y(E.x,D.x,B.x,z.x,x,w,v);C.y=y(E.y,D.y,B.y,z.y,x,w,v);C.z=y(E.z,D.z,B.z,z.z,x,w,v);return C};this.getControlPointsArray=function(){var I,K,H=this.points.length,J=[];for(I=0;I<H;I++){K=this.points[I];J[I]=[K.x,K.y,K.z]}return J};this.getLength=function(J){var L,N,O,M,R=0,H=0,K=0,Q=new s.Vector3(),I=new s.Vector3(),P=[],S=0;P[0]=0;if(!J){J=100}O=this.points.length*J;Q.copy(this.points[0]);for(L=1;L<O;L++){N=L/O;M=this.getPoint(N);I.copy(M);S+=I.distanceTo(Q);Q.copy(M);R=(this.points.length-1)*N;H=Math.floor(R);if(H!=K){P[H]=S;K=H}}P[P.length]=S;return{chunks:P,total:S}};this.reparametrizeByArcLength=function(J){var N,M,Q,R,K,I,S,P,O,T=[],H=new s.Vector3(),L=this.getLength();T.push(H.copy(this.points[0]).clone());for(N=1;N<this.points.length;N++){S=L.chunks[N]-L.chunks[N-1];P=Math.ceil(J*S/L.total);R=(N-1)/(this.points.length-1);K=N/(this.points.length-1);for(M=1;M<P-1;M++){Q=R+M*(1/P)*(K-R);O=this.getPoint(Q);T.push(H.copy(O).clone())}T.push(H.copy(this.points[N]).clone())}this.points=T};function y(O,N,L,K,P,I,H){var M=(L-O)*0.5,J=(K-N)*0.5;return(2*(N-L)+M+J)*H+(-3*(N-L)-2*M-J)*I+M*P+N}};s.Triangle=function(v,u,w){this.a=(v!==undefined)?v:new s.Vector3();this.b=(u!==undefined)?u:new s.Vector3();this.c=(w!==undefined)?w:new s.Vector3()};s.Triangle.normal=function(){var u=new s.Vector3();return function(y,w,A,z){var v=z||new s.Vector3();v.subVectors(A,w);u.subVectors(y,w);v.cross(u);var x=v.lengthSq();if(x>0){return v.multiplyScalar(1/Math.sqrt(x))}return v.set(0,0,0)}}();s.Triangle.barycoordFromPoint=function(){var u=new s.Vector3();var w=new s.Vector3();var v=new s.Vector3();return function(H,G,E,B,L){u.subVectors(B,G);w.subVectors(E,G);v.subVectors(H,G);var F=u.dot(u);var D=u.dot(w);var C=u.dot(v);var z=w.dot(w);var x=w.dot(v);var A=(F*z-D*D);var K=L||new s.Vector3();if(A==0){return K.set(-2,-1,-1)}var y=1/A;var J=(z*C-D*x)*y;var I=(F*x-D*C)*y;return K.set(1-J-I,I,J)}}();s.Triangle.containsPoint=function(){var u=new s.Vector3();return function(x,y,w,z){var v=s.Triangle.barycoordFromPoint(x,y,w,z,u);return(v.x>=0)&&(v.y>=0)&&((v.x+v.y)<=1)}}();s.Triangle.prototype={constructor:s.Triangle,set:function(v,u,w){this.a.copy(v);this.b.copy(u);this.c.copy(w);return this},setFromPointsAndIndices:function(v,x,w,u){this.a.copy(v[x]);this.b.copy(v[w]);this.c.copy(v[u]);return this},copy:function(u){this.a.copy(u.a);this.b.copy(u.b);this.c.copy(u.c);return this},area:function(){var u=new s.Vector3();var v=new s.Vector3();return function(){u.subVectors(this.c,this.b);v.subVectors(this.a,this.b);return u.cross(v).length()*0.5}}(),midpoint:function(v){var u=v||new s.Vector3();return u.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(u){return s.Triangle.normal(this.a,this.b,this.c,u)},plane:function(v){var u=v||new s.Plane();return u.setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(u,v){return s.Triangle.barycoordFromPoint(u,this.a,this.b,this.c,v)},containsPoint:function(u){return s.Triangle.containsPoint(u,this.a,this.b,this.c)},equals:function(u){return u.a.equals(this.a)&&u.b.equals(this.b)&&u.c.equals(this.c)},clone:function(){return new s.Triangle().copy(this)}};s.Vertex=function(u){console.warn("THREE.Vertex has been DEPRECATED. Use THREE.Vector3 instead.");return u};s.UV=function(x,w){console.warn("THREE.UV has been DEPRECATED. Use THREE.Vector2 instead.");return new s.Vector2(x,w)};s.Clock=function(u){this.autoStart=(u!==undefined)?u:true;this.startTime=0;this.oldTime=0;this.elapsedTime=0;this.running=false};s.extend(s.Clock.prototype,{start:function(){this.startTime=window.performance!==undefined&&window.performance.now!==undefined?window.performance.now():Date.now();this.oldTime=this.startTime;this.running=true},stop:function(){this.getElapsedTime();this.running=false},getElapsedTime:function(){this.getDelta();return this.elapsedTime},getDelta:function(){var v=0;if(this.autoStart&&!this.running){this.start()}if(this.running){var u=window.performance!==undefined&&window.performance.now!==undefined?window.performance.now():Date.now();v=0.001*(u-this.oldTime);this.oldTime=u;this.elapsedTime+=v}return v}});s.EventDispatcher=function(){var u={};this.addEventListener=function(v,w){if(u[v]===undefined){u[v]=[]}if(u[v].indexOf(w)===-1){u[v].push(w)}};this.removeEventListener=function(w,x){var v=u[w].indexOf(x);if(v!==-1){u[w][v]=null}};this.dispatchEvent=function(z){var v=u[z.type];if(v!==undefined){z.target=this;var y=false;for(var x=0,w=v.length;x<w;x++){if(v[x]){v[x].call(this,z)}else{y=true}}if(y){var A=[];for(var x=0,w=v.length;x<w;x++){v[x]&&A.push(v[x])}u[z.type]=A}}}};(function(z){z.Raycaster=function(F,H,G,E){this.ray=new z.Ray(F,H);if(this.ray.direction.lengthSq()>0){this.ray.direction.normalize()}this.near=G||0;this.far=E||Infinity};var v=new z.Sphere();var w=new z.Ray();var A=new z.Plane();var C=new z.Vector3();var y=new z.Vector3();var B=new z.Matrix4();var u=function(F,E){return F.distance-E.distance};var x=function(Y,P,F){if(Y instanceof z.Particle){y.getPositionFromMatrix(Y.matrixWorld);var J=P.ray.distanceToPoint(y);if(J>Y.scale.x){return F}F.push({distance:J,point:Y.position,face:null,object:Y})}else{if(Y instanceof z.Mesh){var I=Y._getMMMatrix();y.getPositionFromMatrix(I);v.set(y,Y.geometry.boundingSphere.radius*I.getMaxScaleOnAxis());if(!P.ray.isIntersectionSphere(v)){return F}var K=Y.geometry;var L=K.vertices;var H=Y.material instanceof z.MeshFaceMaterial;var Q=H===true?Y.material.materials:null;var G=Y.material.side;var X,V,U,T;var R=P.precision;Y.matrixRotationWorld.extractRotation(I);B.getInverse(I);w.copy(P.ray).applyMatrix4(B);for(var S=0,N=K.faces.length;S<N;S++){var M=K.faces[S];var O=H===true?Q[M.materialIndex]:Y.material;if(O===undefined){continue}A.setFromNormalAndCoplanarPoint(M.normal,L[M.a]);var W=w.distanceToPlane(A);if(Math.abs(W)<R){continue}if(W<0){continue}G=O.side;if(G!==a.DoubleSide){var E=w.direction.dot(A.normal);if(!(G===a.FrontSide?E<0:E>0)){continue}}if(W<P.near||W>P.far){continue}C=w.at(W,C);if(M instanceof z.Face3){X=L[M.a];V=L[M.b];U=L[M.c];if(!z.Triangle.containsPoint(C,X,V,U)){continue}}else{if(M instanceof z.Face4){X=L[M.a];V=L[M.b];U=L[M.c];T=L[M.d];if((!z.Triangle.containsPoint(C,X,V,T))&&(!z.Triangle.containsPoint(C,V,U,T))){continue}}else{throw Error("face type not supported")}}F.push({distance:W,point:P.ray.at(W),face:M,faceIndex:S,object:Y})}}}};var D=function(G,F,I){var J=G.getDescendants();for(var H=0,E=J.length;H<E;H++){x(J[H],F,I)}};z.Raycaster.prototype.precision=0.0001;z.Raycaster.prototype.set=function(E,F){this.ray.set(E,F);if(this.ray.direction.length()>0){this.ray.direction.normalize()}};z.Raycaster.prototype.intersectObject=function(F,E){var G=[];if(E===true){D(F,this,G)}x(F,this,G);G.sort(u);return G};z.Raycaster.prototype.intersectObjects=function(I,F){var H=[];for(var G=0,E=I.length;G<E;G++){x(I[G],this,H);if(F===true){D(I[G],this,H)}}H.sort(u);return H}}(s));s.Object3D=function(){this.id=s.Object3DIdCount++;this.name="";this.parent=undefined;this.children=[];this.up=new s.Vector3(0,1,0);this.position=new s.Vector3();this.rotation=new s.Vector3();this.eulerOrder=s.Object3D.defaultEulerOrder;this.scale=new s.Vector3(1,1,1);this.worldCenter=new s.Vector3();this.worldRadius=0;this.isLargeScale=true;this._ratioData=null;this._distanceToCameraForLargeScale=0.1;this._programID=0;this.renderDepth=null;this.rotationAutoUpdate=true;this.matrix=new s.Matrix4();this.matrixWorld=new s.Matrix4();this.matrixRotationWorld=new s.Matrix4();this.modelViewInvTranspMatrix=null;this.modelInvTranspMatrix=null;this.matrixAutoUpdate=true;this.matrixWorldNeedsUpdate=true;this.quaternion=new s.Quaternion();this.useQuaternion=false;this.visible=true;this.visibilityFree=false;this.castShadow=false;this.receiveShadow=false;this.frustumCulled=true;this.userData={};this.__webglActive=null;this.__webglInit=false;this._modelViewMatrix=null;this._normalMatrix=null;this.isUniformlyScaled=true};s.TestDoubleAsFloat=new Float32Array(3);s.Object3D.prototype={constructor:s.Object3D,applyMatrix:function(){var u=new s.Matrix4();return function(v){this.matrix.multiplyMatrices(v,this.matrix);this.position.getPositionFromMatrix(this.matrix);this.scale.getScaleFromMatrix(this.matrix);this.isUniformlyScaled=Math.abs(this.scale.x-this.scale.y)<0.0001&&Math.abs(this.scale.z-this.scale.y)<0.0001?true:false;this._updateWorldCenterAndRadius();u.extractRotation(this.matrix);if(this.useQuaternion===true){this.quaternion.setFromRotationMatrix(u)}else{this.rotation.setEulerFromRotationMatrix(u,this.eulerOrder)}}}(),_computeLargeScaleStatus:function(){this.isLargeScale=false;var y=this._getMMMatrix().elements;var v=new s.Vector3(y[12],y[13],y[14]);s.TestDoubleAsFloat[0]=y[12];s.TestDoubleAsFloat[1]=y[13];s.TestDoubleAsFloat[2]=y[14];var A=new s.Vector3(s.TestDoubleAsFloat[0],s.TestDoubleAsFloat[1],s.TestDoubleAsFloat[2]);var z=this._distanceToCameraForLargeScale;var x=z*this.worldRadius;var w=0.005;if(Math.abs(A.x-v.x)>w*Math.abs(A.y+A.z+x)){this.isLargeScale=true;return}if(Math.abs(A.y-v.y)>w*Math.abs(A.x+A.z+x)){this.isLargeScale=true;return}if(Math.abs(A.z-v.z)>w*Math.abs(A.x+A.y+x)){this.isLargeScale=true;return}var u=0.00009;if(x<u*Math.abs(A.y+A.z)){this.isLargeScale=true;return}if(x<u*Math.abs(A.x+A.z)){this.isLargeScale=true;return}if(x<u*Math.abs(A.x+A.y)){this.isLargeScale=true;return}},_getMMMatrix:function(){if(this._ratioData&&this._ratioData.ratio>0&&this.matrixWorld){var y=this._ratioData.vptData();if(y){var u=new s.Vector3();u.getPositionFromMatrix(this.matrixWorld);var z=1/this.matrixWorld.getMaxScaleOnAxis();var x=y[this._ratioData.cameraName?this._ratioData.cameraName:"camera"];if(x.fullWidth){z*=x.height/x.fullHeight}var A=z*x.getWorldSizeFromPixelSize(1,u,y.viewer.div.clientHeight);var w=new s.Matrix4();if(this._ratioData.center){var B=new s.Vector3().copy(this._ratioData.center);B.multiplyScalar(A);var v=new s.Vector3().copy(B);v.applyMatrix4(this.matrixWorld);A=this._ratioData.ratio*z*x.getWorldSizeFromPixelSize(1,v,y.viewer.div.clientHeight);w.makeScale(A,A,A);w.setPosition(B)}else{A*=this._ratioData.ratio;w.makeScale(A,A,A)}var C=new s.Matrix4();C.multiplyMatrices(this.matrixWorld,w);return C}}return this.matrixWorld},_updateWorldCenterAndRadius:function(){var w=this.matrixWorld;var v=this.geometry&&this.geometry.boundingSphere;if(v){this.worldCenter.copy(v.center);this.worldRadius=v.radius;if(this._ratioData&&this._ratioData.ratio>0){if(this._ratioData.center){this.worldRadius+=this._ratioData.center.length()/this._ratioData.ratio}this.worldRadius+=this.worldCenter.length();this.worldRadius*=this._ratioData.ratio;this.worldCenter.set(0,0,0)}else{this.worldRadius*=w.getMaxScaleOnAxis()}}else{this.worldCenter.set(0,0,0);this.worldRadius=0}this.worldCenter.applyMatrix4(w);this.isLargeScale=true;if(this.isLargeScale){this._programID=this._programID|s.ProgramIDs.LARGE_SCALE}else{this._programID=this._programID&~s.ProgramIDs.LARGE_SCALE}if(this._ratioData&&this._ratioData.ratio>0){this._programID=this._programID|s.ProgramIDs.FIXED_SIZE}else{if(this._ratioData){this._programID=this._programID&~s.ProgramIDs.FIXED_SIZE}}if(this._ratioData&&this._ratioData.center){this._programID=this._programID|s.ProgramIDs.FIXED_SIZE_CENTER}else{if(this._ratioData){this._programID=this._programID&~s.ProgramIDs.FIXED_SIZE_CENTER}}if(!this.geometry){return}var y=null;var u=0;if(this.geometry.length>=0){y=this.geometry[0];u=this.geometry.length}else{if(this.geometry._type===2){y=this.geometry;u=1}}for(var x=0;x<u;x++){var z=this.geomWorldBE[x];if(y.boundingSphere){if(!z){this.geomWorldBE[x]={radius:0,center:new s.Vector3()};z=this.geomWorldBE[x]}if(y.boundingSphere){z.center.copy(y.boundingSphere.center);z.radius=y.boundingSphere.radius;if(this._ratioData&&this._ratioData.ratio>0){if(this._ratioData.center){z.radius+=this._ratioData.center.length()/this._ratioData.ratio}z.radius+=z.center.length();z.radius*=this._ratioData.ratio;z.center.set(0,0,0)}else{z.radius*=w.getMaxScaleOnAxis()}}else{z.radius=0;z.center.set(0,0,0)}z.center.applyMatrix4(w)}y=this.geometry[x+1]}},translate:function(){var u=new s.Vector3();return function(w,v){u.copy(v);if(this.useQuaternion===true){u.applyQuaternion(this.quaternion)}else{u.applyEuler(this.rotation,this.eulerOrder)}u.multiplyScalar(w);this.position.add(u);return this}}(),translateX:function(){var u=new s.Vector3(1,0,0);return function(v){return this.translate(v,u)}}(),translateY:function(){var u=new s.Vector3(0,1,0);return function(v){return this.translate(v,u)}}(),translateZ:function(){var u=new s.Vector3(0,0,1);return function(v){return this.translate(v,u)}}(),localToWorld:function(u){return u.applyMatrix4(this._getMMMatrix())},worldToLocal:function(){var u=new s.Matrix4();return function(v){return v.applyMatrix4(u.getInverse(this._getMMMatrix()))}}(),lookAt:function(){var u=new s.Matrix4();return function(v){u.lookAt(v,this.position,this.up);if(this.useQuaternion===true){this.quaternion.setFromRotationMatrix(u)}else{this.rotation.setEulerFromRotationMatrix(u,this.eulerOrder)}}}(),add:function(u,v){if(u===this){console.warn("THREE.Object3D.add: An object can't be added as a child of itself.");return}if(u instanceof s.Object3D){if(u.parent!==undefined){u.parent.remove(u)}u.parent=this;this.children.push(u);var w=this;while(w.parent!==undefined){w=w.parent}if(w!==undefined&&w instanceof s.Scene){w.__addObject(u,v)}}},remove:function(v){var u=this.children.indexOf(v);if(u!==-1){v.parent=undefined;this.children.splice(u,1);var w=this;while(w.parent!==undefined){w=w.parent}if(w!==undefined&&w instanceof s.Scene){w.__removeObject(v)}}},traverse:function(w){w(this);for(var v=0,u=this.children.length;v<u;v++){this.children[v].traverse(w)}},traverseObject3DWithCondition:function(w){if(w(this)){for(var v=0,u=this.children.length;v<u;v++){this.children[v].traverseObject3DWithCondition(w)}}},getChildByName:function(w,v){for(var x=0,u=this.children.length;x<u;x++){var y=this.children[x];if(y.name===w){return y}if(v===true){y=y.getChildByName(w,v);if(y!==undefined){return y}}}return undefined},getDescendants:function(w){if(w===undefined){w=[]}Array.prototype.push.apply(w,this.children);for(var v=0,u=this.children.length;v<u;v++){this.children[v].getDescendants(w)}return w},updateMatrix:function(){this.matrix.setPosition(this.position);if(this.useQuaternion===false){this.matrix.setRotationFromEuler(this.rotation,this.eulerOrder)}else{this.matrix.setRotationFromQuaternion(this.quaternion)}if(this.scale.x!==1||this.scale.y!==1||this.scale.z!==1){this.matrix.scale(this.scale)}this.isUniformlyScaled=Math.abs(this.scale.x-this.scale.y)<0.0001&&Math.abs(this.scale.z-this.scale.y)<0.0001?true:false;this._updateWorldCenterAndRadius();if(this.modelInvTranspMatrix!==null){this.modelInvTranspMatrix.getInverse(this.matrixWorld).transpose()}this.matrixWorldNeedsUpdate=true},updateMatrixWorld:function(w){if(!this.isRoot3ds){if(this.matrixAutoUpdate===true){this.updateMatrix()}if(this.matrixWorldNeedsUpdate===true||w===true){if(this.parent===undefined){this.matrixWorld.copy(this.matrix)}else{this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)}this._updateWorldCenterAndRadius();if(this.modelInvTranspMatrix!==null){this.modelInvTranspMatrix.getInverse(this.matrixWorld).transpose()}this.matrixWorldNeedsUpdate=false;w=true}for(var v=0,u=this.children.length;v<u;v++){this.children[v].updateMatrixWorld(w)}}},clone:function(u){if(u===undefined){u=new s.Object3D()}u.name=this.name;u.up.copy(this.up);u.position.copy(this.position);if(u.rotation instanceof s.Vector3){u.rotation.copy(this.rotation)}u.eulerOrder=this.eulerOrder;u.scale.copy(this.scale);u.renderDepth=this.renderDepth;u.rotationAutoUpdate=this.rotationAutoUpdate;u.matrix.copy(this.matrix);u.matrixWorld.copy(this.matrixWorld);u.matrixRotationWorld.copy(this.matrixRotationWorld);u.matrixAutoUpdate=this.matrixAutoUpdate;u.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate;u.quaternion.copy(this.quaternion);u.useQuaternion=this.useQuaternion;u.visible=this.visible;u.visibilityFree=this.visibilityFree;u.castShadow=this.castShadow;u.receiveShadow=this.receiveShadow;u._programID=this._programID;u.frustumCulled=this.frustumCulled;for(var v=0;v<this.children.length;v++){var w=this.children[v];u.add(w.clone())}return u},getWebGLObjects:function(){return null}};s.Object3D.defaultEulerOrder="XYZ",s.Object3DIdCount=0;s.Projector=function(){var ah,S,Y=[],E=0,O,w,y=[],v=0,D,Z,X=[],C=0,H,K=[],P=0,B,ae,ag=[],N=0,ab,G,M=[],W=0,U={objects:[],sprites:[],lights:[],elements:[]},V=new s.Vector3(),T=new s.Vector4(),J=new s.Box3(new s.Vector3(-1,-1,-1),new s.Vector3(1,1,1)),ai=new s.Box3(),ad=new Array(3),ac=new Array(4),u=new s.Matrix4(),z=new s.Matrix4(),Q,R=new s.Matrix4(),I=new s.Matrix3(),F=new s.Matrix3(),x=new s.Vector3(),af=new s.Frustum(),L=new s.Vector4(),A=new s.Vector4();this.projectVector=function(aj,ak){ak.matrixWorldInverse.getInverse(ak.matrixWorld);z.multiplyMatrices(ak.projectionMatrix,ak.matrixWorldInverse);return aj.applyProjection(z)};this.unprojectVector=function(aj,ak){ak.projectionMatrixInverse.getInverse(ak.projectionMatrix);z.multiplyMatrices(ak.matrixWorld,ak.projectionMatrixInverse);return aj.applyProjection(z)};this.pickingRay=function(ak,al){ak.z=-1;var aj=new s.Vector3(ak.x,ak.y,1);this.unprojectVector(ak,al);this.unprojectVector(aj,al);aj.sub(ak).normalize();return new s.Raycaster(ak,aj)}};s.Face3=function(w,v,z,y,x,u){this.a=w;this.b=v;this.c=z;this.normal=y instanceof s.Vector3?y:new s.Vector3();this.vertexNormals=y instanceof Array?y:[];this.color=x instanceof s.Color?x:new s.Color();this.vertexColors=x instanceof Array?x:[];this.vertexTangents=[];this.materialIndex=u!==undefined?u:0;this.centroid=new s.Vector3()};s.Face3.prototype={constructor:s.Face3,clone:function(){var w=new s.Face3(this.a,this.b,this.c);w.normal.copy(this.normal);w.color.copy(this.color);w.centroid.copy(this.centroid);w.materialIndex=this.materialIndex;var v,u;for(v=0,u=this.vertexNormals.length;v<u;v++){w.vertexNormals[v]=this.vertexNormals[v].clone()}for(v=0,u=this.vertexColors.length;v<u;v++){w.vertexColors[v]=this.vertexColors[v].clone()}for(v=0,u=this.vertexTangents.length;v<u;v++){w.vertexTangents[v]=this.vertexTangents[v].clone()}return w}};s.Face4=function(w,v,A,z,y,x,u){this.a=w;this.b=v;this.c=A;this.d=z;this.normal=y instanceof s.Vector3?y:new s.Vector3();this.vertexNormals=y instanceof Array?y:[];this.color=x instanceof s.Color?x:new s.Color();this.vertexColors=x instanceof Array?x:[];this.vertexTangents=[];this.materialIndex=u!==undefined?u:0;this.centroid=new s.Vector3()};s.Face4.prototype={constructor:s.Face4,clone:function(){var w=new s.Face4(this.a,this.b,this.c,this.d);w.normal.copy(this.normal);w.color.copy(this.color);w.centroid.copy(this.centroid);w.materialIndex=this.materialIndex;var v,u;for(v=0,u=this.vertexNormals.length;v<u;v++){w.vertexNormals[v]=this.vertexNormals[v].clone()}for(v=0,u=this.vertexColors.length;v<u;v++){w.vertexColors[v]=this.vertexColors[v].clone()}for(v=0,u=this.vertexTangents.length;v<u;v++){w.vertexTangents[v]=this.vertexTangents[v].clone()}return w}};s.Geometry=function(){s.EventDispatcher.call(this);this.id=s.GeometryIdCount++;this.name="";this._type=0;this.vertices=[];this.colors=[];this.normals=[];this.faces=[];this.faceUvs=[[]];this.faceVertexUvs=[[]];this.morphTargets=[];this.morphColors=[];this.morphNormals=[];this.skinWeights=[];this.skinIndices=[];this.lineDistances=[];this.boundingBox=null;this.boundingSphere=null;this.hasTangents=false;this.dynamic=true;this.verticesNeedUpdate=false;this.elementsNeedUpdate=false;this.uvsNeedUpdate=false;this.normalsNeedUpdate=false;this.tangentsNeedUpdate=false;this.colorsNeedUpdate=false;this.lineDistancesNeedUpdate=false;this.buffersNeedUpdate=false};s.Geometry.prototype={constructor:s.Geometry,applyMatrix:function(v){var B=new s.Matrix3().getInverse(v).transpose();for(var y=0,u=this.vertices.length;y<u;y++){var A=this.vertices[y];A.applyMatrix4(v)}for(var y=0,u=this.faces.length;y<u;y++){var z=this.faces[y];z.normal.applyMatrix3(B).normalize();for(var w=0,x=z.vertexNormals.length;w<x;w++){z.vertexNormals[w].applyMatrix3(B).normalize()}z.centroid.applyMatrix4(v)}},computeCentroids:function(){var w,v,u;for(w=0,v=this.faces.length;w<v;w++){u=this.faces[w];u.centroid.set(0,0,0);if(u instanceof s.Face3){u.centroid.add(this.vertices[u.a]);u.centroid.add(this.vertices[u.b]);u.centroid.add(this.vertices[u.c]);u.centroid.divideScalar(3)}else{if(u instanceof s.Face4){u.centroid.add(this.vertices[u.a]);u.centroid.add(this.vertices[u.b]);u.centroid.add(this.vertices[u.c]);u.centroid.add(this.vertices[u.d]);u.centroid.divideScalar(4)}}}},computeFaceNormals:function(){var u=new s.Vector3(),B=new s.Vector3();for(var A=0,z=this.faces.length;A<z;A++){var y=this.faces[A];var x=this.vertices[y.a];var w=this.vertices[y.b];var v=this.vertices[y.c];u.subVectors(v,w);B.subVectors(x,w);u.cross(B);u.normalize();y.normal.copy(u)}},computeVertexNormals:function(A){var G,y,B,F,E,D;if(this.__tmpVertices===undefined){this.__tmpVertices=new Array(this.vertices.length);D=this.__tmpVertices;for(G=0,y=this.vertices.length;G<y;G++){D[G]=new s.Vector3()}for(B=0,F=this.faces.length;B<F;B++){E=this.faces[B];if(E instanceof s.Face3){E.vertexNormals=[new s.Vector3(),new s.Vector3(),new s.Vector3()]}else{if(E instanceof s.Face4){E.vertexNormals=[new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3()]}}}}else{D=this.__tmpVertices;for(G=0,y=this.vertices.length;G<y;G++){D[G].set(0,0,0)}}if(A){var x,w,u,K;var z=new s.Vector3(),J=new s.Vector3(),I=new s.Vector3(),H=new s.Vector3(),C=new s.Vector3();for(B=0,F=this.faces.length;B<F;B++){E=this.faces[B];if(E instanceof s.Face3){x=this.vertices[E.a];w=this.vertices[E.b];u=this.vertices[E.c];z.subVectors(u,w);J.subVectors(x,w);z.cross(J);D[E.a].add(z);D[E.b].add(z);D[E.c].add(z)}else{if(E instanceof s.Face4){x=this.vertices[E.a];w=this.vertices[E.b];u=this.vertices[E.c];K=this.vertices[E.d];I.subVectors(K,w);J.subVectors(x,w);I.cross(J);D[E.a].add(I);D[E.b].add(I);D[E.d].add(I);H.subVectors(K,u);C.subVectors(w,u);H.cross(C);D[E.b].add(H);D[E.c].add(H);D[E.d].add(H)}}}}else{for(B=0,F=this.faces.length;B<F;B++){E=this.faces[B];if(E instanceof s.Face3){D[E.a].add(E.normal);D[E.b].add(E.normal);D[E.c].add(E.normal)}else{if(E instanceof s.Face4){D[E.a].add(E.normal);D[E.b].add(E.normal);D[E.c].add(E.normal);D[E.d].add(E.normal)}}}}for(G=0,y=this.vertices.length;G<y;G++){D[G].normalize()}for(B=0,F=this.faces.length;B<F;B++){E=this.faces[B];if(E instanceof s.Face3){E.vertexNormals[0].copy(D[E.a]);E.vertexNormals[1].copy(D[E.b]);E.vertexNormals[2].copy(D[E.c])}else{if(E instanceof s.Face4){E.vertexNormals[0].copy(D[E.a]);E.vertexNormals[1].copy(D[E.b]);E.vertexNormals[2].copy(D[E.c]);E.vertexNormals[3].copy(D[E.d])}}}},computeTangents:function(){var ab,G,Q,E,Z,I,O,B,H,W,T,S,A,z,y,D,C,ai,ah,M,L,ae,ad,K,J,U,R,x,ag=[],af=[],u=new s.Vector3(),F=new s.Vector3(),X=new s.Vector3(),ac=new s.Vector3(),Y=new s.Vector3(),P;for(Q=0,E=this.vertices.length;Q<E;Q++){ag[Q]=new s.Vector3();af[Q]=new s.Vector3()}function N(am,w,v,an,al,ak,aj){W=am.vertices[w];T=am.vertices[v];S=am.vertices[an];A=H[al];z=H[ak];y=H[aj];D=T.x-W.x;C=S.x-W.x;ai=T.y-W.y;ah=S.y-W.y;M=T.z-W.z;L=S.z-W.z;ae=z.x-A.x;ad=y.x-A.x;K=z.y-A.y;J=y.y-A.y;U=1/(ae*J-ad*K);u.set((J*D-K*C)*U,(J*ai-K*ah)*U,(J*M-K*L)*U);F.set((ae*C-ad*D)*U,(ae*ah-ad*ai)*U,(ae*L-ad*M)*U);ag[w].add(u);ag[v].add(u);ag[an].add(u);af[w].add(F);af[v].add(F);af[an].add(F)}for(ab=0,G=this.faces.length;ab<G;ab++){B=this.faces[ab];H=this.faceVertexUvs[0][ab];if(B instanceof s.Face3){N(this,B.a,B.b,B.c,0,1,2)}else{if(B instanceof s.Face4){N(this,B.a,B.b,B.d,0,1,3);N(this,B.b,B.c,B.d,1,2,3)}}}var V=["a","b","c","d"];for(ab=0,G=this.faces.length;ab<G;ab++){B=this.faces[ab];for(Z=0;Z<B.vertexNormals.length;Z++){Y.copy(B.vertexNormals[Z]);O=B[V[Z]];R=ag[O];X.copy(R);X.sub(Y.multiplyScalar(Y.dot(R))).normalize();ac.crossVectors(B.vertexNormals[Z],R);x=ac.dot(af[O]);P=(x<0)?-1:1;B.vertexTangents[Z]=new s.Vector4(X.x,X.y,X.z,P)}}this.hasTangents=true},computeBoundingBox:function(){if(this.boundingBox===null){this.boundingBox=new s.Box3()}this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){if(this.boundingSphere===null){this.boundingSphere=new s.Sphere()}this.boundingSphere.setFromCenterAndPoints(this.boundingSphere.center,this.vertices)},mergeVertices:function(){var x={};var w=[],O=[];var B,P;var D=4;var M=Math.pow(10,D);var K,A,z;var y,I,J,L,C;this.__tmpVertices=undefined;for(K=0,A=this.vertices.length;K<A;K++){B=this.vertices[K];P=[Math.round(B.x*M),Math.round(B.y*M),Math.round(B.z*M)].join("_");if(x[P]===undefined){x[P]=K;w.push(this.vertices[K]);O[K]=w.length-1}else{O[K]=O[x[P]]}}var F=[];for(K=0,A=this.faces.length;K<A;K++){z=this.faces[K];if(z instanceof s.Face3){z.a=O[z.a];z.b=O[z.b];z.c=O[z.c];y=[z.a,z.b,z.c];var H=-1;for(var G=0;G<3;G++){if(y[G]==y[(G+1)%3]){H=G;F.push(K);break}}}else{if(z instanceof s.Face4){z.a=O[z.a];z.b=O[z.b];z.c=O[z.c];z.d=O[z.d];y=[z.a,z.b,z.c,z.d];var H=-1;for(var G=0;G<4;G++){if(y[G]==y[(G+1)%4]){if(H>=0){F.push(K)}H=G}}if(H>=0){y.splice(H,1);var N=new s.Face3(y[0],y[1],y[2],z.normal,z.color,z.materialIndex);for(J=0,L=this.faceVertexUvs.length;J<L;J++){C=this.faceVertexUvs[J][K];if(C){C.splice(H,1)}}if(z.vertexNormals&&z.vertexNormals.length>0){N.vertexNormals=z.vertexNormals;N.vertexNormals.splice(H,1)}if(z.vertexColors&&z.vertexColors.length>0){N.vertexColors=z.vertexColors;N.vertexColors.splice(H,1)}this.faces[K]=N}}}}for(K=F.length-1;K>=0;K--){this.faces.splice(K,1);for(J=0,L=this.faceVertexUvs.length;J<L;J++){this.faceVertexUvs[J].splice(K,1)}}var E=this.vertices.length-w.length;this.vertices=w;return E},clone:function(){var C=new s.Geometry();var B=this.vertices;for(var A=0,D=B.length;A<D;A++){C.vertices.push(B[A].clone())}var w=this.faces;for(var A=0,D=w.length;A<D;A++){C.faces.push(w[A].clone())}var y=this.faceVertexUvs[0];for(var A=0,D=y.length;A<D;A++){var v=y[A],u=[];for(var x=0,z=v.length;x<z;x++){u.push(new s.Vector2(v[x].x,v[x].y))}C.faceVertexUvs[0].push(u)}return C},dispose:function(){this.dispatchEvent({type:"dispose"})}};s.GeometryIdCount=0;s.BufferGeometry=function(){s.EventDispatcher.call(this);this.id=s.GeometryIdCount++;this._type=1;this.attributes={};this.dynamic=false;this.offsets=[];this.boundingBox=null;this.boundingSphere=null;this.hasTangents=false;this.morphTargets=[]};s.BufferGeometry.prototype={constructor:s.BufferGeometry,applyMatrix:function(v){var u;var w;if(this.attributes.position){u=this.attributes.position.array}if(this.attributes.normal){w=this.attributes.normal.array}if(u!==undefined){v.multiplyVector3Array(u);this.verticesNeedUpdate=true}if(w!==undefined){var x=new s.Matrix3();x.getInverse(v).transpose();x.multiplyVector3Array(w);this.normalizeNormals();this.normalsNeedUpdate=true}},computeBoundingBox:function(){if(this.boundingBox===null){this.boundingBox=new s.Box3()}var v=this.attributes.position.array;if(v){var C=this.boundingBox;var u,D,B;if(v.length>=3){C.min.x=C.max.x=v[0];C.min.y=C.max.y=v[1];C.min.z=C.max.z=v[2]}for(var A=3,w=v.length;A<w;A+=3){u=v[A];D=v[A+1];B=v[A+2];if(u<C.min.x){C.min.x=u}else{if(u>C.max.x){C.max.x=u}}if(D<C.min.y){C.min.y=D}else{if(D>C.max.y){C.max.y=D}}if(B<C.min.z){C.min.z=B}else{if(B>C.max.z){C.max.z=B}}}}if(v===undefined||v.length===0){this.boundingBox.min.set(0,0,0);this.boundingBox.max.set(0,0,0)}},computeBoundingSphere:function(){if(this.boundingSphere===null){this.boundingSphere=new s.Sphere()}var w=this.attributes.position.array;if(w){var B,v=0;var u,E,D;for(var C=0,A=w.length;C<A;C+=3){u=w[C];E=w[C+1];D=w[C+2];B=u*u+E*E+D*D;if(B>v){v=B}}this.boundingSphere.radius=Math.sqrt(v)}},computeVertexNormals:function(){if(this.attributes.position){var O,F;var L,Q;var S=this.attributes.position.array.length;if(this.attributes.normal===undefined){this.attributes.normal={itemSize:3,array:new Float32Array(S),numItems:S}}else{for(O=0,F=this.attributes.normal.array.length;O<F;O++){this.attributes.normal.array[O]=0}}var C=this.attributes.position.array;var H=this.attributes.normal.array;var R,P,N,G,E,D,M=new s.Vector3(),K=new s.Vector3(),J=new s.Vector3(),I=new s.Vector3(),T=new s.Vector3();if(this.attributes.index){var w=this.attributes.index.array;var v=this.offsets;for(L=0,Q=v.length;L<Q;++L){var u=v[L].start;var B=v[L].count;var A=v[L].index;for(O=u,F=u+B;O<F;O+=3){R=A+w[O];P=A+w[O+1];N=A+w[O+2];G=C[R*3];E=C[R*3+1];D=C[R*3+2];M.set(G,E,D);G=C[P*3];E=C[P*3+1];D=C[P*3+2];K.set(G,E,D);G=C[N*3];E=C[N*3+1];D=C[N*3+2];J.set(G,E,D);I.subVectors(J,K);T.subVectors(M,K);I.cross(T);H[R*3]+=I.x;H[R*3+1]+=I.y;H[R*3+2]+=I.z;H[P*3]+=I.x;H[P*3+1]+=I.y;H[P*3+2]+=I.z;H[N*3]+=I.x;H[N*3+1]+=I.y;H[N*3+2]+=I.z}}}else{for(O=0,F=C.length;O<F;O+=9){G=C[O];E=C[O+1];D=C[O+2];M.set(G,E,D);G=C[O+3];E=C[O+4];D=C[O+5];K.set(G,E,D);G=C[O+6];E=C[O+7];D=C[O+8];J.set(G,E,D);I.subVectors(J,K);T.subVectors(M,K);I.cross(T);H[O]=I.x;H[O+1]=I.y;H[O+2]=I.z;H[O+3]=I.x;H[O+4]=I.y;H[O+5]=I.z;H[O+6]=I.x;H[O+7]=I.y;H[O+8]=I.z}}this.normalizeNormals();this.normalsNeedUpdate=true}},normalizeNormals:function(){var A=this.attributes.normal.array;var u,D,B,C;for(var w=0,v=A.length;w<v;w+=3){u=A[w];D=A[w+1];B=A[w+2];C=1/Math.sqrt(u*u+D*D+B*B);A[w]*=C;A[w+1]*=C;A[w+2]*=C}},computeTangents:function(){if(this.attributes.index===undefined||this.attributes.position===undefined||this.attributes.normal===undefined||this.attributes.uv===undefined){console.warn("Missing required attributes (index, position, normal or uv) in BufferGeometry.computeTangents()");return}var A=this.attributes.index.array;var I=this.attributes.position.array;var M=this.attributes.normal.array;var af=this.attributes.uv.array;var L=I.length/3;if(this.attributes.tangent===undefined){var N=4*L;this.attributes.tangent={itemSize:4,array:new Float32Array(N),numItems:N}}var U=this.attributes.tangent.array;var aA=[],az=[];for(var at=0;at<L;at++){aA[at]=new s.Vector3();az[at]=new s.Vector3()}var E,aq,T,D,ap,S,C,an,Q,B,am,z,ak,y,ai,K,J,aC,aB,ad,ac,ay,ax,ab,Z,aj;var F=new s.Vector3(),W=new s.Vector3();function ae(aD,w,aE){E=I[aD*3];aq=I[aD*3+1];T=I[aD*3+2];D=I[w*3];ap=I[w*3+1];S=I[w*3+2];C=I[aE*3];an=I[aE*3+1];Q=I[aE*3+2];B=af[aD*2];am=af[aD*2+1];z=af[w*2];ak=af[w*2+1];y=af[aE*2];ai=af[aE*2+1];K=D-E;J=C-E;aC=ap-aq;aB=an-aq;ad=S-T;ac=Q-T;ay=z-B;ax=y-B;ab=ak-am;Z=ai-am;aj=1/(ay*Z-ax*ab);F.set((Z*K-ab*J)*aj,(Z*aC-ab*aB)*aj,(Z*ad-ab*ac)*aj);W.set((ay*J-ax*K)*aj,(ay*aB-ax*aC)*aj,(ay*ac-ax*ad)*aj);aA[aD].add(F);aA[w].add(F);aA[aE].add(F);az[aD].add(W);az[w].add(W);az[aE].add(W)}var av,X;var au,H;var x,v,u;var P=this.offsets;for(au=0,H=P.length;au<H;++au){var R=P[au].start;var al=P[au].count;var Y=P[au].index;for(av=R,X=R+al;av<X;av+=3){x=Y+A[av];v=Y+A[av+1];u=Y+A[av+2];ae(x,v,u)}}var ao=new s.Vector3(),aw=new s.Vector3();var ar=new s.Vector3(),V=new s.Vector3();var ag,ah,G;function O(w){ar.x=M[w*3];ar.y=M[w*3+1];ar.z=M[w*3+2];V.copy(ar);ah=aA[w];ao.copy(ah);ao.sub(ar.multiplyScalar(ar.dot(ah))).normalize();aw.crossVectors(V,ah);G=aw.dot(az[w]);ag=(G<0)?-1:1;U[w*4]=ao.x;U[w*4+1]=ao.y;U[w*4+2]=ao.z;U[w*4+3]=ag}for(au=0,H=P.length;au<H;++au){var R=P[au].start;var al=P[au].count;var Y=P[au].index;for(av=R,X=R+al;av<X;av+=3){x=Y+A[av];v=Y+A[av+1];u=Y+A[av+2];O(x);O(v);O(u)}}this.hasTangents=true;this.tangentsNeedUpdate=true},dispose:function(){this.dispatchEvent({type:"dispose"})}};s.ImmediateRenderObject=function(){s.Object3D.call(this);this.render=function(u){}};s.ImmediateRenderObject.prototype=Object.create(s.Object3D.prototype);s.Camera=function(){s.Object3D.call(this);this.matrixWorldInverse=new s.Matrix4();this.projectionMatrix=new s.Matrix4();this.projectionMatrixInverse=new s.Matrix4();this.realProjectionMatrixInverse=new s.Matrix4();this.pixelCulling=4.5;this.isOrtho=false;this._hasChanged=true;this.externalProjectionMatrix=false;this.fixedSizeCameraConstant=1;this.pixelCullingCst=0;this._viewpoint=null;this.aspect=1};s.Camera.prototype=Object.create(s.Object3D.prototype);s.Camera.prototype.lookAt=function(){var u=new s.Matrix4();return function(v){u.lookAt(this.position,v,this.up);if(this.useQuaternion===true){this.quaternion.setFromRotationMatrix(u)}else{this.rotation.setEulerFromRotationMatrix(u,this.eulerOrder)}}}();s.Camera.prototype.setViewOffsetInternal=function(B,w,v,C,z,u,A){this.fullWidth=B;this.fullHeight=w;this.x=v;this.y=C;this.width=z;if(A&&this.height){this.visualizedHeight=this.height}else{this.visualizedHeight=0}if(A){this.pickingRatioW=A.ratioW;this.pickingRatioH=A.ratioH}else{this.pickingRatioW=null;this.pickingRatioH=null}this.height=u;this._hasChanged=true;this.realProjectionMatrixInverse=this.projectionMatrixInverse.clone();this.updateProjectionMatrix()};s.Camera.prototype.setViewOffset=function(A,w,v,B,z,u){console.warn("deprecated ! use viewpoint.setViewOffset instead");this.setViewOffsetInternal(A,w,v,B,z,u)};s.OrthographicCamera=function(z,w,y,v,x,u){s.Camera.call(this);this.left=z;this.right=w;this.top=y;this.bottom=v;this.near=(x!==undefined)?x:0.1;this.far=(u!==undefined)?u:2000;this.fov=45;this.isOrtho=true;this.updateProjectionMatrix();this.visualizedHeight=400};s.OrthographicCamera.prototype=Object.create(s.Camera.prototype);s.OrthographicCamera.prototype.getCameraConstant=function(u,v){return u*(this.top-this.bottom)/(v||1)};s.OrthographicCamera.prototype.getWorldSizeFromPixelSize=function(v,u,w){return v*(this.top-this.bottom)/(w||1)};s.OrthographicCamera.prototype.performPixelAndFrustumCulling=function(B,y,x){var v=x.worldCenter;var u=x.worldRadius;x.renderPointsOnly=false;var w=this.pixelCulling;if(w>0){var A=w;if(!x._ratioData||x._ratioData.ratio===0){A=this.pixelCullingCst}if(u<A){if(x.hasPoint===false){return false}else{x.renderPointsOnly=true}}}var z=u;if(x._ratioData&&x._ratioData.ratio>0){z*=this.fixedSizeCameraConstant}return B.performFrustumCulling(z,v)};s.OrthographicCamera.prototype.updateProjectionMatrix=function(y,w){var x=Math.abs(this.right-this.left);var v=Math.abs(this.top-this.bottom);var u=y?y:0;var z=w?w:0;if(this.fullWidth){this.aspect=this.fullWidth/this.fullHeight;this.projectionMatrix.makeOrthographic(this.left+((this.x+u*this.width)/this.fullWidth)*x,this.left+((this.x+(1+u)*this.width)/this.fullWidth)*x,this.top-((this.y+z*this.height)/this.fullHeight)*v,this.top-((this.y+(1+z)*this.height)/this.fullHeight)*v,this.near,this.far)}else{this.projectionMatrix.makeOrthographic(this.left+u*x,this.right+u*x,this.top+z*v,this.bottom+z*v,this.near,this.far)}this.projectionMatrixInverse.getInverse(this.projectionMatrix)};s.PerspectiveCamera=function(w,v,x,u){s.Camera.call(this);this.fov=w!==undefined?w:50;this.aspect=v!==undefined?v:1;this.near=x!==undefined?x:0.1;this.far=u!==undefined?u:2000;this.updateProjectionMatrix()};s.PerspectiveCamera.prototype=Object.create(s.Camera.prototype);s.PerspectiveCamera.prototype.setLens=function(v,u){if(u===undefined){u=24}this.fov=2*s.Math.radToDeg(Math.atan(u/(v*2)));this.updateProjectionMatrix()};s.PerspectiveCamera.prototype.getCameraConstant=function(v,w){var u=2*Math.tan(0.5*this.fov*Math.PI/180)*v/(w||1);return u};s.PerspectiveCamera.prototype.getWorldSizeFromPixelSize=function(w,v,x){var y=this.matrixWorldInverse.elements;var z=Math.abs(y[2]*v.x+y[6]*v.y+y[10]*v.z+y[14]);var u=2*z*Math.tan(0.5*this.fov*Math.PI/180)*w/(x||1);return u};s.PerspectiveCamera.prototype.performPixelAndFrustumCulling=function(B,w,v){var u=v.worldCenter;var x=v.worldRadius;v.renderPointsOnly=false;var D=this.pixelCulling;var y=this.matrixWorldInverse.elements;if(D>0){var z=D;if(!v._ratioData||v._ratioData.ratio===0){var A=Math.abs(y[2]*u.x+y[6]*u.y+y[10]*u.z+y[14]);z=this.pixelCullingCst*A}if(x<z){if(v.hasPoint===false){return false}else{v.renderPointsOnly=true}}}var C=x;if(v._ratioData&&v._ratioData.ratio>0){var A=Math.abs(y[2]*u.x+y[6]*u.y+y[10]*u.z+y[14]);var w=this.fixedSizeCameraConstant*A;C*=w}return B.performFrustumCulling(C,u)};s.PerspectiveCamera.prototype.performPixelAndFrustumCullingOnGeometry=function(E,y,w,D){if((D._type!==2)||!w.frustumCulled){return true}var x=(D===w.geometry)?D:w.geometry.indexOf(D);var u=w.geomWorldBE[x];if(!u){return true}var v=u.center;var z=u.radius;var G=this.pixelCulling;var A=this.matrixWorldInverse.elements;if(G>0){var B=G;if(!w._ratioData||w._ratioData.ratio===0){var C=Math.abs(A[2]*v.x+A[6]*v.y+A[10]*v.z+A[14]);B=this.pixelCullingCst*C}if(z<B){return false}}var F=z;if(w._ratioData&&w._ratioData.ratio>0){var C=Math.abs(A[2]*v.x+A[6]*v.y+A[10]*v.z+A[14]);var y=this.fixedSizeCameraConstant*C;F*=y}return E.performFrustumCulling(F,v)};s.PerspectiveCamera.prototype.performPixelCullingOnDG=function(C,N,I,L,z,B){var A=N.geometry.indexOf(I);var w=N.geomWorldBE[A];if(!w){return B}var x=w.center;var E=this.pixelCulling;if(E>0){var F=0;var J=L.cullingData.length-1;var M=this.matrixWorldInverse.elements;while(J-F>1){var K=Math.floor(0.5*(F+J));var u=L.cullingData[K];var H=u.start;if(u.start<z){F=K}if(u.start>z+B){return B}var y=u.radius;var D=E;if(!N._ratioData||N._ratioData.ratio===0){var G=Math.abs(M[2]*x.x+M[6]*x.y+M[10]*x.z+M[14])-y;D=this.pixelCullingCst*G}else{y*=N._ratioData.ratio/N.matrixWorld.getMaxScaleOnAxis()}if(y<D){J=K}else{F=K}}var v=J;if(F!==J){var u=L.cullingData[F];var y=u.radius;var D=E;if(!N._ratioData||N._ratioData.ratio===0){var G=Math.abs(M[2]*x.x+M[6]*x.y+M[10]*x.z+M[14])-y;D=this.pixelCullingCst*G}else{y*=N._ratioData.ratio/N.matrixWorld.getMaxScaleOnAxis()}if(y<D){v=F}}if(v<L.cullingData.length-1){var u=L.cullingData[v];return u.start-z}}return B};s.PerspectiveCamera.prototype.updateProjectionMatrix=function(E,B){if(this.externalProjectionMatrix){return}if(this.fullWidth){var u=this.fullWidth/this.fullHeight;var A=Math.tan(s.Math.degToRad(this.fov*0.5))*this.near;var v=-A;var x=u*v;var C=u*A;var w=Math.abs(C-x);var D=Math.abs(A-v);var z=E?E:0;var y=B?B:0;this.projectionMatrix.makeFrustum(x+((this.x+z*this.width)/this.fullWidth)*w,x+((this.x+(1+z)*this.width)/this.fullWidth)*w,A-((this.y+(1+y)*this.height)/this.fullHeight)*D,A-((this.y+y*this.height)/this.fullHeight)*D,this.near,this.far)}else{this.projectionMatrix.makePerspective(this.fov,this.aspect,this.near,this.far,E,B)}this.projectionMatrixInverse.getInverse(this.projectionMatrix)};s.Light=function(u){s.Object3D.call(this);this.onlyShadow=false;u=u instanceof s.Color?u:new s.Color(u);this.color=u;this._vptPosition=null};s.Light.prototype=Object.create(s.Object3D.prototype);s.Light.prototype.clone=function(u){if(u===undefined){u=new s.Light()}s.Object3D.prototype.clone.call(this,u);u.color.copy(this.color);u._vptPosition=this._vptPosition;return u};s.Light.prototype.allocateShadows=function(v,u){return 0};s.Light.prototype.setup=function(x,u,v,w){};s.Light.prototype.allocate=function(u){};s.AmbientLight=function(u){s.Light.call(this,u)};s.AmbientLight.prototype=Object.create(s.Light.prototype);s.AmbientLight.prototype.clone=function(u){if(u===undefined){u=new s.AmbientLight()}s.Light.prototype.clone.call(this,u);return u};s.AmbientLight.prototype.setup=function(y,v,w,x){if(!this.visible){return}var u=this.color;if(x.gammaInput){y.ambient.r+=u.r*u.r;y.ambient.g+=u.g*u.g;y.ambient.b+=u.b*u.b}else{y.ambient.r+=u.r;y.ambient.g+=u.g;y.ambient.b+=u.b}};s.SphereLight=function(w,v,u){s.Light.call(this,w);this.intensity=(v!==undefined)?v:1;this.radius=(u!==undefined)?u:1};s.SphereLight.prototype=Object.create(s.Light.prototype);s.SphereLight.prototype.clone=function(u){if(u===undefined){u=new s.SphereLight()}s.Light.prototype.clone.call(this,u);u.intensity=this.intensity;u.radius=this.radius;return u};s.SphereLight.prototype.setup=function(z,w,x,y){z.sphere.sphereCount+=1;if(!this.visible){return}var v=z.sphere.sphereLength*3;if(y.gammaInput){w(z.sphere.sphereColors,v,this.color,this.intensity*this.intensity)}else{x(z.sphere.sphereColors,v,this.color,this.intensity)}var u=new s.Vector3();u.getPositionFromMatrix(this.matrixWorld);z.sphere.spherePositions[v]=u.x;z.sphere.spherePositions[v+1]=u.y;z.sphere.spherePositions[v+2]=u.z;z.sphere.sphereData[v]=this.radius;z.sphere.sphereData[v+1]=0;z.sphere.sphereData[v+2]=0;z.sphere.sphereLength+=1};s.SphereLight.prototype.allocate=function(u){u.sphereLights++};s.DiskLight=function(w,v,u){s.Light.call(this,w);this.intensity=(v!==undefined)?v:1;this.radius=(u!==undefined)?u:1};s.DiskLight.prototype=Object.create(s.Light.prototype);s.DiskLight.prototype.clone=function(u){if(u===undefined){u=new s.DiskLight()}s.Light.prototype.clone.call(this,u);u.intensity=this.intensity;u.radius=this.radius;return u};s.DiskLight.prototype.setup=function(A,x,y,z){A.disk.diskCount+=1;if(!this.visible){return}var w=A.disk.diskLength*3;if(z.gammaInput){x(A.disk.diskColors,w,this.color,this.intensity*this.intensity)}else{y(A.disk.diskColors,w,this.color,this.intensity)}var v=new s.Vector3();v.getPositionFromMatrix(this.matrixWorld);A.disk.diskPositions[w]=v.x;A.disk.diskPositions[w+1]=v.y;A.disk.diskPositions[w+2]=v.z;var u=new s.Vector4();u.getColumnFromMatrix(2,this.matrixWorld);u.w=0;A.disk.diskNormals[w]=u.x;A.disk.diskNormals[w+1]=u.y;A.disk.diskNormals[w+2]=u.z;A.disk.diskData[w]=this.radius;A.disk.diskData[w+1]=0;A.disk.diskData[w+2]=0;A.disk.diskLength+=1};s.DiskLight.prototype.allocate=function(u){u.diskLights++};s.TubeLight=function(w,v,u,x){s.Light.call(this,w);this.intensity=(v!==undefined)?v:1;this.radius=(u!==undefined)?u:1;this.width=(x!==undefined)?x:1};s.TubeLight.prototype=Object.create(s.Light.prototype);s.TubeLight.prototype.clone=function(u){if(u===undefined){u=new s.TubeLight()}s.Light.prototype.clone.call(this,u);u.intensity=this.intensity;u.radius=this.radius;u.width=this.width;return u};s.TubeLight.prototype.setup=function(A,w,x,z){A.tube.tubeCount+=1;if(!this.visible){return}var y=A.tube.tubeLength*3;if(z.gammaInput){w(A.tube.tubeColors,y,this.color,this.intensity*this.intensity)}else{x(A.tube.tubeColors,y,this.color,this.intensity)}var v=new s.Vector3();v.getPositionFromMatrix(this.matrixWorld);A.tube.tubePositions[y]=v.x;A.tube.tubePositions[y+1]=v.y;A.tube.tubePositions[y+2]=v.z;var u=new s.Vector4();u.getColumnFromMatrix(0,this.matrixWorld);u.w=0;A.tube.tubeRights[y]=u.x;A.tube.tubeRights[y+1]=u.y;A.tube.tubeRights[y+2]=u.z;A.tube.tubeData[y]=this.radius;A.tube.tubeData[y+1]=this.width;A.tube.tubeData[y+2]=0;A.tube.tubeLength+=1};s.TubeLight.prototype.allocate=function(u){u.tubeLights++};s.AreaLight=function(w,v,x,u){s.Light.call(this,w);this.intensity=(v!==undefined)?v:1;this.height=(u!==undefined)?u:1;this.width=(x!==undefined)?x:1};s.AreaLight.prototype=Object.create(s.Light.prototype);s.AreaLight.prototype.clone=function(u){if(u===undefined){u=new s.AreaLight()}s.Light.prototype.clone.call(this,u);u.intensity=this.intensity;u.width=this.width;u.height=this.height;return u};s.AreaLight.prototype.setup=function(B,y,z,A){B.area.areaCount+=1;if(!this.visible){return}var w=B.area.areaLength*3;if(A.gammaInput){y(B.area.areaColors,w,this.color,this.intensity)}else{z(B.area.areaColors,w,this.color,this.intensity)}var x=B.camera.matrixWorldInverse;var v=new s.Vector3();v.getPositionFromMatrix(this.matrixWorld);B.area.areaPositions[w]=v.x;B.area.areaPositions[w+1]=v.y;B.area.areaPositions[w+2]=v.z;var u=new s.Vector4();u.getColumnFromMatrix(2,this.matrixWorld);u.w=0;B.area.areaNormals[w]=u.x;B.area.areaNormals[w+1]=u.y;B.area.areaNormals[w+2]=u.z;u.getColumnFromMatrix(0,this.matrixWorld);u.w=0;B.area.areaRights[w]=u.x;B.area.areaRights[w+1]=u.y;B.area.areaRights[w+2]=u.z;u.getColumnFromMatrix(1,this.matrixWorld);u.w=0;B.area.areaUps[w]=u.x;B.area.areaUps[w+1]=u.y;B.area.areaUps[w+2]=u.z;B.area.areaData[w]=this.width;B.area.areaData[w+1]=this.height;B.area.areaData[w+2]=0;B.area.areaLength+=1};s.AreaLight.prototype.allocate=function(u){u.areaLights++};s.DirectionalLight=function(v,u){s.Light.call(this,v);this.position.set(0,1,0);this.target=new s.Object3D();this.intensity=(u!==undefined)?u:1;this.castShadow=false;this.onlyShadow=false;this.castGroundShadow=false;this.shadowCameraNear=50;this.shadowCameraFar=5000;this.shadowCameraLeft=-500;this.shadowCameraRight=500;this.shadowCameraTop=500;this.shadowCameraBottom=-500;this.shadowCameraVisible=false;this.shadowCameraHelperToUpdate=true;this.shadowBias=0;this.shadowDarkness=0.5;this.shadowMapWidth=512;this.shadowMapHeight=512;this.shadowCascade=false;this.shadowCascadeOffset=new s.Vector3(0,0,-1000);this.shadowCascadeCount=2;this.shadowCascadeBias=[0,0,0];this.shadowCascadeWidth=[512,512,512];this.shadowCascadeHeight=[512,512,512];this.shadowCascadeNearZ=[-1,0.99,0.998];this.shadowCascadeFarZ=[0.99,0.998,1];this.shadowCascadeArray=[];this.updateShadowMap=true;this.blockUpdate=false;this.shadowMap=null;this.shadowMapSize=null;this.shadowCamera=null;this.shadowMatrix=null;this.LiSPSM=false};s.DirectionalLight.prototype=Object.create(s.Light.prototype);s.DirectionalLight.prototype.clone=function(u){if(u===undefined){u=new s.DirectionalLight()}s.Light.prototype.clone.call(this,u);if(this.target!==null){this.target.clone(u.target)}else{u.target=null}u.intensity=this.intensity;u.castShadow=this.castShadow;u.onlyShadow=this.onlyShadow;return u};s.DirectionalLight.prototype.allocateShadows=function(v,u){if(!this.shadowCascade&&(!this.isVirtual||v.shadowMapCascade)){u.tex2d++;u.dirLight++}return 0};s.DirectionalLight.prototype.setup=function(A,w,x,y){A.directional.dirCount+=1;if(!this.visible){return}var z=new s.Vector3(),v=new s.Vector3();if(!this.target){z.set(0,0,1);z.applyMatrix4(new s.Matrix4().extractRotation(this.matrixWorld))}else{if(this._occurrence&&this._occurrence.node._attachedToVpt){z.copy(this._vptPosition)}else{z.getPositionFromMatrix(this.matrixWorld)}z.sub(this.target.position);if(z.x===0&&z.y===0&&z.z===0){z.set(0,0,1);z.applyMatrix4(new s.Matrix4().extractRotation(this.matrixWorld))}}z.normalize();if(z.x===0&&z.y===0&&z.z===0){return}var u=A.directional.dirLength*3;A.directional.dirPositions[u]=z.x;A.directional.dirPositions[u+1]=z.y;A.directional.dirPositions[u+2]=z.z;A.directional.dirFars[A.directional.dirLength]=this.shadowCamera?this.shadowCamera.far:0;A.directional.dirNears[A.directional.dirLength]=this.shadowCamera?this.shadowCamera.near:0;if(y.gammaInput){if(s.intensityCorrection){w(A.directional.dirColors,u,this.color,this.intensity)}else{w(A.directional.dirColors,u,this.color,this.intensity*this.intensity)}}else{x(A.directional.dirColors,u,this.color,this.intensity)}A.directional.dirLength+=1};s.DirectionalLight.prototype.allocate=function(u){u.dirLights++};s.HemisphereLight=function(v,w,u){s.Light.call(this,v);this.position.set(0,100,0);w=w instanceof s.Color?w:new s.Color("rgb(0,0,0)");this.groundColor=w;this.intensity=(u!==undefined)?u:1};s.HemisphereLight.prototype=Object.create(s.Light.prototype);s.HemisphereLight.prototype.clone=function(){var u=new s.HemisphereLight();s.Light.prototype.clone.call(this,u);u.groundColor.copy(this.groundColor);u.intensity=this.intensity;return u};s.HemisphereLight.prototype.setup=function(B,v,x,y){B.hemi.hemiCount+=1;if(!this.visible){return}var A=new s.Vector3();A.set(0,0,1);A.applyMatrix4(new s.Matrix4().extractRotation(this.matrixWorld));A.normalize();if(A.x===0&&A.y===0&&A.z===0){return}var u=B.hemi.hemiLength*3;B.hemi.hemiPositions[u]=A.x;B.hemi.hemiPositions[u+1]=A.y;B.hemi.hemiPositions[u+2]=A.z;var w=this.color;var z=this.groundColor;if(y.gammaInput){v(B.hemi.hemiSkyColors,u,w,this.intensity);v(B.hemi.hemiGroundColors,u,z,this.intensity)}else{x(B.hemi.hemiSkyColors,u,w,this.intensity);x(B.hemi.hemiGroundColors,u,z,this.intensity)}B.hemi.hemiLength+=1};s.HemisphereLight.prototype.allocate=function(u){u.hemiLights++};s.PointLight=function(v,u,w){s.Light.call(this,v);this.intensity=(u!==undefined)?u:1;this.distance=(w!==undefined)?w:0;this.isPhysicallyAttenuated=false;this.attenuationScale=1;this.shadowCameraNear=50;this.shadowCameraFar=5000;this.shadowCameraFov=90;this.shadowCameraVisible=false;this.shadowCameraHelperToUpdate=true;this.shadowBias=0;this.shadowDarkness=0.5;this.shadowMapWidth=512;this.shadowMapHeight=512;this.updateShadowMap=true;this.shadowMap=null;this.shadowMapSize=null;this.shadowCameras=null;this.shadowMatrix=null};s.PointLight.prototype=Object.create(s.Light.prototype);s.PointLight.prototype.clone=function(u){if(u===undefined){u=new s.PointLight()}s.Light.prototype.clone.call(this,u);u.intensity=this.intensity;u.distance=this.distance;u.isPhysicallyAttenuated=this.isPhysicallyAttenuated;u.attenuationScale=this.attenuationScale;u.castShadow=this.castShadow;u.onlyShadow=this.onlyShadow;return u};s.PointLight.prototype.allocateShadows=function(v,u){u.texCube++};s.PointLight.prototype.setup=function(z,w,x,y){z.point.pointCount+=1;if(!this.visible){return}var v=z.point.pointLength*3;if(y.gammaInput){if(s.intensityCorrection){w(z.point.pointColors,v,this.color,this.intensity)}else{w(z.point.pointColors,v,this.color,this.intensity*this.intensity)}}else{x(z.point.pointColors,v,this.color,this.intensity)}var u=new s.Vector3();if(this._occurrence&&this._occurrence.node._attachedToVpt){u.copy(this._vptPosition)}else{u.getPositionFromMatrix(this.matrixWorld)}z.point.pointPositions[v]=u.x;z.point.pointPositions[v+1]=u.y;z.point.pointPositions[v+2]=u.z;z.point.pointPhysicalAttenuations[z.point.pointLength]=this.isPhysicallyAttenuated;z.point.pointDistances[z.point.pointLength]=this.isPhysicallyAttenuated?this.attenuationScale:this.distance;z.point.pointLength+=1};s.PointLight.prototype.setupShadowPositions=function(v){if(!this.visible){return}var u=new s.Vector3();if(this._occurrence&&this._occurrence.node._attachedToVpt){u.copy(this._vptPosition)}else{u.getPositionFromMatrix(this.matrixWorld)}v.push(u.x);v.push(u.y);v.push(u.z)};s.PointLight.prototype.allocate=function(u){u.pointLights++};s.SpotLight=function(w,u,y,v,x){s.Light.call(this,w);this.position.set(0,1,0);this.target=new s.Object3D();this.intensity=(u!==undefined)?u:1;this.distance=(y!==undefined)?y:0;this.angle=(v!==undefined)?v:Math.PI/2;this.innerAngle=(x!==undefined)?x:this.angle-0.001;this.exponent=1;this.isPhysicallyAttenuated=false;this.attenuationScale=1;this.castShadow=false;this.onlyShadow=false;this.shadowCameraNear=50;this.shadowCameraFar=5000;this.shadowCameraFov=50;this.shadowCameraVisible=false;this.shadowCameraHelperToUpdate=true;this.shadowBias=0;this.shadowDarkness=0.5;this.shadowMapWidth=512;this.shadowMapHeight=512;this.updateShadowMap=true;this.shadowMap=null;this.shadowMapSize=null;this.shadowCamera=null;this.shadowMatrix=null};s.SpotLight.prototype=Object.create(s.Light.prototype);s.SpotLight.prototype.clone=function(u){if(u===undefined){u=new s.SpotLight()}s.Light.prototype.clone.call(this,u);if(this.target!==null){this.target.clone(u.target)}else{u.target=null}u.intensity=this.intensity;u.localDirection=this.localDirection;u.distance=this.distance;u.angle=this.angle;u.innerAngle=this.innerAngle;u.exponent=this.exponent;u.castShadow=this.castShadow;u.onlyShadow=this.onlyShadow;u.isPhysicallyAttenuated=this.isPhysicallyAttenuated;u.attenuationScale=this.attenuationScale;return u};s.SpotLight.prototype.allocateShadows=function(v,u){u.tex2d++;u.spotLight++};s.SpotLight.prototype.setup=function(B,x,y,z){B.spot.spotCount+=1;if(!this.visible){return}var w=B.spot.spotLength*3;if(z.gammaInput){if(s.intensityCorrection){x(B.spot.spotColors,w,this.color,this.intensity)}else{x(B.spot.spotColors,w,this.color,this.intensity*this.intensity)}}else{y(B.spot.spotColors,w,this.color,this.intensity)}var v=new s.Vector3();if(this._occurrence&&this._occurrence.node._attachedToVpt){v.copy(this._vptPosition)}else{v.getPositionFromMatrix(this.matrixWorld)}var A=new s.Vector3();B.spot.spotPositions[w]=v.x;B.spot.spotPositions[w+1]=v.y;B.spot.spotPositions[w+2]=v.z;var u=B.spot.spotLength;B.spot.spotPhysicalAttenuations[u]=this.isPhysicallyAttenuated;B.spot.spotDistances[u]=this.isPhysicallyAttenuated?this.attenuationScale:this.distance;if(!this.target){A.set(0,0,1);A.applyMatrix4(new s.Matrix4().extractRotation(this.matrixWorld))}else{A.copy(v);A.sub(this.target.position);if(A.x===0&&A.y===0&&A.z===0){A.set(0,0,1);A.applyMatrix4(new s.Matrix4().extractRotation(this.matrixWorld))}}A.normalize();B.spot.spotDirections[w]=A.x;B.spot.spotDirections[w+1]=A.y;B.spot.spotDirections[w+2]=A.z;B.spot.spotAnglesCos[u]=Math.cos(this.angle);B.spot.spotInnerAnglesCos[u]=Math.cos(this.innerAngle);B.spot.spotLength+=1};s.SpotLight.prototype.allocate=function(u){u.spotLights++};s.IESLight=function(v,u,x,w){s.Light.call(this,v);this.intensity=(u!==undefined)?u:1;this.distance=(x!==undefined)?x:0;this.iesTexture=w};s.IESLight.prototype=Object.create(s.Light.prototype);s.IESLight.prototype.clone=function(u){if(u===undefined){u=new s.IESLight()}s.Light.prototype.clone.call(this,u);u.intensity=this.intensity;u.distance=this.distance;u.iesTexture=this.iesTexture;return u};s.IESLight.prototype.setup=function(A,w,x,y){A.ies.iesCount+=1;if(!this.visible){return}var v=A.ies.iesLength*3;if(y.gammaInput){w(A.ies.iesColors,v,this.color,this.intensity)}else{x(A.ies.iesColors,v,this.color,this.intensity)}var u=new s.Vector3();if(this._occurrence&&this._occurrence.node._attachedToVpt){u.copy(this._vptPosition)}else{u.getPositionFromMatrix(this.matrixWorld)}A.ies.iesPositions[v]=u.x;A.ies.iesPositions[v+1]=u.y;A.ies.iesPositions[v+2]=u.z;A.ies.iesDistances[A.ies.iesLength]=this.distance;A.ies.iesLightTexture[A.ies.iesCount-1]=this.iesTexture;var z=new s.Matrix4();A.ies.matrixWorldInv[A.ies.iesCount-1]=z.getInverse(this.matrixWorld);A.ies.iesLength+=1};s.IESLight.prototype.allocate=function(u){u.iesLights++};s.ProbeLight=function(v,u){s.Light.call(this,16777215);this.envMap=(v!==undefined)?v:null;this.intensity=(u!==undefined)?u:1;this.shScale=0.333};s.ProbeLight.prototype=Object.create(s.Light.prototype);s.ProbeLight.prototype.clone=function(u){if(u===undefined){u=new s.ProbeLight()}s.Light.prototype.clone.call(this,u);u.envMap=this.envMap;u.intensity=this.intensity;u.shScale=this.shScale;return u};s.ProbeLight.prototype.setup=function(x,u,v,w){if(!this.visible){return}if(!this.envMap){return}x.probe.shFactorsR=this.envMap.shFactorsR;x.probe.shFactorsG=this.envMap.shFactorsG;x.probe.shFactorsB=this.envMap.shFactorsB;x.probe.shScale=this.shScale};s.ProbeLight.prototype.allocate=function(u){u.probeLight=true};s.ImageLoader=function(){s.EventDispatcher.call(this);this.crossOrigin=null};s.ImageLoader.prototype={constructor:s.ImageLoader,load:function(u,w){var v=this;if(w===undefined){w=new Image()}w.addEventListener("load",function(){v.dispatchEvent({type:"load",content:w})},false);w.addEventListener("error",function(){v.dispatchEvent({type:"error",message:"Couldn't load URL ["+u+"]"})},false);if(v.crossOrigin){w.crossOrigin=v.crossOrigin}w.src=u}};s.SkinningTransformations=function(){this.useEulerAngles=false;this.skinningMap=null;this.skinningMapWidth=0;this.skinningMapWidth=0};s.SkinningTransformations.prototype.setSkinningMatrices=function(x,u){if(!this.skinningMapWidth||!this.skinningMapHeight){var w;if(u>256){w=64}else{if(u>64){w=32}else{if(u>16){w=16}else{w=8}}}this.skinningMapWidth=w;this.skinningMapHeight=w}this.useEulerAngles=false;if(!this.skinningMap){var v=new Float32Array(this.skinningMapWidth*this.skinningMapHeight*3);v.set(x,0);this.skinningMap=new s.DataTexture(v,this.skinningMapWidth,this.skinningMapHeight,s.RGBFormat,s.FloatType);this.skinningMap.minFilter=s.NearestFilter;this.skinningMap.magFilter=s.NearestFilter;this.skinningMap.generateMipmaps=false;this.skinningMap.flipY=false}else{this.skinningMap.image.data.set(x,0)}this.skinningMap.needsUpdate=true};s.SkinningTransformations.prototype.setSkinningEulerAngles=function(v,u){if(!this.skinningMapWidth||!this.skinningMapHeight){var w;if(u>512){w=64}else{if(u>128){w=32}else{if(u>32){w=16}else{w=8}}}this.skinningMapWidth=w;this.skinningMapHeight=w}this.useEulerAngles=true;if(!this.skinningMap){var x=new Float32Array(this.skinningMapWidth*this.skinningMapHeight*3);x.set(v,0);this.skinningMap=new s.DataTexture(x,this.skinningMapWidth,this.skinningMapHeight,s.RGBFormat,s.FloatType);this.skinningMap.minFilter=s.NearestFilter;this.skinningMap.magFilter=s.NearestFilter;this.skinningMap.generateMipmaps=false;this.skinningMap.flipY=false}else{this.skinningMap.image.data.set(v,0)}this.skinningMap.needsUpdate=true};s.SkinningTransformationsInstancing=function(){this.useEulerAngles=false;this.skinningInstancingMaps=null;this.skinningInstancingMapsInfo=null};s.SkinningTransformationsInstancing.prototype.setInstancingSkinningMatrices=function(v,F,G){this.useEulerAngles=false;var z;if(!this.skinningInstancingMapsInfo||this.nbBones!==F){var y=function(N){var M=1;while(M<N){M*=2}return M};var I=debugWebGLV6Viewer.renderer.renderer.context;var K=I.getParameter(I.MAX_TEXTURE_SIZE);var B=K*K;var w=F*G*4;var x=Math.ceil(w/B);var u=(w-Math.floor(w/B)*B);var A=Math.sqrt(u);var E=y(A);var D=y(u/E);var H=((x-1)*B+E*D)*3;z={nbBones:F,maxTextureSize:K,nbTextures:x,lastTextureSizeX:E,lastTextureSizeY:D};this.skinningInstancingMapsInfo=z}else{z=this.skinningInstancingMapsInfo}var L;if(!this.skinningInstancingMaps){this.skinningInstancingMaps=new Array(z.nbTextures);L=new Float32Array(H);L.set(v,0)}for(var J=0;J<z.nbTextures-1;J++){if(!this.skinningInstancingMaps[J]){var C=new s.DataTexture(L.subarray(J*z.maxTextureTotalSize*3,(J+1)*z.maxTextureTotalSize*3),z.maxTextureSize,z.maxTextureSize,s.RGBFormat,s.FloatType);C.minFilter=s.NearestFilter;C.magFilter=s.NearestFilter;C.generateMipmaps=false;C.flipY=false;this.skinningInstancingMaps[J]=C}else{this.skinningInstancingMaps[J].image.data.set(v.subarray(J*z.maxTextureTotalSize*3,(J+1)*z.maxTextureTotalSize*3),0)}this.skinningInstancingMaps[J].needsUpdate=true}if(!this.skinningInstancingMaps[z.nbTextures-1]){var C=new s.DataTexture(L.subarray((z.nbTextures-1)*z.maxTextureTotalSize*3,L.length),z.lastTextureSizeX,z.lastTextureSizeY,s.RGBFormat,s.FloatType);C.minFilter=s.NearestFilter;C.magFilter=s.NearestFilter;C.generateMipmaps=false;C.flipY=false;this.skinningInstancingMaps[z.nbTextures-1]=C}else{this.skinningInstancingMaps[z.nbTextures-1].image.data.set(v.subarray((z.nbTextures-1)*z.maxTextureTotalSize*3,v.length),0)}this.skinningInstancingMaps[z.nbTextures-1].needsUpdate=true};s.SkinningTransformationsInstancing.prototype.setInstancingSkinningEulerAngles=function(w,G,H){this.useEulerAngles=true;var A;if(!this.skinningInstancingMapsInfo||this.nbBones!==G){var z=function(N){var M=1;while(M<N){M*=2}return M};var J=debugWebGLV6Viewer.renderer.renderer.context;var L=J.getParameter(J.MAX_TEXTURE_SIZE);var C=L*L;var v=G*H*2;var y=Math.ceil(v/C);var u=(v-Math.floor(v/C)*C);var B=Math.sqrt(u);var F=z(B);var E=z(u/F);var I=((y-1)*C+F*E)*3;A={nbBones:G,maxTextureSize:L,nbTextures:y,lastTextureSizeX:F,lastTextureSizeY:E};this.skinningInstancingMapsInfo=A}else{A=this.skinningInstancingMapsInfo}var x;if(!this.skinningInstancingMaps){this.skinningInstancingMaps=new Array(A.nbTextures);x=new Float32Array(I);x.set(w,0)}for(var K=0;K<A.nbTextures-1;K++){if(!this.skinningInstancingMaps[K]){var D=new s.DataTexture(x.subarray(K*A.maxTextureTotalSize*3,(K+1)*A.maxTextureTotalSize*3),A.maxTextureSize,A.maxTextureSize,s.RGBFormat,s.FloatType);D.minFilter=s.NearestFilter;D.magFilter=s.NearestFilter;D.generateMipmaps=false;D.flipY=false;this.skinningInstancingMaps[K]=D}else{this.skinningInstancingMaps[K].image.data.set(w.subarray(K*A.maxTextureTotalSize*3,(K+1)*A.maxTextureTotalSize*3),0)}this.skinningInstancingMaps[K].needsUpdate=true}if(!this.skinningInstancingMaps[A.nbTextures-1]){var D=new s.DataTexture(x.subarray((A.nbTextures-1)*A.maxTextureTotalSize*3,x.length),A.lastTextureSizeX,A.lastTextureSizeY,s.RGBFormat,s.FloatType);D.minFilter=s.NearestFilter;D.magFilter=s.NearestFilter;D.generateMipmaps=false;D.flipY=false;this.skinningInstancingMaps[A.nbTextures-1]=D}else{this.skinningInstancingMaps[A.nbTextures-1].image.data.set(w.subarray((A.nbTextures-1)*A.maxTextureTotalSize*3,w.length),0)}this.skinningInstancingMaps[A.nbTextures-1].needsUpdate=true};var t=[/(\W+)modelViewMatrix(\W+)/,/(\W+)viewMatrix(\W+)/,/(\W+)projectionMatrix(\W+)/];var g=["modelViewMatrix","viewMatrix","projectionMatrix"];var p=["vGetWorldViewMatrix()","vGetViewMatrix()","vGetProjectionMatrix()"];var q=function(u){var y=g.length;var x="";for(var w=0;w<y;w++){var v=u.search(t[w]);if(v>=0){if(!x){x=['BAD PDSFX USAGE!!!: DO NOT USE THE "'+g[w]+'" token in your overridden function!',"This is henceforth an internal PRIVATE variable. Use the following appropriate PDSFX getter function: "+p[w],"Please take time to correct your PDSFX materials by using the getters/setters provided by the API."].join("\n")}console.warn(x)}}};s._PDSFXData=function(){this.PDSFX=false;this.PDSFX_OverridableFunctions_VS="";this.PDSFX_OverridableFunctions_FS="";this.pdsfxUniformsCode={common:"",vertex:"",fragment:"",};this.pdsfxUniforms=null;this._pdsfxUniformsList=null;this.pdsfxVaryingsCode="";this.pdsfxGlobalVariablesCode_VS="";this.pdsfxGlobalVariablesCode_FS="";this.pdsfxAttributesCode="";this.PDSFX_hasAlbedo=false;this.PDSFX_hasEmissive=false;this.PDSFX_hasSpecular=false;this.PDSFX_hasPsColor=false;this.PDSFX_hasTransparency=false;this.pdsfxUseMap=false};s._PDSFXData.prototype.clone=function(){var u=new s._PDSFXData();u.PDSFX=true;u.PDSFX_OverridableFunctions_VS=this.PDSFX_OverridableFunctions_VS;u.PDSFX_OverridableFunctions_FS=this.PDSFX_OverridableFunctions_FS;if(this.pdsfxUniformsCode){u.pdsfxUniformsCode=this.pdsfxUniformsCode}if(this.pdsfxUniforms){u.pdsfxUniforms=s.UniformsUtils.clone(this.pdsfxUniforms)}if(this.pdsfxVaryingsCode){u.pdsfxVaryingsCode=this.pdsfxVaryingsCode}if(this.pdsfxGlobalVariablesCode_VS){u.pdsfxGlobalVariablesCode_VS=this.pdsfxGlobalVariablesCode_VS}if(this.pdsfxGlobalVariablesCode_FS){u.pdsfxGlobalVariablesCode_FS=this.pdsfxGlobalVariablesCode_FS}if(this.pdsfxAttributesCode){u.pdsfxAttributesCode=this.pdsfxAttributesCode}if(this.PDSFX_hasAlbedo){u.PDSFX_hasAlbedo=true}if(this.PDSFX_hasEmissive){u.PDSFX_hasEmissive=true}if(this.PDSFX_hasSpecular){u.PDSFX_hasSpecular=true}if(this.PDSFX_hasPsColor){u.PDSFX_hasPsColor=true}if(this.PDSFX_hasTransparency){u.PDSFX_hasTransparency=true}if(this.pdsfxUseMap){u.pdsfxUseMap=true}return u};s.WebGLProgramManager=function(u){this.material=u;this.programs=new Map()};s.WebGLProgramManager.prototype.dispose=function(u){this.update(u,null)};s.WebGLProgramManager.prototype.update=function(u,v,y){if(v){if(this.programs.has(y)){var w=this.programs.get(y);this.programs["delete"](y);u(this.material,w.program,false)}}else{var x=this;this.programs.forEach(function(A,z,B){u(x.material,A.program,false)});this.programs.clear()}};s.WebGLProgramManager.prototype.addProgram=function(v,u,w){this.programs.set(w,u)};s.WebGLProgramManager.prototype.getProgram=function(u,w){var v=this.programs.get(w);return v?v:null};s.WebGLProgramManager.prototype.getProgramID=function(v){var w=v?v._programID:1;var u=this.material._programID;return w|u};s.Material=function(){s.EventDispatcher.call(this);this.isPhysicalMaterial=false;this.id=s.MaterialIdCount++;this.name="";this._useCount=0;this._source=s.AssetSource.MANUAL;this.side=a.FrontSide;this.forceSide=false;this.opacity=1;this.transparent=false;this.blending=s.NormalBlending;this.blendSrc=s.SrcAlphaFactor;this.blendDst=s.OneMinusSrcAlphaFactor;this.blendEquation=s.AddEquation;this.depthTest=true;this.depthWrite=true;this.polygonOffset=false;this.polygonOffsetFactor=0;this.polygonOffsetUnits=0;this.polite=false;this.politeMaterial=null;this.alphaTest=0;this.overdraw=false;this.visible=true;this.enableClipPlanes=true;this.clipPlaneIndex=0;this.clipPlaneUseModelMaterial=null;this.mappingType=-1;this.mappingNormTransformation=new s.Matrix3();this.mappingObjTransformation=new s.Matrix4();this.mappingUVTransformation=new s.Matrix3();this.mappingUseFragment=false;this.needsUpdate=true;this.shaderVersion=0;this.overridable=true;this.force=false;this.iterative=false;this.context=null;this.shaderID=s.ShaderIDs.none;this.skinning=false;this.backMaterial=null;this.isBackMaterial=false;this.isAccumMat=false;this.isRevealMat=false;this.isOITable=false;this.updateSSS=false;this.useBlending=false;this.previousOccurrenceRenderingOverride=null;this._programID=0;this.uniforms=null;this.vertexShader=null;this.fragmentShader=null;this.program=null;this.programManager=new s.WebGLProgramManager(this);this.attributes=null;this._picking=false;this._definePickingInstancing=false;this.isInstancingMaterial=false;this.enableReceiveShadowOnCapping=false;this._renderedClipPlane=null;this.line=null;this.point=null;this.setSkinningTransformations({useEulerAngles:false,skinningMap:null,skinningMapWidth:0,skinningMapHeight:0});this.setSkinningTransformationsInstancing({useEulerAngles:false,skinningInstancingMaps:null,skinningInstancingMapsInfo:null});this.skinning=false;this._PDSFXData=null;this.isWideLine=false;this.isDashedLine=false;this.is2DLine=false;this.isCPUPattern=false;this.refreshUniforms=function(w,u,v){};this._withLightMap={}};Object.defineProperty(s.Material.prototype,"PDSFX_OverridableFunctions_FS",{get:function(){return this._PDSFXData?this._PDSFXData.PDSFX_OverridableFunctions_FS:null},});Object.defineProperty(s.Material.prototype,"pdsfxUniforms",{get:function(){console.warn("Do not access the 'pdsfxUniforms' property! Use one of these API functions instead: THREE.Material.getPDSFXUniform, THREE.Material.setPDSFXUniforms, or THREE.Material.updatePDSFXUniform.");return this._PDSFXData?this._PDSFXData.pdsfxUniforms:null},});Object.defineProperty(s.Material.prototype,"PDSFX",{get:function(){return this._PDSFXData?this._PDSFXData.PDSFX:false},});s.Material.prototype.setPDSFXUniforms=function(A){if(this._PDSFXData&&this._PDSFXData.PDSFX){var u=false;var z=0;var y=this._PDSFXData.pdsfxUniformsCode;var x=null;for(var w in A){x=s.ToGLSLTypes[A[w].type];if(!x){continue}if(x.isTexture){this._PDSFXData.pdsfxUseMap=true}u=x.isArray;var B=x.isInt?(A[w].stage===s.FragmentStage?"fragment":"vertex"):"common";if(u){if(A[w].length>0){z=A[w].length;y[B]+="uniform "+x.t+" "+w+"["+z+"];\n"}}else{y[B]+="uniform "+x.t+" "+w+";\n"}}this._PDSFXData.pdsfxUniforms=A}};s.Material.prototype.updatePDSFXUniform=function(v,u){if(this._PDSFXData&&this._PDSFXData.PDSFX){if(this._PDSFXData.pdsfxUniforms[v]!==undefined){this._PDSFXData.pdsfxUniforms[v].value=u}}};s.Material.prototype.getPDSFXUniform=function(u){if(this._PDSFXData&&this._PDSFXData.PDSFX){if(this._PDSFXData.pdsfxUniforms[u]!==undefined){return{name:u,value:this._PDSFXData.pdsfxUniforms[u].value}}else{return null}}};s.Material.prototype.setBackMaterial=function(u){if(this.isBackMaterial){console.warn("You can't set a back material on a back material");return}this.backMaterial=u;if(this.backMaterial!==null){this.backMaterial.polygonOffset=true;this.backMaterial.polygonOffsetFactor=-10;this.backMaterial.polygonOffsetUnits=-10;this.backMaterial.isCPUPattern=this.isCPUPattern;this.backMaterial.isBackMaterial=true;if(this.targetPrimitiveType!==this.backMaterial.targetPrimitiveType||(this.is2DLine&&!this.backMaterial.is2DLine)){console.warn("The back material you are using is not compatible with the main material: primitive types don't match");this.backMaterial=null}else{this.needsUpdate=true}}this.updateDeferredMaterials()};s.Material.prototype.setPDSFXVaryings=function(A){if(this._PDSFXData&&this._PDSFXData.PDSFX){var z=0;var u=false;var y="";var x=null;for(var w in A){x=s.ToGLSLTypes[A[w].type];if(!x){continue}if(!x.canBeVarying){console.warn("setPDSFXVaryings - The type "+A[w].type+" cannot be used for a varying.")}u=x.isArray;if(u&&A[w].length>0){z=A[w].length;y+="varying "+x.t+" "+w+"["+z+"];\n"}else{y+="varying "+x.t+" "+w+";\n"}}this._PDSFXData.pdsfxVaryingsCode=y}};s.Material.prototype.setPDSFXGlobalShaderCode=function(u,v){if(this._PDSFXData&&this._PDSFXData.PDSFX){this._PDSFXData.pdsfxGlobalVariablesCode_VS=u;this._PDSFXData.pdsfxGlobalVariablesCode_FS=v}};s.Material.prototype.setPDSFXPolygonOffset=function(v){if(this._PDSFXData&&this._PDSFXData.PDSFX){this.polygonOffset=true;var u=s.PDSFXPolygonOffsetParams[v];if(u){this.polygonOffsetFactor=u[0];this.polygonOffsetUnits=u[1]}}};s.Material.prototype.setMappingOperator=function(v,x,u,w){this.mappingType=v;if(w!==undefined){this.mappingUseFragment=w}if(x instanceof s.Matrix4){this.mappingObjTransformation=x;this.mappingNormTransformation=new s.Matrix3().getInverse(x).transpose()}if(u instanceof s.Matrix3){this.mappingUVTransformation=u}this.needsUpdate=true};s.Material.prototype.setSkinningTransformations=function(u){this.skinning=true;this.useEulerAngles=u.useEulerAngles;this.skinningMap=u.skinningMap;this.skinningMapWidth=u.skinningMapWidth;this.skinningMapHeight=u.skinningMapHeight};s.Material.prototype.setSkinningTransformationsInstancing=function(u){this.skinning=true;this.useEulerAngles=u.useEulerAngles;this.skinningInstancingMaps=u.skinningInstancingMaps;this.skinningInstancingMapsInfo=u.skinningInstancingMapsInfo};s.Material.prototype.areTexturesLoaded=function(){if(this.map&&this.map.loadEndStatus==="loading"){return false}if(this.lightMap&&this.lightMap.loadEndStatus==="loading"){return false}if(this.bumpMap&&this.bumpMap.loadEndStatus==="loading"){return false}if(this.normalMap&&this.normalMap.loadEndStatus==="loading"){return false}if(this.specularMap&&this.specularMap.loadEndStatus==="loading"){return false}if(this.envMap&&this.envMap.loadEndStatus==="loading"){return false}if(this.coatingBumpMap&&this.coatingBumpMap.loadEndStatus==="loading"){return false}if(this.sssLUT&&this.sssLUT.loadEndStatus==="loading"){return false}if(this.sssIBLLUT&&this.sssIBLLUT.loadEndStatus==="loading"){return false}if(this.translucencyLUT&&this.translucencyLUT.loadEndStatus==="loading"){return false}if(this.uniforms&&this.uniforms.tEnvMap&&this.uniforms.tEnvMap.value&&this.uniforms.tEnvMap.value.loadEndStatus==="loading"){return false}return true};s.Material.prototype._setupOIT=function(u){if(!this.isOITable){return}switch(u){case s.MaterialToUse.oitAccumMaterial:this._programID=this._programID|s.ProgramIDs.OIT_ACCUM;this.isAccumMat=true;break;case s.MaterialToUse.oitRevealMaterial:this._programID=this._programID|s.ProgramIDs.OIT_REVEAL;this.isRevealMat=true;break;default:if(!this.isRevealMat&&!this.isAccumMat){return}if(this.isRevealMat){this._programID=this._programID&~s.ProgramIDs.OIT_REVEAL}if(this.isAccumMat){this._programID=this._programID&~s.ProgramIDs.OIT_ACCUM}this.isRevealMat=false;this.isAccumMat=false;break}};s.Material.prototype.getOpacity=function(){return this.opacity};s.Material.prototype.setValues=function(u){if(u===undefined){return}for(var v in u){var x=u[v];if(x===undefined){console.warn("THREE.Material: '"+v+"' parameter is undefined.");continue}if(v in this){var w=this[v];if(w instanceof s.Color&&x instanceof s.Color){w.copy(x)}else{if(w instanceof s.Color){w.set(x)}else{if(w instanceof s.Vector3&&x instanceof s.Vector3){w.copy(x)}else{if(w instanceof s.Vector2&&x instanceof s.Vector2){w.copy(x)}else{if(w instanceof Float32Array&&x instanceof Float32Array){this[v]=new Float32Array(x)}else{this[v]=x}}}}}}}if(this.backMaterial!==null){this.backMaterial.polygonOffset=true;this.backMaterial.polygonOffsetFactor=-10;this.backMaterial.polygonOffsetUnits=-10;this.backMaterial.isCPUPattern=this.isCPUPattern;this.backMaterial.isBackMaterial=true;if(this.targetPrimitiveType!==this.backMaterial.targetPrimitiveType||(this.is2DLine&&!this.backMaterial.is2DLine)){console.warn("The back material you are using is not compatible with the main material: primitive types don't match");this.backMaterial=null}}if(this.alphaTest){this.transparent=true}};s.Material.prototype._setDefaultPDSFXOverridableFunctions=function(){this._PDSFXData.PDSFX_OverridableFunctions_VS={ComputeCommonValues:s.ShaderChunk.PDSFXComputeCommonValues_VS,ComputeObjectPosition:s.ShaderChunk.PDSFXComputeObjectPosition_VS,ComputeObjectNormal:s.ShaderChunk.PDSFXComputeObjectNormal_VS,ComputeObjectTexCoord0:s.ShaderChunk.PDSFXComputeObjectTexCoord0_VS,ComputeObjectTexCoord1:s.ShaderChunk.PDSFXComputeObjectTexCoord1_VS,ComputeObjectTexCoord2:s.ShaderChunk.PDSFXComputeObjectTexCoord2_VS,ComputeObjectTangent:s.ShaderChunk.PDSFXComputeObjectTangent_VS,ComputeObjectBinormal:s.ShaderChunk.PDSFXComputeObjectBinormal_VS,ProcessViewTangentSpace:s.ShaderChunk.PDSFXProcessViewTangentSpace_VS,ProcessClipSpacePosition:s.ShaderChunk.PDSFXProcessClipSpacePosition_VS,ComputePointSize:s.ShaderChunk.PDSFXComputePointSize_VS,ComputeVaryingValues:s.ShaderChunk.PDSFXComputeVaryingValues_VS};this._PDSFXData.PDSFX_OverridableFunctions_FS={ComputeCommonValues:s.ShaderChunk.PDSFXComputeCommonValues_FS,ComputeDiscard:s.ShaderChunk.PDSFXComputeDiscard_FS,ComputeAlbedo:s.ShaderChunk.PDSFXComputeAlbedo_FS,ComputeViewPosition:s.ShaderChunk.PDSFXComputeViewPosition_FS,ComputeViewNormal:s.ShaderChunk.PDSFXComputeViewNormal_FS,ComputeSpecularReflectance:s.ShaderChunk.PDSFXComputeSpecularReflectance_FS,ComputeRoughness:s.ShaderChunk.PDSFXComputeRoughness_FS,ComputeTransparency:s.ShaderChunk.PDSFXComputeTransparency_FS,ComputeEmissive:s.ShaderChunk.PDSFXComputeEmissive_FS,ComputeOpacity:s.ShaderChunk.PDSFXComputeOpacity_FS,ProcessFinalColor:s.ShaderChunk.PDSFXProcessFinalColor_FS}};s.Material.prototype._getPDSFXOverridableFunctions_VS=function(){var v=this._PDSFXData;if(!v){return""}var u=[v.PDSFX_OverridableFunctions_VS.ComputeCommonValues,v.PDSFX_OverridableFunctions_VS.ComputeObjectPosition,v.PDSFX_OverridableFunctions_VS.ComputeObjectNormal,v.PDSFX_OverridableFunctions_VS.ComputeObjectTexCoord0,v.PDSFX_OverridableFunctions_VS.ComputeObjectTexCoord1,v.PDSFX_OverridableFunctions_VS.ComputeObjectTexCoord2,v.PDSFX_OverridableFunctions_VS.ComputeObjectTangent,v.PDSFX_OverridableFunctions_VS.ComputeObjectBinormal,v.PDSFX_OverridableFunctions_VS.ProcessViewTangentSpace,v.PDSFX_OverridableFunctions_VS.ProcessClipSpacePosition,v.PDSFX_OverridableFunctions_VS.ComputePointSize,v.PDSFX_OverridableFunctions_VS.ComputeVaryingValues].join("\n");return u};s.Material.prototype._getPDSFXOverridableFunctions_FS=function(){var v=this._PDSFXData;if(!v){return""}var u=[v.PDSFX_OverridableFunctions_FS.ComputeCommonValues,v.PDSFX_OverridableFunctions_FS.ComputeDiscard,v.PDSFX_OverridableFunctions_FS.ComputeAlbedo,v.PDSFX_OverridableFunctions_FS.ComputeViewPosition,v.PDSFX_OverridableFunctions_FS.ComputeViewNormal,v.PDSFX_OverridableFunctions_FS.ComputeSpecularReflectance,v.PDSFX_OverridableFunctions_FS.ComputeRoughness,v.PDSFX_OverridableFunctions_FS.ComputeTransparency,v.PDSFX_OverridableFunctions_FS.ComputeEmissive,v.PDSFX_OverridableFunctions_FS.ComputeOpacity,v.PDSFX_OverridableFunctions_FS.ProcessFinalColor].join("\n");return u};s.Material.prototype.setPDSFXOverridableFunctions=function(u,v){if(!(this._PDSFXData&&this._PDSFXData.PDSFX)){console.warn("Not a PDSFX material: please call activatePDSFX() first.")}var w;for(w in u){q(u[w]);this._PDSFXData.PDSFX_OverridableFunctions_VS[w]=u[w]}for(w in v){q(v[w]);this._PDSFXData.PDSFX_OverridableFunctions_FS[w]=v[w]}};s.Material.prototype.clone=function(u){if(u===undefined){u=new s.Material()}u.name=this.name;u.side=this.side;u.forceSide=this.forceSide;u.opacity=this.opacity;u.transparent=this.transparent;u.blending=this.blending;u.blendSrc=this.blendSrc;u.blendDst=this.blendDst;u.blendEquation=this.blendEquation;u.depthTest=this.depthTest;u.depthWrite=this.depthWrite;u.polygonOffset=this.polygonOffset;u.polygonOffsetFactor=this.polygonOffsetFactor;u.polygonOffsetUnits=this.polygonOffsetUnits;u.polite=this.polite;u.politeMaterial=this.politeMaterial;u.alphaTest=this.alphaTest;u.overdraw=this.overdraw;u.visible=this.visible;u.force=this.force;u.enableClipPlanes=this.enableClipPlanes;u.clipPlaneIndex=this.clipPlaneIndex;u.clipPlaneUseModelMaterial=this.clipPlaneUseModelMaterial;u.overridable=this.overridable;u.shaderID=this.shaderID;u.mappingType=this.mappingType;u.mappingUseFragment=this.mappingUseFragment;u.mappingNormTransformation=this.mappingNormTransformation;u.mappingObjTransformation=this.mappingObjTransformation;u.mappingUVTransformation=this.mappingUVTransformation;u.iterative=this.iterative;if(this._picking){u._picking=this._picking}if(this._definePickingInstancing){u._definePickingInstancing=this._definePickingInstancing}if(this.isInstancingMaterial){u.isInstancingMaterial=this.isInstancingMaterial}if(this.skinning){u.skinning=this.skinning;if(this.useEulerAngles){u.useEulerAngles=this.useEulerAngles}if(this.skinningMap){u.skinningMap=this.skinningMap;u.skinningMapWidth=this.skinningMapWidth;u.skinningMapHeight=this.skinningMapHeight}if(this.skinningInstancingMapsInfo){u.skinningInstancingMapsInfo=this.skinningInstancingMapsInfo}if(this.skinningInstancingMaps){u.skinningInstancingMaps=this.skinningInstancingMaps}}if(this._PDSFXData&&this._PDSFXData.PDSFX){u._PDSFXData=this._PDSFXData.clone();if(this.refreshPDSFXUniforms){u.refreshPDSFXUniforms=this.refreshPDSFXUniforms}}u.isAccumMat=this.isAccumMat;u.isRevealMat=this.isRevealMat;u.isOITable=this.isOITable;u.backMaterial=this.backMaterial;u.isBackMaterial=this.isBackMaterial;u.updateSSS=this.updateSSS;u.previousOccurrenceRenderingOverride=this.previousOccurrenceRenderingOverride;u.useBlending=this.useBlending;u._programID=this._programID;u.uniforms=this.uniforms;u.vertexShader=this.vertexShader;u.fragmentShader=this.fragmentShader;u.program=this.program;u.attributes=Object.assign(this.attributes?this.attributes:{},u.attributes);u.enableReceiveShadowOnCapping=this.enableReceiveShadowOnCapping;u._renderedClipPlane=this._renderedClipPlane;u.line=this.line;u.point=this.point;u.isWideLine=this.isWideLine;u.isDashedLine=this.isDashedLine;u.is2DLine=this.is2DLine;u.isCPUPattern=this.isCPUPattern;u.refreshUniforms=this.refreshUniforms;return u};s.Material.prototype.dispose=function(){this.dispatchEvent({type:"dispose"})};s.MaterialIdCount=0;s.LineDSMaterial=function(v){s.Material.call(this);this.color=new s.Color(16777215);this.dashSize=0;this.gapSize=0;this.dashPattern=new Float32Array(2);this.dashType="None";this.patternOffset=0;this.linejoin="miter";this.lineWidth=1;this.pixelSize=new s.Vector2(0.001,0.001);this.side=a.DoubleSide;this.vertexColors=s.NoColors;this.fog=true;this.setValues(v);if(this.dashType!=="None"){this.dashSize=this.gapSize=-1;switch(this.dashType){case 1:this.dashType="Solid";case"Solid":this.dashPattern[0]=-1;break;case 2:this.dashType="Dotted";case"Dotted":this.dashPattern=new Float32Array(2);this.dashPattern[0]=3;this.dashPattern[1]=3;break;case 3:this.dashType="Dashed";case"Dashed":this.dashPattern=new Float32Array(2);this.dashPattern[0]=5;this.dashPattern[1]=1;break;case 4:this.dashType="Dot-Dashed";case"Dot-Dashed":this.dashPattern=new Float32Array(4);this.dashPattern[0]=5;this.dashPattern[1]=3;this.dashPattern[2]=2;this.dashPattern[3]=3;break;case 5:this.dashType="Phantom";case"Phantom":this.dashPattern=new Float32Array(6);this.dashPattern[0]=2;this.dashPattern[1]=2;this.dashPattern[2]=2;this.dashPattern[3]=2;this.dashPattern[4]=6;this.dashPattern[5]=2;break;case 6:this.dashType="Small-Dotted";case"Small-Dotted":this.dashPattern=new Float32Array(2);this.dashPattern[0]=1;this.dashPattern[1]=1;break;case 7:this.dashType="JIS Axis";case"JIS Axis":this.dashPattern=new Float32Array(4);this.dashPattern[0]=14;this.dashPattern[1]=2;this.dashPattern[2]=4;this.dashPattern[3]=2;break;default:this.dashType="None";break}}if((this.dashSize>0&&this.gapSize>0)||this.dashPattern[0]>0.000001){this.isDashedLine=true;if(this.dashSize>0&&this.gapSize>0){console.warn("DEPRECATED: Usage of dashSize and gapSize is deprecated, use dashPattern instead.");this.dashPattern[0]=this.dashSize;this.dashPattern[1]=this.gapSize;this.dashSize=-1;this.gapSize=-1}if(this.dashPattern[0]>0.000001){for(var u=1;u<this.dashPattern.length;u++){this.dashPattern[u]+=this.dashPattern[u-1]}}}if(this.isDashedLine&&this.dashType==="None"){this.dashType="Custom"}};s.LineDSMaterial.prototype=Object.create(s.Material.prototype);s.LineDSMaterial.prototype.clone=function(u){if(u===undefined){u=new s.LineDSMaterial()}s.Material.prototype.clone.call(this,u);u.color.copy(this.color);u.scale=this.scale;u.dashPattern=new Float32Array(this.dashPattern);u.dashType=this.dashType;u.patternOffset=this.patternOffset;u.lineWidth=this.lineWidth;u.linecap=this.linecap;u.linejoin=this.linejoin;u.pixelSize=this.pixelSize;u.side=this.side;u.vertexColors=this.vertexColors;u.fog=this.fog;return u};s.LineDSMaterial.prototype.setPatternOffset=function(u){this.patternOffset=u;if(this.isDashedLine){this.updateDeferredMaterials()}};s.LineDSMaterial.prototype.setScale=function(u){this.scale=u;if(this.isDashedLine){this.updateDeferredMaterials()}};s.LineDSMaterial.prototype.setDashPatternArray=function(u){this.dashPattern=new Float32Array(u);this.dashType="Custom";for(var v=1;v<this.dashPattern.length;v++){this.dashPattern[v]+=this.dashPattern[v-1]}this.isDashedLine=this.dashPattern[0]>0;this.needsUpdate=true;this.updateDeferredMaterials()};s.LineDSMaterial.prototype.setDashPatternType=function(u){this.dashType=u;switch(this.dashType){case 1:this.dashType="Solid";case"Solid":this.dashPattern[0]=-1;break;case 2:this.dashType="Dotted";case"Dotted":this.dashPattern=new Float32Array(2);this.dashPattern[0]=2;this.dashPattern[1]=2;break;case 3:this.dashType="Dashed";case"Dashed":this.dashPattern=new Float32Array(2);this.dashPattern[0]=4;this.dashPattern[1]=2;break;case 4:this.dashType="Dot-Dashed";case"Dot-Dashed":this.dashPattern=new Float32Array(4);this.dashPattern[0]=4;this.dashPattern[1]=2;this.dashPattern[2]=2;this.dashPattern[3]=2;break;case 5:this.dashType="Phantom";case"Phantom":this.dashPattern=new Float32Array(6);this.dashPattern[0]=2;this.dashPattern[1]=2;this.dashPattern[2]=2;this.dashPattern[3]=2;this.dashPattern[4]=6;this.dashPattern[5]=2;break;case 6:this.dashType="Small-Dotted";case"Small-Dotted":this.dashPattern=new Float32Array(2);this.dashPattern[0]=1;this.dashPattern[1]=1;break;case 7:this.dashType="JIS Axis";case"JIS Axis":this.dashPattern=new Float32Array(4);this.dashPattern[0]=14;this.dashPattern[1]=2;this.dashPattern[2]=4;this.dashPattern[3]=2;break;default:this.dashType="None";this.dashPattern=new Float32Array(2);this.dashPattern[0]=0;this.dashPattern[1]=0;break}for(var v=1;v<this.dashPattern.length;v++){this.dashPattern[v]+=this.dashPattern[v-1]}this.isDashedLine=this.dashPattern[0]>0;this.needsUpdate=true;this.updateDeferredMaterials()};s.LineDSMaterial.prototype.activatePDSFX=function(){this._PDSFXData=new s._PDSFXData();this._PDSFXData.PDSFX=true;this._setDefaultPDSFXOverridableFunctions();this._PDSFXData.PDSFX_hasAlbedo=true};s.LineDSMaterial.prototype.loadUniforms=function(v,x,u,w){v.loadUniformsLines(x,this,u,w);v.loadUniformsSkinning(x,this,u)};s.LineDSMaterial.prototype.targetPrimitiveType="LINES";s.LineBasicMaterial=function(u){this.polygonBorderMode=false;this.scale=6.66666;this.linecap="square";s.LineDSMaterial.call(this,u);this.isWideLine=this.lineWidth>1||this.isCPUPattern;if(this.backMaterial){this.backMaterial.isWideLine=this.backMaterial.lineWidth>1||this.isCPUPattern}if(this.polygonBorderMode){this.polygonOffset=this.polygonOffset?this.polygonOffset:this.lineWidth>1;this.polygonOffsetFactor=this.polygonOffsetFactor?this.polygonOffsetFactor:-1;this.polygonOffsetUnits=this.polygonOffsetUnits?this.polygonOffsetUnits:-1}this.shaderID=s.ShaderIDs.line};s.LineBasicMaterial.prototype=Object.create(s.LineDSMaterial.prototype);s.LineBasicMaterial.prototype.clone=function(){var u=new s.LineBasicMaterial();s.LineDSMaterial.prototype.clone.call(this,u);u.polygonBorderMode=this.polygonBorderMode;return u};s.LineBasicMaterial.prototype.setLineWidth=function(v){if(v<1){v=1}var u=Math.round(v);if(Math.abs(this.lineWidth-u)>0.000001){this.needsUpdate=true;this.lineWidth=u;if(this.polygonBorderMode){this.polygonOffset=this.polygonOffset?this.polygonOffset:this.lineWidth>1;this.polygonOffsetFactor=this.polygonOffsetFactor?this.polygonOffsetFactor:-1;this.polygonOffsetUnits=this.polygonOffsetUnits?this.polygonOffsetUnits:-1}this.isWideLine=this.lineWidth>1||this.isCPUPattern;this.updateDeferredMaterials()}};s.LineBasicMaterial.prototype.setBackMaterial=function(u){s.Material.prototype.setBackMaterial.call(this,u);if(this.backMaterial){this.backMaterial.isWideLine=this.backMaterial.lineWidth>1||this.isCPUPattern}this.updateDeferredMaterials()};s.LineBasicMaterial.prototype.setCPUPattern=function(u){if(this.isCPUPattern!==u){this.isCPUPattern=u;this.needsUpdate=true;this.isWideLine=this.lineWidth>1||this.isCPUPattern;if(this.backMaterial!==null){this.backMaterial.isCPUPattern=this.isCPUPattern;this.backMaterial.isWideLine=this.backMaterial.lineWidth>1||this.isCPUPattern;this.backMaterial.needsUpdate=true;this.backMaterial.updateDeferredMaterials()}this.updateDeferredMaterials()}};s.LineBasicShaderLibs={dashedParsVertex:["#ifdef USE_DASHEDLINE","   attribute vec2 lineDistance;","   varying vec2 vLineDistance;","   #ifdef USE_WIDELINE","       varying vec2 vPointNext;","       varying vec2 vPointPrec;","       varying float vLineDistanceAlt;","       varying vec2 vLineDistanceLeft;","       varying vec2 vLineDistanceRight;","       varying float resetSecondDist;","       varying vec2 vConstantNext;","       varying vec2 vConstantCurr;","       varying vec2 vConstantPrec;","   #endif","#endif"].join("\n"),wideParsVertex:["#ifdef USE_WIDELINE","   uniform float halfWidth;","   attribute vec3 previousPos;","   attribute vec3 followingPos;","   attribute float sideExtrusion;","       float getSegmentDepthValue(in vec3 dir, in vec3 posToComp) {","           return min(1e18,(dot(posToComp,dir) * cNormalize(dir)).z);","       }","       float getFinalZ(in bool clipped, in bvec2 precNext, in vec3 pmvPosition, in vec3 pmvPositionPrec, in vec3 pmvPositionSuiv, in vec2 pos, in float oldW, in vec3 mvPosition, in float worldSizeToPixel) {","			vec3 computedPosition = vec3(pos.x, pos.y,pmvPosition.z);","			float finalZ = pmvPosition.z;","       #ifndef USE_POLYGON_BORDER_MODE","           if (!clipped) {","				return finalZ;","           }","			if (precNext.x) {","				finalZ = getSegmentDepthValue(pmvPosition.xyz - pmvPositionPrec.xyz,computedPosition.xyz - pmvPosition.xyz) + pmvPosition.z;","			} else if (precNext.y) {","				finalZ = getSegmentDepthValue(pmvPositionSuiv.xyz - pmvPosition.xyz,computedPosition.xyz - pmvPosition.xyz) + pmvPosition.z;","			}","			return finalZ;","       #else","           vec3 precDir, nextDir;","           if (precNext.y) {","               nextDir = pmvPositionSuiv.xyz - pmvPosition.xyz;","           }","           if (precNext.x) {","               precDir = pmvPosition.xyz - pmvPositionPrec.xyz;","           }","           if (precNext.x && precNext.y && length(cross(nextDir,precDir)) > 1e-6) {","               vec4 equationP = getPlanEquation(nextDir,precDir,pmvPosition.xyz);","               float lambda = -(dot(equationP.xyz,computedPosition.xyz) + equationP.w);","               finalZ = - (equationP.x * computedPosition.x + equationP.y * computedPosition.y + equationP.w)/equationP.z;","               vec3 mvComputedPos = getViewSpaceConvertedPosition(pos, vec2(finalZ,1.0),oldW);","               vec3 positionToComputed = mvComputedPos.xyz - mvPosition;","               if (abs(positionToComputed.z) > 10.0*halfWidth / worldSizeToPixel) {","                   mvComputedPos.z = mvPosition.z + 10.0*halfWidth / worldSizeToPixel * sign(positionToComputed.z);","               }","               vec4 mvpComputedPos = projectionMatrix * vec4(mvComputedPos,1.0);","               mvpComputedPos /= abs(mvpComputedPos.w);","               finalZ = mvpComputedPos.z;","           } else if (precNext.x) {","               finalZ = getSegmentDepthValue(precDir,computedPosition.xyz - pmvPosition.xyz) + pmvPosition.z;","           } else if (precNext.y) {","               finalZ = getSegmentDepthValue(nextDir,computedPosition.xyz - pmvPosition.xyz) + pmvPosition.z;","           }","           return finalZ;","       #endif","       }","#endif"].join("\n"),roundCapParsVertex:["#ifdef USE_ROUNDCAP","   varying vec2 infos;","   varying vec2 centerLeft;","   varying vec2 centerCap;","   varying vec2 centerRight;","#endif"].join("\n"),roundJoinParsVertex:["#ifdef USE_ROUNDJOIN","   varying vec4 centerJoin;","   varying vec4 centerRightJoin;","   varying vec4 centerLeftJoin;","#endif",].join("\n"),polygonBorderModeParsVertex:["   #ifdef USE_POLYGON_BORDER_MODE","       vec4 getPlanEquation(in vec3 v1, in vec3 v2, in vec3 randomPosition) {","           vec3 normal = cross(v1,v2);","           normal = cNormalize(normal);","           float d;","           d = -dot(normal,randomPosition);","           return vec4(normal,d);","       }","","       vec3 getViewSpaceConvertedPosition(in vec2 pos, in vec2 zw, in float w){","           vec4 res = vec4(pos,zw);","           res *= w;","           res.y *= pixelSize.y/pixelSize.x;","           mat4 inverseProjection = mat4(projectionMatrix);","           if (! isNull(projectionMatrix[3][3]) ) {","               inverseProjection[0][0] = 1.0 / projectionMatrix[0][0];","               inverseProjection[1][1] = 1.0 / projectionMatrix[1][1];","               inverseProjection[2][2] = 1.0 / projectionMatrix[2][2];","               inverseProjection[3][2] = -projectionMatrix[3][2] / projectionMatrix[2][2];","               inverseProjection[3][3] = 1.0;","           } else {","               inverseProjection[0][0] = 1.0 / projectionMatrix[0][0];","               inverseProjection[1][1] = 1.0 / projectionMatrix[1][1];","               inverseProjection[2][2] = 0.0;","               inverseProjection[2][3] = 1.0 / projectionMatrix[3][2];","               inverseProjection[3][2] = 1.0 / projectionMatrix[2][3];","               inverseProjection[3][3] = -projectionMatrix[2][2] / (projectionMatrix[3][2] * projectionMatrix[2][3]);","           }","           res = inverseProjection * res;","           return res.xyz/res.w;","       }","   #endif"].join("\n"),wideParsFragment:["#ifdef USE_WIDELINE","   uniform float halfWidth;","#endif",].join("\n"),dashedParsFragment:["#ifdef USE_DASHEDLINE","   uniform float dashSize;","   uniform float scale;","   uniform float totalSize;","   uniform float patternOffset;","   #ifdef PATTERN_LENGTH","       uniform float dashPattern[PATTERN_LENGTH];","   #endif","   varying vec2 vLineDistance;","   #ifdef USE_WIDELINE","       varying vec2 vPointNext;","       varying vec2 vPointPrec;","       varying float vLineDistanceAlt;","       varying vec2 vLineDistanceLeft;","       varying vec2 vLineDistanceRight;","       varying float resetSecondDist;","       varying vec2 vConstantNext;","       varying vec2 vConstantCurr;","       varying vec2 vConstantPrec;","   #endif","   float getDistance(in vec2 next, in vec2 prev) {","       float res = 0.0;","       vec2 direction = next-prev;","       float l = length(direction);","       res = dot(gl_FragCoord.xy  - prev, direction)/(l*l);","       return res * (vLineDistance.y - vLineDistance.x);","   }","   float getDistance(in vec2 next, in vec2 prev, in vec2 origin, in float ratio) {","       float res = 0.0;","       vec2 direction = next-prev;","       float l = length(direction);","       res = dot(gl_FragCoord.xy - origin, direction)/(l*l);","       return res* ratio;","   }","   #ifdef PATTERN_LENGTH","       vec3 getPatternInfo(in float dist) {","           int index = 0;","           float prec = 0.0, cur = 0.0;","           for (int i = 0; i < PATTERN_LENGTH; i++) {","               cur = max(scale,1e-6)*dashPattern[i];","               if (cur > dist) {","                   break;","               }","               prec = cur;","               index++;","           }","           return vec3(float(index),prec,cur);","       }","       float getPatternAlpha(in float dist) {","           float mDist = mod( dist, max(scale,1e-6)*totalSize );","           vec3 patternInfo = getPatternInfo(mDist);","           if (abs(mod(patternInfo.x,2.0)) < 0.5) {","               return 0.0;","           }","               return 1.0;","       }","   #endif","#endif",].join("\n"),roundCapParsFragment:["#ifdef USE_ROUNDCAP","   varying vec2 infos;","   varying vec2 centerLeft;","   varying vec2 centerCap;","   varying vec2 centerRight;","   bool doLeftCap(in bool leftSide) {","       bool leftCap = leftSide && infos.x < 0.0;","       if (!leftCap) {","           return false;","       }","       float distanceL = length(gl_FragCoord.xy - centerLeft)/halfWidth;","       if (distanceL > 1.0) {","           discard;","       }","       return true;","   }","   bool doRightCap(in bool rightSide) {","       bool rightCap = rightSide  && infos.x > length(centerRight - centerCap);","       if (!rightCap) {","           return false;","       }","       float distanceR = length(gl_FragCoord.xy - centerRight) / halfWidth;","       if (distanceR > 1.0) {","            discard;","       }","		return true;","   }","   void doRoundCap() {","       bool centerSide = abs(length(fwidth(centerCap))) < 1e-2;","       bool capToCap = abs(fwidth(infos.y)) < 1e-2 && infos.y > 0.0;","       bool leftSide = abs(length(fwidth(centerLeft))) < 1e-2 ;","       bool rightSide = abs(length(fwidth(centerRight))) < 1e-2 ;","       bool toTreat = ! (leftSide && rightSide && centerSide) || capToCap;","       if (!toTreat) {","           return;","       }","       bool leftCap = doLeftCap(leftSide);","       bool rightCap = doRightCap(rightSide && centerSide);","   }","#endif",].join("\n"),roundJoinParsFragment:["#ifdef USE_ROUNDJOIN","   varying vec4 centerJoin;","   varying vec4 centerRightJoin;","   varying vec4 centerLeftJoin;","   void doCentralJoin() {","       float distanceJoin = 0.0;","       float varJoinC = 0.0;","       if (dot(gl_FragCoord.xy - centerJoin.xy, centerJoin.zw) <= 0.0) {","           return;","       }","       distanceJoin = length(gl_FragCoord.xy - centerJoin.xy) / halfWidth;","       if (distanceJoin > 1.0) {","           discard;","       }","   }","   void doSideJoins() {","       bool rightJoin = abs(length(fwidth(centerRightJoin))) < 1e-2 && dot(gl_FragCoord.xy - centerRightJoin.xy, centerRightJoin.zw) > 0.0;","       bool leftJoin =  abs(length(fwidth(centerLeftJoin))) < 1e-2 && dot(gl_FragCoord.xy - centerLeftJoin.xy, centerLeftJoin.zw) > 0.0;","       float distanceRight = 0.0;","       float distanceLeft = 0.0;","       float varJoinR = 0.0;","       float varJoinL = 0.0;","       if (rightJoin) {","           distanceRight = length(gl_FragCoord.xy - centerRightJoin.xy) / halfWidth;","           if (distanceRight > 1.0) {","               discard;","           }","       }","       if (leftJoin) {","           distanceLeft = length(gl_FragCoord.xy - centerLeftJoin.xy) / halfWidth;","           if (distanceLeft > 1.0) {","               discard;","           }","       }","   }","   void doRoundJoins() {","       bool isOnJoin = abs(length(fwidth(centerJoin))) < 1e-2;","       if (isOnJoin) {","           doCentralJoin();","           return;","       }","       doSideJoins();","    }","#endif",].join("\n"),dashedLineInWide:["   #ifdef USE_DASHEDLINE","       vLineDistanceAlt = vLineDistance.x;","		vec4 mvpPositionPrec = projectionMatrix * mvPositionPrec; ","       vec4 mvpPosition = projectionMatrix * mvPosition;","       vec4 mvpPositionSuiv = projectionMatrix * mvPositionSuiv;","       vConstantNext = (mvpPositionSuiv.xy / mvpPositionSuiv.w + 1.0)/ pixelSize;","       vConstantPrec = (mvpPositionPrec.xy / mvpPositionPrec.w + 1.0) / pixelSize;","       vConstantCurr = (mvpPosition.xy / mvpPosition.w + 1.0) / pixelSize;","	#ifdef CPU_PATTERN","       vLineDistance.x = lineDistance.x ;","       vLineDistance.y = lineDistance.y ;","	#endif","       float worldSizeToPixelPrec = computeWorldSizeToPixel(mvpPositionPrec);","       float worldSizeToPixelNext = computeWorldSizeToPixel(mvpPositionSuiv);","       resetSecondDist = 0.0;","       if (!parity){","           vLineDistanceAlt = vLineDistance.y;","           vPointPrec = (mvpPositionPrec.xy / mvpPositionPrec.w + 1.0) / pixelSize;","           vPointNext = (mvpPosition.xy / mvpPosition.w + 1.0) / pixelSize;","	#ifdef CPU_PATTERN","           vLineDistanceLeft.x = lineDistance.x;","           vLineDistanceLeft.y = lineDistance.y;","           vLineDistanceRight.x = lineDistance.y;","           vLineDistanceRight.y = (lineDistance.y + length(vConstantNext.xy - vConstantCurr.xy));","	#else","           vLineDistance.x = lineDistance.x * modelMatrixScaleX * worldSizeToPixelPrec;","           vLineDistance.y = lineDistance.y * modelMatrixScaleX * worldSizeToPixelCurr;","           vLineDistanceLeft.x = lineDistance.x * modelMatrixScaleX * worldSizeToPixelPrec;","           vLineDistanceLeft.y = lineDistance.y * modelMatrixScaleX * worldSizeToPixelCurr;","           vLineDistanceRight.x = lineDistance.y * modelMatrixScaleX * worldSizeToPixelCurr;","           vLineDistanceRight.y = (lineDistance.y + length(followingPos.xyz - position.xyz)) * modelMatrixScaleX * worldSizeToPixelNext;","	#endif","       } else {","           vLineDistanceAlt = vLineDistance.x;","           vPointPrec = (mvpPosition.xy / mvpPosition.w  + 1.0)/ pixelSize;","           vPointNext = (mvpPositionSuiv.xy / mvpPositionSuiv.w + 1.0)/ pixelSize;","	#ifdef CPU_PATTERN","           vLineDistanceLeft.x = (lineDistance.x - length(vConstantCurr.xy - vConstantPrec.xy));","           vLineDistanceLeft.y = lineDistance.x;","           vLineDistanceRight.x = lineDistance.x;","           vLineDistanceRight.y = lineDistance.y;","	#else","           vLineDistance.x = lineDistance.x * modelMatrixScaleX* worldSizeToPixelCurr;","           vLineDistance.y = lineDistance.y * modelMatrixScaleX* worldSizeToPixelNext;","           vLineDistanceLeft.x = (lineDistance.x - length(position.xyz - previousPos.xyz)) * modelMatrixScaleX * worldSizeToPixelPrec;","           vLineDistanceLeft.y = lineDistance.x * modelMatrixScaleX * worldSizeToPixelCurr;","           vLineDistanceRight.x = lineDistance.x * modelMatrixScaleX * worldSizeToPixelCurr;","           vLineDistanceRight.y = lineDistance.y * modelMatrixScaleX * worldSizeToPixelNext;","	#endif","           if (isNull(lineDistance.x - lineDistance.y)) {","			#ifdef CPU_PATTERN","               vLineDistanceRight.y += length(vConstantNext.xy -  vConstantCurr.xy );","			#else","               vLineDistanceRight.y += length(followingPos.xyz -  position.xyz )* modelMatrixScaleX * worldSizeToPixelNext;","			#endif","               resetSecondDist = 1.0;","           }","       }","   #endif",].join("\n"),roundCapVertex:["#ifdef USE_ROUNDCAP","       vec2 following = (mvpPositionSuivR.xy / mvpPositionSuivR.w + 1.0)/ pixelSize;","       vec2 previous = (mvpPositionPrecR.xy / mvpPositionPrecR.w + 1.0) / pixelSize;","       vec2 current = (mvpPositionR.xy / mvpPositionR.w + 1.0) / pixelSize;","       vec2 computedCurrent = (auxVec.xy + 1.0) / pixelSize;","   if (!bPrecCurr) {","       centerLeft = current.xy;","       centerCap = current.xy;","       centerRight = following.xy;","       infos.x = -halfWidth;","       infos.y = 1.0;","   } else if (!bCurrNext) {","       centerLeft = previous.xy;","       centerCap = previous.xy;","       centerRight = current.xy;","       infos.x = length(current.xy-previous.xy) + halfWidth;","       infos.y = 1.0;","   } else {","       infos.y = 0.0;","       centerLeft = previous.xy;","       centerCap = current.xy;","       centerRight = following.xy;","       if (parity) {","           infos.x = dot(computedCurrent.xy - current.xy,  cNormalize(following.xy - current.xy));","       } else {","           infos.x = length(current.xy - previous.xy) + dot(computedCurrent.xy - current.xy, cNormalize(current.xy - previous.xy));","       }","   }","#endif",].join("\n"),roundJoinVertex:["#ifdef USE_ROUNDJOIN","   vec2 followingJoin = (mvpPositionSuivR.xy / mvpPositionSuivR.w + 1.0)/ pixelSize;","   vec2 previousJoin = (mvpPositionPrecR.xy / mvpPositionPrecR.w + 1.0) / pixelSize;","   vec2 currentJoin = (mvpPositionR.xy / mvpPositionR.w + 1.0) / pixelSize;","   centerLeftJoin = vec4(0.0);","   centerRightJoin = vec4(0.0);","   centerJoin = vec4(0.0);","   if (!bPrecCurr) {","       centerLeftJoin.xy = followingJoin.xy;","       centerJoin.xy = currentJoin.xy;","       centerRightJoin.xy = followingJoin.xy;","       centerRightJoin.zw = dirCurrNext;","   } else if (!bCurrNext) {","       centerLeftJoin.xy = previousJoin.xy;","       centerJoin.xy = currentJoin.xy;","       centerRightJoin.xy = previousJoin.xy;","       centerLeftJoin.zw = -dirPrecCurr;","   } else {","       if (parity) {","           centerLeftJoin.xy = currentJoin.xy;","           centerJoin.xy = currentJoin.xy;","           centerRightJoin.xy = followingJoin.xy;","           centerLeftJoin.zw = -dirCurrNext;","           centerRightJoin.zw = dirCurrNext;","           centerJoin.zw = -dir;","       } else {","           centerLeftJoin.xy = previousJoin.xy;","           centerJoin.xy = currentJoin.xy;","           centerRightJoin.xy = currentJoin.xy;","           centerLeftJoin.zw = -dirPrecCurr;","           centerRightJoin.zw = dirPrecCurr;","           centerJoin.zw = -dir;","       }","   }","#endif",].join("\n"),wideLineExtrusion:["   if (bPrecCurr){","       dirPrecCurr = pmvPosition.xy - pmvPositionPrec.xy;","       dirPrecCurr = cNormalize(dirPrecCurr);","       posPrecCurr = pmvPosition.xy + offset * orientation * vec2(-dirPrecCurr.y, dirPrecCurr.x);","   } else if (bCurrNext) {","       dirPrecCurr = pmvPosition.xy - pmvPositionSuiv.xy;","       dirPrecCurr = cNormalize(dirPrecCurr);","       posPrecCurr = pmvPosition.xy + offset * dirPrecCurr.xy;","   }","","   if (bCurrNext){","       dirCurrNext = pmvPositionSuiv.xy - pmvPosition.xy;","       dirCurrNext = cNormalize(dirCurrNext);","       posCurrNext = pmvPosition.xy + offset * orientation * vec2(-dirCurrNext.y, dirCurrNext.x);","   } else if (bPrecCurr) {","       dirCurrNext = pmvPosition.xy - pmvPositionPrec.xy;","       dirCurrNext = cNormalize(dirCurrNext);","       posCurrNext = pmvPosition.xy + offset * dirCurrNext.xy;","   }","","   vec2 dir = cNormalize(dirCurrNext.xy - dirPrecCurr.xy);","   bool col = false;","   if ( bPrecCurr && bCurrNext){","       if (isNull(length(dir))){","           dir = vec2(-dirCurrNext.y, dirCurrNext.x);","           col = true;","       }","       bool realCol = length(cNormalize(followingPos.xyz - position.xyz) - cNormalize(position.xyz - previousPos.xyz)) < 1e-2;","       float sinAlpha = dir.y * dirPrecCurr.x - dir.x * dirPrecCurr.y;","       float alpha = asin(abs(sinAlpha));","       float distPoints = min(distance(pmvPosition.xy, pmvPositionPrec.xy), distance(pmvPosition.xy, pmvPositionSuiv.xy)) + offset;","       float dist = offset/ sinAlpha;","       if (sign(sinAlpha) == -orientation) {","           if ( alpha < radians(45.0)) {","           #if defined(USE_ROUNDJOIN)","               if (parity){","                   pos = pmvPosition.xy - sign(sinAlpha) * offset * vec2(-dirCurrNext.y,dirCurrNext.x);","                   pos -= offset * dirCurrNext;","               } else {","                   pos = pmvPosition.xy - sign(sinAlpha) *offset * vec2(-dirPrecCurr.y,dirPrecCurr.x);","                   pos += offset * dirPrecCurr;","               }","           #else","               if (parity){","                   pos = posCurrNext - offset * dirCurrNext;","               } else {","                   pos = posPrecCurr + offset * dirPrecCurr;","               }","           #endif","           } else {","               pos = pmvPosition.xy - dir *abs(dist);","           }","           if (col && !realCol) {","               if (parity){","                   pos += dist * dirCurrNext*orientation;","               } else {","                   pos -= dist * dirPrecCurr *orientation;","               }","           }","       } else {","           if (max(distPoints, offset) < abs(dist)){","               dist = max(distPoints - offset, offset)*sign(sinAlpha);","               if (alpha < radians(22.5)){","                   if (parity){","                       pos = posCurrNext + dist * dirCurrNext*orientation;","                   } else {","                       pos = posPrecCurr - dist * dirPrecCurr *orientation;","                   }","                   if (col && !realCol) {","                       if (parity){","                           pos += dist * dirCurrNext*orientation;","                       } else {","                           pos -= dist * dirPrecCurr *orientation;","                       }","                   }","               } else {","                   pos = pmvPosition.xy + dir * max(distPoints, offset);","                   if (col && !realCol) {","                       if (parity){","                           pos += dist * dirCurrNext*orientation;","                       } else {","                           pos -= dist * dirPrecCurr *orientation;","                       }","                   }","               }","           } else {","               pos = pmvPosition.xy + dir *abs(dist);","               if (col && !realCol) {","                   if (parity){","                       pos += dist * dirCurrNext*orientation;","                   } else {","                       pos -= dist * dirPrecCurr *orientation;","                   }","               }","           }","       }","   } else if(bPrecCurr || bCurrNext) {","       #if defined(USE_BUTTCAP)","           pos = pmvPosition.xy + offset * vec2(-dirCurrNext.y, dirCurrNext.x)*orientation;","		#else","			pos = (posCurrNext - pmvPosition.xy)  + posPrecCurr;","		#endif","   } else {","       pos = pmvPosition.xy + offset;","   }",].join("\n"),wideLineClip:["       bool clipped = false;","       vec3 testClip = vec3(sign(pmvPositionPrec.w + pmvPositionPrec.z), sign(pmvPosition.w + pmvPosition.z), sign(pmvPositionSuiv.w + pmvPositionSuiv.z));","       if (bPrecCurr && testClip.x * testClip.y < 0.0 ){","           float a = (pmvPositionPrec.w + pmvPositionPrec.z)/((pmvPositionPrec.w + pmvPositionPrec.z) - (pmvPosition.w + pmvPosition.z));","           if (testClip.x < 0.0) {","               pmvPositionPrec = (1.0 - a) * pmvPositionPrec + a * pmvPosition;","               clipped = true;","           } else if (mod(sideExtrusion,2.0) == 1.0) {","              pmvPosition = (1.0 - a) * pmvPositionPrec + a * pmvPosition;","               pmvPositionSuiv = pmvPosition;","               bCurrNext = false;","               clipped = true;","           }","       }","       if (bCurrNext && testClip.y * testClip.z < 0.0 ){","           float a = (pmvPosition.w + pmvPosition.z)/((pmvPosition.w + pmvPosition.z) - (pmvPositionSuiv.w + pmvPositionSuiv.z));","           if (testClip.z < 0.0) {","               pmvPositionSuiv = (1.0 - a) * pmvPosition + a * pmvPositionSuiv;","               clipped = true;","           } else if (mod(sideExtrusion,2.0) == 0.0){","               pmvPosition = (1.0 - a) * pmvPosition + a * pmvPositionSuiv;","               pmvPositionPrec = pmvPosition;","               bPrecCurr = false;","               clipped = true;","           }","       }","#if defined(USE_ROUNDCAP) || defined(USE_ROUNDJOIN)","       vec4 mvpPositionPrecR = pmvPositionPrec; ","       vec4 mvpPositionR = pmvPosition;","       vec4 mvpPositionSuivR = pmvPositionSuiv;","#endif",].join("\n"),},s.MeshBasicMaterial=function(u){s.Material.call(this);this.color=new s.Color(16777215);this.map=null;this.lightMap=null;this.specularMap=null;this.shaderID=s.ShaderIDs.basic;this.envMap=null;this.combine=s.MultiplyOperation;this.reflectivity=1;this.refractionRatio=0.98;this.fog=true;this.shading=s.SmoothShading;this.wireframe=false;this.wireframeLinewidth=1;this.wireframeLinecap="round";this.wireframeLinejoin="round";this.vertexColors=s.NoColors;this.skinning=false;this.morphTargets=false;this.numSupportedMorpTargets=0;this.canvasNodeTextureSaveParams=null;this.setValues(u)};s.MeshBasicMaterial.prototype=Object.create(s.Material.prototype);s.MeshBasicMaterial.prototype.clone=function(){var u=new s.MeshBasicMaterial();s.Material.prototype.clone.call(this,u);u.color.copy(this.color);u.map=this.map;u.lightMap=this.lightMap;u.specularMap=this.specularMap;u.envMap=this.envMap;u.combine=this.combine;u.reflectivity=this.reflectivity;u.refractionRatio=this.refractionRatio;u.fog=this.fog;u.shading=this.shading;u.wireframe=this.wireframe;u.wireframeLinewidth=this.wireframeLinewidth;u.wireframeLinecap=this.wireframeLinecap;u.wireframeLinejoin=this.wireframeLinejoin;u.vertexColors=this.vertexColors;u.skinning=this.skinning;u.morphTargets=this.morphTargets;u.numSupportedMorpTargets=this.numSupportedMorpTargets;u.canvasNodeTextureSize=this.canvasNodeTextureSize;u.canvasNodeTextureSaveParams=this.canvasNodeTextureSaveParams;return u};s.MeshBasicMaterial.prototype.activatePDSFX=function(){this._PDSFXData=new s._PDSFXData();this._PDSFXData.PDSFX=true;this._setDefaultPDSFXOverridableFunctions();this._PDSFXData.PDSFX_hasAlbedo=true};s.MeshBasicMaterial.prototype.loadUniforms=function(v,x,u,w){v.loadUniformsCommon(x,this,u,w);v.loadUniformsSkinning(x,this,u)};s.MeshLambertMaterial=function(u){s.Material.call(this);this.color=new s.Color(16777215);this.ambient=new s.Color(16777215);this.emissive=new s.Color(0);this.wrapAround=false;this.wrapRGB=new s.Vector3(1,1,1);this.map=null;this.lightMap=null;this.specularMap=null;this.shaderID=s.ShaderIDs.lambert;this.envMap=null;this.combine=s.MultiplyOperation;this.reflectivity=1;this.refractionRatio=0.98;this.fog=true;this.shading=s.SmoothShading;this.wireframe=false;this.wireframeLinewidth=1;this.wireframeLinecap="round";this.wireframeLinejoin="round";this.vertexColors=s.NoColors;this.skinning=false;this.morphTargets=false;this.morphNormals=false;this.lights=true;this.numSupportedMorphTargets=0;this.numSupportedMorphNormals=0;this.setValues(u)};s.MeshLambertMaterial.prototype=Object.create(s.Material.prototype);s.MeshLambertMaterial.prototype.clone=function(){var u=new s.MeshLambertMaterial();s.Material.prototype.clone.call(this,u);u.color.copy(this.color);u.ambient.copy(this.ambient);u.emissive.copy(this.emissive);u.wrapAround=this.wrapAround;u.wrapRGB.copy(this.wrapRGB);u.map=this.map;u.lightMap=this.lightMap;u.specularMap=this.specularMap;u.envMap=this.envMap;u.combine=this.combine;u.reflectivity=this.reflectivity;u.refractionRatio=this.refractionRatio;u.fog=this.fog;u.shading=this.shading;u.wireframe=this.wireframe;u.wireframeLinewidth=this.wireframeLinewidth;u.wireframeLinecap=this.wireframeLinecap;u.wireframeLinejoin=this.wireframeLinejoin;u.vertexColors=this.vertexColors;u.skinning=this.skinning;u.morphTargets=this.morphTargets;u.morphNormals=this.morphNormals;u.numSupportedMorphTargets=this.numSupportedMorphTargets;u.numSupportedMorphNormals=this.numSupportedMorphNormals;return u};s.MeshLambertMaterial.prototype.activatePDSFX=function(){this._PDSFXData=new s._PDSFXData();this._PDSFXData.PDSFX=true;this._setDefaultPDSFXOverridableFunctions()};s.MeshLambertMaterial.prototype.loadUniforms=function(w,y,u,x){var v;if(u.ambient){if(w.gammaInput){if(this.NRECompatibility){v=new s.Color().copyGammaToLinearNRECompatible(this.ambient)}else{v=new s.Color().copyGammaToLinear(this.ambient)}}else{v=this.ambient}y.uniform3f(u.ambient,v.r,v.g,v.b)}if(u.emissive){if(w.gammaInput){if(this.NRECompatibility){v=new s.Color().copyGammaToLinearNRECompatible(this.emissive)}else{v=new s.Color().copyGammaToLinear(this.emissive)}}else{v=this.emissive}y.uniform3f(u.emissive,v.r,v.g,v.b)}if(u.wrapRGB&&this.wrapAround){y.uniform3f(u.wrapRGB,this.wrapRGB.x,this.wrapRGB.y,this.wrapRGB.z)}w.loadUniformsCommon(y,this,u,x);w.loadUniformsSkinning(y,this,u)};s.MeshPhongMaterial=function(u){s.Material.call(this);this.color=new s.Color(16777215);this.ambient=new s.Color(16777215);this.emissive=new s.Color(0);this.specular=new s.Color(1118481);this.shininess=30;this.shininessInSpecMap=false;this.metal=false;this.perPixel=true;this.wrapAround=false;this.wrapRGB=new s.Vector3(1,1,1);this.map=null;this.shaderID=s.ShaderIDs.phong;this.lightMap=null;this.bumpMap=null;this.bumpScale=1;this.normalMap=null;this.normalScale=new s.Vector2(1,1);this.specularMap=null;this.envMap=null;this.combine=s.MultiplyOperation;this.reflectivity=1;this.refractionRatio=0.98;this.refractionRatioMap=null;this.reflectionCoef=0;this.fog=true;this.shading=s.SmoothShading;this.wireframe=false;this.wireframeLinewidth=1;this.wireframeLinecap="round";this.wireframeLinejoin="round";this.vertexColors=s.NoColors;this.skinning=false;this.morphTargets=false;this.morphNormals=false;this.textureBlending=0;this.needsCameraPosition=true;this.lights=true;this.numSupportedMorphTargets=0;this.numSupportedMorphNormals=0;this.setValues(u)};s.MeshPhongMaterial.prototype=Object.create(s.Material.prototype);s.MeshPhongMaterial.prototype.clone=function(){var u=new s.MeshPhongMaterial();s.Material.prototype.clone.call(this,u);u.color.copy(this.color);u.ambient.copy(this.ambient);u.emissive.copy(this.emissive);u.specular.copy(this.specular);u.shininess=this.shininess;u.shininessInSpecMap=this.shininessInSpecMap;u.reflectionCoef=this.reflectionCoef;u.metal=this.metal;u.perPixel=this.perPixel;u.wrapAround=this.wrapAround;u.wrapRGB.copy(this.wrapRGB);u.map=this.map;u.lightMap=this.lightMap;u.bumpMap=this.bumpMap;u.bumpScale=this.bumpScale;u.normalMap=this.normalMap;u.normalScale.copy(this.normalScale);u.specularMap=this.specularMap;u.envMap=this.envMap;u.combine=this.combine;u.reflectivity=this.reflectivity;u.refractionRatio=this.refractionRatio;u.refractionRatioMap=this.refractionRatioMap;u.fog=this.fog;u.shading=this.shading;u.wireframe=this.wireframe;u.wireframeLinewidth=this.wireframeLinewidth;u.wireframeLinecap=this.wireframeLinecap;u.wireframeLinejoin=this.wireframeLinejoin;u.vertexColors=this.vertexColors;u.skinning=this.skinning;u.morphTargets=this.morphTargets;u.morphNormals=this.morphNormals;u.textureBlending=this.textureBlending;u.numSupportedMorphTargets=this.numSupportedMorphTargets;u.numSupportedMorphNormals=this.numSupportedMorphNormals;return u};s.MeshPhongMaterial.prototype.activatePDSFX=function(){this._PDSFXData=new s._PDSFXData();this._PDSFXData.PDSFX=true;this._setDefaultPDSFXOverridableFunctions();this._PDSFXData.PDSFX_hasAlbedo=true;this._PDSFXData.PDSFX_hasEmissive=true;this._PDSFXData.PDSFX_hasSpecular=true};s.MeshPhongMaterial.prototype.loadUniforms=function(w,y,u,x){var v;if(u.ambient){if(w.gammaInput){if(this.NRECompatibility){v=new s.Color().copyGammaToLinearNRECompatible(this.ambient)}else{v=new s.Color().copyGammaToLinear(this.ambient)}}else{v=this.ambient}y.uniform3f(u.ambient,v.r,v.g,v.b)}if(u.emissive){if(w.gammaInput){if(this.NRECompatibility){v=new s.Color().copyGammaToLinearNRECompatible(this.emissive)}else{v=new s.Color().copyGammaToLinear(this.emissive)}}else{v=this.emissive}y.uniform3f(u.emissive,v.r,v.g,v.b)}if(u.specular){if(w.gammaInput){if(this.NRECompatibility){v=new s.Color().copyGammaToLinearNRECompatible(this.specular)}else{v=new s.Color().copyGammaToLinear(this.specular)}}else{v=this.specular}y.uniform3f(u.specular,v.r,v.g,v.b)}if(u.shininess){y.uniform1f(u.shininess,Math.max(this.shininess,0.000001))}if(u.shininessInSpecMap){y.uniform1i(u.shininessInSpecMap,this.shininessInSpecMap)}if(u.wrapRGB&&this.wrapAround){y.uniform3f(u.wrapRGB,this.wrapRGB.x,this.wrapRGB.y,this.wrapRGB.z)}w.loadUniformsCommon(y,this,u,x);w.loadUniformsBump(y,this,u);w.loadUniformsNormalMap(y,this,u);w.loadUniformsSkinning(y,this,u)};s.MeshFaceMaterial=function(u){this.materials=u instanceof Array?u:[]};s.MeshFaceMaterial.prototype.clone=function(){return new s.MeshFaceMaterial(this.materials.slice(0))};s.ParticleBasicMaterial=function(u){s.Material.call(this);this.color=new s.Color(16777215);this.map=null;this.size=1;this.sizeAttenuation=true;this.shaderID=s.ShaderIDs.particle_basic;this.vertexColors=s.NoColors;this.fog=true;this.setValues(u)};s.ParticleBasicMaterial.prototype=Object.create(s.Material.prototype);s.ParticleBasicMaterial.prototype.clone=function(){var u=new s.ParticleBasicMaterial();s.Material.prototype.clone.call(this,u);u.color.copy(this.color);u.map=this.map;u.size=this.size;u.sizeAttenuation=this.sizeAttenuation;u.vertexColors=this.vertexColors;u.fog=this.fog;return u};s.ParticleBasicMaterial.prototype.activatePDSFX=function(){this._PDSFXData=new s._PDSFXData();this._PDSFXData.PDSFX=true;this._setDefaultPDSFXOverridableFunctions();this._PDSFXData.PDSFX_hasPsColor=true};s.ParticleBasicMaterial.prototype.loadUniforms=function(v,x,u,w){v.loadUniformsParticle(x,this,u,w)};s.ParticleBasicMaterial.prototype.targetPrimitiveType="POINTS";s.ParticleCanvasMaterial=function(u){s.Material.call(this);this.color=new s.Color(16777215);this.program=function(w,v){};this.setValues(u)};s.ParticleCanvasMaterial.prototype=Object.create(s.Material.prototype);s.ParticleCanvasMaterial.prototype.clone=function(){var u=new s.ParticleCanvasMaterial();s.Material.prototype.clone.call(this,u);u.color.copy(this.color);u.program=this.program;return u};s.ShaderMaterial=function(u){s.Material.call(this);this.shaderVersion=-1;this.fragmentShader="void main() {}";this.vertexShader="void main() {}";this.uniforms={};this.defines={};this.attributes=null;this.shading=s.SmoothShading;this.wireframe=false;this.wireframeLinewidth=1;this.fog=false;this.lights=false;this.vertexColors=s.NoColors;this.skinning=false;this.needsCameraPosition=true;this.morphTargets=false;this.morphNormals=false;this.enableClipPlanes=false;this.physical=false;this.enableOIT=true;if(u){if(u.lineWidth){this.lineWidth=1}if(u.pixelSize){this.pixelSize=new s.Vector2()}if(u.linejoin){this.linejoin=""}if(u.linecap){this.linecap=""}if(u.miterLimit){this.miterLimit=4;this.is2DLine=true}if(u.scale){this.scale=1}if(u.isDashedLine){this.isDashedLine=true;this.patternOffset=0;this.dashPattern=new Float32Array(2)}}this._shadowPass=false;this.uniformsList=null;this.numSupportedMorphTargets=0;this.numSupportedMorphNormals=0;this.map=null;this.setValues(u);if(this.lineWidth){this.isWideLine=(this.lineWidth>1&&!this.is2DLine)||this.isCPUPattern}};s.ShaderMaterial.prototype=Object.create(s.Material.prototype);s.ShaderMaterial.prototype.clone=function(v){var u=(v!==undefined)?v:new s.ShaderMaterial();s.Material.prototype.clone.call(this,u);u.fragmentShader=this.fragmentShader;u.vertexShader=this.vertexShader;u.uniforms=s.UniformsUtils.clone(this.uniforms);u.attributes=this.attributes;u.defines=this.defines;u.shading=this.shading;u.wireframe=this.wireframe;u.wireframeLinewidth=this.wireframeLinewidth;u.fog=this.fog;u.lights=this.lights;u.vertexColors=this.vertexColors;u.skinning=this.skinning;u.morphTargets=this.morphTargets;u.morphNormals=this.morphNormals;u.physical=this.physical;u.enableOIT=this.enableOIT;u._shadowPass=this._shadowPass;u.uniformsList=this.uniformsList;u.numSupportedMorphTargets=this.numSupportedMorphTargets;u.numSupportedMorphNormals=this.numSupportedMorphNormals;u.map=this.map;return u};s.ShaderMaterial.prototype.activatePDSFX=function(){this._PDSFXData=new s._PDSFXData();this._PDSFXData.PDSFX=true;this._setDefaultPDSFXOverridableFunctions()};s.Texture=function(x,v,z,y,C,w,B,A,u){s.EventDispatcher.call(this);this.id=s.TextureIdCount++;this.name="";this._useCount=0;this._source=s.AssetSource.MANUAL;this.hdr=false;this.hasDiffuse=false;this.sRGB=true;this.image=x;this.mipmaps=[];this.mapping=v!==undefined?v:new s.UVMapping();this.wrapS=z!==undefined?z:s.ClampToEdgeWrapping;this.wrapT=y!==undefined?y:s.ClampToEdgeWrapping;this.magFilter=C!==undefined?C:s.LinearFilter;this.minFilter=w!==undefined?w:s.LinearMipMapLinearFilter;this.anisotropy=u!==undefined?u:1;this.format=B!==undefined?B:s.RGBAFormat;this.type=A!==undefined?A:s.UnsignedByteType;this.offset=new s.Vector2(0,0);this.repeat=new s.Vector2(1,1);this.generateMipmaps=true;this.premultiplyAlpha=false;this.flipY=true;this.unpackAlignment=4;this.needsUpdate=false;this.onUpdate=null;this.onLoadCallbacks=[]};s.Texture.prototype={constructor:s.Texture,clone:function(u){if(u===undefined){u=new s.Texture()}u.hdr=this.hdr;u.sRGB=this.sRGB;u.image=this.image;u.mipmaps=this.mipmaps.slice(0);u.mapping=this.mapping;u.wrapS=this.wrapS;u.wrapT=this.wrapT;u.magFilter=this.magFilter;u.minFilter=this.minFilter;u.anisotropy=this.anisotropy;u.format=this.format;u.type=this.type;u.offset.copy(this.offset);u.repeat.copy(this.repeat);u.generateMipmaps=this.generateMipmaps;u.premultiplyAlpha=this.premultiplyAlpha;u.flipY=this.flipY;u.unpackAlignment=this.unpackAlignment;u.needsUpdate=true;return u},dispose:function(){this.dispatchEvent({type:"dispose"});this.needsUpdate=true}};s.TextureIdCount=0;s.CompressedTexture=function(y,x,E,C,B,v,A,z,D,w,u){s.Texture.call(this,null,v,A,z,D,w,C,B,u);this.image={width:x,height:E};this.mipmaps=y;this.generateMipmaps=false};s.CompressedTexture.prototype=Object.create(s.Texture.prototype);s.CompressedTexture.prototype.clone=function(){var u=new s.CompressedTexture();s.Texture.prototype.clone.call(this,u);return u};s.DataTexture=function(z,x,E,C,B,v,A,y,D,w,u){s.Texture.call(this,null,v,A,y,D,w,C,B,u);this.image={data:z,width:x,height:E}};s.DataTexture.prototype=Object.create(s.Texture.prototype);s.DataTexture.prototype.clone=function(){var u=new s.DataTexture();s.Texture.prototype.clone.call(this,u);return u};s.TextureLODPool=function(){this.totalSize=0;this.textures=[]};s.TextureLODPool.prototype.removeUnusedTextures=function(){var x=[];for(var u=0;u<this.textures.length;u++){var w=this.textures[u];if(w.textureLOD.usedTexture===w.lod){x.push(w);continue}var y=w.textureLOD.textures[w.lod];var v=w.textureLOD.textures[w.textureLOD.usedTexture];if(!v||(v.loadEndStatus==="complete")){y.dispose();w.textureLOD.textures[w.lod]=null;this.totalSize-=w.size}else{x.push(w)}}this.textures=x};s.TextureLODPool.prototype.add=function(u){this.totalSize+=u.size;this.textures.push(u)};s.Particle=function(u){s.Object3D.call(this);this.material=u};s.Particle.prototype=Object.create(s.Object3D.prototype);s.Particle.prototype.clone=function(u){if(u===undefined){u=new s.Particle(this.material)}s.Object3D.prototype.clone.call(this,u);return u};s.ParticleSystem=function(v,u){s.Object3D.call(this);this.geometry=v;this.material=(u!==undefined)?u:new s.ParticleBasicMaterial({color:Math.random()*16777215});this.sortParticles=false;if(this.geometry){if(this.geometry.boundingSphere===null){this.geometry.computeBoundingSphere()}}this.frustumCulled=false;console.log("THREE.ParticleSystem is deprecated. Please use SceneGraphFactory.createMeshNode instead.")};s.ParticleSystem.prototype=Object.create(s.Object3D.prototype);s.ParticleSystem.prototype.clone=function(u){if(u===undefined){u=new s.ParticleSystem(this.geometry,this.material)}u.sortParticles=this.sortParticles;s.Object3D.prototype.clone.call(this,u);return u};s.Line=function(w,v,u){s.Object3D.call(this);this.geometry=w;this.material=(v!==undefined)?v:new s.LineBasicMaterial({color:Math.random()*16777215});this.type=(u!==undefined)?u:s.LineStrip;if(this.geometry){if(!this.geometry.boundingSphere){this.geometry.computeBoundingSphere()}}};s.LineStrip=0;s.LinePieces=1;s.Line.prototype=Object.create(s.Object3D.prototype);s.Line.prototype.clone=function(u){if(u===undefined){u=new s.Line(this.geometry,this.material,this.type)}s.Object3D.prototype.clone.call(this,u);return u};s.Mesh=function(v,u){s.Object3D.call(this);this.geometry=[];if(v){if(v.length){this.geometry=v.slice()}else{if(v.length===undefined){this.geometry=v}}this.geometry.boundingSphere=v.boundingSphere;this.geometry.boundingBox=v.boundingBox}if(s.disableJHGDev){this.material=(u!==undefined)?u:new s.MeshBasicMaterial({color:Math.random()*16777215,wireframe:false})}else{this.material=(u!==undefined)?u:null}this.matApp=null;this.gas=null;if(this.geometry&&(this.geometry.boundingSphere===null)){this.geometry.computeBoundingSphere()}if(!this.geometry.boundingSphere){this.geometry.boundingSphere=new s.Sphere()}if(!this.geometry.boundingBox){this.geometry.boundingBox=new s.Box3()}this.beforeRenderCB=null};s.Mesh.prototype=Object.create(s.Object3D.prototype);s.Mesh.prototype.getMorphTargetIndexByName=function(u){if(this.morphTargetDictionary[u]!==undefined){return this.morphTargetDictionary[u]}console.log("THREE.Mesh.getMorphTargetIndexByName: morph target "+u+" does not exist. Returning 0.");return 0};s.Mesh.prototype.clone=function(u){if(u===undefined){u=new s.Mesh(this.geometry,this.material)}if(this.matApp){u.matApp=this.matApp}s.Object3D.prototype.clone.call(this,u);return u};s.Mesh.prototype.getOwningScene=function(){var u=this;while(u.parent!==undefined){u=u.parent}if(u!==undefined&&u instanceof s.Scene){return u}return null};s.CSS3DNode=function(u){s.Object3D.call(this);this.element=u?u:document.createElement("div");this.element.renderable=this;this.element.style.position="absolute";this.geometry=new s.Geometry();this.geometry.boundingSphere=new s.Sphere()};s.CSS3DNode.prototype=Object.create(s.Object3D.prototype);s.Bone=function(u){s.Object3D.call(this)};s.SkinnedMesh=function(y,x,w){s.Mesh.call(this,y,x,true);this.useVertexTexture=w!==undefined?w:true;this.identityMatrix=new s.Matrix4();this.bones=[];this.boneMatrices=[];var z,A,B,v,u,C;window.sealWebVisuObjects&&Object.seal(this)};s.SkinnedMesh.prototype=Object.create(s.Mesh.prototype);s.Sprite=function(u){s.Object3D.call(this)};s.Sprite.prototype=Object.create(s.Object3D.prototype);s.WebGLObjectManager=function(){this.objects=[];this.idMap=new Map();this.nullCount=0;this.lastCleanFrame=0};s.WebGLObjectManager.prototype._clean=function(){if(this.nullCount>1000){this.idMap.clear();this.objects=this.objects.filter(function(v){return v!==null});this.nullCount=0;for(var u=0;u<this.objects.length;u++){if(this.idMap.has(this.objects[u].object)){this.idMap.get(this.objects[u].object).push(u)}else{this.idMap.set(this.objects[u].object,[u])}}}};s.WebGLObjectManager.prototype.getObjects=function(u){this._tryClean(u);return this.objects};s.WebGLObjectManager.prototype._tryClean=function(v){if(this.lastCleanFrame===0&&v){this.lastCleanFrame=v;return}if(this.nullCount>0&&(!v||(v-this.lastCleanFrame>60))){this.idMap.clear();if(this.nullCount===this.objects.length){this.objects=[]}else{this.objects=this.objects.filter(function(w){return w!==null});for(var u=0;u<this.objects.length;u++){if(this.idMap.has(this.objects[u].object)){this.idMap.get(this.objects[u].object).push(u)}else{this.idMap.set(this.objects[u].object,[u])}}}this.lastCleanFrame=v;this.nullCount=0}};s.WebGLObjectManager.prototype.add=function(u){if(u!==null){if(this.idMap.has(u.object)){this.idMap.get(u.object).push(this.objects.length)}else{this.idMap.set(u.object,[this.objects.length])}this.objects.push(u)}};s.WebGLObjectManager.prototype.remove=function(u){if(u===null){return}if(this.idMap.has(u)){var w=this.idMap.get(u);for(var v=0;v<w.length;v++){this.objects[w[v]]=null;this.nullCount++}this.idMap["delete"](u)}this._clean()};s.WebGLObjectManager.prototype.clear=function(){this.objects=[];this.nullCount=0;this.lastCleanFrame=0;this.idMap.clear()};s.Scene=function(){s.Object3D.call(this);this.fog=null;this.overrideMaterial=null;this.matrixAutoUpdate=false;this.envMipMap=[];this.envMipMapID=null;this.ambienceMatrix=new s.Matrix4();this.reflectionProbes=[];this.useFiniteEnvMap=false;this.parallaxCorrectionParameters={sphereCenter:[],sphereRadius:1,projectionCenter:[]};this.__objects=new Set();this.__lights=[];this.__objectsAdded=new Map();this.__objectsRemoved=new Set();this.__objectsUpdated=new Map()};s.Scene.prototype=Object.create(s.Object3D.prototype);s.Scene.prototype.constructor=s.Scene;s.Scene.prototype._lightSort=function(v,u){var x=v instanceof s.DirectionalLight?6:0;var w=u instanceof s.DirectionalLight?6:0;x+=v instanceof s.SpotLight?4:0;w+=u instanceof s.SpotLight?4:0;x+=v instanceof s.PointLight?2:0;w+=u instanceof s.PointLight?2:0;x=v.onlyShadow?0:x;w=u.onlyShadow?0:w;x+=v.castShadow?1:0;w+=u.castShadow?1:0;x+=v.shadowCascade?2:0;w+=u.shadowCascade?2:0;return w-x};s.Scene.prototype.__addObject=function(u,v){if(u instanceof s.Light){if(this.__lights.indexOf(u)===-1){this.__lights.push(u);this.__lights.sort(this._lightSort)}if(u.target&&u.target.parent===undefined){this.add(u.target)}}else{if(u instanceof s.LensFlare){if(!this.__webglFlares){this.__webglFlares=[]}this.__webglFlares.push(u)}else{if(!(u instanceof s.Camera||u instanceof s.Bone)){this.__objects.add(u);this.__objectsAdded.set(u,v);this.__objectsRemoved["delete"](u)}}}for(var w=0;w<u.children.length;w++){this.__addObject(u.children[w])}};s.Scene.prototype.dispose=function(){var w=this.children.length;var v;for(v=0;v<this.__lights.length;v++){var u=this.__lights[v];if(u.shadowMap&&u.shadowMap.dispose){u.shadowMap.dispose()}}for(v=0;v<w;v++){this.remove(this.children[0])}this.__objects.clear();this.__lights=[];this.__objectsAdded.clear();this.__objectsRemoved.clear();this.__objectsUpdated.clear();this.__webglObjects={main:new s.WebGLObjectManager()};this.__webglObjectsAll=new s.WebGLObjectManager();this.__webglObjectsToDraw=[];this.__webglObjectsImmediate=[];this.__webglSprites=[]};s.Scene.prototype.updateObjectPasses=function(u,v){if(!(u instanceof s.Light||u instanceof s.LensFlare||u instanceof s.Camera||u instanceof s.Bone)){this.__objectsUpdated.set(u,v||null)}};s.Scene.prototype.__removeObject=function(u){if(u instanceof s.Light){var v=this.__lights.indexOf(u);if(v!==-1){this.__lights.splice(v,1)}}else{if(u instanceof s.LensFlare){var v=this.__webglFlares.indexOf(u);if(v!==-1){this.__webglFlares.splice(v,1)}}else{if(!(u instanceof s.Camera)){if(this.__objects["delete"](u)){this.__objectsRemoved.add(u);this.__objectsAdded["delete"](u)}}}}for(var w=0;w<u.children.length;w++){this.__removeObject(u.children[w])}};s.Scene.prototype.getWebGLObjects=function(w,v){var u=this.__webglObjects[w?w:"main"];if(u){return u.getObjects(v)}return[]};s.Scene.prototype.getNbWebGLObjects=function(u){return this.getWebGLObjects(u,0).length};s.Scene.prototype.getAllWebGLObjects=function(u){return this.__webglObjectsAll.getObjects(u)};s.Scene.prototype.computeLightsKey=function(){var x=this.__lights;var w={dirLights:0,pointLights:0,spotLights:0,hemiLights:0,sphereLights:0,areaLights:0,iesLights:0,probeLight:false};var z={dirLight:0,spotLight:0,tex2d:0,texCube:0};var A=x.length;for(var v=0;v<A;v++){var u=x[v];if(u.onlyShadow){continue}u.allocate(w);if(!u.castShadow){continue}u.allocateShadows(null,z)}var y=w.iesLights;y=16*y+w.pointLights;y=16*y+w.spotLights;y=16*y+w.dirLights;y=16*y+z.texCube;y=16*y+z.spotLight;y=16*y+z.dirLight;return y};s.StateSortingResult=function(){this._displayLists=[];this._pickingPriorityMapping=null};s.StateSortingResult.prototype.init=function(){var v=new s.DisplayList({name:"SOLID",priority:1024,zSort:s.FrontToBack,side:a.FrontSide,polygonOffset:true});var C=new s.DisplayList({name:"SURFACE",priority:512,zSort:s.FrontToBack,side:a.DoubleSide,polygonOffset:true});var y=new s.DisplayList({name:"EDGE",priority:256,zSort:s.FrontToBack,side:a.DoubleSide,polygonOffset:false});var u=new s.DisplayList({name:"BACK",priority:192,zSort:s.FrontToBack,side:a.DoubleSide,polygonOffset:true,depthWrite:false,depthFunc:"GREATER"});var A=new s.DisplayList({name:"POINT",priority:128,zSort:s.FrontToBack,side:a.DoubleSide,polygonOffset:false});var w=new s.DisplayList({name:"TRANSPAR1D",priority:96,zSort:s.BackToFront,side:a.DoubleSide,polygonOffset:true,depthWrite:false});w.hasTranspar=true;var x=new s.DisplayList({name:"TRANSPAR",priority:64,zSort:s.BackToFront,side:a.DoubleSide,polygonOffset:true,depthWrite:false});x.hasTranspar=true;var z=new s.DisplayList({name:"NOZ",priority:32,zSort:s.FrontToBack,side:a.DoubleSide,polygonOffset:true,clearDepth:true});var B=new s.DisplayList({name:"NOZTRANSPAR",priority:16,zSort:s.BackToFront,side:a.DoubleSide,polygonOffset:true});this.addDisplayList(v);this.addDisplayList(C);this.addDisplayList(y);this.addDisplayList(u);this.addDisplayList(A);this.addDisplayList(x);this.addDisplayList(w);this.addDisplayList(z);this.addDisplayList(B)};s.StateSortingResult.prototype.addDisplayList=function(u){var w,x=false;if(this._displayLists.length&&(u.priority!==undefined)){for(w=0;w<this._displayLists.length&&!x;w++){var v=this._displayLists[w].priority;if(u.priority>v){this.insertDisplayList(u,w);x=true}}}if(!x){this._displayLists.push(u)}for(w=0;w<this._displayLists.length;w++){this._displayLists[w].index=w}return u};s.StateSortingResult.prototype.insertDisplayList=function(v,u){this._displayLists.splice(u,0,v)};s.StateSortingResult.prototype.getDisplayListByName=function(u){for(var v=0;v<this._displayLists.length;v++){if(this._displayLists[v].name===u){return this._displayLists[v]}}return null};s.Fog=function(w,v,u){this.name="";this.color=new s.Color(w);this.near=(v!==undefined)?v:1;this.far=(u!==undefined)?u:1000};s.Fog.prototype.clone=function(){return new s.Fog(this.color.getHex(),this.near,this.far)};s.FogExp2=function(v,u){this.name="";this.color=new s.Color(v);this.density=(u!==undefined)?u:0.00025};s.FogExp2.prototype.clone=function(){return new s.FogExp2(this.color.getHex(),this.density)};s.RenderableObject=function(){this.object=null;this.z=null};s.RenderableParticle=function(){this.object=null;this.x=null;this.y=null;this.z=null;this.rotation=null;this.scale=new s.Vector2();this.material=null};s.RenderableLine=function(){this.z=null;this.v1=new s.RenderableVertex();this.v2=new s.RenderableVertex();this.material=null};s.VertexStage=0;s.FragmentStage=1;s.ToGLSLTypes={f:{t:"float",isArray:false,isTexture:false,canBeVarying:true,isInt:false},v2:{t:"vec2",isArray:false,isTexture:false,canBeVarying:true,isInt:false},v3:{t:"vec3",isArray:false,isTexture:false,canBeVarying:true,isInt:false},c:{t:"vec3",isArray:false,isTexture:false,canBeVarying:true,isInt:false},v4:{t:"vec4",isArray:false,isTexture:false,canBeVarying:true,isInt:false},m3:{t:"mat3",isArray:false,isTexture:false,canBeVarying:true,isInt:false},m4:{t:"mat4",isArray:false,isTexture:false,canBeVarying:true,isInt:false},i:{t:"int",isArray:false,isTexture:false,canBeVarying:false,isInt:true},b:{t:"bool",isArray:false,isTexture:false,canBeVarying:false,isInt:false},fv1:{t:"float",isArray:true,isTexture:false,canBeVarying:true,isInt:false},iv1:{t:"int",isArray:true,isTexture:false,canBeVarying:false,isInt:true},v2v:{t:"vec2",isArray:true,isTexture:false,canBeVarying:true,isInt:false},v3v:{t:"vec3",isArray:true,isTexture:false,canBeVarying:true,isInt:false},v4v:{t:"vec4",isArray:true,isTexture:false,canBeVarying:true,isInt:false},m4v:{t:"mat4",isArray:true,isTexture:false,canBeVarying:true,isInt:false},t2:{t:"sampler2D",isArray:false,isTexture:true,canBeVarying:false,isInt:false},tc:{t:"samplerCube",isArray:false,isTexture:true,canBeVarying:false,isInt:false},t2v:{t:"sampler2D",isArray:true,isTexture:true,canBeVarying:false,isInt:false},tcv:{t:"samplerCube",isArray:true,isTexture:true,canBeVarying:false,isInt:false}};s.PDSFXPolygonOffsetParams={Backward2:[4,4],Backward1:[2,2.3],Backward0:[1,1],Neutral:[0,0],Frontward0:[-0.9,-1],Frontward1:[-2,-2]};s._DefaultShaderChunk={model_view_transformation_vertex:["#if defined(FIXED_SIZE)","setSimpleNodeData();","#endif","auxPosMV = position;","#ifdef FIXED_SIZE","auxPosMV *= simpleNodeData.fixedSizeScale;","#ifdef FIXED_SIZE_CENTER","auxPosMV += simpleNodeData.fixedSizeScaleCenter * fixedSizeCenterRatio.xyz;","#endif","#endif","vec4 mvPosition = modelViewMatrix * vec4(auxPosMV, 1.0);",].join("\n"),model_view_projection_transformation_vertex:["#if defined(FIXED_SIZE)","setSimpleNodeData();","#endif","auxPosMVP = position;","#ifdef FIXED_SIZE","auxPosMVP *= simpleNodeData.fixedSizeScale;","#ifdef FIXED_SIZE_CENTER","auxPosMVP += simpleNodeData.fixedSizeScaleCenter * fixedSizeCenterRatio.xyz;","#endif","#endif","gl_Position = projectionMatrix * (modelViewMatrix * vec4( auxPosMVP, 1.0 ));",].join("\n"),model_view_normal_vertex:["vec3 mvNormal;","if (use_normal_matrix)","mvNormal = normalMatrix * normal;","else {","mvNormal = vec3(modelViewMatrix * vec4(normal, 0.0));","}","mvNormal = normalize( mvNormal );"].join("\n"),getModelViewTransformationChunk:function(w,u){var v=["#if defined(FIXED_SIZE)","setSimpleNodeData();","#endif","auxPosMVPFunc = "+u+";","#ifdef FIXED_SIZE","auxPosMVPFunc.xyz *= simpleNodeData.fixedSizeScale;","#ifdef FIXED_SIZE_CENTER","auxPosMVPFunc.xyz += auxPosMVPFunc.w * simpleNodeData.fixedSizeScaleCenter * fixedSizeCenterRatio.xyz;","#endif","#endif",w+" = modelViewMatrix * auxPosMVPFunc;",].join("\n");return v},getModelViewUnitVectorTransformationChunk:function(v,u){var w=[v+" = vec3(modelViewMatrix * vec4("+u+", 0.0));",].join("\n");return w}};s.ShaderChunk={decompress_normals_pars:["vec2 unpack_2unorm12_in_2floats(in float iEncodedNormal) {","vec2 res;","res.x = floor(iEncodedNormal/4096.0)/4095.0;","res.y = mod(iEncodedNormal, 4096.0)/4095.0;","return res;","}","float signNotZero(in float k) {","return k >= 0.0 ? 1.0 : -1.0;","}","vec2 signNotZero(in vec2 v) {","return vec2( signNotZero(v.x), signNotZero(v.y) );","}","vec3 decodeNormal(in vec2 iEncodedNormal) {","float x = iEncodedNormal.x*2.0 - 1.0;","float y = iEncodedNormal.y*2.0 - 1.0;","vec3 v = vec3(x, y, 1.0 - abs(x) - abs(y));","if (v.z <= 0.0) {","vec2 sgn = signNotZero(v.xy);","v.xy = - abs(v.yx)*sgn + sgn;","}","return normalize(v);","}",].join("\n"),decompress_vertices_pars:["vec3 unpack_3unorm16_in_2floats(in vec2 iEncodedPosition) {","vec3 res;","res.x = floor(iEncodedPosition.x/256.0);","res.y = mod(iEncodedPosition.x, 256.0) *256.0 + mod(iEncodedPosition.y, 256.0);","res.z = floor(iEncodedPosition.y/256.0);","return res;","}","vec3 decodePosition(in vec2 iEncodedPosition) {","vec3 res = unpack_3unorm16_in_2floats(iEncodedPosition);","return quantizedVector * (res + offsetVector);","}",].join("\n"),PDSFX_common_pars:["/**** PDSFX Common Getters ****/","","float _DSsize_;","","mat4 vGetWorldViewMatrix() {","return modelViewMatrix;","}","","uniform mat4 modelViewInvTranspMatrix;","mat4 vGetWorldViewInvTranspMatrix() {","return modelViewInvTranspMatrix;","}","","mat4 vGetViewMatrix() {","return viewMatrix;","}","","mat4 vGetProjectionMatrix() {","return projectionMatrix;","}","","mat4 vGetViewProjectionMatrix() {","return projectionMatrix * viewMatrix;","}","","uniform mat4 viewInvMatrix;","mat4 vGetViewInvMatrix() {","return viewInvMatrix;","}","","uniform mat4 projectionInvMatrix;","mat4 vGetProjectionInvMatrix() {","return projectionInvMatrix;","}","","mat4 vGetViewProjectionInvMatrix() {","return viewInvMatrix * projectionInvMatrix;","}","","uniform mat4 viewInvTranspMatrix;","mat4 vGetViewInvTranspMatrix() {","return viewInvTranspMatrix;","}","","mat3 _DSmappingUVTransformation;","mat4 vGetTextureMatrix() {","#if defined( NEEDS_UVTOUSE )","#if defined (USE_MAPPING_OPERATOR_FRAGMENT) && defined (MAPPING_OPERATOR)","mat4 matrix;","matrix[0] = vec4(_DSmappingUVTransformation[0], 0.0);","matrix[1] = vec4(_DSmappingUVTransformation[1], 0.0);","matrix[2] = vec4(_DSmappingUVTransformation[2], 0.0);","return matrix;","#endif","#endif","return mat4(0.0);","}","","vec3 vGetWorldEyePos() {","return cameraPosition;","}","","vec3 vGetLowlightColor() {","return vec3(0.0);","}","","float vGetDefaultPointSize() {","#ifdef PARTICLE","return _DSsize_;","#else","return 1.0;","#endif","}","","uniform vec3 nearFarLogFactor;","vec3 vGetNearFarLogFactor() {","return nearFarLogFactor;","}","","uniform vec2 viewportSize;","ivec2 vGetViewportSize() {","return ivec2(viewportSize);","}","","mat3 vGet3x3WorldMatrix() {","return mat3(modelMatrix);","}","","uniform mat4 modelInvTranspMatrix;","mat3 vGet3x3WorldInvTranspMatrix() {","return mat3(modelInvTranspMatrix);","}",""].join("\n"),PDSFX_attribute_getters_vertex:["","float _DSscale_;","#ifdef USE_SIZEATTENUATION","vec3 mvPosForAttenuation;","#endif","","int vGetInstanceID() {","#ifdef IS_MULTI_INSTANCED","	return int(instanceId/5.0 - 1.0);","#else","	return 0;","#endif","}","","vec3 vGetAttribPosition() {","return _DSposition;","}","","vec3 vGetAttribNormal() {","return _DSnormal;","}","","vec3 vGetAttribColor() {","#ifdef USE_COLOR","return color.xyz;","#else","return vec3(0.0);","#endif","}","","vec4 vGetAttribTexCoord0() {","return vec4(_DSuv, 0.0, 0.0);","}","","vec4 vGetAttribTexCoord1() {","return vec4(_DSuv2, 0.0, 0.0);","}","","vec4 vGetAttribTexCoord2() {","return vec4(0.0);","}","","vec3 vGetAttribTangent() {","return _DStangent;","}","","vec3 vGetAttribBinormal() {","return _DSbinormal;","}","",].join("\n"),PDSFX_varying_getters_fragment:["#ifdef PDSFX","","vec4 vGetFragCoord() {","return gl_FragCoord;","}","","void vSetFragDepth(in float iDepth) {","#ifdef FRAG_DEPTH_EXT","gl_FragDepthEXT = iDepth;","#endif","}","","bool vIsFrontFacing() {","return gl_FrontFacing;","}","","vec2 vGetPointCoord() {","return gl_PointCoord;","}","","vec3 vGetViewPosition() {","return _DSviewPosition;","}","","vec3 vGetViewNormal() {","return _DSviewNormal;","}","","vec3 vGetViewTangent() {","return _DSviewTangent;","}","","vec3 vGetViewBinormal() {","return _DSviewBinormal;","}","","vec2 _uvToUse;","vec4 vGetTexCoord0() {","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","return vec4(_uvToUse, 0.0, 0.0);","#else","return vec4(0.0);","#endif","}","","vec4 vGetTexCoord1() {","#ifdef USE_LIGHTMAP","return vec4(vUv2, 0.0, 0.0);","#endif","return vec4(0.0);","}","","vec4 vGetTexCoord2() {","return vec4(0.0);","}","","vec4 vGetClipSpacePosition() {","return _DSclipPosition;","}","vec3 _DSalbedo_;","vec3 _DSemissive_;","vec3 _DSspecular_;","float _DStransparency_;","float _DSroughness_;","float _DSopacity_;","#endif","",].join("\n"),PDSFX_varyings_pars:["","#ifdef PDSFX","varying vec3 _DSviewPosition;","varying vec3 _DSviewNormal;","varying vec3 _DSviewTangent;","varying vec3 _DSviewBinormal;","varying vec4 _DSclipPosition;","#endif",""].join("\n"),PDSFX_start_vertex:["","#ifdef COMPRESSED_VERTICES","position = decodePosition(_DSposition);","#endif","#ifdef COMPRESSED_NORMALS","vec2 enc = unpack_2unorm12_in_2floats(_DSnormal);","normal = decodeNormal(enc);","#endif","#ifdef PDSFX","ComputeCommonValues();","position = ComputeObjectPosition();","normal = ComputeObjectNormal();","uv = ComputeObjectTexCoord0().xy;","#ifdef USE_LIGHTMAP","uv2 = ComputeObjectTexCoord1().xy;","#endif","#if defined(USE_TANGENT) || defined(USE_TANGENT_BINORMAL)","tangent = ComputeObjectTangent();","#ifdef USE_TANGENT_BINORMAL","binormal = ComputeObjectBinormal();","#endif","#endif","TangentSpace _viewTangentSpace;","vec3 _MVNormal;","#if defined( NEEDS_UVTOUSE )","#if defined (USE_MAPPING_OPERATOR_FRAGMENT) && defined (MAPPING_OPERATOR)","_DSmappingUVTransformation = mappingUVTransformation;","#endif","#endif","#endif",""].join("\n"),PDSFX_start_particle_vertex:["#ifdef PDSFX","_DSsize_ = size;","_DSscale_ = scale;","#endif"].join("\n"),PDSFX_point_size_vertex:["#ifdef PDSFX","gl_PointSize = ComputePointSize();","#else","#ifdef USE_SIZEATTENUATION","gl_PointSize = size * ( scale / length( mvPosition.xyz ) );","#else","gl_PointSize = size;","#endif","#endif",].join("\n"),PDSFX_end_vertex:["","#ifdef PDSFX","ProcessClipSpacePosition(gl_Position);","ComputeVaryingValues();","_DSclipPosition = gl_Position;","_DSviewPosition = _viewTangentSpace.Position;","_DSviewNormal = _viewTangentSpace.Normal;","_DSviewTangent = _viewTangentSpace.Tangent;","_DSviewBinormal = _viewTangentSpace.Binormal;","#endif","#ifdef PICKING_INSTANCING","if (instanceId > 16777215.0) vInstancePickingColor = vec3(0.0);","else {","vInstancePickingColor.r = floor(instanceId / 65536.0);","vInstancePickingColor.g = floor((instanceId - vInstancePickingColor.r * 65536.0) / 256.0);","vInstancePickingColor.b = floor(instanceId - vInstancePickingColor.r * 65536.0 - vInstancePickingColor.g * 256.0);","vInstancePickingColor /= 255.0;","}","#endif",""].join("\n"),PDSFX_albedo_pars_fragment:["#ifdef PDSFX","uniform vec3 _DSalbedo;","vec3 diffuse;","#else","uniform vec3 diffuse;","#endif"].join("\n"),PDSFX_opacity_pars_fragment:["#ifdef PDSFX","uniform float _DSopacity;","float opacity;","#else","uniform float opacity;","#endif"].join("\n"),PDSFX_transparency_pars_fragment:["#ifdef PDSFX","uniform float _DStransparency;","float transparency;","#else","uniform float transparency;","#endif"].join("\n"),PDSFX_emissive_pars_fragment:["#ifdef PDSFX","uniform vec3 _DSemissive;","vec3 emissive;","#else","uniform vec3 emissive;","#endif"].join("\n"),PDSFX_specular_pars_fragment:["#ifdef PDSFX","uniform vec3 _DSspecular;","vec3 specular;","#else","uniform vec3 specular;","#endif"].join("\n"),PDSFX_map_fragment:["#ifdef PDSFX_USE_MAP","_uvToUse = vUv;","#endif",].join("\n"),PDSFX_albedo_fragment:["_DSalbedo_ = _DSalbedo;","diffuse = ComputeAlbedo();"].join("\n"),PDSFX_opacity_fragment:["_DSopacity_ = _DSopacity;","opacity = ComputeOpacity();"].join("\n"),PDSFX_emissive_fragment:["_DSemissive_ = _DSemissive;","emissive = ComputeEmissive();"].join("\n"),PDSFX_specular_fragment:["_DSspecular_ = _DSspecular;","specular = ComputeSpecularReflectance();"].join("\n"),PDSFX_discard_fragment:["bool isDiscarded = ComputeDiscard();","if (isDiscarded) discard;"].join("\n"),PDSFX_transparency_fragment:["_DStransparency_ = _DStransparency;","transparency = ComputeTransparency();"].join("\n"),PDSFX_viewNormal_fragment:["vec3 _DSvNormal = ComputeViewNormal();",].join("\n"),PDSFX_end_fragment:["#ifdef PDSFX","ProcessFinalColor(gl_FragColor);","#endif","#ifdef PICKING_INSTANCING","gl_FragColor = vec4(vInstancePickingColor, 1.0);","#endif"].join("\n"),PDSFXComputeCommonValues_VS:["void ComputeCommonValues() {","}"].join("\n"),PDSFXComputeObjectPosition_VS:["vec3 ComputeObjectPosition() {","	return _DSposition;","}"].join("\n"),PDSFXComputeObjectNormal_VS:["vec3 ComputeObjectNormal() {","	return _DSnormal;","}"].join("\n"),PDSFXComputeObjectTexCoord0_VS:["vec4 ComputeObjectTexCoord0() {","	return vec4(_DSuv, 0.0, 0.0);","}"].join("\n"),PDSFXComputeObjectTexCoord1_VS:["vec4 ComputeObjectTexCoord1() {","	return vec4(_DSuv2, 0.0, 0.0);","}"].join("\n"),PDSFXComputeObjectTexCoord2_VS:["vec4 ComputeObjectTexCoord2() {","	return vec4(0.0);","}"].join("\n"),PDSFXComputeObjectTangent_VS:["vec3 ComputeObjectTangent() {","	return _DStangent;","}"].join("\n"),PDSFXComputeObjectBinormal_VS:["vec3 ComputeObjectBinormal() {","	return _DSbinormal;","}"].join("\n"),PDSFXProcessViewTangentSpace_VS:["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","}"].join("\n"),PDSFXProcessClipSpacePosition_VS:["void ProcessClipSpacePosition(inout vec4 ioPosition) {","}"].join("\n"),PDSFXComputePointSize_VS:["float ComputePointSize() {","#ifdef USE_SIZEATTENUATION","return _DSsize_ * ( _DSscale_ / length( mvPosForAttenuation.xyz ) );","#else","return _DSsize_;","#endif","}"].join("\n"),PDSFXComputeVaryingValues_VS:["void ComputeVaryingValues() {","}"].join("\n"),PDSFXComputeCommonValues_FS:["void ComputeCommonValues() {","}"].join("\n"),PDSFXComputeDiscard_FS:["bool ComputeDiscard() {","	return false;","}"].join("\n"),PDSFXComputeAlbedo_FS:["vec3 ComputeAlbedo() {","	return _DSalbedo_;","}"].join("\n"),PDSFXComputeViewPosition_FS:["vec3 ComputeViewPosition() {","	return _DSviewPosition;","}"].join("\n"),PDSFXComputeViewNormal_FS:["vec3 ComputeViewNormal() {","	return normalize(_DSviewNormal);","}"].join("\n"),PDSFXComputeSpecularReflectance_FS:["vec3 ComputeSpecularReflectance() {","	return _DSspecular_;","}"].join("\n"),PDSFXComputeRoughness_FS:["float ComputeRoughness() {","	return _DSroughness_;","}"].join("\n"),PDSFXComputeTransparency_FS:["float ComputeTransparency() {","	return _DStransparency_;","}"].join("\n"),PDSFXComputeEmissive_FS:["vec3 ComputeEmissive() {","	return _DSemissive_;","}"].join("\n"),PDSFXComputeOpacity_FS:["float ComputeOpacity() {","	return _DSopacity_;","}"].join("\n"),PDSFXProcessFinalColor_FS:["void ProcessFinalColor(inout vec4 ioFinalColor) {","}"].join("\n"),fog_pars_fragment:["#ifdef USE_FOG","uniform vec3 fogColor;","#ifdef FOG_EXP2","uniform float fogDensity;","#else","uniform float fogNear;","uniform float fogFar;","#endif","#endif"].join("\n"),fog_fragment:["#ifdef USE_FOG","float depth = gl_FragCoord.z / gl_FragCoord.w;","#ifdef FOG_EXP2","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","#else","float fogFactor = smoothstep( fogNear, fogFar, depth );","#endif","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","#endif"].join("\n"),envmap_pars_fragment:["#if defined( USE_MAP_HDR ) || defined( USE_ENVMAP_HDR )","uniform vec2 mapHDRSize;","uniform vec2 envMapHDRSize;","vec4 texture2DFromRGBE(sampler2D textureSampler, vec2 uv) {","vec4 texelRGBE = texture2D(textureSampler, uv);","float exponent = pow(2.0, 255.0 * texelRGBE.w - 128.0);","return vec4((255.0 / 256.0) * texelRGBE.xyz * exponent, 1.0);","}","vec4 texture2DBilinearFromRGBE(sampler2D textureSampler, vec2 uv, vec2 textureSize, vec2 texelSize) {","vec4 tl = texture2DFromRGBE(textureSampler, uv);","vec4 tr = texture2DFromRGBE(textureSampler, uv + vec2(texelSize.x, 0.0));","vec4 bl = texture2DFromRGBE(textureSampler, uv + vec2(0.0, texelSize.y));","vec4 br = texture2DFromRGBE(textureSampler, uv + vec2(texelSize.x, texelSize.y));","vec2 f = fract(uv.xy * textureSize.xy);","vec4 tA = mix(tl, tr, f.x);","vec4 tB = mix(bl, br, f.x);","return mix(tA, tB, f.y);","}","#endif","#ifdef USE_ENVMAP","const float PI = 3.1415926535898;","const float INV_PI = 0.31830988618;","uniform float reflectivity;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","uniform sampler2D envMap;","uniform mat4 ambienceMatrix;","uniform float envMapExposure;","#else","uniform samplerCube envMap;","#endif","uniform int combine;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHYSICALDS )","uniform bool useRefract;","uniform float refractionRatio;","#if defined( USE_REFRACTIONRATIOMAP )","uniform sampler2D refractionRatioMap;","#endif","#else","varying vec3 vReflect;","#endif","#endif"].join("\n"),envmap_fragment:["#ifdef USE_ENVMAP","vec3 reflectVec;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","vec3 worldNormal = normalize( vec3( vec4( normal, 0.0 ) * viewMatrix ) );","if ( useRefract ) {","#if defined( USE_REFRACTIONRATIOMAP )","reflectVec = refract( cameraToVertex, worldNormal, texture2D(refractionRatioMap, uvToUse).r );","#else","reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );","#endif","} else { ","reflectVec = reflect( cameraToVertex, worldNormal );","}","#else","reflectVec = vReflect;","#endif","vec3 flipReflectVec;","#ifdef DOUBLE_SIDED","float flipNormal = 1.0;","flipReflectVec = flipNormal * reflectVec;","#else","flipReflectVec = reflectVec;","#endif","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_LIGHTPROBEMAP","flipReflectVec = vec3(flipReflectVec.y, flipReflectVec.z, flipReflectVec.x);","flipReflectVec = (ambienceMatrix*vec4(flipReflectVec,0.0)).xyz;","float probeR = INV_PI * acos( flipReflectVec.z ) / length(flipReflectVec.xy);","#ifdef USE_ENVMAP_HDR","vec2 texelSizeEnvMap = vec2(1.0 / envMapHDRSize);","vec4 cubeColor = texture2DBilinearFromRGBE( envMap, 0.5 * (probeR * flipReflectVec.xy + 1.0), envMapHDRSize, texelSizeEnvMap );","#else","vec4 cubeColor = texture2D( envMap, 0.5 * (probeR * flipReflectVec.xy + 1.0) );","#endif","#else","flipReflectVec = (ambienceMatrix*vec4(flipReflectVec,0.0)).xyz;","float phi = atan(flipReflectVec.y, flipReflectVec.x);","float theta = acos(flipReflectVec.z);","#ifdef USE_ENVMAP_HDR","vec2 texelSizeEnvMap = vec2(1.0 / envMapHDRSize);","vec4 cubeColor = envMapExposure * texture2DBilinearFromRGBE( envMap, vec2(0.5 + 0.5 * INV_PI * phi, 1.0 - INV_PI * theta), envMapHDRSize, texelSizeEnvMap );","#else","vec4 cubeColor = envMapExposure * texture2D( envMap, vec2(0.5 + 0.5 * INV_PI * phi, 1.0 - INV_PI * theta) );","#endif","#endif","#else","#if defined(CUBEMAP_ZUP)","vec4 cubeColor = textureCube( envMap, vec3(-flipReflectVec.x, flipReflectVec.zy) );","#else","vec4 cubeColor = textureCube( envMap, flipReflectVec );","#endif","#endif","if ( combine == 1 ) {","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );","} else if ( combine == 2 ) {","gl_FragColor.xyz += cubeColor.xyz * specularStrength * reflectivity;","} else {","gl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );","}","#endif"].join("\n"),envmap_pars_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP ) && ! defined( PHYSICALDS )","varying vec3 vReflect;","uniform float refractionRatio;","uniform bool useRefract;","#if defined( USE_REFRACTIONRATIOMAP )","uniform sampler2D refractionRatioMap;","#endif","#endif"].join("\n"),lines_pars_vertex:["   uniform vec2 pixelSize;","   bool isNull(float x) {","       return abs(x) < 1e-6;","   }","   float computeWorldSizeToPixel(in vec4 pos) {","      return abs(projectionMatrix[0][0]/pos.w)/pixelSize.x;","   }","   vec2 cNormalize(in vec2 v) {","       float len = length(v);","       if (!isNull(len)) {","           return v/len;","       }","       return vec2(0.0);","   }","   vec3 cNormalize(in vec3 v) {","       float len = length(v);","       if (!isNull(len)) {","           return v/len;","       }","       return vec3(0.0);","   }","   vec4 cNormalize(in vec4 v) {","       float len = length(v);","       if (!isNull(len)) {","           return v/len;","       }","       return vec4(0.0);","   }",s.LineBasicShaderLibs.dashedParsVertex,s.LineBasicShaderLibs.polygonBorderModeParsVertex,s.LineBasicShaderLibs.wideParsVertex,s.LineBasicShaderLibs.roundCapParsVertex,s.LineBasicShaderLibs.roundJoinParsVertex].join("\n"),lines_vertex:["#if defined(USE_DASHEDLINE) || defined(USE_WIDELINE)","	float worldSizeToPixelCurr = computeWorldSizeToPixel(gl_Position);","#endif","#ifdef USE_DASHEDLINE","	#ifndef CPU_PATTERN","		float modelMatrixScaleX = length(modelViewMatrix[0]);","#ifdef FIXED_SIZE","modelMatrixScaleX *= simpleNodeData.fixedSizeScale;","#endif","		vLineDistance = worldSizeToPixelCurr * modelMatrixScaleX * lineDistance;","	#else","		vLineDistance = lineDistance;","	#endif","#endif","#ifdef USE_WIDELINE",s._DefaultShaderChunk.getModelViewTransformationChunk("mvPosition","vec4(position, 1.0)"),s._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPositionPrec","vec4(previousPos.xyz, 1.0)"),s._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPositionSuiv","vec4(followingPos.xyz, 1.0)"),"   vec4 pmvPosition = projectionMatrix * mvPosition;","   vec4 pmvPositionPrec = projectionMatrix * mvPositionPrec;","   vec4 pmvPositionSuiv = projectionMatrix * mvPositionSuiv;","","   vec3 eps = vec3(1e-6);","   bool bPrecCurr = !all(lessThan(abs(position.xyz - previousPos.xyz), eps));","   bool bCurrNext = !all(lessThan(abs(followingPos.xyz - position.xyz), eps));","",s.LineBasicShaderLibs.wideLineClip,"   pmvPosition.y *= pixelSize.x/pixelSize.y;","   pmvPositionPrec.y *= pixelSize.x/pixelSize.y;","   pmvPositionSuiv.y *= pixelSize.x/pixelSize.y;","   float oldW = abs(pmvPosition.w);","   pmvPosition /= abs(pmvPosition.w);","   pmvPositionPrec /= abs(pmvPositionPrec.w);","   pmvPositionSuiv /= abs(pmvPositionSuiv.w);","","   float offset = halfWidth  * pixelSize.x ;","   vec2 pos, posPrecCurr, posCurrNext;","   vec2 dirPrecCurr, dirCurrNext;","   float orientation = sign(sideExtrusion);","   bool parity = mod(sideExtrusion,2.0) < 0.5;","","   if (isNull(length(pmvPosition.xy - pmvPositionPrec.xy))) {","       bPrecCurr = false;","   }","   if (isNull(length(pmvPositionSuiv.xy - pmvPosition.xy))) {","       bCurrNext = false;","   }",s.LineBasicShaderLibs.wideLineExtrusion,"#if defined(USE_DASHEDLINE) || defined(USE_ROUNDCAP) || defined(USE_ROUNDJOIN)","       vec3 auxVec = vec3(pos.x, pos.y * pixelSize.y/pixelSize.x,0.0);","#endif",s.LineBasicShaderLibs.dashedLineInWide,s.LineBasicShaderLibs.roundCapVertex,s.LineBasicShaderLibs.roundJoinVertex,"   float finalZ = getFinalZ(clipped,bvec2(bPrecCurr && !col,bCurrNext), pmvPosition.xyz, pmvPositionPrec.xyz, pmvPositionSuiv.xyz, pos, oldW, mvPosition.xyz,worldSizeToPixelCurr);","   gl_Position = vec4(pos.x, pos.y * pixelSize.y/pixelSize.x,finalZ, pmvPosition.w);","#endif"].join("\n"),lines_pars_fragment:["#ifdef PDSFX","uniform vec3 _DSalbedo;","vec3 diffuse;","#else","uniform vec3 diffuse;","#endif","#ifdef PDSFX","uniform float _DSopacity;","float opacity;","#else","uniform float opacity;","#endif",s.LineBasicShaderLibs.wideParsFragment,s.LineBasicShaderLibs.dashedParsFragment,s.LineBasicShaderLibs.roundCapParsFragment,s.LineBasicShaderLibs.roundJoinParsFragment,].join("\n"),lines_fragment:["#ifdef USE_DASHEDLINE","       float dist = vLineDistance.x;","       float dist2 = 0.0;","   #ifdef USE_WIDELINE","       bool isConnection = length(fwidth(vConstantCurr)) < 1e-2;","       bool resetDist2 = fwidth(resetSecondDist) > 1e-2;","		if (!isConnection){","           dist += getDistance(vPointNext,vPointPrec);","		} else  {","           dist = vLineDistanceAlt + getDistance(vConstantCurr,vConstantPrec, vConstantCurr, vLineDistanceLeft.y - vLineDistanceLeft.x);","           dist2 = getDistance(vConstantNext,vConstantCurr, vConstantCurr, vLineDistanceRight.y - vLineDistanceRight.x);","			dist2 += resetDist2 ? 0.0 : vLineDistanceAlt;","		}","   #endif","   #ifdef PATTERN_LENGTH","       #ifndef USE_WIDELINE","           float halfWidth = 0.0;","       #endif","       float patternAlpha = getPatternAlpha(dist+halfWidth + patternOffset);","       if (abs(dist2) > 1e-6) {","           patternAlpha = min(patternAlpha, getPatternAlpha(dist2+halfWidth + patternOffset));","       }","       if (patternAlpha > 0.5) {","           discard;","       }","   #endif","#endif","#ifdef USE_ROUNDCAP","   doRoundCap();","#endif","#ifdef USE_ROUNDJOIN","   doRoundJoins();","#endif",].join("\n"),worldpos_vertex:["#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined( PHYSICALDS ) || defined ( USE_SHADOWMAP )","#ifdef USE_SKINNING","vec4 worldPosition = modelMatrix * skinned;","#endif","#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( morphed, 1.0 );","#endif","#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","#endif","#endif"].join("\n"),envmap_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP ) && ! defined( PHYSICALDS )","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","worldNormal = normalize( worldNormal );","vec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );","if ( useRefract ) {","#if defined( USE_REFRACTIONRATIOMAP )","vReflect = refract( cameraToVertex, worldNormal, texture2D(refractionRatioMap, uvToUse).r );","#else","vReflect = refract( cameraToVertex, worldNormal, refractionRatio );","#endif","} else {","vReflect = reflect( cameraToVertex, worldNormal );","}","#endif"].join("\n"),map_particle_pars_fragment:["#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_particle_fragment:["#ifdef USE_MAP","gl_FragColor = gl_FragColor * texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );","#endif"].join("\n"),map_pars_vertex:["#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","varying vec2 vUv;","uniform vec2 offsetBumpMap;","uniform vec2 repeatBumpMap;","#if defined (MAPPING_OPERATOR)","#if defined (USE_MAPPING_OPERATOR_VERTEX)","uniform mat3 mappingNormTransformation;","uniform mat4 mappingObjTransformation;","uniform mat3 mappingUVTransformation;","#else","varying vec3 localPosition;","varying vec3 localNormal;","#endif","#endif","#endif"].join("\n"),map_pars_vertex_physical:["#ifdef USE_UV_SLOT_1","varying vec2 vUv;","#endif","#ifdef USE_UV_SLOT_2","varying vec2 vUv2;","#endif","#if defined (MAPPING_OPERATOR)","#if defined (USE_MAPPING_OPERATOR_VERTEX)","uniform mat3 mappingNormTransformation;","uniform mat4 mappingObjTransformation;","uniform mat3 mappingUVTransformation;","vec2 applyMappingOperator(vec2 inUV) {","vec2 outUV = inUV;","vec3 localpos = (mappingObjTransformation * vec4(position, 1.0)).xyz; ","vec3 localnorm = mappingNormTransformation * normal; ","#if MAPPING_OPERATOR==1","outUV = localpos.xy;","#elif MAPPING_OPERATOR==2","float radius3d = max(0.000001,length(localpos.xyz));","float z_by_radius3d = localpos.z / radius3d;","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float phiMapping   = asin(z_by_radius3d );","float u=thetaMapping*radius3d;","float v=phiMapping*radius3d;","outUV = vec2(u, v);","#elif MAPPING_OPERATOR==3","float radius3d = max(0.000001,length(localpos.xyz));","float z_by_radius3d = localpos.z / radius3d;","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float phiMapping   = asin(z_by_radius3d );","float u=thetaMapping/3.14159;","float v=phiMapping/3.14159;","outUV = vec2(u, v);","#elif MAPPING_OPERATOR==4","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","if(maxima_normal == absolute_normal.x){","outUV = vec2(sign(localnorm.x) * localpos.y, localpos.z );","}","else if(maxima_normal == absolute_normal.y){","outUV = vec2(-sign(localnorm.y) * localpos.x, localpos.z );","}","else{","outUV = vec2(sign(localnorm.z) * localpos.x, localpos.y);","}","#elif MAPPING_OPERATOR==5","float radius2d = length(localpos.xy);","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","if(maxima_normal == absolute_normal.z){","outUV = vec2(sign(localnorm.z) * localpos.x, localpos.y); ","}else{","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0){","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","outUV = vec2(u , localpos.z);","}","#elif MAPPING_OPERATOR==6","float radius2d = length(localpos.xy);","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","outUV = vec2(u, localpos.z);","#elif MAPPING_OPERATOR==7","float radius2d = length(localpos.xy);","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping/3.14159;","outUV = vec2(u, localpos.z/(radius2d*3.14159));","#endif","return (mappingUVTransformation * vec3(outUV, 1.0)).xy;","}","#else","varying vec3 localPosition;","varying vec3 localNormal;","#endif","#endif",].join("\n"),map_pars_fragment:["#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","varying vec2 vUv;","#if defined (USE_MAPPING_OPERATOR_FRAGMENT) && defined (MAPPING_OPERATOR)","varying vec3 localPosition;","varying vec3 localNormal;","uniform mat3 mappingNormTransformation;","uniform mat4 mappingObjTransformation;","uniform mat3 mappingUVTransformation;","#endif","#endif","#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_pars_fragment_physical:["#ifdef USE_UV_SLOT_1","varying vec2 vUv;","vec2 uvToUse;","#endif","#ifdef USE_UV_SLOT_2","varying vec2 vUv2;","vec2 uv2ToUse;","#endif","#if defined (USE_MAPPING_OPERATOR_FRAGMENT) && defined (MAPPING_OPERATOR)","varying vec3 localPosition;","varying vec3 localNormal;","uniform mat3 mappingNormTransformation;","uniform mat4 mappingObjTransformation;","uniform mat3 mappingUVTransformation;","vec2 applyMappingOperator(vec2 inUV) {","vec2 outUV = inUV;","vec3 localpos = (mappingObjTransformation * vec4(localPosition, 1.0)).xyz; ","vec3 localnorm = mappingNormTransformation * localNormal; ","#if MAPPING_OPERATOR==1","outUV = localpos.xy;","#elif MAPPING_OPERATOR==2","float radius3d = max(0.000001,length(localpos.xyz));","float z_by_radius3d = localpos.z / radius3d;","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float phiMapping   = asin(z_by_radius3d );","float u=thetaMapping*radius3d;","float v=phiMapping*radius3d;","outUV = vec2(u, v);","#elif MAPPING_OPERATOR==3","float radius3d = max(0.000001,length(localpos.xyz));","float z_by_radius3d = localpos.z / radius3d;","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float phiMapping   = asin(z_by_radius3d );","float u=thetaMapping/3.14159;","float v=phiMapping/3.14159;","outUV = vec2(u, v);","#elif MAPPING_OPERATOR==4","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","if(maxima_normal == absolute_normal.x){","outUV = vec2(sign(localnorm.x) * localpos.y, localpos.z );","}","else if(maxima_normal == absolute_normal.y){","outUV = vec2(-sign(localnorm.y) * localpos.x, localpos.z );","}","else{","outUV = vec2(sign(localnorm.z) * localpos.x, localpos.y);","}","#elif MAPPING_OPERATOR==5","float radius2d = length(localpos.xy);","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","if(maxima_normal == absolute_normal.z){","outUV = vec2(sign(localnorm.z) * localpos.x, localpos.y); ","}else{","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0){","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","outUV = vec2(u , localpos.z);","}","#elif MAPPING_OPERATOR==6","float radius2d = length(localpos.xy);","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","outUV = vec2(u, localpos.z);","#elif MAPPING_OPERATOR==7","float radius2d = length(localpos.xy);","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping/3.14159;","outUV = vec2(u, localpos.z/(radius2d*3.14159));","#endif","return (mappingUVTransformation * vec3(outUV, 1.0)).xy;","}","#endif","#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_vertex_physical:["#ifdef USE_UV_SLOT_1","vUv = uv;","#if defined (MAPPING_OPERATOR) && defined(USE_MAPPING_OPERATOR_VERTEX)","vUv = applyMappingOperator(uv);","#endif","#endif","#ifdef USE_UV_SLOT_2","vUv2 = uv2;","#if defined (MAPPING_OPERATOR) && defined(USE_MAPPING_OPERATOR_VERTEX)","vUv2 = applyMappingOperator(uv2);","#endif","#endif","#if defined(MAPPING_OPERATOR) && !defined(USE_MAPPING_OPERATOR_VERTEX)","localPosition = position;","localNormal = normal;","#endif"].join("\n"),map_vertex:["#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","vUv = uv * repeatBumpMap + offsetBumpMap;","#if defined (MAPPING_OPERATOR)","#if defined (USE_MAPPING_OPERATOR_VERTEX)","vec3 localpos = (mappingObjTransformation * vec4(position, 1.0)).xyz; ","vec3 localnorm = mappingNormTransformation * normal; ","#if MAPPING_OPERATOR==1","vUv = localpos.xy;","#elif MAPPING_OPERATOR==2","float radius3d = max(0.000001,length(localpos.xyz));","float z_by_radius3d = localpos.z / radius3d;","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float phiMapping   = asin(z_by_radius3d );","float u=thetaMapping*radius3d;","float v=phiMapping*radius3d;","vUv = vec2(u, v);","#elif MAPPING_OPERATOR==3","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","if(maxima_normal == absolute_normal.x){","vUv = vec2(sign(localnorm.x) * localpos.y, localpos.z );","}","else if(maxima_normal == absolute_normal.y){","vUv = vec2(sign(localnorm.y) * localpos.x, localpos.z );","}","else{","vUv = vec2(sign(localnorm.z) * localpos.x, localpos.y);","}","#elif MAPPING_OPERATOR==4","float radius2d = length(localpos.xy);","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","if(maxima_normal == absolute_normal.z){","vUv = vec2(localpos.x, localpos.y); ","}else{","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0){","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","vUv = vec2(u , localpos.z);","}","#elif MAPPING_OPERATOR==5","float radius2d = length(localpos.xy);","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","vUv = vec2(u, localpos.z);","#endif","vUv = (mappingUVTransformation * vec3(vUv, 1.0)).xy;","#else","localPosition=position;","localNormal=normal;","#endif","#endif","#endif"].join("\n"),uvmapping_fragment:["#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","#if defined (USE_MAPPING_OPERATOR_FRAGMENT) && defined (MAPPING_OPERATOR)","vec3 localpos = (mappingObjTransformation * vec4(localPosition, 1.0)).xyz; ","vec3 localnorm = mappingNormTransformation * localNormal; ","#if MAPPING_OPERATOR==0","uvToUse = vUv;","#elif MAPPING_OPERATOR==1","uvToUse = localpos.xy;","#elif MAPPING_OPERATOR==2","float radius3d = max(0.000001,length(localpos.xyz));","float z_by_radius3d = localpos.z / radius3d;","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float phiMapping   = asin(z_by_radius3d );","float u=thetaMapping*radius3d;","float v=phiMapping*radius3d;","uvToUse = vec2(u, v);","#elif MAPPING_OPERATOR==3","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","if(maxima_normal == absolute_normal.x){","uvToUse = vec2(sign(localnorm.x) * localpos.y, localpos.z );","}","else if(maxima_normal == absolute_normal.y){","uvToUse = vec2(sign(localnorm.y) * localpos.x, localpos.z );","}","else{","uvToUse = vec2(sign(localnorm.z) * localpos.x, localpos.y );","}","#elif MAPPING_OPERATOR==4","float radius2d = length(localpos.xy);","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","uvToUse = vec2(localpos.x, localpos.y); ","if(maxima_normal == absolute_normal.z){","uvToUse = vec2(localpos.x, localpos.y); ","}else{","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0){","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","uvToUse = vec2(u , localpos.z);","}","#elif MAPPING_OPERATOR==5","float radius2d = length(localpos.xy);","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","uvToUse = vec2(u, localpos.z);","#endif","uvToUse = (mappingUVTransformation * vec3(uvToUse, 1.0)).xy;","#endif","#ifdef PDSFX","_uvToUse = uvToUse;","#endif","#endif"].join("\n"),uvmapping_fragment_physical:["#ifdef USE_UV_SLOT_1","uvToUse = vUv;","#if defined (MAPPING_OPERATOR) && defined(USE_MAPPING_OPERATOR_FRAGMENT)","uvToUse = applyMappingOperator(vUv);","#endif","#endif","#ifdef USE_UV_SLOT_2","uv2ToUse = vUv2;","#if defined (MAPPING_OPERATOR) && defined(USE_MAPPING_OPERATOR_FRAGMENT)","uv2ToUse = applyMappingOperator(vUv2);","#endif","#endif"].join("\n"),map_fragment:["#ifdef USE_MAP","#ifdef USE_MAP_HDR","vec2 texelSizeMap = vec2(1.0 / mapHDRSize);","vec4 texelColor = texture2DBilinearFromRGBE( map, uvToUse/*vUv*/, mapHDRSize, texelSizeMap );","#else","vec4 texelColor = texture2D( map, uvToUse/*vUv*/ );","#ifdef GAMMA_INPUT","texelColor.xyz *= texelColor.xyz;","#endif","#endif","gl_FragColor = gl_FragColor * texelColor;","#endif"].join("\n"),lightmap_pars_fragment:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","uniform sampler2D lightMap;","#endif"].join("\n"),lightmap_pars_vertex:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","#endif"].join("\n"),lightmap_fragment:["#ifdef USE_LIGHTMAP","gl_FragColor = gl_FragColor * texture2D( lightMap, vUv2 );","#endif"].join("\n"),lightmap_vertex:["#ifdef USE_LIGHTMAP","vUv2 = uv2;","#endif"].join("\n"),bumpmap_pars_fragment:["#ifdef USE_BUMPMAP","uniform sampler2D bumpMap;","uniform float bumpScale;","vec2 dHdxy_fwd() {","vec2 dSTdx = dFdx( vUv );","vec2 dSTdy = dFdy( vUv );","float Hll = bumpScale * texture2D( bumpMap, vUv ).x;","float dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;","float dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;","return vec2( dBx, dBy );","}","vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {","vec3 vSigmaX = dFdx( surf_pos );","vec3 vSigmaY = dFdy( surf_pos );","vec3 vN = surf_norm;","vec3 R1 = cross( vSigmaY, vN );","vec3 R2 = cross( vN, vSigmaX );","float fDet = dot( vSigmaX, R1 );","vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );","return normalize( abs( fDet ) * surf_norm - vGrad );","}","#endif"].join("\n"),normalmap_pars_fragment:["#ifdef USE_NORMALMAP","const float horizonFade = 1.3;","uniform sampler2D normalMap;","uniform vec2 normalScale;","vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {","vec3 q0 = dFdx( eye_pos.xyz );","vec3 q1 = dFdy( eye_pos.xyz );","vec2 st0 = dFdx( uvToUse.st );","vec2 st1 = dFdy( uvToUse.st );","float alphaT = step(0.00001, abs(st0.y) + abs(st1.y));","float alphaB = step(0.00001, abs(st0.x) + abs(st1.x));","float alphaBT = 1.0 - max(alphaB, alphaT);","st0.y = alphaT * st0.y - (1.0 - alphaT)*(alphaB * st1.x);","st1.y = alphaT * st1.y + (1.0 - alphaT)*(alphaB * st0.x) + alphaBT;","st0.x = alphaB * st0.x - (1.0 - alphaB)*(alphaT * st1.y) + alphaBT;","st1.x = alphaB * st1.x + (1.0 - alphaB)*(alphaT * st0.y);","vec3 S = normalize(  q0 * st1.t - q1 * st0.t );","vec3 T = normalize( -q0 * st1.s + q1 * st0.s );","vec3 N = normalize( surf_norm );","vec3 mapN = texture2D( normalMap, uvToUse/*vUv*/ ).xyz * 2.0 - 1.0;","mapN.xy = normalScale * mapN.xy;","#ifdef NORMALFLIPY","mapN.y = - mapN.y;","#endif","mat3 tsn = mat3( S, T, N );","return normalize( tsn * mapN );","}","vec3 perturbNormal3Arb( vec3 surf_norm, vec3 surf_tgt, vec3 surf_binorm, vec2 normalUV ) {","vec3 N = normalize(surf_norm);","vec3 T = normalize(surf_tgt);","T = normalize(T - dot(T, N) * N);","vec3 B = normalize(surf_binorm);","vec3 mapN = texture2D( normalMap, normalUV ).xyz * 2.0 - 1.0;","#ifdef NORMALFLIPY","mapN.y = - mapN.y;","#endif","mapN.xy = normalScale * mapN.xy;","mat3 tbn = mat3(T, B, N);","return normalize(tbn * mapN);","}","#endif"].join("\n"),specularmap_pars_fragment:["#ifdef USE_SPECULARMAP","uniform sampler2D specularMap;","#endif"].join("\n"),specularmap_fragment:["float specularStrength;","#ifdef USE_SPECULARMAP","#ifdef NRE_COMPATIBILITY","#if (SPECULARMAP_UV_SLOT == 2)","vec2 specularUV = (specularUvTransform * vec3(uv2ToUse, 1.0)).xy;","#else","vec2 specularUV=(specularUvTransform * vec3( uvToUse, 1.0)).xy ;","#endif","#else","vec2 specularUV=uvToUse;","#endif","vec4 texelSpecular = texture2D( specularMap, specularUV );","specularStrength = texelSpecular.r;","#ifdef PHONG","if (shininessInSpecMap) {","shininessValue = texelSpecular.a;","}","#endif","#else","specularStrength = 1.0;","#endif"].join("\n"),lights_lambert_pars_vertex:["uniform vec3 ambient;","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 ambientLightColor;","#if defined( USE_SH_ENVMAP )","uniform mat4 shFactorsR;","uniform mat4 shFactorsG;","uniform mat4 shFactorsB;","uniform float shScale;","#endif","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","uniform float directionalLightFar[ MAX_DIR_LIGHTS ];","uniform float directionalLightNear[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightInnerAngleCos[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif"].join("\n"),lights_lambert_vertex:["vLightFront = vec3( 0.0 );","#ifdef DOUBLE_SIDED","vLightBack = vec3( 0.0 );","#endif","transformedNormal = normalize( transformedNormal );","#if MAX_DIR_LIGHTS > 0","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, dirVector );","vec3 directionalLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 directionalLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","directionalLightWeighting = mix( directionalLightWeighting, directionalLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","directionalLightWeightingBack = mix( directionalLightWeightingBack, directionalLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += directionalLightColor[ i ] * directionalLightWeighting;","#ifdef DOUBLE_SIDED","vLightBack += directionalLightColor[ i ] * directionalLightWeightingBack;","#endif","}","#endif","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 pointLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 pointLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","pointLightWeighting = mix( pointLightWeighting, pointLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","pointLightWeightingBack = mix( pointLightWeightingBack, pointLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += pointLightColor[ i ] * pointLightWeighting * lDistance;","#ifdef DOUBLE_SIDED","vLightBack += pointLightColor[ i ] * pointLightWeightingBack * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - worldPosition.xyz ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = 1.0 - smoothstep( spotLightInnerAngleCos[ i ],spotLightAngleCos[ i ],spotEffect );","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 spotLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 spotLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","spotLightWeighting = mix( spotLightWeighting, spotLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","spotLightWeightingBack = mix( spotLightWeightingBack, spotLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += spotLightColor[ i ] * spotLightWeighting * lDistance * spotEffect;","#ifdef DOUBLE_SIDED","vLightBack += spotLightColor[ i ] * spotLightWeightingBack * lDistance * spotEffect;","#endif","}","}","#endif","#if MAX_HEMI_LIGHTS > 0","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","float hemiDiffuseWeightBack = -0.5 * dotProduct + 0.5;","vLightFront += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","#ifdef DOUBLE_SIDED","vLightBack += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeightBack );","#endif","}","#endif","#if defined( USE_SH_ENVMAP )","vec3 worldNormalSH = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","worldNormalSH = normalize( worldNormalSH );","vec4 normal4 = vec4(worldNormalSH, 1.0);","vec3 shDiffuse;","shDiffuse.r = dot(normal4,(shFactorsR * normal4));","shDiffuse.g = dot(normal4,(shFactorsG * normal4));","shDiffuse.b = dot(normal4,(shFactorsB * normal4));","vLightFront += shScale * shDiffuse;","#endif","vLightFront = vLightFront * diffuse + ambient * ambientLightColor + emissive;","#ifdef DOUBLE_SIDED","vLightBack = vLightBack * diffuse + ambient * ambientLightColor + emissive;","#endif"].join("\n"),lights_phong_pars_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( ENV_MAP ) || defined(USE_SHADOWMAP_CUBE)","varying vec3 vWorldPosition;","#endif","#ifdef USE_SH_ENVMAP","varying vec3 vWorldNormal;","#endif"].join("\n"),lights_phong_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","vPointLight[ i ] = vec4( lVector, lDistance );","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","vSpotLight[ i ] = vec4( lVector, lDistance );","}","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( ENV_MAP ) || defined(USE_SHADOWMAP_CUBE)","vWorldPosition = worldPosition.xyz;","#endif","#ifdef USE_SH_ENVMAP","vWorldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","vWorldNormal = normalize( vWorldNormal );","#endif"].join("\n"),lights_phong_pars_fragment:["uniform vec3 ambientLightColor;","#if defined( USE_SH_ENVMAP )","uniform mat4 shFactorsR;","uniform mat4 shFactorsG;","uniform mat4 shFactorsB;","uniform float shScale;","varying vec3 vWorldNormal;","#endif","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","uniform float directionalLightFar[ MAX_DIR_LIGHTS ];","uniform float directionalLightNear[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#else","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightInnerAngleCos[ MAX_SPOT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#else","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined(USE_SHADOWMAP_CUBE)","varying vec3 vWorldPosition;","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","#ifndef PDSFX","varying vec3 vViewPosition;","#else","vec3 vViewPosition;","#endif","varying vec3 vNormal;"].join("\n"),lights_phong_fragment:["#ifdef PDSFX","vec3 normal = _DSvNormal;","#else","vec3 normal = normalize( vNormal );","#endif","vec3 viewPosition = normalize( vViewPosition );","#ifdef DOUBLE_SIDED","normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","#ifdef USE_NORMALMAP","normal = perturbNormal2Arb( -vViewPosition, normal );","#elif defined( USE_BUMPMAP )","normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","#endif","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse  = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vPointLight[ i ].xyz );","float lDistance = vPointLight[ i ].w;","#endif","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dotProduct, 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dotProduct, 0.0 );","#endif","pointDiffuse  += diffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;","vec3 pointHalfVector = normalize( lVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularStrength * max( pow( pointDotNormalHalf, shininessValue ), 0.0 );","pointSpecular += specular * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance;","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse  = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vSpotLight[ i ].xyz );","float lDistance = vSpotLight[ i ].w;","#endif","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = 1.0 - smoothstep( spotLightInnerAngleCos[ i ],spotLightAngleCos[ i ],spotEffect );","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dotProduct, 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dotProduct, 0.0 );","#endif","spotDiffuse += diffuse * spotLightColor[ i ] * spotDiffuseWeight * lDistance * spotEffect;","vec3 spotHalfVector = normalize( lVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularStrength * max( pow( spotDotNormalHalf, shininessValue ), 0.0 );","spotSpecular += specular * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * spotEffect;","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, dirVector );","#ifdef WRAP_AROUND","float dirDiffuseWeightFull = max( dotProduct, 0.0 );","float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dotProduct, 0.0 );","#endif","dirDiffuse  += diffuse * directionalLightColor[ i ] * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininessValue ), 0.0 );","dirSpecular += specular * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight;","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += diffuse * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularStrength * max( pow( hemiDotNormalHalfSky, shininessValue ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularStrength * max( pow( hemiDotNormalHalfGround, shininessValue ), 0.0 );","hemiSpecular += specular * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#if defined( USE_SH_ENVMAP )","vec4 normal4 = vec4(vWorldNormal, 1.0);","#ifdef DOUBLE_SIDED","normal4.xyz = normal4.xyz * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","vec3 shDiffuse;","shDiffuse.r = dot(normal4,(shFactorsR * normal4));","shDiffuse.g = dot(normal4,(shFactorsG * normal4));","shDiffuse.b = dot(normal4,(shFactorsB * normal4));","totalDiffuse += shScale * diffuse * shDiffuse;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient + totalSpecular );","#else","#ifdef TEXTURE_BLENDING","vec4 texture = vec4( 1.0 );","#ifdef USE_MAP","texture = texelColor;","#endif","#if TEXTURE_BLENDING == 3","#if TEXTURE_FORMAT == 1021","gl_FragColor.a = texture.a;","#endif","#else","#if TEXTURE_BLENDING == 1","gl_FragColor.xyz = texture.xyz * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif","#if TEXTURE_BLENDING == 0","gl_FragColor.xyz = ((1.0-texture.a) * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular) + (texture.a * texture.xyz);","#endif","#if TEXTURE_BLENDING == 2","gl_FragColor.xyz = ((1.0-texture.xyz) * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular) + texture.xyz;","#endif","#endif","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif","#endif"].join("\n"),lights_phong_firstdironly_fragment:["vec3 normal = normalize( vNormal );","vec3 viewPosition = normalize( vViewPosition );","#ifdef DOUBLE_SIDED","normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","#ifdef USE_NORMALMAP","normal = perturbNormal2Arb( -vViewPosition, normal );","#elif defined( USE_BUMPMAP )","normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ 0 ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, dirVector );","#ifdef WRAP_AROUND","float dirDiffuseWeightFull = max( dotProduct, 0.0 );","float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dotProduct, 0.0 );","#endif","dirDiffuse  += diffuse * 3.0 * directionalLightColor[ 0 ] * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininess ), 0.0 );","dirSpecular += specular * directionalLightColor[ 0 ] * dirSpecularWeight * dirDiffuseWeight;","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if defined( USE_SH_ENVMAP )","vec4 normal4 = vec4(vWorldNormal, 1.0);","#ifdef DOUBLE_SIDED","normal4.xyz = normal4.xyz * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","vec3 shDiffuse;","shDiffuse.r = dot(normal4,(shFactorsR * normal4));","shDiffuse.g = dot(normal4,(shFactorsG * normal4));","shDiffuse.b = dot(normal4,(shFactorsB * normal4));","totalDiffuse += shScale * diffuse * shDiffuse;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient + totalSpecular );","#else","#ifdef TEXTURE_BLENDING","vec4 texture = vec4( 1.0 );","#ifdef USE_MAP","texture = texelColor;","#endif","#if TEXTURE_BLENDING == 3","#if TEXTURE_FORMAT == 1021","gl_FragColor.a = texture.a;","#endif","#else","#if TEXTURE_BLENDING == 1","gl_FragColor.xyz = texture.xyz * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif","#if TEXTURE_BLENDING == 0","gl_FragColor.xyz = ((1.0-texture.a) * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular) + (texture.a * texture.xyz);","#endif","#if TEXTURE_BLENDING == 2","gl_FragColor.xyz = ((1.0-texture.xyz) * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular) + texture.xyz;","#endif","#endif","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif","#endif"].join("\n"),color_pars_fragment:["#ifdef USE_COLOR","varying vec4 vColor;","#endif"].join("\n"),color_fragment:["#ifdef USE_COLOR","#ifdef USE_COLOR_RGB","gl_FragColor.xyz *= vColor.xyz;","#elif defined( USE_COLOR_A )","gl_FragColor.w *= vColor.w;","#else","gl_FragColor *= vColor;","#endif","#endif"].join("\n"),color_pars_vertex:["#ifdef USE_COLOR","varying vec4 vColor;","#endif"].join("\n"),color_vertex:["#ifdef USE_COLOR","#ifdef GAMMA_INPUT","vColor = color * color;","#else","vColor = color;","#endif","#endif"].join("\n"),skinning_pars_vertex:["#ifdef USE_SKINNING","#ifdef USE_SKINNING_ANGLES","mat4 getMatrixFromEulerAngles(const in vec3 angles, const in vec3 offset) {","float cosx = cos(angles.y);","float cosy = cos(angles.z);","float cosz = cos(angles.x);","float sinx = sin(angles.y);","float siny = sin(angles.z);","float sinz = sin(angles.x);","float a11, a12, a13, a21, a22, a23, a31, a32, a33;","float cosycosz = cosy*cosz;","float sinxsiny = sinx*siny;","a11 = cosycosz - sinxsiny*sinz;","a12 = -cosx*sinz;","a13 = cosz*siny + cosy*sinx*sinz;","a21 = cosz*sinxsiny + cosy*sinz;","a22 = cosx*cosz;","a23 = siny*sinz - cosycosz*sinx;","a31 = -cosx*siny;","a32 = sinx;","a33 = cosx*cosy;","mat4 bone = mat4(","vec4(a11, a21, a31, 0.0),","vec4(a12, a22, a32, 0.0),","vec4(a13, a23, a33, 0.0),","vec4(offset, 1.0));","return bone;","}","#endif","#ifdef IS_MULTI_INSTANCED","uniform sampler2D skinningInstancingMaps[NB_INSTANCING_SKIN_MAPS];","mat4 getBoneMatrix( const in float i ) {","if (i >= 0.0) {","float real_instanceId = instanceId/5.0 -1.0;","#ifdef USE_SKINNING_ANGLES","float matId = real_instanceId * NB_BONES * 2.0 + 2.0 * i;","#else","float matId = real_instanceId * NB_BONES * 4.0 + 4.0 * i;","#endif","int texId = int(floor(matId/(MAX_MAP_SIZE*MAX_MAP_SIZE)));","float dx, dy;","float x, y;","float xyInTex = matId - float(texId) * (MAX_MAP_SIZE*MAX_MAP_SIZE);","if (texId == NB_INSTANCING_SKIN_MAPS - 1) {","dx = 1.0 / LAST_INSTANCING_SKIN_MAP_SIZE_X;","dy = 1.0 / LAST_INSTANCING_SKIN_MAP_SIZE_Y;","y = floor(xyInTex/LAST_INSTANCING_SKIN_MAP_SIZE_X);","x = xyInTex - y*LAST_INSTANCING_SKIN_MAP_SIZE_X;","} else {","dx = 1.0 / MAX_MAP_SIZE;","dy = 1.0 / MAX_MAP_SIZE;","y = floor(xyInTex/MAX_MAP_SIZE);","x = xyInTex - y*MAX_MAP_SIZE;","}","vec3 v0, v1, v2, v3;","for (int j = 0; j < NB_INSTANCING_SKIN_MAPS; j++) {","if (texId == j) {","v0 = texture2D( skinningInstancingMaps[j], vec2( dx * ( x + 0.5 ), dy * ( y + 0.5 ) ) ).xyz;","v1 = texture2D( skinningInstancingMaps[j], vec2( dx * ( x + 1.5 ), dy * ( y + 0.5 ) ) ).xyz;","#ifndef USE_SKINNING_ANGLES","v2 = texture2D( skinningInstancingMaps[j], vec2( dx * ( x + 2.5 ), dy * ( y + 0.5 ) ) ).xyz;","v3 = texture2D( skinningInstancingMaps[j], vec2( dx * ( x + 3.5 ), dy * ( y + 0.5 ) ) ).xyz;","#endif","break;","}","}","#ifdef USE_SKINNING_ANGLES","vec3 offset = v0;","vec3 angles = v1;","mat4 bone = getMatrixFromEulerAngles(angles, offset);","#else","mat4 bone = mat4(vec4(v0, 0.0), vec4(v1, 0.0), vec4(v2, 0.0), vec4(v3, 1.0));","#endif","return bone;","} else ","return mat4(1.0);","}","#else","uniform sampler2D skinningMap;","mat4 getBoneMatrix( const in float i ) {","if (i >= 0.0) {","#ifdef USE_SKINNING_ANGLES","float j = i * 2.0;","#else","float j = i * 4.0;","#endif","float x = mod( j, N_BONE_PIXEL_X );","float y = floor( j / N_BONE_PIXEL_X );","const float dx = 1.0 / N_BONE_PIXEL_X;","const float dy = 1.0 / N_BONE_PIXEL_Y;","y = dy * ( y + 0.5 );","vec3 v0 = texture2D( skinningMap, vec2( dx * ( x + 0.5 ), y ) ).xyz;","vec3 v1 = texture2D( skinningMap, vec2( dx * ( x + 1.5 ), y ) ).xyz;","#ifndef USE_SKINNING_ANGLES","vec3 v2 = texture2D( skinningMap, vec2( dx * ( x + 2.5 ), y ) ).xyz;","vec3 v3 = texture2D( skinningMap, vec2( dx * ( x + 3.5 ), y ) ).xyz;","#endif","#ifdef USE_SKINNING_ANGLES","vec3 offset = v0;","vec3 angles = v1;","mat4 bone = getMatrixFromEulerAngles(angles, offset);","#else","mat4 bone = mat4(vec4(v0, 0.0), vec4(v1, 0.0), vec4(v2, 0.0), vec4(v3, 1.0));","#endif","return bone;","} else ","return mat4(1.0);","}","#endif","#endif"].join("\n"),skinbase_vertex:["#ifdef USE_SKINNING","mat4 boneMatX = getBoneMatrix( skinIndex.x );","mat4 boneMatY = getBoneMatrix( skinIndex.y );","mat4 boneMatZ = getBoneMatrix( skinIndex.z );","mat4 boneMatW = getBoneMatrix( skinIndex.w );","mat4 skinMatrix = skinWeight.x * boneMatX;","skinMatrix 	+= skinWeight.y * boneMatY;","skinMatrix 	+= skinWeight.z * boneMatZ;","skinMatrix 	+= skinWeight.w * boneMatW;","#endif"].join("\n"),skinning_vertex:["#ifdef USE_SKINNING","#ifdef USE_MORPHTARGETS","vec4 skinVertex = vec4( morphed, 1.0 );","#else","vec4 skinVertex = vec4( position, 1.0 );","#endif","vec4 skinned  = skinMatrix * skinVertex;","#endif"].join("\n"),morphtarget_pars_vertex:["#ifdef USE_MORPHTARGETS","#ifndef USE_MORPHNORMALS","uniform float morphTargetInfluences[ 8 ];","#else","uniform float morphTargetInfluences[ 4 ];","#endif","#endif"].join("\n"),morphtarget_vertex:["#ifdef USE_MORPHTARGETS","vec3 morphed = vec3( 0.0 );","morphed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];","morphed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];","morphed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];","morphed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];","#ifndef USE_MORPHNORMALS","morphed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];","morphed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];","morphed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];","morphed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];","#endif","morphed += position;","#endif"].join("\n"),displacement_vertex:["#ifdef USE_DISPLACEMENTMAP","vec3 dv = texture2D( displacementMap, uv ).xyz;","float df = displacementScale * dv.x + displacementBias;","#ifdef USE_SKINNING","vec3 displacedPosition = skinned.xyz + normalize( skinnedNormal.xyz ) * df;","#else","vec3 displacedPosition = position + normalize( normal ) * df;","#endif","#endif"].join("\n"),default_vertex:["vec4 mvPosition;","#ifdef USE_SKINNING",s._DefaultShaderChunk.getModelViewTransformationChunk("mvPosition","skinned"),"#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHTARGETS ) && !defined( USE_DISPLACEMENTMAP )",s._DefaultShaderChunk.getModelViewTransformationChunk("mvPosition","vec4( morphed, 1.0 )"),"#endif","#if defined(USE_DISPLACEMENTMAP)",s._DefaultShaderChunk.getModelViewTransformationChunk("mvPosition","vec4( displacedPosition, 1.0 )"),"#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHTARGETS ) && ! defined( USE_DISPLACEMENTMAP )",s._DefaultShaderChunk.getModelViewTransformationChunk("mvPosition","vec4( position, 1.0 )"),"#endif","#ifdef PDSFX","_viewTangentSpace.Position = mvPosition.xyz;","ProcessViewTangentSpace(_viewTangentSpace);","mvPosition.xyz = _viewTangentSpace.Position;","#ifdef USE_SIZEATTENUATION","mvPosForAttenuation = mvPosition.xyz;","#endif","#if defined(USE_TANGENT) || defined(USE_TANGENT_BINORMAL)","vTangent = _viewTangentSpace.Tangent;","#ifdef USE_TANGENT_BINORMAL","vBinormal = _viewTangentSpace.Binormal;","#endif","#endif","#endif","gl_Position = projectionMatrix * mvPosition;",].join("\n"),clip_pars_vertex:["#ifdef USE_CLIPPINGPLANES","#if MAX_CLIP_PLANES > 0","uniform lowp int nbClipPlanes;","uniform vec4 clipPlaneEquations[ MAX_CLIP_PLANES ];","varying float clipDist[ MAX_CLIP_PLANES ];","#endif","#endif","#ifdef USE_CLIPPINGPOLYGON","varying vec2 extrusionPlaneUV;","uniform vec3 extrusionPlaneU;","uniform vec3 extrusionPlaneV;","#endif",""].join("\n"),clip_vertex:["#ifdef USE_CLIPPINGPLANES","if(nbClipPlanes > 0) {","clipDist[ 0 ] = dot( mvPosition.xyz, clipPlaneEquations[ 0 ].xyz ) + clipPlaneEquations[ 0 ].w;","clipDist[ 1 ] = dot( mvPosition.xyz, clipPlaneEquations[ 1 ].xyz ) + clipPlaneEquations[ 1 ].w;","clipDist[ 2 ] = dot( mvPosition.xyz, clipPlaneEquations[ 2 ].xyz ) + clipPlaneEquations[ 2 ].w;","clipDist[ 3 ] = dot( mvPosition.xyz, clipPlaneEquations[ 3 ].xyz ) + clipPlaneEquations[ 3 ].w;","clipDist[ 4 ] = dot( mvPosition.xyz, clipPlaneEquations[ 4 ].xyz ) + clipPlaneEquations[ 4 ].w;","clipDist[ 5 ] = dot( mvPosition.xyz, clipPlaneEquations[ 5 ].xyz ) + clipPlaneEquations[ 5 ].w;","}","#endif","#ifdef USE_CLIPPINGPOLYGON","vec3 positionWorld = (modelMatrix*vec4(position.xyz, 1)).xyz;","extrusionPlaneUV = vec2(dot(positionWorld, extrusionPlaneU), dot(positionWorld, extrusionPlaneV));","#endif",""].join("\n"),clip_pars_fragment:["#ifdef USE_CLIPPINGPLANES","#if MAX_CLIP_PLANES > 0","uniform lowp int nbClipPlanes;","varying float clipDist[ MAX_CLIP_PLANES ];","uniform int clipPlaneActive[ MAX_CLIP_PLANES ];","uniform lowp float clipFrontOpacity;","uniform lowp float clipBackOpacity;","#endif","#endif","#ifdef USE_CLIPPINGPOLYGON","uniform sampler2D polygonPoints;","uniform int polygonSize;","varying vec2 extrusionPlaneUV;","vec4 makeColor( const in float r, const in float g, const in float b) { "," return vec4(r,g,b,1.0); }","vec2 getPolygonPoint(const in int index) {","    return texture2D(polygonPoints, vec2((float(index)+0.5)*1.0/float(polygonSize),0.5)).rg;","}","","bool isPointInsidePolygon(const in vec2 point) {","    vec2 previousPoint, currentPoint;","    int i;","    previousPoint = getPolygonPoint(polygonSize-1);","    bool result = false;","    for(int i=0; i < MAX_POLYGON_SIZE;i++) {","        if(i < polygonSize) {","            currentPoint = getPolygonPoint(i);","            if ( ((currentPoint.y>point.y) != (previousPoint.y>point.y)) &&","                 (point.x < (previousPoint.x-currentPoint.x) * (point.y-currentPoint.y) / (previousPoint.y-currentPoint.y) + currentPoint.x) ) {","                result = !result;","            }","            previousPoint = currentPoint;","        }","    }","    return result;","}","#endif",""].join("\n"),clip_fragment:["#ifdef USE_CLIPPINGPLANES","float clipOpacity = -1.0;","if(nbClipPlanes > 0) {","if (0 < nbClipPlanes && clipDist[ 0 ] < 0.0 && clipPlaneActive[ 0 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 0 < nbClipPlanes && clipPlaneActive[ 0 ] > 0) { clipOpacity = clipFrontOpacity; }","if (1 < nbClipPlanes && clipDist[ 1 ] < 0.0 && clipPlaneActive[ 1 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 1 < nbClipPlanes && clipPlaneActive[ 1 ] > 0) { clipOpacity = clipFrontOpacity; }","if (2 < nbClipPlanes && clipDist[ 2 ] < 0.0 && clipPlaneActive[ 2 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 2 < nbClipPlanes && clipPlaneActive[ 2 ] > 0) { clipOpacity = clipFrontOpacity; }","if (3 < nbClipPlanes && clipDist[ 3 ] < 0.0 && clipPlaneActive[ 3 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 3 < nbClipPlanes && clipPlaneActive[ 3 ] > 0) { clipOpacity = clipFrontOpacity; }","if (4 < nbClipPlanes && clipDist[ 4 ] < 0.0 && clipPlaneActive[ 4 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 4 < nbClipPlanes && clipPlaneActive[ 4 ] > 0) { clipOpacity = clipFrontOpacity; }","if (5 < nbClipPlanes && clipDist[ 5 ] < 0.0 && clipPlaneActive[ 5 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 5 < nbClipPlanes && clipPlaneActive[ 5 ] > 0) { clipOpacity = clipFrontOpacity; }","if(clipOpacity == 0.0) discard;","}","#endif","#ifdef USE_CLIPPINGPOLYGON","if(polygonSize > 0) {","  if(!isPointInsidePolygon(extrusionPlaneUV)) {","    discard;","  }","}","#endif",""].join("\n"),iterative_pars_fragment:["#if defined(USE_ITERATION)","uniform int renderIteration;","float random(vec3 scale, float seed) {","  return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","float HaltonSequence(int n, int base) {","float val = 0.0;","float invBase = 1.0 / float(base);","float invBi = invBase;","for (int i = 0; i < 32; i++) {","if (n == 0) break;","float d_i = mod(float(n), float(base));","val += float(d_i) * invBi;","n /= base;","invBi *= invBase;","}","return val;","}","float HaltonSequenceShift(int n, int base, float shift) {","float val = 0.0;","float invBase = 1.0 / float(base);","float invBi = invBase;","for (int i = 0; i < 32; i++) {","if (n == 0) break;","float d_i = mod(float(n), float(base));","val += float(d_i) * invBi;","n /= base;","invBi *= invBase;","}","return fract(val + shift);","}","vec2 LowDiscrepancy2D(int index) {","vec2 res;","res.x = HaltonSequence(index, 2);","res.y = HaltonSequence(index, 5);","return res;","}","vec2 LowDiscrepancy2DShift(int index, vec2 shift) {","vec2 res;","res.x = HaltonSequenceShift(index, 2, shift.x);","res.y = HaltonSequenceShift(index, 5, shift.y);","return res;","}","float Random1D(float seed) {","return random(vec3(12.9898, 78.233, 151.7182), seed);","}","vec2 Random2D(float seed) {","vec2 res;","res.x = random(vec3(12.9898, 78.233, 151.7182), seed);","res.y = random(vec3(63.7264, 10.873, 623.6736), seed);","return res;","}","#endif"].join("\n"),stochastic_transparency_fragment:["#if defined(USE_ITERATION)","float classicAlpha = gl_FragColor.a;","if (classicAlpha < 1.0) {","gl_FragColor.a = 1.0;","float stoch_random = Random1D(float(renderIteration) + vViewPosition.x + vViewPosition.y + vViewPosition.z);","if(stoch_random > classicAlpha) {","discard;","}","}","#endif"].join("\n"),morphnormal_vertex:["#ifdef USE_MORPHNORMALS","vec3 morphedNormal = vec3( 0.0 );","morphedNormal +=  ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];","morphedNormal +=  ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];","morphedNormal +=  ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];","morphedNormal +=  ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];","morphedNormal += normal;","#endif"].join("\n"),skinnormal_vertex:["#ifdef USE_SKINNING","#ifdef USE_MORPHNORMALS","vec4 skinnedNormal = skinMatrix * vec4( morphedNormal, 0.0 );","#else","vec4 skinnedNormal = skinMatrix * vec4( normal, 0.0 );","#endif","#endif"].join("\n"),defaultnormal_vertex:["vec3 objectNormal;","#ifdef USE_SKINNING","objectNormal = skinnedNormal.xyz;","#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHNORMALS )","objectNormal = morphedNormal;","#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHNORMALS )","objectNormal = normal;","#endif","#ifdef FLIP_SIDED","objectNormal = -objectNormal;","#endif","vec3 transformedNormal;","if (use_normal_matrix)","transformedNormal = normalMatrix * objectNormal;","else {",s._DefaultShaderChunk.getModelViewUnitVectorTransformationChunk("transformedNormal","objectNormal"),"}","transformedNormal = normalize(transformedNormal);","#ifdef PDSFX","_viewTangentSpace.Normal = transformedNormal;","#endif",].join("\n"),shadowmap_pars_fragment:["#if defined (USE_SHADOWMAP) || defined(USE_SHADOWMAP_CUBE)","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","float randomValue(vec3 scale, float seed) {","return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","#endif","#ifdef USE_SHADOWMAP","uniform sampler2D shadowMap[ MAX_SHADOWS ];","uniform vec2 shadowMapSize[ MAX_SHADOWS ];","uniform float shadowDarkness[ MAX_SHADOWS ];","uniform float shadowBias[ MAX_SHADOWS ];","#if defined(SHADOWMAP_TYPE_PCF_POISSON) ||defined(SHADOWMAP_TYPE_PCF_INTERPOL)","#if defined(SHADOWMAP_QUALITY_MEDIUM)","uniform vec2 poissonDisk[25];","const int poissonCount = 25;","const float poissonInvSamples = 0.04;","#elif defined(SHADOWMAP_QUALITY_HIGH)","uniform vec2 poissonDisk[49];","const int poissonCount = 49;","const float poissonInvSamples = 0.020408;","#else","uniform vec2 poissonDisk[9];","const int poissonCount = 9;","const float poissonInvSamples = 0.111111;","#endif","#endif","varying vec4 vShadowCoord[ MAX_SHADOWS ];","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","float compESM(sampler2D shadowMap, vec2 coord, float depthFrag) {","float result = texture2D(shadowMap, coord).x * exp(-80.0 * depthFrag);","result *= result * result;","return result;","}","float texture2DESMToPCFCompare(sampler2D shadowMap, vec2 coord, float depthFrag) {","float depthShadowMap = log(texture2D(shadowMap, coord).x) / 80.0;","return step(depthShadowMap, depthFrag);","}","float texture2DShadowESMLerp(sampler2D shadowMap, vec2 shadowMapSize, vec2 shadowPixelSize, vec2 coord, float depthFrag) {","vec2 fractCoord = fract(coord * shadowMapSize + 0.5);","vec2 centroidUV = (coord * shadowMapSize - fractCoord) * shadowPixelSize;","float lb = clamp(compESM(shadowMap, centroidUV, depthFrag), 0.0, 1.0);","float lt = clamp(compESM(shadowMap, centroidUV + vec2(0.0, shadowPixelSize.y), depthFrag), 0.0, 1.0);","float rb = clamp(compESM(shadowMap, centroidUV + vec2(shadowPixelSize.x, 0.0), depthFrag), 0.0, 1.0);","float rt = clamp(compESM(shadowMap, centroidUV + shadowPixelSize, depthFrag), 0.0, 1.0);","float a = mix(lb, lt, fractCoord.y);","float b = mix(rb, rt, fractCoord.y);","return 1.0 - mix(a, b, fractCoord.x);","}","#endif","float texture2DCompare(sampler2D shadowMap, vec2 coord, float depthFrag) {","float depthShadowMap = unpackDepth(texture2D(shadowMap, coord));","return step(depthShadowMap, depthFrag);","}","float texture2DShadowLerp(sampler2D shadowMap, vec2 shadowMapSize, vec2 shadowPixelSize, vec2 coord, float depthFrag) {","vec2 fractCoord = fract(coord * shadowMapSize + 0.5);","vec2 centroidUV = (coord * shadowMapSize - fractCoord) * shadowPixelSize;","float lb = texture2DCompare(shadowMap, centroidUV, depthFrag);","float lt = texture2DCompare(shadowMap, centroidUV + vec2(0.0, shadowPixelSize.y), depthFrag);","float rb = texture2DCompare(shadowMap, centroidUV + vec2(shadowPixelSize.x, 0.0), depthFrag);","float rt = texture2DCompare(shadowMap, centroidUV + shadowPixelSize, depthFrag);","float a = mix(lb, lt, fractCoord.y);","float b = mix(rb, rt, fractCoord.y);","return mix(a, b, fractCoord.x);","}","#if defined( SHADOWMAP_TYPE_PCF )","float getExposurePCF(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize) {","float shadow = 0.0;","#if defined( SHADOWMAP_QUALITY_LOW )","const float shadowDelta = 1.0 / 9.0;","const int fetchCount = 3;","#elif defined( SHADOWMAP_QUALITY_MEDIUM )","const float shadowDelta = 1.0 / 25.0;","const int fetchCount = 5;","#elif defined( SHADOWMAP_QUALITY_HIGH )","const float shadowDelta = 1.0 / 49.0;","const int fetchCount = 7;","#endif","float xPixelOffset = 1.0 / shadowMapSize.x;","float yPixelOffset = 1.0 / shadowMapSize.y;","float dx0 = -1.25 * float((fetchCount-1)/2) *xPixelOffset;","float dy0 = -1.25 * float((fetchCount-1)/2) *yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","float fDepth;","vec2 delta = vec2(dx0,dy0);","for  (int i = 0; i < fetchCount; i ++) {","for  (int j = 0; j < fetchCount; j ++) {","shadow += shadowDelta * texture2DCompare(shadowMap,shadowCoord.xy + delta,shadowCoord.z);","delta.y +=dy1;","}","delta.y =dy0;","delta.x +=dx1;","}","return shadow;","}","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","float getExposurePCFSoft(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize){","float shadow = 0.0;","float xPixelOffset = 1.0 / shadowMapSize.x;","float yPixelOffset = 1.0 / shadowMapSize.y;","float dx0 = -1.0 * xPixelOffset;","float dy0 = -1.0 * yPixelOffset;","float dx1 = 1.0 * xPixelOffset;","float dy1 = 1.0 * yPixelOffset;","mat3 shadowKernel;","vec2 delta = vec2(dx0,dy0);","for  (int i = 0; i < 3; i ++) {","for  (int j = 0; j < 3; j ++) {","shadowKernel[i][j]= 0.25 * texture2DCompare(shadowMap,shadowCoord.xy + delta,shadowCoord.z);","delta.y +=dy1;","}","delta.y =dy0;","delta.x +=dx1;","}","vec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * shadowMapSize.xy );","shadowKernel[0] = mix( shadowKernel[1], shadowKernel[0], fractionalCoord.x );","shadowKernel[1] = mix( shadowKernel[2], shadowKernel[1], fractionalCoord.x );","vec4 shadowValues;","shadowValues.x = mix( shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y );","shadowValues.y = mix( shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y );","shadowValues.z = mix( shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y );","shadowValues.w = mix( shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y );","shadow = dot( shadowValues, vec4( 1.0 ) );","return shadow;","}","#elif defined( SHADOWMAP_TYPE_PCF_INTERPOL )","float getExposurePCFInterpol(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize){","float shadow = 0.0;","const float dimFilter = 4.0;","const float sizeFilter = dimFilter * dimFilter;","const float shadowDelta = 1.0 / sizeFilter;","vec2 shadowPixelSize = 1.0 / shadowMapSize;","for (float xFilter = -0.5 * dimFilter + 0.5; xFilter <= 0.5 * dimFilter; xFilter += 1.0) {","for (float yFilter = -0.5 * dimFilter + 0.5; yFilter <= 0.5 * dimFilter; yFilter += 1.0) {","shadow += texture2DShadowLerp(shadowMap, shadowMapSize, shadowPixelSize, shadowCoord.xy + shadowPixelSize * vec2(xFilter, yFilter), shadowCoord.z);","}","}","shadow *= shadowDelta;","return shadow;","}","#elif defined( SHADOWMAP_TYPE_PCF_POISSON )","float getExposurePCFPoisson(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize) {","float shadow = 0.0;","float xPixelOffset = 1.0/ shadowMapSize.x;","float yPixelOffset = 1.0 / shadowMapSize.y;","float randAngle = randomValue(shadowCoord.xyz,fract(shadowCoord.x*shadowCoord.y)) * 2.0 * 3.14159265359;","for  (int i = 0; i < poissonCount; i ++) {","vec2 p = poissonDisk[i];","float posX = (cos(randAngle)*p.x-sin(randAngle)*p.y)*xPixelOffset;","float posY = (sin(randAngle)*p.x+cos(randAngle)*p.y)*yPixelOffset;","shadow += texture2DCompare(shadowMap,shadowCoord.xy + vec2(posX,posY),shadowCoord.z);","}","shadow *= poissonInvSamples;","return shadow;","}","#elif defined( SHADOWMAP_TYPE_PCF_OPTI )","float getExposurePCFOpti(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize) {","float shadow = 0.0;","vec2 fractCoord = fract(shadowCoord.xy * shadowMapSize + 0.5);","vec2 pixelOffset = vec2(1.0) / shadowMapSize;","vec2 base_uv = (shadowCoord.xy * shadowMapSize - fractCoord) * pixelOffset;","#if defined(SHADOWMAP_QUALITY_LOW)","float uw0 = (3.0 - 2.0 * fractCoord.x);","float uw1 = (1.0 + 2.0 * fractCoord.x);","float u0 = ((2.0 - fractCoord.x) / uw0 - 1.0) * pixelOffset.x;","float u1 = (fractCoord.x / uw1 + 1.0) * pixelOffset.x;","float vw0 = (3.0 - 2.0 * fractCoord.y);","float vw1 = (1.0 + 2.0 * fractCoord.y);","float v0 = ((2.0 - fractCoord.y) / vw0 - 1.0) * pixelOffset.y;","float v1 = (fractCoord.y / vw1 + 1.0) * pixelOffset.y;","shadow += uw0 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v0), shadowCoord.z);","shadow += uw1 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v0), shadowCoord.z);","shadow += uw0 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v1), shadowCoord.z);","shadow += uw1 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v1), shadowCoord.z);","shadow *= 0.0625;","#elif defined(SHADOWMAP_QUALITY_MEDIUM)","float uw0 = (4.0 - 3.0 * fractCoord.x);","float uw1 = 7.0;","float uw2 = (1.0 + 3.0 * fractCoord.x);","float u0 = ((3.0 - 2.0 * fractCoord.x) / uw0 - 2.0) * pixelOffset.x;","float u1 = ((3.0 + fractCoord.x) / uw1) * pixelOffset.x;","float u2 = (fractCoord.x / uw2 + 2.0) * pixelOffset.x;","float vw0 = (4.0 - 3.0 * fractCoord.y);","float vw1 = 7.0;","float vw2 = (1.0 + 3.0 * fractCoord.y);","float v0 = ((3.0 - 2.0 * fractCoord.y) / vw0 - 2.0) * pixelOffset.y;","float v1 = ((3.0 + fractCoord.y) / vw1) * pixelOffset.y;","float v2 = (fractCoord.y / vw2 + 2.0) * pixelOffset.y;","shadow += uw0 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v0), shadowCoord.z);","shadow += uw1 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v0), shadowCoord.z);","shadow += uw2 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v0), shadowCoord.z);","shadow += uw0 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v1), shadowCoord.z);","shadow += uw1 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v1), shadowCoord.z);","shadow += uw2 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v1), shadowCoord.z);","shadow += uw0 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v2), shadowCoord.z);","shadow += uw1 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v2), shadowCoord.z);","shadow += uw2 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v2), shadowCoord.z);","shadow *= 0.0069444;","#elif defined(SHADOWMAP_QUALITY_HIGH)","float uw0 = (5.0 * fractCoord.x - 6.0);","float uw1 = (11.0 * fractCoord.x - 28.0);","float uw2 = -(11.0 * fractCoord.x + 17.0);","float uw3 = -(5.0 * fractCoord.x + 1.0);","float u0 = ((4.0 * fractCoord.x - 5.0) / uw0 - 3.0) * pixelOffset.x;","float u1 = ((4.0 * fractCoord.x - 16.0) / uw1 - 1.0) * pixelOffset.x;","float u2 = (-(7.0 * fractCoord.x + 5.0) / uw2 + 1.0) * pixelOffset.x;","float u3 = (-fractCoord.x / uw3 + 3.0) * pixelOffset.x;","float vw0 = (5.0 *fractCoord.y - 6.0);","float vw1 = (11.0 *fractCoord.y - 28.0);","float vw2 = -(11.0 *fractCoord.y + 17.0);","float vw3 = -(5.0 *fractCoord.y + 1.0);","float v0 = ((4.0 *fractCoord.y - 5.0) / vw0 - 3.0) * pixelOffset.y;","float v1 = ((4.0 *fractCoord.y - 16.0) / vw1 - 1.0) * pixelOffset.y;","float v2 = (-(7.0 *fractCoord.y + 5.0) / vw2 + 1.0) * pixelOffset.y;","float v3 = (-fractCoord.y / vw3 + 3.0) * pixelOffset.y;","shadow += uw0 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v0), shadowCoord.z) ;","shadow += uw1 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v0), shadowCoord.z);","shadow += uw2 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v0), shadowCoord.z);","shadow += uw3 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u3,v0), shadowCoord.z);","shadow += uw0 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v1), shadowCoord.z);","shadow += uw1 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v1), shadowCoord.z);","shadow += uw2 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v1), shadowCoord.z);","shadow += uw3 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u3,v1), shadowCoord.z);","shadow += uw0 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v2), shadowCoord.z);","shadow += uw1 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v2), shadowCoord.z);","shadow += uw2 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v2), shadowCoord.z);","shadow += uw3 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u3,v2), shadowCoord.z);","shadow += uw0 * vw3 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v3), shadowCoord.z);","shadow += uw1 * vw3 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v3), shadowCoord.z);","shadow += uw2 * vw3 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v3), shadowCoord.z);","shadow += uw3 * vw3 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u3,v3), shadowCoord.z);","shadow *= 0.0003698225;","#endif","return shadow;","}","#elif defined( SHADOWMAP_TYPE_ESM )","float getExposureESM(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize) {","float shadow = 0.0;","float depthFragOffset = shadowCoord.z;","shadow = compESM(shadowMap, shadowCoord.xy, depthFragOffset);","float zMaxNeighbor = 0.0;","vec2 pixelOffset = 1.0 / shadowMapSize.xy;","vec2 coordDetect = shadowCoord.xy + vec2(-pixelOffset.x, pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","coordDetect = shadowCoord.xy + vec2(pixelOffset.x, pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","coordDetect = shadowCoord.xy + vec2(-pixelOffset.x, -pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","coordDetect = shadowCoord.xy + vec2(pixelOffset.x, -pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","coordDetect = shadowCoord.xy + vec2(pixelOffset.x, 0.0);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","coordDetect = shadowCoord.xy + vec2(0.0, pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","coordDetect = shadowCoord.xy + vec2(-pixelOffset.x, 0.0);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","coordDetect = shadowCoord.xy + vec2(0.0, -pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","zMaxNeighbor = log(zMaxNeighbor) * 0.0125;","if(zMaxNeighbor < 0.9999999 && (shadowCoord.z + 0.015) < zMaxNeighbor) {","shadow = 0.0;","vec2 fractCoord = fract(shadowCoord.xy * shadowMapSize + 0.5);","vec2 base_uv = (shadowCoord.xy * shadowMapSize - fractCoord) * pixelOffset;","float uw0 = (4.0 - 3.0 * fractCoord.x);","float uw1 = 7.0;","float uw2 = (1.0 + 3.0 * fractCoord.x);","float u0 = ((3.0 - 2.0 * fractCoord.x) / uw0 - 2.0) * pixelOffset.x;","float u1 = ((3.0 + fractCoord.x) / uw1) * pixelOffset.x;","float u2 = (fractCoord.x / uw2 + 2.0) * pixelOffset.x;","float vw0 = (4.0 - 3.0 * fractCoord.y);","float vw1 = 7.0;","float vw2 = (1.0 + 3.0 * fractCoord.y);","float v0 = ((3.0 - 2.0 * fractCoord.y) / vw0 - 2.0) * pixelOffset.y;","float v1 = ((3.0 + fractCoord.y) / vw1) * pixelOffset.y;","float v2 = (fractCoord.y / vw2 + 2.0) * pixelOffset.y;","shadow += uw0 * vw0 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0, v0), depthFragOffset);","shadow += uw1 * vw0 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1, v0), depthFragOffset);","shadow += uw2 * vw0 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2, v0), depthFragOffset);","shadow += uw0 * vw1 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0, v1), depthFragOffset);","shadow += uw1 * vw1 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1, v1), depthFragOffset);","shadow += uw2 * vw1 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2, v1), depthFragOffset);","shadow += uw0 * vw2 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0, v2), depthFragOffset);","shadow += uw1 * vw2 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1, v2), depthFragOffset);","shadow += uw2 * vw2 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2, v2), depthFragOffset);","shadow *= 0.0069444;","shadow = clamp(shadow * 2.0, 0.0, 1.0);","} else {","shadow *= shadow * shadow;","shadow = 1.0 - clamp(shadow, 0.0, 1.0);","}","return shadow;","}","#elif defined( SHADOWMAP_TYPE_ESM_IMPROVED )","float getExposureESMImproved(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize) {","float shadow = 0.0;","float depthFragOffset = shadowCoord.z;","vec2 uv = shadowCoord.xy * shadowMapSize;","vec2 pixelOffset = 1.0 / shadowMapSize.xy;","vec2 base_uv = floor(uv + 0.5);","vec2 fractCoord = uv + 0.5 - base_uv;","base_uv = (base_uv - 0.5) * pixelOffset;","float uw0 = (3.0 - 2.0 * fractCoord.x);","float uw1 = (1.0 + 2.0 * fractCoord.x);","float u0 = ((2.0 - fractCoord.x) / uw0 - 1.0) * pixelOffset.x;","float u1 = (fractCoord.x / uw1 + 1.0 ) * pixelOffset.x;","float vw0 = (3.0 - 2.0 * fractCoord.y);","float vw1 = (1.0 + 2.0 * fractCoord.y);","float v0 = ((2.0 - fractCoord.y) / vw0 - 1.0) * pixelOffset.y;","float v1 = (fractCoord.y / vw1 + 1.0) * pixelOffset.y;","shadow += uw0 * vw0 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0, v0), depthFragOffset);","shadow += uw1 * vw0 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1, v0), depthFragOffset);","shadow += uw0 * vw1 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0, v1), depthFragOffset);","shadow += uw1 * vw1 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1, v1), depthFragOffset);","shadow *= 0.0625;","shadow = clamp(shadow * 1.5, 0.0, 1.0);","return shadow;","}","#endif","float getExposure(vec4 vShadowCoord,sampler2D shadowMap,float shadowBias,vec2 shadowMapSize) {","vec3 shadowCoord = vShadowCoord.xyz / vShadowCoord.w;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );","float exposureResult = 0.0;","bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","bool frustumTest = all( frustumTestVec );","if ( frustumTest ) {","shadowCoord.z += shadowBias;","#if defined( SHADOWMAP_TYPE_PCF )","exposureResult = getExposurePCF(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","exposureResult = getExposurePCFSoft(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_PCF_INTERPOL )","exposureResult = getExposurePCFInterpol(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_PCF_POISSON )","exposureResult = getExposurePCFPoisson(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_PCF_OPTI )","exposureResult = getExposurePCFOpti(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_ESM )","exposureResult = getExposureESM(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_ESM_IMPROVED )","exposureResult = getExposureESMImproved(shadowMap,shadowCoord,shadowMapSize);","#else","exposureResult = texture2DCompare(shadowMap,shadowCoord.xy,shadowCoord.z);","#endif","}","return max(1.0-exposureResult,0.0);","}","#ifdef SHADOWMAP_CASCADE","float getExposureCascaded(vec4 vShadowCoord[MAX_SHADOWS_DIR+MAX_SHADOWS_SPOT],sampler2D shadowMap[MAX_SHADOWS_DIR+MAX_SHADOWS_SPOT],float shadowBias[MAX_SHADOWS_DIR+MAX_SHADOWS_SPOT],vec2 shadowMapSize[MAX_SHADOWS_DIR+MAX_SHADOWS_SPOT]) {","float exposure = 1.0;","int inFrustumCount = 0;","#ifdef SHADOWMAP_DEBUG","vec3 frustumColors[3];","frustumColors[0] = vec3( 1.0, 0.5, 0.0 );","frustumColors[1] = vec3( 0.0, 1.0, 0.8 );","frustumColors[2] = vec3( 0.0, 0.5, 1.0 );","#endif","for( int i = 0; i < MAX_SHADOWS_DIR; i ++ ) {","vec3 shadowCoord = vShadowCoord[i].xyz / vShadowCoord[i].w;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );","bvec2 inFrustumAndZVec = bvec2(inFrustum, shadowCoord.z <= 1.0);","bool inFrustumAndZ = all(inFrustumAndZVec);","inFrustumCount += int( inFrustumAndZ );","bvec2 frustumTestVec = bvec2( inFrustumAndZ, inFrustumCount == 1 );","bool frustumTest = all( frustumTestVec );","if ( frustumTest ) {","exposure = getExposure(vShadowCoord[i],shadowMap[i],shadowBias[i],shadowMapSize[i]);","#ifdef SHADOWMAP_DEBUG","#ifdef SHADOWMAP_CASCADE","if ( frustumTest ) gl_FragColor.xyz *= frustumColors[ i ];","#else","if ( inFrustum ) gl_FragColor.xyz *= frustumColors[ i ];","#endif","#endif","}","}","return exposure;","}","#endif","#endif","#ifdef USE_SHADOWMAP_CUBE","uniform samplerCube shadowMapCube[ MAX_SHADOWS_CUBE ];","uniform float shadowDarknessCube[ MAX_SHADOWS_CUBE ];","uniform float shadowBiasCube[ MAX_SHADOWS_CUBE ];","uniform float shadowNearCube[ MAX_SHADOWS_CUBE ];","uniform float shadowFarCube[ MAX_SHADOWS_CUBE ];","uniform float shadowMapSizeCube[ MAX_SHADOWS_CUBE ];","uniform vec3 shadowPointPosition[ MAX_SHADOWS_CUBE ];","float textureCubeCompare(samplerCube shadowMap, vec3 coord, float depthFrag) {","float depthShadowMap = unpackDepth(textureCube(shadowMap, coord));","return step(depthShadowMap, depthFrag);","}","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","float compESMCube(samplerCube shadowMap, vec3 coord, float depthFrag) {","float result = textureCube(shadowMap, coord).x * exp(-80.0 * depthFrag);","result *= result * result * result * result;","result = clamp(result,0.0,1.0);","return 1.0-result;","}","#endif","#if defined (SHADOWMAP_TYPE_PCF_OPTI) || defined (SHADOWMAP_TYPE_PCF_POISSON) || defined (SHADOWMAP_TYPE_PCF)","float getExposureCubePCF(vec3 normPointVector,float shadowMapSize,samplerCube shadowMapCube,float depth) {","vec3 rndseed = vec3(12.9898,78.233,45.5432);","vec3 randomDir = vec3( dot(normPointVector,rndseed) , dot(normPointVector.yzx,rndseed) , dot(normPointVector.zxy,rndseed) );","randomDir = fract(sin(randomDir) * 43758.5453);","float pixelSize = 2.0 / shadowMapSize;","vec3 xvec = normalize(cross(normPointVector,randomDir))* pixelSize *1.1;","vec3 yvec = normalize(cross(normPointVector,xvec))* pixelSize *1.1;","float inShadow = 0.0;","inShadow += textureCubeCompare(shadowMapCube,normPointVector+xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+xvec-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-xvec-yvec,depth);","#if defined(SHADOWMAP_QUALITY_HIGH) || defined(SHADOWMAP_QUALITY_MEDIUM)","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*xvec-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*xvec-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*yvec+xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*yvec-xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*yvec+xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*yvec-xvec,depth);","#endif","#if defined(SHADOWMAP_QUALITY_HIGH)","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*xvec-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*xvec-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*yvec+xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*yvec-xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*yvec+xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*yvec-xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*xvec+2.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*xvec-2.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*xvec-2.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*xvec+2.0*yvec,depth);","#endif","#if defined(SHADOWMAP_QUALITY_LOW)","inShadow = inShadow/ 8.0;","#elif defined(SHADOWMAP_QUALITY_MEDIUM)","inShadow = inShadow/ 20.0;","#else","inShadow = inShadow/ 36.0;","#endif","return inShadow;","}","#endif","float getExposure(vec3 pointPosition,samplerCube shadowMap,float shadowBias,float shadowMapSize,float shadowNear, float shadowFar) {","vec4 lPosition =  vec4( pointPosition, 1.0 );","vec3 pointVector = vWorldPosition.xyz-lPosition.xyz;","float exposureResult = 0.0;","vec3 absVector = abs(pointVector);","float localZComp = max(absVector.x,max(absVector.y,absVector.z));","float normZComp = (shadowFar+shadowNear)/(shadowFar-shadowNear)-(2.0*shadowFar*shadowNear)/(shadowFar-shadowNear)/localZComp;","normZComp = (normZComp + 1.0) * 0.5;","float depthCube = normZComp +shadowBias;","vec3 normPointVector = normalize( pointVector );","#if defined (SHADOWMAP_TYPE_PCF_OPTI) || defined (SHADOWMAP_TYPE_PCF_POISSON) || defined (SHADOWMAP_TYPE_PCF)","exposureResult = getExposureCubePCF(normPointVector,shadowMapSize,shadowMap,depthCube);","#elif defined (SHADOWMAP_TYPE_ESM)","exposureResult = compESMCube(shadowMap, normPointVector, depthCube);","exposureResult = clamp (shadow,0.0,1.0);","#else","exposureResult = textureCubeCompare(shadowMap,normPointVector,depthCube);","#endif","return 1.0-exposureResult;","}","#endif",].join("\n"),shadowmap_fragment:["float shadowExposure = 1.0;","#if defined(USE_SHADOWMAP) || defined(USE_SHADOWMAP_CUBE)","#ifdef USE_SHADOWMAP","float currentExposure = 1.0;","#ifdef SHADOWMAP_CASCADE","currentExposure  = getExposureCascaded(vShadowCoord,shadowMap,shadowBias,shadowMapSize);","#else","currentExposure = getExposure(vShadowCoord[ 0 ],shadowMap[ 0 ],shadowBias[ 0 ],shadowMapSize[ 0 ]);","#endif","if (currentExposure < 1.0) {","shadowExposure *=1.0 - (shadowDarkness[ 0 ] * (1.0-currentExposure));","}","#ifdef SHADOWMAP_CASCADE","if (MAX_SHADOWS>MAX_SHADOWS_DIR){","for( int i = MAX_SHADOWS_DIR; i < MAX_SHADOWS; i ++ ) {","float currentExposure = 1.0;","currentExposure = getExposure(vShadowCoord[ i ],shadowMap[ i ],shadowBias[ i ],shadowMapSize[ i ]);","if (currentExposure < 1.0) {","shadowExposure *=1.0 - (shadowDarkness[ i ] * (1.0-currentExposure));","}","}","}","#else","if (MAX_SHADOWS>1){","for( int i = 1; i < MAX_SHADOWS; i ++ ) {","float currentExposure = 1.0;","currentExposure = getExposure(vShadowCoord[ i ],shadowMap[ i ],shadowBias[ i ],shadowMapSize[ i ]);","if (currentExposure < 1.0) {","shadowExposure *=1.0 - (shadowDarkness[ i ] * (1.0-currentExposure));","}","}","}","#endif","#endif","#ifdef USE_SHADOWMAP_CUBE","for ( int i = 0; i < MAX_SHADOWS_CUBE; i ++ ) {","float currentExposure = getExposure(shadowPointPosition[ i ],shadowMapCube[ i ],shadowBiasCube[ i ],shadowMapSizeCube[ i ],shadowNearCube[ i ],shadowFarCube[ i ]);","if (currentExposure < 1.0) {","shadowExposure *= 1.0 - (shadowDarknessCube[ i ] * (1.0-currentExposure));","}","}","#endif","#endif","gl_FragColor.xyz *= shadowExposure;",].join("\n"),shadowmap_pars_vertex:["#ifdef USE_SHADOWMAP","varying vec4 vShadowCoord[ MAX_SHADOWS ];","uniform mat4 shadowMatrix[ MAX_SHADOWS ];","#endif"].join("\n"),shadowmap_vertex:["#ifdef USE_SHADOWMAP","#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined( PHYSICALDS ) || defined ( USE_SHADOWMAP )","#ifdef USE_SKINNING","vec4 oldPosition = skinned;","#endif","#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 oldPosition = vec4( morphed, 1.0 );","#endif","#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 oldPosition = vec4( position, 1.0 );","#endif","#endif","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[i]*oldPosition;","}","#endif"].join("\n"),alphatest_fragment:["#if defined(ALPHATEST)","if ( gl_FragColor.a < ALPHATEST ) discard;","#endif"].join("\n"),linear_to_gamma_fragment:["#ifdef GAMMA_OUTPUT","gl_FragColor.xyz = sqrt( gl_FragColor.xyz );","#endif"].join("\n"),oit_pars_vertex:["#ifdef ACCUM_SHADER","   varying float depthOITValue;","#endif"].join("\n"),oit_vertex:["#ifdef ACCUM_SHADER",s._DefaultShaderChunk.getModelViewTransformationChunk("vec4 aux","vec4(position.xyz, 1.0)"),"   depthOITValue = aux.z;","   float normalizeValue;","       float m22 = projectionMatrix[2][2];","       float m32 = projectionMatrix[3][2];","       float near = m32 / (m22 - 1.0);","       float far = ((m22 - 1.0)*near)/(m22 + 1.0);","       normalizeValue = far + near;","   depthOITValue /= 0.5*normalizeValue;","#endif"].join("\n"),oit_pars_fragment:["#ifdef ACCUM_SHADER","   varying float depthOITValue;","   float getOITWeight() {","       float distanceTerm = clamp(0.3/ (1e-3 + pow(depthOITValue,4.0)),1e-3,3e3);","       float alphaTerm = gl_FragColor.a ;","       return alphaTerm*distanceTerm;","   }","#endif"].join("\n"),oit_fragment:["#ifdef USE_OIT","   #if defined(ACCUM_SHADER) || defined(REVEAL_SHADER)","       if (gl_FragColor.a > 1.0 - 1e-2) {","           discard;","       }","   #else","       if (gl_FragColor.a < 1.0 - 1e-2){","           discard;","       }","   #endif","   #if defined(ACCUM_SHADER)","       gl_FragColor = vec4(gl_FragColor.rgb, 1.0)* getOITWeight()* gl_FragColor.a;","   #elif defined(REVEAL_SHADER)","       gl_FragColor.r = gl_FragColor.a;","   #endif","#endif"].join("\n"),utils_paint_fct:["float mi_metallic_paint_o(vec3 X0000002,vec3 X0000003,vec3 X0000004,float X0000005)","{","float X0000006 = 0.0;","vec3 X0000007 = X0000002 - X0000003;","float X0000008 = dot(X0000007, X0000004);","X0000008 *= (X0000008 / (dot(X0000007, X0000007)));","if (X0000008 > 0.0)","{","X0000006 = (exp((((log(X0000008)) * 0.5) * X0000005)));","}","return X0000006;","}","float mi_metallic_paint_o1(float X0000009,float X0000010,float X0000011)","{","float X0000012;","float X0000013;","if (X0000011 <= X0000009)","{","X0000013 = 0.0;","}","else","{","if (X0000011 >= X0000010)","{","X0000013 = 1.0;","}","else","{","X0000012 = ((X0000011 - X0000009) / (X0000010 - X0000009));","X0000013 = ((X0000012 * X0000012) * (3.0 - (2.0 * X0000012)));","}","}","return X0000013;","}"].join("\n"),utils_car_paint_fct:["bool Carpaint_mi_bump(vec4 msl_Carpaint_mi_bump_flakes_1_flake_color_param,vec4 msl_Carpaint_mi_bump_flakes_1_result,vec3 msl_Carpaint_mi_bump_flakes_1_normal_result)","{","float X0000006 = 0.0;","vec3 X0000007 = X0000002 - X0000003;","float X0000008 = dot(X0000007, X0000004);","X0000008 *= (X0000008 / (dot(X0000007, X0000007)));","if (X0000008 > 0.0)","{","X0000006 = (exp((((log(X0000008)) * 0.5) * X0000005)));","}","return X0000006;","}","float mi_metallic_paint_o1(float X0000009,float X0000010,float X0000011)","{","float X0000012;","float X0000013;","if (X0000011 <= X0000009)","{","X0000013 = 0.0;","}","else","{","if (X0000011 >= X0000010)","{","X0000013 = 1.0;","}","else","{","X0000012 = ((X0000011 - X0000009) / (X0000010 - X0000009));","X0000013 = ((X0000012 * X0000012) * (3.0 - (2.0 * X0000012)));","}","}","return X0000013;","}"].join("\n"),utils_fct:["float computeFresnel(vec3 Wi, vec3 Wo, float ior)","{","float rs = pow((ior - 1.0)/(ior + 1.0),2.0);","vec3 h = normalize(Wi+Wo);","float c = dot(Wi,h);","float fresnel = clamp(rs + (1.0 - rs)*pow(1.0 - c,5.0),0.0,1.0);","return fresnel;","}","float getLuminosity(vec3 color)","{","return 0.299*color.x + 0.587*color.y + 0.114*color.z;","}"].join("\n"),basic_pars:["varying vec3 vViewPosition;","varying vec3 vNormal;"].join("\n"),paint_fragment:["vec4 result;","float X0000014 = 3.1415926535897932384626433832795;","float X0000015 = irradiance_weight / X0000014;","bool X0000016;","if (flake_weight > 0.0)","{","	X0000016 = true;","}","else","{","	X0000016 = false;","}","vec4 X0000017;","vec3 X0000018;","vec3 X0000019;","vec3 X0000020;","float X0000021;","float X0000022;","float X0000023;","float global_weight_v = global_weight;","float spec_sec_weight_v = spec_sec_weight;","float spec_weight_v = spec_weight;","float diffuse_bias_v = diffuse_bias;","if (global_weight <= 0.0)","{","global_weight_v = 1.0;","}","if (spec_exp <= 0.0)","{","spec_weight_v = 0.0;","}","if (spec_sec_exp <= 0.0)","{","spec_sec_weight_v = 0.0;","}","if (diffuse_bias < 0.0)","{","diffuse_bias_v = 0.0;","}","X0000019 = mPosition.xyz;","X0000020 = mPosition.xyz;","X0000020 -= X0000019;","X0000021 = (((X0000020.x * X0000020.x) + (X0000020.y * X0000020.y)) + (X0000020.z * X0000020.z));","X0000020 = (normalize(X0000020));","if (edge_color_bias > 0.0)","{","X0000022 = (abs((dot((normal), (viewPosition)))));","X0000022 = (pow(X0000022, edge_color_bias));","X0000023 = (1.0 - X0000022);","X0000017 = ((base_color * X0000022) + (edge_color * X0000023));","}","result = (ambient * X0000017);"].join("\n"),car_paint_fragment:["vec4 result = vec4(0.0,0.0,0.0,0.0);","vec3 msl_local_flake_normal = vec3(0.0,0.0,0.0);","vec4 msl_local_flake_color = vec4(0.0,0.0,0.0,0.0);","float X0000014 = 3.1415926535897932384626433832795;","float X0000015 = irradiance_weight / X0000014;","bool X0000016;","if (flake_weight > 0.0)","{","	X0000016 = true;","}","else","{","	X0000016 = false;","}","vec4 X0000017;","vec3 X0000018;","vec3 X0000019;","vec3 X0000020;","float X0000021;","float X0000022;","float X0000023;","float global_weight_v = global_weight;","float spec_sec_weight_v = spec_sec_weight;","float spec_weight_v = spec_weight;","float diffuse_bias_v = diffuse_bias;","if (global_weight <= 0.0)","{","global_weight_v = 1.0;","}","if (spec_exp <= 0.0)","{","spec_weight_v = 0.0;","}","if (spec_sec_exp <= 0.0)","{","spec_sec_weight_v = 0.0;","}","if (diffuse_bias < 0.0)","{","diffuse_bias_v = 0.0;","}","X0000019 = mPosition.xyz;","X0000020 = mPosition.xyz;","X0000020 -= X0000019;","X0000021 = (((X0000020.x * X0000020.x) + (X0000020.y * X0000020.y)) + (X0000020.z * X0000020.z));","X0000020 = (normalize(X0000020));","if (edge_color_bias > 0.0)","{","X0000022 = (abs((dot((normal), (viewPosition)))));","X0000022 = (pow(X0000022, edge_color_bias));","X0000023 = (1.0 - X0000022);","X0000017 = ((base_color * X0000022) + (edge_color * X0000023));","}","result = (ambient * X0000017);"].join("\n"),tangent_Binormal_pars:["#if defined(USE_TANGENT) || defined(USE_TANGENT_BINORMAL)","varying vec3 vTangent;","#ifdef USE_TANGENT_BINORMAL","varying vec3 vBinormal;","#endif","#endif",].join("\n"),basic_vertex:[s._DefaultShaderChunk.model_view_transformation_vertex,s._DefaultShaderChunk.model_view_normal_vertex,"vNormal = mvNormal;","vViewPosition = normalize(-mvPosition.xyz);","gl_Position = projectionMatrix * mvPosition;"].join("\n"),tangent_Binormal_vertex:["#if defined(USE_TANGENT) || defined(USE_TANGENT_BINORMAL)","#ifdef USE_SKINNING","vec3 objectTangent = vec3(skinMatrix * vec4( tangent, 0.0 ));","#else","vec3 objectTangent = tangent;","#endif","vec3 mvTangent;","if (use_normal_matrix)","mvTangent = normalMatrix * objectTangent;","else {",s._DefaultShaderChunk.getModelViewUnitVectorTransformationChunk("mvTangent","objectTangent"),"}","vTangent = normalize( mvTangent );","#ifdef PDSFX","_viewTangentSpace.Tangent = vTangent;","#endif","#ifdef USE_TANGENT_BINORMAL","#ifdef USE_SKINNING","vec3 objectBinormal = vec3(skinMatrix * vec4( binormal, 0.0 ));","#else","vec3 objectBinormal = binormal;","#endif","vec3 mvBinormal;","if (use_normal_matrix)","mvBinormal = normalMatrix * objectBinormal;","else {",s._DefaultShaderChunk.getModelViewUnitVectorTransformationChunk("mvBinormal","objectBinormal"),"}","vBinormal = normalize( mvBinormal );","#ifdef PDSFX","_viewTangentSpace.Binormal = vTangent;","#endif","#endif","#endif",].join("\n"),mpm_pars:["varying vec3 objectPosition;","varying vec3 objectNormal;","varying vec4 screenPosition;","varying vec2 uv_2;","varying vec3 worldPosition;","varying vec3 worldNormal;","varying vec3 worldTangent;","varying vec3 worldBinormal;","varying vec3 vViewPosition;","varying vec3 vNormal;"].join("\n"),mpm_vertex:["objectPosition = position;","objectNormal = normal;","uv_2 = uv;","vec4 worldPos = modelMatrix * vec4( position, 1.0 );","worldPosition = worldPos.xyz;","worldNormal = normalize(mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * normal);","worldTangent = normalize(mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * tangent);","worldBinormal = normalize(mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * binormal);",s._DefaultShaderChunk.getModelViewTransformationChunk("screenPosition","vec4(position.xyz, 1.0)"),s._DefaultShaderChunk.model_view_transformation_vertex,s._DefaultShaderChunk.model_view_normal_vertex,"vViewPosition = normalize(-mvPosition.xyz);","gl_Position = projectionMatrix * mvPosition;"].join("\n"),mpm_fragment:["const vec3 BASIC_3DS_AXIS_X = vec3( 1.0, 0.0, 0.0 );","const vec3 BASIC_3DS_AXIS_Y = vec3( 0.0, 1.0, 0.0 );","const vec3 BASIC_3DS_AXIS_Z = vec3( 0.0, 0.0, 1.0 );","surface_t surface;","surface.local_position = objectPosition;","surface.position       = worldPosition;","surface.uv             = uv_2;","surface.local_normal     = normalize( objectNormal );","surface.normal     = worldNormal;","surface.normal *= sign( dot( worldNormal, cameraPosition - worldPosition ));","surface.tangent        = normalize( worldTangent );","surface.binormal       = normalize( worldBinormal );","surface.basis[0]       = BASIC_3DS_AXIS_X;","surface.basis[1]       = BASIC_3DS_AXIS_Y;","surface.basis[2]       = BASIC_3DS_AXIS_Z;","camera_t camera;","camera.position   = cameraPosition.xyz;","camera.direction  = normalize( camera.position - surface.position );","mapping_t mapping = compute_information(","mapping_type,","vec2( mapping_scale_u , mapping_scale_v),","vec2( mapping_ratio_u , mapping_ratio_v),","vec2( mapping_offset_u , mapping_offset_v),","vec2( mapping_repeat_u , mapping_repeat_v),","vec2( mapping_flip_u , mapping_flip_v),","mapping_rotation_z,","compute_3dtransformation( ","mapping_world_to_object_position_1st_column,","mapping_world_to_object_position_2nd_column,","mapping_world_to_object_position_3rd_column,","mapping_world_to_object_position_4th_column","),","mapping_world_inverse",");","compute_mapping( mapping, surface );","float displacement = compute_value_greyscale_uniform( surface, default_sp_displacement );","surface.uv -= displacement * compute_parallax( camera, default_slot_height, default_sp_height, Height2D, surface );","float bump         = compute_value_greyscale_uniform( surface, default_sp_bump );","vec2  gradient     = bump * ( compute_value_color( default_slot_normal, surface, default_sp_normal, Normal2D ).xy - vec2( 0.5 ) );","		volume_t volume;","		volume.ior                     = compute_value_greyscale_uniform( surface, default_vp_ior );","		volume.abbe_number             = compute_value_greyscale_uniform( surface, default_vp_abbe_number );","		volume.transparency.color      = compute_value_color_uniform( surface, default_vp_color );","		volume.transparency.absorption = compute_value_greyscale_uniform( surface, default_vp_absorption );","		layer_t layer;","		layer.diffuse.weight           = compute_value_greyscale_uniform( surface, default_generic_brdf_diffuse_weight );","		layer.diffuse.color            = compute_value_color( default_slot_diffuse_color, surface, default_generic_brdf_diffuse_color, Diffuse2D );","		layer.diffuse.glossiness       = compute_value_greyscale_uniform( surface, default_generic_brdf_diffuse_glossiness );","		layer.specular.weight          = compute_value_greyscale_uniform( surface, default_generic_brdf_specular_weight );","		layer.specular.color           = compute_value_color( default_slot_specular_color, surface, default_generic_brdf_specular_color, Specular2D );","		layer.specular.glossiness      = compute_value_greyscale( default_slot_specular_glossiness, surface, default_generic_brdf_specular_glossiness, SpecularGlossiness2D );","		layer.transparency.weight      = compute_value_greyscale( default_slot_transparency, surface, default_generic_btdf_transparency_weight, Transparency2D );","		layer.transparency.color       = layer.diffuse.color;","		layer.transparency.glossiness  = compute_value_greyscale( default_slot_clarity, surface, default_generic_btdf_transparency_glossiness, Clarity2D );","		surface.ambient_occlusion      = compute_value_greyscale( default_slot_ambient_occlusion, surface, default_sp_ambient_occlusion, AmbientOcclusion2D );","		surface.opacity                = compute_value_greyscale( default_slot_opacity          , surface, default_sp_opacity          , Opacity2D );","		surface.normal                 = normalize( surface.normal + gradient.x * surface.tangent + gradient.y * surface.binormal ); /// @NOTE Last to not interfere with texture fetch","		layer.anisotropy               = mix( 0.0, 100.0, compute_value_greyscale_uniform( surface, default_generic_brdf_specular_anisotropy ) );","		float anisotropy_rotation      = PIx2 * compute_value_greyscale( default_slot_specular_anisotropy_direction, surface, default_generic_brdf_specular_anisotropy_rotation, SpecularAnisotropyDirection2D );","		surface.tangent                = cos( anisotropy_rotation ) * surface.tangent + sin( anisotropy_rotation ) * surface.binormal;","		surface.binormal               = cross( surface.normal, surface.tangent );","		camera.reflected               = reflect( - camera.direction, surface.normal );","		float ior                      = compute_value_greyscale_uniform( surface, default_generic_brdf_ior );","		layer.fresnel                  = fresnel( camera.direction, camera.reflected, ior ) * luminosity( layer.specular.weight * layer.specular.color ); /// @NOTE fresnel is computed without taking into accout light or environment illumination","		//contribution_t contribution_environment = environment.compute( camera, surface, layer );","		vec3 normal_openGL    = vec3( surface.normal.x, surface.normal.z, surface.normal.y );","		vec3 reflected_openGL = vec3( camera.reflected.x, camera.reflected.z, camera.reflected.y );","		const float deriv_weight     = 0.5;","		const float glossiness_scale = 100.0;","		const float dd_limit         = 0.002;","		float  glossiness = mix( glossiness_scale, 0.0, pow( layer.specular.glossiness, 2.0 ) );","		vec3 derivative_x        = deriv_weight * dFdx( reflected_openGL );","		vec3 derivative_y        = deriv_weight * dFdy( reflected_openGL );","		vec3 glossiness_mipmap_x = glossiness * clamp( dFdx( normal_openGL ), -vec3( dd_limit ), vec3( dd_limit ) );","		vec3 glossiness_mipmap_y = glossiness * clamp( dFdy( normal_openGL ), -vec3( dd_limit ), vec3( dd_limit ) );","		vec4 contribution_environment_specular = textureCube( IBLSpecular, reflected_openGL, length(glossiness_mipmap_x + derivative_x + glossiness_mipmap_y + derivative_y ));","		if( layer.anisotropy > 0.0 )","		{","			float deriv_anisotropy = min( 0.025 * ( 1.0 - layer.specular.glossiness ) * layer.anisotropy, 0.2 );","			contribution_environment_specular *= 2.0;","			contribution_environment_specular += textureCube( IBLSpecular, normalize( reflected_openGL + deriv_anisotropy * surface.tangent ), length(glossiness_mipmap_x + derivative_x + glossiness_mipmap_y + derivative_y ));","			contribution_environment_specular += textureCube( IBLSpecular, normalize( reflected_openGL - deriv_anisotropy * surface.tangent ), length(glossiness_mipmap_x + derivative_x + glossiness_mipmap_y + derivative_y ));","			contribution_environment_specular *= 0.25;","		}","		vec4 contribution_environment_diffuse = textureCube( IBLDiffuse, normal_openGL );","		contribution_environment.ambient  = contribution_environment.ambient;","		contribution_environment.diffuse  = ( average( contribution_environment_diffuse  ) > 0.0 ? contribution_environment_diffuse  : vec4( 1.0 ) ) * contribution_environment.diffuse;","		contribution_environment.specular = ( average( contribution_environment_specular ) > 0.0 ? contribution_environment_specular : vec4( 1.0 ) ) * contribution_environment.specular;","		float contribution = 1.0;","		float contribution_diffuse;","		float contribution_specular;","		light_t light;","		light.specular = vec4(1.0);","		light.ambient = vec4(0.0);","		contribution_t contribution_light;","		vec4 GlobalAmbientColor = vec4(0.1);","		contribution_light.ambient += GlobalAmbientColor;","		for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","			light.direction = directionalLightDirection[ i ];","			light.diffuse = vec4(directionalLightColor[ i ], 1.0);","			compute_diffuse( camera, surface, light, layer, contribution_diffuse );","			compute_specular( camera, surface, light, layer, contribution_specular );","			contribution_light.ambient  += contribution * light.ambient;","			contribution_light.diffuse  += contribution * light.diffuse * contribution_diffuse;","			contribution_light.specular += contribution * light.specular * contribution_specular;","		}","		illumination_t edf;","		edf.weight         = compute_value_greyscale_uniform( surface, default_generic_edf_diffuse_weight );","		edf.color          = compute_value_color( default_slot_emissive_color, surface, default_generic_edf_diffuse_color, Emissive2D );","		edf.glossiness     = float( 0.0 ); //unsupported","		float  contribution_emission;","		compute_edf( camera, surface, edf, contribution_emission );","		vec4  layer_emission      = contribution_emission * edf.color * clamp( edf.weight, 0.0, 1.0 );","		vec4  layer_reflection    = blend( thin_walled, surface, volume, layer, contribution_light, contribution_environment );","		float opaqueness          = opacity( surface, layer, volume );","		vec4 result = vec4( vec3( layer_emission + layer_reflection ), opaqueness );",].join("\n"),basic_fragment:["float Pi = 3.14159265358979323846264;","vec3 normal = normalize( vNormal );","vec3 viewPosition = normalize( vViewPosition );","normal *= sign( dot( normal, -viewPosition ) );"].join("\n"),tangent_Binormal_fragment:["#if defined(USE_TANGENT) || defined(USE_TANGENT_BINORMAL)","#ifdef PDSFX","vec3 tangent = normalize( _DSviewTangent );","#else","vec3 tangent = normalize( vTangent );","#endif","#ifdef USE_TANGENT_BINORMAL","#ifdef PDSFX","vec3 binormal = normalize( _DSviewBinormal );","#else","vec3 binormal = normalize( vBinormal );","#endif","#else","#ifdef PDSFX","vec3 binormal = cross(_DSvNormal,tangent);","#else","vec3 binormal = cross(normalize(vNormal),tangent);","#endif","#endif","#elif defined (USE_NORMALMAP) || defined(USE_ANISOTROPY) || defined(CLEAR_COAT_BUMPMAP)","vec3 q0 = dFdx( -vViewPosition.xyz );","vec3 q1 = dFdy( -vViewPosition.xyz );","#if defined( NEEDS_UVTOUSE )","vec2 st0 = dFdx( uvToUse/*vUv*/.st );","vec2 st1 = dFdy( uvToUse/*vUv*/.st );","#else","vec2 st0 = vec2(0.0);","vec2 st1 = vec2(0.0);","#endif","float alphaT = step(0.00001, abs(st0.y) + abs(st1.y));","float alphaB = step(0.00001, abs(st0.x) + abs(st1.x));","float alphaBT = 1.0 - max(alphaB, alphaT);","st0.y = alphaT * st0.y - (1.0 - alphaT)*(alphaB * st1.x);","st1.y = alphaT * st1.y + (1.0 - alphaT)*(alphaB * st0.x) + alphaBT;","st0.x = alphaB * st0.x - (1.0 - alphaB)*(alphaT * st1.y) + alphaBT;","st1.x = alphaB * st1.x + (1.0 - alphaB)*(alphaT * st0.y);","vec3 tangent = normalize(  q0 * st1.t - q1 * st0.t );","vec3 binormal = normalize( -q0 * st1.s + q1 * st0.s );","vec3 x = cross(vNormal,tangent);","tangent = normalize(cross(x,vNormal));","x = cross(binormal,vNormal);","binormal = normalize(cross(vNormal,x));","#endif",].join("\n"),illumination_lights_paint_fragment:["vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 direction_fragment_to_light = normalize(- lDirection.xyz );","float dot_nl = dot(direction_fragment_to_light, normal);","vec4 X0000030 = vec4(directionalLightColor[i],1.0) / 3.14159265358979323846;","X0000025 = (vec4(0.0, 0.0, 0.0, 1.0));","if (dot_nl < 0.0)","{","X0000027 = 0.0;","}","else","{","X0000027 = dot_nl;","}","X0000029 = ((pow(X0000027, diffuse_bias_v)) * diffuse_weight);","if (lit_color_bias > 0.0)","{","X0000022 = (pow(X0000027, lit_color_bias));","X0000022 *= (abs((dot((normal), (viewPosition)))));","X0000023 = (1.0 - X0000022);","X0000028 = ((X0000017 * X0000023) + (lit_color * X0000022));","}","else","{","X0000028 = X0000017;","}","X0000025 += ((X0000029 * X0000028) * X0000030);","X0000022 = (pow(X0000027, 0.5));","X0000026 = direction_fragment_to_light;","if (spec_weight_v > 0.0)","{","X0000029 = mi_metallic_paint_o(direction_fragment_to_light, viewPosition, normal, spec_exp);","if (X0000029 > 0.0)","{","if (spec_glazing)","{","X0000029 = mi_metallic_paint_o1(0.5, 0.8, X0000029);","}","X0000029 *= (spec_weight_v * X0000022);","X0000025 += ((X0000029 * spec) * X0000030);","}","}","if (spec_sec_weight_v > 0.0)","{","X0000029 = ((mi_metallic_paint_o(direction_fragment_to_light, viewPosition, normal, spec_sec_exp) * spec_sec_weight_v) * X0000022);","if (X0000029 > 0.0)","{","X0000025 += ((X0000029 * spec_sec) * X0000030);","}","}","result += X0000025;"].join("\n"),illumination_lights_fragment:["vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 direction_fragment_to_light = normalize(- lDirection.xyz );","vec3  direction_fragment_to_camera = -viewPosition;","vec3  reflected_light              = reflect( normalize(lDirection.xyz), normal );","float angle_normal_light           = 0.5 * dot( normal, direction_fragment_to_light  ) + 0.5;","float diffuse_lobe                 = pow( angle_normal_light, diffuse_power );","float diffuse_lobe_normalization   = ( diffuse_power + Pi ) / ( Pi * ( 4.0 - pow( 2.0, -0.5 * diffuse_power  ) ) ) + 0.64;","float diffuse_contribution         = diffuse_lobe * diffuse_lobe_normalization;"].join("\n"),illumination_specular_fragment:["float angle_reflect_light_camera   = 0.5 * dot( reflected_light     , direction_fragment_to_camera ) + 0.5;","float specular_lobe               = pow( angle_reflect_light_camera, specular_power );","float specular_lobe_normalization = ( specular_power + Pi ) / ( Pi * ( 4.0 - pow( 2.0, -0.5 * specular_power ) ) ) + 0.645;","float specular_contribution       = specular_lobe * specular_lobe_normalization;","dirDiffuse  +=  mix( vec3(0.0), directionalLightColor[i], diffuse_contribution );","dirSpecular +=  mix( vec3(0.0), vec3( 1.0 ), specular_contribution );","dirAmbient  +=  mix( vec3(0.0), vec3( 0.0 ), ambient_contribution );"].join("\n"),illumination_specular_anisotropic_fragment:["float specular_contribution = 0.0;","if(anisotropy == 1.0)","{","float angle_reflect_light_camera   = 0.5 * dot( reflected_light     , direction_fragment_to_camera ) + 0.5;","float specular_lobe               = pow( angle_reflect_light_camera, specular_power );","float specular_lobe_normalization = ( specular_power + Pi ) / ( Pi * ( 4.0 - pow( 2.0, -0.5 * specular_power ) ) ) + 0.645;","specular_contribution       = specular_lobe * specular_lobe_normalization;","}","else","{","#ifdef USE_TANGENT_BINORMAL","vec3 N = normal;","vec3 X = cos(anisotropy_rotation)*tangent + sin(anisotropy_rotation)*binormal;","vec3 Y = cross(N,X);","vec3 L = lDirection.xyz;","vec3 C = viewPosition;","vec3 H = normalize(L+C);","float aX = mix(pow(anisotropy,0.1),1.0,refl_gloss);","float aY = mix(pow(1.0/anisotropy,0.1),1.0,refl_gloss);","specular_contribution = (pow(dot(H,X)/aX,2.0) + pow(dot(H,Y)/aY,2.0))/(1.0+dot(H,N));","specular_contribution = exp(-2.0*specular_power*specular_contribution);","specular_contribution *= (specular_power+Pi)/(Pi*(4.0-pow(2.0,-0.5*specular_power))) + 0.645;","#else","float angle_reflect_light_camera   = 0.5 * dot( reflected_light     , direction_fragment_to_camera ) + 0.5;","float specular_lobe               = pow( angle_reflect_light_camera, specular_power );","float specular_lobe_normalization = ( specular_power + Pi ) / ( Pi * ( 4.0 - pow( 2.0, -0.5 * specular_power ) ) ) + 0.645;","specular_contribution       = specular_lobe * specular_lobe_normalization;","#endif","}","dirDiffuse  +=  mix( vec3(0.0), directionalLightColor[i], diffuse_contribution );","dirSpecular +=  mix( vec3(0.0), vec3( 1.0 ), specular_contribution );","dirAmbient  +=  mix( vec3(0.0), vec3( 0.0 ), ambient_contribution );"].join("\n"),fresnel_fragment:["vec3 ref = reflect(viewPosition, normal);","float fresnel = computeFresnel(-viewPosition, ref, refr_ior);","fresnel = mix( fresnel, 1.0, 0.1 * ( refr_ior - 1.0 ) );"].join("\n"),environment_fragment:["dirAmbient += vec3(0.34);","//compute_reflected","vec3 reflected_DS= vReflect;","const mat3 DS_to_OpenGL = mat3(","	0.0, 1.0, 0.0,","	0.0, 0.0,-1.0,","	1.0, 0.0, 0.0",");","vec3 reflected_OpenGL = reflected_DS * DS_to_OpenGL;","vec4 texture_environment_lookup = textureCube(ReflectionCUBEMap,-reflected_OpenGL);","vec3 environment_lookup          = texture_environment_lookup.rgb;"].join("\n"),environment_blur_fragment:["dirAmbient += vec3(0.34);","//compute_reflected","vec3 reflected_DS= vReflect;","const mat3 DS_to_OpenGL = mat3(","	0.0, 1.0, 0.0,","	0.0, 0.0,-1.0,","	1.0, 0.0, 0.0",");","vec3 reflected_OpenGL = reflected_DS * DS_to_OpenGL;","float ddWeight = mix(0.75,0.0,pow(refl_gloss,2.0));","vec3 reflecteddx = ddWeight*dFdx(reflected_OpenGL);","vec3 reflecteddy = ddWeight*dFdy(reflected_OpenGL);","float anisotropyRefl = 1.0/mix(0.3,1.0,pow(refl_gloss,4.0));","float anisotropydd = length(0.5*(reflecteddx+reflecteddy));","float anisotropyWeight = mix(20.0*anisotropydd,0.0,pow(refl_gloss,5.0));","float bias = anisotropydd * anisotropyRefl;","vec4 texture_environment_lookup = textureCube(ReflectionCUBEMap,-reflected_OpenGL,bias );","#ifdef USE_TANGENT_BINORMAL","if(refl_gloss<1.0) {","texture_environment_lookup  += textureCube( ReflectionCUBEMap, normalize(-reflected_OpenGL-anisotropyWeight*tangent),bias );","texture_environment_lookup  += textureCube( ReflectionCUBEMap, normalize(-reflected_OpenGL+anisotropyWeight*tangent),bias );","texture_environment_lookup  += textureCube( ReflectionCUBEMap, normalize(-reflected_OpenGL-anisotropyWeight*binormal),bias  );","texture_environment_lookup  += textureCube( ReflectionCUBEMap, normalize(-reflected_OpenGL+anisotropyWeight*binormal),bias  );","texture_environment_lookup *= 0.2;","}","#endif","vec3 environment_lookup          = texture_environment_lookup.rgb;"].join("\n"),envMaps_pars:["varying vec3 vReflect;"].join("\n"),envMaps_vertex:["vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vec3 objectNormal = normal;","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","worldNormal = normalize( worldNormal );","vec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );","vReflect = reflect( cameraToVertex, worldNormal );"].join("\n"),struct_mpm:["struct surface_t {","vec2 uv;","mat3 basis;","vec3 local_position;","vec3 local_normal;","vec3 position;","vec3 normal;","vec3 tangent;","vec3 binormal;","float height;","float opacity;","float ambient_occlusion;","};","struct camera_t {","vec3 position;","vec3 direction;","vec3 reflected;","};","struct mapping_t {","int type;","vec2 scale;","vec2 offset;","vec2 flip;","vec2 repeat;","mat2 transformation;","mat4 material_local_transformation;","mat4 material_local_transformation_inv;","};","struct volume_transparency_t","{","vec4           color;","float          absorption;","};","struct volume_translucency_t","{","vec4           scattering;","float          absorption;","};","struct volume_t","{","float                 ior;","float                 abbe_number;","volume_transparency_t transparency;","volume_translucency_t translucency;","};","struct illumination_t","{","float weight;","vec4  color;","float glossiness;","};","struct layer_t","{","float          fresnel;","illumination_t diffuse;","illumination_t specular;","float          anisotropy;","illumination_t transparency;","};","struct contribution_t","{","vec4 diffuse;","vec4 specular;","vec4 ambient;","};","struct light_t","{","vec3 position;","vec3 direction;","vec4 ambient;","vec4 diffuse;","vec4 specular;","};",].join("\n"),mapping_mpm:["#define PLANAR_MAPPING               0","#define SPHERICAL_MAPPING            1","#define FINITE_CYLINDRICAL_MAPPING   2","#define CUBICAL_MAPPING              3","#define AUTO_MAPPING                 4","#define ADAPTIVE_MAPPING             5","#define NO_MAPPING                   6","#define HEMI_SPHERICAL_MAPPING       7","#define INFINITE_CYLINDRICAL_MAPPING 8","mat4 compute_3dtransformation_from_column( const in vec4 first, const in vec4 second, const in vec4 third, const in vec4 fourth)","{","return mat4 ( first[0], second[0], third[0], fourth[0],","				first[1], second[1], third[1], fourth[1],","				first[2], second[2], third[2], fourth[2],","				first[3], second[3], third[3], fourth[3]);","}","mat4 compute_3dtransformation_from_row( const in vec4 first, const in vec4 second, const in vec4 third, const in vec4 fourth)","{","return mat4 ( first [0], first [1], first [2], first [3],","				second[0], second[1], second[2], second[3],","				third [0], third [1], third [2], third [3],","				fourth[0], fourth[1], fourth[2], fourth[3]);","}","#define TRANSFORMATION3D_FROM_ROW_VECTOR    1","#define TRANSFORMATION3D_FROM_COLUMN_VECTOR 2","#define TRANSFORMATION3D_STRATEGY   TRANSFORMATION3D_FROM_ROW_VECTOR","mat4 compute_3dtransformation( const in vec4 first, const in vec4 second, const in vec4 third, const in vec4 fourth)","{","#ifdef TRANSFORMATION3D_STRATEGY","	#if TRANSFORMATION3D_STRATEGY == TRANSFORMATION3D_FROM_COLUMN_VECTOR","		return compute_3dtransformation_from_column( first, second, third, fourth );","	#elif TRANSFORMATION3D_STRATEGY == TRANSFORMATION3D_FROM_ROW_VECTOR","		return compute_3dtransformation_from_row( first, second, third, fourth );","	#endif","#endif","return compute_3dtransformation_from_column( first, second, third, fourth );","}","vec3 compute_object_space_position_transformation( const in mapping_t mapping, const in vec3 position)","{","vec3 transformed = (vec4( position, 1.0 ) * mapping.material_local_transformation).xyz;","return transformed;","}","vec3 compute_vector_transformation( const in mapping_t mapping, const in vec3 vector)","{","mat3 vector_transformation = mat3( mapping.material_local_transformation_inv);","vec3 transformed = vector_transformation * vector;","return transformed;","}","mapping_t compute_information(  const in int type,","const in vec2  scale,","const in vec2  ratio,","const in vec2  offset,","const in vec2  repeat,","const in vec2  flip,","const in float angle,","const in mat4  transformation,","const in mat4  inverse_transformation )","{","float cosinus = cos( angle ), sinus = sin( angle );","mapping_t mapping;","mapping.type           = type;","mapping.scale          = vec2( 1.0 ) / ( scale * ratio );","mapping.offset         = ( -1.0 * offset * mapping.scale ) + vec2( 0.5 );","mapping.repeat         = repeat;","mapping.flip           = mix( vec2( 1.0 ), vec2( -1.0 ), flip );","mapping.transformation = mat2(","	mapping.scale.x * mapping.flip.x * cosinus, mapping.scale.x * mapping.flip.y * -sinus,","	mapping.scale.y * mapping.flip.x * sinus  , mapping.scale.y * mapping.flip.y *  cosinus",");","mapping.material_local_transformation = transformation;","mapping.material_local_transformation_inv = inverse_transformation;","return mapping;","}","void compute_transformation( const in mapping_t mapping, inout surface_t surface )","{","surface.uv  = mapping.transformation * surface.uv ;","surface.uv += mapping.offset;","surface.uv  = mix( clamp( surface.uv, vec2( 0.0 ), vec2( 1.0 ) ), surface.uv, vec2( mapping.repeat ) );","}","void compute_transformation_uv( const in mapping_t mapping, inout surface_t surface )","{","surface.uv  = mix( clamp( surface.uv, vec2( 0.0 ), vec2( 1.0 ) ), surface.uv, vec2( mapping.repeat ) );","}","void compute_mapping_spherical( const in mapping_t mapping, inout surface_t surface )","{","float radius3d      = length( surface.local_position.xyz );","float z_by_radius3d = surface.local_position.z / radius3d;","float rho   = radius3d;","float theta = atan( surface.local_position.y, surface.local_position.x ); //azimuth [-PI/2,+PI/2]","float phi   = asin( z_by_radius3d );                      //polar   [-PI,+PI]","vec3 X = surface.basis[0];","vec3 Y = surface.basis[1];","vec3 Z = surface.basis[2];","float cos_theta = cos( theta ), sin_theta = sin( theta ),","cos_phi   = cos( phi   ), sin_phi   = z_by_radius3d;","surface.uv       = vec2( theta, phi ) * vec2( radius3d );","surface.normal   = surface.normal;","surface.tangent  = vec3( - sin_theta * X + cos_theta * Y );","surface.binormal = vec3( - cos_theta * sin_phi * X - sin_theta * sin_phi * Y + cos_phi * Z );","}","void compute_mapping_planar( in mapping_t mapping,  inout surface_t surface )","{","vec3 X = surface.basis[0];","vec3 Y = surface.basis[1];","vec3 Z = surface.basis[2];","surface.uv       = vec2( surface.local_position.xy );","surface.normal   = surface.normal; /* Z */;","surface.tangent  = vec3( Y );","surface.binormal = vec3( X );","}","void compute_mapping_cubical( const in mapping_t mapping, inout surface_t surface )","{","vec3 X = surface.basis[0];","vec3 Y = surface.basis[1];","vec3 Z = surface.basis[2];","float absolute_normal_x = abs( surface.local_normal.x );","float absolute_normal_y = abs( surface.local_normal.y );","float absolute_normal_z = abs( surface.local_normal.z );","float maxima_normal     = max( absolute_normal_x, max( absolute_normal_y, absolute_normal_z ) );","if( maxima_normal == absolute_normal_x )","{","float multiplier = ( surface.local_normal.x > 0.0 ? 1.0 : -1.0 );","surface.uv       = vec2( multiplier * surface.local_position.y, surface.local_position.z );","surface.normal   = surface.normal;","surface.tangent  = vec3( multiplier *  Y );","surface.binormal = vec3( Z );","} ","else if( maxima_normal == absolute_normal_y )","{","float multiplier = ( surface.local_normal.y > 0.0 ? 1.0 : -1.0 );","surface.uv       = vec2( multiplier * surface.local_position.x, surface.local_position.z );","surface.normal   = surface.normal;","surface.tangent  = vec3( multiplier *  X );","surface.binormal = vec3( Z );","}","else /* if( maxima == absolute_z ) */","{","float multiplier = ( surface.local_normal.z > 0.0 ? 1.0 : -1.0 );","surface.uv       = vec2( multiplier * surface.local_position.x, surface.local_position.y );","surface.normal   = surface.normal;","surface.tangent  = vec3( multiplier *  X );","surface.binormal = vec3( Y );","}","}","void compute_mapping_cylindrical_infinite( const in mapping_t mapping, inout surface_t surface )","{","float radius2d      = length( surface.local_position.xy );","float radius3d      = length( surface.local_position.xyz );","float z_by_radius3d = surface.local_position.z / radius3d;","float theta = atan( surface.local_position.y, surface.local_position.x ); //azimuth [-PI/2,+PI/2]","float phi   = asin( z_by_radius3d );                      //polar   [-PI,+PI]","vec3 X = surface.basis[0];","vec3 Y = surface.basis[1];","vec3 Z = surface.basis[2];","float cos_theta = cos( theta ), sin_theta = sin( theta ),","cos_phi   = cos( phi   );","surface.uv       = vec2( theta, surface.local_position.z ) * vec2( radius2d, 1.0 );","surface.normal   = surface.normal; /* vec3( cos_theta * cos_phi * X + sin_theta * cos_phi * Y ) */","surface.tangent  = vec3( - sin_theta * X + cos_theta * Y );","surface.binormal = vec3( Z );","}","void compute_mapping_cylindrical_finite( const in mapping_t mapping, inout surface_t surface )","{","vec3 X = surface.basis[0];","vec3 Y = surface.basis[1];","vec3 Z = surface.basis[2];","float absolute_normal_x = abs( surface.local_normal.x );","float absolute_normal_y = abs( surface.local_normal.y );","float absolute_normal_z = abs( surface.local_normal.z );","float maxima_normal     = max( absolute_normal_x, max( absolute_normal_y, absolute_normal_z ) );","if( maxima_normal == absolute_normal_z )","{","surface.uv       = vec2(( surface.local_normal.z > 0.0 ? 1.0 : -1.0 ) * surface.local_position.x, surface.local_position.y );","surface.normal   = surface.normal;","surface.tangent  = vec3( Y );","surface.binormal = vec3( ( surface.local_normal.z > 0.0 ? 1.0 : -1.0 ) * X );","}","else","{","float radius2d      = length( surface.local_position.xy );","float radius3d      = length( surface.local_position.xyz );","float z_by_radius3d = surface.local_position.z / radius3d;","float theta = atan( surface.local_position.y, surface.local_position.x ); //azimuth [-PI/2,+PI/2]","float phi   = asin( z_by_radius3d );                      //polar   [-PI,+PI]","float cos_theta = cos( theta ), sin_theta = sin( theta ),","  cos_phi   = cos( phi   );","surface.uv       = vec2( theta, surface.local_position.z ) * vec2( radius2d, 1.0 );","surface.normal   = surface.normal; /* vec3( cos_theta * cos_phi * X + sin_theta * cos_phi * Y ) */","surface.tangent  = vec3( - sin_theta * X + cos_theta * Y );","surface.binormal = vec3( Z );","}","}","void compute_mapping( in mapping_t mapping, inout surface_t surface )","{","surface.basis[0] = compute_vector_transformation( mapping, surface.basis[0] );","surface.basis[1] = compute_vector_transformation( mapping, surface.basis[1] );","surface.basis[2] = compute_vector_transformation( mapping, surface.basis[2] );","if( mapping.type == NO_MAPPING )","{","	compute_transformation_uv( mapping, surface );","}","else","{","if     ( mapping.type == SPHERICAL_MAPPING            ) { compute_mapping_spherical( mapping, surface ); }","else if( mapping.type == PLANAR_MAPPING               ) { compute_mapping_planar( mapping, surface ); }","else if( mapping.type == CUBICAL_MAPPING              ) { compute_mapping_cubical( mapping, surface ); }","else if( mapping.type == FINITE_CYLINDRICAL_MAPPING   ) { compute_mapping_cylindrical_finite( mapping, surface ); }","else if( mapping.type == INFINITE_CYLINDRICAL_MAPPING ) { compute_mapping_cylindrical_infinite( mapping, surface ); }","compute_transformation( mapping, surface );","}","}"].join("\n"),blending_mpm:["		vec4 blend( ","			const in float          thin_walled, ","			const in surface_t      surface, ","			const in volume_t       volume, ","			const in layer_t        layer, ","			const in contribution_t light,","			const in contribution_t environment )","		{","			vec4 transparency_mix = layer.transparency.color;","			vec4 diffuse_mix      = layer.diffuse.weight  * layer.diffuse.color * surface.ambient_occlusion;","			vec4 specular_mix     = layer.specular.weight * layer.specular.color;","			const float tonemapping_tweaking_ambient = float( 0.1 );","			/// @NOTE blend with base color on first layer only","			vec4 transparency = mix( volume.transparency.color, vec4( 1.0 ), thin_walled ) * transparency_mix; /// @NOTE transparency contribution shading not supported","			vec4 diffuse      = ( ( light.ambient + environment.ambient ) * tonemapping_tweaking_ambient + ( light.diffuse + environment.diffuse ) ) * diffuse_mix;","			vec4 specular     = ( light.specular + environment.specular ) * specular_mix;","			vec4 core_color   = mix( diffuse, transparency, layer.transparency.weight );","			vec4 reflection   = mix( core_color, specular, layer.fresnel );","			return reflection;","		}",].join("\n"),opacity_mpm:["		float opacity( ","			const in surface_t      surface, ","			const in layer_t        layer, ","			const in volume_t       volume )","		{","			float cutout       = surface.opacity;","			float transparency = luminosity( layer.transparency.weight * layer.transparency.color * volume.transparency.color ) * clamp( 1.0 - layer.fresnel, 0.0, 1.0 );","			return clamp( 1.0 - transparency, 0.0, cutout );","		}",].join("\n"),edf_mpm:["void compute_edf( const in camera_t camera, const in surface_t surface, const in illumination_t edf, out float contribution )","{","const float power = float( 0.1 );","contribution  = 0.5 * dot( camera.direction, surface.normal ) + 0.5;","contribution  = pow( contribution, power );","}",].join("\n"),brdf_mpm:["		void compute_diffuse( const in camera_t camera, const in surface_t surface, const in light_t light, const in layer_t layer, out float contribution )","		{","			float power   = mix( 0.5, 5.0, layer.diffuse.glossiness );","			contribution  = 0.5 * dot( light.direction, surface.normal ) + 0.5;","			contribution  = pow( contribution, power );","			contribution *= ( power + PI ) / ( PI * ( 4.0 - pow( 2.0 , -0.5 * power ) ) ) + 0.64;","		}","		void compute_specular( const in camera_t camera, const in surface_t surface, const in light_t light, const in layer_t layer, out float contribution )","		{","			float power = max( 0.75 * layer.specular.glossiness + 0.25, 0.5 );","			vec3  halff = normalize( light.direction + camera.direction );","			float anisotropy_intensity   = ( layer.anisotropy > 0.0 ) ? mix( 100.0 * layer.anisotropy, 1.0, pow( layer.specular.glossiness, 0.01 ) ) : 1.0;","			vec2  anisotropy_attenuation = vec2( exp( -6.0 * ( power - 0.5 ) ) );","			float dotNL = 0.5 * ( dot( surface.normal, light.direction ) + 1.0 );","			float dotNR = 0.5 * ( dot( surface.normal, camera.reflected ) + 1.0 );","			contribution = exp( -2.0 * ( pow( dot( halff, surface.tangent ) / ( anisotropy_attenuation.x / anisotropy_intensity ), 2.0 ) + pow( dot( halff, surface.binormal ) / anisotropy_attenuation.y, 2.0 ) ) / ( 1.0 + dot( halff, surface.normal ) ) );","			contribution*= dotNL / (  inversesqrt( dotNL * dotNR ) * ( PIx4 * anisotropy_attenuation.x * anisotropy_attenuation.y ) );","		}",].join("\n"),color_mpm:["#define VALUE_NONE    0","#define VALUE_UNIFORM 1","#define VALUE_SPATIAL 2","float compute_value_greyscale_uniform( const in surface_t surface, const in float value )","{","return value;","}","float compute_value_greyscale_spatial( const in surface_t surface, const in sampler2D texture )","{","vec4 texture_fetch = texture2D( texture, surface.uv );","return average( texture_fetch.rgb );","}","float compute_value_greyscale_angular( const in camera_t camera, const in surface_t surface, const in float angle0, const in float angle90 )","{","float angle = max( 0.0, dot( camera.direction, surface.normal ) );","return mix( angle90, angle0, angle );","}","float compute_value_greyscale( const in int type, const in surface_t surface, const in float value, const in sampler2D texture )","{","if     ( type == VALUE_UNIFORM ) { return compute_value_greyscale_uniform( surface, value ); }","else if( type == VALUE_SPATIAL ) { return compute_value_greyscale_spatial( surface, texture ); }","else                             { return 0.0; }","}","vec4 compute_value_color_uniform( const in surface_t surface, const in vec3 value )","{","return vec4( value, 1.0 );","}","vec4 compute_value_color_uniform( const in surface_t surface, const in vec4 value )","{","return value;","}","vec4 compute_value_color_spatial( const in surface_t surface, const in sampler2D texture )","{","return texture2D( texture, surface.uv );","}","vec4 compute_value_color_angular( const in camera_t camera, const in surface_t surface, const in vec3 color0, const in vec3 color90 )","{","float angle = max( 0.0, dot( camera.direction, surface.normal ) );","return vec4( mix( color90, color0, angle ), 1.0 );","}","vec4 compute_value_color_angular( const in camera_t camera, const in surface_t surface, const in vec4 color0, const in vec4 color90 )","{","float angle = max( 0.0, dot( camera.direction, surface.normal ) );","return mix( color90, color0, angle );","}","vec4 compute_value_color_angular( const in camera_t camera, const in surface_t surface, const in sampler2D color0, const in sampler2D color90 )","{","vec4 texture_fetch0  = texture2D( color0, surface.uv );","vec4 texture_fetch90 = texture2D( color90, surface.uv );","float angle = max( 0.0, dot( camera.direction, surface.normal ) );","return mix( texture_fetch90, texture_fetch0, angle );","}","vec4 compute_value_color( const in int type, const in surface_t surface, const in vec3 value, const in sampler2D texture )","{","if     ( type == VALUE_UNIFORM ) { return compute_value_color_uniform( surface, value ); }","else if( type == VALUE_SPATIAL ) { return compute_value_color_spatial( surface, texture ); }","else                             { return vec4(0.0); }","}","vec4 compute_value_color( const in int type, const in surface_t surface, const in vec4 value, const in sampler2D texture )","{","if     ( type == VALUE_UNIFORM ) { return compute_value_color_uniform( surface, value ); }","else if( type == VALUE_SPATIAL ) { return compute_value_color_spatial( surface, texture ); }","else                             { return vec4(0.0); }","}","vec4 compute_value_color_angular( const in int type, const in camera_t camera, const in surface_t surface, const in vec3 color0, const in sampler2D texture0, const in vec3 color90, const in sampler2D texture90 )","{","if     ( type == VALUE_UNIFORM ) { return compute_value_color_angular( camera, surface, color0, color90 ); }","else if( type == VALUE_SPATIAL ) { return compute_value_color_angular( camera, surface, texture0, texture90 ); }","else                             { return vec4(0.0); }","}","vec4 compute_value_color_angular( const in int type, const in camera_t camera, const in surface_t surface, const in vec4 color0, const in sampler2D texture0, const in vec4 color90, const in sampler2D texture90 )","{","if     ( type == VALUE_UNIFORM ) { return compute_value_color_angular( camera, surface, color0, color90 ); }","else if( type == VALUE_SPATIAL ) { return compute_value_color_angular( camera, surface, texture0, texture90 ); }","else                             { return vec4(0.0); }","}",].join("\n"),functions_mpm:["		float sign_with_zero( const in float scalar )","		{","			return scalar > 0.0 ? 1.0 : -1.0;","		}","		float sum( const in vec2 scalar )","		{","			return scalar.x + scalar.y;","		}","		float sum( const in vec3 scalar )","		{","			return scalar.x + scalar.y + scalar.z;","		}","		float sum( const in vec4 scalar )","		{","			return scalar.x + scalar.y + scalar.z + scalar.w;","		}","		float luminosity( const in vec3 color)","		{","			const vec3 coefficient = vec3( 0.299, 0.587, 0.114 );","			return sum( coefficient * color.rgb );","		}","		float luminosity( const in vec4 color)","		{","			const vec3 coefficient = vec3( 0.299, 0.587, 0.114 );","			return sum( coefficient * color.rgb );","		}","		float average( const in vec2 color )","		{","			return sum( color ) / 2.0;","		}","		float average( const in vec3 color )","		{","			return sum( color ) / 3.0;","		}","		float average( const in vec4 color )","		{","			return sum( color.rgb ) / 3.0;","		}","		float fresnel( const in vec3 Wi, const in vec3 Wo, const in float ior)","		{","			float rs = pow((ior - 1.0)/(ior + 1.0),2.0);","			vec3 h = normalize(Wi+Wo);","			float c = dot(Wi,h);","			float fresnel = clamp(rs + (1.0 - rs)*pow(1.0 - c,5.0),0.0,1.0);","			return fresnel;","		}",].join("\n"),constants_mpm:["const float Epsilon = 1e-3;","const float PI      = 3.14159265359;","const float PI_2    = 1.57079632679;","const float PIx2    = 6.28318530718;","const float PIx4    = 12.5663706144;",].join("\n"),parallax_mpm:["vec2 compute_parallax( ","const in camera_t camera, ","const in int height_type, const in float height_uniform, const in sampler2D height_spatial, ","inout surface_t surface ",")","{","const float heightMapRange = 0.15;","float nMinSamples = 12.0;","float nMaxSamples = 150.0;","vec3     vViewWS         = normalize(camera.position - surface.position);","mat3 mWorldToTangent = mat3(surface.tangent, surface.binormal, surface.normal );","vec3     vViewTS         = mWorldToTangent * vViewWS ;","vec2 vParallaxDirection = normalize(vViewTS.xy);","float fLength = length( vViewTS );","float fParallaxLength = sqrt( fLength * fLength - vViewTS.z * vViewTS.z ) / vViewTS.z; ","vec2 vParallaxOffsetTS = vParallaxDirection * fParallaxLength;","vParallaxOffsetTS *= heightMapRange;","float parallax_falloff = clamp(dot(vViewWS,surface.normal),0.0,1.0);","const int nNumSteps = 12;","float fCurrHeight = 0.0;","float fStepSize   = 1.0 / float(nNumSteps);","float fPrevHeight = 1.0;","float fNextHeight = 0.0;","int    nStepIndex = 0;","bool   bCondition = true;","vec2 vTexOffsetPerStep = fStepSize * vParallaxOffsetTS;","float  fCurrentBound     = 1.0;","float  fParallaxAmount   = 0.0;","vec2 pt1;","vec2 pt2;","vec2 texOffset2;","surface_t computed_surface = surface;","for( int nStepIndex = 0; nStepIndex < nNumSteps; nStepIndex ++ ) {","computed_surface.uv -= vTexOffsetPerStep;","float current_height = compute_value_greyscale( height_type, computed_surface, height_uniform, height_spatial );","fCurrHeight = clamp( current_height, Epsilon, 1.0);","fCurrHeight *= 0.9;","fCurrentBound -= fStepSize;","if ( fCurrHeight > fCurrentBound ) ","{     ","pt1 = vec2( fCurrentBound, fCurrHeight );","pt2 = vec2( fCurrentBound + fStepSize, fPrevHeight );","texOffset2 = computed_surface.uv - vTexOffsetPerStep;","break;","}","else","{","fPrevHeight = fCurrHeight;","}","}","float fDelta1 = pt1.x - pt1.y;","float fDelta2 = pt2.x - pt2.y;","fParallaxAmount = (pt1.x * fDelta2 - pt2.x * fDelta1 ) / ( fDelta2 - fDelta1 );","vec2 parallax_offset = vParallaxOffsetTS * (1.0 - fParallaxAmount );","return parallax_offset;","}",].join("\n")};s.UniformsUtils={merge:function(w){var x,z,y,v={};for(x=0;x<w.length;x++){y=this.clone(w[x]);for(z in y){v[z]=y[z]}}return v},mergeNoClone:function(w){var x,z,y,v={};for(x=0;x<w.length;x++){y=w[x];for(z in y){v[z]=y[z]}}return v},clone:function(v){var y,z,A,x,w={};for(y in v){w[y]={};for(z in v[y]){x=v[y][z];if(x instanceof s.Color||x instanceof s.Vector2||x instanceof s.Vector3||x instanceof s.Vector4||x instanceof s.Matrix4){w[y][z]=x.clone()}else{if(x instanceof Array){w[y][z]=x.slice()}else{w[y][z]=x}}}}return w}};s.UniformsLib={common:{diffuse:{type:"c",value:new s.Color(16777215)},opacity:{type:"f",value:1},map:{type:"t",value:null},mapHDRSize:{type:"v2",value:new s.Vector4(2048,1024)},offsetBumpMap:{type:"v2",value:new s.Vector4(0,0)},repeatBumpMap:{type:"v2",value:new s.Vector4(1,1)},lightMap:{type:"t",value:null},specularMap:{type:"t",value:null},envMap:{type:"t",value:null},envMapExposure:{type:"f",value:1},envMapHDRSize:{type:"v2",value:new s.Vector4(2048,1024)},ambienceMatrix:{type:"m4",value:new s.Matrix4()},flipEnvMap:{type:"f",value:1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:0.98},refractionRatioMap:{type:"t",value:null},combine:{type:"i",value:0},morphTargetInfluences:{type:"f",value:0},renderIteration:{type:"i",value:0},mappingNormTransformation:{type:"m3",value:new s.Matrix3()},mappingObjTransformation:{type:"m4",value:new s.Matrix4()},mappingUVTransformation:{type:"m3",value:new s.Matrix3()}},bump:{bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1}},normalmap:{normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new s.Vector2(1,1)}},fog:{fogDensity:{type:"f",value:0.00025},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2000},fogColor:{type:"c",value:new s.Color(16777215)}},lights:{ambientLightColor:{type:"fv",value:[],sceneUniform:true},shFactorsR:{type:"m4",value:new s.Matrix4(),sceneUniform:true},shFactorsG:{type:"m4",value:new s.Matrix4(),sceneUniform:true},shFactorsB:{type:"m4",value:new s.Matrix4(),sceneUniform:true},shScale:{type:"f",value:0.333,sceneUniform:true},directionalLightDirection:{type:"fv",value:[],sceneUniform:true},directionalLightColor:{type:"fv",value:[],sceneUniform:true},directionalLightFar:{type:"fv1",value:[],sceneUniform:true},directionalLightNear:{type:"fv1",value:[],sceneUniform:true},hemisphereLightDirection:{type:"fv",value:[],sceneUniform:true},hemisphereLightSkyColor:{type:"fv",value:[],sceneUniform:true},hemisphereLightGroundColor:{type:"fv",value:[],sceneUniform:true},pointLightColor:{type:"fv",value:[],sceneUniform:true},pointLightPosition:{type:"fv",value:[],sceneUniform:true},pointLightPhysicalAttenuation:{type:"iv",value:[],sceneUniform:true},pointLightDistance:{type:"fv1",value:[],sceneUniform:true},spotLightColor:{type:"fv",value:[],sceneUniform:true},spotLightPosition:{type:"fv",value:[],sceneUniform:true},spotLightDirection:{type:"fv",value:[],sceneUniform:true},spotLightPhysicalAttenuation:{type:"iv",value:[],sceneUniform:true},spotLightDistance:{type:"fv1",value:[],sceneUniform:true},spotLightAngleCos:{type:"fv1",value:[],sceneUniform:true},spotLightInnerAngleCos:{type:"fv1",value:[],sceneUniform:true},iesLightColor:{type:"fv",value:[],sceneUniform:true},iesLightPosition:{type:"fv",value:[],sceneUniform:true},iesLightDistance:{type:"fv1",value:[],sceneUniform:true},iesLightTexture:{type:"tv",value:[],sceneUniform:true},matrixWorldInv:{type:"m4v",value:[],sceneUniform:true},sphereLightColor:{type:"fv",value:[],sceneUniform:true},sphereLightPosition:{type:"fv",value:[],sceneUniform:true},sphereLightData:{type:"fv",value:[],sceneUniform:true},diskLightColor:{type:"fv",value:[],sceneUniform:true},diskLightPosition:{type:"fv",value:[],sceneUniform:true},diskLightData:{type:"fv",value:[],sceneUniform:true},diskLightNormal:{type:"fv",value:[],sceneUniform:true},tubeLightColor:{type:"fv",value:[],sceneUniform:true},tubeLightPosition:{type:"fv",value:[],sceneUniform:true},tubeLightData:{type:"fv",value:[],sceneUniform:true},tubeLightRight:{type:"fv",value:[],sceneUniform:true},areaLightColor:{type:"fv",value:[],sceneUniform:true},areaLightPosition:{type:"fv",value:[],sceneUniform:true},areaLightNormal:{type:"fv",value:[],sceneUniform:true},areaLightRight:{type:"fv",value:[],sceneUniform:true},areaLightUp:{type:"fv",value:[],sceneUniform:true},areaLightData:{type:"fv",value:[],sceneUniform:true},precomputedAreaGGX1texture:{type:"t",value:null,sceneUniform:true},precomputedAreaGGX2texture:{type:"t",value:null,sceneUniform:true},precomputedAreaSheentexture:{type:"t",value:null,sceneUniform:true}},clipPlanes:{nbClipPlanes:{type:"i",value:0,clipPlanesUniform:true},clipPlaneEquations:{type:"fv4",value:[],clipPlanesUniform:true,loadOnlyIfUniformNotZero:"nbClipPlanes"},clipPlaneActive:{type:"iv1",value:[],clipPlanesUniform:true,loadOnlyIfUniformNotZero:"nbClipPlanes"},clipFrontOpacity:{type:"f",value:1,clipPlanesUniform:true,loadOnlyIfUniformNotZero:"nbClipPlanes"},clipBackOpacity:{type:"f",value:0,clipPlanesUniform:true,loadOnlyIfUniformNotZero:"nbClipPlanes"},polygonSize:{type:"i",value:0,clipPlanesUniform:true},polygonPoints:{type:"t",value:null,clipPlanesUniform:true,loadOnlyIfUniformNotZero:"polygonSize"},extrusionPlaneU:{type:"v3",value:new s.Vector3(0,0,1),clipPlanesUniform:true,loadOnlyIfUniformNotZero:"polygonSize"},extrusionPlaneV:{type:"v3",value:new s.Vector3(1,0,0),clipPlanesUniform:true,loadOnlyIfUniformNotZero:"polygonSize"}},particle:{psColor:{type:"c",value:new s.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null},fogDensity:{type:"f",value:0.00025},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2000},fogColor:{type:"c",value:new s.Color(16777215)}},shadowmap:{shadowMap:{type:"tv",value:[],sceneUniform:true},shadowMapSize:{type:"v2v",value:[],sceneUniform:true},shadowBias:{type:"fv1",value:[],sceneUniform:true},shadowDarkness:{type:"fv1",value:[],sceneUniform:true},shadowMapCube:{type:"tcv",value:[],sceneUniform:true},shadowPointPosition:{type:"v3v",value:[],sceneUniform:true},shadowNearCube:{type:"fv1",value:[],sceneUniform:true},shadowFarCube:{type:"fv1",value:[],sceneUniform:true},shadowMapSizeCube:{type:"fv1",value:[],sceneUniform:true},shadowBiasCube:{type:"fv1",value:[],sceneUniform:true},shadowDarknessCube:{type:"fv1",value:[],sceneUniform:true},shadowMatrix:{type:"m4v",value:[],sceneUniform:true},poissonDisk:{type:"v2v",value:[],sceneUniform:true}},lines:{scale:{type:"f",value:1},totalSize:{type:"f",value:0},halfWidth:{type:"f",value:0.5},pixelSize:{type:"v2",value:new s.Vector2(0.01,0.01)},dashPattern:{type:"fv1",value:new Float32Array(2)},patternOffset:{type:"f",value:0}},skinning:{skinningMap:{type:"t",value:null},skinningInstancingMaps:{type:"tv",value:[]}}};s.ShaderLib={basic:{uniforms:s.UniformsUtils.merge([s.UniformsLib.common,s.UniformsLib.fog,s.UniformsLib.shadowmap,s.UniformsLib.clipPlanes,s.UniformsLib.skinning]),vertexShader:[s.ShaderChunk.clip_pars_vertex,s.ShaderChunk.map_pars_vertex,s.ShaderChunk.lightmap_pars_vertex,s.ShaderChunk.envmap_pars_vertex,s.ShaderChunk.color_pars_vertex,s.ShaderChunk.morphtarget_pars_vertex,s.ShaderChunk.skinning_pars_vertex,s.ShaderChunk.shadowmap_pars_vertex,s.ShaderChunk.oit_pars_vertex,"void main() {",s.ShaderChunk.PDSFX_start_vertex,s.ShaderChunk.map_vertex,s.ShaderChunk.lightmap_vertex,s.ShaderChunk.color_vertex,s.ShaderChunk.skinbase_vertex,"#if defined(USE_ENVMAP) || defined(PDSFX)",s.ShaderChunk.morphnormal_vertex,s.ShaderChunk.skinnormal_vertex,s.ShaderChunk.defaultnormal_vertex,"#endif",s.ShaderChunk.morphtarget_vertex,s.ShaderChunk.skinning_vertex,s.ShaderChunk.default_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif",s.ShaderChunk.clip_vertex,s.ShaderChunk.worldpos_vertex,s.ShaderChunk.envmap_vertex,s.ShaderChunk.shadowmap_vertex,s.ShaderChunk.oit_vertex,s.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[s.ShaderChunk.PDSFX_albedo_pars_fragment,s.ShaderChunk.PDSFX_opacity_pars_fragment,"#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","vec2 uvToUse;","#endif",s.ShaderChunk.clip_pars_fragment,s.ShaderChunk.color_pars_fragment,s.ShaderChunk.map_pars_fragment,s.ShaderChunk.lightmap_pars_fragment,s.ShaderChunk.envmap_pars_fragment,s.ShaderChunk.fog_pars_fragment,s.ShaderChunk.shadowmap_pars_fragment,s.ShaderChunk.specularmap_pars_fragment,s.ShaderChunk.oit_pars_fragment,"void main() {","#ifdef PDSFX",s.ShaderChunk.PDSFX_map_fragment,"ComputeCommonValues();",s.ShaderChunk.PDSFX_discard_fragment,s.ShaderChunk.PDSFX_albedo_fragment,s.ShaderChunk.PDSFX_opacity_fragment,"#endif","gl_FragColor = vec4( diffuse, opacity );","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","uvToUse=vUv;","#endif",s.ShaderChunk.clip_fragment,s.ShaderChunk.uvmapping_fragment,s.ShaderChunk.map_fragment,s.ShaderChunk.alphatest_fragment,s.ShaderChunk.specularmap_fragment,s.ShaderChunk.lightmap_fragment,s.ShaderChunk.color_fragment,s.ShaderChunk.envmap_fragment,s.ShaderChunk.shadowmap_fragment,s.ShaderChunk.linear_to_gamma_fragment,s.ShaderChunk.fog_fragment,s.ShaderChunk.oit_fragment,s.ShaderChunk.PDSFX_end_fragment,"}"].join("\n")},lambert:{uniforms:s.UniformsUtils.merge([s.UniformsLib.common,s.UniformsLib.fog,s.UniformsLib.lights,s.UniformsLib.shadowmap,s.UniformsLib.clipPlanes,{ambient:{type:"c",value:new s.Color(16777215)},emissive:{type:"c",value:new s.Color(0)},wrapRGB:{type:"v3",value:new s.Vector3(1,1,1)}},s.UniformsLib.skinning]),vertexShader:["#define LAMBERT","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",s.ShaderChunk.clip_pars_vertex,s.ShaderChunk.map_pars_vertex,s.ShaderChunk.lightmap_pars_vertex,s.ShaderChunk.envmap_pars_vertex,s.ShaderChunk.lights_lambert_pars_vertex,s.ShaderChunk.color_pars_vertex,s.ShaderChunk.morphtarget_pars_vertex,s.ShaderChunk.skinning_pars_vertex,s.ShaderChunk.shadowmap_pars_vertex,s.ShaderChunk.oit_pars_vertex,"void main() {",s.ShaderChunk.PDSFX_start_vertex,s.ShaderChunk.map_vertex,s.ShaderChunk.lightmap_vertex,s.ShaderChunk.color_vertex,s.ShaderChunk.morphnormal_vertex,s.ShaderChunk.skinbase_vertex,s.ShaderChunk.skinnormal_vertex,s.ShaderChunk.defaultnormal_vertex,s.ShaderChunk.morphtarget_vertex,s.ShaderChunk.skinning_vertex,s.ShaderChunk.default_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif",s.ShaderChunk.clip_vertex,s.ShaderChunk.worldpos_vertex,s.ShaderChunk.envmap_vertex,s.ShaderChunk.lights_lambert_vertex,s.ShaderChunk.shadowmap_vertex,s.ShaderChunk.oit_vertex,s.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif","#if defined( NEEDS_UVTOUSE )","vec2 uvToUse;","#endif",s.ShaderChunk.clip_pars_fragment,s.ShaderChunk.iterative_pars_fragment,s.ShaderChunk.color_pars_fragment,s.ShaderChunk.map_pars_fragment,s.ShaderChunk.lightmap_pars_fragment,s.ShaderChunk.envmap_pars_fragment,s.ShaderChunk.fog_pars_fragment,s.ShaderChunk.shadowmap_pars_fragment,s.ShaderChunk.specularmap_pars_fragment,s.ShaderChunk.oit_pars_fragment,"void main() {","#ifdef PDSFX","ComputeCommonValues();","#endif","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","uvToUse=vUv;","#endif",s.ShaderChunk.clip_fragment,s.ShaderChunk.uvmapping_fragment,s.ShaderChunk.map_fragment,s.ShaderChunk.alphatest_fragment,s.ShaderChunk.specularmap_fragment,"#ifdef DOUBLE_SIDED","if ( gl_FrontFacing )","gl_FragColor.xyz *= vLightFront;","else","gl_FragColor.xyz *= vLightBack;","#else","gl_FragColor.xyz *= vLightFront;","#endif",s.ShaderChunk.lightmap_fragment,s.ShaderChunk.color_fragment,s.ShaderChunk.stochastic_transparency_fragment,s.ShaderChunk.envmap_fragment,s.ShaderChunk.shadowmap_fragment,s.ShaderChunk.linear_to_gamma_fragment,s.ShaderChunk.fog_fragment,s.ShaderChunk.oit_fragment,s.ShaderChunk.PDSFX_end_fragment,"}"].join("\n")},phong:{uniforms:s.UniformsUtils.merge([s.UniformsLib.common,s.UniformsLib.bump,s.UniformsLib.normalmap,s.UniformsLib.fog,s.UniformsLib.lights,s.UniformsLib.shadowmap,s.UniformsLib.clipPlanes,{ambient:{type:"c",value:new s.Color(16777215)},emissive:{type:"c",value:new s.Color(0)},specular:{type:"c",value:new s.Color(1118481)},shininess:{type:"f",value:30},shininessInSpecMap:{type:"i",value:0},wrapRGB:{type:"v3",value:new s.Vector3(1,1,1)}},s.UniformsLib.skinning]),vertexShader:["#define PHONG","#ifndef PDSFX","varying vec3 vViewPosition;","#endif","varying vec3 vNormal;",s.ShaderChunk.clip_pars_vertex,s.ShaderChunk.map_pars_vertex,s.ShaderChunk.lightmap_pars_vertex,s.ShaderChunk.envmap_pars_vertex,s.ShaderChunk.lights_phong_pars_vertex,s.ShaderChunk.color_pars_vertex,s.ShaderChunk.morphtarget_pars_vertex,s.ShaderChunk.skinning_pars_vertex,s.ShaderChunk.shadowmap_pars_vertex,s.ShaderChunk.oit_pars_vertex,"void main() {",s.ShaderChunk.PDSFX_start_vertex,s.ShaderChunk.map_vertex,s.ShaderChunk.lightmap_vertex,s.ShaderChunk.color_vertex,s.ShaderChunk.morphnormal_vertex,s.ShaderChunk.skinbase_vertex,s.ShaderChunk.skinnormal_vertex,s.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",s.ShaderChunk.morphtarget_vertex,s.ShaderChunk.skinning_vertex,s.ShaderChunk.default_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif",s.ShaderChunk.clip_vertex,"#ifndef PDSFX","vViewPosition = -mvPosition.xyz;","#endif",s.ShaderChunk.worldpos_vertex,s.ShaderChunk.envmap_vertex,s.ShaderChunk.lights_phong_vertex,s.ShaderChunk.shadowmap_vertex,s.ShaderChunk.oit_vertex,s.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:["#define PHONG",s.ShaderChunk.PDSFX_albedo_pars_fragment,s.ShaderChunk.PDSFX_opacity_pars_fragment,"uniform vec3 ambient;",s.ShaderChunk.PDSFX_emissive_pars_fragment,s.ShaderChunk.PDSFX_specular_pars_fragment,"uniform float shininess;","uniform bool shininessInSpecMap;","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","vec2 uvToUse;","#endif",s.ShaderChunk.clip_pars_fragment,s.ShaderChunk.iterative_pars_fragment,s.ShaderChunk.color_pars_fragment,s.ShaderChunk.map_pars_fragment,s.ShaderChunk.lightmap_pars_fragment,s.ShaderChunk.envmap_pars_fragment,s.ShaderChunk.fog_pars_fragment,s.ShaderChunk.lights_phong_pars_fragment,s.ShaderChunk.shadowmap_pars_fragment,s.ShaderChunk.bumpmap_pars_fragment,s.ShaderChunk.normalmap_pars_fragment,s.ShaderChunk.specularmap_pars_fragment,s.ShaderChunk.oit_pars_fragment,"void main() {","#ifdef PDSFX",s.ShaderChunk.PDSFX_map_fragment,"ComputeCommonValues();",s.ShaderChunk.PDSFX_discard_fragment,s.ShaderChunk.PDSFX_albedo_fragment,s.ShaderChunk.PDSFX_opacity_fragment,s.ShaderChunk.PDSFX_emissive_fragment,s.ShaderChunk.PDSFX_specular_fragment,s.ShaderChunk.PDSFX_viewNormal_fragment,"vViewPosition = -ComputeViewPosition();","#endif","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","uvToUse=vUv;","#endif",s.ShaderChunk.clip_fragment,s.ShaderChunk.uvmapping_fragment,s.ShaderChunk.map_fragment,s.ShaderChunk.alphatest_fragment,"float shininessValue = shininess;",s.ShaderChunk.specularmap_fragment,s.ShaderChunk.lights_phong_fragment,s.ShaderChunk.lightmap_fragment,s.ShaderChunk.color_fragment,s.ShaderChunk.stochastic_transparency_fragment,s.ShaderChunk.envmap_fragment,s.ShaderChunk.shadowmap_fragment,s.ShaderChunk.linear_to_gamma_fragment,s.ShaderChunk.fog_fragment,s.ShaderChunk.oit_fragment,s.ShaderChunk.PDSFX_end_fragment,"}"].join("\n")},particle_basic:{uniforms:s.UniformsUtils.merge([s.UniformsLib.particle,s.UniformsLib.shadowmap,s.UniformsLib.clipPlanes]),vertexShader:["uniform float size;","uniform float scale;",s.ShaderChunk.clip_pars_vertex,s.ShaderChunk.color_pars_vertex,s.ShaderChunk.shadowmap_pars_vertex,"void main() {",s.ShaderChunk.PDSFX_start_particle_vertex,s.ShaderChunk.PDSFX_start_vertex,s.ShaderChunk.color_vertex,"vec4 mvPosition = viewMatrix * (modelMatrix * vec4(position.xyz, 1.0));","#ifdef PDSFX","_viewTangentSpace.Position = mvPosition.xyz;","ProcessViewTangentSpace(_viewTangentSpace);","mvPosition.xyz = _viewTangentSpace.Position;","#ifdef USE_SIZEATTENUATION","mvPosForAttenuation = mvPosition.xyz;","#endif","#endif",s.ShaderChunk.PDSFX_point_size_vertex,"gl_Position = projectionMatrix * mvPosition;",s.ShaderChunk.worldpos_vertex,s.ShaderChunk.shadowmap_vertex,s.ShaderChunk.clip_vertex,s.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:["#ifdef PDSFX","uniform vec3 _DSalbedo;","vec3 psColor;","#else","uniform vec3 psColor;","#endif",s.ShaderChunk.PDSFX_opacity_pars_fragment,"uniform float size;",s.ShaderChunk.clip_pars_fragment,s.ShaderChunk.color_pars_fragment,s.ShaderChunk.map_particle_pars_fragment,s.ShaderChunk.fog_pars_fragment,s.ShaderChunk.shadowmap_pars_fragment,"void main() {","#ifdef PDSFX","_DSsize_ = size;",s.ShaderChunk.PDSFX_map_fragment,"ComputeCommonValues();",s.ShaderChunk.PDSFX_discard_fragment,"_DSalbedo_ = _DSalbedo;","psColor = ComputeAlbedo();",s.ShaderChunk.PDSFX_opacity_fragment,"#endif","gl_FragColor = vec4( psColor, opacity );",s.ShaderChunk.clip_fragment,s.ShaderChunk.map_particle_fragment,s.ShaderChunk.alphatest_fragment,s.ShaderChunk.color_fragment,s.ShaderChunk.shadowmap_fragment,s.ShaderChunk.fog_fragment,s.ShaderChunk.PDSFX_end_fragment,"}"].join("\n")},line:{uniforms:s.UniformsUtils.merge([s.UniformsLib.common,s.UniformsLib.fog,s.UniformsLib.clipPlanes,s.UniformsLib.lines,s.UniformsLib.skinning]),vertexShader:[s.ShaderChunk.clip_pars_vertex,s.ShaderChunk.map_pars_vertex,s.ShaderChunk.envmap_pars_vertex,s.ShaderChunk.color_pars_vertex,s.ShaderChunk.morphtarget_pars_vertex,s.ShaderChunk.skinning_pars_vertex,s.ShaderChunk.lines_pars_vertex,s.ShaderChunk.oit_pars_vertex,"void main() {",s.ShaderChunk.PDSFX_start_vertex,s.ShaderChunk.map_vertex,s.ShaderChunk.color_vertex,s.ShaderChunk.skinbase_vertex,"#ifdef USE_ENVMAP",s.ShaderChunk.morphnormal_vertex,s.ShaderChunk.skinnormal_vertex,s.ShaderChunk.defaultnormal_vertex,"#endif",s.ShaderChunk.morphtarget_vertex,s.ShaderChunk.skinning_vertex,s.ShaderChunk.default_vertex,"#if defined(PDSFX) && defined(USE_ENVMAP)","transformedNormal = _viewTangentSpace.Normal;","#endif",s.ShaderChunk.clip_vertex,s.ShaderChunk.worldpos_vertex,s.ShaderChunk.envmap_vertex,s.ShaderChunk.lines_vertex,s.ShaderChunk.oit_vertex,s.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:["#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","vec2 uvToUse;","#endif",s.ShaderChunk.lines_pars_fragment,s.ShaderChunk.clip_pars_fragment,s.ShaderChunk.color_pars_fragment,s.ShaderChunk.map_pars_fragment,s.ShaderChunk.envmap_pars_fragment,s.ShaderChunk.fog_pars_fragment,s.ShaderChunk.specularmap_pars_fragment,s.ShaderChunk.oit_pars_fragment,"void main() {","#ifdef PDSFX",s.ShaderChunk.PDSFX_map_fragment,"ComputeCommonValues();",s.ShaderChunk.PDSFX_discard_fragment,s.ShaderChunk.PDSFX_albedo_fragment,s.ShaderChunk.PDSFX_opacity_fragment,"#endif","gl_FragColor = vec4( diffuse, opacity );",s.ShaderChunk.lines_fragment,"#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","uvToUse=vUv;","#endif",s.ShaderChunk.clip_fragment,s.ShaderChunk.uvmapping_fragment,s.ShaderChunk.map_fragment,s.ShaderChunk.alphatest_fragment,s.ShaderChunk.specularmap_fragment,s.ShaderChunk.color_fragment,s.ShaderChunk.envmap_fragment,s.ShaderChunk.linear_to_gamma_fragment,s.ShaderChunk.fog_fragment,s.ShaderChunk.oit_fragment,s.ShaderChunk.PDSFX_end_fragment,"}"].join("\n")},normalmap:{uniforms:s.UniformsUtils.merge([s.UniformsLib.fog,s.UniformsLib.lights,s.UniformsLib.shadowmap,{enableAO:{type:"i",value:0},enableDiffuse:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},enableDisplacement:{type:"i",value:0},tDisplacement:{type:"t",value:null},tDiffuse:{type:"t",value:null},tCube:{type:"t",value:null},tNormal:{type:"t",value:null},tSpecular:{type:"t",value:null},tAO:{type:"t",value:null},uNormalScale:{type:"v2",value:new s.Vector2(1,1)},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},uDiffuseColor:{type:"c",value:new s.Color(16777215)},uSpecularColor:{type:"c",value:new s.Color(1118481)},uAmbientColor:{type:"c",value:new s.Color(16777215)},uShininess:{type:"f",value:30},uOpacity:{type:"f",value:1},useRefract:{type:"i",value:0},uRefractionRatio:{type:"f",value:0.98},uReflectivity:{type:"f",value:0.5},uOffset:{type:"v2",value:new s.Vector2(0,0)},uRepeat:{type:"v2",value:new s.Vector2(1,1)},wrapRGB:{type:"v3",value:new s.Vector3(1,1,1)}}]),fragmentShader:["uniform vec3 uAmbientColor;","uniform vec3 uDiffuseColor;","uniform vec3 uSpecularColor;","uniform float uShininess;","uniform float uOpacity;","uniform bool enableDiffuse;","uniform bool enableSpecular;","uniform bool enableAO;","uniform bool enableReflection;","uniform sampler2D tDiffuse;","uniform sampler2D tNormal;","uniform sampler2D tSpecular;","uniform sampler2D tAO;","uniform samplerCube tCube;","uniform vec2 uNormalScale;","uniform bool useRefract;","uniform float uRefractionRatio;","uniform float uReflectivity;","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","vec2 uvToUse;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","uniform float directionalLightFar[ MAX_DIR_LIGHTS ];","uniform float directionalLightNear[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightInnerAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","varying vec3 vWorldPosition;","varying vec3 vViewPosition;",s.ShaderChunk.shadowmap_pars_fragment,s.ShaderChunk.fog_pars_fragment,"void main() {","gl_FragColor = vec4( vec3( 1.0 ), uOpacity );","uvToUse=vUv;","vec3 specularTex = vec3( 1.0 );","vec3 normalTex = texture2D( tNormal, uvToUse/*vUv*/).xyz * 2.0 - 1.0;","normalTex.xy *= uNormalScale;","normalTex = normalize( normalTex );","if( enableDiffuse ) {","#ifdef GAMMA_INPUT","vec4 texelColor = texture2D( tDiffuse, uvToUse/*vUv*/ );","texelColor.xyz *= texelColor.xyz;","gl_FragColor = gl_FragColor * texelColor;","#else","gl_FragColor = gl_FragColor * texture2D( tDiffuse, uvToUse/*vUv*/ );","#endif","}","if( enableAO ) {","#ifdef GAMMA_INPUT","vec4 aoColor = texture2D( tAO, uvToUse/*vUv*/ );","aoColor.xyz *= aoColor.xyz;","gl_FragColor.xyz = gl_FragColor.xyz * aoColor.xyz;","#else","gl_FragColor.xyz = gl_FragColor.xyz * texture2D( tAO, uvToUse/*vUv*/ ).xyz;","#endif","}","if( enableSpecular )","specularTex = texture2D( tSpecular, uvToUse/*vUv*/ ).xyz;","mat3 tsb = mat3( normalize( vTangent ), normalize( vBinormal ), normalize( vNormal ) );","vec3 finalNormal = tsb * normalTex;","#ifdef FLIP_SIDED","finalNormal = -finalNormal;","#endif","vec3 normal = normalize( finalNormal );","vec3 viewPosition = normalize( vViewPosition );","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","{","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ 0 ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_CASCADE","shadowExposure = getExposureCascaded(vShadowCoord,shadowMap,shadowBias,shadowMapSize);","#else","if(0<MAX_SHADOWS_DIR){","shadowExposure = getExposure(vShadowCoord[ 0 ],shadowMap[ 0 ],shadowBias[ 0 ],shadowMapSize[ 0 ]);","}","#endif","#endif","#ifdef WRAP_AROUND","float directionalLightWeightingFull = max( dot( normal, dirVector ), 0.0 );","float directionalLightWeightingHalf = max( 0.5 * dot( normal, dirVector ) + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( directionalLightWeightingFull ), vec3( directionalLightWeightingHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );","#endif","dirDiffuse += directionalLightColor[ 0 ] * uDiffuseColor * dirDiffuseWeight * shadowExposure;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, uShininess ), 0.0 );","dirSpecular += directionalLightColor[ 0 ] * uSpecularColor * dirSpecularWeight * dirDiffuseWeight * shadowExposure;","}","if(MAX_DIR_LIGHTS>1){","for( int i = 1; i < MAX_DIR_LIGHTS; i++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_CASCADE","#else","if(i<MAX_SHADOWS_DIR){","shadowExposure = getExposure(vShadowCoord[ i ],shadowMap[ i ],shadowBias[ i ],shadowMapSize[ i ]);","}","#endif","#endif","#ifdef WRAP_AROUND","float directionalLightWeightingFull = max( dot( normal, dirVector ), 0.0 );","float directionalLightWeightingHalf = max( 0.5 * dot( normal, dirVector ) + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( directionalLightWeightingFull ), vec3( directionalLightWeightingHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );","#endif","dirDiffuse += directionalLightColor[ i ] * uDiffuseColor * dirDiffuseWeight * shadowExposure;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, uShininess ), 0.0 );","dirSpecular += directionalLightColor[ i ] * uSpecularColor * dirSpecularWeight * dirDiffuseWeight * shadowExposure;","}","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 spotVector = lPosition.xyz + vViewPosition.xyz;","float spotDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","spotDistance = 1.0 - min( ( length( spotVector ) / spotLightDistance[ i ] ), 1.0 );","spotVector = normalize( spotVector );","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP","if((i + MAX_SHADOWS_DIR)<MAX_SHADOWS){","shadowExposure = getExposure(vShadowCoord[ i + MAX_SHADOWS_DIR ],shadowMap[ i + MAX_SHADOWS_DIR ],shadowBias[ i + MAX_SHADOWS_DIR ],shadowMapSize[ i + MAX_SHADOWS_DIR ]);","}","#endif","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = 1.0 - smoothstep( spotLightInnerAngleCos[ i ],spotLightAngleCos[ i ],spotEffect );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dot( normal, spotVector ), 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dot( normal, spotVector ) + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dot( normal, spotVector ), 0.0 );","#endif","spotDiffuse += spotDistance * spotLightColor[ i ] * uDiffuseColor * spotDiffuseWeight * spotEffect * shadowExposure;","vec3 spotHalfVector = normalize( spotVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularTex.r * max( pow( spotDotNormalHalf, uShininess ), 0.0 );","spotSpecular += spotDistance * spotLightColor[ i ] * uSpecularColor * spotSpecularWeight * spotDiffuseWeight * spotEffect * shadowExposure;","}","}","#endif","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 pointVector = lPosition.xyz + vViewPosition.xyz;","float pointDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","pointDistance = 1.0 - min( ( length( pointVector ) / pointLightDistance[ i ] ), 1.0 );","pointVector = normalize( pointVector );","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP_CUBE","if (i<MAX_SHADOWS_CUBE){","shadowExposure = getExposure(shadowPointPosition[ i ],shadowMapCube[ i ],shadowBiasCube[ i ],shadowMapSizeCube[ i ],shadowNearCube[ i ],shadowFarCube[ i ]);","}","#endif","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dot( normal, pointVector ), 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dot( normal, pointVector ) + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );","#endif","pointDiffuse += pointDistance * pointLightColor[ i ] * uDiffuseColor * pointDiffuseWeight * shadowExposure;","vec3 pointHalfVector = normalize( pointVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularTex.r * max( pow( pointDotNormalHalf, uShininess ), 0.0 );","pointSpecular += pointDistance * pointLightColor[ i ] * uSpecularColor * pointSpecularWeight * pointDiffuseWeight * shadowExposure;","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += uDiffuseColor * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularTex.r * max( pow( hemiDotNormalHalfSky, uShininess ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularTex.r * max( pow( hemiDotNormalHalfGround, uShininess ), 0.0 );","hemiSpecular += uSpecularColor * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor + totalSpecular );","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor ) + totalSpecular;","#endif","if ( enableReflection ) {","vec3 vReflect;","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","if ( useRefract ) {","vReflect = refract( cameraToVertex, normal, uRefractionRatio );","} else {","vReflect = reflect( cameraToVertex, normal );","}","vec4 cubeColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );","#ifdef GAMMA_INPUT","cubeColor.xyz *= cubeColor.xyz;","#endif","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularTex.r * uReflectivity );","}",s.ShaderChunk.linear_to_gamma_fragment,s.ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["attribute vec4 tangent;","uniform vec2 uOffset;","uniform vec2 uRepeat;","uniform bool enableDisplacement;","#ifdef VERTEX_TEXTURES","uniform sampler2D tDisplacement;","uniform float uDisplacementScale;","uniform float uDisplacementBias;","#endif","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vWorldPosition;","varying vec3 vViewPosition;",s.ShaderChunk.skinning_pars_vertex,s.ShaderChunk.shadowmap_pars_vertex,"void main() {",s.ShaderChunk.skinbase_vertex,s.ShaderChunk.skinnormal_vertex,"#ifdef USE_SKINNING",s._DefaultShaderChunk.model_view_normal_vertex,"vec4 skinnedTangent = skinMatrix * vec4( tangent.xyz, 0.0 );","vec3 mvTangent;","if (use_normal_matrix)","mvTangent = normalMatrix * skinnedTangent.xyz;","else {",s._DefaultShaderChunk.getModelViewUnitVectorTransformationChunk("mvTangent","skinnedTangent.xyz"),"}","vTangent = normalize( mvTangent );","#else","if (use_normal_matrix) {","vNormal = normalMatrix * normal;","vTangent = normalMatrix * tangent.xyz;","} else {",s._DefaultShaderChunk.getModelViewUnitVectorTransformationChunk("vNormal","normal"),s._DefaultShaderChunk.getModelViewUnitVectorTransformationChunk("vTangent","tangent.xyz"),"}","vNormal = normalize(vNormal);","vTangent = normalize(vTangent);","#endif","vBinormal = normalize( cross( vNormal, vTangent ) * tangent.w );","vUv = uv * uRepeat + uOffset;","vec3 displacedPosition;","#ifdef VERTEX_TEXTURES","if ( enableDisplacement ) {","vec3 dv = texture2D( tDisplacement, uv ).xyz;","float df = uDisplacementScale * dv.x + uDisplacementBias;","displacedPosition = position + normalize( normal ) * df;","} else {","#ifdef USE_SKINNING","vec4 skinVertex = vec4( position, 1.0 );","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","}","#else","#ifdef USE_SKINNING","vec4 skinVertex = vec4( position, 1.0 );","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","#endif",s._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPosition","vec4( displacedPosition, 1.0 )"),"vec4 worldPosition = modelMatrix * vec4( displacedPosition, 1.0 );","gl_Position = projectionMatrix * mvPosition;","vWorldPosition = worldPosition.xyz;","vViewPosition = -mvPosition.xyz;","#ifdef USE_SHADOWMAP","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[ i ] * vec4( displacedPosition, 1.0 );","}","#endif","}"].join("\n")},cube:{uniforms:{tCube:{type:"t",value:null},tFlip:{type:"f",value:-1}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;",s._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform samplerCube tCube;","uniform float tFlip;","varying vec3 vWorldPosition;","void main() {","gl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );","}"].join("\n")},depthRGBA:{uniforms:s.UniformsUtils.merge([s.UniformsLib.clipPlanes,s.UniformsLib.skinning,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new s.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new s.Vector4(1,1)}}]),vertexShaderPars:["#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif"].join("\n"),vertexShaderBody:["#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif"].join("\n"),fragmentShaderPars:["vec4 pack_depth( const in float depth ) {","const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","const vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","vec4 res = mod( depth * bit_shift * vec4(255.0), vec4(256.0) ) / vec4(255.0);","res -= res.xxyz * bit_mask;","return res;","}","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif"].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vUvMap ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","gl_FragData[ 0 ] = pack_depth( gl_FragCoord.z );"].join("\n"),vertexShader:[s.ShaderChunk.clip_pars_vertex,s.ShaderChunk.morphtarget_pars_vertex,s.ShaderChunk.skinning_pars_vertex,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","void main() {",s.ShaderChunk.PDSFX_start_vertex,s.ShaderChunk.skinbase_vertex,s.ShaderChunk.morphtarget_vertex,s.ShaderChunk.skinning_vertex,s.ShaderChunk.default_vertex,s.ShaderChunk.clip_vertex,"#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif",s.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[s.ShaderChunk.clip_pars_fragment,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","vec4 pack_depth( const in float depth ) {","const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","const vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","vec4 res = mod( depth * bit_shift * vec4(255.0), vec4(256.0) ) / vec4(255.0);","res -= res.xxyz * bit_mask;","return res;","}","void main() {","#ifdef PDSFX","ComputeCommonValues();",s.ShaderChunk.PDSFX_discard_fragment,"#endif",s.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vUvMap ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","gl_FragData[ 0 ].x = exp(80.0*gl_FragCoord.z);","gl_FragData[ 0 ].w = 1.0;","#else","gl_FragData[ 0 ] = pack_depth( gl_FragCoord.z );","#endif","}"].join("\n")}};function j(v,u){return u.sortKey-v.sortKey}function m(v,u){var x=v[2];var w=u[2];if(w===undefined){return -1}if(x===undefined){return 1}if(x.z!==w.z){if(w.z===undefined){return -1}if(x.z===undefined){return 1}return w.z-x.z}else{return w.id-x.id}}function b(v,u){if(v.z!==u.z){if(u.z===undefined){return -1}if(v.z===undefined){return 1}return u.z-v.z}else{return u.id-v.id}}function o(v,u){if(v.z!==u.z){if(u.z===undefined){return 1}if(v.z===undefined){return -1}return v.z-u.z}else{return v.id-u.id}}function l(v,u){return u[0]-v[0]}var e=0;var n=-1;s.WebGLRenderer=function(bl){this.currentFrameIndex=0;this.renderIteration=0;var cy=0;this._VRCompatible=false;this.resetGSSOCacheFrame=0;this.forcePolygonOffset=s.PolygonOffsetForceStatus.DEFAULT;bl=bl||{};var bw=bl.canvas!==undefined?bl.canvas:document.createElement("canvas"),aG=bl.divCSS!==undefined?bl.divCSS:document.createElement("div"),D=bl.precision!==undefined?bl.precision:"highp",ck=bl.alpha!==undefined?bl.alpha:true,bA=bl.premultipliedAlpha!==undefined?bl.premultipliedAlpha:true,cC=bl.antialias!==undefined?bl.antialias:false,z=bl.stencil!==undefined?bl.stencil:true,aF=bl.preserveDrawingBuffer!==undefined?bl.preserveDrawingBuffer:false,b9=bl.clearColor!==undefined?new s.Color(bl.clearColor):new s.Color(0),aD=bl.clearAlpha!==undefined?bl.clearAlpha:0;this._sortRenderListByBuffer=bl.sortRenderListByBuffer!==undefined?bl.sortRenderListByBuffer:false;var Q,b8;var aE,T;this.domElement=bw;this.currentPass=null;this.id=e++;this.useRenderPriorityOpacity=false;this.renderPriorityDefaultOpacity=1;this.context=null;this.devicePixelRatio=bl.devicePixelRatio!==undefined?bl.devicePixelRatio:window.devicePixelRatio!==undefined?window.devicePixelRatio:1;this.splitScreenMode=null;this.autoClear=true;this.autoClearColor=true;this.autoClearDepth=true;this.autoClearStencil=true;this.visibleSpace=bl.visibleSpace!==undefined?bl.visibleSpace:1;this.sortObjects=true;this.autoUpdateObjects=true;this.autoUpdateScene=true;this.gammaInput=false;this.gammaOutput=false;this.lensFlareEnabled=true;this.shadowMapEnabled=false;this.shadowMapAutoUpdate=true;this.shadowMapType=s.PCFShadowMap;this.shadowMapQuality="Low";this.shadowMapCullFace=s.CullFaceFront;this.shadowMapDebug=false;this.shadowMapCascade=false;this.clipPlanesEnabled=false;this.clipPlanes=[];this.disableBackFaceClipPlanes=0;this.maxMorphTargets=8;this.maxMorphNormals=4;this.autoScaleCubemaps=true;this.disableDepthWrite=false;this.disableDepthTest=false;this.disableColorWrite=false;this.enableStencilWrite=false;this.disableBackFaceCulling=false;this.renderLineMode=null;this.renderFaceMode=s.ShowAllFaces;this.renderVolumesOnly=false;this.materialMode=true;this.gasLookMode=false;this.enableRenderPluginsPre=true;this.enableRenderPluginsPost=true;this.renderPluginsPre=[];this.renderPluginsPost=[];this.prevNormalDepthBuffer=null;this.prevColorBuffer=null;this.ambianceGenerators=null;this.sssGenerator=null;this.dBuffer=null;this.requestDBuffer=false;this.info={memory:new s.MemoryInfo(),render:new s.RenderInfo()};this.float32MatrixTemp=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.float32MatrixTemp.setDoubles=function(cE){var cF=this;cF[0]=cE[0];cF[1]=cE[1];cF[2]=cE[2];cF[4]=cE[4];cF[5]=cE[5];cF[6]=cE[6];cF[8]=cE[8];cF[9]=cE[9];cF[10]=cE[10];cF[12]=cE[12];cF[13]=cE[13];cF[14]=cE[14];return this};this._createDummyTexture=function(){var cE=new Uint8Array(2*2*4);for(var cG=0;cG<2*2;cG++){cE[4*cG]=0;cE[4*cG+1]=0;cE[4*cG+2]=0;cE[4*cG+3]=255}var cF=new s.DataTexture(cE,2,2,s.RGBAFormat,s.UnsignedByteType,new s.LatLongReflectionMapping(),s.ClampToEdgeWrapping,s.ClampToEdgeWrapping,s.LinearFilter,s.LinearFilter);cF.generateMipmaps=false;cF.needsUpdate=true;return cF};this._dummyTexture=this._createDummyTexture();this._clipPlanesState={uniforms:{nbClipPlanes:{type:"i",value:0,clipPlanesUniform:true},clipPlaneEquations:{type:"fv4",value:[],clipPlanesUniform:true},clipPlaneActive:{type:"iv1",value:[],clipPlanesUniform:true},clipFrontOpacity:{type:"f",value:1,clipPlanesUniform:true},clipBackOpacity:{type:"f",value:0,clipPlanesUniform:true},polygonSize:{type:"i",value:0,clipPlanesUniform:true},polygonPoints:{type:"t",value:null,clipPlanesUniform:true},extrusionPlaneU:{type:"v3",value:new s.Vector3(0,0,1),clipPlanesUniform:true},extrusionPlaneV:{type:"v3",value:new s.Vector3(1,0,0),clipPlanesUniform:true}},version:-1,disabled:false,update:function(cP,cJ,cF,cN,cO,cK){if(cF||cP!==cJ||(this.disabled&&cN.enableClipPlanes)){var cG=cP&&cP.clipPlanes;var cS=bm.clipPlanesEnabled?bm.clipPlanes:[];var cI;if(cG){cS=cG}var cH=[],cE,cL;for(cI=0;cI<cS.length&&cH.length<6;cI++){cE=cS[cI];cL=cE&&cE.clippingContext&&cE.clippingContext[bm.id];if(cL&&cL.clippingPlaneAdded){cH.push(cE)}}var cI;var cR=-1;if(cP&&cP.clippingSettings&&cP.clippingSettings.frontOpacity===0){cR=1}for(cI=0;cI<cH.length;cI++){var cM=bm.clipPlanesEnabled||cG;var cQ;if(cO instanceof s.OrthographicCamera){cQ=-cH[cI].normal.dot(cO.getLookAt())}else{cQ=cH[cI].distanceToPoint(cO.position)}cH[cI].enabled=cM&&((bm.disableBackFaceClipPlanes==0)||cR*cQ>0)}M(null,cH,cO);R(this.uniforms,S,cN&&cN.clipPlaneIndex,cP,cK);ao(this.uniforms,cP?cP.clipPolyLine:null);this.disabled=false;this.version++}else{if(!this.disabled&&!cN.enableClipPlanes){this.disabled=true;R(this.uniforms,{length:0,eqs:[],states:[]},0)}}}};this.getPickingRenderPointMode=function(){var cE=0;switch(this.pickPointsMode){case 1:cE=s.AllPointsRenderPointMask;break;case 2:cE=this.renderPointMode;break;case 3:cE=(~this.renderPointMode)&255;break;default:}return cE};this.__glResources__={renderTarget:{},geometry:[],geometryNullCount:0,texture:[],textureLODPool:new s.TextureLODPool(),removeGeometryList:function(cH){var cG=new Set();cH.forEach(function(cK,cJ,cL){cG.add(cK.id)});var cE=0;for(var cF=0;cF<this.geometry.length;cF++){var cI=this.geometry[cF];if(cI&&cG.has(cI.object.id)){cE++;cG["delete"](cI.object.id);this.geometry[cF]=null;this.geometryNullCount++;if(cE===cH.size){break}}}this.tryClean()},tryClean:function(){if(this.geometryNullCount>=100){this.geometry=this.geometry.filter(function(cE){return cE!==null});this.geometryNullCount=0}}};this.restoreGLContext=function(){console.log("restore context");b6();cl=[];a8=0;w._currentProgram=null;var cP=bm.info.memory.programs;bm.info.memory.programs=0;bm.info.memory.sharedbuffers=0;bm.info.memory.geometries=0;var cF=this.__glResources__.geometry;console.log("restore "+cF.length+" geometries");var cE=[];for(var cL=0;cL<cF.length;cL++){if(!cF[cL]){continue}var cQ=cF[cL].object.geometry;if(!cQ){continue}if(cQ.length){for(var cI=0;cI<cQ.length;cI++){cQ[cI].vertexBuffer=null}}else{cF[cL].object.__webglInit=false;cQ.__webglVertexBuffer=null;if(cQ.geometryGroups){for(var cN in cQ.geometryGroups){var cH=cQ.geometryGroups[cN];cH.__webglVertexBuffer=null}}}var cK=bm.initObject(cF[cL].object);if(cK){cE.push(cF[cL])}}this.initSharedBuffersDS(cE,true);bm.info.memory.textures=0;var cR=this.__glResources__.texture;console.log("restore "+cR.length+" textures");for(var cL=0;cL<cR.length;cL++){var cO=cR[cL];cO.needsUpdate=true;cO.__webglInit=false;if(cO.image.__webglTextureCube){cO.image.__webglTextureCube=null}else{if(cO.__webglTexture){cO.__webglTexture=null}}}var cJ=this.__glResources__.renderTarget;var cM=0;for(var cL in cJ){var cG=cJ[cL];if(cG){cG.__webglFramebuffer=null;cG.__webglRenderbuffer=null;cG.__webglTexture=null;cM++}}console.log("restore "+cM+" render targets")};var bm=this,cl=[],a8=0,bC=-1,bB=-1,ad=null,bD=null,bi=null,aM=null,bK=null,aL=null,aB=0,bR=0,aK=-1,W=1,bS=-1,bZ=-1,E=-1,b3=1,aS=-1,cs=-1,a1=-1,u=-1,cf=-1,cv=-1,bg=null,cr=null,bN=null,b1=1,bF=0,bE=0,cu=0,bs=0,A=false,ca=new s.Frustum(),by=new s.Matrix4(),ae=new s.Matrix4(),aC=new s.Vector3(),aA=new s.Vector4(),bj=new s.Vector3(),cD=true,ap=0,b5={ambient:[0,0,0],shFactors:[null,null,null],directional:{length:0,colors:[],positions:[],nears:[],fars:[]},point:{length:0,colors:[],positions:[],physicalAttenuations:[],distances:[]},spot:{length:0,colors:[],positions:[],physicalAttenuations:[],distances:[],directions:[],anglesCos:[],innerAnglesCos:[]},hemi:{length:0,skyColors:[],groundColors:[],positions:[]},sphere:{length:0,colors:[],positions:[],data:[]},area:{length:0,colors:[],positions:[],normals:[],rights:[],ups:[],data:[]},disk:{length:0,colors:[],positions:[],normals:[],data:[]},tube:{length:0,colors:[],positions:[],rights:[],data:[]},ies:{length:0,colors:[],positions:[],distances:[],iesLightTexture:[],matrixWorldInv:[]}};var S={length:0,eqs:[],states:[]};var w;var G;var aj;var ci;var Z;var bQ;var L;var bd;var J;var I;var b2;var bO;var au;this.fixedSizeArrayPool=new d();b6(bl.context,bl.debugContext);bP();this.dispose=function(){var cE;for(cE=0;cE<this.renderPluginsPre.length;cE++){this.renderPluginsPre[cE].dispose&&this.renderPluginsPre[cE].dispose()}for(cE=0;cE<this.renderPluginsPost.length;cE++){this.renderPluginsPost[cE].dispose&&this.renderPluginsPost[cE].dispose()}if(this.ambianceGenerators){this.ambianceGenerators=null}if(this.sssGenerator&&this.sssGenerator.ready){this.sssGenerator.dispose();this.sssGenerator=null}this.renderPluginsPre=[];this.renderPluginsPost=[];this.fixedSizeArrayPool=null;this.getContext=null;bm=null;w=null;cl=null;aG=null;bw=null;this.__glResources__=null;this.context=null;bi=null;bD=null};this.setPickingPriorityMapping=function(cL,cH){if(!cL){cH._pickingPriorityMapping=null;return}var cI=function(cO,cN){if(cO.priority<cN.priority){return -1}if(cO.priority>cN.priority){return 1}return 0};cL.sort(cI);var cJ={};var cK=null;var cE=0;for(var cF=0;cF<cL.length;cF++){var cM=cL[cF];if(cM.priority>0){if(!cK||(cK.priority!==cM.priority)){cE++;var cG=cH.getDisplayListByName("PICKING_H"+cE);if(!cG){cG=cH.addDisplayList(new s.DisplayList({name:"PICKING_H"+cE,priority:-cE,zSort:s.FrontToBack,side:a.FrontSide,polygonOffset:false,pickingPriority:true}))}}cJ[cM.id]=cG}else{if(cM.priority===0){cJ[cM.id]=null}}cK=cM}cK=null;cE=0;for(var cF=cL.length-1;cF>=0;cF--){var cM=cL[cF];if(cM.priority<0){if(!cK||(cK.priority!==cM.priority)){cE--;var cG=cH.getDisplayListByName("PICKING_L"+(-cE));if(!cG){cG=cH.addDisplayList(new s.DisplayList({name:"PICKING_L"+(-cE),priority:2048+(-cE),zSort:s.FrontToBack,side:a.FrontSide,polygonOffset:false,pickingPriority:true}));this.resetGSSOCache()}}cJ[cM.id]=cG}cK=cM}cH._pickingPriorityMapping=cJ};this.setCurrentPass=function(cE){this.currentPass=cE};this._stateSortingResult=new s.StateSortingResult();this._stateSortingResult.init();this.context=w;var cn=w.getParameter(w.MAX_TEXTURE_IMAGE_UNITS);var v=w.getParameter(w.MAX_VERTEX_TEXTURE_IMAGE_UNITS);var ab=w.getParameter(w.MAX_TEXTURE_SIZE);var aW=w.getParameter(w.MAX_CUBE_MAP_TEXTURE_SIZE);var cj=L?w.getParameter(L.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0;var bt=(v>0);var aH=bt&&G;var cg=bd?w.getParameter(w.COMPRESSED_TEXTURE_FORMATS):[];var cd=w.getShaderPrecisionFormat(w.VERTEX_SHADER,w.HIGH_FLOAT);var ct=w.getShaderPrecisionFormat(w.VERTEX_SHADER,w.MEDIUM_FLOAT);var cq=w.getShaderPrecisionFormat(w.VERTEX_SHADER,w.LOW_FLOAT);var aV=w.getShaderPrecisionFormat(w.FRAGMENT_SHADER,w.HIGH_FLOAT);var cm=w.getShaderPrecisionFormat(w.FRAGMENT_SHADER,w.MEDIUM_FLOAT);var a6=w.getShaderPrecisionFormat(w.FRAGMENT_SHADER,w.LOW_FLOAT);var F=w.getShaderPrecisionFormat(w.VERTEX_SHADER,w.HIGH_INT);var be=w.getShaderPrecisionFormat(w.VERTEX_SHADER,w.MEDIUM_INT);var ar=w.getShaderPrecisionFormat(w.VERTEX_SHADER,w.LOW_INT);var cc=w.getShaderPrecisionFormat(w.FRAGMENT_SHADER,w.HIGH_INT);var V=w.getShaderPrecisionFormat(w.FRAGMENT_SHADER,w.MEDIUM_INT);var bY=w.getShaderPrecisionFormat(w.FRAGMENT_SHADER,w.LOW_INT);var cw=cd.precision>0&&aV.precision>0;var bX=ct.precision>0&&cm.precision>0;if(D==="highp"&&!cw){if(bX){D="mediump";console.warn("WebGLRenderer: highp not supported, using mediump")}else{D="lowp";console.warn("WebGLRenderer: highp and mediump not supported, using lowp")}}if(D==="mediump"&&!bX){D="lowp";console.warn("WebGLRenderer: mediump not supported, using lowp")}this.getContext=function(){return w};this.supportsVertexTextures=function(){return bt};this.supportsFloatTextures=function(){return(G&&J)};this.supportsFloatLinearTextures=function(){return Z};this.supportsStandardDerivatives=function(){return bQ};this.supportsCompressedTextureS3TC=function(){return bd};this.supportsMinMaxBlending=function(){return au};this.supportsElementIndexUint=function(){return b2};this.getMaxAnisotropy=function(){return cj};this.getPrecision=function(){return D};this.setGLSize=function(cK,cF,cG,cH){var cE=window.devicePixelRatio||1;bw.width=Math.floor(cK*cE);bw.height=Math.floor(cF*cE);if(this._VRCompatible){bw.style.width="100%";bw.style.height="100%"}else{bw.style.width=cK+"px";bw.style.height=cF+"px"}this.setViewport(0,0,Math.floor(cG*cE),Math.floor(cH*cE));Q=cK;b8=cF;aE=Q/2;T=b8/2;aG.style.width=cK+"px";aG.style.height=cF+"px";for(var cJ=0;cJ<aG.childNodes.length;cJ++){var cI=aG.childNodes[cJ];cI.style.width=cK+"px";cI.style.height=cF+"px"}};this.setViewport=function(cG,cL,cJ,cF){var cI=bF,cH=bE,cE=cu,cK=bs;bF=cG!==undefined?cG:0;bE=cL!==undefined?cL:0;cu=cJ!==undefined?cJ:bw.width;bs=cF!==undefined?cF:bw.height;if(bF!==cI||bE!==cH||cu!==cE||bs!==cK){w.viewport(bF,bE,cu,bs)}s.glStates.currentWidth=cu;s.glStates.currentHeight=bs};this.removeSplitScreenMode=function(){if(this.splitScreenMode){this.activateSplitScreenMode(false);this.splitScreenMode=null}};this.setSplitScreenMode=function(cE,cF){this.splitScreenMode={x:cE,y:cF,active:false};this.activateSplitScreenMode(true)};this.activateSplitScreenMode=function(cE){if(this.splitScreenMode){if(cE!==this.splitScreenMode.active){if(cE){this.setScissor(this.splitScreenMode.x,this.splitScreenMode.y,cu,bs);this.enableScissorTest(true);this.setViewport(this.splitScreenMode.x,this.splitScreenMode.y,cu,bs)}else{this.enableScissorTest(false);this.setViewport(0,0,cu,bs)}this.splitScreenMode.active=cE?true:false}}};this.getViewportSize=function(){return{width:cu,height:bs}};this.getViewport=function(){return{width:cu,height:bs,x:bF,y:bE}};this.setScissor=function(cF,cH,cG,cE){w.scissor(cF,cH,cG,cE)};this.enableScissorTest=function(cE){A=cE;cE?w.enable(w.SCISSOR_TEST):w.disable(w.SCISSOR_TEST)};this.getScissorTest=function(){return A};this.setClearColorHex=function(cE,cF){b9.setHex(cE);aD=cF;w.clearColor(b9.r,b9.g,b9.b,aD)};this.setClearColor=function(cE,cF){b9.copy(cE);aD=cF;w.clearColor(b9.r,b9.g,b9.b,aD)};this.getClearColor=function(){return b9};this.getClearAlpha=function(){return aD};this.clear=function(cF,cI,cG){var cH=0;if(cF===undefined||cF){cH|=w.COLOR_BUFFER_BIT}if(cI===undefined||cI){cH|=w.DEPTH_BUFFER_BIT}var cE=false;if(cG===undefined||cG){cE=true;cH|=w.STENCIL_BUFFER_BIT;this.setStencilWrite(true)}w.clear(cH);if(cE&&!this.enableStencilWrite){this.setStencilWrite(false)}};this.clearTarget=function(cG,cE,cH,cF){this.setRenderTarget(cG);this.clear(cE,cH,cF)};this.setPreviousNormalDepthBuffer=function(cE){this.prevNormalDepthBuffer=cE};this.setPreviousColorBuffer=function(cE){this.prevColorBuffer=cE};this.addPostPlugin=function(cE){cE.init(this);this.renderPluginsPost.push(cE)};this.addPrePlugin=function(cE){cE.init(this);this.renderPluginsPre.push(cE)};this.updateShadowMap=function(cF,cE){w._currentProgram=null;w._oldBlending=-1;u=-1;cf=-1;ad=-1;bD=-1;bC=-1;bB=-1;aM=null;bK=null;aL=null;cD=true;bZ=-1;E=-1;this.shadowMapPlugin.update(cF,cE)};function af(cE){cE.__webglVertexBuffer=w.createBuffer();cE.__webglColorBuffer=w.createBuffer();bm.info.memory.geometries++}function aN(cE){cE.__webglVertexBuffer=w.createBuffer();cE.__webglColorBuffer=w.createBuffer();cE.__webglLineDistanceBuffer=w.createBuffer();bm.info.memory.geometries++}function bc(cF){cF.__webglVertexBuffer=w.createBuffer();cF.__webglNormalBuffer=w.createBuffer();cF.__webglTangentBuffer=w.createBuffer();cF.__webglColorBuffer=w.createBuffer();cF.__webglUVBuffer=w.createBuffer();cF.__webglUV2Buffer=w.createBuffer();cF.__webglSkinIndicesBuffer=w.createBuffer();cF.__webglSkinWeightsBuffer=w.createBuffer();cF.__webglFaceBuffer=w.createBuffer();cF.__webglLineBuffer=w.createBuffer();var cE,cG;if(cF.numMorphTargets){cF.__webglMorphTargetsBuffers=[];for(cE=0,cG=cF.numMorphTargets;cE<cG;cE++){cF.__webglMorphTargetsBuffers.push(w.createBuffer())}}if(cF.numMorphNormals){cF.__webglMorphNormalsBuffers=[];for(cE=0,cG=cF.numMorphNormals;cE<cG;cE++){cF.__webglMorphNormalsBuffers.push(w.createBuffer())}}bm.info.memory.geometries++}var bv=function(cE){return Math.abs(cE)<0.000001?0:cE};var U=function(cE){var cF=cE.elements;return"matrix3d("+bv(cF[0])+","+bv(-cF[1])+","+bv(cF[2])+","+bv(cF[3])+","+bv(cF[4])+","+bv(-cF[5])+","+bv(cF[6])+","+bv(cF[7])+","+bv(cF[8])+","+bv(-cF[9])+","+bv(cF[10])+","+bv(cF[11])+","+bv(cF[12])+","+bv(-cF[13])+","+bv(cF[14])+","+bv(cF[15])+")"};var aP=function(cE){var cF=cE.elements;return"translate3d(-50%,-50%,0) matrix3d("+bv(cF[0])+","+bv(cF[1])+","+bv(cF[2])+","+bv(cF[3])+","+bv(-cF[4])+","+bv(-cF[5])+","+bv(-cF[6])+","+bv(-cF[7])+","+bv(cF[8])+","+bv(cF[9])+","+bv(cF[10])+","+bv(cF[11])+","+bv(cF[12])+","+bv(cF[13])+","+bv(cF[14])+","+bv(cF[15])+")"};var bx=function(cE){var cF=cE.target;cF.removeEventListener("dispose",bx);cx(cF);bm.info.memory.geometries--};var a0=function(cE){var cF=cE.target;cF.removeEventListener("dispose",a0);cF.deallocate(w,bm.info)};var aQ=function(cF){var cE=cF.target;cE.removeEventListener("dispose",aQ);ai(cE);if(cE.textures){cE.usedTexture=-1}bm.info.memory.textures--};var ay=function(cF){var cG=cF.target;cG.removeEventListener("dispose",ay);a9(cG);bm.info.memory.textures--;var cE=bm.__glResources__.renderTarget;if(cE[cG.uniqueID]){delete (cE[cG.uniqueID])}};var bW=function(cG){var cF=cG.target;cF.removeEventListener("dispose",bW);var cE=cF.program!==null?cF.program.program:null;aw(cF,cE,true)};var cx=function(cG){cG.__webglInit=undefined;if(cG.__webglVertexBuffer!==undefined){w.deleteBuffer(cG.__webglVertexBuffer)}if(cG.__webglNormalBuffer!==undefined){w.deleteBuffer(cG.__webglNormalBuffer)}if(cG.__webglTangentBuffer!==undefined){w.deleteBuffer(cG.__webglTangentBuffer)}if(cG.__webglColorBuffer!==undefined){w.deleteBuffer(cG.__webglColorBuffer)}if(cG.__webglUVBuffer!==undefined){w.deleteBuffer(cG.__webglUVBuffer)}if(cG.__webglUV2Buffer!==undefined){w.deleteBuffer(cG.__webglUV2Buffer)}if(cG.__webglTangentBuffer!==undefined){w.deleteBuffer(cG.__webglTangentBuffer)}if(cG.__webglBinormalBuffer!==undefined){w.deleteBuffer(cG.__webglBinormalBuffer)}if(cG.__webglSkinIndicesBuffer!==undefined){w.deleteBuffer(cG.__webglSkinIndicesBuffer)}if(cG.__webglSkinWeightsBuffer!==undefined){w.deleteBuffer(cG.__webglSkinWeightsBuffer)}if(cG.__webglFaceBuffer!==undefined){w.deleteBuffer(cG.__webglFaceBuffer)}if(cG.__webglLineBuffer!==undefined){w.deleteBuffer(cG.__webglLineBuffer)}if(cG.__webglLineDistanceBuffer!==undefined){w.deleteBuffer(cG.__webglLineDistanceBuffer)}if(cG.geometryGroups!==undefined){for(var cF in cG.geometryGroups){var cE=cG.geometryGroups[cF];az(cE)}}};var ai=function(cF){var cE=bm.__glResources__.texture.indexOf(cF);if(cE>=0){bm.__glResources__.texture.splice(cE,1)}if(cF.image&&cF.image.__webglTextureCube){w.deleteTexture(cF.image.__webglTextureCube)}else{if(!cF.__webglInit){return}cF.__webglInit=false;w.deleteTexture(cF.__webglTexture)}};var a9=function(cF){if(!cF||!cF.__webglTexture){return}w.deleteTexture(cF.__webglTexture);if(cF instanceof s.WebGLRenderTargetCube){for(var cE=0;cE<6;cE++){w.deleteFramebuffer(cF.__webglFramebuffer[cE]);w.deleteRenderbuffer(cF.__webglRenderbuffer[cE])}}else{w.deleteFramebuffer(cF.__webglFramebuffer);w.deleteRenderbuffer(cF.__webglRenderbuffer)}};var aw=function(cK,cG,cL){if(cG===null){return}if(cL){cK.programManager.dispose(aw);if(cK.isPhysicalMaterial&&bm.ambianceGenerators){bm.ambianceGenerators.decreaseUseCount(cK.id)}if(cK.isPhysicalMaterial&&bm.sssGenerator&&cK.sssLUT){bm.sssGenerator.decreaseUseCount(cK.sssLUT.id)}if(cK._deferredMaterialsInit){s.cleanDeferredCache(cK.id);cK._deferredMaterialsInit=false;cK._deferredMaterials=[];for(var cH=0;cH<s.MaterialToUse.totalMaterial;cH++){cK._deferredMaterials[cH]=null}cK._deferredMaterials[s.MaterialToUse.originalMaterial]=cK;if(cK.backMaterial){cK._deferredMaterials[s.MaterialToUse.pickingMaterial]&&cK._deferredMaterials[s.MaterialToUse.pickingMaterial].dispose()}cK.needsUpdate=true}return}cK.program=null;var cH,cF,cJ;var cI=false;for(cH=0,cF=cl.length;cH<cF;cH++){cJ=cl[cH];if(cJ.program!==null&&cJ.program.program===cG){cJ.usedTimes--;if(cJ.usedTimes===0){cI=true}break}}if(cI===true){var cE=[];for(cH=0,cF=cl.length;cH<cF;cH++){cJ=cl[cH];if(cJ.program!==null&&cJ.program.program!==cG){cE.push(cJ)}}cl=cE;w.deleteProgram(cG);bm.info.memory.programs--}};function az(cF){w.deleteBuffer(cF.__webglVertexBuffer);w.deleteBuffer(cF.__webglNormalBuffer);w.deleteBuffer(cF.__webglTangentBuffer);w.deleteBuffer(cF.__webglColorBuffer);w.deleteBuffer(cF.__webglUVBuffer);w.deleteBuffer(cF.__webglUV2Buffer);w.deleteBuffer(cF.__webglSkinIndicesBuffer);w.deleteBuffer(cF.__webglSkinWeightsBuffer);w.deleteBuffer(cF.__webglFaceBuffer);w.deleteBuffer(cF.__webglLineBuffer);var cE,cG;if(cF.numMorphTargets){for(cE=0,cG=cF.numMorphTargets;cE<cG;cE++){w.deleteBuffer(cF.__webglMorphTargetsBuffers[cE])}}if(cF.numMorphNormals){for(cE=0,cG=cF.numMorphNormals;cE<cG;cE++){w.deleteBuffer(cF.__webglMorphNormalsBuffers[cE])}}bm.info.memory.geometries--}function co(cG,cE){var cF=cG.vertices.length;cG.__vertexArray=new Float32Array(cF*3);cG.__colorArray=new Float32Array(cF*3);cG.__sortArray=[];cG.__webglParticleCount=cF}function ak(cG,cE){var cF=cG.vertices.length;cG.__vertexArray=new Float32Array(cF*3);cG.__colorArray=new Float32Array(cF*3);cG.__lineDistanceArray=new Float32Array(cF*1);cG.__webglLineCount=cF}function aU(cI,cH){var cO=cH.geometry,cR=cI.faces3,cQ=cI.faces4,cE=cR.length*3+cQ.length*4,cK=cR.length*1+cQ.length*2,cP=cR.length*3+cQ.length*4,cL=al(cH,cI),cM=cb(cL),cG=bp(cL),cN=cp(cL);cI.__vertexArray=new Float32Array(cE*3);if(cG){cI.__normalArray=new Float32Array(cE*3)}if(cO.hasTangents){cI.__tangentArray=new Float32Array(cE*4)}if(cN){cI.__colorArray=new Float32Array(cE*3)}if(cM){if(cO.faceUvs.length>0||cO.faceVertexUvs.length>0){cI.__uvArray=new Float32Array(cE*2)}if(cO.faceUvs.length>1||cO.faceVertexUvs.length>1){cI.__uv2Array=new Float32Array(cE*2)}}if(cH.geometry.skinWeights.length&&cH.geometry.skinIndices.length){cI.__skinIndexArray=new Float32Array(cE*4);cI.__skinWeightArray=new Float32Array(cE*4)}cI.__faceArray=new Uint16Array(cK*3);cI.__lineArray=new Uint16Array(cP*2);var cF,cJ;if(cI.numMorphTargets){cI.__morphTargetsArrays=[];for(cF=0,cJ=cI.numMorphTargets;cF<cJ;cF++){cI.__morphTargetsArrays.push(new Float32Array(cE*3))}}if(cI.numMorphNormals){cI.__morphNormalsArrays=[];for(cF=0,cJ=cI.numMorphNormals;cF<cJ;cF++){cI.__morphNormalsArrays.push(new Float32Array(cE*3))}}cI.__webglFaceCount=cK*3;cI.__webglLineCount=cP*2;cI.__inittedArrays=true}function al(cF,cE){return cF.material instanceof s.MeshFaceMaterial?cF.material.materials[cE.materialIndex]:cF.material}function ch(cE){return cE&&cE.shading!==undefined&&cE.shading===s.SmoothShading}function bp(cE){if((cE instanceof s.MeshBasicMaterial&&!cE.envMap)){return false}if(ch(cE)){return s.SmoothShading}else{return s.FlatShading}}function cp(cE){if(cE.vertexColors){return cE.vertexColors}return false}function cb(cE){if(cE.map||cE.lightMap||cE.bumpMap||cE.normalMap||cE.specularMap||cE instanceof s.ShaderMaterial){return true}return false}function ac(cH){var cE,cG,cF;for(cE in cH.attributes){if(cE==="index"){cF=w.ELEMENT_ARRAY_BUFFER}else{cF=w.ARRAY_BUFFER}cG=cH.attributes[cE];cG.buffer=w.createBuffer();w.bindBuffer(cF,cG.buffer);w.bufferData(cF,cG.array,w.STATIC_DRAW)}}s.bufferIDCount=0;s.vertexComponentBits={POSITION:1,NORMAL:2,UV:4,UV2:8,COLOR:16,TANGENT:32,BINORMAL:64,PREVIOUSPOS:128,NEXTPOS:256,SIDEEXTR:512,LINEDIST:1024,SKININDEX:2048,SKINWEIGHT:4096};this.sharingIntermediaryArray=null;this.sharingIntermediaryIndexArray=null;this.newMaterialInheritance=false;this.initSharedBuffersDS=function(dg,c5){if(dg.length==0){return}var c4=s.vertexComponentBits;var cP=2097152;var c7=Number.MAX_SAFE_INTEGER;var cH=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;if(cH){var dd=parseFloat(navigator.userAgent.substr(navigator.userAgent.length-4));if(dd>=60){c7=250}}var cM=!!navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform);var cN=navigator.userAgent.toLowerCase().indexOf("edge")>-1;var df=cM&&!cN;var cQ=[];var da={};var cE={};var cJ=[];for(var dc=dg.length-1;dc>=0;dc--){var cR=dg[dc].object.geometry;var cX=dg[dc];dg.splice(dc,1);if(cR._type===2){cR=[cR]}for(var db=0;db<cR.length;db++){var cO=cR[db];if(!cO){continue}if(cO.vertexBuffer&&cO.vertexBuffer.isShared){continue}if(cE[cO.id]){cJ.push(cX);continue}if(!cO.vertexIndexArray){console.warn("no geometry available, are you trying to reattach a mesh while noMeshInRAM has been activated?");continue}cE[cO.id]=true;var de=(cO.vertexPositionArray?c4.POSITION:0)+(cO.vertexNormalArray?c4.NORMAL:0)+(cO.vertexUvArray?c4.UV:0)+(cO.vertexUv2Array?c4.UV2:0)+(cO.vertexColorArray?c4.COLOR:0)+(cO.vertexTangentArray?c4.TANGENT:0)+(cO.vertexBinormalArray?c4.BINORMAL:0)+(cO.vertexPreviousPositionArray?c4.PREVIOUSPOS:0)+(cO.vertexNextPositionArray?c4.NEXTPOS:0)+(cO.vertexSideExtrusionArray?c4.SIDEEXTR:0)+(cO.vertexLineDistancesArray?c4.LINEDIST:0)+(cO.vertexSkinIndexArray?c4.SKININDEX:0)+(cO.vertexSkinWeightArray?c4.SKINWEIGHT:0);var cG=da[de];if(!cG){cG={webglObjects:[],geoms:[],type:de,dgCount:0,verticeCount:0,indexCount:0,initialize:c5};da[de]=cG;cQ.push(cG)}cG.geoms.push(cO);cG.verticeCount+=cO.compressedVertices?cO.vertexPositionArray.length/2:cO.vertexPositionArray.length/3;cG.indexCount+=cO.vertexIndexArray.length;cG.dgCount+=cO.drawingGroups.length;cG.webglObjects.push(cX);if(cG.verticeCount>cP||cG.dgCount>c7){cG.initialize=true;da[de]=null}}}for(var c3=0;c3<cQ.length;c3++){var cG=cQ[c3];if(cG.initialize){var cT=cG.geoms.length>0&&cG.geoms[0].compressedNormals;var cL=cG.geoms.length>0&&cG.geoms[0].compressedVertices;var c1=new s.InterleavedBuffer(cG.type,w,s.bufferIDCount++,c4,cT,cL);c1.numItems=cG.verticeCount;c1.indexNumItems=cG.indexCount;c1.nbGeometries=cG.geoms.length;c1.geometries=cG.geoms;c1.isShared=true;bm.info.memory.sharedbuffers++;var cW=c1.itemSize*cG.verticeCount;var cI=null;var c2=null;w.bindBuffer(w.ARRAY_BUFFER,c1.buffer);if(!df){if(this.sharingIntermediaryArray&&this.sharingIntermediaryArray.length>=cW){cI=this.sharingIntermediaryArray}else{cI=new Float32Array(c1.itemSize*cG.verticeCount);this.sharingIntermediaryArray=cI}if(this.sharingIntermediaryIndexArray&&this.sharingIntermediaryIndexArray.length>=c1.indexNumItems){c2=this.sharingIntermediaryIndexArray}else{if(s.supportedExtensions.elementIndexUint){c2=new Uint32Array(c1.indexNumItems)}else{c2=new Uint16Array(c1.indexNumItems)}this.sharingIntermediaryIndexArray=c2}}else{w.bufferData(w.ARRAY_BUFFER,cW*4,w.STATIC_DRAW)}var c9=0;var c0=new Uint32Array(cG.geoms.length);for(var c6=0;c6<cG.geoms.length;c6++){var cO=cG.geoms[c6];if(cO.vertexBuffer){cO.deallocate(w,bm.info)}cO.vertexBuffer=c1;cO.itemSize=1;cO.numItems=cO.vertexIndexArray.length;cO.use32bitIndexBuffer=s.supportedExtensions.elementIndexUint&&(!df||c1.numItems>65535);if(cO.use32bitIndexBuffer){cO.numBytesIndex=4;cO.glFormatTypeIndex=w.UNSIGNED_INT}cO._setAttributesSizeAndOffset();var cU=cL?cO.vertexPositionArray.length/2:cO.vertexPositionArray.length/3;cO.verticeCount=cU;var cY=c9;c0[c6]=c9;if(df){cI=new Float32Array(c1.itemSize*cU);var c9=0}for(var dc=0;dc<cU;++dc){if(cO.compressedVertices){cI[c9++]=cO.vertexPositionArray[2*dc];cI[c9++]=cO.vertexPositionArray[2*dc+1]}else{cI[c9++]=cO.vertexPositionArray[3*dc];cI[c9++]=cO.vertexPositionArray[3*dc+1];cI[c9++]=cO.vertexPositionArray[3*dc+2]}if(cO.vertexNormalArray){if(cO.compressedNormals){cI[c9++]=cO.vertexNormalArray[dc]}else{cI[c9++]=cO.vertexNormalArray[3*dc];cI[c9++]=cO.vertexNormalArray[3*dc+1];cI[c9++]=cO.vertexNormalArray[3*dc+2]}}if(cO.vertexUvArray){cI[c9++]=cO.vertexUvArray[3*dc];cI[c9++]=cO.vertexUvArray[3*dc+1]}if(cO.vertexUv2Array){cI[c9++]=cO.vertexUv2Array[3*dc];cI[c9++]=cO.vertexUv2Array[3*dc+1]}if(cO.vertexColorArray){cI[c9++]=cO.vertexColorArray[4*dc];cI[c9++]=cO.vertexColorArray[4*dc+1];cI[c9++]=cO.vertexColorArray[4*dc+2];cI[c9++]=cO.vertexColorArray[4*dc+3]}if(cO.vertexTangentArray){cI[c9++]=cO.vertexTangentArray[3*dc];cI[c9++]=cO.vertexTangentArray[3*dc+1];cI[c9++]=cO.vertexTangentArray[3*dc+2]}if(cO.vertexBinormalArray){cI[c9++]=cO.vertexBinormalArray[3*dc];cI[c9++]=cO.vertexBinormalArray[3*dc+1];cI[c9++]=cO.vertexBinormalArray[3*dc+2]}if(cO.vertexPreviousPositionArray){cI[c9++]=cO.vertexPreviousPositionArray[3*dc];cI[c9++]=cO.vertexPreviousPositionArray[3*dc+1];cI[c9++]=cO.vertexPreviousPositionArray[3*dc+2]}if(cO.vertexNextPositionArray){cI[c9++]=cO.vertexNextPositionArray[3*dc];cI[c9++]=cO.vertexNextPositionArray[3*dc+1];cI[c9++]=cO.vertexNextPositionArray[3*dc+2]}if(cO.vertexSideExtrusionArray){cI[c9++]=cO.vertexSideExtrusionArray[dc]}if(cO.vertexLineDistancesArray){cI[c9++]=cO.vertexLineDistancesArray[2*dc];cI[c9++]=cO.vertexLineDistancesArray[2*dc+1]}if(cO.vertexSkinIndexArray){cI[c9++]=cO.vertexSkinIndexArray[4*dc];cI[c9++]=cO.vertexSkinIndexArray[4*dc+1];cI[c9++]=cO.vertexSkinIndexArray[4*dc+2];cI[c9++]=cO.vertexSkinIndexArray[4*dc+3]}if(cO.vertexSkinWeightArray){cI[c9++]=cO.vertexSkinWeightArray[4*dc];cI[c9++]=cO.vertexSkinWeightArray[4*dc+1];cI[c9++]=cO.vertexSkinWeightArray[4*dc+2];cI[c9++]=cO.vertexSkinWeightArray[4*dc+3]}}if(df){c9+=cY;w.bufferSubData(w.ARRAY_BUFFER,cY*4,cI)}if(cO.noMeshInRAM){cO.vertexPositionArray=null;if(cO.vertexNormalArray){cO.vertexNormalArray=null}if(cO.vertexUvArray){cO.vertexUvArray=null}if(cO.vertexUv2Array){cO.vertexUv2Array=null}if(cO.vertexColorArray){cO.vertexColorArray=null}if(cO.vertexTangentArray){cO.vertexTangentArray=null}if(cO.vertexBinormalArray){cO.vertexBinormalArray=null}if(cO.vertexPreviousPositionArray){cO.vertexPreviousPositionArray=null}if(cO.vertexNextPositionArray){cO.vertexNextPositionArray=null}if(cO.vertexSideExtrusionArray){cO.vertexSideExtrusionArray=null}if(cO.vertexLineDistancesArray){cO.vertexLineDistancesArray=null}if(cO.vertexSkinIndexArray){cO.vertexSkinIndexArray=null}if(cO.vertexSkinWeightArray){cO.vertexSkinWeightArray=null}}bm.info.memory.geometries++}if(!df){w.bufferData(w.ARRAY_BUFFER,cI.subarray(0,cW),w.STATIC_DRAW)}w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,c1.indexBuffer);if(df){if(cO.use32bitIndexBuffer){w.bufferData(w.ELEMENT_ARRAY_BUFFER,c1.indexNumItems*4,w.STATIC_DRAW)}else{w.bufferData(w.ELEMENT_ARRAY_BUFFER,c1.indexNumItems*2,w.STATIC_DRAW)}}var cK=0;for(var c6=0;c6<cG.geoms.length;c6++){var cO=cG.geoms[c6];cO.indexOffset=cK;var cZ=cK;var c8=cO.vertexIndexArray.length;var cV=c0[c6]/c1.itemSize;if(df){if(cO.use32bitIndexBuffer){c2=new Uint32Array(c8)}else{c2=new Uint16Array(c8)}cK=0}for(var dc=0;dc<c8;++dc){c2[cK++]=cV+cO.vertexIndexArray[dc]}if(cO.noMeshInRAM){cO.vertexIndexArray=null}if(df){cK+=cZ;w.bufferSubData(w.ELEMENT_ARRAY_BUFFER,cZ*cO.numBytesIndex,c2)}}if(!df){w.bufferData(w.ELEMENT_ARRAY_BUFFER,c2.subarray(0,c1.indexNumItems),w.STATIC_DRAW)}for(var cF=0;cF<cG.webglObjects.length;cF++){cG.webglObjects[cF].sortKey=c1.id}}else{for(var cF=0;cF<cG.webglObjects.length;cF++){var cS=cG.webglObjects[cF];dg.push(cS)}}}for(var dc=0;dc<cJ.length;dc++){var cR=cJ[dc].object.geometry;if(cR._type===2){cR=[cR]}if(cR[0].vertexBuffer&&cR[0].vertexBuffer.isShared){cJ[dc].sortKey=cR[0].vertexBuffer.id}else{dg.push(cJ[dc])}}if(c5){this.sharingIntermediaryArray=null;this.sharingIntermediaryIndexArray=null}};this.initDirectBuffersDS=function(cN,cH){var cE=s.vertexComponentBits;if(cN.vertexPositionArray&&!cN.vertexBuffer){var cO=cN.compressedVertices?cN.vertexPositionArray.length/2:cN.vertexPositionArray.length/3;cN.verticeCount=cO;var cL;var cM=(cN.vertexPositionArray?cE.POSITION:0)+(cN.vertexNormalArray?cE.NORMAL:0)+(cN.vertexUvArray?cE.UV:0)+(cN.vertexUv2Array?cE.UV2:0)+(cN.vertexColorArray?cE.COLOR:0)+(cN.vertexTangentArray?cE.TANGENT:0)+(cN.vertexBinormalArray?cE.BINORMAL:0)+(cN.vertexPreviousPositionArray?cE.PREVIOUSPOS:0)+(cN.vertexNextPositionArray?cE.NEXTPOS:0)+(cN.vertexSideExtrusionArray?cE.SIDEEXTR:0)+(cN.vertexLineDistancesArray?cE.LINEDIST:0)+(cN.vertexSkinIndexArray?cE.SKININDEX:0)+(cN.vertexSkinWeightArray?cE.SKINWEIGHT:0);cL=new s.InterleavedBuffer(cM,w,s.bufferIDCount++,cE,cN.compressedNormals,cN.compressedVertices);cL.nbGeometries=1;var cQ=cL.numItems;if(cN.vertexPositionArray!==null){cN.vertexBuffer=cL;w.bindBuffer(w.ARRAY_BUFFER,cN.vertexBuffer.buffer);cN._setAttributesSizeAndOffset();var cK=new Float32Array(cL.itemSize*cO);var cI=0;for(var cJ=0;cJ<cO;++cJ){if(cN.compressedVertices){cK[cI++]=cN.vertexPositionArray[2*cJ];cK[cI++]=cN.vertexPositionArray[2*cJ+1]}else{cK[cI++]=cN.vertexPositionArray[3*cJ];cK[cI++]=cN.vertexPositionArray[3*cJ+1];cK[cI++]=cN.vertexPositionArray[3*cJ+2]}if(cN.vertexNormalArray){if(cN.compressedNormals){cK[cI++]=cN.vertexNormalArray[cJ]}else{cK[cI++]=cN.vertexNormalArray[3*cJ];cK[cI++]=cN.vertexNormalArray[3*cJ+1];cK[cI++]=cN.vertexNormalArray[3*cJ+2]}}if(cN.vertexUvArray){cK[cI++]=cN.vertexUvArray[3*cJ];cK[cI++]=cN.vertexUvArray[3*cJ+1]}if(cN.vertexUv2Array){cK[cI++]=cN.vertexUv2Array[3*cJ];cK[cI++]=cN.vertexUv2Array[3*cJ+1]}if(cN.vertexColorArray){cK[cI++]=cN.vertexColorArray[4*cJ];cK[cI++]=cN.vertexColorArray[4*cJ+1];cK[cI++]=cN.vertexColorArray[4*cJ+2];cK[cI++]=cN.vertexColorArray[4*cJ+3]}if(cN.vertexTangentArray){cK[cI++]=cN.vertexTangentArray[3*cJ];cK[cI++]=cN.vertexTangentArray[3*cJ+1];cK[cI++]=cN.vertexTangentArray[3*cJ+2]}if(cN.vertexBinormalArray){cK[cI++]=cN.vertexBinormalArray[3*cJ];cK[cI++]=cN.vertexBinormalArray[3*cJ+1];cK[cI++]=cN.vertexBinormalArray[3*cJ+2]}if(cN.vertexPreviousPositionArray){cK[cI++]=cN.vertexPreviousPositionArray[3*cJ];cK[cI++]=cN.vertexPreviousPositionArray[3*cJ+1];cK[cI++]=cN.vertexPreviousPositionArray[3*cJ+2]}if(cN.vertexNextPositionArray){cK[cI++]=cN.vertexNextPositionArray[3*cJ];cK[cI++]=cN.vertexNextPositionArray[3*cJ+1];cK[cI++]=cN.vertexNextPositionArray[3*cJ+2]}if(cN.vertexSideExtrusionArray){cK[cI++]=cN.vertexSideExtrusionArray[cJ]}if(cN.vertexLineDistancesArray){cK[cI++]=cN.vertexLineDistancesArray[2*cJ];cK[cI++]=cN.vertexLineDistancesArray[2*cJ+1]}if(cN.vertexSkinIndexArray){cK[cI++]=cN.vertexSkinIndexArray[4*cJ];cK[cI++]=cN.vertexSkinIndexArray[4*cJ+1];cK[cI++]=cN.vertexSkinIndexArray[4*cJ+2];cK[cI++]=cN.vertexSkinIndexArray[4*cJ+3]}if(cN.vertexSkinWeightArray){cK[cI++]=cN.vertexSkinWeightArray[4*cJ];cK[cI++]=cN.vertexSkinWeightArray[4*cJ+1];cK[cI++]=cN.vertexSkinWeightArray[4*cJ+2];cK[cI++]=cN.vertexSkinWeightArray[4*cJ+3]}}if(cN.editable){cN.vertexBuffer.interleavedData=cK;w.bufferData(w.ARRAY_BUFFER,cK,w.DYNAMIC_DRAW)}else{w.bufferData(w.ARRAY_BUFFER,cK,w.STATIC_DRAW)}cL.numItems+=cO;bm.info.memory.geometries++}if(cN.vertexIndexArray!==null){w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,cL.indexBuffer);var cF=0;w.bufferData(w.ELEMENT_ARRAY_BUFFER,cN.vertexIndexArray,w.STATIC_DRAW);cN.use32bitIndexBuffer=cN.vertexIndexArray instanceof Uint32Array;if(cN.use32bitIndexBuffer){cN.numBytesIndex=4;cN.glFormatTypeIndex=w.UNSIGNED_INT}else{cN.numBytesIndex=2;cN.glFormatTypeIndex=w.UNSIGNED_SHORT}cL.indexBuffer.itemSize=1;cN.indexOffset=cL.indexNumItems;cL.indexNumItems+=cN.vertexIndexArray.length;cN.itemSize=1;cN.numItems=cN.vertexIndexArray.length}cL.geometries.push(cN);if(cN.noMeshInRAM&&!cN.sharedBuffers&&!cN.editable){if(cN.vertexPositionArray){cN.vertexPositionArray=null}if(cN.vertexIndexArray){cN.vertexIndexArray=null}if(cN.vertexNormalArray){cN.vertexNormalArray=null}if(cN.vertexUvArray){cN.vertexUvArray=null}if(cN.vertexUv2Array){cN.vertexUv2Array=null}if(cN.vertexColorArray){cN.vertexColorArray=null}if(cN.vertexTangentArray){cN.vertexTangentArray=null}if(cN.vertexBinormalArray){cN.vertexBinormalArray=null}if(cN.vertexPreviousPositionArray){cN.vertexPreviousPositionArray=null}if(cN.vertexNextPositionArray){cN.vertexNextPositionArray=null}if(cN.vertexSideExtrusionArray){cN.vertexSideExtrusionArray=null}if(cN.vertexLineDistancesArray){cN.vertexLineDistancesArray=null}if(cN.vertexSkinIndexArray){cN.vertexSkinIndexArray=null}if(cN.vertexSkinWeightArray){cN.vertexSkinWeightArray=null}}}if(cH&&cH._instancingInfos&&cH._instancingInfos.instanceAttribArrays){var cP=cH._instancingInfos.instanceAttribArrays;for(var cG in cP){if(cG!=="id"&&cP[cG].array!==null&&cP[cG].buffer===null){cP[cG].buffer=w.createBuffer();w.bindBuffer(w.ARRAY_BUFFER,cP[cG].buffer);if(cP[cG].isDynamic){w.bufferData(w.ARRAY_BUFFER,cP[cG].array,w.DYNAMIC_DRAW)}else{w.bufferData(w.ARRAY_BUFFER,cP[cG].array,w.STATIC_DRAW)}cP[cG].buffer.itemSize=cH._instancingInfos.instanceAttribArrays[cG].itemSize;cP[cG].buffer.numItems=cH._instancingInfos.nbInstances}}}};function bz(cM,cE){var cO=cM[cE];var cF=cM.vertexLayout[cE];var cK=cM.vertexBuffer.interleavedData;var cP=cM.vertexBuffer.itemSize;var cI=cP*cF.start;var cL=(cF.isUVs);var cN=cL?3:cF.itemSize;var cG=cN*cF.start;for(var cJ=0;cJ<cF.count;++cJ){cI+=cF.offset/4;for(var cH=0;cH<cF.itemSize;cH++){cK[cI+cH]=cO[cG++]}if(cL){cG++}cI+=cP-cF.offset/4}cF.needsUpdate=false;cF.start=-1;cF.count=-1}function aY(cJ){var cE=cJ.vertexBuffer;var cI=cE.interleavedData;var cG=cE.itemSize;var cK=4*cG*cE.start;var cF=cG*cE.count;var cH=new Float32Array(cI.buffer,cK,cF);w.bindBuffer(w.ARRAY_BUFFER,cE.buffer);w.bufferSubData(w.ARRAY_BUFFER,cK,cH);cE.needsUpdate=false;cE.start=null;cE.count=null}function bh(cJ){var cE=cJ.vertexIndexArray;var cG=cJ.vertexLayout.vertexIndexArray;var cH=cJ.use32bitIndexBuffer?4:2;var cK=cH*cG.start;var cF=cG.count;var cI=new Uint16Array(cE.buffer,cK,cF);w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,cJ.vertexBuffer.indexBuffer);w.bufferSubData(w.ELEMENT_ARRAY_BUFFER,cK,cI);cG.needsUpdate=false;cG.start=-1;cG.count=-1}function bI(cF,cR,c4){var cP,c2,c0,cH,cK,cX,cI=cF.vertices,c1=cI.length,cM=cF.colors,cL=cM.length,cQ=cF.__vertexArray,cE=cF.__colorArray,cG=cF.__sortArray,cV=cF.verticesNeedUpdate,cJ=cF.elementsNeedUpdate,cS=cF.colorsNeedUpdate,cU=cF.__webglCustomAttributesList,cY,cN,c3,cT,cO,cW,cZ;if(c4.sortParticles){ae.copy(by);ae.multiply(c4.matrixWorld);for(cP=0;cP<c1;cP++){c0=cI[cP];aC.copy(c0);aC.applyProjection(ae);cG[cP]=[aC.z,cP]}cG.sort(l);for(cP=0;cP<c1;cP++){c0=cI[cG[cP][1]];cH=cP*3;cQ[cH]=c0.x;cQ[cH+1]=c0.y;cQ[cH+2]=c0.z}for(c2=0;c2<cL;c2++){cH=c2*3;cX=cM[cG[c2][1]];cE[cH]=cX.r;cE[cH+1]=cX.g;cE[cH+2]=cX.b}}else{if(cV){for(cP=0;cP<c1;cP++){c0=cI[cP];cH=cP*3;cQ[cH]=c0.x;cQ[cH+1]=c0.y;cQ[cH+2]=c0.z}}if(cS){for(c2=0;c2<cL;c2++){cX=cM[c2];cH=c2*3;cE[cH]=cX.r;cE[cH+1]=cX.g;cE[cH+2]=cX.b}}}if(cV||c4.sortParticles){w.bindBuffer(w.ARRAY_BUFFER,cF.__webglVertexBuffer);w.bufferData(w.ARRAY_BUFFER,cQ,cR)}if(cS||c4.sortParticles){w.bindBuffer(w.ARRAY_BUFFER,cF.__webglColorBuffer);w.bufferData(w.ARRAY_BUFFER,cE,cR)}}function b4(cH,cS){var cP,c5,c3,cN,c2,cI,cY,cJ=cH.vertices,cL=cH.colors,cR=cH.lineDistances,c4=cJ.length,cK=cL.length,cZ=cR.length,cQ=cH.__vertexArray,cG=cH.__colorArray,cE=cH.__lineDistanceArray,cW=cH.verticesNeedUpdate,cT=cH.colorsNeedUpdate,cF=cH.lineDistancesNeedUpdate,cV=cH.__webglCustomAttributesList,c0,cM,c6,cU,cO,cX,c1;if(cW){for(cP=0;cP<c4;cP++){c2=cJ[cP];cI=cP*3;cQ[cI]=c2.x;cQ[cI+1]=c2.y;cQ[cI+2]=c2.z}w.bindBuffer(w.ARRAY_BUFFER,cH.__webglVertexBuffer);w.bufferData(w.ARRAY_BUFFER,cQ,cS)}if(cT){for(c5=0;c5<cK;c5++){cY=cL[c5];cI=c5*3;cG[cI]=cY.r;cG[cI+1]=cY.g;cG[cI+2]=cY.b}w.bindBuffer(w.ARRAY_BUFFER,cH.__webglColorBuffer);w.bufferData(w.ARRAY_BUFFER,cG,cS)}if(cF){for(c3=0;c3<cZ;c3++){cE[c3]=cR[c3]}w.bindBuffer(w.ARRAY_BUFFER,cH.__webglLineDistanceBuffer);w.bufferData(w.ARRAY_BUFFER,cE,cS)}}function H(dY,d4,ex,cS,ev){if(!dY.__inittedArrays){return}var du=bp(ev),cP=cp(ev),dX=cb(ev),di=(du===s.SmoothShading);var dA,eg,em,cF,cW,cK,dF,cX,dt,cG,ds,es,dO,dN,dM,dL,et,er,ep,en,el,ei,eh,ef,dV,dU,dS,dR,eb,ea,d7,d6,cO,cN,cM,cL,dp,dm,dl,dk,c7,c5,cZ,cY,dw,d1,dz,dr,db,dQ,dW,dc,dj,dv,dT,dB,dP,dE,c9=0,cU=0,d0=0,eq=0,dx=0,dh=0,cV=0,dK=0,cT=0,dy=0,cE=0,cQ=0,c0=0,dn,cJ=dY.__vertexArray,dg=dY.__uvArray,cR=dY.__uv2Array,d5=dY.__normalArray,d9=dY.__tangentArray,dH=dY.__colorArray,d3=dY.__skinIndexArray,ek=dY.__skinWeightArray,ej=dY.__morphTargetsArrays,dd=dY.__morphNormalsArrays,df=dY.__webglCustomAttributesList,cI,eo=dY.__faceArray,dD=dY.__lineArray,dZ=d4.geometry,da=dZ.verticesNeedUpdate,dC=dZ.elementsNeedUpdate,dI=dZ.uvsNeedUpdate,cH=dZ.normalsNeedUpdate,eu=dZ.tangentsNeedUpdate,d8=dZ.colorsNeedUpdate,ey=dZ.morphTargetsNeedUpdate,dJ=dZ.vertices,c8=dY.faces3,c6=dY.faces4,ec=dZ.faces,dG=dZ.faceVertexUvs[0],de=dZ.faceVertexUvs[1],ed=dZ.colors,dq=dZ.skinIndices,ee=dZ.skinWeights,ew=dZ.morphTargets,d2=dZ.morphNormals;if(da){for(dA=0,eg=c8.length;dA<eg;dA++){cF=ec[c8[dA]];dO=dJ[cF.a];dN=dJ[cF.b];dM=dJ[cF.c];cJ[cU]=dO.x;cJ[cU+1]=dO.y;cJ[cU+2]=dO.z;cJ[cU+3]=dN.x;cJ[cU+4]=dN.y;cJ[cU+5]=dN.z;cJ[cU+6]=dM.x;cJ[cU+7]=dM.y;cJ[cU+8]=dM.z;cU+=9}for(dA=0,eg=c6.length;dA<eg;dA++){cF=ec[c6[dA]];dO=dJ[cF.a];dN=dJ[cF.b];dM=dJ[cF.c];dL=dJ[cF.d];cJ[cU]=dO.x;cJ[cU+1]=dO.y;cJ[cU+2]=dO.z;cJ[cU+3]=dN.x;cJ[cU+4]=dN.y;cJ[cU+5]=dN.z;cJ[cU+6]=dM.x;cJ[cU+7]=dM.y;cJ[cU+8]=dM.z;cJ[cU+9]=dL.x;cJ[cU+10]=dL.y;cJ[cU+11]=dL.z;cU+=12}w.bindBuffer(w.ARRAY_BUFFER,dY.__webglVertexBuffer);w.bufferData(w.ARRAY_BUFFER,cJ,ex)}if(d8&&cP){for(dA=0,eg=c8.length;dA<eg;dA++){cF=ec[c8[dA]];cX=cF.vertexColors;dt=cF.color;if(cX.length===3&&cP===s.VertexColors){dV=cX[0];dU=cX[1];dS=cX[2]}else{dV=dt;dU=dt;dS=dt}dH[cT]=dV.r;dH[cT+1]=dV.g;dH[cT+2]=dV.b;dH[cT+3]=dU.r;dH[cT+4]=dU.g;dH[cT+5]=dU.b;dH[cT+6]=dS.r;dH[cT+7]=dS.g;dH[cT+8]=dS.b;cT+=9}for(dA=0,eg=c6.length;dA<eg;dA++){cF=ec[c6[dA]];cX=cF.vertexColors;dt=cF.color;if(cX.length===4&&cP===s.VertexColors){dV=cX[0];dU=cX[1];dS=cX[2];dR=cX[3]}else{dV=dt;dU=dt;dS=dt;dR=dt}dH[cT]=dV.r;dH[cT+1]=dV.g;dH[cT+2]=dV.b;dH[cT+3]=dU.r;dH[cT+4]=dU.g;dH[cT+5]=dU.b;dH[cT+6]=dS.r;dH[cT+7]=dS.g;dH[cT+8]=dS.b;dH[cT+9]=dR.r;dH[cT+10]=dR.g;dH[cT+11]=dR.b;cT+=12}if(cT>0){w.bindBuffer(w.ARRAY_BUFFER,dY.__webglColorBuffer);w.bufferData(w.ARRAY_BUFFER,dH,ex)}}if(eu&&dZ.hasTangents){for(dA=0,eg=c8.length;dA<eg;dA++){cF=ec[c8[dA]];cG=cF.vertexTangents;et=cG[0];er=cG[1];ep=cG[2];d9[cV]=et.x;d9[cV+1]=et.y;d9[cV+2]=et.z;d9[cV+3]=et.w;d9[cV+4]=er.x;d9[cV+5]=er.y;d9[cV+6]=er.z;d9[cV+7]=er.w;d9[cV+8]=ep.x;d9[cV+9]=ep.y;d9[cV+10]=ep.z;d9[cV+11]=ep.w;cV+=12}for(dA=0,eg=c6.length;dA<eg;dA++){cF=ec[c6[dA]];cG=cF.vertexTangents;et=cG[0];er=cG[1];ep=cG[2];en=cG[3];d9[cV]=et.x;d9[cV+1]=et.y;d9[cV+2]=et.z;d9[cV+3]=et.w;d9[cV+4]=er.x;d9[cV+5]=er.y;d9[cV+6]=er.z;d9[cV+7]=er.w;d9[cV+8]=ep.x;d9[cV+9]=ep.y;d9[cV+10]=ep.z;d9[cV+11]=ep.w;d9[cV+12]=en.x;d9[cV+13]=en.y;d9[cV+14]=en.z;d9[cV+15]=en.w;cV+=16}w.bindBuffer(w.ARRAY_BUFFER,dY.__webglTangentBuffer);w.bufferData(w.ARRAY_BUFFER,d9,ex)}if(cH&&du){for(dA=0,eg=c8.length;dA<eg;dA++){cF=ec[c8[dA]];cW=cF.vertexNormals;cK=cF.normal;if(cW.length===3&&di){for(dz=0;dz<3;dz++){db=cW[dz];d5[dh]=db.x;d5[dh+1]=db.y;d5[dh+2]=db.z;dh+=3}}else{for(dz=0;dz<3;dz++){d5[dh]=cK.x;d5[dh+1]=cK.y;d5[dh+2]=cK.z;dh+=3}}}for(dA=0,eg=c6.length;dA<eg;dA++){cF=ec[c6[dA]];cW=cF.vertexNormals;cK=cF.normal;if(cW.length===4&&di){for(dz=0;dz<4;dz++){db=cW[dz];d5[dh]=db.x;d5[dh+1]=db.y;d5[dh+2]=db.z;dh+=3}}else{for(dz=0;dz<4;dz++){d5[dh]=cK.x;d5[dh+1]=cK.y;d5[dh+2]=cK.z;dh+=3}}}w.bindBuffer(w.ARRAY_BUFFER,dY.__webglNormalBuffer);w.bufferData(w.ARRAY_BUFFER,d5,ex)}if(dI&&dG&&dX){for(dA=0,eg=c8.length;dA<eg;dA++){em=c8[dA];ds=dG[em];if(ds===undefined){continue}for(dz=0;dz<3;dz++){dQ=ds[dz];dg[d0]=dQ.x;dg[d0+1]=dQ.y;d0+=2}}for(dA=0,eg=c6.length;dA<eg;dA++){em=c6[dA];ds=dG[em];if(ds===undefined){continue}for(dz=0;dz<4;dz++){dQ=ds[dz];dg[d0]=dQ.x;dg[d0+1]=dQ.y;d0+=2}}if(d0>0){w.bindBuffer(w.ARRAY_BUFFER,dY.__webglUVBuffer);w.bufferData(w.ARRAY_BUFFER,dg,ex)}}if(dC){for(dA=0,eg=c8.length;dA<eg;dA++){eo[dx]=c9;eo[dx+1]=c9+1;eo[dx+2]=c9+2;dx+=3;dD[dK]=c9;dD[dK+1]=c9+1;dD[dK+2]=c9;dD[dK+3]=c9+2;dD[dK+4]=c9+1;dD[dK+5]=c9+2;dK+=6;c9+=3}for(dA=0,eg=c6.length;dA<eg;dA++){eo[dx]=c9;eo[dx+1]=c9+1;eo[dx+2]=c9+3;eo[dx+3]=c9+1;eo[dx+4]=c9+2;eo[dx+5]=c9+3;dx+=6;dD[dK]=c9;dD[dK+1]=c9+1;dD[dK+2]=c9;dD[dK+3]=c9+3;dD[dK+4]=c9+1;dD[dK+5]=c9+2;dD[dK+6]=c9+2;dD[dK+7]=c9+3;dK+=8;c9+=4}w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,dY.__webglFaceBuffer);w.bufferData(w.ELEMENT_ARRAY_BUFFER,eo,ex);w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,dY.__webglLineBuffer);w.bufferData(w.ELEMENT_ARRAY_BUFFER,dD,ex)}if(cS){delete dY.__inittedArrays;delete dY.__colorArray;delete dY.__normalArray;delete dY.__tangentArray;delete dY.__uvArray;delete dY.__uv2Array;delete dY.__binormalArray;delete dY.__faceArray;delete dY.__vertexArray;delete dY.__lineArray;delete dY.__skinIndexArray;delete dY.__skinWeightArray}}function a4(cG,cF,cE){}this.renderBufferImmediate=function(cT,cH,cJ){if(cT.hasPositions&&!cT.__webglVertexBuffer){cT.__webglVertexBuffer=w.createBuffer()}if(cT.hasNormals&&!cT.__webglNormalBuffer){cT.__webglNormalBuffer=w.createBuffer()}if(cT.hasUvs&&!cT.__webglUvBuffer){cT.__webglUvBuffer=w.createBuffer()}if(cT.hasColors&&!cT.__webglColorBuffer){cT.__webglColorBuffer=w.createBuffer()}if(cT.hasPositions){w.bindBuffer(w.ARRAY_BUFFER,cT.__webglVertexBuffer);w.bufferData(w.ARRAY_BUFFER,cT.positionArray,w.DYNAMIC_DRAW);w.enableVertexAttribArray(cH.attributes.position);w.vertexAttribPointer(cH.attributes.position,3,w.FLOAT,false,0,0)}if(cT.hasNormals){w.bindBuffer(w.ARRAY_BUFFER,cT.__webglNormalBuffer);if(cJ.shading===s.FlatShading){var cR,cQ,cO,cG,cM,cV,cF,cL,cU,cE,cK,cS,cP,cN,cI=cT.count*3;for(cN=0;cN<cI;cN+=9){cP=cT.normalArray;cG=cP[cN];cF=cP[cN+1];cE=cP[cN+2];cM=cP[cN+3];cL=cP[cN+4];cK=cP[cN+5];cV=cP[cN+6];cU=cP[cN+7];cS=cP[cN+8];cR=(cG+cM+cV)/3;cQ=(cF+cL+cU)/3;cO=(cE+cK+cS)/3;cP[cN]=cR;cP[cN+1]=cQ;cP[cN+2]=cO;cP[cN+3]=cR;cP[cN+4]=cQ;cP[cN+5]=cO;cP[cN+6]=cR;cP[cN+7]=cQ;cP[cN+8]=cO}}w.bufferData(w.ARRAY_BUFFER,cT.normalArray,w.DYNAMIC_DRAW);w.enableVertexAttribArray(cH.attributes.normal);w.vertexAttribPointer(cH.attributes.normal,3,w.FLOAT,false,0,0)}if(cT.hasUvs&&cJ.map){w.bindBuffer(w.ARRAY_BUFFER,cT.__webglUvBuffer);w.bufferData(w.ARRAY_BUFFER,cT.uvArray,w.DYNAMIC_DRAW);w.enableVertexAttribArray(cH.attributes.uv);w.vertexAttribPointer(cH.attributes.uv,2,w.FLOAT,false,0,0)}if(cT.hasColors&&cJ.vertexColors!==s.NoColors){w.bindBuffer(w.ARRAY_BUFFER,cT.__webglColorBuffer);w.bufferData(w.ARRAY_BUFFER,cT.colorArray,w.DYNAMIC_DRAW);w.enableVertexAttribArray(cH.attributes.color);w.vertexAttribPointer(cH.attributes.color,3,w.FLOAT,false,0,0)}w.drawArrays(w.TRIANGLES,0,cT.count);cT.count=0};this.renderBufferDirect=function(cX,c2,cE,cP,cH,c4){if(cP.visible===false){return}var cL,cZ,cW,cY,c1,cQ,cJ;var cO,cR,cS,cF;var cN=false;cL=bo(cX,c2,cE,cP,c4,undefined,cH,cP.programManager.getProgramID(c4));cZ=cL.attributes;cJ=cH.attributes;var cT=false,cV=cP.wireframe?1:0,c0=(cH.id*16777215)+(cL.id*2)+cV;if(c0!==ad){ad=c0;cT=true}if(cT){ce()}if(c4 instanceof s.Mesh){var cK=cJ.index;if(cK){var cI=cH.offsets;if(cI.length>1){cT=true}for(var cU=0,cM=cI.length;cU<cM;cU++){var cG=cI[cU].index;if(cT){for(cR in cJ){if(cR==="index"){continue}cS=cZ[cR];cO=cJ[cR];cF=cO.itemSize;if(cS>=0){w.bindBuffer(w.ARRAY_BUFFER,cO.buffer);aR(cS);w.vertexAttribPointer(cS,cF,w.FLOAT,false,0,cG*cF*4)}}w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,cK.buffer)}w.drawElements(w.TRIANGLES,cI[cU].count,w.UNSIGNED_SHORT,cI[cU].start*2);bm.info.render.calls++;bm.info.render.vertices+=cI[cU].count;bm.info.render.faces+=cI[cU].count/3;cN=true}}else{if(cT){for(cR in cJ){if(cR==="index"){continue}cS=cZ[cR];cO=cJ[cR];cF=cO.itemSize;if(cS>=0){w.bindBuffer(w.ARRAY_BUFFER,cO.buffer);aR(cS);w.vertexAttribPointer(cS,cF,w.FLOAT,false,0,0)}}}var c3=cH.attributes.position;w.drawArrays(w.TRIANGLES,0,c3.numItems/3);cN=true;bm.info.render.calls++;bm.info.render.vertices+=c3.numItems/3;bm.info.render.faces+=c3.numItems/3/3}}else{if(c4 instanceof s.ParticleSystem){if(cT){for(cR in cJ){cS=cZ[cR];cO=cJ[cR];cF=cO.itemSize;if(cS>=0){w.bindBuffer(w.ARRAY_BUFFER,cO.buffer);aR(cS);w.vertexAttribPointer(cS,cF,w.FLOAT,false,0,0)}}var c3=cJ.position;w.drawArrays(w.POINTS,0,c3.numItems/3);cN=true;bm.info.render.calls++;bm.info.render.points+=c3.numItems/3}}else{if(c4 instanceof s.Line){if(cT){for(cR in cJ){cS=cZ[cR];cO=cJ[cR];cF=cO.itemSize;if(cS>=0){w.bindBuffer(w.ARRAY_BUFFER,cO.buffer);aR(cS);w.vertexAttribPointer(cS,cF,w.FLOAT,false,0,0)}}bf(cP.lineWidth);var c3=cJ.position;w.drawArrays(w.LINE_STRIP,0,c3.numItems/3);cN=true;bm.info.render.calls++;bm.info.render.points+=c3.numItems}}}}return cN};var b7;this.loadingTextureMaterial=new s.MeshPhongMaterial({color:14540253});this.getRenderMode=function(cE){var cJ=s.RenderMode;if(!b7){b7=new cJ()}var cG=this.renderLineMode!==null?this.renderLineMode:s.ShowAllRenderLineMode;var cH=this.renderPointMode||0;var cM=this.renderFaceMode;var cL=b7;var cK=cE&&cE._occurrence;var cI=this.outlineWidth;if(cK){var cF=cK.renderMode;if(cF){if(cF._useRenderLineMask){cG=cF._mask}if(cF._useRenderPointMask){cH=cF._mask}if(cF._useRenderFaceMask){cM=cF._mask}cI=cF._outlineWidth}}cL._setFromMasks(cH,cG,cM);cL.setOutlineWidth(cI);return cL};this.getMaterialMode=function(cE){if(cE&&cE._occurrence&&cE._occurrence.faceMode!==null){return cE._occurrence.faceMode===s.RenderStyle.FaceModes.MATERIAL}else{if(cE.materialMode<2){return !!cE.materialMode}}return this.materialMode};this.getRenderLineMode=function(cF){var cG;var cE=cF&&cF._occurrence&&cF._occurrence.renderMode;if(cE&&cE._useRenderLineMask){cG=cE.getRenderLineMode()}else{if(this.renderLineMode!==null){cG=this.renderLineMode}else{cG=s.ShowAllRenderLineMode}}return cG};this.recompileAllShaders=function(){w.WebVisuShaderVersion++};this.setupPickingMaterial=function(cI,cL,cG){var cJ=cG.pickingID.getHex();var cE=0;if((cL==w.LINES)||(cI&&cI.lineWidth)){var cH=4194304;cE=cJ|cH}else{if(cL==w.TRIANGLES){var cK=8388608;cE=cJ|cK}else{if(cL==w.POINTS){cE=cJ}}}var cF=new s.Color(cE);if(cI.uniforms&&cI.uniforms.pickingColor){cI.uniforms.pickingColor.value=cF}else{cI.color=cF}};this.renderInterval=function(cT,cJ,dd,c2,db,cG,cL,cN,cX,c6,c3,cM,cP,c5){if(cN.glType===w.TRIANGLES){bm.info.render.nbTriangles+=c6/3}bm.info.render.nbDGs++;bm.info.render.nbReps+=cN.cullingData?cN.cullingData.length:1;var cZ=0;if(cN.cullingData&&!cT.isOrtho){var cS=(cN.glType===w.TRIANGLES)?c6/3:c6/2;cS/=cN.cullingData.length;if(cS>this.ratioSSB){var c9=cT.performPixelCullingOnDG(c5,c2,cL,cN,cX,c6);bm.info.render.nbDGsSSBProcessed++;if(cN.glType===w.TRIANGLES){bm.info.render.culledDGTriangles+=(c6-c9)/3}else{if(cN.glType===w.LINES){bm.info.render.culledDGLines+=(c6-c9)/2}}cZ=1-c9/(c6+1);if(!this.colorizeSSB){c6=c9}if(c6===0){return false}}}var cE=null;var c1=null;var cU=null;var cV=cN.glType;var da=(cV===w.TRIANGLES)||(cV===w.TRIANGLE_STRIP);if((cV===w.POINTS)&&!this.renderPoints){return false}if(da&&!this.renderFaces){return false}var cI=c2._instancingInfos?c2._instancingInfos.instanceAttribArrays:null;var c8=c2._instancingInfos&&cI!==null;var df=cL.vertexBuffer;var c7=false;if(cL.needsUpdate){cL.needsUpdate=false;cL.deallocate(w,bm.info);c7=true}if(da&&!db.polygonOffset){cz(this.forcePolygonOffset===s.PolygonOffsetForceStatus.DEFAULT?c2.renderLineMode!==0:this.forcePolygonOffset===s.PolygonOffsetForceStatus.ENABLED,1,1)}var cO=w._currentProgram;var cK=db.programManager.getProgramID(c2);if(cP||cK!==W){db.previousOccurrenceRenderingOverride=null;bo(cT,cJ,dd,db,c2,cM,cL,cK)}else{var c4=db.program.objectUniformLocations;this.loadObjectUniforms(c4,c2,cL,db,cT,cJ)}if(db._picking){this.setupPickingMaterial(db,cV,c2);var c4=db.program.uniformLocations;if(db.uniforms&&db.uniforms.pickingColor){w.uniform3f(c4.pickingColor,db.uniforms.pickingColor.value.r,db.uniforms.pickingColor.value.g,db.uniforms.pickingColor.value.b)}else{w.uniform3f(c4.diffuse,db.color.r,db.color.g,db.color.b)}}if(this.colorizeSSB&&cZ&&!db._picking){var c4=db.program.uniformLocations;c4.diffuse&&w.uniform3f(c4.diffuse,cZ,0,0)}if(db.map&&db.map.lods){db.map.chooseTexture(cT,c2)}cE=db.program;c1=cE.attributes;cU=cE.instanceAttributes;var de=false;if(cE.uvOrBinOrTan){if(!cL.vertexBuffer||!(s.vertexComponentBits.UV&cL.vertexBuffer.vbType)){if(!cL.compressedNormals){if(!cL.vertexIndexArray){console.warn("computeUVs unavailable, make sure noMeshInRAM is inactive")}else{cL.computeUVs();cL.deallocate(w,bm.info);c7=true}}}}if(!cL.vertexBuffer){if(cL.vertexUvArray&&cL.vertexNormalArray&&(((c1.binormal>=0)&&!cL.vertexBinormalArray)||((c1.tangent>=0)&&!cL.vertexTangentArray))){cL.computeTangents();cL.deallocate(w,bm.info);c7=true}}else{if((a.vertexComponentBits.UV&cL.vertexBuffer.vbType)&&(a.vertexComponentBits.NORMAL&cL.vertexBuffer.vbType)&&(((c1.binormal>=0)&&!(a.vertexComponentBits.BINORMAL&cL.vertexBuffer.vbType))||((c1.tangent>=0)&&!(a.vertexComponentBits.TANGENT&cL.vertexBuffer.vbType)))){if(!cL.vertexIndexArray){console.warn("computeTangents unavailable, make sure noMeshInRAM is inactive")}else{cL.computeTangents();cL.deallocate(w,bm.info);c7=true}}}if(!df){c7=true}if(c8){if(bS!==cI.id){bS=cI.id;de=true}for(var cF in cI){if(cF!=="id"){if(!cI[cF].buffer){c7=true;break}else{if(cI[cF].isDynamic){w.bindBuffer(w.ARRAY_BUFFER,cI[cF].buffer);w.bufferData(w.ARRAY_BUFFER,cI[cF].array,w.DYNAMIC_DRAW);cI[cF].isDynamic=false}}}}}if(c7){this.initDirectBuffersDS(cL,c2);df=cL.vertexBuffer}if(!df){return false}if(df&&df.needsUpdate){var cR=cL.vertexLayout;if(cL.vertexPositionArray&&cR.vertexPositionArray.needsUpdate){bz(cL,"vertexPositionArray")}if(cL.vertexNormalArray&&cR.vertexNormalArray.needsUpdate){bz(cL,"vertexNormalArray")}if(cL.vertexUvArray&&cR.vertexUvArray.needsUpdate){bz(cL,"vertexUvArray")}if(cL.vertexUv2Array&&cR.vertexUv2Array.needsUpdate){bz(cL,"vertexUv2Array")}if(cL.vertexColorArray&&cR.vertexColorArray.needsUpdate){bz(cL,"vertexColorArray")}if(cL.vertexTangentArray&&cR.vertexTangentArray.needsUpdate){bz(cL,"vertexTangentArray")}if(cL.vertexBinormalArray&&cR.vertexBinormalArray.needsUpdate){bz(cL,"vertexBinormalArray")}if(cL.vertexPreviousPositionArray&&cR.vertexPreviousPositionArray.needsUpdate){bz(cL,"vertexPreviousPositionArray")}if(cL.vertexNextPositionArray&&cR.vertexNextPositionArray.needsUpdate){bz(cL,"vertexNextPositionArray")}if(cL.vertexSideExtrusionArray&&cR.vertexSideExtrusionArray.needsUpdate){bz(cL,"vertexSideExtrusionArray")}if(cL.vertexLineDistancesArray&&cR.vertexLineDistancesArray.needsUpdate){bz(cL,"vertexLineDistancesArray")}aY(cL);if(cL.vertexIndexArray&&cR.vertexIndexArray.needsUpdate){bh(cL)}}if(df!==bD){bD=df;de=true}if(de){var cQ=df.itemSize*4;w.bindBuffer(w.ARRAY_BUFFER,df.buffer);w.vertexAttribPointer(c1.position,cL.compressedVertices?2:3,w.FLOAT,false,cQ,0);if(c1.normal>=0&&(a.vertexComponentBits.NORMAL&df.vbType)){w.vertexAttribPointer(c1.normal,cL.compressedNormals?1:3,w.FLOAT,false,cQ,df.normalOffset)}if(c1.uv>=0&&(a.vertexComponentBits.UV&df.vbType)){w.vertexAttribPointer(c1.uv,2,w.FLOAT,false,cQ,df.uvOffset)}if(c1.uv2>=0&&(a.vertexComponentBits.UV2&df.vbType)){w.vertexAttribPointer(c1.uv2,2,w.FLOAT,false,cQ,df.uv2Offset)}if(c1.binormal>=0&&(a.vertexComponentBits.BINORMAL&df.vbType)){w.vertexAttribPointer(c1.binormal,3,w.FLOAT,false,cQ,df.binormalOffset)}if(c1.tangent>=0&&(a.vertexComponentBits.TANGENT&df.vbType)){w.vertexAttribPointer(c1.tangent,3,w.FLOAT,false,cQ,df.tangentOffset)}if(c1.color>=0&&(a.vertexComponentBits.COLOR&df.vbType)){w.vertexAttribPointer(c1.color,4,w.FLOAT,false,cQ,df.colorOffset)}if(c1.lineDistance>=0&&(a.vertexComponentBits.LINEDIST&df.vbType)){w.vertexAttribPointer(c1.lineDistance,2,w.FLOAT,false,cQ,df.lineDistancesOffset)}if(c1.previousPos>=0&&(a.vertexComponentBits.PREVIOUSPOS&df.vbType)){w.vertexAttribPointer(c1.previousPos,3,w.FLOAT,false,cQ,df.previousPositionOffset)}if(c1.followingPos>=0&&(a.vertexComponentBits.NEXTPOS&df.vbType)){w.vertexAttribPointer(c1.followingPos,3,w.FLOAT,false,cQ,df.nextPositionOffset)}if(c1.sideExtrusion>=0&&(a.vertexComponentBits.SIDEEXTR&df.vbType)){w.vertexAttribPointer(c1.sideExtrusion,1,w.FLOAT,false,cQ,df.sideExtrusionOffset)}if(c1.skinIndex>=0&&(a.vertexComponentBits.SKININDEX&df.vbType)){w.vertexAttribPointer(c1.skinIndex,4,w.FLOAT,false,cQ,df.skinIndexOffset)}if(c1.skinIndex>=0&&(a.vertexComponentBits.SKINWEIGHT&df.vbType)){w.vertexAttribPointer(c1.skinWeight,4,w.FLOAT,false,cQ,df.skinWeightOffset)}if(c8){for(var cW in cI){if(cW!=="id"){w.bindBuffer(w.ARRAY_BUFFER,cI[cW].buffer);if(cU[cW]>=0&&cI[cW].array){if(cI[cW].isMat4){w.vertexAttribPointer(cU[cW],cI[cW].itemSize,w.FLOAT,false,64,0);w.vertexAttribPointer(cU[cW]+1,cI[cW].itemSize,w.FLOAT,false,64,16);w.vertexAttribPointer(cU[cW]+2,cI[cW].itemSize,w.FLOAT,false,64,32);w.vertexAttribPointer(cU[cW]+3,cI[cW].itemSize,w.FLOAT,false,64,48)}else{w.vertexAttribPointer(cU[cW],cI[cW].itemSize,w.FLOAT,false,0,0)}}}}}w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,df.indexBuffer)}if(cO!=w._currentProgram){var c0={};c0[c1.position]=true;if(c1.normal>=0&&(a.vertexComponentBits.NORMAL&df.vbType)){c0[c1.normal]=true}if(c1.uv>=0&&(a.vertexComponentBits.UV&df.vbType)){c0[c1.uv]=true}if(c1.uv2>=0&&(a.vertexComponentBits.UV2&df.vbType)){c0[c1.uv2]=true}if(c1.tangent>=0&&(a.vertexComponentBits.TANGENT&df.vbType)){c0[c1.tangent]=true}if(c1.binormal>=0&&(a.vertexComponentBits.BINORMAL&df.vbType)){c0[c1.binormal]=true}if(c1.color>=0&&(a.vertexComponentBits.COLOR&df.vbType)){c0[c1.color]=true}if(c1.lineDistance>=0){c0[c1.lineDistance]=true}if(c1.previousPos>=0){c0[c1.previousPos]=true}if(c1.followingPos>=0){c0[c1.followingPos]=true}if(c1.sideExtrusion>=0){c0[c1.sideExtrusion]=true}if(c1.skinIndex>=0&&(a.vertexComponentBits.SKININDEX&df.vbType)){c0[c1.skinIndex]=true}if(c1.skinWeight>=0&&(a.vertexComponentBits.SKINWEIGHT&df.vbType)){c0[c1.skinWeight]=true}if(c8){for(var cW in cI){if(cW!=="id"){if(cU[cW]>=0){if(cI[cW].isMat4){c0[cU[cW]]=true;c0[cU[cW]+1]=true;c0[cU[cW]+2]=true;c0[cU[cW]+3]=true}else{c0[cU[cW]]=true}}}}}am(c0)}var cH=cL.numBytesIndex;var dc=cL.glFormatTypeIndex;if(c8){for(var cW in cI){if(cW!=="id"){if(cU[cW]>=0&&cI[cW].array){if(cI[cW].isMat4){I.vertexAttribDivisorANGLE(cU[cW],1);I.vertexAttribDivisorANGLE(cU[cW]+1,1);I.vertexAttribDivisorANGLE(cU[cW]+2,1);I.vertexAttribDivisorANGLE(cU[cW]+3,1)}else{I.vertexAttribDivisorANGLE(cU[cW],1)}}}}if(db.wireframe&&da){I.drawElementsInstancedANGLE(w.LINE_STRIP,c6,dc,cX*cH,c2._instancingInfos.nbInstances)}else{I.drawElementsInstancedANGLE(cV,c6,dc,cX*cH,c2._instancingInfos.nbInstances)}for(var cY in cI){if(cY!=="id"&&cU[cY]>=0){if(cI[cY].isMat4){I.vertexAttribDivisorANGLE(cU[cY],0);I.vertexAttribDivisorANGLE(cU[cY]+1,0);I.vertexAttribDivisorANGLE(cU[cY]+2,0);I.vertexAttribDivisorANGLE(cU[cY]+3,0)}else{I.vertexAttribDivisorANGLE(cU[cY],0)}}}}else{if(db.wireframe&&da){w.drawElements(w.LINE_STRIP,c6,dc,cX*cH)}else{if((cV===w.POINTS)&&cL.vertexPositionArray&&cL.vertexPositionArray.nonindexedPoints){w.drawArrays(cV,cL.vertexIndexArray[cX],c6)}else{if(cN.nonIndexed){w.drawArrays(cV,cX,c6)}else{w.drawElements(cV,c6,dc,(cL.indexOffset+cX)*cH)}}}}bm.info.render.calls++;bm.info.render.vertices+=c6;if(cV===w.TRIANGLES){bm.info.render.faces+=c6/3}else{if(cV===w.LINES){bm.info.render.lines+=c6/2}}return true};this.renderSectionLines=function(cL,cI,cE,cH,cM,cS,cQ,cP,cF,cK,cN,cG,cR){if(!cM.uniforms.currentClipPlane){return}var cJ;var cO=0;for(cO=0;cO<S.length;cO++){cJ=cM.program;cM.uniforms.currentClipPlane.value=cO;if(cJ&&cJ.program===w._currentProgram){w.uniform1i(cJ.uniformLocations.currentClipPlane,cM.uniforms.currentClipPlane.value)}cM.clipPlaneIndex=cO+1;this._clipPlanesState.update(cN,null,true,cM,cL,true);this.renderInterval.apply(this,arguments)}cM.clipPlaneIndex=0;this._clipPlanesState.update(cN,null,true,cM,cL,false)};this.renderBuffer=function(cP,cT,cF,cJ,cM,cU,cV){if(cJ.visible===false){return false}var cG,cH,cE,cQ,cS,cK,cO,cI;cG=bo(cP,cT,cF,cJ,cU,cV,null,cJ.programManager.getProgramID(cU));cH=cG.attributes;if(cJ._picking){if(cJ.uniforms&&cJ.uniforms.pickingColor){w.uniform3f(cJ.program.uniformLocations.pickingColor,cJ.uniforms.pickingColor.value.r,cJ.uniforms.pickingColor.value.g,cJ.uniforms.pickingColor.value.b)}else{w.uniform3f(cJ.program.uniformLocations.diffuse,cJ.color.r,cJ.color.g,cJ.color.b)}}var cL=false,cN=cJ.wireframe?1:0,cR=(cM.id*16777215)+(cG.id*2)+cN;if(cR!==ad){ad=cR;cL=true}if(cL){ce()}if(!cJ.morphTargets&&cH.position>=0){if(cL){w.bindBuffer(w.ARRAY_BUFFER,cM.__webglVertexBuffer);aR(cH.position);w.vertexAttribPointer(cH.position,3,w.FLOAT,false,0,0)}}else{if(cU.morphTargetBase){X(cJ,cM,cU)}}if(cL){if(cM.__webglCustomAttributesList){for(cO=0,cI=cM.__webglCustomAttributesList.length;cO<cI;cO++){cK=cM.__webglCustomAttributesList[cO];if(cH[cK.buffer.belongsToAttribute]>=0){w.bindBuffer(w.ARRAY_BUFFER,cK.buffer);aR(cH[cK.buffer.belongsToAttribute]);w.vertexAttribPointer(cH[cK.buffer.belongsToAttribute],cK.size,w.FLOAT,false,0,0)}}}if(cH.color>=0&&cM.__colorArray){w.bindBuffer(w.ARRAY_BUFFER,cM.__webglColorBuffer);aR(cH.color);w.vertexAttribPointer(cH.color,3,w.FLOAT,false,0,0)}if(cH.normal>=0&&cM.__normalArray){w.bindBuffer(w.ARRAY_BUFFER,cM.__webglNormalBuffer);aR(cH.normal);w.vertexAttribPointer(cH.normal,3,w.FLOAT,false,0,0)}if(cH.tangent>=0&&cM.__tangentArray){w.bindBuffer(w.ARRAY_BUFFER,cM.__webglTangentBuffer);aR(cH.tangent);w.vertexAttribPointer(cH.tangent,4,w.FLOAT,false,0,0)}if(cH.uv>=0&&cM.__uvArray){w.bindBuffer(w.ARRAY_BUFFER,cM.__webglUVBuffer);aR(cH.uv);w.vertexAttribPointer(cH.uv,2,w.FLOAT,false,0,0)}if(cH.uv2>=0&&cM.__uv2Array){w.bindBuffer(w.ARRAY_BUFFER,cM.__webglUV2Buffer);aR(cH.uv2);w.vertexAttribPointer(cH.uv2,2,w.FLOAT,false,0,0)}if(cJ.skinning&&cH.skinIndex>=0&&cH.skinWeight>=0){w.bindBuffer(w.ARRAY_BUFFER,cM.__webglSkinIndicesBuffer);aR(cH.skinIndex);w.vertexAttribPointer(cH.skinIndex,4,w.FLOAT,false,0,0);w.bindBuffer(w.ARRAY_BUFFER,cM.__webglSkinWeightsBuffer);aR(cH.skinWeight);w.vertexAttribPointer(cH.skinWeight,4,w.FLOAT,false,0,0)}if(cH.lineDistance>=0){w.bindBuffer(w.ARRAY_BUFFER,cM.__webglLineDistanceBuffer);aR(cH.lineDistance);w.vertexAttribPointer(cH.lineDistance,2,w.FLOAT,false,0,0)}}if(cU instanceof s.Mesh){if(cJ.wireframe){bf(cJ.wireframeLinewidth);if(cL){w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,cM.__webglLineBuffer)}w.drawElements(w.LINES,cM.__webglLineCount,w.UNSIGNED_SHORT,0)}else{if(cL){w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,cM.__webglFaceBuffer)}w.drawElements(w.TRIANGLES,cM.__webglFaceCount,w.UNSIGNED_SHORT,0)}bm.info.render.calls++;bm.info.render.vertices+=cM.__webglFaceCount;bm.info.render.faces+=cM.__webglFaceCount/3}else{if(cU instanceof s.Line){cQ=(cU.type===s.LineStrip)?w.LINE_STRIP:w.LINES;bf(cJ.lineWidth);w.drawArrays(cQ,0,cM.__webglLineCount);bm.info.render.calls++}else{if(cU instanceof s.ParticleSystem){w.drawArrays(w.POINTS,0,cM.__webglParticleCount);bm.info.render.calls++;bm.info.render.points+=cM.__webglParticleCount}}}return true};function aR(cE){if(!w._enabledAttributes[cE]){w.enableVertexAttribArray(cE);w._enabledAttributes[cE]=true}}function ce(){for(var cE in w._enabledAttributes){if(w._enabledAttributes[cE]){w.disableVertexAttribArray(cE);w._enabledAttributes[cE]=false}}}function am(cF){for(var cE in cF){if(!w._enabledAttributes[cE]){w.enableVertexAttribArray(cE);w._enabledAttributes[cE]=true}}for(var cE in w._enabledAttributes){if(w._enabledAttributes[cE]&&!cF[cE]){w.disableVertexAttribArray(cE);w._enabledAttributes[cE]=false}}}function X(cG,cE,cF){}var Y=s.MaterialToUse.shadowMapDepthMaterial;var cB=s.MaterialToUse.normalDepthMaterial;this.addDGToDL=function(cY,cJ,cU,cV,cM,cK,cW,cH,cL,cO,cT,cS){var cE=cM,cP=cK;var cN=cY.occurrenceRenderingOverride&&cY.occurrenceRenderingOverride.getFullMaterial();var cR;if(cE.overridable&&cN&&(this.materialToUse===s.MaterialToUse.originalMaterial||this._oitMaterial)){if(cU.glType===w.POINTS){cR=cN.targetPrimitiveType==="POINTS"}else{if(cU.glType===w.LINES||cU.glType===w.POINTS){cR=cN.targetPrimitiveType==="LINES"}else{cR=!cN.targetPrimitiveType}}if(cR){if(this._oitMaterial){!cN._deferredMaterialsInit&&cN.updateDeferredMaterials();cN=cN._deferredMaterials[this.materialToUse]}cE=cN;cK=cN}}if(this.materialToUse===cB||this.materialToUse===Y){if(cU.glType<=w.LINE_STRIP){return}if(cP){if(cY.occurrenceRenderingOverride){var cF=cY.occurrenceRenderingOverride.materialOverride;var cI=null;if(cF){cI=cF.getOpacity()}if(cI!==null){if(cI<1){return}}else{if(cN&&(cN.getOpacity()<1)){return}}}else{if(cP.getOpacity()<1){return}}}}var cX=cE.polite||(this.renderHiddenEdges&&(cU&&cU._geomType&&(cU._geomType===s.GeomTypeEnum.SHARP_EDGE||cU._geomType===s.GeomTypeEnum.SMOOTH_EDGE||cU._geomType===s.GeomTypeEnum.BOUNDARY_EDGE||cU._geomType===s.GeomTypeEnum.EDGE)))?2:1;for(var cQ=0;cQ<cX;cQ++){if(cQ){if(!cE.politeMaterial){cE.politeMaterial=cE.clone();if(this.materialToUse!==s.MaterialToUse.highlightMaterial){cE.politeMaterial.transparent=true;cE.politeMaterial.opacity=0.3;cE.politeMaterial.depthTest=false;cE.politeMaterial.depthWrite=false}}cE=cE.politeMaterial}var cG=cL(cY,cU,cE);if(cG){if(cG.zSort===s.BackToFront&&!cE._picking&&!(this.currentPass&&this.currentPass.isOITPass)){cW.push([cG,cE,cY,cJ,cU,cV]);if(cT){cY._gsso_cache.push({dl:cG.index,args:[cG,cE,cY,cJ,cU,cV],renderLineMode:cY.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame})}}else{cG.addDrawable(cE,cY,cJ,cU,cV,cH,cy,this.fixedSizeArrayPool,this.renderVolumesOnly,cO,cS,this.domElement,this.currentFrameIndex,this.materialToUse);if(cT){cY._gsso_cache.push({dl:cG.index,args:[cE,cY,cJ,cU,cV,cH&&cH.clone(),-1,this.fixedSizeArrayPool,this.renderVolumesOnly,cO,cS,this.domElement,this.materialToUse],renderLineMode:cY.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame})}}}}};this.resetGSSOCache=function(){this.resetGSSOCacheFrame++};var av={};(function(){var cG=["EDGE","WIRE_EDGE","BOUNDARY_EDGE","SHARP_EDGE","SMOOTH_EDGE","HIDDEN_SEAM_EDGE","BOUNDARY_POINT","SHARP_POINT","SMOOTH_POINT","HIDDEN_SEAM_POINT","SURFACIC_POINT","FREE_POINT","INFINITE_FACE","FACE","UNKNOWN","AXIS_SYSTEM"];var cF={EDGE:1,WIRE_EDGE:1,BOUNDARY_EDGE:1,SHARP_EDGE:1,SMOOTH_EDGE:1,HIDDEN_SEAM_EDGE:1,BOUNDARY_POINT:0,SHARP_POINT:0,SMOOTH_POINT:0,HIDDEN_SEAM_POINT:0,SURFACIC_POINT:0,FREE_POINT:0,INFINITE_FACE:2,FACE:2,UNKNOWN:2,AXIS_SYSTEM:2};var cH,cE;for(cH=0;cH<cG.length;cH++){cE=cG[cH];av[s.GeomTypeEnum[cE]]=cF[cE]}})();this.getStateSortedObjects=function(d7,c8,cF,dL,d8,dM,dq){cy++;var c6=this;for(var dz=0;dz<cF._displayLists.length;dz++){cF._displayLists[dz].init()}var dO=cF.getDisplayListByName("EDGE");var cO=cF.getDisplayListByName("POINT");var dn=cF.getDisplayListByName("SOLID");var c9=cF.getDisplayListByName("SURFACE");var dh=cF.getDisplayListByName("BACK");var cG=cF.getDisplayListByName("NOZ");var ef=cF.getDisplayListByName("TRANSPAR");var dI=cF.getDisplayListByName("TRANSPAR1D");var de=cF.getDisplayListByName("NOZTRANSPAR");var cH=[cO,dO,c9,c9,cG,dn];var d1=[dI,dI,ef,ef,de,ef];var cW=(this.materialToUse===s.MaterialToUse.pickingMaterial);var dW=s.GeomTypeEnum.FACE;var c4=w.POINTS;var dt=w.LINES;var dR=w.LINE_STRIP;var dD=function(eq,ew,eu){if(eu.isBackMaterial){return dh}if(eu.uniforms&&eu.uniforms.outlinePositionMaps){return dO}var en;var es=2;if(cW&&cF._pickingPriorityMapping&&eq.pickingPriorityID){var em=eq.pickingPriorityID.points;if(ew.glType>=4){em=eq.pickingPriorityID.faces}else{if(ew.glType>=1){em=eq.pickingPriorityID.edges}}if(em){en=cF._pickingPriorityMapping[em]}if(en){return en}}if(ew){if(!ew._geomType){switch(ew.glType){case 0:es=0;break;case 1:es=1;break;default:es=2}}else{es=av[ew._geomType]}if((es===2)&&ew.gas&&(ew.gas.side===0)){es=5}}else{if(eq instanceof s.Line){es=1}}var eo=eu;var dl=eu.overridable&&eq.occurrenceRenderingOverride&&eq.occurrenceRenderingOverride.materialOverride;var ev=null,et,er;if(dl){if(!dl.internalMaterialOverride||eu!==dl.internalMaterialOverride.material){er=dl.getOpacity();if(er!==null){ev=er<1?true:false}}}if(c6.useRenderPriorityOpacity){var ep=c6.computeRenderPriorityOpacity(1,dl);if(ep<1){ev=true}}if(ev||(ev===null&&!eu.iterative&&(eo.getOpacity()<1)||eo.transparent)){en=d1[es]}else{en=cH[es]}return en};var ec=function(dl){if(!dl.geometry.length){return false}var dg=dl.geometry[0];var em=dg.drawingGroups;if(!em||!em.length){return false}return em[0].gas&&em[0].gas.isGAS};var dA=[];var c1=d7.length;var dv=this.materialToUse===s.MaterialToUse.originalMaterial;var cI=this.materialToUse===s.MaterialToUse.depthMaterial;var d3=this.materialToUse===s.MaterialToUse.normalDepthMaterial;var dc=this.materialToUse===s.MaterialToUse.normalMaterial;var d4=this.materialToUse===s.MaterialToUse.ZOnlyMaterial;var db=dv||d4;var dp=(this.materialToUse===s.MaterialToUse.pickingMaterial)||(this.materialToUse===s.MaterialToUse.pickingMaterialInstancing);var dF=this._oitMaterial=this.materialToUse===s.MaterialToUse.oitAccumMaterial||this.materialToUse===s.MaterialToUse.oitRevealMaterial;var c3=(dp||cI||dc);var eb=s.MaterialToUse.gasLookMaterial;var dS=this.materialToUse;var c5=false;var cS=this.resetGSSOCacheFrame;var dU=d8&&!d8.isOrtho;for(var cJ=0;cJ<c1;++cJ){var dK=d7[cJ];if(!dK||!dK.render){continue}var d0=dK.object,dV=dK.buffer,cV=d0._gsso_cache;d0.z=dK.z;var cN=cV?cV.length:0;if(dL&&cN>0&&cV[0].resetFrameIndex>=cS){var ed,dd,dN,cL;d0.renderLineMode=cV[0].renderLineMode;for(ed=0;ed<cV.length;ed++){dd=cF._displayLists[cV[ed].dl];dN=cV[ed].args;cL=(dN.length===6);if(cL){dN[0]=dd;dA.push(dN)}else{dN[6]=cy;dd.addDrawable(dN[0],dN[1],dN[2],dN[3],dN[4],dN[5],dN[6],dN[7],dN[8],dN[9],dN[10],dN[11],this.currentFrameIndex,dN[12])}}continue}if(dL){d0._gsso_cache=[]}var eg=d0.material;var da=d0.renderPointsOnly;if(!dv&&(d0 instanceof s.Line)){continue}if(c3&&!d0.drawInHLRender){continue}if(d3&&!d0.enableNormalDepth){continue}var ej=null;var di=null;var dE=null;var d9=eg;var ee=this.newMaterialInheritance||ec(d0);if(!ee&&eg){if(!eg._deferredMaterialsInit){eg.updateDeferredMaterials()}if(dF&&!eg._deferredMaterials[dS]){continue}if(eg.line&&!eg.line._deferredMaterialsInit){eg.line.updateDeferredMaterials()}if(eg.point&&!eg.point._deferredMaterialsInit){eg.point.updateDeferredMaterials()}dE=eg._deferredMaterials[this.materialToUse]}if(dE===undefined){dE=eg}var dQ=d0.material;var cK=d0.matApp;var cR=d0.gas;var dk=d0.layer;var cX=this.getRenderMode(d0);d0.renderLineMode=cX.getRenderLineMode();var cE=this.getMaterialMode(d0);if((d0.geometry._type===2)||(d0.geometry.length>=0)){if(d0.fromLoadedModel&&cX&&(cX._mask&s.OutlineMask)&&db){if(!d0.geometry[0].vertexIndexArray){console.warn("OutlineBuilding unavailable, make sure noMeshInRAM is inactive")}else{var dP=d0.outlinesGeometry!==null?d0.outlinesGeometry.geometry:null;if(dP){if(d0.layer&&!d0.layer.upToDate){dP.dispose();dP=null;d0.outlinesGeometry=null;d0.layer.upToDate=true}else{if(d0.outlinesGeometry.outlineWidth!==cX._outlineWidth){if(d0.outlinesGeometry.outlineWidth===1||cX._outlineWidth===1){dP=c.convertOutlineGeometry(dP,d0.outlinesGeometry.outlineWidth,cX._outlineWidth,cy);d0.outlinesGeometry.geometry=dP}else{c.convertWideWidth(dP,cX._outlineWidth,cy)}d0.outlinesGeometry.outlineWidth=cX._outlineWidth}}}if(dP===null){var dT=new c(d0,cX._outlineWidth,cy);dP=dT.computeOutlineGeometry();if(dP!==null){dP.addEventListener("dispose",a0);d0.outlinesGeometry={geometry:dP,outlineWidth:cX._outlineWidth};c5=true}}if(dP!==null){var ek=dP.drawingGroups[0];this.addDGToDL(d0,dP,ek,ek,ek.material,ek.material,dA,cX&&cX.renderLineMode,dD,a0,dL,d8)}}}var eh=null;if(cX&&(cX._gssoMask&s.SectionLineMask)){if(!d0.geometry[0].vertexIndexArray){console.warn("SectionLineBuilding unavailable, make sure noMeshInRAM is inactive")}else{var c0=d0.sectionLinesBuilder&&d0.sectionLinesBuilder.sectionLineGeometry;var dj=null,dH,cP;if(d0.occurrenceRenderingOverride&&d0.occurrenceRenderingOverride.sectionLinesProperties){dj=d0.occurrenceRenderingOverride.sectionLinesProperties;dH=dj.color;cP=dj.width}else{dH=null;cP=1}if(c0&&((d0.layer&&!d0.layer.upToDate)||d0.sectionLinesBuilder.lineWidth!==cP)){d0.sectionLinesBuilder=null;c0.dispose();c0=null;if(d0.layer){d0.layer.upToDate=true}}if(!c0&&!d0.sectionLinesBuilder){var cQ=new r(d0,this,cP);cQ.computeSectionLineGeometry();c0=cQ.sectionLineGeometry;if(c0){c0.addEventListener("dispose",a0)}d0.sectionLinesBuilder=cQ}if(c0){var ea=c0.drawingGroups[0];if(dH!=null){ea.material.uniforms.color.value.set(dH)}else{eh=ea.material}this.addDGToDL(d0,c0,ea,ea,ea.material,ea.material,dA,cX&&cX.renderLineMode,dD,a0,dL,d8)}}}if((dk!==null)&&(dk!==undefined)&&(!this.cuttingScene||ee)){var dC=dk.layers.length;var dB=null;for(var dx=0;dx<dC;dx++){var el=dk.layers[dx];if(el.drawableInterval.layerNum<=0){continue}var ei=el.geometry;var c7=el.drawableGroup;if(ee){var du=c7.glType;if(da&&(du!=c4)){continue}var dJ=el.drawableInterval.material;var dm=el.drawableInterval.gas;if(!dJ){dJ=c7.material}if(!dm){dm=c7.gas}var dZ=null;var d6=null;if(cE){var ds=cK&&cK._getMaterialFromGLType(du,c7._geomType);if(dJ){if(dJ.isMatApp){cM=dJ.solveInheritance(cK);dZ=(cM===cK)?ds:dJ._getMaterialFromGLType(du,c7._geomType)}if(!dZ&&!dJ.isMatApp){cM=ds?cK:null;dZ=ds?ds:dJ}}if(!dZ){cM=cK;dZ=ds}}if(!cE||!dZ){if(dQ&&dQ.force){dZ=dQ}else{var dX;if(cR){dX=cR.getMaterial(dm,du,c7._geomType)}else{dX=dm.isGAS?dm.getMaterial(null,du,c7._geomType):dm}if(dX){dZ=dX}}}if(dZ&&!dZ._deferredMaterialsInit){if(typeof(dZ.updateDeferredMaterials)===typeof(Function)){dZ.updateDeferredMaterials()}}if(this.cuttingScene){if(dB!==null){dZ=dB}else{dB=dZ}}d6=dZ._deferredMaterials[dS];if(dF&&!d6){continue}if(dZ.backMaterial){var dr=dZ.backMaterial._deferredMaterials[dS];dr&&this.addDGToDL(d0,ei,c7,el.drawableInterval,dr,dZ,dA,cX,dD,a0,dL,d8)}this.addDGToDL(d0,ei,c7,el.drawableInterval,d6,dZ,dA,cX,dD,a0,dL,d8)}else{if(da&&(c7.glType!=c4)){continue}var dJ=el.drawableInterval.material;ej=dE;di=d9;if(!c7.gas._deferredMaterialsInit){c7.gas.updateDeferredMaterials()}if(c7.material&&!c7.material._deferredMaterialsInit){if(typeof(c7.material.updateDeferredMaterials)===typeof(Function)){c7.material.updateDeferredMaterials()}}if(dJ!==null){if(!dJ._deferredMaterialsInit){dJ.updateDeferredMaterials()}ej=dJ._deferredMaterials[dS];di=dJ}else{if(!eg.force||(eg.force==="forceGeomTypeFACE")){if(cE&&c7.material&&typeof(c7.material.updateDeferredMaterials)===typeof(Function)){ej=c7.material._deferredMaterials[dS];di=c7.material}else{if(cE&&dv&&(c7._geomType===dW)){if(!c7.gas._deferredMaterials[eb]){c7.gas.updateGasLookMaterial()}if(this.gasLookMode){ej=c7.gas._deferredMaterials[eb]}else{ej=c7.gas._deferredMaterials[dS]}}else{ej=c7.gas._deferredMaterials[dS]}di=c7.gas}if(eg.force&&(c7._geomType===dW)){ej=dE}}}if(dF&&!ej){continue}if(ej.backMaterial){this.addDGToDL(d0,ei,c7,el.drawableInterval,ej.backMaterial,di,dA,cX,dD,a0,dL,d8)}if(((c7.glType==dt)||(c7.glType==dR))&&(ej.line)){ej=ej.line}if((c7.glType==c4)&&(ej.point)){ej=ej.point}this.addDGToDL(d0,ei,c7,el.drawableInterval,ej,di,dA,cX,dD,a0,dL,d8)}}}else{var dY=null;var c2=0;if(d0.geometry.length>=0){dY=d0.geometry[0];c2=d0.geometry.length}else{if(d0.geometry._type===2){dY=d0.geometry;c2=1}}if(ee){var df=dY;var d5=null;var dy;if(this.cuttingScene||eh){for(dy=0;dy<c2;dy++){var dG=dY.drawingGroups;var cU=0;var dw=dG.length;for(var dz=0;dz<dw;dz++){var c7=dG[dz];if(c7._geomType===dW&&!da){if(c7.count>cU){if(cE&&c7.material&&typeof(c7.material.updateDeferredMaterials)===typeof(Function)){d5=c7.material._deferredMaterials[dS]}else{if(!c7.gas.isGAS){d5=c7.gas._deferredMaterials[dS]}}cU=c7.count}}}dY=d0.geometry[dy+1]}if(eh&&!this.cuttingScene&&d5&&d5.color){eh.uniforms.color.value.copy(d5.color);d5=null}}dY=df;for(dy=0;dy<c2;dy++){var dG=dY.drawingGroups;var dw=dG.length;for(var dz=0;dz<dw;dz++){var c7=dG[dz];var du=c7.glType;if(da&&(du!=c4)){continue}var cM=null;var dZ=null;var d6=null;if(d5&&c7._geomType===dW){dZ=d5}else{if(cE){var ds=cK&&cK._getMaterialFromGLType(du,c7._geomType);if(c7.material){if(c7.material.isMatApp){cM=c7.material.solveInheritance(cK);dZ=(cM===cK)?ds:c7.material._getMaterialFromGLType(du,c7._geomType)}if(!dZ&&!c7.material.isMatApp){cM=ds?cK:null;dZ=ds?ds:c7.material}}if(!dZ){cM=cK;dZ=ds}}}if(!cE||!dZ){if(dQ&&dQ.force){dZ=dQ}else{var dX;if(cR){dX=cR.getMaterial(c7.gas,du,c7._geomType)}else{dX=c7.gas.isGAS?c7.gas.getMaterial(null,du,c7._geomType):c7.gas}if(dX){dZ=dX}}}if(dZ&&!dZ._deferredMaterialsInit){if(typeof(dZ.updateDeferredMaterials)===typeof(Function)){dZ.updateDeferredMaterials()}}d6=dZ._deferredMaterials[dS];if(dF&&!d6){continue}if(dZ.backMaterial){var dr=dZ.backMaterial._deferredMaterials[dS];dr&&this.addDGToDL(d0,dY,c7,c7,dr,dZ,dA,cX,dD,a0,dL,d8)}this.addDGToDL(d0,dY,c7,c7,d6,dZ,dA,cX,dD,a0,dL,d8)}dY=d0.geometry[dy+1]}}else{if((eg&&eg.force&&eg.force!=="forceGeomTypeFACE")&&(cE||!d0.fromLoadedModel)){for(var dy=0;dy<c2;dy++){var c7=dY.drawingGroups;var dw=c7.length;for(var dz=0;dz<dw;dz++){if(da&&(c7[dz].glType!=c4)){continue}ej=dE;di=d9;if(dF&&!ej){continue}if(ej.backMaterial){this.addDGToDL(d0,dY,c7[dz],c7[dz],ej.backMaterial,di,dA,cX,dD,a0,dL,d8)}if((c7[dz].glType===dt)||(c7[dz].glType===dR)){if(di.line&&di.line._deferredMaterials[dS]){ej=di.line._deferredMaterials[dS]}else{if(ej.line){ej=ej.line}}}else{if(c7[dz].glType===c4){if(di.point&&di.point._deferredMaterials[dS]){ej=di.point._deferredMaterials[dS]}else{if(ej.point){ej=ej.point}}}else{if(dv&&dY.lightMap){if(!di._withLightMap[dY.lightMap.id]){ej=di.clone();ej.lightMap=dY.lightMap;ej.lightMapLinear=dY.lightMap.hdr;ej.needsUpdate=true;di._withLightMap[dY.lightMap.id]=ej}else{ej=di._withLightMap[dY.lightMap.id]}}}}this.addDGToDL(d0,dY,c7[dz],c7[dz],ej,di,dA,cX,dD,a0,dL,d8)}dY=d0.geometry[dy+1]}}else{var d5=null;var dy;var df=dY;for(dy=0;dy<c2;dy++){var dG=dY.drawingGroups;var cU=0;var dw=dG.length;for(var dz=0;dz<dw;dz++){var c7=dG[dz];if(da&&(c7.glType!=c4)){continue}if(!c7.gas._deferredMaterialsInit){c7.gas.updateDeferredMaterials({gasLook:true})}if(c7.material&&!c7.material._deferredMaterialsInit){if(typeof(c7.material.updateDeferredMaterials)===typeof(Function)){c7.material.updateDeferredMaterials()}}}dY=d0.geometry[dy+1]}dY=df;if(this.cuttingScene||eh){for(dy=0;dy<c2;dy++){var dG=dY.drawingGroups;var cU=0;var dw=dG.length;for(var dz=0;dz<dw;dz++){var c7=dG[dz];if(c7._geomType===dW&&!da){if(c7.count>cU){if(cE&&c7.material&&typeof(c7.material.updateDeferredMaterials)===typeof(Function)){d5=c7.material._deferredMaterials[dS]}else{d5=c7.gas._deferredMaterials[dS]}cU=c7.count}}}dY=d0.geometry[dy+1]}if(eh&&!this.cuttingScene&&d5&&d5.color){eh.uniforms.color.value.copy(d5.color);d5=null}}if(!this.cuttingScene){if(eg&&eg.force==="forceGeomTypeFACE"){d5=dE}}dY=df;for(dy=0;dy<c2;dy++){var dG=dY.drawingGroups;var dw=dG.length;for(var dz=0;dz<dw;dz++){var c7=dG[dz];var du=c7.glType;if(da&&(du!=c4)){continue}var cY;if(cE&&c7.material&&typeof(c7.material.updateDeferredMaterials)===typeof(Function)){cY=c7.material._deferredMaterials[dS];di=c7.material}else{if(cE&&dv&&(c7._geomType===dW)){if(!c7.gas._deferredMaterials[eb]){c7.gas.updateGasLookMaterial()}if(this.gasLookMode){cY=c7.gas._deferredMaterials[eb]}else{cY=c7.gas._deferredMaterials[dS]}}else{cY=c7.gas._deferredMaterials[dS]}di=c7.gas}if(d5&&c7._geomType===dW){ej=d5}else{ej=cY}if(dF&&!ej){continue}if(ej.backMaterial){this.addDGToDL(d0,dY,c7,c7,ej.backMaterial,di,dA,cX,dD,a0,dL,d8)}if(((du==dt)||(du==dR))&&(ej.line)){ej=ej.line}if((du==c4)&&(ej.point)){ej=ej.point}this.addDGToDL(d0,dY,c7,c7,ej,di,dA,cX,dD,a0,dL,d8)}dY=d0.geometry[dy+1]}}}}}else{if(ee&&dQ){if(!dQ._deferredMaterialsInit){if(typeof(dQ.updateDeferredMaterials)===typeof(Function)){dQ.updateDeferredMaterials()}}if(dQ.backMaterial){this.addDGToDL(d0,dV,null,null,dQ.backMaterial._deferredMaterials[dS],dQ,dA,null,dD,a0,dL,d8)}this.addDGToDL(d0,dV,null,null,dQ._deferredMaterials[dS],dQ,dA,null,dD,a0,dL,d8)}else{if(dE.backMaterial){this.addDGToDL(d0,dV,null,null,dE.backMaterial._deferredMaterials[dS],d9,dA,null,dD,a0,dL,d8)}this.addDGToDL(d0,dV,null,null,dE,d9,dA,null,dD,a0,dL,d8)}}}if(c5){c.TexturesManager.finalize()}dA.sort(m);for(var dz=dA.length-1;dz>=0;dz--){var cT=dA[dz];var d0=cT[2];var cX=this.getRenderMode(d0);cT[0].addDrawable(cT[1],d0,cT[3],cT[4],cT[5],cX,cy,this.fixedSizeArrayPool,this.renderVolumesOnly,a0,d8,this.domElement,this.currentFrameIndex,this.materialToUse)}for(dz=0;dz<cF._displayLists.length;dz++){cF._displayLists[dz].finalize()}if(c8){for(var dz=0;dz<cF._displayLists.length;dz++){var cZ=cF._displayLists[dz];if((cZ.name==="TRANSPAR")||(cZ.name==="NOZTRANSPAR")){continue}var d2=cZ._materialList.length;cZ._materialList.length=cZ.usefulListLength;cZ._materialList.sort(function(en,em){var dl=en.material;var dg=em.material;if(!dl.program){return -1}else{if(!dg.program){return 1}else{if(dg.program!==dl.program){return dl.program.id-dg.program.id}else{return en.occurrenceRenderingOverrideId-em.occurrenceRenderingOverrideId}}}});cZ._materialList.length=d2}}};this.renderCuttingElements=function(cG,cS,cV,cE,cO){function cN(cX){if(cX&&(cX instanceof s.MeshBasicMaterial||cX instanceof s.MeshPhongMaterial||cX instanceof s.MeshLambertMaterial)&&!cX.map){return true}return false}if(this.cuttingScene){var cQ=bm.getContext();var cW;var cH="NOTEQUAL";cQ.stencilFunc(cQ[cH],100,255);cQ.colorMask(true,true,true,true);cQ.stencilMask(0);cQ.enable(cQ.CULL_FACE);this.setDepthWrite(true);var cJ=this.disableBackFaceClipPlanes;this.disableBackFaceClipPlanes=0;var cL=cO&&cO.clipPlanes;var cU=this.cuttingScene.getWebGLObjects("main",this.currentFrameIndex);if(cO&&cO.clippingSettings&&cO.clippingSettings.frontOpacity===0){cQ.cullFace(cQ.FRONT)}if(cL){var cF=[];var cR,cP,cT;for(cR=0;cR<cL.length;cR++){cT=cL[cR].clippingContext&&cL[cR].clippingContext[this.id];if(cT&&cT.clippingMeshIndex>0){cF.push(cU[cT.clippingMeshIndex-1])}}cU=cF}var cI=0;var cP;var cM;for(cI=cU.length-1;cI>=0;cI-=1){if(cU[cI]===null){continue}cM=null;cW=null;if(cO&&cO.sectionCappingMaterials){cM=cO.sectionCappingMaterials.defaultMaterial;for(cP=0;cP<cO.sectionCappingMaterials.length;cP++){if(cO.sectionCappingMaterials[cP].clippingPlane===cU[cI].object.clippingPlane){cM=cO.sectionCappingMaterials[cP].material;break}}if(cM){cM.clipPlaneIndex=cI+1;cU[cI].object.geometry.normalsNeedUpdate=true}}bV(cU[cI].object,cS);if(cG&&cG.enableReceiveShadowOnCapping){cU[cI].object.receiveShadow=true}if(this.shadowMapEnabled){aO(cV,cU[cI].object,this)}cU[cI].render=true;if(this.materialToUse===s.MaterialToUse.normalDepthMaterial||(!cM&&cU[cI].object.material.clipPlaneUseModelMaterial)){if(this.materialToUse===s.MaterialToUse.normalDepthMaterial||cN(cG)){cM=cG;cW=cO&&this.materialToUse!==s.MaterialToUse.normalDepthMaterial&&cO.materialOverride}else{if(!this.backupCuttingMaterial){this.backupCuttingMaterial=new s.MeshPhongMaterial({color:"black"})}cM=this.backupCuttingMaterial}cM.clipPlaneIndex=cI+1}else{cM=cM||cU[cI].object.material;if(cM){cM.clipPlaneIndex=cI+1}if(cM instanceof s.HatchingMeshMaterial){var cK;if(cM.autoSpaceColor){if(cN(cG)){cK=cO&&cO.getOverrideColor(cG);cM.spaceColor=cK||cG.color}else{cK=cO&&cO.getOverrideColor();cM.spaceColor=cK||new s.Color(16777215)}}if(cM.autoStripesColor){if(cN(cG)){cM.stripesColor=cK||cG.color}else{cM.stripesColor=cK||new s.Color(0)}}}}this._clipPlanesState.update(cO,null,true,cM,cS,true);an(cU[cI].object,cM);cM._renderedClipPlane=cU[cI].object.clippingPlane;cz(true,1,1);this.renderObjects([cU[cI]],false,"",cS,cV,cE,true,cM,cW);cM._renderedClipPlane=null;if(this.materialToUse===s.MaterialToUse.normalDepthMaterial||cU[cI].object.material.clipPlaneUseModelMaterial){cM.clipPlaneIndex=0}}if(cO&&cO.clippingSettings&&cO.clippingSettings.frontOpacity===0){cQ.cullFace(cQ.BACK)}this.setDepthWrite(false);cQ.disable(cQ.CULL_FACE);cQ.stencilFunc(cQ.ALWAYS,100,255);cQ.colorMask(false,false,false,false);cQ.stencilMask(255);this.clear(false,false,true);this.disableBackFaceClipPlanes=cJ;this._clipPlanesState.update(null,null,true,cG,cS);return true}return false};this.renderAssets=function(){if(this.ambianceGenerators!==null&&this.ambianceGenerators.needsUpdate){this.ambianceGenerators.update(this.currentFrameIndex,this)}};this.updateCSSNodes=function(cU,cS){var cX=cU.getWebGLObjects("css2d",this.currentFrameIndex);var cL=cU.getWebGLObjects("css3d",this.currentFrameIndex);var cE,cV;cS.matrixWorldInverse.getInverse(cS.matrixWorld);if(cL.length&&cS._viewpoint){var cM=0.5/Math.tan(s.Math.degToRad(cS.fov*0.5))*b8;var cR=cS._viewpoint.divCameraCSSElement;aG.style.WebkitPerspective=cM+"px";aG.style.MozPerspective=cM+"px";aG.style.oPerspective=cM+"px";aG.style.perspective=cM+"px";var cT="translate3d(0,0,"+cM+"px)"+U(cS.matrixWorldInverse)+" translate3d("+aE+"px,"+T+"px, 0)";cR.style.WebkitTransform=cT;cR.style.MozTransform=cT;cR.style.oTransform=cT;cR.style.transform=cT}var cP=null;var cQ;for(cQ=0;cQ<cX.length;cQ++){cE=cX[cQ];if(cE===null){continue}cV=cE.object;cE.render=false;cV.render=false;var cJ=true;if(cV.visibilityFree){cJ=cV.visible}else{cJ=this.visibleSpace?cV.visible:!cV.visible}if(cJ){if(this.renderIteration>0){continue}var cH=new s.Vector3();cH.copy(cV.position);var cW=false;if(this.clipPlanesEnabled){for(var cO=0;cO<this.clipPlanes.length;cO++){var cI=this.clipPlanes[cO];var cG=cI.normal.x*cV.position.x+cI.normal.y*cV.position.y+cI.normal.z*cV.position.z+cI.constant;if(cG<0){cW=true;break}}}if((cS.isOrtho||cS.getLookAt().dot(cS.position.clone().sub(cH))<0)&&!cW){var cK=new s.Projector();cK.projectVector(cH,cS);cV.element.style.display="block";cV.element.style.left=(cV.offset.x+(cH.x+1)/2*this.domElement.width)/(window.devicePixelRatio||1)+"px";cV.element.style.top=(cV.offset.y+(-cH.y+1)/2*this.domElement.height)/(window.devicePixelRatio||1)+"px";if(!cP){cP=[]}cP.push({domElement:cV.element,z:cH.z,alwaysOnTopIndex:cV._occurrence?cV._occurrence.node._alwaysOnTopIndex:null})}else{cV.element.style.display="none"}}}for(cQ=0;cQ<cL.length;cQ++){cE=cL[cQ];if(cE===null){continue}cV=cE.object;cE.render=false;cV.render=false;var cJ=true;if(cV.visibilityFree){cJ=cV.visible}else{cJ=this.visibleSpace?cV.visible:!cV.visible}if(cJ){if(this.renderIteration>0){continue}if(cS._viewpoint){var cN=new s.Matrix4().multiplyMatrices(cV.matrixWorld,cV.scaleCSS);var cT=aP(cN);var cF=cV.element;cF.style.WebkitTransform=cT;cF.style.MozTransform=cT;cF.style.oTransform=cT;cF.style.transform=cT;cF.style.pointerEvents="auto";if(cF.parentNode!==cR){cR.appendChild(cF)}}}}if(cP){cP.sort(function(cZ,cY){var c1=cZ.alwaysOnTopIndex!==null,c0=cY.alwaysOnTopIndex!==null;if(c1||c0){if(!c1){return -1}else{if(!c0){return 1}else{if(cZ.alwaysOnTopIndex!==cY.alwaysOnTopIndex){return cZ.alwaysOnTopIndex-cY.alwaysOnTopIndex}}}}return cY.z-cZ.z});for(cQ=0;cQ<cP.length;cQ++){cP[cQ].domElement.style.zIndex=20+cQ}}};function aO(cH,cG){if(!cG.geometry.length||!cG.currentShadowMatrices||cy!==cG.currentShadowMatrices._sortCount){if(!cG.receiveShadow){return}cG.currentShadowMatrices=[];cG.currentShadowMatrices._sortCount=cy;for(var cI=0;cI<cH.length;cI++){var cF=cH[cI];if(!cF.castShadow){continue}if(cF instanceof s.SpotLight||(cF instanceof s.DirectionalLight&&!cF.shadowCascade&&(!cF.isVirtual||bm.shadowMapCascade))){var cE=new s.Matrix4();cE.copy(cF.shadowMatrix);cE.multiply(cG.matrixWorld);cG.currentShadowMatrices.push(cE)}}}}function bV(cE,cF){if(!cE.isUniformlyScaled){cE._normalMatrix.getInverse(new s.Matrix4().multiplyMatrices(cF.matrixWorldInverse,cE.matrixWorld));cE._normalMatrix.transpose()}cE._modelViewMatrix._multiplyDoubleMatricesMV(cF.matrixWorldInverse,cE.matrixWorld);if(cE.modelViewInvTranspMatrix){cE.modelViewInvTranspMatrix.multiplyDoubleMatricesAndInverse(cF.matrixWorldInverse,cE.matrixWorld).transpose()}}this.computeCulling=function(cH,cG,cF,cE){};this.render=function(c7,cY,di,cP,c0,dL,cU,dm){this._clipPlanesState.update(null,null,true,null,cY);ad=null;if(cY instanceof s.Camera===false){console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");return}var dC,dg,cR,dr,du,da,cK=c7.__lights,dB=c7.fog;cK.sort(c7._lightSort);bC=-1;bB=-1;aM=null;bK=null;aL=null;cD=true;ap=c7.computeLightsKey();if(this.autoUpdateScene){c7.updateMatrixWorld()}if(this.cuttingScene){this.cuttingScene.updateMatrixWorld()}if(cY.parent===undefined){cY.updateMatrixWorld()}cY.matrixWorldInverse.getInverse(cY.matrixWorld);if(!cY.orientation){cY.orientation=(cY.matrixWorld.determinant()>0)?1:-1}by.multiplyMatrices(cY.projectionMatrix,cY.matrixWorldInverse);ca.setFromMatrix(by);if(this.autoUpdateObjects){this.initWebGLObjects(c7)}if(this.cuttingScene){this.initWebGLObjects(this.cuttingScene)}if(this.enableRenderPluginsPre){K(this.renderPluginsPre,c7,cY)}bm.info.render.reset();this.setRenderTarget(di);if(this.autoClear||cP){this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil)}if(this.disableColorWrite){w.colorMask(false,false,false,false)}this.setStencilWrite(this.enableStencilWrite);var cL=this.currentPass?this.currentPass.idString:null;var df=(this.materialToUse===s.MaterialToUse.pickingMaterial);var dp=(this.materialToUse===s.MaterialToUse.pickingMaterial||this.materialToUse===s.MaterialToUse.normalMaterial||this.materialToUse===s.MaterialToUse.depthMaterial);if(cU){var du=c7.getWebGLObjects(cL,this.currentFrameIndex);window.webVisuPerfo.startPerfo("cull");var dv=cY.getCameraConstant(1,s.glStates.currentHeight);if(cY.fullWidth){dv*=cY.height/cY.fullHeight;if(!cY.useRealSize){cY.fixedSizeCameraConstant=this.devicePixelRatio*dv}else{if(cY.useRealSize&&cY.visualizedHeight){cY.fixedSizeCameraConstant=this.devicePixelRatio*cY.getCameraConstant(1,cY.fullHeight)}}}else{cY.fixedSizeCameraConstant=this.devicePixelRatio*dv}cY.pixelCullingCst=cY.pixelCulling*dv;var dG=cY.matrixWorldInverse.elements;var dC,cR,dr;var c6=du.length,c8=0;var dF=this.shadowMapEnabled;var dh=this.sortObjects;for(dC=0;dC<c6;dC++){cR=du[dC];if(cR===null){continue}dr=cR.object;cR.render=false;dr.render=false;var dk=true;if(dr.visibilityFree){dk=dr.visible}else{dk=this.visibleSpace?dr.visible:!dr.visible}if(dk){if(!(dr.frustumCulled)||cY.performPixelAndFrustumCulling(ca,dv,dr)){if(dr.beforeRenderCB&&!dp){dr.beforeRenderCB(dr,{viewpoint:cY._viewpoint,camera:cY})}c7.__webglObjectsToDraw[c8]=cR;c8++;bV(dr,cY);if(dF){aO(cK,dr)}cR.render=true;dr.render=true;if(dh){if(dr.renderDepth!==null){cR.sortKey=dr.renderDepth;cR.z=dr.renderDepth}else{var dw=dr.worldRadius;var dc=dr.worldCenter;var cI=dG[2]*dc.x+dG[6]*dc.y+dG[10]*dc.z+dG[14];cR.z=cI+dw}}}else{this.info.render.culledMeshes++}}}window.webVisuPerfo.endPerfo("cull");c7.__webglObjectsToDraw.length=c8;var dx=c7.__webglObjectsToDraw;window.webVisuPerfo.startPerfo("sort");if(this._sortRenderListByBuffer){dx.sort(j)}else{dx.sort(b)}window.webVisuPerfo.endPerfo("sort");var dy=!c7.isBackground;window.webVisuPerfo.startPerfo("gsso");this.getStateSortedObjects(dx,dy,dL,dm,cY,dv,ca);window.webVisuPerfo.endPerfo("gsso")}this.setBlending(s.NoBlending);var cH=false;dL._displayLists[5].active=!c0;window.webVisuPerfo.startPerfo("draw");var c5=null;var cF=this.materialToUse===s.MaterialToUse.originalMaterial||this.materialToUse===s.MaterialToUse.oitAccumMaterial||this.materialToUse===s.MaterialToUse.oitRevealMaterial;var dA=this.materialToUse===s.MaterialToUse.highlightMaterial;var cG=this.materialToUse===s.MaterialToUse.outlineHighlightMaterial;var dt=this.useOIT&&this.currentPass.isOITPass&&cF;var dJ=w.TRIANGLES;for(var dz=0;dz<dL._displayLists.length;dz++){var cO=dL._displayLists[dz];var cN=cO.usefulListLength;if(!cO.active||cN===0){continue}if(cO.depthFunc){w.depthFunc(w[cO.depthFunc])}if(df){if((dz>0)&&(cO.pickingPriority||cH)){w.clear(w.DEPTH_BUFFER_BIT)}cH=!!cO.pickingPriority}if(cO.useStencil){if((cO.name!=="NOZ")||(cO.name==="NOZ"&&this.materialToUse===s.MaterialToUse.originalMaterial)){w.enable(w.STENCIL_TEST);w.stencilFunc(w.ALWAYS,1,255);w.stencilOp(w.KEEP,w.KEEP,w.REPLACE);w.stencilMask(255)}}var cM=cO._materialList;var c4=cO.depthWrite;if(cO.hasTranspar&&!this.currentPass.isOITPass){c4=false}for(var cW=0;cW<cN;cW++){bD=null;ad=null;var dE=cM[cW];var cQ=cF&&dE.material.overridable&&dE.occurrenceRenderingOverride&&dE.occurrenceRenderingOverride.materialOverride?dE.occurrenceRenderingOverride.materialOverride:null;if(!this.clipPlanesEnabled&&this.cuttingScene&&(!dE.occurrenceRenderingOverride||!dE.occurrenceRenderingOverride.clipPlanes)){continue}var dI=dE.material;if(!cU){(!dI._deferredMaterialsInit)&&dI.updateDeferredMaterials();dI=dI._deferredMaterials[this.materialToUse];if(!dI){continue}}if(dt!==dI.isOITable){if(dt){dI._programID=dI._programID|s.ProgramIDs.OIT}else{dI._programID=dI._programID&~s.ProgramIDs.OIT}}dI.isOITable=dt;dI._setupOIT(this.materialToUse);if(cQ&&cQ.internalMaterialOverride&&cQ.internalMaterialOverride.material===dI){cQ=null}var de=cO._displayRangeLists[dE.id];var ds=dI;if(!dI.areTexturesLoaded()){if(dI.transparent){dI._setupOIT(0);continue}else{ds=this.loadingTextureMaterial}}var cZ=de.first;if(!cZ){dI._setupOIT(0);continue}if(dI.isPhysicalMaterial){if(c7.envMipMap.length>0){if(c7.envMipMap[0].hdr&&(c7.envMipMap[1]===null||c7.envMipMapID)){var dj="s"+c7.envMipMap[0].id;var cT="generator";cT+="-"+dj;cT+="-GGX";if(this.ambianceGenerators.manager){var c3=this.ambianceGenerators.getAmbiance(cT,true,{hdr:c7.envMipMap[0],brdf:"GGX"},dj);this.ambianceGenerators.needsUpdate=this.ambianceGenerators.needsUpdate||!c3.complete;c3=c3.ambiance;c7.envMipMap[1]=c3;if(c7.envMipMapID&&c7.envMipMapID!==dj){this.ambianceGenerators.decreaseUseCount(c7.envMipMapID)}}else{this.ambianceGenerators.init(0)}c7.envMipMapID=dj}}var db=dI.overrideIBL!==null&&dI.overrideIBL.hdr!==null;var cJ=db&&dI.overrideIBL.hdr.loadEndStatus==="complete";var c9=db&&dI.overrideIBL.hdr.loadEndStatus==="useCurrent"&&c7.envMipMap.length>0;db=cJ||c9;if((c7.envMipMap.length>0&&c7.envMipMap[1])||db){if(db){var dn=dI.overrideIBL;var cS=c9?c7.envMipMap[0]:dn.hdr;var cT="generator";cT+="-"+dn.name;cT+="-"+cS.id;cT+="-"+dn.brdf;var c3=null;if(dn.mips!==null){c3=dn.mips}else{if(this.ambianceGenerators.manager){c3=this.ambianceGenerators.getAmbiance(cT,!dn.direct,{hdr:cS,brdf:dn.brdf},dI.id);this.ambianceGenerators.needsUpdate=this.ambianceGenerators.needsUpdate||!c3.complete;c3=c3.ambiance}else{this.ambianceGenerators.init(0)}}if(c3!==null){if(dI.envMipMap){dI.needsUpdate=!(c3.hasDiffuse===dI.envMipMap[1].hasDiffuse)}else{dI.needsUpdate=true}dI.envMap=cS;dI.envMipMap=[cS,c3]}}else{if(!dI.envMap){dI.needsUpdate=true}dI.envMipMap=c7.envMipMap;dI.envMap=c7.envMipMap[0]}dI.ambienceMatrix=c7.ambienceMatrix}else{if(!c7.reflectionProbes.length){if(dI.envMap){dI.needsUpdate=true}dI.envMipMap=null;dI.envMap=null}}if(dI.sheen>0||dI.sheenMap){var dd=dI._sheenData.overrideIBL!==null&&dI._sheenData.overrideIBL.hdr!==null;var dD=dd&&dI._sheenData.overrideIBL.hdr.loadEndStatus==="complete";var c2=dd&&dI._sheenData.overrideIBL.hdr.loadEndStatus==="useCurrent"&&c7.envMipMap.length>0;dd=dD||c2;if(dd){var dn=dI._sheenData.overrideIBL;var cS=c2?c7.envMipMap[0]:dn.hdr;var cT="generator";cT+="-"+dn.name;cT+="-"+cS.id;cT+="-"+dn.brdf;var c3=null;if(this.ambianceGenerators.manager){var c3=this.ambianceGenerators.getAmbiance(cT,!dn.direct,{hdr:cS,brdf:dn.brdf},dI.id);this.ambianceGenerators.needsUpdate=this.ambianceGenerators.needsUpdate||!c3.complete;c3=c3.ambiance}else{this.ambianceGenerators.init(1)}if(dI._sheenData.envMipMap===null&&c3!==null){dI.needsUpdate=true}dI._sheenData.envMipMap=c3}}else{if(dI._sheenData&&dI._sheenData.envMipMap){dI.needsUpdate=true;dI._sheenData.envMipMap=null}}if(dI.updateSSS){if(this.sssGenerator===null){this.sssGenerator={ready:false};var dH=this;require(["DS/Visualization/SubsurfaceGenerator"],function(dl){dH.sssGenerator=new dl()})}dI._updateSubsurfaceScattering(this.sssGenerator)}if(c7.reflectionProbes.length){dI.envMap=c7.reflectionProbes[0].map0;dI.reflectionProbes=c7.reflectionProbes}else{if(dI.reflectionProbes){dI.needsUpdate=true}dI.reflectionProbes=null}if(c7.useFiniteEnvMap){dI.useFiniteEnvMap=c7.useFiniteEnvMap;dI.parallaxCorrectionParameters=c7.parallaxCorrectionParameters}else{dI.useFiniteEnvMap=false}if(dI.sslr&&this.prevColorBuffer&&this.prevNormalDepthBuffer){dI.__prevColorTexture=this.prevColorBuffer.renderResults.main;dI.__prevNormalDepthTexture=this.prevNormalDepthBuffer.renderResults.main}}if(dI.physical){if(c7.envMipMap.length>0){dI.envMipMap=c7.envMipMap;dI.envMap=c7.envMipMap[0];dI.ambienceMatrix=c7.ambienceMatrix}if(c7.reflectionProbes.length){dI.envMap=c7.reflectionProbes[0].map0;dI.reflectionProbes=c7.reflectionProbes}if(c7.useFiniteEnvMap){dI.useFiniteEnvMap=c7.useFiniteEnvMap;dI.parallaxCorrectionParameters=c7.parallaxCorrectionParameters}if(dI.sslr&&this.prevColorBuffer&&this.prevNormalDepthBuffer){dI.__prevColorTexture=this.prevColorBuffer.renderResults.main;dI.__prevNormalDepthTexture=this.prevNormalDepthBuffer.renderResults.main}}if(dI.isRevealMat){bm.setBlending(s.CustomBlending,dI.blendEquation,s.ZeroFactor,s.OneMinusSrcColorFactor)}else{if(dI.isAccumMat){bm.setBlending(s.CustomBlending,dI.blendEquation,s.OneFactor,s.OneFactor)}else{if(dI.useBlending||(!dI.iterative&&(dI.transparent||dI.getOpacity()<1))){bm.setBlending(dI.blending,dI.blendEquation,dI.blendSrc,dI.blendDst)}else{var c1=false;if(cQ&&cQ.hasTransparency()){c1=true}else{if(this.useRenderPriorityOpacity){var dq=this.computeRenderPriorityOpacity(1,cQ);if(dq<1){c1=true}}}if(c1){bm.setBlending(s.NormalBlending,s.AddEquation,s.SrcAlphaFactor,s.OneMinusSrcAlphaFactor)}else{bm.setBlending(s.NoBlending)}}}}if(cZ[2]&&!cZ[2].glType&&cZ[2]._geomType===s.GeomTypeEnum.SURFACIC_POINT){bm.setDepthTest(true)}else{bm.setDepthTest(dI.depthTest&&!bm.disableDepthTest)}var dK=c4;if(!c4){if(!this.currentPass.isRobotPass&&cO.hasTranspar&&(!!ds.opacityMap||!!ds.map||(ds.getOpacity()===1&&cQ===null)||(cQ&&cQ.getOpacity()===1))){c4=true}if(this.currentPass.isRobotPass&&df){c4=true}}bm.setDepthWrite(dI.depthWrite&&c4&&!bm.disableDepthWrite);c4=dK;if(dA||cG){if(dA){if(c7.colorHighlight&&dI.uniforms.iScanEffectIntensity){dI.uniforms.iScanEffectIntensity.value=c7.colorHighlight.intensity}if(c7.colorHighlight&&dI.uniforms.colorHighlight){dI.uniforms.colorHighlight.value.x=c7.colorHighlight.color.r;dI.uniforms.colorHighlight.value.y=c7.colorHighlight.color.g;dI.uniforms.colorHighlight.value.z=c7.colorHighlight.color.b;dI.uniforms.colorHighlight.value.w=c7.colorHighlight.intensity}}if(cG){if(c7.colorHighlight&&dI.uniforms.colorHighlight){dI.uniforms.colorHighlight.value.x=c7.colorHighlight.outlineColor.r;dI.uniforms.colorHighlight.value.y=c7.colorHighlight.outlineColor.g;dI.uniforms.colorHighlight.value.z=c7.colorHighlight.outlineColor.b}}dI.polygonOffset=c7.colorHighlight.polygonOffsetParameters.activated;dI.polygonOffsetFactor=c7.colorHighlight.polygonOffsetParameters.factor;dI.polygonOffsetUnits=c7.colorHighlight.polygonOffsetParameters.unit}if(this.forcePolygonOffset===s.PolygonOffsetForceStatus.DEFAULT){cz(dI.polygonOffset,dI.polygonOffsetFactor,dI.polygonOffsetUnits)}bm._clipPlanesState.update(dE.occurrenceRenderingOverride,c5,false,ds,cY,bm.cuttingScene?true:false);c5=dE.occurrenceRenderingOverride;var dr,cE=false,cV;if(!ds.visible){dI._setupOIT(0);continue}if((ds.overridable&&cQ&&cQ.getOpacity()===0)||(!cQ&&ds.getOpacity()===0)){dI._setupOIT(0);continue}if(this.useRenderPriorityOpacity){var dq=this.computeRenderPriorityOpacity(1,cQ);if(dq===0){dI._setupOIT(0);continue}}var cX=true;for(dr=cZ;dr;dr=dr.next){cV=dr[2];if(cV&&cV.gas&&!dI.forceSide){this.setMaterialFaces(cV.gas,dr[0],cY,(cV.glType===dJ))}else{this.setMaterialFaces(dI,dr[0],cY)}if(dr[1]._type===2){if(cQ&&cV&&(cV._geomType===s.GeomTypeEnum.BOUNDARY_EDGE||cV._geomType===s.GeomTypeEnum.SMOOTH_EDGE||cV._geomType===s.GeomTypeEnum.SHARP_EDGE)){cQ.disableColorOverride=true}if(dr[0]&&dr[0].sectionLinesBuilder!==null&&dr[0].sectionLinesBuilder.sectionLineGeometry&&dr[1]===dr[0].sectionLinesBuilder.sectionLineGeometry){this.renderSectionLines(cY,cK,dB,dr[0],ds,null,dr[1],cV,dr[3],dr[4],dE.occurrenceRenderingOverride,cQ,cX)}else{cE=this.renderInterval(cY,cK,dB,dr[0],ds,null,dr[1],cV,dr[3],dr[4],dE.occurrenceRenderingOverride,cQ,cX,dv)}if(cQ){cQ.disableColorOverride=false}if(cE){cX=false}}else{if(dr[1]._type===1){cE=this.renderBufferDirect(cY,cK,dB,dI,dr[1],dr[0])}else{cE=this.renderBuffer(cY,cK,dB,dI,dr[1],dr[0])}}}if(cE){if(this.renderCuttingElements(dI,cY,cK,dB,dE.occurrenceRenderingOverride)){c5=null}}dI._setupOIT(0)}if(cO.depthFunc){if(this.currentPass.depthFunc){w.depthFunc(w[this.currentPass.depthFunc])}else{w.depthFunc(w.LEQUAL)}}if(cO.useStencil){if((cO.name!=="NOZ")||(cO.name==="NOZ"&&this.materialToUse===s.MaterialToUse.originalMaterial)){w.disable(w.STENCIL_TEST)}}}window.webVisuPerfo.endPerfo("draw");if(this.enableRenderPluginsPost){K(this.renderPluginsPost,c7,cY)}if(di&&di.generateMipmaps&&di.minFilter!==s.NearestFilter&&di.minFilter!==s.LinearFilter){bu(di)}if(this.disableColorWrite){w.colorMask(true,true,true,true)}this.setDepthTest(true);this.setDepthWrite(true)};this.doRenderPlugins=function(cE,cI,cG,cH){this.initWebGLObjects(cI);var cF=0;for(cF=0;cF<cE.length;cF++){if(!cE[cF].noRenderTarget){this.setRenderTarget(cH)}}K(cE,cI,cG)};function K(cE,cI,cH){if(!cE.length){return}for(var cG=0,cF=cE.length;cG<cF;cG++){w._currentProgram=null;bi=null;w._oldBlending=-1;u=-1;cf=-1;bZ=-1;E=-1;ad=-1;bD=-1,bC=-1;bB=-1;aM=null;bK=null;aL=null;cD=true;cE[cG].render(cI,cH,s.glStates.currentWidth,s.glStates.currentHeight);w._currentProgram=null;bi=null;w._oldBlending=-1;u=-1;cf=-1;bZ=-1;E=-1;ad=-1;bD=-1,bC=-1;bB=-1;aM=null;bK=null;aL=null;cD=true}}this.renderObjects=function(cK,cI,cJ,cR,cW,cE,cV,cM,cY){var cF,cX,cO,cL,cH,cG,cT;if(cI){cH=cK.length-1;cG=-1;cT=-1}else{cH=0;cG=cK.length;cT=1}for(var cQ=cH;cQ!==cG;cQ+=cT){cF=cK[cQ];if(cF!==null&&cF.render){cX=cF.object;cO=cF.buffer;if(cM){cL=cM}else{cL=cF.object.material[this.materialToUse];if(cL===undefined){cL=cF.object.material}if(!cL){continue}if(cV||cL.useBlending){bm.setBlending(cL.blending,cL.blendEquation,cL.blendSrc,cL.blendDst)}else{bm.setBlending(s.NoBlending)}bm.setDepthTest(cL.depthTest&&!bm.disableDepthTest);bm.setDepthWrite(cL.depthWrite&&!bm.disableDepthWrite);if(bm.forcePolygonOffset===s.PolygonOffsetForceStatus.DEFAULT){cz(cL.polygonOffset,cL.polygonOffsetFactor,cL.polygonOffsetUnits)}}bm.setMaterialFaces(cL);if(cO._type===1){bm.renderBufferDirect(cR,cW,cE,cL,cO,cX)}else{if((cO._type===2)||(cO.length>=0)){var cS=cX.geometry.length||1;var cN=cX.geometry.length?cX.geometry[0]:cX.geometry;for(var cQ=0;cQ<cS;cQ++){var cU=cN.drawingGroups;for(var cP=0;cP<cU.length;cP++){bm.renderInterval(cR,cW,cE,cX,cL,null,cN,cU[cP],cU[cP].start,cU[cP].count,null,cY,true)}if(cS===1){break}cN=cX.geometry[cQ+1]}}else{bm.renderBuffer(cR,cW,cE,cL,cO,cX,cY)}}}}};this.renderImmediateObject=function(cI,cG,cJ,cH,cF){var cE=bo(cI,cG,cJ,cH,cF,null,cH.programManager.getProgramID(cF));ad=-1;bm.setMaterialFaces(cH);if(cF.immediateRenderCallback){cF.immediateRenderCallback(cE,w,ca)}else{cF.render(function(cK){bm.renderBufferImmediate(cK,cE,cH)})}};function bq(cG){var cE=cG.object,cF=cE.material;if(cF.transparent){cG.transparent=cF;cG.opaque=null}else{cG.opaque=cF;cG.transparent=null}}function a5(cM,cJ){var cH,cO,cL,cP,cK,cF,cI={};var cN=cM.morphTargets.length;var cE=cM.morphNormals.length;var cQ=cJ instanceof s.MeshFaceMaterial;cM.geometryGroups={};for(cH=0,cO=cM.faces.length;cH<cO;cH++){cL=cM.faces[cH];cP=cQ?cL.materialIndex:0;if(cI[cP]===undefined){cI[cP]={hash:cP,counter:0}}cF=cI[cP].hash+"_"+cI[cP].counter;if(cM.geometryGroups[cF]===undefined){cM.geometryGroups[cF]={faces3:[],faces4:[],materialIndex:cP,vertices:0,numMorphTargets:cN,numMorphNormals:cE}}cK=cL instanceof s.Face3?3:4;if(cM.geometryGroups[cF].vertices+cK>65535){cI[cP].counter+=1;cF=cI[cP].hash+"_"+cI[cP].counter;if(cM.geometryGroups[cF]===undefined){cM.geometryGroups[cF]={faces3:[],faces4:[],materialIndex:cP,vertices:0,numMorphTargets:cN,numMorphNormals:cE}}}if(cL instanceof s.Face3){cM.geometryGroups[cF].faces3.push(cH)}else{cM.geometryGroups[cF].faces4.push(cH)}cM.geometryGroups[cF].vertices+=cK}cM.geometryGroupsList=[];for(var cG in cM.geometryGroups){cM.geometryGroups[cG].id=s.GeometryIdCount++;cM.geometryGroupsList.push(cM.geometryGroups[cG])}}this.initWebGLObjects=function(cE){if(cE.initWebGLObjectFrameIndex!==this.currentFrameIndex){cE.initWebGLObjectFrameIndex=this.currentFrameIndex;if(!cE.__webglObjects){cE.__webglObjects={main:new s.WebGLObjectManager()};cE.__webglObjectsAll=new s.WebGLObjectManager();cE.__webglObjectsToDraw=[];cE.__webglObjectsSharedToInit=[];cE.__webglObjectsImmediate=[];cE.__webglSprites=[];if(!cE.__webglFlares){cE.__webglFlares=[]}}if(cE.__objectsAdded.size){cE.__objectsAdded.forEach(function(cG,cF,cH){aZ({object:cF,passes:cG},cE)});cE.__objectsAdded.clear()}if(cE.__objectsUpdated.size){cE.__objectsUpdated.forEach(function(cG,cF,cH){aq(cF,cE);aZ({object:cF,passes:cG},cE,true)});cE.__objectsUpdated.clear()}if(cE.__objectsRemoved.size){bm.__glResources__.removeGeometryList(cE.__objectsRemoved);cE.__objectsRemoved.forEach(function(cG,cF,cH){aq(cG,cE)});cE.__objectsRemoved.clear()}this.initSharedBuffersDS(cE.__webglObjectsSharedToInit,s.loadingModels==false);cE.traverseObject3DWithCondition(function(cF){if(cF.isRoot3ds){return false}else{an(cF);return true}})}};this.initObject=function(cF){var cJ=false;var cK;if(cF.geometry&&((cF.geometry._type===2)||(cF.geometry.length>=0))){cF._modelViewMatrix=new s._Float32Matrix4();cF._normalMatrix=new s.Matrix3();cL=cF.geometry;if(cL._type===2){cL.addEventListener("dispose",a0)}else{if(cL.length){for(var cH=0;cH<cL.length;cH++){cL[cH].addEventListener("dispose",a0)}}}if(cL._type===2){if(!cL.sharedBuffers){this.initDirectBuffersDS(cL,cF)}else{cJ=true}}else{if(cL.length>=0){if(cL.length>0&&!cL[0].sharedBuffers){for(var cH=0;cH<cL.length;cH++){this.initDirectBuffersDS(cL[cH],cF)}}else{cJ=true}}}}else{if(!cF.__webglInit){cF.__webglInit=true;cF._modelViewMatrix=new s._Float32Matrix4();cF._normalMatrix=new s.Matrix3();if(cF.geometry!==undefined&&cF.geometry.__webglInit===undefined){cF.geometry.__webglInit=true;cF.geometry.addEventListener("dispose",bx)}var cL=cF.geometry;if(cL===undefined){}else{if(cL._type===1){ac(cL)}else{if(cF instanceof s.Mesh){cI=cF.material;if(cL.geometryGroups===undefined){a5(cL,cI)}for(cK in cL.geometryGroups){var cE=cL.geometryGroups[cK];if(!cE.__webglVertexBuffer){bc(cE);aU(cE,cF);cL.verticesNeedUpdate=true;cL.morphTargetsNeedUpdate=true;cL.elementsNeedUpdate=true;cL.uvsNeedUpdate=true;cL.normalsNeedUpdate=true;cL.tangentsNeedUpdate=true;cL.colorsNeedUpdate=true}}}else{if(cF instanceof s.Line){if(!cL.__webglVertexBuffer){aN(cL);ak(cL,cF);cL.verticesNeedUpdate=true;cL.colorsNeedUpdate=true;cL.lineDistancesNeedUpdate=true}}else{if(cF instanceof s.ParticleSystem){if(!cL.__webglVertexBuffer){af(cL);co(cL,cF);cL.verticesNeedUpdate=true;cL.colorsNeedUpdate=true}var cI=al(cF,cL);var cG=cI.attributes&&C(cI);if(cL.verticesNeedUpdate||cL.colorsNeedUpdate||cF.sortParticles||cG){bI(cL,w.DYNAMIC_DRAW,cF)}cL.verticesNeedUpdate=false;cL.colorsNeedUpdate=false;cI.attributes&&a2(cI)}}}}}}}cF._updateWorldCenterAndRadius();return cJ};function aZ(cQ,cK,cR){var cH=cQ.object;var cP=cQ.passes;var cL,cO,cM,cG;var cF=bm.initObject(cH);var cJ=false;if(cH.__webglActive===cK){cJ=true}else{if((cH.__webglActive instanceof Array)&&cH.__webglActive.indexOf(cK)>=0){cJ=true}}if(!cJ){var cE=true;if(cH instanceof s.Mesh){cO=cH.geometry;if(cO._type===1){ah(cK.__webglObjects,cO,cH,cP,cK.__webglObjectsAll)}else{if((cO._type===2)||(cO.length>=0)){ah(cK.__webglObjects,cO,cH,cP,cK.__webglObjectsAll)}else{if(cO._type===0){for(cL in cO.geometryGroups){cG=cO.geometryGroups[cL];ah(cK.__webglObjects,cG,cH,cP,cK.__webglObjectsAll)}}}}}else{if(cH instanceof s.Line||cH instanceof s.ParticleSystem){cO=cH.geometry;ah(cK.__webglObjects,cO,cH,cP,cK.__webglObjectsAll)}else{if(cH instanceof s.ImmediateRenderObject||cH.immediateRenderCallback){ba(cK.__webglObjectsImmediate,cH,cP)}else{if(cH instanceof s.Sprite){cK.__webglSprites.push(cH);cE=false}else{if(cH instanceof s.CSS2DNode){ah(cK.__webglObjects,null,cH,["css2d"],cK.__webglObjectsAll)}else{if(cH instanceof s.CSS3DNode){ah(cK.__webglObjects,null,cH,["css3d"],cK.__webglObjectsAll)}}}}}}if(!cH.__webglActive){cH.__webglActive=cK}else{if(cH.__webglActive instanceof Array){cH.__webglActive.push(cK)}else{cH.__webglActive=[cH.__webglActive,cK]}}if(cE){var cI=cK.__webglObjectsAll.objects[cK.__webglObjectsAll.objects.length-1];if(!cR){bm.__glResources__.geometry.push(cI)}if(cF){cK.__webglObjectsSharedToInit.push(cI)}else{if(cH.geometry){var cN=cH.geometry.length?cH.geometry[0].vertexBuffer:cH.geometry.vertexBuffer;cI.sortKey=cN?cN.id:0}}}else{if(!cR){bm.__glResources__.geometry.push({object:cH})}}}}var ag=["main"];function ah(cH,cF,cG,cK,cE){if(!cK){cK=ag}var cI,cJ,cL={buffer:cF,object:cG,opaque:null,transparent:null,render:true,z:0,sortKey:0};for(cI=0;cI<cK.length;cI++){cJ=cK[cI];if(!cH[cJ]){cH[cJ]=new s.WebGLObjectManager()}cH[cJ].add(cL)}cE.add(cL)}function ba(cF,cE){cF.push({buffer:null,object:cE,opaque:null,transparent:null,render:true,z:0,sortKey:0})}function an(cH,cF){var cL=cH.geometry,cE,cJ,cK;if(!cL){return}if(cL._type===1){a4(cL,w.DYNAMIC_DRAW,!cL.dynamic)}else{if((cL._type===2)||(cL.length>=0)){}else{if(cH instanceof s.Mesh){for(var cI=0,cG=cL.geometryGroupsList.length;cI<cG;cI++){cE=cL.geometryGroupsList[cI];cK=cF||al(cH,cE);if(cL.buffersNeedUpdate){aU(cE,cH)}cJ=cK.attributes&&C(cK);if(cL.verticesNeedUpdate||cL.morphTargetsNeedUpdate||cL.elementsNeedUpdate||cL.uvsNeedUpdate||cL.normalsNeedUpdate||cL.colorsNeedUpdate||cL.tangentsNeedUpdate||cJ){H(cE,cH,w.DYNAMIC_DRAW,!cL.dynamic,cK)}}cL.verticesNeedUpdate=false;cL.morphTargetsNeedUpdate=false;cL.elementsNeedUpdate=false;cL.uvsNeedUpdate=false;cL.normalsNeedUpdate=false;cL.colorsNeedUpdate=false;cL.tangentsNeedUpdate=false;cL.buffersNeedUpdate=false;cK.attributes&&a2(cK)}else{if(cH instanceof s.Line){cK=al(cH,cL);cJ=cK.attributes&&C(cK);if(cL.verticesNeedUpdate||cL.colorsNeedUpdate||cL.lineDistancesNeedUpdate||cJ){b4(cL,w.DYNAMIC_DRAW)}cL.verticesNeedUpdate=false;cL.colorsNeedUpdate=false;cL.lineDistancesNeedUpdate=false;cK.attributes&&a2(cK)}else{if(cH instanceof s.ParticleSystem){cK=al(cH,cL);cJ=cK.attributes&&C(cK);if(cL.verticesNeedUpdate||cL.colorsNeedUpdate||cH.sortParticles||cJ){bI(cL,w.DYNAMIC_DRAW,cH)}cL.verticesNeedUpdate=false;cL.colorsNeedUpdate=false;cK.attributes&&a2(cK)}}}}}}function C(cF){for(var cE in cF.attributes){if(cF.attributes[cE].needsUpdate){return true}}return false}function a2(cF){for(var cE in cF.attributes){cF.attributes[cE].needsUpdate=false}}function aq(cG,cH){if(cG instanceof s.Mesh||cG instanceof s.ParticleSystem||cG instanceof s.Line||cG instanceof s.CSS2DNode){bk(cH.__webglObjects,cG,cH.__webglObjectsAll)}else{if(cG instanceof s.Sprite){a7(cH.__webglSprites,cG)}else{if(cG instanceof s.ImmediateRenderObject||cG.immediateRenderCallback){cA(cH.__webglObjectsImmediate,cG)}}}var cE=cG.__webglActive,cF;if(cE){if(cE instanceof Array){cF=cE.indexOf(cH);if(cF<=0){cE.splice(cF,1);if(cE.length===1){cG.__webglActive=cE[0]}}}else{cG.__webglActive=false}}}function bk(cG,cF,cE){var cH;for(cH in cG){cG[cH].remove(cF)}cE.remove(cF)}function cA(cF,cE){for(var cG=cF.length-1;cG>=0;cG--){if(cF[cG].object===cE){cF.splice(cG,1)}}}function a7(cF,cE){for(var cG=cF.length-1;cG>=0;cG--){if(cF[cG]===cE){cF.splice(cG,1)}}}this.initMaterial=function(cR,c2,cE,c4,c5){cR.addEventListener("dispose",bW);var cQ,c1,cM,cY,cN,cW,c3,cS,cL,c0,cI,cG,cT;var cJ=cR.shaderID;if(cJ!==s.ShaderIDs.none){aX(cR,s.ShaderLib[s.ShaderIDsToName[cJ]])}cW=bT(c2);cS=aI(c2);cL=cS.dirLight;c0=cS.spotLight;cI=cS.tex2d;cG=cS.texCube;c3=1024;cT=6;var cH=0;if(!!cR.envMap){var cP=cR.envMap.mapping;if(cP instanceof s.SphericalReflectionMapping){cH=1}else{if(cP instanceof s.LatLongReflectionMapping){cH=2}}}var cK=!!cR.map||!!cR.lightMap||!!cR.emissionColorMap||!!cR.bumpMap||!!cR.normalMap||!!cR.specularMap||!!cR.transparencyMap||!!cR.metalnessMap||!!cR.specularContribMap||!!cR.displacementMap||!!cR.clearCoatRoughnessMap||!!cR.coatingGlossinessMap||!!cR.anisotropyMap||!!cR.anisotropyAngleMap||!!cR.opacityMap||!!cR.roughnessMap||cR.glossinessMap||!!cR.clearCoatNormalMap||!!cR.clearCoatMap||!!cR.flakesColorMap||!!cR.flakesCoverageMap||!!cR.flakesRoughnessMap||cR.flakesSizeMap;var cX=true;var cV=false;if(cR.uvSlots){cX=(cR.uvSlots.diffuseMap===1)||(cR.uvSlots.specularMap===1)||(cR.uvSlots.roughnessMap===1)||(cR.uvSlots.normalMap===1)||(cR.uvSlots.lightMap===1);cV=(cR.uvSlots.diffuseMap===2)||(cR.uvSlots.specularMap===2)||(cR.uvSlots.roughnessMap===2)||(cR.uvSlots.normalMap===2)||(cR.uvSlots.lightMap===2)}cN={maxDirLights:cW.directional,maxPointLights:cW.point,maxSpotLights:cW.spot,maxHemiLights:cW.hemi,probeLight:cW.probe,maxSphereLights:cW.sphere,maxTubeLights:cW.tube,maxDiskLights:cW.disk,maxAreaLights:cW.area,maxIESLights:cW.ies,lightMap:!!cR.lightMap,lightMapMode:cR.lightMapMode,lightMapLinear:cR.lightMapLinear,useLighting:cR.useLighting,maxDirShadows:cL,maxSpotShadows:c0,maxShadows:cI,maxShadowsCube:cG,shadowMapEnabled:this.shadowMapEnabled&&(cI>0)&&c4.receiveShadow,shadowMapCubeEnabled:this.shadowMapEnabled&&(cG>0)&&c4.receiveShadow,shadowMapType:this.shadowMapType,shadowMapQuality:this.shadowMapQuality,shadowMapDebug:this.shadowMapDebug,shadowMapCascade:this.shadowMapCascade,morphTargets:cR.morphTargets,morphNormals:cR.morphNormals,maxMorphTargets:this.maxMorphTargets,maxMorphNormals:this.maxMorphNormals,fixedSize:c4&&c4._ratioData&&c4._ratioData.ratio>0,fixedSizeCenter:c4&&c4._ratioData&&c4._ratioData.ratio>0&&c4._ratioData.center,skinning:cR.skinning,useEulerAngles:cR.useEulerAngles,maxBones:c3,skinningMapWidth:cR&&cR.skinningMapWidth,skinningMapHeight:cR&&cR.skinningMapHeight,skinningInstancingMapsInfo:cR.skinningInstancingMapsInfo,useUV:cK,useUV1:cX,useUV2:cV,diffuseMapUVSlot:cR.uvSlots?cR.uvSlots.diffuseMap:1,specularMapUVSlot:cR.uvSlots?cR.uvSlots.specularMap:1,roughnessMapUVSlot:cR.uvSlots?cR.uvSlots.roughnessMap:1,normalMapUVSlot:cR.uvSlots?cR.uvSlots.normalMap:1,lightMapUVSlot:cR.uvSlots?cR.uvSlots.lightMap:2,mappingType:cR.mappingType,mappingUseFragment:cR.mappingUseFragment,mappingNormTransformation:cR.mappingNormTransformation,mappingObjTransformation:cR.mappingObjTransformation,mappingUVTransformation:cR.mappingUVTransformation,textureBlending:cR.textureBlending,textureFormat:cR.map,needTangent:cR.needTangent,needTangentBinormal:cR.needTangentBinormal||cR.anisotropy>0||!!cR.anisotropyMap,sphereMap:cR.sphereMap,maxClipPlanes:cT,clipPlanesEnabled:this.clipPlanes.length>0&&cR.enableClipPlanes,alphaTest:cR.alphaTest,metal:cR.metal,perPixel:cR.perPixel,wrapAround:cR.wrapAround,doubleSided:cR.side===a.DoubleSide,flipSided:cR.side===a.BackSide,vertexColors:cR.vertexColors,sizeAttenuation:cR.sizeAttenuation,isMultiInstanced:c4&&c4._instancingInfos&&c4._instancingInfos.isInstanceNode3D,instancingMeshSelectionMode:c4&&c4._instancingInfos&&c4._instancingInfos.instancingSelectionMode==="mesh",_definePickingInstancing:cR._definePickingInstancing,fog:cE,useFog:cR.fog,fogExp:cE instanceof s.FogExp2,refractionRatioMap:!!cR.refractionRatioMap,normalMap:!!cR.normalMap,normalMapFlipY:!!cR.normalMapFlipY,normalUvTransform:cR.normalUvTransform,bumpMap:!!cR.bumpMap,specgloss:!!cR.ior&&Math.abs(cR.ior-1e+25)<1,map:!!cR.map,mapHDR:!!cR.map&&cR.map.hdr,diffuseMulCoef:!!cR.diffuseMulCoef,diffuseAddCoef:!!cR.diffuseAddCoef,useAlphaFromDiffuseMap:!!cR.useAlphaFromDiffuseMap,specularMap:!!cR.specularMap,specularMulCoef:!!cR.specularMulCoef,specularAddCoef:!!cR.specularAddCoef,specularMapLinear:!!cR.specularMapLinear,metalnessMap:!!cR.metalnessMap,metalnessMulCoef:!!cR.metalnessMulCoef&&cR.metalnessMulCoef!==1,metalnessAddCoef:!!cR.metalnessAddCoef&&cR.metalnessAddCoef!==0,metalnessMapLinear:!!cR.metalnessMapLinear,specularContribMap:!!cR.specularContribMap,specularContribMulCoef:!!cR.specularContribMulCoef&&cR.specularContribMulCoef!==1,specularContribAddCoef:!!cR.specularContribAddCoef&&cR.specularContribAddCoef!==0,emissionColorMap:!!cR.emissionColorMap,emissionColorMulCoef:!!cR.emissionColorMulCoef,emissionColorAddCoef:!!cR.emissionColorAddCoef,emissionNormalized:cR.emissionNormalized,emissionColorMapLinear:!!cR.emissionColorMapLinear,transparencyMap:!!cR.transparencyMap,transparencyMulCoef:!!cR.transparencyMulCoef&&cR.transparencyMulCoef!==1,transparencyAddCoef:!!cR.transparencyAddCoef&&cR.transparencyAddCoef!==0,opacityMap:!!cR.opacityMap,opacityMulCoef:!!cR.opacityMulCoef&&cR.opacityMulCoef!==1,opacityAddCoef:!!cR.opacityAddCoef&&cR.opacityAddCoef!==0,roughnessMap:!!cR.roughnessMap,glossinessMap:!!cR.glossinessMap,glossinessMulCoef:!!cR.glossinessMulCoef&&cR.glossinessMulCoef!==1,glossinessAddCoef:!!cR.glossinessAddCoef&&cR.glossinessAddCoef!==0,roughnessMulCoef:!!cR.roughnessMulCoef&&cR.roughnessMulCoef!==1,roughnessAddCoef:!!cR.roughnessAddCoef&&cR.roughnessAddCoef!==0,roughnessMapLinear:!!cR.roughnessMapLinear,anisotropy:cR.anisotropy>0||!!cR.anisotropyMap,anisotropyMap:!!cR.anisotropyMap,anisotropyMulCoef:!!cR.anisotropyMulCoef&&cR.anisotropyMulCoef!==1,anisotropyAddCoef:!!cR.anisotropyAddCoef&&cR.anisotropyAddCoef!==0,anisotropyAngleMap:!!cR.anisotropyAngleMap,anisotropyAngleMulCoef:!!cR.anisotropyAngleMulCoef&&cR.anisotropyAngleMulCoef!==1,anisotropyAngleAddCoef:!!cR.anisotropyAngleAddCoef&&cR.anisotropyAngleAddCoef!==0,displacementMap:!!cR.displacementMap,reflectionProbes:cR.reflectionProbes,useFiniteEnvMap:cR.useFiniteEnvMap,sheen:cR.sheen||cR.sheenMap,sheenMap:!!cR.sheenMap,sheenMulCoef:!!cR.sheenMulCoef&&cR.sheenMulCoef!==1,sheenAddCoef:!!cR.sheenAddCoef&&cR.sheenAddCoef!==0,sheenMode:cR.sheenMode,old_flakes:typeof cR.flakes!=="undefined",flakes:(typeof cR.flakesCoverageMap!=="undefined"&&(cR.flakesCoverage>0||!!cR.flakesCoverageMap))||cR.flakes,flakesMode:cR.flakesMode,flakesSizeMap:!!cR.flakesSizeMap,flakesSizeMulCoef:!!cR.flakesSizeMulCoef&&cR.flakesSizeMulCoef!==1,flakesSizeAddCoef:!!cR.flakesSizeAddCoef&&cR.flakesSizeAddCoef!==0,flakesCoverageMap:!!cR.flakesCoverageMap,flakesCoverageMulCoef:!!cR.flakesCoverageMulCoef&&cR.flakesCoverageMulCoef!==1,flakesCoverageAddCoef:!!cR.flakesCoverageAddCoef&&cR.flakesCoverageAddCoef!==0,flakesRoughnessMap:!!cR.flakesRoughnessMap,flakesRoughnessMulCoef:!!cR.flakesRoughnessMulCoef&&cR.flakesRoughnessMulCoef!==1,flakesRoughnessAddCoef:!!cR.flakesRoughnessAddCoef&&cR.flakesRoughnessAddCoef!==0,flakesColorMap:!!cR.flakesColorMap,flakesColorMulCoef:!!cR.flakesColorMulCoef,flakesColorAddCoef:!!cR.flakesColorAddCoef,clearCoat:cR.clearCoat>0||!!cR.clearCoatMap,clearCoatMap:!!cR.clearCoatMap,clearCoatMulCoef:!!cR.clearCoatMulCoef&&cR.clearCoatMulCoef!==1,clearCoatAddCoef:!!cR.clearCoatAddCoef&&cR.clearCoatAddCoef!==0,clearCoatRoughnessMap:!!cR.clearCoatRoughnessMap,clearCoatRoughnessMulCoef:!!cR.clearCoatRoughnessMulCoef&&cR.clearCoatRoughnessMulCoef!==1,clearCoatRoughnessAddCoef:!!cR.clearCoatRoughnessAddCoef&&cR.clearCoatRoughnessAddCoef!==0,coatingGlossinessMap:!!cR.coatingGlossinessMap,coatingGlossinessMulCoef:!!cR.coatingGlossinessMulCoef&&cR.coatingGlossinessMulCoef!==1,coatingGlossinessAddCoef:!!cR.coatingGlossinessAddCoef&&cR.coatingGlossinessAddCoef!==0,clearCoatRoughnessMapLinear:!!cR.clearCoatRoughnessMapLinear,clearCoatNormalMap:!!cR.clearCoatNormalMap,clearCoatNormalMapFlipY:cR.clearCoatNormalMapFlipY,orangePeel:cR.orangePeel&&!(!!cR.clearCoatNormalMap),subsurface:cR._subsurface&&!cR.thinWalled,sssLUT:!!cR._sssLUT,sssIBLLUT:!!cR._sssIBLLUT,translucencyLUT:!!cR._translucencyLUT,envMap:!!cR.envMap,envMapSheen:!!cR.envMap&&cR._sheenData&&cR._sheenData.envMipMap!==null,envMapDiffuse:cR.envMipMap&&cR.envMipMap[1]&&cR.envMipMap[1].hasDiffuse,envMapHDR:cR.envMap&&cR.envMap.hdr,envMapping:cH,iterative:!!cR.iterative,sslr:!!cR.sslr,thinWalled:cR.thinWalled,dashedLine:cR.isDashedLine,cpuPattern:cR.isCPUPattern,patternSize:cR.isDashedLine&&!!cR.dashPattern?cR.dashPattern.length:0,wideLine:cR.isWideLine||cR.is2DLine,linejoin:cR.linejoin,linecap:cR.linecap,polygonBorderMode:cR.polygonBorderMode,_gasLook:cR._gasLook>0,NRECompatibility:!!cR.NRECompatibility,isAccumMat:cR.isAccumMat,isRevealMat:cR.isRevealMat,useOIT:cR.isOITable,compressedVertices:c4&&c4.compressedVertices,compressedNormals:c4&&c4.compressedNormals,largeScale:(c4&&c4.isLargeScale)?true:false};if(cR._PDSFXData&&cR._PDSFXData.PDSFX){var cU=cR._PDSFXData;cN.PDSFX=true;cN.PDSFX_OverridableFunctions_VS=cR._getPDSFXOverridableFunctions_VS();cN.PDSFX_OverridableFunctions_FS=cR._getPDSFXOverridableFunctions_FS();cN.PDSFX_hasAlbedo=cU.PDSFX_hasAlbedo;cN.PDSFX_hasEmissive=cU.PDSFX_hasEmissive;cN.PDSFX_hasSpecular=cU.PDSFX_hasSpecular;cN.PDSFX_hasPsColor=cU.PDSFX_hasPsColor;cN.PDSFX_hasTransparency=cU.PDSFX_hasTransparency;cN.pdsfxVaryingsCode=cU.pdsfxVaryingsCode?cU.pdsfxVaryingsCode:"";cN.pdsfxUniformsCode=cU.pdsfxUniformsCode?cU.pdsfxUniformsCode:null;if(cU.pdsfxUniforms){cN.pdsfxUniforms=cU.pdsfxUniforms}cN.pdsfxGlobalVariablesCode_VS=cU.pdsfxGlobalVariablesCode_VS?cU.pdsfxGlobalVariablesCode_VS:"";cN.pdsfxGlobalVariablesCode_FS=cU.pdsfxGlobalVariablesCode_FS?cU.pdsfxGlobalVariablesCode_FS:"";cN.pdsfxAttributesCode=cU.pdsfxAttributesCode?cU.pdsfxAttributesCode:"";cN.pdsfxUseMap=cU.pdsfxUseMap?cU.pdsfxUseMap:"";if(cN.pdsfxUseMap){cN.useUV=true;cN.useUV1=true;cN.useUV2=true}}cR.enableReceiveShadowOnCapping=cN.shadowMapEnabled;cR.program=B(cJ,cR.fragmentShader,cR.vertexShader,cR.uniforms,cR.attributes,cR.defines,cN);cR.programManager.addProgram(c4,cR.program,c5);var cO=cR.program.attributes;if(!cR.loadUniforms){cR.uniformsList=[];var cZ;for(cQ in cR.uniforms){var cF=cR.program.uniformLocations[cQ];if(cF){cZ=cR.uniforms[cQ];if(!cZ.sceneUniform&&!cZ.clipPlanesUniform){cR.uniformsList.push([cQ,cZ])}}}}if(cR._PDSFXData&&cR._PDSFXData.PDSFX){if(cR._PDSFXData.pdsfxUniforms){cR._PDSFXData._pdsfxUniformsList=[];var cZ;for(cQ in cR._PDSFXData.pdsfxUniforms){var cF=cR.program.uniformLocations[cQ];if(cF){cZ=cR._PDSFXData.pdsfxUniforms[cQ];cR._PDSFXData._pdsfxUniformsList.push([cQ,cZ])}}}}};function aX(cF,cE){cF.uniforms=cE.uniforms;cF.vertexShader=cE.vertexShader;cF.fragmentShader=cE.fragmentShader}function bo(cO,cK,cE,cP,cJ,cG,cS,cI){bR=0;aK=-1;if(cP._rendererId!==bm.context.contextId){cP._rendererId=bm.context.contextId;cP.program=null;cP.shaderVersion=bm.context.WebVisuShaderVersion;cP.needsUpdate=true}if(cP.shaderVersion!==-1&&cP.shaderVersion!==bm.context.WebVisuShaderVersion){cP.needsUpdate=true;cP.shaderVersion=bm.context.WebVisuShaderVersion}if(cP.lights&&cP.program&&(cP.program._lightsKey!==ap)){cP.needsUpdate=true}if(!cP.needsUpdate){cP.program=cP.programManager.getProgram(cJ,cI);if(cP.program===null){bm.initMaterial(cP,cK,cE,cJ,cI)}}if(cP.needsUpdate){cP.programManager.update(aw,null,cI);bm.initMaterial(cP,cK,cE,cJ,cI);cP.needsUpdate=false}var cH=cP._PDSFXData&&cP._PDSFXData.PDSFX;var cN=false;var cR=false;var cL=cP.program,cF=cL.uniformLocations,cQ=cP.uniforms;var cM=cL.program;var cT=cG?cG.id:-1;if(cP.id!==bC||cT!==bB){bC=cP.id;bB=cT;cN=true}if(cM!==w._currentProgram){w.useProgram(cM);w._currentProgram=cM;cR=true;cN=true}if(cR||cO!==bi){w.uniformMatrix4fv(cF.projectionMatrix,false,cO.projectionMatrix.elements);cF.viewMatrix&&w.uniformMatrix4fv(cF.viewMatrix,false,cO.matrixWorldInverse.elements);if(cH){cF.projectionInvMatrix&&w.uniformMatrix4fv(cF.projectionInvMatrix,false,cO.projectionMatrixInverse.elements);cF.viewInvMatrix&&w.uniformMatrix4fv(cF.viewInvMatrix,false,cO.matrixWorld.elements);if(cF.viewInvTranspMatrix){cF.viewInvTranspMatrix&&w.uniformMatrix4fv(cF.viewInvTranspMatrix,false,cO.matrixWorld.transpose().elements);cO.matrixWorld.transpose()}cF.nearFarLogFactor&&w.uniform3f(cF.nearFarLogFactor,cO.near,cO.far,1/Math.log(cO.far/cO.near));cF.viewportSize&&w.uniform2f(cF.viewportSize,cu,bs)}if(cO!==bi){bi=cO}}if(cN){cP.refreshUniforms(bm,cJ,cG);if(cP.physical){cQ.renderIteration.value=bm.renderIteration;bm.refreshUniformsPhysicalDSRoughnessMaps(cQ,cP,0.2)}else{if(cP instanceof s.ShaderMaterial&&(cP.isWideLine||cP.is2DLine||cP.isDashedLine)){bm.refreshUniformsLine(cQ,cP,cG)}}if(cP.loadUniforms){cP.loadUniforms(bm,w,cL.uniformLocations,cG)}else{if(cP.skinning){bU(cQ,cP,cG)}ax(cF,cP.uniformsList)}if(cH){if(cP._PDSFXData._pdsfxUniformsList){if(cP.refreshPDSFXUniforms){cP.refreshPDSFXUniforms()}ax(cF,cP._PDSFXData._pdsfxUniformsList)}}if(cR){if(cP.needsCameraPosition||cP.envMap||cH){if(cF.cameraPosition){aC.getPositionFromMatrix(cO.matrixWorld);w.uniform3f(cF.cameraPosition,aC.x,aC.y,aC.z)}}if(cF.cameraConstant){w.uniform1f(cF.cameraConstant,cO.fixedSizeCameraConstant)}if(cP.lights){if(cD){y(cK,cO);cD=false}bm.loadUniformsLights(w,cL.uniformLocations,b5,cL)}if(cE&&cP.fog){bm.loadUniformsFog(w,cL.uniformLocations,cE)}if(cJ.receiveShadow&&!cP._shadowPass){bm.loadUniformsShadow(w,cL,cK)}}}if(cR||cL._clipPlanesVersion!==bm._clipPlanesState.version){if(cP.enableClipPlanes){bm.loadClippingUniforms(w,cL.uniformLocations)}cL._clipPlanesVersion=bm._clipPlanesState.version}aM=null;bK=null;aL=null;var cU=cL.objectUniformLocations;bm.loadObjectUniforms(cU,cJ,cS,cP,cO,cK);W=cI;return cL}function bU(cE,cG,cH){if(cG.skinning){if(cG.skinningMap){cE.skinningMap.value=cG.skinningMap;cE.skinningMap.value.needsUpdate=true}if(cG.skinningInstancingMaps){cE.skinningInstancingMaps.value=cG.skinningInstancingMaps;for(var cF=0;cF<cG.skinningInstancingMaps.length;cF++){cE.skinningInstancingMaps.value[cF].needsUpdate=true}}}}function R(cF,cG,cJ,cH,cE){if(cF.nbClipPlanes){cF.nbClipPlanes.value=cG.length;cF.clipPlaneEquations.value=cG.eqs;cF.clipPlaneActive.value=cG.states.slice(0);var cI=cH&&cH.clippingSettings;if(!cI||cE){cF.clipFrontOpacity.value=1;cF.clipBackOpacity.value=0}else{cF.clipFrontOpacity.value=cI.frontOpacity<0.5?0:1;cF.clipBackOpacity.value=cI.backOpacity<0.5?0:1}if(cJ){cF.clipPlaneActive.value[cJ-1]=0}}}function ao(cE,cF){if(cE.polygonPoints){cE.polygonPoints.value=cF?cF.clippingPolygonTexture:null;cE.polygonSize.value=cF?cF.polyLineSize:0;if(cF&&cF.planeU){cE.extrusionPlaneU.value=cF.planeU}if(cF&&cF.planeV){cE.extrusionPlaneV.value=cF.planeV}}}this.loadObjectUniforms=function(cH,cF,cG,cJ,cI,cE){if(cH.quantizedVector){w.uniform3f(cH.quantizedVector,cG.quantizedVector.x,cG.quantizedVector.y,cG.quantizedVector.z)}if(cH.offsetVector){w.uniform3f(cH.offsetVector,cG.offsetVector.x,cG.offsetVector.y,cG.offsetVector.z)}if(aM!==cF.matrixWorld){if(cH.fixedSizeCenterRatio){w.uniform4f(cH.fixedSizeCenterRatio,cF._ratioData.center.x,cF._ratioData.center.y,cF._ratioData.center.z,cF._ratioData.ratio)}else{if(cH.fixedSizeRatio){w.uniform1f(cH.fixedSizeRatio,cF._ratioData.ratio)}}if(cH.modelViewMatrix){w.uniformMatrix4fv(cH.modelViewMatrix,false,cF._modelViewMatrix.elements)}if(cH.modelMatrix){w.uniformMatrix4fv(cH.modelMatrix,false,this.float32MatrixTemp.setDoubles(cF.matrixWorld.elements))}if(cJ._PDSFXData&&cJ._PDSFXData.PDSFX){if(cH.modelInvTranspMatrix){if(!cF.modelInvTranspMatrix){cF.modelInvTranspMatrix=new s.Matrix4().getInverse(cF.matrixWorld).transpose()}w.uniformMatrix4fv(cH.modelInvTranspMatrix,false,cF.modelInvTranspMatrix.elements)}if(cH.modelViewInvTranspMatrix){if(!cF.modelViewInvTranspMatrix){cF.modelViewInvTranspMatrix=new s._Float32Matrix4().multiplyDoubleMatricesAndInverse(cI.matrixWorldInverse,cF.matrixWorld).transpose()}w.uniformMatrix4fv(cH.modelViewInvTranspMatrix,false,cF.modelViewInvTranspMatrix.elements)}}if(aK!==cF.isUniformlyScaled){aK=cF.isUniformlyScaled;cH.use_normal_matrix&&w.uniform1i(cH.use_normal_matrix,!cF.isUniformlyScaled)}if(!cF.isUniformlyScaled){cH.normalMatrix&&w.uniformMatrix3fv(cH.normalMatrix,false,cF._normalMatrix.elements)}if(cF.receiveShadow&&!cJ._shadowPass){bm.loadUniformsShadowMatrices(w,cJ.program,cE,cF)}aM=cF.matrixWorld}};function a3(){var cE=bR;if(cE>=cn){console.warn("WebGLRenderer: trying to use "+cE+" texture units while this GPU supports only "+cn)}bR+=1;return cE}this.loadMatrix3=function(cG,cE,cF){if(cF){cG.uniformMatrix3fv(cE,false,cF.elements)}};this.loadMatrix4=function(cG,cE,cF){if(cF){cG.uniformMatrix4fv(cE,false,cF.elements)}};this.loadMatrix4Array=function(cL,cG,cE,cH,cJ){var cK=cG.flattenedUniformArrays;if(cK[cH]===undefined){cK[cH]=new Float32Array(16*cJ.length)}var cF;for(var cI=0,cF=cJ.length;cI<cF;cI++){if(cJ[cI]){cJ[cI].flattenToArrayOffset(cK[cH],cI*16)}}cL.uniformMatrix4fv(cE,false,cK[cH])};this.loadVector2Array=function(cI,cH,cM,cJ,cL){var cG=cH.flattenedUniformArrays;if(cG[cJ]===undefined){cG[cJ]=new Float32Array(2*cL.length)}var cK,cE;for(var cF=0,cK=cL.length;cF<cK;cF++){cE=cF*2;cG[cJ][cE]=cL[cF].x;cG[cJ][cE+1]=cL[cF].y}cI.uniform2fv(cM,cG[cJ])};this.loadTexture=function(cI,cE,cH){var cG=cH;var cF=a3();cI.uniform1i(cE,cF);if(cG){if(cG.image instanceof Array&&cG.image.length===6){b0(cG,cF)}else{if(cG instanceof s.WebGLRenderTargetCube){bM(cG,cF)}else{this.setTexture(cG,cF)}}}};this.loadTextureArray=function(cH,cG,cM,cJ,cL){var cF,cK,cI,cN;var cE=cG.flattenedUniformArrays;if(cE[cJ]===undefined){cE[cJ]=[]}for(cF=0,cK=cL.length;cF<cK;cF++){cE[cJ][cF]=a3()}w.uniform1iv(cM,cE[cJ]);for(cF=0,cK=cL.length;cF<cK;cF++){cI=cL[cF];cN=cE[cJ][cF];if(cI){this.setTexture(cI,cN)}}};this.loadTextureCubeArray=function(cH,cG,cM,cJ,cL){var cF,cK,cI,cN;var cE=cG.flattenedUniformArrays;if(cE[cJ]===undefined){cE[cJ]=[]}for(cF=0,cK=cL.length;cF<cK;cF++){cE[cJ][cF]=a3()}w.uniform1iv(cM,cE[cJ]);for(cF=0,cK=cL.length;cF<cK;cF++){cI=cL[cF];cN=cE[cJ][cF];if(cI){bM(cI,cN)}}};this.loadUniformsCommon=function(cK,cL,cH,cI){if(cH.diffuse){var cG=cL.color;if(cI&&cI.getColor()){cG=new s.Color(cI.getColor())}if(this.gammaInput){if(cL.NRECompatibility){cG=new s.Color().copyGammaToLinearNRECompatible(cG)}else{cG=new s.Color().copyGammaToLinear(cG)}}cK.uniform3f(cH.diffuse,cG.r,cG.g,cG.b)}if(cH.opacity){var cM=cL.opacity;if(cI&&cI.getOpacity()!==null){cM=cI.getOpacity()}if(this.useRenderPriorityOpacity){cM=this.computeRenderPriorityOpacity(cM,cI)}cK.uniform1f(cH.opacity,cM)}if(cH.envMapExposure){cK.uniform1f(cH.envMapExposure,cL.envMapExposure||cL.envMapExposure==0?cL.envMapExposure:1)}if(cH.ambienceMatrix){this.loadMatrix4(cK,cH.ambienceMatrix,cL.ambienceMatrix?cL.ambienceMatrix:new s.Matrix4())}if(cH.flipEnvMap){cK.uniform1f(cH.flipEnvMap,cL.flipEnvMap||cL.flipEnvMap==0?cL.flipEnvMap:1)}if(cH.reflectivity){cK.uniform1f(cH.reflectivity,cL.reflectivity||cL.reflectivity==0?cL.reflectivity:1)}if(cH.refractionRatio){cK.uniform1f(cH.refractionRatio,cL.refractionRatio||cL.refractionRatio==0?cL.refractionRatio:0.98)}if(cH.morphTargetInfluences){cK.uniform1f(cH.morphTargetInfluences,cL.morphTargetInfluences?cL.morphTargetInfluences:0)}if(cH.combine){cK.uniform1i(cH.combine,cL.combine?cL.combine:0)}if(cH.renderIteration){cK.uniform1i(cH.renderIteration,this.renderIteration?this.renderIteration:0)}var cE;if(cL.map){cE=cL.map}else{if(cL.specularMap){cE=cL.specularMap}else{if(cL.normalMap){cE=cL.normalMap}else{if(cL.bumpMap){cE=cL.bumpMap}}}}if(cE!==undefined){var cJ=cE.offset;var cF=cE.repeat;if(cH.offsetBumpMap){cK.uniform2f(cH.offsetBumpMap,cJ.x,cJ.y)}if(cH.repeatBumpMap){cK.uniform2f(cH.repeatBumpMap,cF.x,cF.y)}}else{if(cH.offsetBumpMap){cK.uniform2f(cH.offsetBumpMap,0,0)}if(cH.repeatBumpMap){cK.uniform2f(cH.repeatBumpMap,1,1)}}if(cH.map){this.loadTexture(cK,cH.map,cL.map)}if(cH.lightMap){this.loadTexture(cK,cH.lightMap,cL.lightMap)}if(cH.specularMap){this.loadTexture(cK,cH.specularMap,cL.specularMap)}if(cH.envMap){this.loadTexture(cK,cH.envMap,cL.envMap)}if(cH.refractionRatioMap){this.loadTexture(cK,cH.refractionRatioMap,cL.refractionRatioMap)}if(cL.mappingType>-1){if(cH.mappingNormTransformation){this.loadMatrix3(cK,cH.mappingNormTransformation,cL.mappingNormTransformation?cL.mappingNormTransformation:new s.Matrix3())}if(cH.mappingUVTransformation){this.loadMatrix3(cK,cH.mappingUVTransformation,cL.mappingUVTransformation?cL.mappingUVTransformation:new s.Matrix3())}if(cH.mappingObjTransformation){this.loadMatrix4(cK,cH.mappingObjTransformation,cL.mappingObjTransformation?cL.mappingObjTransformation:new s.Matrix4())}}if(cL.map&&cL.map.hdr&&cL.map.image){if(cH.mapHDRSize){cK.uniform2f(cH.mapHDRSize,parseInt(cL.map.image.width),parseInt(cL.map.image.height))}}else{if(cH.mapHDRSize){cK.uniform2f(cH.mapHDRSize,2048,1024)}}if(cL.envMap&&cL.envMap.hdr&&cL.envMap.image){if(cH.envMapHDRSize){cK.uniform2f(cH.envMapHDRSize,parseInt(cL.envMap.image.width),parseInt(cL.envMap.image.height))}if(cH.useRefract){cK.uniform1i(cH.useRefract,cL.envMap&&cL.envMap.mapping instanceof s.CubeRefractionMapping)}}else{if(cH.envMapHDRSize){cK.uniform2f(cH.envMapHDRSize,2048,1024)}if(cH.useRefract){cK.uniform1i(cH.useRefract,0)}}};this.loadUniformsBump=function(cG,cF,cE){if(cF.bumpMap){if(cE.bumpScale){cG.uniform1f(cE.bumpScale,cF.bumpScale?cF.bumpScale:1)}if(cE.bumpMap){this.loadTexture(cG,cE.bumpMap,cF.bumpMap)}}};this.loadUniformsNormalMap=function(cG,cF,cE){if(cF.normalMap){if(cE.normalScale){if(cF.normalScale){cG.uniform2f(cE.normalScale,cF.normalScale.x,cF.normalScale.y)}else{cG.uniform2f(cE.normalScale,1,1)}}if(cE.normalMap){this.loadTexture(cG,cE.normalMap,cF.normalMap)}}};this.loadUniformsLines=function(cJ,cG,cE,cI){if(cE.diffuse){var cF=cG.color;if(cI&&!cI.disableColorOverride&&cI.getColor()){cF=new s.Color(cI.getColor())}if(this.gammaInput){if(cG.NRECompatibility){cF=new s.Color().copyGammaToLinearNRECompatible(cF)}else{cF=new s.Color().copyGammaToLinear(cF)}}cJ.uniform3f(cE.diffuse,cF.r,cF.g,cF.b)}if(cE.opacity){var cH=cG.opacity;if(cI&&cI.getOpacity()!==null){cH=cI.getOpacity()}if(this.useRenderPriorityOpacity){cH=this.computeRenderPriorityOpacity(cH,cI)}cJ.uniform1f(cE.opacity,cH)}if(cE.pixelSize){cJ.uniform2f(cE.pixelSize,cG.pixelSize.x,cG.pixelSize.y)}if(cG.isDashedLine){if(cE.scale){cJ.uniform1f(cE.scale,cG.scale?cG.scale:0.15)}if(cE.dashPattern){cJ.uniform1fv(cE.dashPattern,cG.dashPattern)}if(cE.totalSize){cJ.uniform1f(cE.totalSize,cG.dashPattern[cG.dashPattern.length-1])}if(cE.patternOffset){cJ.uniform1f(cE.patternOffset,cG.patternOffset)}}if(cG.isWideLine||cG.is2DLine){if(cE.halfWidth){cJ.uniform1f(cE.halfWidth,cG.lineWidth?cG.lineWidth/2:0.5)}}if(cG.is2DLine){if(cE.miterLimit){cJ.uniform1f(cE.miterLimit,cG.miterLimit?cG.miterLimit:4)}}};this.loadUniformsSkinning=function(cG,cF,cE){if(cF.skinning){if(cE.skinningMap){this.loadTexture(cG,cE.skinningMap,cF.skinningMap)}if(cE.skinningInstancingMaps){this.loadTextureArray(cG,cF.program,cE.skinningInstancingMaps,"skinningInstancingMaps",cF.skinningInstancingMaps)}}};this.loadUniformsParticle=function(cJ,cG,cE,cI){if(cE.psColor){var cF=cG.color;if(cI&&!cI.disableColorOverride&&cI.getColor()){cF=new s.Color(cI.getColor())}cJ.uniform3f(cE.psColor,cF.r,cF.g,cF.b)}if(cE.opacity){var cH=cG.opacity;if(cI&&cI.getOpacity()!==null){cH=cI.getOpacity()}if(this.useRenderPriorityOpacity){cH=this.computeRenderPriorityOpacity(cH,cI)}cJ.uniform1f(cE.opacity,cH)}if(cE.scale){cJ.uniform1f(cE.scale,this.domElement.height/2)}if(cE.size){cJ.uniform1f(cE.size,cG.size?cG.size:1)}if(cE.map){this.loadTexture(cJ,cE.map,cG.map)}};this.loadUniformsLights=function(cI,cH,cG,cF){if(cH.ambientLightColor&&cG.ambient.length>0){cI.uniform3fv(cH.ambientLightColor,cG.ambient)}if(cG.shFactors[0]!==null){if(cH.shFactorsR){this.loadMatrix4(cI,cH.shFactorsR,cG.shFactors[0]?cG.shFactors[0]:new s.Matrix4())}if(cH.shFactorsG){this.loadMatrix4(cI,cH.shFactorsG,cG.shFactors[1]?cG.shFactors[1]:new s.Matrix4())}if(cH.shFactorsB){this.loadMatrix4(cI,cH.shFactorsB,cG.shFactors[2]?cG.shFactors[2]:new s.Matrix4())}if(cH.shScale){cI.uniform1f(cH.shScale,cG.shScale?cG.shScale:0.333)}}if(cH.directionalLightColor&&cG.directional.colors.length>0){cI.uniform3fv(cH.directionalLightColor,cG.directional.colors)}if(cH.directionalLightDirection&&cG.directional.positions.length>0){cI.uniform3fv(cH.directionalLightDirection,cG.directional.positions)}if(cH.directionalLightNear&&cG.directional.nears.length>0){cI.uniform1fv(cH.directionalLightNear,cG.directional.nears)}if(cH.directionalLightFar&&cG.directional.fars.length>0){cI.uniform1fv(cH.directionalLightFar,cG.directional.fars)}if(cH.pointLightColor&&cG.point.colors.length>0){cI.uniform3fv(cH.pointLightColor,cG.point.colors)}if(cH.pointLightPosition&&cG.point.positions.length>0){cI.uniform3fv(cH.pointLightPosition,cG.point.positions)}if(cH.pointLightPhysicalAttenuation&&cG.point.physicalAttenuations.length>0){cI.uniform1iv(cH.pointLightPhysicalAttenuation,cG.point.physicalAttenuations)}if(cH.pointLightDistance&&cG.point.distances.length>0){cI.uniform1fv(cH.pointLightDistance,cG.point.distances)}if(cH.spotLightColor&&cG.spot.colors.length>0){cI.uniform3fv(cH.spotLightColor,cG.spot.colors)}if(cH.spotLightPosition&&cG.spot.positions.length>0){cI.uniform3fv(cH.spotLightPosition,cG.spot.positions)}if(cH.spotLightDirection&&cG.spot.directions.length>0){cI.uniform3fv(cH.spotLightDirection,cG.spot.directions)}if(cH.spotLightPhysicalAttenuation&&cG.spot.physicalAttenuations.length>0){cI.uniform1iv(cH.spotLightPhysicalAttenuation,cG.spot.physicalAttenuations)}if(cH.spotLightDistance&&cG.spot.distances.length>0){cI.uniform1fv(cH.spotLightDistance,cG.spot.distances)}if(cH.spotLightAngleCos&&cG.spot.anglesCos.length>0){cI.uniform1fv(cH.spotLightAngleCos,cG.spot.anglesCos)}if(cH.spotLightInnerAngleCos&&cG.spot.innerAnglesCos.length>0){cI.uniform1fv(cH.spotLightInnerAngleCos,cG.spot.innerAnglesCos)}if(cH.iesLightColor&&cG.ies.colors.length>0){cI.uniform3fv(cH.iesLightColor,cG.ies.colors)}if(cH.iesLightPosition&&cG.ies.positions.length>0){cI.uniform3fv(cH.iesLightPosition,cG.ies.positions)}if(cH.iesLightDistance&&cG.ies.distances.length>0){cI.uniform1fv(cH.iesLightDistance,cG.ies.distances)}if(cH.iesLightTexture&&cG.ies.iesLightTexture.length>0){this.loadTextureArray(cI,cF,cH.iesLightTexture,"iesLightTexture",cG.ies.iesLightTexture)}if(cH.matrixWorldInv){this.loadMatrix4Array(cI,cF,cH.matrixWorldInv,"matrixWorldInv",cG.ies.matrixWorldInv)}if(cH.hemisphereLightSkyColor&&cG.hemi.skyColors.length>0){cI.uniform3fv(cH.hemisphereLightSkyColor,cG.hemi.skyColors)}if(cH.hemisphereLightGroundColor&&cG.hemi.groundColors.length>0){cI.uniform3fv(cH.hemisphereLightGroundColor,cG.hemi.groundColors)}if(cH.hemisphereLightDirection&&cG.hemi.positions.length>0){cI.uniform3fv(cH.hemisphereLightDirection,cG.hemi.positions)}if(cH.sphereLightColor&&cG.sphere.colors.length>0){cI.uniform3fv(cH.sphereLightColor,cG.sphere.colors)}if(cH.sphereLightPosition&&cG.sphere.positions.length>0){cI.uniform3fv(cH.sphereLightPosition,cG.sphere.positions)}if(cH.sphereLightData&&cG.sphere.data.length>0){cI.uniform3fv(cH.sphereLightData,cG.sphere.data)}if(cH.diskLightColor&&cG.disk.colors.length>0){cI.uniform3fv(cH.diskLightColor,cG.disk.colors)}if(cH.diskLightNormal&&cG.disk.normals.length>0){cI.uniform3fv(cH.diskLightNormal,cG.disk.normals)}if(cH.diskLightPosition&&cG.disk.positions.length>0){cI.uniform3fv(cH.diskLightPosition,cG.disk.positions)}if(cH.diskLightData&&cG.disk.data.length>0){cI.uniform3fv(cH.diskLightData,cG.disk.data)}if(cH.tubeLightColor&&cG.tube.colors.length>0){cI.uniform3fv(cH.tubeLightColor,cG.tube.colors)}if(cH.tubeLightRight&&cG.tube.rights.length>0){cI.uniform3fv(cH.tubeLightRight,cG.tube.rights)}if(cH.tubeLightPosition&&cG.tube.positions.length>0){cI.uniform3fv(cH.tubeLightPosition,cG.tube.positions)}if(cH.tubeLightData&&cG.tube.data.length>0){cI.uniform3fv(cH.tubeLightData,cG.tube.data)}if(cH.areaLightColor&&cG.area.colors.length>0){cI.uniform3fv(cH.areaLightColor,cG.area.colors)}if(cH.areaLightPosition&&cG.area.positions.length>0){cI.uniform3fv(cH.areaLightPosition,cG.area.positions)}if(cH.areaLightNormal&&cG.area.normals.length>0){cI.uniform3fv(cH.areaLightNormal,cG.area.normals)}if(cH.areaLightRight&&cG.area.rights.length>0){cI.uniform3fv(cH.areaLightRight,cG.area.rights)}if(cH.areaLightUp&&cG.area.ups.length>0){cI.uniform3fv(cH.areaLightUp,cG.area.ups)}if(cH.areaLightData&&cG.area.data.length>0){cI.uniform3fv(cH.areaLightData,cG.area.data)}var cE=cG.area.colors.length>0||cG.tube.colors.length>0||cG.disk.colors.length>0||cG.sphere.colors.length>0;if(cE){if(cH.precomputedAreaGGX1texture){if(this.precomputedAreaGGX1texture&&this.precomputedAreaGGX1texture.onRequest){this.precomputedAreaGGX1texture.onRequest();this.precomputedAreaGGX1texture.onRequest=null}this.loadTexture(cI,cH.precomputedAreaGGX1texture,this.precomputedAreaGGX1texture)}if(cH.precomputedAreaGGX2texture){if(this.precomputedAreaGGX2texture&&this.precomputedAreaGGX2texture.onRequest){this.precomputedAreaGGX2texture.onRequest();this.precomputedAreaGGX2texture.onRequest=null}this.loadTexture(cI,cH.precomputedAreaGGX2texture,this.precomputedAreaGGX2texture)}if(cH.precomputedAreaSheentexture){if(this.precomputedAreaSheentexture&&this.precomputedAreaSheentexture.onRequest){this.precomputedAreaSheentexture.onRequest();this.precomputedAreaSheentexture.onRequest=null}this.loadTexture(cI,cH.precomputedAreaSheentexture,this.precomputedAreaSheentexture)}}};this.loadUniformsFog=function(cG,cE,cF){if(cE.fogColor){cG.uniform3f(cE.fogColor,cF.color.r,cF.color.g,cF.color.b)}if(cF instanceof s.Fog){if(cE.fogNear){cG.uniform1f(cE.fogNear,cF.near?cF.near:1)}if(cE.fogFar){cG.uniform1f(cE.fogFar,cF.far?cF.far:2000)}}else{if(cF instanceof s.FogExp2){if(cE.fogDensity){cG.uniform1f(cE.fogDensity,cF.density?cF.density:0.00025)}}}};this.loadUniformsShadow=function(cV,cL,cX){var cR=cL.uniformLocations;if(cR.shadowMatrix){var cU=0;var cG=[];var cE=[];var cP=[];var cF=[];if(this.shadowMapType===s.PCFPoissonShadowMap){this.loadVector2Array(cV,cL,cR.poissonDisk,"poissonDisk",h)}for(var cW=0,cN=cX.length;cW<cN;cW++){var cI=cX[cW];if(cI instanceof s.SpotLight||(cI instanceof s.DirectionalLight&&!cI.shadowCascade&&(!cI.isVirtual||this.shadowMapCascade))){if(!cI.castShadow){continue}cG[cU]=cI.shadowMap;cE[cU]=cI.shadowMapSize;cP[cU]=cI.shadowDarkness;cF[cU]=cI.shadowBias;cU++}}if(cR.shadowMap){this.loadTextureArray(cV,cL,cR.shadowMap,"",cG)}if(cR.shadowMapSize){this.loadVector2Array(cV,cL,cR.shadowMapSize,"shadowMapSize",cE)}if(cR.shadowDarkness){cV.uniform1fv(cR.shadowDarkness,cP)}if(cR.shadowBias){cV.uniform1fv(cR.shadowBias,cF)}}if(cR.shadowMapCube){var cS=0;var cH=[];var cM=[];var cJ=[];var cO=[];var cQ=[];var cK=[];var cT=[];for(var cW=0,cN=cX.length;cW<cN;cW++){var cI=cX[cW];if(cI instanceof s.PointLight){if(!cI.castShadow){continue}cH[cS]=cI.shadowMap;cM[cS]=cI.shadowDarkness;cJ[cS]=cI.shadowBias;cQ[cS]=cI.shadowCameraNear;cK[cS]=cI.shadowCameraFar;cT[cS]=cI.shadowMapWidth;cI.setupShadowPositions(cO);cS++}}this.loadTextureCubeArray(cV,cL,cR.shadowMapCube,"shadowMapCube",cH);if(cR.shadowDarknessCube){cV.uniform1fv(cR.shadowDarknessCube,cM)}if(cR.shadowFarCube){cV.uniform1fv(cR.shadowFarCube,cK)}if(cR.shadowNearCube){cV.uniform1fv(cR.shadowNearCube,cQ)}if(cR.shadowBiasCube){cV.uniform1fv(cR.shadowBiasCube,cJ)}if(cR.shadowPointPosition){cV.uniform3fv(cR.shadowPointPosition,cO)}if(cR.shadowMapSizeCube){cV.uniform1fv(cR.shadowMapSizeCube,cT)}}};this.loadUniformsShadowMatrices=function(cM,cL,cI,cG){var cE=cL.objectUniformLocations;if(cE.shadowMatrix){var cJ=0;var cF=[];for(var cK=0,cN=cI.length;cK<cN;cK++){var cH=cI[cK];if(!cH.castShadow){continue}if(cH instanceof s.SpotLight||(cH instanceof s.DirectionalLight&&!cH.shadowCascade&&(!cH.isVirtual||this.shadowMapCascade))){cF[cJ]=cG.currentShadowMatrices[cJ];cJ++}}if(cE.shadowMatrix){this.loadMatrix4Array(cM,cL,cE.shadowMatrix,"shadowMatrix",cF)}}};this.loadClippingUniforms=function(cG,cE){var cF=this._clipPlanesState.uniforms;if(cE.nbClipPlanes){cG.uniform1i(cE.nbClipPlanes,cF.nbClipPlanes.value)}if(cF.nbClipPlanes.value!==0){if(cE.clipPlaneEquations&&cF.clipPlaneEquations.value.length>0){cG.uniform4fv(cE.clipPlaneEquations,cF.clipPlaneEquations.value)}if(cE.clipPlaneActive&&cF.clipPlaneActive.value.length>0){cG.uniform1iv(cE.clipPlaneActive,cF.clipPlaneActive.value)}if(cE.clipFrontOpacity){cG.uniform1f(cE.clipFrontOpacity,cF.clipFrontOpacity.value)}if(cE.clipBackOpacity){cG.uniform1f(cE.clipBackOpacity,cF.clipBackOpacity.value)}}if(cE.polygonSize){cG.uniform1i(cE.polygonSize,cF.polygonSize.value)}if(cF.polygonSize.value!==0){if(cE.polygonPoints){this.loadTexture(cG,cE.polygonPoints,cF.polygonPoints.value)}if(cE.extrusionPlaneU){cG.uniform3f(cE.extrusionPlaneU,cF.extrusionPlaneU.value.x,cF.extrusionPlaneU.value.y,cF.extrusionPlaneU.value.z)}if(cE.extrusionPlaneV){cG.uniform3f(cE.extrusionPlaneV,cF.extrusionPlaneV.value.x,cF.extrusionPlaneV.value.y,cF.extrusionPlaneV.value.z)}}};function ax(cM,cR){var cL,cS,cI,cJ,cO,cK;for(var cH=0,cK=cR.length;cH<cK;cH++){var cF=cR[cH][0];var cG=cR[cH][1];var cQ=cM[cF];var cE=cR[cH][2];if(cE&&!cE.value){continue}var cN=cG.type;var cP=cG.value;switch(cN){case"b":case"i":w.uniform1i(cQ,cP);break;case"f":w.uniform1f(cQ,cP);break;case"v2":w.uniform2f(cQ,cP.x,cP.y);break;case"v3":w.uniform3f(cQ,cP.x,cP.y,cP.z);break;case"v4":w.uniform4f(cQ,cP.x,cP.y,cP.z,cP.w);break;case"c":w.uniform3f(cQ,cP.r,cP.g,cP.b);break;case"iv1":if(cP.length>0){w.uniform1iv(cQ,cP)}break;case"iv":if(cP.length>0){w.uniform3iv(cQ,cP)}break;case"fv1":if(cP.length>0){w.uniform1fv(cQ,cP)}break;case"fv2":if(cP.length>0){w.uniform2fv(cQ,cP)}break;case"fv":if(cP.length>0){w.uniform3fv(cQ,cP)}break;case"fv4":if(cP.length>0){w.uniform4fv(cQ,cP)}break;case"v2v":if(cG._array===undefined){cG._array=new Float32Array(2*cP.length)}for(cJ=0,cO=cP.length;cJ<cO;cJ++){cI=cJ*2;cG._array[cI]=cP[cJ].x;cG._array[cI+1]=cP[cJ].y}w.uniform2fv(cQ,cG._array);break;case"v3v":if(cG._array===undefined){cG._array=new Float32Array(3*cP.length)}for(cJ=0,cO=cP.length;cJ<cO;cJ++){cI=cJ*3;cG._array[cI]=cP[cJ].x;cG._array[cI+1]=cP[cJ].y;cG._array[cI+2]=cP[cJ].z}w.uniform3fv(cQ,cG._array);break;case"v4v":if(cG._array===undefined){cG._array=new Float32Array(4*cP.length)}for(cJ=0,cO=cP.length;cJ<cO;cJ++){cI=cJ*4;cG._array[cI]=cP[cJ].x;cG._array[cI+1]=cP[cJ].y;cG._array[cI+2]=cP[cJ].z;cG._array[cI+3]=cP[cJ].w}w.uniform4fv(cQ,cG._array);break;case"m3":if(cP){w.uniformMatrix3fv(cQ,false,cP.elements)}break;case"m4":if(cP){w.uniformMatrix4fv(cQ,false,cP.elements)}break;case"m4v":if(cG._array===undefined){cG._array=new Float32Array(16*cP.length)}for(cJ=0,cO=cP.length;cJ<cO;cJ++){if(cP[cJ]){cP[cJ].flattenToArrayOffset(cG._array,cJ*16)}}w.uniformMatrix4fv(cQ,false,cG._array);break;case"t":case"t2":case"tc":cL=cP;cS=a3();w.uniform1i(cQ,cS);if(!cL){cL=bm._dummyTexture}if(cL.image instanceof Array&&cL.image.length===6){b0(cL,cS)}else{if(cL instanceof s.WebGLRenderTargetCube){bM(cL,cS)}else{bm.setTexture(cL,cS)}}break;case"tv":case"t2v":case"tcv":if(cG._array===undefined){cG._array=[]}for(cJ=0,cO=cG.value.length;cJ<cO;cJ++){cG._array[cJ]=a3()}w.uniform1iv(cQ,cG._array);for(cJ=0,cO=cG.value.length;cJ<cO;cJ++){cL=cG.value[cJ];cS=cG._array[cJ];if(!cL){cL=bm._dummyTexture}bm.setTexture(cL,cS)}break}}}function bG(cH,cG,cE,cF){cH[cG]=cE.r*cE.r*cF;cH[cG+1]=cE.g*cE.g*cF;cH[cG+2]=cE.b*cE.b*cF}function bH(cH,cG,cF,cE){cH[cG]=cF.r*cE;cH[cG+1]=cF.g*cE;cH[cG+2]=cF.b*cE}function y(cG,cH){var cI=b5;var cJ={ambient:{r:0,g:0,b:0},directional:{dirCount:0,dirLength:0,dirColors:b5.directional.colors,dirPositions:b5.directional.positions,dirNears:b5.directional.nears,dirFars:b5.directional.fars},point:{pointCount:0,pointLength:0,pointColors:b5.point.colors,pointPositions:b5.point.positions,pointPhysicalAttenuations:b5.point.physicalAttenuations,pointDistances:b5.point.distances},spot:{spotCount:0,spotLength:0,spotColors:b5.spot.colors,spotPositions:b5.spot.positions,spotPhysicalAttenuations:b5.spot.physicalAttenuations,spotDistances:b5.spot.distances,spotDirections:b5.spot.directions,spotAnglesCos:b5.spot.anglesCos,spotInnerAnglesCos:b5.spot.innerAnglesCos,},ies:{iesCount:0,iesLength:0,iesColors:b5.ies.colors,iesPositions:b5.ies.positions,iesDistances:b5.ies.distances,iesLightTexture:b5.ies.iesLightTexture,matrixWorldInv:b5.ies.matrixWorldInv},hemi:{hemiCount:0,hemiLength:0,hemiSkyColors:b5.hemi.skyColors,hemiGroundColors:b5.hemi.groundColors,hemiPositions:b5.hemi.positions},probe:{shFactorsR:null,shFactorsG:null,shFactorsB:null,shScale:0},area:{areaCount:0,areaLength:0,areaColors:b5.area.colors,areaPositions:b5.area.positions,areaNormals:b5.area.normals,areaRights:b5.area.rights,areaUps:b5.area.ups,areaData:b5.area.data},sphere:{sphereCount:0,sphereLength:0,sphereColors:b5.sphere.colors,spherePositions:b5.sphere.positions,sphereData:b5.sphere.data},disk:{diskCount:0,diskLength:0,diskColors:b5.disk.colors,diskNormals:b5.disk.normals,diskPositions:b5.disk.positions,diskData:b5.disk.data},tube:{tubeCount:0,tubeLength:0,tubeColors:b5.tube.colors,tubeRights:b5.tube.rights,tubePositions:b5.tube.positions,tubeData:b5.tube.data},camera:cH};for(cE=0,cK=cG.length;cE<cK;cE++){var cF=cG[cE];if(cF.onlyShadow){continue}cF.setup(cJ,bG,bH,bm)}var cE,cK;for(cE=cJ.directional.dirLength*3,cK=Math.max(cJ.directional.dirColors.length,cJ.directional.dirCount*3);cE<cK;cE++){cJ.directional.dirColors[cE]=0}b5.directional.length=cJ.directional.dirLength;for(cE=cJ.point.pointLength*3,cK=Math.max(cJ.point.pointColors.length,cJ.point.pointCount*3);cE<cK;cE++){cJ.point.pointColors[cE]=0}b5.point.length=cJ.point.pointLength;for(cE=cJ.spot.spotLength*3,cK=Math.max(cJ.spot.spotColors.length,cJ.spot.spotCount*3);cE<cK;cE++){cJ.spot.spotColors[cE]=0}b5.spot.length=cJ.spot.spotLength;for(cE=cJ.hemi.hemiLength*3,cK=Math.max(cJ.hemi.hemiSkyColors.length,cJ.hemi.hemiCount*3);cE<cK;cE++){cJ.hemi.hemiSkyColors[cE]=0}for(cE=cJ.hemi.hemiLength*3,cK=Math.max(cJ.hemi.hemiGroundColors.length,cJ.hemi.hemiCount*3);cE<cK;cE++){cJ.hemi.hemiGroundColors[cE]=0}b5.hemi.length=cJ.hemi.hemiLength;for(cE=cJ.ies.iesLength*3,cK=Math.max(cJ.ies.iesColors.length,cJ.ies.iesCount*3);cE<cK;cE++){cJ.ies.iesColors[cE]=0}b5.ies.length=cJ.ies.iesLength;b5.ambient[0]=cJ.ambient.r;b5.ambient[1]=cJ.ambient.g;b5.ambient[2]=cJ.ambient.b;b5.shFactors[0]=cJ.probe.shFactorsR;b5.shFactors[1]=cJ.probe.shFactorsG;b5.shFactors[2]=cJ.probe.shFactorsB;b5.shScale=cJ.probe.shScale}function M(cJ,cI,cM){var cH,cF,cL,cN=0,cG=0;for(cH=0,cF=cI.length;cH<cF;cH++){cL=cI[cH];cG=4*cN;var cE=new s.Matrix4().copy(cM.matrixWorld);cE.transpose();var cK=new s.Plane().copy(cL);cK.applyMatrix4(cM.matrixWorldInverse);S.eqs[cG]=cK.normal.x;S.eqs[cG+1]=cK.normal.y;S.eqs[cG+2]=cK.normal.z;S.eqs[cG+3]=cK.constant;S.states[cH]=cL.enabled?1:0;cN++}S.length=cN}this.setDisableColorWrite=function(cE){this.disableColorWrite=cE},this.setDisableDepthWrite=function(cE){this.disableDepthWrite=cE},this.setDisableDepthTest=function(cE){this.disableDepthTest=cE},this.setEnableStencilWrite=function(cE){this.enableStencilWrite=cE},this.setDisableBackFaceCulling=function(cE){this.disableBackFaceCulling=cE},this.setFaceCulling=function(cF,cE){b3=0;E=undefined;bZ=undefined;if(cF===s.CullFaceNone){w.disable(w.CULL_FACE);bZ=true}else{if(cE===s.FrontFaceDirectionCW){w.frontFace(w.CW)}else{w.frontFace(w.CCW)}if(cF===s.CullFaceBack){w.cullFace(w.BACK)}else{if(cF===s.CullFaceFront){w.cullFace(w.FRONT)}else{w.cullFace(w.FRONT_AND_BACK)}}w.enable(w.CULL_FACE);bZ=false}};this.setMaterialFaces=function(cL,cI,cK,cG){var cH=cG&&(cI._bodyDim===3);var cJ=(cL.side===a.BackSide);var cE=(!cH&&!cJ&&(cL.side!==a.FrontSide))||this.disableBackFaceCulling;var cF=(cI!==undefined)?cI.orientation:1;if(cK!==undefined){cF*=cK.orientation}if(bZ!==cE){if(cE){w.disable(w.CULL_FACE)}else{w.enable(w.CULL_FACE)}bZ=cE}if((E!==cJ)||(b3!==cF)){if(cJ){if(cF>=0){w.frontFace(w.CW)}else{w.frontFace(w.CCW)}}else{if(cF>=0){w.frontFace(w.CCW)}else{w.frontFace(w.CW)}}b3=cF;E=cJ}};this.setMaterialFacesDebug=function(cJ,cG,cI){var cE=cJ.side===a.DoubleSide;var cH=cJ.side===a.BackSide;var cF=(cG!==undefined)?cG.orientation:1;if(cI!==undefined){cF*=cI.orientation}if(cG instanceof s.Mesh){cF=-cF}if(bZ!==cE){if(cE){w.disable(w.CULL_FACE)}else{w.enable(w.CULL_FACE)}bZ=cE}if((E!==cH)||(b3!==cF)){if(cH){if(cF>=0){w.frontFace(w.CW)}else{w.frontFace(w.CCW)}}else{if(cF>=0){w.frontFace(w.CCW)}else{w.frontFace(w.CW)}}b3=cF;E=cH}};this.setDepthTest=function(cE){if(u!==cE){if(cE){w.enable(w.DEPTH_TEST)}else{w.disable(w.DEPTH_TEST)}u=cE}};this.setDepthWrite=function(cE){if(cf!==cE){w.depthMask(cE);cf=cE}};this.setStencilWrite=function(cE){if(cE!==cv){if(cE){w.stencilMask(255)}else{w.stencilMask(0)}cv=cE}};function bf(cE){if(cE!=undefined&&cE!==b1){w.lineWidth(cE);b1=cE}}function cz(cG,cF,cE){if(bg!==cG){if(cG){w.enable(w.POLYGON_OFFSET_FILL)}else{w.disable(w.POLYGON_OFFSET_FILL)}bg=cG}if(cG&&(cr!==cF||bN!==cE)){w.polygonOffset(cF,cE);cr=cF;bN=cE}}this.setBlending=function(cF,cE,cG,cH){if(cF!==w._oldBlending){if(cF===s.NoBlending){w.disable(w.BLEND)}else{if(cF===s.AdditiveBlending){w.enable(w.BLEND);w.blendEquation(w.FUNC_ADD);w.blendFunc(w.SRC_ALPHA,w.ONE)}else{if(cF===s.SubtractiveBlending){w.enable(w.BLEND);w.blendEquation(w.FUNC_ADD);w.blendFunc(w.ZERO,w.ONE_MINUS_SRC_COLOR)}else{if(cF===s.MultiplyBlending){w.enable(w.BLEND);w.blendEquation(w.FUNC_ADD);w.blendFunc(w.ZERO,w.SRC_COLOR)}else{if(cF===s.CustomBlending){w.enable(w.BLEND)}else{if(cF===s.NormalDepthBlending){w.enable(w.BLEND);w.blendEquationSeparate(w.FUNC_ADD,w.FUNC_ADD);w.blendFuncSeparate(w.ZERO,w.ONE,w.ONE,w.ZERO)}else{if(cF===s.AlphaBlending){w.enable(w.BLEND);w.blendEquation(w.FUNC_ADD);w.blendFunc(w.SRC_ALPHA,w.ONE_MINUS_SRC_ALPHA)}else{w.enable(w.BLEND);w.blendEquationSeparate(w.FUNC_ADD,w.FUNC_ADD);w.blendFuncSeparate(w.SRC_ALPHA,w.ONE_MINUS_SRC_ALPHA,w.ONE,w.ONE_MINUS_SRC_ALPHA)}}}}}}}w._oldBlending=cF}if(cF===s.CustomBlending){if(cE!==aS){w.blendEquation(br(cE));aS=cE}if(cG!==cs||cH!==a1){w.blendFunc(br(cG),br(cH));cs=cG;a1=cH}}else{aS=null;cs=null;a1=null}};function at(cF){var cG,cE,cI=[];for(var cH in cF){cG=cF[cH];if(cG===false){continue}cE="#define "+cH+" "+cG;cI.push(cE)}return cI.join("\n")}function B(cR,cE,cL,da,cU,c6,cS){var c3,c8,c9,cT,cF;var cY=[];if(cR>=0){cY.push(s.ShaderIDsToName[cR])}else{cY.push(cE);cY.push(cL)}for(c9 in c6){cY.push(c9);cY.push(c6[c9])}for(c3 in cS){cY.push(c3);cY.push(cS[c3])}cF=cY.join();var cG="SHADOWMAP_TYPE_BASIC";if(cS.shadowMapType===s.PCFShadowMap){cG="SHADOWMAP_TYPE_PCF"}else{if(cS.shadowMapType===s.PCFSoftShadowMap){cG="SHADOWMAP_TYPE_PCF_SOFT"}else{if(cS.shadowMapType===s.PCFInterpolShadowMap){cG="SHADOWMAP_TYPE_PCF_INTERPOL"}else{if(cS.shadowMapType===s.PCFPoissonShadowMap){cG="SHADOWMAP_TYPE_PCF_POISSON"}else{if(cS.shadowMapType===s.PCFOptimizedShadowMap){cG="SHADOWMAP_TYPE_PCF_OPTI"}else{if(cS.shadowMapType===s.ESMShadowMap){cG="SHADOWMAP_TYPE_ESM"}else{if(cS.shadowMapType===s.ESMImprovedShadowMap){cG="SHADOWMAP_TYPE_ESM_IMPROVED"}}}}}}}var c2="SHADOWMAP_QUALITY_LOW";if(cS.shadowMapQuality===s.MediumQuality){c2="SHADOWMAP_QUALITY_MEDIUM"}else{if(cS.shadowMapQuality===s.HighQuality){c2="SHADOWMAP_QUALITY_HIGH"}}var cK=at(c6);var cZ=cS.map||cS.bumpMap||cS.normalMap||cS.specularMap||cS.specularContribMap||cS.emissionColorMap||cS.transparencyMap||cS.opacityMap||cS.metalnessMap||cS.roughnessMap||cS.glossinessMap||cS.anisotropyMap||cS.anisotropyAngleMap||cS.clearCoatNormalMap||cS.clearCoatRoughnessMap||cS.coatingGlossinessMap||cS.sheenMap||cS.clearCoatMap;var cJ=["precision "+D+" float;",cK,cR===s.ShaderIDs.particle_basic?"#define PARTICLE":"",bt?"#define VERTEX_TEXTURES":"",J?"#define RENDER_TO_FLOAT_TEXTURE":"",bm.gammaInput?"#define GAMMA_INPUT":"",bm.gammaOutput?"#define GAMMA_OUTPUT":"","#define MAX_DIR_LIGHTS "+cS.maxDirLights,"#define MAX_POINT_LIGHTS "+cS.maxPointLights,"#define MAX_SPOT_LIGHTS "+cS.maxSpotLights,"#define MAX_HEMI_LIGHTS "+cS.maxHemiLights,cS.probeLight?"#define USE_SH_ENVMAP":"","#define MAX_SPHERE_LIGHTS "+cS.maxSphereLights,"#define MAX_TUBE_LIGHTS "+cS.maxTubeLights,"#define MAX_DISK_LIGHTS "+cS.maxDiskLights,"#define MAX_AREA_LIGHTS "+cS.maxAreaLights,"#define MAX_IES_LIGHTS "+cS.maxIESLights,cS.lightMap?"#define USE_LIGHTMAP":"","#define MAX_SHADOWS "+cS.maxShadows,"#define MAX_SHADOWS_DIR "+cS.maxDirShadows,"#define MAX_SHADOWS_SPOT "+cS.maxSpotShadows,"#define MAX_SHADOWS_CUBE "+cS.maxShadowsCube,cS.shadowMapEnabled?"#define USE_SHADOWMAP":"",(cS.shadowMapEnabled||cS.shadowMapCubeEnabled)?"#define "+cG:"",(cS.shadowMapEnabled||cS.shadowMapCubeEnabled)?"#define "+c2:"",cS.shadowMapCubeEnabled?"#define USE_SHADOWMAP_CUBE":"",cS.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",cS.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",cS.morphTargets?"#define USE_MORPHTARGETS":"",cS.morphNormals?"#define USE_MORPHNORMALS":"",cS.fixedSize?"#define FIXED_SIZE":"",cS.fixedSizeCenter?"#define FIXED_SIZE_CENTER":"",cS.skinning?"#define USE_SKINNING":"",cS.useEulerAngles?"#define USE_SKINNING_ANGLES":"",cS.skinningMapWidth&&!cS.isMultiInstanced?"#define N_BONE_PIXEL_X "+cS.skinningMapWidth.toFixed(1):"",cS.skinningMapHeight&&!cS.isMultiInstanced?"#define N_BONE_PIXEL_Y "+cS.skinningMapHeight.toFixed(1):"",cS.skinningInstancingMapsInfo&&cS.isMultiInstanced?"#define NB_INSTANCING_SKIN_MAPS "+cS.skinningInstancingMapsInfo.nbTextures+"\n#define NB_BONES "+cS.skinningInstancingMapsInfo.nbBones.toFixed(1)+"\n#define MAX_MAP_SIZE "+cS.skinningInstancingMapsInfo.maxTextureSize.toFixed(1)+"\n#define LAST_INSTANCING_SKIN_MAP_SIZE_X "+cS.skinningInstancingMapsInfo.lastTextureSizeX.toFixed(1)+"\n#define LAST_INSTANCING_SKIN_MAP_SIZE_Y "+cS.skinningInstancingMapsInfo.lastTextureSizeY.toFixed(1)+"\n":"","#define MAX_BONES "+cS.maxBones,cZ?"#define NEEDS_UVTOUSE":"",(cS.useUV&&cS.useUV1)?"#define USE_UV_SLOT_1":"",(cS.useUV&&cS.useUV2)?"#define USE_UV_SLOT_2":"",(cS.mappingUseFragment==false)?"#define USE_MAPPING_OPERATOR_VERTEX":"",(cS.mappingType>-1)?"#define MAPPING_OPERATOR "+cS.mappingType:"",cS.needTangent?"#define USE_TANGENT":"",cS.needTangentBinormal?"#define USE_TANGENT_BINORMAL":"","#define MAX_CLIP_PLANES "+cS.maxClipPlanes,cS.clipPlanesEnabled?"#define USE_CLIPPINGPLANES":"","#define MAX_POLYGON_SIZE "+k.maxPolyLineSize,k.maxPolyLineSize>0?"#define USE_CLIPPINGPOLYGON":"",cS.perPixel?"#define PHONG_PER_PIXEL":"",cS.wrapAround?"#define WRAP_AROUND":"",cS.doubleSided||true?"#define DOUBLE_SIDED":"",cS.flipSided?"#define FLIP_SIDED":"",cS.sizeAttenuation?"#define USE_SIZEATTENUATION":"",cS.vertexColors?"#define USE_COLOR":"",cS.isMultiInstanced?"#define IS_MULTI_INSTANCED":"",cS._definePickingInstancing?"#define PICKING_INSTANCING":"",cS.specgloss?"#define SPECGLOSS":"",cS.map?"#define USE_MAP":"",cS.envMap?"#define USE_ENVMAP":"",(cS.envMapping===1)?"#define USE_LIGHTPROBEMAP":"",(cS.envMapping===2)?"#define USE_LATLONGMAP":"",cS.reflectionProbes?"#define USE_REFLECTION_PROBE":"",cS.useFiniteEnvMap?"#define USE_FINITE_ENVMAP":"",cS.bumpMap?"#define USE_BUMPMAP":"",cS.normalMap?"#define USE_NORMALMAP":"",cS.refractionRatioMap?"#define USE_REFRACTIONRATIOMAP":"",cS.specularMap?"#define USE_SPECULARMAP":"",cS.roughnessMap?"#define USE_ROUGHNESSMAP":"",cS.glossinessMap?"#define USE_GLOSSINESSMAP":"",cS.anisotropy?"#define USE_ANISOTROPY":"",cS.anisotropyMap?"#define USE_ANISOTROPYMAP":"",cS.anisotropyAngleMap?"#define USE_ANISOTROPYANGLEMAP":"",cS.anisotropy?"#define USE_TANGENT_BINORMAL":"",cS.displacementMap?"#define USE_DISPLACEMENTMAP":"",cS.flakes?"#define USE_FLAKES":"",cS.orangePeel?"#define USE_ORANGE_PEEL":"",cS.subsurface?"#define USE_SUBSURFACE":"",cS.iterative?"#define USE_ITERATION":"",cS.sslr?"#define USE_SSLR":"",cS.dashedLine?"#define USE_DASHEDLINE":"",cS.cpuPattern?"#define CPU_PATTERN":"",cS.patternSize?"#define PATTERN_LENGTH "+cS.patternSize:"",cS.wideLine?"#define USE_WIDELINE":"",cS.wideLine&&cS.polygonBorderMode?"#define USE_POLYGON_BORDER_MODE":"",cS.wideLine&&cS.linejoin?"#define USE_"+cS.linejoin.toUpperCase()+"JOIN":"",cS.wideLine&&cS.linecap?"#define USE_"+cS.linecap.toUpperCase()+"CAP":"",cS.NRECompatibility?"#define NRE_COMPATIBILITY":"",cS.isAccumMat?"#define ACCUM_SHADER":"",cS.PDSFX?"#define PDSFX":"",cS.compressedVertices?"#define COMPRESSED_VERTICES":"",cS.compressedNormals?"#define COMPRESSED_NORMALS":"",cS.pdsfxUseMap?"#define PDSFX_USE_MAP":"","","#ifdef PICKING_INSTANCING","varying vec3 vInstancePickingColor;","#endif","","uniform mat4 modelViewMatrix;","uniform mat4 modelMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform bool use_normal_matrix;","uniform mat3 normalMatrix; //Only sent if object is non-uniformly scaled!","uniform vec3 cameraPosition;","#ifdef FIXED_SIZE","#ifdef FIXED_SIZE_CENTER","uniform vec4 fixedSizeCenterRatio;","#else","uniform float fixedSizeRatio;","#endif","uniform float cameraConstant;","vec2 getScale() {","vec3 xAxis = vec3(modelViewMatrix[0][0],modelViewMatrix[1][0],modelViewMatrix[2][0]);","vec3 yAxis = vec3(modelViewMatrix[0][1],modelViewMatrix[1][1],modelViewMatrix[2][1]);","vec3 zAxis = vec3(modelViewMatrix[0][2],modelViewMatrix[1][2],modelViewMatrix[2][2]);","float radius = max(length(xAxis),max(length(yAxis),length(zAxis)));","float screenRadius = 1.0;","if (projectionMatrix[3][3] > 0.5) {","screenRadius = radius;","} else {","float constant = abs(modelViewMatrix[3][2]);","screenRadius = radius / constant;","}","#ifdef FIXED_SIZE_CENTER","float scaleFactorCenter = 1.0 / screenRadius * cameraConstant;","if (projectionMatrix[3][3] > 0.5) {","screenRadius = radius;","} else {","vec4 aux = modelViewMatrix * vec4(scaleFactorCenter*fixedSizeCenterRatio.xyz, 1.0);","float constant2 = abs(aux.z);","screenRadius = radius / constant2;","}","float scaleFactor = fixedSizeCenterRatio.w / screenRadius * cameraConstant;","#else","float scaleFactor = fixedSizeRatio / screenRadius * cameraConstant;","float scaleFactorCenter = scaleFactor;","#endif","return vec2(scaleFactor, scaleFactorCenter);","}","#endif","#if defined(FIXED_SIZE)","struct SimpleNodeData {","float fixedSizeScale;","float fixedSizeScaleCenter;","};","SimpleNodeData simpleNodeData;","bool simpleSizeDataSet = false;","void setSimpleNodeData() {","if (simpleSizeDataSet) return;","#ifdef FIXED_SIZE","vec2 fixedSizeData = getScale();","simpleNodeData.fixedSizeScale = fixedSizeData.x;","simpleNodeData.fixedSizeScaleCenter = fixedSizeData.y;","#endif","simpleSizeDataSet = true;","}","#endif","vec3 auxPosMV;","vec3 auxPosMVP;","vec4 auxPosMVPFunc;","#ifdef PDSFX","attribute vec3 _DSposition;","attribute vec3 _DSnormal;","attribute vec2 _DSuv;","attribute vec2 _DSuv2;","attribute vec3 _DStangent;","attribute vec3 _DSbinormal;","vec3 position;","vec3 normal;","vec2 uv;","vec2 uv2;","vec3 tangent;","vec3 binormal;","#else","#ifdef COMPRESSED_VERTICES","vec3 position;","attribute vec2 _DSposition;","uniform vec3 offsetVector;","uniform vec3 quantizedVector;",s.ShaderChunk.decompress_vertices_pars,"#else","attribute vec3 position;","#endif","#ifdef COMPRESSED_NORMALS","vec3 normal;","attribute float _DSnormal;",s.ShaderChunk.decompress_normals_pars,"#else","attribute vec3 normal;","#endif","attribute vec2 uv;","attribute vec2 uv2;","attribute vec3 tangent;","attribute vec3 binormal;","#endif","#ifdef USE_COLOR","attribute vec4 color;","#endif","#ifdef IS_MULTI_INSTANCED","attribute float instanceId;","#endif","#ifdef USE_MORPHTARGETS","attribute vec3 morphTarget0;","attribute vec3 morphTarget1;","attribute vec3 morphTarget2;","attribute vec3 morphTarget3;","#ifdef USE_MORPHNORMALS","attribute vec3 morphNormal0;","attribute vec3 morphNormal1;","attribute vec3 morphNormal2;","attribute vec3 morphNormal3;","#else","attribute vec3 morphTarget4;","attribute vec3 morphTarget5;","attribute vec3 morphTarget6;","attribute vec3 morphTarget7;","#endif","#endif","#ifdef USE_SKINNING","attribute vec4 skinIndex;","attribute vec4 skinWeight;","#endif","#ifdef USE_DISPLACEMENTMAP","uniform sampler2D displacementMap;","uniform float displacementBias;","uniform float displacementScale;","#endif",""].join("\n");if(cS.PDSFX){var cI=["#ifdef PDSFX",cS.pdsfxAttributesCode,cS.pdsfxVaryingsCode,cS.pdsfxUniformsCode.common,cS.pdsfxUniformsCode.vertex,s.ShaderChunk.PDSFX_common_pars,s.ShaderChunk.PDSFX_varyings_pars,s.ShaderChunk.PDSFX_attribute_getters_vertex,cS.pdsfxGlobalVariablesCode_VS,"struct TangentSpace","{","	vec3 Position;","	vec3 Normal;","	vec3 Tangent;","	vec3 Binormal;","};",cS.PDSFX_OverridableFunctions_VS,"#endif",""].join("\n");cJ+=cI}var c4=(cS.bumpMap||cS.normalMap||cS.anisotropy||cS.flakes||cS.PDSFX||cS.dashedLine||cS.wideLine||cS.subsurface);var cP=[bO?"#extension GL_EXT_frag_depth : enable":"","#extension  GL_OES_standard_derivatives : enable",bO?"#define FRAG_DEPTH_EXT":"",J?"#define RENDER_TO_FLOAT_TEXTURE":"","#define DEPTH_PRECISION "+s.supportedExtensions.depthBits,"precision "+D+" float;",bm.gammaInput?"#define GAMMA_INPUT":"",bm.gammaOutput?"#define GAMMA_OUTPUT":"",cR===s.ShaderIDs.particle_basic?"#define PARTICLE":"",cS.alphaTest?"#define ALPHATEST "+cS.alphaTest:"",cK,"#define MAX_DIR_LIGHTS "+cS.maxDirLights,"#define MAX_POINT_LIGHTS "+cS.maxPointLights,"#define MAX_SPOT_LIGHTS "+cS.maxSpotLights,"#define MAX_IES_LIGHTS "+cS.maxIESLights,"#define MAX_HEMI_LIGHTS "+cS.maxHemiLights,"#define MAX_SPHERE_LIGHTS "+cS.maxSphereLights,"#define MAX_TUBE_LIGHTS "+cS.maxTubeLights,"#define MAX_DISK_LIGHTS "+cS.maxDiskLights,"#define MAX_AREA_LIGHTS "+cS.maxAreaLights,cS.probeLight?"#define USE_SH_ENVMAP":"",cS.useLighting?"#define USE_LIGHTING":"",cS.lightMap?"#define USE_LIGHTMAP":"",(cS.lightMapMode===1)?"#define LIGHTMAP_IRRADIANCE_MODE":"",cS.lightMapLinear?"#define USE_LIGHTMAP_LINEAR":"","#define MAX_SHADOWS "+cS.maxShadows,"#define MAX_SHADOWS_DIR "+cS.maxDirShadows,"#define MAX_SHADOWS_SPOT "+cS.maxSpotShadows,"#define MAX_SHADOWS_CUBE "+cS.maxShadowsCube,cS.shadowMapEnabled?"#define USE_SHADOWMAP":"",(cS.shadowMapEnabled||cS.shadowMapCubeEnabled)?"#define "+cG:"",(cS.shadowMapEnabled||cS.shadowMapCubeEnabled)?"#define "+c2:"",cS.shadowMapCubeEnabled?"#define USE_SHADOWMAP_CUBE":"",cS.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",cS.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",(cS.useFog&&cS.fog)?"#define USE_FOG":"",(cS.useFog&&cS.fogExp)?"#define FOG_EXP2":"",cZ?"#define NEEDS_UVTOUSE":"",(cS.useUV&&cS.useUV1)?"#define USE_UV_SLOT_1":"",(cS.useUV&&cS.useUV2)?"#define USE_UV_SLOT_2":"","#define DIFFUSEMAP_UV_SLOT "+((cS.diffuseMapUVSlot===2)?"2":"1"),"#define SPECULARMAP_UV_SLOT "+((cS.specularMapUVSlot===2)?"2":"1"),"#define ROUGHNESSMAP_UV_SLOT "+((cS.roughnessMapUVSlot===2)?"2":"1"),"#define NORMALMAP_UV_SLOT "+((cS.normalMapUVSlot===2)?"2":"1"),"#define LIGHTMAP_UV_SLOT "+((cS.lightMapUVSlot===2)?"2":"1"),(cS.mappingUseFragment==true)?"#define USE_MAPPING_OPERATOR_FRAGMENT":"",(cS.mappingType>-1)?"#define MAPPING_OPERATOR "+cS.mappingType:"",cS.textureBlending?"#define TEXTURE_BLENDING "+cS.textureBlending:"",cS.needTangent?"#define USE_TANGENT":"",cS.needTangentBinormal?"#define USE_TANGENT_BINORMAL":"",cS.map?"#define TEXTURE_FORMAT "+cS.textureFormat.format:"","#define MAX_CLIP_PLANES "+cS.maxClipPlanes,cS.clipPlanesEnabled?"#define USE_CLIPPINGPLANES":"","#define MAX_POLYGON_SIZE "+k.maxPolyLineSize,k.maxPolyLineSize>0?"#define USE_CLIPPINGPOLYGON":"",cS.refractionRatioMap?"#define USE_REFRACTIONRATIOMAP":"",cS.bumpMap?"#define USE_BUMPMAP":"",cS.normalMap?"#define USE_NORMALMAP":"",cS.normalMapFlipY?"#define NORMALFLIPY":"",cS.specgloss?"#define SPECGLOSS":"",cS.map?"#define USE_MAP":"",cS.mapHDR?"#define USE_MAP_HDR":"",(cS.diffuseMulCoef&&cS.diffuseAddCoef)?"#define USE_DIFFUSE_COEFFICIENTS":"",cS.useAlphaFromDiffuseMap?"#define USE_ALPHA_FROM_MAP":"",cS.specularMap?"#define USE_SPECULARMAP":"",(cS.specularMulCoef&&cS.specularAddCoef)?"#define USE_SPECULAR_COEFFICIENTS":"",cS.specularMapLinear?"#define USE_SPECULARMAP_LINEAR":"",cS.metalnessMap?"#define USE_METALNESSMAP":"",(cS.metalnessMulCoef||cS.metalnessAddCoef)?"#define USE_METALNESS_COEFFICIENTS":"",cS.metalnessMapLinear?"#define USE_METALNESSMAP_LINEAR":"",cS.specularContribMap?"#define USE_SPECULARCONTRIBMAP":"",(cS.specularContribMulCoef||cS.specularContribAddCoef)?"#define USE_SPECULARCONTRIB_COEFFICIENTS":"",cS.emissionColorMap?"#define USE_EMISSIONCOLORMAP":"",cS.emissionMapLinear?"#define USE_EMISSIONCOLORMAP_LINEAR":"",(cS.emissionColorMulCoef&&cS.emissionColorAddCoef)?"#define USE_EMISSIONCOLOR_COEFFICIENTS":"",cS.emissionNormalized?"#define USE_NORMALIZED_EMISSION":"",cS.transparencyMap?"#define USE_TRANSPARENCYMAP":"",(cS.transparencyMulCoef||cS.transparencyAddCoef)?"#define USE_TRANSPARENCY_COEFFICIENTS":"",cS.opacityMap?"#define USE_OPACITYMAP":"",(cS.opacityMulCoef||cS.opacityAddCoef)?"#define USE_OPACITY_COEFFICIENTS":"",cS.roughnessMap?"#define USE_ROUGHNESSMAP":"",cS.glossinessMap?"#define USE_GLOSSINESSMAP":"",(cS.roughnessMulCoef||cS.roughnessAddCoef)?"#define USE_ROUGHNESS_COEFFICIENTS":"",(cS.glossinessMulCoef||cS.glossinessAddCoef)?"#define USE_GLOSSINESS_COEFFICIENTS":"",cS.roughnessMapLinear?"#define USE_ROUGHNESSMAP_LINEAR":"",cS.anisotropy?"#define USE_ANISOTROPY":"",cS.anisotropyMap?"#define USE_ANISOTROPYMAP":"",(cS.anisotropyMulCoef||cS.anisotropyAddCoef)?"#define USE_ANISOTROPY_COEFFICIENTS":"",cS.anisotropyAngleMap?"#define USE_ANISOTROPYANGLEMAP":"",(cS.anisotropyAngleMulCoef||cS.anisotropyAngleAddCoef)?"#define USE_ANISOTROPYANGLE_COEFFICIENTS":"",cS.reflectionProbes?"#define USE_REFLECTION_PROBE":"",cS.sheen?"#define USE_SHEEN":"",cS.sheenMap?"#define USE_SHEEN_MAP":"",(cS.sheenMulCoef||cS.sheenAddCoef)?"#define USE_SHEEN_COEFFICIENTS":"",cS.sheenMode&&cS.sheen?"#define "+cS.sheenMode:"",cS.old_flakes?"#define OLD_FLAKES":"",cS.flakes?"#define USE_FLAKES":"",(cS.flakesMode<2)?"#define ADVANCED_FLAKES_BLENDING":"",(cS.flakesMode<2)?"#define ADVANCED_PRESENCE_NOISE":"",(cS.flakesMode<1)?"#define FLAKES_NORMAL_PERTURBATION":"",(cS.flakesMode<1)?"#define PEARL_FLAKES_ACTIVATED":"",cS.flakesCoverageMap?"#define USE_FLAKESCOVERAGE_MAP":"",(cS.flakesCoverageMulCoef||cS.flakesCoverageAddCoef)?"#define USE_FLAKESCOVERAGE_COEFFICIENTS":"",cS.flakesRoughnessMap?"#define USE_FLAKESROUGHNESS_MAP":"",(cS.flakesRoughnessMulCoef||cS.flakesRoughnessAddCoef)?"#define USE_FLAKESROUGHNESS_COEFFICIENTS":"",cS.flakesColorMap?"#define USE_FLAKESCOLOR_MAP":"",(cS.flakesColorMulCoef||cS.flakesColorAddCoef)?"#define USE_FLAKESCOLOR_COEFFICIENTS":"",cS.flakesSizeMap?"#define USE_FLAKESSIZE_MAP":"",(cS.flakesSizeMulCoef||cS.flakesSizeAddCoef)?"#define USE_FLAKESSIZE_COEFFICIENTS":"",cS.clearCoat?"#define CLEAR_COAT":"",cS.clearCoatMap?"#define CLEAR_COAT_MAP":"",(cS.clearCoatMulCoef||cS.clearCoatAddCoef)?"#define USE_CC_COEFFICIENTS":"",cS.clearCoatNormalMap?"#define CLEAR_COAT_NORMALMAP":"",cS.clearCoatNormalMapFlipY?"#define CLEAR_COAT_NORMALMAPFLIPY":"",cS.clearCoatRoughnessMap?"#define USE_CC_ROUGHNESSMAP":"",cS.coatingGlossinessMap?"#define USE_CC_GLOSSINESSMAP":"",cS.clearCoatRoughnessMapLinear?"#define USE_CC_ROUGHNESSMAPMAP_LINEAR":"",(cS.coatingGlossinessMulCoef||cS.coatingGlossinessAddCoef)?"#define USE_CC_GLOSSINESS_COEFFICIENTS":"",(cS.clearCoatRoughnessMulCoef||cS.clearCoatRoughnessAddCoef)?"#define USE_CC_ROUGHNESS_COEFFICIENTS":"",cS.orangePeel?"#define USE_ORANGE_PEEL":"",cS.subsurface?"#define USE_SUBSURFACE":"",cS.sssLUT?"#define USE_SSSLUT":"",cS.sssIBLLUT?"#define USE_SSSIBLLUT":"",cS.subsurface?"#define USE_TRANSLUCENCY":"",cS.translucencyLUT?"#define USE_TRANSLUCENCYLUT":"",cS.envMap?"#define USE_ENVMAP":"",cS.envMapSheen?"#define USE_ENVMAP_SHEEN":"",cS.envMapDiffuse?"#define USE_ENVMAP_DIFFUSE":"",cS.envMapHDR?"#define USE_ENVMAP_HDR":"",(cS.envMapping===1)?"#define USE_LIGHTPROBEMAP":"",(cS.envMapping===2)?"#define USE_LATLONGMAP":"",cS.useFiniteEnvMap?"#define USE_FINITE_ENVMAP":"",cS.sslr?"#define USE_SSLR":"",cS.iterative?"#define USE_ITERATION":"",cS.thinWalled?"#define THIN_WALLED":"",cS.NRECompatibility?"#define NRE_COMPATIBILITY":"",cS._gasLook?"#define GAS_LOOK":"",cS.isMultiInstanced?"#define IS_MULTI_INSTANCED":"",cS.instancingMeshSelectionMode?"#define INSTANCING_MESH_SELECTION":"",cS._definePickingInstancing?"#define PICKING_INSTANCING":"",cS.dashedLine?"#define USE_DASHEDLINE":"",cS.cpuPattern?"#define CPU_PATTERN":"",cS.patternSize?"#define PATTERN_LENGTH "+cS.patternSize:"",cS.wideLine?"#define USE_WIDELINE":"",cS.wideLine&&cS.polygonBorderMode?"#define USE_POLYGON_BORDER_MODE":"",cS.wideLine&&cS.linejoin?"#define USE_"+cS.linejoin.toUpperCase()+"JOIN":"",cS.wideLine&&cS.linecap?"#define USE_"+cS.linecap.toUpperCase()+"CAP":"",cS.isAccumMat?"#define ACCUM_SHADER":"",cS.isRevealMat?"#define REVEAL_SHADER":"",cS.useOIT?"#define USE_OIT":"",cS.metal?"#define METAL":"",cS.perPixel?"#define PHONG_PER_PIXEL":"",cS.wrapAround?"#define WRAP_AROUND":"",cS.doubleSided||true?"#define DOUBLE_SIDED":"",cS.flipSided?"#define FLIP_SIDED":"",cS.vertexColors?"#define USE_COLOR":"",(cS.vertexColors===3)?"#define USE_COLOR_RGB":"",(cS.vertexColors===4)?"#define USE_COLOR_A":"",cS.PDSFX?"#define PDSFX":"",cS.pdsfxUseMap?"#define PDSFX_USE_MAP":"","","#ifdef PICKING_INSTANCING","varying vec3 vInstancePickingColor;","#endif","","uniform mat4 modelViewMatrix;","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform mat4 modelMatrix;","uniform mat4 projectionMatrix;",""].join("\n");if(cS.PDSFX){var cH=["#ifdef PDSFX",cS.pdsfxVaryingsCode,cS.pdsfxUniformsCode.common,cS.pdsfxUniformsCode.fragment,s.ShaderChunk.PDSFX_common_pars,s.ShaderChunk.PDSFX_varyings_pars,s.ShaderChunk.PDSFX_varying_getters_fragment,cS.pdsfxGlobalVariablesCode_FS,cS.PDSFX_OverridableFunctions_FS,"#endif",""].join("\n");cP+=cH}for(c3=0,c8=cl.length;c3<c8;c3++){var cO=cl[c3];if(cO.code===cF&&cO.prefix_vertex===cJ&&cO.prefix_fragment===cP){cO.usedTimes++;return cO.program}}var dc=new s.ProgramObject();cT=w.createProgram();dc.program=cT;dc._lightsKey=ap;var cW="";cW=cL;var c7="";c7=cE;var c5=x("fragment",cP+c7);var cN=x("vertex",cJ+cW);w.attachShader(cT,cN);w.attachShader(cT,c5);w.linkProgram(cT);if(!w.getProgramParameter(cT,w.LINK_STATUS)){console.error("Could not initialise shader\nVALIDATE_STATUS: "+w.getProgramParameter(cT,w.VALIDATE_STATUS)+", gl error ["+w.getProgramInfoLog(cT)+"]");console.log(cP+c7)}w.deleteShader(c5);w.deleteShader(cN);var cX,db;dc.objectUniformLocations=new s.ObjectUniformLocations();var cQ=dc.objectUniformLocations;cQ.modelMatrix=w.getUniformLocation(cT,"modelMatrix");cQ.modelInvTranspMatrix=w.getUniformLocation(cT,"modelInvTranspMatrix");cQ.modelViewMatrix=w.getUniformLocation(cT,"modelViewMatrix");cQ.modelViewInvTranspMatrix=w.getUniformLocation(cT,"modelViewInvTranspMatrix");cQ.use_normal_matrix=w.getUniformLocation(cT,"use_normal_matrix");cQ.normalMatrix=w.getUniformLocation(cT,"normalMatrix");cQ.shadowMatrix=w.getUniformLocation(cT,"shadowMatrix");cQ.quantizedVector=w.getUniformLocation(cT,"quantizedVector");cQ.offsetVector=w.getUniformLocation(cT,"offsetVector");cQ.fixedSizeRatio=w.getUniformLocation(cT,"fixedSizeRatio");cQ.fixedSizeCenterRatio=w.getUniformLocation(cT,"fixedSizeCenterRatio");dc.uniformLocations={};var c0=dc.uniformLocations;c0.viewMatrix=w.getUniformLocation(cT,"viewMatrix");c0.projectionMatrix=w.getUniformLocation(cT,"projectionMatrix");c0.cameraPosition=w.getUniformLocation(cT,"cameraPosition");c0.cameraConstant=w.getUniformLocation(cT,"cameraConstant");for(cX in da){if(da[cX]._array){da[cX]._array=undefined}c0[cX]=w.getUniformLocation(cT,cX)}if(cS.PDSFX){c0.viewInvMatrix=w.getUniformLocation(cT,"viewInvMatrix");c0.projectionInvMatrix=w.getUniformLocation(cT,"projectionInvMatrix");c0.viewInvTranspMatrix=w.getUniformLocation(cT,"viewInvTranspMatrix");c0.nearFarLogFactor=w.getUniformLocation(cT,"nearFarLogFactor");c0.viewportSize=w.getUniformLocation(cT,"viewportSize");if(cS.PDSFX_hasAlbedo){c0.diffuse=w.getUniformLocation(cT,"_DSalbedo")}if(cS.PDSFX_hasEmissive){c0.emissive=w.getUniformLocation(cT,"_DSemissive")}if(cS.PDSFX_hasSpecular){c0.specular=w.getUniformLocation(cT,"_DSspecular")}if(cS.PDSFX_hasPsColor){c0.psColor=w.getUniformLocation(cT,"_DSalbedo")}if(cS.PDSFX_hasTransparency){c0.transparency=w.getUniformLocation(cT,"_DStransparency")}c0.opacity=w.getUniformLocation(cT,"_DSopacity");if(cS.pdsfxUniforms){for(var c1 in cS.pdsfxUniforms){c0[c1]=w.getUniformLocation(cT,c1)}}}var cV=dc.attributes;if(cS.PDSFX){cV.position=w.getAttribLocation(cT,"_DSposition");cV.normal=w.getAttribLocation(cT,"_DSnormal");cV.uv=w.getAttribLocation(cT,"_DSuv");cV.uv2=w.getAttribLocation(cT,"_DSuv2");cV.tangent=w.getAttribLocation(cT,"_DStangent");cV.binormal=w.getAttribLocation(cT,"_DSbinormal")}else{if(cS.compressedVertices){cV.position=w.getAttribLocation(cT,"_DSposition")}else{cV.position=w.getAttribLocation(cT,"position")}if(cS.compressedNormals){cV.normal=w.getAttribLocation(cT,"_DSnormal")}else{cV.normal=w.getAttribLocation(cT,"normal")}cV.uv=w.getAttribLocation(cT,"uv");cV.uv2=w.getAttribLocation(cT,"uv2");cV.tangent=w.getAttribLocation(cT,"tangent");cV.binormal=w.getAttribLocation(cT,"binormal")}cV.color=w.getAttribLocation(cT,"color");cV.skinIndex=w.getAttribLocation(cT,"skinIndex");cV.skinWeight=w.getAttribLocation(cT,"skinWeight");cV.lineDistance=w.getAttribLocation(cT,"lineDistance");cV.previousPos=w.getAttribLocation(cT,"previousPos");cV.followingPos=w.getAttribLocation(cT,"followingPos");cV.sideExtrusion=w.getAttribLocation(cT,"sideExtrusion");dc.uvOrBinOrTan=cV.uv>=0||cV.binormal>=0||cV.tangent>=0;var cM=dc.instanceAttributes;for(db in cU){cM[db]=w.getAttribLocation(cT,db)}dc.id=a8++;cl.push({program:dc,code:cF,usedTimes:1,prefix_vertex:cJ,prefix_fragment:cP});bm.info.memory.programs=cl.length;return dc}function aJ(cF){var cH=cF.split("\n");for(var cG=0,cE=cH.length;cG<cE;cG++){cH[cG]=(cG+1)+": "+cH[cG]}return cH.join("\n")}function x(cF,cE){var cG;if(cF==="fragment"){cG=w.createShader(w.FRAGMENT_SHADER)}else{if(cF==="vertex"){cG=w.createShader(w.VERTEX_SHADER)}}w.shaderSource(cG,cE);w.compileShader(cG);if(!w.getShaderParameter(cG,w.COMPILE_STATUS)){console.error(w.getShaderInfoLog(cG));console.error(aJ(cE));return null}return cG}function bJ(cE){return(cE&(cE-1))===0}function aT(cE,cF,cG){if(cG){w.texParameteri(cE,w.TEXTURE_WRAP_S,br(cF.wrapS));w.texParameteri(cE,w.TEXTURE_WRAP_T,br(cF.wrapT));w.texParameteri(cE,w.TEXTURE_MAG_FILTER,br(cF.magFilter));w.texParameteri(cE,w.TEXTURE_MIN_FILTER,br(cF.minFilter))}else{w.texParameteri(cE,w.TEXTURE_WRAP_S,w.CLAMP_TO_EDGE);w.texParameteri(cE,w.TEXTURE_WRAP_T,w.CLAMP_TO_EDGE);w.texParameteri(cE,w.TEXTURE_MAG_FILTER,bn(cF.magFilter));w.texParameteri(cE,w.TEXTURE_MIN_FILTER,bn(cF.minFilter))}if(L&&cF.type!==s.FloatType){if(cF.anisotropy>1||cF.__oldAnisotropy){w.texParameterf(cE,L.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(cF.anisotropy,cj));cF.__oldAnisotropy=cF.anisotropy}}}this.setTexture=function(cN,cP){if(cN.lods&&cN.lods.length){var cK=cN.usedTexture;if(cK===-1){cN.lastUsedTexture=-1}else{var cL=cN.textures[cK];if(cL&&(cL.loadEndStatus==="complete")){if(!cL.__webglInit){this.__glResources__.textureLODPool.add({textureLOD:cN,lod:cK,size:cL.image?4*cL.image.width*cL.image.height:0})}cN.lastUsedTexture=cK;cN=cL}else{if(cN.lastUsedTexture!==-1){cN=cN.textures[cN.lastUsedTexture]}}}this.__glResources__.textureLODPool.removeUnusedTextures()}if(cN.needsUpdate){if(!cN.__webglInit){cN.__webglInit=true;cN.addEventListener("dispose",aQ);cN.__webglTexture=w.createTexture();bm.info.memory.textures++;this.__glResources__.texture.push(cN)}w.activeTexture(w.TEXTURE0+cP);w.bindTexture(w.TEXTURE_2D,cN.__webglTexture);w.pixelStorei(w.UNPACK_FLIP_Y_WEBGL,cN.flipY);w.pixelStorei(w.UNPACK_PREMULTIPLY_ALPHA_WEBGL,cN.premultiplyAlpha);w.pixelStorei(w.UNPACK_ALIGNMENT,cN.unpackAlignment);var cI=cN.image,cM=bJ(cI.width)&&bJ(cI.height),cE=br(cN.format),cG=br(cN.type);aT(w.TEXTURE_2D,cN,cM);var cF,cH=cN.mipmaps;if(cN instanceof s.DataTexture){if(cH.length>0&&cM){for(var cJ=0,cO=cH.length;cJ<cO;cJ++){cF=cH[cJ];w.texImage2D(w.TEXTURE_2D,cJ,cE,cF.width,cF.height,0,cE,cG,cF.data)}cN.generateMipmaps=false}else{if(cI.data){w.texImage2D(w.TEXTURE_2D,0,cE,cI.width,cI.height,0,cE,cG,cI.data)}}}else{if(cN instanceof s.CompressedTexture){for(var cJ=0,cO=cH.length;cJ<cO;cJ++){cF=cH[cJ];if(cN.format==s.RGB_S3TC_DXT1_Format||cN.format==s.RGBA_S3TC_DXT1_Format||cN.format==s.RGBA_S3TC_DXT3_Format||cN.format==s.RGBA_S3TC_DXT5_Format){w.compressedTexImage2D(w.TEXTURE_2D,cJ,cE,cF.width,cF.height,0,cF.data)}else{w.texImage2D(w.TEXTURE_2D,cJ,cE,cF.width,cF.height,0,cE,cG,cF.data)}}}else{if(cH.length>0&&cM){for(var cJ=0,cO=cH.length;cJ<cO;cJ++){cF=cH[cJ];w.texImage2D(w.TEXTURE_2D,cJ,cE,cE,cG,cF)}cN.generateMipmaps=false}else{w.texImage2D(w.TEXTURE_2D,0,cE,cE,cG,cN.image)}}}if(cN.generateMipmaps&&cM){w.generateMipmap(w.TEXTURE_2D)}cN.needsUpdate=false;if(cN.onUpdate){cN.onUpdate()}}else{if(!cN.__webglTexture){this.setTexture(this._dummyTexture,cP);return}w.activeTexture(w.TEXTURE0+cP);w.bindTexture(w.TEXTURE_2D,cN.__webglTexture)}};function P(cJ,cK){if(cJ.width<=cK&&cJ.height<=cK){return cJ}var cI=Math.max(cJ.width,cJ.height);var cH=Math.floor(cJ.width*cK/cI);var cF=Math.floor(cJ.height*cK/cI);var cG=document.createElement("canvas");cG.width=cH;cG.height=cF;var cE=cG.getContext("2d");cE.drawImage(cJ,0,0,cJ.width,cJ.height,0,0,cH,cF);return cG}function b0(cP,cQ){if(cP.image.length===6){if(cP.needsUpdate){if(!cP.image.__webglTextureCube){cP.image.__webglTextureCube=w.createTexture();bm.info.memory.textures++;bm.__glResources__.texture.push(cP)}w.activeTexture(w.TEXTURE0+cQ);w.bindTexture(w.TEXTURE_CUBE_MAP,cP.image.__webglTextureCube);w.pixelStorei(w.UNPACK_FLIP_Y_WEBGL,cP.flipY);var cH=cP instanceof s.CompressedTexture;var cE=[];for(var cN=0;cN<6;cN++){if(bm.autoScaleCubemaps&&!cH){cE[cN]=P(cP.image[cN],aW)}else{cE[cN]=cP.image[cN]}}var cK=cE[0],cO=bJ(cK.width)&&bJ(cK.height),cF=br(cP.format),cI=br(cP.type);aT(w.TEXTURE_CUBE_MAP,cP,cO);for(var cN=0;cN<6;cN++){if(cH){var cG,cJ=cE[cN].mipmaps;for(var cL=0,cM=cJ.length;cL<cM;cL++){cG=cJ[cL];if((cP.format===s.AlphaFormat)||(cP.format===s.RGBFormat)||(cP.format===s.RGBAFormat)||(cP.format===s.LuminanceFormat)||(cP.format===s.LuminanceAlphaFormat)){w.texImage2D(w.TEXTURE_CUBE_MAP_POSITIVE_X+cN,cL,cF,cG.width,cG.height,0,cF,cI,cG.data)}else{w.compressedTexImage2D(w.TEXTURE_CUBE_MAP_POSITIVE_X+cN,cL,cF,cG.width,cG.height,0,cG.data)}}}else{w.texImage2D(w.TEXTURE_CUBE_MAP_POSITIVE_X+cN,0,cF,cF,cI,cE[cN])}}if(cP.generateMipmaps&&cO){w.generateMipmap(w.TEXTURE_CUBE_MAP)}cP.needsUpdate=false;if(cP.onUpdate){cP.onUpdate()}}else{w.activeTexture(w.TEXTURE0+cQ);w.bindTexture(w.TEXTURE_CUBE_MAP,cP.image.__webglTextureCube)}}}function bM(cE,cF){w.activeTexture(w.TEXTURE0+cF);w.bindTexture(w.TEXTURE_CUBE_MAP,cE.__webglTexture)}function bL(cG,cF,cE){w.bindFramebuffer(w.FRAMEBUFFER,cG);if(cF){w.framebufferTexture2D(w.FRAMEBUFFER,w.COLOR_ATTACHMENT0,cE,cF.__webglTexture,0)}}function O(cE,cF){w.bindRenderbuffer(w.RENDERBUFFER,cE);if(cF.depthBuffer&&!cF.stencilBuffer){w.renderbufferStorage(w.RENDERBUFFER,w.DEPTH_COMPONENT16,cF.width,cF.height);w.framebufferRenderbuffer(w.FRAMEBUFFER,w.DEPTH_ATTACHMENT,w.RENDERBUFFER,cE)}else{if(cF.depthBuffer&&cF.stencilBuffer){w.renderbufferStorage(w.RENDERBUFFER,w.DEPTH_STENCIL,cF.width,cF.height);w.framebufferRenderbuffer(w.FRAMEBUFFER,w.DEPTH_STENCIL_ATTACHMENT,w.RENDERBUFFER,cE)}else{w.renderbufferStorage(w.RENDERBUFFER,w.RGBA4,cF.width,cF.height)}}}this.setRenderTarget=function(cI){var cK=(cI instanceof s.WebGLRenderTargetCube);if(cI&&!cI.__webglFramebuffer){if(cI.depthBuffer===undefined){cI.depthBuffer=true}if(cI.stencilBuffer===undefined){cI.stencilBuffer=true}cI.addEventListener("dispose",ay);cI.__webglTexture=w.createTexture();bm.info.memory.textures++;this.__glResources__.renderTarget[cI.uniqueID]=cI;var cL=bJ(cI.width)&&bJ(cI.height),cE=br(cI.format),cG=br(cI.type);if(cK){cI.__webglFramebuffer=[];cI.__webglRenderbuffer=[];w.bindTexture(w.TEXTURE_CUBE_MAP,cI.__webglTexture);aT(w.TEXTURE_CUBE_MAP,cI,cL);for(var cH=0;cH<6;cH++){cI.__webglFramebuffer[cH]=w.createFramebuffer();cI.__webglRenderbuffer[cH]=w.createRenderbuffer();w.texImage2D(w.TEXTURE_CUBE_MAP_POSITIVE_X+cH,0,cE,cI.width,cI.height,0,cE,cG,null);bL(cI.__webglFramebuffer[cH],cI,w.TEXTURE_CUBE_MAP_POSITIVE_X+cH);O(cI.__webglRenderbuffer[cH],cI)}if(cL){w.generateMipmap(w.TEXTURE_CUBE_MAP)}}else{cI.__webglFramebuffer=w.createFramebuffer();if(cI.shareDepthFrom){cI.__webglRenderbuffer=cI.shareDepthFrom.__webglRenderbuffer}else{cI.__webglRenderbuffer=w.createRenderbuffer()}w.bindTexture(w.TEXTURE_2D,cI.__webglTexture);aT(w.TEXTURE_2D,cI,cL);w.texImage2D(w.TEXTURE_2D,0,cE,cI.width,cI.height,0,cE,cG,null);bL(cI.__webglFramebuffer,cI,w.TEXTURE_2D);if(cI.shareDepthFrom){if(cI.depthBuffer&&!cI.stencilBuffer){w.framebufferRenderbuffer(w.FRAMEBUFFER,w.DEPTH_ATTACHMENT,w.RENDERBUFFER,cI.__webglRenderbuffer)}else{if(cI.depthBuffer&&cI.stencilBuffer){w.framebufferRenderbuffer(w.FRAMEBUFFER,w.DEPTH_STENCIL_ATTACHMENT,w.RENDERBUFFER,cI.__webglRenderbuffer)}}}else{O(cI.__webglRenderbuffer,cI)}if(cL){w.generateMipmap(w.TEXTURE_2D)}}if(cK){w.bindTexture(w.TEXTURE_CUBE_MAP,null)}else{w.bindTexture(w.TEXTURE_2D,null)}w.bindRenderbuffer(w.RENDERBUFFER,null);w.bindFramebuffer(w.FRAMEBUFFER,null)}else{if(cI&&(cI.minFilter!==cI.originalMinFilter||cI.magFilter!==cI.originalMagFilter)){var cL=bJ(cI.width)&&bJ(cI.height);if(cK){w.bindTexture(w.TEXTURE_CUBE_MAP,cI.__webglTexture);aT(w.TEXTURE_CUBE_MAP,cI,cL);w.bindTexture(w.TEXTURE_CUBE_MAP,null)}else{w.bindTexture(w.TEXTURE_2D,cI.__webglTexture);aT(w.TEXTURE_2D,cI,cL);w.bindTexture(w.TEXTURE_2D,null)}cI.originalMinFilter=cI.minFilter;cI.originalMagFilter=cI.magFilter}}var cN,cF,cO,cM,cJ;if(cI){if(cK){cN=cI.__webglFramebuffer[cI.activeCubeFace]}else{cN=cI.__webglFramebuffer}if(bm.RTTmatchViewport){cF=cu;cO=bs;cM=bF;cJ=bE}else{cF=cI.width;cO=cI.height;cM=0;cJ=0}}else{cN=null;cF=cu;cO=bs;cM=bF;cJ=bE}if(cN!==s.glStates.currentFramebuffer){w.bindFramebuffer(w.FRAMEBUFFER,cN);s.glStates.currentFramebuffer=cN}if(s.glStates.currentWidth!==cF||s.glStates.currentHeight!==cO){w.viewport(cM,cJ,cF,cO);s.glStates.currentWidth=cF;s.glStates.currentHeight=cO}};function bu(cE){if(cE instanceof s.WebGLRenderTargetCube){w.bindTexture(w.TEXTURE_CUBE_MAP,cE.__webglTexture);w.generateMipmap(w.TEXTURE_CUBE_MAP);w.bindTexture(w.TEXTURE_CUBE_MAP,null)}else{w.bindTexture(w.TEXTURE_2D,cE.__webglTexture);w.generateMipmap(w.TEXTURE_2D);w.bindTexture(w.TEXTURE_2D,null)}}function bn(cE){if(cE===s.NearestFilter||cE===s.NearestMipMapNearestFilter||cE===s.NearestMipMapLinearFilter){return w.NEAREST}return w.LINEAR}function br(cE){if(cE===s.RepeatWrapping){return w.REPEAT}if(cE===s.ClampToEdgeWrapping){return w.CLAMP_TO_EDGE}if(cE===s.MirroredRepeatWrapping){return w.MIRRORED_REPEAT}if(cE===s.NearestFilter){return w.NEAREST}if(cE===s.NearestMipMapNearestFilter){return w.NEAREST_MIPMAP_NEAREST}if(cE===s.NearestMipMapLinearFilter){return w.NEAREST_MIPMAP_LINEAR}if(cE===s.LinearFilter){return w.LINEAR}if(cE===s.LinearMipMapNearestFilter){return w.LINEAR_MIPMAP_NEAREST}if(cE===s.LinearMipMapLinearFilter){return w.LINEAR_MIPMAP_LINEAR}if(cE===s.UnsignedByteType){return w.UNSIGNED_BYTE}if(cE===s.UnsignedShort4444Type){return w.UNSIGNED_SHORT_4_4_4_4}if(cE===s.UnsignedShort5551Type){return w.UNSIGNED_SHORT_5_5_5_1}if(cE===s.UnsignedShort565Type){return w.UNSIGNED_SHORT_5_6_5}if(cE===s.ByteType){return w.BYTE}if(cE===s.ShortType){return w.SHORT}if(cE===s.UnsignedShortType){return w.UNSIGNED_SHORT}if(cE===s.IntType){return w.INT}if(cE===s.UnsignedIntType){return w.UNSIGNED_INT}if(cE===s.FloatType){return w.FLOAT}if(cE===s.AlphaFormat){return w.ALPHA}if(cE===s.RGBFormat){return w.RGB}if(cE===s.RGBAFormat){return w.RGBA}if(cE===s.LuminanceFormat){return w.LUMINANCE}if(cE===s.LuminanceAlphaFormat){return w.LUMINANCE_ALPHA}if(cE===s.AddEquation){return w.FUNC_ADD}if(cE===s.SubtractEquation){return w.FUNC_SUBTRACT}if(cE===s.ReverseSubtractEquation){return w.FUNC_REVERSE_SUBTRACT}if(cE===s.ZeroFactor){return w.ZERO}if(cE===s.OneFactor){return w.ONE}if(cE===s.SrcColorFactor){return w.SRC_COLOR}if(cE===s.OneMinusSrcColorFactor){return w.ONE_MINUS_SRC_COLOR}if(cE===s.SrcAlphaFactor){return w.SRC_ALPHA}if(cE===s.OneMinusSrcAlphaFactor){return w.ONE_MINUS_SRC_ALPHA}if(cE===s.DstAlphaFactor){return w.DST_ALPHA}if(cE===s.OneMinusDstAlphaFactor){return w.ONE_MINUS_DST_ALPHA}if(cE===s.DstColorFactor){return w.DST_COLOR}if(cE===s.OneMinusDstColorFactor){return w.ONE_MINUS_DST_COLOR}if(cE===s.SrcAlphaSaturateFactor){return w.SRC_ALPHA_SATURATE}if(bd!==undefined){if(cE===s.RGB_S3TC_DXT1_Format){return bd.COMPRESSED_RGB_S3TC_DXT1_EXT}if(cE===s.RGBA_S3TC_DXT1_Format){return bd.COMPRESSED_RGBA_S3TC_DXT1_EXT}if(cE===s.RGBA_S3TC_DXT3_Format){return bd.COMPRESSED_RGBA_S3TC_DXT3_EXT}if(cE===s.RGBA_S3TC_DXT5_Format){return bd.COMPRESSED_RGBA_S3TC_DXT5_EXT}}if(au!==undefined){if(cE===s.MinEquation){return au.MIN_EXT}if(cE===s.MaxEquation){return au.MAX_EXT}}return 0}function bT(cH){var cG,cI,cF;var cE={dirLights:0,pointLights:0,spotLights:0,hemiLights:0,sphereLights:0,areaLights:0,iesLights:0,tubeLights:0,diskLights:0,probeLight:false};for(cG=0,cI=cH.length;cG<cI;cG++){cF=cH[cG];if(cF.onlyShadow){continue}cF.allocate(cE)}return{probe:cE.probeLight,directional:cE.dirLights,point:cE.pointLights,spot:cE.spotLights,hemi:cE.hemiLights,sphere:cE.sphereLights,area:cE.areaLights,ies:cE.iesLights,tube:cE.tubeLights,disk:cE.diskLights}}function aI(cG){var cF,cI,cE,cH={dirLight:0,spotLight:0,tex2d:0,texCube:0};for(cF=0,cI=cG.length;cF<cI;cF++){cE=cG[cF];if(!cE.castShadow){continue}cE.allocateShadows(bm,cH)}return cH}function N(cF){var cH,cI,cE,cG=0;for(cH=0,cI=cF.length;cH<cI;cH++){cE=cF[cH];cG++}return cG}function b6(cG,cF){function cE(cP,cQ,cO){window.WebVisuTestsWebGLError=true;throw"##WEBGLERROR## "+WebGLDebugUtils.glEnumToString(cP)+" was caused by call to: "+cQ}try{if(cG){w=cG}else{if(!(w=bw.getContext("experimental-webgl",{alpha:ck,premultipliedAlpha:bA,antialias:cC,stencil:z,preserveDrawingBuffer:aF}))){throw"Error creating WebGL context."}}}catch(cL){console.error(cL)}if(!cG&&cF){w=WebGLDebugUtils.makeDebugContext(w,cE)}if(!w._enabledAttributes){w._enabledAttributes={}}if(!w.hasOwnProperty("contextId")){n++;w.contextId=n}if(!w.hasOwnProperty("WebVisuShaderVersion")){w.WebVisuShaderVersion=0}if(!w._currentProgram){w._currentProgram=null}if(!w._oldBlending){w.oldBlending=-1}if(s.enableWebGLStats){s.webGLStats={reset:function(){this.useProgram_nb=0;this.bindBuffer_nb=0;this.drawElements_nb=0},dump:function(){console.log({useProgram_nb:this.useProgram_nb,bindBuffer_nb:this.bindBuffer_nb,drawElements_nb:this.drawElements_nb})},useProgram_nb:0,bindBuffer_nb:0,drawElements_nb:0};w.useProgram_save=w.useProgram;w.useProgram=function(){s.webGLStats.useProgram_nb++;w.useProgram_save.apply(w,arguments)};w.bindBuffer_save=w.bindBuffer;w.bindBuffer=function(){s.webGLStats.bindBuffer_nb++;w.bindBuffer_save.apply(w,arguments)};w.drawElements_save=w.drawElements;w.drawElements=function(){s.webGLStats.drawElements_nb++;w.drawElements_save.apply(w,arguments)}}var cJ=w.getSupportedExtensions();function cI(cO){if(cJ.indexOf(cO)>=0){return w.getExtension(cO)}return null}ci=cI("WEBGL_color_buffer_float");aj=cI("OES_texture_half_float");G=cI("OES_texture_float");Z=cI("OES_texture_float_linear");bQ=cI("OES_standard_derivatives");L=cI("EXT_texture_filter_anisotropic")||cI("MOZ_EXT_texture_filter_anisotropic")||cI("WEBKIT_EXT_texture_filter_anisotropic");bd=cI("WEBGL_compressed_texture_s3tc")||cI("MOZ_WEBGL_compressed_texture_s3tc")||cI("WEBKIT_WEBGL_compressed_texture_s3tc");I=cI("ANGLE_instanced_arrays");b2=cI("OES_element_index_uint");bO=cI("EXT_frag_depth");au=cI("EXT_blend_minmax");if(G){var cK=w.createTexture();var cM=w.createFramebuffer();var cN=w.createRenderbuffer();w.bindTexture(w.TEXTURE_2D,cK);w.texParameteri(w.TEXTURE_2D,w.TEXTURE_WRAP_S,w.CLAMP_TO_EDGE);w.texParameteri(w.TEXTURE_2D,w.TEXTURE_WRAP_T,w.CLAMP_TO_EDGE);w.texParameteri(w.TEXTURE_2D,w.TEXTURE_MAG_FILTER,w.LINEAR);w.texParameteri(w.TEXTURE_2D,w.TEXTURE_MIN_FILTER,w.LINEAR);w.texImage2D(w.TEXTURE_2D,0,w.RGBA,100,100,0,w.RGBA,w.FLOAT,null);w.bindFramebuffer(w.FRAMEBUFFER,cM);w.framebufferTexture2D(w.FRAMEBUFFER,w.COLOR_ATTACHMENT0,w.TEXTURE_2D,cK,0);w.bindRenderbuffer(w.RENDERBUFFER,cN);w.renderbufferStorage(w.RENDERBUFFER,w.DEPTH_COMPONENT16,100,100);w.framebufferRenderbuffer(w.FRAMEBUFFER,w.DEPTH_ATTACHMENT,w.RENDERBUFFER,cN);var cH=w.checkFramebufferStatus(w.FRAMEBUFFER);J=true;if(cH!=w.FRAMEBUFFER_COMPLETE){J=false}w.bindFramebuffer(w.FRAMEBUFFER,null);w.bindTexture(w.TEXTURE_2D,null);w.bindRenderbuffer(w.RENDERBUFFER,null);w.deleteTexture(cK);w.deleteFramebuffer(cM);w.deleteRenderbuffer(cN)}s.supportedExtensions={colorBufferFloat:ci,textureHalfFloat:aj,textureFloat:G,textureFloatLinear:Z,standardDerivatives:bQ,textureFilterAnisotropic:L,compressedTexturesS3TC:bd,instancedArrays:I,elementIndexUint:b2,renderToFloatTexture:J,fragDepth:bO,minMaxBlending:au,fragmentTextureUnits:w.getParameter(w.MAX_TEXTURE_IMAGE_UNITS),vertexTextureUnits:w.getParameter(w.MAX_VERTEX_TEXTURE_IMAGE_UNITS),depthBits:Math.pow(2,-w.getParameter(w.DEPTH_BITS))};if(!G){console.log("THREE.WebGLRenderer: Float textures not supported.")}if(!bQ){console.log("THREE.WebGLRenderer: Standard derivatives not supported.")}if(!L){console.log("THREE.WebGLRenderer: Anisotropic texture filtering not supported.")}if(!bd){console.log("THREE.WebGLRenderer: S3TC compressed textures not supported.")}if(!I){console.log("THREE.WebGLRenderer: angle instanced arrays not supported.")}if(!b2){console.log("THREE.WebGLRenderer: UInt Element Index not supported.")}if(!bO){console.log("THREE.WebGLRenderer: Fragment Depth Writing not supported.")}if(!au){console.log("THREE.WebGLRenderer: min/max blending not supported.")}if(w.getShaderPrecisionFormat===undefined){w.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}}}function bP(){w.lineWidth(1);w.clearColor(0,0,0,1);w.clearDepth(1);w.clearStencil(0);w.enable(w.DEPTH_TEST);w.depthFunc(w.LEQUAL);w.frontFace(w.CCW);w.cullFace(w.BACK);w.enable(w.CULL_FACE);w.enable(w.BLEND);w.blendEquation(w.FUNC_ADD);w.blendFunc(w.SRC_ALPHA,w.ONE_MINUS_SRC_ALPHA);w._oldBlending=s.AlphaBlending;w.clearColor(b9.r,b9.g,b9.b,aD)}this._gpuPickingTolerance=0;this._smallTargetPicking=0;this.useOIT=false;this._oitMaterial=false;this.precomputedTexture1=null;this.precomputedTexture2=null;this.precomputedTexture3=null;this.precomputedAreaGGX1texture=null;this.precomputedAreaGGX2texture=null;this.precomputedAreaSheentexture=null;this.materialToUse=-1;this.shadowMapSoft=false;this.gpuAntiAliasing=false;this.forceMaterialDoubleSide=true;this.cuttingScene=null;this.backupCuttingMaterial=null;this.cameraSystem_cameraIndex=-1};s.WebGLRenderTargetProperties=function(w,u,v){this.width=w;this.height=u;this.options=v};s.WebGLRenderTarget=function(w,u,v){s.EventDispatcher.call(this);this.uniqueID=s.__renderTargetID++;this.width=w;this.height=u;if(v){this.originalMagFilter=v.magFilter;this.originalMinFilter=v.minFilter}this.reset(v)};s.WebGLRenderTarget.prototype.clone=function(){var u=new s.WebGLRenderTarget(this.width,this.height);u.wrapS=this.wrapS;u.wrapT=this.wrapT;u.magFilter=this.magFilter;u.minFilter=this.minFilter;u.anisotropy=this.anisotropy;u.offset.copy(this.offset);u.repeat.copy(this.repeat);u.format=this.format;u.type=this.type;u.depthBuffer=this.depthBuffer;u.stencilBuffer=this.stencilBuffer;u.generateMipmaps=this.generateMipmaps;u.mapping=this.mapping;u.shareDepthFrom=this.shareDepthFrom;if(this.originalMagFilter){u.originalMagFilter=this.originalMagFilter}if(this.originalMinFilter){u.originalMinFilter=this.originalMinFilter}return u};s.WebGLRenderTarget.prototype.reset=function(u){u=u||{};this.wrapS=u.wrapS!==undefined?u.wrapS:s.ClampToEdgeWrapping;this.wrapT=u.wrapT!==undefined?u.wrapT:s.ClampToEdgeWrapping;this.magFilter=u.magFilter!==undefined?u.magFilter:s.LinearFilter;this.minFilter=u.minFilter!==undefined?u.minFilter:s.LinearMipMapLinearFilter;this.anisotropy=u.anisotropy!==undefined?u.anisotropy:1;this.offset=new s.Vector2(0,0);this.repeat=new s.Vector2(1,1);this.format=u.format!==undefined?u.format:s.RGBAFormat;this.type=u.type!==undefined?u.type:s.UnsignedByteType;this.depthBuffer=u.depthBuffer!==undefined?u.depthBuffer:true;this.stencilBuffer=u.stencilBuffer!==undefined?u.stencilBuffer:true;this.generateMipmaps=true;this.mapping=new s.UVMapping();this.shareDepthFrom=null;this.useCount=0};s.WebGLRenderTarget.prototype.dispose=function(){this.dispatchEvent({type:"dispose"})};s.WebGLRenderTargetCube=function(w,u,v){s.WebGLRenderTarget.call(this,w,u,v);this.activeCubeFace=0};s.WebGLRenderTargetCube.prototype=Object.create(s.WebGLRenderTarget.prototype);s.GeometryUtils={center:function(w){w.computeBoundingBox();var v=w.boundingBox;var u=new s.Vector3();u.addVectors(v.min,v.max);u.multiplyScalar(-0.5);w.applyMatrix(new s.Matrix4().makeTranslation(u.x,u.y,u.z));w.computeBoundingBox();return u}};s.ImageUtils={nbTexturesBeingLoaded:0,crossOrigin:"anonymous",loadTexture:function(w,u,E,C,B,I){function y(K){var J=Math.log(K)/Math.LN2;return Math.floor(J)===J}function v(K){var J=Math.log(K)/Math.LN2;return Math.pow(2,Math.round(J))}var x=document.createElement("canvas");var D=new s.Texture(x,u);D.loadEndStatus="loading";var H=((new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent)!=null));var A=!w.startsWith("data:");if(H&&A&&((B===undefined)||(B===false))){var G={headers:new Object(),method:"GET",authentication:"ajax",timeout:3600000,async:true,type:"blob",onComplete:function(K){var L=URL.createObjectURL(K);var M=new Image();var J=new s.ImageLoader();J.addEventListener("load",function(Q){s.ImageUtils.nbTexturesBeingLoaded--;D.needsUpdate=true;D.loadEndStatus="complete";var P,N;if(I&&(!y(M.width)||!y(M.height))){P=v(M.width);N=v(M.height);D.image.width=P;D.image.height=N;D.image.getContext("2d").drawImage(M,0,0,P,N)}else{D.image=M}if(E){E(D)}var O;for(O=0;O<D.onLoadCallbacks.length;O++){D.onLoadCallbacks[O](D)}});J.addEventListener("error",function(N){s.ImageUtils.nbTexturesBeingLoaded--;if(C){C(N.message)}D.loadEndStatus="error"});J.load(L,M)},onFailure:function(J){s.ImageUtils.nbTexturesBeingLoaded--;if(C){C(event.message)}D.loadEndStatus="error"},onTimeout:function(){s.ImageUtils.nbTexturesBeingLoaded--;if(C){C(event.message)}D.loadEndStatus="error"}};UWA.Data.request(w,G)}else{var z=new Image();if(B!==null){z.crossOrigin=B?"use-credentials":"anonymous"}var F=new s.ImageLoader();F.addEventListener("load",function(M){s.ImageUtils.nbTexturesBeingLoaded--;D.needsUpdate=true;D.loadEndStatus="complete";var L,J;if(I&&(!y(z.width)||!y(z.height))){L=v(z.width);J=v(z.height);D.image.width=L;D.image.height=J;D.image.getContext("2d").drawImage(z,0,0,L,J)}else{D.image=z}if(E){E(D)}var K;for(K=0;K<D.onLoadCallbacks.length;K++){D.onLoadCallbacks[K](D)}});F.addEventListener("error",function(J){s.ImageUtils.nbTexturesBeingLoaded--;if(C){C(J.message)}D.loadEndStatus="error"});if(z.crossOrigin){F.crossOrigin=z.crossOrigin}F.load(w,z)}s.ImageUtils.nbTexturesBeingLoaded++;D.sourceFile=w;return D},loadTexture2:function(w,v,x,y,u){console.warn("loadTexture2 is deprecated, use loadTexture with forcePowerOfTwo parameter activated");return s.ImageUtils.loadTexture(w,v,x,y,u,true)},loadTGATexture:function(w,v,y,B,u,x){var A=new s.DataTexture(new Uint8Array(16),2,2,s.RGBAFormat,s.UnsignedByteType);A.mapping=v;var z=new XMLHttpRequest();z.onload=function(){s.ImageUtils.nbTexturesBeingLoaded--;var F=new Uint8Array(z.response);var I=12;var G=F[I]+256*F[I+1];I+=2;var E=F[I]+256*F[I+1];I+=4;A.image.data=new Uint8Array(4*G*E);var H=A.image.data;A.image.width=G;A.image.height=E;for(var J=0;J<E;J++){for(var D=0;D<G;D++){var C=J*G+D;H[4*C]=F[I+4*C+2];H[4*C+1]=F[I+4*C+1];H[4*C+2]=F[I+4*C];H[4*C+3]=F[I+4*C+3]}}A.loadEndStatus="complete";A.generateMipmaps=false;A.needsUpdate=true;if(y){y(A)}};z.onerror=function(){B();s.ImageUtils.nbTexturesBeingLoaded--;A.loadEndStatus="error"};if(x){A.loadEndStatus="pause";A.onRequest=function(){A.loadEndStatus="loading";s.ImageUtils.nbTexturesBeingLoaded++;z.open("GET",w,true);z.responseType="arraybuffer";z.withCredentials=!!u;z.send(null)}}else{A.loadEndStatus="loading";s.ImageUtils.nbTexturesBeingLoaded++;z.open("GET",w,true);z.responseType="arraybuffer";z.withCredentials=!!u;z.send(null)}return A},loadHDRTexture:function(v,u,A,y,w,B,C){var z=new s.DataTexture();z.loadEndStatus="loading";z.hdr=true;z.sRGB=false;z.mapping=u;z.needsSH=false;z.shFactorsR=null;z.shFactorsG=null;z.shFactorsB=null;var x=new XMLHttpRequest();x.onload=function(){s.ImageUtils.nbTexturesBeingLoaded--;var D=x.response;var F=s.ImageUtils.parseRadianceHDR(D,u,w,B,C);z.format=F.format;z.type=F.type;z.image.data=F.data;z.image.width=F.width;z.image.height=F.height;z.loadEndStatus="complete";if(z.needsSH){s.ImageUtils.computeSphericalHarmonics(z)}z.generateMipmaps=true;z.needsUpdate=true;if(A){A(z)}for(var E=0;E<z.onLoadCallbacks.length;E++){z.onLoadCallbacks[E](z)}};x.onerror=function(){z.loadEndStatus="error";y();s.ImageUtils.nbTexturesBeingLoaded--};x.open("GET",v,true);x.responseType="arraybuffer";x.send(null);s.ImageUtils.nbTexturesBeingLoaded++;return z},_compressHDR:function(F){var G=function(N){var M=new Uint8Array(2*N.length);for(var L=0;L<N.length;L++){M[L]=N[L]}return M};var z=F.offset;var D=z;var J=new Uint8Array(F.buffer.length);for(var B=0;B<z;B++){J[B]=F.buffer[B]}var K=new Uint8Array(4+5*F.width);for(var A=0;A<F.height;A++){var x=0;K[x++]=2;K[x++]=2;K[x++]=F.width>>8;K[x++]=F.width&255;for(var H=0;H<4;H++){var I=[];var B=0;while(B<F.width){var w=0;var E=F.buffer[z+4*(A*F.width+B)+H];var v=E;while(B<F.width&&v===E&&w<127){w++;B++;E=v;v=F.buffer[z+4*(A*F.width+B)+H]}if(w>3){if(I.length){K[x++]=I.length;for(var y=0;y<I.length;y++){K[x++]=I[y]}I=[]}K[x++]=128+w;K[x++]=E}else{if(I.length+w>127){K[x++]=I.length;for(var y=0;y<I.length;y++){K[x++]=I[y]}I=[]}I.push(E);if(w>1){I.push(E)}if(w>2){I.push(E)}}}if(I.length){K[x++]=I.length;for(var y=0;y<I.length;y++){K[x++]=I[y]}}}if(D+x>=J.length){J=G(J)}for(var u=0;u<x;u++){J[D++]=K[u]}}var C=new Uint8Array(D);for(var B=0;B<D;B++){C[B]=J[B]}F.buffer=C},streamHDRFormat:function(G,v,u){var K=function(O,N,M){for(var L=0;L<N.length;L++){O[M++]=N.charCodeAt(L)}return M};var w="#?RADIANCE";var E="# Made with Dassault Systemes HDR map javascript generator";var y="FORMAT=32-bit_rle_rgbe";var x="-Y "+u+" +X "+v;var I=w.length+1+E.length+1+y.length+2+x.length+1;var D=new Uint8Array(I+v*u*4);var B=0;B=K(D,w,B);D[B++]=10;B=K(D,E,B);D[B++]=10;B=K(D,y,B);D[B++]=10;D[B++]=10;B=K(D,x,B);D[B++]=10;var F=u-1;for(var A=0;A<u;A++){var J=v-1;for(var C=0;C<v;C++){for(var z=0;z<4;z++){D[B+4*(v*A+C)+z]=G[4*(v*F+J)+z]}J--}F--}var H={buffer:D,offset:B,width:v,height:u};this._compressHDR(H);return new Blob([H.buffer],{type:"application/octet-binary"})},generateBlankHDRTexture:function(x,y){var w=new s.DataTexture();w.hdr=true;w.sRGB=false;w.mapping=new s.LatLongReflectionMapping();w.needsSH=false;w.shFactorsR=null;w.shFactorsG=null;w.shFactorsB=null;w.format=s.RGBAFormat;w.type=s.UnsignedByteType;w.image.width=x;w.image.height=y;w.loadEndStatus="complete";w.generateMipmaps=true;w.needsUpdate=true;var u=new Uint8Array(4*x*y);for(var v=0;v<x*y;v++){u[4*v]=255;u[4*v+1]=255;u[4*v+2]=255;u[4*v+3]=127}w.image.data=u;return w},computeSphericalHarmonics:function(K){var F=K.mapping;var T=K.image.data;var O=K.image.width;var N=K.image.height;var Q,P;if(T===undefined){K.needsSH=true;return}if(K.shFactorsR!==null){return}var B=[];for(Q=0;Q<3;Q++){B[Q]=[];for(P=0;P<9;P++){B[Q][P]=0}}var L=function(u){if(Math.abs(u)<0.0001){return 1}else{return(Math.sin(u)/u)}};var S=function(V,U,W,ad,ab,Y){var v=4*(O*U+V);var ac=Math.pow(2,T[v+3]-128);var u;for(u=0;u<3;u++){var Z=(1/256)*T[v+u]*ac;var X;X=0.282095;B[u][0]+=Z*X*W;X=0.488603;B[u][1]+=Z*(X*ab)*W;B[u][2]+=Z*(X*Y)*W;B[u][3]+=Z*(X*ad)*W;X=1.092548;B[u][4]+=Z*(X*ad*ab)*W;B[u][5]+=Z*(X*ab*Y)*W;B[u][7]+=Z*(X*ad*Y)*W;X=0.315392;B[u][6]+=Z*(X*(3*Y*Y-1))*W;X=0.546274;B[u][8]+=Z*(X*(ad*ad-ab*ab))*W}return B};var J=function(){var z;var V,U,y,x,u;V=0.429043;U=0.511664;y=0.743125;x=0.886227;u=0.247708;var v=[];v[0]=new s.Matrix4();v[1]=new s.Matrix4();v[2]=new s.Matrix4();for(z=0;z<3;z++){v[z].elements[0]=V*B[z][8];v[z].elements[1]=V*B[z][4];v[z].elements[2]=V*B[z][7];v[z].elements[3]=U*B[z][3];v[z].elements[4]=V*B[z][4];v[z].elements[5]=-V*B[z][8];v[z].elements[6]=V*B[z][5];v[z].elements[7]=U*B[z][1];v[z].elements[8]=V*B[z][7];v[z].elements[9]=V*B[z][5];v[z].elements[10]=y*B[z][6];v[z].elements[11]=U*B[z][2];v[z].elements[12]=U*B[z][3];v[z].elements[13]=U*B[z][1];v[z].elements[14]=U*B[z][2];v[z].elements[15]=x*B[z][0]-u*B[z][6]}return v};if(K.mapping instanceof s.LatLongReflectionMapping){for(P=0;P<N;P++){for(Q=0;Q<O;Q++){var I,H,C,w,G,E,D,R;I=Q/O;H=P/N;w=Math.PI*(2*I-1);C=Math.PI*H;G=Math.sin(C)*Math.cos(w);E=Math.sin(C)*Math.sin(w);D=Math.cos(C);R=2*(Math.PI/O)*(Math.PI/N)*Math.sin(C);S(Q,P,R,G,E,D)}}}else{for(Q=0;Q<O;Q++){for(P=0;P<O;P++){var I,H,M,C,w,G,E,D,R;H=(O/2-Q)/(O/2);I=(P-O/2)/(O/2);M=Math.sqrt(I*I+H*H);if(M>1){continue}C=Math.PI*M;w=Math.atan2(H,I);G=Math.sin(C)*Math.cos(w);E=Math.sin(C)*Math.sin(w);D=Math.cos(C);R=(2*Math.PI/O)*(2*Math.PI/O)*L(C);S(Q,P,R,G,E,D)}}}var A=J();if(A!==null){K.shFactorsR=A[0];K.shFactorsG=A[1];K.shFactorsB=A[2]}},loadTextureCube:function(y,v,A,x){var B=[];B.loadCount=0;var z=new s.Texture();z.loadEndStatus="loading";z.image=B;if(v!==undefined){z.mapping=v}z.flipY=false;for(var w=0,C=y.length;w<C;++w){var u=new Image();B[w]=u;u.onload=function(){B.loadCount+=1;s.ImageUtils.nbTexturesBeingLoaded--;if(B.loadCount===6){if(z.loadEndStatus!=="error"){z.loadEndStatus="complete"}z.needsUpdate=true;if(A){A(z)}}};u.onerror=function(){B.loadCount+=1;s.ImageUtils.nbTexturesBeingLoaded--;z.loadEndStatus="error";if(x){x()}};u.crossOrigin=this.crossOrigin;s.ImageUtils.nbTexturesBeingLoaded++;u.src=y[w]}return z},parseRadianceHDR:function(K,D,v,A,B){var w={data:null,width:0,height:0,format:v?s.RGBFormat:s.RGBAFormat,type:v?s.FloatType:s.UnsignedByteType};var O={offset:0,data:new Uint8Array(K)};var N,M;var Q="";for(N=0;N<10;N++){Q+=String.fromCharCode(O.data[O.offset++])}if(Q!=="#?RADIANCE"){return w}var P=0,x;while(true){x=P;P=O.data[O.offset++];if(P==10&&x==10){break}}var G="";while(true){P=O.data[O.offset++];if(P==10){break}G+=String.fromCharCode(P)}var H=new RegExp(/[-,+][X,Y]\s+([0-9]+)\s+[-,+][X,Y]\s+([0-9]+)/i);var I=H.exec(G);if(I===null){return w}w.height=RegExp.$1;w.width=RegExp.$2;if(v){w.data=new Float32Array(w.width*w.height*3)}else{w.data=new Uint8Array(w.width*w.height*4)}var L=new Uint8Array(4*w.width);var z=A?(w.height-1)*(v?3:4)*w.width:0;var F=function(y,T){var S=T*0.00390625;return S*y};var E=function(T,S,U,V){if(B){V+=3*(S-1)}while(S-->0){var y=Math.pow(2,T[4*S+3]-128);U[V++]=F(y,T[4*S]);U[V++]=F(y,T[4*S+1]);U[V++]=F(y,T[4*S+2]);if(B){V-=6}}};var R=function(S,y,T,U){while(y-->0){T[U++]=S[4*y];T[U++]=S[4*y+1];T[U++]=S[4*y+2];T[U++]=S[4*y+3]}};var u=function(X,y,S){var U,T;if(y<8||y>32767){return J(X,0,y,S)}U=S.data[S.offset];if(U!==2){return J(X,0,y,S)}S.offset++;X[1]=S.data[S.offset++];X[2]=S.data[S.offset++];U=S.data[S.offset++];if(X[1]!=2||(X[2]&128)){X[0]=2;X[3]=U;return J(X,1,y-1,S)}for(U=0;U<4;U++){for(T=0;T<y;){var V=S.data[S.offset++];if(V>128){V=V&127;var W=S.data[S.offset++];while(V--){X[4*T+U]=W;T++}}else{while(V--){X[4*T+U]=S.data[S.offset++];T++}}}}return !(S.data.length===S.offset)};var J=function(W,U,y,S){var T,V=0;while(y>0){W[4*U]=S.data[S.offset++];W[4*U+1]=S.data[S.offset++];W[4*U+2]=S.data[S.offset++];W[4*U+3]=S.data[S.offset++];if(W[4*U]===1&&W[4*U+1]===1&&W[4*U+2]===1){for(T=(W[4*U+3]<<V);T>0;T--){W[4*U]=W[4*(U-1)];W[4*U+1]=W[4*(U-1)+1];W[4*U+2]=W[4*(U-1)+2];W[4*U+3]=W[4*(U-1)+3];U++;y--}V+=8}else{U++;y--;V=0}}return true};for(var C=w.height-1;C>=0;C--){u(L,w.width,O);if(v){E(L,w.width,w.data,z);if(A){z-=3*w.width}else{z+=3*w.width}}else{R(L,w.width,w.data,z);z+=4*w.width}}return w},streamDDS:function(C){function A(M){return M.charCodeAt(0)+(M.charCodeAt(1)<<8)+(M.charCodeAt(2)<<16)+(M.charCodeAt(3)<<24)}var I=542327876;var J=128;var D=4;var K=1;var x=64;var w=A("DXT1");var v=A("DXT3");var u=A("DXT5");var z=0;for(var H=0;H<C.mipmaps.length;H++){z+=C.mipmaps[H].data.length}var B=new ArrayBuffer(J+z);var G=new Int32Array(B,0,J/4);G[0]=I;G[1]=J-4;G[2]=659463;G[3]=C.image.height;G[4]=C.image.width;G[5]=65536;G[7]=C.mipmaps.length;G[19]=32;G[20]=D;switch(C.format){case s.RGB_S3TC_DXT1_Format:G[21]=w;break;case s.RGB_S3TC_DXT3_Format:G[21]=v;break;case s.RGB_S3TC_DXT5_Format:G[21]=u;break;case s.RGBAFormat:G[20]|=K;case s.RGBFormat:G[20]|=x;G[23]=255;G[24]=65280;G[25]=16711680;G[26]=4278190080;break;default:console.error("ImageUtils.streamDDS(): Unsupported FourCC code: ");return}G[27]=4198408;var L=new Uint8Array(B,J,z);var y=0;for(var H=0;H<C.mipmaps.length;H++){var E=C.mipmaps[H].data;for(var F=0;F<E.length;F++){L[y+F]=E[F]}y+=E.length}return B}};s.SceneUtils={createMultiMaterialObject:function(y,v){var x=new s.Object3D();for(var w=0,u=v.length;w<u;w++){x.add(new s.Mesh(y,v[w]))}return x},detach:function(w,u,v){w.applyMatrix(u.matrixWorld);u.remove(w);v.add(w)},attach:function(x,w,u){var v=new s.Matrix4();v.getInverse(u.matrixWorld);x.applyMatrix(v);w.remove(x);u.add(x)}};s.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},loadFace:function(x){var u=x.familyName.toLowerCase();var v=this;v.faces[u]=v.faces[u]||{};v.faces[u][x.cssFontWeight]=v.faces[u][x.cssFontWeight]||{};v.faces[u][x.cssFontWeight][x.cssFontStyle]=x;var w=v.faces[u][x.cssFontWeight][x.cssFontStyle]=x;return x},drawText:function(G){var u=[],y=[];var C,w,E=this.getFace(),A=this.size/E.resolution,B=0,F=String(G).split(""),x=F.length;var z=[];for(C=0;C<x;C++){var H=new s.Path();var D=this.extractGlyphPoints(F[C],E,A,B,H);B+=D.offset;z.push(D.path)}var v=B/2;return{paths:z,offset:v}},extractGlyphPoints:function(T,D,X,A,L){var Y=[];var O,M,w,z,N,v,V,S,F,E,C,B,K,R,I,Q,H,P,u,G=D.glyphs[T]||D.glyphs["?"];if(!G){return}if(G.o){z=G._cachedOutline||(G._cachedOutline=G.o.split(" "));v=z.length;V=X;S=X;for(O=0;O<v;){N=z[O++];switch(N){case"m":F=z[O++]*V+A;E=z[O++]*S;L.moveTo(F,E);break;case"l":F=z[O++]*V+A;E=z[O++]*S;L.lineTo(F,E);break;case"q":C=z[O++]*V+A;B=z[O++]*S;I=z[O++]*V+A;Q=z[O++]*S;L.quadraticCurveTo(I,Q,C,B);u=Y[Y.length-1];if(u){K=u.x;R=u.y;for(M=1,w=this.divisions;M<=w;M++){var J=M/w;var W=s.Shape.Utils.b2(J,K,I,C);var U=s.Shape.Utils.b2(J,R,Q,B)}}break;case"b":C=z[O++]*V+A;B=z[O++]*S;I=z[O++]*V+A;Q=z[O++]*-S;H=z[O++]*V+A;P=z[O++]*-S;L.bezierCurveTo(C,B,I,Q,H,P);u=Y[Y.length-1];if(u){K=u.x;R=u.y;for(M=1,w=this.divisions;M<=w;M++){var J=M/w;var W=s.Shape.Utils.b3(J,K,I,H,C);var U=s.Shape.Utils.b3(J,R,Q,P,B)}}break}}}return{offset:G.ha*X,path:L}}};s.FontUtils.generateShapes=function(C,D){D=D||{};var F=D.size!==undefined?D.size:100;var B=D.curveSegments!==undefined?D.curveSegments:4;var x=D.font!==undefined?D.font:"helvetiker";var A=D.weight!==undefined?D.weight:"normal";var u=D.style!==undefined?D.style:"normal";s.FontUtils.size=F;s.FontUtils.divisions=B;s.FontUtils.face=x;s.FontUtils.weight=A;s.FontUtils.style=u;var z=s.FontUtils.drawText(C);var E=z.paths;var w=[];for(var v=0,y=E.length;v<y;v++){Array.prototype.push.apply(w,E[v].toShapes())}return w};(function(w){var v=1e-10;var y=function(A,K){var z=A.length;if(z<3){return null}var O=[],I=[],D=[];var L,J,H;if(x(A)>0){for(J=0;J<z;J++){I[J]=J}}else{for(J=0;J<z;J++){I[J]=(z-1)-J}}var C=z;var B=2*C;for(J=C-1;C>2;){if((B--)<=0){console.log("Warning, unable to triangulate polygon!");if(K){return D}return O}L=J;if(C<=L){L=0}J=L+1;if(C<=J){J=0}H=J+1;if(C<=H){H=0}if(u(A,L,J,H,C,I)){var G,F,E,N,M;G=I[L];F=I[J];E=I[H];O.push([A[G],A[F],A[E]]);D.push([I[L],I[J],I[H]]);for(N=J,M=J+1;M<C;N++,M++){I[N]=I[M]}C--;B=2*C}}if(K){return D}return O};var x=function(A){var D=A.length;var z=0;for(var C=D-1,B=0;B<D;C=B++){z+=A[C].x*A[B].y-A[B].x*A[C].y}return z*0.5};var u=function(V,P,O,L,U,ad){var T;var M,J,ab,Y;var C,A,S,R;M=V[ad[P]].x;J=V[ad[P]].y;ab=V[ad[O]].x;Y=V[ad[O]].y;C=V[ad[L]].x;A=V[ad[L]].y;if(v>(((ab-M)*(A-J))-((Y-J)*(C-M)))){return false}var B,z,N,K,ac,Z;var F,E,X,W,H,G;var D,I,Q;B=C-ab;z=A-Y;N=M-C;K=J-A;ac=ab-M;Z=Y-J;for(T=0;T<U;T++){if((T===P)||(T===O)||(T===L)){continue}S=V[ad[T]].x;R=V[ad[T]].y;F=S-M;E=R-J;X=S-ab;W=R-Y;H=S-C;G=R-A;Q=B*W-z*X;D=ac*E-Z*F;I=N*G-K*H;if((Q>=0)&&(I>=0)&&(D>=0)){return false}}return true};w.Triangulate=y;w.Triangulate.area=x;return w})(s.FontUtils);self._typeface_js={faces:s.FontUtils.faces,loadFace:s.FontUtils.loadFace};s.LineCurve=function(v,u){this.v1=v;this.v2=u};s.LineCurve.prototype=Object.create(s.Curve.prototype);s.LineCurve.prototype.getPoint=function(v){var u=this.v2.clone().sub(this.v1);u.multiplyScalar(v).add(this.v1);return u};s.LineCurve.prototype.getPointAt=function(v){return this.getPoint(v)};s.LineCurve.prototype.getTangent=function(u){var v=this.v2.clone().sub(this.v1);return v.normalize()};s.QuadraticBezierCurve=function(u,w,v){this.v0=u;this.v1=w;this.v2=v};s.QuadraticBezierCurve.prototype=Object.create(s.Curve.prototype);s.QuadraticBezierCurve.prototype.getPoint=function(w){var v,u;v=s.Shape.Utils.b2(w,this.v0.x,this.v1.x,this.v2.x);u=s.Shape.Utils.b2(w,this.v0.y,this.v1.y,this.v2.y);return new s.Vector2(v,u)};s.QuadraticBezierCurve.prototype.getTangent=function(w){var v,u;v=s.Curve.Utils.tangentQuadraticBezier(w,this.v0.x,this.v1.x,this.v2.x);u=s.Curve.Utils.tangentQuadraticBezier(w,this.v0.y,this.v1.y,this.v2.y);var x=new s.Vector2(v,u);x.normalize();return x};s.CubicBezierCurve=function(u,x,w,v){this.v0=u;this.v1=x;this.v2=w;this.v3=v};s.CubicBezierCurve.prototype=Object.create(s.Curve.prototype);s.CubicBezierCurve.prototype.getPoint=function(w){var v,u;v=s.Shape.Utils.b3(w,this.v0.x,this.v1.x,this.v2.x,this.v3.x);u=s.Shape.Utils.b3(w,this.v0.y,this.v1.y,this.v2.y,this.v3.y);return new s.Vector2(v,u)};s.CubicBezierCurve.prototype.getTangent=function(w){var v,u;v=s.Curve.Utils.tangentCubicBezier(w,this.v0.x,this.v1.x,this.v2.x,this.v3.x);u=s.Curve.Utils.tangentCubicBezier(w,this.v0.y,this.v1.y,this.v2.y,this.v3.y);var x=new s.Vector2(v,u);x.normalize();return x};s.SplineCurve=function(u){this.points=(u==undefined)?[]:u};s.SplineCurve.prototype=Object.create(s.Curve.prototype);s.SplineCurve.prototype.getPoint=function(x){var w=new s.Vector2();var B=[];var y=this.points,u,A,z;u=(y.length-1)*x;A=Math.floor(u);z=u-A;B[0]=A==0?A:A-1;B[1]=A;B[2]=A>y.length-2?y.length-1:A+1;B[3]=A>y.length-3?y.length-1:A+2;w.x=s.Curve.Utils.interpolate(y[B[0]].x,y[B[1]].x,y[B[2]].x,y[B[3]].x,z);w.y=s.Curve.Utils.interpolate(y[B[0]].y,y[B[1]].y,y[B[2]].y,y[B[3]].y,z);return w};s.EllipseCurve=function(z,y,A,u,x,w,v){this.aX=z;this.aY=y;this.xRadius=A;this.yRadius=u;this.aStartAngle=x;this.aEndAngle=w;this.aClockwise=v};s.EllipseCurve.prototype=Object.create(s.Curve.prototype);s.EllipseCurve.prototype.getPoint=function(w){var y=this.aEndAngle-this.aStartAngle;if(!this.aClockwise){w=1-w}var x=this.aStartAngle+w*y;var v=this.aX+this.xRadius*Math.cos(x);var u=this.aY+this.yRadius*Math.sin(x);return new s.Vector2(v,u)};s.Curve.Utils={tangentQuadraticBezier:function(u,x,w,v){return 2*(1-u)*(w-x)+2*u*(v-w)},tangentCubicBezier:function(u,y,x,w,v){return -3*y*(1-u)*(1-u)+3*x*(1-u)*(1-u)-6*u*x*(1-u)+6*u*w*(1-u)-3*u*u*w+3*u*u*v},tangentSpline:function(C,B,A,z,x){var y=6*C*C-6*C;var v=3*C*C-4*C+1;var w=-6*C*C+6*C;var u=3*C*C-2*C;return y+v+w+u},interpolate:function(B,A,y,x,C){var z=(y-B)*0.5;var w=(x-A)*0.5;var v=C*C;var u=C*v;return(2*A-2*y+z+w)*u+(-3*A+3*y-2*z-w)*v+z*C+A}};s.Curve.create=function(u,v){u.prototype=Object.create(s.Curve.prototype);u.prototype.getPoint=v;return u};s.LineCurve3=s.Curve.create(function(v,u){this.v1=v;this.v2=u},function(u){var v=new s.Vector3();v.subVectors(this.v2,this.v1);v.multiplyScalar(u);v.add(this.v1);return v});s.QuadraticBezierCurve3=s.Curve.create(function(u,w,v){this.v0=u;this.v1=w;this.v2=v},function(w){var v,u,x;v=s.Shape.Utils.b2(w,this.v0.x,this.v1.x,this.v2.x);u=s.Shape.Utils.b2(w,this.v0.y,this.v1.y,this.v2.y);x=s.Shape.Utils.b2(w,this.v0.z,this.v1.z,this.v2.z);return new s.Vector3(v,u,x)});s.CubicBezierCurve3=s.Curve.create(function(u,x,w,v){this.v0=u;this.v1=x;this.v2=w;this.v3=v},function(w){var v,u,x;v=s.Shape.Utils.b3(w,this.v0.x,this.v1.x,this.v2.x,this.v3.x);u=s.Shape.Utils.b3(w,this.v0.y,this.v1.y,this.v2.y,this.v3.y);x=s.Shape.Utils.b3(w,this.v0.z,this.v1.z,this.v2.z,this.v3.z);return new s.Vector3(v,u,x)});s.SplineCurve3=s.Curve.create(function(u){this.points=(u==undefined)?[]:u},function(F){var D=new s.Vector3();var x=[];var C=this.points,A,u,w;A=(C.length-1)*F;u=Math.floor(A);w=A-u;x[0]=u==0?u:u-1;x[1]=u;x[2]=u>C.length-2?C.length-1:u+1;x[3]=u>C.length-3?C.length-1:u+2;var E=C[x[0]],B=C[x[1]],z=C[x[2]],y=C[x[3]];D.x=s.Curve.Utils.interpolate(E.x,B.x,z.x,y.x,w);D.y=s.Curve.Utils.interpolate(E.y,B.y,z.y,y.y,w);D.z=s.Curve.Utils.interpolate(E.z,B.z,z.z,y.z,w);return D});s.ClosedSplineCurve3=s.Curve.create(function(u){this.points=(u==undefined)?[]:u},function(x){var w=new s.Vector3();var B=[];var y=this.points,u,A,z;u=(y.length-0)*x;A=Math.floor(u);z=u-A;A+=A>0?0:(Math.floor(Math.abs(A)/y.length)+1)*y.length;B[0]=(A-1)%y.length;B[1]=(A)%y.length;B[2]=(A+1)%y.length;B[3]=(A+2)%y.length;w.x=s.Curve.Utils.interpolate(y[B[0]].x,y[B[1]].x,y[B[2]].x,y[B[3]].x,z);w.y=s.Curve.Utils.interpolate(y[B[0]].y,y[B[1]].y,y[B[2]].y,y[B[3]].y,z);w.z=s.Curve.Utils.interpolate(y[B[0]].z,y[B[1]].z,y[B[2]].z,y[B[3]].z,z);return w});s.CurvePath=function(){this.curves=[];this.bends=[];this.autoClose=false};s.CurvePath.prototype=Object.create(s.Curve.prototype);s.CurvePath.prototype.add=function(u){this.curves.push(u)};s.CurvePath.prototype.checkConnection=function(){};s.CurvePath.prototype.closePath=function(){var v=this.curves[0].getPoint(0);var u=this.curves[this.curves.length-1].getPoint(1);if(!v.equals(u)){this.curves.push(new s.LineCurve(u,v))}};s.CurvePath.prototype.getPoint=function(x){var B=x*this.getLength();var A=this.getCurveLengths();var w=0,y,z;while(w<A.length){if(A[w]>=B){y=A[w]-B;z=this.curves[w];var v=1-y/z.getLength();return z.getPointAt(v);break}w++}return null};s.CurvePath.prototype.getLength=function(){var u=this.getCurveLengths();return u[u.length-1]};s.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length){return this.cacheLengths}var x=[],w=0;var v,u=this.curves.length;for(v=0;v<u;v++){w+=this.curves[v].getLength();x.push(w)}this.cacheLengths=x;return x};s.CurvePath.prototype.getBoundingBox=function(){var F=this.getPoints();var v,u,G;var z,y,x;v=u=Number.NEGATIVE_INFINITY;z=y=Number.POSITIVE_INFINITY;var w,A,E,B;var D=F[0] instanceof s.Vector3;B=D?new s.Vector3():new s.Vector2();for(A=0,E=F.length;A<E;A++){w=F[A];if(w.x>v){v=w.x}else{if(w.x<z){z=w.x}}if(w.y>u){u=w.y}else{if(w.y<y){y=w.y}}if(D){if(w.z>G){G=w.z}else{if(w.z<x){x=w.z}}}B.add(w)}var C={minX:z,minY:y,maxX:v,maxY:u,centroid:B.divideScalar(E)};if(D){C.maxZ=G;C.minZ=x}return C};s.CurvePath.prototype.createPointsGeometry=function(u){var v=this.getPoints(u,true);return this.createGeometry(v)};s.CurvePath.prototype.createSpacedPointsGeometry=function(u){var v=this.getSpacedPoints(u,true);return this.createGeometry(v)};s.CurvePath.prototype.createGeometry=function(v){var w=new s.Geometry();for(var u=0;u<v.length;u++){w.vertices.push(new s.Vector3(v[u].x,v[u].y,v[u].z||0))}return w};s.CurvePath.prototype.addWrapPath=function(u){this.bends.push(u)};s.CurvePath.prototype.getTransformedPoints=function(w,y){var v=this.getPoints(w);var x,u;if(!y){y=this.bends}for(x=0,u=y.length;x<u;x++){v=this.getWrapPoints(v,y[x])}return v};s.CurvePath.prototype.getTransformedSpacedPoints=function(w,y){var v=this.getSpacedPoints(w);var x,u;if(!y){y=this.bends}for(x=0,u=y.length;x<u;x++){v=this.getWrapPoints(v,y[x])}return v};s.CurvePath.prototype.getWrapPoints=function(z,E){var u=this.getBoundingBox();var x,A,v,C,B,D;for(x=0,A=z.length;x<A;x++){v=z[x];C=v.x;B=v.y;D=C/u.maxX;D=E.getUtoTmapping(D,C);var w=E.getPoint(D);var y=E.getNormalVector(D).multiplyScalar(B);v.x=w.x+y.x;v.y=w.y+y.y}return z};s.Path=function(u){s.CurvePath.call(this);this.actions=[];if(u){this.fromPoints(u)}};s.Path.prototype=Object.create(s.CurvePath.prototype);s.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"quadraticCurveTo",BEZIER_CURVE_TO:"bezierCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc",ELLIPSE:"ellipse"};s.Path.prototype.fromPoints=function(w){this.moveTo(w[0].x,w[0].y);for(var u=1,x=w.length;u<x;u++){this.lineTo(w[u].x,w[u].y)}};s.Path.prototype.moveTo=function(u,w){var v=Array.prototype.slice.call(arguments);this.actions.push({action:s.PathActions.MOVE_TO,args:v})};s.Path.prototype.lineTo=function(u,C){var v=Array.prototype.slice.call(arguments);var A=this.actions[this.actions.length-1].args;var w=A[A.length-2];var z=A[A.length-1];var B=new s.LineCurve(new s.Vector2(w,z),new s.Vector2(u,C));this.curves.push(B);this.actions.push({action:s.PathActions.LINE_TO,args:v})};s.Path.prototype.quadraticCurveTo=function(y,v,A,z){var B=Array.prototype.slice.call(arguments);var u=this.actions[this.actions.length-1].args;var w=u[u.length-2];var C=u[u.length-1];var x=new s.QuadraticBezierCurve(new s.Vector2(w,C),new s.Vector2(y,v),new s.Vector2(A,z));this.curves.push(x);this.actions.push({action:s.PathActions.QUADRATIC_CURVE_TO,args:B})};s.Path.prototype.bezierCurveTo=function(y,w,E,D,A,z){var B=Array.prototype.slice.call(arguments);var u=this.actions[this.actions.length-1].args;var v=u[u.length-2];var C=u[u.length-1];var x=new s.CubicBezierCurve(new s.Vector2(v,C),new s.Vector2(y,w),new s.Vector2(E,D),new s.Vector2(A,z));this.curves.push(x);this.actions.push({action:s.PathActions.BEZIER_CURVE_TO,args:B})};s.Path.prototype.splineThru=function(A){var u=Array.prototype.slice.call(arguments);var x=this.actions[this.actions.length-1].args;var v=x[x.length-2];var w=x[x.length-1];var z=[new s.Vector2(v,w)];Array.prototype.push.apply(z,A);var y=new s.SplineCurve(z);this.curves.push(y);this.actions.push({action:s.PathActions.CSPLINE_THRU,args:u})};s.Path.prototype.arc=function(B,z,A,x,u,v){var w=this.actions[this.actions.length-1].args;var y=w[w.length-2];var C=w[w.length-1];this.absarc(B+y,z+C,A,x,u,v)};s.Path.prototype.absarc=function(y,x,z,w,v,u){this.absellipse(y,x,z,z,w,v,u)};s.Path.prototype.ellipse=function(A,z,C,B,x,u,v){var w=this.actions[this.actions.length-1].args;var y=w[w.length-2];var D=w[w.length-1];this.absellipse(A+y,z+D,C,B,x,u,v)};s.Path.prototype.absellipse=function(z,y,D,A,w,u,v){var B=Array.prototype.slice.call(arguments);var x=new s.EllipseCurve(z,y,D,A,w,u,v);this.curves.push(x);var C=x.getPoint(v?1:0);B.push(C.x);B.push(C.y);this.actions.push({action:s.PathActions.ELLIPSE,args:B})};s.Path.prototype.getSpacedPoints=function(v,x){if(!v){v=40}var w=[];for(var u=0;u<v;u++){w.push(this.getPoint(u/v))}return w};s.Path.prototype.getPoints=function(af,ad){if(this.useSpacedPoints){console.log("tata");return this.getSpacedPoints(af,ad)}af=af||12;var Q=[];var Z,K,I,w,U;var R,O,ae,L,ag,M,u,N,v,Y,T,X,W;for(Z=0,K=this.actions.length;Z<K;Z++){I=this.actions[Z];w=I.action;U=I.args;switch(w){case s.PathActions.MOVE_TO:Q.push(new s.Vector2(U[0],U[1]));break;case s.PathActions.LINE_TO:Q.push(new s.Vector2(U[0],U[1]));break;case s.PathActions.QUADRATIC_CURVE_TO:R=U[2];O=U[3];ag=U[0];M=U[1];if(Q.length>0){v=Q[Q.length-1];u=v.x;N=v.y}else{v=this.actions[Z-1].args;u=v[v.length-2];N=v[v.length-1]}for(Y=1;Y<=af;Y++){T=Y/af;X=s.Shape.Utils.b2(T,u,ag,R);W=s.Shape.Utils.b2(T,N,M,O);Q.push(new s.Vector2(X,W))}break;case s.PathActions.BEZIER_CURVE_TO:R=U[4];O=U[5];ag=U[0];M=U[1];ae=U[2];L=U[3];if(Q.length>0){v=Q[Q.length-1];u=v.x;N=v.y}else{v=this.actions[Z-1].args;u=v[v.length-2];N=v[v.length-1]}for(Y=1;Y<=af;Y++){T=Y/af;X=s.Shape.Utils.b3(T,u,ag,ae,R);W=s.Shape.Utils.b3(T,N,M,L,O);Q.push(new s.Vector2(X,W))}break;case s.PathActions.CSPLINE_THRU:v=this.actions[Z-1].args;var C=new s.Vector2(v[v.length-2],v[v.length-1]);var z=[C];var V=af*U[0].length;z=z.concat(U[0]);var ac=new s.SplineCurve(z);for(Y=1;Y<=V;Y++){Q.push(ac.getPointAt(Y/V))}break;case s.PathActions.ARC:var F=U[0],E=U[1],G=U[2],ab=U[3],S=U[4],B=!!U[5];var P=S-ab;var D;var x=af*2;for(Y=1;Y<=x;Y++){T=Y/x;if(!B){T=1-T}D=ab+T*P;X=F+G*Math.cos(D);W=E+G*Math.sin(D);Q.push(new s.Vector2(X,W))}break;case s.PathActions.ELLIPSE:var F=U[0],E=U[1],H=U[2],J=U[3],ab=U[4],S=U[5],B=!!U[6];var P=S-ab;var D;var x=af*2;for(Y=1;Y<=x;Y++){T=Y/x;if(!B){T=1-T}D=ab+T*P;X=F+H*Math.cos(D);W=E+J*Math.sin(D);Q.push(new s.Vector2(X,W))}break}}var y=Q[Q.length-1];var A=1e-10;if(Math.abs(y.x-Q[0].x)<A&&Math.abs(y.y-Q[0].y)<A){Q.splice(Q.length-1,1)}if(ad){Q.push(Q[0])}return Q};s.Path.prototype.toShapes=function(){var w,z,C,v,x;var y=[],B=new s.Path();for(w=0,z=this.actions.length;w<z;w++){C=this.actions[w];x=C.args;v=C.action;if(v==s.PathActions.MOVE_TO){if(B.actions.length!=0){y.push(B);B=new s.Path()}}B[v].apply(B,x)}if(B.actions.length!=0){y.push(B)}if(y.length==0){return[]}var E,D,u=[];var A=!s.Shape.Utils.isClockWise(y[0].getPoints());if(y.length==1){E=y[0];D=new s.Shape();D.actions=E.actions;D.curves=E.curves;u.push(D);return u}if(A){D=new s.Shape();for(w=0,z=y.length;w<z;w++){E=y[w];if(s.Shape.Utils.isClockWise(E.getPoints())){D.actions=E.actions;D.curves=E.curves;u.push(D);D=new s.Shape()}else{D.holes.push(E)}}}else{for(w=0,z=y.length;w<z;w++){E=y[w];if(s.Shape.Utils.isClockWise(E.getPoints())){if(D){u.push(D)}D=new s.Shape();D.actions=E.actions;D.curves=E.curves}else{D.holes.push(E)}}u.push(D)}return u};s.Shape=function(){s.Path.apply(this,arguments);this.holes=[]};s.Shape.prototype=Object.create(s.Path.prototype);s.Shape.prototype.extrude=function(v){var u=new s.ExtrudeGeometry(this,v);return u};s.Shape.prototype.makeGeometry=function(u){var v=new s.ShapeGeometry(this,u);return v};s.Shape.prototype.getPointsHoles=function(w){var v,u=this.holes.length,x=[];for(v=0;v<u;v++){x[v]=this.holes[v].getTransformedPoints(w,this.bends)}return x};s.Shape.prototype.getSpacedPointsHoles=function(w){var v,u=this.holes.length,x=[];for(v=0;v<u;v++){x[v]=this.holes[v].getTransformedSpacedPoints(w,this.bends)}return x};s.Shape.prototype.extractAllPoints=function(u){return{shape:this.getTransformedPoints(u),holes:this.getPointsHoles(u)}};s.Shape.prototype.extractPoints=function(u){if(this.useSpacedPoints){return this.extractAllSpacedPoints(u)}return this.extractAllPoints(u)};s.Shape.prototype.extractAllSpacedPoints=function(u){return{shape:this.getTransformedSpacedPoints(u),holes:this.getSpacedPointsHoles(u)}};s.Shape.Utils={removeHoles:function(T,E){var C=T.concat();var R=C.concat();var O,w,K,ad,Q,L,S,A,ab,J,I,H,ae,U,G,F,ag,af,v,u,Z=[];for(ab=0;ab<E.length;ab++){I=E[ab];Array.prototype.push.apply(R,I);H=Number.POSITIVE_INFINITY;for(J=0;J<I.length;J++){G=I[J];var x=[];for(U=0;U<C.length;U++){F=C[U];ae=G.distanceToSquared(F);x.push(ae);if(ae<H){H=ae;Q=J;L=U}}}O=(L-1)>=0?L-1:C.length-1;K=(Q-1)>=0?Q-1:I.length-1;var y=[I[Q],C[L],C[O]];var Y=s.FontUtils.Triangulate.area(y);var P=[I[Q],I[K],C[L]];var X=s.FontUtils.Triangulate.area(P);var D=1;var V=-1;var M=L,W=Q;L+=D;Q+=V;if(L<0){L+=C.length}L%=C.length;if(Q<0){Q+=I.length}Q%=I.length;O=(L-1)>=0?L-1:C.length-1;K=(Q-1)>=0?Q-1:I.length-1;y=[I[Q],C[L],C[O]];var ac=s.FontUtils.Triangulate.area(y);P=[I[Q],I[K],C[L]];var N=s.FontUtils.Triangulate.area(P);if((Y+X)>(ac+N)){L=M;Q=W;if(L<0){L+=C.length}L%=C.length;if(Q<0){Q+=I.length}Q%=I.length;O=(L-1)>=0?L-1:C.length-1;K=(Q-1)>=0?Q-1:I.length-1}else{}ag=C.slice(0,L);af=C.slice(L);v=I.slice(Q);u=I.slice(0,Q);var B=[I[Q],C[L],C[O]];var z=[I[Q],I[K],C[L]];Z.push(B);Z.push(z);C=ag.concat(v).concat(u).concat(af)}return{shape:C,isolatedPts:Z,allpoints:R}},triangulateShape:function(x,w){var A=s.Shape.Utils.removeHoles(x,w);var D=A.shape,u=A.allpoints,G=A.isolatedPts;var v=s.FontUtils.Triangulate(D,false);var y,F,C,E,H,B,z={},I={};for(y=0,F=u.length;y<F;y++){H=u[y].x+":"+u[y].y;if(z[H]!==undefined){console.log("Duplicate point",H)}z[H]=y}for(y=0,F=v.length;y<F;y++){E=v[y];for(C=0;C<3;C++){H=E[C].x+":"+E[C].y;B=z[H];if(B!==undefined){E[C]=B}}}for(y=0,F=G.length;y<F;y++){E=G[y];for(C=0;C<3;C++){H=E[C].x+":"+E[C].y;B=z[H];if(B!==undefined){E[C]=B}}}return v.concat(G)},isClockWise:function(u){return s.FontUtils.Triangulate.area(u)<0},b2p0:function(v,w){var u=1-v;return u*u*w},b2p1:function(u,v){return 2*(1-u)*u*v},b2p2:function(u,v){return u*u*v},b2:function(u,x,w,v){return this.b2p0(u,x)+this.b2p1(u,w)+this.b2p2(u,v)},b3p0:function(v,w){var u=1-v;return u*u*u*w},b3p1:function(v,w){var u=1-v;return 3*u*u*v*w},b3p2:function(v,w){var u=1-v;return 3*u*v*v*w},b3p3:function(u,v){return u*u*u*v},b3:function(u,y,x,w,v){return this.b3p0(u,y)+this.b3p1(u,x)+this.b3p2(u,w)+this.b3p3(u,v)}};s.CircleGeometry=function(D,A,x,v){s.Geometry.call(this);D=D||50;x=x!==undefined?x:0;v=v!==undefined?v:Math.PI*2;A=A!==undefined?Math.max(3,A):8;var z,y=[],u=new s.Vector3(),G=new s.Vector2(0.5,0.5);this.vertices.push(u);y.push(G);for(z=0;z<=A;z++){var C=new s.Vector3();var B=x+z/A*v;C.x=D*Math.cos(B);C.y=D*Math.sin(B);this.vertices.push(C);y.push(new s.Vector2((C.x/D+1)/2,-(C.y/D+1)/2+1))}var w=new s.Vector3(0,0,-1);for(z=1;z<=A;z++){var H=z;var F=z+1;var E=0;this.faces.push(new s.Face3(H,F,E,[w,w,w]));this.faceVertexUvs[0].push([y[z],y[z+1],G])}this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new s.Sphere(new s.Vector3(),D)};s.CircleGeometry.prototype=Object.create(s.Geometry.prototype);s.CubeGeometry=function(u,C,y,v,B,x){s.Geometry.call(this);var E=this;this.width=u;this.height=C;this.depth=y;this.widthSegments=v||1;this.heightSegments=B||1;this.depthSegments=x||1;var D=this.width/2;var A=this.height/2;var w=this.depth/2;z("z","y",-1,-1,this.depth,this.height,D,0);z("z","y",1,-1,this.depth,this.height,-D,1);z("x","z",1,1,this.width,this.depth,A,2);z("x","z",1,-1,this.width,this.depth,-A,3);z("x","y",1,-1,this.width,this.height,w,4);z("x","y",-1,-1,this.width,this.height,-w,5);function z(S,R,F,M,U,T,ag,O){var Q,K,J,W=E.widthSegments,V=E.heightSegments,L=U/2,I=T/2,N=E.vertices.length;if((S==="x"&&R==="y")||(S==="y"&&R==="x")){Q="z"}else{if((S==="x"&&R==="z")||(S==="z"&&R==="x")){Q="y";V=E.depthSegments}else{if((S==="z"&&R==="y")||(S==="y"&&R==="z")){Q="x";W=E.depthSegments}}}var X=W+1,H=V+1,af=U/W,Z=T/V,ae=new s.Vector3();ae[Q]=ag>0?1:-1;for(J=0;J<H;J++){for(K=0;K<X;K++){var G=new s.Vector3();G[S]=(K*af-L)*F;G[R]=(J*Z-I)*M;G[Q]=ag;E.vertices.push(G)}}for(J=0;J<V;J++){for(K=0;K<W;K++){var ad=K+X*J;var ac=K+X*(J+1);var ab=(K+1)+X*(J+1);var Y=(K+1)+X*J;var P=new s.Face4(ad+N,ac+N,ab+N,Y+N);P.normal.copy(ae);P.vertexNormals.push(ae.clone(),ae.clone(),ae.clone(),ae.clone());P.materialIndex=O;E.faces.push(P);E.faceVertexUvs[0].push([new s.Vector2(K/W,1-J/V),new s.Vector2(K/W,1-(J+1)/V),new s.Vector2((K+1)/W,1-(J+1)/V),new s.Vector2((K+1)/W,1-J/V)])}}}this.computeCentroids();this.mergeVertices()};s.CubeGeometry.prototype=Object.create(s.Geometry.prototype);s.CylinderGeometry=function(H,ag,T,W,Q,ad){s.Geometry.call(this);H=H!==undefined?H:20;ag=ag!==undefined?ag:20;T=T!==undefined?T:100;var V=T/2;var U=W||8;var S=Q||1;var M,L,D=[],N=[];for(L=0;L<=S;L++){var R=[];var af=[];var O=L/S;var C=O*(ag-H)+H;for(M=0;M<=U;M++){var P=M/U;var ab=new s.Vector3();ab.x=C*Math.sin(P*Math.PI*2);ab.y=-O*T+V;ab.z=C*Math.cos(P*Math.PI*2);this.vertices.push(ab);R.push(this.vertices.length-1);af.push(new s.Vector2(P,1-O))}D.push(R);N.push(af)}var Y=(ag-H)/T;var J,G;for(M=0;M<U;M++){if(H!==0){J=this.vertices[D[0][M]].clone();G=this.vertices[D[0][M+1]].clone()}else{J=this.vertices[D[1][M]].clone();G=this.vertices[D[1][M+1]].clone()}J.setY(Math.sqrt(J.x*J.x+J.z*J.z)*Y).normalize();G.setY(Math.sqrt(G.x*G.x+G.z*G.z)*Y).normalize();for(L=0;L<S;L++){var B=D[L][M];var A=D[L+1][M];var z=D[L+1][M+1];var w=D[L][M+1];var K=J.clone();var I=J.clone();var F=G.clone();var E=G.clone();var ae=N[L][M].clone();var ac=N[L+1][M].clone();var Z=N[L+1][M+1].clone();var X=N[L][M+1].clone();this.faces.push(new s.Face4(B,A,z,w,[K,I,F,E]));this.faceVertexUvs[0].push([ae,ac,Z,X])}}if(!ad&&H>0){this.vertices.push(new s.Vector3(0,V,0));for(M=0;M<U;M++){var B=D[0][M];var A=D[0][M+1];var z=this.vertices.length-1;var K=new s.Vector3(0,1,0);var I=new s.Vector3(0,1,0);var F=new s.Vector3(0,1,0);var ae=N[0][M].clone();var ac=N[0][M+1].clone();var Z=new s.Vector2(ac.u,0);this.faces.push(new s.Face3(B,A,z,[K,I,F]));this.faceVertexUvs[0].push([ae,ac,Z])}}if(!ad&&ag>0){this.vertices.push(new s.Vector3(0,-V,0));for(M=0;M<U;M++){var B=D[L][M+1];var A=D[L][M];var z=this.vertices.length-1;var K=new s.Vector3(0,-1,0);var I=new s.Vector3(0,-1,0);var F=new s.Vector3(0,-1,0);var ae=N[L][M+1].clone();var ac=N[L][M].clone();var Z=new s.Vector2(ac.u,1);this.faces.push(new s.Face3(B,A,z,[K,I,F]));this.faceVertexUvs[0].push([ae,ac,Z])}}this.computeCentroids();this.computeFaceNormals()};s.CylinderGeometry.prototype=Object.create(s.Geometry.prototype);s.ExtrudeGeometry=function(u,v){if(typeof(u)==="undefined"){u=[];return}s.Geometry.call(this);u=u instanceof Array?u:[u];this.shapebb=u[u.length-1].getBoundingBox();this.addShapeList(u,v);this.computeCentroids();this.computeFaceNormals()};s.ExtrudeGeometry.prototype=Object.create(s.Geometry.prototype);s.ExtrudeGeometry.prototype.addShapeList=function(v,x){var u=v.length;for(var y=0;y<u;y++){var w=v[y];this.addShape(w,x)}};s.ExtrudeGeometry.prototype.addShape=function(R,ab){var B=ab.amount!==undefined?ab.amount:100;var A=ab.bevelThickness!==undefined?ab.bevelThickness:6;var ac=ab.bevelSize!==undefined?ab.bevelSize:A-2;var O=ab.bevelSegments!==undefined?ab.bevelSegments:3;var u=ab.bevelEnabled!==undefined?ab.bevelEnabled:true;var Z=ab.curveSegments!==undefined?ab.curveSegments:12;var al=ab.steps!==undefined?ab.steps:1;var I=ab.extrudePath;var ag,J=false;var az=ab.material;var F=ab.extrudeMaterial;var Q=ab.UVGenerator!==undefined?ab.UVGenerator:s.ExtrudeGeometry.WorldUVGenerator;var ak=this.shapebb;var L,ao,at,aH;if(I){ag=I.getSpacedPoints(al);J=true;u=false;L=ab.frames!==undefined?ab.frames:new s.TubeGeometry.FrenetFrames(I,al,false);ao=new s.Vector3();at=new s.Vector3();aH=new s.Vector3()}if(!u){O=0;A=0;ac=0}var aK,aF,aG;var am=this;var X=[];var ai=this.vertices.length;var P=R.extractPoints(Z);var x=P.shape;var V=P.holes;var av=!s.Shape.Utils.isClockWise(x);if(av){x=x.reverse();for(aF=0,aG=V.length;aF<aG;aF++){aK=V[aF];if(s.Shape.Utils.isClockWise(aK)){V[aF]=aK.reverse()}}av=false}var H=s.Shape.Utils.triangulateShape(x,V);var ay=x;for(aF=0,aG=V.length;aF<aG;aF++){aK=V[aF];x=x.concat(aK)}function ad(aL,z,v){if(!z){console.log("die")}return z.clone().multiplyScalar(v).add(aL)}var aJ,aw,ar,an,K,ax=x.length,G,E=H.length,aj,w=ay.length;var ah=180/Math.PI;function T(aL,z,v){return M(aL,z,v)}function N(aM,aL,z){var aP=Math.atan2(aL.y-aM.y,aL.x-aM.x);var aO=Math.atan2(z.y-aM.y,z.x-aM.x);if(aP>aO){aO+=Math.PI*2}var aN=(aP+aO)/2;var aR=-Math.cos(aN);var aQ=-Math.sin(aN);var v=new s.Vector2(aR,aQ);return v}function M(aQ,aP,aO){var aV=s.ExtrudeGeometry.__v1,aS=s.ExtrudeGeometry.__v2,aU=s.ExtrudeGeometry.__v3,aR=s.ExtrudeGeometry.__v4,aM=s.ExtrudeGeometry.__v5,aL=s.ExtrudeGeometry.__v6,aX,aW,aN,aT,aY,z;aV.set(aQ.x-aP.x,aQ.y-aP.y);aS.set(aQ.x-aO.x,aQ.y-aO.y);aX=aV.normalize();aW=aS.normalize();aU.set(-aX.y,aX.x);aR.set(aW.y,-aW.x);aM.copy(aQ).add(aU);aL.copy(aQ).add(aR);if(aM.equals(aL)){return aR.clone()}aM.copy(aP).add(aU);aL.copy(aO).add(aR);aN=aX.dot(aR);aT=aL.sub(aM).dot(aR);if(aN===0){console.log("Either infinite or no solutions!");if(aT===0){console.log("Its finite solutions.")}else{console.log("Too bad, no solutions.")}}aY=aT/aN;if(aY<0){return N(aQ,aP,aO)}z=aX.multiplyScalar(aY).add(aM);return z.sub(aQ).clone()}var aC=[];for(var aE=0,af=ay.length,aB=af-1,aA=aE+1;aE<af;aE++,aB++,aA++){if(aB===af){aB=0}if(aA===af){aA=0}var W=ay[aE];var U=ay[aB];var S=ay[aA];aC[aE]=T(ay[aE],ay[aB],ay[aA])}var ae=[],aq,y=aC.concat();for(aF=0,aG=V.length;aF<aG;aF++){aK=V[aF];aq=[];for(aE=0,af=aK.length,aB=af-1,aA=aE+1;aE<af;aE++,aB++,aA++){if(aB===af){aB=0}if(aA===af){aA=0}aq[aE]=T(aK[aE],aK[aB],aK[aA])}ae.push(aq);y=y.concat(aq)}for(aJ=0;aJ<O;aJ++){ar=aJ/O;an=A*(1-ar);aw=ac*(Math.sin(ar*Math.PI/2));for(aE=0,af=ay.length;aE<af;aE++){K=ad(ay[aE],aC[aE],aw);ap(K.x,K.y,-an)}for(aF=0,aG=V.length;aF<aG;aF++){aK=V[aF];aq=ae[aF];for(aE=0,af=aK.length;aE<af;aE++){K=ad(aK[aE],aq[aE],aw);ap(K.x,K.y,-an)}}}aw=ac;for(aE=0;aE<ax;aE++){K=u?ad(x[aE],y[aE],aw):x[aE];if(!J){ap(K.x,K.y,0)}else{at.copy(L.normals[0]).multiplyScalar(K.x);ao.copy(L.binormals[0]).multiplyScalar(K.y);aH.copy(ag[0]).add(at).add(ao);ap(aH.x,aH.y,aH.z)}}var au;for(au=1;au<=al;au++){for(aE=0;aE<ax;aE++){K=u?ad(x[aE],y[aE],aw):x[aE];if(!J){ap(K.x,K.y,B/al*au)}else{at.copy(L.normals[au]).multiplyScalar(K.x);ao.copy(L.binormals[au]).multiplyScalar(K.y);aH.copy(ag[au]).add(at).add(ao);ap(aH.x,aH.y,aH.z)}}}for(aJ=O-1;aJ>=0;aJ--){ar=aJ/O;an=A*(1-ar);aw=ac*Math.sin(ar*Math.PI/2);for(aE=0,af=ay.length;aE<af;aE++){K=ad(ay[aE],aC[aE],aw);ap(K.x,K.y,B+an)}for(aF=0,aG=V.length;aF<aG;aF++){aK=V[aF];aq=ae[aF];for(aE=0,af=aK.length;aE<af;aE++){K=ad(aK[aE],aq[aE],aw);if(!J){ap(K.x,K.y,B+an)}else{ap(K.x,K.y+ag[al-1].y,ag[al-1].x+an)}}}}Y();aI();function Y(){if(u){var v=0;var z=ax*v;for(aE=0;aE<E;aE++){G=H[aE];D(G[2]+z,G[1]+z,G[0]+z,true)}v=al+O*2;z=ax*v;for(aE=0;aE<E;aE++){G=H[aE];D(G[0]+z,G[1]+z,G[2]+z,false)}}else{for(aE=0;aE<E;aE++){G=H[aE];D(G[2],G[1],G[0],true)}for(aE=0;aE<E;aE++){G=H[aE];D(G[0]+ax*al,G[1]+ax*al,G[2]+ax*al,false)}}}function aI(){var v=0;aD(ay,v);v+=ay.length;for(aF=0,aG=V.length;aF<aG;aF++){aK=V[aF];aD(aK,v);v+=aK.length}}function aD(aP,v){var aN,aM;aE=aP.length;while(--aE>=0){aN=aE;aM=aE-1;if(aM<0){aM=aP.length-1}var aU=0,z=al+O*2;for(aU=0;aU<z;aU++){var aO=ax*aU;var aL=ax*(aU+1);var aT=v+aN+aO,aS=v+aM+aO,aR=v+aM+aL,aQ=v+aN+aL;C(aT,aS,aR,aQ,aP,aU,z,aN,aM)}}}function ap(v,aM,aL){am.vertices.push(new s.Vector3(v,aM,aL))}function D(z,v,aN,aM){z+=ai;v+=ai;aN+=ai;am.faces.push(new s.Face3(z,v,aN,null,null,az));var aL=aM?Q.generateBottomUV(am,R,ab,z,v,aN):Q.generateTopUV(am,R,ab,z,v,aN);am.faceVertexUvs[0].push(aL)}function C(aR,aQ,aO,aN,v,aL,aS,aP,aM){aR+=ai;aQ+=ai;aO+=ai;aN+=ai;am.faces.push(new s.Face4(aR,aQ,aO,aN,null,null,F));var z=Q.generateSideWallUV(am,R,v,ab,aR,aQ,aO,aN,aL,aS,aP,aM);am.faceVertexUvs[0].push(z)}};s.ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(A,B,x,E,D,C){var u=A.vertices[E].x,F=A.vertices[E].y,z=A.vertices[D].x,y=A.vertices[D].y,w=A.vertices[C].x,v=A.vertices[C].y;return[new s.Vector2(u,F),new s.Vector2(z,y),new s.Vector2(w,v)]},generateBottomUV:function(z,w,u,y,x,v){return this.generateTopUV(z,w,u,y,x,v)},generateSideWallUV:function(z,G,v,N,R,Q,P,O,u,H,M,L){var E=z.vertices[R].x,C=z.vertices[R].y,A=z.vertices[R].z,K=z.vertices[Q].x,J=z.vertices[Q].y,I=z.vertices[Q].z,y=z.vertices[P].x,x=z.vertices[P].y,w=z.vertices[P].z,F=z.vertices[O].x,D=z.vertices[O].y,B=z.vertices[O].z;if(Math.abs(C-J)<0.01){return[new s.Vector2(E,1-A),new s.Vector2(K,1-I),new s.Vector2(y,1-w),new s.Vector2(F,1-B)]}else{return[new s.Vector2(C,1-A),new s.Vector2(J,1-I),new s.Vector2(x,1-w),new s.Vector2(D,1-B)]}}};s.ExtrudeGeometry.__v1=new s.Vector2();s.ExtrudeGeometry.__v2=new s.Vector2();s.ExtrudeGeometry.__v3=new s.Vector2();s.ExtrudeGeometry.__v4=new s.Vector2();s.ExtrudeGeometry.__v5=new s.Vector2();s.ExtrudeGeometry.__v6=new s.Vector2();s.ShapeGeometry=function(u,v){s.Geometry.call(this);if(u instanceof Array===false){u=[u]}this.shapebb=u[u.length-1].getBoundingBox();this.addShapeList(u,v);this.computeCentroids();this.computeFaceNormals()};s.ShapeGeometry.prototype=Object.create(s.Geometry.prototype);s.ShapeGeometry.prototype.addShapeList=function(v,w){for(var x=0,u=v.length;x<u;x++){this.addShape(v[x],w)}return this};s.ShapeGeometry.prototype.addShape=function(v,y){if(y===undefined){y={}}var u=y.curveSegments!==undefined?y.curveSegments:12;var F=y.material;var O=y.UVGenerator===undefined?s.ExtrudeGeometry.WorldUVGenerator:y.UVGenerator;var G=this.shapebb;var M,L,H,J;var E=this.vertices.length;var P=v.extractPoints(u);var z=P.shape;var B=P.holes;var D=!s.Shape.Utils.isClockWise(z);if(D){z=z.reverse();for(M=0,L=B.length;M<L;M++){H=B[M];if(s.Shape.Utils.isClockWise(H)){B[M]=H.reverse()}}D=false}var w=s.Shape.Utils.triangulateShape(z,B);var K=z;for(M=0,L=B.length;M<L;M++){H=B[M];z=z.concat(H)}var N,A=z.length;var C,T=w.length;var x,I=K.length;for(M=0;M<A;M++){N=z[M];this.vertices.push(new s.Vector3(N.x,N.y,0))}for(M=0;M<T;M++){C=w[M];var S=C[0]+E;var R=C[1]+E;var Q=C[2]+E;this.faces.push(new s.Face3(S,R,Q,null,null,F));this.faceVertexUvs[0].push(O.generateBottomUV(this,v,y,S,R,Q))}};s.PlaneGeometry=function(H,G,u,F){s.Geometry.call(this);this.width=H;this.height=G;this.widthSegments=u||1;this.heightSegments=F||1;var z,v;var A=H/2;var w=G/2;var J=this.widthSegments;var I=this.heightSegments;var K=J+1;var E=I+1;var R=this.width/J;var M=this.height/I;var Q=new s.Vector3(0,0,1);for(v=0;v<E;v++){for(z=0;z<K;z++){var D=z*R-A;var C=v*M-w;this.vertices.push(new s.Vector3(D,-C,0))}}for(v=0;v<I;v++){for(z=0;z<J;z++){var P=z+K*v;var O=z+K*(v+1);var N=(z+1)+K*(v+1);var L=(z+1)+K*v;var B=new s.Face4(P,O,N,L);B.normal.copy(Q);B.vertexNormals.push(Q.clone(),Q.clone(),Q.clone(),Q.clone());this.faces.push(B);this.faceVertexUvs[0].push([new s.Vector2(z/J,1-v/I),new s.Vector2(z/J,1-(v+1)/I),new s.Vector2((z+1)/J,1-(v+1)/I),new s.Vector2((z+1)/J,1-v/I)])}}this.computeCentroids()};s.PlaneGeometry.prototype=Object.create(s.Geometry.prototype);s.SphereGeometry=function(D,C,P,R,T,E,S){s.Geometry.call(this);this.radius=D||50;this.widthSegments=Math.max(3,Math.floor(C)||8);this.heightSegments=Math.max(2,Math.floor(P)||6);R=R!==undefined?R:0;T=T!==undefined?T:Math.PI*2;E=E!==undefined?E:0;S=S!==undefined?S:Math.PI;var L,K,F=[],M=[];for(K=0;K<=this.heightSegments;K++){var Q=[];var Z=[];for(L=0;L<=this.widthSegments;L++){var O=L/this.widthSegments;var N=K/this.heightSegments;var W=new s.Vector3();W.x=-this.radius*Math.cos(R+O*T)*Math.sin(E+N*S);W.y=this.radius*Math.cos(E+N*S);W.z=this.radius*Math.sin(R+O*T)*Math.sin(E+N*S);this.vertices.push(W);Q.push(this.vertices.length-1);Z.push(new s.Vector2(O,1-N))}F.push(Q);M.push(Z)}for(K=0;K<this.heightSegments;K++){for(L=0;L<this.widthSegments;L++){var B=F[K][L+1];var A=F[K][L];var z=F[K+1][L];var w=F[K+1][L+1];var J=this.vertices[B].clone().normalize();var I=this.vertices[A].clone().normalize();var H=this.vertices[z].clone().normalize();var G=this.vertices[w].clone().normalize();var Y=M[K][L+1].clone();var X=M[K][L].clone();var V=M[K+1][L].clone();var U=M[K+1][L+1].clone();if(Math.abs(this.vertices[B].y)===this.radius){this.faces.push(new s.Face3(B,z,w,[J,H,G]));this.faceVertexUvs[0].push([Y,V,U])}else{if(Math.abs(this.vertices[z].y)===this.radius){this.faces.push(new s.Face3(B,A,z,[J,I,H]));this.faceVertexUvs[0].push([Y,X,V])}else{this.faces.push(new s.Face4(B,A,z,w,[J,I,H,G]));this.faceVertexUvs[0].push([Y,X,V,U])}}}}this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new s.Sphere(new s.Vector3(),D)};s.SphereGeometry.prototype=Object.create(s.Geometry.prototype);s.TextGeometry=function(v,u){var w=s.FontUtils.generateShapes(v,u);u.amount=u.height!==undefined?u.height:50;if(u.bevelThickness===undefined){u.bevelThickness=10}if(u.bevelSize===undefined){u.bevelSize=8}if(u.bevelEnabled===undefined){u.bevelEnabled=false}s.ExtrudeGeometry.call(this,w,u)};s.TextGeometry.prototype=Object.create(s.ExtrudeGeometry.prototype);s.CameraHelper=function(y){s.Line.call(this);var A=this;this.geometry=new s.Geometry();this.material=new s.LineBasicMaterial({color:16777215,vertexColors:s.FaceColors});this.type=s.LinePieces;this.matrixWorld=y.matrixWorld;this.matrixAutoUpdate=false;this.frustumCulled=false;this.pointMap={};var x=16755200;var C=16711680;var v=43775;var z=16777215;var w=3355443;B("n1","n2",x);B("n2","n4",x);B("n4","n3",x);B("n3","n1",x);B("f1","f2",x);B("f2","f4",x);B("f4","f3",x);B("f3","f1",x);B("n1","f1",x);B("n2","f2",x);B("n3","f3",x);B("n4","f4",x);B("p","n1",C);B("p","n2",C);B("p","n3",C);B("p","n4",C);B("u1","u2",v);B("u2","u3",v);B("u3","u1",v);B("c","t",z);B("p","c",w);B("cn1","cn2",w);B("cn3","cn4",w);B("cf1","cf2",w);B("cf3","cf4",w);this.camera=y;function B(E,D,F){u(E,F);u(D,F)}function u(E,D){A.geometry.vertices.push(new s.Vector3());A.geometry.colors.push(new s.Color(D));if(A.pointMap[E]===undefined){A.pointMap[E]=[]}A.pointMap[E].push(A.geometry.vertices.length-1)}this.update(y)};s.CameraHelper.prototype=Object.create(s.Line.prototype);s.CameraHelper.prototype.update=function(){var y=this;var u=1,x=1;s.CameraHelper.__c.projectionMatrix.copy(this.camera.projectionMatrix);v("c",0,0,-1);v("t",0,0,1);v("n1",-u,-x,-1);v("n2",u,-x,-1);v("n3",-u,x,-1);v("n4",u,x,-1);v("f1",-u,-x,1);v("f2",u,-x,1);v("f3",-u,x,1);v("f4",u,x,1);v("u1",u*0.7,x*1.1,-1);v("u2",-u*0.7,x*1.1,-1);v("u3",0,x*2,-1);v("cf1",-u,0,1);v("cf2",u,0,1);v("cf3",0,-x,1);v("cf4",0,x,1);v("cn1",-u,0,-1);v("cn2",u,0,-1);v("cn3",0,-x,-1);v("cn4",0,x,-1);function v(A,w,F,E){s.CameraHelper.__v.set(w,F,E);s.CameraHelper.__projector.unprojectVector(s.CameraHelper.__v,s.CameraHelper.__c);var D=y.pointMap[A];if(D!==undefined){for(var C=0,B=D.length;C<B;C++){y.geometry.vertices[D[C]].copy(s.CameraHelper.__v)}}}this.geometry.verticesNeedUpdate=true};s.CameraHelper.__projector=new s.Projector();s.CameraHelper.__v=new s.Vector3();s.CameraHelper.__c=new s.Camera();s.LensFlare=function(x,v,y,w,u){s.Object3D.call(this);this.lensFlares=[];this.positionScreen=new s.Vector3();this.customUpdateCallback=undefined;if(x!==undefined){this.add(x,v,y,w,u)}};s.LensFlare.prototype=Object.create(s.Object3D.prototype);s.LensFlare.prototype.add=function(y,w,z,x,u,v){if(w===undefined){w=-1}if(z===undefined){z=0}if(v===undefined){v=1}if(u===undefined){u=new s.Color(16777215)}if(x===undefined){x=s.NormalBlending}z=Math.min(z,Math.max(0,z));this.lensFlares.push({texture:y,size:w,distance:z,x:0,y:0,z:0,scale:1,rotation:1,opacity:v,color:u,blending:x})};s.LensFlare.prototype.updateLensFlares=function(){var x,w=this.lensFlares.length;var v;var u=-this.positionScreen.x*2;var y=-this.positionScreen.y*2;for(x=0;x<w;x++){v=this.lensFlares[x];v.x=this.positionScreen.x+u*v.distance;v.y=this.positionScreen.y+y*v.distance;v.wantedRotation=v.x*Math.PI*0.25;v.rotation+=(v.wantedRotation-v.rotation)*0.25}};s.ShadowMapPlugin=function(){var B,K,G,M,v,y,J=new s.Frustum(),x=new s.Matrix4(),I=new s.Vector3(),L=new s.Vector3(),C=new s.Vector3();this.noRenderTarget=true;this.msaaOffset=[];for(var F=0;F<128;F++){var z=s.RandomLib.LowDiscrepancy2D(F);this.msaaOffset.push({x:z.x-0.5,y:z.y-0.5})}this.init=function(Q){B=Q.context;K=Q;var O=s.ShaderLib.depthRGBA;var P=s.UniformsUtils.clone(O.uniforms);G=new s.ShaderMaterial({fragmentShader:O.fragmentShader,vertexShader:O.vertexShader,uniforms:P});M=new s.ShaderMaterial({fragmentShader:O.fragmentShader,vertexShader:O.vertexShader,uniforms:P,morphTargets:true});v=new s.ShaderMaterial({fragmentShader:O.fragmentShader,vertexShader:O.vertexShader,uniforms:P,skinning:true});y=new s.ShaderMaterial({fragmentShader:O.fragmentShader,vertexShader:O.vertexShader,uniforms:P,morphTargets:true,skinning:true});G.side=a.DoubleSide;G._shadowPass=true;G.enableClipPlanes=true;M._shadowPass=true;v.side=a.DoubleSide;v._shadowPass=true;y._shadowPass=true};this.dispose=function(){};this.render=function(R,Q,P,O){if(!(K.shadowMapEnabled&&K.shadowMapAutoUpdate)){return}this.update(R,Q,P,O)};this.updateShaders=function(){G.needsUpdate=true;M.needsUpdate=true;v.needsUpdate=true;y.needsUpdate=true};this.update=function(ah,a0,ay,ae){var ax,ak,av,Y,ap,S,aW,R,aN,aJ,a8,a3,aT,aH,aY,Q=[],au=0,Z=null;B.disable(B.BLEND);B.enable(B.CULL_FACE);B.frontFace(B.CCW);if(K.shadowMapCullFace===s.CullFaceFront){B.cullFace(B.FRONT)}else{B.cullFace(B.BACK)}K.setDepthTest(true);var O=K.getScissorTest();K.enableScissorTest(false);var a2=null;var aX=null;if(!ah.boundingBox){for(var ar=0;ar<ah.children.length;ar++){var aM=ah.children[ar];if(aM.boundingSphere){aX=aM.boundingSphere}if(aM.boundingBox){a2=aM.boundingBox;break}}if(!a2&&aX){a2=aX.getBoundingBox()}}else{a2=ah.boundingBox}if(!a2){return}var aw=new s.Matrix4();aw.multiplyMatrices(a0.projectionMatrix,a0.matrixWorldInverse);J.setFromMatrix(aw);var aA=J.getCorners();var aC=new s.CGPoly();aC.setFromFrustumPoints(aA);var ag=a2.getPlanes();var a9=aC.clipByPlanes(ag);ah.__lights.sort(ah._lightSort);for(ax=0,ak=ah.__lights.length;ax<ak;ax++){aH=ah.__lights[ax];if(!aH.castShadow&&!aH.castGroundShadow){continue}if(aH.isVirtual){continue}if((aH instanceof s.DirectionalLight)&&aH.shadowCascade){for(ap=aH.shadowCascadeCount;ap<aH.shadowCascadeArray.length;ap++){var W=aH.shadowCascadeArray[ap];if(W){if(W.cameraHelper){W.cameraHelper.visible=false}if(W.convexHullHelper){W.convexHullHelper.visible=false}}}for(ap=0;ap<aH.shadowCascadeCount;ap++){var W;if(!aH.shadowCascadeArray[ap]){W=E(aH,ap);W.originalCamera=a0;aH.shadowCascadeArray[ap]=W;ah.add(W)}else{W=aH.shadowCascadeArray[ap]}N(aH,ap);Q[au]=W;au++}}else{Q[au]=aH;au++}}K.setBlending(s.NoBlending);var az=K.materialToUse;K.materialToUse=s.MaterialToUse.shadowMapDepthMaterial;for(ax=0,ak=Q.length;ax<ak;ax++){aH=Q[ax];var af=!aH.shadowMap;var U=(K.shadowMapType===s.ESMShadowMap||K.shadowMapType===s.ESMImprovedShadowMap);if(aH.shadowMap){af=(U&&(aH.shadowMap.type===s.UnsignedByteType))||(!U&&(aH.shadowMap.type===s.FloatType))}if(af){if(aH.shadowMap){aH.shadowMap.dispose()}var aF=s.LinearFilter;if(K.shadowMapType===s.PCFSoftShadowMap){aF=s.NearestFilter}var aU={minFilter:aF,magFilter:aF,type:U?s.FloatType:s.UnsignedByteType,format:s.RGBAFormat};if(aH instanceof s.PointLight){if(U){aH.tempRT=new s.WebGLRenderTarget(aH.shadowMapWidth,aH.shadowMapHeight,aU)}aH.shadowMap=new s.WebGLRenderTargetCube(aH.shadowMapWidth,aH.shadowMapHeight,aU)}else{aH.shadowMap=new s.WebGLRenderTarget(aH.shadowMapWidth,aH.shadowMapHeight,aU)}aH.shadowMapSize=new s.Vector2(aH.shadowMapWidth,aH.shadowMapHeight);aH.shadowMatrix=new s.Matrix4()}if(aH instanceof s.SpotLight){if(!aH.shadowCamera){aH.shadowCamera=new s.PerspectiveCamera(aH.shadowCameraFov,aH.shadowMapWidth/aH.shadowMapHeight,aH.shadowCameraNear,aH.shadowCameraFar);ah.add(aH.shadowCamera);if(K.autoUpdateScene){ah.updateMatrixWorld()}}}else{if(aH instanceof s.DirectionalLight){if(!aH.shadowCamera){aH.shadowCamera=new s.OrthographicCamera(aH.shadowCameraLeft,aH.shadowCameraRight,aH.shadowCameraTop,aH.shadowCameraBottom,aH.shadowCameraNear,aH.shadowCameraFar);ah.add(aH.shadowCamera);if(K.autoUpdateScene){ah.updateMatrixWorld()}}}else{if(aH instanceof s.PointLight){if(!aH.shadowCameras){aH.shadowCameras=[];for(var ax=0;ax<6;ax++){aH.shadowCameras.push(new s.PerspectiveCamera(aH.shadowCameraFov,aH.shadowMapWidth/aH.shadowMapHeight,aH.shadowCameraNear,aH.shadowCameraFar));ah.add(aH.shadowCameras[ax])}if(K.autoUpdateScene){ah.updateMatrixWorld()}}}else{console.error("Unsupported light type for shadow");continue}}}var a6=aH.updateShadowMap;var an=[];if(aH instanceof s.SpotLight||aH instanceof s.DirectionalLight){an=[aH.shadowCamera]}else{if(aH instanceof s.PointLight){an=aH.shadowCameras}}for(var aZ=0;aZ<an.length;aZ++){R=an[aZ];if(aH instanceof s.PointLight){aH.shadowMap.activeCubeFace=aZ;aH.updateShadowMap=a6}if(K.renderIteration){R=an[aZ].clone();var a4=Math.abs(an[aZ].right-an[aZ].left);var at=Math.abs(an[aZ].top-an[aZ].bottom);R.left=an[aZ].left+this.msaaOffset[K.renderIteration].x*a4/aH.shadowMapWidth;R.right=an[aZ].right+this.msaaOffset[K.renderIteration].x*a4/aH.shadowMapWidth;R.bottom=an[aZ].bottom+this.msaaOffset[K.renderIteration].y*at/aH.shadowMapHeight;R.top=an[aZ].top+this.msaaOffset[K.renderIteration].y*at/aH.shadowMapHeight;R.updateProjectionMatrix()}if(aH.shadowCameraVisible&&!aH.cameraHelper){aH.cameraHelper=new s.CameraHelper(an[aZ]);an[aZ].add(aH.cameraHelper)}if(K.renderIteration<=1){if(aH.isVirtual){if(!aH.originalLight.updateShadowMap){continue}}else{if(!aH.updateShadowMap){continue}}}if(aH.castGroundShadow&&!aH.updateShadowMap){continue}if(!aH.isVirtual){aH.updateShadowMap=false}S=aH.shadowMap;aW=aH.shadowMatrix;var bd=a0.matrixWorld.elements;var a1=aH.matrixWorld.elements;var aE=new s.Vector3(-bd[8],-bd[9],-bd[10]);var aj=new s.Vector3(a1[8],a1[9],a1[10]);if(aH.LiSPSM){var aB=new s.Vector3();aB.crossVectors(aj,aE);var aq=new s.Vector3();aq.crossVectors(aB,aj);aq.normalize();var am=new s.Vector3();var aQ=new s.Vector3();var ai=new s.Vector3();ai.crossVectors(aj,aq);ai.normalize();aQ.crossVectors(ai,aj);aQ.normalize();am.copy(aj);am.normalize();R.position.getPositionFromMatrix(a0.matrixWorld);R.up.copy(aQ);C.copy(R.position);C.add(am);R.lookAt(C)}else{R.position.copy(aH.position);if(aH.target){R.lookAt(aH.target.position)}else{if(aH instanceof s.PointLight){var aV;var aD;switch(aZ){case 0:aV=new s.Vector3().set(1,0,0);aD=new s.Vector3().set(0,0,-1);break;case 1:aV=new s.Vector3().set(-1,0,0);aD=new s.Vector3().set(0,0,1);break;case 2:aV=new s.Vector3().set(0,1,0);aD=new s.Vector3().set(1,0,0);break;case 3:aV=new s.Vector3().set(0,-1,0);aD=new s.Vector3().set(1,0,0);break;case 4:aV=new s.Vector3().set(0,0,1);aD=new s.Vector3().set(1,0,0);break;case 5:aV=new s.Vector3().set(0,0,-1);aD=new s.Vector3().set(-1,0,0);break}var aq=new s.Vector3();aq.crossVectors(aD,aV);aq.normalize();R.up.copy(aq);R.lookAt(new s.Vector3().copy(aH.position).add(aV))}else{var aV=new s.Vector3().set(0,0,-1);aV.applyMatrix4(new s.Matrix4().extractRotation(aH.matrixWorld));R.lookAt(new s.Vector3().copy(aH.position).add(aV))}}}R.updateMatrix();R.matrixWorld.copy(R.matrix);R.matrixWorldInverse.getInverse(R.matrixWorld);R.matrixWorldNeedsUpdate=false;R.matrixAutoUpdate=false;var ab=a9.clone();var ao={near:a0.near,far:a0.far};if(aH.isVirtual){ao=w(a0,ab);var aR=aH.originalLight.shadowCascadeCount;var aP=aH.originalLight.shadowCascadeSubNear&&aH.originalLight.shadowCascadeSubNear[ax];var a7=aH.originalLight.shadowCascadeSubFar&&aH.originalLight.shadowCascadeSubFar[ax];if(aP===undefined){aP=-Math.exp((1-aH.virtualLightIndex/aR)*Math.log(ao.near)+(aH.virtualLightIndex/aR)*Math.log(ao.far))}if(a7===undefined){a7=-Math.exp((1-(1+aH.virtualLightIndex)/aR)*Math.log(ao.near)+((1+aH.virtualLightIndex)/aR)*Math.log(ao.far))}ao.near=aP;ao.far=a7;ab=u(a0,aH,ab,ao.near,ao.far);ab=H(aH,a2,ab,R)}else{ab=H(aH,a2,ab,R)}if(aH.isVirtual||aH.LiSPSM){A(a0,aH,ab,ao.near,ao.far,ah)}if(aH.shadowCameraVisible){ab.applyMatrix4(R.matrixWorld);if(!aH.convexHullHelper){aH.convexHullHelper=new s.CGPolyHelper(ab);ah.add(aH.convexHullHelper)}else{if(aH.shadowCameraHelperToUpdate){var aI=new s.Color(255);var aS=[new s.Color(16711680),new s.Color(65280),new s.Color(255)];if(aH.isVirtual){if(aH.virtualLightIndex<3){aI=aS[aH.virtualLightIndex]}else{aI=new s.Color().setRGB(0,0,0.1*aH.virtualLightIndex)}}aH.convexHullHelper.update(ab,aI)}}}if(aH.convexHullHelper){aH.convexHullHelper.visible=aH.shadowCameraVisible}if(aH.cameraHelper){aH.cameraHelper.visible=aH.shadowCameraVisible}if(aH.shadowCameraVisible){if(aH.shadowCameraHelperToUpdate){aH.cameraHelper.update();aH.cameraHelper.matrixWorld=an[aZ].matrixWorld;aH.cameraHelper.toUpdate=true}else{if(aH.cameraHelper.toUpdate){aH.cameraHelper.matrixWorld=new s.Matrix4().copy(an[aZ].matrixWorld);aH.cameraHelper.matrixWorldNeedsUpdate=false;aH.cameraHelper.toUpdate=false}}}aW.set(0.5,0,0,0.5,0,0.5,0,0.5,0,0,0.5,0.5,0,0,0,1);aW.multiply(R.projectionMatrix);aW.multiply(R.matrixWorldInverse);x.multiplyMatrices(R.projectionMatrix,R.matrixWorldInverse);J.setFromMatrix(x);if(U&&aH instanceof s.PointLight){K.setRenderTarget(aH.tempRT)}else{K.setRenderTarget(S)}if(U){B.clearColor(Math.exp(80),1,1,1)}else{B.clearColor(1,1,1,1)}K.clear();aY=ah.getAllWebGLObjects();K._clipPlanesState.update(null,null,true,null,R);for(av=0,Y=aY.length;av<Y;av++){a3=aY[av];aT=a3.object;a3.render=false;aT.render=false;if(aT.visibilityFree){if(!aT.visible){continue}}else{if(K.visibleSpace?!aT.visible:aT.visible){continue}}if(aT.castShadow){if(!(aT instanceof s.Mesh||aT instanceof s.ParticleSystem)||!(aT.frustumCulled)||J.intersectsObject(aT)){aT._modelViewMatrix._multiplyDoubleMatricesMV(R.matrixWorldInverse,aT.matrixWorld);a3.render=true;aT.render=true}}}var P=K._stateSortingResult;K.getStateSortedObjects(aY,true,P,false,R);var V=null;for(var ac=0;ac<P._displayLists.length;ac++){var X=P._displayLists[ac];var aG=X._materialList;var al=X.usefulListLength;for(var ba=0;ba<al;ba++){var aL=aG[ba];var aK=aL.material;var T=X._displayRangeLists[aL.id];var bc=T.first;K._clipPlanesState.update(aL.occurrenceRenderingOverride,V,false,aK,R);V=aL.occurrenceRenderingOverride;if(!aK.visible){continue}if(aK.getOpacity()===0){continue}var aO=true;if(!bc){continue}var aT;for(aT=bc;aT;aT=aT.next){K.setMaterialFaces(aK,aT[0],R);if(aT[1]._type===2){K.renderInterval(R,ah.__lights,Z,aT[0],aK,null,aT[1],aT[2],aT[3],aT[4],aL.occurrenceRenderingOverride,undefined,aO);aO=false}else{if(aT[1]._type===1){K.renderBufferDirect(R,ah.__lights,Z,aK,aT[1],aT[0])}else{K.renderBuffer(R,ah.__lights,Z,aK,aT[1],aT[0])}}}}}aY=ah.__webglObjectsImmediate;for(av=0,Y=aY.length;av<Y;av++){a3=aY[av];aT=a3.object;if(aT.visibilityFree){if(!aT.visible){continue}}else{if(K.visibleSpace?!aT.visible:aT.visible){continue}}if(aT.castShadow){aT._modelViewMatrix._multiplyDoubleMatricesMV(R.matrixWorldInverse,aT.matrixWorld);K.renderImmediateObject(R,ah.__lights,Z,G,aT)}}if(aH.castGroundShadow||U){K.materialToUse=s.MaterialToUse.originalMaterial;var a5=K.getClearColor(),ad=K.getClearAlpha();B.clearColor(a5.r,a5.g,a5.b,ad);if(K.shadowMapCullFace===s.CullFaceFront){B.cullFace(B.BACK)}if(!aH.castGroundShadow&&U){B.enable(B.BLEND);K.esmEffect.setSize(aH.shadowMap.width,aH.shadowMap.height);if(aH instanceof s.PointLight){K.esmEffect.setInput(aH.tempRT)}else{K.esmEffect.setInput(aH.shadowMap)}K.esmEffect.passBlurV.setForceRenderTarget(aH.shadowMap);K.esmEffect.execute()}else{if(aH.castGroundShadow){aH.blurShadowEffect.setSize(512,512);aH.blurShadowEffect.setInput(aH.shadowMap);aH.blurShadowEffect.execute();aH.groundMaterial.uniforms.groundShadow.value=aH.blurShadowEffect.getResult()}}if(ax<Q.length-1||aZ<an.length-1){K.materialToUse=s.MaterialToUse.shadowMapDepthMaterial;B.disable(B.BLEND);B.enable(B.CULL_FACE);B.frontFace(B.CCW);if(K.shadowMapCullFace===s.CullFaceFront){B.cullFace(B.FRONT)}else{B.cullFace(B.BACK)}}}}}var a5=K.getClearColor(),ad=K.getClearAlpha();B.clearColor(a5.r,a5.g,a5.b,ad);B.enable(B.BLEND);if(K.shadowMapCullFace===s.CullFaceFront){B.cullFace(B.BACK)}K.enableScissorTest(O);K.materialToUse=az};function E(P,Q){var O=new s.DirectionalLight();O.originalLight=P;O.target=P.target;O.isVirtual=true;O.LiSPSM=P.LiSPSM;O.onlyShadow=true;O.castShadow=true;O.shadowCameraNear=P.shadowCameraNear;O.shadowCameraFar=P.shadowCameraFar;O.shadowCameraLeft=P.shadowCameraLeft;O.shadowCameraRight=P.shadowCameraRight;O.shadowCameraBottom=P.shadowCameraBottom;O.shadowCameraTop=P.shadowCameraTop;O.shadowCameraVisible=P.shadowCameraVisible;O.shadowDarkness=P.shadowDarkness;O.shadowBias=P.shadowCascadeBias[Q];O.shadowMapWidth=P.shadowCascadeWidth[Q];O.shadowMapHeight=P.shadowCascadeHeight[Q];return O}function N(P,Q){var O=P.shadowCascadeArray[Q];O.virtualLightIndex=Q;O.position.copy(P.position);if(P.target){O.target.position=P.target.position;O.lookAt(O.target.position)}O.shadowCameraVisible=P.shadowCameraVisible;O.shadowDarkness=P.shadowDarkness;O.shadowBias=P.shadowCascadeBias[Q]}function w(S,V){var R=V.getPoints();var U=R.length;var Q=Infinity;var O=-Infinity;var T=new s.Vector4();for(var P=0;P<R.length;P++){T.copy(R[P]);T.applyMatrix4(S.matrixWorldInverse);if(-T.z<Q){Q=-T.z}if(-T.z>O){O=-T.z}}Q=Math.max(S.near,Q);return{near:Q,far:O}}function u(W,Q,Z,T,S){var U=Q.matrixWorld.elements;var P=W.matrixWorld.elements;var ab=new s.Vector3(P[8],P[9],P[10]);var X=new s.Vector3(-P[8],-P[9],-P[10]);var O=new s.Vector3(U[8],U[9],U[10]);var Y=new s.Vector3().copy(ab).multiplyScalar(T).add(W.position);var ac=new s.Vector3().copy(ab).multiplyScalar(S).add(W.position);var R=new s.Plane(ab,-ab.dot(Y));var V=new s.Plane(X,-X.dot(ac));return Z.clipByPlanes([R,V])}function H(T,Y,X,R){var U=X.getPoints();var W=U.length;var V=new s.CGPoly();V.setFromBox(Y);V.applyMatrix4(R.matrixWorldInverse);var P=[];for(var S=0;S<W;S++){var ab=U[S].clone();ab.applyMatrix4(R.matrixWorldInverse);P.push(ab)}var O=new s.Box3().setFromPoints(P);var Z=O.getPlanes();var Q=V.clipByPlanes([Z[0],Z[1],Z[2],Z[3],Z[4]]);return Q}function A(aj,U,Z,ak,P,am){if(U instanceof s.PointLight){var at=U.shadowCameras}else{var at=[U.shadowCamera]}for(var ai=0;ai<at.length;ai++){var W=U.matrixWorld.elements;var V=aj.matrixWorld.elements;var af=new s.Vector3(V[8],V[9],V[10]);var ac=new s.Vector3(W[8],W[9],W[10]);var Q=Z.getPoints();var ae=Q.length;var Y=new s.Box3().setFromPoints(Q);if(U.LiSPSM){var ap=af.dot(ac);var ah=Math.sqrt(1-ap*ap);var R=(ak+Math.sqrt(ak*P))/ah;var al=Math.abs(Y.max.y-Y.min.y);var O=R+al;var T=new s.Vector3(0,Y.min.y-R,0.5*(Y.min.z+Y.max.z));for(var ag=0;ag<ae;ag++){var ad=Q[ag];ad.sub(T)}var X=0;var S=0;for(var ag=0;ag<ae;ag++){var ad=Q[ag];var ao=Math.abs(R*ad.x/ad.y);if(!X||(ao>X)){X=ao}var ab=Math.abs(R*ad.z/ad.y);if(!S||(ab>S)){S=ab}}T.applyMatrix4(at[ai].matrixWorld);at[ai].position.copy(T);at[ai].matrix.elements[12]=at[ai].position.x;at[ai].matrix.elements[13]=at[ai].position.y;at[ai].matrix.elements[14]=at[ai].position.z;at[ai].matrixWorld.elements[12]=at[ai].position.x;at[ai].matrixWorld.elements[13]=at[ai].position.y;at[ai].matrixWorld.elements[14]=at[ai].position.z;at[ai].matrixWorldInverse.getInverse(at[ai].matrixWorld);var ar=(O+R)/(O-R);var aq=-2*O*R/(O-R);var an=R/X;var al=-R/S;at[ai].projectionMatrix.set(an,0,0,0,0,ar,0,aq,0,0,al,0,0,1,0,0)}else{at[ai].left=Y.min.x;at[ai].right=Y.max.x;at[ai].top=Y.max.y;at[ai].bottom=Y.min.y;at[ai].near=-Y.max.z;at[ai].far=-Y.min.z;at[ai].updateProjectionMatrix()}}}function D(O){return O.material instanceof s.MeshFaceMaterial?O.material.materials[0]:O.material}};s.ShadowMapPlugin.__projector=new s.Projector();s.ShaderFlares={lensFlareVertexTexture:{vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","vUV = uv;","vec2 pos = position;","if( renderType == 2 ) {","vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) ) +","texture2D( occlusionMap, vec2( 0.5, 0.1 ) ) +","texture2D( occlusionMap, vec2( 0.9, 0.1 ) ) +","texture2D( occlusionMap, vec2( 0.9, 0.5 ) ) +","texture2D( occlusionMap, vec2( 0.9, 0.9 ) ) +","texture2D( occlusionMap, vec2( 0.5, 0.9 ) ) +","texture2D( occlusionMap, vec2( 0.1, 0.9 ) ) +","texture2D( occlusionMap, vec2( 0.1, 0.5 ) ) +","texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","vVisibility = (       visibility.r / 9.0 ) *","( 1.0 - visibility.g / 9.0 ) *","(       visibility.b / 9.0 ) *","( 1.0 - visibility.a / 9.0 );","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform lowp int renderType;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","if( renderType == 0 ) {","gl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );","} else if( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * vVisibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")},lensFlare:{vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uv;","vec2 pos = position;","if( renderType == 2 ) {","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision mediump float;","uniform lowp int renderType;","uniform sampler2D map;","uniform sampler2D occlusionMap;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","void main() {","if( renderType == 0 ) {","gl_FragColor = vec4( texture2D( map, vUV ).rgb, 0.0 );","} else if( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","float visibility = texture2D( occlusionMap, vec2( 0.5, 0.1 ) ).a +","texture2D( occlusionMap, vec2( 0.9, 0.5 ) ).a +","texture2D( occlusionMap, vec2( 0.5, 0.9 ) ).a +","texture2D( occlusionMap, vec2( 0.1, 0.5 ) ).a;","visibility = ( 1.0 - visibility / 4.0 );","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * visibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")}};return s});define("Visualization/ThreeJS_R57",["DS/Visualization/ThreeJS_R57","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/ThreeJS_R57");return b});define("DS/VisuDataAccess/Ox4StreamLoader",["DS/VisuDataAccess/Ox4PLMDataHelper","DS/VisuDataAccess/Ox4TicketGeneratorTask","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/WAFData/WAFData"],function(a,d,l,j){var c=null;var h=null;var o=function(q){var p=q.url;q.xmqlServiceUri=function(){return p+"/i3dx/services/xmql"};q.threedexpServiceUri=function(){return p};l.useUWAProxy({proxymode:"passport"})};var f=function(q,r,p){var s='<?xml version="1.0" encoding="utf-8"?>\n';s+='<executeSequence xmlns="http://www.3ds.com/xmql/query">\n';s+="\t<execute>\n";s+="\t\t<function>query_bus</function>\n";s+="\t\t<version>2.0.0</version>\n";s+="\t\t<params>\n";s+='\t\t\t<param name="type">'+r+"</param>\n";s+='\t\t\t<param name="name">*</param>\n';s+='\t\t\t<param name="revision">*</param>\n';s+='\t\t\t<param name="vault">*</param>\n';s+='\t\t\t<param name="where">physicalid=='+q+"</param>\n";s+='\t\t\t<param name="select">'+JSON.stringify(p)+"</param>\n";s+='\t\t\t<param name="dump">,</param>\n';s+="\t\t</params>\n";s+="\t</execute>\n";s+="</executeSequence>\n";return s};var e=function(r,q,u,v,t,s,p){return{mqlCmd:f(r,q,["attribute[StreamDescriptors]","format.file.name","format.file.store"]),parseTCLRow:function(M){var G=/{{.*} {.*} {.*} {{([^{}]*)}} {({.*})} {({.*})}}/;var K=G.exec(M);var B=K[1];var H=K[2];var x=K[3];var J=B.split(":");var C=[];for(var D=0;D<J.length;D++){var A=/SDv2\((.*),'(.*)',(.*),.*,.*,'(.*)','(.*)'\)/;var L=A.exec(J[D]);C.push({format:L[1],role:L[2],lateType:L[3],persistancyType:L[4],persistancyName:L[5]})}var F=/{([^{}]*)}/g;var z=null;var E=[];while((z=F.exec(H))!==null){E.push(z[1])}var I=[];while((z=F.exec(x))!==null){I.push(z[1])}var y={name:"",store:""};for(var D=0;D<C.length;D++){var w=C[D];if((u===undefined||u===w.format)&&(v===undefined||v===w.role)&&(t===undefined||t===w.lateType)&&(s===undefined||s===w.persistancyType)&&(p===undefined||p===w.persistancyName)){if(y.name===""){y.name=r+"_'"+w.role+"'."+w.format;if(w.persistancyName){y.name+="="+w.persistancyName}y.format=w.format}else{y.tooManyFilesError=true;y.name=""}}}if(y.name!==""){for(var D=0;y.store===""&&D<E.length;D++){if(y.name===E[D]){y.store=I[D]}}}if(y.name===""||y.store===""){y.noStreamRetrieved=true;y.name="";y.store=""}return y}}};var m=function(p,q,r){return{mqlCmd:f(p,q,["format["+r+"].file.name","format["+r+"].file.store"]),parseTCLRow:function(u){var t=/{{.*} {.*} {.*} {{([^{}]*)}} {{([^{}]*)}}}/;var s=t.exec(u);if(s===null){return{tooManyFilesError:true}}else{return{name:s[1],store:s[2]}}}}};var g=function(t,s,r){var q=null;if(t.IRPC){q=e(t.physicalid,t.boType,t.format,t.role,t.lateType,t.persistancyType,t.persistancyName)}else{q=m(t.physicalid,t.boType,t.format)}var u="application/xml";var p=new l();p.executePostHttpRequest(h.xmqlServiceUri(),u,q.mqlCmd,function(w){var v=q.parseTCLRow(w);if(v.tooManyFilesError){r("Too many streams retrieved")}else{if(v.noStreamRetrieved){r("No stream retrieved")}else{v.physicalid=t.physicalid;if(v.format===undefined&&t.format!==undefined){v.format=t.format}if(v.format!==undefined){s(v)}else{r("Stream format has to be specified")}}}})};var k=function(r,t,s){var u=c.transformSelectedFileIntoTicketRequest(r.physicalid,r.format,r.store,r.name);var p=new d(u,h);var q=new l();q.asyncTransformFCSUrlIntoRealUrl(p.generateRequest(),false,function(v,w){t(w)})};var n=function(u,p,w,t){if(u.slice(0,8)=="posthttp"){var q=u.indexOf(":postparams:");var v=u.slice(9,q);var r=u.slice(q+12,u.length);var x={cors:true,timeout:100000,method:"POST",data:r,responseType:p,async:true,headers:{Accept:"text/plain",},onComplete:w,onFailure:t};var s=j.authenticatedRequest(v,x)}};var b={Load:function(p){if(c===null||h===null||h.url!==p.serverUrl){h={rawmode:false,url:p.serverUrl};o(h);c=new a(h)}g(p,function(q){k(q,function(r){n(r,p.streamType,p.onStreamLoaded,p.onError)},p.onError)},p.onError)}};return b});define("DS/Visualization/Utils",["UWA/Class","UWA/Utils","DS/Visualization/ProxyAbstraction"],function(b,a,d){var c=b.extend({init:function(){}});c.parseUrl=function(e){return a.parseUrl(e)};c.getExtension=function(k){var g=k.replace(/\.\./g,"");g=g.split(".");if(g.length===1||(g[0]===""&&g.length===2)){return""}var j=g.pop();var f=j.indexOf("?")+1;if(f){g=j.substring(0,f-1)}else{g=j}var h=new RegExp(/^[a-zA-Z0-9_]+$/);var e=h.exec(g);if(e!==null){return g}return""};c.getDomain=function(e){var f=e;if(!a.isAbsoluteUrl(e)){f=window.location}return c.parseUrl(f).hostname};c.getWorkerFromSpec=function(g,k){var e=window.URL||window.webkitURL;var h=new d();c.setProxyFromSpec(g,h);var f=g.serverurl?g.serverurl:"";f+=g.filename?g.filename:"";var j=h.executeGetHttpRequest(f,"blob",null,function(l){var m=e.createObjectURL(l);var n=new Worker(m);if(k){k(n)}})};c.getJSFromSpec=function(f,j){var g=new d();c.setProxyFromSpec(f,g);var e=f.serverurl?f.serverurl:"";e+=f.filename?f.filename:"";var h=g.executeGetHttpRequest(e,"text",null,function(k){if(j){j(k)}},null,"text/plain, text/javascript, application/javascript, application/x-javascript")};c.getWorkerFromSpecs=function(j,h){var e=window.URL||window.webkitURL;var g="";var f=function(k){c.getJSFromSpec(j[k],function(o){g+=o;if(k<j.length-1){f(k+1)}else{if(h){var l=new Blob([g],{type:"application/javascript"});var m=e.createObjectURL(l);var n=new Worker(m);h(n)}}})};f(0)};c.getWorkerBlobFromSpecs=function(j,h){var e=window.URL||window.webkitURL;var g="";var f=function(k){c.getJSFromSpec(j[k],function(n){g+=n;if(k<j.length-1){f(k+1)}else{if(h){var l=new Blob([g],{type:"application/javascript"});var m=e.createObjectURL(l);h(m)}}})};f(0)};c.getFileURLFromSpec=function(g,k){var e=window.URL||window.webkitURL;var h=new d();c.setProxyFromSpec(g,h);var f=g.serverurl?g.serverurl:"";f+=g.filename?g.filename:"";var j=h.executeGetHttpRequest(f,"blob",null,function(m){var l=e.createObjectURL(m);if(k){k(l)}})};c.getFilesURLFromSpec=function(h,g){var f=[];var e=function(j){c.getFileURLFromSpec(h[j],function(k){f.push(k);if(j<h.length-1){e(j+1)}else{if(g){g(f)}}})};e(0)};c.setProxyFromSpec=function(f,h){if(f.proxyurl){if(f.proxyurl==="none"){h.useNoProxy(f.withCredentials)}else{var g=c.parseUrl(f.proxyurl);if(g===null){h.useUWAProxy()}else{if(g.hostname!=undefined){h.useProxyDefinedBy(g.hostname,g.port)}else{var j=f.proxyurl.indexOf("http://127.0.0.1");if(j==0){var j=f.proxyurl.lastIndexOf(":");var e=f.proxyurl.slice(j+1,f.proxyurl.length);e=e.replace("/","");h.useProxyDefinedBy("127.0.0.1",8023)}}}}}else{h.useUWAProxy({proxymode:f.requiredAuth,requestsOptions:f.requestsOptions,login:f.login,contextid:f.contextid})}};return UWA.namespace("THREEDS/Utils",c)});define("Visualization/Utils",["DS/Visualization/Utils","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/Utils");return b});define("DS/Mesh/Mesh",["DS/Mesh/ThreeJS_Base"],function(e){var g=g||{REVISION:"1"};var h=((new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent)!=null));var f=(new RegExp("Edge","i").test(navigator.userAgent));g.VertexComponentEnum={POSITION:0,NORMAL:1,DIFFUSE_COLOR:2,TEX_COORD_0:3,TEX_COORD_1:4,TEX_COORD_2:5,TEX_COORD_3:6,TEX_COORD_4:7,TEX_COORD_5:8,TEX_COORD_6:9,TEX_COORD_7:10,USER_COMPONENT_0:11};g.DataTypeEnum={UCHAR:0,USHORT:1,UINT:2,CHAR:3,SHORT:4,INT:5,FLOAT:6,DOUBLE:7};g.GeomTypeString={};(function(){var k=["EDGE","WIRE_EDGE","BOUNDARY_EDGE","SHARP_EDGE","SMOOTH_EDGE","HIDDEN_SEAM_EDGE","BOUNDARY_POINT","SHARP_POINT","SMOOTH_POINT","HIDDEN_SEAM_POINT","SURFACIC_POINT","FREE_POINT","INFINITE_FACE","FACE","UNKNOWN","AXIS_SYSTEM"];var l,j;for(l=0;l<k.length;l++){j=k[l];g.GeomTypeString[e.GeomTypeEnum[j]]=j}})();g.sizeOfDataType=function(j){switch(j){case g.DataTypeEnum.FLOAT:case g.DataTypeEnum.INT:case g.DataTypeEnum.UINT:return 4;case g.DataTypeEnum.CHAR:case g.DataTypeEnum.UCHAR:return 1;case g.DataTypeEnum.SHORT:case g.DataTypeEnum.USHORT:return 2;case g.DataTypeEnum.DOUBLE:return 8;default:return 0}};g.ConnectivityTypeEnum={TRIANGLES:0,TRIANGLE_FAN:1,TRIANGLE_STRIP:2,LINES:3,LINE_STRIP:4,LINE_LOOP:5,POINTS:6};g.PointSymbolEnum={CROSS:0,PLUS:1,CONCENTRIC:2,COINCIDENT:3,FULLCIRCLE:4,FULLSQUARE:5,STAR:6,DOT:7,SMALLDOT:8};g.LinePatternEnum={UNKNOWN:0,SOLID:1,DOTTED:2,DASHED:3,DOTDASHED:4,PHANTOM:5,SMALLDOTTED:6,JISAXIS:7};g.NOPICKABLE=0;g.PICKABLE=1;g.NODRAWHL=2;g.INVISIBLE=2;g.PICK_NEVER=0;g.PICK_ALWAYS=1;g.PICK_VISIBLE=2;g.PICK_INVISIBLE=3;g.Color=function(m,l,j,k){this.r=m||0;this.g=l||0;this.b=j||0;this.a=(k==undefined?1:k)};g.Color.prototype={constructor:g.Color,setRGBA:function(m,l,j,k){this.r=m;this.g=l;this.b=j;this.a=k},isEqual:function(j){return((this.r===j.r)&&(this.g===j.g)&&(this.b===j.b)&&(this.a===j.a))},clone:function(){return new g.Color(this.r,this.g,this.b,this.a)}};g.FillAttributes=function(l,j,k){this.color=l||new g.Color();this.solid=j||this.solid||0;this.basic=k||this.basic||false};g.FillAttributes.prototype={constructor:g.FillAttributes,isEqual:function(j){return(j!==null)&&this.color.isEqual(j.color)&&(this.solid===j.solid)&&(this.basic===j.basic)},clone:function(){return new g.FillAttributes(this.color.clone(),this.solid)}};g.LineAttributes=function(j,k,l){this.color=j||new g.Color();this.thickness=(Math.round(k)>1?Math.round(k):1);this.pattern=l||g.LinePatternEnum.SOLID;this.forceMaterial=false};g.LineAttributes.prototype={constructor:g.LineAttributes,isEqual:function(j){return(j!==null)&&(this.color.isEqual(j.color)&&(this.thickness===j.thickness)&&(this.pattern===j.pattern)&&(this.forceMaterial===j.forceMaterial)&&((this.forceLineWidth===j.forceLineWidth)||(this.thickness==1)))},clone:function(){return new g.LineAttributes(this.color.clone(),this.thickness,this.pattern)}};g.PointAttributes=function(j,k,l){this.color=j||new g.Color();this.size=k||1;this.symbol=l||g.PointSymbolEnum.CROSS;this.forceMaterial=false};g.PointAttributes.prototype={constructor:g.PointAttributes,isEqual:function(j){return(j!==null)&&(this.color.isEqual(j.color)&&(this.size===j.size)&&(this.forceMaterial===j.forceMaterial)&&(this.symbol===j.symbol))},clone:function(){return new g.PointAttributes(this.color.clone(),this.size,this.symbol)}};var d=new g.FillAttributes();var c=new g.LineAttributes();var a=new g.PointAttributes();g.PrimitiveGroup=function(j){this.identifier=0;this.nbPrimitives=0;this.primitives=[];this.nbBuffers=0;this.buffers=[];this.material=null;this.fillAttr=d;this.lineAttr=c;this.pointAttr=a;this.noz=false;this.editable=false;if(j){if(j.fillGAS!==undefined){this.fillAttr=j.fillGAS}if(j.lineGAS!==undefined){this.lineAttr=j.lineGAS}if(j.pointGAS!==undefined){this.pointAttr=j.pointGAS}if(j.identifier!==undefined){this.identifier=j.identifier}if(j.editable!==undefined){this.editable=j.editable}if(j.noz!==undefined){this.noz=j.noz}}};g.PrimitiveGroup.prototype={constructor:g.PrimitiveGroup,addPrimitive:function(j){this.primitives.push(j);this.nbPrimitives++;return this},addBuffer:function(k,j){this.buffers[k]=j;this.nbBuffers++;return this},removeBuffer:function(j){this.buffers[j]=null;this.nbBuffers--},getBuffer:function(j){var l;for(l in this.buffers){var k=this.buffers[l];if(k.component===j){return k}}return null},getBufferFromId:function(k){var j=this.buffers[k];if(j!==undefined){return j}return null}};g.Buffer=function(j){this.indexBuffer=false;this.size=0;this.component=g.VertexComponentEnum.POSITION;this.format=g.DataTypeEnum.FLOAT;this.dimension=3;this.data=null;if(j){if(j.indexBuffer){this.indexBuffer=true}if(j.component!==undefined){this.component=j.component}if(j.format!==undefined){this.format=j.format}if(j.dimension){this.dimension=j.dimension}if(j.data){this.data=j.data}}};g.Primitive=function(j){this.identifier=0;this.nbIndices=0;this.connectivity=g.ConnectivityTypeEnum.TRIANGLES;this.nbVertexComponents=0;this.geomType=null;this.vertexComponents=[];this.attr=null;this.material=null;if(j){if(j.nbIndices!==undefined){this.nbIndices=j.nbIndices}if(j.connectivity!==undefined){this.connectivity=j.connectivity}if(j.geomType!==undefined){this.geomType=j.geomType}if(j.identifier!==undefined){this.identifier=j.identifier}if(j.fillGAS||j.lineGAS||j.pointGAS){if(!this.attr){this.attr={fill:d,line:c,point:a}}if(j.fillGAS){this.attr.fill=j.fillGAS}if(j.lineGAS){this.attr.line=j.lineGAS}if(j.pointGAS){this.attr.point=j.pointGAS}}}};g.Primitive.prototype={constructor:g.Primitive,addVertexComponent:function(j){this.vertexComponents.push(j);this.nbVertexComponents++;return this}};g.VertexComponent=function(j){this.component=g.VertexComponentEnum.POSITION;this.nbVertices=0;this.nbValuesPerVertex=0;this.format=g.DataTypeEnum.FLOAT;this.cardinality=0;this.bufferId="";this.offset=0;this.indices=null;if(j){if(j.nbVertices!==undefined){this.nbVertices=j.nbVertices}if(j.cardinality!==undefined){this.cardinality=j.cardinality}if(j.bufferId!==undefined){this.bufferId=j.bufferId}if(j.indices!==undefined){this.indices=j.indices}if(j.offset!==undefined){this.offset=j.offset}}};g.IndexArray=function(j){this.format=g.DataTypeEnum.UINT;this.bufferId="";this.offset=0;if(j){if(j.bufferId!==undefined){this.bufferId=j.bufferId}if(j.offset!==undefined){this.offset=j.offset}}};g.Material=function(){this.type="material";this.identifier=0;this.colorAmbient=[];this.colorDiffuse=[];this.colorSpecular=[];this.shininess=0;this.ambientCoef=0;this.diffuseCoef=0;this.specularCoef=0;this.transparent=0;this.reflectivityCoef=0;this.textureId=-1;this.textureImageNumberComposante=0;this.textureBlending=1;this.magFilter=0;this.minFilter=0;this.mappingFunction=0;this.textureWrapS=0;this.textureWrapT=0;this.addedComposantInTexEnv=0;this.shaderMaterial=null};g.Material.prototype={constructor:g.Material,clone:function(){return new g.Material()}};g.SGNode=function(j){this.type=0;if(j){this.cgmId=j.cgmId!==undefined?j.cgmId:-1;this.parent=j.parent!==undefined?j.parent:null;this.solid=j.solid!==undefined?j.solid:false}else{this.cgmId=-1;this.parent=null;this.solid=false}};g.SGNode.prototype={constructor:g.SGNode};g.SGBag=function(j){g.SGNode.call(this,j);j=j||{};this.type=1;this.matrix=j.matrix!==undefined?j.matrix:null;this.children=j.children!==undefined?j.children:[]};g.SGBag.prototype=new g.SGNode();g.SGBag.prototype.constructor=g.SGBag;g.SGBag.prototype.childClone=function(){var j=new Array();for(var k in this.children){j[k]=typeof(this.children[k])=="object"?this.children[k].clone():this.children[k]}return j};g.SGBag.prototype.clone=function(){return new g.SGBag({cgmId:this.cgmId,type:this.type,children:this.childClone(),matrix:this.matrix!==null?this.matrix.clone():null,parent:this.parent,solid:this.solid})};g.SGRep=function(j){g.SGNode.call(this,j);this.type=2;if(j){this.matrix=j.matrix!==undefined?j.matrix:null;this.primitives=j.primitives!==undefined?j.primitives:[];this.boundingSphere=j.boundingSphere!==undefined?j.boundingSphere:null;this.sag=j.sag!==undefined?j.sag:null;this.namingContext=j.namingContext!==undefined?j.namingContext:0}else{this.matrix=null;this.primitives=[];this.boundingSphere=null;this.sag=null;this.namingContext=0}};g.SGRep.prototype=new g.SGNode();g.SGRep.prototype.constructor=g.SGRep;g.SGRep.prototype.primitivesClone=function(){var j=new Array();for(var k in this.primitives){j[k]=typeof(this.primitives[k])=="object"?this.primitives[k].clone():this.primitives[k]}return j};g.SGRep.prototype.clone=function(){return new g.SGRep({cgmId:this.cgmId,type:this.type,primitives:this.primitivesClone(),matrix:this.matrix?this.matrix.clone():null,parent:this.parent,solid:this.solid,sag:this.sag,boundingSphere:this.boundingSphere?{radius:this.boundingSphere.radius,center:[this.boundingSphere.center[0],this.boundingSphere.center[1],this.boundingSphere.center[2]]}:null})};g.SGPrimitive=function(j){this.type=3;if(j){this.cgmId=j.cgmId!==undefined?j.cgmId:-1;this.rep=j.rep!==undefined?j.rep:null;this.group=j.group!==undefined?j.group:null;this.start=j.start!==undefined?j.start:0;this.count=j.count!==undefined?j.count:0;this.boundingSphere=j.boundingSphere!==undefined?j.boundingSphere:undefined;this.decoration=j.decoration!==undefined?j.decoration:0}else{this.cgmId=-1;this.rep=null;this.group=null;this.start=0;this.count=0;this.boundingSphere=undefined;this.decoration=0}};g.SGPrimitive.prototype.constructor=g.SGPrimitive;g.SGPrimitive.prototype.clone=function(){return new g.SGPrimitive({type:this.type,cgmId:this.cgmId,rep:this.rep,group:this.group,start:this.start,count:this.count,boundingSphere:this.boundingSphere?{radius:this.boundingSphere.radius,center:[this.boundingSphere.center[0],this.boundingSphere.center[1],this.boundingSphere.center[2]]}:undefined,decoration:this.decoration})};g.SGPrimitive.prototype.getIdentificationObject=function(){return this.IdentObj};g.SGPrimitive.prototype.setIdentificationObject=function(j){this.IdentObj=j};g.SGPrimitive.prototype.computeBoundingSphere=function(){var r=this.start;var t=this.count;if(t==0){return}var k=this.group.geometry.vertexIndexArray;var A=this.group.geometry.vertexPositionArray;var G=null;var q=0;var s=k[r];var p=A[3*s];var n=A[3*s+1];var l=A[3*s+2];var o=p;var m=n;var j=l;for(var F=1;F<t;++F){s=k[r+F];var w=A[3*s];var v=A[3*s+1];var u=A[3*s+2];if(w<p){p=w}else{if(w>o){o=w}}if(v<n){n=v}else{if(v>m){m=v}}if(u<l){l=u}else{if(u>j){j=u}}}var E=(p+o)/2;var D=(n+m)/2;var C=(l+j)/2;var q=0;for(var F=0;F<t;++F){s=k[r+F];var w=A[3*s];var v=A[3*s+1];var u=A[3*s+2];var B=(u-C)*(u-C)+(v-D)*(v-D)+(w-E)*(w-E);if(B>q){q=B}}q=Math.sqrt(q);return new e.Sphere(new e.Vector3(E,D,C),q)};var b={EDGE:1,WIRE_EDGE:2,BOUNDARY_EDGE:3,SHARP_EDGE:4,SMOOTH_EDGE:5,BOUNDARY_POINT:6,SHARP_POINT:7,SMOOTH_POINT:8,SURFACIC_POINT:9,FREE_POINT:10,INFINITE_FACE:11,FACE:12,UNKNOWN:13};g.getConvertedVec3=function(k,l){var j=[k[l],k[l+1],k[l+2]];return new e.Vector3(j[0],j[1],j[2])};g.isEqualGAS=function(j,k){if((j==null)&&(k==null)){return true}if(((j==null)&&(k!=null))||((j!=null)&&(k==null))){return false}return(j.fill.isEqual(k.fill)&&j.line.isEqual(k.line)&&j.point.isEqual(k.point))};g.isEqualMaterial=function(k,j){if((k==null)&&(j==null)){return true}if(((k==null)&&(j!=null))||((k!=null)&&(j==null))){return false}return(k.id==j.id)&&(k.file==j.file)};g.convertToMaterial3js=function(n,m){if(n==null){return null}var l=null;var k=1;var j=null;switch(m){case 0:k=(n.point.color.a==undefined?1:n.point.color.a);j=new e.Color();if(n.point.color){j.setRGB(n.point.color.r,n.point.color.g,n.point.color.b);l={color:j,opacity:k,symbol:n.point.symbol,pointsize:n.point.size};if(n.point.forceMaterial){l.forceMaterial=true}}break;case 1:k=(n.line.color.a==undefined?1:n.line.color.a);j=new e.Color();if(n.line.color){j.setRGB(n.line.color.r,n.line.color.g,n.line.color.b);l={color:j,opacity:k,lineWidth:n.line.thickness,pattern:n.line.pattern};if(n.line.forceMaterial){l.forceMaterial=true}}break;case 2:k=(n.fill.color.a==undefined?1:n.fill.color.a);j=new e.Color();if(n.fill.color){j.setRGB(n.fill.color.r,n.fill.color.g,n.fill.color.b);l={color:j,opacity:k,solid:n.fill.solid,basic:n.fill.basic}}break;default:break}return l};g.areEqualGraphicProperties=function(j,k){if(j.color==null||k.color==null){return false}if((j.color.r!=k.color.r)||(j.color.g!=k.color.g)||(j.color.b!=k.color.b)){return false}if(j.thickness&&k.thickness&&(j.thickness!=k.thickness)){return false}if(j.pointsize&&k.pointsize&&(j.pointsize!=k.pointsize)){return false}if(j.opacity!=k.opacity){return false}return true};g.validatePrimitiveGroup=function(o){var n,m;for(n=0;n<o.buffers.length;n++){var l=o.buffers[n];if(l){l.size=l.data.byteLength/g.sizeOfDataType(l.format);if(l.indexBuffer){l.format=g.DataTypeEnum.UINT;l.dimension=1}}}for(n=0;n<o.primitives.length;n++){var k=o.primitives[n];if(!k.attr){k.attr={fill:o.fillAttr,line:o.lineAttr,point:o.pointAttr}}for(m=0;m<k.nbVertexComponents;m++){var p=k.vertexComponents[m];var l=o.getBufferFromId(p.bufferId);p.component=l.component;p.nbValuesPerVertex=l.dimension;p.format=l.format}}};g.checkMeshOptimizable=function(q){var l=null;var k=[];for(var p=0;p<q.buffers.length;p++){var n=q.buffers[p];if(!n){continue}if(n.indexBuffer){if(!l){l=n}else{return false}}else{if(!k[n.component]){k[n.component]=n}else{return false}}}for(var o=0;o<q.primitives.length;o++){var m=q.primitives[o];if(m.connectivity===g.ConnectivityTypeEnum.TRIANGLE_STRIP||m.connectivity===g.ConnectivityTypeEnum.TRIANGLE_FAN||m.connectivity===g.ConnectivityTypeEnum.LINE_STRIP){return false}}return true};g.createGeometryOptimized=function(D,p){var w=new g.Mesh();w.rep=p;for(var O=0;O<D.buffers.length;O++){var B=D.buffers[O];var Q=B.component;var R=B.data;if(B.indexBuffer){w.vertexIndexArray=R;continue}switch(Q){case g.VertexComponentEnum.POSITION:w.vertexPositionArray=R;break;case g.VertexComponentEnum.NORMAL:w.vertexNormalArray=R;break;case g.VertexComponentEnum.DIFFUSE_COLOR:w.vertexColorArray=R;break;case g.VertexComponentEnum.TEX_COORD_0:w.vertexUvArray=R;break;case g.VertexComponentEnum.TEX_COORD_1:w.vertexUv2Array=R;break;case g.VertexComponentEnum.TEX_COORD_2:w.vertexTangentArray=R;break;case g.VertexComponentEnum.TEX_COORD_3:w.vertexBinormalArray=R;break;default:break}}var m=[];var I=[];var z=D.nbPrimitives;for(var O=0;O<z;O++){var s=D.primitives[O];var M=!!s.vertexComponents[0].indices;var N=0;var v=m.length;if(!M){I.push(s);continue}for(N=0;N<v;N++){var x=m[N];if((x.connectivity==s.connectivity)&&(x.geomType==s.geomType)&&g.isEqualGAS(x.gas,s.attr)&&(((x.material==null)&&(s.material==null))||((x.material.id==s.material.id)&&(x.material.file==s.material.file)))){x.set.push(s);x.nbIndices+=s.nbIndices;break}}if(N===m.length){var u={connectivity:s.connectivity,geomType:s.geomType,gas:s.attr,material:s.material,nbIndices:s.nbIndices,set:[s]};m.push(u)}}m.sort(function(W,k){if(W.connectivity<k.connectivity){return -1}if(W.connectivity>k.connectivity){return 1}if(W.geomType&&k.geomType){var n=b[W.geomType];var j=b[k.geomType];if(n&&j){return n-j}}return 0});for(var O=0;O<m.length;O++){m[O].set.sort(function(k,j){var W=k.vertexComponents[0].indices;var n=j.vertexComponents[0].indices;if(W&&n){return W.offset-n.offset}return 0})}for(var O=0;O<m.length;O++){var C=m[O];var J=[];var y=C.set[0].vertexComponents[0].indices.offset;var l=C.set[0].vertexComponents[0].indices.offset;var F=0;var E=0;while(E<C.set.length){for(var N=E;N<C.set.length;N++){var t=C.set[N];if(!t.vertexComponents[0].indices||(t.vertexComponents[0].indices.offset!==l)||(N===C.set.length-1)){if(N===C.set.length-1){J.push(t);F+=t.nbIndices;E=N+1}else{E=N}var S=(C.connectivity===g.ConnectivityTypeEnum.TRIANGLES)?4:((C.connectivity===g.ConnectivityTypeEnum.LINES)?1:0);var G=(S===4)?2:S;var o=new g.DrawingGroup(g.convertToMaterial3js(C.gas,G),C.material,S,y,F,undefined,undefined,e.GeomTypeEnum[C.geomType]);o._geomType=C.geomType?e.GeomTypeEnum[C.geomType]:0;w.drawingGroups.push(o);for(var L=0;L<J.length;L++){var P=J[L];var r=new g.SGPrimitive({cgmId:P.identifier,rep:w.rep,group:o,start:P.vertexComponents[0].indices.offset,count:P.nbIndices});o.primitives.push(r);w.rep.primitives.push(r)}y=t.offset;l=t.offset;F=0;J.length=0;break}J.push(t);l+=t.nbIndices;F+=t.nbIndices}}}for(var O=0;O<I.length;O++){var P=I[O];var S=(P.connectivity===g.ConnectivityTypeEnum.TRIANGLES)?4:((P.connectivity===g.ConnectivityTypeEnum.LINES)?1:0);var G=(S===4)?2:S;var o=new g.DrawingGroup(g.convertToMaterial3js(P.attr,G),P.material,S,P.vertexComponents[0].offset,P.nbIndices,undefined,undefined,e.GeomTypeEnum[P.geomType]);o._geomType=P.geomType?e.GeomTypeEnum[P.geomType]:0;o.nonIndexed=true;w.drawingGroups.push(o);var r=new g.SGPrimitive({cgmId:P.identifier,rep:w.rep,group:o,start:P.vertexComponents[0].offset,count:P.nbIndices});o.primitives.push(r);w.rep.primitives.push(r)}var V=new e.Color();var T=new e.Color();var q=new e.Color();if(D.fillAttr.color){V.setRGB(D.fillAttr.color.r,D.fillAttr.color.g,D.fillAttr.color.b)}if(D.lineAttr.color){T.setRGB(D.lineAttr.color.r,D.lineAttr.color.g,D.lineAttr.color.b)}w.gas.fill={color:V,opacity:(D.fillAttr.color.a==undefined?1:D.fillAttr.color.a),solid:D.fillAttr.solid};w.gas.line={color:T,opacity:(D.lineAttr.color.a==undefined?1:D.lineAttr.color.a),lineWidth:D.lineAttr.thickness,pattern:(D.lineAttr.pattern||1)};if(D.pointAttr){if(D.pointAttr.color){q.setRGB(D.pointAttr.color.r,D.pointAttr.color.g,D.pointAttr.color.b)}w.gas.point={color:q,opacity:(D.pointAttr.color.a==undefined?1:D.pointAttr.color.a),pointsize:D.pointAttr.size}}var U=[0,0,0];var A=[0,0,0];if(w.vertexPositionArray){var H=w.vertexPositionArray.length;if(H>=3){U=[w.vertexPositionArray[0],w.vertexPositionArray[1],w.vertexPositionArray[2]];A=[w.vertexPositionArray[0],w.vertexPositionArray[1],w.vertexPositionArray[2]];for(var K=0;K<H;K+=3){if(w.vertexPositionArray[K]<U[0]){U[0]=w.vertexPositionArray[K]}if(w.vertexPositionArray[K+1]<U[1]){U[1]=w.vertexPositionArray[K+1]}if(w.vertexPositionArray[K+2]<U[2]){U[2]=w.vertexPositionArray[K+2]}if(w.vertexPositionArray[K]>A[0]){A[0]=w.vertexPositionArray[K]}if(w.vertexPositionArray[K+1]>A[1]){A[1]=w.vertexPositionArray[K+1]}if(w.vertexPositionArray[K+2]>A[2]){A[2]=w.vertexPositionArray[K+2]}}}}w.AABB={min:U,max:A};return w};g.convertToGeometry3js=function(s,G,S,r,p){var I=r;var k=[];var E=0;var D=0;var A=s.nbPrimitives;for(var P=0;P<A;P++){var u=s.primitives[P];var O=0;var x=k.length;for(O=0;O<x;O++){var z=k[O];if((z.connectivity==u.connectivity)&&(z.geomType==u.geomType)&&g.isEqualGAS(z.gas,u.attr)&&(((z.material==null)&&(u.material==null))||((z.material.id==u.material.id)&&(z.material.file==u.material.file)))){E+=u.nbIndices;switch(z.connectivity){case g.ConnectivityTypeEnum.TRIANGLE_STRIP:case g.ConnectivityTypeEnum.TRIANGLE_FAN:D+=(u.nbIndices-3)*2;z.more_indices+=(u.nbIndices-3)*2;break;case g.ConnectivityTypeEnum.LINE_STRIP:D+=u.nbIndices-2;z.more_indices+=u.nbIndices-2;break;default:break}z.set.push(u);z.nbIndices+=u.nbIndices;break}}if(O==k.length){var w={};w.connectivity=u.connectivity;w.geomType=u.geomType;w.gas=u.attr;w.material=u.material;w.nbIndices=u.nbIndices;w.more_indices=0;w.set=[];w.set.push(u);k.push(w);E+=u.nbIndices;switch(k[O].connectivity){case g.ConnectivityTypeEnum.TRIANGLE_STRIP:case g.ConnectivityTypeEnum.TRIANGLE_FAN:D+=(u.nbIndices-3)*2;w.more_indices=(u.nbIndices-3)*2;break;case g.ConnectivityTypeEnum.LINE_STRIP:D+=u.nbIndices-2;w.more_indices=u.nbIndices-2;break;default:break}}}k.sort(function(W,n){if(W.connectivity<n.connectivity){return -1}if(W.connectivity>n.connectivity){return 1}if(W.geomType&&n.geomType){var V=b[W.geomType];var j=b[n.geomType];if(V&&j){return V-j}}return 0});var t=[];for(var O=0;O<k.length;O++){var w=k[O];for(var P=0;P<w.set.length;P++){t.push(w.set[P])}}var J=null;if((p==undefined)||(p=="multi")){J=(G!==undefined)?g.deMultiIndex(t,s.buffers,G,S):g.deMultiIndex(t,s.buffers)}else{J=(G!==undefined)?g.monoIndex(t,s.buffers,G,S):g.monoIndex(t,s.buffers)}var y=new g.Mesh();y.vertexPositionArray=J.VB[0];y.vertexNormalArray=J.VB[1];y.vertexColorArray=J.VB[2];y.vertexUvArray=J.VB[3];y.vertexUv2Array=J.VB[4];y.vertexTangentArray=J.VB[5];y.vertexBinormalArray=J.VB[6];var N=new Uint32Array(E+D);var K=0,m=0;for(var T=0;T<k.length;T++){var w=k[T];var M=(w.material==null)?s.material:w.material,l;switch(w.connectivity){case g.ConnectivityTypeEnum.TRIANGLES:l=new g.DrawingGroup(g.convertToMaterial3js(w.gas,2),M,4,m,w.nbIndices,undefined,undefined,e.GeomTypeEnum[w.geomType]);l._geomType=w.geomType?e.GeomTypeEnum[w.geomType]:0;y.drawingGroups.push(l);for(var P=0;P<w.set.length;P++){var u=w.set[P];var v=new g.MeshPrimitive(u.identifier,l,m,u.nbIndices);if(u.cgmId){v.cgmId=u.cgmId}if(u.decoration){v.decoration=u.decoration}if(u.boundingSphere){v.boundingSphere=u.boundingSphere}l.primitives.push(v);for(var O=0;O<u.nbIndices;O++){N[m++]=J.IB[K++]}}break;case g.ConnectivityTypeEnum.TRIANGLE_FAN:l=new g.DrawingGroup(g.convertToMaterial3js(w.gas,2),M,4,m,w.nbIndices+w.more_indices,undefined,undefined,e.GeomTypeEnum[w.geomType]);l._geomType=w.geomType?e.GeomTypeEnum[w.geomType]:0;y.drawingGroups.push(l);for(var P=0;P<w.set.length;P++){var u=w.set[P];var F=m;var q=K;for(var O=0;O<u.nbIndices-2;O++){N[m++]=J.IB[q];N[m++]=J.IB[K+1];N[m++]=J.IB[K+2];K++}K+=2;var v=new g.MeshPrimitive(u.identifier,l,F,m-F);if(u.cgmId){v.cgmId=u.cgmId}if(u.decoration){v.decoration=u.decoration}if(u.boundingSphere){v.boundingSphere=u.boundingSphere}l.primitives.push(v)}break;case g.ConnectivityTypeEnum.TRIANGLE_STRIP:l=new g.DrawingGroup(g.convertToMaterial3js(w.gas,2),M,4,m,w.nbIndices+w.more_indices,undefined,undefined,e.GeomTypeEnum[w.geomType]);l._geomType=w.geomType?e.GeomTypeEnum[w.geomType]:0;y.drawingGroups.push(l);for(var P=0;P<w.set.length;P++){var u=w.set[P];var F=m;var C=0;for(var O=0;O<u.nbIndices-2;O++){N[m++]=J.IB[K];N[m++]=J.IB[K+1+C];N[m++]=J.IB[K+2-C];K++;C=1-C}K+=2;var v=new g.MeshPrimitive(u.identifier,l,F,m-F);if(u.cgmId){v.cgmId=u.cgmId}if(u.decoration){v.decoration=u.decoration}if(u.boundingSphere){v.boundingSphere=u.boundingSphere}l.primitives.push(v)}break;case g.ConnectivityTypeEnum.LINES:if(M){M.shading="Basic"}l=new g.DrawingGroup(g.convertToMaterial3js(w.gas,1),M,1,m,w.nbIndices,undefined,undefined,e.GeomTypeEnum[w.geomType]);l._geomType=w.geomType?e.GeomTypeEnum[w.geomType]:0;y.drawingGroups.push(l);for(var P=0;P<w.set.length;P++){var u=w.set[P];var v=new g.MeshPrimitive(u.identifier,l,m,u.nbIndices);if(u.cgmId){v.cgmId=u.cgmId}if(u.decoration){v.decoration=u.decoration}if(u.boundingSphere){v.boundingSphere=u.boundingSphere}l.primitives.push(v);for(var O=0;O<u.nbIndices;O++){N[m++]=J.IB[K++]}}break;case g.ConnectivityTypeEnum.LINE_STRIP:if(M){M.shading="Basic"}l=new g.DrawingGroup(g.convertToMaterial3js(w.gas,1),M,1,m,w.nbIndices+w.more_indices,undefined,undefined,e.GeomTypeEnum[w.geomType]);l._geomType=w.geomType?e.GeomTypeEnum[w.geomType]:0;y.drawingGroups.push(l);for(var P=0;P<w.set.length;P++){var u=w.set[P];var F=m;for(var O=0;O<u.nbIndices-1;O++){N[m++]=J.IB[K++];N[m++]=J.IB[K]}K++;var v=new g.MeshPrimitive(u.identifier,l,F,m-F);if(u.cgmId){v.cgmId=u.cgmId}if(u.decoration){v.decoration=u.decoration}if(u.boundingSphere){v.boundingSphere=u.boundingSphere}l.primitives.push(v)}break;case g.ConnectivityTypeEnum.POINTS:l=new g.DrawingGroup(g.convertToMaterial3js(w.gas,0),M,0,m,w.nbIndices,undefined,undefined,e.GeomTypeEnum[w.geomType]);l._geomType=w.geomType?e.GeomTypeEnum[w.geomType]:0;y.drawingGroups.push(l);for(var P=0;P<w.set.length;P++){var u=w.set[P];var v=new g.MeshPrimitive(u.identifier,l,m,u.nbIndices);if(u.cgmId){v.cgmId=u.cgmId}if(u.decoration){v.decoration=u.decoration}if(u.boundingSphere){v.boundingSphere=u.boundingSphere}l.primitives.push(v);for(var O=0;O<u.nbIndices;O++){N[m++]=J.IB[K++]}}break}}y.vertexIndexArray=N;var U=new e.Color();var Q=new e.Color();var o=new e.Color();if(s.fillAttr.color){U.setRGB(s.fillAttr.color.r,s.fillAttr.color.g,s.fillAttr.color.b)}if(s.lineAttr.color){Q.setRGB(s.lineAttr.color.r,s.lineAttr.color.g,s.lineAttr.color.b)}y.gas.fill={color:U,opacity:(s.fillAttr.color.a==undefined?1:s.fillAttr.color.a),solid:s.fillAttr.solid};y.gas.line={color:Q,opacity:(s.lineAttr.color.a==undefined?1:s.lineAttr.color.a),lineWidth:s.lineAttr.thickness,pattern:(s.lineAttr.pattern||1)};if(s.pointAttr){if(s.pointAttr.color){o.setRGB(s.pointAttr.color.r,s.pointAttr.color.g,s.pointAttr.color.b)}y.gas.point={color:o,opacity:(s.pointAttr.color.a==undefined?1:s.pointAttr.color.a),pointsize:s.pointAttr.size}}if(!I){var R=[0,0,0];var B=[0,0,0];if(y.vertexPositionArray){var H=y.vertexPositionArray.length;if(H>=3){R=[y.vertexPositionArray[0],y.vertexPositionArray[1],y.vertexPositionArray[2]];B=[y.vertexPositionArray[0],y.vertexPositionArray[1],y.vertexPositionArray[2]];for(var L=0;L<H;L+=3){if(y.vertexPositionArray[L]<R[0]){R[0]=y.vertexPositionArray[L]}if(y.vertexPositionArray[L+1]<R[1]){R[1]=y.vertexPositionArray[L+1]}if(y.vertexPositionArray[L+2]<R[2]){R[2]=y.vertexPositionArray[L+2]}if(y.vertexPositionArray[L]>B[0]){B[0]=y.vertexPositionArray[L]}if(y.vertexPositionArray[L+1]>B[1]){B[1]=y.vertexPositionArray[L+1]}if(y.vertexPositionArray[L+2]>B[2]){B[2]=y.vertexPositionArray[L+2]}}}}y.AABB={min:R,max:B}}return y};g.monoIndex=function(E,t,C,m){var z=0;for(var F=0;F<E.length;F++){z+=E[F].nbIndices}var H=[];for(var F=0;F<g.NumberOfComponents;F++){H[F]=[]}var o=0;var F;for(F=0;F<t.length;F++){var B=t[F];if(B==null){continue}if(B.component>=g.NumberOfComponents){continue}if(B.indexBuffer||!B.data.length){continue}if((B._isPlanar!==undefined)&&B._isPlanar){continue}var p=0;var s=H[B.component].length;if(s){var x=H[B.component][s-1];p=x.offset+x.buffer.data.length/3}H[B.component].push({buffer:B,offset:p});B._newOffset=p;if(p+B.data.length/3>o){o=p+B.data.length/3}}for(F=0;F<t.length;F++){var B=t[F];if(B==null){continue}if(B.component>=g.NumberOfComponents){continue}if(B.indexBuffer||!B.data.length){continue}if((B._isPlanar==undefined)||!B._isPlanar){continue}var p=o;H[B.component].push({buffer:B,offset:p});B._newOffset=p}var q=new Uint32Array(z);var r=[];for(var F=0;F<g.NumberOfComponents;F++){var s=H[F].length;if(s){var J=H[F][s-1];r[F]=new Float32Array(3*J.offset+J.buffer.data.length);var p=0;for(var D=0;D<s;D++){var B=H[F][D];var n=B.buffer.data.length;var K=B.buffer.data;if(p<3*B.offset){for(var A=p;A<3*B.offset;A++){r[F][A]=0}p=3*B.offset}if(C==null){for(var A=0;A<n;A++){r[F][p+A]=K[A]}}else{for(var A=0;A<n;A+=3){var v=new e.Vector3(K[A],K[A+1],K[A+2]);if(F==1){v.applyMatrix4(m)}else{if(F==0){v.applyMatrix4(C)}}r[F][p+A]=v.x;r[F][p+A+1]=v.y;r[F][p+A+2]=v.z}}p+=n}}else{r[F]=null}}var w=0;for(var F=0;F<E.length;F++){var u=E[F];var y=u.vertexComponents[0];var I=t[y.bufferId];if(I==undefined){continue}var G=I._newOffset;if(y.indices!=null){var l=t[y.indices.bufferId];for(var A=0;A<u.nbIndices;A++){q[w+A]=l.data[y.indices.offset+A]+G}}else{for(var A=0;A<u.nbIndices;A++){q[w+A]=G+y.offset+A}}w+=u.nbIndices}return{IB:q,VB:r}};g.deMultiIndex=function(J,t,G,p){if((G==undefined)||(p==undefined)){G=null}if((p!==undefined)&&(p instanceof e.Matrix4)){p=new e.Matrix4().copy(p);p.elements[12]=0;p.elements[13]=0;p.elements[14]=0}var A=0;for(var K=0;K<J.length;K++){A+=J[K].nbIndices}var u=[];var r=[];var y=0;for(var K=0;K<g.NumberOfComponents;K++){u[K]=null}for(var K=0;K<J.length;K++){var v=J[K];for(var I=0;I<v.nbVertexComponents;I++){var B=v.vertexComponents[I];if(u[B.component]==null){u[B.component]=[];r[B.component]=B.bufferId;for(var D=0;D<A;D++){u[B.component][D]=null}}var O=t[B.bufferId];var m=null;if(B.indices!=null){m=t[B.indices.bufferId]}if(m!=null){for(var D=0;D<v.nbIndices;D++){u[B.component][y+D]={bufferId:B.bufferId,index:B.offset+m.data[B.indices.offset+D]}}}else{for(var D=0;D<v.nbIndices;D++){u[B.component][y+D]={bufferId:B.bufferId,index:B.offset+D}}}}y+=v.nbIndices}var H=[];for(var I=0;I<A;I++){var N=new g.MultiIndexMultiBuffer();N.old_index=I;for(var K=0;K<g.NumberOfComponents;K++){if(u[K]!==null){N.comp[K]=u[K][I]}}H.push(N)}H.sort(function(k,j){var R=0,Q=0;for(var P=0;P<g.NumberOfComponents;P++){if((k.comp[P]==null)||(j.comp[P]==null)){if(k.comp[P]==null){R++}if(j.comp[P]==null){Q++}continue}if(k.comp[P].index<j.comp[P].index){return -1}if(k.comp[P].index>j.comp[P].index){return 1}if(k.comp[P].bufferId<j.comp[P].bufferId){return -1}if(k.comp[P].bufferId>j.comp[P].bufferId){return 1}}if(R<Q){return -1}if(R>Q){return 1}return 0});var n=new Uint32Array(A);var o=[];for(var K=0;K<g.NumberOfComponents;K++){if(u[K]===null){o[K]=null;continue}var M=t[r[K]].dimension;o[K]=new Float32Array(M*A)}var F=-1;var L=null;for(var K=0;K<H.length;K++){var N=H[K];var q=N.old_index;if(!K||!N.componentsEqual(L)){F++;L=N;for(var I=0;I<g.NumberOfComponents;I++){if(N.comp[I]==null){continue}var z=t[N.comp[I].bufferId].data;var E=t[N.comp[I].bufferId].dimension;if(G==null){for(var D=0;D<E;D++){o[I][E*F+D]=z[E*u[I][N.old_index].index+D]}}else{var w=new e.Vector3(z[3*u[I][N.old_index].index],z[3*u[I][N.old_index].index+1],z[3*u[I][N.old_index].index+2]);if(I==1){w.applyMatrix4(p);o[I][3*F]=w.x;o[I][3*F+1]=w.y;o[I][3*F+2]=w.z}else{if(I==0){w.applyMatrix4(G);o[I][3*F]=w.x;o[I][3*F+1]=w.y;o[I][3*F+2]=w.z}else{o[I][3*F]=w.x;o[I][3*F+1]=w.y;o[I][3*F+2]=w.z}}}}}n[q]=F}var x=[];for(var K=0;K<g.NumberOfComponents;K++){var s=o[K];if(s!==null){var l=t[r[K]].dimension*(F+1);var C=new Float32Array(l);for(var I=0;I<l;I++){C[I]=s[I]}x[K]=C}else{x[K]=null}}return{IB:n,VB:x}};g.MeshContextEnum={UNKNOWN:0,DATA:1,FLOATBUFFER:2,INDEXBUFFER:3,COMPRESSEDBUFFER:4,PRIMITIVE:5,VERTEXCOMPONENT:6,GRAPHICPROPERTIES:7,APPEARANCE:8,BAG:9,MESH:10,TEXT:11};g.NumberOfComponents=7;g.MultiIndex=function(){this.old_index=0;this.comp=[];this.comp[0]=-1;this.comp[1]=-1;this.comp[2]=-1;this.comp[3]=-1;this.comp[4]=-1;this.comp[5]=-1;this.comp[6]=-1};g.MultiIndex.prototype={constructor:g.MultiIndex,componentsEqual:function(k){for(var j=0;j<g.NumberOfComponents;j++){if((this.comp[j]==-1)||(k.comp[j]==-1)){continue}if(this.comp[j]!=k.comp[j]){return false}}return true}};g.MultiIndexMultiBuffer=function(){this.old_index=0;this.comp=[];for(var j=0;j<g.NumberOfComponents;j++){this.comp[j]=null}};g.MultiIndexMultiBuffer.prototype={constructor:g.MultiIndexMultiBuffer,componentsEqual:function(k){for(var j=0;j<g.NumberOfComponents;j++){if((this.comp[j]==null)||(k.comp[j]==null)){continue}if(this.comp[j].bufferId!=k.comp[j].bufferId){return false}if(this.comp[j].index!=k.comp[j].index){return false}}return true}};g.Node=function(p,m,o,k,j,l,n){this.id=p!==undefined?p:"";this.type=m!==undefined?m:"Bag";this.childNodes=o!==undefined?o:[];this.matrix=k!==undefined?k:null;this.position=j!==undefined?j:{};this.rotation=l!==undefined?l:{};this.scale=n!==undefined?n:{}};g.Node.prototype={constructor:g.Node,add:function(j){if(j!=null){this.childNodes.push(j)}},childClone:function(){var j=new Array();for(var k in this.childNodes){j[k]=typeof(this.childNodes[k])=="object"?this.childNodes[k].clone():this.childNodes[k]}return j},matrixClone:function(){if(this.matrix){var j=new e.Matrix4();j.copy(this.matrix);return j}},clone:function(){return new g.Node(this.id,this.type,this.childClone(),this.matrixClone(),this.position,this.rotation,this.scale)}};g.Mesh=function(j,r,k,q,u,m,n,p,l,o,t,s){this.id=j!==undefined?j:"";this.type=r!==undefined?r:"Mesh";this.vertexPositionArray=k!==undefined?k:null;this.vertexNormalArray=q!==undefined?q:null;this.vertexIndexArray=u!==undefined?u:null;this.vertexUvArray=m!==undefined?m:null;this.drawingGroups=n!==undefined?n:[];this.gas=p!==undefined?p:{fill:{},line:{}};this.AABB=l!==undefined?l:{};this._radius=0;this.material=o!==undefined?o:null;this.matrix=s!==undefined?s:null;this.rep=t!==undefined?new g.SGRep({cgmId:t.cgmId}):new g.SGRep()};g.Mesh.prototype={constructor:g.Mesh,setMatrix:function(j){this.matrix=j},indexCopy:function(){if(this.vertexIndexArray instanceof Uint32Array){return new Uint32Array(this.vertexIndexArray)}},tabCopy:function(j){if(j instanceof Float32Array){return new Float32Array(j)}},gasCopy:function(){var j;if(this.gas){j={fill:this.gas.fill,line:this.gas.line}}return j},dGCopy:function(){var j=new Array();for(var k in this.drawingGroups){j[k]=typeof(this.drawingGroups[k])=="object"?this.drawingGroups[k].clone():this.drawingGroups[k]}return j},clone:function(){var j=new g.Mesh(this.id,this.type,this.tabCopy(this.vertexPositionArray),this.tabCopy(this.vertexNormalArray),this.indexCopy(),this.tabCopy(this.vertexUvArray),this.dGCopy(),this.gasCopy(),this.AABB,this.material,this.rep);if(this.vertexBinormalArray){j.vertexBinormalArray=this.tabCopy(this.vertexBinormalArray)}if(this.vertexTangentArray){j.vertexTangentArray=this.tabCopy(this.vertexTangentArray)}return j}};g.MeshPrimitive=function(n,l,m,k,j){this.cgmId=n||0;this.groupIndex=l||0;this.start=m||0;this.count=k||0;this.boundingSphere=undefined;this.rep=0;this.decoration=j||0};g.MeshPrimitive.prototype={constructor:g.MeshPrimitive,clone:function(){if(this.boundingSphere){var j=new g.MeshPrimitive(this.cgmId,this.groupIndex,this.start,this.count,this.decoration);j.boundingSphere={center:this.boundingSphere.center,radius:this.boundingSphere.radius};return j}else{return this}},};g.DrawingGroup=function(n,m,o,j,l,r,k,q,p){this.gas=n||null;this.material=m||null;this.glType=o;this._geomType=q||0;this.gasIndex=p;this.start=j||0;this.count=l||0;this.primitives=r!==undefined?r:[];this.geometry=null;this.vbStart=-1;this.ib=null;this.idWideLine=-1;this.nonIndexed=false;this.lineStructure={sides:[],primitives:[]};this.cullingData=null};g.DrawingGroup.prototype={constructor:g.DrawingGroup,clone:function(){var j=new g.DrawingGroup(this.gas,this.material,this.glType,this.start,this.count,undefined,undefined,this._geomType,this.gasIndex);j.copyPrimitives(this.primitives);j.geometry=this.geometry;j.lineStructure.sides=this.lineStructure.sides.slice(0);j.lineStructure.primitives=this.lineStructure.primitives.slice(0);j.idWideLine=this.idWideLine;return j},copyPrimitives:function(m){var k=false;var j=null;for(var l=0;l<m.length;l++){j=m[l];if(j.boundingSphere){this.primitives.push(j.clone());k=true}else{var n=new g.SGPrimitive();n.cgmId=j.cgmId;n.rep=j.rep;n.group=this;n.start=j.start;n.count=j.count;this.primitives.push(n)}}},computeOrientedBoundingBox:function(s){if(!s){return null}var k=new e.Vector3();var o=new e.Vector3();var r=new e.Vector3();var q=this.geometry.vertexPositionArray;if(q){var p=this.start+this.count;var m=this.geometry.vertexIndexArray;if(q.length>=3){var j=3*m[this.start];o.set(q[j],q[j+1],q[j+2]).applyMatrix4(s);r.set(q[j],q[j+1],q[j+2]).applyMatrix4(s);for(var l=this.start+1;l<p;l++){var j=3*m[l];k.set(q[j],q[j+1],q[j+2]).applyMatrix4(s);if(k.x<o.x){o.x=k.x}if(k.y<o.y){o.y=k.y}if(k.z<o.z){o.z=k.z}if(k.x>r.x){r.x=k.x}if(k.y>r.y){r.y=k.y}if(k.z>r.z){r.z=k.z}}}}return new e.Box3(o,r)},disabled:function(j,k){k=k||0;if(k>0&&(this._geomType&k>0)){return true}return !((this._geomType&j)>0||this._geomType===0)},clonePrimitives:function(){var l=false;var k=[];var j=null;for(var m=0;m<this.primitives.length;m++){j=this.primitives[m];if(j.boundingSphere){k.push(j.clone());l=true}else{var n=new g.SGPrimitive();n.cgmId=j.cgmId;n.rep=j.rep;n.group=this;n.start=j.start;n.count=j.count;k.push(n)}}return k}};Object.defineProperty(g.DrawingGroup.prototype,"geomType",{get:function(){console.warn("[Mesh.DrawingGroup] DOT NOT ACCESS geomType directly !\n");return g.GeomTypeString[this._geomType]},set:function(j){console.warn("[Mesh.DrawingGroup] DOT NOT ACCESS geomType directly !\n");this._geomType=e.GeomTypeEnum[j]},});g.SelectionGroup=function(){this.geometries={}};g.SelectionGroup.prototype={constructor:g.SelectionGroup,contains:function(p){for(var o in this.geometries){var n=this.geometries[o];for(var m=0;m<n.length;m++){var q=n[m].primitives;for(var l=0;l<q.length;l++){if(q[l]===p){return true}}}}return false},getFirstPrimitive:function(){for(var k in this.geometries){var j=this.geometries[k];if(j.length&&j[0].primitives.length){return j[0].primitives[0]}}return null},getPrimitives:function(){var p=[];for(var o in this.geometries){var n=this.geometries[o];for(var m=0;m<n.length;m++){var q=n[m].primitives;for(var l=0;l<q.length;l++){p.push(q[l])}}}return p},addPrimitive:function(m){var k=0;var j=m.group.geometry.id;var l=this.geometries[j];if(!l){l=[];this.geometries[j]=l}for(k=0;k<l.length;k++){if(l[k].drawingGroup===m.group){l[k].primitives.push(m);break}}if(k===l.length){l.push({drawingGroup:m.group,primitives:[m]})}},clone:function(){var m=new g.SelectionGroup();for(var l in this.geometries){var n=this.geometries[l];m.geometries[l]=[];for(var k=0;k<n.length;k++){m.geometries[l][k]={drawingGroup:n[k].drawingGroup,primitives:n[k].primitives.slice()}}}return m},getIdentificationObject:function(){var k;var j=this.getFirstPrimitive();if(j&&j.getIdentificationObject){k=j.getIdentificationObject()}return k}};g.processRepsCGR=function(C,q,ao,Y,ae){var V=0;var aj=0;var Z=!q;var at=[];var N=5;var O=Y?Y:{};var s=0;var J=false;var F=false;var ax=false;var T=false;var ak=false;for(var an=0;an<C.length;an++){V+=C[an].vertexPositionArray?C[an].vertexPositionArray.length:0;aj+=C[an].vertexIndexArray.length;if(!J&&(C[an].vertexNormalArray!==null)){J=true}if(!F&&(C[an].vertexUvArray!==null)){F=true}if(!ax&&C[an].vertexUv2Array){ax=true}if(!T&&C[an].vertexTangentArray){T=true}if(!ak&&C[an].vertexBinormalArray){ak=true}}var u=new Float32Array(V);var U;if(V/3<65535){U=new Uint16Array(aj)}else{U=new Uint32Array(aj)}var o=J?new Float32Array(V):null;var p=F?new Float32Array(V):null;var r=ax?new Float32Array(V):null;var R=T?new Float32Array(V):null;var z=ak?new Float32Array(V):null;var aw=0;for(var an=0;an<C.length;an++){var ad=C[an];var I=ad.vertexPositionArray;if(I){u.set(I,aw);if(o!==null&&ad.vertexNormalArray){o.set(ad.vertexNormalArray,aw)}if(p!==null&&ad.vertexUvArray){p.set(ad.vertexUvArray,aw)}if(r!==null&&ad.vertexUv2Array){r.set(ad.vertexUv2Array,aw)}if(R!==null&&ad.vertexTangentArray){R.set(ad.vertexTangentArray,aw)}if(z!==null&&ad.vertexBinormalArray){z.set(ad.vertexBinormalArray,aw)}}for(var ap=0;ap<ad.drawingGroups.length;ap++){var E=ad.drawingGroups[ap];E.vbStart=aw/3;E.ib=ad.vertexIndexArray;E.geometry=C[an];if(E.gas==null){if((E.glType==4)||(E.glType==5)){E.gas=C[an].gas.fill}else{if(E.glType==1){E.gas=C[an].gas.line}else{if(E.glType==0){E.gas=C[an].gas.point}}}}for(var ar=0;ar<E.primitives.length;ar++){var D=E.primitives[ar];D.rep=ad.rep;if(D.boundingSphere){var A=new e.Vector3(D.boundingSphere.center[0],D.boundingSphere.center[1],D.boundingSphere.center[2]);var w=ad.globalMatrix?!ad.globalMatrix.isIdentity():false;if(w){A.applyMatrix4(C[an].globalMatrix);D.boundingSphere.center=[A.x,A.y,A.z]}}}at.push(E)}aw+=I?I.length:0}at.sort(function(m,k){if(m.glType<k.glType){return -1}if(m.glType>k.glType){return 1}if((m.material==null)&&(k.material!=null)){return -1}if((m.material!=null)&&(k.material==null)){return 1}if((m.material!=null)&&(k.material!=null)){if(m.material.id<k.material.id){return -1}if(m.material.id>k.material.id){return 1}if(m.material.file<k.material.file){return -1}if(m.material.file>k.material.file){return 1}}if((m.gas==null)&&(k.gas!=null)){return -1}if((m.gas!=null)&&(k.gas==null)){return -1}if((m.gas!=null)&&(k.gas!=null)){var n=g.compareGASMaterial(m.gas,k.gas);if(n){return n}}if(m._geomType&&k._geomType){if(m._geomType<k._geomType){return -1}if(m._geomType>k._geomType){return 1}if(ao){if(m.geometry._radius<k.geometry._radius){return 1}if(m.geometry._radius>k.geometry._radius){return -1}}}if(ao){if(m.geometry._radius<k.geometry._radius){return 1}if(m.geometry._radius>k.geometry._radius){return -1}}return 0});var ag=[];var H=[];var t=(at.length>0)?at[0].gas:null;var aq=(at.length>0)?at[0].material:null;var M=(at.length>0)?at[0].glType:0;var X=(at.length>0)?at[0]._geomType:0;var j=0;var P=0;var al=0;var l=0;var ai=t;var ac=[];var v=[];for(var an=0;an<at.length;an++){var E=at[an];if((E.glType==M)&&(E._geomType===X)&&!g.compareGASMaterial(t,E.gas)&&(((aq==null)&&(E.material==null))||(((aq!=null)&&(E.material!=null))&&(aq.id==E.material.id)&&(aq.file==E.material.file)))){if(ao){ac.push({start:j,count:E.count,radius:E.geometry._radius,rep:E.geometry.rep})}al+=E.count;v.push(E);for(var ap=0;ap<E.count;ap++){U[j++]=E.vbStart+E.ib[E.start+ap]}}else{var ab=false;var y=null;if(al>0){y=new g.DrawingGroup(t,at[an-1].material,M,P,al,undefined,undefined,X,l);if(ao){y.cullingData=ac}var L=0;for(var av=0;av<v.length;++av){L+=v[av].primitives.length}var af=new Uint32Array(N*L);var ah=0;var Q=P;var am=[];for(var B=0;B<v.length;++B){var x=v[B];var W=N*ah;if(x.geometry.noShow&&O.containNoShow){for(var av=0;av<x.primitives.length;av++){var D=x.primitives[av];am.push(ah);af[W++]=D.cgmId+1;af[W++]=D.rep;af[W++]=Q;af[W++]=D.count;af[W++]=D.decoration;ah++;Q+=D.count}}else{for(var av=0;av<x.primitives.length;av++){var D=x.primitives[av];af[W++]=D.cgmId+1;af[W++]=D.rep;af[W++]=Q;af[W++]=D.count;af[W++]=D.decoration;ah++;Q+=D.count}}}y.primitives=af;if(am.length){y.noShowPrim=am}v=[];ac=[];ag.push(y)}if(g.compareGASMaterial(ai,E.gas)!==0){ai=E.gas;l++}M=E.glType;X=E._geomType;t=E.gas;if(!ab){aq=E.material}P=j;al=E.count;v.push(E);if(ao){ac.push({start:j,count:E.count,radius:E.geometry._radius,rep:E.geometry.rep})}for(var ap=0;ap<E.count;ap++){U[j++]=E.vbStart+E.ib[E.start+ap]}}}if(al>0){var y=new g.DrawingGroup(t,at[at.length-1].material,M,P,al,undefined,undefined,X,l);if(ao){y.cullingData=ac}var L=0;for(var av=0;av<v.length;++av){L+=v[av].primitives.length}var af=new Uint32Array(N*L);var Q=P;var ah=0;var am=[];for(var B=0;B<v.length;++B){var E=v[B];var W=N*ah;if(E.geometry.noShow&&O.containNoShow){for(var av=0;av<E.primitives.length;av++){var D=E.primitives[av];am.push(ah);af[W++]=D.cgmId+1;af[W++]=D.rep;af[W++]=Q;af[W++]=D.count;af[W++]=D.decoration;ah++;Q+=D.count}}else{for(var av=0;av<E.primitives.length;av++){var D=E.primitives[av];af[W++]=D.cgmId+1;af[W++]=D.rep;af[W++]=Q;af[W++]=D.count;af[W++]=D.decoration;ah++;Q+=D.count}}}y.primitives=af;if(am.length){y.noShowPrim=am}ag.push(y)}var G=new g.Mesh();G.vertexPositionArray=u;G.vertexNormalArray=o;G.vertexUvArray=p;G.vertexUv2Array=r;G.vertexTangentArray=R;G.vertexBinormalArray=z;G.vertexIndexArray=U;G.drawingGroups=ag;if(C[0]===undefined){var au=1;var S=new e.Color();S.setRGB(0.5,0.5,0.5);G.gas.fill={color:S,opacity:au,solid:0};G.gas.line={color:S,opacity:au,lineWidth:1};G.gas.point={color:S,opacity:au,pointsize:1}}else{G.gas=C[0].gas}if(Z){var ay=[0,0,0];var K=[0,0,0];if(V>=3){ay=[u[0],u[1],u[2]];K=[u[0],u[1],u[2]];for(var an=0;an<V;an+=3){if(u[an]<ay[0]){ay[0]=u[an]}if(u[an+1]<ay[1]){ay[1]=u[an+1]}if(u[an+2]<ay[2]){ay[2]=u[an+2]}if(u[an]>K[0]){K[0]=u[an]}if(u[an+1]>K[1]){K[1]=u[an+1]}if(u[an+2]>K[2]){K[2]=u[an+2]}}}G.AABB={min:ay,max:K}}return G};g.processReps=function(A,r,ab){var P=0;var V=0;var R=!r;var af=[];var F=false;var D=false;var aj=false;var N=false;var W=false;for(var Z=0;Z<A.length;Z++){P+=A[Z].vertexPositionArray?A[Z].vertexPositionArray.length:0;V+=A[Z].vertexIndexArray.length;if(!F&&(A[Z].vertexNormalArray!==null)){F=true}if(!D&&(A[Z].vertexUvArray!==null)){D=true}if(!aj&&A[Z].vertexUv2Array){aj=true}if(!N&&A[Z].vertexTangentArray){N=true}if(!W&&A[Z].vertexBinormalArray){W=true}}var u=new Float32Array(P);var O;if(P/3<65535){O=new Uint16Array(V)}else{O=new Uint32Array(V)}var o=F?new Float32Array(P):null;var q=D?new Float32Array(P):null;var s=aj?new Float32Array(P):null;var L=N?new Float32Array(P):null;var y=W?new Float32Array(P):null;var ai=0;for(var Z=0;Z<A.length;Z++){if(A[Z].vertexPositionArray){for(var ac=0;ac<A[Z].vertexPositionArray.length;ac++){u[ai+ac]=A[Z].vertexPositionArray[ac];if(o!==null){o[ai+ac]=(A[Z].vertexNormalArray!==null)?A[Z].vertexNormalArray[ac]:0}if(q!==null){q[ai+ac]=(A[Z].vertexUvArray!==null)?A[Z].vertexUvArray[ac]:0}if(s!==null){s[ai+ac]=A[Z].vertexUv2Array?A[Z].vertexUv2Array[ac]:0}if(L!==null){L[ai+ac]=A[Z].vertexTangentArray?A[Z].vertexTangentArray[ac]:0}if(y!==null){y[ai+ac]=A[Z].vertexBinormalArray?A[Z].vertexBinormalArray[ac]:0}}}for(var ac=0;ac<A[Z].drawingGroups.length;ac++){var C=A[Z].drawingGroups[ac];C.vbStart=ai/3;C.ib=A[Z].vertexIndexArray;C.geometry=A[Z];if(C.gas==null){if((C.glType==4)||(C.glType==5)){C.gas=A[Z].gas.fill}else{if(C.glType==1){C.gas=A[Z].gas.line}else{if(C.glType==0){C.gas=A[Z].gas.point}}}}for(var ae=0;ae<C.primitives.length;ae++){var B=C.primitives[ae];B.rep=A[Z].rep;if(B.boundingSphere){var z=new e.Vector3(B.boundingSphere.center[0],B.boundingSphere.center[1],B.boundingSphere.center[2]);var v=A[Z].globalMatrix?!A[Z].globalMatrix.isIdentity():false;if(v){z.applyMatrix4(A[Z].globalMatrix);B.boundingSphere.center=[z.x,z.y,z.z]}}}af.push(C)}ai+=A[Z].vertexPositionArray?A[Z].vertexPositionArray.length:0}af.sort(function(m,k){if(m.glType<k.glType){return -1}if(m.glType>k.glType){return 1}if((m.material==null)&&(k.material!=null)){return -1}if((m.material!=null)&&(k.material==null)){return 1}if((m.material!=null)&&(k.material!=null)){if(m.material.id<k.material.id){return -1}if(m.material.id>k.material.id){return 1}if(m.material.file<k.material.file){return -1}if(m.material.file>k.material.file){return 1}}if((m.gas==null)&&(k.gas!=null)){return -1}if((m.gas!=null)&&(k.gas==null)){return -1}if((m.gas!=null)&&(k.gas!=null)){var n=g.compareGASMaterial(m.gas,k.gas);if(n){return n}}if(m._geomType&&k._geomType){if(m._geomType<k._geomType){return -1}if(m._geomType>k._geomType){return 1}if(m.geometry._radius<k.geometry._radius){return 1}if(m.geometry._radius>k.geometry._radius){return -1}}if(m.geometry._radius<k.geometry._radius){return 1}if(m.geometry._radius>k.geometry._radius){return -1}return 0});var T=[];var G=[];var t=(af.length>0)?af[0].gas:null;var ad=(af.length>0)?af[0].material:null;var I=(af.length>0)?af[0].glType:0;var Q=(af.length>0)?af[0]._geomType:0;var j=0;var J=0;var X=0;var l=0;var U=t;var S=[];for(var Z=0;Z<af.length;Z++){var C=af[Z];if((C.glType==I)&&(C._geomType===Q)&&!g.compareGASMaterial(t,C.gas)&&(((ad==null)&&(C.material==null))||(((ad!=null)&&(C.material!=null))&&(ad.id==C.material.id)&&(ad.file==C.material.file)))){if(ab){S.push({start:j,count:C.count,radius:C.geometry._radius,rep:C.geometry.rep})}X+=C.count;var K=j;for(var ah=0;ah<C.primitives.length;ah++){var B=C.primitives[ah];var w=new g.SGPrimitive({cgmId:B.cgmId,rep:B.rep,start:K,count:B.count});if(B.decoration){w.decoration=B.decoration}if(B.boundingSphere){w.boundingSphere=B.boundingSphere}G.push(w);B.rep.primitives.push(w);K+=B.count}for(var ac=0;ac<C.count;ac++){O[j++]=C.vbStart+C.ib[C.start+ac]}}else{var x=null;if(X>0){x=new g.DrawingGroup(t,ad,I,J,X,undefined,undefined,Q,l);x.primitives=G;if(ab){x.cullingData=S}for(var Y=0;Y<G.length;Y++){G[Y].group=x}G=[];S=[];T.push(x)}if(g.compareGASMaterial(U,C.gas)!==0){U=C.gas;l++}I=C.glType;Q=C._geomType;t=C.gas;ad=C.material;J=j;X=C.count;if(ab){S.push({start:j,count:C.count,radius:C.geometry._radius,rep:C.geometry.rep})}var K=j;for(var ah=0;ah<C.primitives.length;ah++){var B=C.primitives[ah];var w=new g.SGPrimitive({cgmId:B.cgmId,rep:B.rep,start:K,count:B.count});if(B.decoration){w.decoration=B.decoration}if(B.boundingSphere){w.boundingSphere=B.boundingSphere}G.push(w);B.rep.primitives.push(w);K+=B.count}for(var ac=0;ac<C.count;ac++){O[j++]=C.vbStart+C.ib[C.start+ac]}}}if(X>0){var x=new g.DrawingGroup(t,ad,I,J,X,undefined,undefined,Q,l);x.primitives=G;if(ab){x.cullingData=S}for(var Y=0;Y<G.length;Y++){G[Y].group=x}T.push(x)}var E=new g.Mesh();E.vertexPositionArray=u;E.vertexNormalArray=o;E.vertexUvArray=q;E.vertexUv2Array=s;E.vertexTangentArray=L;E.vertexBinormalArray=y;E.vertexIndexArray=O;E.drawingGroups=T;if(A[0]===undefined){var ag=1;var M=new e.Color();M.setRGB(0.5,0.5,0.5);E.gas.fill={color:M,opacity:ag,solid:0};E.gas.line={color:M,opacity:ag,lineWidth:1};E.gas.point={color:M,opacity:ag,pointsize:1}}else{E.gas=A[0].gas}if(R){var ak=[0,0,0];var H=[0,0,0];if(P>=3){ak=[u[0],u[1],u[2]];H=[u[0],u[1],u[2]];for(var Z=0;Z<P;Z+=3){if(u[Z]<ak[0]){ak[0]=u[Z]}if(u[Z+1]<ak[1]){ak[1]=u[Z+1]}if(u[Z+2]<ak[2]){ak[2]=u[Z+2]}if(u[Z]>H[0]){H[0]=u[Z]}if(u[Z+1]>H[1]){H[1]=u[Z+1]}if(u[Z+2]>H[2]){H[2]=u[Z+2]}}}E.AABB={min:ak,max:H}}return E};g.divideRep=function(ah,af,ae){var z=ah.vertexPositionArray?ah.vertexPositionArray.length:0;var y=ah.vertexIndexArray.length;var ac=[];var P=ae?ae:{};if(af){var M=5;var P=ae?ae:{};var s=0;var ai=null;for(var ar=0;ar<ah.drawingGroups.length;ar++){var w=ah.drawingGroups[ar];if(w.gas==null){if((w.glType==4)||(w.glType==5)){w.gas=ah.gas.fill}else{if(w.glType==1){w.gas=ah.gas.line}else{if(w.glType==0){w.gas=ah.gas.point}}}}s=w.primitives.length;ai=new Uint32Array(M*s);var ad=0;if(ah.noShow&&P.containNoShow){for(var at=0;at<w.primitives.length;at++){var B=w.primitives[at];noShowPrim.push(at);ai[ad++]=B.cgmId+1;ai[ad++]=ah.rep;ai[ad++]=B.start;ai[ad++]=B.count;ai[ad++]=B.decoration}}else{for(var at=0;at<w.primitives.length;at++){var B=w.primitives[at];ai[ad++]=B.cgmId+1;ai[ad++]=ah.rep;ai[ad++]=B.start;ai[ad++]=B.count;ai[ad++]=B.decoration}}w.primitives=ai}}else{for(var at=0;at<ah.drawingGroups.length;at++){var w=ah.drawingGroups[at];if(w.gas==null){if((w.glType==4)||(w.glType==5)){w.gas=ah.gas.fill}else{if(w.glType==1){w.gas=ah.gas.line}else{if(w.glType==0){w.gas=ah.gas.point}}}}for(var ar=0;ar<w.primitives.length;ar++){var B=w.primitives[ar];var x=new g.SGPrimitive({cgmId:B.cgmId,rep:ah.rep,group:w,start:B.start,count:B.count});if(B.decoration){x.decoration=B.decoration}if(B.boundingSphere){x.boundingSphere=B.boundingSphere}w.primitives[ar]=x;ah.rep.primitives.push(x)}}}var V=ah.vertexIndexArray;var U;if(z/3<65535){U=new Uint16Array(V.length)}else{U=new Uint32Array(V.length)}for(var at=0;at<V.length;at++){U[at]=V[at]}ah.vertexIndexArray=U;g.unindexPoints(ah);ac.push(ah);return ac;var K=(ah.vertexNormalArray!==null);var F=(ah.vertexUvArray!==null);var au=!!ah.vertexUv2Array;var T=!!ah.vertexTangentArray;var am=!!ah.vertexBinormalArray;var o=!!ah.vertexColorArray;var A=z/3;var W=new Int32Array(A);var r=0;var N=[];var t=[];var av=[];var ag=[];var G=[];var q=[];var m=[];var R=[];var ak=[];var ab=[];var D=196605;var u=0;var C=0;var O=0;var Y=new Float32Array(D);var J=K?new Float32Array(D):null;var al=F?new Float32Array(D):null;var S=au?new Float32Array(D):null;var v=T?new Float32Array(D):null;var aj=am?new Float32Array(D):null;var Z=o?new Float32Array(4*D/3):null;var ap=new Uint16Array(y);while((u<ah.drawingGroups.length-1)||(C<ah.drawingGroups[u].primitives.length)){var I=false;var X=0;var p=0;var aq=[];for(var an=0;an<A;an++){W[an]=-1}for(var ar=u;ar<ah.drawingGroups.length;ar++){var E=ah.drawingGroups[ar];if(E.gas==null){if((E.glType==4)||(E.glType==5)){E.gas=ah.gas.fill}else{if(E.glType==1){E.gas=ah.gas.line}else{if(E.glType==0){E.gas=ah.gas.point}}}}var w=new g.DrawingGroup(E.gas,E.material,E.glType,X,0);w.geomType=E._geomType;for(var ao=C;ao<E.primitives.length;ao++){var B=E.primitives[ao];var Q=X;for(var an=B.start+O;an<B.start+B.count;an++){var ad=ah.vertexIndexArray[an];if(W[ad]==-1){ap[X]=p;for(var l=0;l<3;l++){Y[3*p+l]=ah.vertexPositionArray[3*ad+l];if(K){J[3*p+l]=ah.vertexNormalArray[3*ad+l]}if(F){al[3*p+l]=ah.vertexUvArray[3*ad+l]}if(au){S[3*p+l]=ah.vertexUv2Array[3*ad+l]}if(T){v[3*p+l]=ah.vertexTangentArray[3*ad+l]}if(am){aj[3*p+l]=ah.vertexBinormalArray[3*ad+l]}if(o){Z[4*p+l]=ah.vertexColorArray[4*ad+l]}}if(o){Z[4*p+3]=ah.vertexColorArray[4*ad+3]}if(p>=65535){I=true;break}W[ad]=p;p++}else{ap[X]=W[ad]}X++}if(I){if(Q==0){if(E.glType==4){X=3*Math.floor(X/3)}else{if(E.glType==1){X=2*Math.floor(X/2)}}O+=X;var x=new g.SGPrimitive({cgmId:B.cgmId,rep:ah.rep,group:w,start:0,count:X});if(B.decoration){x.decoration=B.decoration}if(B.boundingSphere){x.boundingSphere=B.boundingSphere}w.count+=X;w.primitives.push(x);ah.rep.primitives.push(x)}C=ao;break}var x=new g.SGPrimitive({cgmId:B.cgmId,rep:ah.rep,group:w,start:Q,count:B.count-O});if(B.decoration){x.decoration=B.decoration}if(B.boundingSphere){x.boundingSphere=B.boundingSphere}w.count+=B.count-O;O=0;w.primitives.push(x);ah.rep.primitives.push(x)}aq.push(w);if(I){u=ar;break}C=0}ak[r]=new Uint16Array(X);t[r]=new Float32Array(3*p);for(var at=0;at<X;++at){ak[r][at]=ap[at]}for(var at=0;at<3*p;++at){t[r][at]=Y[at]}if(K){av[r]=new Float32Array(3*p);for(var at=0;at<3*p;++at){av[r][at]=J[at]}}else{av[r]=null}if(F){ag[r]=new Float32Array(3*p);for(var at=0;at<3*p;++at){ag[r][at]=al[at]}}else{ag[r]=null}if(au){G[r]=new Float32Array(3*p);for(var at=0;at<3*p;++at){G[r][at]=S[at]}}else{G[r]=null}if(T){q[r]=new Float32Array(3*p);for(var at=0;at<3*p;++at){q[r][at]=v[at]}}else{q[r]=null}if(am){m[r]=new Float32Array(3*p);for(var at=0;at<3*p;++at){m[r][at]=aj[at]}}else{m[r]=null}if(o){R[r]=new Float32Array(4*p);for(var at=0;at<4*p;++at){R[r][at]=Z[at]}}else{R[r]=null}ab.push(aq);r++;if(!I){break}}ac=[];for(var at=0;at<r;at++){var H=new g.Mesh();H.vertexPositionArray=t[at];H.vertexNormalArray=av[at];H.vertexUvArray=ag[at];H.vertexUv2Array=G[at];H.vertexTangentArray=q[at];H.vertexBinormalArray=m[at];H.vertexColorArray=R[at];H.vertexIndexArray=ak[at];H.drawingGroups=ab[at];H.gas=ah.gas;H.rep=ah.rep;var aw=[0,0,0];var L=[0,0,0];if(t[at].length>=3){aw=[t[at][0],t[at][1],t[at][2]];L=[t[at][0],t[at][1],t[at][2]];for(var an=0;an<t[at].length;an+=3){if(t[at][an]<aw[0]){aw[0]=t[at][an]}if(t[at][an+1]<aw[1]){aw[1]=t[at][an+1]}if(t[at][an+2]<aw[2]){aw[2]=t[at][an+2]}if(t[at][an]>L[0]){L[0]=t[at][an]}if(t[at][an+1]>L[1]){L[1]=t[at][an+1]}if(t[at][an+2]>L[2]){L[2]=t[at][an+2]}}}H.AABB={min:aw,max:L};g.unindexPoints(H);ac.push(H)}return ac};g.unindexPoints=function(l){if(!(h||f)){return false}if(!l.vertexPositionArray){return false}var q,p;var y=false;var w=l.vertexPositionArray.length/3;var s=new Int32Array(w);for(q=0;q<w;q++){s[q]=-1}var x=0;for(q=0;q<l.drawingGroups.length;q++){var u=l.drawingGroups[q];if(u.glType>0){continue}y=true;for(p=u.start;p<u.start+u.count;p++){var v=l.vertexIndexArray[p];if(s[v]===-1){l.vertexIndexArray[p]=x;s[v]=x;x++}else{l.vertexIndexArray[p]=s[v]}}}if(!y){return false}var t=x;for(q=0;q<x;q++){if(s[q]===-1){while(t<w){if(s[t]!==-1){s[q]=t;t++;break}s[t]=t;t++}}}while(t<w){if(s[t]===-1){s[t]=t}t++}for(q=0;q<l.drawingGroups.length;q++){var u=l.drawingGroups[q];if(u.glType===0){continue}for(p=u.start;p<u.start+u.count;p++){var v=l.vertexIndexArray[p];l.vertexIndexArray[p]=s[v]}}var z=[];l.vertexPositionArray&&z.push(l.vertexPositionArray);l.vertexNormalArray&&z.push(l.vertexNormalArray);l.vertexUvArray&&z.push(l.vertexUvArray);l.vertexUv2Array&&z.push(l.vertexUv2Array);l.vertexTangentArray&&z.push(l.vertexTangentArray);l.vertexBinormalArray&&z.push(l.vertexBinormalArray);var n=new Float32Array(3*z.length);var m=new Float32Array(3*z.length);for(q=0;q<w;q++){var k=q;var r=s[k];if((r===k)||(r===-1)){continue}for(p=0;p<z.length;p++){var o=z[p];n[3*p]=o[3*k];n[3*p+1]=o[3*k+1];n[3*p+2]=o[3*k+2]}while(r!==-1){for(p=0;p<z.length;p++){var o=z[p];m[3*p]=o[3*r];m[3*p+1]=o[3*r+1];m[3*p+2]=o[3*r+2];o[3*r]=n[3*p];o[3*r+1]=n[3*p+1];o[3*r+2]=n[3*p+2];n[3*p]=m[3*p];n[3*p+1]=m[3*p+1];n[3*p+2]=m[3*p+2]}s[k]=-1;k=r;r=s[k]}}l.vertexPositionArray.nonindexedPoints=true;return true};g.compareGASMaterial=function(j,k){if(j.opacity<k.opacity){return -1}if(j.opacity>k.opacity){return 1}if(j.color.r<k.color.r){return -1}if(j.color.r>k.color.r){return 1}if(j.color.g<k.color.g){return -1}if(j.color.g>k.color.g){return 1}if(j.color.b<k.color.b){return -1}if(j.color.b>k.color.b){return 1}if(j.thickness&&k.thickness){if(j.thickness<k.thickness){return -1}if(j.thickness>k.thickness){return 1}}if(j.lineWidth&&k.lineWidth){if(j.pattern<k.pattern){return -1}if(j.pattern>k.pattern){return 1}if(j.lineWidth<k.lineWidth){return -1}if(j.lineWidth>k.lineWidth){return 1}if(j.forceMaterial||k.forceMaterial){if(!(j.forceMaterial&&k.forceMaterial)){if(j.forceMaterial){return -1}else{return 1}}}}if(j.pointsize&&k.pointsize){if(j.pointsize<k.pointsize){return -1}if(j.pointsize>k.pointsize){return 1}if(j.forceMaterial||k.forceMaterial){if(!(j.forceMaterial&&k.forceMaterial)){if(j.forceMaterial){return -1}else{return 1}}}}if(j.symbol&&k.symbol){if(j.symbol<k.symbol){return -1}if(j.symbol>k.symbol){return 1}if(j.symbol.id<k.symbol.id){return -1}if(j.symbol.id>k.symbol.id){return 1}}if(j.solid!=undefined&&k.solid!=undefined){if(j.solid<k.solid){return -1}if(j.solid>k.solid){return 1}}return 0};g.applyMat=function(q,o,k){if(o!=null){if(q.vertexNormalArray){var l=new e.Matrix4();l.copy(o);l.elements[12]=0;l.elements[13]=0;l.elements[14]=0;for(var x=0;x<q.vertexNormalArray.length;x+=3){var t=new e.Vector3(q.vertexNormalArray[x],q.vertexNormalArray[x+1],q.vertexNormalArray[x+2]);t.applyMatrix4(l);q.vertexNormalArray[x]=t.x;q.vertexNormalArray[x+1]=t.y;q.vertexNormalArray[x+2]=t.z}}if(q.vertexPositionArray){for(var x=0;x<q.vertexPositionArray.length;x+=3){var t=new e.Vector3(q.vertexPositionArray[x],q.vertexPositionArray[x+1],q.vertexPositionArray[x+2]);t.applyMatrix4(o);q.vertexPositionArray[x]=t.x;q.vertexPositionArray[x+1]=t.y;q.vertexPositionArray[x+2]=t.z}var z=q.drawingGroups;for(var x=0;x<z.length;++x){var y=z[x];var s=y.material;var B=!s||s.id<0||!k[s.id].physicalMaterial||(!k[s.id].physicalMaterial.PhysicalMaterial.MappingOperator&&!k[s.id].mapping)||(k[s.id].physicalMaterial.PhysicalMaterial.MappingOperator&&k[s.id].physicalMaterial.PhysicalMaterial.MappingOperator.Type=="None")||(k[s.id].mapping&&k[s.id].mapping.type<0);if(!B){var A=new e.Matrix4().getInverse(o);var r=JSON.parse(JSON.stringify(k[s.id]));var u=r.physicalMaterial.PhysicalMaterial.MappingOperator;if(!u){u=r.mapping}if(u){if(u.UvTransformation){u.UvTransformation=u.UvTransformation.slice(0)}}var v=new e.Matrix4();if(u&&u.ObjectTransformation){v.elements=u.ObjectTransformation.slice(0)}v.multiply(A);u.ObjectTransformation=v.elements;y.material.id=k.length;k.push(r)}}if(o.determinant()<0){for(var x=0;x<z.length;++x){var y=z[x];if(y.glType==4){var p=y.count/3;for(var w=0;w<p;w++){var n=q.vertexIndexArray[y.start+3*w];var m=q.vertexIndexArray[y.start+3*w+1];q.vertexIndexArray[y.start+3*w]=m;q.vertexIndexArray[y.start+3*w+1]=n}}}}}}};g.computeBB=function(o){var k=[0,0,0];var j=[0,0,0];if(o.vertexPositionArray){var l=o.vertexPositionArray.length;if(l>=3){k=[o.vertexPositionArray[0],o.vertexPositionArray[1],o.vertexPositionArray[2]];j=[o.vertexPositionArray[0],o.vertexPositionArray[1],o.vertexPositionArray[2]];for(var m=0;m<l;m+=3){if(o.vertexPositionArray[m]<k[0]){k[0]=o.vertexPositionArray[m]}if(o.vertexPositionArray[m+1]<k[1]){k[1]=o.vertexPositionArray[m+1]}if(o.vertexPositionArray[m+2]<k[2]){k[2]=o.vertexPositionArray[m+2]}if(o.vertexPositionArray[m]>j[0]){j[0]=o.vertexPositionArray[m]}if(o.vertexPositionArray[m+1]>j[1]){j[1]=o.vertexPositionArray[m+1]}if(o.vertexPositionArray[m+2]>j[2]){j[2]=o.vertexPositionArray[m+2]}}}}o.AABB={min:k,max:j}};return g});define("Mesh/Mesh",["DS/Mesh/Mesh","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Mesh/Mesh");return b});define("DS/Visualization/SectionBuilder",["UWA/Class","DS/Mesh/Mesh"],function(b,e){var d=function(j,k){var h=j.length;var l=k;while(l<h){j[l]=j[l+1];l++}j.length--};var a=function(j,k,n){var h=j.length;var o=k;var m;var l=n;do{m=j[o];j[o]=l;l=m;o++}while(o<=h)};var g=function(j,n,m){var l=n[0];var k=n[1];var h=m[0];var o=m[1];if(j[3*l]<j[3*h]){return -1}else{if(j[3*l]>j[3*h]){return 1}else{if(j[3*l+1]<j[3*h+1]){return -1}else{if(j[3*l+1]>j[3*h+1]){return 1}else{if(j[3*l+2]<j[3*h+2]){return -1}else{if(j[3*l+2]>j[3*h+2]){return 1}else{if(j[3*k]<j[3*o]){return -1}else{if(j[3*k]>j[3*o]){return 1}else{if(j[3*k+1]<j[3*o+1]){return -1}else{if(j[3*k+1]>j[3*o+1]){return 1}else{if(j[3*k+2]<j[3*o+2]){return -1}else{if(j[3*k+2]>j[3*o+2]){return 1}else{return 0}}}}}}}}}}}}};var f=function(j){var h=1;while(h<j){h*=2}return h};var c=b.extend({init:function(k,j,h){this.lineWidth=h||1;this.wide=this.lineWidth>1?true:false;this._renderable=k;this.resetBuffers();this.renderer=j;this.sectionLineGeometry=null},resetBuffers:function(){this.indexArray=null;this.currentsArray=null;this.edgeLastIndexArray=null;this._Id=0;this._edgeId=0;this.halfEdges=[];this.halfEdgesStructure=null;this._positionArray=null},allocateArrays:function(j){if(this.wide){this.indexArray=new Uint32Array(3*j*2);var h=6*j;this.currentsArray=new Float32Array(h*2);this.edgeLastIndexArray=new Float32Array(6*j*2)}else{this.indexArray=new Uint32Array(j*2);var h=6*j;this.currentsArray=new Float32Array(h);this.edgeLastIndexArray=new Float32Array(6*j)}},addEdgeIndices:function(l,k,j){var r=this.indexArray;var s=this.currentsArray;var q=this.edgeLastIndexArray;var h=this._edgeId;if(this.wide){var p=h*4;var o=h*4+1;var n=h*4+2;var m=h*4+3;r[h*6]=p;r[h*6+1]=n;r[h*6+2]=m;r[h*6+3]=p;r[h*6+4]=m;r[h*6+5]=o;s[2*6*h]=l;s[2*6*h+1]=k;s[2*6*h+2]=j;s[2*6*h+3]=l;s[2*6*h+3+1]=k;s[2*6*h+3+2]=j;s[2*6*h+6]=k;s[2*6*h+6+1]=j;s[2*6*h+6+2]=l;s[2*6*h+9]=k;s[2*6*h+9+1]=j;s[2*6*h+9+2]=l;q[2*6*h]=+1;q[2*6*h+1]=+1;q[2*6*h+2]=0;q[2*6*h+3]=+1;q[2*6*h+3+1]=-1;q[2*6*h+3+2]=0;q[2*6*h+6]=-1;q[2*6*h+6+1]=+1;q[2*6*h+6+2]=0;q[2*6*h+9]=-1;q[2*6*h+9+1]=-1;q[2*6*h+9+2]=0}else{r[h*2]=h*2;r[h*2+1]=h*2+1;s[6*h]=l;s[6*h+1]=k;s[6*h+2]=j;s[6*h+3]=k;s[6*h+4]=j;s[6*h+5]=l;q[6*h]=+1;q[6*h+1]=0;q[6*h+2]=0;q[6*h+3]=-1;q[6*h+4]=0;q[6*h+5]=0}this._edgeId++},processTriangleIndices:function(k,j,h,l){this.addEdgeIndices(k,j,h);this.addEdgeIndices(j,h,k);this.addEdgeIndices(h,k,j)},computeSectionLineGeometry:function(G){var L=THREEDS.Core;var l,D;var z,x,u;var v=this._renderable;var s=[];var y=0;var E=0;if(!v.layer){s=v.geometry;var q=v.geometry.length;for(var F=0;F<q;F++){var w=v.geometry[F];y+=w.drawingGroups.length;for(var K=0;K<w.drawingGroups.length;K++){var I=w.drawingGroups[K];E+=(I._geomType===L.GeomTypeEnum.FACE)?I.count:0}}}else{var t={};for(var F=0;F<v.layer.layers.length;F++){var I=v.layer.layers[F].drawableGroup;var J=v.layer.layers[F].drawableInterval;if(J.layerNum<1){continue}t[I.geometry.id]=I.geometry;E+=(I._geomType===L.GeomTypeEnum.FACE)?J.count:0}for(var F in t){s.push(t[F])}}if(E===0){return null}this.allocateArrays(E);var r;var n=0;var m=0;var p=[];var M=[];for(var F=0;F<s.length;F++){p[F]=n;M[F]=m;n+=s[F].vertexIndexArray.length;m+=s[F].vertexPositionArray.length}if(s.length===1){l=s[0].vertexIndexArray;D=s[0].vertexPositionArray}else{l=new Uint32Array(n);D=new Float32Array(m);var C=0;var H=0;for(var F=0;F<s.length;F++){var h=s[F];for(var B=0;B<h.vertexIndexArray.length;B++){l[C]=(M[F]/3)+h.vertexIndexArray[B];C++}for(var B=0;B<h.vertexPositionArray.length;B++){D[H]=h.vertexPositionArray[B];H++}}}this.halfEdgesStructure={};r=l.length;this.maxIndices=r;this._positionArray=D;if(!v.layer){var q=s.length;for(var F=0;F<q;F++){var w=s[F];for(var K=0;K<w.drawingGroups.length;K++){var I=w.drawingGroups[K];if(I._geomType===L.GeomTypeEnum.FACE){for(var A=p[F]+I.start;A<p[F]+I.start+I.count;A+=3){z=l[A];x=l[A+1];u=l[A+2];if(!(z===x||x===u||z===u)){this.processTriangleIndices(z,x,u,r)}}}}}}else{for(var F=0;F<v.layer.layers.length;F++){var I=v.layer.layers[F].drawableGroup;var J=v.layer.layers[F].drawableInterval;if(J.layerNum<1){continue}if(I._geomType===L.GeomTypeEnum.FACE){var o=s.indexOf(I.geometry);for(var A=p[o]+J.start;A<p[o]+J.start+J.count;A+=3){z=l[A];x=l[A+1];u=l[A+2];if(!(z===x||x===u||z===u)){this.processTriangleIndices(z,x,u,r)}}}}}this.sectionLineGeometry=this.createNewGeometry();this.resetBuffers()},createNewGeometry:function(p){var G=THREEDS.Core;var n=this.indexArray.length;var x;var D=["uniform sampler2D outlinePositionMaps[NB_OUTLINE_MAPS];","uniform int currentClipPlane;",].join("\n");var o=["float getDist(vec4 pos) {","  vec4 clipPlaneEquation = clipPlaneEquations[currentClipPlane];","  float dist = dot( pos.xyz, clipPlaneEquation.xyz ) + clipPlaneEquation.w;","  return dist;","}","vec4 getIntersection( vec4 M, vec4 N) {","  vec4 clipPlaneEquation = clipPlaneEquations[currentClipPlane];","  vec3 direction = vec3(N.x - M.x, N.y - M.y, N.z - M.z);","  vec4 result;","  float t;","  float denominator = dot(direction, clipPlaneEquation.xyz);","  if(denominator == 0.0) {","    return M;","  } else {","    t = -(dot(M.xyz, clipPlaneEquation.xyz) + clipPlaneEquation.w) / denominator;","    result = vec4(t*direction+M.xyz, 1.0);","    return result;","  }","}","float far;","float near;"].join("\n");var k=["vec4 mvPosition = mvCurrInter;","  gl_Position = projectionMatrix * mvCurrInter;","if(hide) {","  gl_Position.z = 10000000.0 * far;","}"].join("\n");var A=["float i1 = position.x;","float i2 = position.y;","float i3 = position.z;","float ori = uv.x;","float maxMapTotalSize = MAX_OUTLINE_MAP_SIZE*MAX_OUTLINE_MAP_SIZE;","int texId_1 = int(floor(i1/maxMapTotalSize));","int texId_2 = int(floor(i2/maxMapTotalSize));","int texId_3 = int(floor(i3/maxMapTotalSize));","float dx_1, dx_2, dx_3;","float dy_1, dy_2, dy_3;","float x_1, x_2, x_3;","float y_1, y_2, y_3;","float idInTexture_1 = i1 - float(texId_1)*maxMapTotalSize;","float idInTexture_2 = i2 - float(texId_2)*maxMapTotalSize;","float idInTexture_3 = i3 - float(texId_3)*maxMapTotalSize;","if (texId_1 == NB_OUTLINE_MAPS - 1) {","dx_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_1 = floor(idInTexture_1/LAST_OUTLINE_MAP_SIZE_X);","x_1 = idInTexture_1 - y_1*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_1 = floor(idInTexture_1/MAX_OUTLINE_MAP_SIZE);","x_1 = idInTexture_1 - y_1*MAX_OUTLINE_MAP_SIZE;","}","if (texId_2 == NB_OUTLINE_MAPS - 1) {","dx_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_2 = floor(idInTexture_2/LAST_OUTLINE_MAP_SIZE_X);","x_2 = idInTexture_2 - y_2*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_2 = floor(idInTexture_2/MAX_OUTLINE_MAP_SIZE);","x_2 = idInTexture_2 - y_2*MAX_OUTLINE_MAP_SIZE;","}","if (texId_3 == NB_OUTLINE_MAPS - 1) {","dx_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_3 = floor(idInTexture_3/LAST_OUTLINE_MAP_SIZE_X);","x_3 = idInTexture_3 - y_3*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_3 = floor(idInTexture_3/MAX_OUTLINE_MAP_SIZE);","x_3 = idInTexture_3 - y_3*MAX_OUTLINE_MAP_SIZE;","}","vec3 P = texture2D( outlinePositionMaps[texId_1], vec2( dx_1 * ( x_1 + 0.5 ), dy_1 * ( y_1 + 0.5 ) ) ).xyz;","vec3 M = texture2D( outlinePositionMaps[texId_2], vec2( dx_2 * ( x_2 + 0.5 ), dy_2 * ( y_2 + 0.5 ) ) ).xyz;","vec3 N = texture2D( outlinePositionMaps[texId_3], vec2( dx_3 * ( x_3 + 0.5 ), dy_3 * ( y_3 + 0.5 ) ) ).xyz;","float m22 = projectionMatrix[2][2];","float m32 = projectionMatrix[3][2];","bool isPersp = projectionMatrix[2][3] == -1.0;","if (isPersp) {","near = m32 / (m22 - 1.0);","far = ((m22 - 1.0)*near)/(m22 + 1.0);","} else {","near = (m32+1.0)/m22;","far = near - 2.0/m22;","}",].join("\n");if(this.wide){x=new G.ShaderMaterialDS({uniforms:G.UniformsUtils.merge([{outlinePositionMaps:{type:"tv",value:null},currentClipPlane:{type:"i",value:0},sectionLineHalfWidth:{type:"f",value:0.5*this.lineWidth},pixelSize:{type:"v2",value:new G.Vector2()},color:{type:"c",value:new G.Color(0)}},G.UniformsLib.clipPlanes,]),vertexShaderPars:[G.ShaderChunk.clip_pars_vertex,D,"uniform vec2 pixelSize;","uniform float sectionLineHalfWidth;","varying vec2 screenCurr;","varying vec2 screenOpp;",o,"float linearizeNDC(in float iNonLinearNDC) {","	float z01 = 0.5*iNonLinearNDC + 0.5;","	float res = 2.0*near/(far + near - z01*(far - near));","	res = res *2.0 - 1.0;","	return res;","}",].join("\n"),vertexShaderBody:[A,G._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvP","vec4(P,1.0)"),G._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvM","vec4(M,1.0)"),G._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvN","vec4(N,1.0)"),"vec4 mvCurrInter = mvP;","vec4 mvOtherInter = mvM;","bool hide = true;","if (ori > 0.0 && getDist(mvP) > 0.0 && getDist(mvM) < 0.0) {","  mvCurrInter = getIntersection(mvP, mvM);","  if(getDist(mvN) > 0.0) {","    mvOtherInter = getIntersection(mvM, mvN);","  } else {","    mvOtherInter = getIntersection(mvN, mvP);","  }","  hide = false;","}","if (ori < 0.0 && getDist(mvP) < 0.0 && getDist(mvN) > 0.0) {","  if(getDist(mvM) < 0.0) {","    mvCurrInter = getIntersection(mvM, mvN);","  } else {","    mvCurrInter = getIntersection(mvM, mvP);","  }","  mvOtherInter = getIntersection(mvN, mvP);","  hide = false;","}","vec4 mvpCurr = projectionMatrix*vec4(mvCurrInter.xyz,1.0);","vec4 mvpOpp = projectionMatrix*vec4(mvOtherInter.xyz,1.0);","screenCurr = (mvpCurr.xy / mvpCurr.w + 1.0) / pixelSize;","screenOpp = (mvpOpp.xy / mvpOpp.w + 1.0) / pixelSize;","vec4 mvPosition = mvCurrInter;","vec3 ndcCurr = mvpCurr.xyz/mvpCurr.w;","vec3 ndcOpp = mvpOpp.xyz/mvpOpp.w;","float sideExtrusion = uv.y*ori;","float offset = sign(sideExtrusion) * sectionLineHalfWidth;","vec2 line = normalize(screenOpp - screenCurr);","vec2 lineNormal = vec2(-line.y, line.x);","vec2 ptAlongLine = screenCurr - sectionLineHalfWidth*line;","vec2 ndcPtAlongLine = ptAlongLine*pixelSize - 1.0;","float ndcD = length(ndcCurr.xy - ndcPtAlongLine);","float lengthCurrOpp = length(ndcCurr.xy - ndcOpp.xy);","float ndcZDelta = ndcD*abs(ndcCurr.z-ndcOpp.z)/lengthCurrOpp;","float ndcZDeltaLin = ndcD*abs(linearizeNDC(ndcCurr.z)-linearizeNDC(ndcOpp.z))/lengthCurrOpp;","vec2 px_pos;","if (ndcZDeltaLin > 0.7*ndcD) {","px_pos = screenCurr + offset*lineNormal;","ndcZDelta = 0.0;","} else {","px_pos = screenCurr + offset*lineNormal - sectionLineHalfWidth*line;","}","ndcZDelta *= sign(ndcCurr.z - ndcOpp.z);","float ndcFinalZ = mvpCurr.z/mvpCurr.w + ndcZDelta;","vec3 ndcPos = vec3((px_pos*pixelSize - 1.0), ndcFinalZ);","if (ori < 0.0) {","vec2 tmp = screenCurr;","screenCurr = screenOpp;","screenOpp = tmp;","}","vec4 clipSpacePos = vec4(ndcPos*mvpCurr.w, mvpCurr.w);","gl_Position = clipSpacePos;","if(hide) {","  gl_Position.z = 10000000.0 * far;","}",G.ShaderChunk.clip_vertex].join("\n"),fragmentShaderPars:["varying vec2 screenCurr;","varying vec2 screenOpp;","uniform float sectionLineHalfWidth;","uniform vec3 color;",G.ShaderChunk.clip_pars_fragment].join("\n"),fragmentShaderBody:[G.ShaderChunk.clip_fragment,"gl_FragColor = vec4(color, 1.0);","vec2 fCoord = gl_FragCoord.xy;","vec2 currOpp = screenOpp - screenCurr;","vec2 currFcoord = fCoord - screenCurr;","vec2 oppFcoord = fCoord - screenOpp;","bool toDiscard = false;","if (dot(currOpp, currFcoord ) < 0.0) {","if (length(currFcoord) > sectionLineHalfWidth) toDiscard = true;","} else if (dot(-currOpp, oppFcoord ) < 0.0) {","if (length(oppFcoord) > sectionLineHalfWidth) toDiscard = true;","} ","if (toDiscard) discard;"].join("\n")})}else{x=new G.ShaderMaterialDS({uniforms:G.UniformsUtils.merge([{outlinePositionMaps:{type:"tv",value:null},currentClipPlane:{type:"i",value:0},color:{type:"c",value:new G.Color(0)}},G.UniformsLib.clipPlanes,]),vertexShaderPars:[G.ShaderChunk.clip_pars_vertex,D,o,].join("\n"),vertexShaderBody:[A,G._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvP","vec4(P,1.0)"),G._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvM","vec4(M,1.0)"),G._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvN","vec4(N,1.0)"),"vec4 mvCurrInter = mvP;","bool hide = true;","if (ori > 0.0 && getDist(mvP) > 0.0 && getDist(mvM) < 0.0) {","  mvCurrInter = getIntersection(mvP, mvM);","  hide = false;","}","if (ori < 0.0 && getDist(mvP) < 0.0 && getDist(mvN) > 0.0) {","  if(getDist(mvM) < 0.0) {","    mvCurrInter = getIntersection(mvM, mvN);","  } else {","    mvCurrInter = getIntersection(mvM, mvP);","  }","  hide = false;","}",k,G.ShaderChunk.clip_vertex].join("\n"),fragmentShaderPars:["uniform vec3 color;",G.ShaderChunk.clip_pars_fragment].join("\n"),fragmentShaderBody:[G.ShaderChunk.clip_fragment,"gl_FragColor = vec4(color, 1.0);"].join("\n")})}if(this.wide){x.refreshUniforms=function(I,t,H){x.uniforms.pixelSize.value.x=2/I.domElement.width;x.uniforms.pixelSize.value.y=2/I.domElement.height}}x.force=true;x.enableClipPlanes=true;x.side=G.DoubleSide;x.polygonOffset=true;var E=new e.DrawingGroup(x,x,this.wide?4:1,0,n);var B=new G.BufferGeometryDS();B.drawingGroups=[];E.geometry=B;B.drawingGroups.push(E);B.vertexPositionArray=this.currentsArray;B.vertexUvArray=this.edgeLastIndexArray;B.vertexIndexArray=this.indexArray;B.boundingSphere=this._renderable.boundingSphere;B.boundingBox=this._renderable.boundingBox;var j=[];var C=debugWebGLV6Viewer.renderer.renderer.context;var F=C.getParameter(C.MAX_TEXTURE_SIZE);var u=F*F;var l=this._positionArray.length/3;var q=Math.ceil(l/u);var h=(l-Math.floor(l/u)*u);var r=Math.sqrt(h);var w=f(r);var v=f(h/w);var z=((q-1)*u+w*v)*3;var s=new Float32Array(z);s.set(this._positionArray);for(var y=0;y<q-1;y++){var m=new G.DataTexture(s.subarray(y*u*3,(y+1)*u*3),F,F,G.RGBFormat,G.FloatType);m.minFilter=G.NearestFilter;m.magFilter=G.NearestFilter;m.generateMipmaps=false;m.flipY=false;m.needsUpdate=true;j.push(m)}var m=new G.DataTexture(s.subarray((q-1)*u*3,z),w,v,G.RGBFormat,G.FloatType);m.minFilter=G.NearestFilter;m.magFilter=G.NearestFilter;m.generateMipmaps=false;m.flipY=false;m.needsUpdate=true;j.push(m);x.uniforms.outlinePositionMaps.value=j;x.defines={NB_OUTLINE_MAPS:q,MAX_OUTLINE_MAP_SIZE:F.toFixed(1),LAST_OUTLINE_MAP_SIZE_X:w.toFixed(1),LAST_OUTLINE_MAP_SIZE_Y:v.toFixed(1)};return B}});return c});define("DS/Visualization/ThreeJS_DS",["UWA/Class","DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh","DS/Shaders/DeferredShaders","DS/Shaders/AdvancedHighlightShader","DS/Shaders/AdvancedPreHighlightShader","DS/Shaders/AdvancedHighlightShaderSinglePass"],function(a,j,d,b,g,k,f){j.mobileVersion=false;if(!window.webVisuPerfo){window.webVisuPerfo={startPerfo:function(){},endPerfo:function(){}}}var h=j.Constants;j.Matrix4.prototype.equals=function(l,n){var q=this.elements;var p=l.elements;if(n===undefined){for(var o=0;o<16;o++){if(q[o]!==p[o]){return false}}}else{for(var o=0;o<16;o++){if(Math.abs(q[o]-p[o])>n){return false}}}return true};j.Matrix4.prototype.setRotation=function(l){var m=this.elements;m[0]=l[0];m[4]=l[1];m[8]=l[2];m[1]=l[3];m[5]=l[4];m[9]=l[5];m[2]=l[6];m[6]=l[7];m[10]=l[8];return this};j.Quaternion.prototype.toEuler=function(){var l=new j.Vector3();l.x=Math.atan2(2*(this.w*this.x+this.y*this.z),1-2*(this.x*this.x+this.y*this.y));l.y=Math.asin(2*(this.w*this.y-this.z*this.x));l.z=Math.atan2(2*(this.w*this.z+this.x*this.y),1-2*(this.y*this.y+this.z*this.z));return l};j.BoundingSphere=function(m,l,n){j.Sphere.call(this,m,l);this.state=0;n&&this.setState(n)};j.BoundingSphere.prototype=Object.create(j.Sphere.prototype);j.BoundingSphere.prototype.states=["EMPTY","NORMAL","INFINITE"];j.BoundingSphere.prototype.setState=function(l){this.state=this.states.indexOf(l)};j.BoundingSphere.prototype.getState=function(){return this.states[this.state]};j.Box3.prototype.getPlanes=function(){var o=new j.Vector3();var n=new j.Vector3();var l=null;var m=[];o.set(this.min.x,this.max.y,this.min.z);n.set(this.min.x,this.min.y,this.max.z);l=new j.Plane();l.setFromCoplanarPoints(this.min,n,o);m.push(l);o.set(this.max.x,this.min.y,this.min.z);l=new j.Plane();l.setFromCoplanarPoints(this.min,o,n);m.push(l);n.set(this.min.x,this.max.y,this.min.z);l=new j.Plane();l.setFromCoplanarPoints(this.min,n,o);m.push(l);o.set(this.max.x,this.max.y,this.min.z);n.set(this.max.x,this.min.y,this.max.z);l=new j.Plane();l.setFromCoplanarPoints(this.max,n,o);m.push(l);n.set(this.min.x,this.max.y,this.max.z);l=new j.Plane();l.setFromCoplanarPoints(this.max,o,n);m.push(l);o.set(this.max.x,this.min.y,this.max.z);l=new j.Plane();l.setFromCoplanarPoints(this.max,n,o);m.push(l);return m};j.Frustum.__v2=new j.Vector3();j.Frustum.prototype.intersectsObject=function(n,s,q){var l,p=this.planes,u=n._getMMMatrix(),t=n.geometry.boundingSphere,r=-t.radius*u.getMaxScaleOnAxis(),m=j.Frustum.__v2;if(t!==null){m.copy(t.center)}else{m.set(0,0,0)}m.applyMatrix4(u);for(var o=0;o<6;o++){l=p[o].distanceToPoint(m);if(l<=r){return false}}return true};j.Frustum.prototype.performFrustumCulling=function(l,o){var p=this.planes;var s=0;var n=-l;var m=null;var r=null;for(var q=0;q<6;q++){m=p[q];r=m.normal;s=r.x*o.x+r.y*o.y+r.z*o.z+m.constant;if(s<=n){return false}}return true};j.Frustum.prototype.performFrustumCullingNoNearFar=function(l,o){var p=this.planes;var s=0;var n=-l;var m=null;var r=null;for(var q=0;q<4;q++){m=p[q];r=m.normal;s=r.x*o.x+r.y*o.y+r.z*o.z+m.constant;if(s<=n){return false}}return true};j.Frustum.prototype.getCorners=function(){var m=[];var n=new j.Matrix4();var l=new j.Matrix4();var p=this;function o(t,s,r){var w=p.planes[t];var v=p.planes[s];var u=p.planes[r];n.set(w.normal.x,w.normal.y,w.normal.z,0,v.normal.x,v.normal.y,v.normal.z,0,u.normal.x,u.normal.y,u.normal.z,0,0,0,0,1);l.getInverse(n);var q=new j.Vector4().set(-w.constant,-v.constant,-u.constant,1);q.applyMatrix4(l);return q}m[0]=o(1,2,5);m[1]=o(0,2,5);m[2]=o(0,3,5);m[3]=o(1,3,5);m[4]=o(1,2,4);m[5]=o(0,2,4);m[6]=o(0,3,4);m[7]=o(1,3,4);return m};j.CGPolygon=function(){this.corner=[]};j.CGPolygon.prototype={constructor:j.CGPolygon,clone:function(n){var l=n?n:new j.CGPolygon();l.empty();for(var m=0;m<this.corner.length;m++){l.addPoint(this.corner[m])}return l},empty:function(){this.corner=[]},applyMatrix4:function(l){for(var m=0;m<this.corner.length;m++){this.corner[m].applyMatrix4(l)}return this},addPoint:function(l){this.corner.push(new j.Vector3().copy(l));return this},addPoints:function(l){this.corner=l;return this},addPointAtIndex:function(m,l){this.corner[m]=new j.Vector3();this.corner[m].copy(l);return this},clipByPlane:function(r,q){var s=new j.CGPolygon();var m=this.corner.length;if(m<3){return s}var t=[];for(var p=0;p<m;p++){t[p]=(r.distanceToPoint(this.corner[p])>0)}for(var p=0;p<m;p++){var o=(p+1)%m;if(t[p]&&t[o]){continue}if(t[p]){var n=new j.Vector3();var l=new j.Line3(this.corner[p],this.corner[o]);if(r.intersectLine(l,n)!==undefined){q.addPoint(n);s.addPoint(n)}q.addPoint(this.corner[o]);continue}if(t[o]){var n=new j.Vector3();var l=new j.Line3(this.corner[p],this.corner[o]);if(r.intersectLine(l,n)!==undefined){q.addPoint(n);s.addPoint(n)}continue}q.addPoint(this.corner[o])}if(s.corner.length&&(s.corner.length!==2)){this.clone(q);s.empty()}return s}};j.CGPoly=function(){this.polygon=[];return this};j.CGPoly.prototype={constructor:j.CGPoly,addPolygon:function(l){this.polygon.push(l)},removePolygon:function(l){if(l>=this.polygon.length||l<0){console.log("CGPoly: trying to remove a polygon which does not exist !");return}this.polygon.splice(l,1)},empty:function(){this.polygon=[]},clone:function(n){var l=n?n:new j.CGPoly();l.empty();for(var m=0;m<this.polygon.length;m++){l.addPolygon(this.polygon[m].clone())}return l},applyMatrix4:function(l){for(var m=0;m<this.polygon.length;m++){this.polygon[m].applyMatrix4(l)}return this},setFromBox:function(m){var l=new j.CGPolygon();l.addPoint(new j.Vector3().copy(m.min));l.addPoint(new j.Vector3(m.min.x,m.min.y,m.max.z));l.addPoint(new j.Vector3(m.min.x,m.max.y,m.max.z));l.addPoint(new j.Vector3(m.min.x,m.max.y,m.min.z));this.addPolygon(l);l=new j.CGPolygon();l.addPoint(new j.Vector3().copy(m.min));l.addPoint(new j.Vector3(m.min.x,m.max.y,m.min.z));l.addPoint(new j.Vector3(m.max.x,m.max.y,m.min.z));l.addPoint(new j.Vector3(m.max.x,m.min.y,m.min.z));this.addPolygon(l);l=new j.CGPolygon();l.addPoint(new j.Vector3().copy(m.min));l.addPoint(new j.Vector3(m.max.x,m.min.y,m.min.z));l.addPoint(new j.Vector3(m.max.x,m.min.y,m.max.z));l.addPoint(new j.Vector3(m.min.x,m.min.y,m.max.z));this.addPolygon(l);var l=new j.CGPolygon();l.addPoint(new j.Vector3().copy(m.max));l.addPoint(new j.Vector3(m.max.x,m.min.y,m.max.z));l.addPoint(new j.Vector3(m.max.x,m.min.y,m.min.z));l.addPoint(new j.Vector3(m.max.x,m.max.y,m.min.z));this.addPolygon(l);var l=new j.CGPolygon();l.addPoint(new j.Vector3().copy(m.max));l.addPoint(new j.Vector3(m.max.x,m.max.y,m.min.z));l.addPoint(new j.Vector3(m.min.x,m.max.y,m.min.z));l.addPoint(new j.Vector3(m.min.x,m.max.y,m.max.z));this.addPolygon(l);var l=new j.CGPolygon();l.addPoint(new j.Vector3().copy(m.max));l.addPoint(new j.Vector3(m.min.x,m.max.y,m.max.z));l.addPoint(new j.Vector3(m.min.x,m.min.y,m.max.z));l.addPoint(new j.Vector3(m.max.x,m.min.y,m.max.z));this.addPolygon(l)},setFromFrustumPoints:function(n){var m=new j.CGPolygon();for(var l=0;l<4;l++){m.addPoint(new j.Vector3().copy(n[l]))}this.addPolygon(m);m=new j.CGPolygon();for(var l=4;l<8;l++){m.addPointAtIndex(l-4,new j.Vector3().copy(n[11-l]))}this.addPolygon(m);m=new j.CGPolygon();m.addPoint(n[0]);m.addPoint(n[3]);m.addPoint(n[7]);m.addPoint(n[4]);this.addPolygon(m);m=new j.CGPolygon();m.addPoint(n[1]);m.addPoint(n[5]);m.addPoint(n[6]);m.addPoint(n[2]);this.addPolygon(m);m=new j.CGPolygon();m.addPoint(n[4]);m.addPoint(n[5]);m.addPoint(n[1]);m.addPoint(n[0]);this.addPolygon(m);m=new j.CGPolygon();m.addPoint(n[6]);m.addPoint(n[7]);m.addPoint(n[3]);m.addPoint(n[2]);this.addPolygon(m)},clipByPlane:function(v){var s,q;var n=new j.CGPoly();var r=new j.CGPoly();for(s=0;s<this.polygon.length;s++){var m=new j.CGPolygon();var A=this.polygon[s].clipByPlane(v,m);if(m.corner.length){n.addPolygon(m);if(A.corner.length&&(A.corner.length===2)){r.addPolygon(A)}else{if(A.corner.length>0){console.log("plane / polygon intersection is not a segment : "+A.corner.length+" points")}}}}if(r.polygon.length>=3){var t=new j.CGPolygon();var y=r.polygon[r.polygon.length-1];t.addPoint(y.corner[0]);t.addPoint(y.corner[1]);r.removePolygon(r.polygon.length-1);while(r.polygon.length>0){var l=t.corner[t.corner.length-1];var B=0.0001;var w=Infinity;var p=-1;var o=-1;for(s=0;s<r.polygon.length;s++){var u=r.polygon[s];if(u.corner.length===2){for(q=0;q<u.corner.length;q++){var z=u.corner[q];var x=z.distanceToSquared(l);if(x<B){break}if(x<w){w=x;p=s;o=q}}if(q<u.corner.length){t.addPoint(u.corner[(q+1)%2]);break}}else{console.log("convex hull clipping : intersection segment has length > 2")}}if(s<r.polygon.length){r.removePolygon(s)}else{if(p>=0){t.addPoint(r.polygon[p].corner[(o+1)%2]);r.removePolygon(p)}else{console.log("failed to build the intersection polygon btw polyhedra and plane");break}}}t.corner.splice(t.corner.length-1,1);n.addPolygon(t)}return n},clipByPlanes:function(l){if(!l.length){return null}var n=this.clipByPlane(l[0]);for(var m=1;m<l.length;m++){n=n.clipByPlane(l[m])}return n},clipByBox:function(n){var l=n.getPlanes();var o=this.clipByPlane(l[0]);for(var m=1;m<6;m++){o=o.clipByPlane(l[m])}return o},getPoints:function(){var n,m,l,o=[];for(m=0;m<this.polygon.length;m++){n=this.polygon[m];for(l=0;l<n.corner.length;l++){o.push(n.corner[l])}}return o}};j.CGPolyHelper=function(n){j.Line.call(this);var m=this;this.frustumCulled=false;this.geometry=new j.Geometry();this.material=new j.LineBasicMaterial({color:16777215,vertexColors:j.FaceColors});this.type=j.LinePieces;this.matrixWorld=new j.Matrix4();this.matrixAutoUpdate=false;for(var l=0;l<1000;l++){this.geometry.vertices.push(new j.Vector3());this.geometry.colors.push(new j.Color(16711680))}this.update(n,new j.Color(16711680))};j.CGPolyHelper.prototype=Object.create(j.Line.prototype);j.CGPolyHelper.prototype.update=function(l,m){var p=0;var o;for(o=0;o<l.polygon.length;o++){var r=l.polygon[o];var t=r.corner.length;for(var n=0;n<t;n++){var s=r.corner[n];this.geometry.vertices[p].copy(s);this.geometry.colors[p].copy(m);p++;s=r.corner[(n+1)%t];this.geometry.vertices[p].copy(s);this.geometry.colors[p].copy(m);p++}}var q=(p>0)?this.geometry.vertices[p-1]:new j.Vector3();for(o=p;o<1000;o++){this.geometry.vertices[o].copy(q);this.geometry.colors[o].copy(m)}this.geometry.verticesNeedUpdate=true;this.geometry.colorsNeedUpdate=true};j.Camera.prototype.clone=function(l){if(l===undefined){l=new j.Camera()}j.Object3D.prototype.cloneSimple.call(this,l);l.matrixWorldInverse.copy(this.matrixWorldInverse);l.projectionMatrix.copy(this.projectionMatrix);l.projectionMatrixInverse.copy(this.projectionMatrixInverse);l._viewpoint=this._viewpoint;l.pixelCulling=this.pixelCulling;return l};j.OrthographicCamera.prototype.clone=function(l){if(l===undefined){l=new j.OrthographicCamera()}j.Camera.prototype.clone.call(this,l);if(this.fullWidth){l.fullWidth=this.fullWidth;l.fullHeight=this.fullHeight;l.x=this.x;l.y=this.y;l.width=this.width;l.height=this.height}else{if(l.fullWidth){delete (l.fullWidth)}if(l.fullHeight){delete (l.fullHeight)}}l.left=this.left;l.right=this.right;l.top=this.top;l.bottom=this.bottom;l.near=this.near;l.far=this.far;if(this.visualizedHeight){l.visualizedHeight=this.visualizedHeight}l.updateProjectionMatrix();return l};j.OrthographicCamera.prototype.setVisualizedHeight=function(n,m,l){this.fov=l?l:(this.fov?this.fov:45);this.visualizedHeight=n?2*n*Math.tan(Math.PI*this.fov/(180*2)):(this.visualizedHeight?this.visualizedHeight:400);this.aspect=m?m:(this.aspect?this.aspect:1);this.top=this.visualizedHeight/2;this.bottom=-this.top;this.left=this.aspect*this.bottom;this.right=-this.left;this.updateProjectionMatrix()};j.PerspectiveCamera.prototype.clone=function(l){if(l===undefined){l=new j.PerspectiveCamera()}j.Camera.prototype.clone.call(this,l);l.fov=this.fov;l.aspect=this.aspect;l.near=this.near;l.far=this.far;l.externalProjectionMatrix=this.externalProjectionMatrix;if(this.fullWidth){l.fullWidth=this.fullWidth;l.fullHeight=this.fullHeight;l.x=this.x;l.y=this.y;l.width=this.width;l.height=this.height}else{if(l.fullWidth){delete (l.fullWidth)}if(l.fullHeight){delete (l.fullHeight)}}l.updateProjectionMatrix();return l};j.Material_backup=j.Material;j.DeferredMaterial=function(l){this.material=l;this.usedBy=new Set()};j.DeferredMaterial.prototype.get=function(l){this.usedBy.add(l.id);return this.material};j.cleanDeferredCache=function(n){var l=[j.DefaultNormalDepthMaterials,j.DefaultShadowDepthMaterials,j.DefaultPickingMaterials,j.DefaultHighlightMaterials,j.DefaultMaterials];for(var m=0;m<l.length;m++){l[m].forEach(function(r,q,s){r.usedBy["delete"](n);if(r.usedBy.size<1){if(r.material.dispose){r.material.dispose()}else{var p,o;for(p in r.material){o=r.material[p];if(o&&o.dispose){o.dispose()}}}s["delete"](q)}})}};j.Material=function(){j.Material_backup.call(this);this._rendererId=-1;this._deferredMaterialsInit=false;this._deferredMaterials=[];for(var l=0;l<j.MaterialToUse.totalMaterial;l++){this._deferredMaterials[l]=null}this._deferredMaterials[j.MaterialToUse.originalMaterial]=this};j.Material.prototype=j.Material_backup.prototype;j.Material.prototype.updateGenericDeferredMaterials=function(o){var r=this._deferredMaterials[j.MaterialToUse.normalMaterial];r.force=true;r.wireframe=this.wireframe;r.vertexColors=this.vertexColors;r.attributes=Object.assign(r.attributes?r.attributes:{},this.attributes);this.copySkinningParameters(r);this.copyPDSFXParameters(r);var n=this._deferredMaterials[j.MaterialToUse.depthMaterial];n.force=true;n.wireframe=this.wireframe;n.vertexColors=this.vertexColors;n.attributes=Object.assign(n.attributes?n.attributes:{},this.attributes);this.copySkinningParameters(n);this.copyPDSFXParameters(n);var l=this._deferredMaterials[j.MaterialToUse.normalDepthMaterial];if(this.reflectionCoef&&this.reflectionCoef>0){l.uniforms.reflectionCoef={type:"f",value:this.reflectionCoef}}l.force=true;l.wireframe=this.wireframe;l.vertexColors=this.vertexColors;l.attributes=Object.assign(l.attributes?l.attributes:{},this.attributes);this.copySkinningParameters(l);this.copyPDSFXParameters(l);var w=this._deferredMaterials[j.MaterialToUse.shadowMapDepthMaterial];w.force=true;w._shadowPass=true;w.wireframe=this.wireframe;w.vertexColors=this.vertexColors;w.attributes=Object.assign(w.attributes?w.attributes:{},this.attributes);this.copySkinningParameters(w);this.copyPDSFXParameters(w);var t=this._deferredMaterials[j.MaterialToUse.highlightMaterial];if(j.mobileVersion){t.useBlending=true;t.blending=j.CustomBlending2;t.depthTest=false;t.depthWrite=false}t.attributes=Object.assign(t.attributes?t.attributes:{},this.attributes);if(t.line){t.line.attributes=Object.assign(t.line.attributes?t.line.attributes:{},this.attributes)}if(t.point){t.point.attributes=Object.assign(t.point.attributes?t.point.attributes:{},this.attributes)}this.copySkinningParameters(t);this.copyPDSFXParameters(t);if(!j.mobileVersion){var m=this._deferredMaterials[j.MaterialToUse.outlineHighlightMaterial];m.attributes=Object.assign(m.attributes?m.attributes:{},this.attributes);if(m.line){m.line.attributes=Object.assign(m.line.attributes?m.line.attributes:{},this.attributes)}if(m.point){m.point.attributes=Object.assign(m.point.attributes?m.point.attributes:{},this.attributes)}this.copySkinningParameters(m);this.copyPDSFXParameters(m)}var u=this._deferredMaterials[j.MaterialToUse.preHighlightMaterial];u.attributes=Object.assign(u.attributes?u.attributes:{},this.attributes);if(u.line){u.line.attributes=Object.assign(u.line.attributes?u.line.attributes:{},this.attributes)}if(u.point){u.point.attributes=Object.assign(u.point.attributes?u.point.attributes:{},this.attributes)}this.copySkinningParameters(u);this.copyPDSFXParameters(u);var v=this._deferredMaterials[j.MaterialToUse.pickingMaterial];var p=this._deferredMaterials[j.MaterialToUse.pickingMaterialInstancing];if(this.isInstancingMaterial&&p){p.attributes=Object.assign(p.attributes?p.attributes:{},this.attributes);p.force=true;p.transparent=this.transparent;this.copySkinningParameters(p);this.copyPDSFXParametersPicking(p)}v.attributes=Object.assign(v.attributes?v.attributes:{},this.attributes);v.force=true;v._picking=true;this.copySkinningParameters(v);this.copyPDSFXParametersPicking(v);if(this.backMaterial&&!this.backMaterial._deferredMaterialsInit){this.backMaterial.updateDeferredMaterials();this._deferredMaterials[j.MaterialToUse.pickingMaterial]=this._deferredMaterials[j.MaterialToUse.pickingMaterial].clone();this._deferredMaterials[j.MaterialToUse.pickingMaterial].backMaterial=this.backMaterial._deferredMaterials[j.MaterialToUse.pickingMaterial]}var s=this instanceof j.ParticleBasicMaterial;if(!s){this._deferredMaterials[j.MaterialToUse.oitAccumMaterial]=this;this._deferredMaterials[j.MaterialToUse.oitRevealMaterial]=this}this._deferredMaterials[j.MaterialToUse.ZOnlyMaterial]=this.getZOnlyMaterial();if(o&&o.gasLook){this.updateGasLookMaterial()}for(var q=0;q<j.MaterialToUse.totalMaterial;q++){var x=this._deferredMaterials[q];if(x!==null){x.isBackMaterial=this.isBackMaterial}}this._deferredMaterialsInit=true};j.Material.prototype.updateDeferredMaterials=function(p){this._deferredMaterials[j.MaterialToUse.normalMaterial]=this.getNormalMaterial();this._deferredMaterials[j.MaterialToUse.depthMaterial]=this.getDepthMaterial();this._deferredMaterials[j.MaterialToUse.normalDepthMaterial]=this.getNormalDepthMaterial();this._deferredMaterials[j.MaterialToUse.shadowMapDepthMaterial]=this.getShadowDepthMaterial();this._deferredMaterials[j.MaterialToUse.highlightMaterial]=j.mobileVersion?this.getHighlightMaterial("HighlightMobile"):this.getHighlightMaterial("Highlight");if(!j.mobileVersion){var o=this.getHighlightMaterial("OutlineHighlight");this._deferredMaterials[j.MaterialToUse.outlineHighlightMaterial]=o}this._deferredMaterials[j.MaterialToUse.preHighlightMaterial]=this.getHighlightMaterial("PreHighlight");var l=this.getPickingMaterial();var n=l.pickingMaterial;var m=l.pickingMaterialInstancing;this._deferredMaterials[j.MaterialToUse.pickingMaterialInstancing]=m;this._deferredMaterials[j.MaterialToUse.pickingMaterial]=n;this.updateGenericDeferredMaterials(p)};j.Material.prototype.updateGasLookMaterial=function(){if((this instanceof j.MeshPhongMaterial)||(this instanceof j.MeshLambertMaterial)){this._deferredMaterials[j.MaterialToUse.gasLookMaterial]=this.getGasLookMaterial()}};j.Material.prototype.copySkinningParameters=function(l){if(this.skinning){l.skinning=this.skinning;if(this.useEulerAngles){l.useEulerAngles=this.useEulerAngles}if(this.skinningMap){l.skinningMap=this.skinningMap;l.skinningMapWidth=this.skinningMapWidth;l.skinningMapHeight=this.skinningMapHeight}if(this.skinningInstancingMapsInfo){l.skinningInstancingMapsInfo=this.skinningInstancingMapsInfo}if(this.skinningInstancingMaps){l.skinningInstancingMaps=this.skinningInstancingMaps}}};j.Material.prototype.copyPDSFXParameters=function(l){if(this._PDSFXData&&this._PDSFXData.PDSFX){l.activatePDSFX();l.setPDSFXOverridableFunctions(this._PDSFXData.PDSFX_OverridableFunctions_VS,this._PDSFXData.PDSFX_OverridableFunctions_FS);if(this._PDSFXData.pdsfxVaryingsCode){l._PDSFXData.pdsfxVaryingsCode=this._PDSFXData.pdsfxVaryingsCode}if(this._PDSFXData.pdsfxUniformsCode){l._PDSFXData.pdsfxUniformsCode=this._PDSFXData.pdsfxUniformsCode}if(this._PDSFXData.pdsfxUniforms){l._PDSFXData.pdsfxUniforms=this._PDSFXData.pdsfxUniforms}if(this._PDSFXData.pdsfxGlobalVariablesCode_VS){l._PDSFXData.pdsfxGlobalVariablesCode_VS=this._PDSFXData.pdsfxGlobalVariablesCode_VS}if(this._PDSFXData.pdsfxGlobalVariablesCode_FS){l._PDSFXData.pdsfxGlobalVariablesCode_FS=this._PDSFXData.pdsfxGlobalVariablesCode_FS}if(this._PDSFXData.pdsfxAttributesCode){l._PDSFXData.pdsfxAttributesCode=this._PDSFXData.pdsfxAttributesCode}if(this._PDSFXData.pdsfxUseMap){l._PDSFXData.pdsfxUseMap=true}if(l.line&&!(l.line._PDSFXData&&l.line._PDSFXData.PDSFX)){this.copyPDSFXParameters(l.line)}if(l.point&&!(l.point._PDSFXData&&l.point._PDSFXData.PDSFX)){this.copyPDSFXParameters(l.point)}}};j.Material.prototype.copyPDSFXParametersPicking=function(m){if(this._PDSFXData&&this._PDSFXData.PDSFX){m.activatePDSFX();var l={ComputeCommonValues:this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeCommonValues,ComputeDiscard:this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeDiscard};m.setPDSFXOverridableFunctions(this._PDSFXData.PDSFX_OverridableFunctions_VS,l);if(this._PDSFXData.pdsfxVaryingsCode){m._PDSFXData.pdsfxVaryingsCode=this._PDSFXData.pdsfxVaryingsCode}if(this._PDSFXData.pdsfxUniformsCode){m._PDSFXData.pdsfxUniformsCode=this._PDSFXData.pdsfxUniformsCode}if(this._PDSFXData.pdsfxUniforms){m._PDSFXData.pdsfxUniforms=this._PDSFXData.pdsfxUniforms}if(this._PDSFXData.pdsfxGlobalVariablesCode_VS){m._PDSFXData.pdsfxGlobalVariablesCode_VS=this._PDSFXData.pdsfxGlobalVariablesCode_VS}if(this._PDSFXData.pdsfxGlobalVariablesCode_FS){m._PDSFXData.pdsfxGlobalVariablesCode_FS=this._PDSFXData.pdsfxGlobalVariablesCode_FS}if(this._PDSFXData.pdsfxAttributesCode){m._PDSFXData.pdsfxAttributesCode=this._PDSFXData.pdsfxAttributesCode}if(this._PDSFXData.pdsfxUseMap){m._PDSFXData.pdsfxUseMap=true}}};j.Material.prototype.getBaseId=function(){var l="id";l+=this.skinning;l+=this.useEulerAngles;l+=this.skinningMap!==null&&this.skinningMap!==undefined;if(this.skinningMap){l+=this.skinningMap.id}else{if(this.skinningInstancingMaps&&this.skinningInstancingMaps.length>0){l+=this.skinningInstancingMaps[0].id}else{l+=-1}}if(this._PDSFXData&&this._PDSFXData.PDSFX){l+=this._getPDSFXOverridableFunctions_FS();l+=this._getPDSFXOverridableFunctions_VS();if(this._PDSFXData.pdsfxUniforms!==null){l+=this.id}}return l};j.DefaultNormalDepthMaterials=new Map();j.Material.prototype.getNormalDepthMaterialCommons=function(o){var s=this.getBaseId();s+="T"+o+"GTFaceS"+this.side+"CP"+this.enableClipPlanes+"SD"+this.shading;s+="M";s+=(this.map?this.map.id:this.map);s+="AT"+this.alphaTest;s+="BM";s+=(this.bumpMap?this.bumpMap.id:this.bumpMap);s+="MT"+this.morphTargets;s+="MN"+this.morphNormals;s+="BM"+this.isBackMaterial;if(o==="Depth"){if(this.line){var n=this.line;s+="Line"+n.getBaseId();s+="TDepthGTEdgeS"+n.side+"CP"+n.enableClipPlanes+"TR"+(n.transparent||n.getOpacity()<1)+"LW"+n.lineWidth;s+="PBM"+n.polygonBorderMode;s+="BM"+n.isBackMaterial;s+="LC"+n.linecap+"LJ"+n.linejoin}if(this.point){var m=this.point;s+="Point"+m.getBaseId();s+="T"+o+"GTParticleS"+m.side+"CP"+m.enableClipPlanes+"SD"+m.shading;s+="M";s+=(m.map?m.map.id:m.map);s+="AT"+0.01;s+="SA"+m.sizeAttenuation;s+="BM"+m.isBackMaterial}}s="id"+s.hashCode();if(j.DefaultNormalDepthMaterials.has(s)){return{id:s,materialParams:null,material:j.DefaultNormalDepthMaterials.get(s).get(this)}}var q=o;var p=b[q];var l=j.UniformsUtils.clone(p.uniforms);var r={uniforms:l,vertexShader:p.vertexShader,fragmentShader:p.fragmentShader,side:this.side,enableClipPlanes:this.enableClipPlanes};return{id:s,materialParams:r,material:null}};j.Material.prototype.getNormalMaterial=function(){var p=this.getNormalDepthMaterialCommons("Normal");if(p.material!==null){return p.material}var o=p.materialParams;if(this.bumpMap||(this.map&&this.alphaTest)){var n={};if(this.map&&this.alphaTest){n.USE_MAP_ALPHATEST=true;n.ALPHATEST=this.alphaTest;o.uniforms.map.value=this.map;o.uniforms.offsetAlphaMap.value=this.map.offset;o.uniforms.repeatAlphaMap.value=this.map.repeat}if(this.bumpMap){n.USE_BUMPMAP=true;o.uniforms.bumpMap.value=this.bumpMap;o.uniforms.bumpScale.value=this.bumpScale;o.uniforms.offsetBumpMap.value=this.bumpMap.offset;o.uniforms.repeatBumpMap.value=this.bumpMap.repeat}o.defines=n;if(this.shading){o.shading=this.shading}if(this.morphTargets){o.morphTargets=this.morphTargets}if(this.morphNormals){o.morphNormals=this.morphNormals}o.blending=j.NoBlending}var m=new j.ShaderMaterial(o);if(!(this.bumpMap||(this.map&&this.alphaTest))){m.line=this.line?this.line.getInvisibleMaterial():this.getInvisibleMaterial();m.point=this.point?this.point.getInvisibleMaterial():this.getInvisibleMaterial()}var l=new j.DeferredMaterial(m);j.DefaultNormalDepthMaterials.set(p.id,l);return l.get(this)};j.Material.prototype.getNormalDepthMaterial=function(){var p=this.getNormalDepthMaterialCommons("NormalDepth");if(p.material!==null){return p.material}var o=p.materialParams;if(this.bumpMap||(this.map&&this.alphaTest)){var n={};if(this.map&&this.alphaTest){n.USE_MAP_ALPHATEST=true;n.ALPHATEST=this.alphaTest;o.uniforms.map.value=this.map;o.uniforms.offsetAlphaMap.value=this.map.offset;o.uniforms.repeatAlphaMap.value=this.map.repeat}if(this.bumpMap){n.USE_BUMPMAP=true;o.uniforms.bumpMap.value=this.bumpMap;o.uniforms.bumpScale.value=this.bumpScale;o.uniforms.offsetBumpMap.value=this.bumpMap.offset;o.uniforms.repeatBumpMap.value=this.bumpMap.repeat}o.defines=n;if(this.shading){o.shading=this.shading}if(this.morphTargets){o.morphTargets=this.morphTargets}if(this.morphNormals){o.morphNormals=this.morphNormals}o.blending=j.NoBlending}var m=new j.ShaderMaterial(o);if(!(this.bumpMap||(this.map&&this.alphaTest))){m.line=this.line?this.line.getInvisibleMaterial():this.getInvisibleMaterial();m.point=this.point?this.point.getInvisibleMaterial():this.getInvisibleMaterial()}var l=new j.DeferredMaterial(m);j.DefaultNormalDepthMaterials.set(p.id,l);return l.get(this)};j.Material.prototype.getDepthMaterial=function(){var p=this.getNormalDepthMaterialCommons("Depth");if(p.material!==null){return p.material}var o=p.materialParams;if(this.map&&this.alphaTest){var n={};n.USE_MAP_ALPHATEST=true;n.ALPHATEST=this.alphaTest;o.defines=n;o.uniforms.map.value=this.map;o.uniforms.offsetAlphaMap.value=this.map.offset;o.uniforms.repeatAlphaMap.value=this.map.repeat;if(this.shading){o.shading=this.shading}if(this.morphTargets){o.morphTargets=this.morphTargets}if(this.morphNormals){o.morphNormals=this.morphNormals}o.blending=j.NoBlending}var m=new j.ShaderMaterial(o);if(!(this.map&&this.alphaTest)){m.line=this.line?this.line.getDepthMaterial():m;m.point=this.point?this.point.getDepthMaterial():m}var l=new j.DeferredMaterial(m);j.DefaultNormalDepthMaterials.set(p.id,l);return l.get(this)};j.LineBasicMaterial.prototype.getDepthMaterial=function(){var r=this.getBaseId();r+="TDepthGTEdgeS"+this.side+"CP"+this.enableClipPlanes+"TR"+(this.transparent||this.getOpacity()<1)+"LW"+this.lineWidth;r+="PBM"+this.polygonBorderMode;r+="BM"+this.isBackMaterial;r+="LC"+this.linecap+"LJ"+this.linejoin;r="id"+r.hashCode();if(j.DefaultNormalDepthMaterials.has(r)){return j.DefaultNormalDepthMaterials.get(r).get(this)}var p="DepthEdge";var o=b[p];var l=j.UniformsUtils.clone(o.uniforms);var q={uniforms:l,fragmentShader:o.fragmentShader,vertexShader:o.vertexShader,side:j.DoubleSide,lineWidth:this.lineWidth,pixelSize:this.pixelSize,enableClipPlanes:this.enableClipPlanes,linejoin:this.linejoin,linecap:this.linecap,force:true};var n=new j.ShaderMaterial(q);var m=new j.DeferredMaterial(n);j.DefaultNormalDepthMaterials.set(r,m);return m.get(this)};j.ParticleBasicMaterial.prototype.getNormalDepthMaterialCommons=function(m){var q=this.getBaseId();q+="T"+m+"GTParticleS"+this.side+"CP"+this.enableClipPlanes+"SD"+this.shading;q+="SZ"+this.size;q+="M";q+=(this.map?this.map.id:this.map);q+="AT"+0.01;q+="SA"+this.sizeAttenuation;q+="BM"+this.isBackMaterial;q="id"+q.hashCode();if(j.DefaultNormalDepthMaterials.has(q)){return{id:q,materialParams:null,material:j.DefaultNormalDepthMaterials.get(q).get(this)}}var o=m+"Particle";var n=b[o];var l=j.UniformsUtils.clone(n.uniforms);l.size.value=this.size;var p={uniforms:l,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,side:this.side,enableClipPlanes:this.enableClipPlanes};if(this.shading){p.shading=this.shading}return{id:q,materialParams:p,material:null}};j.ParticleBasicMaterial.prototype.getDepthMaterial=function(){var p=this.getNormalDepthMaterialCommons("Depth");if(p.material!==null){return p.material}var o=p.materialParams;var n={USE_MAP_ALPHATEST:true,ALPHATEST:0.01};if(this.sizeAttenuation){n={USE_MAP_ALPHATEST:true,ALPHATEST:0.01,USE_SIZEATTENUATION:this.sizeAttenuation}}o.defines=n;if(this.map){if(this.shading){o.shading=this.shading}o.uniforms.map.value=this.map;o.uniforms.offsetAlphaMap.value=this.map.offset;o.uniforms.repeatAlphaMap.value=this.map.repeat}var m=new j.ShaderMaterial(o);var l=new j.DeferredMaterial(m);j.DefaultNormalDepthMaterials.set(p.id,l);return l.get(this)};j.ParticleBasicMaterial.prototype.getNormalDepthMaterial=function(){var p=this.getNormalDepthMaterialCommons("NormalDepth");if(p.material!==null){return p.material}var o=p.materialParams;var n={USE_MAP_ALPHATEST:true,ALPHATEST:0.01};if(this.sizeAttenuation){n={USE_MAP_ALPHATEST:true,ALPHATEST:0.01,USE_SIZEATTENUATION:this.sizeAttenuation}}o.defines=n;if(this.map){if(this.shading){o.shading=this.shading}o.uniforms.map.value=this.map;o.uniforms.offsetAlphaMap.value=this.map.offset;o.uniforms.repeatAlphaMap.value=this.map.repeat}var m=new j.ShaderMaterial(o);var l=new j.DeferredMaterial(m);j.DefaultNormalDepthMaterials.set(p.id,l);return l.get(this)};j.ParticleBasicMaterial.prototype.getNormalMaterial=function(){var p=this.getNormalDepthMaterialCommons("Normal");if(p.material!==null){return p.material}var o=p.materialParams;if(this.bumpMap||(this.map&&this.alphaTest)){var n={};if(this.map&&this.alphaTest){n.USE_MAP_ALPHATEST=true;n.ALPHATEST=this.alphaTest;o.uniforms.map.value=this.map;o.uniforms.offsetAlphaMap.value=this.map.offset;o.uniforms.repeatAlphaMap.value=this.map.repeat}if(this.bumpMap){n.USE_BUMPMAP=true;o.uniforms.bumpMap.value=this.bumpMap;o.uniforms.bumpScale.value=this.bumpScale;o.uniforms.offsetBumpMap.value=this.bumpMap.offset;o.uniforms.repeatBumpMap.value=this.bumpMap.repeat}o.defines=n;if(this.shading){o.shading=this.shading}if(this.morphTargets){o.morphTargets=this.morphTargets}if(this.morphNormals){o.morphNormals=this.morphNormals}o.blending=j.NoBlending}var m=new j.ShaderMaterial(o);var l=new j.DeferredMaterial(m);j.DefaultNormalDepthMaterials.set(p.id,l);return l.get(this)};j.DefaultShadowDepthMaterials=new Map();j.Material.prototype.getShadowDepthMaterial=function(){var q=this.getBaseId();q+="S"+this.side+"CP"+this.enableClipPlanes+"SD"+this.shading;q+="M";q+=(this.map?this.map.id:this.map);q+="AT"+this.alphaTest;q+="BM"+this.isBackMaterial;q="id"+q.hashCode();if(j.DefaultShadowDepthMaterials.has(q)){return j.DefaultShadowDepthMaterials.get(q).get(this)}var p;var m=j.ShaderLib.depthRGBA;var l=j.UniformsUtils.clone(m.uniforms);if(this.map&&this.alphaTest){var o={};o.USE_MAP_ALPHATEST=true;o.ALPHATEST=this.alphaTest;l.map.value=this.map;l.offsetAlphaMap.value=this.map.offset;l.repeatAlphaMap.value=this.map.repeat;p=new j.ShaderMaterial({uniforms:l,vertexShader:m.vertexShader,fragmentShader:m.fragmentShader,defines:o,blending:j.NoBlending,side:j.DoubleSide,enableClipPlanes:this.enableClipPlanes});if(this.shading){p.shading=this.shading}p.force=true;p.wireframe=this.wireframe;p.vertexColors=this.vertexColors}else{p=new j.ShaderMaterial({uniforms:l,vertexShader:m.vertexShader,fragmentShader:m.fragmentShader,side:j.DoubleSide,enableClipPlanes:this.enableClipPlanes})}p.attributes=Object.assign(p.attributes?p.attributes:{},this.attributes);p._shadowPass=true;var n=new j.DeferredMaterial(p);j.DefaultShadowDepthMaterials.set(q,n);return n.get(this)};j.DefaultPickingMaterials=new Map();j.Material.prototype.getPickingMaterial=function(){var s=this.getBaseId();s+="GTFaceS"+this.side+"CP"+this.enableClipPlanes+"TR"+(this.transparent||this.getOpacity()<1);s+="SD"+this.shading;s+="M";s+=this.map?this.map.id:this.map;s+="AT"+this.alphaTest;s+="BM"+this.isBackMaterial;s="id"+s.hashCode();if(j.DefaultPickingMaterials.has(s)){return j.DefaultPickingMaterials.get(s).get(this)}var r=null;var n=null;if(this.map&&this.alphaTest){var m=b.PickingFragment;var l=j.UniformsUtils.clone(m.uniforms);var q={};q.USE_MAP_ALPHATEST=true;q.ALPHATEST=this.alphaTest;l.map.value=this.map;l.offsetAlphaMap.value=this.map.offset;l.repeatAlphaMap.value=this.map.repeat;r=new j.ShaderMaterial({uniforms:l,vertexShader:m.vertexShader,fragmentShader:m.fragmentShader,defines:q,blending:j.NoBlending,transparent:this.transparent||this.getOpacity()<1,side:this.side,enableClipPlanes:this.enableClipPlanes});if(this.shading){r.shading=this.shading}r.uniforms.pickingColor={type:"c",value:new j.Color()};if(this.isInstancingMaterial){n=new j.ShaderMaterial({uniforms:l,vertexShader:b.PickingFragmentInstancing.vertexShader,fragmentShader:b.PickingFragmentInstancing.fragmentShader,defines:q,blending:j.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,transparent:this.transparent||this.getOpacity()<1});if(this.shading){n.shading=this.shading}}}else{r=new j.MeshBasicMaterial({color:new j.Color(),side:this.side,enableClipPlanes:this.enableClipPlanes,transparent:this.transparent||this.getOpacity()<1});if(this.isInstancingMaterial){n=r.clone();n._definePickingInstancing=true;n.isInstancingMaterial=true}}var p={pickingMaterial:r,pickingMaterialInstancing:n};var o=new j.DeferredMaterial(p);j.DefaultPickingMaterials.set(s,o);return o.get(this)};j.LineBasicMaterial.prototype.getPickingMaterial=function(){var q=this.getBaseId();q+="GTEdgeS"+this.side+"CP"+this.enableClipPlanes+"TR"+(this.transparent||this.getOpacity()<1)+"LW"+this.lineWidth;q+="PBM"+this.polygonBorderMode;q+="BM"+this.isBackMaterial;q+="LC"+this.linecap+"LJ"+this.linejoin;q="id"+q.hashCode();if(j.DefaultPickingMaterials.has(q)){return j.DefaultPickingMaterials.get(q).get(this)}var m={color:new j.Color(),side:this.side,lineWidth:this.lineWidth,enableClipPlanes:this.enableClipPlanes,linejoin:this.linejoin,linecap:this.linecap,pixelSize:this.pixelSize,transparent:this.transparent||this.getOpacity()<1,polygonBorderMode:this.polygonBorderMode};var p=new j.LineBasicMaterial(m);var l=null;if(this.isInstancingMaterial){l=p.clone();l._definePickingInstancing=true;l.isInstancingMaterial=true}var o={pickingMaterial:p,pickingMaterialInstancing:l};var n=new j.DeferredMaterial(o);j.DefaultPickingMaterials.set(q,n);return n.get(this)};j.ShaderMaterial.prototype.getPickingMaterial=function(){var l=j.UniformsUtils.mergeNoClone([this.uniforms]);var m=this.clone();m.fragmentShader=b.PickingFragment.fragmentShader;m.uniforms=l;m.uniforms.pickingColor={type:"c",value:new j.Color()};m.vertexColors=this.vertexColors;return{pickingMaterial:m,pickingMaterialInstancing:null}};j.ParticleBasicMaterial.prototype.getPickingMaterial=function(){var r=this.getBaseId();r+="TParticleSZ"+this.size;r+="CP"+this.enableClipPlanes;r+="TR"+(this.transparent||this.getOpacity()<1);r+="SA"+this.sizeAttenuation;r+="M";r+="BM"+this.isBackMaterial;r+=this.map?this.map.id:this.map;r="id"+r.hashCode();if(j.DefaultPickingMaterials.has(r)){return j.DefaultPickingMaterials.get(r).get(this)}var p={USE_MAP_ALPHATEST:true,ALPHATEST:0.01};if(this.sizeAttenuation){p.USE_SIZEATTENUATION=this.sizeAttenuation}var l=j.UniformsUtils.clone(b.PickingPointFragment.uniforms);if(this.map){l.map.value=this.map;l.offsetAlphaMap.value=this.map.offset;l.repeatAlphaMap.value=this.map.repeat}l.size.value=this.size;var q=new j.ShaderMaterial({uniforms:l,defines:p,fragmentShader:b.PickingPointFragment.fragmentShader,vertexShader:b.PickingPointFragment.vertexShader});q.side=j.DoubleSide;q.enableClipPlanes=this.enableClipPlanes;q.transparent=this.transparent||this.getOpacity()<1;q.uniforms.pickingColor={type:"c",value:new j.Color()};var m=null;if(this.isInstancingMaterial){m=new j.ShaderMaterial({uniforms:l,defines:p,vertexShader:b.PickingPointFragmentInstancing.vertexShader,fragmentShader:b.PickingPointFragmentInstancing.fragmentShader});m.side=j.DoubleSide;m.enableClipPlanes=this.enableClipPlanes;m.transparent=this.transparent}var o={pickingMaterial:q,pickingMaterialInstancing:m};var n=new j.DeferredMaterial(o);j.DefaultPickingMaterials.set(r,n);return n.get(this)};j.DefaultHighlightMaterials=new Map();j.Material.prototype.getHighlightInfo=function(l){var n;var m="Highlight";switch(l){case"Highlight":n=g;m="Highlight";break;case"PreHighlight":n=k;m="Highlight";break;case"HighlightMobile":n=f;m="Highlight";break;case"OutlineHighlight":n=g;m="OutlineHighlight";break;case"OutlinePreHighlight":n=k;m="OutlineHighlight";break;default:break}return{shaderLib:n,shaderName:m}};j.ParticleBasicMaterial.prototype.getHighlightMaterial=function(q){var l=this.getBaseId();l+="T"+q+"GTParticleSZ"+this.size;l+="AT"+0.01;l+="SA"+this.sizeAttenuation;l+="M";l+=this.map?this.map.id:this.map;l+="BM"+this.isBackMaterial;l="id"+l.hashCode();if(j.DefaultHighlightMaterials.has(l)){return j.DefaultHighlightMaterials.get(l).get(this)}var r={USE_MAP_ALPHATEST:true,ALPHATEST:0.01};if(this.sizeAttenuation){r={USE_MAP_ALPHATEST:true,ALPHATEST:0.01,USE_SIZEATTENUATION:this.sizeAttenuation}}var s=this.getHighlightInfo(q);var p=s.shaderLib;var n=s.shaderName;n+="Point";var t=j.UniformsUtils.clone(p[n].uniforms);if(this.map){t.map.value=this.map;t.offsetAlphaMap.value=this.map.offset;t.repeatAlphaMap.value=this.map.repeat}t.size.value=this.size;var o=new j.ShaderMaterial({uniforms:t,defines:r,fragmentShader:p[n].fragmentShader,vertexShader:p[n].vertexShader});o.side=j.DoubleSide;o.enableClipPlanes=this.enableClipPlanes;var m=new j.DeferredMaterial(o);j.DefaultHighlightMaterials.set(l,m);return m.get(this)};j.Material.prototype.getHighlightMaterial=function(s){var l=this.getBaseId();l+="T"+s;l+="GTFace";l+="CP"+this.enableClipPlanes;l+="M";l+=this.map?this.map.id:this.map;l+="AT"+this.alphaTest;l+="BM"+this.isBackMaterial;if(this.line){var w=this.line;l+="Line"+w.getBaseId();l+="T"+s+"GTEdgeCP"+w.enableClipPlanes+"LW"+w.lineWidth;l+="LC"+w.linecap+"LJ"+w.linejoin;if(w.isDashedLine){l+="SC"+w.scale;l+="PO"+(w.patternOffset%w.dashPattern[w.dashPattern.length-1]);l+="CPU"+w.isCPUPattern;for(var n=0;n<w.dashPattern.length;n++){var u=w.dashPattern[n];l+=n+"P"+u}}l+="BM"+w.isBackMaterial}if(this.point){var v=this.point;l+="Point"+v.getBaseId();l+="T"+s+"GTParticleSZ"+v.size;l+="AT"+0.01;l+="SA"+v.sizeAttenuation;l+="M";l+=v.map?v.map.id:v.map;l+="BM"+v.isBackMaterial}l="id"+l.hashCode();if(j.DefaultHighlightMaterials.has(l)){return j.DefaultHighlightMaterials.get(l).get(this)}var t=this.getHighlightInfo(s);var r=t.shaderLib;var q=t.shaderName;q+="Face";var p;var o={uniforms:j.UniformsUtils.clone(r[q].uniforms),fragmentShader:r[q].fragmentShader,vertexShader:r[q].vertexShader,side:j.DoubleSide,enableClipPlanes:this.enableClipPlanes,};if(this.map&&this.alphaTest){o.defines={USE_MAP_ALPHATEST:true,ALPHATEST:this.alphaTest};o.uniforms.map.value=this.map;o.uniforms.offsetAlphaMap.value=this.map.offset;o.uniforms.repeatAlphaMap.value=this.map.repeat;p=new j.ShaderMaterial(o)}else{o.force=true;p=new j.ShaderMaterial(o)}p.line=this.line?this.line.getHighlightMaterial(j.mobileVersion?"HighlightMobile":"Highlight"):null;p.point=this.point?this.point.getHighlightMaterial(j.mobileVersion?"HighlightMobile":"Highlight"):null;var m=new j.DeferredMaterial(p);j.DefaultHighlightMaterials.set(l,m);return m.get(this)};j.LineBasicMaterial.prototype.getHighlightMaterial=function(s){var l=this.getBaseId();l+="T"+s+"GTEdgeCP"+this.enableClipPlanes+"LW"+this.lineWidth;l+="LC"+this.linecap+"LJ"+this.linejoin;if(this.isDashedLine){l+="SC"+this.scale;l+="PO"+(this.patternOffset%this.dashPattern[this.dashPattern.length-1]);l+="CPU"+this.isCPUPattern;for(var n=0;n<this.dashPattern.length;n++){var u=this.dashPattern[n];l+=n+"P"+u}}l+="BM"+this.isBackMaterial;l="id"+l.hashCode();if(j.DefaultHighlightMaterials.has(l)){return j.DefaultHighlightMaterials.get(l).get(this)}var t=this.getHighlightInfo(s);var r=t.shaderLib;var q=t.shaderName;q+="Edge";var o={uniforms:j.UniformsUtils.clone(r[q].uniforms),fragmentShader:r[q].fragmentShader,vertexShader:r[q].vertexShader,side:j.DoubleSide,lineWidth:this.lineWidth,pixelSize:this.pixelSize,isCPUPattern:this.isCPUPattern,patternOffset:this.patternOffset,enableClipPlanes:this.enableClipPlanes,linejoin:this.linejoin,linecap:this.linecap,scale:this.scale,force:true};if(this.isDashedLine){o.isDashedLine=true;o.dashPattern=new Float32Array(this.dashPattern)}var p=new j.ShaderMaterial(o);var m=new j.DeferredMaterial(p);j.DefaultHighlightMaterials.set(l,m);return m.get(this)};j.DefaultMaterials=new Map();j.Material.prototype.getZOnlyMaterial=function(){var n="ZOnly";n="id"+n.hashCode();if(j.DefaultMaterials.has(n)){return j.DefaultMaterials.get(n).get(this)}var m=new j.MeshBasicMaterial({force:true});m.blending=j.CustomBlending;m.useBlending=true;m.blendDst=j.OneFactor;m.blendSrc=j.ZeroFactor;var l=new j.DeferredMaterial(m);j.DefaultMaterials.set(n,l);return l.get(this)};j.ParticleBasicMaterial.prototype.getZOnlyMaterial=function(){return this};j.LineDSMaterial.prototype.getZOnlyMaterial=function(){return this};j.Material.prototype.getInvisibleMaterial=function(){var n=this.getBaseId();n+="TInvisible";n="id"+n.hashCode();if(j.DefaultMaterials.has(n)){return j.DefaultMaterials.get(n).get(this)}var m=new j.ShaderMaterial();m.visible=false;m.force=true;var l=new j.DeferredMaterial(m);j.DefaultMaterials.set(n,l);return l.get(this)};j.Material.prototype.getGasLookMaterial=function(n){var o=this.getBaseId();o+="TGASLook";o+="Col"+this.color.getHex();o+="S"+this.side;o+="CP"+this.enableClipPlanes;o+="O"+this.getOpacity();o="id"+o.hashCode();if(j.DefaultMaterials.has(o)){return j.DefaultMaterials.get(o).get(this)}var m=new j.PhysicalMaterial({NRECompatibility:true,_gasLook:1,color:this.color,opacity:this.getOpacity(),roughness:0.3,metalness:0,specularContrib:1,specular:new j.Color().setRGB(1,1,1),side:this.side,enableClipPlanes:this.enableClipPlanes});var l=new j.DeferredMaterial(m);j.DefaultMaterials.set(o,l);return l.get(this)};j.ShaderMaterialDS=function(l){this.vertexShaderPars="";this.fragmentShaderPars="";this.vertexShaderBody="";this.fragmentShaderBody="";this.originalMaterialRef=null;this.needTangentBinormal=false;j.ShaderMaterial.call(this,l);this.shaderVersion=0;if(this.enableOIT){this.vertexShaderPars=[this.vertexShaderPars,j.ShaderChunk.oit_pars_vertex].join("\n");this.vertexShaderBody=[this.vertexShaderBody,j.ShaderChunk.oit_vertex].join("\n");this.fragmentShaderPars=[this.fragmentShaderPars,j.ShaderChunk.oit_pars_fragment].join("\n");this.fragmentShaderBody=[this.fragmentShaderBody,j.ShaderChunk.oit_fragment].join("\n")}this.update()};j.ShaderMaterialDS.prototype=Object.create(j.ShaderMaterial.prototype);j.ShaderMaterialDS.prototype.clone=function(){var l=new j.ShaderMaterialDS();j.ShaderMaterial.prototype.clone.call(this,l);l.vertexShaderPars=this.vertexShaderPars;l.fragmentShaderPars=this.fragmentShaderPars;l.vertexShaderBody=this.vertexShaderBody;l.fragmentShaderBody=this.fragmentShaderBody;l.originalMaterialRef=this;l.needTangentBinormal=this.needTangentBinormal;return l};j.ShaderMaterialDS.prototype.setShaders=function(l,o,n,m){this.vertexShaderPars=l;this.fragmentShaderPars=n;this.vertexShaderBody=o;this.fragmentShaderBody=m;this.update()};j.ShaderMaterialDS.prototype.update=function(){var l="";l=[l,this.vertexShaderPars,""].join("\n");l+="void main() { \n";l+=this.vertexShaderBody;l+="\n";l+="}";this.vertexShader=l;var m="";m+="#if defined( NEEDS_UVTOUSE )\n";m+="vec2 uvToUse; \n";m+="#endif \n";m=[m,this.fragmentShaderPars,""].join("\n");m+="void main() { \n";m+="#if defined( NEEDS_UVTOUSE )\n";m+="uvToUse=vUv; \n";m+="#endif \n";m+=this.fragmentShaderBody;m+="\n";m+="}";this.fragmentShader=m;this.needsUpdate=true};j.ShaderMaterialDS.prototype.updateDeferredMaterials=function(n){if(this.originalMaterialRef&&this.originalMaterialRef._deferredMaterialsInit){this._deferredMaterials[0]=this;for(var o=1;o<this.originalMaterialRef._deferredMaterials.length;o++){if(this.originalMaterialRef._deferredMaterials[o] instanceof j.ShaderMaterialDS){this._deferredMaterials[o]=this.originalMaterialRef._deferredMaterials[o].clone();if(this.originalMaterialRef._deferredMaterials[o].line){this._deferredMaterials[o].line=this.originalMaterialRef._deferredMaterials[o].line.clone()}if(this.originalMaterialRef._deferredMaterials[o].point){this._deferredMaterials[o].point=this.originalMaterialRef._deferredMaterials[o].point.clone()}for(var N in this._deferredMaterials[o].uniforms){if(N in this.uniforms){this._deferredMaterials[o].uniforms[N]=this.uniforms[N]}}}}this._deferredMaterialsInit=true;return}var V=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(b.Normal.uniforms)]);var I=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(b.Depth.uniforms)]);var T=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(b.NormalDepth.uniforms)]);var R=j.ShaderLib.depthRGBA;var w=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(R.uniforms)]);var m=j.mobileVersion?f:g;var L=m.HighlightFace;var G=m.HighlightEdge;var l=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(L.uniforms)]);var J=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(G.uniforms)]);var t=k.HighlightFace;var q=k.HighlightEdge;var B=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(L.uniforms)]);var s=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(G.uniforms)]);var F=b.PickingFragment;var A=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(F.uniforms)]);var K=this.defines?this.defines:{};if(this.map&&this.alphaTest){K.USE_MAP_ALPHATEST=true;K.ALPHATEST=this.alphaTest;V.map.value=this.map;I.map.value=this.map;T.map.value=this.map;w.map.value=this.map;l.map.value=this.map;B.map.value=this.map;A.map.value=this.map;var M=this.map.offset;var H=this.map.repeat;V.offsetAlphaMap.value=M;V.repeatAlphaMap.value=H;I.offsetAlphaMap.value=M;I.repeatAlphaMap.value=H;T.offsetAlphaMap.value=M;T.repeatAlphaMap.value=H;w.offsetAlphaMap.value=M;w.repeatAlphaMap.value=H;l.offsetAlphaMap.value=M;l.repeatAlphaMap.value=H;B.offsetAlphaMap.value=M;B.repeatAlphaMap.value=H;A.offsetAlphaMap.value=M;A.repeatAlphaMap.value=H}var D=new j.ShaderMaterialDS({uniforms:V,vertexShaderPars:[this.vertexShaderPars,b.Normal.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,b.Normal.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,b.Normal.fragmentShaderPars].join("\n"):b.Normal.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,b.Normal.fragmentShaderBody].join("\n"):b.Normal.fragmentShaderBody,shading:this.shading,defines:K,blending:j.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:false});this._deferredMaterials[j.MaterialToUse.normalMaterial]=D;var v=new j.ShaderMaterialDS({uniforms:I,vertexShaderPars:[this.vertexShaderPars,b.Depth.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,b.Depth.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,b.Depth.fragmentShaderPars].join("\n"):b.Depth.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,b.Depth.fragmentShaderBody].join("\n"):b.Depth.fragmentShaderBody,defines:K,blending:j.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:false});this._deferredMaterials[j.MaterialToUse.depthMaterial]=v;var C=new j.ShaderMaterialDS({uniforms:T,vertexShaderPars:[this.vertexShaderPars,b.NormalDepth.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,b.NormalDepth.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,b.NormalDepth.fragmentShaderPars].join("\n"):b.NormalDepth.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,b.NormalDepth.fragmentShaderBody].join("\n"):b.NormalDepth.fragmentShaderBody,shading:this.shading,defines:K,blending:j.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:false});this._deferredMaterials[j.MaterialToUse.normalDepthMaterial]=C;var O=new j.ShaderMaterialDS({uniforms:w,vertexShaderPars:[this.vertexShaderPars,R.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,R.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,R.fragmentShaderPars].join("\n"):R.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,R.fragmentShaderBody].join("\n"):R.fragmentShaderBody,shading:this.shading,defines:K,blending:j.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:false});this._deferredMaterials[j.MaterialToUse.shadowMapDepthMaterial]=O;this.copySkinningParameters(this._deferredMaterials[j.MaterialToUse.shadowMapDepthMaterial]);this.copyPDSFXParameters(this._deferredMaterials[j.MaterialToUse.shadowMapDepthMaterial]);var Q=new j.ShaderMaterialDS({uniforms:l,defines:K,vertexShaderPars:[this.vertexShaderPars,L.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,L.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,L.fragmentShaderPars].join("\n"):L.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,L.fragmentShaderBody].join("\n"):L.fragmentShaderBody,blending:j.NoBlending,enableOIT:false});Q.side=j.DoubleSide;Q.enableClipPlanes=this.enableClipPlanes;Q.vertexColors=this.vertexColors;Q.line=new j.ShaderMaterialDS({uniforms:J,vertexShaderPars:[this.vertexShaderPars,G.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,G.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,G.fragmentShaderPars].join("\n"):G.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,G.fragmentShaderBody].join("\n"):G.fragmentShaderBody,blending:j.NoBlending,enableOIT:false});Q.line.enableClipPlanes=this.enableClipPlanes;Q.line.vertexColors=this.vertexColors;this._deferredMaterials[j.MaterialToUse.highlightMaterial]=Q;var S=new j.ShaderMaterialDS({uniforms:B,defines:K,vertexShaderPars:[this.vertexShaderPars,t.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,t.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,t.fragmentShaderPars].join("\n"):t.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,t.fragmentShaderBody].join("\n"):t.fragmentShaderBody,blending:j.NoBlending,enableOIT:false});S.side=j.DoubleSide;S.enableClipPlanes=this.enableClipPlanes;S.vertexColors=this.vertexColors;S.line=new j.ShaderMaterialDS({uniforms:s,vertexShaderPars:[this.vertexShaderPars,q.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,q.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,q.fragmentShaderPars].join("\n"):q.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,q.fragmentShaderBody].join("\n"):q.fragmentShaderBody,blending:j.NoBlending,enableOIT:false});S.line.enableClipPlanes=this.enableClipPlanes;S.line.vertexColors=this.vertexColors;this._deferredMaterials[j.MaterialToUse.preHighlightMaterial]=S;if(!j.mobileVersion){var r=g;var y=r.OutlineHighlightFace;var x=r.OutlineHighlightEdge;var P=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(L.uniforms)]);var z=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(G.uniforms)]);if(this.map&&this.alphaTest){P.map.value=this.map;P.offsetAlphaMap.value=this.map.offset;P.repeatAlphaMap.value=this.map.repeat}var U=new j.ShaderMaterialDS({uniforms:P,defines:K,vertexShaderPars:[this.vertexShaderPars,y.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,y.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,y.fragmentShaderPars].join("\n"):y.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,y.fragmentShaderBody].join("\n"):y.fragmentShaderBody,blending:j.NoBlending,enableOIT:false});U.side=j.DoubleSide;U.enableClipPlanes=this.enableClipPlanes;U.vertexColors=this.vertexColors;U.line=new j.ShaderMaterialDS({uniforms:z,vertexShaderPars:[this.vertexShaderPars,x.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,x.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,x.fragmentShaderPars].join("\n"):x.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,x.fragmentShaderBody].join("\n"):x.fragmentShaderBody,blending:j.NoBlending,enableOIT:false});U.line.enableClipPlanes=this.enableClipPlanes;U.line.vertexColors=this.vertexColors;this._deferredMaterials[j.MaterialToUse.outlineHighlightMaterial]=U}var p=new j.ShaderMaterialDS({uniforms:A,vertexShaderPars:[this.vertexShaderPars,F.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,F.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,F.fragmentShaderPars].join("\n"):F.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,F.fragmentShaderBody].join("\n"):F.fragmentShaderBody,shading:this.shading,defines:K,blending:j.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:false});p.uniforms.pickingColor={type:"c",value:new j.Color()};p.wireframe=this.wireframe;p.vertexColors=this.vertexColors;if(this.isInstancingMaterial){var E=new j.ShaderMaterialDS({uniforms:A,vertexShaderPars:[this.vertexShaderPars,F.vertexShaderPars,"varying vec3 vInstancePickingColor;"].join("\n"),vertexShaderBody:[this.vertexShaderBody,F.vertexShaderBody,b.Chunks.picking_instancing_vertex].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,F.fragmentShaderPars,"varying vec3 vInstancePickingColor;"].join("\n"):[F.fragmentShaderPars,"varying vec3 vInstancePickingColor;"].join("\n"),fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,F.fragmentShaderBody,b.Chunks.picking_instancing_fragment].join("\n"):[F.fragmentShaderBody,b.Chunks.picking_instancing_fragment].join("\n"),shading:this.shading,defines:K,blending:j.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:false});E.wireframe=this.wireframe;E.vertexColors=this.vertexColors;this._deferredMaterials[j.MaterialToUse.pickingMaterialInstancing]=E}else{this._deferredMaterials[j.MaterialToUse.pickingMaterialInstancing]=null}this._deferredMaterials[j.MaterialToUse.pickingMaterial]=p;this._deferredMaterials[j.MaterialToUse.pickingMaterial].refreshUniforms=this.refreshUniforms;this._deferredMaterials[j.MaterialToUse.normalMaterial].refreshUniforms=this.refreshUniforms;this._deferredMaterials[j.MaterialToUse.depthMaterial].refreshUniforms=this.refreshUniforms;if(this._deferredMaterials[j.MaterialToUse.pickingMaterialInstancing]!==null){this._deferredMaterials[j.MaterialToUse.pickingMaterialInstancing].refreshUniforms=this.refreshUniforms}this.updateGenericDeferredMaterials(n)};j.IBLOverrider=function(l){this.hdr=l.hdr||{loadEndStatus:"useCurrent"};this.brdf=l.brdf||"GGX";this.direct=l.direct||false;this.name=l.name||"";this.mips=l.mips||null};j.IBLOverrider.prototype.clone=function(){return new j.IBLOverrider({hdr:this.hdr,brdf:this.brdf,direct:this.direct,name:this.name,mips:this.mips})};j.SubsurfaceScatteringPresets={None:-1,Apple:0,Chicken1:1,Chicken2:2,Cream:3,Ketchup:4,Marble:5,Potato:6,Skimmilk:7,Skin1:8,Skin2:9,Wholemilk:10};j._SubsurfaceScatteringPresets={setValues:function(l){if(l.subsurfacePreset===j.SubsurfaceScatteringPresets.None){this._subsurface=false;return}l.updateSSS=true;l._subsurface=true;var m=this.presetValues[l.subsurfacePreset];l._absorptionCoeffs=m.absorptionCoeffs.slice(0);l._scatteringCoeffs=m.scatteringCoeffs.slice(0)},presetValues:[{absorptionCoeffs:[0.003,0.0034,0.046],scatteringCoeffs:[2.29,2.39,1.97]},{absorptionCoeffs:[0.015,0.077,0.19],scatteringCoeffs:[0.15,0.21,0.38]},{absorptionCoeffs:[0.018,0.088,0.2],scatteringCoeffs:[0.19,0.25,0.32]},{absorptionCoeffs:[0.0002,0.0028,0.0163],scatteringCoeffs:[7.38,5.47,3.15]},{absorptionCoeffs:[0.061,0.97,1.45],scatteringCoeffs:[0.18,0.07,0.03]},{absorptionCoeffs:[0.0021,0.0041,0.0071],scatteringCoeffs:[2.19,2.62,3]},{absorptionCoeffs:[0.0024,0.009,0.12],scatteringCoeffs:[0.68,0.7,0.55]},{absorptionCoeffs:[0.0014,0.0025,0.0142],scatteringCoeffs:[0.7,1.22,1.9]},{absorptionCoeffs:[0.032,0.17,0.48],scatteringCoeffs:[0.74,0.88,1.01]},{absorptionCoeffs:[0.013,0.07,0.145],scatteringCoeffs:[1.09,1.59,1.79]},{absorptionCoeffs:[0.0011,0.0024,0.014],scatteringCoeffs:[2.55,3.21,3.77]}]};j.SheenMode={NO_SHEEN:"NONE",VELVET:"USE_VELVET",SATIN:"USE_SATIN"};j.SheenData=function(l){this.envMipMap=l.envMipMap||null;this.overrideIBL=l.overrideIBL||null};j.SheenData.prototype.clone=function(){return new j.SheenData({envMipMap:this.envMipMap,overrideIBL:this.overrideIBL!==null?this.overrideIBL.clone():null,})};j.PhysicalMaterial=function(l){j.Material.call(this);this.isPhysicalMaterial=true;this.lights=true;this.shaderID=j.ShaderIDs.physicalDS;this.needsCameraPosition=true;this.__prevColorTexture=null;this.__prevNormalDepthTexture=null;this.thinWalled=true;this.color=new j.Color(16777215);this.map=null;this.diffuseUvTransform=new j.Matrix3();this.diffuseMulCoef=null;this.diffuseAddCoef=null;this.diffuseMapLinear=true;this.specular=new j.Color(16777215);this.specularMap=null;this.specularUvTransform=new j.Matrix3();this.specularMulCoef=null;this.specularAddCoef=null;this.specularMapLinear=true;this.metalness=0;this.metalnessMap=null;this.metalnessUvTransform=new j.Matrix3();this.metalnessMulCoef=1;this.metalnessAddCoef=0;this.metalnessMapLinear=true;this.specularContrib=1;this.specularContribMap=null;this.specularContribUvTransform=new j.Matrix3();this.specularContribMulCoef=1;this.specularContribAddCoef=0;this.emissionColor=new j.Color(16777215);this.emissionColorMapLinear=true;this.emissionColorMap=null;this.emissionColorAddCoef=null;this.emissionColorMulCoef=null;this.emissionColorUvTransform=new j.Matrix3();this.emissionValue=0;this.emissionNormalized=false;this.transparency=0;this.transparencyMap=null;this.transparencyUvTransform=new j.Matrix3();this.transparencyMulCoef=1;this.transparencyAddCoef=0;this.opacity=1;this.useAlphaFromDiffuseMap=true;this.opacityMap=null;this.opacityUvTransform=new j.Matrix3();this.opacityMulCoef=1;this.opacityAddCoef=0;this.ior=1.4;this.roughness=0;this.roughnessMap=null;this.glossinessMap=null;this.glossinessMulCoef=1;this.glossinessAddCoef=0;this.roughnessUvTransform=new j.Matrix3();this.roughnessMulCoef=1;this.roughnessAddCoef=0;this.roughnessMapLinear=true;this.anisotropy=0;this.anisotropyMap=null;this.anisotropyUvTransform=new j.Matrix3();this.anisotropyMulCoef=1;this.anisotropyAddCoef=0;this.anisotropyAngle=0;this.anisotropyAngleMap=null;this.anisotropyAngleUvTransform=new j.Matrix3();this.anisotropyAngleMulCoef=1;this.anisotropyAngleAddCoef=0;this.displacementMap=null;this.displacementScale=0;this.displacementBias=0;this.reflectionProbes=null;this._sheenData=null;this.sheen=0;this.sheenMap=null;this.sheenMulCoef=1;this.sheenAddCoef=0;this.sheenUvTransform=new j.Matrix3();this.sheenMode=j.SheenMode.NO_SHEEN;this.clearCoat=0;this.clearCoatMap=null;this.clearCoatAddCoef=0;this.clearCoatMulCoef=1;this.clearCoatUvTransform=new j.Matrix3();this.clearCoatRoughnessMap=null;this.clearCoatRoughnessUvTransform=new j.Matrix3();this.clearCoatRoughnessMulCoef=1;this.clearCoatRoughnessAddCoef=0;this.clearCoatRoughnessMapLinear=true;this.coatingGlossinessMap=null;this.coatingGlossinessMulCoef=1;this.coatingGlossinessAddCoef=0;this.clearCoatRoughness=0;this.clearCoatNormalMap=null;this.clearCoatNormalMapFlipY=false;this.clearCoatNormalUvTransform=new j.Matrix3();this.clearCoatNormalScaleMulCoef=1;this.clearCoatNormalScaleAddCoef=0;this.clearCoatNormalScale=1;this.orangePeel=false;this.orangePeelScale=0;this.envMipMap=null;this.envMap=null;this.overrideIBL=null;this.attenuationColor=new j.Color(16777215);this.attenuationDistance=1000000;this.subsurfaceColor=new j.Color(0);this.translucencyScale=1;this.subsurfacePreset=j.SubsurfaceScatteringPresets.None;this.bumpMap=null;this.bumpScale=1;this.bumpScaleMulCoef=1;this.bumpScaleAddCoef=0;this.normalMap=null;this.normalScale=new j.Vector2(1,1);this.normalUvTransform=new j.Matrix3();this.normalScaleMulCoef=1;this.normalScaleAddCoef=0;this.normalMapFlipY=false;this.lightMap=null;this.lightMapMode=0;this.lightMapLinear=true;this.useLighting=true;this.perPixel=true;if(typeof l!=="undefined"&&(typeof l.flakes!=="undefined"||typeof l.flakesDensity!=="undefined"||typeof l.flakesScale!=="undefined"||typeof l.flakesBump!=="undefined"||typeof l.pearlFlakesBump!=="undefined"||typeof l.pearlFlakesColor!=="undefined")){this.flakes=false;this.flakesMode=j.mobileVersion?1:0;this.flakesColor=new j.Color(0);this.flakesBump=0;this.flakesDensity=0;this.flakesScale=0;this.flakesRoughness=0;this.flakesColorMulCoef=new j.Vector3(1,1,1);this.flakesColorAddCoef=new j.Vector3(0,0,0);this.pearlFlakesColor=new j.Color(0);this.pearlFlakesBump=0;this.pearlFlakesDensity=0;this.pearlFlakesColorMulCoef=new j.Vector3(1,1,1);this.pearlFlakesColorAddCoef=new j.Vector3(0,0,0)}else{this.flakesCoverage=0;this.flakesCoverageUvTransform=new j.Matrix3();this.flakesCoverageMap=null;this.flakesCoverageAddCoef=0;this.flakesCoverageMulCoef=1;this.flakesSize=0;this.flakesSizeUvTransform=new j.Matrix3();this.flakesSizeMap=null;this.flakesSizeAddCoef=0;this.flakesSizeMulCoef=1;this.flakesRoughness=0;this.flakesRoughnessUvTransform=new j.Matrix3();this.flakesRoughnessMap=null;this.flakesRoughnessMapLinear=true;this.flakesRoughnessAddCoef=0;this.flakesRoughnessMulCoef=1;this.flakesColor=new j.Color(16777215);this.flakesColorUvTransform=new j.Matrix3();this.flakesColorMap=null;this.flakesColorMapLinear=true;this.flakesColorAddCoef=null;this.flakesColorMulCoef=null}this._gasLook=0;this.needTangent=false;this.needTangentBinormal=false;this.NRECompatibility=true;this.sslr=false;this.uvSlots={diffuseMap:1,specularMap:1,roughnessMap:1,normalMap:1,lightMap:2};this.setValues(l);if(l&&l.hasOwnProperty("glossiness")&&this.metalness==0){this.roughness=1-l.glossiness;this.roughnessMap=null;this.ior=1e+25;this.thinWalled=true;this.metalness=0;this.metalnessMap=null}if(this.glossinessMap){this.roughnessMap=null;this.ior=1e+25;this.thinWalled=true;this.metalness=0;this.metalnessMap=null;this.roughnessMapLinear=l.hasOwnProperty("glossinessMapLinear")?l.glossinessMapLinear:true;this.roughnessUvTransform=l.hasOwnProperty("glossinessUvTransform")?l.glossinessUvTransform:this.roughnessUvTransform}if(l&&l.hasOwnProperty("emissive")){this.emissionColor.copy(l.emissive);this.emissionColorMap=l.hasOwnProperty("emissiveMap")?l.emissiveMap:this.emissionColorMap;this.emissionColorAddCoef=l.hasOwnProperty("emissiveAddCoef")?l.emissiveAddCoef.clone():this.emissionColorAddCoef;this.emissionColorMulCoef=l.hasOwnProperty("emissiveMulCoef")?l.emissiveMulCoef.clone():this.emissionColorMulCoef;this.emissionColorUvTransform=l.hasOwnProperty("emissiveUvTransform")?l.emissiveUvTransform.clone():this.emissionColorUvTransform;this.emissionValue=1;this.emissionNormalized=false;this.emissionColorMapLinear=l.hasOwnProperty("emissiveMapLinear")?l.emissiveMapLinear:true}if(l&&l.hasOwnProperty("coating")){this.clearCoat=l.coating;this.clearCoatRoughness=l.hasOwnProperty("coatingGlossiness")?1-l.coatingGlossiness:0}if(this.coatingGlossinessMap){this.clearCoatRoughnessMap=null;this.clearCoatRoughnessAddCoef=0;this.clearCoatRoughnessMulCoef=1;this.clearCoatRoughnessMapLinear=l.hasOwnProperty("coatingGlossinessMapLinear")?l.coatingGlossinessMapLinear:true;this.clearCoatRoughnessUvTransform=l.hasOwnProperty("coatingGlossinessUvTransform")?l.coatingGlossinessUvTransform:this.clearCoatRoughnessUvTransform}this._subsurface=false;this._sssLUT=null;this._sssIBLLUT=null;this._translucencyLUT=null;this._scatteringCoeffs=null;this._absorptionCoeffs=null;this.setSheen({sheen:this.sheen,sheenMode:this.sheenMode});this.ambienceMatrix=new j.Matrix4();this.useFiniteEnvMap=false;this.parallaxCorrectionParameters=null;if(this.subsurfacePreset>j.SubsurfaceScatteringPresets.None){j._SubsurfaceScatteringPresets.setValues(this)}else{this.setSubsurfaceScatteringParams(l)}};j.PhysicalMaterial.prototype=Object.create(j.Material.prototype);j.PhysicalMaterial.prototype.getOpacity=function(){return 1-Math.max(1-this.opacity,Math.min(this.transparency,0.99))};j.PhysicalMaterial.prototype.clone=function(){var l;if(typeof this.flakes==="undefined"){l=new j.PhysicalMaterial()}else{l=new j.PhysicalMaterial({flakes:this.flakes})}j.Material.prototype.clone.call(this,l);l.__prevColorTexture=this.__prevColorTexture;l.__prevNormalDepthTexture=this.__prevNormalDepthTexture;l.useLighting=this.useLighting;l.perPixel=this.perPixel;l.thinWalled=this.thinWalled;l.color.copy(this.color);l.map=this.map;l.diffuseUvTransform=this.diffuseUvTransform;l.diffuseMulCoef=this.diffuseMulCoef;l.diffuseAddCoef=this.diffuseAddCoef;l.diffuseMapLinear=this.diffuseMapLinear;l.specular.copy(this.specular);l.specularMap=this.specularMap;l.specularUvTransform=this.specularUvTransform;l.specularMulCoef=this.specularMulCoef;l.specularAddCoef=this.specularAddCoef;l.specularMapLinear=this.specularMapLinear;l.metalness=this.metalness;l.metalnessMap=this.metalnessMap;l.metalnessUvTransform=this.metalnessUvTransform;l.metalnessMulCoef=this.metalnessMulCoef;l.metalnessAddCoef=this.metalnessAddCoef;l.metalnessMapLinear=this.metalnessMapLinear;l.specularContrib=this.specularContrib;l.specularContribMap=this.specularContribMap;l.specularContribUvTransform=this.specularContribUvTransform;l.specularContribMulCoef=this.specularContribMulCoef;l.specularContribAddCoef=this.specularContribAddCoef;l.emissionColor.copy(this.emissionColor);l.emissionColorMap=this.emissionColorMap;l.emissionColorAddCoef=this.emissionColorAddCoef;l.emissionColorMulCoef=this.emissionColorMulCoef;l.emissionColorUvTransform=this.emissionColorUvTransform;l.emissionValue=this.emissionValue;l.emissionNormalized=this.emissionNormalized;l.emissionColorMapLinear=this.emissionColorMapLinear;l.transparency=this.transparency;l.transparencyMap=this.transparencyMap;l.transparencyUvTransform=this.transparencyUvTransform;l.transparencyMulCoef=this.transparencyMulCoef;l.transparencyAddCoef=this.transparencyAddCoef;l.opacity=this.opacity;l.useAlphaFromDiffuseMap=this.useAlphaFromDiffuseMap;l.opacityMap=this.opacityMap;l.opacityUvTransform=this.opacityUvTransform;l.opacityMulCoef=this.opacityMulCoef;l.opacityAddCoef=this.opacityAddCoef;l.ior=this.ior;l.roughness=this.roughness;l.roughnessMap=this.roughnessMap;l.glossinessMap=this.glossinessMap;l.glossinessMulCoef=this.glossinessMulCoef;l.glossinessAddCoef=this.glossinessAddCoef;l.roughnessUvTransform=this.roughnessUvTransform;l.roughnessMulCoef=this.roughnessMulCoef;l.roughnessAddCoef=this.roughnessAddCoef;l.roughnessMapLinear=this.roughnessMapLinear;l.anisotropy=this.anisotropy;l.anisotropyMap=this.anisotropyMap;l.anisotropyUvTransform=this.anisotropyUvTransform;l.anisotropyMulCoef=this.anisotropyMulCoef;l.anisotropyAddCoef=this.anisotropyAddCoef;l.anisotropyAngle=this.anisotropyAngle;l.anisotropyAngleMap=this.anisotropyAngleMap;l.anisotropyAngleUvTransform=this.anisotropyAngleUvTransform;l.anisotropyAngleMulCoef=this.anisotropyAngleMulCoef;l.anisotropyAngleAddCoef=this.anisotropyAngleAddCoef;l.displacementMap=this.displacementMap;l.displacementScale=this.displacementScale;l.displacementBias=this.displacementBias;l.reflectionProbes=this.reflectionProbes;l.sheen=this.sheen;l.sheenMap=this.sheenMap;l.sheenMulCoef=this.sheenMulCoef;l.sheenAddCoef=this.sheenAddCoef;l.sheenUvTransform=this.sheenUvTransform;l.sheenMode=this.sheenMode;l._sheenData=this._sheenData!==null?this._sheenData.clone():null;l.clearCoat=this.clearCoat;l.clearCoatMap=this.clearCoatMap;l.clearCoatAddCoef=this.clearCoatAddCoef;l.clearCoatMulCoef=this.clearCoatMulCoef;l.clearCoatUvTransform=this.clearCoatUvTransform;l.clearCoatRoughnessMap=this.clearCoatRoughnessMap;l.clearCoatRoughnessUvTransform=this.clearCoatRoughnessUvTransform;l.clearCoatRoughnessMulCoef=this.clearCoatRoughnessMulCoef;l.clearCoatRoughnessAddCoef=this.clearCoatRoughnessAddCoef;l.clearCoatRoughnessMapLinear=this.clearCoatRoughnessMapLinear;l.coatingGlossinessMap=this.coatingGlossinessMap;l.coatingGlossinessMulCoef=this.coatingGlossinessMulCoef;l.coatingGlossinessAddCoef=this.coatingGlossinessAddCoef;l.clearCoatRoughness=this.clearCoatRoughness;l.clearCoatNormalMap=this.clearCoatNormalMap;l.clearCoatNormalMapFlipY=this.clearCoatNormalMapFlipY;l.clearCoatNormalUvTransform=this.clearCoatNormalUvTransform;l.clearCoatNormalScaleMulCoef=this.clearCoatNormalScaleMulCoef;l.clearCoatNormalScaleAddCoef=this.clearCoatNormalScaleAddCoef;l.clearCoatNormalScale=this.clearCoatNormalScale;l.orangePeel=this.orangePeel;l.orangePeelScale=this.orangePeelScale;l.envMipMap=this.envMipMap;l.envMap=this.envMap;l.overrideIBL=this.overrideIBL!==null?this.overrideIBL.clone():null;l._subsurface=this._subsurface;l._sssLUT=this._sssLUT;l._sssIBLLUT=this._sssIBLLUT;l._translucencyLUT=this._translucencyLUT;l.translucencyScale=this.translucencyScale;l._scatteringCoeffs=this._scatteringCoeffs?this._scatteringCoeffs.slice(0):null;l._absorptionCoeffs=this._absorptionCoeffs?this._absorptionCoeffs.slice(0):null;l.attenuationColor.copy(this.attenuationColor);l.attenuationDistance=this.attenuationDistance;l.subsurfaceColor.copy(this.subsurfaceColor);l.subsurfacePreset=this.subsurfacePreset;l.updateSSS=this.updateSSS;l.bumpMap=this.bumpMap;l.bumpScale=this.bumpScale;l.bumpScaleMulCoef=this.bumpScaleMulCoef;l.bumpScaleAddCoef=this.bumpScaleAddCoef;l.normalMap=this.normalMap;l.normalScale.copy(this.normalScale);l.normalScaleMulCoef=this.normalScaleMulCoef;l.normalScaleAddCoef=this.normalScaleAddCoef;l.normalMapFlipY=this.normalMapFlipY;l.normalUvTransform=this.normalUvTransform;l.lightMap=this.lightMap;l.lightMapMode=this.lightMapMode;l.lightMapLinear=this.lightMapLinear;if(typeof this.flakes!=="undefined"){l.flakes=this.flakes;l.flakesMode=j.mobileVersion?Math.max(1,this.flakesMode):this.flakesMode;l.flakesColor.copy(this.flakesColor);l.flakesBump=this.flakesBump;l.flakesDensity=this.flakesDensity;l.flakesScale=this.flakesScale;l.flakesRoughness=this.flakesRoughness;l.flakesColorMulCoef=this.flakesColorMulCoef;l.flakesColorAddCoef=this.flakesColorAddCoef;l.pearlFlakesColor.copy(this.pearlFlakesColor);l.pearlFlakesBump=this.pearlFlakesBump;l.pearlFlakesDensity=this.pearlFlakesDensity;l.pearlFlakesColorMulCoef=this.pearlFlakesColorMulCoef;l.pearlFlakesColorAddCoef=this.pearlFlakesColorAddCoef}else{l.flakesSize=this.flakesSize;l.flakesSizeUvTransform=this.flakesSizeUvTransform;l.flakesSizeMap=this.flakesSizeMap;l.flakesSizeAddCoef=this.flakesSizeAddCoef;l.flakesSizeMulCoef=this.flakesSizeMulCoef;l.flakesCoverage=this.flakesCoverage;l.flakesCoverageUvTransform=this.flakesCoverageUvTransform;l.flakesCoverageMap=this.flakesCoverageMap;l.flakesCoverageAddCoef=this.flakesCoverageAddCoef;l.flakesCoverageMulCoef=this.flakesCoverageMulCoef;l.flakesRoughness=this.flakesRoughness;l.flakesRoughnessUvTransform=this.flakesRoughnessUvTransform;l.flakesRoughnessMap=this.flakesRoughnessMap;l.flakesRoughnessAddCoef=this.flakesRoughnessAddCoef;l.flakesRoughnessMulCoef=this.flakesRoughnessMulCoef;l.flakesRoughnessMapLinear=this.flakesRoughnessMapLinear;l.flakesColor.copy(this.flakesColor);l.flakesColorUvTransform=this.flakesColorUvTransform;l.flakesColorMap=this.flakesColorMap;l.flakesColorAddCoef=this.flakesColorAddCoef;l.flakesColorMulCoef=this.flakesColorMulCoef;l.flakesColorMapLinear=this.flakesColorMapLinear}l._gasLook=this._gasLook;l.needTangent=this.needTangent;l.needTangentBinormal=this.needTangentBinormal;l.NRECompatibility=this.NRECompatibility;l.sslr=this.sslr;l.uvSlots={diffuseMap:this.uvSlots.diffuseMap,specularMap:this.uvSlots.specularMap,roughnessMap:this.uvSlots.roughnessMap,normalMap:this.uvSlots.normalMap,lightMap:this.uvSlots.lightMap};l.ambienceMatrix=this.ambienceMatrix;l.parallaxCorrectionParameters=this.parallaxCorrectionParameters;l.useFiniteEnvMap=this.useFiniteEnvMap;return l};j.PhysicalMaterial.prototype.setOverrideIBL=function(l){this.overrideIBL=new j.IBLOverrider(l);if(this._sheenData!==null){this._sheenData.overrideIBL.hdr=this.overrideIBL.hdr}this.needsUpdate=true};j.PhysicalMaterial.prototype.setSubsurfaceScatteringPreset=function(l){this.subsurfacePreset=l;j._SubsurfaceScatteringPresets.setValues(this)};j.PhysicalMaterial.prototype.setSubsurfaceScatteringParams=function(r){if(r){this.attenuationColor=r.attenuationColor?r.attenuationColor.clone():this.attenuationColor;this.attenuationDistance=r.attenuationDistance?r.attenuationDistance:this.attenuationDistance;this.subsurfaceColor=r.subsurfaceColor?r.subsurfaceColor.clone():this.subsurfaceColor;this._subsurface=this.subsurfaceColor.getHex()>0;if(this._subsurface){var m=this.attenuationColor;var q=this.attenuationDistance;var n=this.subsurfaceColor;var s=new j.Color(0);s.r=-Math.log(m.r)/q;s.b=-Math.log(m.b)/q;s.g=-Math.log(m.g)/q;var o=new j.Color(0);o.r=1-Math.pow(4.09712+4.20863*n.r-Math.sqrt(9.59217+41.6808*n.r+17.7126*n.r*n.r),2);o.b=1-Math.pow(4.09712+4.20863*n.b-Math.sqrt(9.59217+41.6808*n.b+17.7126*n.b*n.b),2);o.g=1-Math.pow(4.09712+4.20863*n.g-Math.sqrt(9.59217+41.6808*n.g+17.7126*n.g*n.g),2);var l=new j.Color(0);l.r=s.r*(1-o.r);l.g=s.g*(1-o.g);l.b=s.b*(1-o.b);this._absorptionCoeffs=l.toArray();var p=new j.Color(0);p.r=s.r*o.r;p.g=s.g*o.g;p.b=s.b*o.b;this._scatteringCoeffs=p.toArray();this.subsurfacePreset=j.SubsurfaceScatteringPresets.None;this.updateSSS=true}}};j.PhysicalMaterial.prototype._updateSubsurfaceScattering=function(l){if(l===null||!l.ready){return}if(this.updateSSS&&!this.thinWalled){this.needsUpdate=this._sssLUT===null;var m={absorptionCoeffs:this._absorptionCoeffs,scatteringCoeffs:this._scatteringCoeffs,eta:this.ior};if(this._sssLUT!==null){l.decreaseUseCount(this._sssLUT.id)}var n=l.compute(m);this._sssLUT=n.sssLUT;this._sssIBLLUT=n.sssIBLLUT;this._translucencyLUT=n.translucencyLUT;this.updateSSS=false}};j.PhysicalMaterial.prototype.activatePDSFX=function(){this._PDSFXData=new j._PDSFXData();this._PDSFXData.PDSFX=true;this._setDefaultPDSFXOverridableFunctions();this._PDSFXData.PDSFX_hasAlbedo=true;this._PDSFXData.PDSFX_hasEmissive=true;this._PDSFXData.PDSFX_hasTransparency=true;this._PDSFXData.PDSFX_hasSpecular=true};j.PhysicalMaterial.prototype.setSheen=function(o){this.sheenMode=o.sheenMode||this.sheenMode;this.sheenMap=o.sheenMap||this.sheenMap;var n=Math.max(0,Math.min(0.99,o.sheen));var m=this.sheen;this.sheen=n;if((this.sheen>0||this.sheenMap!==null)&&this.sheenMode===j.SheenMode.NO_SHEEN){this.sheenMode=j.SheenMode.VELVET}if(this.sheenMode!==j.SheenMode.NO_SHEEN){if(this._sheenData===null){var l=null;if(this.overrideIBL!==null){l=this.overrideIBL.clone();l.mips=null}else{l=new j.IBLOverrider({})}switch(this.sheenMode){case j.SheenMode.VELVET:l.brdf="ASHIKMIN";break;case j.SheenMode.SATIN:l.brdf="BECKMANN";break;default:}this._sheenData=new j.SheenData({overrideIBL:l})}else{switch(this.sheenMode){case j.SheenMode.VELVET:this._sheenData.overrideIBL.brdf="ASHIKMIN";break;case j.SheenMode.SATIN:this._sheenData.overrideIBL.brdf="BECKMANN";break;default:}if(this.overrideIBL!==null){this._sheenData.overrideIBL.hdr=this.overrideIBL.hdr}}}this.needsUpdate=(this.sheen>0&&m===0||this.sheen===0&&m>0||this.sheenMap!==null)};j.PhysicalMaterial.prototype.loadUniformsFlakes=function(n,p,l,o){if(typeof this.flakes!=="undefined"){if(this.flakes){var m;if(l.flakesColor){if(n.gammaInput){if(this.NRECompatibility){m=new j.Color().copyGammaToLinearNRECompatible(this.flakesColor)}else{m=new j.Color().copyGammaToLinear(this.flakesColor)}}else{m=this.flakesColor}p.uniform3f(l.flakesColor,m.r,m.g,m.b)}if(l.pearlFlakesColor){if(n.gammaInput){if(this.NRECompatibility){m=new j.Color().copyGammaToLinearNRECompatible(this.pearlFlakesColor)}else{m=new j.Color().copyGammaToLinear(this.pearlFlakesColor)}}else{m=this.pearlFlakesColor}p.uniform3f(l.pearlFlakesColor,m.r,m.g,m.b)}if(l.flakesBump){p.uniform1f(l.flakesBump,this.flakesBump)}if(l.flakesDensity){p.uniform1f(l.flakesDensity,this.flakesDensity)}if(l.flakesScale){p.uniform1f(l.flakesScale,this.flakesScale)}if(l.flakesRoughness){p.uniform1f(l.flakesRoughness,this.flakesRoughness)}if(l.pearlFlakesDensity){p.uniform1f(l.pearlFlakesDensity,this.pearlFlakesDensity)}if(l.pearlFlakesBump){p.uniform1f(l.pearlFlakesBump,this.pearlFlakesBump)}if(this.flakesColorMulCoef&&l.flakesColorMulCoef){p.uniform3f(l.flakesColorMulCoef,this.flakesColorMulCoef.x,this.flakesColorMulCoef.y,this.flakesColorMulCoef.z)}if(this.flakesColorAddCoef&&l.flakesColorAddCoef){p.uniform3f(l.flakesColorAddCoef,this.flakesColorAddCoef.x,this.flakesColorAddCoef.y,this.flakesColorAddCoef.z)}if(this.pearlFlakesColorMulCoef&&l.pearlFlakesColorMulCoef){p.uniform3f(l.pearlFlakesColorMulCoef,this.pearlFlakesColorMulCoef.x,this.pearlFlakesColorMulCoef.y,this.pearlFlakesColorMulCoef.z)}if(this.pearlFlakesColorAddCoef&&l.pearlFlakesColorAddCoef){p.uniform3f(l.pearlFlakesColorAddCoef,this.pearlFlakesColorAddCoef.x,this.pearlFlakesColorAddCoef.y,this.pearlFlakesColorAddCoef.z)}}}else{if(this.flakesCoverage>0||this.flakesCoverageMap){var m;if(l.flakesColor){if(n.gammaInput){if(this.NRECompatibility){m=new j.Color().copyGammaToLinearNRECompatible(this.flakesColor)}else{m=new j.Color().copyGammaToLinear(this.flakesColor)}}else{m=this.flakesColor}p.uniform3f(l.flakesColor,m.r,m.g,m.b)}if(l.flakesColorMulCoef){p.uniform3f(l.flakesColorMulCoef,this.flakesColorMulCoef.x,this.flakesColorMulCoef.y,this.flakesColorMulCoef.z)}if(l.flakesColorAddCoef){p.uniform3f(l.flakesColorAddCoef,this.flakesColorAddCoef.x,this.flakesColorAddCoef.y,this.flakesColorAddCoef.z)}if(l.flakesCoverage){p.uniform1f(l.flakesCoverage,this.flakesCoverage)}if(this.flakesCoverageMap){n.loadTexture(p,l.flakesCoverageMap,this.flakesCoverageMap)}if(l.flakesCoverageMulCoef){p.uniform1f(l.flakesCoverageMulCoef,this.flakesCoverageMulCoef)}if(l.flakesCoverageAddCoef){p.uniform1f(l.flakesCoverageAddCoef,this.flakesCoverageAddCoef)}if(l.flakesSize){p.uniform1f(l.flakesSize,this.flakesSize)}if(this.flakesSizeMap){n.loadTexture(p,l.flakesSizeMap,this.flakesSizeMap)}if(l.flakesSizeMulCoef){p.uniform1f(l.flakesSizeMulCoef,this.flakesSizeMulCoef)}if(l.flakesSizeAddCoef){p.uniform1f(l.flakesSizeAddCoef,this.flakesSizeAddCoef)}if(l.flakesRoughness){p.uniform1f(l.flakesRoughness,this.flakesRoughness)}if(this.flakesRoughnessMap){n.loadTexture(p,l.flakesRoughnessMap,this.flakesRoughnessMap)}if(l.flakesRoughnessMulCoef){p.uniform1f(l.flakesRoughnessMulCoef,this.flakesRoughnessMulCoef)}if(l.flakesRoughnessAddCoef){p.uniform1f(l.flakesRoughnessAddCoef,this.flakesRoughnessAddCoef)}if(this.NRECompatibility){if(l.flakesRoughnessUvTransform){n.loadMatrix3(p,l.flakesRoughnessUvTransform,this.flakesRoughnessUvTransform?this.flakesRoughnessUvTransform:new j.Matrix3())}if(l.flakesSizeUvTransform){n.loadMatrix3(p,l.flakesSizeUvTransform,this.flakesSizeUvTransform?this.flakesSizeUvTransform:new j.Matrix3())}if(l.flakesCoverageUvTransform){n.loadMatrix3(p,l.flakesCoverageUvTransform,this.flakesCoverageUvTransform?this.flakesCoverageUvTransform:new j.Matrix3())}if(l.flakesColorUvTransform){n.loadMatrix3(p,l.flakesColorUvTransform,this.flakesColorUvTransform?this.flakesColorUvTransform:new j.Matrix3())}}}}};j.PhysicalMaterial.prototype.loadUniformsCoating=function(m,o,l,n){if(this.clearCoat>0){if(l.clearCoat){o.uniform1f(l.clearCoat,this.clearCoat)}if(l.clearCoatMap){m.loadTexture(o,l.clearCoatMap,this.clearCoatMap)}if(l.clearCoatMulCoef){o.uniform1f(l.clearCoatMulCoef,this.clearCoatMulCoef)}if(l.clearCoatAddCoef){o.uniform1f(l.clearCoatAddCoef,this.clearCoatAddCoef)}if(l.clearCoatRoughness){o.uniform1f(l.clearCoatRoughness,this.clearCoatRoughness)}if(l.clearCoatRoughnessMap){m.loadTexture(o,l.clearCoatRoughnessMap,this.clearCoatRoughnessMap)}if(l.clearCoatRoughnessMulCoef){o.uniform1f(l.clearCoatRoughnessMulCoef,this.clearCoatRoughnessMulCoef)}if(l.clearCoatRoughnessAddCoef){o.uniform1f(l.clearCoatRoughnessAddCoef,this.clearCoatRoughnessAddCoef)}if(l.coatingGlossinessMap){m.loadTexture(o,l.coatingGlossinessMap,this.coatingGlossinessMap)}if(l.coatingGlossinessMulCoef){o.uniform1f(l.coatingGlossinessMulCoef,this.coatingGlossinessMulCoef)}if(l.coatingGlossinessAddCoef){o.uniform1f(l.coatingGlossinessAddCoef,this.coatingGlossinessAddCoef)}if(l.clearCoatNormalMap){m.loadTexture(o,l.clearCoatNormalMap,this.clearCoatNormalMap)}if(l.clearCoatNormalScale){o.uniform1f(l.clearCoatNormalScale,this.clearCoatNormalScaleMulCoef*this.clearCoatNormalScale+this.clearCoatNormalScaleAddCoef)}if(l.orangePeelScale){if(l.orangePeelScale){o.uniform1f(l.orangePeelScale,this.orangePeelScale)}}if(this.NRECompatibility){if(l.clearCoatRoughnessUvTransform){m.loadMatrix3(o,l.clearCoatRoughnessUvTransform,this.clearCoatRoughnessUvTransform?this.clearCoatRoughnessUvTransform:new j.Matrix3())}if(l.clearCoatNormalUvTransform){m.loadMatrix3(o,l.clearCoatNormalUvTransform,this.clearCoatNormalUvTransform?this.clearCoatNormalUvTransform:new j.Matrix3())}}}};j.PhysicalMaterial.prototype.loadUniformsSSS=function(m,o,l,n){if(this._subsurface&&!this.thinWalled){if(l.sssLUT){m.loadTexture(o,l.sssLUT,this._sssLUT)}if(l.sssIBLLUT){m.loadTexture(o,l.sssIBLLUT,this._sssIBLLUT)}if(l.translucencyScale){o.uniform1f(l.translucencyScale,this.translucencyScale)}if(l.translucencyLUT){m.loadTexture(o,l.translucencyLUT,this._translucencyLUT)}}};j.PhysicalMaterial.prototype.loadUniformsSheen=function(m,o,l,n){if(this.sheen>0||this.sheenMap){if(l.sheen){o.uniform1f(l.sheen,this.sheen)}if(l.sheenMap){m.loadTexture(o,l.sheenMap,this.sheenMap)}if(l.sheenMulCoef){o.uniform1f(l.sheenMulCoef,this.sheenMulCoef)}if(l.sheenAddCoef){o.uniform1f(l.sheenAddCoef,this.sheenAddCoef)}if(this.NRECompatibility){if(l.sheenUvTransform){m.loadMatrix3(o,l.sheenUvTransform,this.sheenUvTransform?this.sheenUvTransform:new j.Matrix3())}}if(this._sheenData!==null&&this._sheenData.envMipMap!==null&&l.envMapSheen){m.loadTexture(o,l.envMapSheen,this._sheenData.envMipMap)}}};j.PhysicalMaterial.prototype.loadUniforms=function(q,p,r,m){q.loadUniformsCommon(p,this,r,m);q.loadUniformsNormalMap(p,this,r);q.loadUniformsSkinning(p,this,r);if(this.sslr){if(r.screenSize){p.uniform2f(r.screenSize,q.domElement.width,q.domElement.height)}if(r.invScreenSize){p.uniform2f(r.invScreenSize,1/q.domElement.width,1/q.domElement.height)}if(r.prevColorTexture){q.loadTexture(p,r.prevColorTexture,this.__prevColorTexture)}if(r.prevNormalDepthTexture){q.loadTexture(p,r.prevNormalDepthTexture,this.__prevNormalDepthTexture)}}if(r.normalScale){var o=this.normalScale.clone();o.multiplyScalar(this.normalScaleMulCoef);o.addScalar(this.normalScaleAddCoef);p.uniform2f(r.normalScale,o.x,o.y)}if(this.bumpMap){if(r.bumpScale){p.uniform1f(r.bumpScale,this.bumpScale*this.bumpScaleMulCoef+this.bumpScaleAddCoef)}if(r.bumpMap){q.loadTexture(p,r.bumpMap,this.bumpMap)}}if(r.diffuseAddCoef){p.uniform3f(r.diffuseAddCoef,this.diffuseAddCoef.x,this.diffuseAddCoef.y,this.diffuseAddCoef.z)}if(r.diffuseMulCoef){p.uniform3f(r.diffuseMulCoef,this.diffuseMulCoef.x,this.diffuseMulCoef.y,this.diffuseMulCoef.z)}if(r.specular){var l;var s=this.specular;if(q.gammaInput){if(this.NRECompatibility){l=new j.Color().copyGammaToLinearNRECompatible(s)}else{l=new j.Color().copyGammaToLinear(s)}}else{l=s}p.uniform3f(r.specular,l.r,l.g,l.b)}if(r.specularAddCoef){p.uniform3f(r.specularAddCoef,this.specularAddCoef.x,this.specularAddCoef.y,this.specularAddCoef.z)}if(r.specularMulCoef){p.uniform3f(r.specularMulCoef,this.specularMulCoef.x,this.specularMulCoef.y,this.specularMulCoef.z)}if(r.metalness){p.uniform1f(r.metalness,this.metalness)}if(this.metalnessMap){q.loadTexture(p,r.metalnessMap,this.metalnessMap)}if(r.metalnessMulCoef){p.uniform1f(r.metalnessMulCoef,this.metalnessMulCoef)}if(r.metalnessAddCoef){p.uniform1f(r.metalnessAddCoef,this.metalnessAddCoef)}if(r.specularContrib){p.uniform1f(r.specularContrib,this.specularContrib)}if(this.specularContribMap){q.loadTexture(p,r.specularContribMap,this.specularContribMap)}if(r.specularContribMulCoef){p.uniform1f(r.specularContribMulCoef,this.specularContribMulCoef)}if(r.specularContribAddCoef){p.uniform1f(r.specularContribAddCoef,this.specularContribAddCoef)}if(r.emissionColor){var l=this.emissionColor;if(q.gammaInput){if(this.NRECompatibility){l=new j.Color().copyGammaToLinearNRECompatible(this.emissionColor)}else{l=new j.Color().copyGammaToLinear(this.emissionColor)}}p.uniform3f(r.emissionColor,l.r,l.g,l.b)}if(this.emissionColorMap){q.loadTexture(p,r.emissionColorMap,this.emissionColorMap)}if(r.emissionColorAddCoef){p.uniform3f(r.emissionColorAddCoef,this.emissionColorAddCoef.x,this.emissionColorAddCoef.y,this.emissionColorAddCoef.z)}if(r.emissionColorMulCoef){p.uniform3f(r.emissionColorMulCoef,this.emissionColorMulCoef.x,this.emissionColorMulCoef.y,this.emissionColorMulCoef.z)}if(r.emissionValue){p.uniform1f(r.emissionValue,this.emissionValue)}if(r.transparency){p.uniform1f(r.transparency,this.transparency)}if(this.transparencyMap){q.loadTexture(p,r.transparencyMap,this.transparencyMap)}if(r.transparencyMulCoef){p.uniform1f(r.transparencyMulCoef,this.transparencyMulCoef)}if(r.transparencyAddCoef){p.uniform1f(r.transparencyAddCoef,this.transparencyAddCoef)}if(this.opacityMap){q.loadTexture(p,r.opacityMap,this.opacityMap)}if(r.opacityMulCoef){p.uniform1f(r.opacityMulCoef,this.opacityMulCoef)}if(r.opacityAddCoef){p.uniform1f(r.opacityAddCoef,this.opacityAddCoef)}if(r.ior){p.uniform1f(r.ior,this.ior)}if(r.roughness){p.uniform1f(r.roughness,this.roughness)}if(this.roughnessMap){q.loadTexture(p,r.roughnessMap,this.roughnessMap)}if(r.roughnessMulCoef){p.uniform1f(r.roughnessMulCoef,this.roughnessMulCoef)}if(r.roughnessAddCoef){p.uniform1f(r.roughnessAddCoef,this.roughnessAddCoef)}if(this.glossinessMap){q.loadTexture(p,r.glossinessMap,this.glossinessMap)}if(r.glossinessMulCoef){p.uniform1f(r.glossinessMulCoef,this.glossinessMulCoef)}if(r.glossinessAddCoef){p.uniform1f(r.glossinessAddCoef,this.glossinessAddCoef)}if(r.anisotropy){p.uniform1f(r.anisotropy,this.anisotropy)}if(r.anisotropyMap){q.loadTexture(p,r.anisotropyMap,this.anisotropyMap)}if(r.anisotropyMulCoef){p.uniform1f(r.anisotropyMulCoef,this.anisotropyMulCoef)}if(r.anisotropyAddCoef){p.uniform1f(r.anisotropyAddCoef,this.anisotropyAddCoef)}if(r.anisotropyAngle){p.uniform1f(r.anisotropyAngle,this.anisotropyAngle)}if(r.anisotropyAngleMap){q.loadTexture(p,r.anisotropyAngleMap,this.anisotropyAngleMap)}if(r.anisotropyAngleMulCoef){p.uniform1f(r.anisotropyAngleMulCoef,this.anisotropyAngleMulCoef)}if(r.anisotropyAngleAddCoef){p.uniform1f(r.anisotropyAngleAddCoef,this.anisotropyAngleAddCoef)}if(r.displacementMap){q.loadTexture(p,r.displacementMap,this.displacementMap)}if(r.displacementBias){p.uniform1f(r.displacementBias,this.displacementBias)}if(r.displacementScale){p.uniform1f(r.displacementScale,this.displacementScale)}if(this.useFiniteEnvMap){if(r.sphereCenter){p.uniform3f(r.sphereCenter,this.parallaxCorrectionParameters.sphereCenter.x,this.parallaxCorrectionParameters.sphereCenter.y,this.parallaxCorrectionParameters.sphereCenter.z)}if(r.projectionCenter){p.uniform3f(r.projectionCenter,this.parallaxCorrectionParameters.projectionCenter.x,this.parallaxCorrectionParameters.projectionCenter.y,this.parallaxCorrectionParameters.projectionCenter.z)}if(r.sphereRadius){p.uniform1f(r.sphereRadius,this.parallaxCorrectionParameters.sphereRadius)}}if(this.reflectionProbes&&this.reflectionProbes.length){if(r.reflectionProbe){q.loadTexture(p,r.reflectionProbe,this.reflectionProbes[0].map0)}if(r.reflectionProbeMips){q.loadTexture(p,r.reflectionProbeMips,this.reflectionProbes[0].map1)}if(r.reflectionProbePos){p.uniform3f(r.reflectionProbePos,this.reflectionProbes[0].position.x,this.reflectionProbes[0].position.y,this.reflectionProbes[0].position.z)}if(r.reflectionProbeProxyMin){p.uniform3f(r.reflectionProbeProxyMin,this.reflectionProbes[0].geomProxy.min.x,this.reflectionProbes[0].geomProxy.min.y,this.reflectionProbes[0].geomProxy.min.z)}if(r.reflectionProbeProxyMax){p.uniform3f(r.reflectionProbeProxyMax,this.reflectionProbes[0].geomProxy.max.x,this.reflectionProbes[0].geomProxy.max.y,this.reflectionProbes[0].geomProxy.max.z)}}this.loadUniformsFlakes(q,p,r,m);this.loadUniformsCoating(q,p,r,m);this.loadUniformsSheen(q,p,r,m);if(r.precomputedTexture1){var n=q.precomputedTexture1;if(n&&n.onRequest){n.onRequest();n.onRequest=null}q.loadTexture(p,r.precomputedTexture1,n)}if(r.precomputedTexture2){var n=q.precomputedTexture2;if(n&&n.onRequest){n.onRequest();n.onRequest=null}q.loadTexture(p,r.precomputedTexture2,n)}if(r.precomputedTexture3){var n=q.precomputedTexture3;if(n&&n.onRequest){n.onRequest();n.onRequest=null}q.loadTexture(p,r.precomputedTexture3,n)}if(this.envMipMap&&this.envMipMap[0]){if(r.envMap){q.loadTexture(p,r.envMap,this.envMipMap[0])}if(r.envMap2){q.loadTexture(p,r.envMap2,this.envMipMap[1])}if(this.envMipMap[0]&&this.envMipMap[0].hdr&&this.envMipMap[0].image){if(r.envMapHDRSize){p.uniform2f(r.envMapHDRSize,parseInt(this.envMipMap[0].image.width),parseInt(this.envMipMap[0].image.height))}}var t=this.envMipMap[0].envMapExposure;if(r.envMapExposure){p.uniform1f(r.envMapExposure,(t||(t===0))?t:1)}if(r.ambienceMatrix){p.uniformMatrix4fv(r.ambienceMatrix,false,this.ambienceMatrix.elements)}}this.loadUniformsSSS(q,p,r,m);if(this.NRECompatibility){if(r.normalUvTransform){q.loadMatrix3(p,r.normalUvTransform,this.normalUvTransform?this.normalUvTransform:new j.Matrix3())}if(r.diffuseUvTransform){q.loadMatrix3(p,r.diffuseUvTransform,this.diffuseUvTransform?this.diffuseUvTransform:new j.Matrix3())}if(r.specularUvTransform){q.loadMatrix3(p,r.specularUvTransform,this.specularUvTransform?this.specularUvTransform:new j.Matrix3())}if(r.metalnessUvTransform){q.loadMatrix3(p,r.metalnessUvTransform,this.metalnessUvTransform?this.metalnessUvTransform:new j.Matrix3())}if(r.emissionColorUvTransform){q.loadMatrix3(p,r.emissionColorUvTransform,this.emissionColorUvTransform?this.emissionColorUvTransform:new j.Matrix3())}if(r.specularContribUvTransform){q.loadMatrix3(p,r.specularContribUvTransform,this.specularContribUvTransform?this.specularContribUvTransform:new j.Matrix3())}if(r.transparencyUvTransform){q.loadMatrix3(p,r.transparencyUvTransform,this.transparencyUvTransform?this.transparencyUvTransform:new j.Matrix3())}if(r.opacityUvTransform){q.loadMatrix3(p,r.opacityUvTransform,this.opacityUvTransform?this.opacityUvTransform:new j.Matrix3())}if(r.roughnessUvTransform){q.loadMatrix3(p,r.roughnessUvTransform,this.roughnessUvTransform?this.roughnessUvTransform:new j.Matrix3())}if(r.anisotropyUvTransform){q.loadMatrix3(p,r.anisotropyUvTransform,this.anisotropyUvTransform?this.anisotropyUvTransform:new j.Matrix3())}if(r.anisotropyAngleUvTransform){q.loadMatrix3(p,r.anisotropyAngleUvTransform,this.anisotropyAngleUvTransform?this.anisotropyAngleUvTransform:new j.Matrix3())}}};j.ShaderChunk.lights_physicalDS_pars_vertex=["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform int pointLightPhysicalAttenuation[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform int spotLightPhysicalAttenuation[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#if MAX_IES_LIGHTS > 0","uniform vec3 iesLightPosition[ MAX_IES_LIGHTS ];","uniform float iesLightDistance[ MAX_IES_LIGHTS ];","varying vec4 viesLight[ MAX_IES_LIGHTS ];","uniform sampler2D iesLightTexture[ MAX_IES_LIGHTS ];","uniform mat4 matrixWorldInv[MAX_IES_LIGHTS];","#endif","#endif","#if MAX_TUBE_LIGHTS > 0 || MAX_AREA_LIGHTS > 0 || MAX_DISK_LIGHTS > 0 || MAX_SPHERE_LIGHTS > 0","#define HAS_AREA_LIGHTS","#endif","varying vec3 vWorldPosition;","varying vec3 vWorldNormal;",].join("\n");j.ShaderChunk.lights_physicalDS_vertex=["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","vPointLight[ i ] = vec4( lVector, lDistance );","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","vSpotLight[ i ] = vec4( lVector, lDistance );","}","#endif","#if MAX_IES_LIGHTS > 0","for( int i = 0; i < MAX_IES_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( iesLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( iesLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / iesLightDistance[ i ] ), 1.0 );","viesLight[ i ] = vec4( lVector, lDistance );","}","#endif","#endif","vWorldPosition = worldPosition.xyz;","vWorldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","vWorldNormal = normalize( vWorldNormal );",].join("\n");j.ShaderChunk.madCoefficients_pars_fragment=["#ifdef USE_DIFFUSE_COEFFICIENTS","uniform vec3 diffuseMulCoef;","uniform vec3 diffuseAddCoef;","#endif","#ifdef USE_SPECULAR_COEFFICIENTS","uniform vec3 specularMulCoef;","uniform vec3 specularAddCoef;","#endif","#ifdef USE_METALNESS_COEFFICIENTS","uniform float metalnessMulCoef;","uniform float metalnessAddCoef;","#endif","#ifdef USE_SPECULARCONTRIB_COEFFICIENTS","uniform float specularContribMulCoef;","uniform float specularContribAddCoef;","#endif","#ifdef USE_EMISSIONCOLOR_COEFFICIENTS","uniform vec3 emissionColorMulCoef;","uniform vec3 emissionColorAddCoef;","#endif","#ifdef USE_TRANSPARENCY_COEFFICIENTS","uniform float transparencyMulCoef;","uniform float transparencyAddCoef;","#endif","#ifdef USE_OPACITY_COEFFICIENTS","uniform float opacityMulCoef;","uniform float opacityAddCoef;","#endif","#ifdef USE_ROUGHNESS_COEFFICIENTS","uniform float roughnessMulCoef;","uniform float roughnessAddCoef;","#endif","#ifdef USE_GLOSSINESS_COEFFICIENTS","uniform float glossinessMulCoef;","uniform float glossinessAddCoef;","#endif","#ifdef USE_ANISOTROPY_COEFFICIENTS","uniform float anisotropyMulCoef;","uniform float anisotropyAddCoef;","#endif","#ifdef USE_ANISOTROPYANGLE_COEFFICIENTS","uniform float anisotropyAngleMulCoef;","uniform float anisotropyAngleAddCoef;","#endif","#ifdef USE_CC_COEFFICIENTS","uniform float clearCoatMulCoef;","uniform float clearCoatAddCoef;","#endif","#ifdef USE_CC_ROUGHNESS_COEFFICIENTS","uniform float clearCoatRoughnessMulCoef;","uniform float clearCoatRoughnessAddCoef;","#endif","#ifdef USE_CC_GLOSSINESS_COEFFICIENTS","uniform float coatingGlossinessMulCoef;","uniform float coatingGlossinessAddCoef;","#endif","#ifdef USE_SHEEN_COEFFICIENTS","uniform float sheenMulCoef;","uniform float sheenAddCoef;","#endif","#ifndef OLD_FLAKES","#ifdef USE_FLAKESCOLOR_COEFFICIENTS","uniform vec3 flakesColorMulCoef;","uniform vec3 flakesColorAddCoef;","#endif","#endif","#ifdef USE_FLAKESSIZE_COEFFICIENTS","uniform float flakesSizeMulCoef;","uniform float flakesSizeAddCoef;","#endif","#ifdef USE_FLAKESCOVERAGE_COEFFICIENTS","uniform float flakesCoverageMulCoef;","uniform float flakesCoverageAddCoef;","#endif","#ifdef USE_FLAKESROUGHNESS_COEFFICIENTS","uniform float flakesRoughnessMulCoef;","uniform float flakesRoughnessAddCoef;","#endif",].join("\n");j.ShaderChunk.lights_uniform_fragment=["#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","uniform float directionalLightNear[ MAX_DIR_LIGHTS ];","uniform float directionalLightFar[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform int pointLightPhysicalAttenuation[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#else","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#endif","#if MAX_IES_LIGHTS > 0","uniform vec3 iesLightColor[ MAX_IES_LIGHTS ];","uniform sampler2D iesLightTexture[ MAX_IES_LIGHTS ];","uniform mat4 matrixWorldInv[MAX_IES_LIGHTS];","#ifdef PHONG_PER_PIXEL","uniform vec3 iesLightPosition[ MAX_IES_LIGHTS ];","uniform float iesLightDistance[ MAX_IES_LIGHTS ];","#else","varying vec4 viesLight[ MAX_IES_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightInnerAngleCos[ MAX_SPOT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform int spotLightPhysicalAttenuation[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#else","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPHERE_LIGHTS > 0","uniform vec3 sphereLightColor[ MAX_SPHERE_LIGHTS ];","uniform vec3 sphereLightPosition[ MAX_SPHERE_LIGHTS ];","uniform vec3 sphereLightData[ MAX_SPHERE_LIGHTS ];","#endif","#if MAX_DISK_LIGHTS > 0","uniform vec3 diskLightColor[ MAX_DISK_LIGHTS ];","uniform vec3 diskLightPosition[ MAX_DISK_LIGHTS ];","uniform vec3 diskLightNormal[ MAX_DISK_LIGHTS ];","uniform vec3 diskLightData[ MAX_DISK_LIGHTS ];","#endif","#if MAX_AREA_LIGHTS > 0","uniform vec3 areaLightColor[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightPosition[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightNormal[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightRight[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightUp[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightData[ MAX_AREA_LIGHTS ];","#endif","#if MAX_TUBE_LIGHTS > 0","uniform vec3 tubeLightColor[ MAX_TUBE_LIGHTS ];","uniform vec3 tubeLightPosition[ MAX_TUBE_LIGHTS ];","uniform vec3 tubeLightRight[ MAX_TUBE_LIGHTS ];","uniform vec3 tubeLightData[ MAX_TUBE_LIGHTS ];","#endif","#if MAX_TUBE_LIGHTS > 0 || MAX_AREA_LIGHTS > 0 || MAX_DISK_LIGHTS > 0 || MAX_SPHERE_LIGHTS > 0","#define HAS_AREA_LIGHTS","#endif","#ifdef HAS_AREA_LIGHTS","uniform sampler2D precomputedAreaGGX1texture;","uniform sampler2D precomputedAreaGGX2texture;","#ifdef USE_SHEEN","uniform sampler2D precomputedAreaSheentexture;","#endif","#endif","#ifdef USE_LIGHTMAP","uniform sampler2D lightMap;","#endif","uniform vec3 ambientLightColor;"].join("\n");j.ShaderChunk.physicalDS_uniforms_pars_fragment=[j.ShaderChunk.PDSFX_albedo_pars_fragment,"#ifdef USE_MAP","uniform mat3 diffuseUvTransform;","#endif",j.ShaderChunk.PDSFX_specular_pars_fragment,"#ifdef USE_SPECULARMAP","uniform mat3 specularUvTransform;","#endif","uniform vec3 emissionColor;","uniform float emissionValue;","#ifdef USE_EMISSIONCOLORMAP","uniform sampler2D emissionColorMap;","uniform mat3 emissionColorUvTransform;","#endif",j.ShaderChunk.PDSFX_transparency_pars_fragment,"#ifdef USE_TRANSPARENCYMAP","uniform sampler2D transparencyMap;","uniform mat3 transparencyUvTransform;","#endif",j.ShaderChunk.PDSFX_opacity_pars_fragment,"#ifdef USE_OPACITYMAP","uniform sampler2D opacityMap;","uniform mat3 opacityUvTransform;","#endif","uniform float metalness;","#ifdef USE_METALNESSMAP","uniform sampler2D metalnessMap;","uniform mat3 metalnessUvTransform;","#endif","uniform float specularContrib;","#ifdef USE_SPECULARCONTRIBMAP","uniform sampler2D specularContribMap;","uniform mat3 specularContribUvTransform;","#endif","uniform float ior;","uniform float roughness;","#ifdef USE_ROUGHNESSMAP","uniform sampler2D roughnessMap;","#endif","#ifdef USE_GLOSSINESSMAP","uniform sampler2D glossinessMap;","#endif","#if defined(USE_ROUGHNESSMAP) || defined(USE_GLOSSINESSMAP)","uniform mat3 roughnessUvTransform;","#endif","#ifdef USE_ANISOTROPY","uniform float anisotropy;","uniform float anisotropyAngle;","#ifdef USE_ANISOTROPYMAP","uniform sampler2D anisotropyMap;","uniform mat3 anisotropyUvTransform;","#endif","#ifdef USE_ANISOTROPYANGLEMAP","uniform sampler2D anisotropyAngleMap;","uniform mat3 anisotropyAngleUvTransform;","#endif","#endif","#ifdef USE_SHEEN","uniform float sheen;","#ifdef USE_SHEEN_MAP","uniform sampler2D sheenMap;","uniform mat3 sheenUvTransform;","#endif","#ifdef USE_ENVMAP_SHEEN","uniform sampler2D envMapSheen;","#endif","#endif","#ifdef CLEAR_COAT","uniform float clearCoat;","#ifdef CLEAR_COAT_MAP","uniform sampler2D clearCoatMap;","uniform mat3 clearCoatUvTransform;","#endif","#ifdef CLEAR_COAT_NORMALMAP","uniform sampler2D clearCoatNormalMap;","uniform mat3 clearCoatNormalUvTransform;","#endif","uniform float clearCoatNormalScale;","uniform float clearCoatRoughness;","#ifdef USE_CC_ROUGHNESSMAP","uniform sampler2D clearCoatRoughnessMap;","#endif","#ifdef USE_CC_GLOSSINESSMAP","uniform sampler2D coatingGlossinessMap;","#endif","#if defined(USE_CC_ROUGHNESSMAP) || defined(USE_CC_GLOSSINESSMAP)","uniform mat3 clearCoatRoughnessUvTransform;","#endif","#ifdef USE_ORANGE_PEEL","uniform float orangePeelScale;","#endif","#endif","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","uniform vec3 flakesColor;","uniform float flakesDensity;","uniform float flakesBump;","uniform vec3 flakesColorMulCoef;","uniform vec3 flakesColorAddCoef;","uniform vec3 pearlFlakesColor;","uniform float pearlFlakesDensity;","uniform float pearlFlakesBump;","uniform vec3 pearlFlakesColorMulCoef;","uniform vec3 pearlFlakesColorAddCoef;","uniform float flakesRoughness;","uniform float flakesScale;","#else","uniform vec3 flakesColor;","#ifdef USE_FLAKESCOLOR_MAP","uniform sampler2D flakesColorMap;","uniform mat3 flakesColorUvTransform;","#endif","uniform float flakesCoverage;","#ifdef USE_FLAKESCOVERAGE_MAP","uniform sampler2D flakesCoverageMap;","uniform mat3 flakesCoverageUvTransform;","#endif","uniform float flakesRoughness;","#ifdef USE_FLAKESROUGHNESS_MAP","uniform sampler2D flakesRoughnessMap;","uniform mat3 flakesRoughnessUvTransform;","#endif","uniform float flakesSize;","#ifdef USE_FLAKESSIZE_MAP","uniform sampler2D flakesSizeMap;","uniform mat3 flakesSizeUvTransform;","#endif","#endif","#endif","#ifdef USE_SUBSURFACE","#ifdef USE_SSSLUT","uniform sampler2D sssLUT;","#endif","#ifdef USE_SSSIBLLUT","uniform sampler2D sssIBLLUT;","#endif","#endif","#if defined(USE_TRANSLUCENCY) && defined(USE_SHADOWMAP)","uniform float translucencyScale;","#ifdef USE_TRANSLUCENCYLUT","uniform sampler2D translucencyLUT;","#endif","#endif","#ifdef USE_NORMALMAP","uniform mat3 normalUvTransform;","#endif",].join("\n");j.ShaderChunk.iteration_aniso_pars_fragment=["#if defined(USE_ANISOTROPY)","vec3 ImportanceSampleGGXAniso(vec2 Xi, float roughness, vec3 T, vec3 B, vec3 N, float iAnisotropy) {","vec3 H;","float m = roughness * roughness;","float a_x = m;","float a_y = mix(0.0, m, 1.0 - iAnisotropy);","a_x = max(a_x, kEpsilon);","a_y = max(a_y, kEpsilon);","float coef = sqrt(Xi.y / (1.0 - Xi.y));","H = coef * (a_x * cos(2.0 * PI * Xi.x) * T + a_y * sin(2.0 * PI * Xi.x) * B) + N;","return normalize(H);","}","void SpecularTransmisIBLAniso(inout vec3 specularColor, inout vec3 transmissiveColor, float roughness, vec3 T, vec3 B, vec3 N, vec3 V, float NoV, vec3 specColorF0, vec3 specColorF90, vec2 textureSize, vec2 texelSize, float iAnisotropy, float iAnisotropyAngle) {","vec3 spec = vec3(0.0);","vec3 trans = vec3(0.0);","vec3 Taniso = cos(2.0 * PI * iAnisotropyAngle) * T + sin(2.0 * PI * iAnisotropyAngle) * B;","vec3 Baniso = cross(N, Taniso);","const int nbSamples = 8;","for (int i = 0; i < nbSamples; i++) {","int renderI = i + renderIteration;","int n = (renderI*512)/1024;","int m = int(mod(float(renderI * 512),1024.0));","vec2 E = Hammersley2D(n+m,1024);","vec3 H = ImportanceSampleGGXAniso(E, roughness, Taniso, Baniso, N, iAnisotropy);","vec3 L = 2.0 * dot(V, H) * H - V;","float NoL = clamp(dot(N, L), 0.0, 1.0);","float NoH = clamp(dot(N, H), 0.0, 1.0);","float VoH = clamp(dot(V, H), 0.0, 1.0);","if (NoL > 0.0) {","vec3 worldL = normalize( vec3( vec4( L, 0.0 ) * viewMatrix ) );","#ifdef USE_REFLECTION_PROBE","worldL = correctParallax(vWorldPosition, worldL);","#endif","#ifdef USE_FINITE_ENVMAP","worldL = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, worldL, vWorldPosition);","#endif","vec2 dirUV = getEnvMapUV(worldL);","vec3 worldLt = normalize( vec3( vec4( L - 2.0 * NoL * N, 0.0 ) * viewMatrix ) );","vec2 dirUVt = getEnvMapUV(worldLt);","#ifdef USE_REFLECTION_PROBE","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUV, textureSize, texelSize).xyz;","vec3 colorIBLt = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUVt, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(reflectionProbe, dirUV).xyz;","vec3 colorIBLt = envMapExposure * texture2D(reflectionProbe, dirUVt).xyz;","#endif","#else","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUV, textureSize, texelSize).xyz;","vec3 colorIBLt = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUVt, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(envmap, dirUV).xyz;","vec3 colorIBLt = envMapExposure * texture2D(envmap, dirUVt).xyz;","#endif","#endif","#ifdef USE_SSLR","    vec4 reflectColor = vec4(0.0);","    if (renderIteration > 0) {","        reflectColor = RayMarch(-vViewPosition, L);","        reflectColor *= reflectColor;","    }","    colorIBL = mix(colorIBL, reflectColor.xyz, reflectColor.w);","#endif","float GVis = 0.25 * GeometricSchlick(roughness, NoV, NoL)/max(NoL*NoV,1e-3);","float NoLPDF = 4.0 * NoL * VoH / max(NoH,1e-3);","vec3 F = FresnelSchlick(specColorF0, specColorF90, VoH);","spec += NoLPDF * colorIBL * F * GVis ;","float GVisTrans;","#ifdef THIN_WALLED","GVisTrans =  GVis ;","#else","GVisTrans = (ior*ior)* GeometricSchlick(roughness, NoV, NoL);","float LoH = clamp(dot(L, H), 0.0, 1.0);","GVisTrans *= abs(LoH*VoH)/max(abs(NoL * NoV),1e-6);","GVisTrans /= max(ior*LoH + pow2(ior*VoH),1e-6);","#endif","trans += colorIBLt * GVisTrans*NoLPDF*(1.0 - F);","}","}","specularColor = spec/float(nbSamples);","transmissiveColor = trans/float(nbSamples);","}","void SpecularIBLAniso(inout vec3 specularColor, float roughness, vec3 T, vec3 B, vec3 N, vec3 V, float NoV, vec3 specColorF0, vec3 specColorF90, vec2 textureSize, vec2 texelSize, float iAnisotropy, float iAnisotropyAngle) {","vec3 spec = vec3(0.0);","vec3 trans = vec3(0.0);","vec3 Taniso = cos(2.0 * PI * iAnisotropyAngle) * T + sin(2.0 * PI * iAnisotropyAngle) * B;","vec3 Baniso = cross(N, Taniso);","const int nbSamples = 8;","for (int i = 0; i < nbSamples; i++) {","int renderI = i + renderIteration;","int n = (renderI*512)/1024;","int m = int(mod(float(renderI * 512),1024.0));","vec2 E = Hammersley2D(n+m,1024);","vec3 H = ImportanceSampleGGXAniso(E, roughness, Taniso, Baniso, N, iAnisotropy);","vec3 L = 2.0 * dot(V, H) * H - V;","float NoL = clamp(dot(N, L), 0.0, 1.0);","float NoH = clamp(dot(N, H), 0.0, 1.0);","float VoH = clamp(dot(V, H), 0.0, 1.0);","if (NoL > 0.0) {","vec3 worldL = normalize( vec3( vec4( L, 0.0 ) * viewMatrix ) );","#ifdef USE_REFLECTION_PROBE","worldL = correctParallax(vWorldPosition, worldL);","#endif","#ifdef USE_FINITE_ENVMAP","worldL = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, worldL, vWorldPosition);","#endif","vec2 dirUV = getEnvMapUV(worldL);","#ifdef USE_REFLECTION_PROBE","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUV, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(reflectionProbe, dirUV).xyz;","#endif","#else","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUV, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(envMap, dirUV).xyz;","#endif","#endif","#ifdef USE_SSLR","    vec4 reflectColor = vec4(0.0);","    if (renderIteration > 0) {","        reflectColor = RayMarch(-vViewPosition, L);","        reflectColor *= reflectColor;","    }","    colorIBL = mix(colorIBL, reflectColor.xyz, reflectColor.w);","#endif","float GVis = 0.25 * GeometricSchlick(roughness, NoV, NoL)/max(NoL*NoV,1e-3);","float NoLPDF = 4.0 * NoL * VoH / max(NoH,1e-3);","vec3 F = FresnelSchlick(specColorF0, specColorF90, VoH);","spec += NoLPDF * colorIBL * F * GVis ;","}","}","specularColor = spec/float(nbSamples);","}","#endif",].join("\n");j.ShaderChunk.iteration_sheen_pars_fragment=["#ifdef USE_SHEEN","vec2 vLogComplex(in float value) {","float real = log(abs(value));","float im = atan(0.0,value);","return vec2(real,im);","}","vec2 invComplex(in vec2 value) {","return vec2(value.x,-value.y)/(value.x * value.x + value.y * value.y);","}","vec3 ImportanceSampleAshikmin(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * PI * Xi.x;","float a = roughness * roughness;","float a2 = a * a;","float interiorTerm = 4.0*a2*exp(1.0/a2)/(4.0*a2*Xi.y + Xi.y - 1.0);","vec2 exteriorTerm = a2*vLogComplex(interiorTerm);","vec2 value = invComplex(exteriorTerm);","float val = min(length(value),1.0);","float SinTheta = sqrt(val);","float CosTheta = sqrt(1.0 - val);","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return H;","}","vec3 ImportanceSampleBeckmann(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * PI * Xi.x;","float a = roughness * roughness;","float a2 = a * a;","float loga = 8.0*a2*log(1.0-Xi.y);","float value = loga / (loga - 1.0);","float SinTheta = sqrt(value);","float CosTheta = sqrt(1.0 - value);","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return H;","}","void SheenIBL(inout vec4 specularColor, float roughness, vec3 N, vec3 V, float NoV, vec2 textureSize, vec2 texelSize) {","const int nbSamples = 1;","vec3 spec = vec3(0.0);","for (int i = 0; i < nbSamples; i++) {","int renderI = i + renderIteration;","int n = (renderI*512)/1024;","int m = int(mod(float(renderI * 512),1024.0));","vec2 E = Hammersley2D(n+m,1024);","#ifdef USE_VELVET","vec3 perturbedZ = ImportanceSampleAshikmin(E, roughness);","#else","vec3 perturbedZ = ImportanceSampleBeckmann(E, roughness);","#endif","vec3 H = TangentToWorld(perturbedZ, N);","vec3 L = 2.0 * dot(V, H) * H - V;","float NoL = clamp(dot(N, L), 0.0, 1.0);","float NoH = clamp(dot(N, H), 0.0, 1.0);","float VoH = clamp(dot(V, H), 0.0, 1.0);","if (NoL > 0.0) {","vec3 worldL = normalize( vec3( vec4( L, 0.0 ) * viewMatrix ) );","#ifdef USE_REFLECTION_PROBE","worldL = correctParallax(vWorldPosition, worldL);","#endif","#ifdef USE_FINITE_ENVMAP","worldL = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, worldL, vWorldPosition);","#endif","vec2 dirUV = getEnvMapUV(worldL);","#ifdef USE_REFLECTION_PROBE","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUV, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(reflectionProbe, dirUV).xyz;","#endif","#else","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUV, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(envMap, dirUV).xyz;","#endif","#endif","float GVis = SheenVisGeometricSchlick(NoV, NoL);","float NoLPDF = 4.0 * NoL * VoH / max(NoH,1e-6);","spec += NoLPDF * colorIBL * GVis;","}","}","specularColor.xyz = spec/float(nbSamples);","}","#ifdef USE_ANISOTROPY","void SheenIBLAniso(inout vec4 specularColor, float roughness, in vec3 T, in vec3 B, vec3 N, vec3 V, float NoV, vec2 textureSize, vec2 texelSize, in float anisotropyValue, in float anisotropyAngleValue) {","const int nbSamples = 8;","vec3 spec = vec3(0.0);","for (int i = 0; i < nbSamples; i++) {","int renderI = i + renderIteration;","int n = (renderI*512)/1024;","int m = int(mod(float(renderI * 512),1024.0));","vec2 E = Hammersley2D(n+m,1024);","float r = ComputeAnisotropicRoughness(T,B,N,H,roughness, anisotropyValue, anisotropyAngleValue);","#ifdef USE_VELVET","vec3 perturbedZ = ImportanceSampleAshikmin(E, r);","#else","vec3 perturbedZ = ImportanceSampleBeckmann(E, r);","#endif","vec3 H = TangentToWorld(perturbedZ, N);","vec3 L = 2.0 * dot(V, H) * H - V;","float NoL = clamp(dot(N, L), 0.0, 1.0);","float NoH = clamp(dot(N, H), 0.0, 1.0);","float VoH = clamp(dot(V, H), 0.0, 1.0);","if (NoL > 0.0) {","vec3 worldL = normalize( vec3( vec4( L, 0.0 ) * viewMatrix ) );","#ifdef USE_REFLECTION_PROBE","worldL = correctParallax(vWorldPosition, worldL);","#endif","vec2 dirUV = getEnvMapUV(worldL);","#ifdef USE_REFLECTION_PROBE","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUV, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUV, textureSize, texelSize).xyz;","#endif","float GVis = SheenVisGeometricSchlick(NoV, NoL);","float NoLPDF = 4.0 * NoL * VoH / max(NoH,1e-6);","spec += NoLPDF * colorIBL * GVis;","}","}","specularColor.xyz = spec/float(nbSamples);","}","#endif","#endif",].join("\n");j.ShaderChunk.iteration_pars_fragment=["#if defined(USE_ITERATION) && defined(USE_ENVMAP)","void SpecularTransmisIBL(inout vec3 specularColor, inout vec3 transmissiveColor, float roughness, vec3 N, vec3 V, float NoV, vec3 specColorF0, vec3 specColorF90, vec2 textureSize, vec2 texelSize) {","const int nbSamples = 1;","vec3 spec = vec3(0.0);","vec3 trans = vec3(0.0);","for (int i = 0; i < nbSamples; i++) {","int renderI = i + renderIteration + 1;","int n = (renderI*512)/1024;","int m = int(mod(float(renderI * 512),1024.0));","vec2 E = Hammersley2D(n+m,1024);","vec3 perturbedZ = ImportanceSampleGGX(E, roughness);","vec3 H = TangentToWorld(perturbedZ, N);","vec3 L = 2.0 * dot(V, H) * H - V;","float NoL = clamp(dot(N, L), 0.0, 1.0);","float NoH = clamp(dot(N, H), 0.0, 1.0);","float VoH = clamp(dot(V, H), 0.0, 1.0);","if (NoL > 0.0) {","vec3 worldL = normalize( vec3( vec4( L, 0.0 ) * viewMatrix ) );","#ifdef USE_REFLECTION_PROBE","worldL = correctParallax(vWorldPosition, worldL);","#endif","#ifdef USE_FINITE_ENVMAP","worldL = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, worldL, vWorldPosition);","#endif","vec2 dirUV = getEnvMapUV(worldL);","vec3 worldLt = normalize( vec3( vec4( L - 2.0 * NoL * N, 0.0 ) * viewMatrix ) );","vec2 dirUVt = getEnvMapUV(worldLt);","#ifdef USE_REFLECTION_PROBE","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUV, textureSize, texelSize).xyz;","vec3 colorIBLt = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUVt, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(reflectionProbe, dirUV).xyz;","vec3 colorIBLt = envMapExposure * texture2D(reflectionProbe, dirUVt).xyz;","#endif","#else","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUV, textureSize, texelSize).xyz;","vec3 colorIBLt = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUVt, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(envMap, dirUV).xyz;","vec3 colorIBLt = envMapExposure * texture2D(envMap, dirUVt).xyz;","#endif","#endif","#ifdef USE_SSLR","    vec4 reflectColor = vec4(0.0);","    if (renderIteration > 0) {","        reflectColor = RayMarch(-vViewPosition, L);","        reflectColor.xyz *= reflectColor.xyz;","    }","    colorIBL = mix(colorIBL, reflectColor.xyz, reflectColor.w);","#endif","float GVis = 0.25 * GeometricSchlick(roughness, NoV, NoL)/max(NoL*NoV,1e-3);","float NoLPDF = 4.0 * NoL * VoH / max(NoH,1e-3);","vec3 F = FresnelSchlick(specColorF0, specColorF90, VoH);","spec += NoLPDF * colorIBL * F*GVis ;","float GVisTrans;","#ifdef THIN_WALLED","GVisTrans =  GVis ;","#else","GVisTrans = (ior*ior)* GeometricSchlick(roughness, NoV, NoL);","float LoH = clamp(dot(L, H), 0.0, 1.0);","GVisTrans *= abs(LoH*VoH)/max(abs(NoL * NoV),1e-3);","GVisTrans /= max(ior*LoH + pow2(ior*VoH),1e-3);","#endif","trans += colorIBLt * GVisTrans*NoLPDF*(1.0 - F);","}","}","specularColor = spec/float(nbSamples);","transmissiveColor = trans/float(nbSamples);","}","void SpecularIBL(inout vec3 specularColor, float roughness, vec3 N, vec3 V, float NoV, vec3 specColorF0, vec3 specColorF90, vec2 textureSize, vec2 texelSize) {","const int nbSamples = 1;","vec3 spec = vec3(0.0);","for (int i = 0; i < nbSamples; i++) {","int renderI = i + renderIteration + 1;","int n = (renderI*512)/1024;","int m = int(mod(float(renderI * 512),1024.0));","vec2 E = Hammersley2D(n+m,1024);","vec3 perturbedZ = ImportanceSampleGGX(E, roughness);","vec3 H = TangentToWorld(perturbedZ, N);","vec3 L = 2.0 * dot(V, H) * H - V;","float NoL = clamp(dot(N, L), 0.0, 1.0);","float NoH = clamp(dot(N, H), 0.0, 1.0);","float VoH = clamp(dot(V, H), 0.0, 1.0);","if (NoL > 0.0) {","vec3 worldL = normalize( vec3( vec4( L, 0.0 ) * viewMatrix ) );","#ifdef USE_REFLECTION_PROBE","worldL = correctParallax(vWorldPosition, worldL);","#endif","#ifdef USE_FINITE_ENVMAP","worldL = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, worldL, vWorldPosition);","#endif","vec2 dirUV = getEnvMapUV(worldL);","#ifdef USE_REFLECTION_PROBE","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUV, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(reflectionProbe, dirUV).xyz;","#endif","#else","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUV, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(envMap, dirUV).xyz;","#endif","#endif","#ifdef USE_SSLR","    vec4 reflectColor = vec4(0.0);","    if (renderIteration > 0) {","        reflectColor = RayMarch(-vViewPosition, L);","        reflectColor.xyz *= reflectColor.xyz;","    }","    colorIBL = mix(colorIBL, reflectColor.xyz, reflectColor.w);","#endif","float GVis = 0.25 * GeometricSchlick(roughness, NoV, NoL)/max(NoL*NoV,1e-6);","float NoLPDF = 4.0 * NoL * VoH / max(NoH,1e-6);","vec3 F = FresnelSchlick(specColorF0, specColorF90, VoH);","spec += NoLPDF * colorIBL * F * GVis ;","}","}","specularColor = spec/float(nbSamples);","}",j.ShaderChunk.iteration_aniso_pars_fragment,j.ShaderChunk.iteration_sheen_pars_fragment,"#endif"].join("\n");j.ShaderChunk.brdf_pars_fragment=["vec3 FresnelSchlick(vec3 specularColor, float ctheta) {","float Fc = pow(1.0 - ctheta, 5.0);","return Fc + (1.0 - Fc) * specularColor;","}","vec3 FresnelSchlick(in vec3 iF0, in vec3 iF90, in float ctheta) {","float power = pow5(1.0 - ctheta);","return  mix(iF0, iF90, power);","}","vec2 FresnelSchlick(in float ctheta) {","float power = pow5(1. - ctheta);","return vec2((1.0-power),power);","}","float GeometricSchlick(float roughness, float NoV, float NoL) {","float a = roughness * roughness;","float a2 = a * a;","float G1 = sqrt(1.0-a2+a2/max(NoL*NoL,1e-6));","float G2 = sqrt(1.0-a2+a2/max(NoV*NoV,1e-6));","return 2.0 / (G1+G2);","}","float DistributionGGX(float roughness, float NoH) {","float alpha = roughness * roughness;","float alpha2 = alpha * alpha;","float NoH2 = NoH * NoH;","float d = (alpha2 - 1.0) * NoH2 + 1.0;","return alpha2 / (PI * d * d);","}","#ifdef USE_ANISOTROPY","float AnisotropicGeometricSchlick(float roughnessX, in float roughnessY, float NoV, float NoL, in float iAnisotropyAngle) {","float ax = roughnessX * roughnessX;","float ay = roughnessY * roughnessY;","float a2 = pow2(cos(iAnisotropyAngle)*ax) + pow2(sin(iAnisotropyAngle)*ay);","float G1 = sqrt(1.0-a2+a2/max(NoL*NoL,1e-6));","float G2 = sqrt(1.0-a2+a2/max(NoV*NoV,1e-6));","return 2.0 / (G1+G2);","}","float AnisotropicDistributionGGX(vec3 T, vec3 B, vec3 N, vec3 H, float NoH, in float iRoughnessX, in float iRoughnessY, float iAnisotropyAngle) {","vec3 rot_X = cos(2.0 * PI * iAnisotropyAngle) * T + sin(2.0 * PI * iAnisotropyAngle) * B;","vec3 rot_Y = cross(N, rot_X);","float dot_t_h = dot(rot_X, H);","float dot_b_h = dot(rot_Y, H);","float alpha_T = iRoughnessX;","float alpha_B = iRoughnessY;","alpha_T = max(pow2(alpha_T), 1e-3);","alpha_B = max(pow2(alpha_B), 1e-3);","float a = dot_t_h / alpha_T;","float b = dot_b_h / alpha_B;","float D = a * a + b * b + NoH * NoH;","D = PI * alpha_T * alpha_B * D * D;","D = 1.0 / max(D, kEpsilon);","return D;","}","float ComputeAnisotropicRoughness(in vec3 T, in vec3 B, in vec3 N,in vec3 H, in float iRoughness, in float anisotropy, in float anisotropyAngle) {","vec3  rot_X = cos(anisotropyAngle *2. * PI) * T + sin(anisotropyAngle * 2.* PI) * B;","vec3  rot_Y = cross(N, rot_X);","float dot_t_h = dot(rot_X, H); // sin(theta) cos(phi)","float dot_b_h = dot(rot_Y, H); // sin(theta) sin(phi)","float alpha_T = iRoughness;","float alpha_B = iRoughness * (1.0 - anisotropy) ;","alpha_T = max(pow2(alpha_T), kEpsilon);","alpha_B = max(pow2(alpha_B), kEpsilon);","float tmp =  sign(dot_b_h) * sign(dot_t_h);","dot_t_h = max(abs(dot_t_h),0.05) * tmp;","dot_b_h = max(abs(dot_b_h),0.05);","float phi = atan(dot_t_h,dot_b_h);","float a = pow2(cos(phi) / alpha_T);","float b = pow2(sin(phi) / alpha_B);","float a2 = 1.0/ (a+b);","float roughness = saturate(sqrt(sqrt(a2)));","return clamp(roughness, 0.025, 0.975) ;","}","#endif",].join("\n");j.ShaderChunk.emission_pars_fragment=["vec3 doEmission(in float NoV, in vec3 color, in float value) {","vec3 res = vec3(0.0);","#ifndef USE_NORMALIZED_EMISSION","res = color * value;","#else","vec3 aux = vec3(0.2126729,0.7151522,0.0721750);","res = color/max(dot(color,aux),1e-6) * value;","#endif","return res/3.14159;","}",].join("\n");j.ShaderChunk.sheen_pars_fragment=["#ifdef USE_SHEEN","float SheenVisGeometricSchlick(in float NoV, in float NoL) {","float div = 4.0 * max(NoL + NoV - NoL*NoV, 1e-6);","return 1.0 / div;","}","#ifdef USE_ANISOTROPY","float SheenAnisotropicDistribution(in float NoH, in float sheenValue, in vec3 T, in vec3 B, in vec3 N, in vec3 H, in float anisotropyValue, in float anisotropyAngleValue) {","float cosine2 = max(NoH * NoH,kEpsilon);","float sine2 = max(1.0-cosine2,kEpsilon);","float D = 1.0;","float normalisationTerm = 0.31830988618379;","#if defined(USE_VELVET)","float r = ComputeAnisotropicRoughness(T,B,N,H,sqrt(sheenValue), anisotropyValue, anisotropyAngleValue);","float a2 = pow2(r*r);","normalisationTerm *= 1.0/(4.0*a2+1.0);","float sine4 = max(pow2(sine2),kEpsilon);","float cotan2 = cosine2/sine2;","float value = -cotan2 / a2;","D = 1.0+4.0 * exp(value)/ sine4;","#endif // (defined(USE_VELVET) || defined(USE_SILKVELVET))","#if defined(USE_SATIN)","float r = ComputeAnisotropicRoughness(T,B,N,H,0.3, anisotropyValue, anisotropyAngleValue);","float a2 = pow2(r*r);","normalisationTerm *= 1.0/(8.0*a2);","float cosine4 = max(pow2(cosine2),kEpsilon);","float tan2 = sine2/cosine2;","float value = -tan2/( a2*8.0);","D = exp(value) / cosine4 ;","#endif // (defined(USE_SATIN)","return D * normalisationTerm;","}","vec3 sheenModelAniso(in vec3 diffuse, in vec3 diffuseColor, in vec3 sr0Color, in vec3 sr90Color, in vec3 N, in vec3 V, in vec3 L, in float sheenValue, in vec3 T, in vec3 B, in float iAniso, in float iAnisoAngle) {","vec3 H = normalize(L+V);","float NoH = saturate(dot(N,H));","float NoL = saturate(dot(N,L));","float NoV = saturate(dot(N,V));","float fresnel = 1.0 - vMax(max(FresnelSchlick(sr0Color,sr90Color,NoL),FresnelSchlick(sr0Color,sr90Color,NoV)));","vec3 sheenColor = diffuseColor * SheenAnisotropicDistribution(NoH,sheenValue,T,B,N,H, iAniso, iAnisoAngle) * SheenVisGeometricSchlick(NoL,NoV) * fresnel;","return mix(diffuse,sheenColor, 1.0 - pow5(1.0-sheenValue));","}","#else","float SheenDistribution(in float NoH, in float sheenValue) {","float cosine2 = max(NoH * NoH,kEpsilon);","float sine2 = max(1.0-cosine2,kEpsilon);","float D = 1.0;","float normalisationTerm = 0.31830988618379;","#if defined(USE_VELVET)","float a2 = sheenValue * sheenValue;","normalisationTerm *= 1.0/(4.0*a2+1.0);","float sine4 = max(pow2(sine2),kEpsilon);","float cotan2 = cosine2/sine2;","float value = -cotan2 / a2;","D = 1.0+4.0 * exp(value)/ sine4;","#endif // (defined(USE_VELVET) || defined(USE_SILKVELVET))","#if defined(USE_SATIN)","float a2 = 0.0081;","normalisationTerm *= 1.0/(8.0*a2);","float cosine4 = max(pow2(cosine2),kEpsilon);","float tan2 = sine2/cosine2;","float value = -tan2/( a2*8.0);","D = exp(value) / cosine4 ;","#endif // (defined(USE_SATIN)","return D * normalisationTerm;","}","vec3 sheenModel(in vec3 diffuse, in vec3 diffuseColor, in vec3 sr0Color, in vec3 sr90Color, in vec3 N, in vec3 V, in vec3 L,in float sheenValue) {","vec3 H = normalize(L+V);","float NoH = saturate(dot(N,H));","float NoL = saturate(dot(N,L));","float NoV = saturate(dot(N,V));","float fresnel = 1.0 - vMax(max(FresnelSchlick(sr0Color,sr90Color,NoL),FresnelSchlick(sr0Color,sr90Color,NoV)));","vec3 sheenColor = diffuseColor * SheenDistribution(NoH,sheenValue) * SheenVisGeometricSchlick(NoL,NoV) * fresnel;","return mix(diffuse,sheenColor, 1.0 - pow5(1.0-sheenValue));","}","#endif","#endif",].join("\n");j.ShaderChunk.old_flakes_pars_fragment=["#ifdef USE_FLAKES","#define FREQUENCY 0.6","struct flakes {","float roughness;","vec3 F0;","vec3 worldNormal;","vec3 normal;","};","flakes metal;","flakes metalFlakes;","flakes pearlFlakes;","vec3 flakesModel(inout vec3 diffuse, inout vec3 specular, in vec3 V, in vec3 L) {","vec3 H = normalize(L+V);","vec3 total = vec3(0.0);","float NoH = saturate(dot(metalFlakes.normal,H));","float NoV = saturate(dot(metalFlakes.normal,V));","float NoL = saturate(dot(metalFlakes.normal,L));","float VoH = saturate(dot(V,H));","float distrib = DistributionGGX( metalFlakes.roughness, NoH);","float geomVis = 0.25*GeometricSchlick( metalFlakes.roughness, NoV, NoL) / max(abs(NoL * NoV),1e-3);","vec3 fresnel = FresnelSchlick(metalFlakes.F0, vec3(0.0), VoH);","total += distrib * fresnel * geomVis;","NoH = saturate(dot(metal.normal,H));","NoV = saturate(dot(metal.normal,V));","NoL = saturate(dot(metal.normal,L));","distrib = DistributionGGX( metal.roughness, NoH);","geomVis = 0.25*GeometricSchlick( metal.roughness, NoV, NoL) / max(abs(NoL * NoV),1e-3);","fresnel = FresnelSchlick(metal.F0, vec3(0.0), VoH);","float fresnelEnergy = 1.0 - vMax(max(FresnelSchlick(metal.F0, vec3(0.0), NoL),FresnelSchlick(metal.F0, vec3(0.0), NoV)));","diffuse *= fresnelEnergy;","specular *= fresnelEnergy;","total *= fresnelEnergy;","total += distrib * fresnel * geomVis;","#ifdef PEARL_FLAKES_ACTIVATED","NoH = saturate(dot(pearlFlakes.normal,H));","NoV = saturate(dot(pearlFlakes.normal,V));","NoL = saturate(dot(pearlFlakes.normal,L));","distrib = DistributionGGX( pearlFlakes.roughness, NoH);","geomVis = 0.25*GeometricSchlick( pearlFlakes.roughness, NoV, NoL) / max(abs(NoL * NoV),1e-3);","fresnel = FresnelSchlick(pearlFlakes.F0, vec3(0.0), VoH);","fresnelEnergy = 1.0 - vMax(max(FresnelSchlick(pearlFlakes.F0, vec3(0.0), NoL),FresnelSchlick(pearlFlakes.F0, vec3(0.0), NoV)));","diffuse *= fresnelEnergy;","specular *= fresnelEnergy;","total *= fresnelEnergy;","total += distrib * fresnel * geomVis;","#endif","return total;","}","void flakesVisibility(in vec3 currentWorldNormal, out float flakesLODLevel, out float metallicFlakesBlending, out float flakesMask, in float scaling) {","mat3 mat = transposeMatrix(mat3(modelMatrix));","vec3 worldScaling = 1.0/vec3(length(mat[0]),length(mat[1]),length(mat[2]));","vec3 V = cameraPosition - vWorldPosition; ","float dist = length(worldScaling * V);","V = normalize(V);","float NdotV = dot(currentWorldNormal, V); ","float locality = (NdotV > 0.0) ? 1.0 : 0.0;","if (locality == 0.0) {","flakesLODLevel = 0.0;","metallicFlakesBlending = 0.0;","flakesMask = 0.0;","return;","}","float normDist = saturate(scaling * dist * 0.00125);","float shortDist = 1.0 - normDist;","flakesLODLevel = scaling * dist;","#ifdef ADVANCED_FLAKES_BLENDING","metallicFlakesBlending = normDist * (0.5 * flakesDensity + 0.25);","#else","metallicFlakesBlending = normDist * 0.5 ;","#endif","flakesMask = shortDist;","}","void computeMetallicFlakes(out float metallicFlakesPresence, out vec3 metallicFlakesBaseColor,","in float presenceNoise, in float presenceNoise2, in float noisePositive, in float noiseNegative,","in vec3 T, in vec3 B) {","if (length(flakesColorMulCoef) < kEpsilon) {","return;","}","metallicFlakesPresence = pow5(presenceNoise);","float aux = pow5(presenceNoise2);","metallicFlakesPresence += mix( - aux, aux, flakesDensity);","metallicFlakesPresence *= 5.0;","metallicFlakesPresence = saturate(metallicFlakesPresence);","metallicFlakesBaseColor = mix(2.0 * flakesColor, vec3(0.0), affine(noiseNegative, 0.5, 1.0));","float theta = metallicFlakesPresence * noisePositive* PI * 0.125;","float phi =  metallicFlakesPresence * noiseNegative * PI * 0.125;","metalFlakes.worldNormal = Rotate3D(metalFlakes.worldNormal, theta, B);","metalFlakes.worldNormal = Rotate3D(metalFlakes.worldNormal, phi, T);","}","void computePearlFlakes(out float pearlFlakesPresence, out vec3 pearlFlakesBaseColor, ","in float presenceNoise, in float presenceNoise2, in float noisePositive, in float noiseNegative,","in vec3 T, in vec3 B) {","if (length(pearlFlakesColorMulCoef) < kEpsilon) {","return;","}","pearlFlakesPresence = pow3(pow6(presenceNoise2));","float aux = pow3(pow6(presenceNoise));","pearlFlakesPresence += mix( - aux, aux, pearlFlakesDensity);","pearlFlakesPresence *= 6.0;","pearlFlakesPresence = saturate(pearlFlakesPresence);","pearlFlakesBaseColor = mix(2.0 * pearlFlakesColor, vec3(0.0), affine(noisePositive, 0.5, 1.0));","float theta = pearlFlakesPresence * noisePositive * PI * 0.25;","float phi =  pearlFlakesPresence * noiseNegative * PI * 0.25;","pearlFlakes.worldNormal = Rotate3D(pearlFlakes.worldNormal, theta, B);","pearlFlakes.worldNormal = Rotate3D(pearlFlakes.worldNormal, phi, T);","}","void blendMetalFlakes(in vec3 currentWorldNormal, in float flakesMask, in float metallicFlakesBlending, in float metallicFlakesPresence, in vec3 metallicFlakesBaseColor) {","if (length(flakesColorMulCoef) < kEpsilon) {","return;","}","float metallicFlakesStrength = flakesMask * metallicFlakesPresence;","#ifdef FLAKES_NORMAL_PERTURBATION","float metalPerturbateNormal = 0.1 * flakesBump;","#else","float metalPerturbateNormal = 0.0;","#endif","metalFlakes.roughness = 1.0 - mix(0.75,0.55,flakesRoughness);","metal.roughness = metalFlakes.roughness + metalPerturbateNormal;","metal.F0 = flakesColorMulCoef * metallicFlakesBlending * flakesColor;","metalFlakes.F0 = flakesColorMulCoef * metallicFlakesBaseColor * metallicFlakesStrength;","metalPerturbateNormal *= 10.0 * flakesMask;","metalFlakes.worldNormal = normalize(currentWorldNormal + metalPerturbateNormal * metalFlakes.worldNormal);","}","void blendPearlFlakes(in vec3 currentWorldNormal, in float flakesMask, in float pearlFlakesPresence, in vec3 pearlFlakesBaseColor) {","if (length(pearlFlakesColorMulCoef) < kEpsilon) {","return;","}","float pearlFlakesStrength = flakesMask * pearlFlakesPresence;","#ifdef FLAKES_NORMAL_PERTURBATION","float pearlPerturbateNormal = 0.05 * pearlFlakesBump;","#else","float pearlPerturbateNormal = 0.0;","#endif","pearlFlakes.roughness = 0.25;","pearlFlakes.F0 = pearlFlakesColorMulCoef * pearlFlakesBaseColor * pearlFlakesStrength;","pearlPerturbateNormal *= 10.0 * sqrt(flakesMask);","pearlFlakes.worldNormal = normalize(currentWorldNormal + pearlPerturbateNormal * pearlFlakes.worldNormal);","}","void doFlakes(in vec3 currentWorldNormal) { ","float flakesMask = 0.0;","float flakesLODLevel = 0.0;","float scaling = mix(0.0, 0.9, atan(3.14*flakesScale)*2.0/3.14);","vec3 T = getGeomT(currentWorldNormal);","vec3 B = getGeomB(currentWorldNormal, T);","float metallicFlakesBlending = 0.0;","float metallicFlakesPresence = 0.0;","vec3 metallicFlakesBaseColor = vec3(0.0);","metal.roughness = 0.0;","metal.F0 = vec3(0.0);","metal.worldNormal = currentWorldNormal;","metalFlakes.roughness = 0.0;","metalFlakes.F0 = vec3(0.0);","metalFlakes.worldNormal = currentWorldNormal;","float pearlFlakesPresence = 0.0;","vec3 pearlFlakesBaseColor = vec3(0.0);","#ifdef PEARL_FLAKES_ACTIVATED","pearlFlakes.roughness = 0.0;","pearlFlakes.F0 = vec3(0.0);","pearlFlakes.worldNormal = currentWorldNormal;","#endif","flakesVisibility(currentWorldNormal, flakesLODLevel, metallicFlakesBlending, flakesMask, scaling);","if (length(pearlFlakesColorMulCoef) < kEpsilon && length(flakesColorMulCoef) < kEpsilon) {","return;","}","if (flakesMask < kEpsilon) {","blendMetalFlakes(currentWorldNormal, flakesMask, metallicFlakesBlending, metallicFlakesPresence, metallicFlakesBaseColor);","#ifdef PEARL_FLAKES_ACTIVATED","blendPearlFlakes(currentWorldNormal, flakesMask, pearlFlakesPresence, pearlFlakesBaseColor);","#endif","return;","}","vec3 tex = scaling * vObjectSpacePosition;","tex.y = -abs(tex.y);","tex.x = -abs(tex.x);","#ifdef FLAKES_NORMAL_PERTURBATION","float noisePositive = arrayFBMMixer(0.85 * tex, flakesLODLevel, FREQUENCY,1.0,2.0);","float noiseNegative = arrayFBMMixer(0.85 * tex.yxz, flakesLODLevel, FREQUENCY,1.0,2.0);","#else","float noisePositive = 0.0;","float noiseNegative = 0.0;","#endif","float presenceNoise = affine(arrayFBMMixer(tex, flakesLODLevel, FREQUENCY,1.0,3.0), 0.5, 1.0 );","#ifdef ADVANCED_PRESENCE_NOISE","float presenceNoise2 = affine(arrayFBMMixer(tex.yxz, flakesLODLevel, FREQUENCY,1.0,3.0), 0.5, 1.0);","#else","float presenceNoise2 = 0.0;","#endif","computeMetallicFlakes(metallicFlakesPresence, metallicFlakesBaseColor, presenceNoise, presenceNoise2, noisePositive, noiseNegative, T, B);","#ifdef PEARL_FLAKES_ACTIVATED","computePearlFlakes(pearlFlakesPresence,pearlFlakesBaseColor,presenceNoise, presenceNoise2, noisePositive,noiseNegative,T,B);","#endif","blendMetalFlakes(currentWorldNormal, flakesMask, metallicFlakesBlending, metallicFlakesPresence, metallicFlakesBaseColor);","#ifdef PEARL_FLAKES_ACTIVATED","blendPearlFlakes(currentWorldNormal, flakesMask, pearlFlakesPresence, pearlFlakesBaseColor);","#endif","}","#endif"].join("\n");j.ShaderChunk.flakes_pars_fragment=["#ifdef USE_FLAKES","#define MAX_GRID_SIZE 10","#define HALF_MAXF_GRID_SIZE 5.0","#define CONE_ANGLE 0.9925536979","#define CONE_SOLID_ANGLE 0.04678649594","#define BLEND_MIN 1.0","#define BLEND_MAX 32.0","struct flData {","float flakesArea;","vec2 footprintPos;","vec2 footprintDx;","vec2 footprintDy;","float blendDist;","float footprintArea;","float expectedFlakes;","float invDet;","float seedRes;","};","flData flakesData;","vec2 triplanarMapping(in vec3 p, in vec3 n, in float scale) {","vec2 uv;","if (abs(n.x) >= abs(n.y) && abs(n.x) >= abs(n.z)) {","uv = vec2(-p.z,-p.y);","} else if (abs(n.y) >= abs(n.z)) {","uv = vec2( p.x, p.z);","} else {","uv = vec2( p.x,-p.y);","}","return uv * scale;","}","void initFlakesData(in vec3 p, in vec3 N, in float flakesSize, in float flakesCoverage) {","mat3 mat = transposeMatrix(mat3(modelMatrix));","float scale = vMax(vec3(length(mat[0]),length(mat[1]),length(mat[2])));","flakesData.flakesArea = flakesCoverage / pow2(flakesSize);","vec3 x =  dFdx(p);","vec3 y =  dFdy(p);","flakesData.footprintPos = triplanarMapping(p,N,scale);","flakesData.footprintDx = triplanarMapping(x ,N,scale);","flakesData.footprintDy = triplanarMapping(y,N,scale);","flakesData.footprintArea = flakesData.footprintDx.x * flakesData.footprintDy.y - flakesData.footprintDx.y * flakesData.footprintDy.x;","flakesData.expectedFlakes = abs(flakesData.footprintArea) * flakesData.flakesArea;","flakesData.blendDist = smoothstep(BLEND_MIN, BLEND_MAX, flakesData.expectedFlakes);","flakesData.invDet = 1.0 / flakesData.footprintArea;","flakesData.seedRes = max(4.0, vRound(0.5*sqrt(flakesData.flakesArea)));","}","vec4 parallelogramBBox(in vec2 pos,in vec2 dx,in vec2 dy) {","vec2 corner1 = pos;","vec2 corner2 = pos + dx;","vec2 corner3 = pos + dy;","vec2 corner4 = pos + dx + dy;","vec2 minBBox = vec2(vMin(vec4(corner1.x,corner2.x,corner3.x,corner4.x)), vMin(vec4(corner1.y,corner2.y,corner3.y,corner4.y)));","vec2 maxBBox = vec2(vMax(vec4(corner1.x,corner2.x,corner3.x,corner4.x)), vMax(vec4(corner1.y,corner2.y,corner3.y,corner4.y)));","return vec4(minBBox, maxBBox);","}","bool inFootPrint(in vec2 p) {","if (abs(flakesData.footprintArea) < 1e-10) {","return false;","} else {","vec2 pp = p - flakesData.footprintPos;","vec2 uv = flakesData.invDet * vec2(dot(vec2(-pp.y,pp.x),flakesData.footprintDy), dot(vec2(pp.y,-pp.x),flakesData.footprintDx));","return 0.0 <= uv.x && uv.x <= 1.0 && 0.0 <= uv.y && uv.y <= 1.0;","}","}","vec2 rnGenerator(inout int seed) {","int rn = modI(1140671485 * seed + 12820163,16777216);","seed = modI(1140671485 * rn + 12820163,16777216);","return vec2(float(rn) /16777216.0 ,float(seed) / 16777216.0);","}","vec2 generateFlakesPosition(inout int seed) {","return rnGenerator(seed);","}","vec3 generateFlakesReflection(inout int seed, in vec3 V, in float roughness, in vec3 N) {","vec2 uvs = rnGenerator(seed);","vec3 H = TangentToWorldGeom(ImportanceSampleGGX(uvs.xy,roughness), N);","return 2.0 * dot(V,H) * H - V;","}","void generateFlakes(inout int seed, in vec3 V, in vec3 N, in float roughness, out vec2 pos, out vec3 refl) {","pos = generateFlakesPosition(seed);","refl = generateFlakesReflection(seed, V,roughness,N);","}","void reorientParallelogram(in vec2 pos, in vec2 dx, in vec2 dy, out vec2 nPos, out vec2 nDx, out vec2 nDy) {","nPos = vec2(pos);","if ((dy.x * dx.y - dy.y * dx.x) > 0.0) {","nDx = vec2(dy); ","nDy = vec2(dx); ","} else {","nDx = vec2(dx);","nDy = vec2(dy);","}","if (nDy.y < 0.0) {","nPos = nPos + nDy;","vec2 aux = vec2(nDy);","nDy = nDx;","nDx = - aux;","}","if (nDy.y < 0.0) {","nPos = nPos + nDy;","vec2 aux = vec2(nDy);","nDy = nDx;","nDx = - aux;","}","if (nDx.y < 0.0) {","nPos = nPos + nDx;","vec2 aux = vec2(nDx);","nDx = nDy;","nDy = - aux;","}","if (nDx.y < 0.0) {","nPos = nPos + nDx;","vec2 aux = vec2(nDx);","nDx = nDy;","nDy = - aux;","}","}","vec2 rasterizedParallelogramProcess(in vec2 pos, in vec2 dx, in vec2 dy, in vec2 bbMin, in vec2 bbMax, in vec3 V, in vec3 L, in vec3 N, in float roughness) {","int contributing = 0;","int flakesInFootPrint = 0;","float deltaDDx = dx.x / abs(dx.y);","float deltaDDy = dy.x / abs(dy.y);","vec2 sum = dx + dy;","float minX = max(min(pos.x, min(pos.x + dy.x, pos.x + sum.x)),bbMin.x);","float maxX = max(min(pos.x, min(pos.x + dx.x, pos.x + sum.x)),bbMax.x);","float minY = floor(max(bbMin.y, pos.y));","float maxY = ceil(min(bbMax.y, pos.y + sum.y));","float dyLeftBound =  pos.x +				(minY - pos.y			+ (dy.x < 0.0 ? 1.0 : 0.0)) * deltaDDy;","float dxLeftBound =  pos.x + dy.x +		(minY - pos.y - dy.y	+ (dx.x < 0.0 ? 1.0 : 0.0)) * deltaDDx;","float dyRightBound = pos.x + dx.x +		(minY - pos.y - dx.y	+ (dy.x > 0.0 ? 1.0 : 0.0)) * deltaDDy;","float dxRightBound = pos.x +				(minY - pos.y			+ (dx.x > 0.0 ? 1.0 : 0.0)) * deltaDDx;","int i = 0;","int maxI = -1;","int j = int(minY);","int jEnd = int(maxY);","float nodeSize = 1.0 / flakesData.seedRes;","for (int k = 0; k < 150; k++) {","if (i >= maxI) {","float boundaryLeft = max(minX, max(dyLeftBound, dxLeftBound));","i = int(floor(boundaryLeft));","float boundaryRight = min(maxX, min(dyRightBound, dxRightBound));","maxI = int(ceil(boundaryRight));","dyLeftBound += deltaDDy;","dxLeftBound += deltaDDx;","dyRightBound += deltaDDy;","dxRightBound += deltaDDx;","}","float iWrapped = float(i);","float jWrapped = float(j);","int seed = int(length(vec2(iWrapped,jWrapped)* 16892.0));","for (int k = 0; k < 4; k++) {","vec2 fPos;","vec3 fRefl;","generateFlakes(seed,V,N,roughness,fPos,fRefl);","vec2 flakeUV = nodeSize * (vec2(iWrapped, jWrapped) + fPos);","if (inFootPrint(flakeUV)) {","flakesInFootPrint++;","if (dot(fRefl,L) > CONE_ANGLE) {","contributing++;","}","}","}","i++;","if (i >= maxI) {","j++;","}","if (j >= jEnd) {","break;","}","}","return vec2(float(contributing), float(flakesInFootPrint));","}","vec2 contributingFlakes(in vec3 V, in vec3 L, in vec3 N, in float roughness) {","vec4 bbox = parallelogramBBox(flakesData.footprintPos, flakesData.footprintDx, flakesData.footprintDy);","vec2 gridMin = floor(flakesData.seedRes * bbox.xy);","vec2 gridMax = ceil(flakesData.seedRes * bbox.zw);","vec2 footPrintCenter = flakesData.seedRes * (flakesData.footprintPos + 0.5 * (flakesData.footprintDx + flakesData.footprintDy));","gridMin = clamp(gridMin, footPrintCenter - HALF_MAXF_GRID_SIZE, footPrintCenter + HALF_MAXF_GRID_SIZE);","gridMax = clamp(gridMax, footPrintCenter - HALF_MAXF_GRID_SIZE, footPrintCenter + HALF_MAXF_GRID_SIZE);","vec2 pos = flakesData.footprintPos * flakesData.seedRes;","vec2 dx = flakesData.footprintDx * flakesData.seedRes;","vec2 dy = flakesData.footprintDy * flakesData.seedRes;","vec2 nPos;","vec2 nDx;","vec2 nDy;","reorientParallelogram(pos, dx, dy, nPos, nDx, nDy);","return rasterizedParallelogramProcess(nPos, nDx, nDy, gridMin, gridMax, V, L, N, roughness);","}","float stochasticFlakesBRDF(in vec3 V, in vec3 L, in vec3 N, in float roughness, in float VoH, in float NoL, in float NoV) {","vec2 c = contributingFlakes(V,L,N,roughness);","float refFlakesCount = max(flakesData.expectedFlakes, c.y);","float d = c.x / (refFlakesCount * CONE_SOLID_ANGLE);","float g = GeometricSchlick(roughness, NoL,NoV );","return VoH * g * d / max(NoL*NoV,1e-6);","}","vec3 flakesLightEquation(inout vec3 diffuse, inout vec3 specular, in vec3 V, in vec3 L, in vec3 N, in float roughness, in vec3 color, in float coverage) {","vec3 H = normalize(V+L);","float VoH = dot(V,H);","float NoL = saturate(dot(N,L));","float NoV = saturate(dot(N,V));","float NoH = saturate(dot(N,H));","float res = flakesData.blendDist * SpecularBRDF(roughness,NoV,NoL,NoH);","if (flakesData.blendDist < 1.0 - 1e-3) {","res += (1.0 - flakesData.blendDist) * stochasticFlakesBRDF(V,L,N,roughness,VoH,NoL,NoV);","}","diffuse *= (1.0 - coverage);","specular *= (1.0 - coverage);","return coverage * color * res;","}","#endif",].join("\n");j.ShaderChunk.coating_pars_fragment=["#ifdef CLEAR_COAT","#define COATINGF0 vec3(0.04)","#define COATINGF90 vec3(1.0)","vec3 clearCoatModel(inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L, in float r, in float clStrength) {","vec3 H = normalize(L+V);","float NoH = saturate(dot(N,H));","float NoV = saturate(dot(N,V));","float NoL = saturate(dot(N,L));","float VoH = saturate(dot(V,H));","float distrib = DistributionGGX( r, NoH);","float geomVis = 0.25*GeometricSchlick( r, NoV, NoL) / max(abs(NoL * NoV),1e-3);","vec3 fresnel = clStrength * FresnelSchlick(COATINGF0, COATINGF90, VoH);","float fresnelEnergy = clStrength * vMax(max(FresnelSchlick(COATINGF0, COATINGF90, NoL),FresnelSchlick(COATINGF0, COATINGF90, NoV)));","diffuse *= 1.0 - fresnelEnergy;","specular *= 1.0 - fresnelEnergy;","return distrib * fresnel * geomVis;","}","#ifdef CLEAR_COAT_NORMALMAP","vec3 perturbNormal3ArbCoat( vec3 surf_norm, vec3 surf_tgt, vec3 surf_binorm, vec2 uv ) {","vec3 N = normalize(surf_norm);","vec3 T = normalize(surf_tgt);","T = normalize(T - dot(T, N) * N);","vec3 B = normalize(surf_binorm);","vec3 mapN = texture2D( clearCoatNormalMap, uv ).xyz * 2.0 - 1.0;","#ifdef CLEAR_COAT_NORMALMAPFLIPY","mapN.y = - mapN.y;","#endif","mapN.xy = clearCoatNormalScale * mapN.xy;","mat3 tbn = mat3(T, B, N);","return normalize(tbn * mapN);","}","#endif","#ifdef USE_ORANGE_PEEL","void orangePeelVisibility(in vec3 currentWorldNormal, out float peelMask, in float scaling) {","mat3 mat = transposeMatrix(mat3(modelMatrix));","vec3 worldScaling = 1.0/vec3(length(mat[0]),length(mat[1]),length(mat[2]));","vec3 V = cameraPosition - vWorldPosition;","float dist = length(worldScaling * V);","V = normalize(V);","float NdotV = dot(currentWorldNormal, V);","float locality = (NdotV > 0.0) ? 1.0 : 0.0;","if (locality == 0.0) {","peelMask = 0.0;","return;","}","float normDist = saturate(scaling * dist * 0.00125);","float shortDist = saturate(1.0 - normDist);","peelMask = shortDist;","}","void doOrangePeel(inout vec3 orangePeelWorldNormal) {","float peelMask = 0.0;","float peelScaling = 0.01/max(orangePeelScale,1e-3);","orangePeelVisibility(orangePeelWorldNormal, peelMask,peelScaling);","if (clearCoatNormalScale < kEpsilon || peelMask < kEpsilon) {","return;","}","vec3 tex = peelScaling * vObjectSpacePosition;","tex.y = -abs(tex.y);","tex.x = -abs(tex.x);","float noise = FBM(tex);","vec3 peelNormal = vec3(noise);","orangePeelWorldNormal = normalize(orangePeelWorldNormal + 0.05 *clearCoatNormalScale *peelMask* peelNormal);","}","#endif","#endif"].join("\n");j.ShaderChunk.sss_pars_fragment=["#ifdef USE_SUBSURFACE","#define MINR 2.0","#define MAXR 16.0","#define MAXC 1.0/MINR","#define MINC 1.0/MAXR","vec3 getSkinSSSLUT(in float NdotL, in float curvature) {","float curva = toTexCoord(1.0/curvature,MINR,MAXR); ","float oneMinusCurva = 1.0 - curva;","vec3 curve0;","{","vec3 rangeMin = vec3(0.0, 0.3, 0.3);","vec3 rangeMax = vec3(1.0, 0.7, 0.7);","vec3 offset = vec3(0.0, 0.06, 0.06);","vec3 t = saturate( fma(vec3(NdotL), 1.0 / (rangeMax - rangeMin), (offset + rangeMin) / (rangeMin - rangeMax)  ) );","vec3 lowerLine = (t * t) * vec3(0.65, 0.5, 0.9);","lowerLine.r += 0.045;","lowerLine.b *= t.b;","vec3 m = vec3(1.75, 2.0, 1.97);","vec3 upperLine = fma(vec3(NdotL), m, vec3(0.99, 0.99, 0.99) -m );","upperLine = saturate(upperLine);","vec3 lerpMin = vec3(0.0, 0.35, 0.35);","vec3 lerpMax = vec3(1.0, 0.7 , 0.6 );","vec3 lerpT = saturate( fma(vec3(NdotL), 1.0/(lerpMax-lerpMin), lerpMin/ (lerpMin - lerpMax) ));","curve0 = mix(lowerLine, upperLine, lerpT * lerpT);","}","vec3 curve1;","{","vec3 m = vec3(1.95, 2.0, 2.0);","vec3 upperLine = fma( vec3(NdotL), m, vec3(0.99, 0.99, 1.0) - m);","curve1 = saturate(upperLine);","}","float oneMinusCurva2 = oneMinusCurva * oneMinusCurva;","vec3 brdf = mix(curve0, curve1, fma(oneMinusCurva2, -1.0 * oneMinusCurva2, 1.0));","return saturate(brdf);","}","vec3 getScattering(in float NoL, in float c) {","mat3 mat = transposeMatrix(mat3(modelMatrix));","vec3 worldScaling = 1.0/vec3(length(mat[0]),length(mat[1]),length(mat[2]));","float cNoL = affine(NoL,0.5,1.0);","#ifdef USE_SSSLUT","float cC = toTexCoord(c,MINC,MAXC);","vec2 coord = vec2(cNoL,1.0-cC);","return texture2D(sssLUT,coord).rgb;","#else","return getSkinSSSLUT(cNoL,c);","#endif","}","vec3 SssLUTSampling(in float c) {","#ifdef USE_SSSIBLLUT","float cC = toTexCoord(ceil(c),MINC,MAXC);","vec2 coord = vec2(0.5,cC);","return texture2D(sssIBLLUT,coord).rgb;","#else","float fNumSamples = 32.0;","vec3 res = vec3(0.0);","for (float i = 0.0; i <= 32.0; i++) {","float theta = i * PI/ fNumSamples;","float NoL = cos(theta);","res += getScattering(NoL, c) * sin(theta);","}","float aux = 2.0*pow2(PI)/(fNumSamples+1.0) * zeroSphericalHarmonics();","return res * aux;","#endif","}","#endif // USE_SUBSURFACE","#if defined(USE_TRANSLUCENCY) && defined(USE_SHADOWMAP)","#define TRANSLUCENCY","#endif","#ifdef TRANSLUCENCY","#define MAX_Depth 16.0","#define MIN_Depth 0.5","vec3 translucencyValue(in float s) {","#ifdef USE_TRANSLUCENCYLUT","vec2 coord = vec2(toTexCoord(s,MIN_Depth,MAX_Depth),0.5);","return texture2D(translucencyLUT, coord).rgb;","#else // translucencyLUTEnabled - // to use when there is no texture","float coord = clamp(s,MIN_Depth,MAX_Depth);","vec3 res = vec3(0.0);","float s2 = -pow2(coord);","res += vec3(0.233,0.455,0.649) * exp(s2 / 0.0064);","res += vec3(0.1,0.336,0.344) * exp(s2 / 0.0484);","res += vec3(0.118,0.198,0.0) * exp(s2 / 0.187);","res += vec3(0.113,0.007,0.007) * exp(s2 / 0.567);","res += vec3(0.358,0.004,0.0) * exp(s2 / 1.99);","res += vec3(0.078,0.0,0.0) * exp(s2 / 7.41);","return res;","#endif // translucencyLUTEnabled","}","#define TRANS_PERFMODE 2","#if TRANS_PERFMODE == 0","#define TRANS_SAMPLE 64","#define TRANS_POISSON_DISK(i)  poisson64[i]","vec2 poisson64[64];","void initDisk() {","poisson64[0] = vec2(-0.934812, 0.366741);","poisson64[1] = vec2(-0.918943, -0.0941496);","poisson64[2] = vec2(-0.873226, 0.62389);","poisson64[3] = vec2(-0.8352, 0.937803);","poisson64[4] = vec2(-0.822138, -0.281655);","poisson64[5] = vec2(-0.812983, 0.10416);","poisson64[6] = vec2(-0.786126, -0.767632);","poisson64[7] = vec2(-0.739494, -0.535813);","poisson64[8] = vec2(-0.681692, 0.284707);","poisson64[9] = vec2(-0.61742, -0.234535);","poisson64[10] = vec2(-0.601184, 0.562426);","poisson64[11] = vec2(-0.607105, 0.847591);","poisson64[12] = vec2(-0.581835, -0.00485244);","poisson64[13] = vec2(-0.554247, -0.771111);","poisson64[14] = vec2(-0.483383, -0.976928);","poisson64[15] = vec2(-0.476669, -0.395672);","poisson64[16] = vec2(-0.439802, 0.362407);","poisson64[17] = vec2(-0.409772, -0.175695);","poisson64[18] = vec2(-0.367534, 0.102451);","poisson64[19] = vec2(-0.35313, 0.58153);","poisson64[20] = vec2(-0.341594, -0.737541);","poisson64[21] = vec2(-0.275979, 0.981567);","poisson64[22] = vec2(-0.230811, 0.305094);","poisson64[23] = vec2(-0.221656, 0.751152);","poisson64[24] = vec2(-0.214393, -0.0592364);","poisson64[25] = vec2(-0.204932, -0.483566);","poisson64[26] = vec2(-0.183569, -0.266274);","poisson64[27] = vec2(-0.123936, -0.754448);","poisson64[28] = vec2(-0.0859096, 0.118625);","poisson64[29] = vec2(-0.0610675, 0.460555);","poisson64[30] = vec2(-0.0234687, -0.962523);","poisson64[31] = vec2(-0.00485244, -0.373394);","poisson64[32] = vec2(0.0213324, 0.760247);","poisson64[33] = vec2(0.0359813, -0.0834071);","poisson64[34] = vec2(0.0877407, -0.730766);","poisson64[35] = vec2(0.14597, 0.281045);","poisson64[36] = vec2(0.18186, -0.529649);","poisson64[37] = vec2(0.188208, -0.289529);","poisson64[38] = vec2(0.212928, 0.063509);","poisson64[39] = vec2(0.23661, 0.566027);","poisson64[40] = vec2(0.266579, 0.867061);","poisson64[41] = vec2(0.320597, -0.883358);","poisson64[42] = vec2(0.353557, 0.322733);","poisson64[43] = vec2(0.404157, -0.651479);","poisson64[44] = vec2(0.410443, -0.413068);","poisson64[45] = vec2(0.413556, 0.123325);","poisson64[46] = vec2(0.46556, -0.176183);","poisson64[47] = vec2(0.49266, 0.55388);","poisson64[48] = vec2(0.506333, 0.876888);","poisson64[49] = vec2(0.535875, -0.885556);","poisson64[50] = vec2(0.615894, 0.0703452);","poisson64[51] = vec2(0.637135, -0.637623);","poisson64[52] = vec2(0.677236, -0.174291);","poisson64[53] = vec2(0.67626, 0.7116);","poisson64[54] = vec2(0.686331, -0.389935);","poisson64[55] = vec2(0.691031, 0.330729);","poisson64[56] = vec2(0.715629, 0.999939);","poisson64[57] = vec2(0.8493, -0.0485549);","poisson64[58] = vec2(0.863582, -0.85229);","poisson64[59] = vec2(0.890622, 0.850581);","poisson64[60] = vec2(0.898068, 0.633778);","poisson64[61] = vec2(0.92053, -0.355693);","poisson64[62] = vec2(0.933348, -0.62981);","poisson64[63] = vec2(0.95294, 0.156896);","}","#elif TRANS_PERFMODE == 1","#define TRANS_SAMPLE 32","#define TRANS_POISSON_DISK(i)  poisson32[i]","vec2 poisson32[TRANS_SAMPLE];","void initDisk() {","poisson32[0] = vec2(-0.975402, -0.0711386);","poisson32[1] = vec2(-0.920347, -0.41142);","poisson32[2] = vec2(-0.883908, 0.217872);","poisson32[3] = vec2(-0.884518, 0.568041);","poisson32[4] = vec2(-0.811945, 0.90521);","poisson32[5] = vec2(-0.792474, -0.779962);","poisson32[6] = vec2(-0.614856, 0.386578);","poisson32[7] = vec2(-0.580859, -0.208777);","poisson32[8] = vec2(-0.53795, 0.716666);","poisson32[9] = vec2(-0.515427, 0.0899991);","poisson32[10] = vec2(-0.454634, -0.707938);","poisson32[11] = vec2(-0.420942, 0.991272);","poisson32[12] = vec2(-0.261147, 0.588488);","poisson32[13] = vec2(-0.211219, 0.114841);","poisson32[14] = vec2(-0.146336, -0.259194);","poisson32[15] = vec2(-0.139439, -0.888668);","poisson32[16] = vec2(0.0116886, 0.326395);","poisson32[17] = vec2(0.0380566, 0.625477);","poisson32[18] = vec2(0.0625935, -0.50853);","poisson32[19] = vec2(0.125584, 0.0469069);","poisson32[20] = vec2(0.169469, -0.997253);","poisson32[21] = vec2(0.320597, 0.291055);","poisson32[22] = vec2(0.359172, -0.633717);","poisson32[23] = vec2(0.435713, -0.250832);","poisson32[24] = vec2(0.507797, -0.916562);","poisson32[25] = vec2(0.545763, 0.730216);","poisson32[26] = vec2(0.56859, 0.11655);","poisson32[27] = vec2(0.743156, -0.505173);","poisson32[28] = vec2(0.736442, -0.189734);","poisson32[29] = vec2(0.843562, 0.357036);","poisson32[30] = vec2(0.865413, 0.763726);","poisson32[31] = vec2(0.872005, -0.927);","}","#else","#define TRANS_SAMPLE 25","#define TRANS_POISSON_DISK(i)  poisson25[i]","vec2 poisson25[TRANS_SAMPLE];","void initDisk() {","poisson25[0] = vec2(-0.978698, -0.0884121);","poisson25[1] = vec2(-0.841121, 0.521165);","poisson25[2] = vec2(-0.71746, -0.50322);","poisson25[3] = vec2(-0.702933, 0.903134);","poisson25[4] = vec2(-0.663198, 0.15482);","poisson25[5] = vec2(-0.495102, -0.232887);","poisson25[6] = vec2(-0.364238, -0.961791);","poisson25[7] = vec2(-0.345866, -0.564379);","poisson25[8] = vec2(-0.325663, 0.64037);","poisson25[9] = vec2(-0.182714, 0.321329);","poisson25[10] = vec2(-0.142613, -0.0227363);","poisson25[11] = vec2(-0.0564287, -0.36729);","poisson25[12] = vec2(-0.0185858, 0.918882);","poisson25[13] = vec2(0.0381787, -0.728996);","poisson25[14] = vec2(0.16599, 0.093112);","poisson25[15] = vec2(0.253639, 0.719535);","poisson25[16] = vec2(0.369549, -0.655019);","poisson25[17] = vec2(0.423627, 0.429975);","poisson25[18] = vec2(0.530747, -0.364971);","poisson25[19] = vec2(0.566027, -0.940489);","poisson25[20] = vec2(0.639332, 0.0284127);","poisson25[21] = vec2(0.652089, 0.669668);","poisson25[22] = vec2(0.773797, 0.345012);","poisson25[23] = vec2(0.968871, 0.840449);","poisson25[24] = vec2(0.991882, -0.657338);","}","#endif // TRANS_PERFMODE","vec3 getShadowCoord(in int lightID) {","for (int i = 0; i < MAX_SHADOWS; i++) {","if (i == lightID) {","return vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;","}","}","}","vec2 getLightNearFar(in int lightID) {","for (int i = 0; i < MAX_SHADOWS; i++) {","if (i == lightID) {","return vec2(directionalLightNear[i], directionalLightFar[i]);","}","}","}","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","#define ONEOVER80 0.0125","#endif","float getDepthValue(in int lightID, in vec2 coord) {","for (int i = 0; i < MAX_SHADOWS; i++) {","if (i == lightID) {","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","gl_FragData[ 0 ].x = exp(80.0*gl_FragCoord.z);","return ONEOVER80*log(texture2D(shadowMap[i], coord).x);","#else","return unpackDepth(texture2D(shadowMap[i], coord) );","#endif","}","}","}","vec2 getMultiplier(in int lightID) {","for (int i = 0; i < MAX_SHADOWS; i++) {","if (i == lightID) {","return saturate(vec2(1.5 / shadowMapSize[i]));","}","}","}","float _clipToEye(in float iNearPlane, in float iFarPlane, in float iZClipSpace)","{","return (2.0 * iNearPlane * iFarPlane) / (iFarPlane + iNearPlane - iZClipSpace * (iFarPlane - iNearPlane));","}","float _clipToEyeOrtho(in float iNearPlane, in float iFarPlane, in float iZClipSpace)","{","return 0.5 * ((iFarPlane - iNearPlane) * iZClipSpace + iFarPlane + iNearPlane);","}","float clipToEye(in float z, in int iLayer)","{","vec2 lightInfo = getLightNearFar(iLayer);","return _clipToEyeOrtho(lightInfo.x, lightInfo.y, z);","}","vec3 multiSampleTranslucency(in int lightID) {","mat3 mat = transposeMatrix(mat3(modelMatrix));","vec3 worldScaling = 1.0/vec3(length(mat[0]),length(mat[1]),length(mat[2]));","vec3 depthMapCoord = getShadowCoord(lightID);","vec2 currentCoord;","float currentDepth = clipToEye(2.0*depthMapCoord.z-1.0,lightID);","vec3 res = vec3(0.0);","vec2 multiplier = getMultiplier(lightID);","for (int i = 0; i < TRANS_SAMPLE; i++) {","vec2 offset =  multiplier* TRANS_POISSON_DISK(i);","currentCoord.xy = saturate(depthMapCoord.xy + offset);","float depth = 2.0*getDepthValue(lightID,currentCoord.xy)-1.0;","float s = max( currentDepth - clipToEye(depth,lightID),0.0);","res += translucencyValue(worldScaling[0] * translucencyScale*s);","}","return res/float(TRANS_SAMPLE);","}","vec3 translucencyBRDF(in vec3 N, in vec3 L, in int iLightIndex, in vec3 V, in vec3 diffuseColor,  in vec3 sr0Color, in vec3 sr90Color) {","vec3 Lt = L - 2.0 * dot(L,N) * N;","float mcdirNoL = saturate(dot(N, Lt)+0.3);","vec3 attenuation = multiSampleTranslucency(iLightIndex);","vec3 Ht = normalize(Lt+V);","vec3 fTrans = FresnelSchlick(sr0Color,sr90Color,saturate(dot(Ht,V)));","return mcdirNoL * attenuation * diffuseColor * (1.0 - fTrans) * INV_PI;","}","#endif // Translucency",].join("\n");j.ShaderChunk.lights_rendering_equation_fragment=["vec3 DiffuseLambertBRDF(vec3 diffuseColor) {","return (diffuseColor * INV_PI);","}","#ifdef USE_ANISOTROPY","float TransmissionAnisoBRDF(in float roughnessX, in float roughnessY, in float NoV, in float NoL, in float NoH, in float VoH, in float LoH, in vec3 iNormal, in vec3 H, in vec3 iTangent, in vec3 iBinormal, in float iAnisotropyAngle) {","float ior2 = ior * ior;","float coeff = abs(LoH * VoH) / max(abs(NoL*NoV),1e-3);","coeff *= ior2;","coeff /= ior * LoH + ior2 *VoH*VoH;","float distrib = AnisotropicDistributionGGX(iTangent, iBinormal, iNormal, H, NoH, roughnessX, roughnessY, iAnisotropyAngle);","float geomVis = GeometricSchlick( roughnessX, NoV, NoL);","return coeff*distrib*geomVis;","}","float SpecularAnisoBRDF(in float roughnessX, in float roughnessY, in float NoV, in float NoL, in float NoH, in vec3 iNormal, in vec3 H, in vec3 iTangent, in vec3 iBinormal, in float iAnisotropyAngle) {","float distrib = AnisotropicDistributionGGX(iTangent, iBinormal, iNormal, H, NoH, roughnessX, roughnessY, iAnisotropyAngle);","float geomVis = 0.25 * GeometricSchlick( roughnessX, NoV, NoL)/ max(NoL * NoV,1e-3);","return distrib*geomVis;","}","void coreModelAniso(inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L, in vec3 T, in vec3 B, in float iAnisotropy, in float iAnisotropyAngle, in float r,in vec3 diffuseColor, in vec3 sr0Color, in vec3 sr90Color) {","float NoL = saturate(dot(N,L));","float NoV = saturate(dot(N,V));","vec3 H = normalize(L+V);","float NoH = saturate(dot(N,H));","float VoH = saturate(dot(V,H));","float rX = r;","float rY = r * (1.0 - iAnisotropy);","diffuse = DiffuseLambertBRDF(diffuseColor) * (1.0 - vMax(max(FresnelSchlick(sr0Color,sr90Color,NoV), FresnelSchlick(sr0Color,sr90Color,NoL))));","specular = SpecularAnisoBRDF(rX, rY, NoV, NoL, NoH,N,H,T,B, iAnisotropyAngle)*FresnelSchlick(sr0Color, sr90Color, VoH);","}","#else","float SpecularBRDF(in float roughness, in float NoV, in float NoL, in float NoH) {","float distrib = DistributionGGX( roughness, NoH);","float geomVis = 0.25*GeometricSchlick( roughness, NoV, NoL)/max(NoL*NoV,1e-3);","return distrib*geomVis;","}","float TransmissionBRDF(in float roughness, in float NoV, in float NoL, in float NoH, in float VoH, in float LoH) {","float ior2 = ior * ior;","float coeff = abs(LoH * VoH) / max(abs(NoL*NoV),1e-3);","coeff *= ior2;","coeff /= ior * LoH + ior2 *VoH*VoH;","float distrib = DistributionGGX( roughness, NoH);","float geomVis = GeometricSchlick( roughness, NoV, NoL);","return coeff*distrib*geomVis;","}","void coreModel(inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L, in float r,in vec3 diffuseColor, in vec3 sr0Color, in vec3 sr90Color) {","float NoL = saturate(dot(N,L));","float NoV = saturate(dot(N,V));","vec3 H = normalize(L+V);","float NoH = saturate(dot(N,H));","float VoH = saturate(dot(V,H));","diffuse = DiffuseLambertBRDF(diffuseColor) * (1.0 - vMax(max(FresnelSchlick(sr0Color,sr90Color,NoV), FresnelSchlick(sr0Color,sr90Color,NoL))));","specular = SpecularBRDF(r, NoV, NoL, NoH) *FresnelSchlick(sr0Color, sr90Color, VoH);","}","#endif",j.ShaderChunk.sheen_pars_fragment,"#ifdef OLD_FLAKES",j.ShaderChunk.old_flakes_pars_fragment,"#else",j.ShaderChunk.flakes_pars_fragment,"#endif",j.ShaderChunk.coating_pars_fragment,j.ShaderChunk.sss_pars_fragment,].join("\n");j.ShaderChunk.light_model_pars_fragment=["void _doCommonLightingModel(inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L) {","#ifdef USE_ANISOTROPY","coreModelAniso(diffuse,specular, N,V,L, materialData.tangent, materialData.binormal, materialData.anisotropy, materialData.anisotropyAngle,materialData.roughness,materialData.diffuseColor,materialData.sr0Color,materialData.sr90Color);","#ifdef USE_SHEEN","diffuse = sheenModelAniso(diffuse,materialData.diffuseColor,materialData.sr0Color,materialData.sr90Color, N, V, L,materialData.sheen, materialData.tangent, materialData.binormal, materialData.anisotropy, materialData.anisotropyAngle);","#endif","#else","coreModel(diffuse,specular, N,V,L,materialData.roughness,materialData.diffuseColor,materialData.sr0Color,materialData.sr90Color);","#ifdef USE_SHEEN","diffuse = sheenModel(diffuse,materialData.diffuseColor,materialData.sr0Color,materialData.sr90Color, N, V, L, materialData.sheen);","#endif","#endif","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","specular += flakesModel(diffuse,specular, V,L);","#else","specular += flakesLightEquation(diffuse,specular,V,L,N,materialData.flakesRoughness,materialData.flakesColor, materialData.flakesCoverage);","#endif","#endif","#ifdef CLEAR_COAT","specular += clearCoatModel(diffuse,specular, materialData.clearCoatNormal, V, L,materialData.clearCoatR, materialData.clearCoat);","#endif","}","void doLightingModel(in vec3 E, inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L) {","_doCommonLightingModel(diffuse,specular,N,V,L);","vec3 ENoL = E * saturate(dot(N, L));","#ifdef USE_SUBSURFACE","float sssNoL = dot(N, L);","diffuse *= E * getScattering(sssNoL, materialData.curvature);","#else","diffuse *= ENoL;","#endif","specular *= ENoL;","}","void doAreaLightingModel(in vec3 E, inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L) {","_doCommonLightingModel(diffuse,specular,N,V,L);","specular *= E;","diffuse *= E;","}",].join("\n");j.ShaderChunk.lights_utility_pars_fragment=["#ifdef HAS_AREA_LIGHTS","struct areaLightingData","{","mat3 Minv;","vec2 fresnel;","#ifdef CLEAR_COAT","mat3 MinvCC;","vec2 fresnelCC;","#endif","#ifdef USE_SHEEN","mat3 MinvSheen;","#endif","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","mat3 MinvMetal;","vec2 fresnelMetal;","mat3 MinvMetalFlakes;","vec2 fresnelMetalFlakes;","#ifdef PEARL_FLAKES_ACTIVATED","mat3 MinvPearlFlakes;","vec2 fresnelPearlFlakes;","#endif","#else","mat3 MinvMetal;","vec2 fresnelMetal;","#endif","#endif","};","areaLightingData areaData;","#define LUT_SIZE 64.0","#define LUT_SCALE (LUT_SIZE - 1.0)/LUT_SIZE","#define LUT_BIAS 0.5/LUT_SIZE","#ifdef USE_SHEEN","void setAreaSheenData(in float roughness, in float NoV, out mat3 Minv) {","vec2 uvAr = vec2(roughness, 1.0 - sqrt(1.0 - NoV)) * LUT_SCALE + LUT_BIAS;","vec4 t1 = texture2D(precomputedAreaSheentexture, uvAr);","Minv = mat3(","vec3(t1.x,  0, t1.y),","vec3(  0, 1.0,   0),","vec3(t1.z,  0, t1.w)",");","}","#endif","void setAreaGGXData(in float roughness, in float NoV, out vec2 fresnel, out mat3 Minv) {","vec2 uvAr = vec2(roughness, 1.0 - sqrt(1.0 - NoV)) * LUT_SCALE + LUT_BIAS;","vec4 t1 = texture2D(precomputedAreaGGX1texture, uvAr);","vec4 t2 = texture2D(precomputedAreaGGX2texture, uvAr);","Minv = mat3(","vec3(t1.x,  0, t1.y),","vec3(  0, 1.0,   0),","vec3(t1.z,  0, t1.w)",");","fresnel = vec2(t2.z,t2.y);","}","float IntegrateEdge(in vec3 v1, in vec3 v2)","{","float x = dot(v1, v2);","float y = abs(x);","float a = 0.8543985 + (0.4965155 + 0.0145206*y)*y;","float b = 3.4175940 + (4.1616724 + y)*y;","float v = a / b;","float theta_sintheta = (x > 0.0) ? v : 0.5*inversesqrt(1.0 - x*x) - v;","return (cross(v1, v2)*theta_sintheta).z;","}","void ClipQuad(inout vec3 L[5], out int n)","{","int config = 0;","if (L[0].z > 0.0) config += 1;","if (L[1].z > 0.0) config += 2;","if (L[2].z > 0.0) config += 4;","if (L[3].z > 0.0) config += 8;","n = 0;","if (config == 0)","{","}","else if (config == 1)","{","n = 3;","L[1] = -L[1].z * L[0] + L[0].z * L[1];","L[2] = -L[3].z * L[0] + L[0].z * L[3];","}","else if (config == 2)","{","n = 3;","L[0] = -L[0].z * L[1] + L[1].z * L[0];","L[2] = -L[2].z * L[1] + L[1].z * L[2];","}","else if (config == 3)","{","n = 4;","L[2] = -L[2].z * L[1] + L[1].z * L[2];","L[3] = -L[3].z * L[0] + L[0].z * L[3];","}","else if (config == 4)","{","n = 3;","L[0] = -L[3].z * L[2] + L[2].z * L[3];","L[1] = -L[1].z * L[2] + L[2].z * L[1];","}","else if (config == 5)","{","n = 0;","}","else if (config == 6)","{","n = 4;","L[0] = -L[0].z * L[1] + L[1].z * L[0];","L[3] = -L[3].z * L[2] + L[2].z * L[3];","}","else if (config == 7)","{","n = 5;","L[4] = -L[3].z * L[0] + L[0].z * L[3];","L[3] = -L[3].z * L[2] + L[2].z * L[3];","}","else if (config == 8)","{","n = 3;","L[0] = -L[0].z * L[3] + L[3].z * L[0];","L[1] = -L[2].z * L[3] + L[3].z * L[2];","L[2] =  L[3];","}","else if (config == 9)","{","n = 4;","L[1] = -L[1].z * L[0] + L[0].z * L[1];","L[2] = -L[2].z * L[3] + L[3].z * L[2];","}","else if (config == 10)","{","n = 0;","}","else if (config == 11)","{","n = 5;","L[4] = L[3];","L[3] = -L[2].z * L[3] + L[3].z * L[2];","L[2] = -L[2].z * L[1] + L[1].z * L[2];","}","else if (config == 12)","{","n = 4;","L[1] = -L[1].z * L[2] + L[2].z * L[1];","L[0] = -L[0].z * L[3] + L[3].z * L[0];","}","else if (config == 13) ","{","n = 5;","L[4] = L[3];","L[3] = L[2];","L[2] = -L[1].z * L[2] + L[2].z * L[1];","L[1] = -L[1].z * L[0] + L[0].z * L[1];","}","else if (config == 14)","{","n = 5;","L[4] = -L[0].z * L[3] + L[3].z * L[0];","L[0] = -L[0].z * L[1] + L[1].z * L[0];","}","else if (config == 15)","{","n = 4;","}","if (n == 3)","L[3] = L[0];","if (n == 4)","L[4] = L[0];","}","float areaRectangleLight(in vec3 N, in vec3 V, in vec3 P,in mat3 Minv, in vec3 p0, in vec3 p1, in vec3 p2, in vec3 p3) {","vec3 T = normalize(V-N*dot(V,N));","vec3 B = cross(N,T);","mat3 M = Minv*transposeMatrix(mat3(T,B,N));","float res = 0.0;","vec3 L[5];","L[0] = M * (p0 - P);","L[1] = M * (p1 - P);","L[2] = M * (p2 - P);","L[3] = M * (p3 - P);","int config = 0;","ClipQuad(L,config);","if (config == 0) {","return 0.0;","}","L[0] = normalize(L[0]);","L[1] = normalize(L[1]);","L[2] = normalize(L[2]);","L[3] = normalize(L[3]);","L[4] = normalize(L[4]);","res += IntegrateEdge(L[0], L[1]);","res += IntegrateEdge(L[1], L[2]);","res += IntegrateEdge(L[2], L[3]);","if (config >= 4)","res += IntegrateEdge(L[3], L[4]);","if (config == 5)","res += IntegrateEdge(L[4], L[0]);","return max(0.0,res);","}","vec3 SolveCubic(vec4 Coefficient) {","Coefficient.xyz /= Coefficient.w;","Coefficient.yz /= 3.0;","float A = Coefficient.w;","float B = Coefficient.z;","float C = Coefficient.y;","float D = Coefficient.x;","vec3 Delta = vec3(","-Coefficient.z*Coefficient.z + Coefficient.y,","-Coefficient.y*Coefficient.z + Coefficient.x,","dot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)",");","float Discriminant = dot(vec2(4.0*Delta.x, -Delta.y), Delta.zy);","vec3 RootsA, RootsD;","vec2 xlc, xsc;","{","float A_a = 1.0;","float C_a = Delta.x;","float D_a = -2.0*B*Delta.x + Delta.y;","float Theta = atan(sqrt(Discriminant), -D_a)/3.0;","float x_1a = 2.0*sqrt(-C_a)*cos(Theta);","float x_3a = 2.0*sqrt(-C_a)*cos(Theta + (2.0/3.0)*3.14159265);","float xl;","if ((x_1a + x_3a) > 2.0*B)","xl = x_1a;","else","xl = x_3a;","xlc = vec2(xl - B, A);","}","{","float A_d = D;","float C_d = Delta.z;","float D_d = -D*Delta.y + 2.0*C*Delta.z;","float Theta = atan(D*sqrt(Discriminant), -D_d)/3.0;","float x_1d = 2.0*sqrt(-C_d)*cos(Theta);","float x_3d = 2.0*sqrt(-C_d)*cos(Theta + (2.0/3.0)*3.14159265);","float xs;","if (x_1d + x_3d < 2.0*C)","xs = x_1d;","else","xs = x_3d;","xsc = vec2(-D, xs + C);","}","float E =  xlc.y*xsc.y;","float F = -xlc.x*xsc.y - xlc.y*xsc.x;","float G =  xlc.x*xsc.x;","vec2 xmc = vec2(C*F - B*G, -B*F + C*E);","vec3 Root = vec3(xsc.x/xsc.y, xmc.x/xmc.y, xlc.x/xlc.y);","if (Root.x < Root.y && Root.x < Root.z)","Root.xyz = Root.yxz;","else if (Root.z < Root.x && Root.z < Root.y)","Root.xyz = Root.xzy;","return Root;","}","float areaDiskLight(vec3 N, vec3 V, vec3 P, mat3 Minv, vec3 p0, vec3 p1, vec3 p2) {","vec3 T = normalize(V-N*dot(V,N));","vec3 B = cross(N,T);","mat3 R = transposeMatrix(mat3(T, B, N));","vec3 L[3];","L[0] = R * (p0 - P);","L[1] = R * (p1 - P);","L[2] = R * (p2 - P);","vec3 c  = Minv *(0.5 * (L[0] + L[2]));","vec3 v1 = Minv *(0.5 * (L[1] - L[2]));","vec3 v2 = Minv *(0.5 * (L[1] - L[0]));","if(dot(cross(v1, v2), c) < 0.0)","return 0.0;","float a, b;","float d11 = dot(v1, v1);","float d22 = dot(v2, v2);","float d12 = dot(v1, v2);","if (abs(d12)/sqrt(d11*d22) > 0.005) {","float tr = d11 + d22;","float det = -d12*d12 + d11*d22;","det = sqrt(det);","float u = 0.5*sqrt(tr - 2.0*det);","float v = 0.5*sqrt(tr + 2.0*det);","float e_max = pow2(u + v);","float e_min = pow2(u - v);","vec3 v1_, v2_;","if (d11 > d22) {","v1_ = d12*v1 + (e_max - d11)*v2;","v2_ = d12*v1 + (e_min - d11)*v2;","}","else {","v1_ = d12*v2 + (e_max - d22)*v1;","v2_ = d12*v2 + (e_min - d22)*v1;","}","a = 1.0 / e_max;","b = 1.0 / e_min;","v1 = normalize(v1_);","v2 = normalize(v2_);","}","else {","a = 1.0 / dot(v1, v1);","b = 1.0 / dot(v2, v2);","v1 *= sqrt(a);","v2 *= sqrt(b);","}","vec3 v3 = normalize(cross(v1, v2));","if (dot(c, v3) < 0.0)","v3 *= -1.0;","float L_  = dot(v3, c);","float x0 = dot(v1, c) / L_;","float y0 = dot(v2, c) / L_;","float E1 = inversesqrt(a);","float E2 = inversesqrt(b);","a *= L_*L_;","b *= L_*L_;","float c0 = a*b;","float c1 = a*b*(1.0 + x0*x0 + y0*y0) - a - b;","float c2 = 1.0 - a*(1.0 + x0*x0) - b*(1.0 + y0*y0);","float c3 = 1.0;","vec3 roots = SolveCubic(vec4(c0, c1, c2, c3));","float e1 = roots.x;","float e2 = roots.y;","float e3 = roots.z;","vec3 avgDir = vec3(a*x0/(a - e2), b*y0/(b - e2), 1.0);","mat3 rotate = mat3(v1, v2, v3);","avgDir = rotate*avgDir;","avgDir = normalize(avgDir);","float L1 = sqrt(-e2/e3);","float L2 = sqrt(-e2/e1);","float formFactor = L1*L2*inversesqrt((1.0 + L1*L1)*(1.0 + L2*L2));","vec2 uv = vec2(avgDir.z*0.5 + 0.5, 1.0-formFactor);","uv = uv*LUT_SCALE + LUT_BIAS;","float scale = texture2D(precomputedAreaGGX2texture, uv).w;","float res = formFactor*scale*scale;","return res;","}","void areaRectangleLightModel(out vec3 specular, out vec3 diffuse, in vec3 N,in vec3 V, in vec3 P, in vec3 p0,in vec3 p1,in vec3 p2,in vec3 p3) {","specular = materialData.sr0Color * areaData.fresnel.x + materialData.sr90Color * areaData.fresnel.y;","specular *= areaRectangleLight(N,V,P,areaData.Minv, p0,p1,p2,p3);","diffuse = materialData.diffuseColor * areaRectangleLight(N,V,P,mat3(1.0),p0,p1,p2,p3);","#ifdef USE_SHEEN","vec3 sheen = materialData.diffuseColor * areaRectangleLight(N,V,P,areaData.MinvSheen,p0,p1,p2,p3);","diffuse = mix(diffuse,sheen, 1.0 - pow5(1.0-materialData.sheen));","#endif","diffuse *= 1.0 - vMax(FresnelSchlick(materialData.sr0Color,materialData.sr90Color,saturate(dot(N,V))));","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","vec3 flakesVal = metalFlakes.F0 * areaData.fresnelMetalFlakes.x;","flakesVal *= areaRectangleLight(N,V,P,areaData.MinvMetalFlakes, p0,p1,p2,p3);","specular += flakesVal;","flakesVal = metal.F0 * areaData.fresnelMetal.x;","flakesVal *= areaRectangleLight(N,V,P,areaData.MinvMetal, p0,p1,p2,p3);","float energyFlakes = 1.0 - vMax(FresnelSchlick(metal.F0, vec3(0.0), saturate(dot(metal.normal,V))));","specular *= energyFlakes;","diffuse *= energyFlakes;","specular += flakesVal;","#ifdef PEARL_FLAKES_ACTIVATED","flakesVal = pearlFlakes.F0 * areaData.fresnelPearlFlakes.x;","flakesVal *= areaRectangleLight(N,V,P,areaData.MinvPearlFlakes, p0,p1,p2,p3);","energyFlakes = 1.0 - vMax(FresnelSchlick(pearlFlakes.F0, vec3(0.0), saturate(dot(pearlFlakes.normal,V))));","specular *= energyFlakes;","diffuse *= energyFlakes;","specular += flakesVal;","#endif","#else","vec3 flakesVal = vec3(areaDiskLight(N,V,P,areaData.MinvMetal, p0,p1,p2));","if (flakesData.blendDist < 1.0 - 1e-3) {","vec3 color = flakesVal;","flakesVal *= flakesData.blendDist;","vec3 flakesL = normalize(mix(reflect(-V,N), N, materialData.flakesRoughness));","vec3 flakesH = normalize(flakesL + V);","float VoH = dot(V,flakesH);","float NoL = saturate(dot(N,flakesL));","float NoV = saturate(dot(N,V));","flakesVal += (1.0 - flakesData.blendDist) * color.xyz * stochasticFlakesBRDF(V,flakesL,N,materialData.flakesRoughness,VoH,NoL,NoV);","}","specular *= 1.0 - materialData.flakesCoverage;","diffuse *= 1.0 - materialData.flakesCoverage;","specular += materialData.flakesColor * materialData.flakesCoverage * flakesVal;","#endif","#endif","#ifdef CLEAR_COAT","float fresnelEnergy = 1.0 - materialData.clearCoat * vMax(FresnelSchlick(COATINGF0, COATINGF90, saturate(dot(materialData.clearCoatNormal,V))));","vec3 coat = COATINGF0 * areaData.fresnelCC.x + COATINGF90 * areaData.fresnelCC.y;","coat *= areaRectangleLight(N,V,P,areaData.MinvCC, p0,p1,p2,p3);","diffuse *= fresnelEnergy;","specular *= fresnelEnergy;","specular += coat;","#endif","}","void areaDiskLightModel(out vec3 specular, out vec3 diffuse, in vec3 N,in vec3 V, in vec3 P, in vec3 p0,in vec3 p1,in vec3 p2) {","specular = materialData.sr0Color * areaData.fresnel.x + materialData.sr90Color * areaData.fresnel.y;","specular *= areaDiskLight(N,V,P,areaData.Minv, p0,p1,p2);","diffuse = materialData.diffuseColor * areaDiskLight(N,V,P,mat3(1.0),p0,p1,p2);","#ifdef USE_SHEEN","vec3 sheen = materialData.diffuseColor * areaDiskLight(N,V,P,areaData.MinvSheen,p0,p1,p2);","diffuse = mix(diffuse,sheen, 1.0 - pow5(1.0-materialData.sheen));","#endif","diffuse *= 1.0 - vMax(FresnelSchlick(materialData.sr0Color,materialData.sr90Color,saturate(dot(N,V))));","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","vec3 flakesVal = metalFlakes.F0 * areaData.fresnelMetalFlakes.x;","flakesVal *= areaDiskLight(N,V,P,areaData.MinvMetalFlakes, p0,p1,p2);","specular += flakesVal;","flakesVal = metal.F0 * areaData.fresnelMetal.x;","flakesVal *= areaDiskLight(N,V,P,areaData.MinvMetal, p0,p1,p2);","float energyFlakes = 1.0 - vMax(FresnelSchlick(metal.F0, vec3(0.0), saturate(dot(metal.normal,V))));","specular *= energyFlakes;","diffuse *= energyFlakes;","specular += flakesVal;","#ifdef PEARL_FLAKES_ACTIVATED","flakesVal = pearlFlakes.F0 * areaData.fresnelPearlFlakes.x;","flakesVal *= areaDiskLight(N,V,P,areaData.MinvPearlFlakes, p0,p1,p2);","energyFlakes = 1.0 - vMax(FresnelSchlick(pearlFlakes.F0, vec3(0.0), saturate(dot(pearlFlakes.normal,V))));","specular *= energyFlakes;","diffuse *= energyFlakes;","specular += flakesVal;","#endif","#else","vec3 flakesVal = vec3(areaDiskLight(N,V,P,areaData.MinvMetal, p0,p1,p2));","if (flakesData.blendDist < 1.0 - 1e-3) {","vec3 color = flakesVal;","flakesVal *= flakesData.blendDist;","vec3 flakesL = normalize(mix(reflect(-V,N), N, materialData.flakesRoughness));","vec3 flakesH = normalize(flakesL + V);","float VoH = dot(V,flakesH);","float NoL = saturate(dot(N,flakesL));","float NoV = saturate(dot(N,V));","flakesVal += (1.0 - flakesData.blendDist) * color.xyz * stochasticFlakesBRDF(V,flakesL,N,materialData.flakesRoughness,VoH,NoL,NoV);","}","specular *= 1.0 - materialData.flakesCoverage;","diffuse *= 1.0 - materialData.flakesCoverage;","specular += materialData.flakesColor * materialData.flakesCoverage * flakesVal;","#endif","#endif","#ifdef CLEAR_COAT","float fresnelEnergy = 1.0 - materialData.clearCoat * vMax(FresnelSchlick(COATINGF0, COATINGF90, saturate(dot(materialData.clearCoatNormal,V))));","vec3 coat = COATINGF0 * areaData.fresnelCC.x + COATINGF90 * areaData.fresnelCC.y;","coat *= areaDiskLight(N,V,P,areaData.MinvCC, p0,p1,p2);","diffuse *= fresnelEnergy;","specular *= fresnelEnergy;","specular += coat;","#endif","}","void getSphereLightPoints(in vec3 lP, in float r, in float radius, out vec3 p0, out vec3 p1, out vec3 p2, in vec3 lN, in vec3 N, in vec3 P) {","vec3 toUse = normalize(mix(lN.xyz, -N.xyz, r));","vec3 offsetP = lP + radius * max(dot(vNormalize(P - lP), toUse),0.0) * toUse;","float coeff = radius * mix(1.0, 2.0, r);","vec3 right = getGeomT(toUse.xyz);","vec3 up = getGeomB(toUse.xyz, right);","p0 = offsetP.xyz + right * coeff - up * coeff;","p1 = offsetP.xyz - right * coeff - up * coeff;","p2 = offsetP.xyz - right * coeff + up * coeff;","}","void areaSphereLightModel(out vec3 specular, out vec3 diffuse, in vec3 N,in vec3 V, in vec3 P, in vec3 lP, in vec3 lN, in float r) {","vec3 p0Spec, p1Spec, p2Spec, p0Diff, p1Diff, p2Diff;","#ifdef USE_SHEEN","vec3 p0Sheen, p1Sheen, p2Sheen;","#endif","#ifdef CLEAR_COAT","vec3 p0CC, p1CC, p2CC;","#endif","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","vec3 p0Metal, p1Metal, p2Metal;","vec3 p0MetalFlakes, p1MetalFlakes, p2MetalFlakes;","#ifdef PEARL_FLAKES_ACTIVATED","vec3 p0PearlFlakes, p1PearlFlakes, p2PearlFlakes;","#endif","#else","vec3 p0Metal, p1Metal, p2Metal;","#endif","#endif","{","getSphereLightPoints(lP, materialData.roughness,r, p0Spec, p1Spec, p2Spec, lN, N, P);","#ifdef USE_SHEEN","#ifdef USE_VELVET","float s = sqrt(materialData.sheen);","#else","float s = 0.3;","#endif","getSphereLightPoints(lP, s,r, p0Sheen, p1Sheen, p2Sheen, lN, N, P);","#endif","#ifdef CLEAR_COAT","getSphereLightPoints(lP, materialData.clearCoatR,r, p0CC, p1CC, p2CC, lN, materialData.clearCoatNormal, P);","#endif","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","getSphereLightPoints(lP, metal.roughness,r, p0Metal, p1Metal, p2Metal, lN, metal.normal, P);","getSphereLightPoints(lP, metalFlakes.roughness,r, p0MetalFlakes, p1MetalFlakes, p2MetalFlakes, lN, metalFlakes.normal, P);","#ifdef PEARL_FLAKES_ACTIVATED","getSphereLightPoints(lP, pearlFlakes.roughness,r, p0PearlFlakes, p1PearlFlakes, p2PearlFlakes, lN, pearlFlakes.normal, P);","#endif","#else","getSphereLightPoints(lP, materialData.flakesRoughness,r, p0Metal, p1Metal, p2Metal, lN, metal.normal, P);","#endif","#endif","getSphereLightPoints(lP, 1.0,r, p0Diff, p1Diff, p2Diff, lN, N, P);","}","specular = materialData.sr0Color * areaData.fresnel.x + materialData.sr90Color * areaData.fresnel.y;","specular *= areaDiskLight(N,V,P,areaData.Minv, p0Spec,p1Spec,p2Spec);","diffuse = materialData.diffuseColor * areaDiskLight(N,V,P,mat3(1.0),p0Diff,p1Diff,p2Diff);","#ifdef USE_SHEEN","vec3 sheen = materialData.diffuseColor * areaDiskLight(N,V,P,areaData.MinvSheen,p0Sheen,p1Sheen,p2Sheen);","diffuse = mix(diffuse,sheen, 1.0 - pow5(1.0-materialData.sheen));","#endif","diffuse *= 1.0 - vMax(FresnelSchlick(materialData.sr0Color,materialData.sr90Color,saturate(dot(N,V))));","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","vec3 flakesVal = metalFlakes.F0 * areaData.fresnelMetalFlakes.x;","flakesVal *= areaDiskLight(N,V,P,areaData.MinvMetalFlakes, p0MetalFlakes,p1MetalFlakes,p2MetalFlakes);","specular += flakesVal;","flakesVal = metal.F0 * areaData.fresnelMetal.x;","flakesVal *= areaDiskLight(N,V,P,areaData.MinvMetal, p0Metal,p1Metal,p2Metal);","float energyFlakes = 1.0 - vMax(FresnelSchlick(metal.F0, vec3(0.0), saturate(dot(metal.normal,V))));","specular *= energyFlakes;","diffuse *= energyFlakes;","specular += flakesVal;","#ifdef PEARL_FLAKES_ACTIVATED","flakesVal = pearlFlakes.F0 * areaData.fresnelPearlFlakes.x;","flakesVal *= areaDiskLight(N,V,P,areaData.MinvPearlFlakes, p0PearlFlakes,p1PearlFlakes,p2PearlFlakes);","energyFlakes = 1.0 - vMax(FresnelSchlick(pearlFlakes.F0, vec3(0.0), saturate(dot(pearlFlakes.normal,V))));","specular *= energyFlakes;","diffuse *= energyFlakes;","specular += flakesVal;","#endif","#else","vec3 flakesVal = vec3(areaDiskLight(N,V,P,areaData.MinvMetal, p0Metal,p1Metal,p2Metal));","if (flakesData.blendDist < 1.0 - 1e-3) {","vec3 color = flakesVal;","flakesVal *= flakesData.blendDist;","vec3 flakesL = normalize(mix(reflect(-V,N), N, materialData.flakesRoughness));","vec3 flakesH = normalize(flakesL + V);","float VoH = dot(V,flakesH);","float NoL = saturate(dot(N,flakesL));","float NoV = saturate(dot(N,V));","flakesVal += (1.0 - flakesData.blendDist) * color.xyz * stochasticFlakesBRDF(V,flakesL,N,materialData.flakesRoughness,VoH,NoL,NoV);","}","specular *= 1.0 - materialData.flakesCoverage;","diffuse *= 1.0 - materialData.flakesCoverage;","specular += materialData.flakesColor * materialData.flakesCoverage * flakesVal;","#endif","#endif","#ifdef CLEAR_COAT","float fresnelEnergy = 1.0 - materialData.clearCoat * vMax(FresnelSchlick(COATINGF0, COATINGF90, saturate(dot(materialData.clearCoatNormal,V))));","vec3 coat = COATINGF0 * areaData.fresnelCC.x + COATINGF90 * areaData.fresnelCC.y;","coat *= areaDiskLight(N,V,P,areaData.MinvCC, p0CC,p1CC,p2CC);","diffuse *= fresnelEnergy;","specular *= fresnelEnergy;","specular += coat;","#endif","}","vec3 getSpecularDominantDir(in vec3 N, in vec3 R, in float r){","return normalize(mix(N, R, 1.0-r));","}","float solidAngleRect(in vec3 viewPos, in vec3 p0, in vec3 p1, in vec3 p2, in vec3 p3) {","vec3 v0 = p0 - viewPos;","vec3 v1 = p1 - viewPos;","vec3 v2 = p2 - viewPos;","vec3 v3 = p3 - viewPos;","vec3 n0 = normalize(cross(v0,v1));","vec3 n1 = normalize(cross(v1,v2));","vec3 n2 = normalize(cross(v2,v3));","vec3 n3 = normalize(cross(v3,v0));","float g0 = acos(dot(-n0,n1));","float g1 = acos(dot(-n1,n2));","float g2 = acos(dot(-n2,n3));","float g3 = acos(dot(-n3,n0));","return g0 + g1 + g2 + g3 - 2.0 * 3.14159;","}","vec3 closestOnLine(in vec3 a, in vec3 b, in vec3 c) {","vec3 ab = b - a;","float t = dot(c - a , ab) / dot(ab,ab);","return a + t * ab;","}","vec3 closestOnSegment(in vec3 a, in vec3 b, in vec3 c) {","vec3 ab = b - a;","float t = dot(c - a, ab) / dot(ab,ab);","return a + saturate(t) * ab;","}","vec3 closestPointSphere(in vec3 L, in vec3 R, in float radius) {","vec3 centerToRay = dot(L, R) * R - L;","vec3 closestPoint = L + centerToRay * saturate(radius / length(centerToRay));","return normalize(closestPoint);","}","vec3 closestPointTube(in vec3 P0, in vec3 P1,in vec3 N, in vec3 R, in vec3 P, in vec3 Lp, in float radius) {","vec3 L0 = P0 - P;","vec3 L1 = P1 - P;","vec3 Ld = L1 - L0;","float coeff = dot(R,L0)*dot(R,Ld) - dot(L0,Ld);","coeff /= dot(Ld,Ld) - pow2(dot(R,Ld));","vec3 L = L0 + saturate(coeff) * Ld;","return closestPointSphere(L,R,radius);","}","float illuminanceRectangle(in vec3 p0, in vec3 p1, in vec3 p2, in vec3 p3,in vec3 lPos, in vec3 vPos, in vec3 N) {","float angle = solidAngleRect(vPos, p0,p1,p2,p3);","float coeff = saturate(dot(normalize(lPos - vPos),N));","coeff += saturate(dot(normalize(p0 - vPos),N)) + saturate(dot(normalize(p1 - vPos),N));","coeff += saturate(dot(normalize(p2 - vPos),N)) + saturate(dot(normalize(p3 - vPos),N));","return angle * 0.2*coeff;","}","float illuminanceTube(in vec3 P0, in vec3 P1, in vec3 lPos, in vec3 vPos, in vec3 N, in vec3 lRight, in float lHWidth, in float lRadius) {","vec3 forw = normalize(closestOnLine(P0,P1,vPos) - vPos);","vec3 right = lRight;","vec3 up = cross(right, forw);","float illu = 0.0;//illuminanceRectangle(p0,p1,p2,p3,lPos,vPos,N);","vec3 sphPos = closestOnSegment(P0,P1, vPos);","vec3 sphNorm = sphPos - vPos;","vec3 sphL = normalize(sphNorm);","float sqrSphDist = dot(sphNorm, sphNorm);","float illu2 = 3.14159 * saturate(dot(sphL, N)) * ((lRadius*lRadius)/sqrSphDist);","return illu+illu2;","}","#endif",].join("\n");j.ShaderChunk.lights_physicalDS_pars_fragment=[j.ShaderChunk.physicalDS_uniforms_pars_fragment,j.ShaderChunk.lights_uniform_fragment,j.ShaderChunk.shadowmap_pars_fragment,j.ShaderChunk.brdf_pars_fragment,j.ShaderChunk.lights_rendering_equation_fragment,j.ShaderChunk.light_model_pars_fragment,j.ShaderChunk.lights_utility_pars_fragment,j.ShaderChunk.emission_pars_fragment,j.ShaderChunk.iteration_pars_fragment,"#ifdef GAS_LOOK","vec3 perturbNormalGasLook(vec3 normal, vec3 vWorldPosition) {","float bumpNorm = 0.02 * snoise(10.0 * vWorldPosition);","bumpNorm = mix(bumpNorm, 0.0, clamp(0.02 * abs(vViewPosition.z), 0.0, 1.0));","return normalize(normal + vec3(bumpNorm));","}","#endif"].join("\n");j.ShaderChunk.IBL_pars_fragment=["#if defined( USE_SH_ENVMAP )","uniform mat4 shFactorsR;","uniform mat4 shFactorsG;","uniform mat4 shFactorsB;","uniform float shScale;","#endif","#ifdef USE_ENVMAP","uniform sampler2D precomputedTexture1;","#ifdef USE_SHEEN","uniform sampler2D precomputedTexture2;","#endif","#if (defined(USE_FLAKES) && !defined(OLD_FLAKES)) || defined(USE_SHEEN)","uniform sampler2D precomputedTexture3;","#endif","uniform sampler2D envMap2;","#endif","#ifdef USE_REFLECTION_PROBE","uniform sampler2D reflectionProbe;","uniform sampler2D reflectionProbeMips;","uniform vec3 reflectionProbeProxyMin;","uniform vec3 reflectionProbeProxyMax;","uniform vec3 reflectionProbePos;","#endif","#ifdef USE_FINITE_ENVMAP","uniform vec3 sphereCenter;","uniform vec3 projectionCenter;","uniform float sphereRadius;","#endif","#if defined(USE_SSLR)","uniform sampler2D prevColorTexture;","uniform sampler2D prevNormalDepthTexture;","uniform vec2 screenSize;","uniform vec2 invScreenSize;","#endif","#if defined(USE_ENVMAP)","const float oneOverMax16int = 0.000015259021896696422;","vec2 getMips(in float roughnessValue) {","float mipValue = max(6.0 + 1.15 * log2(roughnessValue + 0.0000001), 0.0);","float mipCoef = fract(mipValue);","if (mipValue > 6.0) {","mipValue = 6.0;","mipCoef = 1.0;","}","return vec2(mipValue,mipCoef);","}","vec2 getEnvMapUV(in vec3 vector) {","vector = (ambienceMatrix*vec4(vector,0.0)).xyz;","float phi = atan(vector.y, vector.x);","float theta = acos(vector.z);","return vec2(fract(0.5 + 0.5 * INV_PI * phi), 1.0 - INV_PI * theta);","}","float unpackFrom16(vec2 pack) {","return 255.0 * oneOverMax16int * (256.0 * pack.x + pack.y);","}","vec2 getUVFromMips(float mip, vec2 uv, vec2 texelSize) {","float t10 = pow(2.0, -floor(log2(mip + 1.0)));","float t11 = 2.0 - (mip + 2.0) * t10;","float t12 = 0.5 * t10;","return vec2(t11 + 1.5 * texelSize.x + (2.0 * t12 - 3.0 * texelSize.x) * uv.x, t12 + 1.5 * texelSize.x + (t12 - 3.0 * texelSize.x) * uv.y);","}","vec4 sampleMipMapRoughness(vec2 uv, float mip, float coef, sampler2D map0, sampler2D map1, vec2 textureSize, vec2 texelSize) {","vec4 color1;","vec4 color2;","vec2 uv1;","vec2 uv2;","#ifdef USE_ENVMAP_HDR","if (mip < 1.0) {","color1 = texture2DBilinearFromRGBE(map0, uv, textureSize, texelSize);","} else {","textureSize.y *= 2.0;","texelSize.y *= 0.5;","float level1 = clamp(floor(mip) - 1.0, 0.0, 4.0);","uv1 = getUVFromMips(level1, uv, texelSize);","color1 = texture2DBilinearFromRGBE(map1, uv1, textureSize, texelSize);","}","float level2 = clamp(floor(mip), 0.0, 5.0);","uv2 = getUVFromMips(level2, uv, texelSize);","color2 = texture2DBilinearFromRGBE(map1, uv2, textureSize, texelSize);","return mix(color1, color2, coef);","#else","return texture2D(map1, uv);","#endif","}","vec4 sampleMipMapRoughnessSheen(vec2 uv, float mip, float coef, sampler2D map1, vec2 textureSize, vec2 texelSize) {","vec4 color1;","vec4 color2;","vec2 uv1;","vec2 uv2;","textureSize.y *= 2.0;","texelSize.y *= 0.5;","float level1 = clamp(floor(mip) - 1.0, 0.0, 4.0);","uv1 = getUVFromMips(level1, uv, texelSize);","color1 = texture2DBilinearFromRGBE(map1, uv1, textureSize, texelSize);","float level2 = clamp(floor(mip), 0.0, 5.0);","uv2 = getUVFromMips(level2, uv, texelSize);","color2 = texture2DBilinearFromRGBE(map1, uv2, textureSize, texelSize);","return mix(color1, color2, coef);","}","#else","const float PI = 3.14159265359;","const float INV_PI = 0.31830988618;","#endif","#ifdef USE_REFLECTION_PROBE","vec3 correctParallax(vec3 worldPos, vec3 reflectVec) {","vec3 rbmax = (reflectionProbeProxyMax - worldPos) / reflectVec;","vec3 rbmin = (reflectionProbeProxyMin - worldPos) / reflectVec;","vec3 rbminmax = max(rbmax, rbmin);","float distance = min(min(rbminmax.x, rbminmax.y), rbminmax.z);","vec3 intersectPos = worldPos + reflectVec * distance;","return normalize(intersectPos - reflectionProbePos);","}","#endif","#ifdef USE_FINITE_ENVMAP","vec3 correctParallaxFinite(vec3 center, vec3 projection, float radius, vec3 rayDir, vec3 rayOrig) {","float t = 0.0;","vec3 dist = rayOrig - center;","float B = 2.0*dot(rayDir, dist);","float C = dot(dist, dist) - radius*radius;","float disc = B*B - 4.0*C;","if (disc < 0.0) {","    t = -1.0;","}","t = (-B + sqrt(disc)) / 2.0;","vec3 hitPos = rayOrig + t*rayDir;","vec3 sn = (hitPos - projection);","return normalize(sn);","}","#endif","#if defined(USE_SSLR)","vec4 RayMarch(vec3 origin, vec3 direction) {","    vec4 outColor = vec4(0.0);","    float radius = 0.5;","    vec3 ptReflect = origin + radius * direction;","    vec2 screenUV = gl_FragCoord.xy * invScreenSize;","    float z = texture2D(prevNormalDepthTexture, screenUV).w;","    vec3 originScreenPos = vec3(screenUV, 2.0 * z - 1.0);","    vec4 offset = projectionMatrix * vec4(ptReflect, 1.0);","    offset.xyz /= offset.w;","    offset.xy = offset.xy * 0.5 + 0.5;","    vec3 endReflectScreenPos = offset.xyz;","    vec3 reflectScreenPos = endReflectScreenPos - originScreenPos;","    reflectScreenPos /= length(endReflectScreenPos.xy - originScreenPos.xy);","    vec2 stepsToBorder = vec2(screenSize * screenUV / abs(reflectScreenPos.xy));","    if (reflectScreenPos.x > 0.0) stepsToBorder.x = screenSize.x * (1.0 - screenUV.x) / abs(reflectScreenPos.x);","    if (reflectScreenPos.y > 0.0) stepsToBorder.y = screenSize.y * (1.0 - screenUV.y) / abs(reflectScreenPos.y);","    float stepsToScreenBorder = min(stepsToBorder.x, stepsToBorder.y);","    reflectScreenPos /= screenSize.x;","    float prevDepth = originScreenPos.z;","    float ray_marching_step = 16.0;","    float j = ray_marching_step;","    for (int i = 0; i < 64; ++i) {","      if (j > stepsToScreenBorder) { break; }","      vec3 sampleScreenPos = originScreenPos + j * reflectScreenPos;","      vec4 normalDepth = texture2D(prevNormalDepthTexture, sampleScreenPos.xy);","      float z = 2.0 * normalDepth.w - 1.0;","      vec3 n;","      n.z = 2.0 * dot(normalDepth.xy, normalDepth.xy) - 1.0;","      n.xy = normalize(normalDepth.xy) * sqrt(1.0 - n.z * n.z);","      float diffZ = sampleScreenPos.z - z;","      if (normalDepth.w > 0.0 && diffZ > 0.0) {","        if (ray_marching_step == 1.0) {","          if (abs(diffZ) < 10.0 * abs(sampleScreenPos.z - prevDepth)) {","            float reflectAttenuation = clamp(-dot(n, direction), 0.0, 1.0) * ((stepsToScreenBorder - j) / stepsToScreenBorder);","            outColor = texture2D(prevColorTexture, sampleScreenPos.xy);","            outColor.w = reflectAttenuation;","          }","          break;","        } else {","          ray_marching_step *= 0.5;","          j -= ray_marching_step;","        }","      } else {","        prevDepth = sampleScreenPos.z;","        j += (0.5 + 0.5 * Random1D(float(renderIteration) + j)) * ray_marching_step;","      }","    }","    return outColor;","}","#endif",].join("\n");j.ShaderChunk.IBL_fragment=["vec3 specularIBLValue = vec3(0.0);","vec3 diffuseIBLValue = vec3(0.0);","#ifdef CLEAR_COAT","vec3 clearCoatIBLValue = vec3(0.0);","#endif","#ifndef USE_ENVMAP_HDR","vec2 envMapHDRSize;","vec2 texelSizeEnvMap;","#endif","vec3 cameraToVertex;","if (projectionMatrix[3][3] > 0.5) {","cameraToVertex = normalize( vec3( vec4( 0.0,0.0,-1.0, 0.0 ) * viewMatrix ) );","} else {","cameraToVertex = normalize( vWorldPosition - cameraPosition );","}",].join("\n");j.ShaderChunk.core_IBL_fragment=["vec3 worldViewNormal = normalize( vec3( vec4( viewNormal, 0.0 ) * viewMatrix ) );","float NdotV = max(dot(normal, viewPosition), 0.0);","vec3 reflectVec = reflect( cameraToVertex, worldNormal );","#if !defined(USE_ITERATION)","vec2 mips = getMips(materialData.roughness);","vec4 cubeColor;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_REFLECTION_PROBE","reflectVec = correctParallax(vWorldPosition, reflectVec);","#endif","#ifdef USE_FINITE_ENVMAP","reflectVec = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, reflectVec, vWorldPosition);","#endif","vec2 reflectionUV = getEnvMapUV(reflectVec);","#ifdef USE_REFLECTION_PROBE","cubeColor = envMapExposure * sampleMipMapRoughness( reflectionUV, mips.x, mips.y, reflectionProbe, reflectionProbeMips, envMapHDRSize, texelSizeEnvMap );","#else","cubeColor = envMapExposure * sampleMipMapRoughness( reflectionUV, mips.x, mips.y, envMap, envMap2, envMapHDRSize, texelSizeEnvMap );","#endif","#endif","#endif","#ifdef USE_NORMALMAP","float hOcclusion = clamp(1.0 + horizonFade * dot(reflectVec, worldViewNormal), 0.0, 1.0);","hOcclusion *= hOcclusion;","#else","float hOcclusion = 1.0;","#endif","#if defined(USE_ITERATION)","#if defined(USE_ANISOTROPY)","SpecularIBLAniso(specularIBLValue,materialData.roughness, tangent, binormal, normal, viewPosition, NdotV, materialData.sr0Color, materialData.sr90Color, envMapHDRSize, texelSizeEnvMap, materialData.anisotropy, materialData.anisotropyAngle);","#else","SpecularIBL(specularIBLValue,materialData.roughness, normal, viewPosition, NdotV, materialData.sr0Color, materialData.sr90Color, envMapHDRSize, texelSizeEnvMap);","#endif","#else","vec4 preCompGGX = texture2D(precomputedTexture1, vec2(NdotV,materialData.roughness));","vec3 GFresnelVoH = materialData.sr0Color* unpackFrom16(preCompGGX.xy) + materialData.sr90Color * unpackFrom16(preCompGGX.zw);","specularIBLValue = cubeColor.xyz * GFresnelVoH;","#endif","specularIBLValue *= hOcclusion;","#ifdef USE_LIGHTMAP","#ifdef LIGHTMAP_IRRADIANCE_MODE","specularIBLValue *= clamp(aoValue, 0.0, 1.0);","#else","specularIBLValue *= aoValue;","#endif","#endif","#if defined( USE_LATLONGMAP )","vec2 normalUV = getEnvMapUV(worldNormal);","vec2 textureSizeEnvMap = vec2(envMapHDRSize.x, 2.0 * envMapHDRSize.y);","vec2 texelSizeEnvMipMap = vec2(texelSizeEnvMap.x, 0.5 * texelSizeEnvMap.y);","vec3 fresnelNoV = FresnelSchlick(materialData.sr0Color,materialData.sr90Color,NdotV);","#if defined(USE_ENVMAP_DIFFUSE) && !defined(USE_REFLECTION_PROBE)","float diffMip = 6.0;","#else","float diffMip = 5.0;","#endif","#ifdef USE_REFLECTION_PROBE","#ifdef USE_ENVMAP_HDR","vec4 texelColor = envMapExposure * texture2DBilinearFromRGBE(reflectionProbeMips, getUVFromMips(diffMip, normalUV, texelSizeEnvMipMap), textureSizeEnvMap, texelSizeEnvMipMap);","#else","vec4 texelColor = envMapExposure * texture2D(reflectionProbeMips, vec2(normalUV.x,normalUV.y));","#endif","#else","#ifdef USE_ENVMAP_HDR","vec4 texelColor = envMapExposure * texture2DBilinearFromRGBE(envMap2, getUVFromMips(diffMip, normalUV, texelSizeEnvMipMap), textureSizeEnvMap, texelSizeEnvMipMap);","#else","vec4 texelColor = envMapExposure * texture2D(envMap2, vec2(normalUV.x,normalUV.y));","#endif","#endif","#if defined(USE_SHEEN) && defined(USE_ENVMAP_SHEEN)","vec4 sheenColor = vec4(0.0);","#ifdef USE_VELVET","float sheenRough = sqrt(materialData.sheen);","#else","float sheenRough = 0.3;","#endif","#ifndef USE_ITERATION","#ifdef USE_VELVET","vec2 mipsF = getMips(1.0-sheenRough);","float GFab = unpackFrom16(texture2D(precomputedTexture2, vec2(NdotV,sheenRough)).zw);","#else","vec2 mipsF = getMips(sheenRough);","float GFab = unpackFrom16(texture2D(precomputedTexture2, vec2(NdotV,sheenRough)).xy);","#endif","sheenColor = sampleMipMapRoughnessSheen( reflectionUV, mipsF.x, mipsF.y, envMapSheen, envMapHDRSize, texelSizeEnvMap );","sheenColor *= GFab;","#else","SheenIBL(sheenColor,sheenRough,normal,viewPosition,NdotV,envMapHDRSize,texelSizeEnvMap);","#endif","texelColor.rgb = mix(texelColor.rgb,sheenColor.rgb,1.0 - pow5(1.0-materialData.sheen));","#endif","texelColor.rgb *= 1.0 - vMax(fresnelNoV);","#ifdef USE_SUBSURFACE","texelColor.rgb *= SssLUTSampling(materialData.curvature);","#endif","#ifdef USE_LIGHTMAP","#ifdef LIGHTMAP_IRRADIANCE_MODE","diffuseIBLValue = aoValue * materialData.diffuseColor;","#else","diffuseIBLValue = aoValue * materialData.diffuseColor  * texelColor.xyz;","#endif","#else","diffuseIBLValue = materialData.diffuseColor * texelColor.xyz  ;","#endif","#endif",].join("\n");j.ShaderChunk.coating_IBL_fragment=["#ifdef CLEAR_COAT","float NdotVcoating = max(dot(materialData.clearCoatNormal, viewPosition), 0.0);","vec3 reflectVeccoating = reflect( cameraToVertex, worldClearCoatNormal );","#if !defined(USE_ITERATION)","vec2 mipsC = getMips(materialData.clearCoatR);","vec4 cubeColorcoating;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_REFLECTION_PROBE","reflectVeccoating = correctParallax(vWorldPosition, reflectVeccoating);","#endif","#ifdef USE_FINITE_ENVMAP","reflectVeccoating = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, reflectVeccoating, vWorldPosition);","#endif","vec2 reflectionUVcoating = getEnvMapUV(reflectVeccoating);","#ifdef USE_REFLECTION_PROBE","cubeColorcoating = envMapExposure * sampleMipMapRoughness( reflectionUVcoating, mipsC.x, mipsC.y, reflectionProbe, reflectionProbeMips, envMapHDRSize, texelSizeEnvMap );","#else","cubeColorcoating = envMapExposure * sampleMipMapRoughness( reflectionUVcoating, mipsC.x, mipsC.y, envMap, envMap2, envMapHDRSize, texelSizeEnvMap );","#endif","#endif","#endif","#ifdef CLEAR_COAT_NORMALMAP","float chOcclusion = clamp(1.0 + 1.3 * dot(reflectVeccoating, worldViewNormal), 0.0, 1.0);","chOcclusion *= chOcclusion;","#else","float chOcclusion = 1.0;","#endif","#if defined(USE_ITERATION)","SpecularIBL(clearCoatIBLValue,materialData.clearCoatR, materialData.clearCoatNormal, viewPosition, max(dot(materialData.clearCoatNormal, viewPosition), 0.0), COATINGF0,COATINGF90, envMapHDRSize, texelSizeEnvMap);","#else","vec4 precompCoat = texture2D(precomputedTexture1, vec2(NdotVcoating,materialData.clearCoatR));","vec3 GFresnelVoHCoat = unpackFrom16(precompCoat.xy) * COATINGF0 + unpackFrom16(precompCoat.zw) * COATINGF90;","clearCoatIBLValue = cubeColorcoating.xyz * GFresnelVoHCoat;","#endif","float energyCoating = 1.0 - materialData.clearCoat* vMax(FresnelSchlick(COATINGF0,COATINGF90,NdotVcoating));","specularIBLValue.xyz *= energyCoating;","diffuseIBLValue.xyz *= energyCoating;","clearCoatIBLValue.xyz *= materialData.clearCoat * chOcclusion;","#endif"].join("\n");j.ShaderChunk.flakes_IBL_fragment=["#ifdef USE_FLAKES","float NdotVMetal = NdotV;","#if !defined(USE_ITERATION)","vec2 mipsMetal = getMips(materialData.flakesRoughness);","vec4 cubeColorMetal;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","vec2 reflectionUVMetal = reflectionUV;","#ifdef USE_REFLECTION_PROBE","cubeColorMetal = envMapExposure * sampleMipMapRoughness( reflectionUVMetal, mipsMetal.x, mipsMetal.y, reflectionProbe, reflectionProbeMips, envMapHDRSize, texelSizeEnvMap );","#else","cubeColorMetal = envMapExposure * sampleMipMapRoughness( reflectionUVMetal, mipsMetal.x, mipsMetal.y, envMap, envMap2, envMapHDRSize, texelSizeEnvMap );","#endif","#endif","#endif","vec3 metalIBLValue = vec3(0.0);","#if defined(USE_ITERATION)","SpecularIBL(metalIBLValue,materialData.flakesRoughness, normal, viewPosition, max(dot(normal, viewPosition), 0.0),ve3(1.0),vec3(1.0), envMapHDRSize, texelSizeEnvMap);","#else","float GMetal = unpackFrom16(texture2D(precomputedTexture3, vec2(NdotVMetal,materialData.flakesRoughness)).xy);","metalIBLValue = cubeColorMetal.xyz  * GMetal;","#endif","if (flakesData.blendDist < 1.0 - 1e-3) {","metalIBLValue *= flakesData.blendDist;","vec3 flakesL = normalize(mix(reflect(-viewPosition,normal), normal, materialData.flakesRoughness));","vec3 flakesH = normalize(flakesL + viewPosition);","float VoH = dot(viewPosition,flakesH);","float NoL = saturate(dot(normal,flakesL));","float NoV = saturate(dot(normal,viewPosition));","metalIBLValue += (1.0 - flakesData.blendDist) * cubeColorMetal.xyz * stochasticFlakesBRDF(viewPosition,flakesL,normal,materialData.flakesRoughness,VoH,NoL,NoV);","}","float energyMetal = 1.0 - materialData.flakesCoverage;","diffuseIBLValue *= energyMetal;","specularIBLValue *= energyMetal;","specularIBLValue += materialData.flakesCoverage * hOcclusion* materialData.flakesColor * metalIBLValue;","#endif"].join("\n");j.ShaderChunk.old_flakes_IBL_fragment=["#ifdef USE_FLAKES","float NdotVMetalFlakes = max(dot(metalFlakes.normal, viewPosition), 0.0);","vec3 reflectVecMetalFlakes = reflect( cameraToVertex, metalFlakes.worldNormal );","float NdotRMetalFlakes = max(dot(metalFlakes.worldNormal, reflectVecMetalFlakes), 0.0);","float NdotVMetal = NdotV;","#if !defined(USE_ITERATION)","vec2 mipsMetalFlakes = getMips(metalFlakes.roughness);","vec2 mipsMetal = getMips(metal.roughness);","vec4 cubeColorMetal;","vec4 cubeColorMetalFlakes;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_REFLECTION_PROBE","reflectVecMetalFlakes = correctParallax(vWorldPosition, reflectVecMetalFlakes);","#endif","#ifdef USE_FINITE_ENVMAP","reflectVecMetalFlakes = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, reflectVecMetalFlakes, vWorldPosition);","#endif","vec2 reflectionUVMetalFlakes = getEnvMapUV(reflectVecMetalFlakes);","vec2 reflectionUVMetal = reflectionUV;","#ifdef USE_REFLECTION_PROBE","cubeColorMetalFlakes = envMapExposure * sampleMipMapRoughness( reflectionUVMetalFlakes, mipsMetalFlakes.x, mipsMetalFlakes.y, reflectionProbe, reflectionProbeMips, envMapHDRSize, texelSizeEnvMap );","cubeColorMetal = envMapExposure * sampleMipMapRoughness( reflectionUVMetal, mipsMetal.x, mipsMetal.y, reflectionProbe, reflectionProbeMips, envMapHDRSize, texelSizeEnvMap );","#else","cubeColorMetalFlakes = envMapExposure * sampleMipMapRoughness( reflectionUVMetalFlakes, mipsMetalFlakes.x, mipsMetalFlakes.y, envMap, envMap2, envMapHDRSize, texelSizeEnvMap );","cubeColorMetal = envMapExposure * sampleMipMapRoughness( reflectionUVMetal, mipsMetal.x, mipsMetal.y, envMap, envMap2, envMapHDRSize, texelSizeEnvMap );","#endif","#endif","#endif","float mFhOcclusion = clamp(1.0 + 1.3 * dot(reflectVecMetalFlakes, worldViewNormal), 0.0, 1.0);","mFhOcclusion *= mFhOcclusion;","vec3 metalFlakesIBLValue = vec3(0.0);","vec3 metalIBLValue = vec3(0.0);","#if defined(USE_ITERATION)","SpecularIBL(metalFlakesIBLValue,metalFlakes.roughness, metalFlakes.normal, viewPosition, max(dot(metalFlakes.normal, viewPosition), 0.0), metalFlakes.F0,vec3(0.0), envMapHDRSize, texelSizeEnvMap);","SpecularIBL(metalIBLValue,metal.roughness, metal.normal, viewPosition, max(dot(metal.normal, viewPosition), 0.0), metal.F0,vec3(0.0), envMapHDRSize, texelSizeEnvMap);","#else","vec4 precompMetalFlakes = texture2D(precomputedTexture1, vec2(NdotVMetalFlakes,metalFlakes.roughness));","vec4 precompMetal = texture2D(precomputedTexture1, vec2(NdotVMetal,metal.roughness));","vec3 GFresnelVoHMetalFlakes = unpackFrom16(precompMetalFlakes.xy) * metalFlakes.F0 ;","metalFlakesIBLValue = cubeColorMetalFlakes.xyz * GFresnelVoHMetalFlakes;","vec3 GFresnelVoHMetal = unpackFrom16(precompMetal.xy) * metal.F0 ;","metalIBLValue = cubeColorMetal.xyz * GFresnelVoHMetal;","#endif","specularIBLValue += mFhOcclusion*metalFlakesIBLValue;","float energyMetal = 1.0 - vMax(FresnelSchlick(metal.F0,vec3(0.0),NdotVMetal));","diffuseIBLValue *= energyMetal;","specularIBLValue *= energyMetal;","specularIBLValue += hOcclusion*metalIBLValue;","#endif"].join("\n");j.ShaderChunk.old_pearlflakes_IBL_fragment=["#if defined(USE_FLAKES) && defined(PEARL_FLAKES_ACTIVATED)","float NdotVPearlFlakes = max(dot(pearlFlakes.normal, viewPosition), 0.0);","vec3 reflectVecPearlFlakes = reflect( cameraToVertex, pearlFlakes.worldNormal );","#if !defined(USE_ITERATION)","vec2 mipsPearl = getMips(pearlFlakes.roughness);","vec4 cubeColorPearlFlakes;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_REFLECTION_PROBE","reflectVecPearlFlakes = correctParallax(vWorldPosition, reflectVecPearlFlakes);","#endif","#ifdef USE_FINITE_ENVMAP","reflectVecPearlFlakes = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, reflectVecPearlFlakes, vWorldPosition);","#endif","vec2 reflectionUVPearlFlakes = getEnvMapUV(reflectVecPearlFlakes);","#ifdef USE_REFLECTION_PROBE","cubeColorPearlFlakes = envMapExposure * sampleMipMapRoughness( reflectionUVPearlFlakes, mipsPearl.x, mipsPearl.y, reflectionProbe, reflectionProbeMips, envMapHDRSize, texelSizeEnvMap );","#else","cubeColorPearlFlakes = envMapExposure * sampleMipMapRoughness( reflectionUVPearlFlakes, mipsPearl.x, mipsPearl.y, envMap, envMap2, envMapHDRSize, texelSizeEnvMap );","#endif","#endif","#endif","float pFhOcclusion = clamp(1.0 + 1.3 * dot(reflectVecPearlFlakes, worldViewNormal), 0.0, 1.0);","pFhOcclusion *= pFhOcclusion;","vec3 pearlFlakesIBLValue = vec3(0.0);","#if defined(USE_ITERATION)","SpecularIBL(pearlFlakesIBLValue,pearlFlakes.roughness, pearlFlakes.normal, viewPosition, max(dot(pearlFlakes.normal, viewPosition), 0.0), pearlFlakes.F0,vec3(0.0), envMapHDRSize, texelSizeEnvMap);","#else","vec4 precompPearlFlakes = texture2D(precomputedTexture1, vec2(NdotVPearlFlakes,pearlFlakes.roughness));","vec3 GFresnelVoHPearlFlakes = unpackFrom16(precompPearlFlakes.xy) * pearlFlakes.F0 ;","pearlFlakesIBLValue = cubeColorPearlFlakes.xyz * GFresnelVoHPearlFlakes;","#endif","float energyPearlFlakes = 1.0 - vMax(FresnelSchlick(pearlFlakes.F0,vec3(0.0),NdotVPearlFlakes));","diffuseIBLValue *= energyPearlFlakes;","specularIBLValue *= energyPearlFlakes;","specularIBLValue += pFhOcclusion*pearlFlakesIBLValue;","#endif"].join("\n");j.ShaderChunk.total_IBL_fragment=["#ifndef SPECGLOSS","specularIBLValue /= transToDivide;","#endif","gl_FragColor.xyz += specularIBLValue + diffuseIBLValue;","#ifdef CLEAR_COAT","#ifndef SPECGLOSS","clearCoatIBLValue /= transToDivide;","#endif","gl_FragColor.xyz += clearCoatIBLValue;","#endif",].join("\n");j.ShaderChunk.transparency_lights_physicalDS_fragment=["#ifdef PDSFX","float trans = _DStransparency;","#else","float trans = transparency;","#endif","#ifdef USE_TRANSPARENCYMAP","#ifdef NRE_COMPATIBILITY","vec2 transparencyUV=(transparencyUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 transparencyUV=uvToUse;","#endif","trans = texture2D(transparencyMap, transparencyUV).r;","#endif","#ifdef USE_TRANSPARENCY_COEFFICIENTS","trans = transparencyMulCoef * trans + transparencyAddCoef;","#endif","#ifdef PDSFX","_DStransparency_ = trans;","trans = ComputeTransparency();","#endif","trans *= (1.0 - metalnessValue);","#ifdef SPECGLOSS","vec3 Ft = FresnelSchlick(specularColor, vec3(1.0), NoV);","#else","vec3 Ft = FresnelSchlick(materialData.sr0Color, materialData.sr90Color, NoV);","#endif","float transToDivide = max(1.0 - trans * (1.0 - 0.3333*(Ft.x + Ft.y + Ft.z)), 1e-6);","gl_FragColor.a = transToDivide;",].join("\n");j.ShaderChunk.cutout_lights_physicalDS_fragment=["#ifdef PDSFX","float opacityValue = _DSopacity;","#else","float opacityValue = opacity;","#endif","#ifdef USE_OPACITYMAP","#ifdef NRE_COMPATIBILITY","vec2 opacityUV=(opacityUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 opacityUV=uvToUse;","#endif","opacityValue = texture2D(opacityMap, opacityUV).r;","#endif","#ifdef USE_OPACITY_COEFFICIENTS","opacityValue = opacityMulCoef * opacityValue + opacityAddCoef;","#endif","#ifdef PDSFX","_DSopacity_ = opacityValue;","opacityValue = ComputeOpacity();","#endif","gl_FragColor.a *= opacityValue;","#if defined(USE_MAP) && defined(USE_ALPHA_FROM_MAP) && defined(NRE_COMPATIBILITY)","gl_FragColor.a *= transparencyFromDiffuseMap;","#endif",].join("\n");j.ShaderChunk.normal_lights_physicalDS_fragment=["vec3 normal = viewNormal;","#ifdef USE_NORMALMAP","#ifdef NRE_COMPATIBILITY","#if (NORMALMAP_UV_SLOT == 2)","vec2 normalUv =(normalUvTransform * vec3(uv2ToUse, 1.0)).xy;","#else","vec2 normalUv =(normalUvTransform * vec3(uvToUse, 1.0)).xy;","#endif","#else","vec2 normalUv = uvToUse;","#endif","normal = perturbNormal3Arb( viewNormal, tangent, binormal, normalUv );","#elif defined( USE_BUMPMAP )","normal = perturbNormalArb( -vViewPosition, viewNormal, dHdxy_fwd() );","#endif","vec3 worldNormal = normalize( vec3( vec4( normal, 0.0 ) * viewMatrix ) );","#ifdef USE_SUBSURFACE","vec3 worldNoMapNormal = normalize( vec3( vec4( viewNormal, 0.0 ) * viewMatrix ) );","#endif",].join("\n");j.ShaderChunk.cc_lights_physicalDS_fragment=["#ifdef CLEAR_COAT","#ifdef CLEAR_COAT_MAP","#ifdef NRE_COMPATIBILITY","vec2 ccUV=(clearCoatUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 ccUV=uvToUse;","#endif","materialData.clearCoat = texture2D( clearCoatMap, ccUV ).r;","#else","materialData.clearCoat = clearCoat;","#endif","#ifdef USE_CC_COEFFICIENTS","materialData.clearCoat = clearCoatMulCoef * materialData.clearCoat + clearCoatAddCoef;","#endif","#ifdef CLEAR_COAT_NORMALMAP","#ifdef NRE_COMPATIBILITY","#if (NORMALMAP_UV_SLOT == 2)","vec2 ccnormalUv =(clearCoatNormalUvTransform * vec3(uv2ToUse, 1.0)).xy;","#else","vec2 ccnormalUv =(clearCoatNormalUvTransform * vec3(uvToUse, 1.0)).xy;","#endif","#else","vec2 ccnormalUv = uvToUse;","#endif","materialData.clearCoatNormal = perturbNormal3ArbCoat( viewNormal, tangent, binormal, ccnormalUv );","#else","materialData.clearCoatNormal = viewNormal;","#endif","vec3 worldClearCoatNormal = normalize( vec3( vec4( materialData.clearCoatNormal, 0.0 ) * viewMatrix ) );","#ifdef USE_ORANGE_PEEL","doOrangePeel(worldClearCoatNormal);","materialData.clearCoatNormal = normalize( (viewMatrix * vec4( worldClearCoatNormal, 0.0)).xyz);","#endif","#ifdef USE_CC_ROUGHNESSMAP","#ifdef NRE_COMPATIBILITY","vec2 ccroughnessUV=(clearCoatRoughnessUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 ccroughnessUV=uvToUse;","#endif","materialData.clearCoatR = texture2D( clearCoatRoughnessMap, ccroughnessUV ).r;","#if !defined( USE_CC_ROUGHNESSMAP_LINEAR )","materialData.clearCoatR *= materialData.clearCoatR;","#endif","materialData.clearCoatR = max(materialData.clearCoatR, 0.0025);","#else","materialData.clearCoatR =  max(clearCoatRoughness, 0.0025);","#endif","#ifdef USE_CC_ROUGHNESS_COEFFICIENTS","materialData.clearCoatR = clearCoatRoughnessMulCoef * materialData.clearCoatR + clearCoatRoughnessAddCoef;","#endif","#ifdef USE_CC_GLOSSINESSMAP","#ifdef NRE_COMPATIBILITY","vec2 ccglossinessUV=(clearCoatRoughnessUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 ccglossinessUV=uvToUse;","#endif","float ccGlossiness = texture2D( coatingGlossinessMap, ccglossinessUV ).r;","#if !defined( USE_CC_ROUGHNESSMAP_LINEAR )","ccGlossiness *= ccGlossiness;","#endif","#ifdef USE_CC_GLOSSINESS_COEFFICIENTS","ccGlossiness = coatingGlossinessMulCoef * ccGlossiness + coatingGlossinessAddCoef;","#endif","materialData.clearCoatR = max(1.0 - ccGlossiness, 0.0025);","#endif","#endif",].join("\n");j.ShaderChunk.flakes_lights_physicalDS_fragment=["#ifdef USE_FLAKES","#ifdef OLD_FLAKES","doFlakes(worldNormal);","metalFlakes.normal = normalize((viewMatrix* (vec4(metalFlakes.worldNormal, 0.0))).xyz);","metal.normal = normal;","#ifdef PEARL_FLAKES_ACTIVATED","pearlFlakes.normal = normalize((viewMatrix * (vec4(pearlFlakes.worldNormal, 0.0))).xyz);","#endif","#else","#ifdef USE_FLAKESCOVERAGE_MAP","#ifdef NRE_COMPATIBILITY","vec2 fdUV=(flakesCoverageUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 fdUV=uvToUse;","#endif","materialData.flakesCoverage = texture2D( flakesCoverageMap, fdUV ).r;","#else","materialData.flakesCoverage = flakesCoverage;","#endif","#ifdef USE_FLAKESCOVERAGE_COEFFICIENTS","materialData.flakesCoverage = flakesCoverageMulCoef * materialData.flakesCoverage + flakesCoverageAddCoef;","#endif","#ifdef USE_FLAKESCOLOR_MAP","#ifdef NRE_COMPATIBILITY","vec2 fcUv =(flakesColorUvTransform * vec3(uvToUse, 1.0)).xy;","#else","vec2 fcUv = uvToUse;","#endif","materialData.flakesColor = texture2D( flakesColorMap, fdUV ).xyz;","#if !defined( USE_FLAKESCOLOR_LINEAR )","#ifdef NRE_COMPATIBILITY","materialData.flakesColor.x = (materialData.flakesColor.x < 0.04045)    ? (materialData.flakesColor.x/12.92) : pow((materialData.flakesColor.x + 0.055)/1.055, 2.4);","materialData.flakesColor.y = (materialData.flakesColor.y < 0.04045)    ? (materialData.flakesColor.y/12.92) : pow((materialData.flakesColor.y + 0.055)/1.055, 2.4);","materialData.flakesColor.z = (materialData.flakesColor.z < 0.04045)    ? (materialData.flakesColor.z/12.92) : pow((materialData.flakesColor.z + 0.055)/1.055, 2.4);","#else","materialData.flakesColor.rgb *= materialData.flakesColor.rgb;","#endif","#endif","#else","materialData.flakesColor = flakesColor;","#endif","#ifdef USE_FLAKESCOLOR_COEFFICIENTS","materialData.flakesColor = flakesColorMulCoef * materialData.flakesColor + flakesColorAddCoef;","#endif","#ifdef USE_FLAKESROUGHNESS_MAP","#ifdef NRE_COMPATIBILITY","vec2 frUV=(flakesRoughnessUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 frUV=uvToUse;","#endif","materialData.flakesRoughness = texture2D( flakesRoughnessMap, frUV ).r;","#if !defined( USE_FLAKESROUGHNESS_MAP_LINEAR )","materialData.flakesRoughness *= materialData.flakesRoughness;","#endif","materialData.flakesRoughness = min(0.975,max(materialData.flakesRoughness, 0.0025));","#else","materialData.flakesRoughness = min(0.975,max(flakesRoughness, 0.0025));","#endif","#ifdef USE_FLAKESROUGHNESS_COEFFICIENTS","materialData.flakesRoughness = flakesRoughnessMulCoef * materialData.flakesRoughness + flakesRoughnessAddCoef;","#endif","#ifdef USE_FLAKESSIZE_MAP","#ifdef NRE_COMPATIBILITY","vec2 fsUV=(flakesSizeUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 fsUV=uvToUse;","#endif","materialData.flakesSize = texture2D( flakesSizeMap, fsUV ).r;","#else","materialData.flakesSize = flakesSize;","#endif","#ifdef USE_FLAKESSIZE_COEFFICIENTS","materialData.flakesSize = flakesSizeMulCoef * materialData.flakesSize + flakesSizeAddCoef;","#endif","initFlakesData(vObjectSpacePosition, normalize(vObjectNormal),materialData.flakesSize, materialData.flakesCoverage);","#endif","#endif"].join("\n");j.ShaderChunk.sheen_lights_physicalDS_fragment=["#ifdef USE_SHEEN","#ifdef USE_SHEEN_MAP","#ifdef NRE_COMPATIBILITY","vec2 sheenUV=(sheenUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 sheenUV=uvToUse;","#endif","materialData.sheen = texture2D( sheenMap, sheenUV ).r;","#else","materialData.sheen =  sheen;","#endif","#ifdef USE_SHEEN_COEFFICIENTS","materialData.sheen = sheenMulCoef * materialData.sheen + sheenAddCoef;","#endif","#endif",].join("\n");j.ShaderChunk.specular_lights_physicalDS_fragment=["#ifdef PDSFX","vec3 specularColor = _DSspecular;","#else","vec3 specularColor = specular;","#endif","#ifdef USE_SPECULARMAP","#if !defined( USE_SPECULARMAP_LINEAR )","#ifdef NRE_COMPATIBILITY","texelSpecular.x = (texelSpecular.x < 0.04045)    ? (texelSpecular.x/12.92) : pow((texelSpecular.x + 0.055)/1.055, 2.4);","texelSpecular.y = (texelSpecular.y < 0.04045)    ? (texelSpecular.y/12.92) : pow((texelSpecular.y + 0.055)/1.055, 2.4);","texelSpecular.z = (texelSpecular.z < 0.04045)    ? (texelSpecular.z/12.92) : pow((texelSpecular.z + 0.055)/1.055, 2.4);","#else","texelSpecular.rgb *= texelSpecular.rgb;","#endif","#endif","specularColor = texelSpecular.rgb;","#endif","#ifdef USE_SPECULAR_COEFFICIENTS","specularColor.xyz = specularMulCoef*specularColor.xyz + specularAddCoef;","#endif","#ifdef PDSFX","_DSspecular_ = specularColor;","specularColor = ComputeSpecularReflectance();","#endif",].join("\n");j.ShaderChunk.roughness_lights_physicalDS_fragment=["#ifdef USE_ROUGHNESSMAP","#ifdef NRE_COMPATIBILITY","#if (ROUGHNESSMAP_UV_SLOT == 2)","vec2 roughnessUV = (roughnessUvTransform * vec3(uv2ToUse, 1.0)).xy;","#else","vec2 roughnessUV=(roughnessUvTransform * vec3( uvToUse, 1.0)).xy ;","#endif","#else","vec2 roughnessUV=uvToUse;","#endif","materialData.roughness = texture2D( roughnessMap, roughnessUV ).r;","#if !defined( USE_ROUGHNESSMAP_LINEAR )","materialData.roughness *= materialData.roughness;","#endif","materialData.roughness = min(max(materialData.roughness, 0.025),0.975);","#else","materialData.roughness = min(max(roughness, 0.025),0.975);","#endif","#ifdef USE_ROUGHNESS_COEFFICIENTS","materialData.roughness = roughnessMulCoef * materialData.roughness + roughnessAddCoef;","#endif","#ifdef USE_GLOSSINESSMAP","#ifdef NRE_COMPATIBILITY","#if (ROUGHNESSMAP_UV_SLOT == 2)","vec2 glossinessUV = (roughnessUvTransform * vec3(uv2ToUse, 1.0)).xy;","#else","vec2 glossinessUV=(roughnessUvTransform * vec3( uvToUse, 1.0)).xy ;","#endif","#else","vec2 glossinessUV=uvToUse;","#endif","float glossinessTex = texture2D( glossinessMap, glossinessUV ).r;","#if !defined( USE_ROUGHNESSMAP_LINEAR )","glossinessTex *= glossinessTex;","#endif","#ifdef USE_GLOSSINESS_COEFFICIENTS","glossinessTex = glossinessMulCoef * glossinessTex + glossinessAddCoef;","#endif","materialData.roughness = min(max(1.0-glossinessTex, 0.025),0.975);","#endif","#ifdef PDSFX","_DSroughness_ = materialData.roughness;","materialData.roughness = ComputeRoughness();","#endif",].join("\n");j.ShaderChunk.emission_lights_physicalDS_fragment=["#ifdef USE_EMISSIONCOLORMAP","#ifdef NRE_COMPATIBILITY","vec2 emissionUV=(emissionColorUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 emissionUV=uvToUse;","#endif","vec3 emissionTex = texture2D( emissionColorMap, emissionUV ).rgb;","#if !defined( USE_EMISSIONCOLORMAP_LINEAR )","#ifdef NRE_COMPATIBILITY","emissionTex.x = (emissionTex.x < 0.04045)    ? (emissionTex.x/12.92) : pow((emissionTex.x + 0.055)/1.055, 2.4);","emissionTex.y = (emissionTex.y < 0.04045)    ? (emissionTex.y/12.92) : pow((emissionTex.y + 0.055)/1.055, 2.4);","emissionTex.z = (emissionTex.z < 0.04045)    ? (emissionTex.z/12.92) : pow((emissionTex.z + 0.055)/1.055, 2.4);","#else","emissionTex *= emissionTex;","#endif","#endif","vec3 emissionColorValue = emissionTex;","#else","vec3 emissionColorValue = emissionColor;","#endif","#ifdef USE_EMISSIONCOLOR_COEFFICIENTS","emissionColorValue = emissionColorMulCoef * emissionColorValue + emissionColorAddCoef;","#endif",].join("\n");j.ShaderChunk.metalness_lights_physicalDS_fragment=["#ifdef USE_METALNESSMAP","#ifdef NRE_COMPATIBILITY","vec2 metalnessUV=(metalnessUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 metalnessUV=uvToUse;","#endif","float metalnessValue = texture2D( metalnessMap, metalnessUV ).r;","#if !defined( USE_METALNESSMAP_LINEAR )","metalnessValue *= metalnessValue;","#endif","#else","float metalnessValue = metalness;","#endif","#ifdef USE_METALNESS_COEFFICIENTS","metalnessValue = metalnessMulCoef * metalnessValue + metalnessAddCoef;","#endif",].join("\n");j.ShaderChunk.specularcontrib_lights_physicalDS_fragment=["#ifdef USE_SPECULARCONTRIBMAP","#ifdef NRE_COMPATIBILITY","vec2 specCUV=(specularContribUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 specCUV=uvToUse;","#endif","float specContrib = texture2D( specularContribMap, specCUV ).r;","#else","float specContrib = specularContrib;","#endif","#ifdef USE_SPECULARCONTRIB_COEFFICIENTS","specContrib = specularContribMulCoef * specContrib + specularContribAddCoef;","#endif",].join("\n");j.ShaderChunk.anisotropy_lights_physicalDS_fragment=["#if defined( USE_ANISOTROPY )","#ifdef USE_ANISOTROPYMAP","#ifdef NRE_COMPATIBILITY","vec2 anisotropyUV=(anisotropyUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 anisotropyUV=uvToUse;","#endif","materialData.anisotropy = texture2D(anisotropyMap, anisotropyUV).r;","#else","materialData.anisotropy = anisotropy;","#endif","#ifdef USE_ANISOTROPY_COEFFICIENTS","materialData.anisotropy = anisotropyMulCoef * materialData.anisotropy + anisotropyAddCoef;","#endif","materialData.anisotropy = min(materialData.anisotropy, 0.975);","#ifdef USE_ANISOTROPYANGLEMAP","#ifdef NRE_COMPATIBILITY","vec2 anisotropyAngleUV=(anisotropyAngleUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 anisotropyAngleUV=uvToUse;","#endif","materialData.anisotropyAngle = texture2D(anisotropyAngleMap, anisotropyAngleUV).r;","#else","materialData.anisotropyAngle = anisotropyAngle;","#endif","#ifdef USE_ANISOTROPYANGLE_COEFFICIENTS","materialData.anisotropyAngle = anisotropyAngleMulCoef * materialData.anisotropyAngle + anisotropyAngleAddCoef;","#endif","materialData.binormal = binormal;","materialData.tangent = tangent;","#endif",].join("\n");j.ShaderChunk.albedo_lights_physicalDS_fragment=["#ifdef PDSFX","vec3 albedo = _DSalbedo;","#else","vec3 albedo = diffuse;","#endif","#ifdef USE_MAP","#ifdef NRE_COMPATIBILITY","#if (DIFFUSEMAP_UV_SLOT == 2)","vec2 diffuseUV = (diffuseUvTransform * vec3(uv2ToUse, 1.0)).xy ;","#else","vec2 diffuseUV = (diffuseUvTransform * vec3(uvToUse, 1.0)).xy ;","#endif","#ifdef USE_ALPHA_FROM_MAP","float transparencyFromDiffuseMap = texture2D(map, diffuseUV).w;","#endif","#else","vec2 diffuseUV = uvToUse;","#endif","vec3 texelAlbedo = texture2D(map, diffuseUV).xyz;","#ifdef GAMMA_INPUT","#ifdef NRE_COMPATIBILITY","texelAlbedo.x = (texelAlbedo.x < 0.04045) ? (texelAlbedo.x/12.92) : pow((texelAlbedo.x + 0.055)/1.055, 2.4);","texelAlbedo.y = (texelAlbedo.y < 0.04045) ? (texelAlbedo.y/12.92) : pow((texelAlbedo.y + 0.055)/1.055, 2.4);","texelAlbedo.z = (texelAlbedo.z < 0.04045) ? (texelAlbedo.z/12.92) : pow((texelAlbedo.z + 0.055)/1.055, 2.4);","#else","texelAlbedo.rgb *= texelAlbedo.rgb;","#endif","#endif","albedo = texelAlbedo;","#endif","#ifdef USE_DIFFUSE_COEFFICIENTS","albedo = albedo * diffuseMulCoef + diffuseAddCoef;","#endif","#ifdef PDSFX","_DSalbedo_ = albedo;","albedo = ComputeAlbedo();","#endif",].join("\n");j.ShaderChunk.total_lights_physicalDS_fragment=["vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#if MAX_IES_LIGHTS > 0","totalDiffuse += iesDiffuse;","totalSpecular += iesSpecular;","#endif","#if MAX_SPHERE_LIGHTS > 0","totalDiffuse += sphereDiffuse;","totalSpecular += sphereSpecular;","#endif","#if MAX_DISK_LIGHTS > 0","totalDiffuse += diskDiffuse;","totalSpecular += diskSpecular;","#endif","#if MAX_TUBE_LIGHTS > 0","totalDiffuse += tubeDiffuse;","totalSpecular += tubeSpecular;","#endif","#if MAX_AREA_LIGHTS > 0","totalDiffuse += areaDiffuse;","totalSpecular += areaSpecular;","#endif","#if defined(USE_LIGHTMAP) && defined(LIGHTMAP_IRRADIANCE_MODE)","totalDiffuse = vec3(0.0);","totalSpecular *= clamp(aoValue, 0.0, 1.0);","#endif","#ifndef SPECGLOSS","totalSpecular /= transToDivide;","#endif",].join("\n");j.ShaderChunk.area_lights_physicalDS_fragment=["#if MAX_AREA_LIGHTS > 0","vec3 areaDiffuse  = vec3(0.0);","vec3 areaSpecular = vec3(0.0);","for (int i = 0; i < MAX_AREA_LIGHTS; i++) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lPosition = viewMatrix *vec4( areaLightPosition[ i ], 1.0 );","vec4 lNormal = viewMatrix *vec4( areaLightNormal[ i ], 0.0 );","float hw = 0.5*areaLightData[i].x;","float hh = 0.5*areaLightData[i].y;","vec3 up = (viewMatrix * vec4( areaLightUp[i],0.0)).xyz;","vec3 right = (viewMatrix * vec4( areaLightRight[i],0.0)).xyz;","vec3 p0 = lPosition.xyz + right * hw - up * hh;","vec3 p1 = lPosition.xyz - right * hw - up * hh;","vec3 p2 = lPosition.xyz - right * hw + up * hh;","vec3 p3 = lPosition.xyz + right * hw + up * hh;","areaRectangleLightModel(specular, diffuse, normal,viewPosition, -vViewPosition, p0,p1,p2,p3);","areaDiffuse += areaLightColor[i] * diffuse;","areaSpecular += areaLightColor[i] * specular;","}","#endif"].join("\n");j.ShaderChunk.sphere_lights_physicalDS_fragment=["#if MAX_SPHERE_LIGHTS > 0","vec3 sphereDiffuse  = vec3( 0.0 );","vec3 sphereSpecular = vec3( 0.0 );","for (int i = 0; i < MAX_SPHERE_LIGHTS; i++) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lPosition = viewMatrix * vec4( sphereLightPosition[ i ], 1.0 );","vec3 lNormal = -viewReflect.xyz;","float r = sphereLightData[i].x;","areaSphereLightModel(specular, diffuse, normal,viewPosition, -vViewPosition,lPosition.xyz, lNormal, r);","sphereDiffuse += sphereLightColor[i]*diffuse;","sphereSpecular += sphereLightColor[i]*specular;","}","#endif"].join("\n");j.ShaderChunk.disk_lights_physicalDS_fragment=["#if MAX_DISK_LIGHTS > 0","vec3 diskDiffuse  = vec3( 0.0 );","vec3 diskSpecular = vec3( 0.0 );","for (int i = 0; i < MAX_DISK_LIGHTS; i++) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lPosition = viewMatrix * vec4( diskLightPosition[ i ], 1.0 );","vec4 lNormal = viewMatrix * vec4( diskLightNormal[ i ], 0.0 );","float r = diskLightData[i].x;","vec3 right = getGeomT(lNormal.xyz);","vec3 up = getGeomB(lNormal.xyz, right);","vec3 p0 = lPosition.xyz + right * r - up * r;","vec3 p1 = lPosition.xyz - right * r - up * r;","vec3 p2 = lPosition.xyz - right * r + up * r;","areaDiskLightModel(specular, diffuse, normal,viewPosition, -vViewPosition, p0,p1,p2);","diskDiffuse += diskLightColor[i]*diffuse;","diskSpecular += diskLightColor[i]*specular;","}","#endif"].join("\n");j.ShaderChunk.tube_lights_physicalDS_fragment=["#if MAX_TUBE_LIGHTS > 0","vec3 tubeDiffuse  = vec3( 0.0 );","vec3 tubeSpecular = vec3( 0.0 );","for (int i = 0; i < MAX_TUBE_LIGHTS; i++) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lPosition = viewMatrix * vec4( tubeLightPosition[ i ], 1.0 );","float lRadius = tubeLightData[i].x;","float lWidth = tubeLightData[i].y;","vec3 lRight = (viewMatrix * vec4( tubeLightRight[i],0.0)).xyz;","vec3 P0 = lPosition.xyz - lRight * lWidth * 0.5;","vec3 P1 = lPosition.xyz + lRight * lWidth * 0.5;","vec3 E = tubeLightColor[i] * illuminanceTube(P0,P1,lPosition.xyz,-vViewPosition,normal,lRight,0.5*lWidth,lRadius);","vec3 closestPoint = closestPointTube(P0,P1,normal,viewReflect,-vViewPosition.xyz, lPosition.xyz,lRadius);","doAreaLightingModel(E, diffuse, specular, normal, viewPosition, closestPoint);","tubeDiffuse += diffuse;","tubeSpecular += specular;","}","#endif"].join("\n");j.ShaderChunk.hemi_lights_physicalDS_fragment=["#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += materialData.diffuseColor * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularStrength * max( pow( hemiDotNormalHalfSky, materialData.roughness ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularStrength * max( pow( hemiDotNormalHalfGround, materialData.roughness ), 0.0 );","hemiSpecular += specular * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","}","#endif"].join("\n");j.ShaderChunk.dir_lights_physicalDS_fragment=["#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","#ifdef TRANSLUCENCY","vec3 dirTranslucency = vec3(0.0);","initDisk();","#endif","{","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ 0 ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_CASCADE","shadowExposure = getExposureCascaded(vShadowCoord,shadowMap,shadowBias,shadowMapSize);","#else","if(0<MAX_SHADOWS_DIR){","shadowExposure = getExposure(vShadowCoord[ 0 ],shadowMap[ 0 ],shadowBias[ 0 ],shadowMapSize[ 0 ]);","}","#endif","#endif","vec3 E = directionalLightColor[ 0 ] * shadowExposure;","doLightingModel(E, diffuse, specular, normal, viewPosition, lVector);","#ifdef TRANSLUCENCY","if (0 < MAX_SHADOWS) {","dirTranslucency += E * translucencyBRDF( normal, lVector, 0, viewPosition, materialData.diffuseColor, materialData.sr0Color, materialData.sr90Color);","}","#endif","dirDiffuse += diffuse ;","dirSpecular += specular;","}","if(MAX_DIR_LIGHTS>1){","for( int i = 1; i < MAX_DIR_LIGHTS; i ++ ) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_CASCADE","#else","if(i<MAX_SHADOWS_DIR){","shadowExposure = getExposure(vShadowCoord[ i ],shadowMap[ i ],shadowBias[ i ],shadowMapSize[ i ]);","}","#endif","#endif","vec3 E = directionalLightColor[ i ] * shadowExposure;","doLightingModel(E, diffuse, specular, normal, viewPosition, lVector);","#ifdef TRANSLUCENCY","if (i < MAX_SHADOWS) {","dirTranslucency += E * translucencyBRDF( normal, lVector, i, viewPosition, materialData.diffuseColor, materialData.sr0Color, materialData.sr90Color);","}","#endif","dirDiffuse += diffuse ;","dirSpecular += specular;","}","}","#endif"].join("\n");j.ShaderChunk.point_lights_physicalDS_fragment=["#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse  = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lAttenuation = 1.0;","if (pointLightPhysicalAttenuation[ i ]> 0){","lAttenuation = 1.0 / (dot(lVector,lVector) * pointLightDistance[ i ]);","}else {","if ( pointLightDistance[ i ] > 0.0 )","lAttenuation = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","}","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vPointLight[ i ].xyz );","float lAttenuation = vPointLight[ i ].w;","#endif","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP_CUBE","if (i<MAX_SHADOWS_CUBE){","shadowExposure = getExposure(shadowPointPosition[ i ],shadowMapCube[ i ],shadowBiasCube[ i ],shadowMapSizeCube[ i ],shadowNearCube[ i ],shadowFarCube[ i ]);","}","#endif","vec3 E = pointLightColor[ i ]  * lAttenuation * shadowExposure;","doLightingModel(E, diffuse, specular, normal, viewPosition, lVector);","pointDiffuse += diffuse;","pointSpecular += specular;","}","#endif"].join("\n");j.ShaderChunk.spot_lights_physicalDS_fragment=["#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse  = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lAttenuation = 1.0;","if (spotLightPhysicalAttenuation[ i ]> 0){","lAttenuation =1.0 / (dot(lVector,lVector) * spotLightDistance[ i ]);","}else {","if ( spotLightDistance[ i ] > 0.0 )","lAttenuation = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","}","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vSpotLight[ i ].xyz );","float lAttenuation = vSpotLight[ i ].w;","#endif","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP","if((i + MAX_SHADOWS_DIR)<MAX_SHADOWS){","shadowExposure = getExposure(vShadowCoord[ i + MAX_SHADOWS_DIR ],shadowMap[ i + MAX_SHADOWS_DIR ],shadowBias[ i + MAX_SHADOWS_DIR ],shadowMapSize[ i + MAX_SHADOWS_DIR ]);","}","#endif","spotEffect = 1.0 - smoothstep( spotLightInnerAngleCos[ i ],spotLightAngleCos[ i ],spotEffect );","vec3 E = spotLightColor[ i ] * lAttenuation * spotEffect * shadowExposure;","doLightingModel(E, diffuse, specular, normal, viewPosition, lVector);","spotDiffuse += diffuse;","spotSpecular += specular;","}","}","#endif"].join("\n");j.ShaderChunk.ies_lights_physicalDS_fragment=["#if MAX_IES_LIGHTS > 0","vec3 iesDiffuse  = vec3( 0.0 );","vec3 iesSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_IES_LIGHTS; i ++ ) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( iesLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( iesLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / iesLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( viesLight[ i ].xyz );","float lDistance = viesLight[ i ].w;","#endif","vec3 E = iesLightColor[ i ] * lDistance * 3.14159;","vec4 coordInIESWorld = normalize(matrixWorldInv[i] * vec4(vWorldPosition,1.0));","float stepTexture = 1.0/128.0*72.0;","const float PI = 3.14159265359;","const float invTwoPi = 1.0/PI;","float phi = acos(-coordInIESWorld.z)/3.14159;","float theta = myAtan2(coordInIESWorld.x,-coordInIESWorld.y)*invTwoPi;","if(theta<0.0) theta *= -1.0;","E *= texture2D(iesLightTexture[i],vec2(phi,theta)).x;","doLightingModel(E, diffuse, specular, normal, viewPosition, lVector);","iesDiffuse  += diffuse;","iesSpecular += specular;","}","#endif"].join("\n");j.ShaderChunk.lights_physicalDS_fragment=["vec3 viewPosition;","if (projectionMatrix[3][3] > 0.5) {","viewPosition = vec3(0.0,0.0,1.0);","} else {","viewPosition = normalize( vViewPosition );","}","#ifdef PDSFX","vec3 viewNormal = _DSvNormal;","#else","vec3 viewNormal = normalize( vNormal );","#endif","#ifdef DOUBLE_SIDED","viewNormal = viewNormal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif",j.ShaderChunk.normal_lights_physicalDS_fragment,"#ifdef USE_SUBSURFACE","materialData.curvature = length(fwidth(worldNoMapNormal)) / length(fwidth(vObjectSpacePosition));","#endif",j.ShaderChunk.cc_lights_physicalDS_fragment,j.ShaderChunk.flakes_lights_physicalDS_fragment,j.ShaderChunk.specular_lights_physicalDS_fragment,j.ShaderChunk.albedo_lights_physicalDS_fragment,j.ShaderChunk.roughness_lights_physicalDS_fragment,j.ShaderChunk.emission_lights_physicalDS_fragment,j.ShaderChunk.metalness_lights_physicalDS_fragment,j.ShaderChunk.sheen_lights_physicalDS_fragment,j.ShaderChunk.specularcontrib_lights_physicalDS_fragment,"#ifdef USE_LIGHTMAP","#if (LIGHTMAP_UV_SLOT == 2)","vec3 aoValue = texture2D(lightMap, uv2ToUse).rgb;","#else","vec3 aoValue = texture2D(lightMap, uvToUse).rgb;","#endif","#ifndef USE_LIGHTMAP_LINEAR","aoValue *= aoValue;","#endif","#endif",j.ShaderChunk.anisotropy_lights_physicalDS_fragment,"#ifdef GAS_LOOK","normal = perturbNormalGasLook(normal, vWorldPosition);","#endif","float NoV = clamp(dot(normal, viewPosition), 0.0, 1.0);","materialData.ior = ior;","float F0 = (materialData.ior - 1.0)/(materialData.ior + 1.0);","F0 *= F0;","materialData.sr0Color = (1.0 - metalnessValue) * F0 * specContrib  * specularColor + metalnessValue * albedo;","materialData.sr90Color = vec3(1.0) * ((1.0-metalnessValue)*specContrib + metalnessValue);",j.ShaderChunk.transparency_lights_physicalDS_fragment,j.ShaderChunk.cutout_lights_physicalDS_fragment,"#ifdef SPECGLOSS","materialData.diffuseColor = albedo;","#else","materialData.diffuseColor = albedo * (1.0 - metalnessValue) * (1.0 - trans);","#endif","#ifdef USE_LIGHTING",j.ShaderChunk.spot_lights_physicalDS_fragment,j.ShaderChunk.ies_lights_physicalDS_fragment,j.ShaderChunk.point_lights_physicalDS_fragment,j.ShaderChunk.dir_lights_physicalDS_fragment,j.ShaderChunk.hemi_lights_physicalDS_fragment,"#ifdef HAS_AREA_LIGHTS","vec3 viewReflect = reflect(-viewPosition, normal);","setAreaGGXData(materialData.roughness, NoV,areaData.fresnel, areaData.Minv);","#ifdef CLEAR_COAT","setAreaGGXData(materialData.clearCoatR, saturate(dot(materialData.clearCoatNormal,viewPosition)),areaData.fresnelCC, areaData.MinvCC);","#endif","#ifdef USE_SHEEN","#ifdef USE_VELVET","setAreaSheenData(sqrt(materialData.sheen), NoV, areaData.MinvSheen);","#else","setAreaSheenData(0.3, NoV, areaData.MinvSheen);","#endif","#endif","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","setAreaGGXData(metal.roughness, saturate(dot(metal.normal,viewPosition)),areaData.fresnelMetal, areaData.MinvMetal);","setAreaGGXData(metalFlakes.roughness, saturate(dot(metalFlakes.normal,viewPosition)),areaData.fresnelMetalFlakes, areaData.MinvMetalFlakes);","#ifdef PEARL_FLAKES_ACTIVATED","setAreaGGXData(pearlFlakes.roughness, saturate(dot(pearlFlakes.normal,viewPosition)),areaData.fresnelPearlFlakes, areaData.MinvPearlFlakes);","#endif","#else","setAreaGGXData(materialData.flakesRoughness, NoV,areaData.fresnelMetal, areaData.MinvMetal);","#endif","#endif","#endif",j.ShaderChunk.area_lights_physicalDS_fragment,j.ShaderChunk.sphere_lights_physicalDS_fragment,j.ShaderChunk.tube_lights_physicalDS_fragment,j.ShaderChunk.disk_lights_physicalDS_fragment,j.ShaderChunk.total_lights_physicalDS_fragment,"#ifdef TEXTURE_BLENDING","vec4 texture = vec4( 1.0 );","#ifdef USE_MAP","texture = texelColor;","#endif","#if TEXTURE_BLENDING == 3","#if TEXTURE_FORMAT == 1021","gl_FragColor.a = texture.a;","#endif","#else","#if TEXTURE_BLENDING == 1","gl_FragColor.xyz = texture.xyz * totalDiffuse  + totalSpecular;","#endif","#if TEXTURE_BLENDING == 0","gl_FragColor.xyz = (1.0-texture.a) * totalDiffuse + totalSpecular + texture.a * texture.xyz;","#endif","#if TEXTURE_BLENDING == 2","gl_FragColor.xyz = (1.0-texture.xyz) * totalDiffuse + totalSpecular + texture.xyz;","#endif","#endif","#else","gl_FragColor.xyz = totalDiffuse + totalSpecular;","#endif","#endif","vec3 totalEmission = doEmission(NoV, emissionColorValue, emissionValue);",].join("\n");j.ShaderChunk.position_pars_vertex=["#if defined(USE_FLAKES) || defined(USE_ORANGE_PEEL) || defined(USE_SUBSURFACE) ","varying vec3 vObjectSpacePosition;","varying vec3 vObjectNormal;","#endif"].join("\n");j.ShaderChunk.position_vertex=["#if defined(USE_FLAKES) || defined(USE_ORANGE_PEEL) || defined(USE_SUBSURFACE) ","vObjectSpacePosition = position.xyz;","vObjectNormal = objectNormal.xyz;","#endif"].join("\n");j.ShaderChunk.noise_pars_fragment=["#if defined (GAS_LOOK) || defined (USE_FLAKES) || defined (USE_ORANGE_PEEL)","vec4 mod289(vec4 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec3 mod289(vec3 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec2 mod289(vec2 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec3 permute(vec3 x) {","  return mod289(((x*34.0)+1.0)*x);","}","vec4 permute(vec4 x) {","	return mod289(((x*34.0)+1.0)*x);","}","vec4 taylorInvSqrt(vec4 r) {","	return 1.79284291400159 - 0.85373472095314 * r;","}","float snoise(vec3 v) {","const vec2  C = vec2(1.0/6.0, 1.0/3.0);","const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);","vec3 i  = floor(v + dot(v, C.yyy) );","vec3 x0 =   v - i + dot(i, C.xxx) ;","vec3 g = step(x0.yzx, x0.xyz);","vec3 l = 1.0 - g;","vec3 i1 = min( g.xyz, l.zxy );","vec3 i2 = max( g.xyz, l.zxy );","vec3 x1 = x0 - i1 + C.xxx;","vec3 x2 = x0 - i2 + C.yyy;","vec3 x3 = x0 - D.yyy;","i = mod289(i);","vec4 p = permute( permute( permute( i.z + vec4(0.0, i1.z, i2.z, 1.0 )) + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));","float n_ = 0.142857142857;","vec3  ns = n_ * D.wyz - D.xzx;","vec4 j = p - 49.0 * floor(p * ns.z * ns.z);","vec4 x_ = floor(j * ns.z);","vec4 y_ = floor(j - 7.0 * x_ );","vec4 x = x_ *ns.x + ns.yyyy;","vec4 y = y_ *ns.x + ns.yyyy;","vec4 h = 1.0 - abs(x) - abs(y);","vec4 b0 = vec4( x.xy, y.xy );","vec4 b1 = vec4( x.zw, y.zw );","vec4 s0 = floor(b0)*2.0 + 1.0;","vec4 s1 = floor(b1)*2.0 + 1.0;","vec4 sh = -step(h, vec4(0.0));","vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy;","vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww;","vec3 p0 = vec3(a0.xy,h.x);","vec3 p1 = vec3(a0.zw,h.y);","vec3 p2 = vec3(a1.xy,h.z);","vec3 p3 = vec3(a1.zw,h.w);","vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));","p0 *= norm.x;","p1 *= norm.y;","p2 *= norm.z;","p3 *= norm.w;","vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);","m = m * m;","return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) ) );","}","#endif","#if defined(USE_FLAKES) || defined(USE_ORANGE_PEEL)","#define NBOCTAVES 10","float getMean(in float LODLevel) {","float mult = 1.8;","float LOD = 3.0;","float oldLOD = 0.0;","for (int i = NBOCTAVES - 1 ; i >=0; i--) {","float pente = 1.0 / (LOD - oldLOD);","float origine = float(i) + 1.0 + oldLOD * pente;","if (LODLevel <= LOD) {","return origine - pente * LODLevel;","}","oldLOD = LOD;","LOD *= mult;","}","return 0.0;","}","float FBM(vec3 iVector)","{","vec3 vector = iVector;","float res = 0.0;","float amplitude = 1.0;","float sum = 0.0;","for (int octave = 0; octave < 1; octave++) {","if (amplitude < 10.0 * kEpsilon) {","break;","}","vector = vector * 2.0;","sum += amplitude;","res += snoise(vector) * amplitude;","amplitude *= 0.5;","}","return clamp(res/sum,-1.0,1.0);","}","float arrayFBMMixer(in vec3 iVector, in float LODLevel, in float frequency, in float low, in float up)","{","vec3 vector = iVector;","float res = 0.0;","float sum = 0.0;","float variance = 1.5;","float mean = getMean(LODLevel);","float amplitude;","int minIndex = int(max(0.0, mean - low));","int maxIndex = int(min(float(NBOCTAVES), mean + up));","frequency *= pow(1.8, float(minIndex));","int octave = minIndex;","for (int i = 0; i < 10 ; i++) {","if (octave >= maxIndex) {break;}","vec3 vec = vector * frequency;","frequency *= 1.8;","amplitude = gaussian(float(octave), mean, variance);","sum += amplitude;","res += snoise(vec) * amplitude;","octave++;","}","return clamp(res/sum,-1.0,1.0);","}","#endif"].join("\n");j.ShaderChunk.utility_pars_fragment=["#if defined(USE_FLAKES) || defined(USE_ORANGE_PEEL) || defined(USE_SUBSURFACE) ","varying vec3 vObjectSpacePosition;","varying vec3 vObjectNormal;","#endif","const float kEpsilon = 0.00001;","vec3 getGeomT(in vec3 N) {","vec3 normN = normalize(N);","float x = normN.x;","float y = normN.y;","float z = normN.z;","vec3 T = vec3(0.0);","if ( abs(z) > 0.0) {","T.y += 0.0;","T.x += 1.0;","T.z += - x / z;","return normalize(T);","}","if ( abs(y) > 0.0) {","T.x += 0.0;","T.z += 1.0;","T.y += - z / y;","return normalize(T);","}","if ( abs(x) > 0.0) {","T.z += 0.0;","T.y += 1.0;","T.x += - y / x;","return normalize(T);","}","return vec3(0.0);","}","vec3 getGeomB(in vec3 N, in vec3 T) {","N = normalize(N);","T = normalize(T);","return normalize(cross(N,T));","}","float myAtan2(float y,float x){","float absx, absy, val;","float pi = 3.14159265359;","float ret;","if (x == 0.0 && y == 0.0) return 0.0;","absy = y < 0.0 ? -y : y;","if(y < 0.0) absy = -y;","else absy = y;","absx = x < 0.0 ? -x : x;","if (absy - absx == absy) return y < 0.0 ? -pi*0.5 : pi*0.5;","if (absx - absy == absx) val = 0.0;","else val = atan(y/x);","if (x > 0.0) return val;","if (y < 0.0) return val - pi;","return val + pi;","}","#define INV_GOLDEN_RATIO 0.6180339887","vec2 Hammersley2D(int i, int N)","{","return vec2((float(i) + 0.5) / float(N), fract(float(i) * INV_GOLDEN_RATIO));","}","vec3 TangentToWorldGeom(vec3 Vec, vec3 TangentZ) {","vec3 TangentX = getGeomT(TangentZ);","vec3 TangentY = getGeomB(TangentZ, TangentX);","return TangentX * Vec.x + TangentY * Vec.y + TangentZ * Vec.z;","}","vec3 TangentToWorld(vec3 Vec, vec3 TangentZ) {","vec3 UpVector = abs(TangentZ.x) < 0.999 ? vec3(0,0,1) : vec3(1,0,0);","vec3 TangentX = normalize(cross(UpVector, TangentZ));","vec3 TangentY = cross(TangentZ, TangentX);","return TangentX * Vec.x + TangentY * Vec.y + TangentZ * Vec.z;","}","vec3 ImportanceSampleGGX(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * 3.14159265359 * Xi.x;","float a = roughness * roughness;","float a2 = a * a;","float CosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a2 - 1.0) * Xi.y));","float SinTheta = sqrt(1.0 - CosTheta * CosTheta);","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return H;","}","float modI(float a, float b) {","float m = a - floor((a+0.5)/b)*b;","return floor(m+0.5);","}","int modI(int a, int b) {","return int(modI(float(a), float(b)));","}","float vRound(float a) {","return floor(a + 0.5);","}","float vMax(in vec2 v) {","return max(v.x,v.y);","}","float vMax(in vec3 v) {","return max(vMax(v.xy),v.z);","}","float vMax(in vec4 v) {","return max(vMax(v.xy),vMax(v.zw));","}","float vMin(in vec2 v) {","return min(v.x,v.y);","}","float vMin(in vec3 v) {","return min(vMin(v.xy),v.z);","}","float vMin(in vec4 v) {","return min(vMin(v.xy),vMin(v.zw));","}","float affine(in float value, in float value0, in float value1) {","return value * (value1 - value0) + value0;","}","float toTexCoord(in float x, in float minValue, in float maxValue) {","return clamp((clamp(x, minValue, maxValue) - minValue) / (maxValue - minValue),0.0,1.0);","}","vec2 toTexCoord(in vec2 x, in vec2 minValue, in vec2 maxValue) {","return clamp((clamp(x, minValue, maxValue) - minValue) / (maxValue - minValue),0.0,1.0);","}","vec3 toTexCoord(in vec3 x, in vec3 minValue, in vec3 maxValue) {","return clamp((clamp(x, minValue, maxValue) - minValue) / (maxValue - minValue),0.0,1.0);","}","vec4 toTexCoord(in vec4 x, in vec4 minValue, in vec4 maxValue) {","return clamp((clamp(x, minValue, maxValue) - minValue) / (maxValue - minValue),0.0,1.0);","}","float zeroSphericalHarmonics() {","return sqrt(0.31830988618) / 2.0;","}","bool vIsnan( float val )","{","return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;","}","vec2 vNormalize( vec2 val )","{","if (length(val) < 1e-6) {","return vec2(0.0);","}","return normalize(val);","}","vec3 vNormalize( vec3 val )","{","if (length(val) < 1e-6) {","return vec3(0.0);","}","return normalize(val);","}","vec4 vNormalize( vec4 val )","{","if (length(val) < 1e-6) {","return vec4(0.0);","}","return normalize(val);","}","mat3 transposeMatrix(in mat3 m) {","mat3 mT;","mT[0] = vec3(m[0][0], m[1][0], m[2][0]);","mT[1] = vec3(m[0][1], m[1][1], m[2][1]);","mT[2] = vec3(m[0][2], m[1][2], m[2][2]);","return mT;","}","float gaussian(in float x, in float mean, in float variance) ","{","float value = x - mean;","value *= value;","value /= 2.0 * variance;","return exp(-value);","}","float saturate(in float iValue)","{","return clamp(iValue, 0.0, 1.0);","}","vec2 saturate(in vec2 iValue)","{","return clamp(iValue, vec2(0.0), vec2(1.0));","}","vec3 saturate(in vec3 iValue)","{","return clamp(iValue, vec3(0.0), vec3(1.0));","}","vec4 saturate(in vec4 iValue)","{","return clamp(iValue, vec4(0.0), vec4(1.0));","}","float pow2(in float iValue)","{","return iValue*iValue;","}","float pow3(in float iValue)","{","return pow2(iValue) * iValue;","}","float pow4(in float iValue)","{","float tmp = pow2(iValue);","return pow2(tmp);","}","float pow5(in float iValue)","{","float tmp = pow4(iValue);","return tmp * iValue;","}","float pow6(in float iValue)","{","float tmp = pow2(iValue);","float tmp2 = pow2(tmp);","return tmp * tmp2;","}","float fma(in float x, in float y, in float z) {","return x*y + z;","}","vec3 fma(in vec3 x, in vec3 y, in vec3 z) {","return x*y + z;","}","vec2 fma(in vec2 x, in vec2 y, in vec2 z) {","return x*y + z;","}","vec4 fma(in vec4 x, in vec4 y, in vec4 z) {","return x*y + z;","}","vec3 Rotate3D(in vec3 iVec, in float iAngle, in vec3 iAxe) {","float s = sin(iAngle);","float c = cos(iAngle);","float x = iAxe.x;","float y = iAxe.y;","float z = iAxe.z;","mat3 rot = mat3(pow2(x) * (1.0 - c) + c, x * y * (1.0 - c) - z * s, x * z * (1.0 - c) + y * s,","x * y * (1.0 - c) + z * s, pow2(y) * (1.0 - c) + c, y * z * (1.0 - c) - x * s,","x * z * (1.0 - c) - y * s, y * z * (1.0 - c) + x * s, pow2(z) * (1.0 - c) + c);","return rot * iVec;","}",].join("\n");j.ShaderChunk.postshadowmap_fragment=["#ifdef USE_LIGHTING","#ifdef TRANSLUCENCY","#ifndef SPECGLOSS","dirTranslucency /= transToDivide;","#endif","gl_FragColor.xyz += dirTranslucency;","#endif","#endif","gl_FragColor.xyz += totalEmission;",].join("\n");j.ShaderLib.physicalDS={uniforms:j.UniformsUtils.merge([j.UniformsLib.common,j.UniformsLib.bump,j.UniformsLib.normalmap,j.UniformsLib.fog,j.UniformsLib.lights,j.UniformsLib.shadowmap,j.UniformsLib.clipPlanes,j.UniformsLib.skinning,{prevColorTexture:{type:"t",value:null},prevNormalDepthTexture:{type:"t",value:null},screenSize:{type:"v2",value:new j.Vector2()},invScreenSize:{type:"v2",value:new j.Vector2()},normalUvTransform:{type:"m3",value:new j.Matrix3()},diffuseUvTransform:{type:"m3",value:new j.Matrix3()},diffuseMulCoef:{type:"v3",value:new j.Vector3()},diffuseAddCoef:{type:"v3",value:new j.Vector3()},specular:{type:"c",value:new j.Color(16777215)},specularUvTransform:{type:"m3",value:new j.Matrix3()},specularAddCoef:{type:"v3",value:new j.Vector3()},specularMulCoef:{type:"v3",value:new j.Vector3()},metalness:{type:"f",value:1},metalnessMap:{type:"t",value:null},metalnessUvTransform:{type:"m3",value:new j.Matrix3()},metalnessAddCoef:{type:"f",value:1},metalnessMulCoef:{type:"f",value:0},specularContrib:{type:"f",value:1},specularContribMap:{type:"t",value:null},specularContribUvTransform:{type:"m3",value:new j.Matrix3()},specularContribMulCoef:{type:"f",value:1},specularContribAddCoef:{type:"f",value:0},emissionColor:{type:"c",value:new j.Color(0)},emissionColorMap:{type:"t",value:null},emissionColorUvTransform:{type:"m3",value:new j.Matrix3()},emissionColorMulCoef:{type:"v3",value:new j.Vector3()},emissionColorAddCoef:{type:"v3",value:new j.Vector3()},emissionValue:{type:"f",value:0},transparency:{type:"f",value:0},transparencyMap:{type:"t",value:null},transparencyUvTransform:{type:"m3",value:new j.Matrix3()},transparencyMulCoef:{type:"f",value:1},transparencyAddCoef:{type:"f",value:0},opacity:{type:"f",value:0},opacityMap:{type:"t",value:null},opacityUvTransform:{type:"m3",value:new j.Matrix3()},opacityMulCoef:{type:"f",value:1},opacityAddCoef:{type:"f",value:0},ior:{type:"f",value:1.4},roughness:{type:"f",value:0},roughnessMap:{type:"t",value:null},glossinessMap:{type:"t",value:null},glossinessMulCoef:{type:"f",value:1},glossinessAddCoef:{type:"f",value:0},roughnessUvTransform:{type:"m3",value:new j.Matrix3()},roughnessMulCoef:{type:"f",value:1},roughnessAddCoef:{type:"f",value:0},anisotropy:{type:"f",value:0},anisotropyMap:{type:"t",value:null},anisotropyUvTransform:{type:"m3",value:new j.Matrix3()},anisotropyMulCoef:{type:"f",value:1},anisotropyAddCoef:{type:"f",value:0},anisotropyAngle:{type:"f",value:0},anisotropyAngleMap:{type:"t",value:null},anisotropyAngleUvTransform:{type:"m3",value:new j.Matrix3()},anisotropyAngleMulCoef:{type:"f",value:1},anisotropyAngleAddCoef:{type:"f",value:0},displacementMap:{type:"t",value:null},displacementBias:{type:"f",value:0},displacementScale:{type:"f",value:0},reflectionProbe:{type:"t",value:null},reflectionProbeMips:{type:"t",value:null},reflectionProbeProxyMin:{type:"v3",value:new j.Vector3()},reflectionProbeProxyMax:{type:"v3",value:new j.Vector3()},reflectionProbePos:{type:"v3",value:new j.Vector3()},envMapSheen:{type:"t",value:null},sheen:{type:"f",value:0},sheenMap:{type:"t",value:null},sheenUvTransform:{type:"m3",value:new j.Matrix3()},sheenMulCoef:{type:"f",value:1},sheenAddCoef:{type:"f",value:0},flakesColor:{type:"c",value:new j.Color(0)},flakesBump:{type:"f",value:0},flakesDensity:{type:"f",value:0},flakesScale:{type:"f",value:0},flakesRoughness:{type:"f",value:0},flakesColorMulCoef:{type:"v3",value:new j.Vector3()},flakesColorAddCoef:{type:"v3",value:new j.Vector3()},pearlFlakesColor:{type:"c",value:new j.Color(0)},pearlFlakesDensity:{type:"f",value:0},pearlFlakesBump:{type:"f",value:0},pearlFlakesColorMulCoef:{type:"v3",value:new j.Vector3()},pearlFlakesColorAddCoef:{type:"v3",value:new j.Vector3()},flakesColorMap:{type:"t",value:null},flakesColorUvTransform:{type:"m3",value:new j.Matrix3()},flakesCoverage:{type:"f",value:0},flakesCoverageUvTransform:{type:"m3",value:new j.Matrix3()},flakesCoverageyMap:{type:"t",value:null},flakesCoverageMulCoef:{type:"f",value:1},flakesCoverageAddCoef:{type:"f",value:0},flakesSize:{type:"f",value:0},flakesSizeUvTransform:{type:"m3",value:new j.Matrix3()},flakesSizeMap:{type:"t",value:null},flakesSizeMulCoef:{type:"f",value:1},flakesSizeAddCoef:{type:"f",value:0},flakesRoughnessUvTransform:{type:"m3",value:new j.Matrix3()},flakesRoughnessMap:{type:"t",value:null},flakesRoughnessMulCoef:{type:"f",value:1},flakesRoughnessAddCoef:{type:"f",value:0},sphereCenter:{type:"v3",value:new j.Vector3()},projectionCenter:{type:"v3",value:new j.Vector3()},sphereRadius:{type:"f",value:0},clearCoat:{type:"f",value:0},clearCoatMap:{type:"t",value:null},clearCoatUvTransform:{type:"m3",value:new j.Matrix3()},clearCoatMulCoef:{type:"f",value:1},clearCoatAddCoef:{type:"f",value:0},clearCoatRoughness:{type:"f",value:0},clearCoatRoughnessMap:{type:"t",value:null},clearCoatRoughnessUvTransform:{type:"m3",value:new j.Matrix3()},clearCoatRoughnessMulCoef:{type:"f",value:1},clearCoatRoughnessAddCoef:{type:"f",value:0},coatingGlossinessMap:{type:"t",value:null},coatingGlossinessMulCoef:{type:"f",value:1},coatingGlossinessAddCoef:{type:"f",value:0},clearCoatNormalMap:{type:"t",value:null},clearCoatNormalpUvTransform:{type:"m3",value:new j.Matrix3()},clearCoatNormalScale:{type:"f",value:1},orangePeelScale:{type:"f",value:0},precomputedTexture1:{type:"t",value:null},precomputedTexture2:{type:"t",value:null},precomputedTexture3:{type:"t",value:null},envMap2:{type:"t",value:null},sssLUT:{type:"t",value:null},sssIBLLUT:{type:"t",value:null},translucencyLUT:{type:"t",value:null},translucencyScale:{type:"f",value:1}}]),vertexShader:["#define PHYSICALDS","#ifndef PDSFX","varying vec3 vViewPosition;","#endif","varying vec3 vNormal;",j.ShaderChunk.clip_pars_vertex,j.ShaderChunk.map_pars_vertex_physical,j.ShaderChunk.envmap_pars_vertex,j.ShaderChunk.lights_physicalDS_pars_vertex,j.ShaderChunk.shadowmap_pars_vertex,j.ShaderChunk.tangent_Binormal_pars,j.ShaderChunk.skinning_pars_vertex,j.ShaderChunk.position_pars_vertex,j.ShaderChunk.oit_pars_vertex,"void main() {",j.ShaderChunk.PDSFX_start_vertex,j.ShaderChunk.skinbase_vertex,j.ShaderChunk.skinnormal_vertex,j.ShaderChunk.skinning_vertex,j.ShaderChunk.map_vertex_physical,j.ShaderChunk.defaultnormal_vertex,j.ShaderChunk.tangent_Binormal_vertex,"vNormal = normalize( transformedNormal );",j.ShaderChunk.displacement_vertex,j.ShaderChunk.default_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif",j.ShaderChunk.clip_vertex,"#ifndef PDSFX","vViewPosition = -mvPosition.xyz;","#endif",j.ShaderChunk.worldpos_vertex,j.ShaderChunk.envmap_vertex,j.ShaderChunk.lights_physicalDS_vertex,j.ShaderChunk.shadowmap_vertex,j.ShaderChunk.position_vertex,j.ShaderChunk.oit_vertex,j.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:["#define PHYSICALDS","struct matData","{","float roughness;","vec3 diffuseColor;","vec3 sr0Color;","vec3 sr90Color;","float ior;","#ifdef USE_ANISOTROPY","vec3 tangent;","vec3 binormal;","float anisotropy;","float anisotropyAngle;","#endif","#ifdef USE_SHEEN","float sheen;","#endif","#ifdef CLEAR_COAT","float clearCoat;","vec3 clearCoatNormal;","float clearCoatR;","#endif","#ifdef USE_SUBSURFACE","float curvature;","#endif","#if defined(USE_FLAKES) && !defined(OLD_FLAKES)","vec3 flakesColor;","float flakesSize;","float flakesCoverage;","float flakesRoughness;","#endif","};","matData materialData;","varying vec3 vWorldNormal;","varying vec3 vWorldPosition;","#ifndef PDSFX","varying vec3 vViewPosition;","#else","	vec3 vViewPosition;","#endif","varying vec3 vNormal;",j.ShaderChunk.clip_pars_fragment,j.ShaderChunk.map_pars_fragment_physical,j.ShaderChunk.madCoefficients_pars_fragment,j.ShaderChunk.envmap_pars_fragment,j.ShaderChunk.fog_pars_fragment,j.ShaderChunk.iterative_pars_fragment,j.ShaderChunk.utility_pars_fragment,j.ShaderChunk.noise_pars_fragment,j.ShaderChunk.bumpmap_pars_fragment,j.ShaderChunk.normalmap_pars_fragment,j.ShaderChunk.IBL_pars_fragment,j.ShaderChunk.lights_physicalDS_pars_fragment,j.ShaderChunk.specularmap_pars_fragment,j.ShaderChunk.tangent_Binormal_pars,j.ShaderChunk.oit_pars_fragment,"void main() {","#ifdef PDSFX",j.ShaderChunk.PDSFX_map_fragment,"ComputeCommonValues();",j.ShaderChunk.PDSFX_discard_fragment,j.ShaderChunk.PDSFX_viewNormal_fragment,"vViewPosition = -ComputeViewPosition();","#endif","gl_FragColor = vec4( vec3 ( 1.0 ), 1.0 );",j.ShaderChunk.clip_fragment,j.ShaderChunk.uvmapping_fragment_physical,j.ShaderChunk.tangent_Binormal_fragment,j.ShaderChunk.specularmap_fragment,j.ShaderChunk.lights_physicalDS_fragment,j.ShaderChunk.alphatest_fragment,j.ShaderChunk.stochastic_transparency_fragment,"#if defined( USE_MAP_HDR ) || defined( USE_ENVMAP_HDR )","vec2 texelSizeEnvMap = vec2(1.0 / envMapHDRSize);","#endif","#if defined(USE_ENVMAP) && defined(USE_LIGHTING)",j.ShaderChunk.IBL_fragment,j.ShaderChunk.core_IBL_fragment,"#ifdef OLD_FLAKES",j.ShaderChunk.old_flakes_IBL_fragment,j.ShaderChunk.old_pearlflakes_IBL_fragment,"#else",j.ShaderChunk.flakes_IBL_fragment,"#endif",j.ShaderChunk.coating_IBL_fragment,j.ShaderChunk.total_IBL_fragment,"#elif !defined(USE_LIGHTING)","#ifdef USE_LIGHTMAP","gl_FragColor.xyz = aoValue * materialData.diffuseColor;","#else","gl_FragColor.xyz = materialData.diffuseColor;","#endif","#else","vec3 ambientTerm = ambientLightColor;","#ifdef USE_SUBSURFACE","vec3 scattering = SssLUTSampling(materialData.curvature);","#else","vec3 scattering = vec3(1.0);","#endif","#ifdef USE_LIGHTMAP","#ifdef LIGHTMAP_IRRADIANCE_MODE","gl_FragColor.xyz += scattering * aoValue * materialData.diffuseColor;","#else","gl_FragColor.xyz += scattering * aoValue * materialData.diffuseColor  * ambientTerm;","#endif","#else","gl_FragColor.xyz += scattering * materialData.diffuseColor * ambientTerm;","#endif","#endif",j.ShaderChunk.postshadowmap_fragment,j.ShaderChunk.linear_to_gamma_fragment,j.ShaderChunk.fog_fragment,j.ShaderChunk.oit_fragment,j.ShaderChunk.PDSFX_end_fragment,"}"].join("\n")};j.TangentToWorld=function(){var m=new j.Vector3();var l=new j.Vector3();return function(n,o){var r=Math.abs(o.z)<0.999?m.set(0,0,1):m.set(1,0,0);l.crossVectors(r,o);var q=l.normalize();var p=m.crossVectors(o,q);q.multiplyScalar(n.x);p.multiplyScalar(n.y);q.add(p);p.copy(o);p.multiplyScalar(n.z);q.add(p);return q}}();j.RandomLib={};j.RandomLib._tmpVec2=new j.Vector2();j.RandomLib._tmpVec3=new j.Vector3();j.RandomLib._tmpBits=new Uint32Array(1);j.RandomLib.ReverseBits32=function(l){var l=j.RandomLib._tmpBits;l[0]=i;l[0]=((l[0]<<16)|(l[0]>>16))>>>0;l[0]=((l[0]&1431655765)<<1)|((l[0]&2863311530)>>>1)>>>0;l[0]=((l[0]&858993459)<<2)|((l[0]&3435973836)>>>2)>>>0;l[0]=((l[0]&252645135)<<4)|((l[0]&4042322160)>>>4)>>>0;l[0]=((l[0]&16711935)<<8)|((l[0]&4278255360)>>>8)>>>0;return l[0]*2.3283064365386963e-10};j.RandomLib.Hammersley=function(m,l,p,o){var n=j.RandomLib._tmpVec2;n.x=m/l;n.y=j.RandomLib.ReverseBits32(m);return n};j.RandomLib.LowDiscrepancy2D=function(m,l,p,o){var n=j.RandomLib._tmpVec2;n.x=j.RandomLib.HaltonSequence(m,2);n.y=j.RandomLib.HaltonSequence(m,5);return n};j.RandomLib.HaltonSequence=function(r,m){var q=0;var p=1/m;var o=p;while(r>0){var l=(r%m);q+=l*o;r=Math.floor(r/m);o*=p}return q};j.RandomLib.ImportanceSampleGGX=function(s,q){var r=j.RandomLib._tmpVec3;var l=q*q;var o=l*l;var n=2*Math.PI*s.x;var t=Math.sqrt((1-s.y)/(1+(o-1)*s.y));var p=Math.sqrt(1-t*t);r.x=p*Math.cos(n);r.y=p*Math.sin(n);r.z=t;return r};j.RandomLib.Hammersley2D=function(m,n){var l=(m+0.5)/n;var o=m*6180339887;o=o-Math.floor(o);return new j.Vector2(l,o)};j.RandomLib.ImportanceSampleAshikmin=function(x,q){var y=j.RandomLib._tmpVec3;var u=function(A){var B=Math.log(Math.abs(A));var r=Math.atan2(0,A);return new j.Vector2(B,r)};var o=function(r){var A=(r.x*r.x+r.y*r.y);return new j.Vector2(r.x/A,-r.y/A)};var t=2*Math.PI*x.x;var l=q;var m=l*l*l*l;var z=4*m*Math.exp(1/m)/(4*m*x.y+x.y-1);var s=m*u(z);var w=o(s);var n=Math.min(Math.sqrt(w.x*w.x+w.y*w.y),1);var v=Math.sqrt(n);var p=Math.sqrt(1-n);y.x=v*Math.cos(t);y.y=v*Math.sin(t);y.z=p;return y};j.RandomLib.ImportanceSampleCosine=function(p,n){var o=j.RandomLib._tmpVec3;var l=2*Math.PI*p.x;var m=Math.sqrt(p.y);var q=Math.sqrt(1-p.y);o.x=m*Math.cos(l);o.y=m*Math.sin(l);o.z=q;return o};j.RandomLib.ImportanceSampleBeckmann=function(t,o){var u=j.RandomLib._tmpVec3;var p=2*Math.PI*t.x;var l=o;var m=l*l*l*l;var v=8*m*Math.log(1-t.y);var s=v/(v-1);var q=Math.sqrt(s);var n=Math.sqrt(1-s);u.x=q*Math.cos(p);u.y=q*Math.sin(p);u.z=n;return u};j.RandomLib.computePreIntegratedGFTexture=function(w,C,t){var p=Date.now();var A=new j.Vector2();var z=new j.Vector3();var D=new j.Vector3();var l,B;switch(t){case"ASHIKMIN":l=j.RandomLib.ImportanceSampleAshikmin;B=function(J,N,L,y,x){var M=Math.min(0.25*Math.max(1/Math.max(L+N-N*L,0.000001),0),5);var K=4*L*y/x;return K*M};break;case"BECKMANN":l=j.RandomLib.ImportanceSampleBeckmann;B=function(J,N,L,y,x){var M=Math.min(0.25*Math.max(1/Math.max(L+N-N*L,0.000001),0),5);var K=4*L*y/x;return K*M};break;case"GGX":default:var o=function(y,M,L){var x=0.5*y*y;var K=M*(1-x)+x;var J=L*(1-x)+x;return L*M/(K*J)};l=j.RandomLib.ImportanceSampleGGX;B=function(J,N,L,y,x){var M=0.25*GeomGGX(J,N,L)/Math.max(L*N,0.000001);var K=4*L*y/x;return K*M}}var E=function(R,S,J,y){var O=D;O.x=Math.sqrt(1-S*S);O.y=0;O.z=S;var M=0;var K=0;for(var Q=0;Q<C;Q++){var W=j.RandomLib.LowDiscrepancy2D(Q,C,J,y);var X=l(W,R);var T=z.copy(X);T.multiplyScalar(2*O.dot(X));T.sub(O);var x=Math.max(0,Math.min(T.z,1));var N=Math.max(0,Math.min(X.z,1));var Y=Math.max(0,Math.min(O.dot(X),1));if(x>0){var U=B(R,S,x,Y,N);var P=Math.pow(1-Y,5);M+=(1-P)*U;K+=P*U}}A.x=M/C;A.y=K/C;return A};var m=256*256-1;var G=function(y){y*=m;var x=[Math.floor(y/256),Math.floor(y)];x[1]-=x[0]*256;x[0]=Math.min(x[0],255);x[1]=Math.min(x[1],255);return x};var F=function(x){return(x[0]*256+x[1])/m};var H=new Uint8Array(4*w*w);for(var r=0;r<w;r++){for(var s=0;s<w;s++){var u=r*w+s;var I=E(1-r/(w-1),s/(w-1),Math.floor(100000*Math.random()),Math.floor(100000*Math.random()));var n=G(I.x);var v=G(I.y);H[4*u]=n[0];H[4*u+1]=n[1];H[4*u+2]=v[0];H[4*u+3]=v[1]}}var q=Date.now();console.log((q-p)/1000);return new j.DataTexture(H,w,w,j.RGBAFormat,j.Uint8Type)};j.RandomLib.computePreIntegratedTexture=function(C,G){var E=new j.Vector4();var B=new j.Vector4();var D=new j.Vector3();var I=new j.Vector3();var l=j.RandomLib.ImportanceSampleAshikmin;var v=j.RandomLib.ImportanceSampleBeckmann;var m=function(O,S,Q,y,x){var R=0.25/Math.max(Q+S-S*Q,0.001);var P=4*Q*y/Math.max(x,0.001);return P*R};var z=function(Q,R,x){var T=Q*Q;var y=T*T;var S=Math.max(R*R,0.001);var O=Math.max(x*x,0.001);var P=Math.sqrt(1-y+y/S);var U=Math.sqrt(1-y+y/O);return 2/(P+U)};var o=j.RandomLib.ImportanceSampleGGX;var H=function(O,S,Q,y,x){var R=0.25*z(O,S,Q)/Math.max(Q*S,0.001);var P=4*Q*y/Math.max(x,0.001);return P*R};var F=function(ai,x,ae,ad){var O=I;O.x=Math.sqrt(1-x*x);O.y=0;O.z=x;var y=0;var ah=0;var U=0;var aj=0;var P=0;E.x=E.y=E.z=E.w=B.x=B.y=B.z=B.w=0;var X=0;var ag=0;var Z=0;for(var ac=0;ac<G;ac++){var ab=j.RandomLib.LowDiscrepancy2D(ac,G,ae,ad);var T=o(ab,ai);var R=D.copy(T);R.multiplyScalar(2*O.dot(T));R.sub(O);var Q=Math.max(0,Math.min(R.z,1));var S=Math.max(0,Math.min(T.z,1));var af=Math.max(0,Math.min(O.dot(T),1));if(Q>0.001){var Y=Math.pow(1-af,5);var W=H(ai,x,Q,af,S)*Q;y+=W;ah+=W*(1-Y);U+=W*Y;X+=Q}T=l(ab,ai);R=D.copy(T);R.multiplyScalar(2*O.dot(T));R.sub(O);Q=Math.max(0,Math.min(R.z,1));S=Math.max(0,Math.min(T.z,1));af=Math.max(0,Math.min(O.dot(T),1));if(Q>0.001){aj+=m(ai,x,Q,af,S)*Q;ag+=Q}T=v(ab,ai);R=D.copy(T);R.multiplyScalar(2*O.dot(T));R.sub(O);Q=Math.max(0,Math.min(R.z,1));S=Math.max(0,Math.min(T.z,1));af=Math.max(0,Math.min(O.dot(T),1));if(Q>0.001){P+=m(ai,x,Q,af,S)*Q;Z+=Q}}E.x=ah/X;E.w=aj/ag;E.z=P/Z;E.y=U/X;B.x=y/X};var q=256*256-1;var L=function(y){y*=q;var x=[Math.floor(y/256),Math.floor(y)];x[1]-=x[0]*256;x[0]=Math.min(x[0],255);x[1]=Math.min(x[1],255);return x};var K=function(x){return(x[0]*256+x[1])/q};var N=new Uint8Array(4*C*C);var r=new Uint8Array(4*C*C);var p=new Uint8Array(4*C*C);for(var t=0;t<C;t++){for(var u=0;u<C;u++){var w=t*C+u;F(1-t/(C-1),u/(C-1),Math.floor(100000*Math.random()),Math.floor(100000*Math.random()));var s=L(E.x);var A=L(E.y);var J=L(E.z);var M=L(E.w);var n=L(B.x);N[4*w]=s[0];N[4*w+1]=s[1];N[4*w+2]=A[0];N[4*w+3]=A[1];r[4*w]=J[0];r[4*w+1]=J[1];r[4*w+2]=M[0];r[4*w+3]=M[1];p[4*w]=n[0];p[4*w+1]=n[1];p[4*w+2]=0;p[4*w+3]=0}}return[new j.DataTexture(N,C,C,j.RGBAFormat,j.Uint8Type),new j.DataTexture(r,C,C,j.RGBAFormat,j.Uint8Type),new j.DataTexture(p,C,C,j.RGBAFormat,j.Uint8Type),]};j.RandomLib.computeHaltonSequence4D=function(n){var l=n*n;var o=new Float32Array(4*l);for(var m=0;m<l;m++){o[4*m]=j.RandomLib.HaltonSequence(m,2);o[4*m+1]=j.RandomLib.HaltonSequence(m,5);o[4*m+2]=j.RandomLib.HaltonSequence(m,7);o[4*m+3]=j.RandomLib.HaltonSequence(m,9)}return new j.DataTexture(o,n,n,j.RGBAFormat,j.FloatType)};j.RGB_S3TC_DXT1_Format=2001;j.RGBA_S3TC_DXT1_Format=2002;j.RGBA_S3TC_DXT3_Format=2003;j.RGBA_S3TC_DXT5_Format=2004;j.CompressedTexture=function(o,n,u,s,r,l,q,p,t,m){j.Texture.call(this,null,l,q,p,t,m,s,r);this.image={width:n,height:u};this.mipmaps=o};j.CompressedTexture.prototype=Object.create(j.Texture.prototype);j.CompressedTexture.prototype.clone=function(){var l=new j.CompressedTexture(this.mipmaps,this.image.width,this.image.height,this.format,this.type,this.mapping,this.wrapS,this.wrapT,this.magFilter,this.minFilter);l.offset.copy(this.offset);l.repeat.copy(this.repeat);return l};j.Texture.prototype.setAsLOD=function(l){this.lods=[];this.textures=[];this.usedTexture=-1;this.lastUsedTexture=-1;this.switchLODTextureCB=l};j.Texture.prototype.chooseTexture=function(m,l){if(this.switchLODTextureCB){this.usedTexture=this.switchLODTextureCB({camera:m,object:l,texture:this,lods:this.lods,bSphere:l.geometry.boundingSphere,bBox:l.geometry.boundingBox,matrix:l.matrixWorld})}else{this.usedTexture=-1}if(this.usedTexture===-1){return}var n=this.lods[this.usedTexture];if(!this.textures[this.usedTexture]&&n.loadCB){this.textures[this.usedTexture]=n.loadCB(this)}};j.LODTextureData=function(n,m,l){this.imageData=n;this.bufferData=m;this.loadCB=l};j.Object3D_backup=j.Object3D.prototype.constructor;j.Object3D_backup_proto=j.Object3D.prototype;j.Object3D=function(){j.Object3D_backup.call(this);this.orientation=0;this.boundingSphere=null;this.boundingBox=null;this.pickingID=this.getUniqueColor()};j.Object3D.prototype=j.Object3D_backup_proto;j.Object3D.prototype.constructor=j.Object3D;j.Object3D.prototype.cloneSimple=function(l){if(l===undefined){l=new j.Object3D()}l.name=this.name;l.up.copy(this.up);l.position.copy(this.position);if(l.rotation instanceof j.Vector3){l.rotation.copy(this.rotation)}l.eulerOrder=this.eulerOrder;l.scale.copy(this.scale);l.renderDepth=this.renderDepth;l.rotationAutoUpdate=this.rotationAutoUpdate;l.matrix.copy(this.matrix);l.matrixWorld.copy(this.matrixWorld);l.matrixRotationWorld.copy(this.matrixRotationWorld);l.matrixAutoUpdate=this.matrixAutoUpdate;l.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate;l.quaternion.copy(this.quaternion);l.useQuaternion=this.useQuaternion;l.visible=this.visible;l.visibilityFree=this.visibilityFree;l.castShadow=this.castShadow;l.receiveShadow=this.receiveShadow;l.frustumCulled=this.frustumCulled;l.isUniformlyScaled=this.isUniformlyScaled;return l};j.Object3D.prototype.getLookAt=function(){var l=this._getMMMatrix().elements;return new j.Vector3(-l[8],-l[9],-l[10])};var e=new j.Matrix4();j.Object3D.prototype.setMatrix=function(l,n){this.matrix=l;if(!l){this.scale.set(1,1,1);this.rotation.set(0,0,0);this.position.set(0,0,0)}else{this.scale.getScaleFromMatrix(this.matrix);var m=e.extractRotation(this.matrix);this.rotation.setEulerFromRotationMatrix(m,this.eulerOrder);this.position.getPositionFromMatrix(this.matrix)}this.isUniformlyScaled=Math.abs(this.scale.x-this.scale.y)<0.0001&&Math.abs(this.scale.z-this.scale.y)<0.0001?true:false;if(n===false){this.matrixWorldNeedsUpdate=false;this.matrixWorld=this.matrix||j.IdentityMatrix}else{this.matrixWorldNeedsUpdate=true}this._updateWorldCenterAndRadius();if(this.modelInvTranspMatrix!==null){this.modelInvTranspMatrix.getInverse(this.matrixWorld).transpose()}};j.Object3D.prototype.containsObject=function(l){var n=this;while(n.parent!==undefined){n=n.parent}var m=l.parent;if(m===undefined){return false}while(m.parent!==undefined){m=m.parent}return(m===n)};j.Object3D.prototype.containsMesh=function(l){if(l instanceof j.Mesh||l instanceof j.CSS2DNode){var m=this;while(m.parent!==undefined){m=m.parent}if(m!==undefined&&m instanceof j.Scene){if(m.__objects.has(l)){return true}}}return false};j.Object3D.prototype.containsLight=function(l){if(l instanceof j.Light){var m=this;while(m.parent!==undefined){m=m.parent}if(m!==undefined&&m instanceof j.Scene){if(m.__lights.indexOf(l)!==-1){return true}}}return false};j.Object3D.prototype.containsLensFlare=function(l){if(l instanceof j.LensFlare){var m=this;while(m.parent!==undefined){m=m.parent}if(m!==undefined&&m instanceof j.Scene){if(m.__webglFlares&&(m.__webglFlares.indexOf(l)!==-1)){return true}}}return false};j.Object3D.prototype.getMeshInstances=function(){var l=[];var p=this;while(p.parent!==undefined){p=p.parent}if(p!==undefined&&p instanceof j.Scene){var n=p.getWebGLObjects("main",0);if(!n){return l}for(var m=0;m<n.length;m++){var o=n[m].object;if(o instanceof j.Mesh){l.push(o)}}}return l};j.Object3D.prototype.recompileShaders=function(){var r,u,n;if(this instanceof j.Mesh){if(this.material!==null){this.material.needsUpdate=true;if(this.material.line){this.material.line.needsUpdate=true}if(this.material.point){this.material.point.needsUpdate=true}}if(this.userData&&this.userData.oldMaterial){this.userData.oldMaterial.needsUpdate=true;if(this.userData.oldMaterial.line){this.userData.oldMaterial.line.needsUpdate=true}if(this.userData.oldMaterial.point){this.userData.oldMaterial.point.needsUpdate=true}}if(this.layer&&this.layer.layers){for(u=0;u<this.layer.layers.length;u++){var o=this.layer.layers[u].drawableInterval.material;if(o){o.needsUpdate=true}}}if(this.material&&this.material._deferredMaterialsInit){var o=this.material._deferredMaterials;for(var r=0;r<o.length;r++){var v=o[r];if(v){v.needsUpdate=true}}}if(this.material&&this.material.line&&this.material.line._deferredMaterialsInit){var o=this.material.line._deferredMaterials;for(var r=0;r<o.length;r++){var v=o[r];if(v){v.needsUpdate=true}}}if(this.material&&this.material.point&&this.material.point._deferredMaterialsInit){var o=this.material.point._deferredMaterials;for(var r=0;r<o.length;r++){var v=o[r];if(v){v.needsUpdate=true}}}var t=null;var s=0;if(this.geometry.length>=0){t=this.geometry[0];s=this.geometry.length}else{if(this.geometry._type===2){t=this.geometry;s=1}}for(var p=0;p<s;p++){var m=t.drawingGroups;for(var q=0;q<m.length;q++){if(m[q].gas!==null){m[q].gas.needsUpdate=true}if(m[q].material!==null&&m[q].material instanceof j.Material){m[q].material.needsUpdate=true}if(m[q].gas._deferredMaterialsInit){var o=m[q].gas._deferredMaterials;for(var r=0;r<o.length;r++){var v=o[r];if(v){v.needsUpdate=true}}}}t=this.geometry[p+1]}return}for(r=0,n=this.children.length;r<n;r++){this.children[r].recompileShaders()}return};j.Object3D.prototype.getScene=function(){if(this instanceof j.Scene){return this}else{if(this.parent!=null){return this.parent.getScene()}else{return null}}};j.Object3D.prototype.getUniqueColor=function(){var l=Number(this.id).toString(16);if(this.id>=4194303){console.warn("max  number of pickingId values reached")}l="000000".substr(0,6-l.length)+l;l.toUpperCase();l="#"+l;return new j.Color(l)};j.CSS2DNode=function(m,l,n){j.Object3D.call(this);this.element=m?m:document.createElement("div");this.element.renderable=this;this.element.style.position="absolute";this.element.style.pointerEvents="auto";this.position=l?l:(this.position?this.position:new j.Vector3());this.pickable=true;this.geometry=new j.Geometry();this.geometry.boundingSphere=new j.Sphere();this.offset=n?n:(this.offset?this.offset:new j.Vector2())};j.CSS2DNode.prototype=Object.create(j.Object3D.prototype);j.Scene_backup=j.Scene.prototype.constructor;j.Scene_backup_proto=j.Scene.prototype;j.Scene=function(){j.Scene_backup.call(this);this.isBackground=false;this.colorHighlight=null;this.initWebGLObjectFrameIndex=-1;this.__webglObjects=null;this.__webglObjectsAll=null;this.__webglObjectsToDraw=null;this.__webglObjectsSharedToInit=null;this.__webglObjectsImmediate=null;this.__webglSprites=null;this.__webglFlares=null;this.renderResultIndices=null};j.Scene.prototype=j.Scene_backup_proto;j.Scene.prototype.constructor=j.Scene;j.DisplayList=function(l){this.name="";this.active=true;this.priority=0;this.zSort=j.FrontToBack;this.side=j.DoubleSide;this.clearDepth=false;this.clearStencil=false;this.useStencil=false;this.pickingPriority=false;this.depthTest=true;this.depthWrite=true;this.depthFunc=null;this.polygonOffset=false;this.polygonOffsetFactor=1;this.polygonOffsetUnits=1;this.setValues(l);this._materialList=[];this.usefulListLength=0;this._displayRangeLists={};this.hasTranspar=false;this.index=-1};j.DisplayList.prototype.addDrawable=function(s,J,r,E,B,l,p,w,G,t,A,H,z,n){var v=null;var m=s.id;if(J&&J.occurrenceRenderingOverride){v=J.occurrenceRenderingOverride;m=m+"#"+v.id}var C=this._displayRangeLists[m];if(!C){C=this._displayRangeLists[m]=new j.DisplayRangeList(s,v)}var I=false;if(s.isWideLine||s.is2DLine){if(!G){if(r&&!r.vertexIndexArray){console.warn("ComputeWideLine unavailable, make sure noMeshInRAM is inactive");return false}if(!s.pixelSize){s.pixelSize=new j.Vector2()}s.pixelSize.x=2/H.width;s.pixelSize.y=2/H.height;if(A.fullWidth&&A.pickingRatioW){s.pixelSize.x/=A.pickingRatioW;s.pixelSize.y/=A.pickingRatioH}var F=r.computeWideLine(E,s);if(r.wideLines){r.wideLines.addEventListener("dispose",t);if(s.isDashedLine){if(s.isCPUPattern){var y;if(!J.isLargeScale){J._modelViewMatrix._multiplyDoubleMatricesMV(A.matrixWorldInverse,J.matrixWorld);J._programID=J._programID|j.ProgramIDs.LARGE_SCALE;J.isLargeScale=true}y=J._modelViewMatrix;if(J._ratioData&&J._ratioData.ratio>0){y=new j.Matrix4().multiplyMatrices(A.matrixWorldInverse,J._getMMMatrix())}r.wideLines.computePixelWideLineDistances(y,A.projectionMatrix,H,z)}else{if(r.wideLines.cpuPatternMode||!r.wideLines.vertexLineDistancesArray){r.wideLines.computeWideLineDistances()}}}}if(B===E){B=F}else{var o=F.primitives[B.primitiveStart];var x=F.primitives[B.primitiveStart+B.primitiveCount-1];if(o&&x){B={start:o.start,count:x.start-o.start+x.count};var q=F.primitives[0];if(q.start!==F.start){B.start+=F.start}}}I=C.add(J,r.wideLines,F,B,l,p,w,G,n)}}else{if(s.isDashedLine&&!s.is2DLine){if(!s.pixelSize){s.pixelSize=new j.Vector2()}s.pixelSize.x=2/H.width;s.pixelSize.y=2/H.height;if(s.isCPUPattern){var y;if(!J.isLargeScale){J._modelViewMatrix._multiplyDoubleMatricesMV(A.matrixWorldInverse,J.matrixWorld);J._programID=J._programID|j.ProgramIDs.LARGE_SCALE;J.isLargeScale=true}y=J._modelViewMatrix;if(J._ratioData&&J._ratioData.ratio>0){y=new j.Matrix4().multiplyMatrices(A.matrixWorldInverse,J._getMMMatrix())}r.computePixelLineDistances(y,A.projectionMatrix,H,z)}else{if(r.cpuPatternMode||!r.vertexLineDistancesArray||r.vertexLayout.vertexPositionArray.needsUpdate){if(r&&!r.vertexIndexArray){console.warn("computeLineDistance unavailable, make sure noMeshInRAM is inactive");return false}r.computeLineDistances()}}}I=C.add(J,r,E,B,l,p,w,G,n)}if(I){var D=this._materialList;var u={material:s,occurrenceRenderingOverride:v,id:m,occurrenceRenderingOverrideId:(v?v.id:-1)};D[this.usefulListLength++]=u}};j.DisplayList.prototype.init=function(){this.usefulListLength=0;this._displayRangeLists={}};j.DisplayList.prototype.finalize=function(){};j.DisplayList.prototype.setValues=function(l){if(l===undefined){return}for(var m in l){var n=l[m];if(n===undefined){console.warn("THREE.DisplayList: '"+m+"' parameter is undefined.");continue}if(m in this){this[m]=n}}};j.DisplayRangeList=function(m,l){this.material=m;this.occurrenceRenderingOverride=l;this.first=null;this.last=null;this._sortCount=0};j.DisplayRangeList.prototype.add=function(r,w,x,y,z,u,s,A,p){var o=false;var m=true;if(this._sortCount<u){this._sortCount=u;this.first=null;this.last=null;o=true}var t=z?z._gssoMask:j.RenderMode.defaultMask;if(x){var q=x._geomType&&x._geomType&h.SurfacicPointRenderPointMask;m=(x._geomType&t)||!x._geomType;if(m&&q){var l=p===j.MaterialToUse.pickingMaterial||p===j.MaterialToUse.highlightMaterial||p===j.MaterialToUse.preHighlightMaterial;m=l}if(A){if(x.glType===0||x.glType===1||(x._geomType&j.RenderMode.pointsMask)||(x._geomType&j.RenderMode.linesMask)){m=false}else{if(r._bodyDim===0&&x.gas&&x.gas.side===j.DoubleSide){m=false}else{if(r&&r._bodyDim!==0&&r._bodyDim!==3){m=false}}}}if(!x.cullingData){if(m&&x.glType===1&&this.last){var v=this.last;if((v[1]===w)&&(v[2].glType===x.glType)&&(v[3]+v[4]===y.start)){v[4]+=y.count;m=false}}}}if(m){var n=null;if(x){n=s.get5(r,w,x,y.start,y.count)}else{n=s.get2(r,w)}n.next=null;if(this.first===null){this.first=this.last=n}else{this.last.next=n;this.last=n}}return o};j.Ray_backup=j.Ray;j.Ray=function(W,D){j.Ray_backup.call(this,W,D);var Z=0.0001;var m=0;var P=0;var ah=new j.Vector3();var af=new j.Vector3();var ae=new j.Vector3();var ac=new j.Vector3();var ab=new j.Vector3();var Y=new j.Vector3();var w=new j.Vector3();var s=new j.Vector3();var r=new j.Vector3();var y=new j.Vector3();var x=new j.Vector3();var t=new j.Vector3();var H=new j.Vector3();var G=new j.Vector3();var X=new j.Vector3();var Q=new j.Vector3();var q=new j.Vector3();var l=new j.Vector3();var ad=new j.Vector3();var n=new j.Vector3();var U=new j.Vector3();var I=new j.Vector3();var K=new j.Matrix4();var al=new j.Vector3(),aj=new j.Vector3(),ag=new j.Vector3();var ai,L,J;function o(v,an,u){al.subVectors(u,v);ai=al.dot(an);L=aj.addVectors(v,ag.copy(an).multiplyScalar(ai));J=u.distanceTo(L);return J}function A(ao,an,v,u){al.subVectors(v,ao.origin);ai=al.dot(ao.direction);var aq=aj.addVectors(W,ag.copy(ao.direction).multiplyScalar(ai));al.subVectors(v,an.origin);ai=al.dot(an.direction);var ap=aj.addVectors(W,ag.copy(an.direction).multiplyScalar(ai));if((aq.x<v-u)&&(aq.y>v+u)&&(ap.x>v+u)&&(ap.y<v-u)){return true}return false}var O,N,M,F,E,ak,z,T,S;function C(an,v,u,ao){al.subVectors(ao,v);aj.subVectors(u,v);ag.subVectors(an,v);O=al.dot(al);N=al.dot(aj);M=al.dot(ag);F=aj.dot(aj);E=aj.dot(ag);ak=O*F-N*N;if(ak<1e-10){return false}z=1/ak;T=(F*M-N*E)*z;S=(O*E-N*M)*z;return(T>=0)&&(S>=0)&&(T+S<1)}function V(au,az,ax){var aA=au.direction;var ay=new j.Vector3().subVectors(ax,az);var aw=new j.Vector3().subVectors(au.origin,az);var av=aA.lengthSq();var at=aA.dot(ay);var ar=ay.lengthSq();var aq=aA.dot(aw);var ap=ay.dot(aw);var an=av*ar-at*at;var ao=0;if(an<1e-7){ao=(at>ar)?aq/at:ap/ar}else{ao=(av*ap-at*aq)/an}return ay.multiplyScalar(ao).add(az)}function p(ao,an,v){var u=new j.Vector3();u.x=ao.x+S*(an.x-ao.x)+T*(v.x-ao.x);u.y=ao.y+S*(an.y-ao.y)+T*(v.y-ao.y);u.z=ao.z+S*(an.z-ao.z)+T*(v.z-ao.z);return u}function B(ao,an,av,u,aG,aH){var aI=aG;var ap=0.5;if(window.devicePixelRatio){ap*=window.devicePixelRatio}var aK=ap*m;var aJ=ap*P;t.copy(av);t.x=(t.x+1)*aK;t.y=(t.y+1)*aJ;w.copy(ao);s.copy(an);w.applyMatrix4(u);s.applyMatrix4(u);y.copy(w);x.copy(s);y.applyProjection(K);x.applyProjection(K);var aD=y.z>1;var aq=x.z>1;if(aD||aq){var az=aH._viewpoint._frustum;var v=(w.dot(az.planes[5].normal)+az.planes[5].constant<0);var aA=(s.dot(az.planes[5].normal)+az.planes[5].constant<0);if(v&&aA){return false}else{if(v||aA){var aB=new j.Line3(w,s);var aF=az.planes[5].intersectLine(aB);if(v){y.copy(aF);y.applyProjection(K)}else{x.copy(aF);x.applyProjection(K)}}}}y.x=(y.x+1)*aK;y.y=(y.y+1)*aJ;x.x=(x.x+1)*aK;x.y=(x.y+1)*aJ;H.subVectors(x,y);G.subVectors(t,y);var aE=G.x*H.x+G.y*H.y;if(aE<1){return false}var ay=H.x*H.x+H.y*H.y;var at=Math.sqrt(ay);var ar=aI.length/at;ar*=ay;if((aE<-ar)||(aE>ay+ar)){return false}var aC=aE/ay;var aw=y.x+aC*H.x;var au=y.y+aC*H.y;var ax=Math.sqrt((aw-t.x)*(aw-t.x)+(au-t.y)*(au-t.y));if(ax>aI.norm||ax<-aI.norm){return false}return true}function R(ar,an,ap,ao){var aq=Infinity;var v=0.01;w.copy(ah);s.copy(an);w.applyMatrix4(ao);var u=new j.Matrix4();u.getInverse(ap);s.applyMatrix4(u);s.applyMatrix4(ao);if((w.z>(s.z-v))&&(w.z<(s.z+v))){H.subVectors(w,s);aq=Math.sqrt(H.x*H.x+H.y*H.y)}return aq}function am(at,aq,au,ar){var v=96;var an=ar/v;if(window.devicePixelRatio){v*=window.devicePixelRatio}var ap=0.5*m/v;var ao=0.5*P/v;r.copy(aq);r.x*=ap;r.y*=ao;w.copy(at);w.applyMatrix4(au);y.copy(w);y.applyProjection(K);y.x*=ap;y.y*=ao;H.subVectors(r,y);var u=Math.sqrt(H.x*H.x+H.y*H.y);if(u>an){return false}return true}this.computeShortestPointToLine=function(v,u){return V(this,v,u)};this.intersectMeshInstances=function(aX,az,aA,aC,aF,ao,ar,aS,u,aM,aE,aq){var aT=aq!==undefined?aq:true;var aU,aZ;aE=aE||["main","noz","afterHighlightNoZ"];var aG=aX.object;var a2=aX.type;if(a2!==undefined){aC=(aC&&(a2==2));aF=(aF&&(a2==1));ao=(ao&&(a2==0))}if(aG instanceof j.Mesh){aU=[{object:aG}]}else{aU=[];for(aZ=0;aZ<aE.length;aZ++){aU=aU.concat(aG.getWebGLObjects(aE[aZ],0))}}var aH,aR,au=[];m=ar;P=aS;az.matrixWorldInverse.getInverse(az.matrixWorld);K.multiplyMatrices(az.projectionMatrix,az.matrixWorldInverse);var aJ=u*window.devicePixelRatio;var aw=1.4142135623730951;for(aZ=0,aH=aU.length;aZ<aH;aZ++){if(aU[aZ]===null){continue}aR=aU[aZ].object;var aN=true;if(aR.visibilityFree){aN=aR.visible}else{aN=aT?aR.visible:!aR.visible}if(aN){if((aR.pickable!==undefined)&&!aR.pickable){continue}var an=new j.Vector3();if(aR.geometry.boundingSphere!==null){an.copy(aR.geometry.boundingSphere.center)}var at=aR._getMMMatrix();an.applyMatrix4(at);var aB=o(this.origin,this.direction,an);var aI=at.getMaxScaleOnAxis();var ax=0;if(aS!=undefined){var aY=0;var v=0;var av=null;var ap=0;if(aR.geometry.length>=0){av=aR.geometry[0];ap=aR.geometry.length}else{if(aR.geometry._type===2){av=aR.geometry;ap=1}}for(var ay=0;ay<ap;ay++){var aD=av.drawingGroups;for(var aW=0,aL=aD.length;aW<aL;aW++){var aP=aD[aW];if(aP.gas){var aO;if(aP.gas.isGAS&&(aP.glType===0)){aO=aP.gas.getPointSize()}else{if((aP.gas instanceof j.ParticleBasicMaterial)&&aP.gas.size){aO=aP.gas.size}}if(aO>v){v=aO}}else{if(aP.material&&(aP.material instanceof j.ParticleBasicMaterial)&&aP.material.size){if(aP.material.size>v){v=aP.material.size}}}}}aY+=v;ax=az.getWorldSizeFromPixelSize(aY,an,P)}var aQ=az.getWorldSizeFromPixelSize(aJ,an,P);if(aB<=aR.geometry.boundingSphere.radius*aI+ax*aw/2+aQ*aw){if(aC){var aV;if((aR.geometry._type===2)||(aR.geometry.length>=0)){aV=this.intersectBufferGeomOptim(az,aA,aR);if(aV.length){if(!aV[0].point&&aX.point){aV[0].point=aX.point}if(!aV[0].normal&&aX.normal){aV[0].normal=aX.normal}}}else{var aK=new j.Raycaster(this.origin,this.direction,az.near,az.far);aV=aK.intersectObject(aR,false);if(aV.length){if(!aV[0].point&&aX.point){aV[0].point=aX.point}if(!aV[0].normal&&aX.normal){aV[0].normal=aX.normal}}}au=au.concat(aV)}if(aF){var a1=this.intersectBufferGeomEdge(aA,aR,u,az);if(a1.length){if(!a1[0].point&&aX.point){a1[0].point=aX.point}if(!a1[0].normal&&aX.normal){a1[0].normal=aX.normal}}au=au.concat(a1)}if(ao){var a0=this.intersectBufferGeomPoint(aA,aR,az,aX.point,u,aM);if(a0.length){if(!a0[0].point&&aX.point){a0[0].point=aX.point}if(!a0[0].normal&&aX.normal){a0[0].normal=aX.normal}}au=au.concat(a0)}}}}au.sort(function(a4,a3){return a4.distance-a3.distance});if(!au.length){au.push({})}return au};this.intersectMeshInstancesZones3D=function(aH,aF,ar,av,aw,aD,aG,aJ,aA,ap,aL,aC,au,at){var ay,aE;var aK=at!==undefined?at:true;if(aH instanceof j.Mesh){ay=[{object:aH}]}else{ay=[];for(aE=0;aE<aC.length;aE++){ay=ay.concat(aH.getWebGLObjects(aC[aE],0))}}var ax,aM,u=[];m=ap;P=aL;aF.matrixWorldInverse.getInverse(aF.matrixWorld);K.multiplyMatrices(aF.projectionMatrix,aF.matrixWorldInverse);for(aE=0,ax=ay.length;aE<ax;aE++){if(ay[aE]===null){continue}aM=ay[aE].object;var ao=true;if(aM.visibilityFree){ao=aM.visible}else{ao=aK?aM.visible:!aM.visible}if(ao){if((aM.pickable!==undefined)&&!aM.pickable){continue}var az=new j.Sphere();if(aM.geometry.boundingSphere!==null){az.copy(aM.geometry.boundingSphere)}var aq=aM._getMMMatrix();az.center.applyMatrix4(aq);if(aw.intersectsSphere(az)){var aN=[];if(!au&&!aD){aN=this.intersectBufferGeom3DInsideFrustumMesh(aw,aM,aG,aJ,aA)}else{var an=["faces","edges","points"];for(var v=0;v<3;v++){var aI=[];if(an[v]==="faces"&&aG){if((aM.geometry._type===2)||(aM.geometry.length>=0)){aI=this.intersectBufferGeomZone3D(aF,aw,aM,aD,au,aG)}else{var aB=new j.Raycaster(this.origin,this.direction,aF.near,aF.far);aI=aB.intersectObject(aM,false)}}else{if(an[v]==="edges"&&aJ){aI=this.intersectBufferGeomEdge3D(aw,aM,aD,au,aJ)}else{if(an[v]==="points"&&aA){aI=this.intersectBufferGeomPoint3D(aw,aM,aA)}}}if(aD){aN=aN.concat(aI)}else{if(!au&&!aI.length){break}if(!aN.length&&aI.length){aN=aN.concat(aI)}if(au&&aN.length>0){break}}}}if(aN){u=u.concat(aN)}}}}if(!u.length){u.push({})}return u};this.intersectBufferGeomOptim=function(aF,aL,aR){var ao=(aF!==null)?aF.near:0;var aM,aA=[];var az=aR._getMMMatrix();var ay=new j.Matrix4().getInverse(az);aR.matrixRotationWorld.extractRotation(az);var ar=new j.Ray().copy(this).applyMatrix4(ay);var at=new j.Vector3();var aY,aX,aW,aN,aU,u,aV,aB,aQ,aZ,aO;var aC=null;var aT=0;if(aR.geometry.length>=0){aC=aR.geometry[0];aT=aR.geometry.length}else{if(aR.geometry._type===2){aC=aR.geometry;aT=1}}if(aC&&!aC.vertexIndexArray){aM={distance:0,primitive:true,object:aR,point:null,normal:null};aA.push(aM);return aA}for(aY=0;aY<aT;aY++){var aK=aC.drawingGroups;var ap=aC.vertexIndexArray;var aP=aC.vertexUvArray?aC.vertexUvArray:null;for(aW=0,aN=aK.length;aW<aN;aW++){aQ=aK[aW];if((aQ.glType!=4)&&(aQ.glType!=5)){continue}var aS=null;if(aR.layer){aS=aR.layer.getIntervals(aC,aQ)}aB=aQ.primitives.length;for(aV=0;aV<aB;aV++){var aE=aQ.primitives[aV];var an=aE.boundingSphere?aE.boundingSphere:(aE.rep?aE.rep.boundingSphere:null);if(an){at.set(an.center[0],an.center[1],an.center[2]);var aI=o(ar.origin,ar.direction,at);if(aI>an.radius){continue}}if(aS!==null){var v=false;for(aX=aS.length-1;aX>=0;aX--){if(aS[aX].start<=aE.start){if(aS[aX].layerNum<=0){v=true}break}}if(v){continue}}u=aE.start+aE.count;for(aU=aE.start;aU<u;((aQ.glType===4)?aU+=3:aU++)){l.copy(ar.origin);ad.copy(ar.direction);var aw,av,au;if(aQ.nonIndexed){aw=aU;av=aU+1;au=aU+2}else{aw=ap[aU];av=ap[aU+1];au=ap[aU+2]}aC.getVertexPosition(ah,aw);aC.getVertexPosition(af,av);aC.getVertexPosition(ae,au);aC.getVertexNormal(ac,aw);aC.getVertexNormal(ab,av);aC.getVertexNormal(Y,au);aw*=3;av*=3;au*=3;Q.addVectors(ah,af);Q.add(ae);Q.multiplyScalar(0.3333333);q.addVectors(ac,ab);q.add(Y);q.multiplyScalar(0.3333333);n=Q.sub(l);aZ=ad.dot(q);if(Math.abs(aZ)<Z){continue}aO=q.dot(n)/aZ;if(aO>=0){I.addVectors(l,ad.multiplyScalar(aO));if(C(I,ah,af,ae)){var aq=null;if(aP){var aJ=new j.Vector3(aP[aw],aP[aw+1],aP[aw+2]);var aH=new j.Vector3(aP[av],aP[av+1],aP[av+2]);var aG=new j.Vector3(aP[au],aP[au+1],aP[au+2]);aq=p(aJ,aH,aG)}var aD=I.barycentricCoordinates(ah,af,ae);ac.multiplyScalar(aD.alpha);ab.multiplyScalar(aD.beta);Y.multiplyScalar(aD.gamma);q.addVectors(ac,ab);q.add(Y);q.multiplyScalar(aD.normalisationFactor);q.normalize();var ax=I.clone().applyMatrix4(az);aM={distance:this.origin.distanceTo(ax),point:ax,normal:q.clone().applyMatrix4(aR.matrixRotationWorld),tangent:null,uv:aq,primitive:aE,geometry:aC,object:aR};aA.push(aM)}}}}}aC=aR.geometry[aY+1]}return aA};this._castRayIntoBufferGeom=function(aT,an){var aR,v=[];var ar=aT._getMMMatrix();var ay=new j.Matrix4().getInverse(ar);aT.matrixRotationWorld.extractRotation(ar);var ao=new j.Ray().copy(this).applyMatrix4(ay);var aL,aK,aF,aA,aC,aq,aD,aP,aw,aG,aU;var at=null;var aM=0;if(aT.geometry.length>=0){at=aT.geometry[0];aM=aT.geometry.length}else{if(aT.geometry._type===2){at=aT.geometry;aM=1}}if(at&&!at.vertexIndexArray){aR={distance:0,primitive:true,object:aT,point:null,normal:null};v.push(aR);return v}for(aL=0;aL<aM;aL++){var av=at.drawingGroups;var au=at.vertexIndexArray;var az=at.vertexUvArray?at.vertexUvArray:null;for(aF=0,aA=av.length;aF<aA;aF++){aw=av[aF];if((aw.glType!=4)&&(aw.glType!=5)){continue}var ax=null;if(aT.layer){ax=aT.layer.getIntervals(at,aw)}aP=aw.primitives.length;for(aD=0;aD<aP;aD++){var ap=aw.primitives[aD];if(ax!==null){var aE=false;for(aK=ax.length-1;aK>=0;aK--){if(ax[aK].start<=ap.start){if(ax[aK].layerNum<=0){aE=true}break}}if(aE){continue}}aq=ap.start+ap.count;for(aC=ap.start;aC<aq;((aw.glType===4)?aC+=3:aC++)){l.copy(ao.origin);ad.copy(ao.direction);var aJ=au[aC];var aI=au[aC+1];var aH=au[aC+2];at.getVertexPosition(ah,aJ);at.getVertexPosition(af,aI);at.getVertexPosition(ae,aH);at.getVertexNormal(ac,aJ);at.getVertexNormal(ab,aI);at.getVertexNormal(Y,aH);aJ*=3;aI*=3;aH*=3;Q.addVectors(ah,af);Q.add(ae);Q.multiplyScalar(0.3333333);q.addVectors(ac,ab);q.add(Y);q.multiplyScalar(0.3333333);n=Q.sub(l);aG=ad.dot(q);if(Math.abs(aG)<Z){continue}aU=q.dot(n)/aG;if(aU>=0){I.addVectors(l,ad.multiplyScalar(aU));if(C(I,ah,af,ae)){if(an){aR={object:aT,geometry:at};v.push(aR);return v}var aB=null;if(az){var aQ=new j.Vector3(az[aJ],az[aJ+1],az[aJ+2]);var aO=new j.Vector3(az[aI],az[aI+1],az[aI+2]);var aN=new j.Vector3(az[aH],az[aH+1],az[aH+2]);aB=p(aQ,aO,aN)}var aS=I.barycentricCoordinates(ah,af,ae);ac.multiplyScalar(aS.alpha);ab.multiplyScalar(aS.beta);Y.multiplyScalar(aS.gamma);q.addVectors(ac,ab);q.add(Y);q.multiplyScalar(aS.normalisationFactor);q.normalize();var u=I.clone().applyMatrix4(ar);aR={distance:this.origin.distanceTo(u),point:u,normal:q.clone().applyMatrix4(aT.matrixRotationWorld),tangent:null,uv:aB,primitive:ap,geometry:at,object:aT};v.push(aR)}}}}}at=aT.geometry[aL+1]}return v};this.intersectBufferGeom3DInsideFrustumMesh=function(au,aK,aI,aJ,az){var av=aI+aJ+az;var ax=false;var aH,u=[];var aE,aD,aC,aw,ay,an,aA,aG,ar;var ao=null;var aF=0;if(aK.geometry.length>=0){ao=aK.geometry[0];aF=aK.geometry.length}else{if(aK.geometry._type===2){ao=aK.geometry;aF=1}}for(aE=0;aE<aF;aE++){var aq=ao.drawingGroups;var ap=ao.vertexIndexArray;for(aC=0,aw=aq.length;aC<aw;aC++){ar=aq[aC];if(ar._geomType&&!(ar._geomType&av)){continue}var at=null;if(aK.layer){at=aK.layer.getIntervals(ao,ar)}aG=ar.primitives.length;for(aA=0;aA<aG;aA++){var v=ar.primitives[aA];if(at!==null){var aB=false;for(aD=at.length-1;aD>=0;aD--){if(at[aD].start<=v.start){if(at[aD].layerNum<=0){aB=true}break}}if(aB){continue}}an=v.start+v.count;for(ay=v.start;ay<an;ay++){ax=true;ao.getVertexPosition(ah,ap[ay]);w.copy(ah);w.applyMatrix4(aK._getMMMatrix());if(!au.containsPoint(w)){return null}}}}ao=aK.geometry[aE+1]}if(ax){u.push({object:aK})}else{return null}return u};this.intersectBufferGeomZone3D=function(aL,az,aS,aH,aw,aO){var aR=(aL!==null)?aL.near:0;var aN,u=[];var ao=aS._getMMMatrix();var ax=new j.Matrix4().getInverse(ao);aS.matrixRotationWorld.extractRotation(ao);var aJ,aI,aG,aB,aC,an,aD,aM,au,aF,aT,ay;var aq=null;var aK=0;if(aS.geometry.length>=0){aq=aS.geometry[0];aK=aS.geometry.length}else{if(aS.geometry._type===2){aq=aS.geometry;aK=1}}if(aq.noMeshInRAM||!aq.vertexIndexArray){return u}if(!aH){ay=!aw}var aP=new j.Sphere();for(aJ=0;aJ<aK;aJ++){var at=aq.drawingGroups;var ar=aq.vertexIndexArray;var aA=aq.vertexUvArray?aq.vertexUvArray:null;for(aG=0,aB=at.length;aG<aB;aG++){au=at[aG];if((au.glType!=4)&&(au.glType!=5)){continue}if(au._geomType&&!(au._geomType&aO)){continue}var av=null;if(aS.layer){av=aS.layer.getIntervals(aq,au)}aM=au.primitives.length;for(aD=0;aD<aM;aD++){if(aH&&!aw){ay=true}var v=au.primitives[aD],aQ;if(aH&&v.boundingSphere){aQ=v.boundingSphere.center;aP.center.set(aQ[0],aQ[1],aQ[2]);aP.radius=v.boundingSphere.radius*ao.getMaxScaleOnAxis();aP.center.applyMatrix4(ao);if(!az.intersectsSphere(aP)){continue}}if(av!==null){var aE=false;for(aI=av.length-1;aI>=0;aI--){if(av[aI].start<=v.start){if(av[aI].layerNum<=0){aE=true}break}}if(aE){continue}}an=v.start+v.count;for(aC=v.start;aC<an;aC++){aq.getVertexPosition(ah,ar[aC]);aq.getVertexPosition(af,ar[aC+1]);aq.getVertexPosition(ae,ar[aC+2]);w.copy(ah);s.copy(af);r.copy(ae);w.applyMatrix4(ao);s.applyMatrix4(ao);r.applyMatrix4(ao);if(aw){var ap=new j.Sphere();ap.setFromCenterAndPoints(new j.Vector3((w.x+s.x+r.x)/3,(w.y+s.y+r.y)/3,(w.z+s.z+r.z)/3),[w,s,r]);if(az.intersectsSphere(ap)&&az.intersectsTriangle([w,s,r])){if(aH){aN={primitive:v,geometry:aq,object:aS};u.push(aN)}else{ay=true}break}}else{if(!(az.containsPoint(w)&&az.containsPoint(s)&&az.containsPoint(r))){ay=false;break}}if(au.glType==4){aC+=2}}if(aH&&!aw&&ay){aN={primitive:v,geometry:aq,object:aS};u.push(aN)}else{if(!aH&&aw&&u.length){break}}}if(!aH&&((aw&&ay)||(!aw&&!ay))){break}}if(!aH&&((aw&&ay)||(!aw&&!ay))){break}aq=aS.geometry[aJ+1]}if(!aH&&ay){u.push({object:aS})}return u};this.intersectBufferGeomEdge=function(au,aQ,aO,aL){var u=0.99;var aK={norm:0,length:0};if(aQ.material&&aQ.material.lineWidth&&aQ.material.lineWidth>1){if(aQ.material.lineWidth<aO*2){aK.length=aO+1}else{aK.length=aQ.material.lineWidth/2}}else{aK.length=aO+1}aK.norm=Math.sqrt(2*(aK.length)*(aK.length));var at=new j.Vector3();var aN,v=[];var ar=aQ._getMMMatrix();var aI,aH,aE,aA,aB,aq,aC,aM,ay;var av=null;var aJ=0;if(aQ.geometry.length>=0){av=aQ.geometry[0];aJ=aQ.geometry.length}else{if(aQ.geometry._type===2){av=aQ.geometry;aJ=1}}if(av&&!av.vertexIndexArray){aN={distance:0,primitive:true,object:aQ,point:null,normal:null};v.push(aN);return v}for(aI=0;aI<aJ;aI++){var ax=av.drawingGroups;var aw=av.vertexIndexArray;for(aE=0,aA=ax.length;aE<aA;aE++){ay=ax[aE];if(ay.glType!=1){continue}var az=null;if(aQ.layer){az=aQ.layer.getIntervals(av,ay)}aM=ay.primitives.length;for(aC=0;aC<aM;aC++){var ao=ay.primitives[aC];var an=ao.boundingSphere?ao.boundingSphere:(ao.rep?ao.rep.boundingSphere:null);if(an){at.set(an.center[0],an.center[1],an.center[2]);at.applyMatrix4(ar);var ap=o(this.origin,this.direction,at);var aP=ar.getMaxScaleOnAxis();if(ap>an.radius*aP){continue}}if(az!==null){var aD=false;for(aH=az.length-1;aH>=0;aH--){if(az[aH].start<=ao.start){if(az[aH].layerNum<=0){aD=true}break}}if(aD){continue}}aq=ao.start+ao.count;for(aB=ao.start;aB<aq;aB+=2){if(ay.nonIndexed){av.getVertexPosition(ah,aB);av.getVertexPosition(af,aB+1)}else{av.getVertexPosition(ah,aw[aB]);av.getVertexPosition(af,aw[aB+1])}if(B(ah,af,au,ar,aK,aL)){var aG=V(this,w,s);var aF=this.origin.distanceTo(aG);aN={distance:Math.max(0,u*aF),point:aG.clone(),normal:null,tangent:new j.Vector3().subVectors(aG,w).normalize(),primitive:ao,geometry:av,object:aQ};v.push(aN);break}}}}av=aQ.geometry[aI+1]}return v};this.intersectBufferGeomEdge3D=function(ay,aN,aF,aw,aM){var u=0.99;var aL,v=[];var ap=aN._getMMMatrix();var aI,aH,aD,az,aA,ao,aB,aK,au,ax;var aq=null;var aJ=0;if(aN.geometry.length>=0){aq=aN.geometry[0];aJ=aN.geometry.length}else{if(aN.geometry._type===2){aq=aN.geometry;aJ=1}}if(aq.noMeshInRAM||!aq.vertexIndexArray){return v}if(!aF){ax=!aw}for(aI=0;aI<aJ;aI++){var at=aq.drawingGroups;var ar=aq.vertexIndexArray;for(aD=0,az=at.length;aD<az;aD++){au=at[aD];if(au.glType!=1){continue}if(au._geomType&&!(au._geomType&aM)){continue}var av=null;if(aN.layer){av=aN.layer.getIntervals(aq,au)}aK=au.primitives.length;for(aB=0;aB<aK;aB++){if(aF){ax=true}var an=au.primitives[aB];if(av!==null){var aC=false;for(aH=av.length-1;aH>=0;aH--){if(av[aH].start<=an.start){if(av[aH].layerNum<=0){aC=true}break}}if(aC){continue}}ao=an.start+an.count;for(aA=an.start;aA<ao;aA+=2){aq.getVertexPosition(ah,ar[aA]);aq.getVertexPosition(af,ar[aA+1]);w.copy(ah);s.copy(af);w.applyMatrix4(ap);s.applyMatrix4(ap);if(aw){if(ay.intersectsLine([w,s])){if(aF){var aG=V(this,w,s);var aE=this.origin.distanceTo(aG);aL={distance:Math.max(0,u*aE),point:aG.clone(),normal:null,tangent:new j.Vector3().subVectors(aG,w).normalize(),primitive:an,geometry:aq,object:aN};v.push(aL)}else{ax=true}break}}else{if(!(ay.containsPoint(w)&&ay.containsPoint(s))){ax=false;break}}}if(aF&&!aw&&ax){aL={primitive:an,geometry:aq,object:aN};v.push(aL)}else{if(!aF&&aw&&v.length){break}}}if(!aF&&((aw&&ax)||(!aw&&!ax))){break}}if(!aF&&((aw&&ax)||(!aw&&!ax))){break}aq=aN.geometry[aI+1]}if(!aF&&ax){v.push({object:aN})}return v};this._castRayIntoBufferGeomEdge=function(aL,ao,an){var u=0.99;var aK,v=[];var ar=aL._getMMMatrix();var aH,aG,aD,az,aA,aq,aB,aJ,aw;var at=null;var aI=0;if(aL.geometry.length>=0){at=aL.geometry[0];aI=aL.geometry.length}else{if(aL.geometry._type===2){at=aL.geometry;aI=1}}if(at&&!at.vertexIndexArray){aK={distance:0,primitive:true,object:aL,point:null,normal:null};v.push(aK);return v}for(aH=0;aH<aI;aH++){var av=at.drawingGroups;var au=at.vertexIndexArray;for(aD=0,az=av.length;aD<az;aD++){aw=av[aD];if(aw.glType!=1){continue}var ax=null;if(aL.layer){ax=aL.layer.getIntervals(at,aw)}aJ=aw.primitives.length;for(aB=0;aB<aJ;aB++){var ap=aw.primitives[aB];if(ax!==null){var aC=false;for(aG=ax.length-1;aG>=0;aG--){if(ax[aG].start<=ap.start){if(ax[aG].layerNum<=0){aC=true}break}}if(aC){continue}}aq=ap.start+ap.count;for(aA=ap.start;aA<aq;aA+=2){at.getVertexPosition(ah,au[aA]);at.getVertexPosition(af,au[aA+1]);w.copy(ah);s.copy(af);w.applyMatrix4(ar);s.applyMatrix4(ar);var aF=new j.Vector3();var ay=this.distanceSqToSegment(w,s,null,aF);if(ay<ao*ao){if(an){aK={object:aL,geometry:at};v.push(aK);return v}var aE=this.origin.distanceTo(aF);aK={distance:Math.max(0,u*aE),point:aF.clone(),normal:null,tangent:new j.Vector3().subVectors(aF,w).normalize(),primitive:ap,geometry:at,object:aL};v.push(aK)}}}}at=aL.geometry[aH+1]}return v};this.intersectBufferGeomPoint=function(at,aU,aO,aQ,aS,ap){var u=0.98;var aR,v=[];var an=(aS+1)*Math.sqrt(2);var aN;var ar=aU._getMMMatrix();var aF=new j.Matrix4().multiplyMatrices(aO.matrixWorldInverse,ar);var aL,aK,aI,aD,aE,aq,aG,aP,az;var av=null;var aM=0;var ay=Infinity;var aC=ap;var aT=aQ;if(!aT){aC=false}if(aU.geometry.length>=0){av=aU.geometry[0];aM=aU.geometry.length}else{if(aU.geometry._type===2){av=aU.geometry;aM=1}}if(av&&!av.vertexIndexArray){aR={distance:0,primitive:true,object:aU,point:null,normal:null};v.push(aR);return v}for(aL=0;aL<aM;aL++){var ax=av.drawingGroups;var aw=av.vertexIndexArray;for(aI=0,aD=ax.length;aI<aD;aI++){az=ax[aI];if(az.glType!==0){continue}if(az.gas){var aB;if(az.gas.isGAS){aB=az.gas.getPointSize()}else{if((az.gas instanceof j.ParticleBasicMaterial)&&az.gas.size){aB=az.gas.size}}if(aB>(aS*2+1)){aN=aB*Math.sqrt(2)/2}else{aN=an}}else{aN=an}var aA=null;if(aU.layer){aA=aU.layer.getIntervals(av,az)}aP=az.primitives.length;for(aG=0;aG<aP;aG++){var ao=az.primitives[aG];if(aA!==null){var aH=false;for(aK=aA.length-1;aK>=0;aK--){if(aA[aK].start<=ao.start){if(aA[aK].layerNum<=0){aH=true}break}}if(aH){continue}}aq=ao.start+ao.count;for(aE=ao.start;aE<aq;aE++){if(az.nonIndexed){av.getVertexPosition(ah,aE)}else{av.getVertexPosition(ah,aw[aE])}if(aC){var au=R(ah,aT,ar,aF);if(au<ay){ay=au;var aJ=this.origin.distanceTo(w);aR={distance:Math.max(0,u*aJ),point:w.clone(),normal:null,primitive:ao,geometry:av,object:aU}}}else{if(am(ah,at,ar,aN)){var aJ=this.origin.distanceTo(w);aR={distance:Math.max(0,u*aJ),point:w.clone(),normal:null,primitive:ao,geometry:av,object:aU};v.push(aR)}}}}}av=aU.geometry[aL+1]}if(aC&&aR){v.push(aR)}return v};this.intersectBufferGeomPoint3D=function(aw,aJ,az){var u=0.98;var aI,v=[];var ap=aJ._getMMMatrix();var aF,aE,aC,ax,ay,ao,aA,aH,au;var aq=null;var aG=0;if(aJ.geometry.length>=0){aq=aJ.geometry[0];aG=aJ.geometry.length}else{if(aJ.geometry._type===2){aq=aJ.geometry;aG=1}}if(aq.noMeshInRAM||!aq.vertexIndexArray){return v}for(aF=0;aF<aG;aF++){var at=aq.drawingGroups;var ar=aq.vertexIndexArray;for(aC=0,ax=at.length;aC<ax;aC++){au=at[aC];if(au.glType!==0){continue}if(au._geomType&&!(au._geomType&az)){continue}var av=null;if(aJ.layer){av=aJ.layer.getIntervals(aq,au)}aH=au.primitives.length;for(aA=0;aA<aH;aA++){var an=au.primitives[aA];if(av!==null){var aB=false;for(aE=av.length-1;aE>=0;aE--){if(av[aE].start<=an.start){if(av[aE].layerNum<=0){aB=true}break}}if(aB){continue}}ao=an.start+an.count;for(ay=an.start;ay<ao;ay++){aq.getVertexPosition(ah,ar[ay]);w.copy(ah);w.applyMatrix4(ap);if(aw.computeOutcode(w)===0){var aD=this.origin.distanceTo(w);aI={distance:Math.max(0,u*aD),point:w.clone(),normal:null,primitive:an,geometry:aq,object:aJ};v.push(aI)}}}}aq=aJ.geometry[aF+1]}return v};this._castRayIntoBufferGeomPoint=function(aK,ao,an){var u=0.98;var aJ,v=[];var ar=aK._getMMMatrix();var aG,aF,aD,ay,az,aq,aB,aI,aw;var at=null;var aH=0;if(aK.geometry.length>=0){at=aK.geometry[0];aH=aK.geometry.length}else{if(aK.geometry._type===2){at=aK.geometry;aH=1}}if(at&&!at.vertexIndexArray){aJ={distance:0,primitive:true,object:aK,point:null,normal:null};v.push(aJ);return v}for(aG=0;aG<aH;aG++){var av=at.drawingGroups;var au=at.vertexIndexArray;for(aD=0,ay=av.length;aD<ay;aD++){aw=av[aD];if(aw.glType!==0){continue}var ax=null;if(aK.layer){ax=aK.layer.getIntervals(at,aw)}aI=aw.primitives.length;for(aB=0;aB<aI;aB++){var ap=aw.primitives[aB];if(ax!==null){var aC=false;for(aF=ax.length-1;aF>=0;aF--){if(ax[aF].start<=ap.start){if(ax[aF].layerNum<=0){aC=true}break}}if(aC){continue}}aq=ap.start+ap.count;for(az=ap.start;az<aq;az++){at.getVertexPosition(ah,au[az]);w.copy(ah);w.applyMatrix4(ar);var aA=this.distanceToPoint(w);if(aA<ao){if(an){aJ={object:aK,geometry:at};v.push(aJ);return v}var aE=this.origin.distanceTo(w);aJ={distance:Math.max(0,u*aE),point:w.clone(),normal:null,primitive:ap,geometry:at,object:aK};v.push(aJ)}}}}at=aK.geometry[aG+1]}return v}};j.Ray.prototype=j.Ray_backup.prototype;j.Ray.prototype.intersectPlaneInDir=function(l,n){var m=this.distanceToPlane(l);if((m===undefined)||(m<0)){return undefined}return this.at(m,n)};j.Mesh_backup=j.Mesh;j.Mesh=function(n,m,l){j.Mesh_backup.call(this,n,m);this.pickable=true;this.sceneGraph=null;this.highLight={primitives:[],nbSelected:[]};this.drawInHLRender=true;this.enableNormalDepth=true;this.visible=true;this.visibilityFree=false;this.layer=null;this.selectionGroups=null;this.outlinesGeometry=null;this.sectionLinesBuilder=null;this._bodyDim=0;this.hasPoint=false;this.renderPointsOnly=false;this._checkGeometry();this.boundingSphere=this.geometry.boundingSphere.clone();this.boundingBox=this.geometry.boundingBox.clone();this.geomWorldBE=[];this.__webglInit=false;this.__webglActive=null;this._modelViewMatrix=null;this._normalMatrix=null;this.render=true;this.z=0;this.renderLineMode=null;this._occurrence=null;this.pickingPriorityID=0;this.occurrenceRenderingOverride=null;this._centerZ=0;this.currentShadowMatrices=null;this.highlight=null;this.preHighlight=null;this._instancingInfos=null;this.clippingPlane=null;this.disableMirror=0;this._manipulators=undefined;this._3dxmlMaterial=null;this._gsso_cache=null;this.fromLoadedModel=false;this.compressedNormals=this.geometry.length&&n[0].compressedNormals;this.compressedVertices=this.geometry.length&&n[0].compressedVertices;this.materialMode=2;if(this.compressedVertices){this._programID=this._programID|j.ProgramIDs.COMPRESSED_VERTICES}if(this.compressedNormals){this._programID=this._programID|j.ProgramIDs.COMPRESSED_NORMALS}if(!l){window.sealWebVisuObjects&&Object.seal(this)}};j.Mesh.prototype=j.Mesh_backup.prototype;j.Mesh.prototype._isOutsideOrInsideVolume=function(o,p,l){var n=new j.Sphere();var m=this._getMMMatrix();if(this.boundingSphere!==null){n.copy(this.boundingSphere)}n.applyMatrix4(m);if(o.containsSphere(n)){l.push({object:this});return true}if(o.intersectsSphere(n)){return false}p.push({object:this});return true};j.Mesh.prototype._intersectVolume=function(q,m,v,w,n,s,t){if(this._isOutsideOrInsideVolume(q,s,n)){return}var r=this._getMMMatrix();var l=this.geometry;if(l._type===2){l=[l]}for(var p=0;p<l.length;p++){var u=l[p];var o=u._intersectVolume(this,q,m,v,w,r);switch(o){case 0:s.push({object:this});break;case 1:t.push({object:this});break;case 2:n.push({object:this});break;default:return}}return};Object.defineProperty(j.Mesh.prototype,"instanceAttribArrays",{get:function(){return this._instancingInfos?this._instancingInfos.instanceAttribArrays:null},set:function(l){if(this._instancingInfos){this._instancingInfos.instanceAttribArrays=l}}});Object.defineProperty(j.Mesh.prototype,"instancingSelectionMode",{get:function(){return this._instancingInfos?this._instancingInfos.instancingSelectionMode:""},set:function(l){if(this._instancingInfos){this._instancingInfos.instancingSelectionMode=l}}});Object.defineProperty(j.Mesh.prototype,"nbInstances",{get:function(){return this._instancingInfos?this._instancingInfos.nbInstances:-1},set:function(l){if(this._instancingInfos){this._instancingInfos.nbInstances=l}}});j.Mesh.prototype.copyInstancingInfos=function(l){if(this._instancingInfos){l._instancingInfos={isInstanceNode3D:this._instancingInfos.isInstanceNode3D,nbInstances:this._instancingInfos.nbInstances,instancingSelectionMode:this._instancingInfos.instancingSelectionMode,instanceAttribArrays:this._instancingInfos.instanceAttribArrays,pickedInstanceId:-1}}};j.Mesh.prototype.addRefVBO=function(){var n=null;var l=0;if(this.geometry.length>=0){n=this.geometry[0];l=this.geometry.length}else{if(this.geometry._type===2){n=this.geometry;l=1}}for(var m=0;m<l;m++){n.addRefVBO(this);n=this.geometry[m+1]}};j.Mesh.prototype.releaseVBO=function(){var n=null;var l=0;if(this.geometry.length>=0){n=this.geometry[0];l=this.geometry.length}else{if(this.geometry._type===2){n=this.geometry;l=1}}for(var m=0;m<l;m++){n.releaseVBO(this);n=this.geometry[m+1]}if(this.outlinesGeometry){this.outlinesGeometry.geometry&&this.outlinesGeometry.geometry.dispose()}};j.Mesh.prototype.dispose=function(){var n=null;var l=0;if(this.geometry.length>=0){n=this.geometry[0];l=this.geometry.length}else{if(this.geometry._type===2){n=this.geometry;l=1}}for(var m=0;m<l;m++){n.dispose();n=this.geometry[m+1]}};j.Mesh.prototype.computeTangents=function(o){var n=null;var l=0;if(this.geometry.length>=0){n=this.geometry[0];l=this.geometry.length}else{if(this.geometry._type===2){n=this.geometry;l=1}}for(var m=0;m<l;m++){n.computeTangents(o);n=this.geometry[m+1]}};j.Mesh.prototype.computeUVs=function(){var n=null;var l=0;if(this.geometry.length>=0){n=this.geometry[0];l=this.geometry.length}else{if(this.geometry._type===2){n=this.geometry;l=1}}for(var m=0;m<l;m++){n.computeUVs(this.geometry.boundingBox);n=this.geometry[m+1]}};j.Mesh.prototype.detachGeometry=function(n){if(!n){return}if(!this.layer){return}var o=this.layer.getIntervals(n,null,true);for(var m=0;m<o.length;m++){l=this.layer.layers.indexOf(o[m]);if(l!==-1){this.layer.layers.splice(l,1);this.layer.upToDate=false}}if(this.geometry&&this.geometry.length){var l=this.geometry.indexOf(n);if(l!==-1){this.geometry.splice(l,1)}}};j.Mesh.prototype.removeGeometry=function(o){if(!o){return}var l=o.meshList;for(var n=0;n<l.length;n++){var p=l[n];if(!p.layer){continue}var q=p.layer.getIntervals(o,null,true);for(var n=0;n<q.length;n++){m=p.layer.layers.indexOf(q[n]);if(m!==-1){p.layer.layers.splice(m,1);p.layer.upToDate=false}}}for(var n=0;n<l.length;n++){var p=l[n];if(p.geometry&&p.geometry.length){var m=p.geometry.indexOf(o);if(m!==-1){p.geometry.splice(m,1)}}}};j.Mesh.prototype.addGeometry=function(r,q,n){var l=false;for(var o=0;o<this.geometry.length;o++){if(this.geometry[o]===r){l=true;break}}if(l){if(!n){this._initLayersForGeometry(1,r)}else{if(!this.layer){this.initLayers(1)}for(var m=0;m<n.length;m++){var t=n[m];var p=t.drawableInterval;if((p.layerNum===1)||p.material){var s=t.drawableGroup.primitives.slice(p.primitiveStart,p.primitiveStart+p.primitiveCount);this.layer.addPrimitivesToLayer(r,t.drawableGroup,s,p.layerNum,p.material)}}}return}if(!r.boundingBox){r.computeBoundingBox()}if(!this.geometry.boundingBox){this.geometry.boundingBox=new j.Box3()}q&&this.geometry.boundingBox.expandByPoint(r.boundingBox.min);q&&this.geometry.boundingBox.expandByPoint(r.boundingBox.max);if(!r.boundingSphere){r.computeBoundingSphere()}if(!this.geometry.boundingSphere){this.geometry.boundingSphere=new j.Sphere()}q&&this.geometry.boundingSphere.clone().mergeWithSphere(r.boundingSphere,this.geometry.boundingSphere);if(this._occurrence&&this._occurrence.scene3js){r.addRefVBO(this)}if(!this.layer&&!n){this.geometry.push(r);this._checkGeometry();return}if(!this.layer){this.initLayers(1)}this.geometry.push(r);if(n){this._copyLayers(n)}else{this._initLayersForGeometry(1,r)}this._checkGeometry()};j.Mesh.prototype.getRenderablesFromGeometries=function(){if(!this.geometry||!this.geometry.length){return}var m={};for(var p=0;p<this.geometry.length;p++){var o=this.geometry[p];for(var l=0;l<o.meshList.length;l++){var q=o.meshList[l];m[q.id]=q}}var n=[];for(var p in m){n.push(m[p])}return n};j.Mesh.prototype.optimizeBuffers=function(){};j.Mesh.prototype.isMeshHiddenByLayer=function(){if((this.layer===null)||!this.layer.layers.length){return false}for(var l=0;l<this.layer.layers.length;l++){var m=this.layer.layers[l];if(m.drawableInterval.layerNum!==0){return false}}return true};j.Mesh.prototype.addHighLightPrimitive=function(l){var m=this.highLight.primitives.indexOf(l);if(m!==-1){this.highLight.nbSelected[m]++;return}this.highLight.primitives.push(l);this.highLight.nbSelected.push(1);if(this.layer===null){this.initLayers()}this.layer.addPrimitivesToLayers([l],1)};j.Mesh.prototype.addHighLightRep=function(o){var p=[];for(var n=0;n<o.primitives.length;n++){var l=o.primitives[n];var m=this.highLight.primitives.indexOf(l);if(m!==-1){this.highLight.nbSelected[m]++;continue}this.highLight.primitives.push(l);this.highLight.nbSelected.push(1);p.push(l)}if(this.layer===null){this.initLayers()}this.layer.addPrimitivesToLayers(p,1)};j.Mesh.prototype.removeHighLightPrimitive=function(l){var m=this.highLight.primitives.indexOf(l);if(m===-1){return}if(this.layer===null){return}this.highLight.nbSelected[m]--;if(this.highLight.nbSelected[m]){return}this.highLight.primitives.splice(m,1);this.highLight.nbSelected.splice(m,1);this.layer.addPrimitivesToLayers([l],0)};j.Mesh.prototype.removeHighLightRep=function(o){var p=[];for(var n=0;n<o.primitives.length;n++){var l=o.primitives[n];var m=this.highLight.primitives.indexOf(l);if(m===-1){continue}this.highLight.nbSelected[m]--;if(this.highLight.nbSelected[m]){continue}this.highLight.primitives.splice(m,1);this.highLight.nbSelected.splice(m,1);p.push(l)}if(this.layer===null){this.layer=new j.BufferLayer()}this.layer.addPrimitivesToLayers(p,0)};j.Mesh.prototype.removeHighLight=function(){this.layer=null;this.highLight.primitives=[];this.highLight.nbSelected=[]};j.Mesh.prototype.initLayers=function(o){if(this.layer!==null){return}this.layer=new j.BufferLayer();var l=1;var n=this.geometry;if(this.geometry.length>=0){n=this.geometry[0];l=this.geometry.length}for(var m=0;m<l;m++){this._initLayersForGeometry(o,n);n=this.geometry[m+1]}};j.Mesh.prototype._initLayersForGeometry=function(m,t){if(!this.layer){this.layer=new j.BufferLayer()}var o=this.layer.getIntervals(t,null,true);for(var p=0;p<o.length;p++){var r=this.layer.layers.indexOf(o[p]);if(r!==-1){this.layer.layers.splice(r,1)}}for(var n=0;n<t.drawingGroups.length;n++){var s=t.drawingGroups[n];var l=new j.DrawableInterval(m,s.start,s.count);l.primitiveStart=0;l.primitiveCount=s.primitives.length;var q=new j.LayerInterval(t,s,l);this.layer.layers.push(q)}};j.Mesh.prototype._copyLayers=function(n){if(!this.layer){this.layer=new j.BufferLayer()}for(var m=0;m<n.length;m++){var l=n[m];this.layer.layers.push(l.clone())}};j.Mesh.prototype.hasPriorityManipulators=function(){if(this._manipulators){for(var l in this._manipulators){if(this._manipulators[l].active&&this._manipulators[l].getPickingPriority()){return true}}}return false};j.Mesh.prototype.hasManipulators=function(){if(this._manipulators){for(var l in this._manipulators){if(this._manipulators[l].active){return true}}}return false};j.Mesh.prototype._checkGeometry=function(){var r,o,n,l,m,q,p;if(this.geometry.length){r=this.geometry.length;for(n=0;n<r;n++){m=this.geometry[n];if(m._type!==2){continue}q=m.drawingGroups;o=q.length;for(l=0;l<o;l++){p=q[l];if(p.glType===0){this.hasPoint=true;return true}}}}return false};j.Mesh.prototype.getNode=function(){return this._occurrence&&this._occurrence.node};j.Mesh.prototype.getSelectionGroup=function(n){if(!this.selectionGroups){return null}for(var l=0;l<this.selectionGroups.length;l++){var m=this.selectionGroups[l];if(m.contains(n)){return m}}return null};j.Mesh.prototype.removeSelectionGroup=function(n){if(!this.selectionGroups){return null}for(var l=0;l<this.selectionGroups.length;l++){var m=this.selectionGroups[l];if(m.contains(n)){this.selectionGroups.splice(l,1);break}}};j.Mesh.prototype.addSelectionGroup=function(l){if(!this.selectionGroups){this.selectionGroups=[]}this.selectionGroups.push(l)};j.InterleavedBuffer=function(l,o,q,n,p,m){this.buffer=o.createBuffer();this.indexBuffer=o.createBuffer();this.numItems=0;this.indexNumItems=0;this.interleavedData=null;this.indexData=null;this.id=q;this.geometries=[];this.isShared=false;this.nbGeometries=0;this.compressedNormals=p||false;this.compressedVertices=m||false;this.needsUpdate=false;this.start=null;this.count=null;this.vbType=l;this._setBufferOffsets(n)};j.InterleavedBuffer.prototype._setBufferOffsets=function(l){this.itemSize=0;if(l.POSITION&this.vbType){var m=this.compressedVertices?2:3;this.normalOffset=m*4;this.uvOffset=m*4;this.uv2Offset=m*4;this.colorOffset=m*4;this.tangentOffset=m*4;this.binormalOffset=m*4;this.previousPositionOffset=m*4;this.nextPositionOffset=m*4;this.sideExtrusionOffset=m*4;this.lineDistancesOffset=m*4;this.skinIndexOffset=m*4;this.skinWeightOffset=m*4;this.itemSize+=m}if(l.NORMAL&this.vbType){var m=this.compressedNormals?1:3;this.itemSize+=m;this.uvOffset+=m*4;this.uv2Offset+=m*4;this.colorOffset+=m*4;this.tangentOffset+=m*4;this.binormalOffset+=m*4;this.previousPositionOffset+=m*4;this.nextPositionOffset+=m*4;this.sideExtrusionOffset+=m*4;this.lineDistancesOffset+=m*4;this.skinIndexOffset+=m*4;this.skinWeightOffset+=m*4}if(l.UV&this.vbType){this.itemSize+=2;this.uv2Offset+=2*4;this.colorOffset+=2*4;this.tangentOffset+=2*4;this.binormalOffset+=2*4;this.previousPositionOffset+=2*4;this.nextPositionOffset+=2*4;this.sideExtrusionOffset+=2*4;this.lineDistancesOffset+=2*4;this.skinIndexOffset+=2*4;this.skinWeightOffset+=2*4}if(l.UV2&this.vbType){this.itemSize+=2;this.colorOffset+=2*4;this.tangentOffset+=2*4;this.binormalOffset+=2*4;this.previousPositionOffset+=2*4;this.nextPositionOffset+=2*4;this.sideExtrusionOffset+=2*4;this.lineDistancesOffset+=2*4;this.skinIndexOffset+=2*4;this.skinWeightOffset+=2*4}if(l.COLOR&this.vbType){this.itemSize+=4;this.tangentOffset+=4*4;this.binormalOffset+=4*4;this.previousPositionOffset+=4*4;this.nextPositionOffset+=4*4;this.sideExtrusionOffset+=4*4;this.lineDistancesOffset+=4*4;this.skinIndexOffset+=4*4;this.skinWeightOffset+=4*4}if(l.TANGENT&this.vbType){this.itemSize+=3;this.binormalOffset+=3*4;this.previousPositionOffset+=3*4;this.nextPositionOffset+=3*4;this.sideExtrusionOffset+=3*4;this.lineDistancesOffset+=3*4;this.skinIndexOffset+=3*4;this.skinWeightOffset+=3*4}if(l.BINORMAL&this.vbType){this.itemSize+=3;this.previousPositionOffset+=3*4;this.nextPositionOffset+=3*4;this.sideExtrusionOffset+=3*4;this.lineDistancesOffset+=3*4;this.skinIndexOffset+=3*4;this.skinWeightOffset+=3*4}if(l.PREVIOUSPOS&this.vbType){this.itemSize+=3;this.nextPositionOffset+=3*4;this.sideExtrusionOffset+=3*4;this.lineDistancesOffset+=3*4;this.skinIndexOffset+=3*4;this.skinWeightOffset+=3*4}if(l.NEXTPOS&this.vbType){this.itemSize+=3;this.sideExtrusionOffset+=3*4;this.lineDistancesOffset+=3*4;this.skinIndexOffset+=3*4;this.skinWeightOffset+=3*4}if(l.SIDEEXTR&this.vbType){this.itemSize+=1;this.lineDistancesOffset+=1*4;this.skinIndexOffset+=1*4;this.skinWeightOffset+=1*4}if(l.LINEDIST&this.vbType){this.itemSize+=2;this.skinIndexOffset+=2*4;this.skinWeightOffset+=2*4}if(l.SKININDEX&this.vbType){this.itemSize+=4;this.skinWeightOffset+=4*4}if(l.SKINWEIGHT&this.vbType){this.itemSize+=4}};j.LensFlare.prototype.clone=function(l){if(l===undefined){l=new j.LensFlare()}j.Object3D.prototype.clone.call(this,l);l.positionScreen.copy(this.positionScreen);l.customUpdateCallback=this.customUpdateCallback;for(var m=0;m<this.lensFlares.length;m++){var n=this.lensFlares[m];var o={texture:n.texture,size:n.size,distance:n.distance,x:0,y:0,z:0,scale:1,rotation:1,opacity:n.opacity,color:n.color.clone(),blending:n.blending};l.lensFlares.push(o)}return l};j.ShaderFlares.lensFlareDepthMap={vertexShader:["uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uv;","vec2 pos = position;","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 screenPositionFlare;","uniform sampler2D tNormalDepth;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","void main() {","float visibility = 0.0;","float depth1 = texture2D( tNormalDepth, screenPositionFlare.xy ).w;","float depth2 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2( 0.005,  0.005) ).w;","float depth3 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2( 0.005, -0.005) ).w;","float depth4 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2(-0.005,  0.005) ).w;","float depth5 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2(-0.005, -0.005) ).w;","if ((depth1 == 0.0) || (screenPositionFlare.z < depth1)) visibility += 0.2;","if ((depth2 == 0.0) || (screenPositionFlare.z < depth2)) visibility += 0.2;","if ((depth3 == 0.0) || (screenPositionFlare.z < depth3)) visibility += 0.2;","if ((depth4 == 0.0) || (screenPositionFlare.z < depth4)) visibility += 0.2;","if ((depth5 == 0.0) || (screenPositionFlare.z < depth5)) visibility += 0.2;","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * visibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}"].join("\n")};j.LensFlarePlugin=function(){var n,o,l;this._lensFlare={};this.init=function(q){n=q.context;o=q;var r=this._lensFlare;l=q.getPrecision();r.vertices=new Float32Array(8+8);r.faces=new Uint16Array(6);var p=0;r.vertices[p++]=-1;r.vertices[p++]=-1;r.vertices[p++]=0;r.vertices[p++]=0;r.vertices[p++]=1;r.vertices[p++]=-1;r.vertices[p++]=1;r.vertices[p++]=0;r.vertices[p++]=1;r.vertices[p++]=1;r.vertices[p++]=1;r.vertices[p++]=1;r.vertices[p++]=-1;r.vertices[p++]=1;r.vertices[p++]=0;r.vertices[p++]=1;p=0;r.faces[p++]=0;r.faces[p++]=1;r.faces[p++]=2;r.faces[p++]=0;r.faces[p++]=2;r.faces[p++]=3;r.vertexBuffer=n.createBuffer();r.elementBuffer=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,r.vertexBuffer);n.bufferData(n.ARRAY_BUFFER,r.vertices,n.STATIC_DRAW);n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,r.elementBuffer);n.bufferData(n.ELEMENT_ARRAY_BUFFER,r.faces,n.STATIC_DRAW);r.program=m(j.ShaderFlares.lensFlareDepthMap,l);r.attributes={};r.uniforms={};r.attributes.vertex=n.getAttribLocation(r.program,"position");r.attributes.uv=n.getAttribLocation(r.program,"uv");r.uniforms.map=n.getUniformLocation(r.program,"map");r.uniforms.tNormalDepth={location:null,value:null};r.uniforms.tNormalDepth.location=n.getUniformLocation(r.program,"tNormalDepth");r.uniforms.opacity=n.getUniformLocation(r.program,"opacity");r.uniforms.color=n.getUniformLocation(r.program,"color");r.uniforms.scale=n.getUniformLocation(r.program,"scale");r.uniforms.rotation=n.getUniformLocation(r.program,"rotation");r.uniforms.screenPosition=n.getUniformLocation(r.program,"screenPosition");r.uniforms.screenPositionFlare=n.getUniformLocation(r.program,"screenPositionFlare")};this.dispose=function(){n.deleteBuffer(this._lensFlare.vertexBuffer);n.deleteBuffer(this._lensFlare.elementBuffer);n.deleteProgram(this._lensFlare.program)};this.render=function(I,F,B,p){var x=I.__webglFlares,K=x.length;if(!K||!o.lensFlareEnabled){return}var t=this._lensFlare;var G=new j.Vector3();var s=p/B,H=B*0.5,A=p*0.5;var y=16/p,L=new j.Vector2(y*s,y);var w=new j.Vector3(1,1,0),v=new j.Vector2(1,1);var J=t.uniforms,u=t.attributes;n.useProgram(t.program);n.enableVertexAttribArray(t.attributes.vertex);n.enableVertexAttribArray(t.attributes.uv);o.setTexture(J.tNormalDepth.value,0);n.uniform1i(J.tNormalDepth.location,0);n.uniform1i(J.map,1);n.bindBuffer(n.ARRAY_BUFFER,t.vertexBuffer);n.vertexAttribPointer(u.vertex,2,n.FLOAT,false,2*8,0);n.vertexAttribPointer(u.uv,2,n.FLOAT,false,2*8,8);n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.elementBuffer);n.disable(n.CULL_FACE);n.depthMask(false);var D,C,E,r,z;for(D=0;D<K;D++){y=16/p;L.set(y*s,y);r=x[D];G.set(r.matrixWorld.elements[12],r.matrixWorld.elements[13],r.matrixWorld.elements[14]);G.applyMatrix4(F.matrixWorldInverse);if(G.z>0){continue}G.applyProjection(F.projectionMatrix);var q=0.5+0.5*G.z;w.copy(G);v.x=w.x*H+H;v.y=w.y*A+A;if(v.x>0&&v.x<B&&v.y>0&&v.y<p){n.disable(n.DEPTH_TEST);n.uniform3f(J.screenPositionFlare,0.5*(w.x+1),0.5*(w.y+1),q);r.positionScreen.copy(w);if(r.customUpdateCallback){r.customUpdateCallback(r)}else{r.updateLensFlares()}n.uniform1i(J.renderType,2);n.enable(n.BLEND);for(C=0,E=r.lensFlares.length;C<E;C++){z=r.lensFlares[C];if(z.opacity>0.001&&z.scale>0.001){w.x=z.x;w.y=z.y;w.z=z.z;y=z.size*z.scale/p;L.x=y*s;L.y=y;n.uniform3f(J.screenPosition,w.x,w.y,w.z);n.uniform2f(J.scale,L.x,L.y);n.uniform1f(J.rotation,z.rotation);n.uniform1f(J.opacity,z.opacity);n.uniform3f(J.color,z.color.r,z.color.g,z.color.b);o.setBlending(z.blending,z.blendEquation,z.blendSrc,z.blendDst);o.setTexture(z.texture,1);n.drawElements(n.TRIANGLES,6,n.UNSIGNED_SHORT,0)}}}}n.enable(n.CULL_FACE);n.enable(n.DEPTH_TEST);n.depthMask(true)};function m(s,q){var r=n.createProgram();var p=n.createShader(n.FRAGMENT_SHADER);var u=n.createShader(n.VERTEX_SHADER);var t="precision "+q+" float;\n";n.shaderSource(p,t+s.fragmentShader);n.shaderSource(u,t+s.vertexShader);n.compileShader(p);n.compileShader(u);n.attachShader(r,p);n.attachShader(r,u);n.linkProgram(r);n.deleteShader(p);n.deleteShader(u);return r}};j.WebGLRenderer_backup=j.WebGLRenderer;j.WebGLRenderer=function(m){this.renderPoints=false;this.renderPointMode=j.AllPointsButSurfacicPointsRenderPointMask;this.renderLineMode=null;this.renderFaceMode=j.ShowAllFaces;this.renderFaces=true;this.renderHiddenEdges=false;this.outlineWidth=1;this.ratioSSB=100;this.colorizeSSB=false;this.pickPointsMode=2;this.pickLinesMode=1;this.pickFacesMode=2;j.WebGLRenderer_backup.call(this,m);var n=this;var l=this.getContext()};j.WebGLRenderer.prototype.computeRenderPriorityOpacity=function(l,n){var m=n?n.getRenderPriorityOpacity():null;if(m===null||m<0){m=this.renderPriorityDefaultOpacity}return m*l};j.WebGLRenderer.prototype.refreshUniformsLine=function(l,o,p){if(l.diffuse){var m=o.color;if(p&&!p.disableColorOverride&&p.getColor()){m=new j.Color(p.getColor())}l.diffuse.value=m}if(l.opacity){var n;n=o.opacity;if(p&&p.getOpacity()!==null){n=p.getOpacity()}if(this.useRenderPriorityOpacity){n=this.computeRenderPriorityOpacity(n,p)}l.opacity.value=n}if(l.pixelSize){l.pixelSize.value={x:o.pixelSize.x,y:o.pixelSize.y}}if(o.isDashedLine){l.scale.value=o.scale;l.dashPattern.value=o.dashPattern;l.totalSize.value=o.dashPattern[o.dashPattern.length-1];l.patternOffset.value=o.patternOffset}if(o.isWideLine||o.is2DLine){l.halfWidth.value=o.lineWidth/2}if(o.is2DLine){l.miterLimit.value=o.miterLimit}};j.WebGLRenderer.prototype.refreshUniformsPhysicalDSRoughnessMaps=function(m,p,o){var n=this.precomputedTexture1;if(m.precomputedTexture1&&n){m.precomputedTexture1.value=n;if(n&&n.onRequest){n.onRequest();n.onRequest=null}}n=this.precomputedTexture2;if(m.precomputedTexture2&&n){m.precomputedTexture2.value=n;if(n&&n.onRequest){n.onRequest();n.onRequest=null}}n=this.precomputedTexture3;if(m.precomputedTexture3&&n){m.precomputedTexture3.value=n;if(n&&n.onRequest){n.onRequest();n.onRequest=null}}if(p.envMipMap&&p.envMipMap[0]){m.envMap.value=p.envMipMap[0];m.envMap2.value=p.envMipMap[1];if(m.envMap.value&&m.envMap.value.hdr&&m.envMap.value.image){m.envMapHDRSize.value.x=parseInt(m.envMap.value.image.width);m.envMapHDRSize.value.y=parseInt(m.envMap.value.image.height)}var l=p.envMipMap[0].envMapExposure;m.envMapExposure.value=(l||(l===0))?l:1;m.ambienceMatrix.value=p.ambienceMatrix?p.ambienceMatrix:new j.Matrix4();if(p.useFiniteEnvMap){m.sphereCenter.value=p.parallaxCorrectionParameters.sphereCenter;m.sphereRadius.value=p.parallaxCorrectionParameters.sphereRadius;m.projectionCenter.value=p.parallaxCorrectionParameters.projectionCenter}}if(p.reflectionProbes&&p.reflectionProbes.length){m.reflectionProbe.value=p.reflectionProbes[0].map0;m.reflectionProbeMips.value=p.reflectionProbes[0].map1;m.reflectionProbePos.value=p.reflectionProbes[0].position;m.reflectionProbeProxyMin.value=p.reflectionProbes[0].geomProxy.min;m.reflectionProbeProxyMax.value=p.reflectionProbes[0].geomProxy.max}};j.createPlaneGeometryDS=function(l,w){var r=new j.BufferGeometryDS();r.vertexIndexArray=new Uint16Array(6);r.vertexPositionArray=new Float32Array(12);r.vertexNormalArray=new Float32Array(12);r.vertexUvArray=new Float32Array(12);var t=new d.SGRep({solid:false});var u=[];var m=new d.DrawingGroup(new j.MeshPhongMaterial({side:j.DoubleSide,color:new j.Color(16777215)}),null,4,0,6,u,undefined,j.GeomTypeEnum.UNKNOWN,0);m.geometry=r;r.drawingGroups.push(m);var q=new d.SGPrimitive({start:0,count:6,cgmId:0,rep:t,group:m});u.push(q);t.primitives.push(q);var v=r.vertexIndexArray;v[0]=0;v[1]=1;v[2]=3;v[3]=1;v[4]=2;v[5]=3;var p=r.vertexPositionArray;p[0]=-0.5*l;p[1]=0.5*w;p[2]=0;p[3]=-0.5*l;p[4]=-0.5*w;p[5]=0;p[6]=0.5*l;p[7]=-0.5*w;p[8]=0;p[9]=0.5*l;p[10]=0.5*w;p[11]=0;var s=r.vertexNormalArray;for(var o=0;o<4;o++){s[3*o]=0;s[3*o+1]=0;s[3*o+2]=1}var n=r.vertexUvArray;n[0]=0;n[1]=1;n[2]=0;n[3]=0;n[4]=0;n[5]=0;n[6]=1;n[7]=0;n[8]=0;n[9]=1;n[10]=1;n[11]=0;r.computeBoundingBox();r.computeBoundingSphere();return r};j.convertParticleSystemToBufferGeometryDS=function(t){if(!t||(t._type!==0)||!t.vertices){return}var m=t.vertices.length;var q=new j.BufferGeometryDS();q.vertexPositionArray=new Float32Array(3*m);q.vertexPositionArray.nonindexedPoints=true;q.vertexIndexArray=new Uint16Array(1);q.vertexIndexArray[0]=0;var r=new d.SGRep({solid:false});var s=[];var l=new d.DrawingGroup(new j.MeshPhongMaterial({side:j.DoubleSide,color:new j.Color(16777215)}),null,0,0,m,s,undefined,j.GeomTypeEnum.UNKNOWN,0);l.geometry=q;q.drawingGroups.push(l);var p=new d.SGPrimitive({start:0,count:m,cgmId:0,rep:r,group:l});s.push(p);r.primitives.push(p);var o=q.vertexPositionArray;for(var n=0;n<m;n++){o[3*n]=t.vertices[n].x;o[3*n+1]=t.vertices[n].y;o[3*n+2]=t.vertices[n].z}q.computeBoundingBox();q.computeBoundingSphere();return q};j.BufferGeometryDS=function(){j.EventDispatcher.call(this);this.id=j.GeometryIdCount++;this._type=2;this.needsUpdate=false;this.vertexBuffer=null;this.sharedBuffers=false;this.noMeshInRAM=false;this.vertexIndexArray=null;this.vertexPositionArray=null;this.vertexNormalArray=null;this.vertexUvArray=null;this.vertexUv2Array=null;this.vertexTangentArray=null;this.vertexBinormalArray=null;this.vertexColorArray=null;this.vertexLineDistancesArray=null;this.vertexPreviousPositionArray=null;this.vertexNextPositionArray=null;this.vertexSideExtrusionArray=null;this.vertexSkinIndexArray=null;this.vertexSkinWeightArray=null;this.vertexLayout={vertexIndexArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexPositionArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexNormalArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexUvArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:true},vertexUv2Array:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:true},vertexTangentArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexBinormalArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexColorArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexLineDistancesArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexPreviousPositionArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexNextPositionArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexSideExtrusionArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexSkinIndexArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexSkinWeightArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false}};this.dynamic=false;this.boundingBox=null;this.boundingSphere=null;this.drawingGroups=[];this.vboRef=0;this.meshList=[];this.wideLines=null;this.cpuPatternFrame=0;this.cpuPatternMode=false;this.line=null;this.editable=false;this.use32bitIndexBuffer=false;this.numBytesIndex=2;this.glFormatTypeIndex=5123;this.indexOffset=0;this.itemSize=1;this.numItems=1;this.compressedNormals=false;this.compressedVertices=false;this.quantizedVector=null;this.offsetVector=null};j.BufferGeometryDS.prototype={constructor:j.BufferGeometryDS,attributeName:["Position","Normal","Color","Uv","Uv2","Tangent","Binormal"],getVertexPositionArray:function(){if(this.compressedVertices&&this.vertexPositionArray){var o=this.vertexPositionArray.length/2;var p=new Float32Array(3*o);for(var n=0;n<o;n++){var m=this.vertexPositionArray[2*n];var q=this.vertexPositionArray[2*n+1];var l=this.uncompressPoint(m,q);p[3*n]=l.x;p[3*n+1]=l.y;p[3*n+2]=l.z}return p}return this.vertexPositionArray},getVertexPosition:function(l,m){if(!l){l=new j.Vector3()}if(this.vertexPositionArray){if(this.compressedVertices){return l.copy(this.uncompressPoint(this.vertexPositionArray[2*m],this.vertexPositionArray[2*m+1]))}return l.copy({x:this.vertexPositionArray[3*m],y:this.vertexPositionArray[3*m+1],z:this.vertexPositionArray[3*m+2]})}return null},getVertexNormal:function(l,m){if(!l){l=new j.Vector3()}if(this.vertexNormalArray){if(this.compressedNormals){return l.copy(this.uncompressNormal(this.vertexNormalArray[m]))}return l.copy({x:this.vertexNormalArray[3*m],y:this.vertexNormalArray[3*m+1],z:this.vertexNormalArray[3*m+2]})}return null},uncompressPoint:function(l,p){var o=this.quantizedVector.x*(Math.floor(l/256)+this.offsetVector.x);var m=this.quantizedVector.z*(Math.floor(p/256)+this.offsetVector.z);var n=this.quantizedVector.y*((l%256)*256+(p%256)+this.offsetVector.y);return{x:o,y:n,z:m}},uncompressNormal:function(l){var q=function(s){var r={x:0,y:0};r.x=Math.floor(s/4096)/4095;r.y=(s%4096)/4095;return r};var n=function(s){var r=function(t){return t>=0?1:-1};return{x:r(s.x),y:r(s.y)}};var p=new j.Vector3();var o=q(l);p.x=2*o.x-1;p.y=2*o.y-1;p.z=1-Math.abs(p.x)-Math.abs(p.y);if(p.z<=0){var m=n({x:p.x,y:p.y});p.x=-Math.abs(p.y)*m.x+m.x;p.y=-Math.abs(p.x)*m.y+m.y}return p.normalize()},primitiveIterator:function(m,u,y,s,x){if(!this.vertexIndexArray){console.log("Warning: no CPU picking in noMeshInRam");return 0}var w=this.drawingGroups;for(var q=0;q<w.length;q++){var t=w[q];var p=0;switch(t.glType){case 4:case 5:if(!u){continue}p=3;break;case 1:if(!s){continue}p=2;break;case 0:if(!y){continue}p=1;break;default:continue}var o=null;if(x.layer){o=x.layer.getIntervals(geometry,t)}for(var n=0;n<t.primitives.length;n++){var r=t.primitives[n];if(o!==null){var v=false;for(var l=o.length-1;l>=0;l--){if(o[l].start<=prim.start){if(o[l].layerNum<=0){v=true}break}}if(v){continue}}if(m(p,r)){return}}}},_intersectPrimitivesVolume:function(l,v,z,r,w,x,A,m,o,n){var D=new j.Vector3();var C=new j.Vector3();var B=new j.Vector3();var p=new j.Sphere();if(!this.vertexIndexArray){console.log("Warning: no CPU picking in noMeshInRam");return 0}var u=this;var y=function(E){var F=true;var I=false;for(var G=E.start;G<E.start+E.count;G++){u.getVertexPosition(D,u.vertexIndexArray[G]);D.applyMatrix4(o);var H=v.containsPoint(D);F=F&&H;I=I||H;if(!F&&I){break}}return{insideb:F,partialb:I}};var s=function(G){var H=true;var J=false;for(var I=G.start;I<G.start+G.count;I+=2){u.getVertexPosition(D,u.vertexIndexArray[I]);D.applyMatrix4(o);u.getVertexPosition(C,u.vertexIndexArray[I+1]);C.applyMatrix4(o);var F=v.containsPoint(D);var E=v.containsPoint(C);p.setFromCenterAndPoints(new j.Vector3((D.x+C.x)/2,(D.y+C.y)/2,(D.z+C.z)/2),[D,C]);H=H&&(F&&E);J=J||F||E||(v.intersectsSphere(p)&&v.intersectsLine([D,C]));if(!H&&J){break}}return{insideb:H,partialb:J}};var q=function(G){var H=true;var K=false;for(var I=G.start;I+2<G.start+G.count;I++){u.getVertexPosition(D,u.vertexIndexArray[I]);D.applyMatrix4(o);u.getVertexPosition(C,u.vertexIndexArray[I+1]);C.applyMatrix4(o);u.getVertexPosition(B,u.vertexIndexArray[I+2]);B.applyMatrix4(o);p.setFromCenterAndPoints(new j.Vector3((D.x+C.x+B.x)/3,(D.y+C.y+B.y)/3,(D.z+C.z+B.z)/3),[D,C,B]);var F=v.containsPoint(D);var E=v.containsPoint(C);var J=v.containsPoint(B);H=H&&(F&&E&&J);K=K||F||E||J||(v.intersectsSphere(p)&&v.intersectsTriangle([D,C,B]));if(!H&&K){break}}return{insideb:H,partialb:K}};var t=function(G,F){var E;switch(G){case 1:E=y(F);break;case 2:E=s(F);break;case 3:E=q(F);break;default:console.error("Error: requiredVectors can't be equal to 0");return}var H={primitive:F,geometry:u,object:l};if(!E.insideb){if(E.partialb){m.push(H);return n}else{A.push(H)}}else{x.push(H)}return false};this.primitiveIterator(t,z,r,w,l)},_intersectVolume:function(t,n,l,r,s,o){if(!this.vertexIndexArray){console.log("Warning: no CPU picking in noMeshInRam");return 0}var m=[];var q=[];var p=[];this._intersectPrimitivesVolume(t,n,l,r,s,m,p,q,o,true);if(q.length>0||(p.length>0&&m.length>0)){return 1}return p.length>0?0:2},computeBoundingBox:function(){var m=[0,0,0];var l=[0,0,0];var r=this.vertexPositionArray;if(r){var p=r.length;if(p>=1){m=[Infinity,Infinity,Infinity];l=[-Infinity,-Infinity,-Infinity];if(this.compressedVertices){for(var q=0;q<p;q+=2){if(isNaN(r[q])){continue}var o=this.uncompressPoint(r[q],r[q+1]);if(o.x<m[0]){m[0]=o.x}if(o.y<m[1]){m[1]=o.y}if(o.z<m[2]){m[2]=o.z}if(o.x>l[0]){l[0]=o.x}if(o.y>l[1]){l[1]=o.y}if(o.z>l[2]){l[2]=o.z}}}else{for(var q=0;q<p;q+=3){if(isNaN(r[q])){continue}if(r[q]<m[0]){m[0]=r[q]}if(r[q+1]<m[1]){m[1]=r[q+1]}if(r[q+2]<m[2]){m[2]=r[q+2]}if(r[q]>l[0]){l[0]=r[q]}if(r[q+1]>l[1]){l[1]=r[q+1]}if(r[q+2]>l[2]){l[2]=r[q+2]}}}}}m=new j.Vector3(m[0],m[1],m[2]);l=new j.Vector3(l[0],l[1],l[2]);this.boundingBox=new j.Box3(m,l);return this.boundingBox},computeOrientedBoundingBox:function(z,w){if(!z){return null}var l=new j.Vector3();var r=new j.Vector3();var y=new j.Vector3();var x=this.vertexPositionArray;if(x){var o=x.length;if(o>=1){if(w){var t=true;for(var s=0;s<w.length;s++){var u=w[s];if(!u.layerNum){continue}if(!u.count){continue}if(t){t=false;var v=this.vertexIndexArray[u.start];if(this.compressedVertices){v*=2;var p=this.uncompressPoint(x[2*v],x[2*v+1]);r.set(p.x,p.y,p.z).applyMatrix4(z);y.set(p.x,p.y,p.z).applyMatrix4(z)}else{v*=3;r.set(x[v],x[v+1],x[v+2]).applyMatrix4(z);y.set(x[v],x[v+1],x[v+2]).applyMatrix4(z)}}for(var q=u.start;q<u.start+u.count;q++){var v=this.vertexIndexArray[q];if(this.compressedVertices){v*=2;var p=this.uncompressPoint(x[v],x[v+1]);l.set(p.x,p.y,p.z).applyMatrix4(z)}else{v*=3;l.set(x[v],x[v+1],x[v+2]).applyMatrix4(z)}if(l.x<r.x){r.x=l.x}if(l.y<r.y){r.y=l.y}if(l.z<r.z){r.z=l.z}if(l.x>y.x){y.x=l.x}if(l.y>y.y){y.y=l.y}if(l.z>y.z){y.z=l.z}}}}else{if(this.compressedVertices){var p=this.uncompressPoint(x[0],x[1]);r.set(p.x,p.y,p.z).applyMatrix4(z);y.set(p.x,p.y,p.z).applyMatrix4(z);for(var m=0;m<o;m+=2){var p=this.uncompressPoint(x[m],x[m+1]);l.set(p.x,p.y,p.z).applyMatrix4(z);if(l.x<r.x){r.x=l.x}if(l.y<r.y){r.y=l.y}if(l.z<r.z){r.z=l.z}if(l.x>y.x){y.x=l.x}if(l.y>y.y){y.y=l.y}if(l.z>y.z){y.z=l.z}}}else{r.set(x[0],x[1],x[2]).applyMatrix4(z);y.set(x[0],x[1],x[2]).applyMatrix4(z);for(var m=0;m<o;m+=3){l.set(x[m],x[m+1],x[m+2]).applyMatrix4(z);if(l.x<r.x){r.x=l.x}if(l.y<r.y){r.y=l.y}if(l.z<r.z){r.z=l.z}if(l.x>y.x){y.x=l.x}if(l.y>y.y){y.y=l.y}if(l.z>y.z){y.z=l.z}}}}}}return new j.Box3(r,y)},computeBoundingSphere:function(){if(!this.boundingSphere){this.boundingSphere=new j.Sphere()}var l=this.boundingBox;if(l){this.boundingSphere.radius=l.max.clone().sub(l.min).multiplyScalar(0.5).length();this.boundingSphere.center=l.max.clone().add(l.min).multiplyScalar(0.5)}},computeUVs:function(A){if(this.vertexUvArray){return}var q=this.vertexPositionArray;var o=new Float32Array(this.compressedVertices?1.5*q.length:q.length);this.vertexUvArray=o;if(!this.vertexNormalArray){return}if(!A){A=this.computeBoundingBox()}var w=[A.min.x,A.min.y,A.min.z];var r=[A.max.x-A.min.x,A.max.y-A.min.y,A.max.z-A.min.z];for(var p=0;p<o.length/3;p++){var s=3*p;var t=new j.Vector3();this.getVertexNormal(t,p);var x=Math.abs(t.x);var B=Math.abs(t.y);var n=0;if(B>x){x=B;n=1}B=Math.abs(t.z);if(B>x){x=B;n=2}var z=(n+1)%3;var y=(n+2)%3;var l;if(this.compressedVertices){var m=this.uncompressPoint(q[2*p],q[2*p+1]);l=[m.x,m.y,m.z]}else{l=[q[s],q[s+1],q[s+2]]}o[s]=(l[z]-w[z])/Math.min(r[z],r[y]);o[s+1]=(l[y]-w[y])/Math.min(r[z],r[y]);o[s+2]=0}},computeTangents:function(y){if(this.vertexBinormalArray&&this.vertexTangentArray){return}if(this.vertexTangentArray){var v=this.vertexTangentArray;var R=new j.Vector3();var r=new j.Vector3();var m=new j.Vector3();this.vertexBinormalArray=new Float32Array(v.length);for(var G=0;G<v.length;G+=3){this.getVertexNormal(R,G/3);R.normalize();r.set(this.vertexTangentArray[G],this.vertexTangentArray[G+1],this.vertexTangentArray[G+2]);r.normalize();m.crossVectors(R,r);this.vertexBinormalArray[G]=m.x;this.vertexBinormalArray[G+1]=m.y;this.vertexBinormalArray[G+2]=m.z}return}var G=0,B=0,z=0,w=0,p=new j.Vector3(),o=new j.Vector3(),n=new j.Vector3(),M=new j.Vector2(),K=new j.Vector2(),I=new j.Vector2(),E=new j.Vector2(),D=new j.Vector2(),H=new j.Vector3(),F=new j.Vector3(),O=new j.Vector3(),R=new j.Vector3(),r=new j.Vector3(),m=new j.Vector3(),x=new j.Vector3(),Q=0,P=0,N=0,u=0,t=0,s=0,A=0;var v,q;if(this.compressedVertices){v=new Float32Array(1.5*this.vertexPositionArray.length);q=new Float32Array(1.5*this.vertexPositionArray.length)}else{v=new Float32Array(this.vertexPositionArray.length);q=new Float32Array(this.vertexPositionArray.length)}if(!this.vertexTangentArray){this.vertexTangentArray=v}if(!this.vertexBinormalArray){this.vertexBinormalArray=q}for(G=0;G<v.length;G++){v[G]=0;q[G]=0}for(var C=0;C<this.drawingGroups.length;C++){var L=this.drawingGroups[C];if(L.glType!==4){continue}for(G=L.start;G<L.start+L.count;G+=3){B=this.vertexIndexArray[G];z=this.vertexIndexArray[G+1];w=this.vertexIndexArray[G+2];this.getVertexPosition(p,B);this.getVertexPosition(o,z);this.getVertexPosition(n,w);M.set(this.vertexUvArray[3*B],this.vertexUvArray[3*B+1]);K.set(this.vertexUvArray[3*z],this.vertexUvArray[3*z+1]);I.set(this.vertexUvArray[3*w],this.vertexUvArray[3*w+1]);H.subVectors(o,p);F.subVectors(n,p);E.subVectors(K,M);D.subVectors(I,M);var J=E.x*D.y-D.x*E.y;if(Math.abs(J)>1e-8){J=1/J;Q=J*(D.y*H.x-E.y*F.x);P=J*(D.y*H.y-E.y*F.y);N=J*(D.y*H.z-E.y*F.z);u=J*(E.x*F.x-D.x*H.x);t=J*(E.x*F.y-D.x*H.y);s=J*(E.x*F.z-D.x*H.z)}else{Q=1;P=0;N=0;u=0;t=1;s=0}v[3*B]+=Q;v[3*z]+=Q;v[3*w]+=Q;v[3*B+1]+=P;v[3*z+1]+=P;v[3*w+1]+=P;v[3*B+2]+=N;v[3*z+2]+=N;v[3*w+2]+=N;q[3*B]+=u;q[3*z]+=u;q[3*w]+=u;q[3*B+1]+=t;q[3*z+1]+=t;q[3*w+1]+=t;q[3*B+2]+=s;q[3*z+2]+=s;q[3*w+2]+=s}}for(G=0;G<v.length;G+=3){this.getVertexNormal(R,G/3);r.set(v[G],v[G+1],v[G+2]);m.set(q[G],q[G+1],q[G+2]);r.normalize();m.normalize();A=R.dot(r);x=new j.Vector3().copy(r);x.sub(O.copy(R).multiplyScalar(A));x.normalize();v[G]=x.x;v[G+1]=x.y;v[G+2]=x.z;q[G]=m.x;q[G+1]=m.y;q[G+2]=m.z}},computeLineDistances:function(B){this.cpuPatternMode=false;var z=0;var r=[];var o=this.vertexPositionArray;var m=this.vertexIndexArray;var q=B&&B.length===m.length;var v,t,C=new j.Vector3(),A=new j.Vector3();for(var x=0;x<this.drawingGroups.length;x++){var y=this.drawingGroups[x];var l=y.start;var p=y.count;for(var w=0;w<p;w++){z=0;var u=w+l;var n=0;if(q){n=B[u]}if(w>0){if(this.compressedVertices){v=2*m[u];t=2*m[u-1];if(v===t){continue}var s=this.uncompressPoint(o[v],o[v+1]);C.x=s.x;C.y=s.y;C.z=s.z;s=this.uncompressPoint(o[t],o[t+1]);A.x=s.x;A.y=s.y;A.z=s.z}else{v=3*m[u];t=3*m[u-1];if(v===t){continue}C.x=o[v];C.y=o[v+1];C.z=o[v+2];A.x=o[t];A.y=o[t+1];A.z=o[t+2]}z=C.distanceTo(A);if(Math.abs(z)>0.000001&&!(w%2)){r[2*m[u]]=n;r[2*m[u]+1]=n}else{r[2*m[u]]=n+z+r[2*m[u-1]];r[2*m[u]+1]=n+z+r[2*m[u-1]]}}else{r[2*m[u]]=n;r[2*m[u]+1]=n}}}this.needsUpdate=true;this.vertexLineDistancesArray=new Float32Array(r)},_computeWideLineDistances:function(){this.cpuPatternMode=false;var o=[];var x=this.line.vertexLineDistancesArray;for(var v=0;v<this.drawingGroups.length;v++){var u=this.drawingGroups[v];var n=u.lineStructure.sides;var y=u.lineStructure.primitives;var m=0;for(var s=0;s<y.length;s++){var z=y[s];for(var q=0;q<z.length;q++){var w=z[q];var l=((w.endLine||w.begLine)&&(!w.isLoopedWith&&!w.fusedWith)?2:4);for(var p=0;p<l;p++){var t=x[2*w.cur];if(n[m]%2===0){o.push(t);if(w.isLoopedWith){o.push(t)}else{if(w.fusedWith){var r=y[w.fusedWith.primIndex][0];r=x[2*r.cur];if(Math.abs(r-t)<0.000001){o.push(x[2*w.next])}else{o.push(t)}}else{o.push(x[2*w.next])}}}else{o.push(x[2*w.prev]);o.push(t)}m++}}}}this.needsUpdate=true;this.vertexLineDistancesArray=new Float32Array(o)},computeWideLineDistances:function(){this.line.computeLineDistances([]);this._computeWideLineDistances()},computePixelLineDistances:function(l,G,F,z){if(this.cpuPatternFrame>=z){return}this.cpuPatternMode=true;this.cpuPatternFrame=z;var C=0;var t=[];var r=new j.Matrix4();r.multiplyMatrices(G,l);var p=this.vertexPositionArray;var n=this.vertexIndexArray;var x,v,E=new j.Vector4(),D=new j.Vector4();var H=new j.Vector2();var o=new j.Vector2();for(var A=0;A<this.drawingGroups.length;A++){var B=this.drawingGroups[A];var m=B.start;var q=B.count;for(var y=0,s=q;y<s;y++){C=0;var w=y+m;if(y>0){if(this.compressedVertices){x=2*n[w];v=2*n[w-1];if(x===v){continue}var u=this.uncompressPoint(p[x],p[x+1]);E.x=u.x;E.y=u.y;E.z=u.z;u=this.uncompressPoint(p[v],p[v+1]);D.x=u.x;D.y=u.y;D.z=u.z}else{x=3*n[w];v=3*n[w-1];if(x===v){continue}E.x=p[x];E.y=p[x+1];E.z=p[x+2];D.x=p[v];D.y=p[v+1];D.z=p[v+2]}E.w=1;E.applyMatrix4(r);D.w=1;D.applyMatrix4(r);H.x=0.5*((E.x/E.w)+1)*F.width;H.y=0.5*((E.y/E.w)+1)*F.height;o.x=0.5*((D.x/D.w)+1)*F.width;o.y=0.5*((D.y/D.w)+1)*F.height;C=H.distanceTo(o);if(Math.abs(C)>0.000001&&!(y%2)){t[2*n[w]]=0;t[2*n[w]+1]=0}else{t[2*n[w]]=C+t[2*n[w-1]];t[2*n[w]+1]=C+t[2*n[w-1]]}}else{t[2*n[w]]=0;t[2*n[w]+1]=0}}}this.needsUpdate=true;this.vertexLineDistancesArray=new Float32Array(t)},computePixelWideLineDistances:function(m,D,C,x){if(this.cpuPatternFrame>=x){return}this.cpuPatternMode=true;this.cpuPatternFrame=x;this.line.computePixelLineDistances(m,D,C,x);var r=[];var n=this.line.vertexLineDistancesArray;for(var z=0;z<this.drawingGroups.length;z++){var A=this.drawingGroups[z];var q=A.lineStructure.primitives;var B=A.lineStructure.sides;var o=0;for(var w=0;w<q.length;w++){var s=q[w];for(var v=0;v<s.length;v++){var p=s[v];var y=((p.endLine||p.begLine)&&(!p.isLoopedWith&&!p.fusedWith)?2:4);for(var u=0;u<y;u++){var t=n[2*p.cur];if(B[o]%2===0){r.push(t);if(p.isLoopedWith){r.push(t)}else{if(p.fusedWith){var l=q[p.fusedWith.primIndex][0];l=n[2*l.cur];if(Math.abs(l-t)<0.000001){r.push(n[2*p.next])}else{r.push(t)}}else{r.push(n[2*p.next])}}}else{r.push(n[2*p.prev]);r.push(t)}o++}}}}this.needsUpdate=true;this.vertexLineDistancesArray=new Float32Array(r)},computeWideLine:function(ah,Z){if(!this.wideLines||(this.wideLines.vertexBuffer&&this.wideLines.vertexBuffer.needsUpdate)){if(this.wideLines){this.wideLines.dispose()}this.wideLines=new j.BufferGeometryDS();this.wideLines.editable=this.editable;this.wideLines.dgIds=0;this.wideLines.line=this}var M=this.wideLines.drawingGroups;var P=null;for(var af=0;af<M.length;af++){if(ah.idWideLine===M[af].idWideLine){P=M[af];break}}if(P){return P}var P=new d.DrawingGroup();if(ah instanceof d.DrawingGroup){P=ah.clone()}else{P.gas=ah.gas;P.gasIndex=ah.gasIndex;P._geomType=ah._geomType;P.layers=ah.layers;P.material=ah.material;P.copyPrimitives(ah.primitives);P.count=ah.count}P.geometry=this.wideLines;P.glType=4;ah.idWideLine=this.wideLines.dgIds;P.idWideLine=this.wideLines.dgIds++;var K=this;var u=this.vertexPositionArray;var W=function(aj,ai){var l=0.000001;var am=u;if(K.compressedVertices){var al=K.uncompressPoint(am[2*aj],am[2*aj+1]);var ak=K.uncompressPoint(am[2*ai],am[2*ai+1]);return Math.abs(al.x-ak.x)<l&&Math.abs(al.y-ak.y)<l&&Math.abs(al.z-ak.z)<l}return Math.abs(am[3*aj]-am[3*ai])<l&&Math.abs(am[3*aj+1]-am[3*ai+1])<l&&Math.abs(am[3*aj+2]-am[3*ai+2])<l};var L=function(an){var ap=[];var ao=0;for(var am=0;am<ah.primitives.length;am++){var aj=ah.primitives[am];var ai;if(!P.primitives&&!P.primitives[am]){ai=new d.Primitive();ai.cgmId=aj.cgmId;ai.decoration=aj.decoration;ai.group=P;ai.rep=aj.rep;ai.type=aj.type;ai.start=aj.start;ai.count=aj.count;P.primitives[am]=ai}else{ai=P.primitives[am]}ap.push([]);for(var ak=aj.start;ak<aj.start+aj.count;ak++){var al=(ak-aj.start)%2;ao=an[ak];var l={cur:ao,prev:al?an[ak-1]:ao,next:al?ao:an[ak+1],begLine:false,endLine:false,fusedBack:false,fusedWith:null};ap[am].push(l)}}return ap};var E=L(this.vertexIndexArray);var ab=function(ap){var l=[];for(var ao=0;ao<ap.length;ao++){l.push([]);J=ap[ao];if(J.length<1){continue}for(var am=0;am<J.length;am++){var an=J[am];if(an.cur!==an.next){l[ao].push(an)}else{if(am<J.length-1){var ai=am+1;var aj=J[ai];if(an.cur===aj.cur){for(var al=am+2;al<J.length;al++){if(an.cur===J[al].cur){ai=al}else{break}}aj=J[ai];var ak={cur:an.cur,next:aj.next,prev:an.prev,begLine:false,endLine:false,fusedBack:false,fusedWith:null};am=ai;l[ao].push(ak)}else{l[ao].push(an)}}else{l[ao].push(an)}}}}return l};E=ab(E);var B=function(l,am){for(var aj=0;aj<l.length;aj++){var al=l[aj];if(al.length<1){continue}for(var ai=0;ai<al.length;ai++){var ak=al[ai];am(ak,al,ai)}}};var y=function(l){if(l.next===l.cur){l.endLine=true}else{if(l.prev===l.cur){l.begLine=true}}};B(E,y);var A=function(ak,aj,ai){if(ak.endLine&&ai<aj.length-1){var l=aj[ai+1];if(l.begLine&&W(ak.cur,l.cur)){ak.endLine=false;l.begLine=false}}};B(E,A);var s=function(ak,aj,ai){if(W(ak.cur,ak.next)&&!ak.endLine&&!ak.begLine){for(var al=ai+1;al<aj.length;al++){var l=aj[al];if(!W(ak.cur,l.cur)){break}l.prev=ak.prev;if(l.endLine){break}if(!W(l.next,l.cur)){ak.next=l.next;ak.endSkip=true;l.baseSkip=true}else{if(!l.colorIndex){l.colorIndex=ak.cur}}}}};B(E,s);var C=new j.Vector3();var X=function(av){if(av.length<2){return}var at=[];for(var au=0;au<av.length;au++){var aw=av[au];if(aw.length<1){continue}var ax=aw[aw.length-1];var l=aw[0];if(W(ax.cur,ax.next)){K.getVertexPosition(C,ax.cur);at.push([C.x,C.y,C.z,au,1])}if(W(l.prev,l.cur)){K.getVertexPosition(C,l.cur);at.push([C.x,C.y,C.z,au,0])}}var ai=function(aB,aA){var aD=aB[0]-aA[0];if(Math.abs(aD)<0.000001){var aC=aB[1]-aA[1];if(Math.abs(aC)<0.000001){var ay=aB[2]-aA[2];if(Math.abs(ay)<0.000001){var az=aB[3]-aA[3];if(az===0){return 0}return az>0?1:-1}else{return ay>0?1:-1}}else{return aC>0?1:-1}}else{return aD>0?1:-1}};at.sort(ai);for(var al=0;al<at.length;al++){var an=at[al];if(an[4]===0){continue}for(var ak=al+1;ak<at.length;ak++){var aj=at[ak];if(aj[4]===1||aj[3]===an[3]){continue}var ar=Math.abs(an[0]-aj[0]);if(ar<0.000001){var aq=Math.abs(an[1]-aj[1]);if(aq<0.000001){var ao=Math.abs(an[2]-aj[2]);if(ao<0.000001){var aw=av[an[3]];var ax=aw[aw.length-1];var am=av[aj[3]];var ap=am[0];if(!ap.fusedBack){ax.next=ap.next;ap.prev=ax.prev;ax.fusedWith={primIndex:aj[3]};ap.fusedBack=true;break}}}}break}}};X(E);var N=function(am,al,ak){var ai=al.length;if(am.begLine){for(var an=ak+1;an<ai;an++){var aj=al[an];if(aj.endLine){if(an-ak>1&&W(aj.cur,am.cur)){aj.isLoopedWith=true;am.prev=aj.prev;aj.next=am.next}break}}}};B(E,N);P.lineStructure.primitives=E.slice(0);var m=[];var F=[];var o=[];var ad=[];var ag=0;for(var af=0;af<E.length;af++){var J=E[af];for(var ae=0;ae<J.length;ae++){var x=J[ae];var O=((x.endLine||x.begLine)&&!x.isLoopedWith&&!x.fusedWith?2:4);x.indRef=ag;x.inds=[];for(var ac=0;ac<O;ac++){x.inds.push(ag);ad[ag]=((ac%2)===0?1:-1);if(O===4){if(ac<2){ad[ag]*=1}else{ad[ag]*=2}}else{if(x.begLine){ad[ag]*=2}}if(this.compressedVertices){var T=this.uncompressPoint(u[2*x.cur],u[2*x.cur+1]);m[3*ag]=T.x;m[3*ag+1]=T.y;m[3*ag+2]=T.z;T=this.uncompressPoint(u[2*x.prev],u[2*x.prev+1]);F[3*ag]=T.x;F[3*ag+1]=T.y;F[3*ag+2]=T.z;T=this.uncompressPoint(u[2*x.next],u[2*x.next+1]);o[3*ag]=T.x;o[3*ag+1]=T.y;o[3*ag+2]=T.z}else{for(var Y=0;Y<3;Y++){m[3*ag+Y]=u[3*x.cur+Y];F[3*ag+Y]=u[3*x.prev+Y];o[3*ag+Y]=u[3*x.next+Y]}}ag++}}}P.lineStructure.sides=ad.slice(0);var S=null;if(this.vertexColorArray){S=[];var ag=0;for(var af=0;af<E.length;af++){var J=E[af];for(var ae=0;ae<J.length;ae++){var x=J[ae];var O=((x.endLine||x.begLine)&&!x.isLoopedWith&&!x.fusedWith?2:4);for(var ac=0;ac<O;ac++){var t=x.colorIndex>=0?x.colorIndex:x.cur;for(var Y=0;Y<4;Y++){S[4*ag+Y]=this.vertexColorArray[4*t+Y]}ag++}}}}var U=null;if(!this.vertexLineDistancesArray&&(Z.isDashedLine)){console.warn("DEPRECATED: Use createLineNode to create your lines correctly");this.computeLineDistances([])}if(!this.vertexLineDistancesArray&&(Z.politeMaterial)){this.computeLineDistances([])}if(this.vertexLineDistancesArray&&this.wideLines.vertexBuffer&&this.wideLines.vertexBuffer.needsUpdate){this.computeLineDistances([])}if(this.vertexLineDistancesArray){U=[];var ag=0;for(var af=0;af<E.length;af++){var J=E[af];for(var ae=0;ae<J.length;ae++){var x=J[ae];var O=((x.endLine||x.begLine)&&(!x.isLoopedWith&&!x.fusedWith)?2:4);for(var ac=0;ac<O;ac++){var z=this.vertexLineDistancesArray[2*x.cur];if(ad[ag]%2===0){U.push(z);if(x.isLoopedWith){U.push(z)}else{if(x.fusedWith){var V=E[x.fusedWith.primIndex][0];V=this.vertexLineDistancesArray[2*V.cur];if(Math.abs(V-z)<0.000001){U.push(this.vertexLineDistancesArray[2*x.next])}else{U.push(z)}}else{U.push(this.vertexLineDistancesArray[2*x.next])}}}else{U.push(this.vertexLineDistancesArray[2*x.prev]);U.push(z)}ag++}}}}var p=[];var n=0;for(var af=0;af<E.length;af++){var J=E[af];if(J.length<1){continue}var I=P.primitives[af];var w=ah.primitives[af];var q=I.count;I.count=0;var ae=0;for(ae=0;ae<J.length;ae++){var r=J[ae];var D=r.inds;if(r.endLine||r.begLine){if(r.endLine){if(r.isLoopedWith){p.push(D[0]);p.push(D[1]);p.push(D[2]);p.push(D[3]);p.push(D[2]);p.push(D[1]);I.count+=6}continue}var H=J[ae+1].inds;p.push(D[0]);p.push(D[1]);p.push(H[0]);p.push(H[1]);p.push(H[0]);p.push(D[1]);I.count+=6}else{if(!r.baseSkip){p.push(D[0]);p.push(D[1]);p.push(D[2]);p.push(D[3]);p.push(D[2]);p.push(D[1]);I.count+=6}if(!r.endSkip){var H=J[ae+1].inds;p.push(D[2]);p.push(D[3]);p.push(H[0]);p.push(H[1]);p.push(H[0]);p.push(D[3]);I.count+=6}}}var R=J[J.length-1].fusedWith;if(R){var v=J[ae-1].inds;p.push(v[0]);p.push(v[1]);p.push(v[2]);p.push(v[3]);p.push(v[2]);p.push(v[1]);I.count+=6}I.start=n;n+=I.count}var Q={count:p.length,start:0};var G=0;if(this.wideLines.vertexPositionArray){G=this.wideLines.vertexPositionArray.length/3;m=Array.prototype.slice.call(this.wideLines.vertexPositionArray).concat(m)}if(this.wideLines.vertexPreviousPositionArray){F=Array.prototype.slice.call(this.wideLines.vertexPreviousPositionArray).concat(F)}if(this.wideLines.vertexNextPositionArray){o=Array.prototype.slice.call(this.wideLines.vertexNextPositionArray).concat(o)}if(this.wideLines.vertexSideExtrusionArray){ad=Array.prototype.slice.call(this.wideLines.vertexSideExtrusionArray).concat(ad)}if(this.wideLines.vertexColorArray){S=Array.prototype.slice.call(this.wideLines.vertexColorArray).concat(S)}if(this.wideLines.vertexLineDistancesArray){if(G-this.wideLines.vertexLineDistancesArray.length/2>0){this.wideLines._computeWideLineDistances()}U=Array.prototype.slice.call(this.wideLines.vertexLineDistancesArray).concat(U)}else{if(U!==null&&U.length>0&&G>0){this.wideLines._computeWideLineDistances();U=Array.prototype.slice.call(this.wideLines.vertexLineDistancesArray).concat(U)}}if(this.wideLines.vertexIndexArray){Q.start=this.wideLines.vertexIndexArray.length;p.forEach(function(ai,l,aj){aj[l]+=G});p=Array.prototype.slice.call(this.wideLines.vertexIndexArray).concat(p)}this.wideLines.vertexPositionArray=new Float32Array(m);this.wideLines.vertexPreviousPositionArray=new Float32Array(F);this.wideLines.vertexNextPositionArray=new Float32Array(o);this.wideLines.vertexSideExtrusionArray=new Float32Array(ad);if(S){this.wideLines.vertexColorArray=new Float32Array(S)}if(U){this.wideLines.vertexLineDistancesArray=new Float32Array(U)}if(m.length>196608&&j.supportedExtensions.elementIndexUint){this.wideLines.vertexIndexArray=new Uint32Array(p)}else{this.wideLines.vertexIndexArray=new Uint16Array(p)}P.start=Q.start;P.count=Q.count;this.wideLines.drawingGroups.push(P);return P},deallocate:function(n,m){if(this.vertexBuffer!==null){this.vertexBuffer.nbGeometries--;if(m){m.memory.geometries--}var l=this.vertexBuffer.geometries.indexOf(this);this.vertexBuffer.geometries.splice(l,1);if(this.vertexBuffer.nbGeometries==0){n.deleteBuffer(this.vertexBuffer.buffer);n.deleteBuffer(this.vertexBuffer.indexBuffer);if(m&&this.vertexBuffer.isShared===true){m.memory.sharedbuffers--}}}this.vertexBuffer=null},addRefVBO:function(m){this.vboRef++;this.meshList.push(m);var l=function(p){if(p&&p._source===j.AssetSource.MATERIAL_MANAGER){p._useCount++;for(var q in p){if(p.hasOwnProperty(q)&&p[q] instanceof j.Texture){var r=p[q];if(r._source===j.AssetSource.MATERIAL_MANAGER){r._useCount++}}}l(p.line);l(p.point)}};l(m.material);l(m.gas);for(var n=0;n<this.drawingGroups.length;n++){var o=this.drawingGroups[n];l(o.material);l(o.gas)}},releaseVBO:function(o){var m=function(q){if(q&&q._source===j.AssetSource.MATERIAL_MANAGER){q._useCount--;if(q._useCount<=0){q.dispose()}for(var r in q){if(q.hasOwnProperty(r)&&q[r] instanceof j.Texture){var s=q[r];if(s._source===j.AssetSource.MATERIAL_MANAGER){s._useCount--;if(s._useCount<=0){s.dispose()}}}}m(q.line);m(q.point)}};this.vboRef--;if(this.vboRef===0){this.dispatchEvent({type:"dispose"});if(this.wideLines){this.wideLines.dispatchEvent({type:"dispose"})}}else{var l=this.meshList.indexOf(o);if(l!==-1){this.meshList.splice(l,1);m(o.material);m(o.gas);for(var n=0;n<this.drawingGroups.length;n++){var p=this.drawingGroups[n];m(p.material);m(p.gas)}}else{console.warn("BufferGeometryDS tried to break the link with a THREE.Mesh, but it failed !")}}},dispose:function(){this.dispatchEvent({type:"dispose"})},clone:function(){var p=new j.BufferGeometryDS();p.vertexIndexArray=this.vertexIndexArray?new Uint16Array(this.vertexIndexArray):null;p.vertexPositionArray=this.vertexPositionArray?new Float32Array(this.vertexPositionArray):null;p.vertexNormalArray=this.vertexNormalArray?new Float32Array(this.vertexNormalArray):null;p.vertexUvArray=this.vertexUvArray?new Float32Array(this.vertexUvArray):null;p.vertexUv2Array=this.vertexUv2Array?new Float32Array(this.vertexUv2Array):null;p.vertexTangentArray=this.vertexTangentArray?new Float32Array(this.vertexTangentArray):null;p.vertexBinormalArray=this.vertexBinormalArray?new Float32Array(this.vertexBinormalArray):null;p.vertexColorArray=this.vertexColorArray?new Float32Array(this.vertexColorArray):null;p.vertexPreviousPositionArray=this.vertexPreviousPositionArray?new Float32Array(this.vertexPreviousPositionArray):null;p.vertexNextPositionArray=this.vertexNextPositionArray?new Float32Array(this.vertexNextPositionArray):null;p.vertexSideExtrusionArray=this.vertexSideExtrusionArray?new Float32Array(this.vertexSideExtrusionArray):null;p.vertexLineDistancesArray=this.vertexLineDistancesArray?new Float32Array(this.vertexLineDistancesArray):null;p.vertexSkinIndexArray=this.vertexSkinIndexArray?new Float32Array(this.vertexSkinIndexArray):null;p.vertexSkinWeightArray=this.vertexSkinWeightArray?new Float32Array(this.vertexSkinWeightArray):null;p.boundingBox=this.boundingBox?this.boundingBox.clone():null;p.boundingSphere=this.boundingSphere?this.boundingSphere.clone():null;p.compressedNormals=this.compressedNormals;p.compressedVertices=this.compressedVertices;p.offsetVector=this.offsetVector;p.quantizedVector=this.quantizedVector;p.drawingGroups=[];for(var o=0;o<this.drawingGroups.length;o++){var r=this.drawingGroups[o];var q=[];var l=new d.DrawingGroup(r.gas,r.material,r.glType,r.start,r.count,null,null,r._geomType,r.gasIndex);for(var n=0;n<r.primitives.length;n++){var m=r.primitives[n];var s=new d.SGPrimitive({type:m.type,cgmId:m.cgmId,parent:m.parent,rep:m.rep,group:l,start:m.start,count:m.count,solid:m.solid});q.push(s)}l.geometry=p;l.primitives=q;p.drawingGroups.push(l)}return p},merge:function(y,s,x){var z=this.attributeName.length;var A=this.vertexPositionArray.length/3;var u=this.vertexIndexArray.length;for(var p=0;p<z;p++){var v="vertex"+this.attributeName[p]+"Array";if(this[v]&&y[v]){var r=this[v];var n=r.length+y[v].length;if(n>65536){return null}this[v]=new Float32Array(n);for(var q=0;q<r.length;q++){this[v][q]=r[q]}for(var q=0;q<y[v].length;q++){this[v][r.length+q]=y[v][q]}}}if(this.vertexBuffer!==null){if(this.sharedBuffers){this.vertexBuffer.nbGeometries--;if(this.vertexBuffer.nbGeometries==0){s.deleteBuffer(this.vertexBuffer.buffer);s.deleteBuffer(this.vertexBuffer.indexBuffer);if(this.vertexBuffer.vbPool!==null){this.vertexBuffer.vbPool[this.vertexBuffer.vbType]=null}}}else{s.deleteBuffer(this.vertexBuffer.buffer);s.deleteBuffer(this.vertexBuffer.indexBuffer)}}this.vertexBuffer=null;var r=this.vertexIndexArray;var n=r.length+y.vertexIndexArray.length;this.vertexIndexArray=new Uint16Array(n);for(var q=0;q<r.length;q++){this.vertexIndexArray[q]=r[q]}for(var q=0;q<y.vertexIndexArray.length;q++){this.vertexIndexArray[r.length+q]=A+y.vertexIndexArray[q]}for(var q=0;q<y.drawingGroups.length;q++){var w=y.drawingGroups[q];w.geometry=this;w.start+=u;for(var p=0;p<w.primitives.length;p++){var m=w.primitives[p];m.start+=u}this.drawingGroups.push(w)}var l=false;for(var q=0;q<this.meshList.length;q++){var B=this.meshList[q];if(B.layer){for(var p=0;p<y.drawingGroups.length;p++){var w=y.drawingGroups[p];var o=new j.DrawableInterval(1,w.start,w.count);o.primitiveStart=0;o.primitiveCount=w.primitives.length;var t=new j.LayerInterval(this,w,o);B.layer.layers.push(t)}}}return this},_setAttributesSizeAndOffset:function(){var l=this.vertexLayout;if(this.vertexPositionArray){l.vertexPositionArray.offset=0;l.vertexPositionArray.itemSize=this.compressedVertices?2:3}if(this.vertexNormalArray){l.vertexNormalArray.offset=this.vertexBuffer.normalOffset;l.vertexNormalArray.itemSize=3}if(this.vertexUvArray){l.vertexUvArray.offset=this.vertexBuffer.uvOffset;l.vertexUvArray.itemSize=2}if(this.vertexUv2Array){l.vertexUv2Array.offset=this.vertexBuffer.uv2Offset;l.vertexUv2Array.itemSize=2}if(this.vertexColorArray){l.vertexColorArray.offset=this.vertexBuffer.colorOffset;l.vertexColorArray.itemSize=4}if(this.vertexTangentArray){l.vertexTangentArray.offset=this.vertexBuffer.tangentOffset;l.vertexTangentArray.itemSize=3}if(this.vertexBinormalArray){l.vertexBinormalArray.offset=this.vertexBuffer.binormalOffset;l.vertexBinormalArray.itemSize=3}if(this.vertexPreviousPositionArray){l.vertexPreviousPositionArray.offset=this.vertexBuffer.previousPositionOffset;l.vertexPreviousPositionArray.itemSize=3}if(this.vertexNextPositionArray){l.vertexNextPositionArray.offset=this.vertexBuffer.nextPositionOffset;l.vertexNextPositionArray.itemSize=3}if(this.vertexSideExtrusionArray){l.vertexSideExtrusionArray.offset=this.vertexBuffer.sideExtrusionOffset;l.vertexSideExtrusionArray.itemSize=1}if(this.vertexLineDistancesArray){l.vertexLineDistancesArray.offset=this.vertexBuffer.lineDistancesOffset;l.vertexLineDistancesArray.itemSize=2}if(this.vertexSkinIndexArray){l.vertexSkinIndexArray.offset=this.vertexBuffer.skinIndexOffset;l.vertexSkinIndexArray.itemSize=4}if(this.vertexSkinWeightArray){l.vertexSkinWeightArray.offset=this.vertexBuffer.skinWeightOffset;l.vertexSkinWeightArray.itemSize=4}}};j.DrawableInterval=function(l,p,n,m,o){this.layerNum=l||0;this.material=m||null;this.gas=o||null;this.start=p||0;this.count=n||0;this.primitiveStart=0;this.primitiveCount=0};j.DrawableInterval.prototype={constructor:j.DrawableInterval,clone:function(){var l=new j.DrawableInterval(this.layerNum,this.start,this.count,this.material,this.gas);l.primitiveStart=this.primitiveStart;l.primitiveCount=this.primitiveCount;return l}};j.LayerInterval=function(l,n,m){this.geometry=(l!==undefined)?l:null;this.drawableGroup=(n!==undefined)?n:null;this.drawableInterval=(m!==undefined)?m:null};j.LayerInterval.prototype={constructor:j.LayerInterval,clone:function(){var l=new j.LayerInterval();l.geometry=this.geometry;l.drawableGroup=this.drawableGroup;l.drawableInterval=this.drawableInterval.clone();return l},computeOrientedBoundingBox:function(x){var s=true;var t=this.drawableInterval;var n=this.geometry.vertexIndexArray;var v=this.geometry.vertexPositionArray;var r=new j.Vector3();var w=new j.Vector3();var m=new j.Vector3();if(t.layerNum&&t.count){var l=t.start;var p=t.start+t.count;if(s){s=false;var u=n[l];if(this.geometry.compressedVertices){u*=2;var o=this.geometry.uncompressPoint(v[u],v[u+1]);r.set(o.x,o.y,o.z).applyMatrix4(x);w.set(o.x,o.y,o.z).applyMatrix4(x)}else{u*=3;r.set(v[u],v[u+1],v[u+2]).applyMatrix4(x);w.set(v[u],v[u+1],v[u+2]).applyMatrix4(x)}}for(var q=l;q<p;q++){var u=n[q];if(this.geometry.compressedVertices){u*=2;var o=this.geometry.uncompressPoint(v[u],v[u+1]);m.set(o.x,o.y,o.z).applyMatrix4(x)}else{u*=3;m.set(v[u],v[u+1],v[u+2]).applyMatrix4(x)}if(m.x<r.x){r.x=m.x}if(m.y<r.y){r.y=m.y}if(m.z<r.z){r.z=m.z}if(m.x>w.x){w.x=m.x}if(m.y>w.y){w.y=m.y}if(m.z>w.z){w.z=m.z}}}return new j.Box3(r,w)}};j.BufferLayer=function(){this.layers=[];this.upToDate=false};j.BufferLayer.prototype={constructor:j.BufferLayer,clone:function(o){var n=new j.BufferLayer();for(var m=0;m<this.layers.length;m++){var l=this.layers[m].clone();if(o){l.drawableInterval.layerNum=0}n.addLayerInterval(l)}return n},getIntervals:function(q,p,o){var n=[];for(var m=0;m<this.layers.length;m++){var l=this.layers[m];if((l.geometry===q)&&(!p||(l.drawableGroup===p))){n.push(o?l:l.drawableInterval)}}return n},getInterval:function(q){var p=q.group;var o=p.geometry;var n=this.getIntervals(o,p);for(var m=0;m<n.length;m++){var l=n[m];if((q.start>=l.start)&&(q.start+q.count<=l.start+l.count)){return l}}return null},addLayerInterval:function(l){this.layers.push(l);this.upToDate=false},removeIntervals:function(p,o){var l=(o!==undefined);for(var n=0;n<this.layers.length;n++){var m=this.layers[n];if((m.geometry==p)&&(!l||(l&&(m.drawableGroup==o)))){this.layers.splice(n,1);n--}}this.upToDate=false},addPrimitivesToLayersOpacity:function(o,n,m){var l=[];this.addPrimitivesToLayers_internal(o,n,function(q){var p=l[q.id];if(!p){p=q.clone();p.opacity=m;p.transparent=true;l[q.id]=p}return p});this.upToDate=false},addPrimitivesToLayers:function(o,l,m,n){this.addPrimitivesToLayers_internal(o,l,function(){return m},n);this.upToDate=false},addPrimitivesToLayers_internal:function(v,n,q,s){var p,o;var t=[];for(p=0;p<v.length;p++){var l=v[p];for(o=0;o<t.length;o++){var u=t[o];if(u.length&&(u[0].group.geometry==l.group.geometry)&&(u[0].group==l.group)){u.push(l);break}}if(o==t.length){var u=[l];t.push(u)}}for(p=0;p<t.length;p++){t[p].sort(function(y,x){if(y.start<x.start){return -1}if(y.start>x.start){return 1}return 0})}for(p=0;p<t.length;p++){var m=t[p][0].group;var w=m.geometry;var r=q(m.gas);this.addPrimitivesToLayer(w,m,t[p],n,r,s)}},addPrimitivesToLayer:function(s,C,E,w,v,x){var B,K,m;var o=this.getIntervals(s,C);var D=[];if(!o.length){for(B=0;B<E.length;B++){var p=E[B];D.push(new j.DrawableInterval(w,p.start,p.count,v?v:null,x?x:null))}}else{var u=0;var t=o[u];var z=(x===undefined)?t.gas:x;var y=(v===undefined)?t.material:v;K=t.start;m=t.count;for(B=0;B<E.length;B++){var p=E[B];while(p.start+p.count>K+m){if(m){D.push(new j.DrawableInterval(t.layerNum,K,m,t.material,t.gas))}u++;t=o[u];z=(x===undefined)?t.gas:x;y=(v===undefined)?t.material:v;K=t.start;m=t.count}if((w!==t.layerNum)||(y!==t.material)||(z!==t.gas)){if(p.start>K){D.push(new j.DrawableInterval(t.layerNum,K,p.start-K,t.material,t.gas))}D.push(new j.DrawableInterval(w,p.start,p.count,y,z));var H=p.start+p.count;m=t.count-H+t.start;K=H}}if(m>0){D.push(new j.DrawableInterval(t.layerNum,K,m,t.material,t.gas))}for(var B=u+1;B<o.length;B++){D.push(o[B])}this.removeIntervals(s,C)}var L=D[0].layerNum;var l=D[0].material;var r=D[0].gas;K=D[0].start;m=0;for(B=0;B<D.length;B++){var n=D[B];if((n.layerNum===L)&&(n.material===l)&&(n.gas===r)){m+=n.count}else{var G=new j.DrawableInterval(L,K,m,l,r);this.addLayerInterval(new j.LayerInterval(s,C,G));L=n.layerNum;l=n.material;r=n.gas;K=n.start;m=n.count}if(B==D.length-1){var G=new j.DrawableInterval(L,K,m,l,r);this.addLayerInterval(new j.LayerInterval(s,C,G))}}for(var B=0;B<this.layers.length;B++){var J=this.layers[B];var F=J.drawableGroup;var I=J.drawableInterval;var A=0,q=0;if(F.primitives.length){if(F.primitives.length<20){while(I.start>F.primitives[A].start){A++}}else{A=c(F.primitives,I.start)}I.primitiveStart=A;while(I.start+I.count>F.primitives[A].start+F.primitives[A].count){A++}I.primitiveCount=A-I.primitiveStart+1}else{I.primitiveStart=0;I.primitiveCount=0}}}};function c(q,p){if(p<=q[0].start){return 0}var o=q.length-1;var l=0;var m,n=false;while(o-l>1){m=Math.floor((o+l)/2);if(q[m].start<p){l=m}else{o=m}}return o}j.EventTarget=function(){var l={};this.addEventListener=function(m,n){if(l[m]==undefined){l[m]=[]}if(l[m].indexOf(n)===-1){l[m].push(n)}};this.dispatchEvent=function(m){for(var n in l[m.type]){if(l[m.type].hasOwnProperty(n)){l[m.type][n](m)}}};this.removeEventListener=function(n,o){var m=l[n].indexOf(o);if(m!==-1){l[n].splice(m,1)}}};j.ImageUtils.crossOriginPolicy=true;j.ImageUtils.loadCompressedTexture=function(m,l,o,r,s,n){var q=new j.CompressedTexture();q.mapping=l;var p=new XMLHttpRequest();p.onload=function(){j.ImageUtils.nbTexturesBeingLoaded--;var v=p.response;var w=j.ImageUtils.parseDDS(v,true,s);q.format=w.format;if(w.type){q.type=w.type}q.width=w.width;q.height=w.height;if(w.isCubemap){var u=[];q.image=u;var t=w.mipmaps.length/w.mipmapCount;for(var z=0;z<t;z++){u[z]={mipmaps:[]};for(var y=0;y<w.mipmapCount;y++){u[z].mipmaps.push(w.mipmaps[z*w.mipmapCount+y]);u[z].format=w.format;u[z].width=w.width;u[z].height=w.height}}var x=u[3];u[3]=u[2];u[2]=x}else{q.mipmaps=w.mipmaps;q.image.width=w.width;q.image.height=w.height}q.generateMipmaps=false;if(!q.mipmaps){if(q.magFilter!=1003&&q.magFilter!=1006){q.magFilter=1006}if(q.minFilter!=1003&&q.minFilter!=1006){q.minFilter=1006}}q.needsUpdate=true;q.loadEndStatus="complete";if(o){o(q)}};if(n){q.loadEndStatus="pause";q.onRequest=function(){q.loadEndStatus="loading";j.ImageUtils.nbTexturesBeingLoaded++;p.open("GET",m,true);p.responseType="arraybuffer";p.send(null)}}else{q.loadEndStatus="loading";j.ImageUtils.nbTexturesBeingLoaded++;p.open("GET",m,true);p.responseType="arraybuffer";p.send(null)}return q};j.ImageUtils.loadCompressedTextureFromBuffer=function(l,n){var o=new j.CompressedTexture();o.loadEndStatus="complete";o.mapping=n;var m=j.ImageUtils.parseDDS(l,true);o.format=m.format;o.mipmaps=m.mipmaps;o.image.width=m.width;o.image.height=m.height;o.generateMipmaps=false;o.needsUpdate=true;return o};j.ImageUtils.parseDDS=function(ay,l,ax){if(ax===undefined){ax=true}var p={mipmaps:[],width:0,height:0,format:null,mipmapCount:1};var W=542327876;var aK=1,K=2,au=4,A=8,Y=4096,ap=131072,aS=524288,aB=8388608;var C=8,aX=4194304,Q=4096;var aj=512,ag=1024,aP=2048,ae=4096,aN=8192,ad=16384,aL=32768,R=2097152;var ab=1,aG=2,al=4,aW=64,P=512,N=131072;var aw=4;var an=28;var r=6;function y(a0){return a0.charCodeAt(0)+(a0.charCodeAt(1)<<8)+(a0.charCodeAt(2)<<16)+(a0.charCodeAt(3)<<24)}function av(a0){return String.fromCharCode(a0&255,(a0>>8)&255,(a0>>16)&255,(a0>>24)&255)}function aZ(a1){var a0=a1[4];a1[4]=a1[7];a1[7]=a0;a0=a1[5];a1[5]=a1[6];a1[6]=a0}function aA(a1){var a0=a1[4];a1[4]=a1[5];a1[5]=a0}function q(a1){var a0=a1[0];a1[0]=a1[6];a1[6]=a0;a0=a1[1];a1[1]=a1[7];a1[7]=a0;a0=a1[2];a1[2]=a1[4];a1[4]=a0;a0=a1[3];a1[3]=a1[5];a1[5]=a0;aZ(a1.subarray(8,16))}function aH(a1){var a0=a1[0];a1[0]=a1[2];a1[2]=a0;a0=a1[1];a1[1]=a1[3];a1[3]=a0;aZ(a1.subarray(8,16))}function B(a3){var a4=a3[2]+256*(a3[3]+256*a3[4]);var a0=a3[5]+256*(a3[6]+256*a3[7]);var a1=((a4&4095)<<12)|((a4&16773120)>>12);var a2=((a0&4095)<<12)|((a0&16773120)>>12);a3[2]=a2&255;a3[3]=(a2&65280)>>8;a3[4]=(a2&16711680)>>8;a3[5]=a1&255;a3[6]=(a1&65280)>>8;a3[7]=(a1&16711680)>>8;aZ(a3.subarray(8,16))}function B(a3){var a4=a3[2]+256*(a3[3]+256*a3[4]);var a0=a3[5]+256*(a3[6]+256*a3[7]);var a1=((a4&4095)<<12)|((a4&16773120)>>12);var a2=((a0&4095)<<12)|((a0&16773120)>>12);a3[2]=a2&255;a3[3]=(a2&65280)>>8;a3[4]=(a2&16711680)>>8;a3[5]=a1&255;a3[6]=(a1&65280)>>8;a3[7]=(a1&16711680)>>8;aZ(a3.subarray(8,16))}function aU(a1){var a2=a1[2]+256*(a1[3]+256*a1[4]);var a0=((a2&4095)<<12);a1[2]=a0&255;a1[3]=(a0&65280)>>8;a1[4]=(a0&16711680)>>8;aZ(a1.subarray(8,16))}function aR(a2,a0){var a1;for(a1=0;a1<a2.length;a1++){a2[a1]=a0[a1]}}function aC(bc,ba,a2,bi,bl){var a0,a7,be,bj,bm,a5,a3,bk,bh,a1,bn,a8,a6,a9,bf,bg;switch(bi){case j.RGB_S3TC_DXT1_Format:be=8;a0=aZ;a7=aA;break;case j.RGBA_S3TC_DXT3_Format:be=16;a0=q;a7=aH;break;case j.RGBA_S3TC_DXT5_Format:be=16;a0=B;a7=aU;break;default:console.error("flip dds error");return bl}bj=bc;bm=ba;for(bh=0;bh<a2;++bh){bn=bl[bh].data;a5=Math.floor((bj+3)/4);a3=Math.floor((bm+3)/4);bk=a5*a3;if(bm==1){break}else{if(bm==2){for(bf=0;bf<a5;bf++){a7(bn.subarray(a1,bf*be));a1=+be}}else{a1=0;for(bf=1;bf<=bk;bf++){if(bf==4095){var bd}a0(bn.subarray(a1,bf*be));a1+=be}bg=be*a5;a9=new Uint8Array(bg);for(var a4=0;a4<a3/2;++a4){a8=bn.subarray(a4*bg,(a4+1)*bg);a6=bn.subarray((a3-a4-1)*bg,(a3-a4)*bg);aR(a9,a8);aR(a8,a6);aR(a6,a9)}}}bj/=2;if(bj<1){bc=1}bm/=2;if(bm<1){ba=1}}}var M=y("DXT1");var L=y("DXT3");var I=y("DXT5");var aY=y("DX10");var u=116;var aM=31;var aI=5;var ak=0;var m=1;var am=2;var U=3;var s=4;var aO=7;var w=20;var aq=21;var az=22;var n=23;var aT=24;var ao=25;var t=26;var Z=27;var aF=28;var aE=29;var aD=30;var aJ=32;var at=33;var aV=34;var T=35;var x=36;var ar=new Int32Array(ay,0,aM+aI+1);if(ar[ak]!==W){console.error("ImageUtils.parseDDS(): Invalid magic number in DDS header");return p}var G=ar[n];var O=ar[aT];var H=ar[ao];var ah=ar[t];var V;var F=ar[aq];if(F===aY){var ai=ar[aJ];if((ar[aV]&aw)||(ar[T]===6)){p.isCubemap=true}if(ai===an){p.format=j.RGBAFormat;V=4}else{if(ai===r){p.format=j.RGBFormat;V=12;p.type=j.FloatType;ax=false}}}else{switch(F){case M:V=8;p.format=j.RGB_S3TC_DXT1_Format;break;case L:V=16;p.format=j.RGBA_S3TC_DXT3_Format;break;case I:V=16;p.format=j.RGBA_S3TC_DXT5_Format;break;default:if(F===u){p.format=j.RGBAFormat;p.type=j.FloatType;V=16}else{if(ar[az]===32&&ar[n]&16711680&&ar[aT]&65280&&ar[ao]&255&&ar[t]&4278190080){p.format=j.RGBAFormat;V=4}else{if(ar[w]&aW){if(ar[w]&ab){p.format=j.RGBAFormat;V=4}else{p.format=j.RGBFormat;V=3}}else{console.error("ImageUtils.parseDDS(): Unsupported FourCC code: ",av(F));return p}}}}var ac=ar[aF];p.isCubemap=ac&aj?true:false;if(p.isCubemap&&(!(ac&ag)||!(ac&aP)||!(ac&ae)||!(ac&aN)||!(ac&ad)||!(ac&aL))){console.error("THREE.DDSLoader.parse: Incomplete cubemap faces");return p}}p.mipmapCount=1;if(ar[am]&ap&&l!==false){p.mipmapCount=Math.max(1,ar[aO])}p.width=ar[s];p.height=ar[U];var S=ar[m]+4;if(F===aY){S+=20}var E=p.isCubemap?6:1;var v=(F===M)||(F===L)||(F===I);for(var o=0;o<E;o++){var aQ=p.width;var D=p.height;var J=aQ*D;if(v){J=Math.ceil(aQ/4)*Math.ceil(D/4)}J*=V;for(var af=0;af<p.mipmapCount;af++){var z=null;if(v){if(S+J>ay.byteLength){console.log("dxterror")}z=new Uint8Array(ay,S,J)}else{if(V===16){z=new Float32Array(ay,S,J/4)}else{if(V===12){z=new Float32Array(ay,S,J/4)}else{if(F===0&&(V!==3)){z=j.ImageUtils.getImageFromColorMasks(ay,S,J,G,O,H,ah)}else{z=j.ImageUtils.loadARGBMip(ay,S,aQ,D,V)}}}}var X={data:z,width:aQ,height:D};p.mipmaps.push(X);S+=J;aQ/=2;if(aQ<1){aQ=1}D/=2;if(D<1){D=1}J=(v)?Math.ceil(aQ/4)*Math.ceil(D/4):aQ*D;J*=V}}if(ax){aC(p.width,p.height,p.mipmapCount,p.format,p.mipmaps)}return p};j.ImageUtils.loadARGBMip=function(C,s,B,A,z){var o=B*A*z;var v=(4-((z*B)%4))%4;var u=o+A*v;var l=new Uint8Array(C,s,o);var t=new Uint8Array(u);var G=0;var n=0;var m=0;for(var p=0;p<A;p++){for(var q=0;q<B;q++){var w=l[n];n++;var D=l[n];n++;var E=l[n];n++;var F;if(z===4){F=l[n];n++}t[G]=w;G++;t[G]=D;G++;t[G]=E;G++;if(z===4){t[G]=F;G++}}G+=v}return t};j.ImageUtils.getImageFromColorMasks=function(o,p,n,s,q,x,z){var u=new Int32Array(o,p,n/4);var m=new Uint8Array(n);var y=j.ImageUtils.computeMaskShift(s);var t=j.ImageUtils.computeMaskShift(q);var l=j.ImageUtils.computeMaskShift(x);var v=j.ImageUtils.computeMaskShift(z);for(var r=0;r<n/4;r++){var w=u[r];m[4*r]=(w&s)>>y;m[4*r+1]=(w&q)>>t;m[4*r+2]=(w&x)>>l;m[4*r+3]=(w&z)>>v}return m};j.ImageUtils.computeMaskShift=function(l){var n=l;var m=0;while(!(n&1)){n=n>>1;m++}return m};j.InfinitePlaneShader={uniforms:j.UniformsUtils.merge([j.UniformsLib.common,j.UniformsLib.lights,j.UniformsLib.shadowmap,{ambient:{type:"c",value:new j.Color(328965)},emissive:{type:"c",value:new j.Color(0)},specular:{type:"c",value:new j.Color(1118481)},border:{type:"c",value:new j.Color(268065)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new j.Vector3(1,1,1)},attenuation:{type:"i",value:0},displayGrid:{type:"f",value:1},displayPlane:{type:"f",value:1},gridFromBelow:{type:"f",value:1},gridTexture:{type:"t",value:null},gridTexture2:{type:"t",value:null},gridTexture3:{type:"t",value:null},gridTexture4:{type:"t",value:null},nbSteps:{type:"f",value:5},gridUnit:{type:"f",value:1},gridOffset:{type:"v2",value:new j.Vector2()},gridCoeff:{type:"f",value:0},gridColor:{type:"c",value:new j.Color(16777215)},planeSize:{type:"f",value:100},planeBorder:{type:"f",value:1},planeFalloff:{type:"f",value:0},gridFalloff:{type:"f",value:0},uvScale:{type:"f",value:1},planeOpacity:{type:"f",value:1}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;","#ifndef USE_MAP","varying vec2 vUv;","#endif",j.ShaderChunk.map_pars_vertex,j.ShaderChunk.clip_pars_vertex,j.ShaderChunk.lights_phong_pars_vertex,j.ShaderChunk.color_pars_vertex,j.ShaderChunk.shadowmap_pars_vertex,"void main() {","vUv = uv;",j.ShaderChunk.color_vertex,j.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",j.ShaderChunk.default_vertex,j.ShaderChunk.clip_vertex,"vViewPosition = -mvPosition.xyz;",j.ShaderChunk.worldpos_vertex,j.ShaderChunk.lights_phong_vertex,j.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["const vec3 vOrthoDir = vec3(0.0, 0.0, 1.0);","uniform vec3 diffuse;","uniform float planeOpacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform vec3 border;","uniform int attenuation;","#ifdef PLANE_V2","const float alphaSlope = 0.66666666667;","const float alphaSlope2 = 0.44444444444;","const float edgeSize = 0.01;","const float stepSize = 0.001;","const float small2GridWidth = 0.0005;","const float smallGridWidth = 0.0005;","const float bigGridWidth = 0.0005;","uniform float displayGrid;","uniform float displayPlane;","uniform float gridFromBelow;","uniform float planeFalloff;","uniform float gridFalloff;","uniform float planeSize;","uniform float planeBorder;","uniform sampler2D gridTexture;","uniform sampler2D gridTexture2;","uniform sampler2D gridTexture3;","uniform sampler2D gridTexture4;","uniform float nbSteps;","uniform float gridUnit;","uniform vec2 gridOffset;","uniform float gridCoeff;","uniform vec3 gridColor;","#ifdef USE_MAP","uniform sampler2D map;","#endif","#endif","uniform float uvScale;","varying vec2 vUv;","vec2 uvToUse;",j.ShaderChunk.color_pars_fragment,j.ShaderChunk.lights_phong_pars_fragment,j.ShaderChunk.shadowmap_pars_fragment,"void main() {","uvToUse = vUv * uvScale;","vec3 I = vOrthoDir;","gl_FragColor = vec4(1.0);","if (!(projectionMatrix[3][3] > 0.0)) {","  I = normalize(vViewPosition);","}","float fresnelFactor = dot(I, vNormal);","#ifndef PLANE_V2","if (fresnelFactor < 0.0) {","  discard;","}","if (attenuation == 0) {","  fresnelFactor = 1.0;","}","#endif",j.ShaderChunk.alphatest_fragment,"float shininessValue = shininess;",j.ShaderChunk.specularmap_fragment,j.ShaderChunk.lights_phong_fragment,j.ShaderChunk.color_fragment,"vec3 cCenter = gl_FragColor.xyz;","vec3 cBorder = border;","#if defined(GAMMA_INPUT)","cBorder *= cBorder;","#endif","#ifdef PLANE_V2","float dUV = length(2.0 * vUv - 1.0);","float borderMask = planeBorder * smoothstep(1.0 - 2.0 * edgeSize, 1.0 - 2.0 * edgeSize + stepSize, dUV) * smoothstep(1.0 - edgeSize + stepSize, 1.0 - edgeSize, dUV);","float a2 = max(1.0 - alphaSlope2 * (1.0 + gridCoeff) * (1.0 + gridCoeff), 0.0);","float a1 = 1.0 - alphaSlope2 * gridCoeff * gridCoeff;","float a0 = 1.0 - alphaSlope2 * (1.0 - gridCoeff) * (1.0 - gridCoeff);","float a00 = max(1.0 - alphaSlope2 * (2.0 - gridCoeff) * (2.0 - gridCoeff), 0.0);","vec2 div = 0.5 * planeSize * (2.0 * vUv - 1.0) + gridOffset;","vec2 big2Div = (1.0 / (nbSteps * nbSteps)) * div / gridUnit;","vec2 bigDiv = (1.0 / nbSteps) * div / gridUnit;","vec2 smallDiv = div / gridUnit;","vec2 small2Div = nbSteps * div / gridUnit;","float gridAlpha = texture2D(gridTexture, small2Div).a;","gridAlpha *= a2;","gridAlpha += a1 * texture2D(gridTexture2, smallDiv).a;","gridAlpha += a0 * texture2D(gridTexture3, bigDiv).a;","gridAlpha += a00 * texture2D(gridTexture4, big2Div).a;","gridAlpha = min(1.0, gridAlpha);","#ifdef USE_MAP","vec4 texelColor = texture2D( map, uvToUse );","#ifdef GAMMA_INPUT","texelColor.xyz *= texelColor.xyz;","#endif","cCenter = mix(cCenter, texelColor.xyz, texelColor.a);","#endif","float planeAlpha = 1.0001 - smoothstep(planeFalloff, 1.0, dUV);","gridAlpha *= 1.0001 - smoothstep(gridFalloff, 1.0, dUV);","planeAlpha *= planeOpacity * step(0.0, fresnelFactor) * displayPlane;","gridAlpha *= step(-gridFromBelow, fresnelFactor) * displayGrid;","vec4 planeCol = vec4(mix(mix(cCenter, cBorder, planeBorder), cCenter, planeAlpha), mix(planeAlpha, 1.0, planeBorder));","vec4 gridCol = vec4(gridColor * gridColor, gridAlpha);","vec4 gridOverPlaneColor = vec4((gridCol.xyz * gridCol.a + planeCol.xyz * planeCol.a * (1.0 - gridCol.a)) / (0.0001 + gridCol.a + planeCol.a * (1.0 - gridCol.a)), gridCol.a + planeCol.a * (1.0 - gridCol.a));","gl_FragColor = mix(gridOverPlaneColor, vec4(cBorder, borderMask), step(1.0 - 2.0 * edgeSize, dUV));","#else","vec2 dUV = 2.0 * (vUv * 2.0 - 1.0);","float dist = dot(dUV, dUV);","float dist2 = clamp(dist * dist, 0.0, 1.0);","dist = clamp(dist, 0.0, 1.0);","gl_FragColor = vec4(mix(cCenter, cBorder, dist), fresnelFactor*(1.0 - dist2));","#endif",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n"),fragmentShaderFirstDirOnly:["const vec3 vOrthoDir = vec3(0.0, 0.0, 1.0);","uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform vec3 border;","uniform int attenuation;","varying vec2 vUv;"," vec2 uvToUse;",j.ShaderChunk.color_pars_fragment,j.ShaderChunk.lights_phong_pars_fragment,j.ShaderChunk.shadowmap_pars_fragment,"void main() {","uvToUse=vUv;","vec3 I = vOrthoDir;","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );","if (!(projectionMatrix[3][3] > 0.0)) {","  I = normalize(vViewPosition);","}","float fresnelFactor = dot(I, vNormal);","if (fresnelFactor < 0.0) {","  discard;","}","if (attenuation == 0) {","  fresnelFactor = 1.0;","}",j.ShaderChunk.alphatest_fragment,j.ShaderChunk.specularmap_fragment,j.ShaderChunk.lights_phong_firstdironly_fragment,j.ShaderChunk.color_fragment,"vec3 cCenter = gl_FragColor.xyz;","vec3 cBorder = border;","#ifdef GAMMA_INPUT","cBorder *= cBorder;","#endif","vec2 dUV = 2.0 * (vUv * 2.0 - 1.0);","float dist = dot(dUV, dUV);","float dist2 = clamp(dist * dist, 0.0, 1.0);","dist = clamp(dist, 0.0, 1.0);","gl_FragColor = vec4(mix(cCenter, cBorder, dist), fresnelFactor*(1.0 - dist2));",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};j.InfinitePlaneShaderSimple={uniforms:j.UniformsUtils.merge([j.UniformsLib.common,{ambient:{type:"c",value:new j.Color(328965)},emissive:{type:"c",value:new j.Color(0)},specular:{type:"c",value:new j.Color(1118481)},border:{type:"c",value:new j.Color(268065)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new j.Vector3(1,1,1)},attenuation:{type:"i",value:0}}]),vertexShader:["varying vec3 vViewPosition;","varying vec3 vNormal;","varying vec2 vUv;",j.ShaderChunk.color_pars_vertex,"void main() {","vUv = uv;",j.ShaderChunk.color_vertex,j.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",j.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",j.ShaderChunk.worldpos_vertex,"}"].join("\n"),fragmentShader:["const vec3 vOrthoDir = vec3(0.0, 0.0, 1.0);","uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform vec3 border;","uniform int attenuation;","varying vec3 vViewPosition;","varying vec3 vNormal;","varying vec2 vUv;"," vec2 uvToUse;",j.ShaderChunk.color_pars_fragment,"void main() {","uvToUse=vUv;","vec3 I = vOrthoDir;","gl_FragColor = vec4( diffuse, opacity );","if (!(projectionMatrix[3][3] > 0.0)) {","  I = normalize(vViewPosition);","}","float fresnelFactor = dot(I, vNormal);","if (fresnelFactor < 0.0) {","  discard;","}","if (attenuation == 0) {","  fresnelFactor = 1.0;","}",j.ShaderChunk.alphatest_fragment,j.ShaderChunk.specularmap_fragment,j.ShaderChunk.color_fragment,"vec3 cCenter = gl_FragColor.xyz;","vec3 cBorder = border;","#ifdef GAMMA_INPUT","cBorder *= cBorder;","#endif","vec2 dUV = 2.0 * (vUv * 2.0 - 1.0);","float dist = dot(dUV, dUV);","float dist2 = clamp(dist * dist, 0.0, 1.0);","dist = clamp(dist, 0.0, 1.0);","gl_FragColor = vec4(mix(cCenter, cBorder, dist), fresnelFactor*(1.0 - dist2));",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};j.TexturedGridShader={uniforms:j.UniformsUtils.merge([j.UniformsLib.common,j.UniformsLib.fog,j.UniformsLib.lights,j.UniformsLib.shadowmap,{ambient:{type:"c",value:new j.Color(328965)},emissive:{type:"c",value:new j.Color(0)},specular:{type:"c",value:new j.Color(1118481)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new j.Vector3(1,1,1)},gridCenter:{type:"v3",value:new j.Vector3()},gridSize:{type:"f",value:1},attenuation:{type:"f",value:1}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;",j.ShaderChunk.map_pars_vertex,"void main() {",j.ShaderChunk.map_vertex,j.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",j.ShaderChunk.worldpos_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform vec3 gridCenter;","uniform float gridSize;","uniform float attenuation;",j.ShaderChunk.map_pars_fragment,j.ShaderChunk.lights_phong_pars_fragment,"void main() {","gl_FragColor = vec4( diffuse, 1.0 );","vec4 texelColor = texture2D( map, vUv );","gl_FragColor *= texelColor;",j.ShaderChunk.color_fragment,"vec3 cCenter = gl_FragColor.xyz;","vec3 cBorder = cCenter;","#ifdef GAMMA_INPUT","cBorder *= cBorder;","#endif","vec3 vecDist = - vViewPosition - gridCenter;","float dist = 16.0 * dot(vecDist, vecDist);","dist /= (gridSize * gridSize);","dist = clamp(dist, 0.0, 1.0);","gl_FragColor = vec4( mix(vec4(cCenter, 0.9 * attenuation), vec4(cBorder, 0.0), dist));","gl_FragColor.a *= texelColor.a;","}"].join("\n")};j.GridShader={uniforms:j.UniformsUtils.merge([j.UniformsLib.common,j.UniformsLib.fog,j.UniformsLib.lights,j.UniformsLib.shadowmap,{ambient:{type:"c",value:new j.Color(328965)},emissive:{type:"c",value:new j.Color(0)},specular:{type:"c",value:new j.Color(1118481)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new j.Vector3(1,1,1)},gridCenter:{type:"v3",value:new j.Vector3()},gridSize:{type:"f",value:1},attenuation:{type:"f",value:1},startFalloff:{type:"f",value:0},endFalloff:{type:"f",value:1}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;",j.ShaderChunk.color_pars_vertex,"void main() {",j.ShaderChunk.color_vertex,j.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",j.ShaderChunk.worldpos_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform vec3 gridCenter;","uniform float gridSize;","uniform float attenuation;","#ifdef GRID_V2","uniform float startFalloff;","uniform float endFalloff;","#endif",j.ShaderChunk.color_pars_fragment,j.ShaderChunk.lights_phong_pars_fragment,"void main() {","gl_FragColor = vec4( diffuse, 0.6 );",j.ShaderChunk.color_fragment,"vec3 cCenter = gl_FragColor.xyz;","vec3 cBorder = cCenter;","#ifdef GAMMA_INPUT","cBorder *= cBorder;","#endif","vec3 vecDist = - vViewPosition - gridCenter;","#ifdef GRID_V2","float gridRadius = 0.5 * gridSize;","float dist = smoothstep(startFalloff * gridRadius, endFalloff * gridRadius, length(vecDist));","#else","float dist = 16.0 * dot(vecDist, vecDist);","dist /= (gridSize * gridSize);","dist = clamp(dist, 0.0, 1.0);","#endif","gl_FragColor = vec4( mix(vec4(cCenter, 0.6 * attenuation), vec4(cBorder, 0.0), dist));",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};j.BigGridShader={uniforms:j.UniformsUtils.merge([j.UniformsLib.common,j.UniformsLib.fog,j.UniformsLib.lights,j.UniformsLib.shadowmap,{ambient:{type:"c",value:new j.Color(328965)},emissive:{type:"c",value:new j.Color(0)},specular:{type:"c",value:new j.Color(1118481)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new j.Vector3(1,1,1)},gridCenter:{type:"v3",value:new j.Vector3()},gridSize:{type:"f",value:1},attenuation:{type:"f",value:1}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;",j.ShaderChunk.color_pars_vertex,"void main() {",j.ShaderChunk.color_vertex,j.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",j.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",j.ShaderChunk.worldpos_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform vec3 gridCenter;","uniform float gridSize;","uniform float attenuation;",j.ShaderChunk.color_pars_fragment,j.ShaderChunk.lights_phong_pars_fragment,"void main() {","gl_FragColor = vec4( diffuse, opacity );",j.ShaderChunk.color_fragment,"vec3 cCenter = gl_FragColor.xyz;","vec3 cBorder = cCenter;","#ifdef GAMMA_INPUT","cBorder *= cBorder;","#endif","vec3 vecDist = - vViewPosition - gridCenter;","float dist = 16.0 * dot(vecDist, vecDist);","dist /= (gridSize * gridSize);","dist = clamp(dist, 0.0, 1.0);","gl_FragColor = vec4( mix(vec4(cCenter, attenuation), vec4(cBorder, 0.0), dist));",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};j.SmallPlaneShader={uniforms:j.UniformsUtils.merge([j.UniformsLib.common,j.UniformsLib.lights,j.UniformsLib.shadowmap,{groundShadow:{type:"t",value:null}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;","varying vec2 vUv;",j.ShaderChunk.color_pars_vertex,j.ShaderChunk.clip_pars_vertex,j.ShaderChunk.shadowmap_pars_vertex,"void main() {","vUv = uv;",j.ShaderChunk.color_vertex,j.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",j.ShaderChunk.default_vertex,j.ShaderChunk.clip_vertex,"vViewPosition = -mvPosition.xyz;",j.ShaderChunk.worldpos_vertex,j.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["const vec3 vOrthoDir = vec3(0.0, 0.0, 1.0);","uniform vec3 diffuse;","uniform float opacity;","#ifdef GROUND_SHADOW","  uniform sampler2D groundShadow;","#endif","varying vec3 vViewPosition;","varying vec3 vNormal;","varying vec2 vUv;","vec2 uvToUse;",j.ShaderChunk.color_pars_fragment,j.ShaderChunk.shadowmap_pars_fragment,"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );","uvToUse=vUv;","vec3 I = vOrthoDir;","if (!(projectionMatrix[3][3] > 0.0)) {","  I = normalize(vViewPosition);","}","if (dot(I, vNormal) < 0.0) {","  discard;","}",j.ShaderChunk.alphatest_fragment,j.ShaderChunk.color_fragment,j.ShaderChunk.shadowmap_fragment,"#ifdef GROUND_SHADOW","  float shadowCoeff = texture2D(groundShadow, vUv).x;","  gl_FragColor.xyz *= shadowCoeff;","#endif","vec2 toCenter = 2.0 * (vec2(0.5) - vUv);","float distToCenter = min(1.0, dot(toCenter, toCenter));","gl_FragColor = vec4(mix(gl_FragColor.xyz, vec3(1.0), distToCenter), 1.0);","}"].join("\n")};j.LightProbeMapShader={defines:{sRGB:false,HDR:false},uniforms:{tEnvMap:{type:"t",value:null},ambient:{type:"c",value:new j.Color(16777215)}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tEnvMap;","uniform vec3 ambient;","varying vec3 vWorldPosition;","const float PI = 3.14159;","const float INV_PI = 0.31830988618;","void main() {","vec3 dir = normalize(vWorldPosition - cameraPosition);","dir = vec3(dir.y, dir.z, dir.x);","float probeR = INV_PI * acos( dir.z ) / length(dir.xy);","gl_FragColor = texture2D( tEnvMap, 0.5 * (probeR * dir.xy + 1.0) );","#if defined( GAMMA_INPUT ) && defined( sRGB )","gl_FragColor *= gl_FragColor;","#endif","gl_FragColor *= vec4(ambient, 1.0);","}"].join("\n")};j.FiniteEnvMap={defines:{PROJECTION_CONIC:true,LATLONG_MAP:true,sRGB:false,HDR:false,AMBIENCE_V2:false},uniforms:{tEnvMap:{type:"t",value:null},tEnvMap2:{type:"t",value:null},envMapHDRSize:{type:"v2",value:new j.Vector4(2048,1024)},invScreenSize:{type:"v2",value:new j.Vector2()},tFlip:{type:"f",value:-1},ambienceMatrix:{type:"m4",value:new j.Matrix4()},groundPosition:{type:"v3",value:new j.Vector3(0,0,0)},groundNormal:{type:"v3",value:new j.Vector3(0,0,1)},sceneHeight:{type:"v3",value:new j.Vector3(0,0,0.15)},groundHeight:{type:"v3",value:new j.Vector3(0,0,0.23)},groundOffset:{type:"f",value:0},groundRadius:{type:"f",value:5000},blurCoef:{type:"f",value:0},withGround:{type:"f",value:0},groundScale:{type:"f",value:0.78},intensity:{type:"f",value:1},envMapExposure:{type:"f",value:1},ambient:{type:"c",value:new j.Color(16777215)}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#if defined( LATLONG_MAP ) ","uniform sampler2D tEnvMap;","#else","uniform samplerCube tEnvMap;","#endif","#if defined( ENVMAP2 ) ","uniform sampler2D tEnvMap2;","#endif","uniform float blurCoef;","uniform float withGround;","uniform float envMapExposure;","uniform float tFlip;","uniform vec3 ambient;","uniform vec3 groundPosition;","uniform vec3 groundNormal;","uniform vec3 sceneHeight;","uniform vec3 groundHeight;","uniform float groundOffset;","uniform float groundRadius;","uniform float groundScale;","uniform float intensity;","uniform vec2 invScreenSize;","uniform mat4 ambienceMatrix;","varying vec3 vWorldPosition;","const float PI = 3.14159;","const float INV_PI = 0.31830988618;","#if defined( HDR )","uniform vec2 envMapHDRSize;","vec4 texture2DFromRGBE(sampler2D textureSampler, vec2 uv) {","vec4 texelRGBE = texture2D(textureSampler, uv);","float exponent = pow(2.0, 255.0 * texelRGBE.w - 128.0);","return vec4((255.0 / 256.0) * texelRGBE.xyz * exponent, 1.0);","}","vec4 texture2DBilinearFromRGBE(sampler2D textureSampler, vec2 uv, vec2 textureSize, vec2 texelSize) {","vec4 tl = texture2DFromRGBE(textureSampler, uv);","vec4 tr = texture2DFromRGBE(textureSampler, uv + vec2(texelSize.x, 0.0));","vec4 bl = texture2DFromRGBE(textureSampler, uv + vec2(0.0, texelSize.y));","vec4 br = texture2DFromRGBE(textureSampler, uv + vec2(texelSize.x, texelSize.y));","vec2 f = fract(uv.xy * textureSize.xy);","vec4 tA = mix(tl, tr, f.x);","vec4 tB = mix(bl, br, f.x);","return mix(tA, tB, f.y);","}","vec4 sampleMipMapRoughness(vec2 uv, float mip, float coef, sampler2D map0, sampler2D map1, vec2 textureSize, vec2 texelSize) {","vec4 color1;","vec4 color2;","vec2 uv1;","vec2 uv2;","if (mip < 1.0) {","color1 = texture2DBilinearFromRGBE(map0, uv, textureSize, texelSize);","} else {","textureSize.y *= 2.0;","texelSize.y *= 0.5;","float level1 = clamp(floor(mip) - 1.0, 0.0, 4.0);","float t10 = pow(2.0, -floor(log2(level1 + 1.0)));","float t11 = 2.0 - (level1 + 2.0) * t10;","float t12 = 0.5 * t10;","uv1 = vec2(t11 + 1.5 * texelSize.x + (2.0 * t12 - 3.0 * texelSize.x) * uv.x, t12 + 1.5 * texelSize.x + (t12 - 3.0 * texelSize.x) * uv.y);","color1 = texture2DBilinearFromRGBE(map1, uv1, textureSize, texelSize);","}","float level2 = clamp(floor(mip), 0.0, 5.0);","float t20 = pow(2.0, -floor(log2(level2 + 1.0)));","float t21 = 2.0 - (level2 + 2.0) * t20;","float t22 = 0.5 * t20;","uv2 = vec2(t21 + 1.5 * texelSize.x + (2.0 * t22 - 3.0 * texelSize.x) * uv.x, t22 + 1.5 * texelSize.x + (t22 - 3.0 * texelSize.x) * uv.y);","color2 = texture2DBilinearFromRGBE(map1, uv2, textureSize, texelSize);","return mix(color1, color2, coef);","}","#endif","vec2 MapNormalToTextureCoordinate(vec3 iNormal) {","float phi = atan(iNormal.y, iNormal.x);","float theta = acos(iNormal.z);","vec2 reflectionUV = vec2(fract(0.5 + 0.5 * INV_PI * phi), 1.0 - INV_PI * theta);","return reflectionUV;","}","float IntersectPlane(vec3 iPos, vec3 iRay, vec3 iPlaneOrig, vec3 iPlaneNormal) {","float t = dot(iPlaneNormal, iPlaneOrig-iPos);","float cosNormalDir = dot(iPlaneNormal, iRay);","if (cosNormalDir==0.0) return 0.0;","t = t/cosNormalDir;","return t;","}","float IntersectSphereFar(vec3  iSphereCenter, float iSphereRadius, vec3 iRayDir, vec3  iRayOrig) {","   vec3 dist = iRayOrig - iSphereCenter;","   float B = 2.0*dot(iRayDir, dist);","   float C = dot(dist, dist) - iSphereRadius*iSphereRadius;","   float disc = B*B - 4.0*C;","   if (disc < 0.0)","       return -1.0;","   float t = (-B + sqrt(disc)) / 2.0;","   return t;","}","void main() {","vec3 n = normalize(vWorldPosition - cameraPosition);","vec3 groundPos = (ambienceMatrix * vec4(groundPosition, 1.0)).xyz;","vec3 groundNor = (ambienceMatrix * vec4(groundNormal, 0.0)).xyz;","vec3  sphereCenter  = groundPos + groundNor * sceneHeight * groundRadius;","vec3  offset  = vec3(0.0,0.0,groundOffset);","offset = (ambienceMatrix * vec4(offset, 0.0)).xyz;","#if defined( AMBIENCE_V2 ) ","groundNor = groundNormal;","sphereCenter  = groundPosition +  sceneHeight * groundRadius;","offset = groundOffset * groundNor;","groundPos = groundPosition + offset;","#endif","float sphereRadius  = groundRadius * groundScale;","vec3  rayDir      = vec3(0.0);","vec3  rayOrig     = vec3(0.0);","if (sphereRadius > 0.0) {","#if defined( PROJECTION_CONIC ) ","rayDir      = n;","rayOrig     = cameraPosition;","#else","#endif","float t =  IntersectSphereFar(sphereCenter, sphereRadius, rayDir, rayOrig);","vec3  planeNormal = groundNor;","if (t>0.0) {","if (dot(planeNormal, rayDir)<0.0){","#if defined( AMBIENCE_V2 ) ","float planeT  = IntersectPlane(rayOrig, rayDir, groundPos, planeNormal);","#else","float planeT  = IntersectPlane(rayOrig, rayDir, groundPos + offset, planeNormal);","#endif","planeT = planeT * withGround;","#if defined( PROJECTION_CONIC ) ","t = (planeT>0.0) ? min(planeT,t) : t;","#else","#endif","}","vec3 hitPos = rayOrig + t*rayDir;","#if defined( AMBIENCE_V2 ) ","vec3 projectionCenter = groundPosition + groundHeight * sphereRadius; ","#else","vec3 projectionCenter = groundPos + offset ; ","projectionCenter += groundNor * groundHeight*groundRadius;","#endif","vec3 sn = (hitPos - projectionCenter);","n = normalize(sn);","}","}","#if defined( LATLONG_MAP ) ","n = (ambienceMatrix * vec4(n, 0.0)).xyz;","#if defined( HDR )","#else","n.y *= -1.0;","#endif","vec2 coords = MapNormalToTextureCoordinate(n);","#if defined( HDR )","vec2 texelSize = vec2(1.0 / envMapHDRSize);","#if defined( ENVMAP2 )","float mipValue = max(6.0 + 1.15 * log2(blurCoef + 0.0000001), 0.0);","float mipCoef = fract(mipValue);","if (mipValue > 6.0) {","mipValue = 6.0;","mipCoef = 1.0;","}","gl_FragColor.xyz = envMapExposure * sampleMipMapRoughness( coords, mipValue, mipCoef, tEnvMap, tEnvMap2, envMapHDRSize, texelSize ).xyz;","#else","gl_FragColor.xyz = envMapExposure * texture2DBilinearFromRGBE( tEnvMap, coords, envMapHDRSize, texelSize ).xyz;","#endif","#else","gl_FragColor.xyz = envMapExposure * texture2D( tEnvMap, coords ).xyz;","#endif","#else","n = (ambienceMatrix * vec4(n, 0.0)).xyz;","gl_FragColor.xyz = envMapExposure * textureCube(tEnvMap, vec3(n.x, -n.z,n.y)).xyz;","#endif","gl_FragColor.w = 1.0;","#if defined( GAMMA_OUTPUT ) && defined( HDR )","gl_FragColor.xyz = pow(gl_FragColor.xyz, vec3(1.0 / 2.2));","#elif !defined( GAMMA_OUTPUT ) && defined( sRGB )","gl_FragColor.xyz *= gl_FragColor.xyz;","#endif","gl_FragColor *= vec4(ambient, 1.0);","}"].join("\n")};j.CubeMapShader={uniforms:{tEnvMap:{type:"t",value:null},tFlip:{type:"f",value:-1},envMapExposure:{type:"f",value:1},ambienceMatrix:{type:"m4",value:new j.Matrix4()},ambient:{type:"c",value:new j.Color(16777215)}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform samplerCube tEnvMap;","uniform float tFlip;","uniform vec3 ambient;","uniform float envMapExposure;","uniform mat4 ambienceMatrix;","varying vec3 vWorldPosition;","void main() {","vec3 relPos = vWorldPosition - cameraPosition;","relPos = (ambienceMatrix * vec4(relPos,0.0)).xyz;","#if defined(CUBEMAP_ZUP)","gl_FragColor = vec4(ambient, 1.0) * textureCube( tEnvMap, vec3( -relPos.x, relPos.zy ) );","#else","gl_FragColor = vec4(ambient, 1.0) * textureCube( tEnvMap, vec3( relPos.x, -relPos.z, relPos.y ) );","#endif","}"].join("\n")};j.LatLongMapShader={defines:{sRGB:false,HDR:false},uniforms:{tEnvMap:{type:"t",value:null},tEnvMap2:{type:"t",value:null},envMapHDRSize:{type:"v2",value:new j.Vector4(2048,1024)},invScreenSize:{type:"v2",value:new j.Vector2()},cameraSight:{type:"v3",value:new j.Vector3()},cameraUp:{type:"v3",value:new j.Vector3()},cameraRight:{type:"v3",value:new j.Vector3()},startOffset:{type:"v2",value:new j.Vector2(0,0)},endOffset:{type:"v2",value:new j.Vector2(1,1)},ambienceMatrix:{type:"m4",value:new j.Matrix4()},blurCoef:{type:"f",value:0},envMapExposure:{type:"f",value:1},ambient:{type:"c",value:new j.Color(16777215)}},vertexShader:["void main() {",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tEnvMap;","#if defined( ENVMAP2 ) ","uniform sampler2D tEnvMap2;","#endif","uniform mat4 ambienceMatrix;","uniform float blurCoef;","uniform float envMapExposure;","uniform vec3 ambient;","uniform vec2 invScreenSize;","uniform vec3 cameraSight;","uniform vec3 cameraUp;","uniform vec3 cameraRight;","uniform vec2 startOffset;","uniform vec2 endOffset;","const float INV_PI = 0.31830988618379;","const float PI = 3.14159265359;","#if defined( HDR )","uniform vec2 envMapHDRSize;","vec4 texture2DFromRGBE(sampler2D textureSampler, vec2 uv) {","vec4 texelRGBE = texture2D(textureSampler, uv);","float exponent = pow(2.0, 255.0 * texelRGBE.w - 128.0);","return vec4((255.0 / 256.0) * texelRGBE.xyz * exponent, 1.0);","}","vec4 texture2DBilinearFromRGBE(sampler2D textureSampler, vec2 uv, vec2 textureSize, vec2 texelSize) {","vec4 tl = texture2DFromRGBE(textureSampler, uv);","vec4 tr = texture2DFromRGBE(textureSampler, uv + vec2(texelSize.x, 0.0));","vec4 bl = texture2DFromRGBE(textureSampler, uv + vec2(0.0, texelSize.y));","vec4 br = texture2DFromRGBE(textureSampler, uv + vec2(texelSize.x, texelSize.y));","vec2 f = fract(uv.xy * textureSize.xy);","vec4 tA = mix(tl, tr, f.x);","vec4 tB = mix(bl, br, f.x);","return mix(tA, tB, f.y);","}","vec4 sampleMipMapRoughness(vec2 uv, float mip, float coef, sampler2D map0, sampler2D map1, vec2 textureSize, vec2 texelSize) {","vec4 color1;","vec4 color2;","vec2 uv1;","vec2 uv2;","if (mip < 1.0) {","color1 = texture2DBilinearFromRGBE(map0, uv, textureSize, texelSize);","} else {","textureSize.y *= 2.0;","texelSize.y *= 0.5;","float level1 = clamp(floor(mip) - 1.0, 0.0, 4.0);","float t10 = pow(2.0, -floor(log2(level1 + 1.0)));","float t11 = 2.0 - (level1 + 2.0) * t10;","float t12 = 0.5 * t10;","uv1 = vec2(t11 + 1.5 * texelSize.x + (2.0 * t12 - 3.0 * texelSize.x) * uv.x, t12 + 1.5 * texelSize.x + (t12 - 3.0 * texelSize.x) * uv.y);","color1 = texture2DBilinearFromRGBE(map1, uv1, textureSize, texelSize);","}","float level2 = clamp(floor(mip), 0.0, 5.0);","float t20 = pow(2.0, -floor(log2(level2 + 1.0)));","float t21 = 2.0 - (level2 + 2.0) * t20;","float t22 = 0.5 * t20;","uv2 = vec2(t21 + 1.5 * texelSize.x + (2.0 * t22 - 3.0 * texelSize.x) * uv.x, t22 + 1.5 * texelSize.x + (t22 - 3.0 * texelSize.x) * uv.y);","color2 = texture2DBilinearFromRGBE(map1, uv2, textureSize, texelSize);","return mix(color1, color2, coef);","}","#endif","void main() {","vec2 screenOffset = 2.0 * mix(startOffset, endOffset, gl_FragCoord.xy * invScreenSize) - 1.0;","vec3 dir = normalize(cameraSight + screenOffset.x * cameraRight + screenOffset.y * cameraUp);","dir = (ambienceMatrix * vec4(dir,0.0)).xyz;","#if defined( HDR )","#else","dir.y *= -1.0;","#endif","float phi = atan(dir.y, dir.x);","float theta = acos(dir.z);","vec2 texelCoord = vec2(fract(0.5 + 0.5 * INV_PI * phi), 1.0 - INV_PI * theta);","#if defined( HDR )","vec2 texelSize = vec2(1.0 / envMapHDRSize);","#if defined( ENVMAP2 )","float mipValue = max(6.0 + 1.15 * log2(blurCoef + 0.0000001), 0.0);","float mipCoef = fract(mipValue);","if (mipValue > 6.0) {","mipValue = 6.0;","mipCoef = 1.0;","}","gl_FragColor.xyz = envMapExposure * sampleMipMapRoughness( texelCoord, mipValue, mipCoef, tEnvMap, tEnvMap2, envMapHDRSize, texelSize ).xyz;","#else","gl_FragColor.xyz = envMapExposure * texture2DBilinearFromRGBE( tEnvMap, texelCoord, envMapHDRSize, texelSize ).xyz;","#endif","#else","gl_FragColor.xyz = envMapExposure * texture2D( tEnvMap, texelCoord ).xyz;","#endif","gl_FragColor.w = 1.0;","#if defined( GAMMA_OUTPUT ) && defined( HDR )","gl_FragColor.xyz = pow(gl_FragColor.xyz, vec3(1.0 / 2.2));","#elif !defined( GAMMA_OUTPUT ) && defined( sRGB )","gl_FragColor.xyz = pow(gl_FragColor.xyz,vec3(2.2));","#endif","gl_FragColor *= vec4(ambient, 1.0);","}"].join("\n")};j.SimpleMapShader={defines:{sRGB:false,HDR:false},uniforms:{tEnvMap:{type:"t",value:null},envMapExposure:{type:"f",value:1},ambient:{type:"c",value:new j.Color(16777215)},offset:{type:"v2",value:new j.Vector2(0,0)},invSize:{type:"v2",value:new j.Vector2(512,512)}},vertexShader:["void main() {",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tEnvMap;","uniform vec3 ambient;","uniform vec2 invSize;","uniform vec2 offset;","uniform float envMapExposure;","void main() {","vec2 coord = (gl_FragCoord.xy - offset) * invSize;","vec4 color = vec4(0.0);","color = envMapExposure * texture2D( tEnvMap, coord );","#if defined( GAMMA_INPUT ) && defined( sRGB )","color *= color;","#endif","vec2 edge = step(vec2(0.0), coord) - step(vec2(1.0), coord);","gl_FragColor = color * vec4(ambient, 1.0) * (edge.x * edge.y) + vec4(0.0,0.0,0.0,1.0) * (1.0 - (edge.x * edge.y)) ;","}"].join("\n")};j.GradientBackgroundShader2={uniforms:{colors:{type:"fv",value:[]},},vertexShader:["uniform vec3 colors[2];","varying vec3 vColor;","void main() {","vColor = mix(colors[0], colors[1], smoothstep(-1.0, 1.0, position.z));",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec3 vColor;","void main() {","gl_FragColor = vec4(vColor, 1.0);","#ifdef GAMMA_INPUT","gl_FragColor *= gl_FragColor;","#endif",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};j.GradientBackgroundShader3={uniforms:{colors:{type:"fv",value:[]}},vertexShader:["uniform vec3 colors[3];","varying vec3 vColor;","void main() {","vec3 borderColor = mix(colors[2], colors[0], step(0.0, position.z));","float a = sign(position.z) * position.z;","vColor = mix(colors[1], borderColor, a);",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec3 vColor;","void main() {","gl_FragColor = vec4(vColor, 1.0);","#ifdef GAMMA_INPUT","gl_FragColor *= gl_FragColor;","#endif",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};j.GradientBackgroundShader4={uniforms:{colors:{type:"fv",value:[]},horizonHeight:{type:"f",value:0}},vertexShader:["varying float vPositionZ;","void main() {","vPositionZ = position.z;",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 colors[4];","uniform float horizonHeight;","varying float vPositionZ;","void main() {","float positionSign = step(horizonHeight, vPositionZ);","vec3 centerColor = positionSign * colors[1] + ((1.0 - positionSign) * colors[3]);","vec3 borderColor = positionSign * colors[0] + ((1.0 - positionSign) * colors[2]);","float minHeight = positionSign * horizonHeight + ((1.0 - positionSign) * -1.0);","float maxHeight = positionSign + ((1.0 - positionSign) * horizonHeight);","vec3 color = mix(centerColor, borderColor, smoothstep(minHeight, maxHeight, vPositionZ));","gl_FragColor = vec4(color, 1.0);","#ifdef GAMMA_INPUT","gl_FragColor *= gl_FragColor;","#endif",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};j.HatchingMeshMaterial=function(l){var m={side:j.FrontSide,uniforms:j.UniformsUtils.merge([j.UniformsLib.clipPlanes,{planeU:{type:"v3",value:new j.Vector3(1,0,0)},planeV:{type:"v3",value:new j.Vector3(0,1,0)},hatchingDirection:{type:"v2",value:new j.Vector2(1,-1)},hatchingNormal:{type:"v2",value:new j.Vector2(-1,-1)},hatchingSpaceWidth:{type:"f",value:10},hatchingSpaceColor:{type:"v4",value:new j.Vector4(10,10,10,1)},hatchingLineWidth:{type:"f",value:1},hatchingLineColor:{type:"v4",value:new j.Vector4(0,0,0,1)}}]),vertexColors:j.VertexColors,vertexShaderPars:[j.ShaderChunk.clip_pars_vertex,"varying vec2 vUv;","varying vec4 myPosition;","uniform vec3 planeU;","uniform vec3 planeV;"].join("\n"),vertexShaderBody:[j._DefaultShaderChunk.model_view_transformation_vertex,"vec3 mvPlaneU = (viewMatrix * vec4(planeU, 0.0)).xyz;","vec3 mvPlaneV = (viewMatrix * vec4(planeV, 0.0)).xyz;",j._DefaultShaderChunk.model_view_normal_vertex,"vUv = vec2(dot(mvPosition.xyz, mvPlaneU), dot(mvPosition.xyz, mvPlaneV))-vec2(dot(viewMatrix[3].xyz, mvPlaneU), dot(viewMatrix[3].xyz, mvPlaneV));","gl_Position = projectionMatrix * mvPosition;","myPosition = gl_Position;",j.ShaderChunk.clip_vertex].join("\n"),fragmentShaderPars:[j.ShaderChunk.clip_pars_fragment,"varying vec2 vUv;","varying vec4 myPosition;","uniform vec2 hatchingDirection;","uniform vec2 hatchingNormal;","uniform float hatchingSpaceWidth;","uniform float hatchingLineWidth;","uniform vec4 hatchingSpaceColor;","uniform vec4 hatchingLineColor;","const float pi = 3.141592653589793;",].join("\n"),fragmentShaderBody:[j.ShaderChunk.clip_fragment,"float eval = hatchingNormal.x*vUv.x + hatchingNormal.y*vUv.y;","float k = mod(eval, hatchingSpaceWidth);","vec2 fwx = dot(hatchingNormal, dFdx(vUv))*hatchingNormal;","vec2 fwy = dot(hatchingNormal, dFdy(vUv))*hatchingNormal;","vec2 fw = abs(fwx) + abs(fwy);","float fwlen = length(fw);","float tol = min(hatchingLineWidth*fwlen, hatchingSpaceWidth - fwlen);","if (k < tol/2.0 || k > hatchingSpaceWidth - tol/2.0) {","  gl_FragColor = hatchingLineColor;","} else {","  gl_FragColor = hatchingSpaceColor;","}",""].join("\n")};this.stripesDirection=new j.Vector2(1,1);this.spaceWidth=1;this.spaceColor=new j.Color(16777215);this.spaceOpacity=1;this.stripesWidth=1;this.stripesColor=new j.Color(0);this.stripesOpacity=1;this.autoSpaceColor=false;this.autoStripesColor=false;j.ShaderMaterialDS.call(this,m);this.enableClipPlanes=true;this.refreshUniforms=function(q,o,p){var r=this._renderedClipPlane;if(r){var n=new j.Vector3();n.crossVectors(r.normal,r.upVector);n.normalize();var s=new j.Vector3();s.crossVectors(n,r.normal);this.uniforms.planeU.value=n;this.uniforms.planeV.value=s}this.uniforms.hatchingDirection.value=this.stripesDirection.clone();this.uniforms.hatchingDirection.value.normalize();this.uniforms.hatchingNormal.value=new j.Vector2(this.stripesDirection.y,-this.stripesDirection.x);this.uniforms.hatchingNormal.value.normalize();this.uniforms.hatchingSpaceWidth.value=this.spaceWidth;this.uniforms.hatchingLineWidth.value=this.stripesWidth;if(q.gammaInput){this.uniforms.hatchingSpaceColor.value=new j.Vector4(this.spaceColor.r*this.spaceColor.r,this.spaceColor.g*this.spaceColor.g,this.spaceColor.b*this.spaceColor.b,this.stripesOpacity);this.uniforms.hatchingLineColor.value=new j.Vector4(this.stripesColor.r*this.stripesColor.r,this.stripesColor.g*this.stripesColor.g,this.stripesColor.b*this.stripesColor.b,this.stripesOpacity)}else{this.uniforms.hatchingSpaceColor.value=new j.Vector4(this.spaceColor.r,this.spaceColor.g,this.spaceColor.b,this.stripesOpacity);this.uniforms.hatchingLineColor.value=new j.Vector4(this.stripesColor.r,this.stripesColor.g,this.stripesColor.b,this.stripesOpacity)}};this.setValues(l)};j.HatchingMeshMaterial.prototype=Object.create(j.ShaderMaterialDS.prototype);j.HatchingMeshMaterial.prototype.clone=function(){var l=new j.HatchingMeshMaterial();j.ShaderMaterialDS.prototype.clone.call(this,l);l.stripesDirection=this.stripesDirection.clone();l.spaceWidth=this.spaceWidth;l.spaceColor=this.spaceColor.clone();l.spaceOpacity=this.spaceOpacity;l.stripesWidth=this.stripesWidth;l.stripesColor=this.stripesColor.clone();l.stripesOpacity=this.stripesOpacity;l.autoStripesColor=this.autoStripesColor;l.autoSpaceColor=this.autoSpaceColor;l.uniforms.planeU.value=this.uniforms.planeU.value.clone();l.uniforms.planeV.value=this.uniforms.planeV.value.clone();return l};j.CSSSVGNode=function(l){j.Object3D.call(this);this.element=l;this.element.renderable=this;this.geometry=new j.Geometry();this.geometry.boundingSphere=new j.Sphere()};j.CSSSVGNode.prototype=Object.create(j.Object3D.prototype);return UWA.namespace("THREEDS/Core",j)});define("Visualization/ThreeJS_DS",["DS/Visualization/ThreeJS_DS","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/ThreeJS_DS");return b});define("DS/Visualization/BudgetedRenderManager",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(a,c){var b=a.extend({init:function(d){this.viewer=d;this._animationFrameId=-1;this._isRenderFrame=false;this._frameTime=0;this._lastAnimationTimeStamp=-1;this._isActive=false;this._lastRefreshStamp=performance.now();this._objectivePercentage=-1;this._shiftToObjective=0;this._shiftStart=0;this._lastFrameTime=16.7;this._lastRenderFrameTime=16.7;this._framesToSkip=-1;this._maxTime=10000;this._renderCallbackId=-1;return this},_setAsRenderFrame:function(){this._isRenderFrame=true},_askForRender:function(k){if(this._renderCallbackId>=0){clearTimeout(this._renderCallbackId);this._renderCallbackId=-1}if(!this._isActive){k.budgeted=false;this.viewer.render(k)}else{var g=performance.now();var j=g-this._lastRefreshStamp;var h=this._lastRenderFrameTime-this._lastFrameTime;var d=this._objectivePercentage;var f=(performance.now()-this._shiftStart)/this._shiftToObjective;f=Math.min(Math.max(0,f),1);f=f*f*(3-2*f);d=1-f+d*f;var e=0;if(h>d*this._lastRenderFrameTime){e=(h*(1-d))/d}if(e<=j||j>this._maxTime){k.budgeted=false;this._lastRefreshStamp=g;this.viewer.render(k)}else{var l=this;this._renderCallbackId=setTimeout(function(){l.viewer.render(k)},e)}}},_resetShift:function(){this._shiftStart=performance.now();this._framesToSkip=0},resetMeasures:function(){this._lastAnimationTimeStamp=-1;this._lastFrameTime=16.7;this._lastRenderFrameTime=16.7;this._framesToSkip=-1},setBudget:function(d){this._objectivePercentage=Math.max(0,Math.min(1,d));this._isActive=true;var f=this;if(this._animationFrameId<0){var e=function(){var g=performance.now();if(f._lastAnimationTimeStamp>=0){f._frameTime=g-f._lastAnimationTimeStamp}if(f._isRenderFrame){f._lastRenderFrameTime=Math.max(f._frameTime,16)}else{f._lastFrameTime=Math.max(f._frameTime,16);f._framesToSkip--}f._lastAnimationTimeStamp=g;f._isRenderFrame=false;f._animationFrameId=requestAnimationFrame(e)};this._animationFrameId=requestAnimationFrame(e);this.resetMeasures()}},disableBudget:function(){this._isActive=false;this._objectivePercentage=-1;if(this._animationFrameId>0){cancelAnimationFrame(this._animationFrameId);this._animationFrameId=-1}},setMaxTime:function(d){this._maxTime=d},setShiftingObjective:function(d){this._shiftToObjective=d}});return UWA.namespace("THREEDS/BudgetedRenderManager",b)});define("DS/Visualization/IESUtils",["DS/Visualization/ThreeJS_DS"],function(b){var a={nbTexturesBeingLoaded:0,crossOrigin:"anonymous",loadIESTexture:function(d,c,l,j,g,k){var e=128,m=128;var f=new b.DataTexture(null,e,m,b.LuminanceFormat,b.FloatType);f.mapping=c;f.generateMipmaps=false;f.loadEndStatus="loading";var h=new XMLHttpRequest();h.onload=function(){a.nbTexturesBeingLoaded--;var n=a.parserIES(h.response);f.image.data=n;f.loadEndStatus="complete";f.generateMipmaps=false;f.minFilter=b.LinearFilter;f.magFilter=b.LinearFilter;f.needsUpdate=true;if(l){l(f)}var o;for(o=0;o<f.onLoadCallbacks.length;o++){f.onLoadCallbacks[o](f)}};h.onerror=function(){j();a.nbTexturesBeingLoaded--;f.loadEndStatus="error"};if(k){f.loadEndStatus="pause";f.onRequest=function(){f.loadEndStatus="loading";a.nbTexturesBeingLoaded++;h.open("GET",d,true);h.responseType="text";h.withCredentials=!!g;h.send(null)}}else{f.loadEndStatus="loading";a.nbTexturesBeingLoaded++;h.open("GET",d,true);h.responseType="text";h.withCredentials=!!g;h.send(null)}return f},parserIES:function(j){var Z=j.lastIndexOf("TILT=");var g=j.slice(Z);Z=g.indexOf("\n");g=g.slice(Z+1);g=g.replace(/\n|\s|\r/g,"_");g=g.replace("__","_");g=g.split("_");var B=[];for(var S=0;S<g.length;S++){if(g[S]==""){continue}B[B.length]=parseFloat(g[S])}g=null;var P,F,X,s,f,D,W,O,r,ab,C,k,e,q,t,E,U,M,p=-1,u=-1,H=-1;P=B[0];F=B[1];X=B[2];s=B[3];f=B[4];D=B[5];W=B[6];O=B[7];r=B[8];ab=B[9];C=B[10];k=B[11];e=B[12];E=13;U=128;M=128;q=[s];t=[f];var R=[];var n=new Float32Array(U*M);for(var L=0;L<U;L++){for(var K=0;K<M;K++){n[L*M+K]=0}}for(var N=0;N<s;N++){q[N]=B[N+E]}E+=parseInt(s);for(var T=0;T<f;T++){t[T]=B[T+E]}E+=parseInt(f);if(D==1){if(q[s-1]==90){u=1}else{if(q[s-1]==180){u=2}}if(f==1&&t[0]==0){p=0}else{if(t[f-1]==90){p=1}else{if(t[f-1]==180){p=2}}}for(var T=0;T<f;T++){for(var N=0;N<s;N++){var G=B[N+T*s+E];H=H<G?G:H}}if(p==0){f=2;t[1]=180;for(var N=0;N<s;N++){B[N+s+E]=B[N+E]}}if(p==1){if(u==1){for(var T=0;T<f;T++){var A=90-(t[T]-90);R[t[T]]=[s*2];R[A]=[s*2];for(var N=0;N<s;N++){var o=90-(q[N]-90);R[t[T]][q[N]]=R[A][q[N]]=R[t[T]][o]=R[A][o]=B[N+T*s+E]/H}}for(var N=0;N<s-1;N++){q.push(90-(q[N]-90))}}else{if(u==2){for(var T=0;T<f;T++){var A=90-(t[T]-90);R[t[T]]=[s*2];R[A]=[s*2];for(var N=0;N<s;N++){R[t[T]][q[N]]=R[A][q[N]]=B[N+T*s+E]/H}}}}for(var T=0;T<f-1;T++){t.push(90-(t[T]-90))}}else{if(p==0||p==2){if(u==1){for(var T=0;T<f;T++){R[t[T]]=[s*2];for(var N=0;N<s;N++){var o=90-(q[N]-90);R[t[T]][q[N]]=R[t[T]][o]=B[N+T*s+E]/H}}for(var N=0;N<s-1;N++){q.push(90-(q[N]-90))}}else{if(u==2){for(var T=0;T<f;T++){R[t[T]]=[s];for(var N=0;N<s;N++){R[t[T]][q[N]]=B[N+T*s+E]/H}}}}}else{console.log("Erreur symetricHType "+p)}}t=t.sort(function(v,h){return v-h});q=q.sort(function(v,h){return v-h});var w=180/U;var m=t[0];var Q=t[1];var I=1;for(var T=0;T<180;T+=w){while(T>Q){m=Q;Q=t[I+1];I++}var d=q[0];var J=q[1];var z=1;var l=(T-m)/(Q-m);for(var N=0;N<180;N+=w){while(N>J){d=J;J=q[z+1];z++}var c=(N-d)/(J-d);var Y=(1-c)*R[m][d]+c*R[m][J];var V=(1-c)*R[Q][d]+c*R[Q][J];n[T/w*U+N/w]=(1-l)*Y+l*V}}}else{console.log("Mauvais Gonio Type")}return n}};return a});define("DS/VisuEvents/ScreenEvent",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events"],function(c,d,a){var b=c.extend({init:function(e){this.type="Screen";this.view=null;this.path=null;this.event=e;this.isPrimary=false;this.state=b.State.NONE;this.startTime=0;this.currentTime=0;this.startPosition=new d.Vector2();this.currentPosition=new d.Vector2();this.lastPosition=new d.Vector2();this.deltaPosition=new d.Vector2();this.offsetPosition=new d.Vector2();this._startPosition=new d.Vector2();this._currentPosition=new d.Vector2();this._lastPosition=new d.Vector2();this._deltaPosition=new d.Vector2();this._offsetPosition=new d.Vector2();this.updateView(e);return this},setPrimary:function(e){this.isPrimary=e},update:function(e){this.currentTime=new Date().getTime();this.event=e;switch(e.type){case"mousedown":case"touchstart":case"mousewheel":case"DOMMouseScroll":this.state=b.State.BEGIN;this.startTime=this.currentTime;break;case"keydown":if(this.state===b.State.NONE){this.state=b.State.BEGIN;this.startTime=this.currentTime}break;case"mousemove":case"touchmove":this.state=b.State.MOVE;this.updateView(e);break;case"keyup":case"mouseup":case"touchend":this.state=b.State.END;break;case"mouseleave":case"mouseout":case"touchcancel":this.state=b.State.CANCEL;break;default:break}},updateView:function(e){var f;if(e.path&&e.path.length){f=e.path[0].__impl4cf1e782hg__||e.path[0].impl||e.path[0];this.path=e.path}else{if(e.target){f=e.target}else{if(e.srcElement){f=e.srcElement}}}if(this.view){this.startPosition.copy(this.getRelativePositionToView(this.startPosition,f));this.currentPosition.copy(this.getRelativePositionToView(this.currentPosition,f));this.lastPosition.copy(this.getRelativePositionToView(this.lastPosition,f))}this.view=f},nextState:function(){switch(this.state){case b.State.BEGIN:case b.State.MOVE:this.state=b.State.IDLE;break;case b.State.END:case b.State.CANCEL:default:this.state=b.State.NONE;break}},getType:function(){return this.type},getState:function(){return this.state},getView:function(){return this.view},getJSEvent:function(){return this.event},isInView:function(g){var e=g;if(!(g instanceof Array)){e=[g]}if(this.path){for(var k=0;k<e.length;k++){for(var h=0;h<this.path.length;h++){var l=this.path[h].__impl4cf1e782hg__||this.path[h].impl||this.path[h];var f=e[k].__impl4cf1e782hg__||e[k].impl||e[k];if(l===f){return true}}}}else{for(var k=0;k<e.length;k++){var m=this.view;while(m){if(m===e[k]){return true}m=m.parentNode}}}return false},getStartPosition:function(e){if(e){return this.getRelativePositionToView2(this._startPosition,e)}else{return this.getRelativePositionToView2(this._startPosition,this.view)}},getCurrentPosition:function(e){if(e){return this.getRelativePositionToView2(this._currentPosition,e)}else{return this.getRelativePositionToView2(this._currentPosition,this.view)}},getLastPosition:function(e){if(e){return this.getRelativePositionToView2(this._lastPosition,e)}else{return this.getRelativePositionToView2(this._lastPosition,this.view)}},getOffsetPosition:function(){return this._offsetPosition.clone()},getDeltaPosition:function(){return this._deltaPosition.clone()},getRelativePositionToView:function(j,e){var h,f;try{h=this.view.getBoundingClientRect()}catch(g){h={left:0,top:0}}try{f=e.getBoundingClientRect()}catch(g){f={left:0,top:0}}return new d.Vector2(j.x+h.left-f.left,j.y+h.top-f.top)},getRelativePositionToView2:function(h,e){var f;try{f=e.getBoundingClientRect()}catch(g){f={left:0,top:0}}return new d.Vector2(h.x-f.left,h.y-f.top)},});b.State={NONE:0,BEGIN:1,IDLE:2,MOVE:3,END:4,CANCEL:5};b.MouseButton={NONE:-1,LEFT:0,MIDDLE:1,RIGHT:2,WHEEL:3};b.KeyboardKey={SHIFT:16,CTRL:17,S:83};b.printMouseButton=function(e){switch(e){case b.MouseButton.LEFT:return"Left";case b.MouseButton.MIDDLE:return"Middle";case b.MouseButton.RIGHT:return"Right";case b.MouseButton.NONE:default:return""}};return UWA.namespace("THREEDS/Events/ScreenEvent",b)});define("VisuEvents/ScreenEvent",["DS/VisuEvents/ScreenEvent","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuEvents/ScreenEvent");return b});define("DS/Gestures/BasicGesture",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events"],function(e,f,a){var d=0;var b=0;var c=e.extend({init:function(g){this.name=g?g:"";this.id=d++;this.view=[];this.priority=1000;this._order=0;this._needsUpdate=false;this.currentEvent=null;this.events=[];this.debugEvents=false;this.state=c.State.INIT;this.firstChange=false;this.lastChange=false;this.gestures=[];this.requiredBy=0;this.maskedBy=[];this.callbacks=[];this.action="";return this},setView:function(g){if(!g){return}if(g instanceof Array){this.view=[];for(var h=0;h<g.length;h++){this.view.push(g[h])}}else{this.view=[g]}},setAction:function(g){this.action=g},addView:function(g){if(!g){return}this.view.push(g)},removeView:function(g){if(!g){return}var h=this.view.indexOf(g);if(h===-1){return}this.view.splice(h,1)},resetView:function(){this.view=[]},setPriority:function(g){this.priority=g},requireGesture:function(g){this.gestures.push(g);g.requiredBy++;this._needsUpdate=true},maskGesture:function(g){if(g!==null){g.maskedBy.push(this)}},addCallback:function(g){if(typeof g==="function"){for(var j=0;j<this.callbacks.length;j++){if(this.callbacks[j].cb===g){return this.callbacks[j].uid}}var h=this._getEventID();this.callbacks.push({cb:g,uid:h});return h}return null},removeCallback:function(g){if(typeof g==="function"){for(var h=0;h<this.callbacks.length;h++){if(this.callbacks[h].cb===g){this.callbacks[h].cb=null;return true}}}return false},removeCallbackFromToken:function(h){for(var g=0;g<this.callbacks.length;g++){if((this.callbacks[g].uid===h)&&this.callbacks[g].cb){this.callbacks[g].cb=null;return true}}return false},executeCallbacks:function(j){var k=false,h;var g=this.callbacks.slice();for(h=0;h<g.length;h++){if(g[h].cb){g[h].cb.call(this,j)}else{k=true}}k&&this._updateCBArray()},_updateCBArray:function(){if(!this.callbacks.length){return}var h=[];for(var g=0;g<this.callbacks.length;g++){if(this.callbacks[g].cb){h.push(this.callbacks[g])}}this.callbacks=h},_getEventID:function(){var g=this.id+"_"+b;b++;return g},isUsed:function(){return this.callbacks.length||this.requiredBy},_dispose:function(h){this._updateCBArray();if(!this.isUsed()){for(var g=0;g<this.gestures.length;g++){this.gestures[g].requiredBy--;!this.gestures[g].requiredBy&&this.gestures[g]._dispose(h)}h&&h.apply(this);this.view=[]}},detect:function(g){this.currentEvent=g},execute:function(h){if((this.state===c.State.OK)||(this.state===c.State.CHANGE)){if(!h){for(var g=0;g<this.maskedBy.length;g++){var j=this.maskedBy[g];if((j.state===c.State.OK)||(j.state===c.State.CHANGE)){return}}}this.triggerEvent(this.currentEvent)}},update:function(){switch(this.state){case c.State.KO:case c.State.OK:case c.State.CANCEL:this.changeState(c.State.INIT);break;case c.State.CHANGE:if(this.lastChange){this.lastChange=false;this.changeState(c.State.INIT)}break;default:break}},setDebugEvents:function(g){this.debugEvents=g},changeState:function(h,g){this.firstChange=(this.state===c.State.BEGIN)&&(h===c.State.CHANGE);this.lastChange=!!g;this.state=h;if(this.debugEvents>=5){console.log("Gesture "+this.name+" change state to "+c.printState(this.state))}},getState:function(){return this.state},getName:function(){return this.name},getEvents:function(){return this.events},triggerEvent:function(){var g={eventChannel:"/VISU/",eventType:"@on"+this.name+"Event",eventID:this.id,from:this.currentEvent,gesture:this,state:this.firstChange?"begin":(this.lastChange?"end":"")};switch(this.debugEvents){case 0:case 1:break;case 2:if(this.state===c.State.OK){console.log(g)}break;case 3:if(this.state===c.State.CHANGE){console.log(g)}break;case 4:case 5:case 6:console.log(g);break;default:break}a.publish({event:"/VISU/on"+this.name,data:g});if(c.RecordEventsManager){window.WebVisuCurrentGesture=this}this.executeCallbacks(g);if(c.RecordEventsManager){window.WebVisuCurrentGesture=null}if(c.RecordEventsManager){c.RecordEventsManager.recordBasicGesture(this)}},getElapsedTime:function(){if(this.getEvents().length>0){var g=this.getEvents()[0].currentTime-this.getEvents()[0].startTime;return g}return null}});c.State={INIT:0,BEGIN:1,CHANGE:2,OK:3,KO:4,CANCEL:5};c.printState=function(g){switch(g){case c.State.INIT:return"INIT";case c.State.BEGIN:return"BEGIN";case c.State.CHANGE:return"CHANGE";case c.State.OK:return"OK";case c.State.KO:return"KO";case c.State.CANCEL:return"CANCEL";default:return""}};c.RecordEventsManager=null;c.setRecordEventsManager=function(g){this.RecordEventsManager=g};return UWA.namespace("THREEDS/Gestures/BasicGesture",c)});define("Gestures/BasicGesture",["DS/Gestures/BasicGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/BasicGesture");return b});define("DS/Plugins/ShaderPass",["DS/Visualization/ThreeJS_DS"],function(c){var a=1;var b=function(e,f,d){this.textureID=(f!==undefined)?f:"tDiffuse";this.uniforms=c.UniformsUtils.clone(e.uniforms);this.name=d;this.id="S"+(a++);this.defines={};if(e.defines){this.defines=e.defines}this.material=new c.ShaderMaterial({uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,defines:this.defines});this.material.force=true;this.material.polygonOffset=true;this.material.polygonOffsetFactor=0;this.material.polygonOffsetUnits=0;this.renderToScreen=false;this.needsSwap=true;this.composer=null;this.requiredComposers=[];this.forceRenderTarget=null;this.order=0;this.isCustomPass=false;this.defaults={};this.linkedComposerContexts=[];this.idString="main";this.changeRenderTargetProperties=null;this.enableWarmStart=false;this.beforeRenderCB=null;this.afterRenderCB=null;this.requiredReadBuffer=null;this.isOITPass=false;this.composer=null;this.disabledByDefault=false;this.order=0;this.gammaCorrectionPass=false;this.isRobotPass=false};b.prototype={compileShader:function(d){d&&d.initMaterial(this.material,[],null,null,this.material.programManager.getProgramID(null));this.material._rendererId=d.context.contextId;this.material.needsUpdate=false},setForceRenderTarget:function(d){this.forceRenderTarget=d},addRequiredComposer:function(d){this.requiredComposers.push(d)},setCustomPass:function(){this.isCustomPass=true},getDefaultState:function(){return{enabled:this.disabledByDefault?false:true,renderToCanvas:false,isLastPass:false}},addLinkedEffectComposerContext:function(d){if(this.linkedComposerContexts.indexOf(d)<0){this.linkedComposerContexts.push(d);d.useCount++}},shareDepth:function(d,g,e){var f=d.composerContext.forceRenderTarget;if(!f){f=d.renderTargetPool.buildRenderTarget(d.composerContext.width,d.composerContext.height,"linear",null,e,true);f.generateMipmaps=false;d.composerContext.forceRenderTarget=f;this.uniforms[d.targetUniform].value=d.composerContext.forceRenderTarget;this.requiredReadBuffer=e}},render:function(l,p,h,o,k,q,d,r,j,f){if(!k&&this.uniforms[this.textureID]){this.uniforms[this.textureID].value=p}if(this.beforeRenderCB){this.beforeRenderCB(p)}var e;for(e=0;e<this.requiredComposers.length;e++){var g=this.requiredComposers[e];if(g.bShareDepth){this.shareDepth(g,l,p)}if(g.needsCameraUpdate){this.requiredComposers[e].composerContext.cameraName=q.cameraName}var m=g.getAllPasses();if(m.length>0&&m[0].uniforms!==undefined){var n=m[0].uniforms;if(n[this.textureID]!==undefined){n[this.textureID].value=p}}this.requiredComposers[e].render(undefined,undefined,d,j)}this.composer.quad.material=this.material;l.setCurrentPass(this);l.autoClearStencil=false;l.autoClearDepth=false;l.activateSplitScreenMode(h?false:true);l.setDisableDepthTest(true);if(this.forceRenderTarget!==null){h=this.forceRenderTarget}if(f){l.render(this.composer.shaderPassScene,this.composer.camera,undefined,undefined,undefined,l._stateSortingResult,true)}else{l.render(this.composer.shaderPassScene,this.composer.camera,h,false,undefined,l._stateSortingResult,true)}l.setDisableDepthTest(false);l.setCurrentPass(null);if(this.afterRenderCB){this.afterRenderCB()}}};return b});define("Plugins/ShaderPass",["DS/Plugins/ShaderPass","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Plugins/ShaderPass");return b});define("DS/Effects/BasicEffect",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(b,c){var a=b.extend({init:function(d){this.enabled=true;this.composers=[];this.mixPass=null;this.width=2;this.height=2;this.renderer=d;return this},initEffect:function(d,e){},update:function(e,d,f){},setSize:function(e,d){if((this.width===e)&&(this.height===d)){return false}this.width=Math.max(2,e);this.height=Math.max(2,d);return true},updateComposersName:function(d){var e;for(e=0;e<this.composers.length;e++){this.composers[e].composerContext.name=d+"#"+e}},setEnabled:function(d){this.enabled=d;var f;for(f=0;f<this.composers.length;f++){this.composers[f].enabled=d}if(this.mixPass!==null){var e=this.mixPass.composer;if(e&&e.contexts.length){e.contexts[0].enablePass(this.mixPass,d)}}},getMaxIteration:function(){return 0},dispose:function(){var d;for(d=0;d<this.composers.length;d++){if(this.composers[d].composerContext){this.composers[d].composerContext.dispose()}this.composers[d].dispose()}}});return a});define("Effects/BasicEffect",["DS/Effects/BasicEffect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/BasicEffect");return b});define("DS/Plugins/ClearPass",["DS/Visualization/ThreeJS_DS"],function(b){var a=1;var c=function(d){this.name=d;this.id="C"+(a++);this.clearColor=null;this.clearAlpha=1;this.oldClearColor=new b.Color();this.oldClearAlpha=1;this.clear=true;this.clearbColor=false;this.clearDepth=false;this.needsSwap=false;this.clearStencil=false;this.clearStencilValue=null;this.invertTarget=false;this.scene=null;this.idString=null;this.composer=null;this.order=0;this.disabledByDefault=false;this.isCustomPass=false;this.context=null;this.isRobotPass=false;this.defaults={clear:true,doClearDepth:false}};c.prototype={getDefaultState:function(){return{enabled:this.disabledByDefault?false:true,clear:this.defaults.clear,clearColor:this.clearColor,clearAlpha:this.clearAlpha,doClearDepth:this.defaults.doClearDepth,renderToCanvas:false}},setClearStencil:function(d){this.clearStencil=d},setClearDepth:function(d){this.clearDepth=d},setCustomPass:function(){this.isCustomPass=true},setScene:function(d){this.scene=d},render:function(l,h,n,m,k,o,d,p,j,g){if(this.idString&&this.scene&&this.scene.getNbWebGLObjects(this.idString)===0){return}var e=l.context;if(this.clearColor){this.oldClearColor.copy(l.getClearColor());this.oldClearAlpha=l.getClearAlpha();l.setClearColor(this.clearColor,this.clearAlpha)}if(this.clearStencilValue!==null){e.clearStencil(this.clearStencilValue)}else{e.clearStencil(100)}l.autoClear=false;l.autoClearColor=this.clear||this.clearbColor;l.autoClearDepth=this.clear||this.clearDepth;l.autoClearStencil=this.clear||this.clearStencil;l.setCurrentPass(this);var f=null;if(!g){f=this.invertTarget?h:n}l.setRenderTarget(f);var q;if(l.splitScreenMode){l.activateSplitScreenMode(f?false:true)}else{q=l.getScissorTest();l.enableScissorTest(false)}l.clear(this.clear||this.clearbColor,this.clear||this.clearDepth,this.clear||this.clearStencil);if(!l.splitScreenMode){l.enableScissorTest(q)}l.setCurrentPass(null)}};return c});define("Plugins/ClearPass",["DS/Plugins/ClearPass","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Plugins/ClearPass");return b});define("DS/Visualization/MaterialManager",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/CoreEvents/ModelEvents"],function(a,c,h,e,b){function g(n,m){return h.ImageUtils.loadTextureCube(n,m)}function f(n,m){return h.ImageUtils.loadTexture(n,undefined,null,null,m)}var j=null,k=null,d=null,l=a.extend({init:function(n,m,o,p){if(j!==null){if(!j.multiViewer&&m){j.precomputedTexture1&&j.precomputedTexture1.dispose();j.precomputedTexture2&&j.precomputedTexture2.dispose();j.precomputedTexture3&&j.precomputedTexture3.dispose();j.precomputedAreaGGX1texture&&j.precomputedAreaGGX1texture.dispose();j.precomputedAreaGGX2texture&&j.precomputedAreaGGX2texture.dispose();j.precomputedAreaSheentexture&&j.precomputedAreaSheentexture.dispose()}else{this.multiViewer=j.multiViewer;this.canvas=j.canvas;this.context=j.context;this.materials=j.materials;this.threeDXMaterials=j.threeDXMaterials;this.textures=j.textures;this.resources=[];this._modelEvent=j._modelEvent;if(j.backgroundColorMaterial==null){this.backgroundColorMaterial=null;this.initBackgroundColorMaterial(p)}else{this.backgroundColorMaterial=j.backgroundColorMaterial}this.precomputedTexture1=j.precomputedTexture1;this.precomputedTexture2=j.precomputedTexture2;this.precomputedTexture3=j.precomputedTexture3;this.precomputedAreaGGX1texture=j.precomputedAreaGGX1texture;this.precomputedAreaGGX2texture=j.precomputedAreaGGX2texture;this.precomputedAreaSheentexture=j.precomputedAreaSheentexture;return this}}this.materials=[];this.threeDXMaterials=new Map();this.textures=[];this.resources=[];this._modelEvent=new b();k=null;d=null;this.backgroundColorMaterial=null;j=this;this.initResources(n,m,o);this.initBackgroundColorMaterial(p);return this},cleanAll:function(){j.materials=[];j.threeDXMaterials=new Map();this.deallocateSharedMaterials()},deallocateSharedMaterials:function(){var u=["Invisible","Normal","Depth","NormalDepth","ShadowMapDepth","Picking","Highlight","PreHighlight","HighlightMobile"];var o=["Face","Line","Point"];var t=["0","1","2"];var y=["true","false"];var n=[1];for(var s=0;s<u.length;s++){var x=h.DefaultMaterials[u[s]];if(!x){continue}for(var r=0;r<o.length;r++){var z=x[o[r]];if(!z){continue}for(var q=0;q<t.length;q++){var v=z[t[q]];if(!v){continue}for(var p=0;p<y.length;p++){var m=v[y[p]];if(!m){continue}var w=m[n[0]];if(w){w.needsUpdate=true}}}}}},initBackgroundColorMaterial:function(n){if(n==null){return}var m=new h.MeshBasicMaterial({color:n.ambience.getBackgroundColor(),side:h.DoubleSide});this.backgroundColorMaterial=m;n.onBackgroundModify(function(p){var o=new h.Color(p);m.color=o})},initResources:function(q,v,u){this.multiViewer=v;if(v){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("experimental-webgl",{alpha:true,premultipliedAlpha:false,antialias:u,stencil:true,preserveDrawingBuffer:q||false})}var t=c.getWebappsAssetUrl("Effects","");var p=h.ImageUtils.loadTGATexture(t+"precomputedTexture1.bin",new h.UVMapping(),null,null,true,true);p.minFilter=h.NearestFilter;p.magFilter=h.NearestFilter;this.precomputedTexture1=p;var n=h.ImageUtils.loadTGATexture(t+"precomputedTexture2.bin",new h.UVMapping(),null,null,true,true);n.minFilter=h.NearestFilter;n.magFilter=h.NearestFilter;this.precomputedTexture2=n;var m=h.ImageUtils.loadTGATexture(t+"precomputedTexture3.bin",new h.UVMapping(),null,null,true,true);m.minFilter=h.NearestFilter;m.magFilter=h.NearestFilter;this.precomputedTexture3=m;var s=h.ImageUtils.loadCompressedTexture(t+"AreaLightGGX1.dds",new h.UVMapping(),null,null,false,true);s.minFilter=h.LinearFilter;s.magFilter=h.LinearFilter;this.precomputedAreaGGX1texture=s;var r=h.ImageUtils.loadCompressedTexture(t+"AreaLightGGX2.dds",new h.UVMapping(),null,null,false,true);r.minFilter=h.LinearFilter;r.magFilter=h.LinearFilter;this.precomputedAreaGGX2texture=r;var o=h.ImageUtils.loadCompressedTexture(t+"AreaLightSheen.dds",new h.UVMapping(),null,null,false,true);o.minFilter=h.LinearFilter;o.magFilter=h.LinearFilter;this.precomputedAreaSheentexture=o},setCanvasSize:function(n,m){if(this.multiViewer){this.canvas.width=Math.max(this.canvas.width,n);this.canvas.height=Math.max(this.canvas.height,m)}},getCanvas:function(){return this.canvas},getContext:function(){return this.context},onPDSFXMaterial:function(m){return this._modelEvent.subscribe({event:"PDSFXMaterial"},m)},cleanResources:function(){j.textures=[];this.textures=[];this.materials=this.materials.filter(function(m){return !m.hasTexture})},getMaterialById:function(n){var m;for(m=0;m<this.materials.length;m++){if(this.materials[m].threejs_mat.id===n){return this.materials[m].threejs_mat}}return null},getMaterialByName:function(m){var n;for(n=0;n<this.materials.length;n++){if(this.materials[n].threejs_mat.name===m){return this.materials[n].threejs_mat}}return null},getBackgroundColorMaterial:function(){if(this.backgroundColorMaterial){return this.backgroundColorMaterial}else{var m=new h.MeshBasicMaterial({side:h.DoubleSide});return m}},getMaterialCgr:function(n,q,r,t){var p,o,s;if(n.backgoundColor!==undefined){return this.getBackgroundColorMaterial()}for(o=0;o<this.materials.length;o++){p=this.materials[o];s=p.params;if(s.type!=="material"){continue}if((s.ambientCoef!==n.ambientCoef)||(s.diffuseCoef!==n.diffuseCoef)||(s.specularCoef!==n.specularCoef)){continue}if((s.colorAmbient[0]!==n.colorAmbient[0])||(s.colorAmbient[1]!==n.colorAmbient[1])||(s.colorAmbient[2]!==n.colorAmbient[2])){continue}if((s.colorDiffuse[0]!==n.colorDiffuse[0])||(s.colorDiffuse[1]!==n.colorDiffuse[1])||(s.colorDiffuse[2]!==n.colorDiffuse[2])){continue}if((s.colorSpecular[0]!==n.colorSpecular[0])||(s.colorSpecular[1]!==n.colorSpecular[1])||(s.colorSpecular[2]!==n.colorSpecular[2])){continue}if((s.url!==undefined)&&(n.textureId===-1)){continue}if((s.url===undefined)&&(n.textureId!==-1)){continue}if(n.textureId!==-1){continue}if(s.transparent!==n.transparent){continue}if(s.shininess!==n.shininess){continue}if(s.textureImageNumberComposante!==n.textureImageNumberComposante){continue}if(s.textureBlending!==n.textureBlending){continue}if(s.magFilter!==n.magFilter){continue}if(s.minFilter!==n.minFilter){continue}if(s.mappingFunction!==n.mappingFunction){continue}if(s.textureWrapS!==n.textureWrapS){continue}if(s.textureWrapT!==n.textureWrapT){continue}if(s.addedComposantInTexEnv!==n.addedComposantInTexEnv){continue}if(s.mapping){if(!n.mapping||s.mapping.type!==n.mapping.type||s.mapping.ObjectTransformation!==n.mapping.ObjectTransformation||s.mapping.UvTransformation!==n.mapping.UvTransformation){continue}}return p.threejs_mat}p=this.createMaterial(n,q,r,t);return p},getMaterial3DXML:function(n,r,s,u,o){var q,p,t;for(p=0;p<this.materials.length;p++){q=this.materials[p];t=q.params;if(t.type!=="material3DXML"){continue}if(t.shading!==n.shading){continue}if((t.reflectivityCoef!==n.reflectivityCoef)||(t.shininess!==n.shininess)||(t.specularCoef!==n.specularCoef)){continue}if((t.WrappingModeU!==n.WrappingModeU)||(t.WrappingModeV!==n.WrappingModeV)||(t.FlipU!==n.FlipU)||(t.FlipV!==n.FlipV)){continue}if((t.transparency!==n.transparency)||(t.transparent!==n.transparent)||(t.alphaTest!==n.alphaTest)||(t.mappingFunction!==n.mappingFunction)||(t.MappingType!==n.MappingType)){continue}if((t.TextureDimension!==n.TextureDimension)||(t.TextureFunction!==n.TextureFunction)||(t.DiffuseMap!==n.DiffuseMap)){continue}if((t.DiffuseMapRepeat[0]!==n.DiffuseMapRepeat[0])||(t.DiffuseMapRepeat[1]!==n.DiffuseMapRepeat[1])||(t.DiffuseMapWrap[0]!==n.DiffuseMapWrap[0])||(t.DiffuseMapWrap[1]!==n.DiffuseMapWrap[1])){continue}if((t.colorAmbient[0]!==n.colorAmbient[0])||(t.colorAmbient[1]!==n.colorAmbient[1])||(t.colorAmbient[2]!==n.colorAmbient[2])){continue}if((t.colorDiffuse[0]!==n.colorDiffuse[0])||(t.colorDiffuse[1]!==n.colorDiffuse[1])||(t.colorDiffuse[2]!==n.colorDiffuse[2])){continue}if((!t.colorSpecular&&n.colorSpecular)||(t.colorSpecular&&!n.colorSpecular)){continue}if(t.colorSpecular&&n.colorSpecular){if((t.colorSpecular[0]!==n.colorSpecular[0])||(t.colorSpecular[1]!==n.colorSpecular[1])||(t.colorSpecular[2]!==n.colorSpecular[2])){continue}}if(o){if(t.__nbTexturesToLoad===0){o(q.threejs_mat)}else{if(!t.__cbLoadedImages){t.__cbLoadedImages=[]}t.__cbLoadedImages.push(o)}}return q.threejs_mat}q=this.createMaterial(n,r,s,null,o);return q},getTexture:function(r){var q,s,n,o,m=[];if(!r.offset){r.offset=[0,0]}if(!r.repeat){r.repeat=[1,1]}if(!r.wrap){r.wrap=[1,1]}if(!r.filter){r.filter=[5,1]}if(r.resourceId!==undefined){if(this.textures[r.resourceId]){m=this.textures[r.resourceId]}}if(m.length){for(n=0;n<m.length;n++){q=m[n];o=q;s=q.params;if(r.texturePoint!==s.texturePoint){continue}if((r.offset[0]!==s.offset[0])||(r.offset[1]!==s.offset[1])||(r.repeat[0]!==s.repeat[0])||(r.repeat[1]!==s.repeat[1])||(r.wrap[0]!==s.wrap[0])||(r.wrap[1]!==s.wrap[1])||(r.filter[0]!==s.filter[0])||(r.filter[1]!==s.filter[1])){}return q.threejs_texture}q=o.threejs_texture.clone();q.offset.set(r.offset[0],r.offset[1]);q.repeat.set(r.repeat[0],r.repeat[1]);if((r.wrap[0]===1)||(r.wrap[0]=="repeat")){q.wrapS=h.RepeatWrapping}else{q.wrapS=h.ClampToEdgeWrapping}if((r.wrap[1]===1)||(r.wrap[0]=="repeat")){q.wrapT=h.RepeatWrapping}else{q.wrapT=h.ClampToEdgeWrapping}switch(r.filter[0]){case 0:q.min=h.NearestFilter;break;case 1:q.min=h.LinearFilter;break;case 2:q.min=h.NearestMipMapNearestFilter;break;case 3:q.min=h.NearestMipMapLinearFilter;break;case 4:q.min=h.LinearMipMapNearestFilter;break;case 5:q.min=h.LinearMipMapLinearFilter;break}switch(r.filter[1]){case 0:q.mag=h.NearestFilter;break;case 1:q.mag=h.LinearFilter;break;case 2:q.mag=h.NearestMipMapNearestFilter;break;case 3:q.mag=h.NearestMipMapLinearFilter;break;case 4:q.mag=h.LinearMipMapNearestFilter;break;case 5:q.mag=h.LinearMipMapLinearFilter;break}var p={offset:r.offset,repeat:r.repeat,wrap:r.wrap,filter:r.filter,texturePoint:r.texturePoint};this.textures[r.resourceId]=[{params:p,threejs_texture:q}];q._source=h.AssetSource.MATERIAL_MANAGER;return q}q=this.createTexture(r);if(r.resourceId!==undefined){var p={offset:r.offset,repeat:r.repeat,wrap:r.wrap,filter:r.filter,texturePoint:r.texturePoint};this.textures[r.resourceId]=[{params:p,threejs_texture:q}];q._source=h.AssetSource.MATERIAL_MANAGER}return q},createMaterial:function(X,ak,K,R,J){var Y;X.__nbTexturesToLoad=0;X.__cbLoadedImages=[];J&&X.__cbLoadedImages.push(J);function O(){return Y}function ac(m){return(m[0]*255<<16)+(m[1]*255<<8)+m[2]*255}function D(an,am,aq,ao){var ar={};var at=c.getWebappsAssetUrl("Visualization","");var m=f(at+"default_white_color.png");var ap=f(at+"slot_normal_default.jpg");var au=f(at+"slot_specular_anisotropy_direction_default.jpg");if(an.AmbientOcclusion2D&&an.AmbientOcclusion2D.url=="slot_ambient_occlusion_default.tif"){aq.AmbientOcclusion2D=m}else{aq.AmbientOcclusion2D=ao.getTexture({type:"data",resources:am[an.AmbientOcclusion2D.imgId],resourceId:an.AmbientOcclusion2D.imgId})}if(an.Clarity2D&&an.Clarity2D.url=="slot_clarity_default.tif"){aq.Clarity2D=m}else{aq.Clarity2D=ao.getTexture({type:"data",resources:am[an.Clarity2D.imgId],resourceId:an.Clarity2D.imgId})}if(an.Diffuse2D&&an.Diffuse2D.url=="slot_diffuse_default.tif"){aq.Diffuse2D=m}else{aq.Diffuse2D=ao.getTexture({type:"data",resources:am[an.Diffuse2D.imgId],resourceId:an.Diffuse2D.imgId})}if(an.Emissive2D&&an.Emissive2D.url=="slot_emissive_default.tif"){aq.Emissive2D=m}else{aq.Emissive2D=ao.getTexture({type:"data",resources:am[an.Emissive2D.imgId],resourceId:an.Emissive2D.imgId})}if(an.Height2D&&an.Height2D.url=="slot_displacement_default.tif"){aq.Height2D=m}else{aq.Height2D=ao.getTexture({type:"data",resources:am[an.Height2D.imgId],resourceId:an.Height2D.imgId})}if(an.Normal2D&&an.Normal2D.url=="slot_normal_default.tif"){aq.Normal2D=ap}else{aq.Normal2D=ao.getTexture({type:"data",resources:am[an.Height2D.imgId],resourceId:an.Height2D.imgId})}if(an.Specular2D&&an.Specular2D.url=="slot_specular_default.tif"){aq.Specular2D=m}else{aq.Specular2D=ao.getTexture({type:"data",resources:am[an.Specular2D.imgId],resourceId:an.Specular2D.imgId})}if(an.SpecularAnisotropyDirection2D&&an.SpecularAnisotropyDirection2D.url=="slot_specular_anisotropy_direction_default.tif"){aq.SpecularAnisotropyDirection2D=au}else{aq.SpecularAnisotropyDirection2D=ao.getTexture({type:"data",resources:am[an.SpecularAnisotropyDirection2D.imgId],resourceId:an.SpecularAnisotropyDirection2D.imgId})}if(an.SpecularGlossiness2D&&an.SpecularGlossiness2D.url=="slot_specular_glossiness_default.tif"){aq.SpecularGlossiness2D=m}else{aq.SpecularGlossiness2D=ao.getTexture({type:"data",resources:am[an.SpecularGlossiness2D.imgId],resourceId:an.SpecularGlossiness2D.imgId})}if(an.Transparency2D&&an.Transparency2D.url=="slot_transparency_default.tif"){aq.Transparency2D=m}else{aq.Transparency2D=ao.getTexture({type:"data",resources:am[an.Transparency2D.imgId],resourceId:an.Transparency2D.imgId})}}function V(m,ao,at,aq){var am=0,ap=m.param;for(am in ap){var ar=ap[am].imgId;if(ar!==undefined){if(ao[ar]&&ao[ar].url){ap[am].url=ao[ar].url}ap[am].map=at.getTexture({type:"data",resources:ao[ar],resourceId:ar});at.resources[ar]=ap[am].map}}var an={name:m.name,parameters:m.param,material:null};at._modelEvent.publish({event:"PDSFXMaterial",data:an});if(an.material){return an.material}return null}function y(az,aB,aA,aE){if(az!=null){var an=az.param;var ax=0;if(an.transparency_multiply_blend!=undefined){ax=an.transparency_multiply_blend}var au=c.getWebappsAssetUrl("Visualization","");if(k==null){var aD=[au+"studio_pure_white_Specular_Map/posx.jpg",au+"studio_pure_white_Specular_Map/negx.jpg",au+"studio_pure_white_Specular_Map/posy.jpg",au+"studio_pure_white_Specular_Map/negy.jpg",au+"studio_pure_white_Specular_Map/posz.jpg",au+"studio_pure_white_Specular_Map/negz.jpg"];k=g(aD)}var aC;switch(az.name){case"MPM_basic":case"MPM_material":case"MPM_colored_glass":case"MPM_diffuse":case"MPM_soft_plastic":case"MPM_polished_plastic":case"MPM_clear_glass":case"MPM_frosted_glass":case"MPM_diamond":case"MPM_satinated_metal":case"MPM_anisotropic_metal":case"MPM_polished_metal":case"MPM_emissive":var au=c.getWebappsAssetUrl("Visualization","");var aD=[au+"studio_pure_white_Diffuse_Map/posx.jpg",au+"studio_pure_white_Diffuse_Map/negx.jpg",au+"studio_pure_white_Diffuse_Map/posy.jpg",au+"studio_pure_white_Diffuse_Map/negy.jpg",au+"studio_pure_white_Diffuse_Map/posz.jpg",au+"studio_pure_white_Diffuse_Map/negz.jpg"];var at=an.mapping_world_to_object_position_1st_column;var ar=an.mapping_world_to_object_position_2nd_column;var ap=an.mapping_world_to_object_position_3rd_column;var ao=an.mapping_world_to_object_position_4th_column;var aq=new h.Matrix4(at[0],at[1],at[2],at[3],ar[0],ar[1],ar[2],ar[3],ap[0],ap[1],ap[2],ap[3],ao[0],ao[1],ao[2],ao[3]);var am=new h.Matrix4();am.getInverse(aq);var av=g(aD);var ay={};D(an,aB,ay,aA);aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{mapping_world_inverse:{type:"m4",value:am},default_sp_normal:{type:"fv4",value:an.default_sp_normal},default_generic_brdf_diffuse_color:{type:"fv4",value:an.default_generic_brdf_diffuse_color},default_generic_brdf_specular_color:{type:"fv4",value:an.default_generic_brdf_specular_color},default_generic_edf_diffuse_color:{type:"fv4",value:an.default_generic_edf_diffuse_color},default_vp_color:{type:"fv4",value:an.default_vp_color},default_sp_bump:{type:"f",value:an.default_sp_bump},default_sp_displacement:{type:"f",value:an.default_sp_displacement},default_sp_height:{type:"f",value:an.default_sp_height},default_sp_opacity:{type:"f",value:an.default_sp_opacity},default_sp_ambient_occlusion:{type:"f",value:an.default_sp_ambient_occlusion},default_generic_brdf_ior:{type:"f",value:an.default_generic_brdf_ior},default_generic_brdf_diffuse_weight:{type:"f",value:an.default_generic_brdf_diffuse_weight},default_generic_brdf_diffuse_glossiness:{type:"f",value:an.default_generic_brdf_diffuse_glossiness},default_generic_brdf_specular_weight:{type:"f",value:an.default_generic_brdf_specular_weight},default_generic_brdf_specular_glossiness:{type:"f",value:an.default_generic_brdf_specular_glossiness},default_generic_brdf_specular_anisotropy:{type:"f",value:an.default_generic_brdf_specular_anisotropy},default_generic_brdf_specular_anisotropy_rotation:{type:"f",value:an.default_generic_brdf_specular_anisotropy_rotation},default_generic_btdf_transparency_weight:{type:"f",value:an.default_generic_btdf_transparency_weight},default_generic_btdf_transparency_glossiness:{type:"f",value:an.default_generic_btdf_transparency_glossiness},default_generic_edf_diffuse_weight:{type:"f",value:an.default_generic_edf_diffuse_weight},default_vp_ior:{type:"f",value:an.default_vp_ior},default_vp_absorption:{type:"f",value:an.default_vp_absorption},default_vp_abbe_number:{type:"f",value:an.default_vp_abbe_number},default_slot_normal:{type:"i",value:an.default_slot_normal},default_slot_ambient_occlusion:{type:"i",value:an.default_slot_ambient_occlusion},default_slot_height:{type:"i",value:an.default_slot_height},default_slot_opacity:{type:"i",value:an.default_slot_opacity},default_slot_diffuse_color:{type:"i",value:an.default_slot_diffuse_color},default_slot_specular_color:{type:"i",value:an.default_slot_specular_color},default_slot_specular_glossiness:{type:"i",value:an.default_slot_specular_glossiness},default_slot_specular_anisotropy_direction:{type:"i",value:an.default_slot_specular_anisotropy_direction},default_slot_transparency:{type:"i",value:an.default_slot_transparency},default_slot_clarity:{type:"i",value:an.default_slot_clarity},default_slot_emissive_color:{type:"i",value:an.default_slot_emissive_color},mapping_scale_u:{type:"f",value:an.mapping_scale_u},mapping_scale_v:{type:"f",value:an.mapping_scale_v},mapping_flip_u:{type:"f",value:an.mapping_flip_u},mapping_flip_v:{type:"f",value:an.mapping_flip_v},mapping_offset_u:{type:"f",value:an.mapping_offset_u},mapping_offset_v:{type:"f",value:an.mapping_offset_v},mapping_repeat_u:{type:"f",value:an.mapping_repeat_u},mapping_repeat_v:{type:"f",value:an.mapping_repeat_v},mapping_ratio_u:{type:"f",value:an.mapping_ratio_u},mapping_ratio_v:{type:"f",value:an.mapping_ratio_v},mapping_rotation_z:{type:"f",value:an.mapping_rotation_z},thin_walled:{type:"f",value:an.thin_walled},mapping_type:{type:"i",value:an.mapping_type},mapping_world_to_object_position_1st_column:{type:"fv4",value:an.mapping_world_to_object_position_1st_column},mapping_world_to_object_position_2nd_column:{type:"fv4",value:an.mapping_world_to_object_position_2nd_column},mapping_world_to_object_position_3rd_column:{type:"fv4",value:an.mapping_world_to_object_position_3rd_column},mapping_world_to_object_position_4th_column:{type:"fv4",value:an.mapping_world_to_object_position_4th_column},AmbientOcclusion2D:{type:"t",value:ay.AmbientOcclusion2D},Clarity2D:{type:"t",value:ay.Clarity2D},Diffuse2D:{type:"t",value:ay.Diffuse2D},Emissive2D:{type:"t",value:ay.Emissive2D},Height2D:{type:"t",value:ay.Height2D},Normal2D:{type:"t",value:ay.Normal2D},Specular2D:{type:"t",value:ay.Specular2D},SpecularAnisotropyDirection2D:{type:"t",value:ay.SpecularAnisotropyDirection2D},SpecularGlossiness2D:{type:"t",value:ay.SpecularGlossiness2D},Transparency2D:{type:"t",value:ay.Transparency2D},Opacity2D:{type:"t",value:ay.Opacity2D},IBLDiffuse:{type:"t",value:av},IBLSpecular:{type:"t",value:k}}]),vertexShaderPars:h.ShaderChunk.mpm_pars,vertexShaderBody:h.ShaderChunk.mpm_vertex,fragmentShaderPars:["uniform mat4 mapping_world_inverse;","uniform float mapping_ratio_u;","uniform float mapping_ratio_v;","uniform float mapping_scale_u;","uniform float mapping_scale_v;","uniform float mapping_flip_u;","uniform float mapping_flip_v;","uniform float mapping_offset_u;","uniform float mapping_offset_v;","uniform float mapping_repeat_u;","uniform float mapping_repeat_v;","uniform float mapping_rotation_z;","uniform int  mapping_type;","uniform vec4  mapping_world_to_object_position_1st_column;","uniform vec4  mapping_world_to_object_position_2nd_column;","uniform vec4  mapping_world_to_object_position_3rd_column;","uniform vec4  mapping_world_to_object_position_4th_column;","uniform float thin_walled;","uniform int default_slot_normal;","uniform int default_slot_height;","uniform int default_slot_opacity;","uniform int default_slot_ambient_occlusion;","uniform int default_slot_diffuse_color;","uniform int default_slot_specular_color;","uniform int default_slot_specular_glossiness;","uniform int default_slot_transparency;","uniform int default_slot_clarity;","uniform int default_slot_emissive_color;","uniform int default_slot_specular_anisotropy_direction;","uniform float default_sp_bump;","uniform vec4 default_sp_normal;","uniform float default_sp_displacement;","uniform float default_sp_height;","uniform float default_sp_opacity;","uniform float default_sp_ambient_occlusion;","uniform float default_generic_brdf_ior;","uniform float default_generic_brdf_diffuse_weight;","uniform vec4 default_generic_brdf_diffuse_color;","uniform float default_generic_brdf_diffuse_glossiness;","uniform float default_generic_brdf_specular_weight;","uniform vec4 default_generic_brdf_specular_color;","uniform float default_generic_brdf_specular_glossiness;","uniform float default_generic_brdf_specular_anisotropy;","uniform float default_generic_brdf_specular_anisotropy_rotation;","uniform float default_generic_btdf_transparency_weight;","uniform float default_generic_btdf_transparency_glossiness;","uniform float default_generic_edf_diffuse_weight;","uniform vec4 default_generic_edf_diffuse_color;","uniform vec4 default_vp_color;","uniform float default_vp_ior;","uniform float default_vp_absorption;","uniform float default_vp_abbe_number;","uniform sampler2D Normal2D;","uniform sampler2D Height2D;","uniform sampler2D Opacity2D;","uniform sampler2D AmbientOcclusion2D;","uniform sampler2D Diffuse2D;","uniform sampler2D Specular2D;","uniform sampler2D SpecularGlossiness2D;","uniform sampler2D SpecularAnisotropyDirection2D;","uniform sampler2D Transparency2D;","uniform sampler2D Clarity2D;","uniform sampler2D Emissive2D;","uniform samplerCube IBLDiffuse;","uniform samplerCube IBLSpecular;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.mpm_pars,h.ShaderChunk.struct_mpm,h.ShaderChunk.constants_mpm,h.ShaderChunk.functions_mpm,h.ShaderChunk.brdf_mpm,h.ShaderChunk.edf_mpm,h.ShaderChunk.opacity_mpm,h.ShaderChunk.blending_mpm,h.ShaderChunk.mapping_mpm,h.ShaderChunk.color_mpm,h.ShaderChunk.parallax_mpm,"contribution_t contribution_environment = contribution_t(vec4(1.0),vec4(1.0),vec4(1.0));"].join("\n"),fragmentShaderBody:[h.ShaderChunk.mpm_fragment,"gl_FragColor = result;"].join("\n")});aC.uniforms.Height2D.value=ay.Height2D;aC.uniforms.Normal2D.value=ay.Normal2D;aC.uniforms.Opacity2D.value=ay.Opacity2D;aC.uniforms.AmbientOcclusion2D.value=ay.AmbientOcclusion2D;aC.uniforms.Diffuse2D.value=ay.Diffuse2D;aC.uniforms.Specular2D.value=ay.Specular2D;aC.uniforms.SpecularGlossiness2D.value=ay.SpecularGlossiness2D;aC.uniforms.SpecularAnisotropyDirection2D.value=ay.SpecularAnisotropyDirection2D;aC.uniforms.Transparency2D.value=ay.Transparency2D;aC.uniforms.Clarity2D.value=ay.Clarity2D;aC.uniforms.Emissive2D.value=ay.Emissive2D;aC.uniforms.IBLSpecular.value=k;aC.uniforms.IBLDiffuse.value=av;aC.needTangentBinormal=true;break;case"mia_phen_polished_metal":aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(an.diffuse!=undefined)?an.diffuse:[1,1,1,1]},emissive_color:{type:"fv4",value:(an.emissive_color!=undefined)?an.emissive_color:[1,1,1,1]},diffuse_weight:{type:"f",value:(an.diffuse_weight!=undefined)?an.diffuse_weight:0},reflectivity:{type:"f",value:(an.reflectivity!=undefined)?an.reflectivity:1},transparency_multiply_blend:{type:"f",value:ax},refr_ior:{type:"f",value:(an.refr_ior!=undefined)?an.refr_ior:8},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(an.emissive_intensity!=undefined)?an.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float diffuse_weight;","uniform vec4  diffuse;","uniform vec4  refl_color;","uniform float reflectivity;","uniform float transparency_multiply_blend;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = 30.0;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_fragment,h.ShaderChunk.fresnel_fragment,"float reflectionDiffuseWeight   = mix( 1.0, 0.8, reflectivity );","const float roughnessWeight = 0.85;","float ambientStrength = diffuse_weight;","float diffuseStrength = roughnessWeight*diffuse_weight*reflectionDiffuseWeight;","float specularStrength = 0.05 + 0.45*reflectivity;","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*diffuse.xyz);","vec3 specularResult = dirSpecular*(specularStrength);","vec3 reflectionResult = reflectivity*diffuse.xyz*environment_lookup*clamp(1.0-getLuminosity(diffuseResult.xyz+specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});break;case"mia_phen_satinated_metal":var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(an.diffuse!=undefined)?an.diffuse:[1,1,1,1]},emissive_color:{type:"fv4",value:(an.emissive_color!=undefined)?an.emissive_color:[1,1,1,1]},diffuse_weight:{type:"f",value:(an.diffuse_weight!=undefined)?an.diffuse_weight:0},reflectivity:{type:"f",value:(an.reflectivity!=undefined)?an.reflectivity:1},refl_gloss:{type:"f",value:(an.refl_gloss!=undefined)?an.refl_gloss:0.25},transparency_multiply_blend:{type:"f",value:ax},refr_ior:{type:"f",value:(an.refr_ior!=undefined)?an.refr_ior:8},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(an.emissive_intensity!=undefined)?an.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float diffuse_weight;","uniform vec4  diffuse;","uniform float reflectivity;","uniform float transparency_multiply_blend;","uniform float refl_gloss;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = mix( 5., 30., pow( refl_gloss, 0.5 ) );","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_blur_fragment,h.ShaderChunk.fresnel_fragment,"float reflectionDiffuseWeight   = mix( 1.0, 0.8, reflectivity );","const float roughnessWeight = 0.85;","float ambientStrength = diffuse_weight;","float diffuseStrength = roughnessWeight*diffuse_weight*reflectionDiffuseWeight;","float specularStrength = 0.05 + 0.45*reflectivity;","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*diffuse.xyz);","vec3 specularResult = dirSpecular*(specularStrength*diffuse.xyz);","vec3 reflectionResult = reflectivity*diffuse.xyz*environment_lookup*clamp(1.0-getLuminosity(diffuseResult.xyz+specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aC.needTangentBinormal=true;break;case"mia_phen_anisotropic_metal":var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(an.diffuse!=undefined)?an.diffuse:[1,1,1,1]},emissive_color:{type:"fv4",value:(an.emissive_color!=undefined)?an.emissive_color:[1,1,1,1]},anisotropy:{type:"f",value:(an.anisotropy!=undefined)?an.anisotropy:0.1},anisotropy_rotation:{type:"f",value:(an.anisotropy_rotation!=undefined)?an.anisotropy_rotation:0},diffuse_weight:{type:"f",value:(an.diffuse_weight!=undefined)?an.diffuse_weight:0},reflectivity:{type:"f",value:(an.reflectivity!=undefined)?an.reflectivity:1},refl_gloss:{type:"f",value:(an.refl_gloss!=undefined)?an.refl_gloss:0.25},transparency_multiply_blend:{type:"f",value:ax},refr_ior:{type:"f",value:(an.refr_ior!=undefined)?an.refr_ior:8},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(an.emissive_intensity!=undefined)?an.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float diffuse_weight;","uniform vec4  diffuse;","uniform float anisotropy_rotation;","uniform float anisotropy;","uniform float reflectivity;","uniform float transparency_multiply_blend;","uniform float refl_gloss;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = mix( 5., 30., pow( refl_gloss, 0.5 ) );","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_anisotropic_fragment,"}","#endif",h.ShaderChunk.environment_blur_fragment,h.ShaderChunk.fresnel_fragment,"float reflectionDiffuseWeight   = mix( 1.0, 0.8, reflectivity );","const float roughnessWeight = 0.85;","float ambientStrength = diffuse_weight;","float diffuseStrength = roughnessWeight*diffuse_weight*reflectionDiffuseWeight;","float specularStrength = 0.05 + 0.45*reflectivity;","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*diffuse.xyz);","vec3 specularResult = dirSpecular*specularStrength;","vec3 reflectionResult = reflectivity*diffuse.xyz*environment_lookup*clamp(1.0-getLuminosity(diffuseResult.xyz+specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aC.needTangentBinormal=true;break;case"mia_phen_soft_plastic":var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(an.diffuse!=undefined)?an.diffuse:[1,1,1,1]},refl_gloss:{type:"f",value:(an.refl_gloss!=undefined)?an.refl_gloss:0.25},refl_color:{type:"fv4",value:(an.refl_color!=undefined)?an.refl_color:[1,1,1,1]},emissive_color:{type:"fv4",value:(an.emissive_color!=undefined)?an.emissive_color:[1,1,1,1]},diffuse_weight:{type:"f",value:(an.diffuse_weight!=undefined)?an.diffuse_weight:0.77},reflectivity:{type:"f",value:(an.reflectivity!=undefined)?an.reflectivity:0.7},transparency_multiply_blend:{type:"f",value:ax},refr_ior:{type:"f",value:(an.refr_ior!=undefined)?an.refr_ior:2},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(an.emissive_intensity!=undefined)?an.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float diffuse_weight;","uniform vec4  diffuse;","uniform vec4  refl_color;","uniform float reflectivity;","uniform float refl_gloss;","uniform float transparency_multiply_blend;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = mix(5.0, 30.0,pow(refl_gloss,0.5));","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_blur_fragment,h.ShaderChunk.fresnel_fragment,"float reflectionDiffuseWeight   = mix( 1.0, 0.8, reflectivity );","const float roughnessWeight = 0.85;","float ambientStrength = diffuse_weight;","float diffuseStrength = roughnessWeight*diffuse_weight*reflectionDiffuseWeight;","float specularStrength = 0.05 + 0.15*reflectivity;","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*diffuse.xyz);","vec3 specularResult = dirSpecular*(specularStrength*refl_color.xyz);","vec3 reflectionResult = reflectivity*refl_color.xyz*environment_lookup*clamp(1.0-getLuminosity(diffuseResult.xyz+specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aC.needTangentBinormal=true;break;case"mia_phen_polished_plastic":var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(an.diffuse!=undefined)?an.diffuse:[1,1,1,1]},refl_color:{type:"fv4",value:(an.refl_color!=undefined)?an.refl_color:[1,1,1,1]},emissive_color:{type:"fv4",value:(an.emissive_color!=undefined)?an.emissive_color:[1,1,1,1]},diffuse_weight:{type:"f",value:(an.diffuse_weight!=undefined)?an.diffuse_weight:0.77},reflectivity:{type:"f",value:(an.reflectivity!=undefined)?an.reflectivity:0.75},transparency_multiply_blend:{type:"f",value:ax},refr_ior:{type:"f",value:(an.refr_ior!=undefined)?an.refr_ior:2},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(an.emissive_intensity!=undefined)?an.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float diffuse_weight;","uniform vec4  diffuse;","uniform vec4  refl_color;","uniform float reflectivity;","uniform float transparency_multiply_blend;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = 30.0;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_fragment,h.ShaderChunk.fresnel_fragment,"float reflectionDiffuseWeight   = mix( 1.0, 0.8, reflectivity );","const float roughnessWeight = 0.85;","float ambientStrength = diffuse_weight;","float diffuseStrength = roughnessWeight*diffuse_weight*reflectionDiffuseWeight;","float specularStrength = 0.05 + 0.15*reflectivity;","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*diffuse.xyz);","vec3 specularResult = dirSpecular*(specularStrength*refl_color.xyz);","vec3 reflectionResult = reflectivity*refl_color.xyz*environment_lookup*clamp(1.0-getLuminosity(diffuseResult.xyz+specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});break;case"mia_phen_diffuse":var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(an.diffuse!=undefined)?an.diffuse:[1,1,1,1]},emissive_color:{type:"fv4",value:(an.emissive_color!=undefined)?an.emissive_color:[1,1,1,1]},diffuse_roughness:{type:"f",value:(an.diffuse_roughness!=undefined)?an.diffuse_roughness:1},transparency_multiply_blend:{type:"f",value:ax},emissive_intensity:{type:"f",value:(an.emissive_intensity!=undefined)?an.emissive_intensity:0}}]),vertexShaderPars:h.ShaderChunk.basic_pars,vertexShaderBody:h.ShaderChunk.basic_vertex,fragmentShaderPars:["uniform vec4  diffuse;","uniform float diffuse_roughness;","uniform float transparency_multiply_blend;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","float diffuse_power  = mix(0.5,3.0,diffuse_roughness);","const float specular_power = 5.0;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif","float roughnessWeight = mix(0.85,1.0,diffuse_roughness);","const float ambientStrength = 0.77;","float diffuseStrength = roughnessWeight*0.77;","const float specularStrength = 0.05;","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*diffuse.xyz);","vec3 specularResult = dirSpecular*(specularStrength);","vec3 result = emitResult.xyz + diffuseResult + specularResult;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});break;case"mia_phen_frosted_glass":var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{refr_falloff_color:{type:"fv4",value:(an.refr_falloff_color!=undefined)?an.refr_falloff_color:[1,1,1,1]},emissive_color:{type:"fv4",value:(an.emissive_color!=undefined)?an.emissive_color:[1,1,1,1]},transparency_multiply_blend:{type:"f",value:ax},refr_ior:{type:"f",value:(an.refr_ior!=undefined)?an.refr_ior:1.45},refr_gloss:{type:"f",value:(an.refr_gloss!=undefined)?an.refr_gloss:1},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(an.emissive_intensity!=undefined)?an.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float refr_gloss;","uniform vec4  refr_falloff_color;","uniform float transparency_multiply_blend;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","float refl_gloss  = refr_gloss;","const float diffuse_power  = 0.5;","float specular_power = mix(5.0, 30.0,pow(refl_gloss,0.5));","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_blur_fragment,h.ShaderChunk.fresnel_fragment,"const float reflectionDiffuseWeight   = 0.8;","const float roughnessWeight = 0.85;","const float ambientStrength = 0.77;","float diffuseStrength = roughnessWeight*0.77*reflectionDiffuseWeight;","float specularStrength = 0.5;","vec4 refl_color = vec4(1.0);","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*refl_color.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*refl_color.xyz);","diffuseResult *= 0.5 * refr_falloff_color.xyz;","vec3 specularResult = dirSpecular*(specularStrength*refl_color.xyz);","vec3 reflectionResult = refl_color.xyz*environment_lookup*clamp(1.0-getLuminosity(specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float opacity = 0.0;","opacity += fresnel*(1.0+length(specularResult.xyz));","opacity += clamp(1.0-length(refr_falloff_color.xyz),0.0,1.0);","opacity += (1.0-fresnel)*length(emitResult.xyz);","opacity = min(opacity,1.0);","float post_process_transparency_blend = mix( opacity, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aC.needTangentBinormal=true;break;case"mia_phen_clear_glass":var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{emissive_color:{type:"fv4",value:(an.emissive_color!=undefined)?an.emissive_color:[1,1,1,1]},transparency_multiply_blend:{type:"f",value:ax},refr_ior:{type:"f",value:(an.refr_ior!=undefined)?an.refr_ior:1.45},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(an.emissive_intensity!=undefined)?an.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float transparency_multiply_blend;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = 30.0;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_fragment,h.ShaderChunk.fresnel_fragment,"const float reflectionDiffuseWeight   = 0.8;","const float roughnessWeight = 0.85;","const float ambientStrength = 0.77;","float diffuseStrength = roughnessWeight*0.77*reflectionDiffuseWeight;","float specularStrength = 0.5;","vec4 refl_color = vec4(1.0);","vec4 refr_color = vec4(1.0);","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*refl_color.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*refl_color.xyz);","diffuseResult *= 0.5 * refr_color.xyz;","vec3 specularResult = dirSpecular*(specularStrength*refl_color.xyz);","vec3 reflectionResult = refl_color.xyz*environment_lookup*clamp(1.0-getLuminosity(specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float opacity = 0.0;","opacity += fresnel*(1.0+length(specularResult.xyz));","opacity += clamp(1.0-length(refr_color.xyz),0.0,1.0);","opacity += (1.0-fresnel)*length(emitResult.xyz);","opacity = min(opacity,1.0);","float post_process_transparency_blend = mix( opacity, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aC.needTangentBinormal=true;break;case"mia_phen_colored_glass":var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{refr_falloff_color:{type:"fv4",value:(an.refr_falloff_color!=undefined)?an.refr_falloff_color:[1,1,1,1]},emissive_color:{type:"fv4",value:(an.emissive_color!=undefined)?an.emissive_color:[1,1,1,1]},transparency_multiply_blend:{type:"f",value:ax},refr_ior:{type:"f",value:(an.refr_ior!=undefined)?an.refr_ior:1.45},reflectivity:{type:"f",value:(an.reflectivity!=undefined)?an.reflectivity:0.66},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(an.emissive_intensity!=undefined)?an.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform vec4  refr_falloff_color;","uniform float transparency_multiply_blend;","uniform float refr_ior;","uniform float reflectivity;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","const float specular_power = 30.0;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_fragment,h.ShaderChunk.fresnel_fragment,"float intensity_specular    = /* weight */ 0.50;","float intensity_environment = /* weight */ 1.00;","float intensity_emissive    = /* weight */ emissive_intensity * /* attenuation */ 0.75;","/* contributions */","vec4 emitResult = intensity_emissive*emissive_color;","vec3 specularResult = dirSpecular*intensity_specular;","vec3 reflectionResult = environment_lookup*intensity_environment;","vec3  reflective_specular   = /* specular reflection weight */ reflectivity * ( specularResult + reflectionResult );","vec3  refractive_specular   = refr_falloff_color.rgb;","float luminosity_reflective               = getLuminosity( reflective_specular );","float cursor_refraction_reflection        = clamp( fresnel + luminosity_reflective, 0.0, 1.0 );","vec3  perceived                           = mix( refractive_specular, reflective_specular, cursor_refraction_reflection ) + emitResult.xyz;","float opacity = fresnel;","const float interpolation_power           = 3.0;","float luminosity_reflective_interpolation = pow( luminosity_reflective, interpolation_power );","float post_process_transparency_blend = mix( mix( opacity, 1.0, luminosity_reflective_interpolation ), 0.0, transparency_multiply_blend );","gl_FragColor = vec4( perceived.rgb * perceived.rgb, post_process_transparency_blend );"].join("\n")});aC.needTangentBinormal=true;break;case"diamond":var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{refr_color:{type:"fv4",value:(an.refr_color!=undefined)?an.refr_color:[1,1,1,1]},refl_color:{type:"fv4",value:(an.refl_color!=undefined)?an.refl_color:[1,1,1,1]},transparency_multiply_blend:{type:"f",value:ax},abbe_number:{type:"f",value:(an.abbe_number!=undefined)?an.abbe_number:55},refr_ior:{type:"f",value:(an.refr_ior!=undefined)?an.refr_ior:2.4},ReflectionCUBEMap:{type:"t",value:k}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform vec4  refl_color;","uniform vec4  refr_color;","uniform float transparency_multiply_blend;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float abbe_number;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = 30.0;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_fragment,h.ShaderChunk.fresnel_fragment,"const float reflectionDiffuseWeight   = 0.8;","const float roughnessWeight = 0.85;","const float ambientStrength = 0.77;","float diffuseStrength = roughnessWeight*0.77*reflectionDiffuseWeight;","float specularStrength = 0.5;","float emissive_intensity = 0.0;","vec4 emissive_color = vec4(1.0);","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*refl_color.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*refl_color.xyz);","diffuseResult *= 0.5 * refr_color.xyz;","vec3 specularResult = dirSpecular*(specularStrength*refl_color.xyz);","vec3 reflectionResult = refl_color.xyz*environment_lookup*clamp(1.0-getLuminosity(specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float opacity = 0.0;","opacity += fresnel*(1.0+length(specularResult.xyz));","opacity += clamp(1.0-length(refr_color.xyz),0.0,1.0);","opacity += (1.0-fresnel)*length(emitResult.xyz);","opacity = min(opacity,1.0);","float post_process_transparency_blend = mix( opacity, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aC.needTangentBinormal=true;break;case"mia_phen_emissive":var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{color:{type:"f",value:(an.color!=undefined)?an.color:[1,1,1,1]},intensity:{type:"fv4",value:(an.intensity!=undefined)?an.intensity:1000}}]),vertexShaderPars:h.ShaderChunk.basic_pars,vertexShaderBody:h.ShaderChunk.basic_vertex,fragmentShaderPars:["uniform vec4  color;","uniform float intensity;","uniform float transparency_multiply_blend;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,"float diffuseLobeShape = 0.5*dot(viewPosition,normal)+0.5;","diffuseLobeShape = pow(diffuseLobeShape,0.1);","vec4 emitResult = color * diffuseLobeShape*clamp(intensity,0.0,1.0);","vec3 result = emitResult.xyz;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});break;case"CATIATemplateUseMapCubic":var aw;aw=aA.getTexture({type:"data",resources:aB[an.KdText.imgId],resourceId:an.KdText.imgId});var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{KaColor:{type:"fv4",value:(an.KaColor!=undefined)?an.KaColor:[1,1,1,1]},KdColor:{type:"fv4",value:(an.KdColor!=undefined)?an.KdColor:[1,1,1,1]},KsColor:{type:"fv4",value:(an.KsColor!=undefined)?an.KsColor:[1,1,1,1]},Kd:{type:"f",value:(an.Kd!=undefined)?an.Kd:1},Ka:{type:"f",value:(an.Ka!=undefined)?an.Ka:0},KbBump:{type:"f",value:(an.KbBump!=undefined)?an.KbBump:0},transparency_multiply_blend:{type:"f",value:ax},Kr:{type:"f",value:(an.Kr!=undefined)?an.Kr:1},KsShi:{type:"f",value:(an.KsShi!=undefined)?an.KsShi:0.75},Kt:{type:"f",value:(an.Kt!=undefined)?an.Kt:0},RepeatU:{type:"f",value:(an.RepeatU!=undefined)?an.RepeatU:1},RepeatV:{type:"f",value:(an.RepeatV!=undefined)?an.RepeatV:1},TextOperMapType:{type:"f",value:(an.TextOperMapType!=undefined)?an.TextOperMapType:0},ReflectionCUBEMap:{type:"t",value:k},KdText:{type:"t",value:aw},Ks:{type:"f",value:(an.Ks!=undefined)?an.Ks:1}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,"varying vec2 vUV;",h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,"vUV = uv;",h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform vec4  KaColor;","uniform vec4  KdColor;","uniform vec4  KsColor;","uniform float Kd;","uniform float Ka;","uniform float KbBump;","uniform float transparency_multiply_blend;","uniform float Kr;","uniform float KsShi;","uniform float Kt;","uniform float RepeatU;","uniform float RepeatV;","uniform float TextOperMapType;","uniform float Ks;","uniform samplerCube ReflectionCUBEMap;","uniform sampler2D KdText;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","varying vec2 vUV;",h.ShaderChunk.basic_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"float alpha = 1.0;","vec3 texture_diffuse_lookup;","vec3 normal_mix = normal;","vec3  Bumps = vec3( 0.0, 0.0, 0.0 );","//application input","if (TextOperMapType > 0.0) {","vec2 clamped_uv = clamp(vUV, vec2(0.0), vec2(1.0) );","vec2 repeat     = vec2( RepeatU, RepeatV );","vec2 texel      = mix( clamped_uv, vUV, repeat );","//baking","vec4  textMap = texture2D( KdText, texel );","texture_diffuse_lookup = textMap.xyz;","alpha = textMap.w;","}","else {","texture_diffuse_lookup = vec3(1.0);","alpha = 1.0;","}","float interpolator_texture   = TextOperMapType;","//normal","if (TextOperMapType > 0.0) {","float bump_intensity      = KbBump;","vec3  bump_loopkup        = vec3( ( texture_diffuse_lookup.r + texture_diffuse_lookup.g + texture_diffuse_lookup.b ) / 3.0 - 0.5);","#ifdef USE_TANGENT_BINORMAL","Bumps = bump_loopkup.x * tangent + bump_loopkup.y * binormal;","#endif","normal_mix          = normal + Bumps;","normal_mix          = normalize(normal_mix);","}","//vec3 normal = normalize( normal );","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 2.0;","float specular_power = 95. * KsShi + 5.;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_fragment,"vec4 result = vec4( 0.0, 0.0, 0.0, alpha *(1.0 - Kt) );","result.xyz += Ka/2.0 * KaColor.xyz;","result.xyz += Kd   * KdColor.xyz * dirDiffuse;","result.xyz *= texture_diffuse_lookup.xyz;","result.xyz += Ks * KsColor.xyz * dirSpecular;","result.xyz += Kr * environment_lookup *clamp(1.0-getLuminosity(result.xyz),0.0,1.0);","result.a = mix( result.a, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb*result.rgb, result.a );"].join("\n")});aC.uniforms.KdText.value=aw;aC.needTangentBinormal=false;break;case"CATIATemplateUseMapSpheric":var aw=aA.getTexture({type:"data",resources:aB[an.KdText.imgId],resourceId:an.KdText.imgId});var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{KaColor:{type:"fv4",value:(an.KaColor!=undefined)?an.KaColor:[1,1,1,1]},KdColor:{type:"fv4",value:(an.KdColor!=undefined)?an.KdColor:[1,1,1,1]},KsColor:{type:"fv4",value:(an.KsColor!=undefined)?an.KsColor:[1,1,1,1]},Kd:{type:"f",value:(an.Kd!=undefined)?an.Kd:1},Ka:{type:"f",value:(an.Ka!=undefined)?an.Ka:0},KbBump:{type:"f",value:(an.KbBump!=undefined)?an.KbBump:0},transparency_multiply_blend:{type:"f",value:ax},Kr:{type:"f",value:(an.Kr!=undefined)?an.Kr:1},KsShi:{type:"f",value:(an.KsShi!=undefined)?an.KsShi:0.75},Kt:{type:"f",value:(an.Kt!=undefined)?an.Kt:0},RepeatU:{type:"f",value:(an.RepeatU!=undefined)?an.RepeatU:1},RepeatV:{type:"f",value:(an.RepeatV!=undefined)?an.RepeatV:1},TextOperMapType:{type:"f",value:(an.TextOperMapType!=undefined)?an.TextOperMapType:0},ReflectionCUBEMap:{type:"t",value:k},KdText:{type:"t",value:aw},Ks:{type:"f",value:(an.Ks!=undefined)?an.Ks:1}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,"varying vec2 vUV;",h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,"vUV = uv;",h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform vec4  KaColor;","uniform vec4  KdColor;","uniform vec4  KsColor;","uniform float Kd;","uniform float Ka;","uniform float KbBump;","uniform float transparency_multiply_blend;","uniform float Kr;","uniform float KsShi;","uniform float Kt;","uniform float RepeatU;","uniform float RepeatV;","uniform float TextOperMapType;","uniform float Ks;","uniform samplerCube ReflectionCUBEMap;","uniform sampler2D KdText;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","varying vec2 vUV;",h.ShaderChunk.basic_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"float alpha = 1.0;","vec3 texture_diffuse_lookup;","vec3 normal_mix = normal;","vec3  Bumps = vec3( 0.0, 0.0, 0.0 );","//application input","if (TextOperMapType > 0.0) {","vec2 clamped_uv = clamp(vUV, vec2(0.0), vec2(1.0) );","vec2 repeat     = vec2( RepeatU, RepeatV );","vec2 texel      = mix( clamped_uv, vUV, repeat );","//baking","vec4  textMap = texture2D( KdText, texel );","texture_diffuse_lookup = textMap.xyz;","alpha = textMap.w;","}","else {","texture_diffuse_lookup = vec3(1.0);","alpha = 1.0;","}","float interpolator_texture   = TextOperMapType;","//normal","if (TextOperMapType > 0.0) {","float bump_intensity      = KbBump;","vec3  bump_loopkup        = vec3( ( texture_diffuse_lookup.r + texture_diffuse_lookup.g + texture_diffuse_lookup.b ) / 3.0 - 0.5);","#ifdef USE_TANGENT_BINORMAL","Bumps = bump_loopkup.x * tangent + bump_loopkup.y * binormal;","#endif","normal_mix          = normal + Bumps;","normal_mix          = normalize(normal_mix);","}","//vec3 normal = normalize( normal );","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 2.0;","float specular_power = 95. * KsShi + 5.;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_fragment,"vec4 result = vec4( 0.0, 0.0, 0.0, alpha *(1.0 - Kt) );","result.xyz += Ka/2.0 * KaColor.xyz;","result.xyz += Kd   * KdColor.xyz * dirDiffuse;","result.xyz *= texture_diffuse_lookup.xyz;","result.xyz += Ks * KsColor.xyz * dirSpecular;","result.xyz += Kr * environment_lookup *clamp(1.0-getLuminosity(result.xyz),0.0,1.0);","result.a = mix( result.a, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb*result.rgb, result.a );"].join("\n")});aC.uniforms.KdText.value=aw;aC.needTangentBinormal=true;break;case"mia_phen_material":var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(an.diffuse!=undefined)?an.diffuse:[1,1,1,1]},emissive_color:{type:"fv4",value:(an.emissive_color!=undefined)?an.emissive_color:[1,1,1,1]},refl_color:{type:"fv4",value:(an.refl_color!=undefined)?an.refl_color:[1,1,1,1]},refr_color:{type:"fv4",value:(an.refr_color!=undefined)?an.refr_color:[1,1,1,1]},anisotropy:{type:"f",value:(an.anisotropy!=undefined)?an.anisotropy:1},anisotropy_rotation:{type:"f",value:(an.anisotropy_rotation!=undefined)?an.anisotropy_rotation:0},cutout_opacity:{type:"f",value:(an.cutout_opacity!=undefined)?an.cutout_opacity:1},diffuse_roughness:{type:"f",value:(an.diffuse_roughness!=undefined)?an.diffuse_roughness:1},diffuse_weight:{type:"f",value:(an.diffuse_weight!=undefined)?an.diffuse_weight:0.77},reflectivity:{type:"f",value:(an.reflectivity!=undefined)?an.reflectivity:0},refl_gloss:{type:"f",value:(an.refl_gloss!=undefined)?an.refl_gloss:0},refr_gloss:{type:"f",value:(an.refr_gloss!=undefined)?an.refr_gloss:1},transparency:{type:"f",value:(an.transparency!=undefined)?an.transparency:0},transparency_multiply_blend:{type:"f",value:ax},refr_ior:{type:"f",value:(an.refr_ior!=undefined)?an.refr_ior:1.5},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(an.emissive_intensity!=undefined)?an.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float diffuse_weight;","uniform float diffuse_roughness;","uniform vec4  diffuse;","uniform vec4  refl_color;","uniform vec4  refr_color;","uniform float anisotropy_rotation;","uniform float anisotropy;","uniform float reflectivity;","uniform float transparency;","uniform float transparency_multiply_blend;","uniform float refl_gloss;","uniform float refr_gloss;","uniform float refr_ior;","uniform float cutout_opacity;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","float diffuse_power  = mix(0.5, 3.0, diffuse_roughness);","float specular_power = mix( 5., 30., pow( refl_gloss, 0.5 ) );","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_anisotropic_fragment,"}","#endif",h.ShaderChunk.environment_blur_fragment,h.ShaderChunk.fresnel_fragment,"float reflectionDiffuseWeight   = mix( 1.0, 0.8, reflectivity );","float roughnessWeight = mix( 0.8, 1.0, diffuse_roughness );","float ambientStrength = diffuse_weight;","float diffuseStrength = roughnessWeight*diffuse_weight*reflectionDiffuseWeight;","float specularStrength = 0.05 + 0.45*reflectivity;","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*diffuse.xyz*diffuseStrength;","diffuseResult *= mix(vec3(1.0),0.5*refr_color.xyz,transparency);","vec3 specularResult = dirSpecular*(specularStrength*refl_color.xyz);","vec3 reflectionResult = reflectivity*refl_color.xyz*environment_lookup*clamp(1.0-getLuminosity((1.0-transparency)*diffuseResult.xyz+specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float opacity = 0.0;","opacity += fresnel*(1.0+length(specularResult.xyz));","opacity += clamp(1.0-length(refr_color.xyz),0.0,1.0);","opacity += (1.0-fresnel)*length(emitResult.xyz);","opacity =mix(1.0,min(opacity,cutout_opacity),transparency);","float post_process_transparency_blend = mix( opacity, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aC.needTangentBinormal=true;break;case"mia_phen_reflective_translucent":var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(an.diffuse!=undefined)?an.diffuse:[1,1,1,1]},emissive_color:{type:"fv4",value:(an.emissive_color!=undefined)?an.emissive_color:[1,1,1,1]},refr_trans_color:{type:"fv4",value:(an.refr_trans_color!=undefined)?an.refr_trans_color:[1,1,1,1]},refr_trans_weight:{type:"f",value:(an.refr_trans_weight!=undefined)?an.refr_trans_weight:1},reflectivity:{type:"f",value:(an.reflectivity!=undefined)?an.reflectivity:0},refr_gloss:{type:"f",value:(an.refr_gloss!=undefined)?an.refr_gloss:1},transparency:{type:"f",value:(an.transparency!=undefined)?an.transparency:0.8},transparency_multiply_blend:{type:"f",value:ax},refr_ior:{type:"f",value:(an.refr_ior!=undefined)?an.refr_ior:1.3},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(an.emissive_intensity!=undefined)?an.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform vec4  diffuse;","uniform vec4  refr_trans_color;","uniform float refr_trans_weight;","uniform float reflectivity;","uniform float transparency;","uniform float transparency_multiply_blend;","uniform float refr_gloss;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = mix( 5., 30., pow( refr_gloss, 0.5 ) );","const float ambient_contribution  = 1.0;","float refl_gloss = refr_gloss;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_blur_fragment,h.ShaderChunk.fresnel_fragment,"float reflectionDiffuseWeight = mix(1.0,0.8,reflectivity);","const float roughnessWeight = 0.85;","const float ambientStrength = 0.77;","float diffuseStrength = roughnessWeight* 0.77*reflectionDiffuseWeight;","float specularStrength = 0.05 + 0.45*reflectivity;","vec3 refl_color = vec3(1.0);","vec3 refr_color = mix(vec3(1.0) ,refr_trans_color.xyz,refr_trans_weight);","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*diffuse.xyz*diffuseStrength;","diffuseResult *= mix(vec3(1.0),0.5*refr_color.xyz,transparency);","vec3 specularResult = dirSpecular*specularStrength;","vec3 reflectionResult = reflectivity*refl_color.xyz*environment_lookup*clamp(1.0-getLuminosity((1.0-transparency)*diffuseResult.xyz+specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float opacity = 0.0;","opacity += fresnel*(1.0+length(specularResult.xyz));","opacity += clamp(1.0-length(refr_color.xyz),0.0,1.0);","opacity += (1.0-fresnel)*length(emitResult.xyz);","opacity =mix(1.0,min(opacity,1.0),transparency);","float post_process_transparency_blend = mix( opacity, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aC.needTangentBinormal=true;break;case"mip_metallic_paint":var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{ambient:{type:"fv4",value:(an.ambient!=undefined)?an.ambient:[0,0,0,1]},base_color:{type:"fv4",value:(an.base_color!=undefined)?an.base_color:[0,1,0,1]},scene_ambient:{type:"fv4",value:(an.__scene_ambient!=undefined)?an.__scene_ambient:[0,0,0,0]},edge_color:{type:"fv4",value:(an.edge_color!=undefined)?an.edge_color:[0.6,0.07,0.07,1]},flake_color:{type:"fv4",value:(an.flake_color!=undefined)?an.flake_color:[1,1,1,1]},lit_color:{type:"fv4",value:(an.lit_color!=undefined)?an.lit_color:[0.6,0,0.2,1]},spec:{type:"fv4",value:(an.spec!=undefined)?an.spec:[1,1,1,1]},spec_sec:{type:"fv4",value:(an.spec_sec!=undefined)?an.spec_sec:[1,1,1,1]},diffuse_bias:{type:"f",value:(an.diffuse_bias!=undefined)?an.diffuse_bias:1.5},diffuse_weight:{type:"f",value:(an.diffuse_weight!=undefined)?an.diffuse_weight:1},edge_color_bias:{type:"f",value:(an.edge_color_bias!=undefined)?an.edge_color_bias:1},flake_bump:{type:"f",value:(an.flake_bump!=undefined)?an.flake_bump:0},flake_decay:{type:"f",value:(an.flake_decay!=undefined)?an.flake_decay:0.01},flake_exp:{type:"f",value:(an.flake_exp!=undefined)?an.flake_exp:45},flake_reflect:{type:"f",value:(an.flake_reflect!=undefined)?an.flake_reflect:0.01},flake_weight:{type:"f",value:(an.flake_weight!=undefined)?an.flake_weight:0.01},global_weight:{type:"f",value:(an.global_weight!=undefined)?an.global_weight:1},irradiance_weight:{type:"f",value:(an.irradiance_weight!=undefined)?an.irradiance_weight:1},lit_color_bias:{type:"f",value:(an.lit_color_bias!=undefined)?an.lit_color_bias:8},mode:{type:"f",value:(an.mode!=undefined)?an.mode:0},spec_exp:{type:"f",value:(an.spec_exp!=undefined)?an.spec_exp:60},spec_glazing:{type:"f",value:(an.spec_glazing!=undefined)?an.spec_glazing:1},spec_sec_exp:{type:"f",value:(an.spec_sec_exp!=undefined)?an.spec_sec_exp:25},spec_sec_weight:{type:"f",value:(an.spec_sec_weight!=undefined)?an.spec_sec_weight:0.5},spec_weight:{type:"f",value:(an.spec_weight!=undefined)?an.spec_weight:0.2},transparency_multiply_blend:{type:"f",value:ax}}]),vertexShaderPars:["varying vec3 mPosition;","varying vec3 mNormal;",h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:["mPosition = position;","mNormal = normal;",h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_paint_fct,"uniform vec4 ambient;","uniform vec4 scene_ambient;","uniform vec4 base_color;","uniform vec4 edge_color;","uniform float edge_color_bias;","uniform vec4 lit_color;","uniform float lit_color_bias;","uniform float diffuse_weight;","uniform float diffuse_bias;","uniform float irradiance_weight;","uniform vec4 spec;","uniform float spec_weight;","uniform float spec_exp;","uniform vec4 spec_sec;","uniform float spec_sec_weight;","uniform float spec_sec_exp;","uniform bool spec_glazing;","uniform vec4 flake_color;","uniform float flake_weight;","uniform float flake_reflect;","uniform float flake_exp;","uniform float flake_decay;","uniform float flake_bump;","uniform float global_weight;","uniform float transparency_multiply_blend;","uniform float mode;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","varying vec3 mPosition;","varying vec3 mNormal;",h.ShaderChunk.basic_pars,].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,h.ShaderChunk.paint_fragment,"vec4 X0000025 = vec4(0.0, 0.0, 0.0, 1.0);","vec3 X0000026;","float X0000027;","vec4 X0000028;","float X0000029;","#if MAX_DIR_LIGHTS > 0","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_paint_fragment,"}","#endif","/* contributions */","if (X0000015 > 0.0)","{","result += ((X0000015 * (scene_ambient)) * X0000017);","}","result *= global_weight_v;","result.a = 1.0;","result.a = mix( result.a, 0.0, transparency_multiply_blend );","gl_FragColor = vec4(result);"].join("\n")});aC.needTangentBinormal=true;break;case"mip_car_paint":var aF=f(au+"car_paint_flakes.jpg",h.ImageUtils.crossOriginPolicy);var aC=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{ambient:{type:"fv4",value:(an.ambient!=undefined)?an.ambient:[0,0,0,1]},base_color:{type:"fv4",value:(an.base_color!=undefined)?an.base_color:[0,1,0,1]},scene_ambient:{type:"fv4",value:(an.__scene_ambient!=undefined)?an.__scene_ambient:[0,0,0,0]},edge_color:{type:"fv4",value:(an.edge_color!=undefined)?an.edge_color:[0.6,0.07,0.07,1]},flake_color:{type:"fv4",value:(an.flake_color!=undefined)?an.flake_color:[1,1,1,1]},lit_color:{type:"fv4",value:(an.lit_color!=undefined)?an.lit_color:[0.6,0,0.2,1]},spec:{type:"fv4",value:(an.spec!=undefined)?an.spec:[1,1,1,1]},Environment_map_cubic_1_env_tex_props:{type:"fv4",value:(an.Environment_map_cubic_1_env_tex_props!=undefined)?an.Environment_map_cubic_1_env_tex_props:[0,0,0,0]},msl_Carpaint_spec_sec:{type:"fv4",value:(an.msl_Carpaint_spec_sec!=undefined)?an.msl_Carpaint_spec_sec:[1,1,1,1]},msl_mi_bump_flakes_1_noise_tex_props:{type:"fv4",value:(an.msl_mi_bump_flakes_1_noise_tex_props!=undefined)?an.msl_mi_bump_flakes_1_noise_tex_props:[0,0,0,0]},raster_offset:{type:"fv2",value:(an.__raster_offset!=undefined)?an.__raster_offset:[0,0]},differential_scale:{type:"f",value:(an.__differential_scale!=undefined)?an.__differential_scale:1},incident_ior:{type:"f",value:(an.__incident_ior!=undefined)?an.__incident_ior:1},light_normal_mode:{type:"f",value:(an.__light_normal_mode!=undefined)?an.__light_normal_mode:1},light_scaling_factor:{type:"f",value:(an.__light_scaling_factor!=undefined)?an.__light_scaling_factor:0},object_label:{type:"f",value:(an.__object_label!=undefined)?an.__object_label:0},orthographic:{type:"f",value:(an.__orthographic!=undefined)?an.__orthographic:0},refracted_ior:{type:"f",value:(an.__refracted_ior!=undefined)?an.__refracted_ior:1.01},diffuse_bias:{type:"f",value:(an.diffuse_bias!=undefined)?an.diffuse_bias:1.5},diffuse_weight:{type:"f",value:(an.diffuse_weight!=undefined)?an.diffuse_weight:1},edge_color_bias:{type:"f",value:(an.edge_color_bias!=undefined)?an.edge_color_bias:1},flake_decay:{type:"f",value:(an.flake_decay!=undefined)?an.flake_decay:0.01},flake_density:{type:"f",value:(an.flake_density!=undefined)?an.flake_density:0.5},flake_exp:{type:"f",value:(an.flake_exp!=undefined)?an.flake_exp:45},flake_reflect:{type:"f",value:(an.flake_reflect!=undefined)?an.flake_reflect:0.01},flake_scale:{type:"f",value:(an.flake_scale!=undefined)?an.flake_scale:5},flake_strength:{type:"f",value:(an.flake_strength!=undefined)?an.flake_strength:2},flake_weight:{type:"f",value:(an.flake_weight!=undefined)?an.flake_weight:0.01},global_weight:{type:"f",value:(an.global_weight!=undefined)?an.global_weight:1},irradiance_weight:{type:"f",value:(an.irradiance_weight!=undefined)?an.irradiance_weight:1},lit_color_bias:{type:"f",value:(an.lit_color_bias!=undefined)?an.lit_color_bias:8},msl_Carpaint_spec_sec_exp:{type:"f",value:(an.msl_Carpaint_spec_sec_exp!=undefined)?an.msl_Carpaint_spec_sec_exp:25},msl_Carpaint_spec_sec_weight:{type:"f",value:(an.msl_Carpaint_spec_sec_weight!=undefined)?an.msl_Carpaint_spec_sec_weight:0.3},msl_Environment_map_cubic_1_intensity:{type:"f",value:(an.msl_Environment_map_cubic_1_intensity!=undefined)?an.msl_Environment_map_cubic_1_intensity:1},msl_mi_bump_flakes_1_noise_tex:{type:"t",value:aF},ReflectionCUBEMap:{type:"t",value:k},spec_exp:{type:"f",value:(an.spec_exp!=undefined)?an.spec_exp:60},spec_glazing:{type:"f",value:(an.spec_glazing!=undefined)?an.spec_glazing:1},spec_weight:{type:"f",value:(an.spec_weight!=undefined)?an.spec_weight:0.2},transparency_multiply_blend:{type:"f",value:ax}}]),vertexShaderPars:["varying vec3 mPosition;","varying vec3 mNormal;","varying vec2 vUV;",h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:["mPosition = position;","mNormal = normal;","vUV = uv;",h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:["uniform vec4 ambient;","uniform vec4 base_color;","uniform vec4 scene_ambient;","uniform vec4 edge_color;","uniform vec4 flake_color;","uniform vec4 lit_color;","uniform vec4 spec;","uniform vec4 Environment_map_cubic_1_env_tex_props;","uniform vec4 msl_Carpaint_spec_sec;","uniform vec4 msl_mi_bump_flakes_1_noise_tex_props;","uniform vec4 raster_offset;","uniform float differential_scale;","uniform float incident_ior;","uniform float light_normal_mode;","uniform float light_scaling_factor;","uniform float object_label;","uniform float orthographic;","uniform float refracted_ior;","uniform float diffuse_bias;","uniform float diffuse_weight;","uniform float edge_color_bias;","uniform float flake_decay;","uniform float flake_density;","uniform float flake_exp;","uniform float flake_reflect;","uniform float flake_scale;","uniform float flake_strength;","uniform float flake_weight;","uniform float global_weight;","uniform float irradiance_weight;","uniform float lit_color_bias;","uniform float msl_Carpaint_spec_sec_exp;","uniform float msl_Carpaint_spec_sec_weight;","uniform float msl_Environment_map_cubic_1_intensity;","uniform float spec_exp;","uniform bool spec_glazing;","uniform float spec_weight;","uniform float transparency_multiply_blend;","uniform sampler2D msl_mi_bump_flakes_1_noise_tex;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","varying vec3 mPosition;","varying vec3 mNormal;","varying vec2 vUV;","uniform samplerCube ReflectionCUBEMap;",h.ShaderChunk.basic_pars,h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"vec2 texel      = mod( vUV, vec2(1.0) );","//baking","vec4  flake_lookup = texture2D( msl_mi_bump_flakes_1_noise_tex, texel );","vec3  flake_noise                  = flake_lookup.rgb;","float flake_intensity              = pow( flake_lookup.a, 1.0 / flake_density );","vec3  flake_normal_gradient_object = flake_noise.rgb - vec3(0.5);","vec3  flake_normal                 = normalize( normal + ( flake_normal_gradient_object * flake_strength ) );","vec3  flake_tint                   = flake_color.rgb * flake_intensity;","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular1 = vec3( 0.0 );","vec3 dirSpecular2 = vec3( 0.0 );","vec3 dirSpecular3 = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 direction_fragment_to_light = normalize(- lDirection.xyz );","vec3  direction_fragment_to_camera = -viewPosition;","vec3  reflected_light              = reflect( normalize(lDirection.xyz), normal );","vec3  half_light_eye                 = normalize( direction_fragment_to_light + direction_fragment_to_camera );","float angle_normal_light             = max( 0.0, dot(normal, direction_fragment_to_light) );","float angle_normal_camera            = max( 0.0, dot(normal, direction_fragment_to_camera ) );","float angle_normal_half_surface      = max( 0.0, dot(normal, half_light_eye) );","float angle_normal_half_flake        = max( 0.0, dot(flake_normal, half_light_eye) );","float  diffuse_bias_contribution     = pow( angle_normal_light, diffuse_bias );","float  color_variation_cursor        = pow( angle_normal_light, lit_color_bias ) * abs( angle_normal_camera );","vec3   diffuse_color_variation       = mix( vec3(1.0), lit_color.rgb, color_variation_cursor );","float  specular_intensifier          = pow( angle_normal_light, 0.5 );","float  specular_lobe_1               = step( 0.0, angle_normal_half_surface ) * exp( log( angle_normal_half_surface ) * 0.5 * spec_exp );","float  specular_lobe_2               = step( 0.0, angle_normal_half_surface ) * exp( log( angle_normal_half_surface ) * 0.5 * msl_Carpaint_spec_sec_exp );","float specular_lobe_flake         = step( 0.0, angle_normal_half_flake ) * exp( log( angle_normal_half_flake ) * 0.5 );","vec3  diffuse_contribution    = diffuse_color_variation * diffuse_bias_contribution;","float specular_1_contribution = specular_lobe_1         * specular_intensifier;","float specular_2_contribution = specular_lobe_2         * specular_intensifier;","float specular_3_contribution = specular_lobe_flake     * specular_intensifier;","dirDiffuse  +=  mix( vec3(0.0), directionalLightColor[i], diffuse_contribution );","dirSpecular1 +=  mix( vec3(0.0), vec3( 1.0 ), specular_1_contribution );","dirSpecular2 +=  mix( vec3(0.0), vec3( 1.0 ), specular_2_contribution );","dirSpecular3 +=  mix( vec3(0.0), vec3( 1.0 ), specular_3_contribution );","dirAmbient  +=  mix( vec3(0.0), vec3( 0.0 ), ambient_contribution );","}","#endif","float angle_normal_camera            = dot( normal, -viewPosition);",h.ShaderChunk.environment_fragment,"float cursor_edge_bias            = step( 0.0, edge_color_bias );","float color_variation_cursor_edge = pow( abs( angle_normal_camera ), edge_color_bias ); // Normal could lead to 0.0 > dot","vec3  diffuse_color_angular       = mix( base_color.rgb, mix( edge_color.rgb, base_color.rgb, color_variation_cursor_edge ), cursor_edge_bias );","float falloff                     = 1.0 - clamp( angle_normal_camera, 0.0, 1.0 );","vec3 mix_environment              = falloff * environment_lookup.rgb * msl_Environment_map_cubic_1_intensity;","vec3 mix_ambient                  = ambient.rgb * diffuse_color_angular;","vec3 mix_irradiance               = ( scene_ambient.rgb / Pi ) * diffuse_color_angular * irradiance_weight;","vec3 mix_diffuse                  = dirDiffuse.rgb * diffuse_color_angular * diffuse_weight;","vec3 mix_specular                 = dirSpecular1.rgb * spec.rgb                  * spec_weight"," + dirSpecular2.rgb * msl_Carpaint_spec_sec.rgb * msl_Carpaint_spec_sec_weight"," + dirSpecular3.rgb * flake_tint                * flake_weight;","vec3 mix_result = global_weight * ( mix_ambient + mix_irradiance + mix_diffuse + mix_specular ) + mix_environment;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( mix_result.rgb * mix_result.rgb, post_process_transparency_blend );"].join("\n")});aC.needTangentBinormal=true;aC.uniforms.msl_mi_bump_flakes_1_noise_tex.value=aF;break;default:return new h.MeshPhongMaterial();break}aC.force=true;aC.lights=true;if(aC.uniforms.ReflectionCUBEMap){aC.uniforms.ReflectionCUBEMap.value=k}if(aE!==undefined){if(aE!==0){aC.transparent=true}}return aC}return new h.MeshPhongMaterial()}var ah,A,ab,u="MeshPhongMaterial",F={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,blending:h.NormalBlending,side:h.DoubleSide};if(X.physicalMaterial){var z={};var Q=X.physicalMaterial.PhysicalMaterial;if(Q.isVisDescription){var s=this;var E=(X.mapping&&X.mapping.type)||Q.type==="Visu.EVisuPBR";var al=function(an,ao,at,m,aq){var ar=Q[ao];if(typeof ar!=="undefined"){if(ar.length){z[an]=new h.Color();z[an].setRGB(ar[0],ar[1],ar[2]);return}if(typeof ar.MADCoefficients!=="undefined"){var am=ar.MADCoefficients;z[an+"MulCoef"]=new h.Vector3(am[0],am[1],am[2]);z[an+"AddCoef"]=new h.Vector3(am[3],am[4],am[5])}if(typeof ar.value!=="undefined"){z[an]=new h.Color();z[an].setRGB(ar.value[0],ar.value[1],ar.value[2])}else{if(typeof ar.texture!=="undefined"&&m){z[an+"Map"]=s.getTexture({wrap:U,type:"data",resources:R[ar.texture]});z[an+"MapLinear"]=aq;var ap=Q[ao+"UvTransform"];if(ap&&E){var au=new h.Matrix3();au.set(ap[0],ap[2],ap[4],ap[1],ap[3],ap[5],0,0,1);z[an+"UvTransform"]=au}}else{if(at!==null){z[an]=new h.Color();z[an].setRGB(at.x,at.y,at.z)}}}}};var t=function(an,ao,at,m,aq){var ar=Q[ao];if(typeof ar!=="undefined"){if(typeof ar!=="object"){z[an]=ar;return}if(typeof ar.MADCoefficients!=="undefined"){var am=ar.MADCoefficients;z[an+"MulCoef"]=am[0];z[an+"AddCoef"]=am[1]}if(typeof ar.value!=="undefined"){z[an]=ar.value}else{if(typeof ar.texture!=="undefined"&&m){z[an+"Map"]=s.getTexture({wrap:U,type:"data",resources:R[ar.texture]});z[an+"MapLinear"]=aq;var ap=Q[ao+"UvTransform"];if(ap&&E){var au=new h.Matrix3();au.set(ap[0],ap[2],ap[4],ap[1],ap[3],ap[5],0,0,1);z[an+"UvTransform"]=au}}else{if(at!==null){z[an]=at}}}}};var U=[0,0];if(Q.RepeatU){U[0]=1}if(Q.RepeatV){U[1]=1}var x=Q.diffuse||Q.albedo;if(x){if(x.MADCoefficients){var Z=x.MADCoefficients;z.diffuseMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.diffuseAddCoef=new h.Vector3(Z[3],Z[4],Z[5])}if(x.value){z.color=new h.Color();z.color.setRGB(x.value[0],x.value[1],x.value[2])}else{if(x.texture!=undefined){z.map=this.getTexture({wrap:U,type:"data",resources:R[x.texture]});var ag=Q.diffuseUvTransform;if(ag&&E){var G=new h.Matrix3();G.set(ag[0],ag[2],ag[4],ag[1],ag[3],ag[5],0,0,1);z.diffuseUvTransform=G}}}}if(Q.type==="Visu.EVisuPBR"){var N=function(ap,am){var m=Q[am];if(typeof m!=="undefined"){if(typeof m.texture!=="undefined"){z[ap+"Map"]=s.getTexture({wrap:U,type:"data",resources:R[m.texture]});var ao=Q[ap+"MapUvTransform"];if(ao){var an=new h.Matrix3();an.set(ao[0],ao[2],ao[4],ao[1],ao[3],ao[5],0,0,1);z[ap+"UvTransform"]=an}}}};t("metalness","metallic",0,true,true);t("roughness","roughness",0,true,true);t("anisotropyAngle","anisotropyRotation",0,true,true);N("normal","normal");t("opacity","cutoutOpacity",1,true,true);t("sheen","sheen",0,true,true);t("specularContrib","specular",1,true,true);al("specular","specularTint",new h.Vector3(1,1,1),true,false);al("flakesColor","flakeColor",new h.Vector3(1,1,1),true,false);t("flakesCoverage","flakeCoverage",0,true,false);t("flakesSize","flakeSize",0.5,true,false);t("flakesRoughness","flakeRoughness",0,true,false);t("clearCoat","clearcoat",0,true,true);N("clearCoatNormal","clearcoatNormal");t("clearCoatRoughness","clearcoatRoughness",0,false,true);t("orangePeel","orangePeel",false,false,true);t("orangePeelScale","orangePeelScale",0,false,true);al("emissionColor","emissionColor",new h.Vector3(1,1,1),true,false);t("emissionValue","emissionValue",0,false,true);t("emissionNormalized","emissionEnergyNormalization",false,false,true);t("thinWalled","thinWalled",false,false,true);t("ior","ior",1.5,false,true);al("attenuationColor","attenuationColor",new h.Vector3(1,1,1),false,false);al("subsurfaceColor","subsurfaceColor",new h.Vector3(0,0,0),false,false);t("attenuationDistance","attenuationDistance",100000000,false,true)}else{al("specular","fresnelCoefficient",new h.Vector3(1,1,1),true,false);al("emissive","emissive",new h.Vector3(1,1,1),true,false);al("flakesColor","flakesColor",new h.Vector3(0,0,0),false,false);al("pearlFlakesColor","pearlFlakesColor",new h.Vector3(0,0,0),false,false);t("glossiness","glossiness",1,true,true);t("opacity","opacity",1,true,true);t("anisotropyAngle","anisotropyAngle",0,true,true);t("clearCoat","Coating",0,false,true);t("bumpScale","bumpScale",1,true,true);t("coatingGlossiness","coatingGlossiness",1,false,true);t("clearCoatNormalScale","coatingNormalBump",0,false,true);t("orangePeel","ProceduralCoating",false,false,true);t("orangePeelScale","coatingNormalScale",1,false,true);t("flakes","Flakes",false,false,true);t("flakesDensity","flakesDensity",0,true,false);t("flakesBump","flakesBump",1,false,true);t("flakesScale","flakesScale",0.5,false,true);t("flakesRoughness","flakesRoughness",0.25,false,true);t("pearlFlakesBump","pearlFlakesBump",1,false,true);t("pearlFlakesDensity","pearlFlakesDensity",1,false,true);if(Q.normalMap){z.normalMap=this.getTexture({type:"data",resources:R[Q.normalMap.texture],resourceId:Q.normalMap.texture});if(!Q.NormalMapConventionPositiveY){z.normalMapFlipY=false}else{z.normalMapFlipY=true}var ag=Q.normalMapUvTransform;if(ag&&E){var G=new h.Matrix3();G.set(ag[0],ag[2],ag[4],ag[1],ag[3],ag[5],0,0,1);z.normalUvTransform=G}}if(Q.coatingMap){z.clearCoatNormalMap=this.getTexture({type:"data",resources:R[Q.coatingMap.texture],resourceId:Q.coatingMap.texture})}}t("anisotropy","anisotropy",0,true,true);t("transparency","transparency",0,true,true);if(Q.UseAlphaDiffuseChannel){z.transparent=true}else{z.useAlphaFromDiffuseMap=false}if((z.opacity==1&&z.transparency>0)||z.opacityMap){z.transparent=true}if(Q.IsAlphaTestEnabled){z.transparent=false;z.alphaTest=0.5}}else{var n=Q.MappingOperator.Type;if(n!="None"){z.mappingUseFragment=true;z.mappingObjTransformation=new h.Matrix4();z.mappingObjTransformation.elements=Q.MappingOperator.ObjectTransformation;z.mappingNormTransformation=new h.Matrix3().getInverse(z.mappingObjTransformation).transpose();if(n=="Planar"){z.mappingType=1}else{if(n=="Spherical"){z.mappingType=2}else{if(n=="Spherical Normalized"){z.mappingType=3}else{if(n=="Cubic"){z.mappingType=4}else{if(n=="FiniteCylindrical"){z.mappingType=5}else{if(n=="InfiniteCylindrical"){z.mappingType=6}else{if(n=="InfiniteCylindrical Normalized"){z.mappingType=7}}}}}}}}z.mappingUVTransformation=new h.Matrix3();z.mappingUVTransformation.elements=Q.MappingOperator.UvTransformation;if(Q.Float3Parameter){var P=Q.Float3Parameter;if(P.diffuse){var Z=P.diffuse.MADCoefficients;if(P.diffuse.AsTexture==false){z.color=new h.Color();z.color.setRGB(P.diffuse.Value[0],P.diffuse.Value[1],P.diffuse.Value[2]);z.diffuseMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.diffuseAddCoef=new h.Vector3(Z[3],Z[4],Z[5])}else{var U=[0,0];if(P.diffuse.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(P.diffuse.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(P.diffuse.UvTransform&&n!="None"){var M=P.diffuse.UvTransform;z.diffuseUvTransform=new h.Matrix3(M[0],M[4],M[8],M[1],M[5],M[9],M[2],M[6],M[10])}z.diffuseMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.diffuseAddCoef=new h.Vector3(Z[3],Z[4],Z[5]);z.map=this.getTexture({wrap:U,type:"data",resources:R[P.diffuse.Texture],resourceId:P.diffuse.Texture})}}if(P.fresnelCoefficient){var Z=P.fresnelCoefficient.MADCoefficients;if(P.fresnelCoefficient.AsTexture==false){z.specular=new h.Color();z.specular.setRGB(P.fresnelCoefficient.Value[0],P.fresnelCoefficient.Value[1],P.fresnelCoefficient.Value[2]);z.specularMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.specularAddCoef=new h.Vector3(Z[3],Z[4],Z[5])}else{var U=[0,0];if(P.fresnelCoefficient.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(P.fresnelCoefficient.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(P.fresnelCoefficient.UvTransform&&n!="None"){var q=P.fresnelCoefficient.UvTransform;z.specularUvTransform=new h.Matrix3(q[0],q[4],q[8],q[1],q[5],q[9],q[2],q[6],q[10])}z.specularMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.specularAddCoef=new h.Vector3(Z[3],Z[4],Z[5]);z.specularMap=this.getTexture({wrap:U,type:"data",resources:R[P.fresnelCoefficient.Texture],resourceId:P.fresnelCoefficient.Texture});z.specularMapLinear=false}}if(P.emissive){var Z=P.emissive.MADCoefficients;if(P.emissive.AsTexture==false){z.emissive=new h.Color();z.emissive.setRGB(P.emissive.Value[0],P.emissive.Value[1],P.emissive.Value[2]);z.emissiveMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.emissiveAddCoef=new h.Vector3(Z[3],Z[4],Z[5])}else{z.emissive=new h.Color();z.emissive.setRGB(1,1,1);var U=[0,0];if(P.emissive.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(P.emissive.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(P.emissive.UvTransform&&n!="None"){var S=P.emissive.UvTransform;z.emissiveUvTransform=new h.Matrix3(S[0],S[4],S[8],S[1],S[5],S[9],S[2],S[6],S[10])}z.emissiveMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.emissiveAddCoef=new h.Vector3(Z[3],Z[4],Z[5]);z.emissiveMap=this.getTexture({wrap:U,type:"data",resources:R[P.emissive.Texture],resourceId:P.emissive.Texture});z.emissiveMapLinear=false}}if(P.coatingFresnelCoefficient){if(P.coatingFresnelCoefficient.AsTexture===false){z.coatingSpecularColor=new h.Color();z.coatingSpecularColor.setRGB(P.coatingFresnelCoefficient.Value[0],P.coatingFresnelCoefficient.Value[1],P.coatingFresnelCoefficient.Value[2])}}if(P.flakesColor){var Z=P.flakesColor.MADCoefficients;if(P.flakesColor.AsTexture===false){z.flakesColor=new h.Color();z.flakesColor.setRGB(P.flakesColor.Value[0],P.flakesColor.Value[1],P.flakesColor.Value[2]);z.flakesColorMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.flakesColorAddCoef=new h.Vector3(Z[3],Z[4],Z[5])}}if(P.pearlFlakesColor){var Z=P.pearlFlakesColor.MADCoefficients;if(P.pearlFlakesColor.AsTexture===false){z.pearlFlakesColor=new h.Color();z.pearlFlakesColor.setRGB(P.pearlFlakesColor.Value[0],P.pearlFlakesColor.Value[1],P.pearlFlakesColor.Value[2]);z.pearlFlakesColorMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.pearlFlakesColorAddCoef=new h.Vector3(Z[3],Z[4],Z[5])}}}if(Q.FloatParameter){var v=Q.FloatParameter;if(v.glossiness){var Z=v.glossiness.MADCoefficients;if(v.glossiness.AsTexture==false){z.glossiness=v.glossiness.Value;z.glossinessMulCoef=Z[0];z.glossinessAddCoef=Z[1]}else{var U=[0,0];if(v.glossiness.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(v.glossiness.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(v.glossiness.UvTransform&&n!="None"){var L=v.glossiness.UvTransform;z.glossinessUvTransform=new h.Matrix3(L[0],L[4],L[8],L[1],L[5],L[9],L[2],L[6],L[10])}z.glossinessMulCoef=Z[0];z.glossinessAddCoef=Z[1];z.glossinessMap=this.getTexture({wrap:U,type:"data",resources:R[v.glossiness.Texture],resourceId:v.glossiness.Texture})}}if(v.bumpScale){var Z=v.bumpScale.MADCoefficients;if(v.bumpScale.AsTexture==false){var I=v.bumpScale.Value;z.normalScale=new h.Vector2(I,I);z.normalScaleMulCoef=Z[0];z.normalScaleAddCoef=Z[1]}}if(v.opacity){var Z=v.opacity.MADCoefficients;if(v.opacity.AsTexture==false){z.opacity=v.opacity.Value;z.opacityMulCoef=Z[0];z.opacityAddCoef=Z[1]}else{var U=[0,0];if(v.opacity.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(v.opacity.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(v.opacity.UvTransform&&n!="None"){var af=v.opacity.UvTransform;z.opacityUvTransform=new h.Matrix3(af[0],af[4],af[8],af[1],af[5],af[9],af[2],af[6],af[10])}z.opacityMulCoef=Z[0];z.opacityAddCoef=Z[1];z.opacityMap=this.getTexture({wrap:U,type:"data",resources:R[v.opacity.Texture],resourceId:Q.MapParameter.normalMap.Texture})}}if(v.transparency){var Z=v.transparency.MADCoefficients;if(v.transparency.AsTexture==false){z.transparency=v.transparency.Value;z.transparencyMulCoef=Z[0];z.transparencyAddCoef=Z[1]}}if(v.anisotropy){var Z=v.anisotropy.MADCoefficients;if(v.anisotropy.AsTexture==false){z.anisotropy=v.anisotropy.Value;z.anisotropyMulCoef=Z[0];z.anisotropyAddCoef=Z[1]}else{var U=[0,0];if(v.anisotropy.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(v.anisotropy.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(v.anisotropy.UvTransform&&n!="None"){var aj=v.anisotropy.UvTransform;z.anisotropyUvTransform=new h.Matrix3(aj[0],aj[4],aj[8],aj[1],aj[5],aj[9],aj[2],aj[6],aj[10])}z.anisotropyMulCoef=Z[0];z.anisotropyAddCoef=Z[1];z.anisotropyMap=this.getTexture({wrap:U,type:"data",resources:R[v.anisotropy.Texture],resourceId:v.anisotropy.Texture})}}if(v.anisotropyAngle){if(v.anisotropyAngle.AsTexture==false){var Z=v.anisotropyAngle.MADCoefficients;z.anisotropyAngle=v.anisotropyAngle.Value;z.anisotropyAngleMulCoef=Z[0];z.anisotropyAngleAddCoef=Z[1]}else{var U=[0,0];if(v.anisotropyAngle.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(v.anisotropyAngle.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(v.anisotropyAngle.UvTransform&&n!="None"){var W=v.anisotropyAngle.UvTransform;z.anisotropyAngleUvTransform=new h.Matrix3(W[0],W[4],W[8],W[1],W[5],W[9],W[2],W[6],W[10])}z.anisotropyAngleMulCoef=Z[0];z.anisotropyAngleAddCoef=Z[1];z.anisotropyAngleMap=this.getTexture({wrap:U,type:"data",resources:R[v.anisotropyAngle.Texture],resourceId:v.anisotropyAngle.Texture})}}if(v.coatingGlossiness){var Z=v.coatingGlossiness.MADCoefficients;if(v.coatingGlossiness.AsTexture===false){var I=Z[1]+v.coatingGlossiness.Value*Z[0];z.coatingGlossiness=I}else{var U=[0,0];if(v.coatingGlossiness.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(v.coatingGlossiness.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(v.coatingGlossiness.UvTransform&&n!="None"){var ae=v.coatingGlossiness.UvTransform;z.coatingGlossinessUvTransform=new h.Matrix3(ae[0],ae[4],ae[8],ae[1],ae[5],ae[9],ae[2],ae[6],ae[10])}z.coatingGlossinessMulCoef=Z[0];z.coatingGlossinessAddCoef=Z[1];z.coatingGlossinessMap=this.getTexture({wrap:U,type:"data",resources:R[v.coatingGlossiness.Texture],resourceId:v.coatingGlossiness.Texture})}}if(v.coatingBump){var Z=v.coatingBump.MADCoefficients;if(v.coatingBump.AsTexture===false){var I=Z[1]+v.coatingBump.Value*Z[0];z.clearCoatNormalScale=I}}if(v.coatingScale){var Z=v.coatingScale.MADCoefficients;if(v.coatingScale.AsTexture===false){var I=Z[1]+v.coatingScale.Value*Z[0];z.orangePeelScale=I}}if(v.flakesBump){var Z=v.flakesBump.MADCoefficients;if(v.flakesBump.AsTexture===false){var I=Z[1]+v.flakesBump.Value*Z[0];z.flakesBump=I}}if(v.flakesDensity){var Z=v.flakesDensity.MADCoefficients;if(v.flakesDensity.AsTexture===false){var I=Z[1]+v.flakesDensity.Value*Z[0];z.flakesDensity=I}}if(v.flakesScale){var Z=v.flakesScale.MADCoefficients;if(v.flakesScale.AsTexture===false){var I=Z[1]+v.flakesScale.Value*Z[0];z.flakesScale=I}}if(v.flakesRoughness){var Z=v.flakesRoughness.MADCoefficients;if(v.flakesRoughness.AsTexture===false){var I=Z[1]+v.flakesRoughness.Value*Z[0];z.flakesRoughness=I}}if(v.pearlFlakesBump){var Z=v.pearlFlakesBump.MADCoefficients;if(v.pearlFlakesBump.AsTexture===false){var I=Z[1]+v.pearlFlakesBump.Value*Z[0];z.pearlFlakesBump=I}}if(v.pearlFlakesDensity){var Z=v.pearlFlakesDensity.MADCoefficients;if(v.pearlFlakesDensity.AsTexture===false){var I=Z[1]+v.pearlFlakesDensity.Value*Z[0];z.pearlFlakesDensity=I}}}if(Q.AlphaMode=="eDiffuseChannel"){z.transparent=true}else{if((z.opacity==1&&z.transparency>0)||z.opacityMap){z.transparent=true}}if(Q.AlphaTest==true){z.transparent=false;z.alphaTest=0.5}if(Q.Coating===true){z.coating=1}if(Q.ProceduralCoating===true){z.orangePeel=true}if(Q.Flakes===true){z.flakes=true}if(Q.NormalMap&&Q.NormalMap.UseNormalMap==true){z.normalMap=this.getTexture({type:"data",resources:R[Q.NormalMap.Texture],resourceId:Q.NormalMap.Texture})}if(Q.MapParameter&&Q.MapParameter.normalMap&&Q.MapParameter.normalMap.Enabled==true){z.normalMap=this.getTexture({type:"data",resources:R[Q.MapParameter.normalMap.Texture],resourceId:Q.MapParameter.normalMap.Texture});if(Q.MapParameter.normalMap.UvTransform&&n!="None"){var o=Q.MapParameter.normalMap.UvTransform;z.normalUvTransform=new h.Matrix3(o[0],o[4],o[8],o[1],o[5],o[9],o[2],o[6],o[10])}if(Q.NormalMapConvention!="PositiveY"){z.normalMapFlipY=false}else{z.normalMapFlipY=true}}if(Q.MapParameter&&Q.MapParameter.coatingBumpMap&&Q.MapParameter.coatingBumpMap.Enabled==true){z.clearCoatNormalMap=this.getTexture({type:"data",resources:R[Q.MapParameter.coatingBumpMap.Texture],resourceId:Q.MapParameter.coatingBumpMap.Texture});if(Q.MapParameter.coatingBumpMap.UvTransform&&n!="None"){var o=Q.MapParameter.coatingBumpMap.UvTransform;z.clearCoatNormalUvTransform=new h.Matrix3(o[0],o[4],o[8],o[1],o[5],o[9],o[2],o[6],o[10])}if(Q.CoatingBumpMapConvention!="PositiveY"){z.clearCoatNormalMapFlipY=false}else{z.clearCoatNormalMapFlipY=true}}}z.NRECompatibility=true;var Y=new h.PhysicalMaterial(z);if(X.mapping){var r=null;if(X.mapping.ObjectTransformation){r=new h.Matrix4();r.elements=X.mapping.ObjectTransformation}var p=null;if(X.mapping.UvTransformation&&(Q.type==="Visu.EVisuPBR"||X.mapping.type)){p=new h.Matrix3();p.elements=X.mapping.UvTransformation}var H=X.mapping.type;if(Q.type!="Visu.EVisuPBR"){if(H==7){H--}if(H>=3){H--}}Y.setMappingOperator(H,r,p,true)}return Y}if(X.shaderMaterial){if(X.shaderMaterial.PDSFX){Y=V(X.shaderMaterial,R,this,X.transparent);if(Y){return Y}}else{return Y=y(X.shaderMaterial,R,this,X.transparent)}}if(X===null){return new h.MeshPhongMaterial()}if(X.wireframe!==undefined){F.wireframe=X.wireframe}if(X.transparent!==undefined){F.opacity=1-X.transparent;if(F.opacity!==1){F.transparent=true}}if(X.shading){if(X.shading==="Phong"){u="MeshPhongMaterial"}else{if(X.shading==="Basic"){u="MeshBasicMaterial"}}}if(X.blending){if(X.blending==="Additive"){F.blending=h.AdditiveBlending}else{if(X.blending==="Subtractive"){F.blending=h.SubtractiveBlending}else{if(X.blending==="Multiply"){F.blending=h.MultiplyBlending}}}}if(X.depthTest!==undefined){F.depthTest=X.depthTest}if(X.vertexColors!==undefined){if(X.vertexColors==="face"){F.vertexColors=h.FaceColors}else{if(X.vertexColors){F.vertexColors=h.VertexColors}}}var C;if(X.colorDiffuse){if(typeof(X.diffuseCoef)!="undefined"){C=[X.colorDiffuse[0]*X.diffuseCoef,X.colorDiffuse[1]*X.diffuseCoef,X.colorDiffuse[2]*X.diffuseCoef];F.color=ac(C)}else{F.color=ac(X.colorDiffuse)}}else{if(X.DbgColor){F.color=X.DbgColor}}if(X.colorSpecular){if(typeof(X.specularCoef)!="undefined"){C=[X.colorSpecular[0]*X.specularCoef,X.colorSpecular[1]*X.specularCoef,X.colorSpecular[2]*X.specularCoef];F.specular=ac(C)}else{F.specular=ac(X.colorSpecular)}}if(X.colorAmbient){if(typeof(X.ambientCoef)!="undefined"){C=[X.colorAmbient[0]*X.ambientCoef,X.colorAmbient[1]*X.ambientCoef,X.colorAmbient[2]*X.ambientCoef];F.ambient=ac(C)}else{F.ambient=ac(X.colorAmbient)}}if(X.transparency){F.opacity=X.transparency;if(F.opacity!==1){F.transparent=true}}if(X.shininess){F.shininess=X.shininess}if(X.reflectivityCoef){F.reflectivity=X.reflectivityCoef}if(X.alphaTest){F.alphaTest=X.alphaTest}if((X.reflectivityCoef>0.1)&&(X.ReflectionMap===undefined)){var ai=c.getWebappsAssetUrl("Visualization","");var B=f(ai+"defaultEnvMap.png",h.ImageUtils.crossOriginPolicy);B.flipY=true;F.envMap=B;F.combine=h.MixOperation;F.envMap.mapping=new h.SphericalReflectionMapping();F.perPixel=true}if(X.textureId!==undefined&&X.textureId!==-1){if(X.textureBlending!==undefined){F.textureBlending=X.textureBlending}if(X.mappingFunction==="SPHERICAL_ENV_MAP"){F.sphereMap=true}else{F.map=this.getTexture({type:"data",resources:R[X.textureId],filter:[X.minFilter,X.magFilter],wrap:[X.textureWrapS,X.textureWrapT],resourceId:X.textureId});if(F.map.transparent){F.transparent=true;F.alphaTest=0.0001}}}if(X.DiffuseMap&&ak){F.map=this.getTexture({type:"url",sourceFile:X.DiffuseMap,texturePath:ak,material:X,cb:O,repeat:X.DiffuseMapRepeat,offset:X.DiffuseMapOffset,wrap:X.DiffuseMapWrap,format:K})}if(X.mapLight&&ak){F.lightMap=this.getTexture({type:"url",sourceFile:X.mapLight,material:X,cb:O,texturePath:ak,repeat:X.mapLightRepeat,offset:X.mapLightOffset,wrap:X.mapLightWrap})}if(X.mapNormal&&ak){F.normalMap=this.getTexture({type:"url",sourceFile:X.mapNormal,material:X,cb:O,texturePath:ak,repeat:X.mapNormalRepeat,offset:X.mapNormalOffset,wrap:X.mapNormalWrap})}if(X.mapSpecular&&ak){F.specularMap=this.getTexture({type:"url",sourceFile:X.mapSpecular,material:X,cb:O,texturePath:ak,repeat:X.mapSpecularRepeat,offset:X.mapSpecularOffset,wrap:X.mapSpecularWrap})}if(X.ReflectionMap&&ak){F.envMap=this.getTexture({type:"url_envMap",sourceFile:X.mapSpecular,material:X,cb:O,texturePath:ak,repeat:X.mapSpecularRepeat,offset:X.mapSpecularOffset,wrap:X.mapSpecularWrap})}if(X.mapNormal){ah=h.ShaderUtils.lib.normal;A=h.UniformsUtils.clone(ah.uniforms);A.tNormal.texture=F.normalMap;if(X.mapNormalFactor){A.uNormalScale.value=X.mapNormalFactor}if(F.map){A.tDiffuse.texture=F.map;A.enableDiffuse.value=true}if(F.specularMap){A.tSpecular.texture=F.specularMap;A.enableSpecular.value=true}if(F.lightMap){A.tAO.texture=F.lightMap;A.enableAO.value=true}A.uDiffuseColor.value.setHex(F.color);A.uSpecularColor.value.setHex(F.specular);A.uAmbientColor.value.setHex(F.ambient);A.uShininess.value=F.shininess;if(F.opacity!==undefined){A.uOpacity.value=F.opacity}ab={fragmentShader:ah.fragmentShader,vertexShader:ah.vertexShader,uniforms:A,lights:true,fog:true};Y=new h.ShaderMaterial(ab)}else{Y=new h[u](F);if(X.mapping){var r=null;if(X.mapping.ObjectTransformation){r=new h.Matrix4();r.elements=X.mapping.ObjectTransformation}var p=null;if(X.mapping.UvTransformation){p=new h.Matrix3();p.elements=X.mapping.UvTransformation}Y.setMappingOperator(X.mapping.type,r,p,true)}}if(X.DbgName!==undefined){Y.name=X.DbgName}if(X.textureId!==undefined&&X.textureId!==-1){X.url=R[X.textureId].url}var w=false;for(var T in Y){if(Y.hasOwnProperty(T)&&Y[T] instanceof h.Texture){w=true;break}}this.materials.push({params:X,threejs_mat:Y,hasTexture:w,});Y._source=h.AssetSource.MATERIAL_MANAGER;if(X.__nbTexturesToLoad===0){for(var ad=0;ad<X.__cbLoadedImages.length;ad++){X.__cbLoadedImages[ad](Y)}}if(Y.map&&Y.map.needToCheckTransparency){Y.map.transparentCb=function(m){Y.transparent=m}}return Y},createPointMaterial:function(s){var p=null;var u=9;var m=false;var n=s.color;var r;var o=s.opacity;var t=false;if(s.symbol){o=undefined;if(typeof s.symbol==="object"){n=new h.Color(16777215);r=this.getTexture({type:"data",resources:s.resource[s.symbol.id],texturePoint:true,resourceId:s.symbol.id});if(r.zoom){u=9;m=false}else{u=r.size;t=true}}else{var q=c.getWebappsAssetUrl("Visualization","");switch(s.symbol){case 0:r=null;u=1;break;case 1:r=f(q+"textures/point/cross.png",h.ImageUtils.crossOriginPolicy);break;case 2:r=f(q+"textures/point/plus.png",h.ImageUtils.crossOriginPolicy);break;case 3:r=f(q+"textures/point/concentric.png",h.ImageUtils.crossOriginPolicy);break;case 4:r=f(q+"textures/point/coincident.png",h.ImageUtils.crossOriginPolicy);break;case 5:r=f(q+"textures/point/fullCircle.png",h.ImageUtils.crossOriginPolicy);u=5;break;case 6:r=f(q+"textures/point/fullSquare.png",h.ImageUtils.crossOriginPolicy);u=7;break;case 7:r=f(q+"textures/point/star.png",h.ImageUtils.crossOriginPolicy);break;case 8:r=f(q+"textures/point/dot.png",h.ImageUtils.crossOriginPolicy);u=3;break;case 9:r=f(q+"textures/point/smallDot.png",h.ImageUtils.crossOriginPolicy);u=2;break;default:r=f(q+"textures/point/cross.png",h.ImageUtils.crossOriginPolicy);break}t=true;u=Math.round(u*(window.devicePixelRatio||1))}}else{u=s.size}p=new h.ParticleBasicMaterial({size:u,color:n,map:r,blending:h.NormalBlending,depthTest:false,sizeAttenuation:m,transparent:t,alphatest:0.001});if(o){p.opacity=o}return p},createTexture:function(D){function v(Y){var X=Math.log(Y)/Math.LN2;return Math.floor(X)===X}function R(Y){var X=Math.log(Y)/Math.LN2;return Math.pow(2,Math.round(X))}function J(Z,Y){var ac=new Image(),ab,X;h.ImageUtils.nbTexturesBeingLoaded++;D.material.__nbTexturesToLoad++;Z.loadEndStatus="loading";ac.onload=function(){Z.loadEndStatus="complete";if(!v(ac.width)||!v(ac.height)){ab=R(ac.width);X=R(ac.height);Z.image.width=ab;Z.image.height=X;Z.image.getContext("2d").drawImage(ac,0,0,ab,X)}else{Z.image=ac}Z.needsUpdate=true;h.ImageUtils.nbTexturesBeingLoaded--;D.material.__nbTexturesToLoad--;for(var ad=0;ad<Z.onLoadCallbacks.length;ad++){Z.onLoadCallbacks[ad](Z)}if(D.material.__nbTexturesToLoad===0){for(var ad=0;ad<D.material.__cbLoadedImages.length;ad++){D.material.__cbLoadedImages[ad](D.cb())}}};ac.onerror=function(){h.ImageUtils.nbTexturesBeingLoaded--;D.material.__nbTexturesToLoad--;Z.loadEndStatus="error";if(D.material.__nbTexturesToLoad===0){for(var ad=0;ad<D.material.__cbLoadedImages.length;ad++){D.material.__cbLoadedImages[ad](D.cb())}}};ac.crossOrigin="anonymous";ac.src=Y}function N(Z,Y){var ab,X;Z.image=[];h.ImageUtils.nbTexturesBeingLoaded++;Z.image.loadCount=0;for(ab=0,X=6;ab<X;++ab){Z.image[ab]=new Image();Z.image[ab].onload=function(){Z.image.loadCount+=1;if(Z.image.loadCount===6){Z.needsUpdate=true;h.ImageUtils.nbTexturesBeingLoaded--;for(var ac=0;ac<Z.onLoadCallbacks.length;ac++){Z.onLoadCallbacks[ac](Z)}}};Z.image[ab].onerror=function(){Z.image.loadCount+=1;if(Z.image.loadCount===6){h.ImageUtils.nbTexturesBeingLoaded--}};Z.image[ab].crossOrigin="anonymous";Z.image[ab].src=Y}}function u(ao,al,ar,ai,ad,aq){var ap=al/ai,Y=new Float32Array(ar*ai*aq),ae,Z,ab,ak,X,aj,ag,af,an,am,ac,ah;if(ap!==1){aj=ap/2;for(ag=0;ag<ai;ag++,aj+=ap){ae=Math.floor(aj);if(ae>=(ar-1)){Z=0}else{Z=aq}ab=aj-ae;ak=ag*aq;X=ae*aq;for(af=0;af<ar;af++,ak+=ai*aq,X+=al*aq){for(an=0;an<aq;an++){Y[ak+an]=ao[X+an]*(1-ab)+ao[X+Z+an]*ab}}}}else{for(am=0;am<ar*ai*aq;am++){Y[am]=ao[am]}}ac=ar/ad;ah=new Uint8Array(ad*ai*aq);if(ac!==1){aj=ac/2;for(af=0;af<ad;af++,aj+=ac){ae=Math.floor(aj);if(ae>=(ar-1)){Z=0}else{Z=aq*ai}ab=aj-ae;ak=af*ai*aq;X=ae*ai*aq;for(ag=0;ag<ai;ag++,ak+=aq,X+=aq){for(an=0;an<aq;an++){ah[ak+an]=Y[X+an]*(1-ab)+Y[X+Z+an]*ab}}}}else{for(am=0;am<ad*ai*aq;am++){ah[am]=Y[am]}}return ah}function t(Y){var X;for(X=3;X<Y.length;X+=4){if(Y[X]!=255){return true}}return false}function O(at,aq,af,aA,aF){var ab,ak,av,aB,aG,ai,ag,aC,az,aw,ae,aH,an,aj,ap,aD,ay,am,X,ao,Z;function Y(aI){aD=aI[4];aI[4]=aI[7];aI[7]=aD;aD=aI[5];aI[5]=aI[6];aI[6]=aD}function al(aI){aD=aI[4];aI[4]=aI[5];aI[5]=aD}function aE(aI){aD=aI[0];aI[0]=aI[6];aI[6]=aD;aD=aI[1];aI[1]=aI[7];aI[7]=aD;aD=aI[2];aI[2]=aI[4];aI[4]=aD;aD=aI[3];aI[3]=aI[5];aI[5]=aD;Y(aI.subarray(8,16))}function ad(aI){aD=aI[0];aI[0]=aI[2];aI[2]=aD;aD=aI[1];aI[1]=aI[3];aI[3]=aD;Y(aI.subarray(8,16))}function ac(aI){am=aI[2]+256*(aI[3]+256*aI[4]);ao=aI[5]+256*(aI[6]+256*aI[7]);X=((am&4095)<<12)|((am&16773120)>>12);Z=((ao&4095)<<12)|((ao&16773120)>>12);aI[2]=Z&255;aI[3]=(Z&65280)>>8;aI[4]=(Z&16711680)>>8;aI[5]=X&255;aI[6]=(X&65280)>>8;aI[7]=(X&16711680)>>8;Y(aI.subarray(8,16))}function ac(aI){am=aI[2]+256*(aI[3]+256*aI[4]);ao=aI[5]+256*(aI[6]+256*aI[7]);X=((am&4095)<<12)|((am&16773120)>>12);Z=((ao&4095)<<12)|((ao&16773120)>>12);aI[2]=Z&255;aI[3]=(Z&65280)>>8;aI[4]=(Z&16711680)>>8;aI[5]=X&255;aI[6]=(X&65280)>>8;aI[7]=(X&16711680)>>8;Y(aI.subarray(8,16))}function ar(aI){am=aI[2]+256*(aI[3]+256*aI[4]);X=((am&4095)<<12);aI[2]=X&255;aI[3]=(X&65280)>>8;aI[4]=(X&16711680)>>8;Y(aI.subarray(8,16))}function ax(aK,aI){var aJ;for(aJ=0;aJ<aK.length;aJ++){aK[aJ]=aI[aJ]}}switch(aA){case h.RGB_S3TC_DXT1_Format:av=8;ab=Y;ak=al;break;case h.RGBA_S3TC_DXT3_Format:av=16;ab=aE;ak=ad;break;case h.RGBA_S3TC_DXT5_Format:av=16;ab=ac;ak=ar;break;default:console.error("flip dds error");return aF}aB=at;aG=aq;for(az=0;az<af;++az){aH=aF[az].data;ai=Math.floor((aB+3)/4);ag=Math.floor((aG+3)/4);aC=ai*ag;if(aG==1){break}else{if(aG==2){for(aw=0;aw<ai;aw++){ak(aH.subarray(ae,aw*av));ae=+av}}else{ae=0;for(aw=1;aw<=aC;aw++){if(aw==4095){var au}ab(aH.subarray(ae,aw*av));ae+=av}ay=av*ai;ap=new Uint8Array(ay);for(var ah=0;ah<ag/2;++ah){an=aH.subarray(ah*ay,(ah+1)*ay);aj=aH.subarray((ag-ah-1)*ay,(ag-ah)*ay);ax(ap,an);ax(an,aj);ax(aj,ap)}}}aB/=2;if(aB<1){at=1}aG/=2;if(aG<1){aq=1}}}function B(ab,ae,ag,X,af){var ac;var ad=parseInt((ag/2),10)+ag%2;var ah=new Uint8Array(X*(af+ag)*4);if(ae==h.RGBAFormat){var Z=ad*X*4;for(ac=0;ac<ab.length;ac++){ah[Z+ac]=ab[ac]}}else{var Z=ad*X*4;var Y=0;for(ac=0;ac<ab.length;ac+=3,Y+=4){ah[Z+Y]=ab[ac];ah[Z+Y+1]=ab[ac+1];ah[Z+Y+2]=ab[ac+2];ah[Z+Y+3]=1}}return ah}function H(ae,ag,Z,X,ah){var af,ad,ab,ac;var Y=parseInt((Z/2),10)+Z%2;var ai=new Uint8Array(ah*(X+Z)*4);if(ag==h.RGBAFormat){ac=0;for(af=0;af<ah;af++){ac=Y*4+(X+Z)*4*af;for(ad=0;ad<X*4;ad++){ai[ac+ad]=ae[af*X*4+ad]}}}else{ac=0;for(af=0;af<ah;af++){ac=Y*4+(X+Z)*4*af;for(ad=0,ab=0;ad<X;ad+=3,ab+=4){ai[ac+ab]=ae[af*X*4+ad];ai[ac+ab+1]=ae[af*X*4+ad+1];ai[ac+ab+2]=ae[af*X*4+ad+2];ai[ac+ab+3]=1}}}return ai}var E,A,G,V,w,P;if((D.wrap[0]===1)||(D.wrap[0]=="repeat")){E=h.RepeatWrapping}else{E=h.ClampToEdgeWrapping}if((D.wrap[1]===1)||(D.wrap[0]=="repeat")){A=h.RepeatWrapping}else{A=h.ClampToEdgeWrapping}switch(D.filter[0]){case 0:V=h.NearestFilter;break;case 1:V=h.LinearFilter;break;case 2:V=h.NearestMipMapNearestFilter;break;case 3:V=h.NearestMipMapLinearFilter;break;case 4:V=h.LinearMipMapNearestFilter;break;case 5:V=h.LinearMipMapLinearFilter;break}switch(D.filter[1]){case 0:G=h.NearestFilter;break;case 1:G=h.LinearFilter;break;case 2:G=h.NearestMipMapNearestFilter;break;case 3:G=h.NearestMipMapLinearFilter;break;case 4:G=h.LinearMipMapNearestFilter;break;case 5:G=h.LinearMipMapLinearFilter;break}switch(D.type){case"url":var K=/(?:\.([^.]+))?$/,T=K.exec(D.sourceFile.filename)[1],r,o;if(T==="dds"){w=h.ImageUtils.loadCompressedTextureFromBuffer(D.sourceFile.buffer)}else{r=document.createElement("canvas");w=new h.Texture(r);if(D.format==="XMLV6"){w.sourceFile=D.sourceFile}else{w.sourceFile=window.URL.createObjectURL(D.sourceFile.buffer)}}if(D.offset){w.offset.set(D.offset[0],D.offset[1])}if(T==="dds"){if(w&&w.mipmaps){o=w.mipmaps;if((o[o.length-1].height!=1)||(o[o.length-1].width!=1)){V=G=h.LinearFilter}}w.flipY=true;break}if(D.format==="XMLV6"){J(w,D.texturePath+"/"+D.sourceFile)}else{J(w,w.sourceFile)}if(w){w.flipY=true}break;case"url_envMap":var K=/(?:\.([^.]+))?$/,T=K.exec(sourceFile.filename)[1],r,o;if(T==="dds"){w=h.ImageUtils.loadCompressedTextureFromBuffer(sourceFile.buffer)}else{r=document.createElement("canvas");w=new h.Texture(r);if(D.format==="XMLV6"){w.sourceFile=sourceFile}else{w.sourceFile=window.URL.createObjectURL(sourceFile.buffer)}}if(D.offset){w.offset.set(D.offset[0],D.offset[1])}if(T==="dds"){if(w&&w.mipmaps){o=w.mipmaps;if((o[o.length-1].height!=1)||(o[o.length-1].width!=1)){w.minFilter=w.magFilter=h.LinearFilter}}w.flipY=true;break}N(w,D.texturePath+"/"+sourceFile);if(w){w.flipY=true}break;case"data":var m,p,U,z,F,s,M,S=false,Q=false;if(D.resources.mipmaps){var C=D.resources;if(C.url=="default_white_color.dds"){if(d==null){var W=c.getWebappsAssetUrl("Visualization","");w=f(W+"default_white_color.png")}else{w=d}break}var L=0;switch(C.format){case 3:L=h.RGBAFormat;break;case 6:L=h.RGB_S3TC_DXT1_Format;S=true;break;case 7:L=h.RGBA_S3TC_DXT1_Format;S=true;break;case 8:L=h.RGBA_S3TC_DXT3_Format;S=true;break;case 9:L=h.RGBA_S3TC_DXT5_Format;S=true;break}if(S){O(C.width,C.height,C.mipmapCount,L,C.mipmaps)}w=new h.CompressedTexture(C.mipmaps,C.width,C.height,L,undefined,new h.UVMapping(),E,A,G,V);w.flipY=false;w.generateMipmaps=false;w.needsUpdate=true;break}m=D.resources.width;p=D.resources.height;U=D.resources.img;z=D.resources.format;var x=false;if(D.filter[0]>1||D.filter[1]>1){x=true}if(E==h.RepeatWrapping||A==h.RepeatWrapping){x=true}if(D.resources.zoom){P=true}switch(z){case 0:z=h.LuminanceFormat;break;case 1:z=h.LuminanceAlphaFormat;break;case 2:z=h.RGBFormat;break;case 3:z=h.RGBAFormat;M=t(U);break;default:}if(D.resources.compression){var I=function(ab){var X=ab.image;var Y=document.createElement("canvas");Y.width=X.width;Y.height=X.height;Y.getContext("2d").drawImage(X,0,0,X.width,X.height);var Z=Y.getContext("2d").getImageData(0,0,X.width,X.height);w.transparent=t(Z.data);if(w.transparentCb){w.transparentCb(w.transparent)}};var y=new Blob([U],{type:"image/png"});var q=URL.createObjectURL(y);w=h.ImageUtils.loadTexture(q,undefined,I,null,h.ImageUtils.crossOriginPolicy,x);w.needToCheckTransparency=true;w.size=m;break}if(D.texturePoint){if(m>p){U=B(U,z,m-p,m,p);p=m}else{if(p>m){U=H(U,z,p-m,m,p);m=p}}}else{if((!v(m)||!v(p))&&x){F=R(m);s=R(p);if(z===h.RGBAFormat){U=u(U,m,p,F,s,4)}else{if(z===h.RGBFormat){U=u(U,m,p,F,s,3)}}m=F;p=s}}w=new h.DataTexture(U,m,p,z,undefined,undefined,E,A,G,V);if(w){w.size=m;w.flipY=false;if(M){w.transparent=true}if(z==h.RGBFormat){var n=m*3;if(n%4){w.unpackAlignment=2;if(n%2){w.unpackAlignment=1}}}}w.needsUpdate=true;break}if(w){if(P){w.zoom=true}w.wrapS=E;w.wrapT=A;w.magFilter=G;w.minFilter=V}return w},_getDashPattern:function(n){var m;switch(n){case e.LinePatternEnum.DOTTED:m=new Float32Array(2);m[0]=3;m[1]=3;break;case e.LinePatternEnum.DASHED:m=new Float32Array(2);m[0]=5;m[1]=1;break;case e.LinePatternEnum.DOTDASHED:m=new Float32Array(4);m[0]=5;m[1]=3;m[2]=2;m[3]=3;break;case e.LinePatternEnum.PHANTOM:m=new Float32Array(6);m[0]=2;m[1]=2;m[2]=2;m[3]=2;m[4]=6;m[5]=2;break;case e.LinePatternEnum.SMALLDOTTED:m=new Float32Array(2);m[0]=1;m[1]=1;break;case e.LinePatternEnum.JISAXIS:m=new Float32Array(4);m[0]=14;m[1]=2;m[2]=4;m[3]=2;break;default:m=new Float32Array(1);m[0]=-1;break}return m},set3DXMaterial:function(m,n){this.threeDXMaterials.set(m,n)},get3DXMaterial:function(m){if(this.threeDXMaterials.has(m)){return this.threeDXMaterials.get(m)}return null},getMaterialFromGAS:function(q){var p,s,o;if(q.color==undefined){q.color=new h.Color()}if(q.opacity===undefined){q.opacity=1}for(o=0;o<this.materials.length;o++){p=this.materials[o];s=p.params;if(s.type!=="color"){continue}if((q.symbol!==undefined)&&(s.style!=="point")){continue}if((q.lineWidth!==undefined)&&(s.style!=="line")){continue}if((q.lineWidth===undefined)&&(q.symbol===undefined)&&(s.style!=="fill")){continue}if((q.pattern!==undefined)&&(s.pattern!==q.pattern)){continue}if((s.color.r!==q.color.r)||(s.color.g!==q.color.g)||(s.color.b!==q.color.b)){continue}if(s.opacity!==q.opacity){continue}if((q.lineWidth!==undefined)&&(s.lineWidth!==q.lineWidth)){continue}if((q.symbol!==undefined)&&(s.symbol!==q.symbol)){continue}if((q.size!==undefined)&&(s.size!==q.size)){continue}if((q.solid!==undefined)&&(s.solid!==q.solid)){continue}if((q.basic)&&(s.basic!==q.basic)){continue}return p.threejs_mat}if(q.symbol!==undefined){s={type:"color",style:"point",color:q.color,opacity:q.opacity,symbol:q.symbol,size:q.size};var p=this.createPointMaterial({symbol:q.symbol,color:q.color,opacity:q.opacity,resource:q.resource,size:q.size})}else{if(q.lineWidth!==undefined){s={type:"color",style:"line",color:q.color,opacity:q.opacity,lineWidth:q.lineWidth,pattern:q.pattern};var n=(q.pattern instanceof Array)?q.pattern:this._getDashPattern(q.pattern);p=new h.LineBasicMaterial({color:q.color.getHex(),lineWidth:q.lineWidth,scale:6.66,dashPattern:n,opacity:q.opacity,transparent:(q.opacity<1)})}else{if(q.basic){s={type:"color",style:"fill",color:q.color,opacity:q.opacity,basic:q.basic,solid:q.solid};p=new h.MeshBasicMaterial({color:q.color.getHex(),side:q.solid===1?h.FrontSide:h.DoubleSide,opacity:q.opacity,transparent:(q.opacity<1)})}else{s={type:"color",style:"fill",color:q.color,opacity:q.opacity,solid:q.solid};p=new h.MeshPhongMaterial({color:q.color.getHex(),opacity:q.opacity,transparent:(q.opacity<1),side:q.solid===1?h.FrontSide:h.DoubleSide,specular:16777215,shininess:76})}}}var m=false;for(var r in p){if(p.hasOwnProperty(r)&&p[r] instanceof h.Texture){m=true;break}}this.materials.push({params:s,threejs_mat:p,hasTexture:m});p._source=h.AssetSource.MATERIAL_MANAGER;return p}});return UWA.namespace("THREEDS/MaterialManager",l)});define("Visualization/MaterialManager",["DS/Visualization/MaterialManager","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/MaterialManager");return b});define("DS/Plugins/RenderPass",["DS/Visualization/ThreeJS_DS"],function(c){var b=1;var a=function(j,h,e,d,k,g,f){this.scene=j;this.lockScene=false;this.name=f;this.id="R"+(b++);this.forcePolygonOffset=c.PolygonOffsetForceStatus.DEFAULT;this.overrideMaterial=e;this.renderFaces=(d!==undefined)?d:null;this.renderLineMode=(k!==undefined&&k!==null)?(k||c.HideAllRenderLineMode):null;this.renderPoints=(g!==undefined)?g:null;this.renderPointMode=null;this.forceMaterialDoubleSide=false;this.oldRenderFaces=false;this.oldRenderLineMode=c.HideAllRenderLineMode;this.oldRenderPoints=false;this.oldRenderSurfacicPoints=false;this.needsSwap=false;this.order=0;this.renderPluginsPre=true;this.renderPluginsPost=true;this.oldRenderPluginsPre=true;this.oldRenderPluginsPost=true;this.disableColorWrite=false;this.disableDepthWrite=false;this.disableBackFaceCulling=false;this.disableClippingPlanes=false;this.enableStencilTest=false;this.enableStencilWrite=false;this.stencilOpFrontFaces="KEEP";this.stencilOpBackFaces="KEEP";this.stencilOpFrontFacesZFail="KEEP";this.stencilOpBackFacesZFail="KEEP";this.stencilFunc="ALWAYS";this.depthFunc=null;this.prevNormalDepthBuffer=null;this.prevColorBuffer=null;this.materialToUse=null;this.hideSurfacesAndUnclipedMeshes=false;this.cullFaceMode="back";this.disableBackFaceClipPlanes=false;this.renderCuttingElements=false;this.cuttingScene=null;this.isCustomPass=false;this.disableToneMapping=false;this.stencilRef=100;this.defaults={};this.cameraName="main";this.idString="main";this.info=new c.RenderInfo();this.customCamera=null;this.useRenderPriorityOpacity=false;this.isOITPass=false;this.dlsToDisable=[];this.composer=null;this.ignoreNoZ=false;this.disabledByDefault=false;this.order=0;this.isRobotPass=false;this.oldRenderPointMode=null;this.renderToScreen=false;this.renderSurfacicPoints=false;this.context=null;this.stateSortingResult=null;this.updateStateSortingResult=true;this.enableGSSOCache=false;this.forceMaterialMode=false};a.prototype={getDefaultState:function(){return{enabled:this.disabledByDefault?false:true,renderPlugins:false,renderToCanvas:false}},setStateSortingResult:function(d,e){this.stateSortingResult=d;this.updateStateSortingResult=e},getUsedStateSortingResult:function(d){return this.stateSortingResult||d._stateSortingResult},setForceMaterialMode:function(d){this.forceMaterialMode=d},setRenderPluginsPre:function(d){this.renderPluginsPre=d},setGSSOCache:function(d){this.enableGSSOCache=d},setRenderPluginsPost:function(d){this.renderPluginsPost=d},setMaterialToUse:function(d){this.materialToUse=d},setDisableColorWrite:function(d){this.disableColorWrite=d},setUseRenderPriorityOpacity:function(d){this.useRenderPriorityOpacity=d},setCustomCamera:function(d){this.customCamera=d},setDisableDepthWrite:function(d){this.disableDepthWrite=d},setDisableBackFaceCulling:function(d){this.disableBackFaceCulling=d},setForceMaterialDoubleSide:function(d){this.forceMaterialDoubleSide=d},setDisableClippingPlanes:function(d){this.disableClippingPlanes=d},setEnableStencilWrite:function(d){this.enableStencilWrite=d},setEnableStencilTest:function(d){this.enableStencilTest=d},setCameraName:function(d){this.cameraName=d},setStencilOps:function(e,d){this.stencilOpFrontFaces=e;this.stencilOpBackFaces=d;this.stencilOpFrontFacesZFail=e;this.stencilOpBackFacesZFail=d},setStencilOpsSeparate:function(g,d,f,e){this.stencilOpFrontFaces=g;this.stencilOpBackFaces=d;this.stencilOpFrontFacesZFail=f;this.stencilOpBackFacesZFail=e},setStencilFunc:function(d){this.stencilFunc=d},setCullFaceMode:function(d){this.cullFaceMode=d},setHideSurfacesAndUnclippedMeshes:function(d){this.hideSurfacesAndUnclipedMeshes=d},setDisableBackFaceClipPlanes:function(d){this.disableBackFaceClipPlanes=d},setCuttingScene:function(d){this.cuttingScene=d},setRenderCuttingElements:function(d){if(this.renderCuttingElements&&!d){this.setCuttingScene(null)}this.renderCuttingElements=d},setCustomPass:function(){this.isCustomPass=true},setDisableToneMapping:function(d){this.disableToneMapping=d},setDepthFunc:function(d){this.depthFunc=d},setScene:function(d){this.scene=d},setPreviousNormalDepthBuffer:function(d){this.prevNormalDepthBuffer=d},setPreviousColorBuffer:function(d){this.prevColorBuffer=d},setDLsToDisable:function(d){this.dlsToDisable=d.slice(0)},setDLsState:function(f,d,e){if(d&&d.length){d.forEach(function(g){f.forEach(function(h){if(h.name===g){h.active=e}})})}},activateAllDLs:function(e){for(var d=0;d<e.length;d++){e[d].active=true}},render:function(o,w,j,x,e,d,z,f,q,h){var r;var s=z[f];var g=o.context;this.scene.overrideMaterial=this.overrideMaterial;o.forcePolygonOffset=this.forcePolygonOffset;if(this.depthFunc){g.depthFunc(g[this.depthFunc])}g.stencilFunc(g[this.stencilFunc],this.stencilRef,255);g.stencilOpSeparate(g.FRONT,g.KEEP,g[this.stencilOpFrontFacesZFail],g[this.stencilOpFrontFaces]);g.stencilOpSeparate(g.BACK,g.KEEP,g[this.stencilOpBackFacesZFail],g[this.stencilOpBackFaces]);if(this.enableStencilTest){g.enable(g.STENCIL_TEST)}if(this.renderFaces!==null){this.oldRenderFaces=o.renderFaces;o.renderFaces=this.renderFaces}if(this.renderLineMode!==null){this.oldRenderLineMode=o.renderLineMode;o.renderLineMode=this.renderLineMode}if(this.forceMaterialDoubleSide){o.forceMaterialDoubleSide=true}if(this.renderPoints!==null){this.oldRenderPoints=o.renderPoints;o.renderPoints=this.renderPoints}if(this.renderPointMode!==null){this.oldRenderPointMode=o.renderPointMode;o.renderPointMode=this.renderPointMode}this.oldRenderPluginsPre=o.enableRenderPluginsPre;o.enableRenderPluginsPre=this.renderPluginsPre;this.oldRenderPluginsPost=o.enableRenderPluginsPost;o.enableRenderPluginsPost=this.renderPluginsPost;o.setFaceCulling(this.cullFaceMode=="back"?c.CullFaceBack:(this.cullFaceMode=="front"?c.CullFaceFront:c.CullFaceNone));if(this.disableBackFaceClipPlanes!=0){o.disableBackFaceClipPlanes=this.disableBackFaceClipPlanes}var p=o.clipPlanesEnabled;if(this.disableClippingPlanes){o.clipPlanesEnabled=false}if(this.disableColorWrite){o.setDisableColorWrite(true)}if(this.disableDepthWrite){o.setDisableDepthWrite(true)}if(this.enableStencilWrite){o.setEnableStencilWrite(true)}if(this.disableBackFaceCulling){o.setDisableBackFaceCulling(true)}var m=[];if(this.hideSurfacesAndUnclipedMeshes){this.scene.traverse(function(B){if(B instanceof c.Mesh&&B.visible){var A=B.material;if(A&&A.enableClipPlanes===false){m.push(B);B.visible=false}}})}var k=o.materialToUse;if(!c.MaterialHasPriority[k]&&this.materialToUse){o.materialToUse=this.materialToUse}if(this.cuttingScene){o.cuttingScene=this.cuttingScene}o.setCurrentPass(this);o.autoClearStencil=false;o.autoClearDepth=false;o.autoClear=false;var u=o.gammaInput;var t=o.gammaOutput;if(this.disableToneMapping){o.gammaInput=false;o.gammaOutput=false}var n=o.renderVolumesOnly;o.renderVolumesOnly=this.hideSurfacesAndUnclipedMeshes;this.prevNormalDepthBuffer&&o.setPreviousNormalDepthBuffer(this.prevNormalDepthBuffer);this.prevColorBuffer&&o.setPreviousColorBuffer(this.prevColorBuffer);if(this.useRenderPriorityOpacity&&o.materialToUse===c.MaterialToUse.originalMaterial){o.useRenderPriorityOpacity=true}var v,l;if(this.stateSortingResult!==null){v=this.stateSortingResult;l=this.updateStateSortingResult}else{v=o._stateSortingResult;l=true}var y;if(this.forceMaterialMode){y=o.materialMode;o.materialMode=true}this.setDLsState(v._displayLists,this.dlsToDisable,false);o.activateSplitScreenMode(!h&&j?false:true);if(h){o.render(this.scene,this.customCamera||s||this.composer.camera,undefined,undefined,undefined,v,l,this.enableGSSOCache&&d.enableGSSOCache)}else{o.render(this.scene,this.customCamera||s||this.composer.camera,j,false,false,v,l,this.enableGSSOCache&&d.enableGSSOCache)}if(this.forceMaterialMode){o.materialMode=y}this.activateAllDLs(v._displayLists);if(this.useRenderPriorityOpacity){o.useRenderPriorityOpacity=false}o.info.render.copyTo(this.info);o.renderVolumesOnly=n;o.gammaInput=u;o.gammaOutput=t;o.setCurrentPass(null);if(this.cuttingScene){o.cuttingScene=null}o.materialToUse=k;for(r=0;r<m.length;r++){m[r].visible=true}o.setDisableColorWrite(false);if(this.disableClippingPlanes){o.clipPlanesEnabled=p}if(this.disableBackFaceCulling){o.setDisableBackFaceCulling(false)}o.setDisableDepthWrite(false);o.setEnableStencilWrite(false);if(this.enableStencilTest){g.disable(g.STENCIL_TEST)}if(this.renderFaces!==null){o.renderFaces=this.oldRenderFaces}if(this.renderLineMode!==null){o.renderLineMode=this.oldRenderLineMode}if(this.renderPoints!==null){o.renderPoints=this.oldRenderPoints}if(this.renderPointMode!==null){o.renderPointMode=this.oldRenderPointMode}if(this.disableBackFaceClipPlanes!=0){o.disableBackFaceClipPlanes=0}o.enableRenderPluginsPre=this.oldRenderPluginsPre;o.enableRenderPluginsPost=this.oldRenderPluginsPost;o.forceMaterialDoubleSide=false;this.scene.overrideMaterial=null;g.stencilFunc(g.ALWAYS,0,255);g.stencilOp(g.KEEP,g.KEEP,g.KEEP);if(this.depthFunc){g.depthFunc(g.LEQUAL)}o.forcePolygonOffset=c.PolygonOffsetForceStatus.DEFAULT}};return a});define("Plugins/RenderPass",["DS/Plugins/RenderPass","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Plugins/RenderPass");return b});define("DS/Visualization/RenderPriorityManager",["UWA/Class","DS/Plugins/RenderPass","DS/Plugins/ClearPass"],function(b,a,d){var c=b.extend({init:function(e){this.viewer=e;this.enabled=false;this.passes=this._createPasses(e)},setEnabled:function(e){e=e?true:false;if(this.enabled!==e){this.enabled=e;this._enablePasses(this.enabled);this.viewer.internalSceneGraph.root._forceUpdate()}},_enablePasses:function(e){if(this.passes){var g=this.viewer;if(e){var f;for(f=0;f<this.passes.length;f++){g.renderer.mainComposer.addPass(this.passes[f])}}else{g.renderer.mainComposer.removePasses(this.passes)}}},_createPasses:function(l){var j=[];var e=new d("renderPriorityClear");e.defaults.clear=false;e.setClearStencil(true);e.clearStencilValue=0;e.idString="renderPriority";j.push(e);var f=4;var h,k,g;for(h=0;h<=f;h++){k=new a(null,null,null,null,null,null,"renderPriorityStencilP"+h);k.idString="p"+h;k.stencilRef=h;k.enableStencilTest=true;k.setStencilFunc("GEQUAL");k.setStencilOps("REPLACE","REPLACE");k.setEnableStencilWrite(true);j.push(k);if(h!==f){g=new a(null,null,null,null,null,null,"renderPriorityDrawP"+h);g.idString="p"+h;g.stencilRef=h;g.enableStencilTest=true;g.setStencilFunc("LESS");g.setStencilOps("KEEP","KEEP");g.useRenderPriorityOpacity=true;g.setEnableStencilWrite(false);j.push(g)}}return j}});return c});define("DS/VisuEvents/TouchEvent",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent"],function(b,a){var c=a.extend({init:function(f,e,d){this._parent(e);this.type="Touch";this.identifier=f;this._traveledDist=0;if(this.event.touches&&this.event.touches[d]){this.view=this.event.touches[d].target}return this},update:function(d){this._parent(d);var g=null;for(var h=0;h<d.changedTouches.length;h++){var l=d.changedTouches[h];if(l.identifier===this.identifier){g=l;break}}var e;try{e=this.view.getBoundingClientRect()}catch(f){e={left:0,top:0}}switch(d.type){case"touchstart":this.currentPosition.set(g.clientX-e.left,g.clientY-e.top);this.startPosition.copy(this.currentPosition);this.lastPosition.copy(this.currentPosition);this.deltaPosition.set(0,0);this.offsetPosition.set(0,0);this._currentPosition.set(g.clientX,g.clientY);this._startPosition.copy(this._currentPosition);this._lastPosition.copy(this._currentPosition);this._deltaPosition.set(0,0);this._offsetPosition.set(0,0);this._traveledDist=0;break;case"touchmove":var j=new b.Vector2(g.clientX-e.left,g.clientY-e.top);this.lastPosition.copy(this.currentPosition);this.deltaPosition.subVectors(j,this.currentPosition);this.currentPosition.copy(j);this.offsetPosition.subVectors(this.currentPosition,this.startPosition);j.set(g.clientX,g.clientY);this._lastPosition.copy(this._currentPosition);this._deltaPosition.subVectors(j,this._currentPosition);this._currentPosition.copy(j);this._offsetPosition.subVectors(this._currentPosition,this._startPosition);var m=this._currentPosition.clone();m.sub(this._lastPosition);this._traveledDist+=m.length();break;case"touchend":case"touchcancel":var j=new b.Vector2(g.clientX-e.left,g.clientY-e.top);this.lastPosition.copy(this.currentPosition);this.deltaPosition.subVectors(j,this.currentPosition);this.currentPosition.copy(j);this.offsetPosition.subVectors(this.currentPosition,this.startPosition);j.set(g.clientX,g.clientY);this._lastPosition.copy(this._currentPosition);this._deltaPosition.subVectors(j,this._currentPosition);this._currentPosition.copy(j);this._offsetPosition.subVectors(this._currentPosition,this._startPosition);var k=new b.Vector2(this._currentPosition.x,this._currentPosition.y);k.sub(this._lastPosition);this._traveledDist+=k.length();break;default:break}},getIdentifier:function(){return this.identifier},getTraveledDistance:function(){return this._traveledDist}});return UWA.namespace("THREEDS/Events/TouchEvent",c)});define("VisuEvents/TouchEvent",["DS/VisuEvents/TouchEvent","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuEvents/TouchEvent");return b});define("DS/Shaders/BloomShaders",["DS/Visualization/ThreeJS_DS"],function(e){var f=function(h){var j="tDiffuse"+(h?h:"");var g={defines:{LEVEL:1},uniforms:{invSize:{type:"v2",value:new e.Vector2(512,512)},radius:{type:"f",value:0.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D "+j+";","varying vec2 vUv;","void main() {","vec2 screenPos = vUv;","vec4 result = vec4(0.0);","float blurSize = invSize.x;","#if (LEVEL == 1)","result += texture2D("+j+", vec2(vUv.x - 1.2 * blurSize, vUv.y)) * 0.3125;","result += texture2D("+j+", vec2(vUv.x, vUv.y)) * 0.375;","result += texture2D("+j+", vec2(vUv.x + 1.2 * blurSize, vUv.y)) * 0.3125;","#endif","#if (LEVEL == 2)","result += texture2D("+j+", vec2(vUv.x - 1.285714285714 * blurSize, vUv.y)) * 0.328125;","result += texture2D("+j+", vec2(vUv.x, vUv.y)) * 0.3125;","result += texture2D("+j+", vec2(vUv.x + 1.285714285714 * blurSize, vUv.y)) * 0.328125;","#endif","#if (LEVEL == 3)","result += texture2D("+j+", vec2(vUv.x - 3.111111111111 * blurSize, vUv.y)) * 0.03515625;","result += texture2D("+j+", vec2(vUv.x - 1.333333333333 * blurSize, vUv.y)) * 0.328125;","result += texture2D("+j+", vec2(vUv.x, vUv.y)) * 0.2734375;","result += texture2D("+j+", vec2(vUv.x + 1.333333333333 * blurSize, vUv.y)) * 0.328125;","result += texture2D("+j+", vec2(vUv.x + 3.111111111111 * blurSize, vUv.y)) * 0.03515625;","#endif","#if (LEVEL == 4)","result += texture2D("+j+", vec2(vUv.x - 3.181818181818 * blurSize, vUv.y)) * 0.0537109375;","result += texture2D("+j+", vec2(vUv.x - 1.363636363636 * blurSize, vUv.y)) * 0.322265625;","result += texture2D("+j+", vec2(vUv.x, vUv.y)) * 0.24609375;","result += texture2D("+j+", vec2(vUv.x + 1.363636363636 * blurSize, vUv.y)) * 0.322265625;","result += texture2D("+j+", vec2(vUv.x + 3.181818181818 * blurSize, vUv.y)) * 0.0537109375;","#endif","#if (LEVEL == 5)","result += texture2D("+j+", vec2(vUv.x - 5.076923076923 * blurSize, vUv.y)) * 0.003173828125;","result += texture2D("+j+", vec2(vUv.x - 3.230769230769 * blurSize, vUv.y)) * 0.06982421875;","result += texture2D("+j+", vec2(vUv.x - 1.384615384615 * blurSize, vUv.y)) * 0.314208984375;","result += texture2D("+j+", vec2(vUv.x, vUv.y)) * 0.2255859375;","result += texture2D("+j+", vec2(vUv.x + 1.384615384615 * blurSize, vUv.y)) * 0.314208984375;","result += texture2D("+j+", vec2(vUv.x + 3.230769230769 * blurSize, vUv.y)) * 0.06982421875;","result += texture2D("+j+", vec2(vUv.x + 5.076923076923 * blurSize, vUv.y)) * 0.003173828125;","#endif","gl_FragColor = result;","}"].join("\n")};g.uniforms[j]={type:"t",value:null};return g},c={defines:{LEVEL:1},uniforms:{tDiffuse:{type:"t",value:null},invSize:{type:"v2",value:new e.Vector2(512,512)},radius:{type:"f",value:0.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec2 screenPos = vUv;","vec4 result = vec4(0.0);","float blurSize = invSize.y;","#if (LEVEL == 1)","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 1.2 * blurSize)) * 0.3125;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y)) * 0.375;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 1.2 * blurSize)) * 0.3125;","#endif","#if (LEVEL == 2)","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 1.285714285714 * blurSize)) * 0.328125;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y)) * 0.3125;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 1.285714285714 * blurSize)) * 0.328125;","#endif","#if (LEVEL == 3)","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 3.111111111111 * blurSize)) * 0.03515625;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 1.333333333333 * blurSize)) * 0.328125;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y)) * 0.2734375;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 1.333333333333 * blurSize)) * 0.328125;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 3.111111111111 * blurSize)) * 0.03515625;","#endif","#if (LEVEL == 4)","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 3.181818181818 * blurSize)) * 0.0537109375;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 1.363636363636 * blurSize)) * 0.322265625;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y)) * 0.24609375;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 1.363636363636 * blurSize)) * 0.322265625;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 3.181818181818 * blurSize)) * 0.0537109375;","#endif","#if (LEVEL == 5)","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 5.076923076923 * blurSize)) * 0.003173828125;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 3.230769230769 * blurSize)) * 0.06982421875;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 1.384615384615 * blurSize)) * 0.314208984375;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y)) * 0.2255859375;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 1.384615384615 * blurSize)) * 0.314208984375;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 3.230769230769 * blurSize)) * 0.06982421875;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 5.076923076923 * blurSize)) * 0.003173828125;","#endif","gl_FragColor = result;","}"].join("\n")},b={uniforms:{tDiffuse:{type:"t",value:null},invSize:{type:"v2",value:new e.Vector2(512,512)},radius:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D tDiffuse;","uniform float radius;","varying vec2 vUv;","void main() {","vec4 result = vec4(0.0);","float radiusH = invSize.x * radius;","float radiusV = invSize.y * radius;","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * -0.326212, vUv.y + radiusV * -0.405805 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * -0.840144, vUv.y + radiusV * -0.07358 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * -0.695914, vUv.y + radiusV * 0.457137 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * -0.203345, vUv.y + radiusV * 0.620716 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * 0.96234, vUv.y + radiusV * -0.194983 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * 0.473434, vUv.y + radiusV * -0.480026 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * 0.519456, vUv.y + radiusV * 0.767022 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * 0.185461, vUv.y + radiusV * -0.893124 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * 0.507431, vUv.y + radiusV * 0.064425 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * 0.530992, vUv.y + radiusV * 0.412458 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * -0.32194, vUv.y + radiusV * -0.871945 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * -0.791559, vUv.y + radiusV * 0.597705 ) );","gl_FragColor = result * 0.0833333333333333;","}"].join("\n")},d={uniforms:{tDiffuse2:{type:"t",value:null},threshold:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse2;","uniform float threshold;","varying vec2 vUv;","void main() {","    vec4 color = texture2D( tDiffuse2, vUv );","float lum = dot(color.rgb, vec3(0.2126, 0.7152, 0.0722));","float lum2 = clamp(lum - threshold, 0.0, 1.0);","color.rgb *= lum2;","gl_FragColor = color;","}"].join("\n")},a={uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDiffuse4:{type:"t",value:null},tDiffuse5:{type:"t",value:null},tDiffuse6:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform sampler2D tDiffuse4;","uniform sampler2D tDiffuse5;","uniform sampler2D tDiffuse6;","varying vec2 vUv;","void main() {","    vec4 color = texture2D( tDiffuse, vUv );","    vec4 bloom1 = texture2D( tDiffuse2, vUv );","    vec4 bloom2 = texture2D( tDiffuse3, vUv );","    vec4 bloom3 = texture2D( tDiffuse4, vUv );","    vec4 bloom4 = texture2D( tDiffuse5, vUv );","    vec4 bloom5 = texture2D( tDiffuse6, vUv );","    vec3 bloom = 0.5 * bloom1.rgb + 0.5 * bloom2.rgb + 0.5 * bloom3.rgb + 0.5 * bloom4.rgb + 0.5 * bloom5.rgb;","    float bloomFactor = 0.9;","	 vec3 result = color.rgb + bloomFactor * bloom;","	 float maxComponent = max(result.x, max(result.y, result.z));","	 if (maxComponent > 1.0) { result /= maxComponent; }","    gl_FragColor = vec4(result, color.a);","}"].join("\n")};return{Threshold:d,BlurH:f(),BlurH2:f(2),BlurV:c,PoissonBlur:b,FinalBlending:a}});define("Shaders/BloomShaders",["DS/Shaders/BloomShaders","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/BloomShaders");return b});define("DS/Shaders/NothingShader",["DS/Visualization/ThreeJS_DS"],function(a){var b={uniforms:{tDiffuse:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",a._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","    gl_FragColor = texture2D( tDiffuse, vUv );","}"].join("\n")};return b});define("Shaders/NothingShader",["DS/Shaders/NothingShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/NothingShader");return b});define("DS/Plugins/ComposerContext",["DS/Visualization/ThreeJS_DS"],function(g){var b=true;var d=1;var f=30;function c(h){if(!h&&f>0){console.warn("Rendering EffectComposer without specifying a result name");f--}}var e=30;var a=function(n,k,j,o){this.id=d++;if(n===undefined){var l=window.innerWidth||1,h=window.innerHeight||1,m={minFilter:g.LinearFilter,magFilter:g.LinearFilter,format:g.RGBFormat,stencilBuffer:false};n=new g.WebGLRenderTargetProperties(l,h,"uint")}this.renderTargetProperties=n;this.width=this.renderTargetProperties?this.renderTargetProperties.width:undefined;this.height=this.renderTargetProperties?this.renderTargetProperties.height:undefined;this.originalRenderTargetProperties=n;this.name=j;this.readBuffer=null;this.writeBuffer=null;this.renderResults={};this.usedBy=[];this.useCount=1;this.keepResult=false;this.forceRenderTarget=o;this.passes=[];this.passStates=[];this.composer=k;k.contexts.push(this);this.needsUpdate=true;this.cameras=[];this.updateStates();this.onEffectComposerChange=null;Object.defineProperty(this,"renderTarget2",{get:function(){if(e>0){console.warn("Accessing renderTarget2 deprecated property");e--}var p;for(p in this.renderResults){return this.renderResults[p]}return null}});this.beforeRenderCB=null;this.afterRenderCB=null;this.needRequiredReadBuffer=false;this.cameraName="";this.clearReadBuffer=0;this.noIdCheck=false;this.enableGSSOCache=false};a.prototype={getPassState:function(j){var h=this.passes.indexOf(j),k;if(h<0&&j){h=this.passes.length;this.passes.push(j);k=j.getDefaultState();k.pass=j;this.passStates[h]=k}return this.passStates[h]},updateStates:function(){var k=this.composer.getAllPasses();var h=[],j;for(j=0;j<k.length;j++){h.push(this.getPassState(k[j]))}this.passes=k;this.passStates=h;if(this.onEffectComposerChange){this.onEffectComposerChange(this)}},setBeforeRenderCB:function(h){this.beforeRenderCB=h},setAfterRenderCB:function(h){this.afterRenderCB=h},enablePass:function(j,h){if(j){var k=this.getPassState(j);k.enabled=h}},setAsLastPass:function(j,h){if(j){var k=this.getPassState(j);k.isLastPass=h}},enableRenderCuttingElementsPasses:function(h){var j=0,k;for(j=0;j<this.passes.length;j++){k=this.passes[j];if(k.renderCuttingElements&&!k.disabledByDefault){this.enablePass(k,h)}}},setPassClear:function(k,j,m,h){var l=this.getPassState(k);l.clear=j;if(typeof m!=="undefined"){l.clearColor=m}if(typeof h!=="undefined"){l.clearAlpha=h}},setPassRenderToCanvas:function(j,h){var k=this.getPassState(j);k.renderToCanvas=h},setPassClearDepth:function(j,h){var k=this.getPassState(j);k.doClearDepth=h},setRenderPlugins:function(j,h){var k=this.getPassState(j);k.renderPlugins=h},setCamera:function(j,h){var k=this.getPassState(j);k.camera=h},setCameraName:function(h){this.cameraName=h},setTransformCameraCB:function(h){this.transformCameraCB=h},clearReadBufferIfRequired:function(j,h){if(this.clearReadBuffer!==0){if(this.clearReadBuffer!==2){j.pushRenderTarget(this.readBuffer)}this.clearReadBuffer=0;this.readBuffer=null}},swapBuffers:function(l,h,j){var k=this.writeBuffer;this.writeBuffer=this.readBuffer;this.readBuffer=k;if(!this.readBuffer){this.acquireReadBuffer(l,h)}if(!this.writeBuffer&&j){this.acquireWriteBuffer(l,h)}},useWarmStart:function(k,h){var l=this.getPassState(k);var j=l.warmStart[h];if(this.readBuffer){renderTargetPool.pushRenderTarget(this.readBuffer);this.readBuffer=null}this.readBuffer=j;this.clearReadBuffer=2},saveReadRenderTargetForLatterWarmStart:function(k,m,j){var l=this.getPassState(k);if(!l.warmStart){l.warmStart={}}var h=l.warmStart[j];if(h){m.pushRenderTarget(h)}l.warmStart[j]=this.readBuffer;this.clearReadBuffer=2},changeRenderTargetProperties:function(j,k,h){this.clearReadBuffer=1;this.writeBuffer&&k.pushRenderTarget(this.writeBuffer,this);this.writeBuffer=null;j.width=this.width;j.height=this.height;this.renderTargetProperties=j;this.acquireWriteBuffer(k,h)},linkToShaderPassUniform:function(j,h){j.addLinkedEffectComposerContext(this);if(this.usedBy.indexOf(h)<0){this.usedBy.push(h)}},linkTo_internal:function(j,l,h){if(!this.noIdCheck){c(h)}j.value=this.renderResults[h];var k;for(k=0;k<this.usedBy.length;k++){if(this.usedBy[k]===j){return}}this.usedBy.push(j)},removeLinks:function(){this.usedBy=[]},updateLinks:function(h){if(!this.noIdCheck){c(h)}var j;for(j=0;j<this.usedBy.length;j++){this.usedBy[j].value=this.renderResults[h]}},restoreOriginalRenderTargetProperties:function(j,h){if(!j.areRenderTargetOptionsEqual(this.renderTargetProperties,this.originalRenderTargetProperties)){this.renderTargetProperties=this.originalRenderTargetProperties;if(this.renderResults[h]){j.pushRenderTarget(this.renderResults[h]);this.renderResults[h]=null}}},acquireWriteBuffer:function(j,h){if(!this.noIdCheck){c(h)}if(this.renderTargetProperties){if(this.renderResults[h]){this.writeBuffer=this.renderResults[h];this.renderResults[h]=null}else{if(!this.writeBuffer){this.writeBuffer=j.buildRenderTarget(this.renderTargetProperties.width,this.renderTargetProperties.height,this.renderTargetProperties.options||this.renderTargetProperties.optionsId,this)}}}},acquireReadBuffer:function(j,h){if(!this.noIdCheck){c(h)}if(this.renderTargetProperties){if(!this.readBuffer){this.readBuffer=j.buildRenderTarget(this.renderTargetProperties.width,this.renderTargetProperties.height,this.renderTargetProperties.options,this)}}},getResult:function(j,k){var h=this.renderResults[j];if(k){this.renderResults[j]=null}return h},selectResult:function(j,h){this.renderResults[h]=this.writeBuffer;this.writeBuffer=null;if(this.renderResults[h]){this.renderResults[h].useCount=this.useCount}if(this.writeBuffer){j.pushRenderTarget(this.writeBuffer,this);this.writeBuffer=null}if(this.readBuffer){j.pushRenderTarget(this.readBuffer,this);this.readBuffer=null}},releaseRenderTargets:function(k,j){var h=this.renderResults[j];if(!this.keepResult&&h){h.useCount--;if(h.useCount<=0){k.pushRenderTarget(h,this);this.renderResults[j]=null}}},setSize:function(l,h){var k,j,n;for(j=0;j<this.passStates.length;j++){if(n){if(n.warmStart){for(k in n.warmStart){n.warmStart[k].dispose()}n.warmStart=null}}var m=this.passes[j];if(m.requiredReadBuffer){m.requiredReadBuffer.dispose();m.requiredReadBuffer=null}}for(k in this.renderResults){if(this.renderResults[k]){this.renderResults[k].dispose()}}this.renderResults={};if(this.originalRenderTargetProperties){this.originalRenderTargetProperties.width=l;this.originalRenderTargetProperties.height=h}if(this.renderTargetProperties){this.renderTargetProperties.width=l;this.renderTargetProperties.height=h}if(this.forceRenderTarget){this.forceRenderTarget.dispose()}this.forceRenderTarget=null;if(this.readBuffer){this.readBuffer.dispose()}this.readBuffer=null;if(this.writeBuffer){this.writeBuffer.dispose()}this.writeBuffer=null;this.width=l;this.height=h},dispose:function(){this.setSize(0,0)},setGSSOCache:function(h){this.enableGSSOCache=h},setOnEffectComposerChangeCallback:function(h){this.onEffectComposerChange=h;if(h){h(this)}}};return a});define("Plugins/ComposerContext",["DS/Plugins/ComposerContext","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Plugins/ComposerContext");return b});define("DS/Plugins/EffectComposer",["DS/Visualization/ThreeJS_DS","DS/Plugins/ShaderPass","DS/Plugins/ComposerContext","DS/Plugins/ClearPass"],function(l,b,j,g){var d="-->";function k(o){var n=false;var m=o.slice(d.length);if(m.startsWith("(")&&m.endsWith(")")){m=m.slice(1,m.length-1);n=true}return{list:m,privateList:false}}function c(s,t){var n;var q="passes",p,r,u=false,o;var m=false;if(t){n=t.indexOf(s.name);if(n<0){throw new Error("unknown added pass")}else{for(p=n;p>=0&&!u;p--){r=t[p];if(r.startsWith(d)){o=k(r);q=o.list;m=o.privateList;u=true}}}}else{n=s.order}return{order:n,list:q,privateList:m}}function a(o,m,n){o.splice.apply(o,[m,0].concat(n))}var f=function(m){this.name=m;this.preCustomPasses=[];this.passes=[];this.postCustomPasses=[];this.privateList=false};f.prototype.addPass=function(q,p,m){if(this.passes.length&&(p!==undefined)){for(var n=0;n<this.passes.length;n++){var o=c(this.passes[n],m).order;if(p<o){this.passes.splice(n,0,q);return}}}this.passes.push(q)};var h=0;var e=function(q,p,t,u){this.renderer=q;this.renderTargetPool=t;this.orderedPassNames=u||null;this.id=h;h++;this.contexts=[];var o;this.passLists=[];if(u){var s,m,n,r;for(o=0;o<u.length;o++){s=u[o];if(s.startsWith(d)){n=k(s);m=n.list;var r=new f(m);r.privateList=n.privateList;this.passLists.push(r)}}}else{this.passLists.push(new f("passes"))}this.passListIndex={};for(o=0;o<this.passLists.length;o++){this.passListIndex[this.passLists[o].name]=o}this.preCustomPasses=[];this.postCustomPasses=[];this.prevNormalDepthBuffer=null;this.prevColorBuffer=null;this.camera=new l.OrthographicCamera(-1,1,1,-1,0,1);this.geometry=[l.createPlaneGeometryDS(2,2)];this.quad=new l.Mesh(this.geometry,null);this.quad.frustumCulled=false;this.quad.visibilityFree=true;this.shaderPassScene=new l.Scene();this.shaderPassScene.add(this.quad);this.renderScene=null;this.enabled=true;if(p){this.composerContext=new j(p,this)}else{this.composerContext=null}this.bShareDepth=false;this.needsCameraUpdate=false;this.targetUniform=null;this.keepResult=false};e.prototype={dispose:function(){this.quad.dispose()},getAllPasses:function(p){p=p||0;var n;var m=[],o;for(n=p;n<this.passLists.length;n++){o=this.passLists[n];if(o.preCustomPasses.length){m=m.concat(o.preCustomPasses)}m=m.concat(o.passes);if(o.postCustomPasses.length){m=m.concat(o.postCustomPasses)}}return m},setComposerContext:function(m){this.composerContext=m},updateComposerContexts:function(n){var m;for(m=0;m<this.contexts.length;m++){this.contexts[m].updateStates(n)}},swapBuffers:function(o,m,n){this.composerContext.swapBuffers(o,m,n)},addPass:function(n){var o=c(n,this.orderedPassNames);var m=o.order;var p=this.passLists[this.passListIndex[o.list]];p.addPass(n,m,this.orderedPassNames);n.composer=this;this.updateComposerContexts()},insertPass:function(n,m,o){o.splice(m,0,n);n.composer=this;this.updateComposerContexts()},enablePass:function(n,m){this.composerContext.enablePass(n,m)},linkToShaderPassUniform:function(o,n,m){this.composerContext.linkToShaderPassUniform(o,n,m)},removeLinks:function(){this.composerContext.removeLinks()},updateScene:function(q){this.renderScene=q;var n=this.getAllPasses();var p=n.length,o,m;for(m=0;m<p;m++){o=n[m];if(o.setScene&&!o.lockScene){o.setScene(q)}}},getRenderResult:function(m){return this.composerContext.renderResults[m]},findRequiredReabBuffer:function(p){if(!this.composerContext.needRequiredReadBuffer){return{forceWriteBufferIndex:-1,requiredReadBuffer:null}}var s=this.getAllPasses();var o=s.length;var r;var m=-1;var n=null;for(var q=p;q<o;q++){r=s[q];if(r&&r.requiredReadBuffer&&this.composerContext.getPassState(r).enabled){n=r.requiredReadBuffer;if(m===-1){m=p}break}if(r instanceof b&&this.composerContext.getPassState(r).enabled){m=q}}if(!n){m=-1}return{forceWriteBufferIndex:m,requiredReadBuffer:n}},render:function(C,B,E,w,q){if(!this.enabled){return}if(!this.composerContext.needsUpdate&&this.composerContext.keepResult){this.renderer.setRenderTarget(this.composerContext.renderResults[w]);return}this.composerContext.restoreOriginalRenderTargetProperties(this.renderTargetPool,w);this.composerContext.acquireWriteBuffer(this.renderTargetPool,w);if((B!==undefined)&&this.composerContext.writeBuffer){this.composerContext.writeBuffer.activeCubeFace=B}if(this.composerContext.beforeRenderCB){this.composerContext.beforeRenderCB(this.composerContext)}var s=this.getAllPasses();var m,p,z,u=s.length,D,y;var v=0;if(q){v=s.indexOf(q);if(v<0){return}this.composerContext.useWarmStart(q,w)}var x=false;var n=(v===0);var r=this.findRequiredReabBuffer(v);for(z=v;z<u;z++){var o=null;m=s[z];if(m.gammaCorrectionPass){x=true}D=this.composerContext.getPassState(m);if(m.clear!==undefined){m.clear=D.clear;m.clearColor=D.clearColor;m.clearAlpha=D.clearAlpha}if(m.setClearDepth){m.setClearDepth(D.doClearDepth)}if(m.setRenderPluginsPre){m.setRenderPluginsPre(D.renderPlugins)}if(m.setRenderPluginsPost){m.setRenderPluginsPost(D.renderPlugins)}if(D.cameraName){o=D.cameraName}else{if(this.composerContext.cameraName){o=this.composerContext.cameraName}else{o=m.cameraName}}if(D.isLastPass){break}if(!D.enabled){continue}var A=m.needsSwap&&v!==z&&!n;var t=z===r.forceWriteBufferIndex;if(t){this.composerContext.readBuffer=this.composerContext.writeBuffer;this.composerContext.writeBuffer=r.requiredReadBuffer}else{if(A){this.swapBuffers(this.renderTargetPool,w,!m.changeRenderTargetProperties)}}if(m.setPreviousColorBuffer){this.prevNormalDepthBuffer&&m.setPreviousNormalDepthBuffer(this.prevNormalDepthBuffer);this.prevColorBuffer&&m.setPreviousColorBuffer(this.prevColorBuffer)}if(m.changeRenderTargetProperties){this.composerContext.changeRenderTargetProperties(m.changeRenderTargetProperties,this.renderTargetPool,w)}if(m.enableWarmStart&&m!==q){this.composerContext.saveReadRenderTargetForLatterWarmStart(m,this.renderTargetPool,w)}if(m.setDisableToneMapping&&x){m.setDisableToneMapping(true)}if(!this.composerContext.forceRenderTarget){m.render(this.renderer,this.composerContext.readBuffer,this.composerContext.writeBuffer,C,n,this.composerContext,E,o,w,D.renderToCanvas)}else{m.render(this.renderer,this.composerContext.readBuffer,this.composerContext.forceRenderTarget,C,n,this.composerContext,E,o,w,D.renderToCanvas)}if(m.requiredReadBuffer){this.composerContext.clearReadBuffer=2}this.composerContext.clearReadBufferIfRequired(this.renderTargetPool,w);if(!(m instanceof g)){n=false}if(m.linkedComposerContexts){for(y=0;y<m.linkedComposerContexts.length;y++){m.linkedComposerContexts[y].releaseRenderTargets(this.renderTargetPool,w)}}}this.composerContext.selectResult(this.renderTargetPool,w);this.composerContext.releaseRenderTargets(this.renderTargetPool,w);this.composerContext.updateLinks(w);if(this.composerContext.afterRenderCB){this.composerContext.afterRenderCB(this.composerContext)}},setSize:function(n,m){if(this.composerContext){this.composerContext.setSize(n,m)}},setPreviousNormalDepthBuffer:function(m){this.prevNormalDepthBuffer=m},setPreviousColorBuffer:function(m){this.prevColorBuffer=m},insertCustomPassAfterPass:function(q,n){var r=this.passLists[this.passListIndex.main];var p=r.preCustomPasses;var m=r.postCustomPasses;var o;q.setCustomPass();if(n){o=p.indexOf(n);if(o>=0){p.splice(o+1,0,q)}else{o=m.indexOf(n);if(o>=0){m.splice(o+1,0,q)}else{throw new Error("Reference custom pass not found")}}}else{m.splice(0,0,q)}this.updateComposerContexts()},insertCustomPassBefore:function(q,n){var r=this.passLists[this.passListIndex.main];var p=r.preCustomPasses;var m=r.postCustomPasses;q.setCustomPass();var o;if(n){o=p.indexOf(n);if(o>=0){p.splice(o,0,q)}else{o=m.indexOf(n);if(o>=0){m.splice(o,0,q)}else{throw new Error("Reference custom pass not found")}}}else{p.push(q)}this.updateComposerContexts()},getPassList:function(m){return this.passLists[this.passListIndex[m]]},insertCustomPassBeforeNEW:function(r,n){if(!n){return false}if(!(r instanceof Array)){r=[r]}var q,p,t,o,s=false,m;if(typeof n==="string"||n instanceof String){t=this.getPassList(n);if(t.privateList){return false}a(t.preCustomPasses,t.preCustomPasses.length-1,r)}else{for(q=0;q<this.passLists.length&&!s;q++){t=this.passLists[q];m=[t.preCustomPasses,t.postCustomPasses];for(p=0;p<m.length&&!s;p++){o=m[p].indexOf(n);if(o>=0){a(m[p],o,r);s=true}}}if(!s){console.warn("ERROR: Reference custom pass not found");return false}}for(q=0;q<r.length;q++){r[q].context=this}this.updateComposerContexts();return true},insertCustomPassAfterNEW:function(r,n){if(!n){return false}if(!(r instanceof Array)){r=[r]}var q,p,t,o,s=false,m;if(typeof n==="string"||n instanceof String){t=this.getPassList(n);if(t.privateList){return false}a(t.postCustomPasses,0,r)}else{for(q=0;q<this.passLists.length&&!s;q++){t=this.passLists[q];m=[t.preCustomPasses,t.postCustomPasses];for(p=0;p<m.length&&!s;p++){o=m[p].indexOf(n);if(o>=0){a(m[p],o+1,r);s=true}}}if(!s){console.warn("ERROR: Reference custom pass not found");return false}}for(q=0;q<r.length;q++){r[q].context=this}this.updateComposerContexts();return true},removeCustomPassNEW:function(q){var p,o,n,r,s=q[0],t,m;for(p=0;p<this.passLists.length&&!r;p++){t=this.passLists[p];m=[t.preCustomPasses,t.postCustomPasses];for(o=0;o<m.length&&!r;o++){n=m[o].indexOf(s);if(n>=0){m[o].splice(n,q.length);r=true}}}this.updateComposerContexts()},enableCustomPassNEW:function(o){var n,p,m;for(n=0;n<o.length;n++){p=o[n];for(m=0;m<this.contexts.length;m++){this.contexts[m].enablePass(p,p.disabledByDefault?false:true)}}this.updateComposerContexts()},removePasses:function(q){var p,r,s,o,n,m;for(p=0;p<this.passLists.length&&!r;p++){s=this.passLists[p].passes;r=false;for(n=0;n<q.length;n++){o=s.indexOf(q[n]);if(o>=0){r=true;s[o]=null}}if(r){m=0;for(n=0;n<s.length;n++){if(s[n]){s[m]=s[n];m++}}s.length=m}}this.updateComposerContexts()},updateLinks:function(m){this.composerContext.updateLinks(m)},getPostEffectPasses:function(){var n="postEffects1";var p=this.passListIndex[n];var m=[];var o=0;for(o=p;o<this.passLists.length;o++){if(o>p){m=m.concat(this.passLists[o].preCustomPasses)}m=m.concat(this.passLists[o].passes);m=m.concat(this.passLists[o].postCustomPasses)}return m}};return e});define("Plugins/EffectComposer",["DS/Plugins/EffectComposer","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Plugins/EffectComposer");return b});define("DS/Effects/ESMEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/BloomShaders","DS/Plugins/ClearPass"],function(e,c,f,d,b,g){var a=c.extend({init:function(j,h){this._parent(j);this.renderer=j;this.rtPool=h;this.map=null;this.passBlurH=null;this.passBlurV=null;return this},setSize:function(j,h){this.width=parseInt(j);this.height=parseInt(h)},setInput:function(j){if(!j){return}this.map=j;if(this.composers[0]){this.composers[0].setSize(this.width,this.height);this.passBlurH.uniforms.invSize.value.set(1/this.width,1/this.height);this.passBlurV.uniforms.invSize.value.set(1/this.width,1/this.height)}else{var h=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");this.composers[0]=new f(this.renderer,h,this.rtPool);this.composers[0].composerContext.keepResult=true;this.passBlurH=new d(b.BlurH2);this.passBlurV=new d(b.BlurV);this.passBlurH.material.defines={LEVEL:3};this.passBlurV.material.defines={LEVEL:3};this.passBlurH.uniforms.invSize.value.set(1/this.width,1/this.height);this.passBlurV.uniforms.invSize.value.set(1/this.width,1/this.height);this.passBlurH.material.needsUpdate=true;this.passBlurV.material.needsUpdate=true;this.passBlurH.renderToScreen=false;this.passBlurV.renderToScreen=false;this.composers[0].addPass(this.passBlurH);this.composers[0].addPass(this.passBlurV)}this.passBlurH.uniforms.tDiffuse2.value=this.map},execute:function(){this.composers[0].render(0,undefined,undefined,"toto")},getResult:function(){return this.composers[0].getRenderResult("toto")}});return a});define("DS/Effects/BlurShadowEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/BloomShaders","DS/Plugins/ClearPass"],function(e,c,g,d,b,h){var f={uniforms:{tDiffuse2:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse2;","varying vec2 vUv;","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","void main() {","gl_FragColor = vec4(1.0);","float shadowDepth = unpackDepth(texture2D(tDiffuse2, vUv));","if (shadowDepth < 1.0) {","  gl_FragColor.x = 0.5;","}","}"].join("\n")};var a=c.extend({init:function(k,j){this._parent(k);this.renderer=k;this.rtPool=j;this.map=null;this.passShadow=null;this.passBlurH=null;this.passBlurV=null;return this},setSize:function(k,j){this.width=parseInt(k);this.height=parseInt(j)},setInput:function(k){if(!k){return}this.map=k;if(this.composers[0]){this.composers[0].setSize(this.width,this.height);this.passBlurH.uniforms.invSize.value.set(1/this.width,1/this.height);this.passBlurV.uniforms.invSize.value.set(1/this.width,1/this.height)}else{var j=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers[0]=new g(this.renderer,j,this.rtPool);this.composers[0].composerContext.keepResult=false;this.clearPass=new h("groundShadowClearPass");this.passShadow=new d(f);this.passBlurH=new d(b.BlurH);this.passBlurV=new d(b.BlurV);this.passBlurH.material.defines={LEVEL:5};this.passBlurV.material.defines={LEVEL:5};this.passBlurH.uniforms.invSize.value.set(1/this.width,1/this.height);this.passBlurV.uniforms.invSize.value.set(1/this.width,1/this.height);this.passBlurH.material.needsUpdate=true;this.passBlurV.material.needsUpdate=true;this.passBlurH.renderToScreen=false;this.passBlurV.renderToScreen=false;this.composers[0].addPass(this.clearPass);this.composers[0].addPass(this.passShadow);this.composers[0].addPass(this.passBlurH);this.composers[0].addPass(this.passBlurV);this.composers[0].composerContext.keepResult=true;this.composers[0].composerContext.setPassClear(this.clearPass,true,new e.Color(16777215),1)}this.passShadow.uniforms.tDiffuse2.value=this.map},execute:function(){this.composers[0].render(0,undefined,undefined,"toto")},getResult:function(){return this.composers[0].getRenderResult("toto")}});return a});define("DS/Shaders/EncodeHDRShader",["DS/Visualization/ThreeJS_DS"],function(b){var a={uniforms:{map:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D map;","varying vec2 vUv;","void main() {","vec3 color = texture2D(map, vUv).rgb;","float value = max(color.r, max(color.g, color.b));","int exponent = 0;","float mantissa = 0.0;","if (value > 1.0) {","for (int i = 1; i <= 127; i++) {","value /= 2.0;","exponent++;","if (value < 1.0) { break; }","}","} else if (value < 1.0) {","int j = 1;","for (int i = 1; i <= 129; i++) {","value *= 2.0;","exponent--;","if (value > 1.0) { j = 0; break; }","}","value /= 2.0;","exponent++;","if (j > 0) {","color = vec3(0.0);","exponent = 0;","}","}","gl_FragColor = vec4(color * pow(2.0, float(-exponent)), float(exponent + 128) / 255.0);","}"].join("\n")};return a});define("Shaders/EncodeHDRShader",["DS/Shaders/EncodeHDRShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/EncodeHDRShader");return b});define("DS/VisuDataAccess/Ox4TypeHelper",["DS/Visualization/Utils","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(c,l){var b=function(q){if(typeof(q.hostname)==="undefined"){console.log("Ox4TypeHelper:No Hostname in ServerDefinition");return null}var o=q.hostname;if(typeof(q.rooturi)==="undefined"){console.log("Ox4TypeHelper:No RootUri in ServerDefinition");return null}var s=q.rooturi;var r="http://";if(typeof(q.protocol)!="undefined"){if(q.protocol==="https"){r="https://"}}var n=-1;if(typeof(q.port)!="undefined"){n=q.port}var p=r+o;if(n!=-1){p+=":"+n}p+="/"+s+"/i3dx/services/xmql";return p};var f=function(n){var o='<?xml version="1.0" encoding="utf-8"?>\n';o+='<executeSequence xmlns="http://www.3ds.com/xmql/query">\n';o+="\t<execute>\n";if(n){o+="\t\t<function>get_parents_rel_type</function>\n"}else{o+="\t\t<function>get_parents_bus_type</function>\n"}o+="\t\t<version>1.0.0</version>\n";o+="\t\t<params>\n";o+='\t\t\t<param name="type">%1</param>\n';o+="\t\t</params>\n";o+="\t</execute>\n";o+="</executeSequence>\n";return o};var g=null;var d=f(false);var h=f(true);var e=function(q,o,u){var r=new l();var t=o?h:d;t=t.replace("%1",q);if(u!==null){var n={data:t,type:"json",headers:{"Content-type":"application/xml",Accept:"application/json"},onComplete:function(w){var v=[];try{v=JSON.parse(w.xmql_response.body.result[2].output);if(!Array.isArray(v)){v=[]}}catch(x){v=[]}u(v)}};r.executePostHttpRequestWithOptions(g,n)}else{var p=[];try{p=JSON.parse(r.executeSyncPostHttpRequest(g,"application/xml",t));if(!Array.isArray(p)){p=[]}}catch(s){p=[]}return p}};var m=function(q,p,r){var n=r;if(n===undefined){n=null}if(typeof q!=="string"){if(n!==null){n([])}else{return[]}}else{if(a[p].hasOwnProperty(q)){if(null!==n){n(a[p][q])}else{return a[p][q]}}else{if(null!==n){e(q,p==="rel",function(s){a[p][q]=s;while(s.length>0){s=s.slice(0);a[p][s.shift()]=s}n(a[p][q])})}else{var o=e(q,p==="rel",null);a[p][q]=o;while(o.length>0){o=o.slice(0);a[p][o.shift()]=o}console.warn("[Ox4TypeHelper]: Synchronous server call is deprecated, switch to asynchronous version");return a[p][q]}}}};var j=function(o,n){return a[o].hasOwnProperty(n)};var a={bus:{},rel:{}};var k={IsInit:function(){return g!=null},Init:function(p,q,o){var n={requiredAuth:q,proxyurl:o};if(n.requiredAuth===undefined){n.requiredAuth=null}if(n.proxyurl===undefined){n.proxyurl=null}c.setProxyFromSpec(n,l);g=b(p)},InitWithUrl:function(o,r,q,p){var n={requiredAuth:q,proxyurl:p};if(n.requiredAuth===undefined){n.requiredAuth=null}if(n.proxyurl===undefined){n.proxyurl=null}c.setProxyFromSpec(n,l);g=o+"/i3dx/services/xmql";if(typeof r==="string"){g+="?tenant="+r}},RegisterParentsTypes:function(p,s){var o=p;var q=function(u,w,t){var v=u.pop();while(v&&j(w,v)){v=u.pop()}if(v){m(v,w,function(){q(u,w,t)})}else{t()}};var r=0;var n=function(){if(++r==2){s()}};q(p.bus,"bus",n);q(p.rel,"rel",n)},GetParentsBusType:function(n,o){return m(n,"bus",o)},GetParentsRelType:function(n,o){return m(n,"rel",o)},IsBusA:function(p,r,q){var n=q;if(n===undefined){n=null}if(typeof p!=="string"||typeof r!=="string"){if(n!==null){n(false)}else{return false}}else{if(p===r){if(n!==null){n(true)}else{return true}}else{if(n!==null){this.GetParentsBusType(p,function(s){n(s.indexOf(r)>=0)})}else{var o=this.GetParentsBusType(p);return o.indexOf(r)>=0}}}},IsRelA:function(p,r,q){var n=q;if(n===undefined){n=null}if(typeof p!=="string"||typeof r!=="string"){if(n!==null){n(false)}else{return false}}else{if(p===r){if(n!==null){n(true)}else{return true}}else{if(n!==null){this.GetParentsRelType(p,function(s){n(s.indexOf(r)>=0)})}else{var o=this.GetParentsRelType(p);return o.indexOf(r)>=0}}}}};return k});define("VisuDataAccess/Ox4TypeHelper",["DS/VisuDataAccess/Ox4TypeHelper","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/Ox4TypeHelper");return b});define("DS/Gestures/HoldGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture","DS/WebRecordEnabler/Adapter"],function(c,b,d,e){var a=d.extend({init:function(){this._parent("Hold");this.priority=10;this.identifier=null;this.maxTime=THREEDS.VisuEventsManager.getHoldTime();this.maxDistance=10;this.timer=null;this.startTime=0;this.endTime=0;return this},detect:function(j){this._parent(j);var h=this;switch(this.state){case d.State.INIT:var g=THREEDS.VisuEventsManager.getTouchEventsByStates([b.State.BEGIN,b.State.MOVE,b.State.IDLE]);if(g.length===1){this.resetTimer();g=THREEDS.VisuEventsManager.getTouchEventsByStates([b.State.BEGIN],this.view);if(g.length===1){this.identifier=g[0].identifier;if(!e.isReplaying()){this.timer=setTimeout(function(){h.events=[g[0]];h.endTime=new Date().getTime();h.changeState(d.State.OK);h.execute(true)},this.maxTime)}this.startTime=g[0].startTime;this.changeState(d.State.BEGIN)}}break;case d.State.BEGIN:var g=THREEDS.VisuEventsManager.getTouchEventsByStates([b.State.BEGIN,b.State.MOVE,b.State.IDLE]);var f=THREEDS.VisuEventsManager.getTouchEventById(this.identifier);if((g.length!==1)||(f===null)||(f.state===b.State.END)){this.resetTimer();this.changeState(d.State.KO)}else{if(f.state===b.State.MOVE){if(f.offsetPosition.length()>this.maxDistance){this.resetTimer();this.changeState(d.State.KO)}}}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}},resetTimer:function(){if(this.timer!==null){clearTimeout(this.timer);this.timer=null}},getTouchPoint:function(){if(this.getEvents().length>0){var f=this.getEvents()[0].getCurrentPosition();return f}return null},getElapsedTime:function(){if(this.getEvents().length>0){var f=this.endTime-this.startTime;return f}return null}});return UWA.namespace("THREEDS/Gestures/HoldGesture",a)});define("Gestures/HoldGesture",["DS/Gestures/HoldGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/HoldGesture");return b});define("DS/Shaders/DisplayIrradianceMapShader",["DS/Visualization/ThreeJS_DS"],function(b){var a={uniforms:{tDiffuse1:{type:"t",value:null},offset1:{type:"v2",value:new b.Vector2(0,0.5)},scale1:{type:"f",value:0.5},},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse1;","uniform vec2 offset1;","uniform float scale1;","varying vec2 vUv;","void main() {","gl_FragColor = vec4(0.0);","vec2 vUv2 = (vUv - offset1) / scale1;","if (vUv2.x > 0.0 && vUv2.y > 0.0 && vUv2.x < 1.0 && vUv2.y < 1.0) {","    vec3 color = texture2D( tDiffuse1, vUv2 ).xyz;","    color = pow(color, vec3(1.0 / 2.2));","    gl_FragColor = vec4(color, 1.0); return;","}","}"].join("\n")};return a});define("Shaders/DisplayIrradianceMapShader",["DS/Shaders/DisplayIrradianceMapShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/DisplayIrradianceMapShader");return b});define("DS/Shaders/MultiplicativeBlendShader",["DS/Visualization/ThreeJS_DS"],function(a){var b={defines:{POSTPRO:1},uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},strength:{type:"f",value:0.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",a._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#if (POSTPRO == 1)","uniform sampler2D tDiffuse;","#endif","uniform sampler2D tDiffuse2;","uniform float strength;","varying vec2 vUv;","void main() {","float color2 = texture2D( tDiffuse2, vUv ).x;","float mult = clamp((color2 - strength)/(1.0 -strength), 0.0, 1.0);","mult *= mult;","#if (POSTPRO == 1)","mult *= mult;","vec4 color  = texture2D(  tDiffuse, vUv );","gl_FragColor = vec4(color.xyz * mult, color.a);","#else","gl_FragColor = vec4(vec3(0.0), 1.0 - mult);","#endif","}"].join("\n")};return b});define("Shaders/MultiplicativeBlendShader",["DS/Shaders/MultiplicativeBlendShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/MultiplicativeBlendShader");return b});define("DS/VisuUnstreamers/FileInZipStreamObject",["DS/VisuUnstreamers/StreamObject","WebappsUtils/WebappsUtils","DS/ZipJS/zip-fs"],function(b,f,d){var e=2;var g=0;var a=[];var c=b.extend({init:function(h,j){this._parent(h,j);d.workerScriptsPath=f.getWebappsBaseUrl()+"ZipJS/";return this},open:function(){},close:function(){},read:function(m,j){var l=this;var n=function(){if(!l.blob.waitingEntries){l.blob.waitingEntries=[]}l.blob.waitingEntries.push({cb:m,type:j,context:l})};if(this.blob.zipEntries===undefined){this.blob.zipEntries="Loading";n();var h=new d.fs.FS();h.importBlob(this.blob,function(){l.blob.zipEntries=h;for(var p=0;p<l.blob.waitingEntries.length;p++){var o=l.blob.waitingEntries[p];o.context.read(o.cb,o.type)}})}else{if(this.blob.zipEntries==="Loading"){n()}else{var k=this.blob.zipEntries.find(this.filename);if(k){this._unzipData(k,j,m)}else{console.warn({msg:"Missing "+this.filename+" in the zip.",zip:this.blob.zipEntries});if(m){m(null)}}}}},readAsArrayBuffer:function(h){this.read(h,"arraybuffer")},readAsBlob:function(h){this.read(h,"blob")},readAsText:function(h){this.read(h,"text")},readAsXML:function(h){this.read(h,"xml")},_unzipData:function(l,h,k){var j=this;if(g<e){g++;if(h==="text"||h==="xml"){l.getText(function(m){j._popUnzipItem();if(k){if(h==="text"){k(m.target.result)}else{k(new DOMParser().parseFromString(m.target.result,"text/xml"))}}})}else{if(h==="arraybuffer"||h==="blob"){l.getBlob("text/plain",function(n){j._popUnzipItem();if(k){if(h==="arraybuffer"){var m=new FileReader();m.onload=function(o){k(o.target.result)};m.readAsArrayBuffer(n)}else{k(n)}}})}else{console.error("Unknown type to read : "+h)}}}else{a.push({entry:l,type:h,onsuccess:k})}},_popUnzipItem:function(){g--;if(a.length>0){var h=a[0];this._unzipData(h.entry,h.type,h.onsuccess);a.splice(0,1)}}});return UWA.namespace("THREEDS/FileInZipStreamObject",c)});define("VisuUnstreamers/FileInZipStreamObject",["DS/VisuUnstreamers/FileInZipStreamObject","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuUnstreamers/FileInZipStreamObject");return b});define("DS/Gestures/MouseDownGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,a,d){var b=d.extend({init:function(e){this._parent(a.printMouseButton(e)+"MouseDown");this.priority=0;this.button=e;return this},detect:function(g){this._parent(g);switch(this.state){case d.State.INIT:var f=THREEDS.VisuEventsManager.getMouseEventsByStates([a.State.BEGIN],this.button,this.view);if(f.length){var e=f[0];this.events=[e];this.changeState(d.State.OK);return}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/MouseDownGesture",b)});define("Gestures/MouseDownGesture",["DS/Gestures/MouseDownGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/MouseDownGesture");return b});define("DS/Animation/AnimationPath",["DS/Animation/ANIM"],function(a){var b=function(d,c,e){this._startValue=d;this._endValue=c;this._duration=e;this._easingCurve=function(f){a.assert(0<=f&&f<=1);return f};this._interpolator=function(f,g,h){return g+(h-g)*f}};b.prototype.startValue=function(){return this._startValue};b.prototype.setStartValue=function(c){this._startValue=c};b.prototype.endValue=function(){return this._endValue};b.prototype.setEndValue=function(c){this._endValue=c};b.prototype.duration=function(){return this._duration};b.prototype.setDuration=function(c){this._duration=c};b.prototype.easingCurve=function(){return this._easingCurve};b.prototype.setEasingCurve=function(c){this._easingCurve=c};b.prototype.interpolator=function(){return this._interpolator};b.prototype.setInterpolator=function(c){this._interpolator=c};b.prototype.valueAt=function(f){a.assert(0<=f&&f<=this._duration);var c=f/this._duration;var d=this._easingCurve(c);return this._interpolator(d,this._startValue,this._endValue)};return b});define("Animation/AnimationPath",["DS/Animation/AnimationPath","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Animation/AnimationPath");return b});define("DS/Shaders/ReplaceBlendShader",["DS/Visualization/ThreeJS_DS"],function(b){var a={uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","varying vec2 vUv;","void main() {","vec3 color  = texture2D(  tDiffuse, vUv ).xyz;","vec4 color2 = texture2D( tDiffuse2, vUv );","gl_FragColor = vec4((1.0 - color2.a) * color + color2.a * color2.xyz, 1.0);","}"].join("\n")};return a});define("Shaders/ReplaceBlendShader",["DS/Shaders/ReplaceBlendShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/ReplaceBlendShader");return b});define("DS/Gestures/EditGesture",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture","DS/WebRecordEnabler/Adapter"],function(b,d,c,e,f){var a=e.extend({init:function(){this._parent("Edit");this.priority=10;this.identifier=null;this.maxTimeTouch=THREEDS.VisuEventsManager.getHoldTime();this.maxTimeMouse=THREEDS.VisuEventsManager.getHoldTime();this.maxDistance=10;this.timer=null;this._type=-1;this.event=null;return this},detect:function(n){this._parent(n);var m=this;var l=THREEDS.VisuEventsManager.getTouchEventsByStates([c.State.BEGIN,c.State.MOVE,c.State.IDLE]);var j=THREEDS.VisuEventsManager.getMouseEvents(null,this.view);var k=null;switch(this.state){case e.State.INIT:if(l.length===1||this.onlyLeftMouse(j)){this.resetTimer();if(l.length===1){k=THREEDS.VisuEventsManager.getTouchEventsByStates([c.State.BEGIN],this.view);this._type=1}else{if(j.length){k=THREEDS.VisuEventsManager.getMouseEventsByStates([c.State.BEGIN],0,this.view);this._type=0}}if(k&&k.length===1){this.resetTimer();var g=(this._type===1)?this.maxTimeTouch:this.maxTimeMouse;this.identifier=k[0].identifier;this.event=k[0];if(!g){this.events=[k[0]];this.changeState(e.State.OK);this.execute(true);this._type=-1}else{if(!f.isReplaying()){this.timer=setTimeout(function(){m.events=[k[0]];m.changeState(e.State.OK);m.execute(true);m._type=-1},g)}this.whenBegin()}}else{this._type=-1}}break;case e.State.BEGIN:var h=null;if(this._type===1){h=THREEDS.VisuEventsManager.getTouchEventById(this.identifier)}else{if(this._type===0){h=this.event}}if((this._type===1&&l.length!==1)||(this._type===0&&!this.onlyLeftMouse(j))||(h===null)||(h.state===c.State.END)){this.whenKO()}else{if(h.state===c.State.MOVE){if(h.offsetPosition.length()>this.maxDistance){this.whenKO()}}}break;case e.State.KO:case e.State.OK:case e.State.CANCEL:this.changeState(e.State.INIT);break;default:break}},onlyLeftMouse:function(g){for(var h=0;h<g.length;h++){if((g[h].button!==0)&&(g[h].button!==-1)){return false}}return true},setTimerTouch:function(g){this.maxTimeTouch=g},setTimerMouse:function(g){this.maxTimeMouse=g},resetTimer:function(){if(this.timer!==null){clearTimeout(this.timer);this.timer=null;this._type=-1}},whenBegin:function(){this.changeState(e.State.BEGIN);var g={eventChannel:"/VISU/",eventType:"@onEditEventBegin",eventID:this.id,from:this.currentEvent,gesture:this};b.publish({event:"/VISU/onEditEventBegin",data:g})},whenKO:function(){this.resetTimer();this.changeState(e.State.KO);var g={eventChannel:"/VISU/",eventType:"@onEditEventKO",eventID:this.id,from:this.currentEvent,gesture:this};b.publish({event:"/VISU/onEditEventKO",data:g})}});return UWA.namespace("THREEDS/Gestures/EditGesture",a)});define("Gestures/EditGesture",["DS/Gestures/EditGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/EditGesture");return b});define("DS/Visualization/MaterialApplication",["DS/Visualization/ThreeJS_DS"],function(a){a.MaterialLayerUndefined=Number.MAX_SAFE_INTEGER||(Math.pow(2,53)-1);a.MaterialLayerMax=a.MaterialLayerUndefined-1;var b=function(c){this.isMatApp=true;this._mergeWithGAS=false;this._material=null;this._materialGeomFace=null;this._materialLine=null;this._materialPoint=null;this._inheritance=1;this._layer=a.MaterialLayerMax;this.setParameters(c)};b.prototype.copy=function(c){this._mergeWithGAS=c._mergeWithGAS;this._material=c._material;this._materialGeomFace=c._materialGeomFace;this._materialLine=c._materialLine;this._materialPoint=c._materialPoint;this._inheritance=c._inheritance;this._layer=c._layer};b.prototype.clone=function(){return new b({faceMaterial:this._material,geometricalFaceMaterial:this._materialGeomFace,lineMaterial:this._materialLine,pointMaterial:this._materialPoint,inheritance:this._inheritance,layer:this._layer,mergeWithGAS:this._mergeWithGAS})};b.prototype.setParameters=function(c){if(c.faceMaterial){this._material=c.faceMaterial}if(c.geometricalFaceMaterial){this._materialGeomFace=c.geometricalFaceMaterial}if(c.lineMaterial){this._materialLine=c.lineMaterial}if(c.pointMaterial){this._materialPoint=c.pointMaterial}if(c.inheritance!==undefined){this._inheritance=c.inheritance}if(c.layer!==undefined){this._layer=c.layer}if(c.mergeWithGAS!==undefined){this._mergeWithGAS=c.mergeWithGAS}};b.prototype._getMaterialFromGLType=function(c,d){if(c===4){if((d===a.GeomTypeEnum.FACE)&&this._materialGeomFace){return this._materialGeomFace}else{return this._material}}else{if(c===1){return this._materialLine}}return this._materialPoint};b.prototype.solveInheritance=function(c){if(!c){return this}if((this._inheritance!==0)&&((this._layer<c._layer)||((this._layer===c._layer)&&((this._layer<a.MaterialLayerMax)||(this._inheritance===2||(this._inheritance===1&&c._inheritance===0)))))){return this}else{return c}};b.prototype.getMaterial=function(e,c,d){if(!e){return this._getMaterialFromGLType(c,d)}if((this._inheritance!==0)&&((this._layer<e._layer)||((this._layer===e._layer)&&((this._layer<a.MaterialLayerMax)||(this._inheritance===2||(this._inheritance===1&&e._inheritance===0)))))){return this._getMaterialFromGLType(c,d)}else{return e._getMaterialFromGLType(c,d)}};return b});define("DS/Shaders/SSAO3Shader",["DS/Visualization/ThreeJS_DS"],function(f){var g=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;var e={computeVertexPositionVS:["vec4 normalDepth = texture2D( tNormalDepth, vUv );",window.webVRBypass?"normalDepth.xy = vec2(-1.0,-1.0)+2.0*normalDepth.xy;":"","float z = normalDepth.w;","if ( z < 0.1 ) return;","vec2 xy = vUv * 2.0 - 1.0;","vec4 vertexPositionProjected = vec4(xy, 2.0 * z - 1.0, 1.0);","vec4 vertexPositionVS = realProjectionMatrixInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","vertexPositionVS.w = 1.0;"].join("\n"),computeNormal:["vec3 normal = vec3(0.0, 0.0, 1.0);","if (dot(normalDepth.xy, normalDepth.xy) > 0.000001) {","   normal.z = 2.0 * dot(normalDepth.xy, normalDepth.xy) - 1.0;","   normal.xy = normalize(normalDepth.xy) * sqrt(1.0 - normal.z * normal.z);","}"].join("\n")},b={defines:{NB_SAMPLES:24,INV_NB_SAMPLES:1/72,TAU:"61.0"},uniforms:{tNormalDepth:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new f.Matrix4()},screenRatio:{type:"f",value:0.5},screenSize:{type:"v2",value:new f.Vector2(800,600)},invSize:{type:"v2",value:new f.Vector2(1/800,1/600)},radius:{type:"f",value:0.5},thresholdAngle:{type:"f",value:0.12},maxRadiusInPixels:{type:"f",value:30},prevMap:{type:"t",value:null},numIteration:{type:"i",value:0}},vertexShader:["varying vec2 vUv;","void main() {","  vUv = uv;",f._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform mat4 realProjectionMatrixInverse;","uniform float screenRatio;","uniform vec2 screenSize;","uniform vec2 invSize;","uniform float radius;","uniform float thresholdAngle;","uniform float maxRadiusInPixels;","uniform int numIteration;","uniform sampler2D prevMap;","uniform sampler2D tNormalDepth;","varying vec2 vUv;","const float PI = 3.14159265358979323846264;","const float one_over_tan_225 = 2.414213562373095;","const float sigma = 0.25;","float random(vec3 scale, float seed) {","  return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","float Random1D(float seed) {","return random(vec3(12.9898, 78.233, 151.7182), seed);","}","void main() {","  gl_FragColor = vec4(1.0);",e.computeVertexPositionVS,e.computeNormal,"  vec3 origin = vertexPositionVS.xyz;","  float projRadius = - 0.5 * one_over_tan_225 * radius / origin.z;","  float scaleRadius = min(1.0, maxRadiusInPixels * invSize.y / projRadius);","  projRadius *= scaleRadius;","  float newRadius = scaleRadius * radius;","  float newRadius2 = newRadius * newRadius;","  float oneOverRadius2 = 1.0 / (newRadius2 + 0.0001);","  float maxInvSize = max(invSize.x, invSize.y);","  float occlusion = 0.0;","  float phi = 100.0 * Random1D(vUv.x + vUv.y);","  for (int i = 0; i < NB_SAMPLES; ++i) {",g?"    if (i >= NB_SAMPLES) { continue; }":"","    float alpha = (float(3 * i + numIteration) + 0.5) * INV_NB_SAMPLES;","    float h = max(maxInvSize, projRadius * alpha);","    float theta = 2.0 * PI * alpha * TAU + phi;","    vec2 u = vec2(screenRatio * cos(theta), sin(theta));","    vec2 uvSample = vUv + h * u;","    uvSample = floor(screenSize * uvSample) + vec2(0.5);","    uvSample *= invSize;","    float z = texture2D(tNormalDepth, uvSample).w;","    vec2 inScreen = step(vec2(0.0), uvSample) * step(vec2(-1.0), -uvSample) * step(0.0, z);","    vec4 posProjected = vec4(uvSample * 2.0 - 1.0, 2.0 * z - 1.0, 1.0);","    vec4 posVS = realProjectionMatrixInverse * posProjected;","    posVS.xyz /= posVS.w;","    vec3 Vi = posVS.xyz - origin;","    occlusion += inScreen.x * inScreen.y * max(0.0, dot(normalize(Vi), normal) - thresholdAngle) * max(0.0, newRadius2 - dot(Vi, Vi)) * oneOverRadius2;","  }","  occlusion = max(0.0, 1.0 - 2.0 * sigma * (2.0 - 1.0 * abs(normal.z)) * occlusion * 3.0 * INV_NB_SAMPLES);","  float prevAO = texture2D( prevMap, vUv ).r;","  gl_FragColor = vec4(vec3((prevAO * float(numIteration) + occlusion) / (float(numIteration) + 1.0)), 1.0);","}"].join("\n")},a={uniforms:{tNormalDepth:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new f.Matrix4()},screenRatio:{type:"f",value:0.5},nbSamples:{type:"i",value:12},tau:{type:"f",value:7},radius:{type:"f",value:0.5},thresholdAngle:{type:"f",value:0.071},screenSize:{type:"v2",value:new f.Vector2(800,600)},invSize:{type:"v2",value:new f.Vector2(1/800,1/600)},maxRadiusInPixels:{type:"f",value:30}},vertexShader:["varying vec2 vUv;","void main() {","  vUv = uv;",f._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform mat4 realProjectionMatrixInverse;","uniform float screenRatio;","uniform vec2 screenSize;","uniform vec2 invSize;","uniform float radius;","uniform int nbSamples;","uniform float tau;","uniform float thresholdAngle;","uniform float maxRadiusInPixels;","uniform sampler2D tNormalDepth;","varying vec2 vUv;","const int kernelSize = 32;","const float PI = 3.14159265358979323846264;","const float one_over_tan_225 = 2.414213562373095;","const float sigma = 0.25;","float random(vec3 scale, float seed) {","  return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","float Random1D(float seed) {","return random(vec3(12.9898, 78.233, 151.7182), seed);","}","void main() {","  gl_FragColor = vec4(1.0);",e.computeVertexPositionVS,e.computeNormal,"  vec3 origin = vertexPositionVS.xyz;","  float projRadius = - 0.5 * one_over_tan_225 * radius / origin.z;","  float scaleRadius = min(1.0, maxRadiusInPixels * invSize.y / projRadius);","  projRadius *= scaleRadius;","  float newRadius = scaleRadius * radius;","  float newRadius2 = newRadius * newRadius;","  float oneOverRadius2 = 1.0 / (newRadius2 + 0.0001);","  float maxInvSize = max(invSize.x, invSize.y);","  float occlusion = 0.0;","  float phi = 100.0 * Random1D(vUv.x + vUv.y);","  for (int i = 0; i < kernelSize; ++i) {","    if (i >= nbSamples) { continue; }","    float alpha = (float(i) + 0.5) / float(nbSamples);","    float h = max(maxInvSize, projRadius * alpha);","    float theta = 2.0 * PI * alpha * tau + phi;","    vec2 u = vec2(screenRatio * cos(theta), sin(theta));","    vec2 uvSample = vUv + h * u;","    uvSample = floor(screenSize * uvSample) + vec2(0.5);","    uvSample *= invSize;","    float z = texture2D(tNormalDepth, uvSample).w;","    vec2 inScreen = step(vec2(0.0), uvSample) * step(vec2(-1.0), -uvSample) * step(0.0, z);","    vec4 posProjected = vec4(uvSample * 2.0 - 1.0, 2.0 * z - 1.0, 1.0);","    vec4 posVS = realProjectionMatrixInverse * posProjected;","    posVS.xyz /= posVS.w;","    vec3 Vi = posVS.xyz - origin;","    occlusion += inScreen.x * inScreen.y * max(0.0, dot(normalize(Vi), normal) - thresholdAngle) * max(0.0, newRadius2 - dot(Vi, Vi)) * oneOverRadius2;","  }","  occlusion = max(0.0, 1.0 - 2.0 * sigma * (2.0 - 1.0 * abs(normal.z)) * occlusion / float(nbSamples));","  gl_FragColor = vec4(vec3(occlusion), 1.0);","}"].join("\n")},d={uniforms:{tNormalDepth:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new f.Matrix4()},screenRatio:{type:"f",value:0.5},nbSamples:{type:"i",value:12},tau:{type:"f",value:7},radius:{type:"f",value:0.5},thresholdAngle:{type:"f",value:0.071},screenSize:{type:"v2",value:new f.Vector2(800,600)},invSize:{type:"v2",value:new f.Vector2(1/800,1/600)},maxRadiusInPixels:{type:"f",value:30}},vertexShader:["varying vec2 vUv;","void main() {","  vUv = uv;",f._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform mat4 realProjectionMatrixInverse;","uniform float screenRatio;","uniform vec2 screenSize;","uniform vec2 invSize;","uniform float radius;","uniform int nbSamples;","uniform float tau;","uniform float thresholdAngle;","uniform float maxRadiusInPixels;","uniform sampler2D tNormalDepth;","varying vec2 vUv;","const int nbDirections = 6;","const int nbSteps = 4;","const float invNbDirections = 1.0 / float(nbDirections);","const float invNbSteps = 1.0 / float(nbSteps);","const float PI = 3.14159265358979323846264;","const float one_over_tan_225 = 2.414213562373095;","const float sigma = 0.25;","float random(vec3 scale, float seed) {","  return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","float Random1D(float seed) {","return random(vec3(12.9898, 78.233, 151.7182), seed);","}","vec3 minDiff(vec3 P, vec3 Pr, vec3 Pl) {","vec3 V1 = Pr - P;","vec3 V2 = P - Pl;","return (dot(V1, V1) < dot(V2, V2)) ? V1 : V2;","}","float invLength(vec2 v) {","return inversesqrt(dot(v, v));","}","vec3 getViewPosition(vec2 uv) {","vec4 normalDepth = texture2D(tNormalDepth, uv);","float z = normalDepth.w;","vec2 xy = uv * 2.0 - 1.0;","vec4 vertexPositionProjected = vec4(xy, 2.0 * z - 1.0, 1.0);","vec4 vertexPositionVS = realProjectionMatrixInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","return vertexPositionVS.xyz;","}","void main() {","  gl_FragColor = vec4(1.0);","  vec3 origin = getViewPosition(vUv);","  vec3 Pr = getViewPosition(vUv + vec2( invSize.x, 0.0));","  vec3 Pl = getViewPosition(vUv + vec2(-invSize.x, 0.0));","  vec3 Pt = getViewPosition(vUv + vec2(0.0,  invSize.y));","  vec3 Pb = getViewPosition(vUv + vec2(0.0, -invSize.y));","  vec3 dPdu = minDiff(origin, Pr, Pl);","  vec3 dPdv = minDiff(origin, Pt, Pb) * screenRatio;","  float projRadius = - 0.5 * one_over_tan_225 * radius / origin.z;","  float maxScaleRadius = min(1.0, maxRadiusInPixels * invSize.y / projRadius);","  float minScaleRadius = max(1.0, float(nbSteps) * invSize.y / projRadius);","  float scaleRadius = minScaleRadius * maxScaleRadius;","  projRadius *= scaleRadius;","  float newRadius = scaleRadius * radius;","  float newRadius2 = newRadius * newRadius;","  float oneOverRadius2 = 1.0 / (newRadius2 + 0.0001);","  float h = projRadius * invNbSteps;","  float occlusion = 0.0;","  float phi = 100.0 * Random1D(vUv.x + vUv.y);","  float dTheta = 2.0 * PI * invNbDirections;","  for (int j = 0; j < nbDirections; j++) {","    float theta = dTheta * float(j) + phi;","    vec2 duv = h * vec2(screenRatio * cos(theta), sin(theta));","    vec3 T = duv.x * dPdu + duv.y * dPdv;","    float tanH = T.z * invLength(T.xy) + tan(30.0 * PI / 180.0);","    float sinH = tanH * inversesqrt(tanH * tanH + 1.0);","    vec2 uvSample = vUv;","    float tanS;","    vec3 S;","    float d2;","    for (int i = 0; i < nbSteps; ++i) {","      uvSample += duv;","      S = getViewPosition(uvSample);","      tanS =(S.z - origin.z) * invLength(S.xy - origin.xy);","      d2 = dot(S - origin, S - origin);","      if (d2 < newRadius2 && tanS > tanH) {","        float sinS = tanS * inversesqrt(tanS * tanS + 1.0);","        occlusion += (1.0 - d2 * oneOverRadius2) * (sinS - sinH);","        tanH = tanS;","        sinH = sinS;","      }","    }","  }","  gl_FragColor = vec4(vec3(1.0 - 0.5 * occlusion * invNbDirections), 1.0);","}"].join("\n")},c={uniforms:{tNormalDepth:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new f.Matrix4()},screenMin:{type:"f",value:1000},screenRatio:{type:"f",value:0.5},nbSamples:{type:"i",value:12},tau:{type:"f",value:7},radius:{type:"f",value:0.5},thresholdAngle:{type:"f",value:0.071}},vertexShader:["varying vec2 vUv;","void main() {","  vUv = uv;",f._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform mat4 realProjectionMatrixInverse;","uniform float screenMin;","uniform float screenRatio;","uniform float radius;","uniform int nbSamples;","uniform float tau;","uniform float thresholdAngle;","uniform sampler2D tNormalDepth;","varying vec2 vUv;","const int kernelSize = 32;","const float PI = 3.14159265358979323846264;","const float one_over_tan_225 = 2.414213562373095;","const float sigma = 0.25;","float random(vec3 scale, float seed) {","  return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","float Random1D(float seed) {","return random(vec3(12.9898, 78.233, 151.7182), seed);","}","void main() {","  gl_FragColor = vec4(1.0);",e.computeVertexPositionVS,e.computeNormal,"  vec3 origin = vertexPositionVS.xyz;","  float projRadius = - 0.5 * one_over_tan_225 * radius / origin.z;","  float minDelta = projRadius / float(nbSamples);","  float scaleRadius = max(1.0, (8.0 / screenMin) / minDelta);","  projRadius *= scaleRadius;","  float newRadius = scaleRadius * radius;","  float newRadius2 = newRadius * newRadius;","  float occlusion = 0.0;","  float phi = 100.0 * Random1D(vUv.x + vUv.y);","  for (int i = 0; i < kernelSize; ++i) {","    if (i >= nbSamples) { continue; }","    float alpha = (float(i) + 0.5) / float(nbSamples);","    float h = projRadius * alpha * 0.5;","    float theta = 2.0 * PI * alpha * tau + phi;","    vec2 u = vec2(screenRatio * cos(theta), sin(theta));","    vec2 uvSample = vUv + h * u;","    float z = texture2D(tNormalDepth, uvSample).w;","    bvec4 inScreen4 = bvec4(uvSample.x >= 0.0, uvSample.x <= 1.0, uvSample.y >= 0.0, uvSample.y <= 1.0);","    bool inScreen = all(inScreen4);","    if (all(bvec2(inScreen, z > 0.0))) {","      vec4 posProjected = vec4(uvSample * 2.0 - 1.0, 2.0 * z - 1.0, 1.0);","      vec4 posVS = realProjectionMatrixInverse * posProjected;","      posVS.xyz /= posVS.w;","      vec3 Vi = posVS.xyz - origin;","      occlusion += max(0.0, dot(normalize(Vi), normal) - thresholdAngle) * max(0.0, newRadius2 - dot(Vi, Vi)) / (newRadius2 + 0.0001);","    }","  }","  occlusion = max(0.0, 1.0 - 2.0 * sigma * (2.0 - 1.0 * abs(normal.z)) * occlusion / float(nbSamples));","  gl_FragColor = vec4(vec3(occlusion), 1.0);","}"].join("\n")};return{SSAO_V0:c,SSAO_V1:b,SSAO_V2:a,SSAO_HBAO:d}});define("Shaders/SSAO3Shader",["DS/Shaders/SSAO3Shader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/SSAO3Shader");return b});define("DS/Gestures/MouseWheelGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,a,d){var b=d.extend({init:function(){this._parent("MouseWheel");this.priority=0;this.delta=0;return this},detect:function(g){this._parent(g);switch(this.state){case d.State.INIT:var f=THREEDS.VisuEventsManager.getMouseEventsByStates([a.State.BEGIN],a.MouseButton.WHEEL,this.view);if(f.length){var e=f[0];this.events=[e];this.delta=UWA.Event.wheelDelta(e.getJSEvent());this.changeState(d.State.OK);return}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/MouseWheelGesture",b)});define("Gestures/MouseWheelGesture",["DS/Gestures/MouseWheelGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/MouseWheelGesture");return b});define("DS/Gestures/SwipeGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(b,a,d){var c=d.extend({init:function(){this._parent("Swipe");this.priority=10;this.touches=[];this.identifier=null;this.minDistance=5;return this},detect:function(h){this._parent(h);this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([a.State.BEGIN,a.State.MOVE,a.State.IDLE,a.State.END]);switch(this.state){case d.State.INIT:if((this.touches.length===1)&&(this.touches[0].isInView(this.view))){this.changeState(d.State.BEGIN)}break;case d.State.BEGIN:if(this.touches.length===1){if(this.touches[0].offsetPosition.length()>this.minDistance){var g=(this.touches[0].getState()===a.State.END);var e=h[0].getJSEvent();if(!g&&e.preventDefault){e.preventDefault()}this.events=this.touches;this.changeState(d.State.CHANGE)}}else{this.changeState(d.State.KO)}break;case d.State.CHANGE:if(this.touches.length===1){var g=(this.touches[0].getState()===a.State.END);var e=h[0].getJSEvent();if(!g&&e.preventDefault){e.preventDefault()}this.events=this.touches;this.changeState(d.State.CHANGE,g)}else{if(this.touches.length===2){var j=this.touches[0].getState();var f=this.touches[1].getState();if((j===a.State.BEGIN)||(f===a.State.BEGIN)){this.changeState(d.State.CHANGE,true)}else{this.changeState(d.State.KO)}}else{this.changeState(d.State.KO)}}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);this.touches=[];break;default:break}},getSwipeOrigin:function(){var e;if(this.getEvents().length>0){e=this.getEvents()[0].getStartPosition()}return e},getSwipeVector:function(){if(this.getEvents().length>0){var e=this.getEvents()[0].getCurrentPosition();e.sub(this.getEvents()[0].getStartPosition());return e}return null},getSwipeDuration:function(){if(this.getEvents().length>0){var e=this.getEvents()[0].currentTime-this.getEvents()[0].startTime;return e}return null}});return UWA.namespace("THREEDS/Gestures/SwipeGesture",c)});define("Gestures/SwipeGesture",["DS/Gestures/SwipeGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/SwipeGesture");return b});define("DS/Gestures/PrimaryPointerDoubleClickGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(b,a,d){var c=d.extend({init:function(e){this._parent("PrimaryPointerDoubleClick");this.priority=100;this.currentTime=0;this.maxTime=300;this.maxDistance=15;this.lastClickTime=0;this.lastClickPosition=new b.Vector2();return this},detect:function(f){this._parent(f);var e=this.gestures[0];if(!e){return}this.currentTime=new Date().getTime();switch(this.state){case d.State.INIT:if(e.getState()===d.State.OK){this.lastClickTime=this.currentTime;this.lastClickPosition.copy(e.events[0].currentPosition);this.changeState(d.State.BEGIN)}break;case d.State.BEGIN:if(e.getState()===d.State.OK){if((this.currentTime-this.lastClickTime<this.maxTime)&&(this.lastClickPosition.sub(e.events[0].currentPosition).length()<this.maxDistance)){this.events=e.getEvents();this.changeState(d.State.OK)}else{this.lastClickTime=this.currentTime;this.lastClickPosition.copy(e.events[0].currentPosition)}}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/PrimaryPointerDoubleClickGesture",c)});define("Gestures/PrimaryPointerDoubleClickGesture",["DS/Gestures/PrimaryPointerDoubleClickGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/PrimaryPointerDoubleClickGesture");return b});define("DS/Shaders/FlareShaders",["DS/Visualization/ThreeJS_DS"],function(b){var a={uniforms:{tDiffuse:{type:"t",value:null},tBlur:{type:"t",value:null},tLensColor:{type:"t",value:null},tLensDirt:{type:"t",value:null},invSize:{type:"v2",value:new b.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tBlur;","uniform sampler2D tLensColor;","uniform sampler2D tLensDirt;","uniform vec2 invSize;","const float ghostDispersal = 0.25;","const int ghosts = 8;","const float distortion = 5.0;","const float haloWidth = 1.0;","const float one_over_sqrt2 = 0.70710678;","varying vec2 vUv;","vec4 textureDistorted(sampler2D tex, vec2 texcoord, vec2 direction, vec3 distortion) {","   return vec4(","      texture2D(tex, texcoord + direction * distortion.r).r,","      texture2D(tex, texcoord + direction * distortion.g).g,","      texture2D(tex, texcoord + direction * distortion.b).b,","      1.0","   );","}","void main() {","   vec4 color = texture2D( tDiffuse, vUv );","   vec2 flippedUV = vec2(1.0) - vUv;","   vec2 uvToCenter = vec2(0.5) - flippedUV;","   vec3 distort = vec3(-invSize.x * distortion, 0.0, invSize.x * distortion);","   vec2 ghostVec = uvToCenter * ghostDispersal;","   vec4 flare = vec4(0.0);","   for (int i = 0; i < ghosts; ++i) {","      vec2 offset = fract(flippedUV + ghostVec * float(i));","      float ghostHeight = length(vec2(0.5) - offset) / one_over_sqrt2;","      ghostHeight = pow(1.0 - ghostHeight, 10.0);","      flare += textureDistorted(tBlur, offset, normalize(ghostVec), distort) * ghostHeight;","   }","   flare *= texture2D(tLensColor, vec2(length(uvToCenter) / one_over_sqrt2, 0.5));","   float dirt = texture2D( tLensDirt, vUv ).r;","   flare *= vec4(0.5) + dirt;","   gl_FragColor = vec4(color.rgb + flare.rgb, color.a);","}"].join("\n")};return{FinalBlending:a}});define("Shaders/FlareShaders",["DS/Shaders/FlareShaders","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/FlareShaders");return b});define("DS/Gestures/DoubleTapGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,a,d){var b=d.extend({init:function(){this._parent("DoubleTap");this.priority=100;this.currentTime=0;this.maxTime=400;this.maxDistance=15;this.lastTapTime=0;this.lastTapPosition=new c.Vector2();this.lastTapTimeTemp=0;this.lastTapPositionTemp=new c.Vector2();this.firstTapStartTime=0;return this},detect:function(h){this._parent(h);var e=this.gestures[0];if(!e){return}this.currentTime=new Date().getTime();switch(this.state){case d.State.INIT:if(e.getState()===d.State.OK){this.lastTapTime=this.currentTime;this.lastTapPosition.copy(e.events[0].currentPosition);this.lastTapTimeTemp=this.currentTime;this.lastTapPositionTemp.copy(e.events[0].currentPosition);this.firstTapStartTime=e.events[0].startTime;this.changeState(d.State.BEGIN)}break;case d.State.BEGIN:if(e.getState()===d.State.OK){if((this.currentTime-this.lastTapTime<this.maxTime)&&(this.lastTapPosition.sub(e.events[0].currentPosition).length()<this.maxDistance)){this.events=e.getEvents();this.changeState(d.State.OK)}else{this.lastTapTime=this.currentTime;this.lastTapPosition.copy(e.events[0].currentPosition);this.lastTapPositionTemp.copy(e.events[0].currentPosition);this.lastTapTimeTemp=this.currentTime;this.firstTapStartTime=e.events[0].startTime}}else{var g=THREEDS.VisuEventsManager.getTouchEventsByStates([a.State.BEGIN],this.view);if((this.currentTime-this.lastTapTimeTemp<this.maxTime)&&(this.lastTapPositionTemp.sub(e.events[0].currentPosition).length()<this.maxDistance)){if(g[0]){var f=g[0].getJSEvent();if(f&&f.preventDefault){f.preventDefault()}}}}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}},getElapsedTime:function(){if(this.getEvents().length>0){var e=this.currentTime-this.firstTapStartTime;return e}return null},getTouchPoint:function(){if(this.getEvents().length>0){var e=this.getEvents()[0].getCurrentPosition();return e}return null}});return UWA.namespace("THREEDS/Gestures/DoubleTapGesture",b)});define("Gestures/DoubleTapGesture",["DS/Gestures/DoubleTapGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/DoubleTapGesture");return b});define("DS/Gestures/SpreadGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,a,d){var b=d.extend({init:function(){this._parent("Spread");this.priority=10;this.touches=[];this.fingersVector0_1=new c.Vector2();this.fingersVector1_2=new c.Vector2();this.fingersVector2_0=new c.Vector2();this.latencyTime=30;this.initTime=0;this.distance=null;this.lastDistance=0;this.initDistance=0;this.distanceMin=0;return this},detect:function(f){this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([a.State.BEGIN,a.State.MOVE,a.State.IDLE,a.State.END],this.view);if(this.touches.length===3){this.fingersVector0_1.subVectors(this.touches[1].currentPosition,this.touches[0].currentPosition);this.fingersVector1_2.subVectors(this.touches[2].currentPosition,this.touches[1].currentPosition);this.fingersVector2_0.subVectors(this.touches[0].currentPosition,this.touches[2].currentPosition);if(this.distance===null){this.distance=this.fingersVector0_1.length()+this.fingersVector1_2.length()+this.fingersVector2_0.length()}this.lastDistance=this.distance;this.distance=this.fingersVector0_1.length()+this.fingersVector1_2.length()+this.fingersVector2_0.length()}switch(this.state){case d.State.INIT:this.distance=null;if(this.touches.length===3){this.preventDefault(this.touches);this.initTime=new Date().getTime();this.initDistance=this.distance;this.changeState(d.State.BEGIN)}break;case d.State.BEGIN:if(this.touches.length===3){this.events=this.touches;this.preventDefault(this.events);this.changeState(d.State.CHANGE)}else{this.changeState(d.State.KO)}break;case d.State.CHANGE:if(this.touches.length===3){var e=(this.touches[0].getState()===a.State.END)||(this.touches[1].getState()===a.State.END)||(this.touches[2].getState()===a.State.END);this.events=this.touches;this.preventDefault(this.events);this.changeState(d.State.CHANGE,e)}else{this.changeState(d.State.KO)}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);this.touches=[];this.distance=null;break;default:break}},preventDefault:function(h){for(var g=0;g<h.length;g++){var e=h[g];var f=e.getJSEvent();if(f.preventDefault){f.preventDefault()}}}});return UWA.namespace("THREEDS/Gestures/SpreadGesture",b)});define("Gestures/SpreadGesture",["DS/Gestures/SpreadGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/SpreadGesture");return b});define("DS/Shaders/PreComputeSDFFontIterativeShaders",["DS/Visualization/ThreeJS_DS"],function(h){var g={defines:{},uniforms:{tDiffuse:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",h._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","float dist = texture2D(tDiffuse, vUv).r;","gl_FragColor = vec4(vec3(mod(10.0*dist, 1.0)), 1.0);","}"].join("\n")};var f={defines:{},uniforms:{prevMap:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",h._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D prevMap;","varying vec2 vUv;","void main() {","vec4 texel = texture2D(prevMap, vUv);","float diff = length(texel.rg) - length(texel.ba);","diff = clamp(20.0 * diff, -1.0, 1.0);","float toto = clamp(0.5 * diff + 0.5, 0.0, 1.0);","gl_FragColor = vec4(vec3(toto), 1.0);","}"].join("\n")};var a={defines:{},uniforms:{textureSize:{type:"v2",value:new h.Vector2(256,256)},invSize:{type:"v2",value:new h.Vector2(1/256,1/256)},tDiffuse:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",h._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 textureSize;","uniform vec2 invSize;","varying vec2 vUv;","float aastep (float threshold , float value) {","float afwidth = 0.7 * length ( vec2(dFdx(value), dFdy(value)));","return smoothstep (threshold - afwidth, threshold + afwidth, value);","}","void main() {","vec2 uv = vUv * textureSize;","vec2 uv00 = floor(uv - vec2(0.5));","vec2 uvlerp = uv - uv00 - vec2(0.5);","vec2 st00 = (uv00 + vec2(0.5)) * invSize;","vec4 D00 = texture2D(tDiffuse, st00);","vec4 D10 = texture2D(tDiffuse, st00 + vec2(invSize.x, 0.0));","vec4 D01 = texture2D(tDiffuse, st00 + vec2(0.0, invSize.y));","vec4 D11 = texture2D(tDiffuse, st00 + vec2(invSize.x, invSize.y));","vec2 D00_10 = vec2(D00.r, D10.r)*255.0-128.0 + vec2(D00.g, D10.g)*(255.0/256.0);","vec2 D01_11 = vec2(D01.r, D11.r)*255.0-128.0 + vec2(D01.g, D11.g)*(255.0/256.0);","vec2 D0_1 = mix(D00_10, D01_11, uvlerp.y);","float D = mix(D0_1.x, D0_1.y, uvlerp.x);","float g = aastep(0.0, D);","gl_FragColor = vec4(vec3(g), 1.0);","}"].join("\n")};var e={defines:{},uniforms:{prevMap:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",h._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D prevMap;","varying vec2 vUv;","void main() {","float texel = texture2D(prevMap, vUv).r;","gl_FragColor = vec4(texel > 0.99999 ? vec2(9999.0) : vec2(0.0), texel > 0.99999 ? vec2(0.0) : vec2(9999.0));","}"].join("\n")};var j={defines:{},uniforms:{invSize:{type:"v2",value:new h.Vector2(1/256,1/256)},prevMap:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",h._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D prevMap;","uniform vec2 invSize;","varying vec2 vUv;","void ComputeDistance(vec2 uv, vec2 offset, inout vec4 bestseed) {","vec2 newvec = uv + offset;","vec4 newseed = texture2D(prevMap, newvec);","if (newvec.x >= 0.0 && newvec.x <= 1.0 && newvec.y >= 0.0 && newvec.y <= 1.0) {","newseed.rg += offset;","newseed.ba += offset;","if (length(newseed.rg) < length(bestseed.rg)) {","bestseed.rg = newseed.rg;","}","if (length(newseed.ba) < length(bestseed.ba)) {","bestseed.ba = newseed.ba;","}","}","}","void main() {","vec4 bestseed = texture2D(prevMap, vUv);","ComputeDistance(vUv, vec2(-invSize.x, -invSize.y), bestseed);","ComputeDistance(vUv, vec2(-invSize.x,        0.0), bestseed);","ComputeDistance(vUv, vec2(-invSize.x,  invSize.y), bestseed);","ComputeDistance(vUv, vec2(0.0, -invSize.y),        bestseed);","ComputeDistance(vUv, vec2(0.0,  invSize.y),        bestseed);","ComputeDistance(vUv, vec2(invSize.x, -invSize.y), bestseed);","ComputeDistance(vUv, vec2(invSize.x,        0.0), bestseed);","ComputeDistance(vUv, vec2(invSize.x,  invSize.y), bestseed);","gl_FragColor = bestseed;","}"].join("\n")};var d={defines:{},uniforms:{tDiffuse1:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",h._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse1;","varying vec2 vUv;","void main() {","vec4 texel = texture2D(tDiffuse1, vUv);","gl_FragColor = vec4(texel);","}"].join("\n")};var c={uniforms:{tDiffuse2:{type:"t",value:null},tileMin:{type:"v2",value:new h.Vector2(0,0)},tileMax:{type:"v2",value:new h.Vector2(64,64)},realTileMax:{type:"v2",value:new h.Vector2(64,64)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",h._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 tileMin;","uniform vec2 tileMax;","uniform vec2 realTileMax;","uniform sampler2D tDiffuse2;","varying vec2 vUv;","void main() {","vec2 uv = vUv;","if (uv.x < tileMin.x) { discard; }","vec2 tiledUV = (uv - tileMin) / (tileMax - tileMin);","tiledUV.y = 1.0 - tiledUV.y;","gl_FragColor = texture2D(tDiffuse2, tiledUV);","}"].join("\n")};var b={defines:{},uniforms:{prevMap:{type:"t",value:null},invSize:{type:"v2",value:new h.Vector2(1/256,1/256)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",h._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["const float SQRT2 = 1.41421356;","uniform sampler2D prevMap;","uniform vec2 invSize;","varying vec2 vUv;","void main() {","#if defined(OUTSIDE)","float value = texture2D(prevMap, vUv).r;","#else","float value = texture2D(prevMap, vUv).r;","#endif","float qv = invSize.x;","float qd = SQRT2 * invSize.x;","#if defined(OUTSIDE)","float lValue  = texture2D(prevMap, vec2(vUv.x - invSize.x, vUv.y)).r + qv;","float rValue  = texture2D(prevMap, vec2(vUv.x + invSize.x, vUv.y)).r + qv;","float bValue  = texture2D(prevMap, vec2(vUv.x, vUv.y - invSize.y)).r + qv;","float tValue  = texture2D(prevMap, vec2(vUv.x, vUv.y + invSize.y)).r + qv;","float tlValue = texture2D(prevMap, vec2(vUv.x - invSize.x, vUv.y + invSize.y)).r + qd;","float trValue = texture2D(prevMap, vec2(vUv.x + invSize.x, vUv.y + invSize.y)).r + qd;","float blValue = texture2D(prevMap, vec2(vUv.x - invSize.x, vUv.y - invSize.y)).r + qd;","float brValue = texture2D(prevMap, vec2(vUv.x + invSize.x, vUv.y - invSize.y)).r + qd;","if (vUv.x - invSize.x > 0.0) { value = min(lValue, value); }","if (vUv.x + invSize.x < 1.0) { value = min(rValue, value); }","if (vUv.y - invSize.y > 0.0) { value = min(bValue, value); }","if (vUv.y + invSize.y < 1.0) { value = min(tValue, value); }","if (vUv.x - invSize.x > 0.0 && vUv.y + invSize.y < 1.0) { value = min(tlValue, value); }","if (vUv.x + invSize.x < 1.0 && vUv.y + invSize.y < 1.0) { value = min(trValue, value); }","if (vUv.x - invSize.x > 0.0 && vUv.y - invSize.y > 0.0) { value = min(blValue, value); }","if (vUv.x + invSize.x < 1.0 && vUv.y - invSize.y > 0.0) { value = min(brValue, value); }","#else","float lValue  = mix(1.0, texture2D(prevMap, vec2(vUv.x - invSize.x, vUv.y)).r + qv, inScreen4.x);","float rValue  = mix(1.0, texture2D(prevMap, vec2(vUv.x + invSize.x, vUv.y)).r + qv, inScreen4.y);","float bValue  = mix(1.0, texture2D(prevMap, vec2(vUv.x, vUv.y - invSize.y)).r + qv, inScreen4.z);","float tValue  = mix(1.0, texture2D(prevMap, vec2(vUv.x, vUv.y + invSize.y)).r + qv, inScreen4.w);","float tlValue = mix(1.0, texture2D(prevMap, vec2(vUv.x - invSize.x, vUv.y + invSize.y)).r + qd, inScreen4.x * inScreen4.w);","float trValue = mix(1.0, texture2D(prevMap, vec2(vUv.x + invSize.x, vUv.y + invSize.y)).r + qd, inScreen4.y * inScreen4.w);","float blValue = mix(1.0, texture2D(prevMap, vec2(vUv.x - invSize.x, vUv.y - invSize.y)).r + qd, inScreen4.x * inScreen4.z);","float brValue = mix(1.0, texture2D(prevMap, vec2(vUv.x + invSize.x, vUv.y - invSize.y)).r + qd, inScreen4.y * inScreen4.z);","#endif","gl_FragColor = vec4(vec3(value), 1.0);","}"].join("\n")};return{ComputeSDFFont:b,ComputeSDFFontSeed:e,ComputeSDFFontFlood:j,ComputeSDFFontDisplay:g,ComputeSDFFontDisplayResult:a,ComputeSDFFontMerge:f,Nothing:d,MergeTiles:c}});define("DS/Gestures/TapGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(b,a,d){var c=d.extend({init:function(){this._parent("Tap");this.priority=10;this.identifier=null;this.maxTime=300;this.maxDistance=10;return this},detect:function(g){this._parent(g);switch(this.state){case d.State.INIT:var f=THREEDS.VisuEventsManager.getTouchEventsByStates([a.State.BEGIN,a.State.MOVE,a.State.IDLE]);if(f.length===1){f=THREEDS.VisuEventsManager.getTouchEventsByStates([a.State.BEGIN],this.view);if(f.length===1){this.identifier=f[0].identifier;this.changeState(d.State.BEGIN)}}break;case d.State.BEGIN:var f=THREEDS.VisuEventsManager.getTouchEvents();if(f.length>1){return}var e=THREEDS.VisuEventsManager.getTouchEventById(this.identifier);if(e===null){this.changeState(d.State.KO)}else{if(e.state===a.State.MOVE){if((e.offsetPosition.length()>this.maxDistance)||(e.currentTime-e.startTime>this.maxTime)){this.changeState(d.State.KO)}}else{if(e.state===a.State.END){if((e.offsetPosition.length()>this.maxDistance)||(e.currentTime-e.startTime>this.maxTime)){this.changeState(d.State.KO)}else{this.events=[e];this.changeState(d.State.OK)}}}}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}},getTouchPoint:function(){if(this.getEvents().length>0){var e=this.getEvents()[0].getCurrentPosition();return e}return null}});return UWA.namespace("THREEDS/Gestures/TapGesture",c)});define("Gestures/TapGesture",["DS/Gestures/TapGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/TapGesture");return b});define("DS/Gestures/PrimaryPointerUpUniqueGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent","DS/Gestures/BasicGesture"],function(c,a,d,e){var b=e.extend({init:function(){this._parent("PrimaryPointerUpUnique");this.priority=10;this.identifier=null;return this},detect:function(g){this._parent(g);switch(this.state){case e.State.INIT:var h=THREEDS.VisuEventsManager.getPrimaryPointerEventsByStates([a.State.END],this.view);if(h.length===1){var j=THREEDS.VisuEventsManager.getTouchEvents();var f=THREEDS.VisuEventsManager.getMouseEvents();if(j.length+f.length<=2){this.events=[h[0]];this.changeState(e.State.OK)}}break;case e.State.KO:case e.State.OK:case e.State.CANCEL:this.identifier=null;this.changeState(e.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/PrimaryPointerUpUniqueGesture",b)});define("Gestures/PrimaryPointerUpUniqueGesture",["DS/Gestures/PrimaryPointerUpUniqueGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/PrimaryPointerUpUniqueGesture");return b});define("DS/Gestures/PrimaryPointerDownUniqueGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent","DS/Gestures/BasicGesture"],function(c,a,d,e){var b=e.extend({init:function(){this._parent("PrimaryPointerDownUnique");this.priority=10;this.identifier=null;return this},detect:function(g){this._parent(g);switch(this.state){case e.State.INIT:var h=THREEDS.VisuEventsManager.getPrimaryPointerEventsByStates([a.State.BEGIN],this.view);if(h.length===1){var j=THREEDS.VisuEventsManager.getTouchEvents();var f=THREEDS.VisuEventsManager.getMouseEvents();if(j.length+f.length<=2){this.events=[h[0]];this.changeState(e.State.OK)}}break;case e.State.KO:case e.State.OK:case e.State.CANCEL:this.identifier=null;this.changeState(e.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/PrimaryPointerDownUniqueGesture",b)});define("Gestures/PrimaryPointerDownUniqueGesture",["DS/Gestures/PrimaryPointerDownUniqueGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/PrimaryPointerDownUniqueGesture");return b});define("DS/Plugins/PluginPass",["DS/Visualization/ThreeJS_DS"],function(b){var a=function(g,d,c,e,f){this.scene=g;this.camera=d;this.name=c;this.cameraName="main";this.plugin=e;this.plugin.init(f);this.composer=null};a.prototype={getDefaultState:function(){return{enabled:false,renderPlugins:false}},setCameraName:function(c){this.cameraName=c},setScene:function(c){this.scene=c},render:function(h,k,e,j,g,l,c,m,f){var d=c[m];h.doRenderPlugins([this.plugin],this.scene,d,e)},dispose:function(){this.plugin.dispose()}};return a});define("Plugins/PluginPass",["DS/Plugins/PluginPass","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Plugins/PluginPass");return b});define("DS/Gestures/MouseMoveGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,a,d){var b=d.extend({init:function(){this._parent("MouseMove");this.priority=0;return this},detect:function(h){this._parent(h);var f=THREEDS.VisuEventsManager.getMouseEvents(a.MouseButton.NONE,this.view);switch(this.state){case d.State.INIT:case d.State.CHANGE:for(var g=0;g<f.length;g++){var e=f[g];if(e.state===a.State.MOVE){this.events=[e];this.changeState(d.State.CHANGE);return}else{this.changeState(d.State.INIT);return}}this.changeState(d.State.INIT);break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/MouseMoveGesture",b)});define("Gestures/MouseMoveGesture",["DS/Gestures/MouseMoveGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/MouseMoveGesture");return b});define("DS/Animation/AnimationEngine",["DS/Animation/ANIM"],function(a){var b=function(){if(b.prototype.instance){return b.prototype.instance}b.prototype.instance=this;this._animations=[]};b.prototype._register=function(c){this._animations.push(c)};b.prototype._unregister=function(c){this._animations.splice(this._animations.indexOf(c),1)};b.prototype.step=function(f){var c=this._animations;var h=[];var g=[];for(var d=0;d<c.length;++d){var e=c[d];if(e.direction()===a.Direction.FORWARD){e.setTime(e.time()+f)}else{c.setTime(c.time()-f)}if(e.direction()===a.Direction.FORWARD&&e.time()===e.duration()||e.direction()===a.Direction.BACKWARD&&e.time()===0){if(e.loop()){g.push(e)}else{h.push(e)}}}for(d=0;d<h.length;++d){h[d].stop()}for(d=0;d<g.length;++d){g[d].start()}};return b});define("Animation/AnimationEngine",["DS/Animation/AnimationEngine","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Animation/AnimationEngine");return b});define("DS/Animation/AbstractAnimation",["DS/Animation/ANIM","DS/Animation/AnimationEngine"],function(a,c){var b=function(d){this._state=a.State.STOPPED;this._direction=a.Direction.FORWARD;this._loop=0;this._time=0;this._onStateChange=d;this._group=null};b.prototype.state=function(){return this._state};b.prototype.direction=function(){return this._direction};b.prototype.setDirection=function(d){a.assert(this._group===null);this._direction=d;this._updateDirection(d)};b.prototype.loop=function(){return this._loop};b.prototype.setLoop=function(d){a.assert(this._group===null);this._loop=d};b.prototype.time=function(){return this._time};b.prototype.setTime=function(e){a.assert(this._group===null);var d=Math.max(0,Math.min(this.duration(),e));this._time=d;this._updateCurrentTime(d)};b.prototype.duration=function(){a.assert(false)};b.prototype.group=function(){return this._group};b.prototype.isRunning=function(){return this._state===a.State.RUNNING};b.prototype.start=function(){a.assert(this._group===null);this.rewind();if(this._state!==a.State.RUNNING){var d=new c();d._register(this);this._state=a.State.RUNNING;this._updateState(this._state)}};b.prototype.pause=function(){a.assert(this._group===null);if(this._state===a.State.RUNNING){var d=new c();d._unregister(this);this._state=a.State.PAUSED;this._updateState(this._state)}};b.prototype.resume=function(){a.assert(this._group===null);if(this._state===a.State.PAUSED){var d=new c();d._register(this);this._state=a.State.RUNNING;this._updateState(this._state)}};b.prototype.stop=function(){a.assert(this._group===null);if(this._state!==a.State.STOPPED){var d=new c();d._unregister(this);this._state=a.State.STOPPED;this._updateState(this._state)}};b.prototype.rewind=function(){if(this._direction===a.Direction.FORWARD){this.setTime(0)}else{this.setTime(this.duration())}};b.prototype._updateCurrentTime=function(){a.assert(false)};b.prototype._updateState=function(d){if(this._onStateChange){this._onStateChange(d)}};b.prototype._updateDirection=function(){};return b});define("Animation/AbstractAnimation",["DS/Animation/AbstractAnimation","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Animation/AbstractAnimation");return b});define("DS/Animation/PropertyAnimation",["DS/Animation/ANIM","DS/Animation/AbstractAnimation"],function(a,c){var b=function(g,e,f,d){c.call(this,d);this._target=g;this._property=e;this._path=f};b.prototype=new c();b.prototype.target=function(){return this._target};b.prototype.setTarget=function(d){a.assert(this.state()===a.State.STOPPED);this._target=d};b.prototype.property=function(){return this._property};b.prototype.setProperty=function(d){a.assert(this.state()===a.State.STOPPED);this._property=d};b.prototype.path=function(){return this._path};b.prototype.setPath=function(d){a.assert(this.state()===a.State.STOPPED);this._path=d};b.prototype.duration=function(){return this._path.duration()};b.prototype._updateCurrentTime=function(d){if(this._target[this._property] instanceof Function){this._target[this._property](this._path.valueAt(d))}else{this._target[this._property]=this._path.valueAt(d)}};return b});define("Animation/PropertyAnimation",["DS/Animation/PropertyAnimation","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Animation/PropertyAnimation");return b});define("DS/Shaders/MLAAShaders",["DS/Visualization/ThreeJS_DS"],function(d){var b={uniforms:{tDiffuse:{type:"t",value:null},screenWidth:{type:"f",value:800},screenHeight:{type:"f",value:600}},vertexShader:["varying vec2 vUv;","varying vec4 offset[3];","uniform float screenHeight;","uniform float screenWidth;","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","void main() {","    vUv = uv;","    offset[0] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4(-1.0, 0.0, 0.0, 1.0);","    offset[1] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4( 1.0, 0.0, 0.0,-1.0);","    offset[2] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4(-2.0, 0.0, 0.0, -2.0);",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform float screenHeight;","uniform float screenWidth;","uniform sampler2D tDiffuse;","varying vec2 vUv;","varying vec4 offset[3];","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","const float threshold = 0.1;","void main() {","    vec3 weights = vec3(0.2126,0.7152, 0.0722);","    float L = dot(texture2D(tDiffuse, vUv.xy).rgb, weights);","    float Lleft = dot(texture2D(tDiffuse, offset[0].xy).rgb, weights);","    float Ltop = dot(texture2D(tDiffuse, offset[0].zw).rgb, weights);","    float Lright = dot(texture2D(tDiffuse, offset[1].xy).rgb, weights);","    float Lbottom = dot(texture2D(tDiffuse, offset[1].zw).rgb, weights);","    vec4 delta = abs(vec4(L) - vec4(Lleft, Ltop, Lright, Lbottom));","    vec4 edges = step(vec4(threshold), delta);","    gl_FragColor = edges;","    gl_FragColor.ba = vec2(0.0,1.0);","}"].join("\n")};var c={uniforms:{tDiffuse:{type:"t",value:null},areaTex:{type:"t",value:null},screenWidth:{type:"f",value:800},screenHeight:{type:"f",value:600}},vertexShader:["varying vec2 vUv;","uniform float screenHeight;","uniform float screenWidth;","void main() {","    vUv = uv;",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D areaTex;","uniform float screenHeight;","uniform float screenWidth;","varying vec2 vUv;","const int   MAX_SEARCH_STEPS = 7;","const int   MAX_DISTANCE     = 16;","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","vec4 tex2DLod(sampler2D map, vec2 texcoord, float offset) {","    return texture2D(map, texcoord );","}","float SearchXLeft(vec2 texcoord) {","    int j;","    texcoord -= vec2(1.5, 0.0) * SMAA_PIXEL_SIZE;","    float g = 0.0;","    for (int i = 0; i < MAX_SEARCH_STEPS; i++) {","        j = i;","        g = texture2D(tDiffuse, texcoord).g;","        if (g < 0.9) break;","        texcoord -= vec2(2.0, 0.0) * SMAA_PIXEL_SIZE;","    }","    return max(-2.0 * float(j) - 2.0 * g, -2.0 * float(MAX_SEARCH_STEPS));","}","float SearchXRight(vec2 texcoord) {","    int j;","    texcoord += vec2(1.5, 0.0) * SMAA_PIXEL_SIZE;","    float g = 0.0;","    for(int i = 0; i < MAX_SEARCH_STEPS; i++) {","        j = i;","        g = texture2D(tDiffuse, texcoord).g;","        if (g < 0.9) break;","        texcoord += vec2(2.0, 0.0) * SMAA_PIXEL_SIZE;","    }","    return min(2.0 * float(j) + 2.0 * g, 2.0 * float(MAX_SEARCH_STEPS));","}","float SearchYUp(vec2 texcoord) {","    int j;","    texcoord += vec2(0.0, 1.5) * SMAA_PIXEL_SIZE;","    float r = 0.0;","    for(int i = 0; i < MAX_SEARCH_STEPS; i++) {","        j = i;","        r = texture2D(tDiffuse, texcoord).r;","        if (r < 0.9) break;","        texcoord += vec2(0.0, 2.0) * SMAA_PIXEL_SIZE;","    }","    return min(2.0 * float(j) + 2.0 * r, 2.0 * float(MAX_SEARCH_STEPS));","}","float SearchYDown(vec2 texcoord) {","    int j;","    texcoord -= vec2(0.0, 1.5) * SMAA_PIXEL_SIZE;","    float r = 0.0;","    for(int i = 0; i < MAX_SEARCH_STEPS; i++) {","        j = i;","        r = texture2D(tDiffuse, texcoord).r;","        if (r < 0.9) break;","        texcoord -= vec2(0.0, 2.0) * SMAA_PIXEL_SIZE;","    }","    return max(-2.0 * float(j) - 2.0 * r, -2.0 * float(MAX_SEARCH_STEPS));","}","vec2 round(vec2 invec) {","    return vec2(floor(abs(invec) + vec2(0.5)) * sign(invec));","}","vec2 Area(vec2 distance, float e1, float e2) {","    float areaSize = float(MAX_DISTANCE) * 5.0;","    vec2 pixcoord = float(MAX_DISTANCE) * ","                    round(4.0 * vec2(e1, e2)) ","                    + distance + vec2(0.5);","    vec2 texcoord = pixcoord / areaSize;","    return tex2DLod(areaTex, vec2(texcoord.x, 1.0 - texcoord.y), 0.0).rg;","}","void main() {","    vec4 weights = vec4(0.0, 0.0, 0.0, 0.0);","    vec2 e = texture2D(tDiffuse, vUv).rg;","    vec2 d;","    if (e.g != 0.0) { ","        d = vec2(SearchXLeft(vUv), SearchXRight(vUv));","        vec4 coords = vec4(d.x, 0.25, d.y + 1.0, 0.25) * SMAA_PIXEL_SIZE.xyxy + vUv.xyxy;","        float e1 = tex2DLod(tDiffuse, coords.xy, 0.0).r;","        float e2 = tex2DLod(tDiffuse, coords.zw, 0.0).r;","        weights.rg = Area(abs(d), e1, e2);","    }","    if (e.r != 0.0) {","        d = vec2(SearchYUp(vUv), SearchYDown(vUv));","        vec4 coords = vec4(-0.25, d.x, -0.25, d.y - 1.0) * SMAA_PIXEL_SIZE.xyxy + vUv.xyxy;","        float e1 = texture2D(tDiffuse, coords.xy).g;","        float e2 = texture2D(tDiffuse, coords.zw).g;","        weights.ba = Area(abs(d), e1, e2);","    }","    gl_FragColor = clamp(weights, 0.0, 1.0);","}"].join("\n")};var a={uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},screenWidth:{type:"f",value:800},screenHeight:{type:"f",value:600}},vertexShader:["varying vec2 vUv;","void main() {","    vUv = uv;",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","uniform float screenHeight;","uniform float screenWidth;","varying vec2 vUv;","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","void main() {","    vec4 topLeft = texture2D(tDiffuse2, vUv);","    float bottom = texture2D(tDiffuse2, vUv + vec2(0.0, -1.0) * SMAA_PIXEL_SIZE).g;","    float right = texture2D(tDiffuse2, vUv + vec2(1.0, 0.0) * SMAA_PIXEL_SIZE).a;","    vec4 a = vec4(topLeft.r, bottom, topLeft.b, right);","    vec4 w = a * a * a;","    float sum = dot(w, vec4(1.0));","    if (sum > 0.0) {","        vec4 o = a * SMAA_PIXEL_SIZE.yyxx;","        vec4 color = vec4(0.0);","        color = texture2D(tDiffuse, vUv + vec2( 0.0,  o.r)) * w.r + color;","        color = texture2D(tDiffuse, vUv + vec2( 0.0, -o.g)) * w.g + color;","        color = texture2D(tDiffuse, vUv + vec2(-o.b,  0.0)) * w.b + color;","        color = texture2D(tDiffuse, vUv + vec2( o.a,  0.0)) * w.a + color;","        gl_FragColor = color / sum;","    } else {","        gl_FragColor = texture2D(tDiffuse, vUv);","    }","}"].join("\n")};return{EdgeDetection:b,BlendingWeights:c,FinalBlending:a}});define("Shaders/MLAAShaders",["DS/Shaders/MLAAShaders","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/MLAAShaders");return b});define("DS/Gestures/PinchTapGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(b,a,d){var c=d.extend({init:function(){this._parent("PinchTap");this.priority=10;this.maxTime=300;this.maxDistance=10;return this},detect:function(g){this._parent(g);switch(this.state){case d.State.INIT:var f=THREEDS.VisuEventsManager.getTouchEventsByStates([a.State.BEGIN,a.State.MOVE,a.State.IDLE],this.view);if(f.length===2){this.changeState(d.State.BEGIN)}break;case d.State.BEGIN:var f=THREEDS.VisuEventsManager.getTouchEvents();if(f.length>2){this.changeState(d.State.KO);return}for(var e=0;e<f.length;e++){var j=f[e];var h=j.getState();if(h===a.State.MOVE){if((j.offsetPosition.length()>this.maxDistance)||(j.currentTime-j.startTime>this.maxTime)){this.changeState(d.State.KO);return}}else{if(h===a.State.END){if((j.offsetPosition.length()>this.maxDistance)||(j.currentTime-j.startTime>this.maxTime)){this.changeState(d.State.KO);return}else{if(f.length===1){this.events.push(j);this.changeState(d.State.OK);return}else{if(f.length===2){this.events=[j]}}}}}}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/PinchTapGesture",c)});define("Gestures/PinchTapGesture",["DS/Gestures/PinchTapGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/PinchTapGesture");return b});define("DS/Effects/MLAAEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/MLAAShaders"],function(c,d,a,f,b,g){var e=a.extend({init:function(m,l){this._parent(m);var j=new c.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers.push(new f(m,j,l));this.pass1=new b(g.EdgeDetection);this.pass2=new b(g.BlendingWeights);this.mixPass=new b(g.FinalBlending,undefined,"MLAAEffect");this.composers[0].addPass(this.pass1);this.composers[0].addPass(this.pass2);var h=d.getWebappsAssetUrl("Effects","");var k=new c.ImageUtils.loadTexture(h+"AreaTexMLAA.png",undefined,null,null,c.ImageUtils.crossOriginPolicy);k.minFilter=c.LinearFilter;k.magFilter=c.LinearFilter;this.pass2.uniforms.areaTex.value=k;return this},initEffect:function(h,j){j.insertComposer(this.composers[0],this.mixPass);this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2);this.mixPass.addRequiredComposer(this.composers[0])},update:function(j,h,k){},setSize:function(k,h){var j=this._parent(k,h);if(!j){return}this.composers[0].setSize(this.width,this.height);this.pass1.uniforms.screenWidth.value=this.width;this.pass1.uniforms.screenHeight.value=this.height;this.pass2.uniforms.screenWidth.value=this.width;this.pass2.uniforms.screenHeight.value=this.height;this.mixPass.uniforms.screenWidth.value=this.width;this.mixPass.uniforms.screenHeight.value=this.height}});return e});define("Effects/MLAAEffect",["DS/Effects/MLAAEffect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/MLAAEffect");return b});define("DS/Shaders/DisplayMipsRoughnessShader",["DS/Visualization/ThreeJS_DS"],function(b){var a={uniforms:{tDiffuse1:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDiffuse4:{type:"t",value:null},tDiffuse5:{type:"t",value:null},tDiffuse6:{type:"t",value:null},offset1:{type:"v2",value:new b.Vector2(0,0.5)},scale1:{type:"f",value:0.5},offset2:{type:"v2",value:new b.Vector2(0,0.25)},scale2:{type:"f",value:0.25},offset3:{type:"v2",value:new b.Vector2(0.25,0.25)},scale3:{type:"f",value:0.25},offset4:{type:"v2",value:new b.Vector2(0,0.125)},scale4:{type:"f",value:0.125},offset5:{type:"v2",value:new b.Vector2(0.125,0.125)},scale5:{type:"f",value:0.125},offset6:{type:"v2",value:new b.Vector2(0.25,0.125)},scale6:{type:"f",value:0.125}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse1;","uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform sampler2D tDiffuse4;","uniform sampler2D tDiffuse5;","uniform sampler2D tDiffuse6;","uniform vec2 offset1;","uniform float scale1;","uniform vec2 offset2;","uniform float scale2;","uniform vec2 offset3;","uniform float scale3;","uniform vec2 offset4;","uniform float scale4;","uniform vec2 offset5;","uniform float scale5;","uniform vec2 offset6;","uniform float scale6;","varying vec2 vUv;","void main() {","gl_FragColor = vec4(0.0);","vec2 vUv2 = (vUv - offset1) / scale1;","vec2 vUv3 = (vUv - offset2) / scale2;","vec2 vUv4 = (vUv - offset3) / scale3;","vec2 vUv5 = (vUv - offset4) / scale4;","vec2 vUv6 = (vUv - offset5) / scale5;","vec2 vUv7 = (vUv - offset6) / scale6;","if (vUv2.x > 0.0 && vUv2.y > 0.0 && vUv2.x < 1.0 && vUv2.y < 1.0) {","    vec3 color = texture2D( tDiffuse1, vUv2 ).xyz;","    color = pow(color, vec3(1.0 / 2.2));","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv3.x > 0.0 && vUv3.y > 0.0 && vUv3.x < 1.0 && vUv3.y < 1.0) {","    vec3 color = texture2D( tDiffuse2, vUv3 ).xyz;","    color = pow(color, vec3(1.0 / 2.2));","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv4.x > 0.0 && vUv4.y > 0.0 && vUv4.x < 1.0 && vUv4.y < 1.0) {","    vec3 color = texture2D( tDiffuse3, vUv4 ).xyz;","    color = pow(color, vec3(1.0 / 2.2));","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv5.x > 0.0 && vUv5.y > 0.0 && vUv5.x < 1.0 && vUv5.y < 1.0) {","    vec3 color = texture2D( tDiffuse4, vUv5 ).xyz;","    color = pow(color, vec3(1.0 / 2.2));","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv6.x > 0.0 && vUv6.y > 0.0 && vUv6.x < 1.0 && vUv6.y < 1.0) {","    vec3 color = texture2D( tDiffuse5, vUv6 ).xyz;","    color = pow(color, vec3(1.0 / 2.2));","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv7.x > 0.0 && vUv7.y > 0.0 && vUv7.x < 1.0 && vUv7.y < 1.0) {","    vec3 color = texture2D( tDiffuse6, vUv7 ).xyz;","    color = pow(color, vec3(1.0 / 2.2));","    gl_FragColor = vec4(color, 1.0); return;","}","}"].join("\n")};var c={uniforms:{tDiffuse1:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDiffuse4:{type:"t",value:null},tDiffuse5:{type:"t",value:null},tDiffuse6:{type:"t",value:null},tDiffuse7:{type:"t",value:null},offset1:{type:"v2",value:new b.Vector2(0,0.5)},scale1:{type:"v2",value:new b.Vector2(1,0.5)},offset2:{type:"v2",value:new b.Vector2(0,0.25)},scale2:{type:"v2",value:new b.Vector2(0.5,0.25)},offset3:{type:"v2",value:new b.Vector2(0.5,0.25)},scale3:{type:"v2",value:new b.Vector2(0.5,0.25)},offset4:{type:"v2",value:new b.Vector2(0,0.125)},scale4:{type:"v2",value:new b.Vector2(0.25,0.125)},offset5:{type:"v2",value:new b.Vector2(0.25,0.125)},scale5:{type:"v2",value:new b.Vector2(0.25,0.125)},offset6:{type:"v2",value:new b.Vector2(0.5,0.125)},scale6:{type:"v2",value:new b.Vector2(0.25,0.125)},offset7:{type:"v2",value:new b.Vector2(0.75,0.125)},scale7:{type:"v2",value:new b.Vector2(0.25,0.125)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse1;","uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform sampler2D tDiffuse4;","uniform sampler2D tDiffuse5;","uniform sampler2D tDiffuse6;","uniform sampler2D tDiffuse7;","uniform vec2 offset1;","uniform vec2 scale1;","uniform vec2 offset2;","uniform vec2 scale2;","uniform vec2 offset3;","uniform vec2 scale3;","uniform vec2 offset4;","uniform vec2 scale4;","uniform vec2 offset5;","uniform vec2 scale5;","uniform vec2 offset6;","uniform vec2 scale6;","uniform vec2 offset7;","uniform vec2 scale7;","varying vec2 vUv;","void main() {","gl_FragColor = vec4(0.0);","vec2 vUv2 = (vUv - offset1) / scale1;","vec2 vUv3 = (vUv - offset2) / scale2;","vec2 vUv4 = (vUv - offset3) / scale3;","vec2 vUv5 = (vUv - offset4) / scale4;","vec2 vUv6 = (vUv - offset5) / scale5;","vec2 vUv7 = (vUv - offset6) / scale6;","vec2 vUv8 = (vUv - offset7) / scale7;","if (vUv2.x > 0.0 && vUv2.y > 0.0 && vUv2.x < 1.0 && vUv2.y < 1.0) {","    vec3 color = texture2D( tDiffuse1, vec2(1.0 - vUv2.x, vUv2.y) ).xyz;","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv3.x > 0.0 && vUv3.y > 0.0 && vUv3.x < 1.0 && vUv3.y < 1.0) {","    vec3 color = texture2D( tDiffuse2, vec2(1.0 - vUv3.x, vUv3.y) ).xyz;","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv4.x > 0.0 && vUv4.y > 0.0 && vUv4.x < 1.0 && vUv4.y < 1.0) {","    vec3 color = texture2D( tDiffuse3, vec2(1.0 - vUv4.x, vUv4.y) ).xyz;","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv5.x > 0.0 && vUv5.y > 0.0 && vUv5.x < 1.0 && vUv5.y < 1.0) {","    vec3 color = texture2D( tDiffuse4, vec2(1.0 - vUv5.x, vUv5.y) ).xyz;","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv6.x > 0.0 && vUv6.y > 0.0 && vUv6.x < 1.0 && vUv6.y < 1.0) {","    vec3 color = texture2D( tDiffuse5, vec2(1.0 - vUv6.x, vUv6.y) ).xyz;","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv7.x > 0.0 && vUv7.y > 0.0 && vUv7.x < 1.0 && vUv7.y < 1.0) {","    vec3 color = texture2D( tDiffuse6, vec2(1.0 - vUv7.x, vUv7.y) ).xyz;","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv8.x > 0.0 && vUv8.y > 0.0 && vUv8.x < 1.0 && vUv8.y < 1.0) {","    vec3 color = texture2D( tDiffuse7, vec2(1.0 - vUv8.x, vUv8.y) ).xyz;","    gl_FragColor = vec4(color, 1.0); return;","}","}"].join("\n")};return{DisplayMips:a,MergeMips:c}});define("ShadersDebug/DisplayMipsRoughnessShader",["DS/Shaders/DisplayMipsRoughnessShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("ShadersDebug/DisplayMipsRoughnessShader");return b});define("DS/Effects/FlareEffect",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/BloomShaders","DS/Shaders/FlareShaders"],function(g,e,b,h,d,a,f){var c=b.extend({init:function(l,k){this._parent(l);this.threshold=1;this.passThreshold;this.passBlurH;this.passBlurV;this.passThreshold=new d(a.Threshold);var o=0.5,p;p=new e.WebGLRenderTargetProperties(o*this.width,o*this.height,"uint");this.composers[0]=new h(l,p,k);this.passBlurH=new d(a.BlurH);this.passBlurV=new d(a.BlurV);this.composers[0].addPass(this.passThreshold);this.composers[0].addPass(this.passBlurH);this.composers[0].addPass(this.passBlurV);this.passThreshold.uniforms.threshold.value=this.threshold;this.mixPass=new d(f.FinalBlending,undefined,"FlareEffect");var j=g.getWebappsAssetUrl("Effects","");var n=new e.ImageUtils.loadTexture(j+"lenscolor.png",undefined,null,null,e.ImageUtils.crossOriginPolicy);n.minFilter=e.LinearFilter;n.magFilter=e.LinearFilter;var m=new e.ImageUtils.loadTexture(j+"lensdirt.png",undefined,null,null,e.ImageUtils.crossOriginPolicy);m.minFilter=e.LinearFilter;m.magFilter=e.LinearFilter;this.mixPass.uniforms.tLensColor.value=n;this.mixPass.uniforms.tLensDirt.value=m;return this},initEffect:function(k,l){var j=l.getComposer("result");j.linkToShaderPassUniform(this.passThreshold,this.passThreshold.uniforms.tDiffuse2);l.insertComposer(this.composers[0],this.mixPass);this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tBlur);this.mixPass.addRequiredComposer(this.composers[0])},update:function(k,j,l){},setSize:function(l,j){var k=this._parent(l,j);if(!k){return}var m=0.5;this.composers[0].setSize(m*this.width,m*this.height);this.passBlurH.uniforms.invSize.value.set(1/(m*this.width),1/(m*this.height));this.passBlurV.uniforms.invSize.value.set(1/(m*this.width),1/(m*this.height));this.mixPass.uniforms.invSize.value.set(1/(m*this.width),1/(m*this.height))}});return c});define("Effects/FlareEffect",["DS/Effects/FlareEffect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/FlareEffect");return b});define("DS/Gestures/PinchGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,a,d){var b=d.extend({init:function(){this._parent("Pinch");this.priority=10;this.touches=[];this.fingersVector=new c.Vector2();this.latencyTime=200;this.initTime=0;this.distance=null;this.lastDistance=0;this.initDistance=0;this.distanceMin=10;this.orientation=null;this.lastOrientation=0;this.deltaOrientation=0;this.initOrientation=0;this.orientationMax=0.1;this.barycenter=null;this.lastBarycenter=new c.Vector2();this.initBarycenter=new c.Vector2();return this},detect:function(g){this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([a.State.BEGIN,a.State.MOVE,a.State.IDLE,a.State.END],this.view);if(this.touches.length===2){var e=g[0].getJSEvent();if(e.preventDefault){e.preventDefault()}this.fingersVector.subVectors(this.touches[1].currentPosition,this.touches[0].currentPosition);if(this.distance===null){this.distance=this.fingersVector.length()}if(this.orientation===null){this.orientation=Math.atan2(this.fingersVector.y,this.fingersVector.x)}if(this.barycenter===null){this.barycenter=new c.Vector2();this.barycenter.addVectors(this.touches[0].currentPosition,this.touches[1].currentPosition);this.barycenter.multiplyScalar(0.5)}this.lastDistance=this.distance;this.distance=this.fingersVector.length();this.lastOrientation=this.orientation;this.orientation=Math.atan2(this.fingersVector.y,this.fingersVector.x);this.deltaOrientation=this.orientation-this.lastOrientation;var j=(this.deltaOrientation>=0)?1:-1;j*=2*Math.PI;if(Math.abs(this.deltaOrientation-j)<Math.abs(this.deltaOrientation)){this.deltaOrientation-=j}this.lastBarycenter.copy(this.barycenter);this.barycenter.addVectors(this.touches[0].currentPosition,this.touches[1].currentPosition);this.barycenter.multiplyScalar(0.5)}switch(this.state){case d.State.INIT:if(this.touches.length===2){this.initTime=new Date().getTime();this.initDistance=this.distance;this.initOrientation=this.orientation;this.initBarycenter.copy(this.barycenter);this.changeState(d.State.BEGIN)}break;case d.State.BEGIN:if(this.touches.length===2){if(new Date().getTime()-this.initTime>this.latencyTime){var h=Math.abs(this.orientation-this.initOrientation);h=Math.min(h,Math.abs(h-2*Math.PI));if((Math.abs(this.distance-this.initDistance)>this.distanceMin)&&(h<this.orientationMax)){this.events=this.touches;this.changeState(d.State.CHANGE)}else{this.changeState(d.State.KO)}}}else{this.changeState(d.State.KO)}break;case d.State.CHANGE:if(this.touches.length===2){var f=(this.touches[0].getState()===a.State.END)||(this.touches[1].getState()===a.State.END);this.events=this.touches;this.changeState(d.State.CHANGE,f)}else{this.changeState(d.State.KO)}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);this.touches=[];this.distance=null;this.orientation=null;this.barycenter=null;break;default:break}},getAngle:function(){return(this.orientation||0)},getDeltaAngle:function(){return this.deltaOrientation},getFirstTouchPosition:function(e){var f;if(this.getEvents().length===2){f=this.getEvents()[0].getCurrentPosition();return f}return null},getSecondTouchPosition:function(f){var e;if(this.getEvents().length===2){e=this.getEvents()[1].getCurrentPosition();return e}return null},getInitialDistance:function(e){var g=-1;if(this.getEvents().length===2){var f=this.getEvents()[1].getStartPosition();f.sub(this.getEvents()[0].getStartPosition());g=f.length()}return g},getDistance:function(e){var g=-1;if(this.getEvents().length===2){var f=this.getEvents()[1].getCurrentPosition();f.sub(this.getEvents()[0].getCurrentPosition());g=f.length()}return g}});return UWA.namespace("THREEDS/Gestures/PinchGesture",b)});define("Gestures/PinchGesture",["DS/Gestures/PinchGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/PinchGesture");return b});define("DS/Gestures/MouseUpGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(b,a,d){var c=d.extend({init:function(e){this._parent(a.printMouseButton(e)+"MouseUp");this.priority=0;this.button=e;return this},detect:function(g){this._parent(g);switch(this.state){case d.State.INIT:var f=THREEDS.VisuEventsManager.getMouseEventsByStates([a.State.END],this.button,this.view);if(f.length){var e=f[0];this.events=[e];this.changeState(d.State.OK);return}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/MouseUpGesture",c)});define("Gestures/MouseUpGesture",["DS/Gestures/MouseUpGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/MouseUpGesture");return b});define("DS/Shaders/DisplayPassShader",["DS/Visualization/ThreeJS_DS"],function(a){var b={uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDiffuse4:{type:"t",value:null},offset:{type:"v2",value:new a.Vector2(0.505,0.01)},scale:{type:"f",value:0.485},offset2:{type:"v2",value:new a.Vector2(0.01,0.01)},scale2:{type:"f",value:0.485},offset3:{type:"v2",value:new a.Vector2(0.505,0.505)},scale3:{type:"f",value:0.485},offset4:{type:"v2",value:new a.Vector2(0.01,0.505)},scale4:{type:"f",value:0.485}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",a._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform sampler2D tDiffuse4;","uniform vec2 offset;","uniform float scale;","uniform vec2 offset2;","uniform float scale2;","uniform vec2 offset3;","uniform float scale3;","uniform vec2 offset4;","uniform float scale4;","varying vec2 vUv;","void main() {","gl_FragColor = vec4(0.0);","vec2 vUv2 = (vUv - offset) / scale;","vec2 vUv3 = (vUv - offset2) / scale2;","vec2 vUv4 = (vUv - offset3) / scale3;","vec2 vUv5 = (vUv - offset4) / scale4;","if (vUv2.x > 0.0 && vUv2.y > 0.0 && vUv2.x < 1.0 && vUv2.y < 1.0) {","    gl_FragColor = vec4(texture2D( tDiffuse2, vUv2 ).xyz, 1.0); return;","} else if (vUv3.x > 0.0 && vUv3.y > 0.0 && vUv3.x < 1.0 && vUv3.y < 1.0) {","    gl_FragColor = vec4(texture2D( tDiffuse3, vUv3 ).xyz, 1.0); return;","} else if (vUv4.x > 0.0 && vUv4.y > 0.0 && vUv4.x < 1.0 && vUv4.y < 1.0) {","    vec4 normalDepth = texture2D( tDiffuse4, vUv4 );","    gl_FragColor = vec4(vec3(normalDepth.w), 1.0); return;","} else if (vUv5.x > 0.0 && vUv5.y > 0.0 && vUv5.x < 1.0 && vUv5.y < 1.0) {","    vec4 normalDepth = texture2D( tDiffuse4, vUv5 );","    vec3 normal = vec3(0.0, 0.0, 1.0);","    if (dot(normalDepth.xy, normalDepth.xy) > 0.000001) {","        normal.z = 2.0 * dot(normalDepth.xy, normalDepth.xy) - 1.0;","        normal.xy = normalize(normalDepth.xy) * sqrt(1.0 - normal.z * normal.z);","    }","    gl_FragColor = vec4(0.5 + 0.5 * normal, 1.0); return;","}","}"].join("\n")};return b});define("Shaders/DisplayPassShader",["DS/Shaders/DisplayPassShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/DisplayPassShader");return b});define("DS/VisuLoaders/ColladaLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Visualization/ProxyAbstraction"],function(b,d,c){var a=function(){var ar=null;var K=null;var ab;var aO=null;var ae={};var p={};var S={};var ak={};var aw={};var U={};var ay={};var aj={};var aS;var aM;var aV;var k;var N;var x=true;var T=b.SmoothShading;var ag={centerGeometry:false,convertUpAxis:false,subdivideFaces:true,upAxis:"Y",defaultEnvMap:null,waitMaterial:new b.MeshPhongMaterial({color:new b.Color(16777215)})};var aU=1;var az="Y";var D=null;function l(a4,a8,a7){var a6=0;if(document.implementation&&document.implementation.createDocument){var a5=new XMLHttpRequest();a5.onreadystatechange=function(){if(a5.readyState==4){if(a5.status==0||a5.status==200){if(a5.responseXML){aO=a8;aq(a5.responseXML,undefined,a4)}else{if(a5.responseText){aO=a8;var a9=new DOMParser();var ba=a9.parseFromString(a5.responseText,"application/xml");aq(ba,undefined,a4)}else{console.error("ColladaLoader: Empty or non-existing file ("+a4+")")}}}}else{if(a5.readyState==3){if(a7){if(a6==0){a6=a5.getResponseHeader("Content-Length")}a7({total:a6,loaded:a5.responseText.length})}}}};a5.open("GET",a4,true);a5.withCredentials=true;a5.send(null)}else{alert("Don't know how to parse XML!")}}function ah(a5,a9,a7){var a4=a5.serverurl?a5.serverurl:"";a4+=a5.filename?a5.filename:"";var a6=new c();d.setProxyFromSpec(a5,a6);var a8=function(bc){aO=a9;var ba=new DOMParser();var bd=ba.parseFromString(bc,"application/xml");aq(bd,undefined,a4)};a6.executeGetHttpRequest(a4,"text",null,a8,function(){console.error("ColladaLoader: Empty or non-existing file ("+a4+")")})}function aq(a9,a7,a5){ar=a9;a7=a7||aO;if(a5!==undefined){var a8=a5.split("/");a8.pop();aV=(a8.length<1?".":a8.join("/"))+"/"}C();Y();p=aD("//dae:library_images/dae:image",ai,"image");U=aD("//dae:library_materials/dae:material",g,"material");ay=aD("//dae:library_effects/dae:effect",R,"effect");aw=aD("//dae:library_geometries/dae:geometry",aF,"geometry");aj=aD(".//dae:library_cameras/dae:camera",aT,"camera");ak=aD("//dae:library_controllers/dae:controller",M,"controller");S=aD("//dae:library_animations/dae:animation",aW,"animation");aM=aD(".//dae:library_visual_scenes/dae:visual_scene",aP,"visual_scene");k=[];N=[];ab=ac();K=new b.Object3D();for(var a6=0;a6<ab.nodes.length;a6++){K.add(h(ab.nodes[a6]))}K.scale.multiplyScalar(aU);z();var a4={scene:K,morphs:k,skins:N,animations:aS,dae:{images:p,materials:U,cameras:aj,effects:ay,geometries:aw,controllers:ak,animations:S,visualScenes:aM,scene:ab}};if(a7){a7(a4)}return a4}function G(a4){T=a4}function C(){var a7=ar.evaluate("//dae:asset",ar,a0,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);var a5=a7.iterateNext();if(a5&&a5.childNodes){for(var a4=0;a4<a5.childNodes.length;a4++){var a8=a5.childNodes[a4];switch(a8.nodeName){case"unit":var a6=a8.getAttribute("meter");if(a6){aU=parseFloat(a6)}break;case"up_axis":az=a8.textContent.charAt(0);break}}}}function aD(ba,a7,a9){var a8=ar.evaluate(ba,ar,a0,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);var bc={};var a6=a8.iterateNext();var a5=0;while(a6){var a4=(new a7()).parse(a6);if(!a4.id||a4.id.length==0){a4.id=a9+(a5++)}bc[a4.id]=a4;a6=a8.iterateNext()}return bc}function ac(){var a5=ar.evaluate(".//dae:scene/dae:instance_visual_scene",ar,a0,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext();if(a5){var a4=a5.getAttribute("url").replace(/^#/,"");return aM[a4.length>0?a4:"visual_scene0"]}else{return null}}function z(){aS=[];t(K)}function t(a9){var bc=ab.getChildById(a9.name,true),a8=null;if(bc&&bc.keys){a8={fps:60,hierarchy:[{node:bc,keys:bc.keys,sids:bc.sids}],node:a9,name:"animation_"+a9.name,length:0};aS.push(a8);for(var a7=0,a4=bc.keys.length;a7<a4;a7++){a8.length=Math.max(a8.length,bc.keys[a7].time)}}else{a8={hierarchy:[{keys:[],sids:[]}]}}for(var a7=0,a4=a9.children.length;a7<a4;a7++){var ba=t(a9.children[a7]);for(var a5=0,a6=ba.hierarchy.length;a5<a6;a5++){a8.hierarchy.push({keys:[],sids:[]})}}return a8}function L(){var ba=1000000;var a4=-ba;var a8=0;for(var a9 in S){var a7=S[a9];for(var a6=0;a6<a7.sampler.length;a6++){var a5=a7.sampler[a6];a5.create();ba=Math.min(ba,a5.startTime);a4=Math.max(a4,a5.endTime);a8=Math.max(a8,a5.input.length)}}return{start:ba,end:a4,frames:a8}}function r(bc,a8){var ba=a8 instanceof H?ak[a8.url]:a8;if(!ba||!ba.morph){console.log("could not find morph controller!");return}var a7=ba.morph;for(var a6=0;a6<a7.targets.length;a6++){var a5=a7.targets[a6];var a4=aw[a5];if(!a4.mesh||!a4.mesh.primitives||!a4.mesh.primitives.length){continue}var a9=a4.mesh.primitives[0].geometry}}function aQ(bc,a4,a9){var a5=ak[a4.url];if(!a5||!a5.skin){console.log("could not find skin controller!");return}if(!a4.skeleton||!a4.skeleton.length){console.log("could not find the skeleton for the skin!");return}var bd=a5.skin;var a7=ab.getChildById(a4.skeleton[0]);var ba=[];a9=a9!==undefined?a9:true;var a6=[];bc.skinWeights=[];bc.skinIndices=[];if(a9){for(var a8=0;a8<bc.vertices.length;a8++){bc.vertices[a8].applyMatrix4(bd.bindShapeMatrix)}}}function F(a9,a5,ba,a7){a9.world=a9.world||new b.Matrix4();a9.world.copy(a9.matrix);if(a9.channels&&a9.channels.length){var a8=a9.channels[0];var a4=a8.sampler.output[ba];if(a4 instanceof b.Matrix4){a9.world.copy(a4)}}if(a7){a9.world.multiplyMatrices(a7,a9.world)}a5.push(a9);for(var a6=0;a6<a9.nodes.length;a6++){F(a9.nodes[a6],a5,ba,a9.world)}}function W(a4,bc){for(var a7=0;a7<a4.length;a7++){var ba=a4[a7];var bd=-1;if(ba.type!="JOINT"){continue}for(var a6=0;a6<bc.joints.length;a6++){if(ba.sid==bc.joints[a6]){bd=a6;break}}if(bd>=0){var a8=bc.invBindMatrices[bd];ba.invBindMatrix=a8;ba.skinningMatrix=new b.Matrix4();ba.skinningMatrix.multiplyMatrices(ba.world,a8);ba.weights=[];for(var a6=0;a6<bc.weights.length;a6++){for(var a5=0;a5<bc.weights[a6].length;a5++){var a9=bc.weights[a6][a5];if(a9.joint==bd){ba.weights.push(a9)}}}}else{throw"ColladaLoader: Could not find joint '"+ba.sid+"'."}}}function aX(bg,bh,a6){var be=ak[bh.url];a6=a6!==undefined?a6:40;if(!be||!be.skin){console.log("ColladaLoader: Could not find skin controller.");return}if(!bh.skeleton||!bh.skeleton.length){console.log("ColladaLoader: Could not find the skeleton for the skin. ");return}var bd=L();var a8=ab.getChildById(bh.skeleton[0],true)||ab.getChildBySid(bh.skeleton[0],true);var ba,a9,bi,a4,bc;var bj=new b.Vector3(),a5,bk;for(ba=0;ba<bg.vertices.length;ba++){bg.vertices[ba].applyMatrix4(be.skin.bindShapeMatrix)}for(a6=0;a6<bd.frames;a6++){var a7=[];var bf=[];for(ba=0;ba<bg.vertices.length;ba++){bf.push(new b.Vector3())}F(a8,a7,a6);W(a7,be.skin);for(ba=0;ba<a7.length;ba++){if(a7[ba].type!="JOINT"){continue}for(a9=0;a9<a7[ba].weights.length;a9++){bi=a7[ba].weights[a9];a4=bi.index;bc=bi.weight;a5=bg.vertices[a4];bk=bf[a4];bj.x=a5.x;bj.y=a5.y;bj.z=a5.z;bj.applyMatrix4(a7[ba].skinningMatrix);bk.x+=(bj.x*bc);bk.y+=(bj.y*bc);bk.z+=(bj.z*bc)}}}}function h(bu,bf){var bk=new b.Object3D();var bi=false;var bd;var bo;var bx,bv;for(bx=0;bx<bu.controllers.length;bx++){var br=ak[bu.controllers[bx].url];switch(br.type){case"skin":if(aw[br.skin.source]){var bm=new aB();bm.url=br.skin.source;bm.instance_material=bu.controllers[bx].instance_material;bu.geometries.push(bm);bi=true;bd=bu.controllers[bx]}else{if(ak[br.skin.source]){var bB=ak[br.skin.source];bo=bB;if(bB.morph&&aw[bB.morph.source]){var bm=new aB();bm.url=bB.morph.source;bm.instance_material=bu.controllers[bx].instance_material;bu.geometries.push(bm)}}}break;case"morph":if(aw[br.morph.source]){var bm=new aB();bm.url=br.morph.source;bm.instance_material=bu.controllers[bx].instance_material;bu.geometries.push(bm);bo=bu.controllers[bx]}console.log("ColladaLoader: Morph-controller partially supported.");default:break}}var a7={};for(bx=0;bx<bu.geometries.length;bx++){var bw=bu.geometries[bx];var bg=bw.instance_material;var a9=aw[bw.url];var bc={};var bz=[];var bl=0;var a6;if(a9){if(!a9.mesh||!a9.mesh.primitives){continue}if(bk.name.length==0){bk.name=a9.id}if(bg){for(bv=0;bv<bg.length;bv++){var bp=bg[bv];var by=U[bp.target];var ba=by.instance_effect.url;var a4=ay[ba].shader;var bs=a4.material;if(a9.doubleSided){if(!(bs in a7)){var bh=bs.clone();bh.side=b.DoubleSide;a7[bs]=bh}bs=a7[bs]}bs.opacity=!bs.opacity?1:bs.opacity;bc[bp.symbol]=bl;bz.push(bs);a6=bs;a6.name=by.name==null||by.name===""?by.id:by.name;bl++}}var a5;var bj=a6||new b.MeshLambertMaterial({color:14540253,shading:b.FlatShading,side:a9.doubleSided?b.DoubleSide:b.FrontSide});var bt=a9.mesh.geometry3js;var bq=null;if(bl>1){bj=new b.MeshFaceMaterial(bz);for(bv=0;bv<bt.faces.length;bv++){var be=bt.faces[bv];be.materialIndex=bc[be.daeMaterial]}}if(bd!==undefined){aX(bt,bd);bj.morphTargets=true;a5=new b.SkinnedMesh(bt,bj,false);a5.skeleton=bd.skeleton;a5.skinController=ak[bd.url];a5.skinInstanceController=bd;a5.name="skin_"+N.length;N.push(a5)}else{if(bo!==undefined){r(bt,bo);bj.morphTargets=true;a5=new b.Mesh(bt,bj);a5.name="morph_"+k.length;k.push(a5)}else{a5=new b.Mesh(bt,bj)}}if(bq){bq.objectsWhoWantThisMaterial.push(a5)}bu.geometries.length>1?bk.add(a5):bk=a5}}for(bx=0;bx<bu.cameras.length;bx++){var bn=bu.cameras[bx];var bC=aj[bn.url];bk=new b.PerspectiveCamera(bC.fov,bC.aspect_ratio,bC.znear,bC.zfar)}bk.name=bu.name||bu.id||"";bk.matrix=bu.matrix;var a8=bu.matrix.decompose();bk.position=a8[0];bk.quaternion=a8[1];bk.useQuaternion=true;bk.scale=a8[2];if(ag.centerGeometry&&bk.geometry){var bA=b.GeometryUtils.center(bk.geometry);bA.multiply(bk.scale);bA.applyQuaternion(bk.quaternion);bk.position.sub(bA)}for(bx=0;bx<bu.nodes.length;bx++){bk.add(h(bu.nodes[bx],bu))}return bk}function s(a5,a6){for(var a4=0;a4<a5.joints.length;a4++){if(a5.joints[a4]==a6){return a4}}}function O(a4){return ar.evaluate(".//dae:library_nodes//dae:node[@id='"+a4+"']",ar,a0,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext()}function v(a6){var a9=[];var a5=1000000;var ba=-1000000;for(var a4 in S){var a7=S[a4];for(var a8=0;a8<a7.channel.length;a8++){var bc=a7.channel[a8];var bd=a7.sampler[a8];var a4=bc.target.split("/")[0];if(a4==a6.id){bd.create();bc.sampler=bd;a5=Math.min(a5,bd.startTime);ba=Math.max(ba,bd.endTime);a9.push(bc)}}}if(a9.length){a6.startTime=a5;a6.endTime=ba}return a9}function aZ(a9){var a7=10000000;for(var a6=0;a6<a9.channels.length;a6++){var a5=a9.channels[a6].sampler;for(var a4=0;a4<a5.input.length-1;a4++){var ba=a5.input[a4];var a8=a5.input[a4+1];a7=Math.min(a7,a8-ba)}}return a7}function af(a5,be){var a6={};var a8,a7;for(a8=0;a8<a5.channels.length;a8++){var a9=a5.channels[a8];a6[a9.sid]=a9}var bc=new b.Matrix4();for(a8=0;a8<a5.transforms.length;a8++){var a4=a5.transforms[a8];var a9=a6[a4.sid];if(a9!==undefined){var ba=a9.sampler;var bd;for(a7=0;a7<ba.input.length-1;a7++){if(ba.input[a7+1]>be){bd=ba.output[a7];break}}if(bd!==undefined){if(bd instanceof b.Matrix4){bc.multiplyMatrices(bc,bd)}else{bc.multiplyMatrices(bc,a4.matrix)}}else{bc.multiplyMatrices(bc,a4.matrix)}}else{bc.multiplyMatrices(bc,a4.matrix)}}return bc}function aJ(bf){if(bf.channels&&bf.channels.length){var bd=[],bj=[];for(var bh=0,a9=bf.channels.length;bh<a9;bh++){var bm=bf.channels[bh],a4=bm.fullSid,be=bm.sampler,ba=be.input,bc=bf.getTransformBySid(bm.sid),a5;if(bm.arrIndices){a5=[];for(var bg=0,bi=bm.arrIndices.length;bg<bi;bg++){a5[bg]=aE(bm.arrIndices[bg])}}else{a5=X(bm.member)}if(bc){if(bj.indexOf(a4)===-1){bj.push(a4)}for(var bg=0,bi=ba.length;bg<bi;bg++){var a8=ba[bg],bk=be.getData(bc.type,bg),bl=au(bd,a8);if(!bl){bl=new al(a8);var a7=A(bd,a8);bd.splice(a7==-1?bd.length:a7,0,bl)}bl.addTarget(a4,bc,a5,bk)}}else{console.log('Could not find transform "'+bm.sid+'" in node '+bf.id)}}for(var bh=0;bh<bj.length;bh++){var a6=bj[bh];for(var bg=0;bg<bd.length;bg++){var bl=bd[bg];if(!bl.hasTarget(a6)){y(bd,bl,bg,a6)}}}bf.keys=bd;bf.sids=bj}}function au(a7,a9){var a8=null;for(var a6=0,a4=a7.length;a6<a4&&a8==null;a6++){var a5=a7[a6];if(a5.time===a9){a8=a5}else{if(a5.time>a9){break}}}return a8}function A(a8,a9){var a5=-1;for(var a7=0,a4=a8.length;a7<a4&&a5==-1;a7++){var a6=a8[a7];if(a6.time>=a9){a5=a7}}return a5}function y(bf,bc,bd,a9){var bg=aC(bf,a9,bd?bd-1:0),ba=o(bf,a9,bd+1);if(bg&&ba){var a5=(bc.time-bg.time)/(ba.time-bg.time),be=bg.getTarget(a9),a8=ba.getTarget(a9).data,a4=be.data,a7;if(be.type==="matrix"){a7=a4}else{if(a4.length){a7=[];for(var a6=0;a6<a4.length;++a6){a7[a6]=a4[a6]+(a8[a6]-a4[a6])*a5}}else{a7=a4+(a8-a4)*a5}}bc.addTarget(a9,be.transform,be.member,a7)}}function o(a6,a7,a4){for(;a4<a6.length;a4++){var a5=a6[a4];if(a5.hasTarget(a7)){return a5}}return null}function aC(a6,a7,a4){a4=a4>=0?a4:a4+a6.length;for(;a4>=0;a4--){var a5=a6[a4];if(a5.hasTarget(a7)){return a5}}return null}function ai(){this.id="";this.init_from=""}ai.prototype.parse=function(a5){this.id=a5.getAttribute("id");for(var a4=0;a4<a5.childNodes.length;a4++){var a6=a5.childNodes[a4];if(a6.nodeName=="init_from"){this.init_from=a6.textContent}}return this};function M(){this.id="";this.name="";this.type="";this.skin=null;this.morph=null}M.prototype.parse=function(a5){this.id=a5.getAttribute("id");this.name=a5.getAttribute("name");this.type="none";for(var a4=0;a4<a5.childNodes.length;a4++){var a6=a5.childNodes[a4];switch(a6.nodeName){case"skin":this.skin=(new u()).parse(a6);this.type=a6.nodeName;break;case"morph":this.morph=(new n()).parse(a6);this.type=a6.nodeName;break;default:break}}return this};function n(){this.method=null;this.source=null;this.targets=null;this.weights=null}n.prototype.parse=function(a8){var a6={};var a4=[];var a7;this.method=a8.getAttribute("method");this.source=a8.getAttribute("source").replace(/^#/,"");for(a7=0;a7<a8.childNodes.length;a7++){var ba=a8.childNodes[a7];if(ba.nodeType!=1){continue}switch(ba.nodeName){case"source":var a9=(new aR()).parse(ba);a6[a9.id]=a9;break;case"targets":a4=this.parseInputs(ba);break;default:console.log(ba.nodeName);break}}for(a7=0;a7<a4.length;a7++){var a5=a4[a7];var a9=a6[a5.source];switch(a5.semantic){case"MORPH_TARGET":this.targets=a9.read();break;case"MORPH_WEIGHT":this.weights=a9.read();break;default:break}}return this};n.prototype.parseInputs=function(a6){var a4=[];for(var a5=0;a5<a6.childNodes.length;a5++){var a7=a6.childNodes[a5];if(a7.nodeType!=1){continue}switch(a7.nodeName){case"input":a4.push((new e()).parse(a7));break;default:break}}return a4};function u(){this.source="";this.bindShapeMatrix=null;this.invBindMatrices=[];this.joints=[];this.weights=[]}u.prototype.parse=function(a7){var a5={};var a4,a8;this.source=a7.getAttribute("source").replace(/^#/,"");this.invBindMatrices=[];this.joints=[];this.weights=[];for(var a6=0;a6<a7.childNodes.length;a6++){var bc=a7.childNodes[a6];if(bc.nodeType!=1){continue}switch(bc.nodeName){case"bind_shape_matrix":var a9=j(bc.textContent);this.bindShapeMatrix=ap(a9);break;case"source":var ba=new aR().parse(bc);a5[ba.id]=ba;break;case"joints":a4=bc;break;case"vertex_weights":a8=bc;break;default:console.log(bc.nodeName);break}}this.parseJoints(a4,a5);this.parseWeights(a8,a5);return this};u.prototype.parseJoints=function(a7,a5){for(var a6=0;a6<a7.childNodes.length;a6++){var a9=a7.childNodes[a6];if(a9.nodeType!=1){continue}switch(a9.nodeName){case"input":var a4=(new e()).parse(a9);var a8=a5[a4.source];if(a4.semantic=="JOINT"){this.joints=a8.read()}else{if(a4.semantic=="INV_BIND_MATRIX"){this.invBindMatrices=a8.read()}}break;default:break}}};u.prototype.parseWeights=function(a9,a4){var bj,bg,bd=[];for(var ba=0;ba<a9.childNodes.length;ba++){var a5=a9.childNodes[ba];if(a5.nodeType!=1){continue}switch(a5.nodeName){case"input":bd.push((new e()).parse(a5));break;case"v":bj=aY(a5.textContent);break;case"vcount":bg=aY(a5.textContent);break;default:break}}var be=0;for(var ba=0;ba<bg.length;ba++){var a7=bg[ba];var bc=[];for(var a8=0;a8<a7;a8++){var bf={};for(var a6=0;a6<bd.length;a6++){var bh=bd[a6];var bi=bj[be+bh.offset];switch(bh.semantic){case"JOINT":bf.joint=bi;break;case"WEIGHT":bf.weight=a4[bh.source].data[bi];break;default:break}}bc.push(bf);be+=bd.length}for(var a8=0;a8<bc.length;a8++){bc[a8].index=ba}this.weights.push(bc)}};function aP(){this.id="";this.name="";this.nodes=[];this.scene=new b.Object3D()}aP.prototype.getChildById=function(a7,a4){for(var a5=0;a5<this.nodes.length;a5++){var a6=this.nodes[a5].getChildById(a7,a4);if(a6){return a6}}return null};aP.prototype.getChildBySid=function(a4,a5){for(var a6=0;a6<this.nodes.length;a6++){var a7=this.nodes[a6].getChildBySid(a4,a5);if(a7){return a7}}return null};aP.prototype.parse=function(a5){this.id=a5.getAttribute("id");this.name=a5.getAttribute("name");this.nodes=[];for(var a4=0;a4<a5.childNodes.length;a4++){var a6=a5.childNodes[a4];if(a6.nodeType!=1){continue}switch(a6.nodeName){case"node":this.nodes.push((new aG()).parse(a6));break;default:break}}return this};function aG(){this.id="";this.name="";this.sid="";this.nodes=[];this.controllers=[];this.transforms=[];this.geometries=[];this.channels=[];this.matrix=new b.Matrix4()}aG.prototype.getChannelForTransform=function(bf){for(var ba=0;ba<this.channels.length;ba++){var bc=this.channels[ba];var a8=bc.target.split("/");var a4=a8.shift();var a5=a8.shift();var bd=(a5.indexOf(".")>=0);var be=(a5.indexOf("(")>=0);var a7;var a9;if(bd){a8=a5.split(".");a5=a8.shift();a9=a8.shift()}else{if(be){a7=a5.split("(");a5=a7.shift();for(var a6=0;a6<a7.length;a6++){a7[a6]=parseInt(a7[a6].replace(/\)/,""))}}}if(a5==bf){bc.info={sid:a5,dotSyntax:bd,arrSyntax:be,arrIndices:a7};return bc}}return null};aG.prototype.getChildById=function(a7,a4){if(this.id==a7){return this}if(a4){for(var a5=0;a5<this.nodes.length;a5++){var a6=this.nodes[a5].getChildById(a7,a4);if(a6){return a6}}}return null};aG.prototype.getChildBySid=function(a4,a5){if(this.sid==a4){return this}if(a5){for(var a6=0;a6<this.nodes.length;a6++){var a7=this.nodes[a6].getChildBySid(a4,a5);if(a7){return a7}}}return null};aG.prototype.getTransformBySid=function(a4){for(var a5=0;a5<this.transforms.length;a5++){if(this.transforms[a5].sid==a4){return this.transforms[a5]}}return null};aG.prototype.parse=function(a6){var a4;this.id=a6.getAttribute("id");this.sid=a6.getAttribute("sid");this.name=a6.getAttribute("name");this.type=a6.getAttribute("type");this.type=this.type=="JOINT"?this.type:"NODE";this.nodes=[];this.transforms=[];this.geometries=[];this.cameras=[];this.controllers=[];this.matrix=new b.Matrix4();for(var a5=0;a5<a6.childNodes.length;a5++){var a8=a6.childNodes[a5];if(a8.nodeType!=1){continue}switch(a8.nodeName){case"node":this.nodes.push((new aG()).parse(a8));break;case"instance_camera":this.cameras.push((new aA()).parse(a8));break;case"instance_controller":this.controllers.push((new H()).parse(a8));break;case"instance_geometry":this.geometries.push((new aB()).parse(a8));break;case"instance_light":break;case"instance_node":a4=a8.getAttribute("url").replace(/^#/,"");var a7=O(a4);if(a7){this.nodes.push((new aG()).parse(a7))}break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new aL()).parse(a8));break;case"extra":break;default:console.log(a8.nodeName);break}}this.channels=v(this);aJ(this);this.updateMatrix();return this};aG.prototype.updateMatrix=function(){this.matrix.identity();for(var a4=0;a4<this.transforms.length;a4++){this.transforms[a4].apply(this.matrix)}};function aL(){this.sid="";this.type="";this.data=[];this.obj=null}aL.prototype.parse=function(a4){this.sid=a4.getAttribute("sid");this.type=a4.nodeName;this.data=j(a4.textContent);this.convert();return this};aL.prototype.convert=function(){switch(this.type){case"matrix":this.obj=ap(this.data);break;case"rotate":this.angle=b.Math.degToRad(this.data[3]);case"translate":V(this.data,-1);this.obj=new b.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":V(this.data,1);this.obj=new b.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type);break}};aL.prototype.apply=function(a4){switch(this.type){case"matrix":a4.multiply(this.obj);break;case"translate":a4.translate(this.obj);break;case"rotate":a4.rotateByAxis(this.obj,this.angle);break;case"scale":a4.scale(this.obj);break}};aL.prototype.update=function(a6,a7){var a4=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(!a7){this.obj.copy(a6)}else{if(a7.length===1){switch(a7[0]){case 0:this.obj.n11=a6[0];this.obj.n21=a6[1];this.obj.n31=a6[2];this.obj.n41=a6[3];break;case 1:this.obj.n12=a6[0];this.obj.n22=a6[1];this.obj.n32=a6[2];this.obj.n42=a6[3];break;case 2:this.obj.n13=a6[0];this.obj.n23=a6[1];this.obj.n33=a6[2];this.obj.n43=a6[3];break;case 3:this.obj.n14=a6[0];this.obj.n24=a6[1];this.obj.n34=a6[2];this.obj.n44=a6[3];break}}else{if(a7.length===2){var a5="n"+(a7[0]+1)+(a7[1]+1);this.obj[a5]=a6}else{console.log("Incorrect addressing of matrix in transform.")}}}break;case"translate":case"scale":if(Object.prototype.toString.call(a7)==="[object Array]"){a7=a4[a7[0]]}switch(a7){case"X":this.obj.x=a6;break;case"Y":this.obj.y=a6;break;case"Z":this.obj.z=a6;break;default:this.obj.x=a6[0];this.obj.y=a6[1];this.obj.z=a6[2];break}break;case"rotate":if(Object.prototype.toString.call(a7)==="[object Array]"){a7=a4[a7[0]]}switch(a7){case"X":this.obj.x=a6;break;case"Y":this.obj.y=a6;break;case"Z":this.obj.z=a6;break;case"ANGLE":this.angle=b.Math.degToRad(a6);break;default:this.obj.x=a6[0];this.obj.y=a6[1];this.obj.z=a6[2];this.angle=b.Math.degToRad(a6[3]);break}break}};function H(){this.url="";this.skeleton=[];this.instance_material=[]}H.prototype.parse=function(a6){this.url=a6.getAttribute("url").replace(/^#/,"");this.skeleton=[];this.instance_material=[];for(var a5=0;a5<a6.childNodes.length;a5++){var a8=a6.childNodes[a5];if(a8.nodeType!==1){continue}switch(a8.nodeName){case"skeleton":this.skeleton.push(a8.textContent.replace(/^#/,""));break;case"bind_material":var a7=ar.evaluate(".//dae:instance_material",a8,a0,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(a7){var a4=a7.iterateNext();while(a4){this.instance_material.push((new m()).parse(a4));a4=a7.iterateNext()}}break;case"extra":break;default:break}}return this};function m(){this.symbol="";this.target=""}m.prototype.parse=function(a4){this.symbol=a4.getAttribute("symbol");this.target=a4.getAttribute("target").replace(/^#/,"");return this};function aB(){this.url="";this.instance_material=[]}aB.prototype.parse=function(a6){this.url=a6.getAttribute("url").replace(/^#/,"");this.instance_material=[];for(var a5=0;a5<a6.childNodes.length;a5++){var a8=a6.childNodes[a5];if(a8.nodeType!=1){continue}if(a8.nodeName=="bind_material"){var a7=ar.evaluate(".//dae:instance_material",a8,a0,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(a7){var a4=a7.iterateNext();while(a4){this.instance_material.push((new m()).parse(a4));a4=a7.iterateNext()}}break}}return this};function aF(){this.id="";this.mesh=null}aF.prototype.parse=function(a5){this.id=a5.getAttribute("id");aK(this,a5);for(var a4=0;a4<a5.childNodes.length;a4++){var a6=a5.childNodes[a4];switch(a6.nodeName){case"mesh":this.mesh=(new ao(this)).parse(a6);break;case"extra":break;default:break}}return this};function ao(a4){this.geometry=a4.id;this.primitives=[];this.vertices=null;this.geometry3js=null}ao.prototype.parse=function(a8){this.primitives=[];var a7,a6;for(a7=0;a7<a8.childNodes.length;a7++){var a9=a8.childNodes[a7];switch(a9.nodeName){case"source":a1(a9);break;case"vertices":this.vertices=(new an()).parse(a9);break;case"triangles":this.primitives.push((new ad().parse(a9)));break;case"polygons":this.primitives.push((new E().parse(a9)));break;case"polylist":this.primitives.push((new aH().parse(a9)));break;default:break}}this.geometry3js=new b.Geometry();var a5=ae[this.vertices.input.POSITION.source].data;for(a7=0;a7<a5.length;a7+=3){this.geometry3js.vertices.push(Z(a5,a7).clone())}for(a7=0;a7<this.primitives.length;a7++){var a4=this.primitives[a7];a4.setVertices(this.vertices);this.handlePrimitive(a4,this.geometry3js)}this.geometry3js.computeCentroids();this.geometry3js.computeFaceNormals();if(this.geometry3js.calcNormals){this.geometry3js.computeVertexNormals();delete this.geometry3js.calcNormals}this.geometry3js.computeBoundingBox();return this};ao.prototype.handlePrimitive=function(bc,a6){var bu,bt,bn=bc.p,bh=bc.inputs;var a4,bm,a7;var bg,bs;var bq=0,bo=3,bk=0;var bC=[];for(bu=0;bu<bh.length;bu++){a4=bh[bu];var bp=a4.offset+1;bk=(bk<bp)?bp:bk;switch(a4.semantic){case"TEXCOORD":bC.push(a4.set);break}}for(var be=0;be<bn.length;++be){var br=bn[be],bw=0;while(bw<br.length){var ba=[];var bv=[];var bA=null;var bi=[];if(bc.vcount){bo=bc.vcount.length?bc.vcount[bq++]:bc.vcount}else{bo=br.length/bk}for(bu=0;bu<bo;bu++){for(bt=0;bt<bh.length;bt++){a4=bh[bt];bg=ae[a4.source];bm=br[bw+(bu*bk)+a4.offset];bs=bg.accessor.params.length;a7=bm*bs;switch(a4.semantic){case"VERTEX":ba.push(bm);break;case"NORMAL":bv.push(Z(bg.data,a7));break;case"TEXCOORD":bA=bA||{};if(bA[a4.set]===undefined){bA[a4.set]=[]}bA[a4.set].push(new b.Vector2(bg.data[a7],bg.data[a7+1]));break;case"COLOR":bi.push(new b.Color().setRGB(bg.data[a7],bg.data[a7+1],bg.data[a7+2]));break;default:break}}}if(bv.length==0){a4=this.vertices.input.NORMAL;if(a4){bg=ae[a4.source];bs=bg.accessor.params.length;for(var bd=0,bf=ba.length;bd<bf;bd++){bv.push(Z(bg.data,ba[bd]*bs))}}else{a6.calcNormals=true}}if(!bA){bA={};a4=this.vertices.input.TEXCOORD;if(a4){bC.push(a4.set);bg=ae[a4.source];bs=bg.accessor.params.length;for(var bd=0,bf=ba.length;bd<bf;bd++){a7=ba[bd]*bs;if(bA[a4.set]===undefined){bA[a4.set]=[]}bA[a4.set].push(new b.Vector2(bg.data[a7],1-bg.data[a7+1]))}}}if(bi.length==0){a4=this.vertices.input.COLOR;if(a4){bg=ae[a4.source];bs=bg.accessor.params.length;for(var bd=0,bf=ba.length;bd<bf;bd++){a7=ba[bd]*bs;bi.push(new b.Color().setRGB(bg.data[a7],bg.data[a7+1],bg.data[a7+2]))}}}var a8=null,a9=[],bl,bj;if(bo===3){a9.push(new b.Face3(ba[0],ba[1],ba[2],bv,bi.length?bi:new b.Color()))}else{if(bo===4){a9.push(new b.Face4(ba[0],ba[1],ba[2],ba[3],bv,bi.length?bi:new b.Color()))}else{if(bo>4&&ag.subdivideFaces){var a5=bi.length?bi:new b.Color(),bz,by,bx,bE,bD,bB;for(bt=1;bt<bo-1;){a9.push(new b.Face3(ba[0],ba[bt],ba[bt+1],[bv[0],bv[bt++],bv[bt]],a5))}}}}if(a9.length){for(var bd=0,bf=a9.length;bd<bf;bd++){a8=a9[bd];a8.daeMaterial=bc.material;a6.faces.push(a8);for(bt=0;bt<bC.length;bt++){bl=bA[bC[bt]];if(bo>4){bj=[bl[0],bl[bd+1],bl[bd+2]]}else{if(bo===4){bj=[bl[0],bl[1],bl[2],bl[3]]}else{bj=[bl[0],bl[1],bl[2]]}}if(!a6.faceVertexUvs[bt]){a6.faceVertexUvs[bt]=[]}a6.faceVertexUvs[bt].push(bj)}}}else{console.log("dropped face with vcount "+bo+" for geometry with id: "+a6.id)}bw+=bk*bo}}};function E(){this.material="";this.count=0;this.inputs=[];this.vcount=null;this.p=[];this.geometry=new b.Geometry()}E.prototype.setVertices=function(a4){for(var a5=0;a5<this.inputs.length;a5++){if(this.inputs[a5].source==a4.id){this.inputs[a5].source=a4.input.POSITION.source}}};E.prototype.parse=function(a5){this.material=a5.getAttribute("material");this.count=q(a5,"count",0);for(var a4=0;a4<a5.childNodes.length;a4++){var a6=a5.childNodes[a4];switch(a6.nodeName){case"input":this.inputs.push((new e()).parse(a5.childNodes[a4]));break;case"vcount":this.vcount=aY(a6.textContent);break;case"p":this.p.push(aY(a6.textContent));break;case"ph":console.warn("polygon holes not yet supported!");break;default:break}}return this};function aH(){E.call(this);this.vcount=[]}aH.prototype=Object.create(E.prototype);function ad(){E.call(this);this.vcount=3}ad.prototype=Object.create(E.prototype);function aI(){this.source="";this.count=0;this.stride=0;this.params=[]}aI.prototype.parse=function(a5){this.params=[];this.source=a5.getAttribute("source");this.count=q(a5,"count",0);this.stride=q(a5,"stride",0);for(var a4=0;a4<a5.childNodes.length;a4++){var a7=a5.childNodes[a4];if(a7.nodeName=="param"){var a6={};a6.name=a7.getAttribute("name");a6.type=a7.getAttribute("type");this.params.push(a6)}}return this};function an(){this.input={}}an.prototype.parse=function(a6){this.id=a6.getAttribute("id");for(var a5=0;a5<a6.childNodes.length;a5++){if(a6.childNodes[a5].nodeName=="input"){var a4=(new e()).parse(a6.childNodes[a5]);this.input[a4.semantic]=a4}}return this};function e(){this.semantic="";this.offset=0;this.source="";this.set=0}e.prototype.parse=function(a4){this.semantic=a4.getAttribute("semantic");this.source=a4.getAttribute("source").replace(/^#/,"");this.set=q(a4,"set",-1);this.offset=q(a4,"offset",0);if(this.semantic=="TEXCOORD"&&this.set<0){this.set=0}return this};function aR(a4){this.id=a4;this.type=null}aR.prototype.parse=function(a6){this.id=a6.getAttribute("id");for(var a5=0;a5<a6.childNodes.length;a5++){var a7=a6.childNodes[a5];switch(a7.nodeName){case"bool_array":this.data=am(a7.textContent);this.type=a7.nodeName;break;case"float_array":this.data=j(a7.textContent);this.type=a7.nodeName;break;case"int_array":this.data=aY(a7.textContent);this.type=a7.nodeName;break;case"IDREF_array":case"Name_array":this.data=J(a7.textContent);this.type=a7.nodeName;break;case"technique_common":for(var a4=0;a4<a7.childNodes.length;a4++){if(a7.childNodes[a4].nodeName=="accessor"){this.accessor=(new aI()).parse(a7.childNodes[a4]);break}}break;default:break}}return this};aR.prototype.read=function(){var a5=[];var a8=this.accessor.params[0];switch(a8.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var a6=0;a6<this.data.length;a6+=16){var a7=this.data.slice(a6,a6+16);var a4=ap(a7);a5.push(a4)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+a8.type+".");break}return a5};function g(){this.id="";this.name="";this.instance_effect=null}g.prototype.parse=function(a5){this.id=a5.getAttribute("id");this.name=a5.getAttribute("name");for(var a4=0;a4<a5.childNodes.length;a4++){if(a5.childNodes[a4].nodeName=="instance_effect"){this.instance_effect=(new B()).parse(a5.childNodes[a4]);break}}return this};function at(){this.color=new b.Color(0);this.color.setRGB(Math.random(),Math.random(),Math.random());this.color.a=1;this.texture=null;this.texcoord=null;this.texOpts=null}at.prototype.isColor=function(){return(this.texture==null)};at.prototype.isTexture=function(){return(this.texture!=null)};at.prototype.parse=function(a6){for(var a5=0;a5<a6.childNodes.length;a5++){var a7=a6.childNodes[a5];if(a7.nodeType!=1){continue}switch(a7.nodeName){case"color":var a4=j(a7.textContent);this.color=new b.Color(0);this.color.setRGB(a4[0],a4[1],a4[2]);this.color.a=a4[3];break;case"texture":this.texture=a7.getAttribute("texture");this.texcoord=a7.getAttribute("texcoord");this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1,};this.parseTexture(a7);break;default:break}}return this};at.prototype.parseTexture=function(a5){if(!a5.childNodes){return this}if(a5.childNodes[1]&&a5.childNodes[1].nodeName==="extra"){a5=a5.childNodes[1];if(a5.childNodes[1]&&a5.childNodes[1].nodeName==="technique"){a5=a5.childNodes[1]}}for(var a4=0;a4<a5.childNodes.length;a4++){var a6=a5.childNodes[a4];switch(a6.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[a6.nodeName]=parseFloat(a6.textContent);break;case"wrapU":case"wrapV":this.texOpts[a6.nodeName]=parseInt(a6.textContent);break;default:this.texOpts[a6.nodeName]=a6.textContent;break}}return this};function ax(a5,a4){this.type=a5;this.effect=a4;this.material=null}ax.prototype.parse=function(a5){for(var a4=0;a4<a5.childNodes.length;a4++){var a7=a5.childNodes[a4];if(a7.nodeType!=1){continue}switch(a7.nodeName){case"ambient":case"emission":case"diffuse":case"specular":case"transparent":case"normal":this[a7.nodeName]=(new at()).parse(a7);break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var a6=av(a7,".//dae:float");if(a6.length>0){this[a7.nodeName]=parseFloat(a6[0].textContent)}break;default:break}}this.create();return this};ax.prototype.create=function(){var bd={};var bh=(this["transparency"]!==undefined&&this["transparency"]<1);var a9=0;var be=null;var ba=null;function a5(){var bi=0,bj=null;if(ba&&ba.numberOfAwaitedTextures){ba.numberOfAwaitedTextures--;if(ba.numberOfAwaitedTextures===0){delete ba.numberOfAwaitedTextures}}}for(var a4 in this){switch(a4){case"ambient":case"emission":case"diffuse":case"specular":case"normal":var bg=this[a4];if(bg instanceof at){if(bg.isTexture()){var a7=bg.texture;var bf=this.effect.sampler[a7].source;if(bf){var a6=this.effect.surface[bf];var a8=p[a6.init_from];if(a8){var bc=b.ImageUtils.loadTexture(aV+a8.init_from,undefined,a5,null,true);a9++;bc.wrapS=bg.texOpts.wrapU?b.RepeatWrapping:b.ClampToEdgeWrapping;bc.wrapT=bg.texOpts.wrapV?b.RepeatWrapping:b.ClampToEdgeWrapping;bc.offset.x=bg.texOpts.offsetU;bc.offset.y=bg.texOpts.offsetV;bc.repeat.x=bg.texOpts.repeatU;bc.repeat.y=bg.texOpts.repeatV;if(a4==="normal"){bd.normalMap=bc}else{bd.map=bc}if(a4==="emission"){bd.emissive=16777215}}}}else{if(a4==="diffuse"||!bh){if(a4==="emission"){bd.emissive=bg.color.getHex()}else{bd[a4]=bg.color.getHex()}}}}break;case"shininess":bd[a4]=this[a4];break;case"reflectivity":bd[a4]=this[a4];if(bd[a4]>0){bd.envMap=ag.defaultEnvMap}bd.combine=b.MixOperation;break;case"index_of_refraction":bd.refractionRatio=this[a4];if(this[a4]!==1){bd.envMap=ag.defaultEnvMap}break;case"transparency":if(bh){bd.transparent=true;bd.opacity=this[a4];bh=true}break;default:break}}bd.shading=T;bd.side=this.effect.doubleSided?b.DoubleSide:b.FrontSide;switch(this.type){case"constant":if(bd.emissive!=undefined){bd.color=bd.emissive}ba=new b.MeshBasicMaterial(bd);break;case"phong":case"blinn":if(bd.diffuse!=undefined){bd.color=bd.diffuse}ba=new b.MeshPhongMaterial(bd);break;case"lambert":default:if(bd.diffuse!=undefined){bd.color=bd.diffuse}ba=new b.MeshLambertMaterial(bd);break}this.material=ba;return this.material};function f(a4){this.effect=a4;this.init_from=null;this.format=null}f.prototype.parse=function(a5){for(var a4=0;a4<a5.childNodes.length;a4++){var a6=a5.childNodes[a4];if(a6.nodeType!=1){continue}switch(a6.nodeName){case"init_from":this.init_from=a6.textContent;break;case"format":this.format=a6.textContent;break;default:console.log("unhandled Surface prop: "+a6.nodeName);break}}return this};function Q(a4){this.effect=a4;this.source=null;this.wrap_s=null;this.wrap_t=null;this.minfilter=null;this.magfilter=null;this.mipfilter=null}Q.prototype.parse=function(a5){for(var a4=0;a4<a5.childNodes.length;a4++){var a6=a5.childNodes[a4];if(a6.nodeType!=1){continue}switch(a6.nodeName){case"source":this.source=a6.textContent;break;case"minfilter":this.minfilter=a6.textContent;break;case"magfilter":this.magfilter=a6.textContent;break;case"mipfilter":this.mipfilter=a6.textContent;break;case"wrap_s":this.wrap_s=a6.textContent;break;case"wrap_t":this.wrap_t=a6.textContent;break;default:console.log("unhandled Sampler2D prop: "+a6.nodeName);break}}return this};function R(){this.id="";this.name="";this.shader=null;this.surface={};this.sampler={}}R.prototype.create=function(){if(this.shader==null){return null}};R.prototype.parse=function(a5){this.id=a5.getAttribute("id");this.name=a5.getAttribute("name");aK(this,a5);this.shader=null;for(var a4=0;a4<a5.childNodes.length;a4++){var a6=a5.childNodes[a4];if(a6.nodeType!=1){continue}switch(a6.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(a6));break;default:break}}return this};R.prototype.parseNewparam=function(a6){var a4=a6.getAttribute("sid");for(var a5=0;a5<a6.childNodes.length;a5++){var a7=a6.childNodes[a5];if(a7.nodeType!=1){continue}switch(a7.nodeName){case"surface":this.surface[a4]=(new f(this)).parse(a7);break;case"sampler2D":this.sampler[a4]=(new Q(this)).parse(a7);break;case"extra":break;default:console.log(a7.nodeName);break}}};R.prototype.parseProfileCOMMON=function(a6){var a7;for(var a5=0;a5<a6.childNodes.length;a5++){var a8=a6.childNodes[a5];if(a8.nodeType!=1){continue}switch(a8.nodeName){case"profile_COMMON":this.parseProfileCOMMON(a8);break;case"technique":a7=a8;break;case"newparam":this.parseNewparam(a8);break;case"image":var a4=(new ai()).parse(a8);p[a4.id]=a4;break;case"extra":break;default:console.log(a8.nodeName);break}}return a7};R.prototype.parseTechnique=function(a5){for(var a4=0;a4<a5.childNodes.length;a4++){var a6=a5.childNodes[a4];if(a6.nodeType!=1){continue}switch(a6.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=(new ax(a6.nodeName,this)).parse(a6);break;default:break}}};function B(){this.url=""}B.prototype.parse=function(a4){this.url=a4.getAttribute("url").replace(/^#/,"");return this};function aW(){this.id="";this.name="";this.source={};this.sampler=[];this.channel=[]}aW.prototype.parse=function(a6){this.id=a6.getAttribute("id");this.name=a6.getAttribute("name");this.source={};for(var a5=0;a5<a6.childNodes.length;a5++){var a9=a6.childNodes[a5];if(a9.nodeType!=1){continue}switch(a9.nodeName){case"animation":var a7=(new aW()).parse(a9);for(var a8 in a7.source){this.source[a8]=a7.source[a8]}for(var a4=0;a4<a7.channel.length;a4++){this.channel.push(a7.channel[a4]);this.sampler.push(a7.sampler[a4])}break;case"source":var a8=(new aR()).parse(a9);this.source[a8.id]=a8;break;case"sampler":this.sampler.push((new I(this)).parse(a9));break;case"channel":this.channel.push((new P(this)).parse(a9));break;default:break}}return this};function P(a4){this.animation=a4;this.source="";this.target="";this.fullSid=null;this.sid=null;this.dotSyntax=null;this.arrSyntax=null;this.arrIndices=null;this.member=null}P.prototype.parse=function(a6){this.source=a6.getAttribute("source").replace(/^#/,"");this.target=a6.getAttribute("target");var a8=this.target.split("/");var bc=a8.shift();var a4=a8.shift();var ba=(a4.indexOf(".")>=0);var a7=(a4.indexOf("(")>=0);if(ba){a8=a4.split(".");this.sid=a8.shift();this.member=a8.shift()}else{if(a7){var a9=a4.split("(");this.sid=a9.shift();for(var a5=0;a5<a9.length;a5++){a9[a5]=parseInt(a9[a5].replace(/\)/,""))}this.arrIndices=a9}else{this.sid=a4}}this.fullSid=a4;this.dotSyntax=ba;this.arrSyntax=a7;return this};function I(a4){this.id="";this.animation=a4;this.inputs=[];this.input=null;this.output=null;this.strideOut=null;this.interpolation=null;this.startTime=null;this.endTime=null;this.duration=0}I.prototype.parse=function(a5){this.id=a5.getAttribute("id");this.inputs=[];for(var a4=0;a4<a5.childNodes.length;a4++){var a6=a5.childNodes[a4];if(a6.nodeType!=1){continue}switch(a6.nodeName){case"input":this.inputs.push((new e()).parse(a6));break;default:break}}return this};I.prototype.create=function(){for(var a5=0;a5<this.inputs.length;a5++){var a4=this.inputs[a5];var a6=this.animation.source[a4.source];switch(a4.semantic){case"INPUT":this.input=a6.read();break;case"OUTPUT":this.output=a6.read();this.strideOut=a6.accessor.stride;break;case"INTERPOLATION":this.interpolation=a6.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(a4.semantic);break}}this.startTime=0;this.endTime=0;this.duration=0;if(this.input.length){this.startTime=100000000;this.endTime=-100000000;for(var a5=0;a5<this.input.length;a5++){this.startTime=Math.min(this.startTime,this.input[a5]);this.endTime=Math.max(this.endTime,this.input[a5])}this.duration=this.endTime-this.startTime}};I.prototype.getData=function(a6,a4){var a7;if(a6==="matrix"&&this.strideOut===16){a7=this.output[a4]}else{if(this.strideOut>1){a7=[];a4*=this.strideOut;for(var a5=0;a5<this.strideOut;++a5){a7[a5]=this.output[a4+a5]}if(this.strideOut===3){switch(a6){case"rotate":case"translate":V(a7,-1);break;case"scale":V(a7,1);break}}else{if(this.strideOut===4&&a6==="matrix"){V(a7,-1)}}}else{a7=this.output[a4]}}return a7};function al(a4){this.targets=[];this.time=a4}al.prototype.addTarget=function(a7,a4,a6,a5){this.targets.push({sid:a7,member:a6,transform:a4,data:a5})};al.prototype.apply=function(a4){for(var a5=0;a5<this.targets.length;++a5){var a6=this.targets[a5];if(!a4||a6.sid===a4){a6.transform.update(a6.data,a6.member)}}};al.prototype.getTarget=function(a5){for(var a4=0;a4<this.targets.length;++a4){if(this.targets[a4].sid===a5){return this.targets[a4]}}return null};al.prototype.hasTarget=function(a5){for(var a4=0;a4<this.targets.length;++a4){if(this.targets[a4].sid===a5){return true}}return false};al.prototype.interpolate=function(be,a6){for(var ba=0;ba<this.targets.length;++ba){var bd=this.targets[ba],a4=be.getTarget(bd.sid),a9;if(bd.transform.type!=="matrix"&&a4){var a7=(a6-this.time)/(be.time-this.time),bc=a4.data,a5=bd.data;if(a7<0||a7>1){console.log("Key.interpolate: Warning! Scale out of bounds:"+a7);a7=a7<0?0:1}if(a5.length){a9=[];for(var a8=0;a8<a5.length;++a8){a9[a8]=a5[a8]+(bc[a8]-a5[a8])*a7}}else{a9=a5+(bc-a5)*a7}}else{a9=bd.data}bd.transform.update(a9,bd.member)}};function aT(){this.id="";this.name="";this.technique=""}aT.prototype.parse=function(a5){this.id=a5.getAttribute("id");this.name=a5.getAttribute("name");for(var a4=0;a4<a5.childNodes.length;a4++){var a6=a5.childNodes[a4];if(a6.nodeType!=1){continue}switch(a6.nodeName){case"optics":this.parseOptics(a6);break;default:break}}return this};aT.prototype.parseOptics=function(a8){for(var a7=0;a7<a8.childNodes.length;a7++){if(a8.childNodes[a7].nodeName=="technique_common"){var ba=a8.childNodes[a7];for(var a6=0;a6<ba.childNodes.length;a6++){this.technique=ba.childNodes[a6].nodeName;if(this.technique=="perspective"){var a9=ba.childNodes[a6];for(var a4=0;a4<a9.childNodes.length;a4++){var bc=a9.childNodes[a4];switch(bc.nodeName){case"yfov":this.yfov=bc.textContent;break;case"xfov":this.xfov=bc.textContent;break;case"znear":this.znear=bc.textContent;break;case"zfar":this.zfar=bc.textContent;break;case"aspect_ratio":this.aspect_ratio=bc.textContent;break}}}else{if(this.technique=="orthographic"){var a5=ba.childNodes[a6];for(var a4=0;a4<a5.childNodes.length;a4++){var bc=a5.childNodes[a4];switch(bc.nodeName){case"xmag":this.xmag=bc.textContent;break;case"ymag":this.ymag=bc.textContent;break;case"znear":this.znear=bc.textContent;break;case"zfar":this.zfar=bc.textContent;break;case"aspect_ratio":this.aspect_ratio=bc.textContent;break}}}}}}}return this};function aA(){this.url=""}aA.prototype.parse=function(a4){this.url=a4.getAttribute("url").replace(/^#/,"");return this};function a1(a4){var a5=a4.getAttribute("id");if(ae[a5]!=undefined){return ae[a5]}ae[a5]=(new aR(a5)).parse(a4);return ae[a5]}function a0(a4){if(a4=="dae"){return"http://www.collada.org/2005/11/COLLADASchema"}return null}function am(a8){var a5=J(a8);var a7=[];for(var a6=0,a4=a5.length;a6<a4;a6++){a7.push((a5[a6]=="true"||a5[a6]=="1")?true:false)}return a7}function j(a8){var a5=J(a8);var a7=[];for(var a6=0,a4=a5.length;a6<a4;a6++){a7.push(parseFloat(a5[a6]))}return a7}function aY(a8){var a5=J(a8);var a7=[];for(var a6=0,a4=a5.length;a6<a4;a6++){a7.push(parseInt(a5[a6],10))}return a7}function J(a4){return(a4.length>0)?w(a4).split(/\s+/):[]}function w(a4){return a4.replace(/^\s+/,"").replace(/\s+$/,"")}function a2(a6,a5,a4){if(a6.hasAttribute(a5)){return parseFloat(a6.getAttribute(a5))}else{return a4}}function q(a6,a5,a4){if(a6.hasAttribute(a5)){return parseInt(a6.getAttribute(a5),10)}else{return a4}}function aN(a6,a5,a4){if(a6.hasAttribute(a5)){return a6.getAttribute(a5)}else{return a4}}function a3(a6,a4){if(a6===undefined){var a5="0.";while(a5.length<a4+2){a5+="0"}return a5}a4=a4||2;var a7=a6.toString().split(".");a7[1]=a7.length>1?a7[1].substr(0,a4):"0";while(a7[1].length<a4){a7[1]+="0"}return a7.join(".")}function av(a5,a7){var a8=ar.evaluate(a7,a5,a0,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);var a6=a8.iterateNext();var a4=[];while(a6){a4.push(a6);a6=a8.iterateNext()}return a4}function aK(a6,a4){a6.doubleSided=false;var a5=ar.evaluate(".//dae:extra//dae:double_sided",a4,a0,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(a5){a5=a5.iterateNext();if(a5&&parseInt(a5.textContent,10)===1){a6.doubleSided=true}}}function Y(){if(!ag.convertUpAxis||az===ag.upAxis){D=null}else{switch(az){case"X":D=ag.upAxis==="Y"?"XtoY":"XtoZ";break;case"Y":D=ag.upAxis==="X"?"YtoX":"YtoZ";break;case"Z":D=ag.upAxis==="X"?"ZtoX":"ZtoY";break}}}function V(a6,a4){if(!ag.convertUpAxis||az===ag.upAxis){return}switch(D){case"XtoY":var a5=a6[0];a6[0]=a4*a6[1];a6[1]=a5;break;case"XtoZ":var a5=a6[2];a6[2]=a6[1];a6[1]=a6[0];a6[0]=a5;break;case"YtoX":var a5=a6[0];a6[0]=a6[1];a6[1]=a4*a5;break;case"YtoZ":var a5=a6[1];a6[1]=a4*a6[2];a6[2]=a5;break;case"ZtoX":var a5=a6[0];a6[0]=a6[1];a6[1]=a6[2];a6[2]=a5;break;case"ZtoY":var a5=a6[1];a6[1]=a6[2];a6[2]=a4*a5;break}}function Z(a5,a6){var a4=[a5[a6],a5[a6+1],a5[a6+2]];V(a4,-1);return new b.Vector3(a4[0],a4[1],a4[2])}function ap(a5){if(ag.convertUpAxis){var a4=[a5[0],a5[4],a5[8]];V(a4,-1);a5[0]=a4[0];a5[4]=a4[1];a5[8]=a4[2];a4=[a5[1],a5[5],a5[9]];V(a4,-1);a5[1]=a4[0];a5[5]=a4[1];a5[9]=a4[2];a4=[a5[2],a5[6],a5[10]];V(a4,-1);a5[2]=a4[0];a5[6]=a4[1];a5[10]=a4[2];a4=[a5[0],a5[1],a5[2]];V(a4,-1);a5[0]=a4[0];a5[1]=a4[1];a5[2]=a4[2];a4=[a5[4],a5[5],a5[6]];V(a4,-1);a5[4]=a4[0];a5[5]=a4[1];a5[6]=a4[2];a4=[a5[8],a5[9],a5[10]];V(a4,-1);a5[8]=a4[0];a5[9]=a4[1];a5[10]=a4[2];a4=[a5[3],a5[7],a5[11]];V(a4,-1);a5[3]=a4[0];a5[7]=a4[1];a5[11]=a4[2]}return new b.Matrix4(a5[0],a5[1],a5[2],a5[3],a5[4],a5[5],a5[6],a5[7],a5[8],a5[9],a5[10],a5[11],a5[12],a5[13],a5[14],a5[15])}function aE(a5){if(a5>-1&&a5<3){var a4=["X","Y","Z"],a6={X:0,Y:1,Z:2};a5=X(a4[a5]);a5=a6[a5]}return a5}function X(a4){if(ag.convertUpAxis){switch(a4){case"X":switch(D){case"XtoY":case"XtoZ":case"YtoX":a4="Y";break;case"ZtoX":a4="Z";break}break;case"Y":switch(D){case"XtoY":case"YtoX":case"ZtoX":a4="X";break;case"XtoZ":case"YtoZ":case"ZtoY":a4="Z";break}break;case"Z":switch(D){case"XtoZ":a4="X";break;case"YtoZ":case"ZtoX":case"ZtoY":a4="Y";break}break}}return a4}return{load:l,loadFromSpec:ah,parse:aq,setPreferredShading:G,applySkin:aX,geometries:aw,options:ag}};b.ColladaLoader=a;return a});define("DS/Visualization/ColladaLoader",["DS/VisuLoaders/ColladaLoader","DS/Visualization/ThreeJS_DS"],function(a,b){return b});define("DS/Shaders/AdaptativeBlurShader",["DS/Visualization/ThreeJS_DS"],function(d){var a={defines:{NB_SAMPLES:1,STEP:"1.5"},uniforms:{tDiffuse:{type:"t",value:null},invSize:{type:"v2",value:new d.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","float result = 0.0;","float total = 0.0;","for (int i = -NB_SAMPLES; i <= NB_SAMPLES; ++i) {","for (int j = -NB_SAMPLES; j <= NB_SAMPLES; ++j) {","vec2 offset = STEP * invSize * vec2(float(i), float(j));","float weight = 1.0 / (1.0 + dot(offset, offset));","result += weight * texture2D(tDiffuse, vUv + offset).x;","total += weight;","}","}","result /= total;","gl_FragColor = vec4(vec3(result), 1.0);","}"].join("\n")},c={defines:{NB_SAMPLES:4,STEP:1.5},uniforms:{tDiffuse:{type:"t",value:null},tNormalDepth:{type:"t",value:null},invSize:{type:"v2",value:new d.Vector2(512,512)},radius:{type:"f",value:0.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D tDiffuse;","uniform sampler2D tNormalDepth;","varying vec2 vUv;","void main() {","vec2 screenPos = vUv;","vec4 normalDepth = texture2D( tNormalDepth, vUv );",window.webVRBypass?"normalDepth.xy = vec2(-1.0,-1.0)+2.0*normalDepth.xy;":"","float depth = normalDepth.w;","vec3 normal = vec3(0.0, 0.0, 1.0);","if (dot(normalDepth.xy, normalDepth.xy) > 0.000001) {","   normal.z = 2.0 * dot(normalDepth.xy, normalDepth.xy) - 1.0;","   normal.xy = normalize(normalDepth.xy) * sqrt(1.0 - normal.z * normal.z);","}","float result = texture2D(tDiffuse, vUv).x;","float total = 1.0;","for (int i = -NB_SAMPLES; i <= NB_SAMPLES; ++i) {","if (i != 0) {","vec2 pos = vUv + STEP * vec2(invSize.x * float(i), 0.0);","vec4 normalDepth2 = texture2D( tNormalDepth, pos );",window.webVRBypass?"normalDepth2.xy = vec2(-1.0,-1.0)+2.0*normalDepth2.xy;":"","float depth2 = normalDepth2.w;","vec3 normal2 = vec3(0.0, 0.0, 1.0);","if (dot(normalDepth2.xy, normalDepth2.xy) > 0.000001) {","   normal2.z = 2.0 * dot(normalDepth2.xy, normalDepth2.xy) - 1.0;","   normal2.xy = normalize(normalDepth2.xy) * sqrt(1.0 - normal2.z * normal2.z);","}","float weightDepth = 1.0 / (1.0 + 100.0*abs(depth2 - depth));","float weightNormal = clamp(dot(normal, normal2), 0.0, 1.0);","result += weightDepth * weightNormal * texture2D(tDiffuse, pos).x;","total += weightDepth * weightNormal;","}","}","result /= total;","gl_FragColor = vec4(vec3(result), 1.0);","}"].join("\n")},b={defines:{NB_SAMPLES:4,STEP:1.5},uniforms:{tDiffuse:{type:"t",value:null},tNormalDepth:{type:"t",value:null},invSize:{type:"v2",value:new d.Vector2(512,512)},radius:{type:"f",value:0.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D tDiffuse;","uniform sampler2D tNormalDepth;","varying vec2 vUv;","void main() {","vec2 screenPos = vUv;","vec4 normalDepth = texture2D( tNormalDepth, vUv );",window.webVRBypass?"normalDepth.xy = vec2(-1.0,-1.0)+2.0*normalDepth.xy;":"","float depth = normalDepth.w;","vec3 normal = vec3(0.0, 0.0, 1.0);","if (dot(normalDepth.xy, normalDepth.xy) > 0.000001) {","   normal.z = 2.0 * dot(normalDepth.xy, normalDepth.xy) - 1.0;","   normal.xy = normalize(normalDepth.xy) * sqrt(1.0 - normal.z * normal.z);","}","float result = texture2D(tDiffuse, vUv).x;","float total = 1.0;","for (int i = -NB_SAMPLES; i <= NB_SAMPLES; ++i) {","if (i != 0) {","vec2 pos = vUv + STEP * vec2(0.0, invSize.y * float(i));","vec4 normalDepth2 = texture2D( tNormalDepth, pos );",window.webVRBypass?"normalDepth2.xy = vec2(-1.0,-1.0)+2.0*normalDepth2.xy;":"","float depth2 = normalDepth2.w;","vec3 normal2 = vec3(0.0, 0.0, 1.0);","if (dot(normalDepth2.xy, normalDepth2.xy) > 0.000001) {","   normal2.z = 2.0 * dot(normalDepth2.xy, normalDepth2.xy) - 1.0;","   normal2.xy = normalize(normalDepth2.xy) * sqrt(1.0 - normal2.z * normal2.z);","}","float weightDepth = 1.0 / (1.0 + 100.0*abs(depth2 - depth));","float weightNormal = clamp(dot(normal, normal2), 0.0, 1.0);","result += weightDepth * weightNormal * texture2D(tDiffuse, pos).x;","total += weightDepth * weightNormal;","}","}","result /= total;","gl_FragColor = vec4(vec3(result), 1.0);","}"].join("\n")};return{H:c,V:b,HV:a}});define("Shaders/AdaptativeBlurShader",["DS/Shaders/AdaptativeBlurShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/AdaptativeBlurShader");return b});define("DS/Shaders/CompareModelsShader",["DS/Visualization/ThreeJS_DS"],function(a){var b={uniforms:{tDiffuse:{type:"t",value:null},tCommonColor:{type:"t",value:null},tDepthOld:{type:"t",value:null},tDepthNew:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new a.Matrix4()},tolerance:{type:"f",value:0.0001}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",a._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tCommonColor;","uniform sampler2D tDepthOld;","uniform sampler2D tDepthNew;","uniform mat4 realProjectionMatrixInverse;","uniform float tolerance;","varying vec2 vUv;","float getLinearDepth(vec2 iUV, float iDepth) {","vec2 xy = iUV * 2.0 - 1.0;","vec4 posProjected = vec4(xy, 2.0 * iDepth - 1.0, 1.0);","vec4 posVS = realProjectionMatrixInverse * posProjected;","return posVS.z / posVS.w;","}","void main() {","vec4 color = texture2D(tDiffuse, vUv);","vec4 common = texture2D(tCommonColor, vUv);","float depthOld = texture2D(tDepthOld, vUv).w;","float depthNew = texture2D(tDepthNew, vUv).w;","float diff = abs(getLinearDepth(vUv, depthOld) - getLinearDepth(vUv, depthNew));","gl_FragColor = mix(vec4(mix(color.rgb, common.rgb, common.a), color.a), color, step(tolerance, diff));","}"].join("\n")};return b});define("Shaders/CompareModelsShader",["DS/Shaders/CompareModelsShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/CompareModelsShader");return b});define("DS/Effects/SSAO2Effect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/SSAO3Shader","DS/Shaders/AdaptativeBlurShader","DS/Shaders/MultiplicativeBlendShader","DS/Plugins/ClearPass"],function(h,a,c,f,b,g,k,j,e){var d=c.extend({init:function(p,o){var r=this._parent(p);this.__renderer=p;var q=new h.WebGLRenderTargetProperties(this.width,this.height,"uintRGBA");var n=new f(p,q,o);n.composerContext.keepResult=true;this.composers.push(n);this.version=2;this.influenceRadius=0.3;this.mixPass=new b(j,undefined,"SSAOEffect");this.mixPass.compileShader(p);this.__compNormalDepth=null;this.setVersion(this.version);var l=new Uint8Array(2*2*4);for(var m=0;m<2*2;m++){l[4*m]=0;l[4*m+1]=0;l[4*m+2]=0;l[4*m+3]=255}this.initTexture=new h.DataTexture(l,2,2,h.RGBAFormat,h.UnsignedByteType,new h.LatLongReflectionMapping(),h.ClampToEdgeWrapping,h.ClampToEdgeWrapping,h.LinearFilter,h.LinearFilter);this.initTexture.generateMipmaps=false;this.initTexture.needsUpdate=true;this.renderer.setTexture(this.initTexture,0);return this},initEffect:function(l,m){if(l){this.mixPass.disabledByDefault=true;this.mixPass.needsSwap=false;this.mixPass.material.defines.POSTPRO=0;this.mixPass.material.transparent=true;this.mixPass.material.needsUpdate=true}this.__compNormalDepth=m.getComposer("normalDepth");if(this.version===1){this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAO_1_32,this.effectSSAO_1_32.uniforms.tNormalDepth)}else{if(this.version===2){this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAO_2,this.effectSSAO_2.uniforms.tNormalDepth)}else{this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAO_0,this.effectSSAO_0.uniforms.tNormalDepth)}this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAOBlurH,this.effectSSAOBlurH.uniforms.tNormalDepth);this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAOBlurV,this.effectSSAOBlurV.uniforms.tNormalDepth)}m.insertComposer(this.composers[0],this.mixPass);this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2);this.mixPass.addRequiredComposer(this.composers[0])},update:function(u,m,p,q,o){var t=p._renderedCamera;t.projectionMatrixInverse.getInverse(t.projectionMatrix);var n=m.getBoundingSphere(),s=this.influenceRadius*n.radius,l=(new h.Vector3().subVectors(p.target,t.position)).length(),r=this.influenceRadius*l*Math.tan(0.5*t.fov*(Math.PI/180));s=(s>r)?r:s;if(this.version===1){this.composers[0].composerContext.needsUpdate=(q<=2);this.effectSSAO_1_32.uniforms.realProjectionMatrixInverse.value=t.projectionMatrixInverse;this.effectSSAO_1_32.uniforms.radius.value=s;this.effectSSAO_1_32.uniforms.numIteration.value=q;this.effectSSAO_1_32.uniforms.prevMap.value=!q?this.initTexture:this.composers[0].composerContext.renderTarget2}else{if(this.version===2){this.effectSSAO_2.uniforms.realProjectionMatrixInverse.value=t.projectionMatrixInverse;this.effectSSAO_2.uniforms.radius.value=s}else{this.effectSSAO_0.uniforms.realProjectionMatrixInverse.value=t.projectionMatrixInverse;this.effectSSAO_0.uniforms.radius.value=s}this.effectSSAOBlurH.uniforms.radius.value=s;this.effectSSAOBlurV.uniforms.radius.value=s}},setStrength:function(m){var l=Math.min(Math.max(m,0.000001),1);this.mixPass.uniforms.strength.value=Math.log(l)+0.7},setThresholdAngle:function(l){if(this.version===1){this.effectSSAO_1_32.uniforms.thresholdAngle.value=Math.cos(l)}else{if(this.version===2){this.effectSSAO_2.uniforms.thresholdAngle.value=Math.cos(l)}else{this.effectSSAO_0.uniforms.thresholdAngle.value=Math.cos(l)}}},setNbSamples:function(l){if((this.version===0)&&this.effectSSAO_0){this.effectSSAO_0.uniforms.tau.value=this.tau[this.effectSSAO_0.uniforms.nbSamples.value];this.effectSSAO_0.uniforms.nbSamples.value=Math.min(l,32)}if((this.version===2)&&this.effectSSAO_2){this.effectSSAO_2.uniforms.tau.value=this.tau[this.effectSSAO_2.uniforms.nbSamples.value];this.effectSSAO_2.uniforms.nbSamples.value=Math.min(l,32)}},setRadius:function(l){this.influenceRadius=Math.max(0,Math.min(l,1))},setSize:function(n,l,o){var m=this._parent(n,l);if(!m&&!o){return}this.composers[0].setSize(this.width,this.height);if(this.version!==1){if(this.effectSSAO_0){this.effectSSAO_0.uniforms.screenMin.value=Math.min(this.width,this.height);this.effectSSAO_0.uniforms.screenRatio.value=this.height/this.width}if(this.effectSSAO_2){this.effectSSAO_2.uniforms.screenRatio.value=this.height/this.width;this.effectSSAO_2.uniforms.screenSize.value.set(this.width,this.height);this.effectSSAO_2.uniforms.invSize.value.set(1/this.width,1/this.height)}this.effectSSAOBlurH.uniforms.invSize.value.set(1/this.width,1/this.height);this.effectSSAOBlurV.uniforms.invSize.value.set(1/this.width,1/this.height)}if((this.version===1)&&this.effectSSAO_1_32){this.effectSSAO_1_32.uniforms.screenRatio.value=this.height/this.width;this.effectSSAO_1_32.uniforms.screenSize.value.set(this.width,this.height);this.effectSSAO_1_32.uniforms.invSize.value.set(1/this.width,1/this.height)}},_setVersion:function(l){this.version=l;if(l!==1){if(!this.tau){var m=[];m[0]=0;m[1]=1;m[2]=1;m[3]=2;m[4]=3;m[5]=3;m[6]=5;m[7]=5;m[8]=5;m[9]=7;m[10]=7;m[11]=7;m[12]=7;m[13]=7;m[14]=11;m[15]=11;m[16]=11;m[17]=13;m[18]=13;m[19]=13;m[20]=17;m[21]=17;m[22]=17;m[23]=17;m[24]=19;m[25]=19;m[26]=19;m[27]=23;m[28]=23;m[29]=23;m[30]=23;m[31]=27;m[32]=27;m[48]=43;m[64]=59;this.tau=m}if((l===0)&&!this.effectSSAO_0){this.effectSSAO_0=new b(g.SSAO_V0);this.effectSSAO_0.order=0;this.effectSSAO_0.compileShader(this.__renderer);this.composers[0].addPass(this.effectSSAO_0);this.__compNormalDepth&&this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAO_0,this.effectSSAO_0.uniforms.tNormalDepth);k.H.defines.NB_SAMPLES=4;k.V.defines.NB_SAMPLES=4;k.H.defines.STEP="1.5";k.V.defines.STEP="1.5"}if((l===2)&&!this.effectSSAO_2){this.effectSSAO_2=new b(g.SSAO_V2);this.effectSSAO_2.order=10;this.effectSSAO_2.compileShader(this.__renderer);this.composers[0].addPass(this.effectSSAO_2);this.__compNormalDepth&&this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAO_2,this.effectSSAO_2.uniforms.tNormalDepth);k.H.defines.NB_SAMPLES=3;k.V.defines.NB_SAMPLES=3;k.H.defines.STEP="1.5";k.V.defines.STEP="1.5"}if(!this.effectSSAOBlurH){this.effectSSAOBlurH=new b(k.H);this.effectSSAOBlurV=new b(k.V);this.effectSSAOBlurH.order=100;this.effectSSAOBlurV.order=110;this.effectSSAOBlurH.compileShader(this.__renderer);this.effectSSAOBlurV.compileShader(this.__renderer);this.composers[0].addPass(this.effectSSAOBlurH);this.composers[0].addPass(this.effectSSAOBlurV);this.__compNormalDepth&&this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAOBlurH,this.effectSSAOBlurH.uniforms.tNormalDepth);this.__compNormalDepth&&this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAOBlurV,this.effectSSAOBlurV.uniforms.tNormalDepth)}else{this.effectSSAOBlurH.compileShader(this.__renderer);this.effectSSAOBlurV.compileShader(this.__renderer)}this.composers[0].enablePass(this.effectSSAO_0,(l===0));this.composers[0].enablePass(this.effectSSAO_2,(l===2));this.composers[0].enablePass(this.effectSSAOBlurH,true);this.composers[0].enablePass(this.effectSSAOBlurV,true);if(this.effectSSAO_1_32){this.composers[0].enablePass(this.effectSSAO_1_32,false)}}else{if(!this.effectSSAO_1_32){this.effectSSAO_1_32=new b(g.SSAO_V1);this.effectSSAO_1_32.order=20;this.effectSSAO_1_32.compileShader(this.__renderer);this.composers[0].addPass(this.effectSSAO_1_32);this.__compNormalDepth&&this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAO_1_32,this.effectSSAO_1_32.uniforms.tNormalDepth)}if(this.effectSSAO_0||this.effectSSAO_2){this.composers[0].enablePass(this.effectSSAO_0,false);this.composers[0].enablePass(this.effectSSAO_2,false);this.composers[0].enablePass(this.effectSSAOBlurH,false);this.composers[0].enablePass(this.effectSSAOBlurV,false)}this.composers[0].enablePass(this.effectSSAO_1_32,true)}},setVersion:function(l){this._setVersion(l);this.setStrength(0.95);if(l===1){this.influenceRadius=0.3}else{this.influenceRadius=0.2;this.setNbSamples(12)}this.setSize(this.width,this.height,true)},getMaxIteration:function(){return(this.version===1)?3:0}});return d});define("Effects/SSAO2Effect",["DS/Effects/SSAO2Effect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/SSAO2Effect");return b});define("DS/Effects/PreHighlightEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/AdvancedHighlightShader","DS/Shaders/AdvancedPreHighlightShader","DS/Plugins/ClearPass"],function(h,c,e,a,b,g,j,d){var f=c.extend({init:function(m,l){this._parent(m);var k=new h.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers.push(new e(m,k,l));this.composers[0].composerContext.keepResult=true;this.hlClearPass=null;this.hlRenderPass=null;this.mixPass=new b(j.FinalBlending,undefined,"PreHighlightEffect");this.mixPass.compileShader(m);return this},initEffect:function(k,l){if(k){this.mixPass.disabledByDefault=true;this.mixPass.needsSwap=false;this.mixPass.material.defines.POSTPRO=0;this.mixPass.material.transparent=true;this.mixPass.material.needsUpdate=true}l.insertComposer(this.composers[0],this.mixPass);this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tAdd);this.mixPass.addRequiredComposer(this.composers[0])},update:function(s,m,o,p,q){var r=this.composers[0].renderer;if(this.hlRenderPass===null){this.hlClearPass=new d("prehl");this.hlRenderPass=new a(m.selectionPreHL.sceneHL,o._renderedCamera,null);this.hlRenderPass.setMaterialToUse(h.MaterialToUse.preHighlightMaterial);this.hlRenderPass.cameraName="mainNoJittering";this.composers[0].composerContext.setPassClear(this.hlClearPass,true,new h.Color(16711680),1);this.composers[0].addPass(this.hlClearPass);this.composers[0].addPass(this.hlRenderPass)}this.hlRenderPass.renderFaces=(r.pickFacesMode===1)||((r.pickFacesMode===2)&&r.renderFaces)||((r.pickFacesMode===3)&&!r.renderFaces);var n=r.getRenderMode().clone();n.setRenderMode("Outline",false);var l=n.getRenderLineMode();var k=(r.pickLinesMode===1)||((r.pickLinesMode===2)&&(l||(l===null)))||((r.pickLinesMode===3)&&(l===0));this.hlRenderPass.renderLineMode=k?h.ShowAllRenderLineMode:0;this.hlRenderPass.renderPoints=(r.pickPointsMode===1)||r.renderPoints;this.hlRenderPass.renderPointMode=r.getPickingRenderPointMode();this.composers[0].composerContext.needsUpdate=true},setColor:function(l,k){if(l instanceof h.Vector4){this.mixPass.uniforms.iOutlineColor.value=l;if(!k){this.mixPass.uniforms.iOutlineColor2.value=l}}if(k instanceof h.Vector4){this.mixPass.uniforms.iOutlineColor2.value=k}},setSize:function(m,k){var l=this._parent(m,k);if(!l){return}this.composers[0].setSize(this.width,this.height);this.mixPass.uniforms.h.value=1/this.width;this.mixPass.uniforms.v.value=1/this.height}});return f});define("Effects/PreHighlightEffect",["DS/Effects/PreHighlightEffect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/PreHighlightEffect");return b});define("DS/Gestures/RotateGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,a,d){var b=d.extend({init:function(){this._parent("Rotate");this.priority=10;this.touches=[];this.fingersVector=new c.Vector2();this.latencyTime=200;this.initTime=0;this.distance=null;this.lastDistance=0;this.initDistance=0;this.distanceMax=10;this.orientation=null;this.lastOrientation=0;this.deltaOrientation=0;this.initOrientation=0;this.orientationMin=0.1;this.barycenter=null;this.lastBarycenter=new c.Vector2();this.initBarycenter=new c.Vector2();return this},detect:function(g){this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([a.State.BEGIN,a.State.MOVE,a.State.IDLE,a.State.END],this.view);if(this.touches.length===2){var e=g[0].getJSEvent();if(e.preventDefault){e.preventDefault()}this.fingersVector.subVectors(this.touches[1].currentPosition,this.touches[0].currentPosition);if(this.distance===null){this.distance=this.fingersVector.length()}if(this.orientation===null){this.orientation=Math.atan2(this.fingersVector.y,this.fingersVector.x)}if(this.barycenter===null){this.barycenter=new c.Vector2();this.barycenter.addVectors(this.touches[0].currentPosition,this.touches[1].currentPosition);this.barycenter.multiplyScalar(0.5)}this.lastDistance=this.distance;this.distance=this.fingersVector.length();this.lastOrientation=this.orientation;this.orientation=Math.atan2(this.fingersVector.y,this.fingersVector.x);this.deltaOrientation=this.orientation-this.lastOrientation;var j=(this.deltaOrientation>=0)?1:-1;j*=2*Math.PI;if(Math.abs(this.deltaOrientation-j)<Math.abs(this.deltaOrientation)){this.deltaOrientation-=j}this.lastBarycenter.copy(this.barycenter);this.barycenter.addVectors(this.touches[0].currentPosition,this.touches[1].currentPosition);this.barycenter.multiplyScalar(0.5)}switch(this.state){case d.State.INIT:if(this.touches.length===2){this.initTime=new Date().getTime();this.initDistance=this.distance;this.initOrientation=this.orientation;this.initBarycenter.copy(this.barycenter);this.changeState(d.State.BEGIN)}break;case d.State.BEGIN:if(this.touches.length===2){if(new Date().getTime()-this.initTime>this.latencyTime){var h=Math.abs(this.orientation-this.initOrientation);h=Math.min(h,Math.abs(h-2*Math.PI));if((Math.abs(this.distance-this.initDistance)<this.distanceMax)&&(h>this.orientationMin)){this.events=this.touches;this.changeState(d.State.CHANGE)}else{this.changeState(d.State.KO)}}}else{this.changeState(d.State.KO)}break;case d.State.CHANGE:if(this.touches.length===2){var f=(this.touches[0].getState()===a.State.END)||(this.touches[1].getState()===a.State.END);this.events=this.touches;this.changeState(d.State.CHANGE,f)}else{this.changeState(d.State.KO)}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);this.touches=[];this.distance=null;this.orientation=null;this.barycenter=null;break;default:break}},getAngle:function(){return(this.orientation||0)},getDeltaAngle:function(){return this.deltaOrientation},getFirstTouchPosition:function(e){var f;if(this.getEvents().length===2){f=this.getEvents()[0].getCurrentPosition();return f}return null},getSecondTouchPosition:function(f){var e;if(this.getEvents().length===2){e=this.getEvents()[1].getCurrentPosition();return e}return null},getOriginDirection:function(f){if(this.getEvents().length===2){var e=this.getEvents()[1].getStartPosition();e.sub(this.getEvents()[0].getStartPosition());return e}return null},getCurrentDirection:function(e){if(this.getEvents().length===2){var f=this.getEvents()[1].getCurrentPosition();f.sub(this.getEvents()[0].getCurrentPosition());return f}return null},getLastDirection:function(f){if(this.getEvents().length===2){var e=this.getEvents()[1].getLastPosition();e.sub(this.getEvents()[0].getLastPosition());return e}return null}});return UWA.namespace("THREEDS/Gestures/RotateGesture",b)});define("Gestures/RotateGesture",["DS/Gestures/RotateGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/RotateGesture");return b});define("DS/Gestures/DoubleClickGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,a,d){var b=d.extend({init:function(e){this._parent(a.printMouseButton(e)+"DoubleClick");this.priority=100;this.button=e;this.currentTime=0;this.maxTime=300;this.maxDistance=15;this.lastClickTime=0;this.lastClickPosition=new c.Vector2();return this},detect:function(f){this._parent(f);var e=this.gestures[0];if(!e){return}this.currentTime=new Date().getTime();switch(this.state){case d.State.INIT:if(e.getState()===d.State.OK){this.lastClickTime=this.currentTime;this.lastClickPosition.copy(e.events[0].currentPosition);this.changeState(d.State.BEGIN)}break;case d.State.BEGIN:if(e.getState()===d.State.OK){if((this.currentTime-this.lastClickTime<this.maxTime)&&(this.lastClickPosition.sub(e.events[0].currentPosition).length()<this.maxDistance)){this.events=e.getEvents();this.changeState(d.State.OK)}else{this.lastClickTime=this.currentTime;this.lastClickPosition.copy(e.events[0].currentPosition)}}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/DoubleClickGesture",b)});define("Gestures/DoubleClickGesture",["DS/Gestures/DoubleClickGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/DoubleClickGesture");return b});define("DS/Gestures/KeyUpGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(b,a,d){var c=d.extend({init:function(){this._parent("KeyUp");this.priority=0;this.key=0;return this},detect:function(h){this._parent(h);switch(this.state){case d.State.INIT:for(var g=0;g<h.length;g++){var f=h[g];var k=f.getType();var j=f.getState();if(k==="Keyboard"){var e=f.getKey();if(j===a.State.END){this.events=[f];this.key=e;this.changeState(d.State.OK);return}}}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/KeyUpGesture",c)});define("Gestures/KeyUpGesture",["DS/Gestures/KeyUpGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/KeyUpGesture");return b});define("DS/Shaders/SSLRShader",["DS/Visualization/ThreeJS_DS"],function(b){var a={computeReflectionCoef:["vec4 normalDepth = texture2D( tNormalDepth, vUv );","float reflectionCoef = normalDepth.z;"].join("\n"),computeVertexPositionVS:["float z = normalDepth.w;","if ( z == 0.0 ) return;","vec2 xy = vUv * 2.0 - 1.0;","vec4 vertexPositionProjected = vec4( xy, 2.0 * z - 1.0, 1.0 );","vec4 vertexPositionVS = realProjectionMatrixInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","vertexPositionVS.w = 1.0;"].join("\n"),computeNormal:["vec3 normal;","if (normalDepth.x == 0.0 && normalDepth.y == 0.0) { normal = vec3(0.0); } else {","   normal.z = 2.0 * dot(normalDepth.xy, normalDepth.xy) - 1.0;","   normal.xy = normalize(normalDepth.xy) * sqrt(1.0 - normal.z * normal.z);","}"].join("\n")},c={uniforms:{tDiffuse2:{type:"t",value:null},tNormalDepth:{type:"t",value:null},tRandomTex:{type:"t",value:null},size:{type:"v2",value:new b.Vector2(512,512)},realProjectionMatrix:{type:"m4",value:new b.Matrix4()},realProjectionMatrixInverse:{type:"m4",value:new b.Matrix4()},radius:{type:"f",value:0.5}},vertexShader:["varying vec2 vUv;","void main() {","  vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform mat4 realProjectionMatrix;","uniform mat4 realProjectionMatrixInverse;","uniform sampler2D tDiffuse2;","uniform sampler2D tNormalDepth;","uniform sampler2D tRandomTex;","uniform vec2 size;","uniform float radius;","varying vec2 vUv;","const float roughness = 0.0;","const vec3 unitY = vec3(0.0, 1.0, 0.0);","const vec3 unitZ = vec3(0.0, 0.0, 1.0);","vec2 getScreenPos(vec3 pos) {","  vec4 offset = realProjectionMatrix * vec4(pos, 1.0);","  offset.xy /= offset.w;","  offset.xy = offset.xy * 0.5 + 0.5;","  return offset.xy;","}","vec3 getScreenPos3(vec3 pos) {","  vec4 offset = realProjectionMatrix * vec4(pos, 1.0);","  offset.xyz /= offset.w;","  offset.xy = offset.xy * 0.5 + 0.5;","  return offset.xyz;","}","float random(vec3 scale, float seed) {","  return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","void main() {","  vec2 screenPos = vUv;","  gl_FragColor = vec4(0.0);",a.computeReflectionCoef,"  if (reflectionCoef > 0.0) {",a.computeVertexPositionVS,a.computeNormal,"    vec3 origin = vertexPositionVS.xyz;","    vec3 I = normalize(origin);","    vec3 vReflect = normalize(reflect(I, normal));","    vec3 ptReflect = origin + radius * vReflect;","    vec3 originScreenPos = vec3(vUv, 2.0 * z - 1.0);","    vec3 endReflectScreenPos = getScreenPos3( ptReflect );","    vec3 reflectScreenPos = endReflectScreenPos - originScreenPos;","    reflectScreenPos /= length(endReflectScreenPos.xy - originScreenPos.xy);","    vec2 stepsToBorder = vec2(size * vUv / abs(reflectScreenPos.xy));","    if (reflectScreenPos.x > 0.0) stepsToBorder.x = size.x * (1.0 - vUv.x) / abs(reflectScreenPos.x);","    if (reflectScreenPos.y > 0.0) stepsToBorder.y = size.y * (1.0 - vUv.y) / abs(reflectScreenPos.y);","    float stepsToScreenBorder = min(stepsToBorder.x, stepsToBorder.y);","    reflectScreenPos /= size.x;","    float prevDepth = originScreenPos.z;","    float ray_marching_step = 16.0;","    float j = ray_marching_step;","    for (int i = 0; i < 64; ++i) {","      if (j > stepsToScreenBorder) { break; }","      vec3 sampleScreenPos = originScreenPos + j * reflectScreenPos;","      vec4 normalDepth = texture2D( tNormalDepth, sampleScreenPos.xy );","      float z = 2.0 * normalDepth.w - 1.0;","      vec3 n;","      n.z = 2.0 * dot(normalDepth.xy, normalDepth.xy) - 1.0;","      n.xy = normalize(normalDepth.xy) * sqrt(1.0 - n.z * n.z);","      float diffZ = sampleScreenPos.z - z;","      if (diffZ > 0.0) {","        if (ray_marching_step == 1.0) {","          if (abs(diffZ) < 10.0*abs(sampleScreenPos.z - prevDepth)) {","            float reflectAttenuation = clamp(-dot(n, vReflect), 0.0, 1.0) * ((stepsToScreenBorder - j) / stepsToScreenBorder);","            gl_FragColor = vec4( texture2D( tDiffuse2, sampleScreenPos.xy ).xyz, reflectAttenuation * reflectionCoef );","          }","          return;","        } else {","          ray_marching_step *= 0.5;","          j -= ray_marching_step;","        }","      } else {","        prevDepth = sampleScreenPos.z;","        j += ray_marching_step;","      }","    }","  }","}"].join("\n")};return c});define("Shaders/SSLRShader",["DS/Shaders/SSLRShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/SSLRShader");return b});define("DS/Effects/DebugPassEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/ReplaceBlendShader","DS/Shaders/DisplayPassShader"],function(f,d,h,c,e,a,g){var b=d.extend({init:function(l,k){this._parent(l);var j=new f.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers.push(new h(l,j,k));this.debugPass=null;this.mixPass=new e(a,undefined,"DebugPassEffect");return this},initEffect:function(j,l){if(this.debugPass===null){this.debugPass=new e(g);this.composers[0].addPass(this.debugPass);if(l.HighlightEffect!==null){l.HighlightEffect.composers[0].linkToShaderPassUniform(this.debugPass,this.debugPass.uniforms.tDiffuse2)}else{if(l.composers[0]){l.composers[0].linkToShaderPassUniform(this.debugPass,this.debugPass.uniforms.tDiffuse2)}}if(l.pickingGPUComposerContext){l.pickingGPUComposerContext.linkToShaderPassUniform(this.debugPass,this.debugPass.uniforms.tDiffuse3)}var k=l.getComposer("normalDepth");k.linkToShaderPassUniform(this.debugPass,this.debugPass.uniforms.tDiffuse4)}l.insertComposer(this.composers[0],this.mixPass);this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2);this.mixPass.addRequiredComposer(this.composers[0])},update:function(k,j,l){},setSize:function(l,j){var k=this._parent(l,j);if(!k){return}this.composers[0].setSize(this.width,this.height)}});return b});define("Effects/DebugPassEffect",["DS/Effects/DebugPassEffect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/DebugPassEffect");return b});define("DS/VisuEvents/KeyboardEvent",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent"],function(b,a){var c=a.extend({init:function(d,e){this._parent(e);this.type="Keyboard";this.key=d;return this},update:function(d){this._parent(d)},getKey:function(){return this.key}});return UWA.namespace("THREEDS/Events/KeyboardEvent",c)});define("VisuEvents/KeyboardEvent",["DS/VisuEvents/KeyboardEvent","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuEvents/KeyboardEvent");return b});define("DS/Gestures/KeyDownGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(b,a,d){var c=d.extend({init:function(){this._parent("KeyDown");this.priority=0;this.key=0;return this},detect:function(h){this._parent(h);switch(this.state){case d.State.INIT:for(var g=0;g<h.length;g++){var f=h[g];var k=f.getType();var j=f.getState();if(k==="Keyboard"){var e=f.getKey();if(j===a.State.BEGIN){this.events=[f];this.key=e;this.changeState(d.State.OK);return}}}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/KeyDownGesture",c)});define("Gestures/KeyDownGesture",["DS/Gestures/KeyDownGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/KeyDownGesture");return b});define("DS/Visualization/GraphicAttributeSet",["DS/Visualization/ThreeJS_DS","DS/Visualization/MaterialManager","DS/Mesh/Mesh"],function(c,a,e){c.GASEnum={NO_INHERIT:0,COLOR_INHERIT:1,RGB_INHERIT:1,ALPHA_INHERIT:1<<1,LINEWIDTH_INHERIT:1<<2,LINETYPE_INHERIT:1<<3,ASMCOLOR_INHERIT:1<<4,SYMBOLTYPE_INHERIT:1<<5};c.GASEnum.RGBA_INHERIT=c.GASEnum.COLOR_INHERIT|c.GASEnum.ALPHA_INHERIT;var h=new c.Color(0);var b=new c.Color(16777215);var g=[1,2,3,4,5,6,7,8,9];var f=[9,9,9,9,5,7,9,3,2];var d=function(j){this.isGAS=true;this._color=null;this._alpha=1;this._lineWidth=1;this._lineType=e.LinePatternEnum.SOLID;this._symbolType=null;this._inheritance=c.GASEnum.RGBA_INHERIT;this._material=null;j&&this.setParameters(j)};d.prototype.setParameters=function(j){if(j.colorRGB!==undefined){this._color=j.colorRGB?j.colorRGB.clone():null}if(j.colorA!==undefined){this._alpha=j.colorA}if(j.lineWidth!==undefined){this._lineWidth=j.lineWidth}if(j.lineType!==undefined){this._lineType=j.lineType}if(j.symbolType!==undefined){this._symbolType=j.symbolType}if(j.inheritance!==undefined){this._inheritance=j.inheritance}};d.prototype.merge=function(j){if(j._color&&(j._inheritance&c.GASEnum.COLOR_INHERIT)){this._color=j._color.clone();this._inheritance|=c.GASEnum.COLOR_INHERIT}if(j._color&&(j._inheritance&c.GASEnum.ASMCOLOR_INHERIT)){this._color=j._color.clone();this._inheritance|=c.GASEnum.ASMCOLOR_INHERIT}if((j._alpha!==null)&&(j._inheritance&c.GASEnum.ALPHA_INHERIT)){this._alpha=j._alpha;this._inheritance|=c.GASEnum.ALPHA_INHERIT}if(j._lineWidth&&(j._inheritance&c.GASEnum.LINEWIDTH_INHERIT)){this._lineWidth=j._lineWidth;this._inheritance|=c.GASEnum.LINEWIDTH_INHERIT}if((j._lineType!==null)&&(j._inheritance&c.GASEnum.LINETYPE_INHERIT)){this._lineType=j._lineType;this._inheritance|=c.GASEnum.LINETYPE_INHERIT}if((j._symbolType!==null)&&(j._inheritance&c.GASEnum.SYMBOLTYPE_INHERIT)){this._symbolType=j._symbolType;this._inheritance|=c.GASEnum.SYMBOLTYPE_INHERIT}};d.prototype.copy=function(j){this._color=j._color?j._color.clone():null;this._alpha=j._alpha;this._lineWidth=j._lineWidth;this._lineType=j._lineType;this._symbolType=j._symbolType;this._inheritance=j._inheritance};d.prototype.clone=function(){return new d({colorRGB:this._color?this._color.clone():null,colorA:this._alpha,lineType:this._lineType,lineWidth:this._lineWidth,symbolType:this._symbolType,inheritance:this._inheritance})};d.prototype.getPointSize=function(){var j=(this._symbolType!==null)?this._symbolType:e.PointSymbolEnum.CROSS;return Math.round(f[j]*(window.devicePixelRatio||1))};d.prototype.getMaterial=function(n,j,m){var l=new a();var o={};if(this._color&&(this._inheritance&(c.GASEnum.COLOR_INHERIT+c.GASEnum.ASMCOLOR_INHERIT))){o.color=this._color}else{if(n){o.color=n.isGAS?n._color:n.color}}if((this._alpha!==null)&&(this._inheritance&c.GASEnum.ALPHA_INHERIT)){o.opacity=this._alpha}else{if(n){o.opacity=n.isGAS?n._alpha:n.opacity}}if(j===1){o.lineWidth=1;if(this._inheritance&c.GASEnum.ASMCOLOR_INHERIT){o.color=h;o.opacity=1}if(this._lineWidth&&(this._inheritance&c.GASEnum.LINEWIDTH_INHERIT)){o.lineWidth=this._lineWidth}else{if(n){o.lineWidth=n.isGAS?n._lineWidth:n.lineWidth;if(!o.lineWidth){o.lineWidth=1}}}if((this._lineType!==null)&&(this._inheritance&c.GASEnum.LINETYPE_INHERIT)){o.pattern=this._lineType}else{if(n){o.pattern=n.isGAS?n._lineType:n.dashPattern;if(!o.pattern){o.pattern=e.LinePatternEnum.SOLID}}}}if(j===0){var k=e.PointSymbolEnum.DOT;if((this._symbolType!==null)&&(this._inheritance&c.GASEnum.SYMBOLTYPE_INHERIT)){k=this._symbolType}else{if(n&&n.isGAS&&(n._symbolType!==null)){k=n._symbolType}}o.symbol=g[k]}return l.getMaterialFromGAS(o)};return d});define("DS/Mesh/MeshUtils",["DS/Mesh/Mesh","DS/Visualization/ThreeJS_DS","DS/Visualization/MaterialManager","DS/Visualization/GraphicAttributeSet"],function(d,b,a,c){d.convertTo3jsGeometry=function(e,r){if(!e.length){return}var n=[];var s=null;var h=null;var q=new b.Sphere();var p=new b.Box3();for(var k=0;k<e.length;k++){var o=e[k];var m=new b.BufferGeometryDS();var g=new b.Vector3(o.AABB.min[0],o.AABB.min[1],o.AABB.min[2]);var l=new b.Vector3(o.AABB.max[0],o.AABB.max[1],o.AABB.max[2]);if(s==null){s=g}if(h==null){h=l}if(g.x<s.x){s.x=g.x}if(g.y<s.y){s.y=g.y}if(g.z<s.z){s.z=g.z}if(l.x>h.x){h.x=l.x}if(l.y>h.y){h.y=l.y}if(l.z>h.z){h.z=l.z}p.set(s,h);q.radius=h.clone().sub(s).multiplyScalar(0.5).length();q.center=h.clone().add(s).multiplyScalar(0.5);for(var f=0;f<o.drawingGroups.length;f++){o.drawingGroups[f].geometry=m}m.drawingGroups=o.drawingGroups;m.vertexPositionArray=o.vertexPositionArray;if(o.vertexNormalArray!==null){m.vertexNormalArray=o.vertexNormalArray}if(o.vertexUvArray!==null){m.vertexUvArray=o.vertexUvArray}if(o.vertexUv2Array){m.vertexUv2Array=o.vertexUv2Array}if(o.vertexTangentArray){m.vertexTangentArray=o.vertexTangentArray}if(o.vertexBinormalArray){m.vertexBinormalArray=o.vertexBinormalArray}m.vertexIndexArray=o.vertexIndexArray;n.push(m)}n.boundingSphere=q;n.boundingBox=p;return n};d.convertTo3jsMesh=function(s,r,B,J,I){if(!s.length){return}var g=window.newMaterialInheritance;var e=null;var l=[];var k=null;var E=null;var H=new b.Sphere();var f=new b.Box3();var q=new a();var u=false;for(var A=0;A<s.length;A++){var h=s[A];var n=new b.BufferGeometryDS();n.editable=h.editable;if(J!==undefined){n.sharedBuffers=J}if(I!==undefined){n.noMeshInRAM=I}var w=new b.Vector3(h.AABB.min[0],h.AABB.min[1],h.AABB.min[2]);var z=new b.Vector3(h.AABB.max[0],h.AABB.max[1],h.AABB.max[2]);if(k==null){k=w}if(E==null){E=z}if(w.x<k.x){k.x=w.x}if(w.y<k.y){k.y=w.y}if(w.z<k.z){k.z=w.z}if(z.x>E.x){E.x=z.x}if(z.y>E.y){E.y=z.y}if(z.z>E.z){E.z=z.z}f.set(k,E);H.radius=E.clone().sub(k).multiplyScalar(0.5).length();H.center=E.clone().add(k).multiplyScalar(0.5);for(var y=0;y<h.drawingGroups.length;y++){var D=h.drawingGroups[y];if(!u){if(D._geomType!==0){u=true}}D.geometry=n;if((B!==undefined)&&B){var F=null;var o=null;var t=D.gas;var p=D.material;if(p){D.gas=p}else{if(t!==null){if((o!=null)&&d.areEqualGraphicProperties(o,t)){D.gas=F}else{var x=new b.Color();x.setRGB(t.color.r,t.color.g,t.color.b);var m={color:x,opacity:t.opacity};if(t.linewidth){console.warn("DEPRECATED : Use lineWidth (cameCase) instead of linewidth.");t.lineWidth=t.linewidth}if(t.lineWidth){m.lineWidth=t.lineWidth;if(t.pattern){m.pattern=t.pattern}}else{if(t.pointsize){m.symbol=0;m.size=t.pointsize}else{m.solid=t.solid}}if(g){var G={colorRGB:m.color,colorA:m.opacity,inheritance:b.GASEnum.RGBA_INHERIT};if(m.lineWidth){G.lineWidth=m.lineWidth;G.inheritance|=b.GASEnum.LINEWIDTH_INHERIT}if(m.pattern){G.lineType=m.pattern;G.inheritance|=b.GASEnum.LINETYPE_INHERIT}D.gas=new c(G)}else{D.gas=q.getMaterialFromGAS(m)}F=D.gas;o=t}}}}}n.drawingGroups=h.drawingGroups;n.vertexPositionArray=h.vertexPositionArray;if(h.vertexNormalArray!==null){n.vertexNormalArray=h.vertexNormalArray}if(h.vertexColorArray!==null){n.vertexColorArray=h.vertexColorArray}if(h.vertexUvArray!==null){n.vertexUvArray=h.vertexUvArray}if(h.vertexUv2Array){n.vertexUv2Array=h.vertexUv2Array}if(h.vertexTangentArray){n.vertexTangentArray=h.vertexTangentArray}if(h.vertexBinormalArray){n.vertexBinormalArray=h.vertexBinormalArray}n.vertexIndexArray=h.vertexIndexArray;var C=r&&(r.isDashedLine||(r.backMaterial&&r.backMaterial.isDashedLine));if(C){n.computeLineDistances(s.patternOffsets)}l.push(n)}if(!H.radius){H.radius=0.1}if(!f.min.distanceToSquared(f.max)){f.expandByScalar(0.1)}l.boundingSphere=H;l.boundingBox=f;e=new b.Mesh(l,r);e.matrixAutoUpdate=false;e.castShadow=true;e.receiveShadow=true;var v=new d.SGBag();v.children.push(s[0].rep);s[0].rep.parent=v;e.sceneGraph=v;e.fromLoadedModel=u;return e};d.createEmptyMesh=function(){var f=new b.BufferGeometryDS();f.boundingSphere=new b.Sphere(new b.Vector3(),0);f.boundingBox=new b.Box3();var e=new b.MeshPhongMaterial();mesh=new b.Mesh(f,e);mesh.matrixAutoUpdate=false;mesh.castShadow=true;mesh.receiveShadow=true;return new THREEDS.Nodes.Mesh(mesh)};d.convertTo3js=function(s,v,u,k){var f=null;var m=[];var l=null;var C=null;var E=new b.Sphere();var g=new b.Box3();var q=new THREEDS.MaterialManager();q.cleanResources();var B;for(var A=0;A<s.length;A++){var h=s[A];var o=new b.BufferGeometryDS();var w=new b.Vector3(h.AABB.min[0],h.AABB.min[1],h.AABB.min[2]);var z=new b.Vector3(h.AABB.max[0],h.AABB.max[1],h.AABB.max[2]);if(l==null){l=w}if(C==null){C=z}if(w.x<l.x){l.x=w.x}if(w.y<l.y){l.y=w.y}if(w.z<l.z){l.z=w.z}if(z.x>C.x){C.x=z.x}if(z.y>C.y){C.y=z.y}if(z.z>C.z){C.z=z.z}g.set(l,C);E.radius=C.clone().sub(l).multiplyScalar(0.5).length();E.center=C.clone().add(l).multiplyScalar(0.5);var D=null;var p=null;for(var y=0;y<h.drawingGroups.length;y++){h.drawingGroups[y].geometry=o;var t=h.drawingGroups[y].gas;var r=h.drawingGroups[y].material;if(k&&(r!==null)&&!r.file&&(r.id!==-1)){if(k[r.id]!=null){B=k[r.id]}else{B=q.getMaterialCgr(v[r.id],undefined,"CGR",u);k[r.id]=B}h.drawingGroups[y].gas=B}else{if((t!==null)&&t.color){var x=new b.Color();x.setRGB(t.color.r,t.color.g,t.color.b);h.drawingGroups[y].gas=q.getMaterialFromGAS({color:x,opacity:t.opacity,lineWidth:(t.lineWidth?t.lineWidth:t.linewidth),solid:t.solid,symbol:t.symbol,basic:t.basic,resource:u})}}}o.drawingGroups=h.drawingGroups;o.vertexPositionArray=h.vertexPositionArray;if(h.vertexNormalArray!==null){o.vertexNormalArray=h.vertexNormalArray}if(h.vertexUvArray!==null){o.vertexUvArray=h.vertexUvArray}if(h.vertexUv2Array){o.vertexUv2Array=h.vertexUv2Array}if(h.vertexTangentArray){o.vertexTangentArray=h.vertexTangentArray}if(h.vertexBinormalArray){o.vertexBinormalArray=h.vertexBinormalArray}o.vertexIndexArray=h.vertexIndexArray;m.push(o)}var e=new b.Color();e.setRGB(s[0].gas.fill.color.r,s[0].gas.fill.color.g,s[0].gas.fill.color.b);var n=new b.Color();n.setRGB(s[0].gas.line.color.r,s[0].gas.line.color.g,s[0].gas.line.color.b);var r=q.getMaterialFromGAS({color:e,opacity:s[0].gas.fill.opacity,solid:s[0].gas.fill.solid,basic:s[0].gas.fill.basic});r.line=q.getMaterialFromGAS({color:n,opacity:s[0].gas.line.opacity,lineWidth:(s[0].gas.line.lineWidth?s[0].gas.line.lineWidth:s[0].gas.line.linewidth)});m.boundingSphere=E;m.boundingBox=g;f=new b.Mesh(m,r);f.matrixAutoUpdate=false;f.castShadow=true;f.receiveShadow=true;if(s.length){f.sceneGraph=s[0].sceneGraph}return new THREEDS.Nodes.Mesh(f)};d.mergeGeometries=function(an){an.invalidRatio=an.invalidRatio||0;var aq=0;var J=0;var ad=[];var S=0;var g=false;var o=false;var l=false;var G=false;var Z=false;var ao=false;for(var P=0;P<an.layers.length;P++){var E=an.layers[P].drawableInterval;if(E.layerNum<=0){S+=E.count}}for(var P=0;P<an.geometries.length;P++){var az=an.geometries[P];aq+=az.vertexIndexArray.length;J+=az.vertexPositionArray.length;ad[P]=az.vertexPositionArray.length;g=(az.vertexNormalArray!==null);o=(az.vertexUvArray!==null);l=(az.vertexUv2Array!==null);G=(az.vertexColorArray!==null);Z=(az.vertexTangentArray!==null);ao=(az.vertexBinormalArray!==null)}if(!S&&!an.force){return null}if(!an.force&&(S/aq<an.invalidRatio)){return null}var aj=[];for(var P=0;P<an.layers.length;P++){var y=an.layers[P].drawableGroup;var E=an.layers[P].drawableInterval;if(E.layerNum>0){for(var O=E.primitiveStart;O<E.primitiveStart+E.primitiveCount;O++){aj.push(y.primitives[O])}}}aj.sort(function(k,j){var aE=k.group;var n=j.group;if(aE.glType<n.glType){return -1}if(aE.glType>n.glType){return 1}if(aE._geomType<n._geomType){return -1}if(aE._geomType>n._geomType){return 1}if(aE.gas===null){return -1}if(n.gas===null){return 1}if(aE.gas.id<n.gas.id){return -1}if(aE.gas.id>n.gas.id){return 1}return 0});var m=[];for(var P=0;P<ad.length;P++){m[P]=new Int32Array(ad[P]/3);for(var O=0;O<m[P].length;O++){m[P][O]=-1}}var B=[];var au=[];var av=[];var ax=[];var H=[];var w=[];var N=[];var aA=[];var X=[];var V=[];var p=Math.min(J,196608);var ab=Math.min(J*4/3,262144);au[0]=new Float32Array(p);av[0]=g?new Float32Array(p):null;ax[0]=o?new Float32Array(p):null;H[0]=l?new Float32Array(p):null;w[0]=G?new Float32Array(ab):null;N[0]=Z?new Float32Array(p):null;aA[0]=ao?new Float32Array(p):null;X[0]=new Uint16Array(aq);var ah=aj[0].group.glType;var C=aj[0].group._geomType;var ag=aj[0].group.gas;var t=[];var at=[];var aD=0;var ak=0;var Q=0;var I=0;var z=0;for(var P=0;P<aj.length;P++){var ai=aj[P];var y=ai.group;var az=y.geometry;var Y=(an.geometries instanceof Array)?an.geometries.indexOf(az):0;var u=az.vertexPositionArray;var ay=az.vertexNormalArray;var D=az.vertexUvArray;var r=az.vertexUv2Array;var T=az.vertexColorArray;var ac=az.vertexTangentArray;var e=az.vertexBinormalArray;var s=az.vertexIndexArray;if(ak+ai.count>=65536){var U=new d.DrawingGroup(ag,ag,ah,Q,z-Q,undefined,undefined,C);t.push(U);for(var O=0;O<at.length;O++){at[O].group=U;U.primitives.push(at[O])}at=[];V[aD]=t;B[aD]={index:z,data:ak};ah=y.glType;C=y._geomType;ag=y.gas;t=[];aD++;ak=0;Q=0;I=0;z=0;p=196608;ab=262144;au[aD]=new Float32Array(p);av[aD]=g?new Float32Array(p):null;ax[aD]=o?new Float32Array(p):null;H[aD]=l?new Float32Array(p):null;w[aD]=G?new Float32Array(ab):null;N[aD]=Z?new Float32Array(p):null;aA[aD]=ao?new Float32Array(p):null;X[aD]=new Uint16Array(aq);for(var M=0;M<ad.length;M++){for(var O=0;O<m[M].length;O++){m[M][O]=-1}}}else{if((y.glType!==ah)||(y.gas!==ag)||(y._geomType!==C)){var U=new d.DrawingGroup(ag,ag,ah,Q,z-Q,undefined,undefined,C);ah=y.glType;C=y._geomType;ag=y.gas;t.push(U);Q=z;for(var O=0;O<at.length;O++){at[O].group=U;U.primitives.push(at[O])}at=[]}}I=z;for(var O=0;O<ai.count;O++){var aw=s[ai.start+O];var ap=m[Y][aw];if(ap===-1){for(var A=0;A<3;A++){au[aD][3*ak+A]=u[3*aw+A];if(g){av[aD][3*ak+A]=ay[3*aw+A]}if(o){ax[aD][3*ak+A]=D[3*aw+A]}if(l){H[aD][3*ak+A]=r[3*aw+A]}if(Z){N[aD][3*ak+A]=ac[3*aw+A]}if(ao){aA[aD][3*ak+A]=e[3*aw+A]}}if(G){for(var A=0;A<4;A++){w[aD][4*ak+A]=T[4*aw+A]}}m[Y][aw]=ak;X[aD][z++]=ak;ak++}else{X[aD][z++]=ap}}var f=ai.clone();f.start=I;at.push(f);ai._newPrim=f}if(at.length>0){var U=new d.DrawingGroup(ag,ag,ah,Q,z-Q,undefined,undefined,C);t.push(U);for(var O=0;O<at.length;O++){at[O].group=U;U.primitives.push(at[O])}at=[];V[aD]=t;B[aD]={index:z,data:ak}}var aC=aD+1;var af=null;for(var P=0;P<aC;P++){var p=B[P];var v=X[P];var h=au[P];var al=av[P];var D=ax[P];var r=H[P];var W=w[P];var am=N[P];var L=aA[P];if(p.index<v.length){af=new Uint16Array(p.index);for(var O=0;O<p.index;O++){af[O]=v[O]}X[P]=af}if(3*p.data<h.length){var q=3*p.data;var F=4*p.data;af=new Float32Array(q);for(var O=0;O<q;O++){af[O]=h[O]}au[P]=af;if(g){af=new Float32Array(q);for(var O=0;O<q;O++){af[O]=al[O]}av[P]=af}if(o){af=new Float32Array(q);for(var O=0;O<q;O++){af[O]=D[O]}ax[P]=af}if(l){af=new Float32Array(q);for(var O=0;O<q;O++){af[O]=r[O]}H[P]=af}if(G){af=new Float32Array(F);for(var O=0;O<F;O++){af[O]=W[O]}w[P]=af}if(Z){af=new Float32Array(q);for(var O=0;O<q;O++){af[O]=am[O]}N[P]=af}if(ao){af=new Float32Array(q);for(var O=0;O<q;O++){af[O]=L[O]}aA[P]=af}}}var ar=[];for(var P=0;P<aC;P++){var R=new d.Mesh();R.vertexPositionArray=au[P];R.vertexNormalArray=av[P];R.vertexUvArray=ax[P];R.vertexUv2Array=H[P];R.vertexColorArray=w[P];R.vertexTangentArray=N[P];R.vertexBinormalArray=aA[P];R.vertexIndexArray=X[P];R.drawingGroups=V[P];var aB=[0,0,0];var x=[0,0,0];if(au[P].length>=3){aB=[au[P][0],au[P][1],au[P][2]];x=[au[P][0],au[P][1],au[P][2]];for(var K=0;K<au[P].length;K+=3){if(au[P][K]<aB[0]){aB[0]=au[P][K]}if(au[P][K+1]<aB[1]){aB[1]=au[P][K+1]}if(au[P][K+2]<aB[2]){aB[2]=au[P][K+2]}if(au[P][K]>x[0]){x[0]=au[P][K]}if(au[P][K+1]>x[1]){x[1]=au[P][K+1]}if(au[P][K+2]>x[2]){x[2]=au[P][K+2]}}}R.AABB={min:aB,max:x};ar.push(R)}var ae=d.convertTo3jsGeometry(ar,null);return ae};return d});define("Mesh/MeshUtils",["DS/Mesh/MeshUtils","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Mesh/MeshUtils");return b});define("DS/Visualization/GeometryHelper",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],function(b,c,d){var e=document.createElement("canvas");e.width=512;e.height=64;var a=b.extend({init:function(){return this},CreateVis3DCuboid:function(E,n,g,u,C,A,l){var x,t,p,h,f,s,w,D,z,y,B,m,o,r,v,q,k;if(E instanceof c.Vector3){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");this.fill=A!==undefined?A:1;this.cornerPoint=E!==undefined?E:new c.Vector3(0,0,0);this.firstAxis=n!==undefined?n:new c.Vector3(1,0,0);this.secondAxis=g!==undefined?g:new c.Vector3(0,1,0);this.thirdAxis=u!==undefined?u:new c.Vector3(0,0,1);this.color=C!==undefined?C:new d.Color(0.5,0.5,0.5,1);k=l?l:0}else{this.fill=E.fill!==undefined?E.fill:1;this.cornerPoint=E.cornerPoint!==undefined?E.cornerPoint:new c.Vector3(0,0,0);this.firstAxis=E.firstAxis!==undefined?E.firstAxis:new c.Vector3(1,0,0);this.secondAxis=E.secondAxis!==undefined?E.secondAxis:new c.Vector3(0,1,0);this.thirdAxis=E.thirdAxis!==undefined?E.thirdAxis:new c.Vector3(0,0,1);this.color=E.color!==undefined?E.color:new d.Color(0.5,0.5,0.5,1);k=E.layerNb?E.layerNb:0}x=new d.PrimitiveGroup();x.fillAttr=new d.FillAttributes();x.lineAttr=new d.LineAttributes();x.pointAttr=new d.PointAttributes();t=new d.Buffer();t.size=24;t.component=d.VertexComponentEnum.POSITION;t.format=d.DataTypeEnum.FLOAT;t.dimension=3;t.data=new Float32Array(24);p=new d.Buffer();p.size=18;p.component=d.VertexComponentEnum.NORMAL;p.format=d.DataTypeEnum.FLOAT;p.dimension=3;p.data=new Float32Array(18);h=new d.Buffer();h.size=12;h.component=d.VertexComponentEnum.TEX_COORD_0;h.format=d.DataTypeEnum.FLOAT;h.dimension=3;h.data=new Float32Array(12);f=new d.Buffer();f.indexBuffer=true;f.size=24;f.format=d.DataTypeEnum.UINT;f.dimension=1;f.data=new Uint16Array(24);s=new d.Buffer();s.indexBuffer=true;s.size=24;s.format=d.DataTypeEnum.UINT;s.dimension=1;s.data=new Uint16Array(24);w=new d.Buffer();w.indexBuffer=true;w.size=24;w.format=d.DataTypeEnum.UINT;w.dimension=1;w.data=new Uint16Array(24);x.addBuffer(0,t);x.addBuffer(1,p);x.addBuffer(2,h);x.addBuffer(3,f);x.addBuffer(4,s);x.addBuffer(5,w);D=t.data;z=0;B=new c.Vector3();B.addVectors(this.cornerPoint,this.thirdAxis);D[z++]=B.x;D[z++]=B.y;D[z++]=B.z;B.add(this.firstAxis);D[z++]=B.x;D[z++]=B.y;D[z++]=B.z;B.add(this.secondAxis);D[z++]=B.x;D[z++]=B.y;D[z++]=B.z;B.addVectors(this.cornerPoint,this.thirdAxis);B.add(this.secondAxis);D[z++]=B.x;D[z++]=B.y;D[z++]=B.z;B.addVectors(this.cornerPoint,this.secondAxis);D[z++]=B.x;D[z++]=B.y;D[z++]=B.z;B.add(this.firstAxis);D[z++]=B.x;D[z++]=B.y;D[z++]=B.z;B.addVectors(this.cornerPoint,this.firstAxis);D[z++]=B.x;D[z++]=B.y;D[z++]=B.z;D[z++]=this.cornerPoint.x;D[z++]=this.cornerPoint.y;D[z++]=this.cornerPoint.z;if(this.fill){D=f.data;z=0;y=0;D[z++]=0;D[z++]=1;D[z++]=3;D[z++]=2;D[z++]=4;D[z++]=5;D[z++]=7;D[z++]=6;D[z++]=0;D[z++]=3;D[z++]=7;D[z++]=4;D[z++]=6;D[z++]=5;D[z++]=1;D[z++]=2;D[z++]=5;D[z++]=4;D[z++]=2;D[z++]=3;D[z++]=7;D[z++]=6;D[z++]=0;D[z++]=1;D=s.data;z=0;for(y=0;y<6;y++){D[z++]=y;D[z++]=y;D[z++]=y;D[z++]=y}D=w.data;z=0;for(y=0;y<6;y++){D[z++]=2;D[z++]=3;D[z++]=0;D[z++]=1;D[z++]=1;D[z++]=0;D[z++]=3;D[z++]=2;D[z++]=3;D[z++]=1;D[z++]=2;D[z++]=0;D[z++]=3;D[z++]=1;D[z++]=2;D[z++]=0;D[z++]=1;D[z++]=0;D[z++]=3;D[z++]=2;D[z++]=2;D[z++]=3;D[z++]=0;D[z++]=1}D=p.data;z=0;D[z++]=0;D[z++]=0;D[z++]=1;D[z++]=0;D[z++]=0;D[z++]=-1;D[z++]=-1;D[z++]=0;D[z++]=0;D[z++]=1;D[z++]=0;D[z++]=0;D[z++]=0;D[z++]=1;D[z++]=0;D[z++]=0;D[z++]=-1;D[z++]=0;D=h.data;z=0;D[z++]=0;D[z++]=0;D[z++]=0;D[z++]=1;D[z++]=0;D[z++]=0;D[z++]=0;D[z++]=1;D[z++]=0;D[z++]=1;D[z++]=1;D[z++]=0}else{D=f.data;z=0;y=0;D[z++]=0;D[z++]=3;D[z++]=3;D[z++]=2;D[z++]=2;D[z++]=1;D[z++]=1;D[z++]=0;D[z++]=7;D[z++]=4;D[z++]=4;D[z++]=5;D[z++]=5;D[z++]=6;D[z++]=6;D[z++]=7;D[z++]=0;D[z++]=7;D[z++]=3;D[z++]=4;D[z++]=2;D[z++]=5;D[z++]=1;D[z++]=6}for(y=0;y<6;y++){o=new d.Primitive();o.nbIndices=4;o.connectivity=this.fill?d.ConnectivityTypeEnum.TRIANGLE_STRIP:d.ConnectivityTypeEnum.LINES;o.attr={fill:new d.FillAttributes(this.color,1),line:new d.LineAttributes(),point:new d.PointAttributes()};r=new d.VertexComponent();r.component=d.VertexComponentEnum.POSITION;r.nbVertices=4;r.nbValuesPerVertex=3;r.format=d.DataTypeEnum.FLOAT;r.cardinality=0;r.bufferId=0;r.indices=new d.IndexArray();r.indices.format=d.DataTypeEnum.UINT;r.indices.bufferId=3;r.indices.offset=4*y;o.addVertexComponent(r);if(this.fill){v=new d.VertexComponent();v.component=d.VertexComponentEnum.NORMAL;v.nbVertices=4;v.nbValuesPerVertex=3;v.format=d.DataTypeEnum.FLOAT;v.cardinality=0;v.bufferId=1;v.indices=new d.IndexArray();v.indices.format=d.DataTypeEnum.UINT;v.indices.bufferId=4;v.indices.offset=4*y;q=new d.VertexComponent();q.component=d.VertexComponentEnum.TEX_COORD_0;q.nbVertices=4;q.nbValuesPerVertex=3;q.format=d.DataTypeEnum.FLOAT;q.cardinality=0;q.bufferId=2;q.indices=new d.IndexArray();q.indices.format=d.DataTypeEnum.UINT;q.indices.bufferId=5;q.indices.offset=4*y;o.addVertexComponent(v);o.addVertexComponent(q)}x.addPrimitive(o)}x.noz=k>0;return x},CreateVis3DSphere:function(g,A,I,h,C,D,L,x,l){var w,X,m,E,s,H,p,O,J,V,Q,y,B,G,q,t,z,R,U,T,P,r,K,M,Z,o,Y,N,n,W;var f=false;if(g instanceof c.Matrix4||g===undefined){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");this.matrix=g!==undefined?g:null;this.radius=A!==undefined?A:1;this.meridianStart=I!==undefined?I:0;this.meridianEnd=h!==undefined?h:Math.PI*2;this.parallelStart=C!==undefined?C:0;this.parallelEnd=D!==undefined?D:Math.PI*2;this.sag=L!==undefined?L:80;Z=(x!==undefined)?x:new d.Color(0.5,0.5,0.5,1);W=l?l:0}else{this.matrix=g.matrix!==undefined?g.matrix:null;this.radius=g.radius!==undefined?g.radius:1;this.meridianStart=g.meridianStart!==undefined?g.meridianStart:0;this.meridianEnd=g.meridianEnd!==undefined?g.meridianEnd:Math.PI*2;this.parallelStart=g.parallelStart!==undefined?g.parallelStart:0;this.parallelEnd=g.parallelEnd!==undefined?g.parallelEnd:Math.PI*2;this.sag=g.sag!==undefined?g.sag:80;Z=(g.color!==undefined)?g.color:new d.Color(0.5,0.5,0.5,1);W=g.layerNb?g.layerNb:0;f=g.tgtBinorm?g.tgtBinorm:false}if(this.parallelStart<0){this.parallelStart=0}if(this.parallelStart>Math.PI){this.parallelStart=Math.PI}w=this.parallelEnd-this.parallelStart;if(w<0){w=0}if(this.parallelStart+w>Math.PI){w=Math.PI-this.parallelStart}if(this.meridianStart<0){this.meridianStart=0}if(this.meridianStart>2*Math.PI){this.meridianStart=2*Math.PI}X=this.meridianEnd-this.meridianStart;if(X<0){X=0}if(this.meridianStart+X>2*Math.PI){X=2*Math.PI-this.meridianStart}m=3*(this.sag+1)*this.sag;E=6*this.sag*(this.sag-1);s=new d.PrimitiveGroup();s.fillAttr=new d.FillAttributes();s.lineAttr=new d.LineAttributes();s.pointAttr=new d.PointAttributes();H=new d.Buffer();H.size=3*m;H.component=d.VertexComponentEnum.POSITION;H.format=d.DataTypeEnum.FLOAT;H.dimension=3;H.data=new Float32Array(H.size);p=new d.Buffer();p.size=3*m;p.component=d.VertexComponentEnum.NORMAL;p.format=d.DataTypeEnum.FLOAT;p.dimension=3;p.data=new Float32Array(p.size);O=new d.Buffer();O.size=3*m;O.component=d.VertexComponentEnum.TEX_COORD_0;O.format=d.DataTypeEnum.FLOAT;O.dimension=3;O.data=new Float32Array(O.size);if(f){J=new d.Buffer();J.size=3*m;J.component=d.VertexComponentEnum.TEX_COORD_2;J.format=d.DataTypeEnum.FLOAT;J.dimension=3;J.data=new Float32Array(J.size);V=new d.Buffer();V.size=3*m;V.component=d.VertexComponentEnum.TEX_COORD_3;V.format=d.DataTypeEnum.FLOAT;V.dimension=3;V.data=new Float32Array(V.size);s.addBuffer(5,J);s.addBuffer(6,V)}Q=new d.Buffer();Q.indexBuffer=true;Q.size=E;Q.format=d.DataTypeEnum.UINT;Q.dimension=1;Q.data=new Uint16Array(Q.size);s.addBuffer(0,H);s.addBuffer(1,p);s.addBuffer(2,O);s.addBuffer(3,Q);B=Q.data;R=0;for(U=0;U<this.sag-1;U++){for(T=0;T<this.sag;T++){B[R++]=U*(this.sag+1)+T;B[R++]=(U+1)*(this.sag+1)+T;B[R++]=(U+1)*(this.sag+1)+T+1;B[R++]=U*(this.sag+1)+T;B[R++]=(U+1)*(this.sag+1)+T+1;B[R++]=U*(this.sag+1)+T+1}}B=H.data;G=p.data;q=O.data;if(f){t=J.data;z=V.data}R=0;P=1/(this.sag-1);r=new c.Vector3();for(U=0;U<this.sag;U++){K=U*P;for(T=0;T<=this.sag;T++,R+=3){M=T/this.sag;G[R]=Math.sin(this.parallelStart+K*w)*Math.cos(this.meridianStart+M*X);r.x=this.radius*G[R];q[R]=T/this.sag;G[R+1]=Math.sin(this.parallelStart+K*w)*Math.sin(this.meridianStart+M*X);r.y=this.radius*G[R+1];q[R+1]=U/this.sag;G[R+2]=Math.cos(this.parallelStart+K*w);r.z=this.radius*G[R+2];q[R+2]=0;if(f){t[R]=G[R+1];t[R+1]=-G[R];t[R+2]=0;z[R]=G[R]*G[R+2];z[R+1]=G[R+1]*G[R+2];z[R+2]=-G[R]*G[R]-G[R+1]*G[R+1]}if(this.matrix){r.applyMatrix4(this.matrix)}B[R]=r.x;B[R+1]=r.y;B[R+2]=r.z}}o=new d.Primitive();o.nbIndices=E;o.connectivity=d.ConnectivityTypeEnum.TRIANGLES;o.attr={fill:new d.FillAttributes(Z,1),line:new d.LineAttributes(),point:new d.PointAttributes()};Y=new d.VertexComponent();Y.component=d.VertexComponentEnum.POSITION;Y.nbVertices=m;Y.nbValuesPerVertex=3;Y.format=d.DataTypeEnum.FLOAT;Y.cardinality=0;Y.bufferId=0;Y.indices=new d.IndexArray();Y.indices.format=d.DataTypeEnum.UINT;Y.indices.bufferId=3;Y.indices.offset=0;N=new d.VertexComponent();N.component=d.VertexComponentEnum.NORMAL;N.nbVertices=m;N.nbValuesPerVertex=3;N.format=d.DataTypeEnum.FLOAT;N.cardinality=0;N.bufferId=1;N.indices=new d.IndexArray();N.indices.format=d.DataTypeEnum.UINT;N.indices.bufferId=3;N.indices.offset=0;n=new d.VertexComponent();n.component=d.VertexComponentEnum.TEX_COORD_0;n.nbVertices=m;n.nbValuesPerVertex=3;n.format=d.DataTypeEnum.FLOAT;n.cardinality=0;n.bufferId=2;n.indices=new d.IndexArray();n.indices.format=d.DataTypeEnum.UINT;n.indices.bufferId=3;n.indices.offset=0;o.addVertexComponent(Y);o.addVertexComponent(N);o.addVertexComponent(n);if(f){var F=new d.VertexComponent();F.component=d.VertexComponentEnum.TEX_COORD_2;F.nbVertices=m;F.nbValuesPerVertex=3;F.format=d.DataTypeEnum.FLOAT;F.cardinality=0;F.bufferId=5;F.indices=new d.IndexArray();F.indices.format=d.DataTypeEnum.UINT;F.indices.bufferId=3;F.indices.offset=0;var S=new d.VertexComponent();S.component=d.VertexComponentEnum.TEX_COORD_3;S.nbVertices=m;S.nbValuesPerVertex=3;S.format=d.DataTypeEnum.FLOAT;S.cardinality=0;S.bufferId=6;S.indices=new d.IndexArray();S.indices.format=d.DataTypeEnum.UINT;S.indices.bufferId=3;S.indices.offset=0;o.addVertexComponent(F);o.addVertexComponent(S)}s.addPrimitive(o);s.noz=W>0;return s},CreateVis3DTube:function(g,A,L,Q,F,w,m){var D,v,h,T,E,W,n,l,B,u,f,C,r,I,M,x,y,J,O,t,z,o,G,N,p,s,V,k,U,H,q,K,S,P;if(g instanceof c.Vector3){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");D=g;v=new c.Vector3(0,0,0);v.addVectors(g,A);h=Q?Q:1;T=L?L:1;V=(w!==undefined)?w:new d.Color(0.2,0.8,0.2,1);S=m?m:0;P=F}else{D=g.bottomCenterPoint;v=new c.Vector3(0,0,0);v.addVectors(g.bottomCenterPoint,g.extrusionVector);h=g.externalRadius?g.externalRadius:1;T=g.internalRadius?g.internalRadius:1;P=g.sag?g.sag:0;V=(g.color!==undefined)?g.color:new d.Color(0.2,0.8,0.2,1);S=g.layerNb?g.layerNb:0}if(T===h){return this.CreateVis3DCylinderCustom({bottomCenterPoint:D,topCenterPoint:v,bottomRadius:h,topRadius:h,sag:P,bottomCap:false,topCap:false,internal:false,layerNb:S})}E=this.CreateVis3DCylinderCustom({bottomCenterPoint:D,topCenterPoint:v,bottomRadius:h,topRadius:h,sag:P,bottomCap:false,topCap:false,internal:false,layerNb:S});W=this.CreateVis3DCylinderCustom({bottomCenterPoint:D,topCenterPoint:v,bottomRadius:T,topRadius:T,sag:P,bottomCap:false,topCap:false,internal:true,layerNb:S});n=(P+1)*3*8;l=(P+1)*3*8;B=24*P;u=T/h;f=new d.PrimitiveGroup();f.fillAttr=new d.FillAttributes();f.lineAttr=new d.LineAttributes();f.pointAttr=new d.PointAttributes();C=new d.Buffer();C.size=n;C.component=d.VertexComponentEnum.POSITION;C.format=d.DataTypeEnum.FLOAT;C.dimension=3;C.data=new Float32Array(C.size);r=new d.Buffer();r.size=l;r.component=d.VertexComponentEnum.NORMAL;r.format=d.DataTypeEnum.FLOAT;r.dimension=3;r.data=new Float32Array(r.size);I=new d.Buffer();I.size=n;I.component=d.VertexComponentEnum.TEX_COORD_0;I.format=d.DataTypeEnum.FLOAT;I.dimension=3;I.data=new Float32Array(I.size);M=new d.Buffer();M.indexBuffer=true;M.size=B;M.format=d.DataTypeEnum.UINT;M.dimension=1;M.data=new Uint16Array(M.size);C.data.set(E.buffers[0].data.subarray(0,2*3*(P+1)),0);C.data.set(W.buffers[0].data.subarray(0,2*3*(P+1)),2*3*(P+1));C.data.set(E.buffers[0].data.subarray(0,3*(P+1)),4*3*(P+1));C.data.set(W.buffers[0].data.subarray(0,3*(P+1)),5*3*(P+1));C.data.set(E.buffers[0].data.subarray(3*(P+1),6*(P+1)),6*3*(P+1));C.data.set(W.buffers[0].data.subarray(3*(P+1),6*(P+1)),7*3*(P+1));I.data.set(E.buffers[2].data.subarray(0,2*3*(P+1)),0);I.data.set(W.buffers[2].data.subarray(0,2*3*(P+1)),2*3*(P+1));I.data.set(E.buffers[2].data.subarray(0,3*(P+1)),4*3*(P+1));I.data.set(W.buffers[2].data.subarray(0,3*(P+1)),5*3*(P+1));I.data.set(E.buffers[2].data.subarray(3*(P+1),6*(P+1)),6*3*(P+1));I.data.set(W.buffers[2].data.subarray(3*(P+1),6*(P+1)),7*3*(P+1));r.data.set(E.buffers[1].data.subarray(0,(P+1)*3*2),0);r.data.set(W.buffers[1].data.subarray(0,(P+1)*3*2),(P+1)*3*2);y=(P+1)*3*4;for(var R=0;R<2*(P+1);R++){r.data[y++]=0;r.data[y++]=0;r.data[y++]=-1}for(var R=0;R<2*(P+1);R++){r.data[y++]=0;r.data[y++]=0;r.data[y++]=1}M.data.set(E.buffers[3].data,0);t=E.buffers[3].size;z=E.buffers[0].size/3;o=E.buffers[1].size/3;for(O=0;O<t;O++){M.data[O+t]=W.buffers[3].data[O]+z}y=E.buffers[3].size+W.buffers[3].size;z*=2;G=(E.buffers[1].size+W.buffers[1].size)/3;for(N=0;N<P;++N){p=N+1;M.data[y++]=N+z;M.data[y++]=P+1+N+z;M.data[y++]=p+z;M.data[y++]=P+1+N+z;M.data[y++]=P+1+p+z;M.data[y++]=p+z}G+=1;z+=((P+1)*2);for(N=0;N<P;++N){p=N+1;M.data[y++]=P+1+N+z;M.data[y++]=N+z;M.data[y++]=p+z;M.data[y++]=p+z;M.data[y++]=P+1+p+z;M.data[y++]=P+1+N+z}f.addBuffer(0,C);f.addBuffer(1,r);f.addBuffer(2,I);f.addBuffer(3,M);f.addPrimitive(E.primitives[0]);f.addPrimitive(W.primitives[0]);s=W.primitives[0].vertexComponents;for(O=0;O<s.length;O++){s[O].indices.offset+=t}k=new d.Primitive();k.nbIndices=6*this.sag;k.connectivity=d.ConnectivityTypeEnum.TRIANGLES;k.attr={fill:new d.FillAttributes(V,1),line:new d.LineAttributes(),point:new d.PointAttributes()};U=new d.VertexComponent();U.component=d.VertexComponentEnum.POSITION;U.nbVertices=(this.sag+1)*2;U.nbValuesPerVertex=3;U.format=d.DataTypeEnum.FLOAT;U.cardinality=0;U.bufferId=0;U.indices=new d.IndexArray();U.indices.format=d.DataTypeEnum.UINT;U.indices.bufferId=3;U.indices.offset=E.buffers[3].size+W.buffers[3].size;H=new d.VertexComponent();H.component=d.VertexComponentEnum.NORMAL;H.nbVertices=(this.sag+1)*2;H.nbValuesPerVertex=3;H.format=d.DataTypeEnum.FLOAT;H.cardinality=0;H.bufferId=1;H.indices=new d.IndexArray();H.indices.format=d.DataTypeEnum.UINT;H.indices.bufferId=3;H.indices.offset=E.buffers[3].size+W.buffers[3].size;q=new d.VertexComponent();q.component=d.VertexComponentEnum.TEX_COORD_0;q.nbVertices=(this.sag+1)*2;q.nbValuesPerVertex=3;q.format=d.DataTypeEnum.FLOAT;q.cardinality=0;q.bufferId=2;q.indices=new d.IndexArray();q.indices.format=d.DataTypeEnum.UINT;q.indices.bufferId=3;q.indices.offset=E.buffers[3].size+W.buffers[3].size;k.addVertexComponent(U);k.addVertexComponent(H);k.addVertexComponent(q);f.addPrimitive(k);K=new d.Primitive();K.nbIndices=6*this.sag;K.connectivity=d.ConnectivityTypeEnum.TRIANGLES;K.attr={fill:new d.FillAttributes(V,1),line:new d.LineAttributes(),point:new d.PointAttributes()};U=new d.VertexComponent();U.component=d.VertexComponentEnum.POSITION;U.nbVertices=(this.sag+1)*2;U.nbValuesPerVertex=3;U.format=d.DataTypeEnum.FLOAT;U.cardinality=0;U.bufferId=0;U.indices=new d.IndexArray();U.indices.format=d.DataTypeEnum.UINT;U.indices.bufferId=3;U.indices.offset=E.buffers[3].size+W.buffers[3].size+(P*6);H=new d.VertexComponent();H.component=d.VertexComponentEnum.NORMAL;H.nbVertices=(this.sag+1)*2;H.nbValuesPerVertex=3;H.format=d.DataTypeEnum.FLOAT;H.cardinality=0;H.bufferId=1;H.indices=new d.IndexArray();H.indices.format=d.DataTypeEnum.UINT;H.indices.bufferId=3;H.indices.offset=E.buffers[3].size+W.buffers[3].size+(P*6);q=new d.VertexComponent();q.component=d.VertexComponentEnum.TEX_COORD_0;q.nbVertices=(this.sag+1)*2;q.nbValuesPerVertex=3;q.format=d.DataTypeEnum.FLOAT;q.cardinality=0;q.bufferId=2;q.indices=new d.IndexArray();q.indices.format=d.DataTypeEnum.UINT;q.indices.bufferId=3;q.indices.offset=E.buffers[3].size+W.buffers[3].size+(P*6);K.addVertexComponent(U);K.addVertexComponent(H);K.addVertexComponent(q);f.addPrimitive(K);f.noz=S>0;return f},CreateVis3DCylinder:function(l,h,k,j,f){var g;if(l instanceof c.Vector3){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");g={bottomCenterPoint:l,topCenterPoint:h,bottomRadius:k,topRadius:k,sag:j,bottomCap:true,topCap:true,internal:false,layerNb:f}}else{g={bottomCenterPoint:l.bottomCenterPoint,topCenterPoint:l.topCenterPoint,bottomRadius:l.radius,topRadius:l.radius,sag:l.sag,bottomCap:true,topCap:true,internal:false,color:l.color,layerNb:l.layerNb}}return this.CreateVis3DCylinderCustom(g)},CreateVis3DCone:function(m,h,n,l,k,j,f){var g;if(m instanceof c.Vector3){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");g={bottomCenterPoint:m,topCenterPoint:h,bottomRadius:n!==undefined?n:1,topRadius:l!==undefined?l:1,sag:k,bottomCap:true,topCap:true,internal:false,color:(j!==undefined)?j:new d.Color(0.2,0.8,0.2,1),layerNb:f||0}}else{g={bottomCenterPoint:m.bottomCenterPoint,topCenterPoint:m.topCenterPoint,bottomRadius:m.bottomRadius!==undefined?m.bottomRadius:1,topRadius:m.topRadius!==undefined?m.topRadius:1,sag:m.sag,bottomCap:true,topCap:true,internal:false,color:(m.color!==undefined)?m.color:new d.Color(0.2,0.8,0.2,1),layerNb:m.layerNb||0}}if(g.topRadius<=0){g.topCap=false}if(g.bottomRadius<=0){g.bottomCap=false}return this.CreateVis3DCylinderCustom(g)},CreateVis3DCylinderCustom:function(n,D,F,aj,ac,t,r,w,M,q){var an,I,ax,Q,C,g,S,ai,K,Y,o,x,T,s,p,L,X,B,ag,al,N,P,V,ak,aq,ap,R,z,ao,W,y,v,ah,H,am,ad,af,ar,G,U,J,aw,E,av,ae,A,Z,ab,l,au,O;if(n instanceof c.Vector3){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");this.bottomCenterPoint=n!==undefined?n:new c.Vector3(0,0,0);this.topCenterPoint=D!==undefined?D:new c.Vector3(0,5,0);this.bottomRadius=F!==undefined?F:1;this.topRadius=aj!==undefined?aj:1;this.sag=ac!==undefined?ac:80;an=r!==undefined?r:true;I=t!==undefined?t:true;ax=w!==undefined?w:false;au=q?q:0;aw=M?M:new d.Color(0.2,0.8,0.2,1)}else{this.bottomCenterPoint=n.bottomCenterPoint!==undefined?n.bottomCenterPoint:new c.Vector3(0,0,0);this.topCenterPoint=n.topCenterPoint!==undefined?n.topCenterPoint:new c.Vector3(0,5,0);this.bottomRadius=n.bottomRadius!==undefined?n.bottomRadius:1;this.topRadius=n.topRadius!==undefined?n.topRadius:1;this.sag=n.sag!==undefined?n.sag:80;an=n.topCap!==undefined?n.topCap:true;I=n.bottomCap!==undefined?n.bottomCap:true;ax=n.internal!==undefined?n.internal:false;au=n.layerNb?n.layerNb:0;aw=n.color?n.color:new d.Color(0.2,0.8,0.2,1)}Q=new c.Vector4(0,0,0,0);Q.subVectors(this.topCenterPoint,this.bottomCenterPoint);Q.w=0;Q.normalize();C=new c.Matrix4();if(Q.x===0&&Q.y===0){C.identity()}else{C.set(Q.x/Math.sqrt(Q.x*Q.x+Q.y*Q.y),Q.y/Math.sqrt(Q.x*Q.x+Q.y*Q.y),0,0,-Q.y/Math.sqrt(Q.x*Q.x+Q.y*Q.y),Q.x/Math.sqrt(Q.x*Q.x+Q.y*Q.y),0,0,0,0,1,0,0,0,0,1)}g=new c.Matrix4();if(Q.x===0&&Q.y===0&&Q.z===0){g.identity()}else{g.set(Q.z/Math.sqrt(Q.x*Q.x+Q.y*Q.y+Q.z*Q.z),0,-Math.sqrt(Q.x*Q.x+Q.y*Q.y)/Math.sqrt(Q.x*Q.x+Q.y*Q.y+Q.z*Q.z),0,0,1,0,0,Math.sqrt(Q.x*Q.x+Q.y*Q.y)/Math.sqrt(Q.x*Q.x+Q.y*Q.y+Q.z*Q.z),0,Q.z/Math.sqrt(Q.x*Q.x+Q.y*Q.y+Q.z*Q.z),0,0,0,0,1)}S=new c.Matrix4();S.multiplyMatrices(g,C);S.transpose();K=S.clone();Y=new c.Vector3(this.bottomCenterPoint.x,this.bottomCenterPoint.y,this.bottomCenterPoint.z);ai=S.clone();S.elements[12]=Y.x;S.elements[13]=Y.y;S.elements[14]=Y.z;o=Math.sqrt((this.bottomCenterPoint.x-this.topCenterPoint.x)*(this.bottomCenterPoint.x-this.topCenterPoint.x)+(this.bottomCenterPoint.y-this.topCenterPoint.y)*(this.bottomCenterPoint.y-this.topCenterPoint.y)+(this.bottomCenterPoint.z-this.topCenterPoint.z)*(this.bottomCenterPoint.z-this.topCenterPoint.z));x=(this.bottomRadius-this.topRadius)/o;T=6*this.sag;s=2*(this.sag+1);p=2*(this.sag+1);var f=s;if(an){T+=3*(this.sag-2);f+=this.sag;p+=this.sag;s+=this.sag}if(I){T+=3*(this.sag-2);f+=this.sag;p+=this.sag;s+=this.sag}L=new d.PrimitiveGroup();L.fillAttr=new d.FillAttributes();L.lineAttr=new d.LineAttributes();L.pointAttr=new d.PointAttributes();X=new d.Buffer();X.size=3*s;X.component=d.VertexComponentEnum.POSITION;X.format=d.DataTypeEnum.FLOAT;X.dimension=3;X.data=new Float32Array(X.size);B=new d.Buffer();B.size=3*p;B.component=d.VertexComponentEnum.NORMAL;B.format=d.DataTypeEnum.FLOAT;B.dimension=3;B.data=new Float32Array(B.size);ag=new d.Buffer();ag.size=3*f;ag.component=d.VertexComponentEnum.TEX_COORD_0;ag.format=d.DataTypeEnum.FLOAT;ag.dimension=3;ag.data=new Float32Array(ag.size);al=new d.Buffer();al.indexBuffer=true;al.size=T;al.format=d.DataTypeEnum.UINT;al.dimension=1;al.data=new Uint16Array(al.size);L.addBuffer(0,X);L.addBuffer(1,B);L.addBuffer(2,ag);L.addBuffer(3,al);P=al.data;ak=0;if(ax){for(ap=0;ap<this.sag;++ap){z=ap+1;P[ak++]=z;P[ak++]=ap;P[ak++]=this.sag+1+ap;P[ak++]=z;P[ak++]=this.sag+1+ap;P[ak++]=this.sag+1+z}}else{for(ap=0;ap<this.sag;++ap){z=ap+1;P[ak++]=ap;P[ak++]=z;P[ak++]=this.sag+1+ap;P[ak++]=this.sag+1+ap;P[ak++]=z;P[ak++]=this.sag+1+z}}if(an){for(ap=0;ap<this.sag-2;ap++){P[ak++]=2*this.sag+2;P[ak++]=2*this.sag+2+ap+1;P[ak++]=2*this.sag+2+ap+2}}if(I){if(an){for(ap=0;ap<this.sag-2;ap++){P[ak++]=3*this.sag+2;P[ak++]=3*this.sag+2+ap+1;P[ak++]=3*this.sag+2+ap+2}}else{for(ap=0;ap<this.sag-2;ap++){P[ak++]=2*this.sag+2;P[ak++]=2*this.sag+2+ap+1;P[ak++]=2*this.sag+2+ap+2}}}ah=X.data;H=ag.data;var am=0;for(ap=0;ap<this.sag+1;ap++,am+=3){G=(ap/this.sag)*2*Math.PI;ah[am]=this.bottomRadius*Math.cos(G);ah[am+1]=this.bottomRadius*Math.sin(G);ah[am+2]=0;H[am]=ap/this.sag;H[am+1]=1;H[am+2]=0}am=3*(this.sag+1);for(ap=0;ap<this.sag+1;ap++,am+=3){G=(ap/this.sag)*2*Math.PI;ah[am]=this.topRadius*Math.cos(G);ah[am+1]=this.topRadius*Math.sin(G);ah[am+2]=o;H[am]=ap/this.sag;H[am+1]=0;H[am+2]=0}if(an){G=0;for(aq=0;aq<this.sag;aq++){G=(aq/this.sag)*2*Math.PI;ah[am]=ah[3*(this.sag+aq+1)];H[am++]=(Math.cos(G)+1)/2;ah[am]=ah[3*(this.sag+aq+1)+1];H[am++]=1-(Math.sin(G)+1)/2;ah[am]=ah[3*(this.sag+aq+1)+2];H[am++]=0}}if(I){G=0;for(aq=0;aq<this.sag;aq++){G=(aq/this.sag)*2*Math.PI;ah[am]=ah[3*(this.sag-1-aq)];H[am++]=(Math.cos(G)+1)/2;ah[am]=ah[3*(this.sag-1-aq)+1];H[am++]=1-(Math.sin(G)+1)/2;ah[am]=ah[3*(this.sag-1-aq)+2];H[am++]=0}}ah=B.data;am=0;for(var at=0;at<2;at++){for(ap=0;ap<this.sag+1;ap++){G=(ap/this.sag)*2*Math.PI;J=new c.Vector3();J.x=X.data[ap*3];J.y=X.data[ap*3+1];J.z=X.data[ap*3+2];J.z=Math.sqrt(J.x*J.x+J.y*J.y)*x;J.normalize();if(ax){ah[am++]=-J.x;ah[am++]=-J.y;ah[am++]=-J.z}else{ah[am++]=J.x;ah[am++]=J.y;ah[am++]=J.z}}}if(an){for(var at=0;at<this.sag;at++){ah[am++]=0;ah[am++]=0;ah[am++]=1}}if(I){for(var at=0;at<this.sag;at++){ah[am++]=0;ah[am++]=0;ah[am++]=-1}}for(aq=0;aq<s;aq++){J=new c.Vector3();J.x=X.data[aq*3];J.y=X.data[aq*3+1];J.z=X.data[aq*3+2];J.applyMatrix4(S);X.data[aq*3]=J.x;X.data[aq*3+1]=J.y;X.data[aq*3+2]=J.z}for(aq=0;aq<p;aq++){J=new c.Vector3();J.x=B.data[aq*3];J.y=B.data[aq*3+1];J.z=B.data[aq*3+2];J.applyMatrix4(ai);B.data[aq*3]=J.x;B.data[aq*3+1]=J.y;B.data[aq*3+2]=J.z}E=new d.Primitive();E.nbIndices=6*this.sag;E.connectivity=d.ConnectivityTypeEnum.TRIANGLES;E.attr={fill:new d.FillAttributes(aw,1),line:new d.LineAttributes(),point:new d.PointAttributes()};av=new d.VertexComponent();av.component=d.VertexComponentEnum.POSITION;av.nbVertices=2*this.sag;av.nbValuesPerVertex=3;av.format=d.DataTypeEnum.FLOAT;av.cardinality=0;av.bufferId=0;av.indices=new d.IndexArray();av.indices.format=d.DataTypeEnum.UINT;av.indices.bufferId=3;av.indices.offset=0;ae=new d.VertexComponent();ae.component=d.VertexComponentEnum.NORMAL;ae.nbVertices=2*this.sag;ae.nbValuesPerVertex=3;ae.format=d.DataTypeEnum.FLOAT;ae.cardinality=0;ae.bufferId=1;ae.indices=new d.IndexArray();ae.indices.format=d.DataTypeEnum.UINT;ae.indices.bufferId=3;ae.indices.offset=0;A=new d.VertexComponent();A.component=d.VertexComponentEnum.TEX_COORD_0;A.nbVertices=2*this.sag;A.nbValuesPerVertex=3;A.format=d.DataTypeEnum.FLOAT;A.cardinality=0;A.bufferId=2;A.indices=new d.IndexArray();A.indices.format=d.DataTypeEnum.UINT;A.indices.bufferId=3;A.indices.offset=0;E.addVertexComponent(av);E.addVertexComponent(ae);E.addVertexComponent(A);L.addPrimitive(E);if(an){Z=new d.Primitive();Z.nbIndices=3*(this.sag-2);Z.connectivity=d.ConnectivityTypeEnum.TRIANGLES;Z.attr={fill:new d.FillAttributes(aw,1),line:new d.LineAttributes(),point:new d.PointAttributes()};av=new d.VertexComponent();av.component=d.VertexComponentEnum.POSITION;av.nbVertices=this.sag;av.nbValuesPerVertex=3;av.format=d.DataTypeEnum.FLOAT;av.cardinality=0;av.bufferId=0;av.indices=new d.IndexArray();av.indices.format=d.DataTypeEnum.UINT;av.indices.bufferId=3;av.indices.offset=6*this.sag;ae=new d.VertexComponent();ae.component=d.VertexComponentEnum.NORMAL;ae.nbVertices=this.sag;ae.nbValuesPerVertex=3;ae.format=d.DataTypeEnum.FLOAT;ae.cardinality=0;ae.bufferId=1;ae.indices=new d.IndexArray();ae.indices.format=d.DataTypeEnum.UINT;ae.indices.bufferId=3;ae.indices.offset=6*this.sag;A=new d.VertexComponent();A.component=d.VertexComponentEnum.TEX_COORD_0;A.nbVertices=this.sag;A.nbValuesPerVertex=3;A.format=d.DataTypeEnum.FLOAT;A.cardinality=0;A.bufferId=2;A.offset=2*(this.sag+1);Z.addVertexComponent(av);Z.addVertexComponent(ae);Z.addVertexComponent(A);L.addPrimitive(Z)}if(I){ab=6*this.sag;if(an){ab+=3*(this.sag-2)}l=new d.Primitive();l.nbIndices=3*(this.sag-2);l.connectivity=d.ConnectivityTypeEnum.TRIANGLES;l.attr={fill:new d.FillAttributes(aw,1),line:new d.LineAttributes(),point:new d.PointAttributes()};av=new d.VertexComponent();av.component=d.VertexComponentEnum.POSITION;av.nbVertices=this.sag;av.nbValuesPerVertex=3;av.format=d.DataTypeEnum.FLOAT;av.cardinality=0;av.bufferId=0;av.indices=new d.IndexArray();av.indices.format=d.DataTypeEnum.UINT;av.indices.bufferId=3;av.indices.offset=ab;ae=new d.VertexComponent();ae.component=d.VertexComponentEnum.NORMAL;ae.nbVertices=this.sag;ae.nbValuesPerVertex=3;ae.format=d.DataTypeEnum.FLOAT;ae.cardinality=0;ae.bufferId=1;ae.indices=new d.IndexArray();ae.indices.format=d.DataTypeEnum.UINT;ae.indices.bufferId=3;ae.indices.offset=ab;A=new d.VertexComponent();A.component=d.VertexComponentEnum.TEX_COORD_0;A.nbVertices=this.sag+2;A.nbValuesPerVertex=3;A.format=d.DataTypeEnum.FLOAT;A.cardinality=0;A.bufferId=2;A.offset=an?this.sag:0;A.offset+=2*(this.sag+1);l.addVertexComponent(av);l.addVertexComponent(ae);l.addVertexComponent(A);L.addPrimitive(l)}L.noz=au>0;return L},createLine:function(g,v,R,l){var H,J,Q,u,f,L,U,S,C=d.ConnectivityTypeEnum.LINE_STRIP,I=false;var m=false;var s=false;if(g instanceof Array){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");H=g;f=R;J=[];Q=[];U=(v!==undefined)?v:new d.Color(0.5,0.5,0.5,1);S=l?l:0}else{if(g instanceof Object){H=g.points;J=g.colors?g.colors:[];Q=g.idx?g.idx:[];C=g.drawMode?g.drawMode:C;I=g.editable?g.editable:false;u=g.patternOffsets?g.patternOffsets:[];if(C!==d.ConnectivityTypeEnum.LINES&&C!==d.ConnectivityTypeEnum.LINE_STRIP){console.warn("Invalid draw mode for the line, passing to strip mode");C=d.ConnectivityTypeEnum.LINE_STRIP}if(C===d.ConnectivityTypeEnum.LINES&&Q.length===0){for(var O=0;O<H.length-1;O++){Q.push(O);Q.push(O+1)}}if(g.hasOwnProperty("material")){var F=function(){if(Q.length===0){return false}if(g.material.is2DLine){return g.material.isDashedLine}var V=new Set();var Y=0;for(var W=0;W<Q.length;W++){var X=Q[W];if(V.has(X)&&X!==Y){return true}Y=X;V.add(X)}return false};f=g.material.lineWidth;m=F();U=(g.material.color!==undefined)?g.material.color:new d.Color(0.5,0.5,0.5,1);if(u.length&&u.length===Q.length){s=true}}else{f=g.width;U=(g.color!==undefined)?g.color:new d.Color(0.5,0.5,0.5,1)}S=g.layerNb?g.layerNb:0}}if(m){var r=[],t=[],y=[];for(var O=0;O<Q.length;O++){var z=Q[O];r.push(H[z]);if(J.length){t.push(J[z])}if(s){y.push(u[z])}Q[O]=O}H=r;J=t;u=y}var h=H.length;var k=J.length;var P=Q.length;if(!h){return null}var E=function(ab,X,W,Z,Y){var V=new d.Buffer();V.size=ab*X;V.component=W;V.format=Z;V.dimension=ab;V.data=new Float32Array(V.size);return V};var x=function(W){var V=new d.Buffer();V.indexBuffer=true;V.size=W;V.format=d.DataTypeEnum.UINT;V.dimension=1;if(W>65535){V.data=new Uint32Array(V.size)}else{V.data=new Uint16Array(V.size)}return V};var p=new d.PrimitiveGroup();p.fillAttr=new d.FillAttributes();p.lineAttr=new d.LineAttributes(U,f);p.pointAttr=new d.PointAttributes();var D=0;var A=E(3,h,d.VertexComponentEnum.POSITION,d.DataTypeEnum.FLOAT);var G=D++;p.addBuffer(G,A);L=A.data;for(var O=0;O<h;O++){var q=H[O];L[3*O]=q.x;L[3*O+1]=q.y;L[3*O+2]=q.z}var o=false;var j=0;if(k===h){o=E(4,k,d.VertexComponentEnum.DIFFUSE_COLOR,d.DataTypeEnum.FLOAT);j=D++;p.addBuffer(j,o);L=o.data;for(var O=0;O<k;O++){var n=J[O];L[4*O]=n.x;L[4*O+1]=n.y;L[4*O+2]=n.z;L[4*O+3]=n.w}}var K=false;var w=0;if(P){w=D++;K=x(Q.length);p.addBuffer(w,K);L=K.data;for(var O=0;O<P;O++){L[O]=Q[O]}}if(s){p.patternOffsets=u}var M=new d.Primitive();M.nbIndices=P?P:h;M.connectivity=C;M.attr={fill:new d.FillAttributes(U),line:new d.LineAttributes(U,f),point:new d.PointAttributes()};var B=function(W,ab,Z,ac,Y,V){var X=new d.VertexComponent();X.component=W.component;X.nbValuesPerVertex=W.dim;X.format=W.format;X.nbVertices=Z;X.cardinality=0;X.bufferId=ab;if(ac){X.indices=new d.IndexArray();X.indices.format=ac.format;X.indices.bufferId=Y;X.indices.offset=V}return X};var T=B(A,G,h,K,w,0);M.addVertexComponent(T);var N;if(k){N=B(o,j,k,K,w,0);M.addVertexComponent(N)}p.addPrimitive(M);p.noz=S>0;p.editable=I;return p},createRectangle:function(F,m,C,D,j,h){var G,v,p,u,f,s,y,E,B,l,r,q,n,o,x,z,w,A,t,g,H,k;if(F instanceof Object){z=F.width?F.width:1;w=F.height?F.height:1;A=F.fill?F.fill:false;l=(F.color!==undefined)?F.color:new d.Color(0.5,0.5,0.5,1);t=(F.noEdge?F.noEdge:false);g=(F.layerNb?F.layerNb:0);H=F.sharing?F.sharing:false;k=F.cornerPoint?F.cornerPoint:new c.Vector2(0,0)}else{console.warn("DEPRECATED: Please use a litteral object to define your primitive.");z=F?F:1;w=m?m:1;A=C?C:false;l=(D!==undefined)?D:new d.Color(0.5,0.5,0.5,1);t=(j?j:false);g=(h?h:0);k=new c.Vector2(0,0);H=false}G=new d.PrimitiveGroup();G.sharing=H;G.fillAttr=new d.FillAttributes();G.lineAttr=new d.LineAttributes();G.pointAttr=new d.PointAttributes();v=new d.Buffer();v.size=15;v.component=d.VertexComponentEnum.POSITION;v.format=d.DataTypeEnum.FLOAT;v.dimension=3;v.data=new Float32Array(v.size);p=new d.Buffer();p.size=3;p.component=d.VertexComponentEnum.NORMAL;p.format=d.DataTypeEnum.FLOAT;p.dimension=3;p.data=new Float32Array(p.size);u=new d.Buffer();u.size=12;u.component=d.VertexComponentEnum.TEX_COORD_0;u.format=d.DataTypeEnum.FLOAT;u.dimension=3;u.data=new Float32Array(u.size);f=new d.Buffer();f.indexBuffer=true;f.size=A?9:5;f.format=d.DataTypeEnum.UINT;f.dimension=1;f.data=new Uint16Array(f.size);s=new d.Buffer();s.indexBuffer=true;s.size=5;s.format=d.DataTypeEnum.UINT;s.dimension=1;s.data=new Uint16Array(s.size);y=new d.Buffer();y.indexBuffer=true;y.size=A?4:0;y.format=d.DataTypeEnum.UINT;y.dimension=1;y.data=new Uint16Array(y.size);G.addBuffer(0,v);G.addBuffer(1,p);G.addBuffer(2,f);G.addBuffer(3,s);G.addBuffer(4,u);G.addBuffer(5,y);E=f.data;B=0;E[B++]=0;E[B++]=1;E[B++]=2;E[B++]=3;E[B++]=4;if(A){E[B++]=0;E[B++]=1;E[B++]=3;E[B++]=2}E=s.data;B=0;E[B++]=0;E[B++]=0;E[B++]=0;E[B++]=0;E[B++]=0;E=y.data;B=0;if(A){E[B++]=0;E[B++]=1;E[B++]=3;E[B++]=2}E=v.data;B=0;E[B++]=k.x;E[B++]=k.y;E[B++]=0;E[B++]=z+k.x;E[B++]=k.y;E[B++]=0;E[B++]=z+k.x;E[B++]=w+k.y;E[B++]=0;E[B++]=k.x;E[B++]=w+k.y;E[B++]=0;E[B++]=k.x;E[B++]=k.y;E[B++]=0;E=p.data;B=0;E[B++]=0;E[B++]=0;E[B++]=1;E=u.data;B=0;E[B++]=0;E[B++]=0;E[B++]=0;E[B++]=1;E[B++]=0;E[B++]=0;E[B++]=1;E[B++]=1;E[B++]=0;E[B++]=0;E[B++]=1;E[B++]=0;if(!t){r=new d.Primitive();r.nbIndices=5;r.connectivity=d.ConnectivityTypeEnum.LINE_STRIP;r.attr={fill:new d.FillAttributes(l),line:new d.LineAttributes(l),point:new d.PointAttributes()};q=new d.VertexComponent();q.component=d.VertexComponentEnum.POSITION;q.nbVertices=5;q.nbValuesPerVertex=3;q.format=d.DataTypeEnum.FLOAT;q.cardinality=0;q.bufferId=0;q.indices=new d.IndexArray();q.indices.format=d.DataTypeEnum.UINT;q.indices.bufferId=2;q.indices.offset=0;x=new d.VertexComponent();x.component=d.VertexComponentEnum.NORMAL;x.nbVertices=1;x.nbValuesPerVertex=3;x.format=d.DataTypeEnum.FLOAT;x.cardinality=0;x.bufferId=1;x.indices=new d.IndexArray();x.indices.format=d.DataTypeEnum.UINT;x.indices.bufferId=3;x.indices.offset=0;r.addVertexComponent(q);r.addVertexComponent(x);G.addPrimitive(r)}if(A){o=new d.Primitive();o.nbIndices=4;o.connectivity=d.ConnectivityTypeEnum.TRIANGLE_STRIP;o.attr={fill:new d.FillAttributes(l),line:new d.LineAttributes(),point:new d.PointAttributes()};q=new d.VertexComponent();q.component=d.VertexComponentEnum.POSITION;q.nbVertices=4;q.nbValuesPerVertex=3;q.format=d.DataTypeEnum.FLOAT;q.cardinality=0;q.bufferId=0;q.indices=new d.IndexArray();q.indices.format=d.DataTypeEnum.UINT;q.indices.bufferId=2;q.indices.offset=5;x=new d.VertexComponent();x.component=d.VertexComponentEnum.NORMAL;x.nbVertices=1;x.nbValuesPerVertex=3;x.format=d.DataTypeEnum.FLOAT;x.cardinality=0;x.bufferId=1;x.indices=new d.IndexArray();x.indices.format=d.DataTypeEnum.UINT;x.indices.bufferId=3;x.indices.offset=0;n=new d.VertexComponent();n.component=d.VertexComponentEnum.TEX_COORD_0;n.nbVertices=4;n.nbValuesPerVertex=3;n.format=d.DataTypeEnum.FLOAT;n.cardinality=0;n.bufferId=4;n.indices=new d.IndexArray();n.indices.format=d.DataTypeEnum.UINT;n.indices.bufferId=5;n.indices.offset=0;o.addVertexComponent(q);o.addVertexComponent(x);o.addVertexComponent(n);G.addPrimitive(o)}G.noz=g>0;return G},createCircle:function(Q,F,L,O,D,N,h){var n,z,r,y,f,w,B,P,G,J,K,s,p,v,m,u,t,q,A,o,M,I,C,x,l,E,H,g;if(Q instanceof Object){l=Q.radius?Q.radius:1;E=Q.segments?Q.segments:24;I=Q.startAngle!==undefined?Q.startAngle:0;C=Q.endAngle!==undefined?Q.endAngle:Math.PI*2;H=Q.fill?Q.fill:false;m=(Q.color!==undefined)?Q.color:new d.Color(0.5,0.5,0.5,1);x=(Q.noEdge?Q.noEdge:false);g=(Q.layerNb?Q.layerNb:0)}else{console.warn("DEPRECATED: Please use a litteral object to define your primitive.");l=Q?Q:1;E=F?F:24;I=O!==undefined?O:0;C=D!==undefined?D:Math.PI*2;H=L?L:false;x=false;m=(N!==undefined)?N:new d.Color(0.5,0.5,0.5,1);g=(h?h:0)}M=C-I;n=new d.PrimitiveGroup();n.fillAttr=new d.FillAttributes();n.lineAttr=new d.LineAttributes();n.pointAttr=new d.PointAttributes();z=new d.Buffer();z.size=3*(E+2);z.component=d.VertexComponentEnum.POSITION;z.format=d.DataTypeEnum.FLOAT;z.dimension=3;z.data=new Float32Array(z.size);r=new d.Buffer();r.size=3;r.component=d.VertexComponentEnum.NORMAL;r.format=d.DataTypeEnum.FLOAT;r.dimension=3;r.data=new Float32Array(r.size);y=new d.Buffer();y.size=2*3;y.component=d.VertexComponentEnum.TEX_COORD_0;y.format=d.DataTypeEnum.FLOAT;y.dimension=3;y.data=new Float32Array(y.size);f=new d.Buffer();f.indexBuffer=true;f.size=H?2*(E+1)+1:E+1;f.format=d.DataTypeEnum.UINT;f.dimension=1;f.data=new Uint16Array(f.size);w=new d.Buffer();w.indexBuffer=true;w.size=E+2;w.format=d.DataTypeEnum.UINT;w.dimension=1;w.data=new Uint16Array(w.size);B=new d.Buffer();B.indexBuffer=true;B.size=H?E+2:0;B.format=d.DataTypeEnum.UINT;B.dimension=1;B.data=new Uint16Array(B.size);n.addBuffer(0,z);n.addBuffer(1,r);n.addBuffer(2,y);n.addBuffer(3,f);n.addBuffer(4,w);n.addBuffer(5,B);P=f.data;G=0;for(J=1;J<E+2;J++){P[G++]=J}if(H){G=E+1;P[G++]=0;for(J=1;J<E+2;J++){P[G++]=J}}P=w.data;G=0;for(G=0;G<=E+2;G++){P[G++]=0}if(H){P=B.data;P[0]=0;for(G=1;G<=E+2;G++){P[G]=1}}P=z.data;G=0;P[G++]=0;P[G++]=0;P[G++]=0;for(J=0;J<E+2;J++){p=(J/E)*M+I;P[G++]=l*Math.cos(p);P[G++]=l*Math.sin(p);P[G++]=0}P=r.data;K=0;P[K++]=0;P[K++]=0;P[K++]=1;P=y.data;K=0;P[K++]=0;P[K++]=0;P[K++]=0;P[K++]=1;P[K++]=0;P[K++]=0;if(!x){u=new d.Primitive();u.nbIndices=E+1;u.connectivity=d.ConnectivityTypeEnum.LINE_STRIP;u.attr={fill:new d.FillAttributes(m),line:new d.LineAttributes(),point:new d.PointAttributes()};t=new d.VertexComponent();t.component=d.VertexComponentEnum.POSITION;t.nbVertices=E+2;t.nbValuesPerVertex=3;t.format=d.DataTypeEnum.FLOAT;t.cardinality=0;t.bufferId=0;t.indices=new d.IndexArray();t.indices.format=d.DataTypeEnum.UINT;t.indices.bufferId=3;t.indices.offset=0;A=new d.VertexComponent();A.component=d.VertexComponentEnum.NORMAL;A.nbVertices=1;A.nbValuesPerVertex=3;A.format=d.DataTypeEnum.FLOAT;A.cardinality=0;A.bufferId=1;A.indices=new d.IndexArray();A.indices.format=d.DataTypeEnum.UINT;A.indices.bufferId=4;A.indices.offset=0;u.addVertexComponent(t);u.addVertexComponent(A);n.addPrimitive(u)}if(H){q=new d.Primitive();q.nbIndices=E+2;q.connectivity=d.ConnectivityTypeEnum.TRIANGLE_FAN;q.attr={fill:new d.FillAttributes(m),line:new d.LineAttributes(),point:new d.PointAttributes()};t=new d.VertexComponent();t.component=d.VertexComponentEnum.POSITION;t.nbVertices=E+2;t.nbValuesPerVertex=3;t.format=d.DataTypeEnum.FLOAT;t.cardinality=0;t.bufferId=0;t.indices=new d.IndexArray();t.indices.format=d.DataTypeEnum.UINT;t.indices.bufferId=3;t.indices.offset=E+1;A=new d.VertexComponent();A.component=d.VertexComponentEnum.NORMAL;A.nbVertices=1;A.nbValuesPerVertex=3;A.format=d.DataTypeEnum.FLOAT;A.cardinality=0;A.bufferId=1;A.indices=new d.IndexArray();A.indices.format=d.DataTypeEnum.UINT;A.indices.bufferId=4;A.indices.offset=0;o=new d.VertexComponent();o.component=d.VertexComponentEnum.TEX_COORD_0;o.nbVertices=2;o.nbValuesPerVertex=3;o.format=d.DataTypeEnum.FLOAT;o.cardinality=0;o.bufferId=2;o.indices=new d.IndexArray();o.indices.format=d.DataTypeEnum.UINT;o.indices.bufferId=5;o.indices.offset=0;q.addVertexComponent(t);q.addVertexComponent(A);q.addVertexComponent(o);n.addPrimitive(q)}n.noz=g>0;return n},createTorus:function(g,H,l,p,o,J,A,h){var B,n,E,r,G,N,P,C,F,x,O,Q,f,S,R,K,I,y,z,D,q,w,L,V,t,U,s,M,T;if(g instanceof c.Matrix4){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");this.axis=g||null;this.majorRadius=H||100;this.minorRadius=l||40;this.majorStartAngle=p||0;this.majorEndAngle=o||Math.PI*2;this.sag=J||8;V=(A!==undefined)?A:new d.Color(0.5,0.5,0.5,1);T=(h?h:0)}else{if(g instanceof Object){this.axis=g.axis||null;this.majorRadius=g.majorRadius||100;this.minorRadius=g.minorRadius||40;this.majorStartAngle=g.majorStartAngle||0;this.majorEndAngle=g.majorEndAngle||Math.PI*2;this.sag=g.sag||8;V=g.color||((A!==undefined)?A:new d.Color(0.5,0.5,0.5,1));T=(h?h:0)}}B=(this.majorEndAngle-this.majorStartAngle)/this.sag;n=(this.sag+1)*(this.sag+1);E=6*this.sag*this.sag;r=new d.PrimitiveGroup();r.fillAttr=new d.FillAttributes();r.lineAttr=new d.LineAttributes();r.pointAttr=new d.PointAttributes();G=new d.Buffer();G.size=3*n;G.component=d.VertexComponentEnum.POSITION;G.format=d.DataTypeEnum.FLOAT;G.dimension=3;G.data=new Float32Array(G.size);w=new d.Buffer();w.size=3*n;w.component=d.VertexComponentEnum.NORMAL;w.format=d.DataTypeEnum.FLOAT;w.dimension=3;w.data=new Float32Array(w.size);N=new d.Buffer();N.size=3*n;N.component=d.VertexComponentEnum.TEX_COORD_0;N.format=d.DataTypeEnum.FLOAT;N.dimension=3;N.data=new Float32Array(N.size);P=new d.Buffer();P.indexBuffer=true;P.size=E;P.format=d.DataTypeEnum.UINT;P.dimension=1;P.data=new Uint16Array(P.size);r.addBuffer(0,G);r.addBuffer(1,w);r.addBuffer(2,N);r.addBuffer(3,P);C=P.data;O=0;for(S=0;S<(this.sag);++S){D=S+1;for(R=0;R<this.sag;++R){q=R+1;C[O]=S*(this.sag+1)+R;C[O+1]=D*(this.sag+1)+R;C[O+2]=S*(this.sag+1)+q;C[O+3]=D*(this.sag+1)+q;C[O+4]=S*(this.sag+1)+q;C[O+5]=D*(this.sag+1)+R;O+=6}}C=G.data;F=w.data;x=N.data;Q=0;f=new c.Vector3();for(S=0;S<(this.sag+1);S++){K=this.majorStartAngle+S*B;for(R=0;R<this.sag+1;R++,Q+=3){I=R/this.sag*2*Math.PI;f.x=this.majorRadius*Math.cos(K);f.y=this.majorRadius*Math.sin(K);y=new c.Vector3();y.x=(this.majorRadius+this.minorRadius*Math.cos(I))*Math.cos(K);y.y=(this.majorRadius+this.minorRadius*Math.cos(I))*Math.sin(K);y.z=this.minorRadius*Math.sin(I);z=y.clone();if(this.axis){y.applyMatrix4(this.axis)}C[Q]=y.x;C[Q+1]=y.y;C[Q+2]=y.z;L=new c.Vector3();L.subVectors(z,f).normalize();if(this.axis){L.applyMatrix4(this.axis)}L.normalize();F[Q]=L.x;F[Q+1]=L.y;F[Q+2]=L.z;x[Q]=S/this.sag;x[Q+1]=1-R/this.sag;x[Q+2]=0}}t=new d.Primitive();t.nbIndices=E;t.connectivity=d.ConnectivityTypeEnum.TRIANGLES;t.attr={fill:new d.FillAttributes(V,1),line:new d.LineAttributes(),point:new d.PointAttributes()};U=new d.VertexComponent();U.component=d.VertexComponentEnum.POSITION;U.nbVertices=n;U.nbValuesPerVertex=3;U.format=d.DataTypeEnum.FLOAT;U.cardinality=0;U.bufferId=0;U.indices=new d.IndexArray();U.indices.format=d.DataTypeEnum.UINT;U.indices.bufferId=3;U.indices.offset=0;M=new d.VertexComponent();M.component=d.VertexComponentEnum.NORMAL;M.nbVertices=n;M.nbValuesPerVertex=3;M.format=d.DataTypeEnum.FLOAT;M.cardinality=0;M.bufferId=1;M.indices=new d.IndexArray();M.indices.format=d.DataTypeEnum.UINT;M.indices.bufferId=3;M.indices.offset=0;s=new d.VertexComponent();s.component=d.VertexComponentEnum.TEX_COORD_0;s.nbVertices=n;s.nbValuesPerVertex=3;s.format=d.DataTypeEnum.FLOAT;s.cardinality=0;s.bufferId=2;s.indices=new d.IndexArray();s.indices.format=d.DataTypeEnum.UINT;s.indices.bufferId=3;s.indices.offset=0;t.addVertexComponent(U);t.addVertexComponent(M);t.addVertexComponent(s);r.addPrimitive(t);r.noz=T>0;return r},createPoints:function(f,h,j,g){var k=this.createMesh(f,undefined,undefined,undefined,d.ConnectivityTypeEnum.POINTS,h,g,undefined,undefined,undefined,j);k.pointAttr.size=j;k.noz=g>0;return k},createMesh:function(G,h,L,H,z,C,t,k,j,o,v){var I,B,E,w,m,f,u,q,g,A,J,D,F,K,n,l,s,x,r,y;F=new c.Vector3();K=new c.Vector3();this.bufferPosition=G!==undefined?G:[];this.bufferNormal=h!==undefined?h:[];this.bufferUV=L!==undefined?L:[];this.bufferColor=o!==undefined?o:[];this.bufferIndex=H!==undefined?H:[];this.glType=z!==undefined?z:d.ConnectivityTypeEnum.TRIANGLES;I=this.bufferPosition.length;B=this.bufferNormal.length;E=this.bufferUV.length;w=this.bufferColor.length;m=this.bufferIndex.length;f=new d.PrimitiveGroup();f.fillAttr=new d.FillAttributes();f.lineAttr=new d.LineAttributes();f.pointAttr=new d.PointAttributes();q=null;g=null;A=null;u=new d.Buffer();u.size=I;u.component=d.VertexComponentEnum.POSITION;u.format=d.DataTypeEnum.FLOAT;u.dimension=3;u.data=new Float32Array(this.bufferPosition);f.addBuffer(0,u);if(B){q=new d.Buffer();q.size=B;q.component=d.VertexComponentEnum.NORMAL;q.format=d.DataTypeEnum.FLOAT;q.dimension=3;q.data=new Float32Array(this.bufferNormal);f.addBuffer(1,q)}if(E){g=new d.Buffer();g.size=E;g.component=d.VertexComponentEnum.TEX_COORD_0;g.format=d.DataTypeEnum.FLOAT;g.dimension=3;g.data=new Float32Array(this.bufferUV);f.addBuffer(2,g)}if(w){A=new d.Buffer();A.size=w;A.component=d.VertexComponentEnum.DIFFUSE_COLOR;A.format=d.DataTypeEnum.FLOAT;A.dimension=3;A.data=new Float32Array(this.bufferColor);f.addBuffer(4,A)}if(m){J=new d.Buffer();J.indexBuffer=true;J.size=m;J.format=d.DataTypeEnum.UINT;J.dimension=1;if(m>65535){J.data=new Uint32Array(this.bufferIndex)}else{J.data=new Uint16Array(this.bufferIndex)}f.addBuffer(3,J)}if(k){for(D=0;D<I/3;D++){F.x=u.data[D*3];F.y=u.data[D*3+1];F.z=u.data[D*3+2];k.multiplyVector3(F);u.data[D*3]=F.x;u.data[D*3+1]=F.y;u.data[D*3+2]=F.z}for(D=0;D<B/3;D++){K.x=q.data[D*3];K.y=q.data[D*3+1];K.z=q.data[D*3+2];k.multiplyVector3(K);q.data[D*3]=K.x;q.data[D*3+1]=K.y;q.data[D*3+2]=K.z}}n=(C!=="undefined")?C:new d.Color(0.5,0.5,0.5,1);var p=v||1;l=new d.Primitive();l.nbIndices=m?m:I/3;l.connectivity=this.glType;l.attr={fill:new d.FillAttributes(n),line:new d.LineAttributes(n),point:new d.PointAttributes(n,p)};s=new d.VertexComponent();s.component=d.VertexComponentEnum.POSITION;s.nbVertices=I/3;s.nbValuesPerVertex=3;s.format=d.DataTypeEnum.FLOAT;s.cardinality=0;s.bufferId=0;s.indices=null;if(m){s.indices=new d.IndexArray();s.indices.format=d.DataTypeEnum.UINT;s.indices.bufferId=3;s.indices.offset=0}l.addVertexComponent(s);if(B){x=new d.VertexComponent();x.component=d.VertexComponentEnum.NORMAL;x.nbVertices=B/3;x.nbValuesPerVertex=3;x.format=d.DataTypeEnum.FLOAT;x.cardinality=0;x.bufferId=1;x.indices=null;if(m){x.indices=new d.IndexArray();x.indices.format=d.DataTypeEnum.UINT;x.indices.bufferId=3;x.indices.offset=0}l.addVertexComponent(x)}if(E){r=new d.VertexComponent();r.component=d.VertexComponentEnum.TEX_COORD_0;r.nbVertices=E/3;r.nbValuesPerVertex=3;r.format=d.DataTypeEnum.FLOAT;r.cardinality=0;r.bufferId=2;r.indices=null;if(m){r.indices=new d.IndexArray();r.indices.format=d.DataTypeEnum.UINT;r.indices.bufferId=3;r.indices.offset=0}l.addVertexComponent(r)}if(w){y=new d.VertexComponent();y.component=d.VertexComponentEnum.DIFFUSE_COLOR;y.nbVertices=w/3;y.nbValuesPerVertex=3;y.format=d.DataTypeEnum.FLOAT;y.cardinality=0;y.bufferId=4;y.indices=null;if(m){y.indices=new d.IndexArray();y.indices.format=d.DataTypeEnum.UINT;y.indices.bufferId=3;y.indices.offset=0}l.addVertexComponent(y)}f.addPrimitive(l);if(t){t.force=true;f.material=t}f.noz=j>0;return f},createText:function(n,p,g,w,z,f){if(z===undefined){z=32}var j,q,h,t,k,s,u,l,v,m,r,o;j="font-family: "+p+"; font-size: "+z+"px;";q=this._determineTextSize(n,j);h=q.width;t=q.height;k=h/t;s=e;s.width=h;s.height=t;u=s.getContext("2d");l=0;v=0;u.fillStyle="#"+w.getHexString();u.lineWidth=0;u.strokeStyle="#"+w.getHexString();u.font=z+"px "+p;u.textAlign="left";u.textBaseline="top";u.fillText(n,l,v);u.restore();m=h/z;r=this.createRectangle(g*m,g*m/k,true,undefined,undefined,f);var o=undefined;if(s.width!=0||s.height!=0){var y=u.getImageData(0,0,s.width,s.height);var A=new ArrayBuffer(y.data.length);var B=new Uint8Array(A);for(var x=0;x<4*s.width*s.height;++x){B[x]=y.data[x]}o=new c.DataTexture(B,s.width,s.height,c.RGBAFormat,c.UnsignedByteType,new c.UVMapping(),c.ClampToEdgeWrapping,c.ClampToEdgeWrapping,c.LinearFilter,c.LinearMipMapLinearFilter);o.needsUpdate=true}r.material=new c.MeshBasicMaterial({map:o,transparent:true});r.material.force=true;r.noz=f>0;return r},convertFromTHREEMesh:function(y){if(!(y instanceof c.Mesh)){return}var x=true;var V=0.00001;var R=function(j,m,k,l){return(Math.abs(j.x-m[k])<V)&&(Math.abs(j.y-m[k+1])<V)&&((l===2)||(Math.abs(j.z-m[k+2])<V))};var o,ag,af,ad,ac,H,n,Q,aj,ah,r,am,g,q,ak,S,p,T,O,ae,s,D,U,G,X,P,ab,al,I,B,u,v,t,L,w,h={x:0,y:0},o=y.geometry;if(o._type!==0){return}L=[];w=[];v=false;var N=o.faces;var M=o.faceVertexUvs[0];for(ag=0;ag<N.length;ag++){w[ag]={face:N[ag],uv:M?M[ag]:null}}if(y.material instanceof c.MeshFaceMaterial){v=true;w.sort(function(k,j){return k.face.materialIndex-j.face.materialIndex})}H=0;n=0;I=0;al=[];B=0;t=(w.length&&(w[0].face.materialIndex!==undefined))?w[0].face.materialIndex:-1;for(ag=0;ag<w.length;ag++){var W=w[ag].face;if(v&&(t!==W.materialIndex)){al[I]={nbIndices:H,nbVertices:n,start:B,end:ag,material:v?y.material.materials[t]:y.material};I+=1;B=ag;H=0;n=0;t=W.materialIndex}if(W instanceof c.Face3){H+=3;n+=3}else{H+=6;n+=4}}if(H!=0){al[I]={nbIndices:H,nbVertices:n,start:B,end:ag,material:v?y.material.materials[t]:y.material}}g=o.vertices;var C=new Int32Array(g.length);var ai=["a","b","c","d"];for(ac=0;ac<al.length;ac++){var F=al[ac];var A=false;n=F.nbVertices;H=F.nbIndices;Q=new Float32Array(3*n);aj=new Float32Array(3*n);ah=new Float32Array(3*n);r=new Float32Array(3*n);am=new Uint32Array(H);var Y=0;for(ag=0;ag<C.length;ag++){C[ag]=-1}B=F.start;u=F.end;ad=0;if(x){for(ag=B;ag<u;ag++){q=w[ag].face;G=w[ag].uv;S=q.vertexNormals&&q.vertexNormals.length?q.vertexNormals:null;p=q.vertexColors&&q.vertexColors.length?q.vertexColors:null;T=q.normal;O=null;if(!S||!S.length){S=null}if(!p||!p.length){p=null}var f=(q instanceof c.Face4)?4:3;for(af=0;af<f;af++){s=S?S[af]:T;D=p?p[af]:O;X=G?G[af]:h;var J=C[q[ai[af]]];if((J===-1)||!R(s,aj,3*J,3)||!R(X,r,3*J,2)||(D&&!R(D,ah,3*J,3))){C[q[ai[af]]]=Y;ak=g[q[ai[af]]];Q[3*Y]=ak.x;Q[3*Y+1]=ak.y;Q[3*Y+2]=ak.z;aj[3*Y]=s.x;aj[3*Y+1]=s.y;aj[3*Y+2]=s.z;if(D){A=true;ah[3*Y]=D.r;ah[3*Y+1]=D.g;ah[3*Y+2]=D.b}r[3*Y]=X.x;r[3*Y+1]=X.y;r[3*Y+2]=0;if(af===3){am[ad++]=am[ad-4];am[ad++]=am[ad-3]}am[ad++]=Y++}else{if(af===3){am[ad++]=am[ad-4];am[ad++]=am[ad-3]}am[ad++]=J}}}}else{for(ag=B;ag<u;ag++){q=w[ag].face;G=w[ag].uv;S=q.vertexNormals&&q.vertexNormals.length?q.vertexNormals:null;T=q.normal;if(!S||!S.length){S=null}var f=(q instanceof c.Face4)?4:3;for(af=0;af<f;af++){var J=C[q[ai[af]]];if(J===-1){C[q[ai[af]]]=Y;ak=g[q[ai[af]]];s=S?S[af]:T;X=G?G[af]:h;Q[3*Y]=ak.x;Q[3*Y+1]=ak.y;Q[3*Y+2]=ak.z;aj[3*Y]=s.x;aj[3*Y+1]=s.y;aj[3*Y+2]=s.z;r[3*Y]=X.x;r[3*Y+1]=X.y;r[3*Y+2]=0;if(af===3){am[ad++]=am[ad-4];am[ad++]=am[ad-3]}am[ad++]=Y++}else{if(af===3){am[ad++]=am[ad-4];am[ad++]=am[ad-3]}am[ad++]=J}}}}var Z=new Float32Array(3*Y);var z=new Float32Array(3*Y);var K=new Float32Array(3*Y);var E=new Float32Array(3*Y);for(ag=0;ag<3*Y;ag++){Z[ag]=Q[ag];z[ag]=aj[ag];K[ag]=ah[ag];E[ag]=r[ag]}Q=Z;aj=z;ah=A?K:null;r=E;if(A){F.material.vertexColors=c.VertexColors}L[L.length]={bufPos:Q,bufNorm:aj,bufCol:ah,bufUV:r,bufInd:am,connectivity:d.ConnectivityTypeEnum.TRIANGLES,material:F.material}}return this.createPrimGroup(L)},createPrimGroup:function(g){var z,v,s,x,j,f,r,n,m,h,B,w,y,C,l,k,q,t,p,o;f=new d.PrimitiveGroup();f.fillAttr=new d.FillAttributes();f.lineAttr=new d.LineAttributes();f.pointAttr=new d.PointAttributes();for(w=0;w<g.length;w++){var A=!!g[w].bufCol;var u=A?5:4;z=g[w].bufPos.length;v=g[w].bufNorm.length;if(A){s=g[w].bufCol.length}x=g[w].bufUV.length;j=g[w].bufInd.length;r=new d.Buffer();r.size=z;r.component=d.VertexComponentEnum.POSITION;r.format=d.DataTypeEnum.FLOAT;r.dimension=3;r.data=new Float32Array(g[w].bufPos);n=new d.Buffer();n.size=v;n.component=d.VertexComponentEnum.NORMAL;n.format=d.DataTypeEnum.FLOAT;n.dimension=3;n.data=new Float32Array(g[w].bufNorm);if(A){m=new d.Buffer();m.size=s;m.component=d.VertexComponentEnum.DIFFUSE_COLOR;m.format=d.DataTypeEnum.FLOAT;m.dimension=3;m.data=new Float32Array(g[w].bufCol)}h=new d.Buffer();h.size=x;h.component=d.VertexComponentEnum.TEX_COORD_0;h.format=d.DataTypeEnum.FLOAT;h.dimension=3;h.data=new Float32Array(g[w].bufUV);B=new d.Buffer();B.indexBuffer=true;B.size=j;B.format=d.DataTypeEnum.UINT;B.dimension=1;B.data=new Uint32Array(g[w].bufInd);f.addBuffer(w*u,r);f.addBuffer(1+w*u,n);f.addBuffer(2+w*u,h);f.addBuffer(3+w*u,B);if(A){f.addBuffer(4+w*u,m)}}l=new d.Color(0.5,0.5,0.5,1);for(w=0;w<g.length;w++){var A=!!g[w].bufCol;var u=A?5:4;z=g[w].bufPos.length;v=g[w].bufNorm.length;if(A){s=g[w].bufCol.length}x=g[w].bufUV.length;j=g[w].bufInd.length;k=new d.Primitive();k.nbIndices=j;k.connectivity=g[w].connectivity;switch(k.connectivity){case d.ConnectivityTypeEnum.TRIANGLES:case d.ConnectivityTypeEnum.TRIANGLE_FAN:case d.ConnectivityTypeEnum.TRIANGLE_STRIP:k.geomType="FACE";break;case d.ConnectivityTypeEnum.LINES:case d.ConnectivityTypeEnum.LINE_STRIP:case d.ConnectivityTypeEnum.LINE_LOOP:k.geomType="WIRE_EDGE";break;case d.ConnectivityTypeEnum.POINTS:k.geomType="FREE_POINT";break;default:k.geomType=null;break}k.attr={fill:new d.FillAttributes(l),line:new d.LineAttributes(),point:new d.PointAttributes()};q=new d.VertexComponent();q.component=d.VertexComponentEnum.POSITION;q.nbVertices=z/3;q.nbValuesPerVertex=3;q.format=d.DataTypeEnum.FLOAT;q.cardinality=0;q.bufferId=w*u;q.indices=new d.IndexArray();q.indices.format=d.DataTypeEnum.UINT;q.indices.bufferId=3+w*u;q.indices.offset=0;t=new d.VertexComponent();t.component=d.VertexComponentEnum.NORMAL;t.nbVertices=v/3;t.nbValuesPerVertex=3;t.format=d.DataTypeEnum.FLOAT;t.cardinality=0;t.bufferId=1+w*u;t.indices=new d.IndexArray();t.indices.format=d.DataTypeEnum.UINT;t.indices.bufferId=3+w*u;t.indices.offset=0;if(A){p=new d.VertexComponent();p.component=d.VertexComponentEnum.DIFFUSE_COLOR;p.nbVertices=s/3;p.nbValuesPerVertex=3;p.format=d.DataTypeEnum.FLOAT;p.cardinality=0;p.bufferId=4+w*u;p.indices=new d.IndexArray();p.indices.format=d.DataTypeEnum.UINT;p.indices.bufferId=3+w*u;p.indices.offset=0}o=new d.VertexComponent();o.component=d.VertexComponentEnum.TEX_COORD_0;o.nbVertices=x/3;o.nbValuesPerVertex=3;o.format=d.DataTypeEnum.FLOAT;o.cardinality=0;o.bufferId=2+w*u;o.indices=new d.IndexArray();o.indices.format=d.DataTypeEnum.UINT;o.indices.bufferId=3+w*u;o.indices.offset=0;k.addVertexComponent(q);k.addVertexComponent(t);if(A){k.addVertexComponent(p)}k.addVertexComponent(o);k.material=g[w].material;f.addPrimitive(k)}if(g[0]&&g[0].material){f.material=g[0].material}return f},_determineTextSize:function(l,k){var g,j,m,h,f;g=document.getElementsByTagName("body")[0];j=document.createElement("div");j.setAttribute("style",k);m=document.createElement("span");m.setAttribute("style","white-space: nowrap");h=document.createTextNode(l);m.appendChild(h);j.appendChild(m);g.appendChild(j);f={width:0,height:0};f.width=m.offsetWidth;f.height=m.offsetHeight;g.removeChild(j);return f}});return UWA.namespace("THREEDS/GeometryHelper",a)});define("Visualization/GeometryHelper",["DS/Visualization/GeometryHelper","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/GeometryHelper");return b});define("DS/Shaders/VignettingShader",["DS/Visualization/ThreeJS_DS"],function(b){var a={uniforms:{tDiffuse:{type:"t",value:null},offset:{type:"f",value:1},darkness:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform float offset;","uniform float darkness;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","vec2 uv = ( vUv - vec2( 0.5 ) ) * vec2( offset );","gl_FragColor = vec4( mix( texel.rgb, vec3( 1.0 - darkness ), dot( uv, uv ) ), texel.a );","}"].join("\n")};return a});define("Shaders/VignettingShader",["DS/Shaders/VignettingShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/VignettingShader");return b});define("DS/Effects/VignettingEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ShaderPass","DS/Shaders/VignettingShader"],function(d,b,c,a){var e=b.extend({init:function(g,f){this._parent(g);this.mixPass=new c(a,undefined,"VignettingEffect");return this},initEffect:function(f,g){g.insertComposer(null,this.mixPass)},update:function(g,f,h){},setSize:function(h,f){var g=this._parent(h,f);if(!g){return}}});return e});define("Effects/VignettingEffect",["DS/Effects/VignettingEffect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/VignettingEffect");return b});define("DS/Shaders/OITShader",["DS/Visualization/ThreeJS_DS"],function(b){var a={uniforms:{tOpaque:{type:"t",value:null},tAccum:{type:"t",value:null},tReveal:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","   vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tOpaque;","uniform sampler2D tReveal;","uniform sampler2D tAccum;","const float inf = 1e6;","bool isinf(float n){","   return abs(n) == inf;","}","const float threshold = 1e-6;","varying vec2 vUv;","float maxComponent(vec4 iVector) {","   return max(iVector.r,max(iVector.g,max(iVector.b,iVector.a)));","}","void main() {","   vec4 opaque = texture2D(tOpaque, vUv);","   float reveal = texture2D(tReveal, vUv).r;","   if (reveal > 1.0 - threshold) {","       gl_FragColor = opaque;","       return;","   }","   vec4 accum = texture2D(tAccum, vUv);","   if (isinf(maxComponent(abs(accum)))){","       accum.rgb = vec3(max(accum.a,threshold));","   }","   vec3 avgCol = accum.rgb / max(accum.a,threshold);","   gl_FragColor = vec4(avgCol * (1.0 - reveal) + reveal * opaque.rgb,1.0);","}"].join("\n")};return a});define("Shaders/OITShader",["DS/Shaders/OITShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/OITShader");return b});define("DS/Effects/OITEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ComposerContext","DS/Plugins/EffectComposer","DS/Plugins/ClearPass","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/OITShader"],function(h,d,g,f,e,a,b,c){var j=d.extend({init:function(o,n,k){this._parent(o);this.stateSortingResult=k;var m=n.buildRenderTarget(this.width,this.height,"linear",null,null,true);m.generateMipmaps=false;var l=n.buildRenderTarget(this.width,this.height,"linear",null,null,true);l.generateMipmaps=false;this.composerAccum=new f(o,m,n);this.composerAccum.needsCameraUpdate=true;this.composerAccum.targetUniform="tAccum";this.composers.push(this.composerAccum);this.composerReveal=new f(o,l,n);this.composerReveal.needsCameraUpdate=true;this.composerReveal.targetUniform="tReveal";this.composers.push(this.composerReveal);this.composerAccum.bShareDepth=true;this.composerAccum.composerContext.keepResult=true;this.composerReveal.bShareDepth=true;this.composerReveal.composerContext.keepResult=true;this.mixPass=new b(c,"tOpaque","oitPass");this.mixPass.compileShader(o);this.clearAccumPass=null;this.accumPass=null;this.clearRevealPass=null;this.revealPass=null;return this},initEffect:function(l,m){var k=["SOLID","SURFACE","EDGE","POINT","NOZ","NOZTRANSPAR"];this.clearAccumPass=new e("clear_accum_oit");this.clearAccumPass.clearColor=new h.Color(0);this.clearAccumPass.clearbColor=true;this.clearAccumPass.clear=false;this.clearAccumPass.defaults.clear=false;this.clearAccumPass.clearAlpha=0;this.clearAccumPass.disabledByDefault=true;this.accumPass=new a(m.scene,null,null,null,null,null,"oit_accum_pass");this.accumPass.setStateSortingResult(this.stateSortingResult,false);this.accumPass.isOITPass=true;this.accumPass.setMaterialToUse(h.MaterialToUse.oitAccumMaterial);this.accumPass.setDLsToDisable(k);this.accumPass.disabledByDefault=true;this.accumPass.setDisableBackFaceCulling(false);this.accumPass.setDisableDepthWrite(true);this.composerAccum.addPass(this.clearAccumPass);this.composerAccum.addPass(this.accumPass);this.composerAccum.enablePass(this.clearAccumPass,true);this.composerAccum.enablePass(this.accumPass,true);this.clearRevealPass=new e("clear_reveal_oit");this.clearRevealPass.clearColor=new h.Color(16711680);this.clearRevealPass.clear=false;this.clearRevealPass.clearbColor=true;this.clearRevealPass.defaults.clear=false;this.clearRevealPass.clearAlpha=0;this.clearRevealPass.disabledByDefault=true;this.revealPass=new a(m.scene,null,null,null,null,null,"oit_reveal_pass");this.revealPass.setStateSortingResult(this.stateSortingResult,false);this.revealPass.setMaterialToUse(h.MaterialToUse.oitRevealMaterial);this.revealPass.isOITPass=true;this.revealPass.setDLsToDisable(k);this.revealPass.disabledByDefault=true;this.revealPass.setDisableBackFaceCulling(false);this.revealPass.setDisableDepthWrite(true);this.composerReveal.addPass(this.clearRevealPass);this.composerReveal.addPass(this.revealPass);this.composerReveal.enablePass(this.clearRevealPass,true);this.composerReveal.enablePass(this.revealPass,true);this.mixPass.addRequiredComposer(this.composerAccum);this.mixPass.addRequiredComposer(this.composerReveal);m.insertComposer(null,this.mixPass)},update:function(l,k,m){},setSize:function(n,k){var m=this._parent(n,k);if(!m){return}for(var l=0;l<this.composers.length;l++){this.composers[l].setSize(n,k)}},});return j});define("Effects/OITEffect",["DS/Effects/OITEffect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/OITEffect");return b});define("DS/Gestures/PinchPanRotateGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,a,d){var b=d.extend({init:function(){this._parent("PinchPanRotate");this.priority=10;this.touches=[];this.fingersVector=new c.Vector2();this.distance=null;this.lastDistance=0;this.orientation=null;this.lastOrientation=0;this.deltaOrientation=0;return this},detect:function(g){this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([a.State.BEGIN,a.State.MOVE,a.State.IDLE,a.State.END],this.view);if(this.touches.length===2){this.fingersVector.subVectors(this.touches[1].getCurrentPosition(this.view),this.touches[0].getCurrentPosition(this.view));if(this.distance===null){this.distance=this.fingersVector.length()}if(this.orientation===null){this.orientation=Math.atan2(this.fingersVector.y,this.fingersVector.x)}this.lastDistance=this.distance;this.distance=this.fingersVector.length();this.lastOrientation=this.orientation;this.orientation=Math.atan2(this.fingersVector.y,this.fingersVector.x);this.deltaOrientation=this.orientation-this.lastOrientation;var h=(this.deltaOrientation>=0)?1:-1;h*=2*Math.PI;if(Math.abs(this.deltaOrientation-h)<Math.abs(this.deltaOrientation)){this.deltaOrientation-=h}}switch(this.state){case d.State.INIT:this.distance=null;this.orientation=null;if(this.touches.length>0){this.changeState(d.State.BEGIN)}break;case d.State.BEGIN:if(this.touches.length===2){var e=g[0].getJSEvent();if(e.preventDefault){e.preventDefault()}this.events=this.touches;this.changeState(d.State.CHANGE)}break;case d.State.CHANGE:if(this.touches.length===2){var e=g[0].getJSEvent();if(e.preventDefault){e.preventDefault()}var f=(this.touches[0].getState()===a.State.END)||(this.touches[1].getState()===a.State.END);this.events=this.touches;this.changeState(d.State.CHANGE,f)}else{this.changeState(d.State.KO)}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);this.touches=[];this.distance=null;this.orientation=null;break;default:break}},getAngle:function(){return(this.orientation||0)},getDeltaAngle:function(){return this.deltaOrientation}});return UWA.namespace("THREEDS/Gestures/PinchPanRotateGesture",b)});define("Gestures/PinchPanRotateGesture",["DS/Gestures/PinchPanRotateGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/PinchPanRotateGesture");return b});define("DS/Shaders/MirrorShaders",["DS/Visualization/ThreeJS_DS"],function(c){var b={uniforms:{tDiffuse:{type:"t",value:null},texelSize:{type:"v2",value:new c.Vector2()},},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",c._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tDiffuse;","uniform vec2 texelSize;","vec4 blur(){","vec4 sum = vec4(0);","int nbSamples = 0;","float pixelSizeX = 1.0 / texelSize.x;","float pixelSizeY = 1.0 / texelSize.y;","for( int i = -10; i < 10; i+=2 ){","for( int j = -10; j < 10; j+=2 ){","sum += texture2D( tDiffuse, vUv + vec2(float(i)*pixelSizeX,float(j)*pixelSizeY) );","nbSamples++;","}","}","return sum / float(nbSamples);","}","void main() {","gl_FragColor = blur();","} "].join("\n")};var a={uniforms:{tReflectedScene:{type:"t",value:null},tDiffuse:{type:"t",value:null},reflectivity:{type:"f",value:0.3},},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",c._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tDiffuse;","uniform sampler2D tReflectedScene;","uniform float reflectivity;","void main() {","vec4 mirrorPlane    = texture2D(tDiffuse, vUv);","vec4 reflectedScene = texture2D(tReflectedScene, vUv);","float blend = 1.0 - reflectivity;","vec3 mirrorMix = (1.0 - blend) * reflectedScene.xyz + blend * mirrorPlane.xyz;","gl_FragColor = vec4(mirrorMix * reflectedScene.w + mirrorPlane.xyz * (1.0 - reflectedScene.w), mirrorPlane.w);","} "].join("\n")};return{blend:a,reflectedScene:b,}});define("Shaders/MirrorShaders",["DS/Shaders/MirrorShaders","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/MirrorShaders");return b});define("DS/Shaders/StereoShaders",["DS/Visualization/ThreeJS_DS"],function(d){var e={uniforms:{tLeftEye:{type:"t",value:null},tRightEye:{type:"t",value:null},tDiffuse:{type:"t",value:null},},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tDiffuse;","uniform sampler2D tLeftEye;","uniform sampler2D tRightEye;","void main() {","if(vUv.x < 0.5) {","gl_FragColor = texture2D(tLeftEye, vec2(vUv.x*2.0, vUv.y));","} else {","gl_FragColor = texture2D(tRightEye, vec2((vUv.x-0.5)*2.0, vUv.y));","}","} "].join("\n")};var c={uniforms:{tLeftEye:{type:"t",value:null},tRightEye:{type:"t",value:null},tDiffuse:{type:"t",value:null},},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tDiffuse;","uniform sampler2D tLeftEye;","uniform sampler2D tRightEye;","void main() {","vec4 cr = texture2D(tLeftEye, vUv);","vec4 cl = texture2D(tRightEye, vUv);","gl_FragColor = vec4(cl.r, cr.g, cr.b, 1.0);","} "].join("\n")};var b={uniforms:{tLeftEye:{type:"t",value:null},tRightEye:{type:"t",value:null},tDiffuse:{type:"t",value:null},scale:{type:"v2",value:new d.Vector2(1,1)},scaleIn:{type:"v2",value:new d.Vector2(1,1)},leftLensCenter:{type:"v2",value:new d.Vector2(0,0)},hmdWarpParam:{type:"v4",value:new d.Vector4(1,0,0,0)},chromAbParam:{type:"v4",value:new d.Vector4(1,0,0,0)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tDiffuse;","uniform sampler2D tLeftEye;","uniform sampler2D tRightEye;","uniform vec2 scale;","uniform vec2 scaleIn;","uniform vec2 leftLensCenter;","uniform vec4 hmdWarpParam;","uniform vec4 chromAbParam;","void main() {","  if(vUv.x >= 0.5) {","    vec2 lensCenter = leftLensCenter;","    vec2 uv = (vec2((vUv.x-0.5)*2.0, vUv.y)*2.0)-1.0;","    vec2 theta = (uv-lensCenter)*scaleIn;","    float rSq = theta.x*theta.x + theta.y*theta.y;","    vec2 rvector = theta*(hmdWarpParam.x + hmdWarpParam.y*rSq + hmdWarpParam.z*rSq*rSq + hmdWarpParam.w*rSq*rSq*rSq);","    vec2 rBlue = rvector * (chromAbParam.z + chromAbParam.w * rSq);","    vec2 tcBlue = (lensCenter + scale * rBlue);","    tcBlue = (tcBlue+1.0)/2.0;","    if (any(bvec2(clamp(tcBlue, vec2(0.0,0.0), vec2(1.0,1.0))-tcBlue))) {","      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);","      return;}","    vec2 tcGreen = lensCenter + scale * rvector;","    tcGreen = (tcGreen+1.0)/2.0;","    vec2 rRed = rvector * (chromAbParam.x + chromAbParam.y * rSq);","    vec2 tcRed = lensCenter + scale * rRed;","    tcRed = (tcRed+1.0)/2.0;","    gl_FragColor = vec4(texture2D(tLeftEye, tcRed).r, texture2D(tLeftEye, tcGreen).g, texture2D(tLeftEye, tcBlue).b, 1.0);","  } else {","    vec2 lensCenter = -leftLensCenter;","    vec2 uv = (vec2(vUv.x*2.0, vUv.y)*2.0)-1.0;","    vec2 theta = (uv-lensCenter)*scaleIn;","    float rSq = theta.x*theta.x + theta.y*theta.y;","    vec2 rvector = theta*(hmdWarpParam.x + hmdWarpParam.y*rSq + hmdWarpParam.z*rSq*rSq + hmdWarpParam.w*rSq*rSq*rSq);","    vec2 rBlue = rvector * (chromAbParam.z + chromAbParam.w * rSq);","    vec2 tcBlue = (lensCenter + scale * rBlue);","    tcBlue = (tcBlue+1.0)/2.0;","    if (any(bvec2(clamp(tcBlue, vec2(0.0,0.0), vec2(1.0,1.0))-tcBlue))) {","      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);","      return;}","    vec2 tcGreen = lensCenter + scale * rvector;","    tcGreen = (tcGreen+1.0)/2.0;","    vec2 rRed = rvector * (chromAbParam.x + chromAbParam.y * rSq);","    vec2 tcRed = lensCenter + scale * rRed;","    tcRed = (tcRed+1.0)/2.0;","    gl_FragColor = vec4(texture2D(tRightEye, tcRed).r, texture2D(tRightEye, tcGreen).g, texture2D(tRightEye, tcBlue).b, 1.0);","  }","} "].join("\n")};var a={uniforms:{tEye:{type:"t",value:null},tDiffuse:{type:"t",value:null},eyeToSourceUVScale:{type:"v2",value:new d.Vector2(0.33333333,0.3333333)},eyeToSourceUVOffset:{type:"v2",value:new d.Vector2(0.5,0.5)}},vertexShader:["varying vec2 uvr;","varying vec2 uvg;","varying vec2 uvb;","uniform vec2 eyeToSourceUVScale;","uniform vec2 eyeToSourceUVOffset;","void main() {","uvr = uv.xy * eyeToSourceUVScale + eyeToSourceUVOffset;","uvg = uv2.xy * eyeToSourceUVScale + eyeToSourceUVOffset;","uvb = tangent.xy * eyeToSourceUVScale + eyeToSourceUVOffset;","uvr.y = 1.0 - uvr.y;","uvg.y = 1.0 - uvg.y;","uvb.y = 1.0 - uvb.y;",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 uvr;","varying vec2 uvg;","varying vec2 uvb;","uniform sampler2D tDiffuse;","uniform sampler2D tEye;","void main() {","gl_FragColor = vec4(texture2D(tEye, uvr).r, texture2D(tEye, uvg).g, texture2D(tEye, uvb).b, 1.0);","} "].join("\n")};return{leftRight:e,anaglyph:c,oculusDK1:b,oculusDK2:a}});define("Shaders/MirrorShaders",["DS/Shaders/MirrorShaders","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/MirrorShaders");return b});define("DS/Visualization/CameraSystem",["UWA/Class","DS/Shaders/StereoShaders","DS/Plugins/ShaderPass","DS/Plugins/RenderPass","DS/Visualization/ThreeJS_DS","DS/Plugins/ClearPass"],function(c,d,f,b,e,h){var g=c.extend({init:function(){this._computeCameraArrayCB=null;this._predefinedCombineShader=null;this._shaderParameters=null},setComputeCameraArrayCB:function(k,j){this._computeCameraArrayCB=k;this.useExternalProjectionMatrix=j?true:false},setUsePredefinedCombineShader:function(k,l){this._predefinedCombineShader=k;this._shaderParameters=l;var j=a[this._predefinedCombineShader];if(j.warmup){j.warmup()}},getViewportSize:function(k,j){return a[this._predefinedCombineShader].getViewportSize.apply(this,arguments)},computeCameraArray:function(n,m,k){var j=this._computeCameraArrayCB(n,m,k);var l;for(l=0;j&&l<j.length;l++){j[l].updateProjectionMatrix();j[l].projectionMatrixInverse.getInverse(j[l].projectionMatrix)}return j},getUniformName:function(j){return a[this._predefinedCombineShader].uniformsName[j]},applyShaderParameters:function(j){if(j&&this._shaderParameters){var k;for(k in this._shaderParameters){j[k].value=this._shaderParameters[k]}}},isReady:function(){var j=a[this._predefinedCombineShader];return j.type==="ShaderPass"||j.ready},createPasses:function(j){var k=a[this._predefinedCombineShader];if(k.type==="ShaderPass"){this.stereoPass=new f(k.combineShader,undefined,"stereoPass");j.composerContext.setPassRenderToCanvas(this.stereoPass,true)}else{if(k.type==="RenderPass"){this.clearPass=new h("combineClearPass");j.addPass(this.clearPass);j.composerContext.setPassRenderToCanvas(this.clearPass,true);this.stereoPass=new b(null,null,null,null,null,null,"combineStereoPass");this.stereoPass.setDepthFunc("ALWAYS");this.stereoPass.setDisableBackFaceCulling(true);this.stereoScene=new e.Scene();this.stereoScene.renderResultIndices={};k.fillScene(this.stereoScene);this.stereoPass.scene=this.stereoScene;j.composerContext.setPassClear(this.clearPass,true,new e.Color(0),1);j.composerContext.setPassRenderToCanvas(this.stereoPass,true)}}j.addPass(this.stereoPass)},updatePasses:function(j,p,l){var n;var o=a[this._predefinedCombineShader];if(o.type==="ShaderPass"){for(n=0;n<j.length;n++){var k=this.getUniformName(n);this.stereoPass.uniforms[k].value=l[j[n]]}this.applyShaderParameters(this.stereoPass.uniforms)}else{if(o.type==="RenderPass"){var q=this.stereoPass.scene;for(n=0;n<q.myMeshes.length;n++){q.myMeshes[n].material.uniforms.tEye.value=l[j[q.renderResultIndices[q.myMeshes[n].id]]];var m;for(m in o.parameters[n]){q.myMeshes[n].material.uniforms[m].value=o.parameters[n][m]}if(this._shaderParameters){for(m in this._shaderParameters[n]){q.myMeshes[n].material.uniforms[m].value=this._shaderParameters[n][m]}}}}}this.stereoPass.renderToScreen=p},isStereo:function(){return true}});var a={leftRight:{getViewportSize:function(k,j){return{width:Math.floor(k/2),height:j}},combineShader:d.leftRight,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},oculusDK1:{getViewportSize:function(k,j){return{width:Math.floor(k/2),height:j}},combineShader:d.oculusDK1,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},anaglyph:{getViewportSize:function(k,j){return{width:k,height:j}},combineShader:d.anaglyph,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},oculusDK2:{getViewportSize:function(k,j){return{width:Math.floor(k/2),height:j}},ready:false,warmup:function(){require(["DS/OculusDK2/OculusDK2DeformationMeshCreator"],function(j){a.oculusDK2.ready=true;a.oculusDK2.OculusDK2DeformationMeshCreator=j})},fillScene:function(l){var k=a.oculusDK2;k.uniforms=e.UniformsUtils.clone(d.oculusDK2.uniforms);var j=new e.ShaderMaterial({uniforms:k.uniforms,vertexShader:d.oculusDK2.vertexShader,fragmentShader:d.oculusDK2.fragmentShader});k.OculusDK2DeformationMeshCreator.fillScene(l,j)},parameters:[{eyeToSourceUVScale:new e.Vector2(2*0.232447237,0.376141697),eyeToSourceUVOffset:new e.Vector2(2*0.246082067,0.5)},{eyeToSourceUVScale:new e.Vector2(2*0.232447237,0.376141697),eyeToSourceUVOffset:new e.Vector2(2*(0.753917933-0.5),0.5)}],type:"RenderPass"}};return g});define("DS/Shaders/SMAAShader",["DS/Visualization/ThreeJS_DS"],function(d){var b={uniforms:{tDiffuse:{type:"t",value:null},screenWidth:{type:"f",value:800},screenHeight:{type:"f",value:600}},vertexShader:["varying vec2 vUv;","varying vec4 offset[3];","uniform float screenHeight;","uniform float screenWidth;","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth,1.0/screenHeight);","void main() {","    vUv = uv;","    offset[0] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4(-1.0, 0.0, 0.0, 1.0);","    offset[1] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4( 1.0, 0.0, 0.0, -1.0);","    offset[2] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4(-2.0, 0.0, 0.0, -2.0);",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","varying vec4 offset[3];","float SMAA_THRESHOLD = 0.1;","void main() {","   vec2 threshold = vec2(SMAA_THRESHOLD, SMAA_THRESHOLD);","   vec3 weights   = vec3(0.2126,0.7152,0.0722);","   float L        = dot(texture2D(tDiffuse, vUv.xy).rgb, weights);","   float Lleft    = dot(texture2D(tDiffuse, offset[0].xy).rgb, weights);","   float Ltop     = dot(texture2D(tDiffuse, offset[0].zw).rgb, weights);","   vec4 delta;","   delta.xy   = abs(L - vec2(Lleft, Ltop));","   vec2 edges = step(threshold, delta.xy);","   float Lright   = dot(texture2D(tDiffuse, offset[1].xy).rgb, weights);","   float Lbottom  = dot(texture2D(tDiffuse, offset[1].zw).rgb, weights);","   delta.zw = abs(L - vec2(Lright, Lbottom));","   vec2 maxDelta  = max(delta.xy, delta.zw);","   maxDelta       = max(maxDelta.xx, maxDelta.yy);","   float Lleftleft = dot(texture2D(tDiffuse, offset[2].xy).rgb, weights);","   float Ltoptop   = dot(texture2D(tDiffuse, offset[2].zw).rgb, weights);","   delta.zw        = abs(vec2(Lleft, Ltop) - vec2(Lleftleft, Ltoptop));","   maxDelta = max(maxDelta.xy, delta.zw);","   edges.xy *= step(0.5 * maxDelta, delta.xy);","   gl_FragColor = vec4(edges, 0.0, 1.0);","}"].join("\n")};var c={uniforms:{tDiffuse:{type:"t",value:null},areaTex:{type:"t",value:null},searchTex:{type:"t",value:null},screenWidth:{type:"f",value:800},screenHeight:{type:"f",value:600}},vertexShader:["varying vec2 vUv;","varying vec4 offset[3];","uniform float screenHeight;","uniform float screenWidth;","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","const int SMAA_MAX_SEARCH_STEPS = 8;","void main() {","   vUv = uv;","   offset[0] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4(-0.25, 0.125,  1.25, 0.125);","   offset[1] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4(-0.125, 0.25, -0.125,  -1.25);","   offset[2] = vec4(offset[0].xz, offset[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * SMAA_PIXEL_SIZE.xxyy * float(SMAA_MAX_SEARCH_STEPS);",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D searchTex;","uniform sampler2D areaTex;","uniform float screenHeight;","uniform float screenWidth;","varying vec2 vUv;","varying vec4 offset[3];","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","const int   SMAA_FORCE_DIAGONAL_DETECTION  = 1;","const int   SMAA_FORCE_CORNER_DETECTION    = 1;","const int   SMAA_AREATEX_MAX_DISTANCE      = 16;","const int   SMAA_AREATEX_MAX_DISTANCE_DIAG = 20;","const float SMAA_AREATEX_SUBTEX_SIZE       = 1.0 / 7.0;","const vec2  SMAA_AREATEX_PIXEL_SIZE        = vec2(1.0 / 160.0, 1.0/ 560.0);","const float  SMAA_THRESHOLD              = 0.1;","const int    SMAA_MAX_SEARCH_STEPS       = 16;","const int    SMAA_MAX_SEARCH_STEPS_DIAG  = 8;","const int    SMAA_CORNER_ROUNDING        = 25;","float SMAASearchLength(vec2 e, float bias, float scale) {","   e.r = bias + e.r * scale;","   return  255.0*texture2D(searchTex, vec2(e.x,1.0-e.y)).r;","}","float SMAASearchXLeft() {","   vec2 texCoord = vUv + SMAA_PIXEL_SIZE * vec2(-0.25, 0.125);","   float end = (vUv.x - 0.25 * SMAA_PIXEL_SIZE.x) - 2.0 * SMAA_PIXEL_SIZE.x * float(SMAA_MAX_SEARCH_STEPS);","   vec2 e = vec2(0.0, 1.0);","   for(int i = 0;i<SMAA_MAX_SEARCH_STEPS;i++){","       if((texCoord.x > end) && (e.g > 0.8281) && (e.r == 0.0)){","           e = texture2D(tDiffuse, texCoord).rg;","           texCoord.x -= 2.0 * SMAA_PIXEL_SIZE.x;","       }else","           break;","   }","   texCoord.x += 0.25 * SMAA_PIXEL_SIZE.x;","   texCoord.x += SMAA_PIXEL_SIZE.x;","   texCoord.x += 2.0 * SMAA_PIXEL_SIZE.x;","   texCoord.x -= SMAA_PIXEL_SIZE.x * SMAASearchLength(e, 0.0, 0.5);","   return texCoord.x  ;","}","float SMAASearchXRight() {","   vec2 texcoord = vUv + SMAA_PIXEL_SIZE * vec2(1.25, 0.125);","   float end = (vUv.x + 1.25 * SMAA_PIXEL_SIZE.x) + 2.0 * SMAA_PIXEL_SIZE.x * float(SMAA_MAX_SEARCH_STEPS);","   vec2 e = vec2(0.0, 1.0);","   for(int i = 0;i<SMAA_MAX_SEARCH_STEPS;i++){","       if((texcoord.x < end) && (e.g > 0.8281) && (e.r == 0.0)){","           e = texture2D(tDiffuse, texcoord).rg;","           texcoord += vec2(2.0, 0.0) * SMAA_PIXEL_SIZE;","       }else","           break;","   }","   texcoord.x -= 0.25 * SMAA_PIXEL_SIZE.x;","   texcoord.x -= SMAA_PIXEL_SIZE.x;","   texcoord.x -= 2.0 * SMAA_PIXEL_SIZE.x;","   texcoord.x += SMAA_PIXEL_SIZE.x * SMAASearchLength(e, 0.5, 0.5);","   return texcoord.x;","}","float SMAASearchYDown() {","   vec2 texcoord = vUv + SMAA_PIXEL_SIZE * vec2(-0.125, -1.25);","   float end = (vUv.y - 1.25 * SMAA_PIXEL_SIZE.y) - 2.0 * SMAA_PIXEL_SIZE.y * float(SMAA_MAX_SEARCH_STEPS);","   vec2 e = vec2(1.0, 0.0);","   for(int i = 0;i<SMAA_MAX_SEARCH_STEPS;i++){","       if((texcoord.y > end) && (e.r > 0.8281) && (e.g == 0.0)){","           e = texture2D(tDiffuse, texcoord).rg;","           texcoord -= vec2(0.0, 2.0) * SMAA_PIXEL_SIZE;","       }else","           break;","   }","   texcoord.y += 0.25 * SMAA_PIXEL_SIZE.y;","   texcoord.y += SMAA_PIXEL_SIZE.y;","   texcoord.y -= SMAA_PIXEL_SIZE.y * SMAASearchLength(e.gr ,0.5, 0.5);","   return texcoord.y ;","}","float SMAASearchYUp() {","   vec2 texcoord = vUv + SMAA_PIXEL_SIZE * vec2(-0.125, 0.25);","   float end = (vUv.y + 0.25 * SMAA_PIXEL_SIZE.y) + 2.0 * SMAA_PIXEL_SIZE.y * float(SMAA_MAX_SEARCH_STEPS);","   vec2 e = vec2(1.0, 0.0);","   for(int i = 0;i<SMAA_MAX_SEARCH_STEPS;i++){","       if((texcoord.y < end) && (e.r > 0.8281) && (e.g == 0.0)){","           e = texture2D(tDiffuse, texcoord).rg;","           texcoord += vec2(0.0, 2.0) * SMAA_PIXEL_SIZE;","       }else","           break;","   }","   texcoord.y -= 0.25 * SMAA_PIXEL_SIZE.y;","   texcoord.y -= SMAA_PIXEL_SIZE.y;","   texcoord.y -= 2.0 * SMAA_PIXEL_SIZE.y;","   texcoord.y += SMAA_PIXEL_SIZE.y * SMAASearchLength(e.gr, 0.0, 0.5);","   return texcoord.y ;","}","vec2 round(vec2 invec) {","   return vec2(floor(abs(invec) + vec2(0.5)) * sign(invec));","}","vec2 SMAAArea(vec2 dist, float e1, float e2, float offset) {","   vec2 texcoord = float(SMAA_AREATEX_MAX_DISTANCE) * round(4.0 * vec2(e1, e2)) + dist  ;","   texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + (0.5 * SMAA_AREATEX_PIXEL_SIZE);","   return texture2D(areaTex, vec2(texcoord.x,1.0-texcoord.y)).rg;","}","void SMAADetectHorizontalCornerPattern(vec2 weights, vec2 texcoord, vec2 d) {","   if (SMAA_CORNER_ROUNDING < 100 || SMAA_FORCE_CORNER_DETECTION == 1 ){","       vec4 coords = vec4(d.x, 0.0, d.y, 0.0)*SMAA_PIXEL_SIZE.xyxy+ texcoord.xyxy;","       vec2 e;","       e.r = texture2D(tDiffuse, (coords.xy + vec2(0.0,  -1.0))).r;","       bool left = abs(d.x) < abs(d.y);","       e.g = texture2D(tDiffuse, (coords.xy + vec2(0.0, 2.0))).r;","       if (left) weights *= clamp(float(SMAA_CORNER_ROUNDING) / 100.0 + 1.0 - e,0.0,1.0);","       e.r = texture2D(tDiffuse, (coords.zw + vec2(1.0,  -1.0))).r;","       e.g = texture2D(tDiffuse, (coords.zw + vec2(1.0, 2.0))).r;","       if (!left) weights *= clamp(float(SMAA_CORNER_ROUNDING) / 100.0 + 1.0 - e,0.0,1.0);","   }","}","void SMAADetectVerticalCornerPattern(vec2 weights, vec2 texcoord, vec2 d) {","   if (SMAA_CORNER_ROUNDING < 100 || SMAA_FORCE_CORNER_DETECTION == 1){","       vec4 coords = vec4(0.0, d.x, 0.0, d.y)*SMAA_PIXEL_SIZE.xyxy + texcoord.xyxy;","       vec2 e;","       e.r = texture2D(tDiffuse, (coords.xy + vec2( 1.0, 0.0))).g;","       bool left = abs(d.x) < abs(d.y);","       e.g = texture2D(tDiffuse, (coords.xy + vec2(-2.0, 0.0))).g;","       if (left) weights *= clamp(float(SMAA_CORNER_ROUNDING) / 100.0 + 1.0 - e,0.0,1.0);","       e.r = texture2D(tDiffuse, (coords.zw + vec2( 1.0, -1.0))).g;","       e.g = texture2D(tDiffuse, (coords.zw + vec2(-2.0, -1.0))).g;","       if (!left) weights *= clamp(float(SMAA_CORNER_ROUNDING) / 100.0 + 1.0 - e,0.0,1.0);","	}","}","vec2 SMAAAreaDiag(vec2 dist, vec2 e) {","   vec2 texcoord = float(SMAA_AREATEX_MAX_DISTANCE_DIAG) * e + dist;","   texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + (0.5 * SMAA_AREATEX_PIXEL_SIZE);","   texcoord.x += 0.5;","   return texture2D(areaTex, vec2(texcoord.x,1.0-texcoord.y)).rg;","}","float SMAASearchDiag1(vec2 texcoord, vec2 dir, float c) {","   texcoord += dir * SMAA_PIXEL_SIZE;","   vec2 e = vec2(0.0, 0.0);","   int j;","   for (int i = 0; i < SMAA_MAX_SEARCH_STEPS_DIAG; i++) {","       j = i;","       e.rg = texture2D(tDiffuse, texcoord).rg;","       if (dot(e, vec2(1.0, 1.0)) < 1.9) break;","       texcoord += dir * SMAA_PIXEL_SIZE;","   }","   return float(j) + float(e.g > 0.9) * c;","}","float SMAASearchDiag2(vec2 texcoord, vec2 dir, float c) {","   texcoord += dir * SMAA_PIXEL_SIZE;","   vec2 e = vec2(0.0, 0.0);","   int j;","   for (int i = 0; i < SMAA_MAX_SEARCH_STEPS_DIAG; i++) {","       j = i;","       e.g = texture2D(tDiffuse, texcoord).g;","       e.r = texture2D(tDiffuse, (texcoord + (vec2(1.0, 0.0)* SMAA_PIXEL_SIZE))).r;","       if (dot(e, vec2(1.0, 1.0)) < 1.9) break;","       texcoord += dir * SMAA_PIXEL_SIZE;","   }","   return float(j) + float(e.g > 0.9) * c;","}","vec2 SMAACalculateDiagWeights(vec2 texcoord, vec2 e, ivec4 subsampleIndices) {","   vec2 weights = vec2(0.0, 0.0);","   vec2 d;","   d.x = e.r > 0.0? SMAASearchDiag1(texcoord, vec2(-1.0,  -1.0), 1.0) : 0.0;","   d.y = SMAASearchDiag1(texcoord, vec2(1.0, 1.0), 0.0);","   if (d.r + d.g > 2.0) {","       vec4 coords = vec4(-d.r, -d.r, d.g, d.g) * SMAA_PIXEL_SIZE.xyxy + texcoord.xyxy;","       vec4 c;","       c.x = texture2D(tDiffuse, (coords.xy + vec2( -1.0, 0.0 )* SMAA_PIXEL_SIZE)).g;","       c.y = texture2D(tDiffuse, (coords.xy + vec2( 0.0,  0.0 )* SMAA_PIXEL_SIZE)).r;","       c.z = texture2D(tDiffuse, (coords.zw + vec2( 1.0,  0.0 )* SMAA_PIXEL_SIZE)).g;","       c.w = texture2D(tDiffuse, (coords.zw + vec2( 1.0, 1.0 )* SMAA_PIXEL_SIZE)).r;","       vec2 e = 2.0 * c.xz + c.yw;","       float t = float(SMAA_MAX_SEARCH_STEPS_DIAG) - 1.0;","       e *= step(d.rg, vec2(t, t));","       weights += SMAAAreaDiag(d, e);","   }","   d.x = SMAASearchDiag2(texcoord, vec2(-1.0, 1.0), 0.0);","   float right = texture2D(tDiffuse, (texcoord + vec2(1.0, 0.0)* SMAA_PIXEL_SIZE)).r;","   d.y = right > 0.0? SMAASearchDiag2(texcoord, vec2(1.0, -1.0), 1.0) : 0.0;","   if (d.r + d.g > 2.0) { ","       vec4 coords = vec4(-d.r, d.r, d.g, -d.g)* SMAA_PIXEL_SIZE.xyxy+ texcoord.xyxy;","       vec4 c;","       c.x  = texture2D(tDiffuse, (coords.xy + vec2(-1.0,  0.0)* SMAA_PIXEL_SIZE)).g;","       c.y  = texture2D(tDiffuse, (coords.xy + vec2( 0.0, 1.0)* SMAA_PIXEL_SIZE)).r;","       c.zw = texture2D(tDiffuse, (coords.zw + vec2( 1.0,  0.0)* SMAA_PIXEL_SIZE)).gr;","       vec2 e = 2.0 * c.xz + c.yw;","       float t = float(SMAA_MAX_SEARCH_STEPS_DIAG) - 1.0;","       e *= step(d.rg, vec2(t, t));","       weights += SMAAAreaDiag(d, e).gr;","   }","   return weights;","}","void main() {","	vec2 pixcoord = vUv / SMAA_PIXEL_SIZE;","   vec4 weights = vec4(0.0, 0.0, 0.0, 0.0);","   vec2 e = texture2D(tDiffuse, vUv).rg;","   if (e.g > 0.0) {","       if (SMAA_MAX_SEARCH_STEPS_DIAG > 0 || SMAA_FORCE_DIAGONAL_DETECTION == 1)","       weights.rg = SMAACalculateDiagWeights(vUv, e, ivec4(0));","       if (dot(weights.rg, vec2(1.0, 1.0)) == 0.0) {","           vec2 d;","           vec2 coords;","           coords.x = SMAASearchXLeft();","           coords.y = vUv.y + 0.25 * SMAA_PIXEL_SIZE.y ;","           d.x = coords.x;","           float e1 = texture2D(tDiffuse, coords).r;","           coords.x = SMAASearchXRight();","           d.y = coords.x;","           d =  (d / SMAA_PIXEL_SIZE.x) - pixcoord.x ;","           vec2 sqrt_d = sqrt(abs(d));","           float e2 = texture2D(tDiffuse, (coords + vec2(1.0, 0.0)* SMAA_PIXEL_SIZE)).r;","           weights.rg = SMAAArea(sqrt_d, e1, e2, 0.0);","           SMAADetectHorizontalCornerPattern(weights.rg, vUv, d);","       } else","           e.r = 0.0;","   }","   if (e.r > 0.0) {","       vec2 d;","       vec2 coords;","       coords.y = SMAASearchYUp();","       coords.x = offset[0].x;","       d.x = coords.y;","       float e1 = texture2D(tDiffuse, coords).g;","       coords.y = SMAASearchYDown();","       d.y = coords.y;","       d = d / SMAA_PIXEL_SIZE.y - pixcoord.y;","       vec2 sqrt_d = sqrt(abs(d));","       float e2 = texture2D(tDiffuse, (coords + vec2(0.0, 1.0)* SMAA_PIXEL_SIZE)).g;","       weights.ba = SMAAArea(sqrt_d, e1, e2, 0.0);","       SMAADetectVerticalCornerPattern(weights.ba, vUv, d);","   }","   gl_FragColor=weights;","}"].join("\n")};var a={uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},screenWidth:{type:"f",value:800},screenHeight:{type:"f",value:600}},vertexShader:["uniform float screenHeight;","uniform float screenWidth;","varying vec2 vUv;","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","void main() {","    vUv = uv;",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","uniform float screenHeight;","uniform float screenWidth;","varying vec2 vUv;","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","void main() {","   vec4 topLeft = texture2D(tDiffuse2, vUv);","   float bottom = texture2D(tDiffuse2, vUv.xy + SMAA_PIXEL_SIZE.xy * vec2(0.0, -1.0)).g;","   float right = texture2D(tDiffuse2, vUv.xy + SMAA_PIXEL_SIZE.xy * vec2(1.0, 0.0)).a;","   vec4 a = vec4(topLeft.r, bottom, topLeft.b, right);","   vec4 w = a * a * a;","   float sum = dot(w, vec4(1.0));","   if (sum > 0.0) {","       vec4 color = vec4(0.0);","       vec4 CurrentColor = texture2D(tDiffuse, vUv);","       vec4 ColorLeft = texture2D(tDiffuse, vUv.xy + SMAA_PIXEL_SIZE.xy * vec2(-1.0, 0.0));","       vec4 ColorTop = texture2D(tDiffuse, vUv.xy + SMAA_PIXEL_SIZE.xy * vec2(0.0, 1.0));","       vec4 ColorRight = texture2D(tDiffuse, vUv.xy + SMAA_PIXEL_SIZE.xy * vec2(1.0, 0.0));","       vec4 ColorBottom = texture2D(tDiffuse, vUv.xy + SMAA_PIXEL_SIZE.xy * vec2(0.0, -1.0));","       color = mix(CurrentColor, ColorTop, a.r) * w.r + color;","       color = mix(CurrentColor, ColorBottom, a.g) * w.g + color;","       color = mix(CurrentColor, ColorLeft, a.b) * w.b + color;","       color = mix(CurrentColor, ColorRight, a.a) * w.a + color;","       gl_FragColor = color / sum;","   } else {","       gl_FragColor = texture2D(tDiffuse,vUv);","   }","}"].join("\n")};return{EdgeDetection:b,BlendingWeights:c,FinalBlending:a}});define("Shaders/SMAAShader",["DS/Shaders/SMAAShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/SMAAShader");return b});define("DS/VisuEvents/MouseEvent",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent"],function(c,a){var b=a.extend({init:function(d,e){this._parent(e);this.type="Mouse";this.button=d;return this},update:function(g){this._parent(g);var f;try{f=this.view.getBoundingClientRect()}catch(e){f={left:0,top:0}}switch(g.type){case"mousedown":case"mousewheel":case"DOMMouseScroll":this.currentPosition.set(g.clientX-f.left,g.clientY-f.top);this.startPosition.copy(this.currentPosition);this.lastPosition.copy(this.currentPosition);this.deltaPosition.set(0,0);this.offsetPosition.set(0,0);this._currentPosition.set(g.clientX,g.clientY);this._startPosition.copy(this._currentPosition);this._lastPosition.copy(this._currentPosition);this._deltaPosition.set(0,0);this._offsetPosition.set(0,0);if(this.button===a.MouseButton.LEFT){this.setPrimary(true)}break;case"mousemove":var d=new c.Vector2(g.clientX-f.left,g.clientY-f.top);this.lastPosition.copy(this.currentPosition);this.deltaPosition.subVectors(d,this.currentPosition);this.currentPosition.copy(d);this.offsetPosition.subVectors(this.currentPosition,this.startPosition);d.set(g.clientX,g.clientY);this._lastPosition.copy(this._currentPosition);this._deltaPosition.subVectors(d,this._currentPosition);this._currentPosition.copy(d);this._offsetPosition.subVectors(this._currentPosition,this._startPosition);break;case"mouseup":case"mouseleave":case"mouseout":var d=new c.Vector2(g.clientX-f.left,g.clientY-f.top);this.lastPosition.copy(this.currentPosition);this.deltaPosition.subVectors(d,this.currentPosition);this.currentPosition.copy(d);this.offsetPosition.subVectors(this.currentPosition,this.startPosition);d.set(g.clientX,g.clientY);this._lastPosition.copy(this._currentPosition);this._deltaPosition.subVectors(d,this._currentPosition);this._currentPosition.copy(d);this._offsetPosition.subVectors(this._currentPosition,this._startPosition);break;default:break}},getButton:function(){return this.button}});return UWA.namespace("THREEDS/Events/MouseEvent",b)});define("VisuEvents/MouseEvent",["DS/VisuEvents/MouseEvent","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuEvents/MouseEvent");return b});define("DS/Effects/SMAAEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/SMAAShader","DS/Plugins/ClearPass"],function(d,e,b,g,c,f,h){var a=b.extend({init:function(o,n){this._parent(o);var k=new d.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composer=new g(o,k,n);this.composer.composerContext.name="SMAAEffect";this.composers.push(this.composer);this.pass1=new c(f.EdgeDetection);this.pass1.compileShader(o);this.pass2=new c(f.BlendingWeights);this.pass2.compileShader(o);this.mixPass=new c(f.FinalBlending,undefined,"SMAAEffect");this.mixPass.compileShader(o);this.composer.addPass(this.pass1);this.composer.addPass(this.pass2);var j=e.getWebappsAssetUrl("Effects","");var m=new d.ImageUtils.loadTexture(j+"AreaTexSMAA.png",undefined,null,null,d.ImageUtils.crossOriginPolicy);m.minFilter=d.LinearFilter;m.magFilter=d.LinearFilter;this.pass2.uniforms.areaTex.value=m;var l=new d.ImageUtils.loadTexture(j+"SearchTexSMAA.png",undefined,null,null,d.ImageUtils.crossOriginPolicy);l.minFilter=d.NearestFilter;l.magFilter=d.NearestFilter;this.pass2.uniforms.searchTex.value=l;this.areaTexture=m;this.searchTexture=l;return this},initEffect:function(j,k){k.insertComposer(this.composer,this.mixPass);this.composer.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2);this.mixPass.addRequiredComposer(this.composer)},update:function(k,j,l){},setSize:function(l,j){var k=this._parent(l,j);if(!k){return}this.composer.setSize(this.width,this.height);this.pass1.uniforms.screenWidth.value=this.width;this.pass1.uniforms.screenHeight.value=this.height;this.pass2.uniforms.screenWidth.value=this.width;this.pass2.uniforms.screenHeight.value=this.height;this.mixPass.uniforms.screenWidth.value=this.width;this.mixPass.uniforms.screenHeight.value=this.height},dispose:function(){this._parent();this.areaTexture.dispose();this.searchTexture.dispose()}});return a});define("Effects/SMAAEffect",["DS/Effects/SMAAEffect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/SMAAEffect");return b});define("DS/Visualization/RenderMode",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(a,f){var d=a.extend({init:function(g){this._mask=0;this._gssoMask=0;this._setFromMasks(0,0,f.GeomTypeEnum.FACE);this._useRenderLineMask=true;this._useRenderFaceMask=true;this._useRenderPointMask=true;this._outlineWidth=1;if(g&&g.renderLineMode!==undefined){this._setRenderLineMode(g.renderLineMode)}},clone:function(){var g=new d();g._mask=this._mask;g._gssoMask=this._gssoMask;g._useRenderLineMask=this._useRenderLineMask;g._useRenderPointMask=this._useRenderPointMask;g._useRenderFaceMask=this._useRenderFaceMask;return g},combine:function(g){if(g){this._mask=g._mask}},setOutlineWidth:function(g){this._outlineWidth=g},setRenderMode:function(l,h){if(l==="@InternalEdge"){this.setRenderMode("InternalSharpEdge",h);this.setRenderMode("InternalSmoothEdge",h)}else{if(l==="@Edge"){this.setRenderMode("InternalSharpEdge",h);this.setRenderMode("InternalSmoothEdge",h);this.setRenderMode("BoundaryEdge",h);this.setRenderMode("WireEdge",h)}else{if(l==="@Point"){this.setRenderMode("BoundaryPoint",h);this.setRenderMode("SharpPoint",h);this.setRenderMode("SmoothPoint",h);this.setRenderMode("SurfacicPoint",h);this.setRenderMode("FreePoint",h)}else{var k={InternalSharpEdge:"SHARP_EDGE",InternalSmoothEdge:"SMOOTH_EDGE",BoundaryEdge:"BOUNDARY_EDGE",WireEdge:"WIRE_EDGE",Outline:"_OUTLINE",SectionLine:"_SECTION_LINE",Face:"FACE",BoundaryPoint:"BOUNDARY_POINT",SharpPoint:"SHARP_POINT",SurfacicPoint:"SURFACIC_POINT",SmoothPoint:"SMOOTH_POINT",FreePoint:"FREE_POINT",AxisSystem:"AXIS_SYSTEM",InfiniteFace:"INFINITE_FACE"};var g=k[l];if(!g){console.warn(l+"unknown category")}else{var m=f.GeomTypeEnum[g];var j,n;j=this._mask||0;if(h){n=j|m}else{n=j&~m}this._setMask(n)}}}}},_setRenderLineMode:function(k){k=k||0;var g=this._mask,j,h=d.linesMask;g=g&(~h);j=(k&h)|g;this._setMask(j)},_setFromMasks:function(j,g,h){this._setMask((j&b)|(g&e)|(h&c))},getRenderLineMode:function(){return this._mask&e},_setMask:function(g){this._mask=g;this._gssoMask=g|d.defaultMask}});d.createChild=function(g,h){var j=null;if(g||h){if(g){j=g.clone();j.combine(h)}else{j=h}}return j};d.defaultMask=f.GeomTypeEnum.EDGE|f.GeomTypeEnum.UNKNOWN;var b=f.GeomTypeEnum.BOUNDARY_POINT|f.GeomTypeEnum.SHARP_POINT|f.GeomTypeEnum.SMOOTH_POINT|f.GeomTypeEnum.SURFACIC_POINT|f.GeomTypeEnum.FREE_POINT|f.GeomTypeEnum.HIDDEN_SEAM_POINT;d.pointsMask=b;var e=f.GeomTypeEnum.EDGE|f.GeomTypeEnum.WIRE_EDGE|f.GeomTypeEnum.BOUNDARY_EDGE|f.GeomTypeEnum.SHARP_EDGE|f.GeomTypeEnum.SMOOTH_EDGE|f.GeomTypeEnum.HIDDEN_SEAM_EDGE|f.GeomTypeEnum._OUTLINE|f.GeomTypeEnum._SECTION_LINE;d.linesMask=e;var c=f.GeomTypeEnum.INFINITE_FACE|f.GeomTypeEnum.FACE|f.GeomTypeEnum.AXIS_SYSTEM;d.facesMask=c;d.defaultRenderLineMode=f.GeomTypeEnum.EDGE;f.RenderMode=d;return d});define("DS/Gestures/PrimaryPointerMoveUniqueGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent","DS/Gestures/BasicGesture"],function(b,a,d,e){var c=e.extend({init:function(){this._parent("PrimaryPointerMoveUnique");this.priority=10;return this},detect:function(g){this._parent(g);switch(this.state){case e.State.INIT:case e.State.CHANGE:var m=false;var n=THREEDS.VisuEventsManager.getScreenEvents();var l=n.length;var p=null;if(l>0){if(l===1){var o=n[0].getType();var f=n[0].getState();if(o==="Mouse"||o==="Touch"){m=(f===a.State.MOVE);p=n[0]}}else{if(l===2){var j=THREEDS.VisuEventsManager.getMouseEventsByStates([a.State.MOVE],a.MouseButton.NONE,this.view);var h=THREEDS.VisuEventsManager.getMouseEventsByStates([a.State.MOVE],a.MouseButton.LEFT,this.view);var k=THREEDS.VisuEventsManager.getTouchEvents(this.view);m=((j.length===1)&&(h.length===1))||((k.length===1)&&(k[0].getState()===a.State.MOVE)&&(!j.length)&&(!h.length));p=(h.length)?h[0]:k[0]}}}if(m){this.events=[p];this.changeState(e.State.CHANGE);return}this.changeState(e.State.INIT);break;case e.State.KO:case e.State.OK:case e.State.CANCEL:this.changeState(e.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/PrimaryPointerMoveUniqueGesture",c)});define("Gestures/PrimaryPointerMoveUniqueGesture",["DS/Gestures/PrimaryPointerMoveUniqueGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/PrimaryPointerMoveUniqueGesture");return b});define("DS/Shaders/SSLRBlendShader",["DS/Visualization/ThreeJS_DS"],function(b){var a={uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","varying vec2 vUv;","void main() {","  vec4 color  = texture2D(  tDiffuse, vUv );","  vec4 color2 = texture2D( tDiffuse2, vUv );","  gl_FragColor = vec4((1.0 - color2.a) * color.xyz + color2.a * color2.xyz, color.a);","}"].join("\n")};return a});define("Shaders/SSLRBlendShader",["DS/Shaders/SSLRBlendShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/SSLRBlendShader");return b});define("DS/Shaders/DisplayShadowMapsShader",["DS/Visualization/ThreeJS_DS"],function(b){var a={uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDiffuse4:{type:"t",value:null},tDiffuse5:{type:"t",value:null},offset:{type:"v2",value:new b.Vector2(0.505,0.01)},scale:{type:"f",value:0.485},offset2:{type:"v2",value:new b.Vector2(0.01,0.01)},scale2:{type:"f",value:0.485},offset3:{type:"v2",value:new b.Vector2(0.505,0.505)},scale3:{type:"f",value:0.485},offset4:{type:"v2",value:new b.Vector2(0.01,0.505)},scale4:{type:"f",value:0.485}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform sampler2D tDiffuse4;","uniform sampler2D tDiffuse5;","uniform vec2 offset;","uniform float scale;","uniform vec2 offset2;","uniform float scale2;","uniform vec2 offset3;","uniform float scale3;","uniform vec2 offset4;","uniform float scale4;","varying vec2 vUv;","void main() {","gl_FragColor = vec4(0.0);","vec2 vUv2 = (vUv - offset) / scale;","vec2 vUv3 = (vUv - offset2) / scale2;","vec2 vUv4 = (vUv - offset3) / scale3;","vec2 vUv5 = (vUv - offset4) / scale4;","if (vUv2.x > 0.0 && vUv2.y > 0.0 && vUv2.x < 1.0 && vUv2.y < 1.0) {","    vec4 normalDepth = texture2D( tDiffuse2, vUv2 );","    gl_FragColor = vec4(vec3(normalDepth.w), 0.7); return;","} else if (vUv3.x > 0.0 && vUv3.y > 0.0 && vUv3.x < 1.0 && vUv3.y < 1.0) {","    vec4 normalDepth = texture2D( tDiffuse3, vUv3 );","    gl_FragColor = vec4(vec3(normalDepth.w), 0.7); return;","} else if (vUv4.x > 0.0 && vUv4.y > 0.0 && vUv4.x < 1.0 && vUv4.y < 1.0) {","    vec4 normalDepth = texture2D( tDiffuse4, vUv4 );","    gl_FragColor = vec4(vec3(normalDepth.w), 0.7); return;","} else if (vUv5.x > 0.0 && vUv5.y > 0.0 && vUv5.x < 1.0 && vUv5.y < 1.0) {","    vec4 normalDepth = texture2D( tDiffuse5, vUv5 );","    gl_FragColor = vec4(vec3(normalDepth.w), 0.7); return;","}","}"].join("\n")};return a});define("Shaders/DisplayShadowMapsShader",["DS/Shaders/DisplayShadowMapsShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/DisplayShadowMapsShader");return b});define("DS/Effects/SSLREffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/SSLRShader","DS/Shaders/BloomShaders","DS/Shaders/SSLRBlendShader"],function(h,b,d,e,c,f,j,g){var a=d.extend({init:function(o,n){var p=this._parent(o);var m=new h.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers.push(new e(o,m,n));this.effectSSLR=new c(f);this.effectSSLRBlurH=new c(j.BlurH);this.effectSSLRBlurV=new c(j.BlurV);this.composers[0].addPass(this.effectSSLR);this.composers[0].addPass(this.effectSSLRBlurH);this.composers[0].addPass(this.effectSSLRBlurV);this.composers[0].enablePass(this.effectSSLRBlurH,false);this.composers[0].enablePass(this.effectSSLRBlurV,false);var k=b.getWebappsAssetUrl("Effects","");var l=new h.ImageUtils.loadTexture(k+"SSAORandom.png",undefined,null,null,h.ImageUtils.crossOriginPolicy);l.minFilter=h.LinearFilter;l.magFilter=h.LinearFilter;this.effectSSLR.uniforms.tRandomTex.value=l;this.mixPass=new c(g,undefined,"SSLREffect");var p=this;this.mixPass.beforeRenderCB=function(q){p.effectSSLR.uniforms.tDiffuse2.value=q};return this},initEffect:function(l,m){var k=m.getComposer("normalDepth");k.linkToShaderPassUniform(this.effectSSLR,this.effectSSLR.uniforms.tNormalDepth);m.insertComposer(this.composers[0],this.mixPass);this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2);this.mixPass.addRequiredComposer(this.composers[0])},update:function(m,l,o){o._renderedCamera.projectionMatrixInverse.getInverse(o._renderedCamera.projectionMatrix);this.effectSSLR.uniforms.realProjectionMatrixInverse.value=o._renderedCamera.projectionMatrixInverse;this.effectSSLR.uniforms.realProjectionMatrix.value=o._renderedCamera.projectionMatrix;var q=l.getBoundingSphere(),n=0.2*q.radius,k=(new h.Vector3().subVectors(o.target,o._renderedCamera.position)).length(),p=0.2*k*Math.tan(0.5*o._renderedCamera.fov*(Math.PI/180));n=(n>p)?p:n;this.effectSSLR.uniforms.radius.value=n},setSize:function(m,k){var l=this._parent(m,k);if(!l){return}this.composers[0].setSize(this.width,this.height);this.effectSSLRBlurH.uniforms.invSize.value.set(1/this.width,1/this.height);this.effectSSLRBlurV.uniforms.invSize.value.set(1/this.width,1/this.height);this.effectSSLR.uniforms.size.value.set(this.width,this.height)}});return a});define("Effects/SSLREffect",["DS/Effects/SSLREffect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/SSLREffect");return b});define("DS/Visualization/RenderTargetPool",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(a,b){var c=a.extend({init:function(e){var d=b.FloatType;if(!e.supportsFloatTextures()){d=b.UnsignedByteType}this.rtOptionsMap={linear:{minFilter:b.LinearFilter,magFilter:b.LinearFilter,stencilBuffer:true,format:b.RGBAFormat,type:d},nearest:{minFilter:b.NearestFilter,magFilter:b.NearestFilter,stencilBuffer:true,format:b.RGBAFormat,type:d},uint:{minFilter:b.LinearFilter,magFilter:b.LinearFilter,stencilBuffer:true,format:b.RGBAFormat,type:b.UnsignedByteType},uintRGBA:{minFilter:b.LinearFilter,magFilter:b.LinearFilter,stencilBuffer:false,format:b.RGBAFormat,type:b.UnsignedByteType},uintNearest:{minFilter:b.NearestFilter,magFilter:b.NearestFilter,stencilBuffer:true,format:b.RGBAFormat,type:b.UnsignedByteType},uintRGBNearest:{minFilter:b.NearestFilter,magFilter:b.NearestFilter,stencilBuffer:true,format:b.RGBFormat,type:b.UnsignedByteType},cubelinear:{minFilter:b.LinearFilter,magFilter:b.LinearFilter,stencilBuffer:true,format:b.RGBAFormat,type:d},};this.renderTargetPool=[]},areRenderTargetOptionsEqual:function(e,d){if(!e||!d){return e===d}return e.height===d.height&&e.width===d.width&&e.options===d.options},resetRenderTargetPool:function(){var d=0;for(d=0;d<this.renderTargetPool.length;d++){this.renderTargetPool[d].dispose()}this.renderTargetPool=[]},rtpStats:{nbCreation:0},dumpPool:function(){var e="dumpPool: [";var d;for(d=0;d<this.renderTargetPool.length;d++){if(d>0){e+=", "}e+=this.renderTargetPool[d].uniqueID}e+="]";console.log(e)},buildRenderTarget:function(e,n,m,j,f,d){var o=this.rtOptionsMap[m],g;var k=null,h,l=-1;if(!d){for(h=0;h<this.renderTargetPool.length&&l<0;h++){g=this.rtOptionsMap[this.renderTargetPool[h].optionsId];if(g&&g.type===o.type&&this.renderTargetPool[h].width===e&&this.renderTargetPool[h].height===n){k=this.renderTargetPool[h];k.reset(this.rtOptionsMap[m]);l=h}else{}}if(l>=0){this.renderTargetPool.splice(l,1)}}if(!k){if(m==="cubelinear"){k=new b.WebGLRenderTargetCube(e,n,this.rtOptionsMap[m])}else{k=new b.WebGLRenderTarget(e,n,this.rtOptionsMap[m])}if(e>0&&n>0){this.rtpStats.nbCreation++}}if(f){k.shareDepthFrom=f}k.optionsId=m;return k},pushRenderTarget:function(d,e){this.renderTargetPool.push(d)}});return c});define("Visualization/RenderTargetPool",["DS/Visualization/RenderTargetPool","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/RenderTargetPool");return b});define("DS/Shaders/BokehDOFShader",["DS/Visualization/ThreeJS_DS"],function(a){var b={defines:{RINGS:3,SAMPLES:8},uniforms:{textureWidth:{type:"f",value:512},textureHeight:{type:"f",value:512},focalDepth:{type:"f",value:1},focalLength:{type:"f",value:64},fstop:{type:"f",value:0.9},realProjectionMatrixInverse:{type:"m4",value:new a.Matrix4()},tDiffuse:{type:"t",value:null},tNormalDepth:{type:"t",value:null},maxblur:{type:"f",value:5},showFocus:{type:"i",value:0},manualdof:{type:"i",value:0},threshold:{type:"f",value:0.5},gain:{type:"f",value:2},bias:{type:"f",value:0.5},fringe:{type:"f",value:0.7},noise:{type:"i",value:1},dithering:{type:"f",value:0.0001},shaderFocus:{type:"i",value:0},focusCoords:{type:"v2",value:new a.Vector2()}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",a._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform mat4 realProjectionMatrixInverse;","uniform sampler2D tDiffuse;","uniform sampler2D tNormalDepth;","uniform float textureWidth;","uniform float textureHeight;","const float PI = 3.14159265;","float width = textureWidth; //texture width","float height = textureHeight; //texture height","vec2 texel = vec2(1.0 / width, 1.0 / height);","uniform float focalDepth;  //focal distance value in meters, but you may use autofocus option below","uniform float focalLength; //focal length in mm","uniform float fstop; //f-stop value","uniform bool showFocus; //show debug focus point and focal range (red = focal point, green = focal range)","//------------------------------------------","//user variables","const int samples = SAMPLES; //samples on the first ring","const int rings = RINGS; //ring count","const int maxringsamples = rings * samples;","uniform bool manualdof; // manual dof calculation","float ndofstart = 1.0; // near dof blur start","float ndofdist = 2.0; // near dof blur falloff distance","float fdofstart = 1.0; // far dof blur start","float fdofdist = 3.0; // far dof blur falloff distance","float CoC = 0.03; //circle of confusion size in mm (35mm film = 0.03mm)","uniform bool shaderFocus;","bool autofocus = shaderFocus;","uniform vec2 focusCoords;","uniform float maxblur;","uniform float threshold; // highlight threshold;","uniform float gain; // highlight gain;","uniform float bias; // bokeh edge bias","uniform float fringe; // bokeh chromatic aberration / fringing","uniform bool noise; //use noise instead of pattern for sample dithering","uniform float dithering;","float namount = dithering; //dither amount","//------------------------------------------","float getDepth( vec2 coords ) {","vec4 normalDepth = texture2D( tNormalDepth, coords );","float z = normalDepth.w;","if ( z == 0.0 ) return 0.0;","vec2 xy = coords * 2.0 - 1.0;","vec4 vertexPositionProjected = vec4( xy, 2.0 * z - 1.0, 1.0 );","vec4 vertexPositionVS = realProjectionMatrixInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","vertexPositionVS.w = 1.0;","return -vertexPositionVS.z;","}","vec3 color(vec2 coords, float blur) {","vec3 col = texture2D(tDiffuse, coords).rgb;","return col;","}","vec2 rand(vec2 coord) {","float noiseX = ((fract(1.0-coord.s*(width/2.0))*0.25)+(fract(coord.t*(height/2.0))*0.75))*2.0-1.0;","float noiseY = ((fract(1.0-coord.s*(width/2.0))*0.75)+(fract(coord.t*(height/2.0))*0.25))*2.0-1.0;","if (noise) {","noiseX = clamp(fract(sin(dot(coord ,vec2(12.9898,78.233))) * 43758.5453),0.0,1.0)*2.0-1.0;","noiseY = clamp(fract(sin(dot(coord ,vec2(12.9898,78.233)*2.0)) * 43758.5453),0.0,1.0)*2.0-1.0;","}","return vec2(noiseX, noiseY);","}","vec3 debugFocus(vec3 col, float blur, float depth) {","float edge = 0.002*depth; //distance based edge smoothing","float m = clamp(smoothstep(0.0,edge,blur),0.0,1.0);","float e = clamp(smoothstep(1.0-edge,1.0,blur),0.0,1.0);","col = mix(col,vec3(1.0,0.5,0.0),(1.0-m)*0.6);","col = mix(col,vec3(0.0,0.5,1.0),((1.0-e)-(1.0-m))*0.2);","return col;","}","float gather(float i, float j, int ringsamples, inout vec3 col, float w, float h, float blur) {","float rings2 = float(rings);","float step = PI*2.0 / float(ringsamples);","float pw = cos(j*step)*i;","float ph = sin(j*step)*i;","float weight = mix(1.0, i/rings2, bias);","col += color(vUv.xy + vec2(pw*w, ph*h), blur) * weight;","return weight;","}","void main() {","float depth = getDepth(vUv.xy);","float fDepth = focalDepth;","if (autofocus) {","fDepth = getDepth(focusCoords);","}","// dof blur factor calculation","float blur = 0.0;","if (manualdof) {","float a = depth - fDepth;","float b = (a - fdofstart) / fdofdist;","float c = (- a - ndofstart) / ndofdist;","blur = (a > 0.0) ? b : c;","} else {","float f = focalLength;","float d = fDepth * 1000.0;","float o = depth * 1000.0;","float a = (o * f) / (o - f);","float b = (d * f) / (d - f);","float c = (d - f) / (d * fstop * CoC);","blur = abs(a - b) * c;","}","blur = clamp(blur, 0.0, 1.0);","vec2 noise = rand(vUv.xy) * namount * blur;","float w = (1.0 / width) * blur * maxblur + noise.x;","float h = (1.0 / height) * blur * maxblur + noise.y;","vec4 colAlpha = texture2D(tDiffuse, vUv.xy);","vec3 col = colAlpha.rgb;","float s = 1.0;","int ringsamples;","for (int i = 1; i <= rings; i++) {","ringsamples = i * samples;","for (int j = 0 ; j < maxringsamples ; j++) {","if (j >= ringsamples) break;","s += gather(float(i), float(j), ringsamples, col, w, h, blur);","}","}","col /= s;","if (showFocus) {","col = debugFocus(col, blur, depth);","}","gl_FragColor.rgb = col;","gl_FragColor.a = colAlpha.a;","} "].join("\n")};return b});define("Shaders/BokehDOFShader",["DS/Shaders/BokehDOFShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/BokehDOFShader");return b});define("DS/Effects/BokehDOFEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ShaderPass","DS/Shaders/BokehDOFShader"],function(c,a,b,e){var d=a.extend({init:function(k,h){this._parent(k);this.mixPass=new b(e,undefined,"BokehDOFEffect");this.mixPass.uniforms.focusCoords.value.set(0.5,0.5);this.autofocus=true;this.distanceToTarget=100;this.lensRadius=1;this.iterative=false;this.maxIteration=128;this.dofOffset=[];var g;var f=0;for(g=0;g<this.maxIteration;g++){var l;do{l=c.RandomLib.LowDiscrepancy2D(f);l.x=2*l.x-1;l.y=2*l.y-1;f++}while(l.length()>1);this.dofOffset.push({x:l.x,y:l.y})}this.dofOffset.sort(function(m,j){if(m.x*m.x+m.y*m.y<j.x*j.x+j.y*j.y){return -1}return 1});return this},initEffect:function(g,h){h.insertComposer(null,this.mixPass);var f=h.getComposer("normalDepth");f.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tNormalDepth)},update:function(h,g,j){j._renderedCamera.projectionMatrixInverse.getInverse(j._renderedCamera.projectionMatrix);this.mixPass.uniforms.realProjectionMatrixInverse.value=j._renderedCamera.projectionMatrixInverse;if(this.autofocus){var f=new c.Vector3().subVectors(j.target,j._renderedCamera.position);this.distanceToTarget=f.length();this.mixPass.uniforms.focalDepth.value=this.distanceToTarget}},updateFocalPlane:function(f){this.mixPass.uniforms.focalDepth.value=f},updateFocalLength:function(f){this.mixPass.uniforms.focalLength.value=f;this.lensRadius=f},updateFStop:function(f){this.mixPass.uniforms.fstop.value=f},setAutoFocus:function(f){this.autofocus=f},setSize:function(h,f){var g=this._parent(h,f);if(!g){return}this.mixPass.uniforms.textureWidth.value=h;this.mixPass.uniforms.textureHeight.value=f},setIterative:function(f){if(f===this.iterative){return}this.iterative=f;if(this.mixPass){var g=this.mixPass.composer;if(g&&g.contexts.length){g.contexts[0].enablePass(this.mixPass,this.enabled&&!this.iterative)}}},getMaxIteration:function(){return this.maxIteration},computeJitterCamera:function(p,n,f){var q=this.width/this.height;var o=p.clone();var s=o.near*Math.tan(c.Math.degToRad(0.5*o.fov));var u=q*s;var j=Math.min(this.getMaxIteration()-1,n);var l=o.near*this.lensRadius*this.dofOffset[j].x/this.mixPass.uniforms.focalDepth.value;var k=o.near*this.lensRadius*this.dofOffset[j].y/this.mixPass.uniforms.focalDepth.value;var h=u-l;var t=-(u+l);var r=s-k;var g=-(s+k);if(f){f.x*=2*Math.abs(u);f.y*=2*Math.abs(s);t+=f.x;h+=f.x;g+=f.y;r+=f.y}var m=o.getLookAt().cross(o.up);o.position.add(o.up.clone().multiplyScalar(this.lensRadius*this.dofOffset[j].y));o.position.add(m.clone().multiplyScalar(this.lensRadius*this.dofOffset[j].x));o.projectionMatrix.makeFrustum(t,h,g,r,o.near,o.far);return o}});return d});define("Effects/BokehDOFEffect",["DS/Effects/BokehDOFEffect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/BokehDOFEffect");return b});define("DS/Gestures/PrimaryPointerClickGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent","DS/Gestures/BasicGesture"],function(c,a,d,e){var b=e.extend({init:function(){this._parent("PrimaryPointerClick");this.priority=10;this.identifier=null;this.maxTime=300;this.maxDistance=10;return this},detect:function(h){this._parent(h);switch(this.state){case e.State.INIT:this.identifier=null;var j=THREEDS.VisuEventsManager.getPrimaryPointerEventsByStates([a.State.BEGIN],this.view);if(j.length===1){if(j[0] instanceof d){this.identifier=j[0].identifier}this.changeState(e.State.BEGIN)}break;case e.State.BEGIN:var f=null;if(this.identifier!==null){var g=THREEDS.VisuEventsManager.getTouchEvents(this.view);if(g.length>1){return}f=THREEDS.VisuEventsManager.getTouchEventById(this.identifier)}else{f=THREEDS.VisuEventsManager.getMouseEvents(a.MouseButton.LEFT,this.view)[0]}if(f){if(f.state===a.State.MOVE){if((f.offsetPosition.length()>this.maxDistance)||(f.currentTime-f.startTime>this.maxTime)){this.changeState(e.State.KO)}}else{if(f.state===a.State.END){if((f.offsetPosition.length()>this.maxDistance)||(f.currentTime-f.startTime>this.maxTime)){this.changeState(e.State.KO)}else{this.events=[f];this.changeState(e.State.OK)}}}}else{this.changeState(e.State.KO)}break;case e.State.KO:case e.State.OK:case e.State.CANCEL:this.identifier=null;this.changeState(e.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/PrimaryPointerClickGesture",b)});define("Gestures/PrimaryPointerClickGesture",["DS/Gestures/PrimaryPointerClickGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/PrimaryPointerClickGesture");return b});define("DS/Gestures/ReleaseGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,b,d){var a=d.extend({init:function(){this._parent("Release");this.priority=0;return this},detect:function(f){this._parent(f);switch(this.state){case d.State.INIT:var e=THREEDS.VisuEventsManager.getTouchEventsByStates([b.State.END],this.view);if(e.length){this.events=e.slice();this.changeState(d.State.OK);return}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/ReleaseGesture",a)});define("Gestures/ReleaseGesture",["DS/Gestures/ReleaseGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/ReleaseGesture");return b});define("DS/Gestures/MediumHoldGesture",["DS/Gestures/HoldGesture"],function(a){var b=a.extend({init:function(){this._parent();this.priority=100;this.name="MediumHold";this.maxTime=THREEDS.VisuEventsManager.getMediumHoldTime();return this},detect:function(c){this._parent(c)}});return UWA.namespace("THREEDS/Gestures/MediumHoldGesture",b)});define("Gestures/MediumHoldGesture",["DS/Gestures/MediumHoldGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/MediumHoldGesture");return b});define("DS/Effects/DebugShadowMapsEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/ReplaceBlendShader","DS/Shaders/DisplayShadowMapsShader"],function(g,c,h,b,f,a,d){var e=c.extend({init:function(l,k){this._parent(l);var j=new g.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers.push(new h(l,j,k));this.debugPass=null;this.mixPass=new f(a,undefined,"DebugShadowMapsEffect");this.nbLights=0;return this},initEffect:function(j,k){if(this.debugPass===null){this.debugPass=new f(d);this.composers[0].addPass(this.debugPass)}k.insertComposer(this.composers[0],this.mixPass);this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2);this.mixPass.addRequiredComposer(this.composers[0])},update:function(p,j,k){var n=j.scene;var q=n.__lights.length;if(q===this.nbLights){return}var r=2;for(var m=0;m<q;m++){var l=n.__lights[m];if(l.shadowMap){var o="tDiffuse"+r;if(this.debugPass.uniforms[o]!==undefined){this.debugPass.uniforms[o].value=l.shadowMap}r++}}},setSize:function(l,j){var k=this._parent(l,j);if(!k){return}this.composers[0].setSize(this.width,this.height)}});return e});define("Effects/DebugShadowMapsEffect",["DS/Effects/DebugShadowMapsEffect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/DebugShadowMapsEffect");return b});define("DS/Shaders/DownSamplingShaders",["DS/Visualization/ThreeJS_DS"],function(b){var a=function(f){var g="tDiffuse"+(f?f:"");var e={uniforms:{invSize:{type:"v2",value:new b.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D "+g+";","varying vec2 vUv;","void main() {","gl_FragColor = texture2D("+g+", vUv);","}"].join("\n")};e.uniforms[g]={type:"t",value:null};return e};var d=function(f){var g="tDiffuse"+(f?f:"");var e={uniforms:{invSize:{type:"v2",value:new b.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D "+g+";","varying vec2 vUv;","void main() {","vec3 result = vec3(0.0);","float total = 0.0;","for (int i = -2; i <= 2; ++i) {","for (int j = -2; j <= 2; ++j) {","vec2 offset = 1.0 * invSize * vec2(float(i), float(j));","float weight = 1.0 / (1.0 + dot(offset, offset));","result += weight * texture2D("+g+", vUv + offset).xyz;","total += weight;","}","}","result /= total;","gl_FragColor = vec4(result, 1.0);","}"].join("\n")};e.uniforms[g]={type:"t",value:null};return e};var c=function(p){var n={tDiffuse1:{type:"t",value:null},};var j=["uniform sampler2D tDiffuse1;",];var m=["if (vUv.y < 0.5) {","gl_FragColor = texture2D(tDiffuse1, vec2(vUv.x, 2.0 * vUv.y));","}",];for(var g=0;g<p;g++){var e=(g+2);var h=Math.pow(2,-e);var l=1/h;n["tDiffuse"+e]={type:"t",value:null};j.push("uniform sampler2D tDiffuse"+e+";");var f=1-h;var o=2*h;m.push("else if (vUv.y < "+f+" && vUv.x < "+o+") {");m.push("vec2 uv = vec2(float("+(l/2)+") * vUv.x, float("+l+") * (vUv.y - "+(1-o)+"));");m.push("gl_FragColor = texture2D(tDiffuse"+e+", uv);");m.push("}")}m.push("else {");m.push("gl_FragColor = vec4(vec3(0.0), 1.0);");m.push("}");j=j.join("\n");m=m.join("\n");var k={uniforms:n,vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:[j,"varying vec2 vUv;","void main() {",m,"}"].join("\n")};return k};return{DownSampling:a(2),DownSamplingBlur:d(2),MergeMips:c}});define("DS/Gestures/MouseOutGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,b,d){var a=d.extend({init:function(){this._parent("MouseOut");this.priority=0;return this},detect:function(h){this._parent(h);var f=THREEDS.VisuEventsManager.getMouseEvents();switch(this.state){case d.State.INIT:for(var g=0;g<f.length;g++){var e=f[g];if((e.state===b.State.CANCEL)&&(e.button===b.MouseButton.NONE)){this.events=[e];this.changeState(d.State.OK);return}}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/MouseOutGesture",a)});define("Gestures/MouseOutGesture",["DS/Gestures/MouseOutGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/MouseOutGesture");return b});define("DS/Effects/HighlightEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/AdvancedHighlightShader","DS/Plugins/ClearPass"],function(f,c,g,b,e,a,h){var d=c.extend({init:function(o,n,l){this._parent(o);this.scenes=[];this.sceneToAdd=[];this.isMultiHighlightMode=false;this.rendererType=l;var m=new f.WebGLRenderTargetProperties(this.width,this.height,"uint");this.effectComp=new g(o,m,n);this.effectComp.keepResult=true;this.composers.push(this.effectComp);var k=new f.WebGLRenderTargetProperties(this.width,this.height,"uintNearest");this.effectCompMultiHL=new g(o,k,n);this.effectCompMultiHL.keepResult=true;this.hlClearPass=null;this.hlClearPass2=null;this.hlRenderPass=null;this.hlRenderPass2=null;this.mixPass=new e(a.FinalBlending,undefined,"HighlightEffect");this.mixPass.enableWarmStart=true;this.mixPass.compileShader(o);var j=[];j[0]=-0.326212;j[1]=-0.405805;j[2]=-0.840144;j[3]=-0.07358;j[4]=-0.695914;j[5]=0.457137;j[6]=-0.203345;j[7]=0.620716;j[8]=0.96234;j[9]=-0.194983;j[10]=0.473434;j[11]=-0.480026;j[12]=0.519456;j[13]=0.767022;j[14]=0.185461;j[15]=-0.893124;j[16]=0.507431;j[17]=0.064425;j[18]=0.530992;j[19]=0.412458;j[20]=-0.32194;j[21]=-0.871945;j[22]=-0.791559;j[23]=0.597705;this.mixPass.uniforms.poisson.value=j;return this},initEffect:function(j,k){this.rendererType=j;if(this.rendererType){this.mixPass.disabledByDefault=true;this.mixPass.needsSwap=false;this.mixPass.material.defines.POSTPRO=0;this.mixPass.material.transparent=true;this.mixPass.material.needsUpdate=true}k.insertComposer(this.composers[0],this.mixPass);this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tAdd);this.mixPass.addRequiredComposer(this.composers[0])},update:function(y,n,r,u,v){var w=this.composers[0].renderer;if(this.hlRenderPass===null){this.hlClearPass=new h("hlClearPass");this.hlRenderPass=new b(n.selectionHL.sceneHL,null,null,undefined,undefined,undefined,"hlRenderPass");this.hlRenderPass.setDisableBackFaceCulling(true);this.hlRenderPass.setMaterialToUse(f.MaterialToUse.highlightMaterial);this.hlRenderPass.cameraName="mainNoJittering";this.composers[0].addPass(this.hlClearPass);this.composers[0].addPass(this.hlRenderPass);this.composers[0].composerContext.setPassClear(this.hlClearPass,true,new f.Color(0),0)}if(this.isMultiHighlightMode&&this.hlRenderPass2===null){this.hlClearPass2=new h("hlClearPass");this.hlRenderPass2=new b(n.selectionHL.sceneHL,null,null,undefined,undefined,undefined,"hlRenderPass");this.hlRenderPass2.setDisableBackFaceCulling(true);this.hlRenderPass2.setMaterialToUse(f.MaterialToUse.outlineHighlightMaterial);this.hlRenderPass2.cameraName="mainNoJittering";this.composers[1].addPass(this.hlClearPass2);this.composers[1].addPass(this.hlRenderPass2);this.composers[1].composerContext.setPassClear(this.hlClearPass2,true,new f.Color(0),0)}if(this.sceneToAdd.length){for(var s=0;s<this.sceneToAdd.length;s++){var t=this.sceneToAdd[s];var A=new b(t.sceneHL,null,null,undefined,undefined,undefined,"hlRenderPass");A.setDisableBackFaceCulling(true);A.setMaterialToUse(f.MaterialToUse.highlightMaterial);A.cameraName="mainNoJittering";this.composers[0].addPass(A);t.passes.push(A)}for(var s=0;s<this.sceneToAdd.length;s++){var t=this.sceneToAdd[s];var A=new b(t.sceneHL,null,null,undefined,undefined,undefined,"hlRenderPass");A.setDisableBackFaceCulling(true);A.setMaterialToUse(f.MaterialToUse.outlineHighlightMaterial);A.cameraName="mainNoJittering";this.composers[1].addPass(A);t.passes.push(A)}this.sceneToAdd=[]}var m=(w.pickFacesMode===1)||((w.pickFacesMode===2)&&w.renderFaces)||((w.pickFacesMode===3)&&!w.renderFaces);var p=w.getRenderMode().clone();p.setRenderMode("Outline",false);var l=p.getRenderLineMode();var k=(w.pickLinesMode===1)||((w.pickLinesMode===2)&&(l||(l===null)))||((w.pickLinesMode===3)&&(l===0));var o=w.getPickingRenderPointMode();var x=(w.pickPointsMode===1)||w.renderPoints;this.hlRenderPass.renderFaces=m;this.hlRenderPass.renderLineMode=k?f.ShowAllRenderLineMode:0;this.hlRenderPass.renderPoints=x;this.hlRenderPass.renderPointMode=o;if(this.isMultiHighlightMode){this.hlRenderPass2.renderFaces=m;this.hlRenderPass2.renderLineMode=k?f.ShowAllRenderLineMode:0;this.hlRenderPass2.renderPoints=x;this.hlRenderPass2.renderPointMode=o;for(var s=0;s<this.scenes.length;s++){for(var q=0;q<this.scenes[s].passes.length;q++){var z=this.scenes[s].passes[q];z.renderFaces=m;z.renderLineMode=k?f.ShowAllRenderLineMode:0;z.renderPoints=x;z.renderPointMode=o}}}this.composers[0].composerContext.needsUpdate=(u===0)||v;if(this.composers[1]){this.composers[1].composerContext.needsUpdate=(u===0)||v}},switchHiglightMode:function(m){var k;if(m){k=a.FinalBlendingMultiHL}else{k=a.FinalBlending}this.mixPass.uniforms=f.UniformsUtils.clone(k.uniforms);if(k.defines){this.mixPass.defines=k.defines}this.mixPass.material=new f.ShaderMaterial({uniforms:this.mixPass.uniforms,vertexShader:k.vertexShader,fragmentShader:k.fragmentShader,defines:this.mixPass.defines,force:true});var l=this.composers[0].renderer;this.mixPass.compileShader(l);if(this.rendererType){this.mixPass.disabledByDefault=true;this.mixPass.needsSwap=false;this.mixPass.material.defines.POSTPRO=0;this.mixPass.material.transparent=true;this.mixPass.material.needsUpdate=true}if(m){this.composers[0].removeLinks();this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tAdd);this.composers.push(this.effectCompMultiHL);this.mixPass.addRequiredComposer(this.composers[1]);this.composers[1].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tAdd2);this.composers[1].setSize(this.composers[0].composerContext.width,this.composers[0].composerContext.height)}else{this.composers[0].removeLinks();this.composers[1].removeLinks();this.composers.splice(1,1);this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tAdd);var j=[];j[0]=-0.326212;j[1]=-0.405805;j[2]=-0.840144;j[3]=-0.07358;j[4]=-0.695914;j[5]=0.457137;j[6]=-0.203345;j[7]=0.620716;j[8]=0.96234;j[9]=-0.194983;j[10]=0.473434;j[11]=-0.480026;j[12]=0.519456;j[13]=0.767022;j[14]=0.185461;j[15]=-0.893124;j[16]=0.507431;j[17]=0.064425;j[18]=0.530992;j[19]=0.412458;j[20]=-0.32194;j[21]=-0.871945;j[22]=-0.791559;j[23]=0.597705;this.mixPass.uniforms.poisson.value=j;this.mixPass.linkedComposerContexts.pop();this.mixPass.requiredComposers.pop();this.composers[0].updateComposerContexts()}},addScene:function(j){if(this.isMultiHighlightMode==false){this.switchHiglightMode(true)}this.isMultiHighlightMode=true;this.scenes.push(j);this.sceneToAdd.push(j)},removePasses:function(m){var j=this.composers[0];var l=j.passLists[0].passes;for(var k=0;k<l.length;k++){if(l[k]===m.passes[0]){l.splice(k,1)}}j.updateComposerContexts();var j=this.composers[1];var l=j.passLists[0].passes;for(var k=0;k<l.length;k++){if(l[k]===m.passes[1]){l.splice(k,1)}}j.updateComposerContexts()},removeScene:function(l){var j=[];for(var k=0;k<this.scenes.length;k++){if(this.scenes[k]===l){this.removePasses(l);this.scenes[k].clearAll();continue}j.push(this.scenes[k])}this.scenes=j},setSize:function(l,j){var k=this._parent(l,j);if(!k){return}this.composers[0].setSize(this.width,this.height);if(this.composers[1]){this.composers[1].setSize(this.width,this.height)}this.mixPass.uniforms.h.value=1/this.width;this.mixPass.uniforms.v.value=1/this.height},setEnabled:function(j){this.composers[0].composerContext.enablePass(this.hlRenderPass,j);if(j){this._parent(j)}}});return d});define("Effects/HighlightEffect",["DS/Effects/HighlightEffect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/HighlightEffect");return b});define("DS/Gestures/LongHoldGesture",["DS/Gestures/HoldGesture"],function(a){var b=a.extend({init:function(){this._parent();this.priority=100;this.name="LongHold";this.maxTime=THREEDS.VisuEventsManager.getLongHoldTime();return this},detect:function(c){this._parent(c)}});return UWA.namespace("THREEDS/Gestures/LongHoldGesture",b)});define("Gestures/LongHoldGesture",["DS/Gestures/LongHoldGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/LongHoldGesture");return b});define("DS/Gestures/DoublePinchTapGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,a,d){var b=d.extend({init:function(){this._parent("DoublePinchTap");this.priority=100;this.currentTime=0;this.maxTime=600;this.maxDistance=15;this.lastTapTime=0;this.lastTapPosition=0;return this},detect:function(f){this._parent(f);var e=this.gestures[0];if(!e){return}this.currentTime=new Date().getTime();switch(this.state){case d.State.INIT:if(e.getState()===d.State.OK){this.lastTapTime=this.currentTime;this.lastPosition=e.events[1].currentPosition;this.changeState(d.State.BEGIN)}break;case d.State.BEGIN:if(e.getState()===d.State.OK){if((this.currentTime-this.lastTapTime<this.maxTime)&&(this.lastPosition.sub(e.events[1].currentPosition).length()<this.maxDistance)){this.events=e.getEvents();this.changeState(d.State.OK)}else{this.lastTapTime=this.currentTime;this.lastPosition=e.events[1].currentPosition}}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/DoublePinchTapGesture",b)});define("Gestures/DoublePinchTapGesture",["DS/Gestures/DoublePinchTapGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/DoublePinchTapGesture");return b});define("DS/Gestures/PanGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,a,d){var b=d.extend({init:function(){this._parent("Pan");this.priority=10;this.touches=[];this.fingersVector=new c.Vector2();this.latencyTime=200;this.initTime=0;this.distance=null;this.lastDistance=0;this.initDistance=0;this.distanceMax=10;this.orientation=null;this.lastOrientation=0;this.initOrientation=0;this.orientationMax=0.1;this.barycenter=null;this.lastBarycenter=new c.Vector2();this.initBarycenter=new c.Vector2();this.barycenterMin=10;return this},detect:function(g){this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([a.State.BEGIN,a.State.MOVE,a.State.IDLE,a.State.END],this.view);if(this.touches.length===2){var e=g[0].getJSEvent();if(e.preventDefault){e.preventDefault()}this.fingersVector.subVectors(this.touches[1].currentPosition,this.touches[0].currentPosition);if(this.distance===null){this.distance=this.fingersVector.length()}if(this.orientation===null){this.orientation=Math.acos(Math.min(Math.max((this.touches[1].currentPosition.x-this.touches[0].currentPosition.x)/this.distance,-1),1))}if(this.barycenter===null){this.barycenter=new c.Vector2();this.barycenter.addVectors(this.touches[0].currentPosition,this.touches[1].currentPosition);this.barycenter.multiplyScalar(0.5)}this.lastDistance=this.distance;this.distance=this.fingersVector.length();this.lastOrientation=this.orientation;this.orientation=Math.acos(Math.min(Math.max((this.touches[1].currentPosition.x-this.touches[0].currentPosition.x)/this.distance,-1),1));this.lastBarycenter.copy(this.barycenter);this.barycenter.addVectors(this.touches[0].currentPosition,this.touches[1].currentPosition);this.barycenter.multiplyScalar(0.5)}switch(this.state){case d.State.INIT:if(this.touches.length===2){this.initTime=new Date().getTime();this.initDistance=this.distance;this.initOrientation=this.orientation;this.initBarycenter.copy(this.barycenter);this.changeState(d.State.BEGIN)}break;case d.State.BEGIN:if(this.touches.length===2){if(new Date().getTime()-this.initTime>this.latencyTime){if((Math.abs(this.distance-this.initDistance)<this.distanceMax)&&(Math.abs(this.orientation-this.initOrientation)<this.orientationMax)&&(this.initBarycenter.sub(this.barycenter).length()>this.barycenterMin)){this.events=this.touches;this.changeState(d.State.CHANGE)}else{this.changeState(d.State.KO)}}}else{this.changeState(d.State.KO)}break;case d.State.CHANGE:if(this.touches.length===2){var f=(this.touches[0].getState()===a.State.END)||(this.touches[1].getState()===a.State.END);this.events=this.touches;this.changeState(d.State.CHANGE,f)}else{this.changeState(d.State.KO)}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);this.touches=[];this.distance=null;this.orientation=null;this.barycenter=null;break;default:break}},getFirstTouchPosition:function(e){var f;if(this.getEvents().length===2){f=this.getEvents()[0].getCurrentPosition();return f}return null},getSecondTouchPosition:function(f){var e;if(this.getEvents().length===2){e=this.getEvents()[1].getCurrentPosition();return e}return null},getDistanceFromOrigin:function(){if(this.getEvents().length>0){var e=this.getEvents()[0].getCurrentPosition();e.sub(this.getEvents()[0].getStartPosition());return e.length()}return null},getLastTraveledDistance:function(){if(this.getEvents().length>0){var e=this.getEvents()[0].getCurrentPosition();e.sub(this.getEvents()[0].getLastPosition());return e.length()}return null},getTotalTraveledDistFromOrigin:function(){var e=0;if(this.getEvents().length>0){e=this.getEvents()[0].getTraveledDistance();return e}return null},getLastTraveledVector:function(){if(this.getEvents().length>0){var e=this.getEvents()[0]._currentPosition.clone();e.sub(this.getEvents()[0]._lastPosition);return e}return null},getDirectionFromOrigin:function(){if(this.getEvents().length>0){var e=this.getEvents()[0]._currentPosition.clone();e.sub(this.getEvents()[0]._startPosition);return e}return null}});return UWA.namespace("THREEDS/Gestures/PanGesture",b)});define("Gestures/PanGesture",["DS/Gestures/PanGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/PanGesture");return b});define("DS/Gestures/ClickGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,b,d){var a=d.extend({init:function(e){this._parent(b.printMouseButton(e)+"Click");this.priority=10;this.button=e;this.maxTime=300;this.maxDistance=10;return this},detect:function(h){this._parent(h);var f=THREEDS.VisuEventsManager.getMouseEvents(null,this.view);switch(this.state){case d.State.INIT:for(var g=0;g<f.length;g++){var e=f[g];if((e.state===b.State.BEGIN)&&(e.button===this.button)){this.changeState(d.State.BEGIN);return}}break;case d.State.BEGIN:for(var g=0;g<f.length;g++){var e=f[g];if(e.button===this.button){if(e.state===b.State.MOVE){if((e.offsetPosition.length()>this.maxDistance)||(e.currentTime-e.startTime>this.maxTime)){this.changeState(d.State.KO);return}}else{if(e.state===b.State.END){if((e.offsetPosition.length()>this.maxDistance)||(e.currentTime-e.startTime>this.maxTime)){this.changeState(d.State.KO)}else{this.events=[e];this.changeState(d.State.OK)}return}}}}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/ClickGesture",a)});define("Gestures/ClickGesture",["DS/Gestures/ClickGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/ClickGesture");return b});define("DS/Gestures/HoldMouseDownGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture","DS/Gestures/MouseDownGesture","DS/WebRecordEnabler/Adapter"],function(d,a,e,b,f){var c=e.extend({init:function(h,g){this._parent("Hold"+a.printMouseButton(h)+"MouseDown");this.priority=10;this.button=h;this.maxTime=g?g:THREEDS.VisuEventsManager.getHoldTime();this.maxDistance=10;this.timer=null;return this},detect:function(l){this._parent(l);var h=THREEDS.VisuEventsManager.getMouseEvents(null,this.view);var k=this;switch(this.state){case e.State.INIT:for(var j=0;j<h.length;j++){var g=h[j];if((g.state===a.State.BEGIN)&&(g.button===this.button)){this.resetTimer();this.evt=g;if(!f.isReplaying()){this.timer=setTimeout(function(){k.events=[g];k.changeState(e.State.OK);k.execute(true)},this.maxTime)}this.changeState(e.State.BEGIN);return}}break;case e.State.BEGIN:if((this.evt===null)||(this.evt.state===a.State.END)||((this.evt.state===a.State.MOVE)&&(this.evt.offsetPosition.length()>this.maxDistance))){this.resetTimer();this.changeState(e.State.KO)}break;case e.State.KO:case e.State.OK:case e.State.CANCEL:this.changeState(e.State.INIT);break;default:break}},resetTimer:function(){if(this.timer!==null){clearTimeout(this.timer);this.timer=null}}});return UWA.namespace("THREEDS/Gestures/HoldMouseDownGesture",c)});define("Gestures/HoldMouseDownGesture",["DS/Gestures/HoldMouseDownGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/HoldMouseDownGesture");return b});define("DS/Gestures/LongEditGesture",["DS/Gestures/EditGesture"],function(a){var b=a.extend({init:function(){this._parent();this.priority=100;this.name="LongEdit";this.maxTimeTouch=1000;this.maxTimeMouse=1000;return this},detect:function(c){this._parent(c)}});return UWA.namespace("THREEDS/Gestures/LongEditGesture",b)});define("Gestures/LongEditGesture",["DS/Gestures/LongEditGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/LongEditGesture");return b});define("DS/VisuDataAccess/Ox4PlanRunner",["DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(a){var b=function(j,d,g,h,q,o){var m=function(){this.SetName=g;this.executePostHttpRequest=function(t,r,w,v){var s=new a();var u="application/xml";if(typeof(r)==="boolean"&&r){u="application/xmql"}s.executePostHttpRequest(t,u,w,v)}};var f=d;var n=j;var l=new m(g);var k=q;var p=o;var c=function(r){if(h!==null){var s=(j.currentTaskIndex()/j.tasksCount())*100;h(s)}console.log("onNextTask");var t=j.next();if(t==null){e()}else{t[0].run(f,l,h,c,o)}};var e=function(){console.log("----------------Finished-------->");var r=(j.endingTask())(f);if(r.geometryNodes.length>0){k(r)}else{p({type:"NO_GEOMETRY",msg:"No 3D geometry on this product"})}};this.executePlan=function(){console.log("Beginning Ox4PlanRunner runPlan");var r=n.next();r[0].run(f,l,null,c,null);console.log("Ending Ox4PlanRunner runPlan")}};return b});define("VisuDataAccess/Ox4PlanRunner",["DS/VisuDataAccess/Ox4PlanRunner","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/Ox4PlanRunner");return b});define("DS/Gestures/TouchGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,a,d){var b=d.extend({init:function(){this._parent("Touch");this.priority=0;return this},detect:function(f){this._parent(f);switch(this.state){case d.State.INIT:var e=THREEDS.VisuEventsManager.getTouchEventsByStates([a.State.BEGIN],this.view);if(e.length){this.events=e.slice();this.changeState(d.State.OK);return}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);break;default:break}}});return UWA.namespace("THREEDS/Gestures/TouchGesture",b)});define("Gestures/TouchGesture",["DS/Gestures/TouchGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/TouchGesture");return b});define("DS/VisuDataAccess/Ox4DECPlanRunner",["DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(a){var b=function(h,d,g,p,n){var l=function(){this.executePostHttpRequest=function(s,q,v,u){var r=new a();var t="application/xml";if(typeof(q)==="boolean"&&q){t="application/xmql"}r.executePostHttpRequest(s,t,v,u)};this.executeSyncPostHttpRequest=function(s,q,u){var r=new a();var t="application/xml";if(typeof(q)==="boolean"&&q){t="application/xmql"}return r.executeSyncPostHttpRequest(s,t,u)}};var f=d;var m=h;var k=new l();var j=p;var o=n;var c=function(q){console.log("onNextTask");var r=h.next();if(r==null){e()}else{r[0].run(f,k,g,c,n)}};var e=function(){console.log("----------------Finished-------->");var q=(h.endingTask())(f);if(q.geometryNodes.length>0){j(q)}else{o({type:"NO_GEOMETRY",msg:"No 3D geometry on this product"})}};this.executePlan=function(){console.log("Beginning Ox4PlanRunner runPlan");var q=m.next();q[0].run(f,k,null,c,null);console.log("Ending Ox4PlanRunner runPlan")}};return b});define("VisuDataAccess/Ox4DECPlanRunner",["DS/VisuDataAccess/Ox4DECPlanRunner","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/Ox4DECPlanRunner");return b});define("DS/VisuIdentification/Node",["UWA/Class","DS/VisuIdentification/Pattern"],function(a,d){var c=[];var b=a.extend({init:function(f,e){this.pattern=this._findOrCreatePattern(f);this.localId=e;return this},getLocalId:function(){return this.localId},getPattern:function(){return this.pattern},getSpace:function(){return this.pattern.space},getContext:function(){return this.pattern.context},getSharability:function(){return this.pattern.shared},setLocalId:function(e){this.localId=e},setPattern:function(e){this.pattern=this._findOrCreatePattern(e)},computeId:function(){var e="";if(!this.pattern){return e}e+=this.pattern.getContext();e+=b.delimiter;e+=this.localId;return e},_findOrCreatePattern:function(g){for(var f=0;f<c.length;f++){var e=c[f];if(e.isEqual(g)){return e}}return new d(g.space,g.context,g.shared)}});b.delimiter="#";b.atomicDelimiter="/";return UWA.namespace("THREEDS/Identification/Node",b)});define("DS/Visualization/SubElement",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/VisuIdentification/Node","DS/VisuIdentification/Pattern"],function(a,j,d,f,e){var g={};var c=30;var h=0;var b=a.extend({init:function(m,l){if(l!==g&&c>0){var k=(new Error()).stack;k=k&&k.substring(k.indexOf("\n")+1);console.warn("Use of deprecated constructor.\nUse SubElement.getFromSGNode() instead.\n"+k);c--}this.sgNode=m;this._internalGeometryData=null;this.id=h++},getDimension:function(){if(this.sgNode){var k=this.sgNode;if(k.getFirstPrimitive){k=k.getFirstPrimitive()}switch(k.group.glType){case 0:return"point";case 1:case 2:case 3:return"line";case 4:case 5:case 6:return"surface";default:return""}}return""},getCellDimension:function(){if(this.sgNode){var k=this.sgNode;if(k.getFirstPrimitive){k=k.getFirstPrimitive()}switch(k.group.glType){case 0:return 0;case 1:case 2:case 3:return 1;case 4:case 5:case 6:return 2;default:return -1}}return -1},getBodyDimension:function(){if(this.sgNode){var k=this.sgNode;if(k.getFirstPrimitive){k=k.getFirstPrimitive()}if(k.rep&&k.rep.solid){return 3}return 2}return -1},getType:function(){if(this.sgNode){var k=this.sgNode;if(k.getFirstPrimitive){return"selectionGroup"}switch(k.type){case 0:return"node";case 1:return"bag";case 2:return"rep";case 3:return"primitive";default:return""}}return""},getGeometricType:function(){if(this.sgNode){var l=this.getType();if(l==="primitive"){var k=this.sgNode;var m=k.group;if(m){return d.GeomTypeString[m._geomType]}}}return null},getParent:function(){if(this.sgNode){var k=this.sgNode;if(k.getFirstPrimitive){k=k.getFirstPrimitive()}var l=(this.getType()==="primitive")?k.rep:k.parent;if(l){return THREEDS.SubElement.getFromSGNode(l)}}return null},getChildren:function(){var l,k=[];if(this.sgNode){var m=this.getType();if(m==="rep"){for(l=0;l<this.sgNode.primitives.length;l++){k.push(THREEDS.SubElement.getFromSGNode(this.sgNode.primitives[l]))}}else{if(m==="selectionGroup"){var n=this.sgNode.getPrimitives();for(l=0;l<n.length;l++){k.push(THREEDS.SubElement.getFromSGNode(n[l]))}}else{for(l=0;l<this.sgNode.children.length;l++){k.push(THREEDS.SubElement.getFromSGNode(this.sgNode.children[l]))}}}}return k},getCGMID:function(){if(this.sgNode&&!this.sgNode.getFirstPrimitive){return this.sgNode.cgmId}return""},getModelIdentification:function(){return this.getIdentificationObject()},getIdentificationObject:function(){var l;var k=this.sgNode;if(k){if(k.getFirstPrimitive){k=k.getFirstPrimitive()}if(k.getIdentificationObject){l=k.getIdentificationObject()}}return l},getMeshes:function(){var r=[];var n=[];if(this.sgNode){var s=this.getType();if(s==="primitive"){var k=this.sgNode.group;if(k&&k.geometry){var l=k.geometry.meshList;for(var p=0;p<l.length;p++){var t=l[p];n.push(t._occurrence.node)}}}}var q=-1;var m=null;if(n.length){n.sort(function(v,u){return v.id-u.id});q=n[0].id;r.push(n[0])}for(var o=1;o<n.length;o++){m=n[o];if(q!==m.id){q=m.id;r.push(m)}}return r},getReps:function(){var l,k=[];if(this.getType()==="rep"){k.push(this)}else{for(l=0;l<this.children.length;l++){k=k.concat(this.children[l].getReps())}}return k}});b.getFromSGNode=function(k){if(!k.internalNode){k.internalNode=new THREEDS.SubElement(k,g)}return k.internalNode};return UWA.namespace("THREEDS/SubElement",b)});define("Visualization/SubElement",["DS/Visualization/SubElement","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/SubElement");return b});define("DS/Visualization/PathElement",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/Visualization/SubElement"],function(c,e,a,h,g){var b=0;var f=c.extend({init:function(j){this._uid=b++;this.externalPath=[];this.internalPath=[];this._key=null;this.setFromArray(j)},getUID:function(){return this._uid},getLength:function(){return this.externalPath.length+this.internalPath.length},getLastElement:function(j){if(!j&&this.internalPath.length){return this.internalPath[this.internalPath.length-1]}if(this.externalPath.length){return this.externalPath[this.externalPath.length-1]}return null},getElement:function(j,k){if(j<this.externalPath.length){return this.externalPath[j]}if(!k&&(j<this.getLength())){return this.internalPath[j-this.externalPath.length]}return null},isEqual:function(k){var j;if(!k){return false}if(this.externalPath.length!==k.externalPath.length){return false}if(this.internalPath.length!==k.internalPath.length){return false}for(j=0;j<this.externalPath.length;j++){if(this.externalPath[j]!==k.externalPath[j]){return false}}for(j=0;j<this.internalPath.length;j++){if(this.internalPath[j].sgNode!==k.internalPath[j].sgNode){return false}}return true},empty:function(){this.externalPath=[];this.internalPath=[]},clone:function(){var j=new THREEDS.PathElement(this.externalPath);for(var k=0;k<this.internalPath.length;k++){var l=this.internalPath[k];if(l){j.internalPath.push(l)}}if(this._key){j._key=this._key}if(this.instanceId){j.instanceId=this.instanceId}return j},copy:function(j){this.externalPath=j.externalPath.slice();this.internalPath=j.internalPath.slice()},addElement:function(j){var k;if(j){if(j.getNotAllowedInPathElement){if(j.getNotAllowedInPathElement()){d()}}else{if(j.notAllowedInPathElement){d()}}}if(this._key){delete this._key}if(j instanceof THREEDS.Nodes.Node3D){this.externalPath.push(j);return true}if(j instanceof THREEDS.SubElement){this.internalPath.push(j);return true}return false},setFromArray:function(m,l){this._key=null;var n;if((m===undefined)||!(m instanceof Array)){return false}var k=[];for(n=0;n<m.length;n++){var o=m[n];if((o.getNotAllowedInPathElement&&o.getNotAllowedInPathElement())||o.notAllowedInPathElement){d()}else{if(o===null){return false}k.push(o)}}var p=[];if(l&&(l instanceof Array)){for(n=0;n<l.length;n++){var j=l[n];if(j===null){return false}p.push(j)}}if(this.getLength()){this.empty()}this.externalPath=k;this.internalPath=p;return true},setFromOccurrence:function(m,p,j){if((m===null)||(m===undefined)){return false}var l=m.node;var k=m.parent;this.externalPath=[l];var n=false;while(k!==null&&!n){l=k.node;k=k.parent;if(l.getNotAllowedInPathElement()){break}else{this.externalPath.unshift(l);if(j&&l===j){n=true}}}var o=(j&&n)||!j;if((p===null)||(p===undefined)){return o}var k=p.getParent();this.internalPath=[p];while(k!==null){this.internalPath.unshift(k);k=k.getParent()}return o},setFromOccurrencePath:function(k,m){if((k===null)||(k===undefined)){return false}var o=k.getSize();if(!o){return false}var j=[];for(var n=0;n<o;n++){var l=k.getNodeName(n);if(l===null){return false}var p=m.getChildByName(l);if(p===null){return false}if(p.getNotAllowedInPathElement()){d()}else{j.push(p)}}if(this.getLength()){this.empty()}this.externalPath=j;return true},_getOccurrences:function(s){var n,q,m,l,u,t,r,p,o;if(!this.externalPath.length){return[]}n=this.externalPath[0];if(n===null){return[]}u=n._occurrences;if(s){u=u.filter(function(j){return j.scene3js===s.internalSceneGraph.root3js})}t=[];for(o=1;o<this.externalPath.length;o++){n=this.externalPath[o];for(r=0;r<u.length;r++){q=u[r];m=q.children;for(p=0;p<m.length;p++){l=m[p];if(l.node===n){t.push(l)}}}u=t;t=[]}return u},_getRenderableOccurrences:function(r,q){var k,o,m,p,n,l;k=this._getOccurrences(r);o=[];if(k){for(n=0;n<k.length;n++){p=k[n];m=p._getRenderableOccurrences(q);for(l=0;l<m.length;l++){o.push(m[l])}}}return o},_getUniqueOccurrence:function(k){var j=this._getOccurrences(k);if(j&&j.length===1){return j[0]}return null},getKey:function(){if(!this._key){var j=0,k="";for(j=0;j<this.externalPath.length;j++){k+=(j===0?"":"/")+this.externalPath[j].id}k+="//";for(j=0;j<this.internalPath.length;j++){k+=(j===0?"":"/")+this.internalPath[j].id}this._key=k}return this._key},hash:function(){if(!this._hash){var l=0,m="";var k;if(this.internalPath.length){k=this.internalPath[this.internalPath.length-1];if(k instanceof g){var j=k.sgNode;if(j){if(j.start){m+=j.start+"/"}}}else{throw new Error("Unknown node")}}for(l=this.externalPath.length-1;l>=0;l--){m+=this.externalPath[l].id+"/"}this._hash=m}return this._hash},getParentPath:function(){var l=this.externalPath.concat(this.internalPath);if(l.length<=1){return null}var k=new THREEDS.PathElement(),j;for(j=0;j<l.length-1;j++){k.addElement(l[j])}return k},getChildrenPathes:function(k){var n=[];var j=this.getLastElement(),m,o;var l=k?k.getKey():null;if(j===null){return false}if(j.children){for(m=0;m<j.children.length;m++){o=this.clone();o.addElement(j.children[m]);if(o.getKey()!==l){n.push(o)}}}return n},getSiblingsPathes:function(){var j=this.getParentPath();if(!j){return[]}var k=j.getChildrenPathes(this);return k},getAncestorsPathes:function(){var k=this,j=[];while(k){j.unshift(k);k=k.getParentPath()}return j},getSubPath:function(n){if(this.internalPath.length>0){return null}var k,l,j=null,m=null;for(k=this.externalPath.length-2;k>=0&&j===null;k--){l=this.externalPath[k];if(n(l)){j=k}}if(j!==null){m=new f();for(k=0;k<=j;k++){m.addElement(this.externalPath[k])}}return m},toJSON:function(j){var o={};var n=[];var m=this.externalPath[0];var k;while(m){n=[m].concat(n);m=m.parents.length&&m!==j?m.parents[0]:null}o.firstElementPath=[];function l(p){if(p.getPersistentId){return{persistent:true,value:p.getPersistentId()}}else{return{persistent:false,value:p.parents[0].children.indexOf(p)}}}for(k=0;k<n.length;k++){m=n[k];if(m.parents.length||m!==j){o.firstElementPath.push(l(m))}}o.externalPathRest=[];for(k=1;k<this.externalPath.length;k++){o.externalPathRest.push(l(this.externalPath[k]))}return o},setFromJSON:function(m,k){var n=k;function j(q,r){var p,s;if(!r.persistent){return q.children[r.value]}else{for(p=0;p<q.children.length;p++){s=q.children[p];if(s.getPersistentId&&s.getPersistentId()===r.value){return s}}}return null}var l;for(l=0;l<m.firstElementPath.length;l++){n=j(n,m.firstElementPath[l])}var o=[n];for(l=0;l<m.externalPathRest.length;l++){o.push(j(o[o.length-1],m.externalPathRest[l]))}for(l=0;l<o.length;l++){if(!o[l].getNotAllowedInPathElement()){this.addElement(o[l])}}},_dbgPrint:function(){var j="ext:[";var m=this.externalPath.length;for(var l=0;l<m;l++){var k=this.externalPath[l];if(k){j+=k.name}if(l<m-1){j+=", "}}j+="] int:[";m=this.internalPath.length;for(var l=0;l<m;l++){var k=this.internalPath[l];if(k){j+=k.getCGMID()}if(l<m-1){j+=", "}}j+="]";return j},getMatrix:function(l){var m=this._getUniqueOccurrence(l);if(!m){return null}if(m.originalOverrideSet){var k=m.originalOverrideSet.getSubstituteMatrix();if(k){return k.clone()}}var j=this.getLastElement(true);if(j===null){return null}return j.getMatrix()},getWorldMatrix:function(l,k){var n=this;var m=n._getUniqueOccurrence(l);var j;if(m){m._tryOverridesUpdateWithAncestors(l);if(k){k.copy(m.matrix);return k}else{return m.matrix.clone()}}return null},getMatrixInAxisSystem:function(l,m){var k=this.getWorldMatrix(m);if(!k){return null}var j=new e.Matrix4();var n=new e.Matrix4();n.getInverse(l);j.multiplyMatrices(n,k);return j},getBoundingSphere:function(m,l){if(l==="show"){console.warn("DEPRECATED: use visibleSpace instead of show");l="visibleSpace"}if(l==="noShow"){console.warn("DEPRECATED: use invisibleSpace instead of noShow");l="invisibleSpace"}var k=this.getWorldMatrix(m);if(!k){return null}var n=this._getUniqueOccurrence(m);if(!n){return null}m=m||n.scene3js.viewer;n._tryOverridesUpdateWithAncestors(m);var j=n.getBoundingSphere(l).clone();j.center.applyMatrix4(k);return j},getBoundingBox:function(j,n,m){if(!n){return}if(m==="show"){console.warn("DEPRECATED: use visibleSpace instead of show");m="visibleSpace"}if(m==="noShow"){console.warn("DEPRECATED: use invisibleSpace instead of noShow");m="invisibleSpace"}var l=this.getWorldMatrix(n);if(!l){return null}if(j){j.copy(l)}var o=this._getUniqueOccurrence(n);if(!o){return null}n=n||o.scene3js.viewer;o._tryOverridesUpdateWithAncestors(n);var k=o.getBoundingBox(m).clone();return k},getOrientedBoundingBox:function(o,n,q,j,p){if(!n){return null}var k=j||(n.visibleSpace===1?"visibleSpace":"invisibleSpace");var r=this._getUniqueOccurrence(n);if(!r){return null}q=q?q:e.FixedSizeFiltering.Include;p=p?p:[];var s=0;for(var l=0;l<p.length;l++){var m=p[l];s=s|m}r._tryOverridesUpdateWithAncestors(n);return r.computeAccurateBoundingBox(k,o,q,s)},checkExternalPath:function(){var k=true;var j,l,m;for(j=0;j<this.externalPath.length-1&&k;j++){l=this.externalPath[j];m=this.externalPath[j+1];if(l.children.indexOf(m)<0){k=false}}return k},isAParentOf:function(o){function p(t,r){var q=[];var s=t[0];var u=t[0];if(u.parents.length===1&&u!==r){u=u.parents[0];while(u.parents.length===1&&u!==r){q.unshift(u);u=u.parents[0]}q.unshift(u)}q=q.concat(t);return q}var m,l;var j=this.externalPath[0];var n=o.externalPath[0];var k;if(j===n){m=this.externalPath;l=o.externalPath}else{if(this.externalPath.indexOf(n)>0){m=this.externalPath;l=p(o.externalPath,j)}else{m=p(this.externalPath,n);l=o.externalPath}}if(l[0]===m[0]){if(m.length<=l.length){k=0;while(k<m.length&&m[k]===l[k]){k++}return k===m.length}else{return false}}else{return false}},concatenatePathes:function(k,j){var l=k.externalPath.concat(j.externalPath);this.setFromArray(l)},substractPath:function(n,m){var o=m.externalPath.concat([]);var j=n.externalPath;var k=o.indexOf(j[j.length-1]);var l;for(l=0;l<j.length;l++){if(j[l]!==o[l]){return false}}o.splice(0,j.length-1);this.setFromArray(o);return true},setRenderPasses:function(m){var l=this._getRenderableOccurrences();for(var k=0;k<l.length;k++){l[k].setVisibleInPasses(m)}},getParentOccurrencePath:function(){return this.getParentPath.apply(this,arguments)},getChildrenOccurrencePathes:function(){return this.getChildrenPathes.apply(this,arguments)},getSiblingsOccurrencePathes:function(){return this.getSiblingsPathes.apply(this,arguments)},getAncestorsOccurrencePathes:function(){return this.getAncestorsPathes.apply(this,arguments)},_getIndexFromNode:function(j){return this.externalPath.indexOf(j)}});function d(){console.warn("An attempt to add an unauthorized node to a PathElement has been countered.\nPlease remove the node from your PathElement creation.\nNode returned by viewer.getRootNode() and any of its parents may not be part of a PathElement")}return UWA.namespace("THREEDS/PathElement",f)});define("Visualization/PathElement",["DS/Visualization/PathElement","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/PathElement");return b});define("DS/Manipulators/Manipulator",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Visualization/PathElement","DS/CoreEvents/ModelEvents","DS/VisuEvents/ScreenEvent"],function(a,h,e,f,d,g){var k=0;var j=0;var c=a.extend({init:function(l){this.viewer=l;this._uid=k++;this.active=true;this.hasPriority=false;this._pickingPriority=true;this._pickingInManip=false;this._selectionAllowed=false;this._prePickingDuringManip=true;this._preActivationDuringManip=true;this._pickingDuringManip=true;this._checkManipsWhenEnabled=false;this.links={};this.manipulatedPaths=[];this.preactivated={path:null,node:null};this._modelEvent=new d();return this},enable:function(){this.active=true},disable:function(){this.active=false},setExclusive:function(l){this.hasPriority=l},getPriority:function(){return this.hasPriority},getPickingPriority:function(){return this._pickingPriority},setPickingPriority:function(l){this._pickingPriority=l},setPickingInManipulation:function(l){console.log("setPickingInManipulation is DEPRECATED.");this._pickingInManip=l},getPickingInManipulation:function(){return this._pickingInManip},setSelectionAllowed:function(l){this._selectionAllowed=l},getSelectionAllowed:function(){return this._selectionAllowed},setPrePickingDuringManipulation:function(l){this._prePickingDuringManip=l},getPrePickingDuringManipulation:function(){return this._prePickingDuringManip},setPreActivationDuringManipulation:function(l){this._preActivationDuringManip=l},getPreActivationDuringManipulation:function(){return this._preActivationDuringManip},setPickingDuringManipulation:function(l){this._pickingDuringManip=l},getPickingDuringManipulation:function(){return this._pickingDuringManip},checkManipulatorsOnCreation:function(l){this._checkManipsWhenEnabled=l},getUID:function(){return this._uid},linkToNode:function(m){if(m.setIsManipulator){m.setIsManipulator(true)}else{m.isManipulator=true}var l=this._buildLink({node:m});this.activate(l);return l},linkToPath:function(m){m.getLastElement().setIsManipulator(true);var l=this._buildLink({path:m});this.activate(l);return l},_linkToViewer:function(){var l=this._buildLink({viewer:this.viewer});this.activate(l);return l},_buildLink:function(m){var l=j++;this.links[l]={path:m.path,node:m.node,viewer:m.viewer,states:{manipulateState:c.State.NONE,preActivateState:c.State.NONE}};return l},unlink:function(l){if(this.links[l]){var m=this.links[l];if(m.node){if(m.node.setIsManipulator){m.node.setIsManipulator(false)}else{m.node.isManipulator=false}}else{if(m.path){m.path.getLastElement().setIsManipulator(false)}}if(this.deactivate(l)){delete this.links[l];return true}}return false},activate:function(n){if(n===undefined){return false}var w=this.links[n];if(!w){return false}if(w.viewer){w.viewer._addManipulator(this,n)}else{var o=w.node?w.node:w.path;var m=[];var q={};if(o instanceof f){m=o._getRenderableOccurrences()}else{for(var s=0;s<o._occurrences.length;s++){var v=o._occurrences[s]._getRenderableOccurrences();for(var r=0;r<v.length;r++){m.push(v[r])}}}for(var u=0;u<m.length;u++){var p=m[u];if(p._manipulators===undefined){p._manipulators={}}p._manipulators[n]=this;var y=p._occurrence;if(y&&y.scene3js&&y.scene3js.viewer&&y.scene3js.viewer.manipulatorManager){q[y.scene3js.viewer.id]=y.scene3js.viewer}}if(this._checkManipsWhenEnabled&&(w.states.manipulateState===c.State.NONE)){for(var l in q){var t=q[l];var x=THREEDS.VisuEventsManager.getMouseEvents(-1,t.canvas);if(!x.length){continue}t.manipulatorManager._onMove({from:[x[0]],viewer:t},true)}}}return true},deactivate:function(p){if(p===undefined){return false}var r=this.links[p];if(!r){return false}if(r.viewer){r.viewer._removeManipulator(p)}else{var n=r.node?r.node:r.path;var s=[];if(n instanceof f){s=n._getRenderableOccurrences()}else{for(var o=0;o<n._occurrences.length;o++){var m=n._occurrences[o]._getRenderableOccurrences();for(l=0;l<m.length;l++){s.push(m[l])}}}for(var l=0;l<s.length;l++){var q=s[l];if(q._manipulators&&q._manipulators[p]){delete q._manipulators[p]}}}return true},BeginManipulate:function(m,r,l){if(this.hasPriority&&r.viewer&&r.viewer.currentViewpoint&&r.viewer.currentViewpoint.control){r.viewer.currentViewpoint.control._onStopManip(r)}if(m){if(m instanceof f){this.manipulatedPaths.push(m)}else{for(var p=0;p<m._occurrences.length;p++){var n=m._occurrences[p];var s=new f();s.setFromOccurrence(n);var t=s._getRenderableOccurrences();for(var o=0;o<t.length;o++){var q=new f();q.setFromOccurrence(t[o]._occurrence);this.manipulatedPaths.push(q)}}}}},Manipulate:function(m,l,n){},EndManipulate:function(m,l,n){this.manipulatedPaths=[]},HandleLongHold:function(m,l){return false},PrimaryPointerClick:function(m,l,n){},PrimaryPointerDoubleClick:function(m,l,n){},BeginPreactivate:function(m,l,n){},Preactivate:function(m,l,n){},EndPreactivate:function(m,l,n){},onBeginManipulate:function(l){return this._modelEvent.subscribe({event:"BeginManipulate"},l)},onManipulate:function(l){return this._modelEvent.subscribe({event:"Manipulate"},l)},onEndManipulate:function(l){return this._modelEvent.subscribe({event:"EndManipulate"},l)},onBeginPreactivate:function(l){return this._modelEvent.subscribe({event:"BeginPreactivate"},l)},onPreactivate:function(l){return this._modelEvent.subscribe({event:"Preactivate"},l)},onEndPreactivate:function(l){return this._modelEvent.subscribe({event:"EndPreactivate"},l)},onPrimaryPointerClick:function(l){return this._modelEvent.subscribe({event:"PrimaryPointerClick"},l)},onPrimaryPointerDoubleClick:function(l){return this._modelEvent.subscribe({event:"PrimaryPointerDoubleClick"},l)},subscribe:function(l,m){return this._modelEvent.subscribe({event:l},m)},unsubscribe:function(l){this._modelEvent.unsubscribe(l)},publish:function(l,m){return this._modelEvent.publish({event:l,data:m,context:this})},DEPRECATED_CONSTRUCTOR:function(l){if(l&&l[0] instanceof THREEDS.WebGLV6Viewer){if(b>0){b--;console.log("[Manipulators] DEPRECATED Manipulator construction: "+(new Error()).stack)}return true}return false}});var b=50;c.State={NONE:0,BEGIN:1,MOVE:2,END:3};return UWA.namespace("THREEDS/Nodes/Manipulator",c)});define("Manipulators/Manipulator",["DS/Manipulators/Manipulator","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Manipulators/Manipulator");return b});define("DS/Manipulators/TrapSelectionManipulator",["DS/Manipulators/Manipulator"],function(b){var a=b.extend({init:function(c,d){this._parent(c);this.extremities={xPix:0,x:0,yPix:0,y:0};this.originPoint=null;this.startTime=null;this.divTrap=this.setupDivTrap(c.divTrap);this.noCursorChange=true;this.isActive=true;this.advancedSelection=d?true:false;this.forwardSelect=false},setAdvanced:function(c){this.advancedSelection=c;if(!c){this.setupDivTrap(this.divTrap);this.forwardSelect=false}},BeginManipulate:function(d,c,e){this.viewer.setCursor("TrapSelection",100);this.originPoint=this.viewer.getMousePosition(c.from[0].getCurrentPosition(this.viewer.canvas));this.setExtremities(this.originPoint);this.startTime=Date.now();this.manipIndex=0},Manipulate:function(d,c,f){var e=this.viewer.getMousePosition(c.from[0].getCurrentPosition(this.viewer.canvas));this.setExtremities(this.originPoint,e);if(this.divTrap){this.divTrap.show();this.divTrap.setStyles({width:(this.extremities.pt.xPix-this.extremities.xPix)/(window.devicePixelRatio||1),height:(this.extremities.pt.yPix-this.extremities.yPix)/(window.devicePixelRatio||1),left:(this.extremities.xPix)/(window.devicePixelRatio||1),top:(this.extremities.yPix)/(window.devicePixelRatio||1),pointerEvents:"none"})}},EndManipulate:function(d,c,e){this.viewer.setCursor("Auto");if(this.extremities&&this.divTrap){this.divTrap.hide();this.divTrap.setStyles({width:"0px",height:"0px",left:"0px",top:"0px",pointerEvents:"none"});this.viewer._doPickingFromMouseEvent(c.from[0],this.viewer.currentViewpoint.control,this)}this.setExtremities(null)},HandleLongHold:function(d,c){return true},setupDivTrap:function(c){c.setStyles({position:"absolute",opacity:"0.8",pointerEvents:"none",border:"1px dashed black",backgroundColor:"transparent"});c.hide();return c},setExtremities:function(h,g){if(!h){this.extremities=null;return}if(!g){this.extremities=h;return}var e={};var d={};var c=true;if(h.xPix<g.xPix){c=true;e.xPix=h.xPix;e.x=h.x;d.xPix=g.xPix;d.x=g.x}else{c=false;e.xPix=g.xPix;e.x=g.x;d.xPix=h.xPix;d.x=h.x}if(h.yPix<g.yPix){e.yPix=h.yPix;e.y=h.y;d.yPix=g.yPix;d.y=g.y}else{e.yPix=g.yPix;e.y=g.y;d.yPix=h.yPix;d.y=h.y}this.extremities=e;this.extremities.pt=d;if(this.advancedSelection&&this.divTrap&&this.forwardSelect!==c){var f;if(c){f={border:"2px solid #f5c77e",backgroundColor:"rgba(245, 200, 125, 0.5)"}}else{f={border:"2px dashed #75cdf0",backgroundColor:"rgba(117, 205, 240, 0.5)"}}this.divTrap.setStyles(f);this.forwardSelect=c}},getExtremities:function(){return this.extremities}});return a});define("DS/Manipulators/RotationManipulator",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator"],function(d,a,c){var b=c.extend({init:function(e){var f;if(this.DEPRECATED_CONSTRUCTOR(arguments)){f={axis:arguments[1]}}else{f=e||{}}this._parent();this.axis=f.axis;this.axis.normalize();this.centerPosition=new d.Vector3();this.fromCenterToInitial=new d.Vector3();this.plane=new d.Plane();this.projector=new d.Projector();return this},BeginManipulate:function(g,e,h){this._parent(g,e,h);this.initial3dIntersectionPoint=h.position;this.plane.setFromNormalAndCoplanarPoint(this.axis,this.initial3dIntersectionPoint);this.fromCenterToInitial.subVectors(this.initial3dIntersectionPoint,this.centerPosition);this.fromCenterToInitial.projectOnPlane(this.axis);this.fromCenterToInitial.normalize();var f={viewer:e.viewer,eventChannel:"BeginManipulate",event:e,paths:this.manipulatedPaths,intersection:h,manipulator:this};this.publish("BeginManipulate",f)},Manipulate:function(p,n,e){this._parent(p,n,e);var j=new d.Vector2().copy(n.from[0].getCurrentPosition(n.viewer.canvas));var m=n.viewer.currentViewpoint.create3DRayFrom2DPoint(j);var l=m.intersectPlane(this.plane);var g=new d.Vector3().subVectors(l,this.centerPosition);g.projectOnPlane(this.axis);g.normalize();var f=new d.Vector3();f.crossVectors(this.fromCenterToInitial,g);f.normalize();var h=this.fromCenterToInitial.angleTo(g);var o=new d.Matrix4().makeRotationAxis(f,h);var k={viewer:n.viewer,eventChannel:"Manipulate",event:n,paths:this.manipulatedPaths,rotationMatrix:o,angle:h,axis:f,center:this.centerPosition,intersection:e,manipulator:this};this.publish("Manipulate",k)},EndManipulate:function(p,n,e){var j=new d.Vector2().copy(n.from[0].getCurrentPosition(n.viewer.canvas));var m=n.viewer.currentViewpoint.create3DRayFrom2DPoint(j);var l=m.intersectPlane(this.plane);var g=new d.Vector3().subVectors(l,this.centerPosition);g.projectOnPlane(this.axis);g.normalize();var f=new d.Vector3();f.crossVectors(this.fromCenterToInitial,g);f.normalize();var h=this.fromCenterToInitial.angleTo(g);var o=new d.Matrix4().makeRotationAxis(f,h);var k={viewer:n.viewer,eventChannel:"EndManipulate",event:n,paths:this.manipulatedPaths,rotationMatrix:o,angle:h,axis:f,center:this.centerPosition,intersection:e,manipulator:this};this.publish("EndManipulate",k);this._parent(p,n,e)},setCenter:function(e){this.centerPosition=e},setAxis:function(e){this.axis=e},BeginPreactivate:function(f,e,h){var g={viewer:e.viewer,eventChannel:"BeginPreactivate",event:e,preactivated:this.preactivated,intersection:h,manipulator:this};this.publish("BeginPreactivate",g)},Preactivate:function(f,e,h){var g={viewer:e.viewer,eventChannel:"Preactivate",event:e,preactivated:this.preactivated,intersection:h,manipulator:this};this.publish("Preactivate",g)},EndPreactivate:function(f,e,h){var g={viewer:e.viewer,eventChannel:"EndPreactivate",event:e,preactivated:this.preactivated,intersection:h,manipulator:this};this.publish("EndPreactivate",g)},PrimaryPointerClick:function(f,e,h){var g={viewer:e.viewer,eventChannel:"PrimaryPointerClick",event:e,intersection:h,manipulator:this};this.publish("PrimaryPointerClick",g)},PrimaryPointerDoubleClick:function(f,e,h){var g={viewer:e.viewer,eventChannel:"PrimaryPointerDoubleClick",event:e,intersection:h,manipulator:this};this.publish("PrimaryPointerDoubleClick",g)}});return UWA.namespace("THREEDS/Nodes/RotationManipulator",b)});define("Manipulators/RotationManipulator",["DS/Manipulators/RotationManipulator","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Manipulators/RotationManipulator");return b});define("DS/Manipulators/PlaneTranslationManipulator",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator","DS/Visualization/PathElement"],function(c,a,b,e){var d=b.extend({init:function(f){var g;if(this.DEPRECATED_CONSTRUCTOR(arguments)){g={axis:arguments[1]}}else{g=f||{}}this._parent();this.axis=g.axis;this.axis.normalize();this.projector=new c.Projector();return this},BeginManipulate:function(h,f,j){this._parent(h,f,j);this.initial3dIntersectionPoint=j.position;this.plane=new c.Plane().setFromNormalAndCoplanarPoint(this.axis,j.position);var g={viewer:f.viewer,eventChannel:"BeginManipulate",event:f,paths:this.manipulatedPaths,intersection:j,manipulator:this};this.publish("BeginManipulate",g)},Manipulate:function(m,g,n){this._parent(m,g,n);var h=new c.Vector2().copy(g.from[0].getCurrentPosition(g.viewer.canvas));var f=g.viewer.currentViewpoint.create3DRayFrom2DPoint(h);var l=f.intersectPlane(this.plane);var j=new c.Vector3().subVectors(l,this.initial3dIntersectionPoint);j.projectOnPlane(this.axis);var k={viewer:g.viewer,eventChannel:"Manipulate",event:g,paths:this.manipulatedPaths,translationVector:j,intersection:n,manipulator:this};this.publish("Manipulate",k)},EndManipulate:function(m,g,n){var h=new c.Vector2().copy(g.from[0].getCurrentPosition(g.viewer.canvas));var f=g.viewer.currentViewpoint.create3DRayFrom2DPoint(h);var l=f.intersectPlane(this.plane);var j=new c.Vector3().subVectors(l,this.initial3dIntersectionPoint);j.projectOnPlane(this.axis);var k={viewer:g.viewer,eventChannel:"EndManipulate",event:g,paths:this.manipulatedPaths,translationVector:j,intersection:n,manipulator:this};this.publish("EndManipulate",k);this._parent(m,g,n)},BeginPreactivate:function(g,f,j){var h={viewer:f.viewer,eventChannel:"BeginPreactivate",event:f,preactivated:this.preactivated,intersection:j,manipulator:this};this.publish("BeginPreactivate",h)},Preactivate:function(g,f,j){var h={viewer:f.viewer,eventChannel:"Preactivate",event:f,preactivated:this.preactivated,intersection:j,manipulator:this};this.publish("Preactivate",h)},EndPreactivate:function(g,f,j){var h={viewer:f.viewer,eventChannel:"EndPreactivate",event:f,preactivated:this.preactivated,intersection:j,manipulator:this};this.publish("EndPreactivate",h)},PrimaryPointerClick:function(g,f,j){var h={viewer:f.viewer,eventChannel:"PrimaryPointerClick",event:f,intersection:j,manipulator:this};this.publish("PrimaryPointerClick",h)},PrimaryPointerDoubleClick:function(g,f,j){var h={viewer:f.viewer,eventChannel:"PrimaryPointerDoubleClick",event:f,intersection:j,manipulator:this};this.publish("PrimaryPointerDoubleClick",h)}});return UWA.namespace("THREEDS/Nodes/PlaneTranslationManipulator",d)});define("Manipulators/PlaneTranslationManipulator",["DS/Manipulators/PlaneTranslationManipulator","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Manipulators/PlaneTranslationManipulator");return b});define("DS/Manipulators/HandlePointManipulator",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator"],function(d,b,c){var a=c.extend({init:function(){if(this.DEPRECATED_CONSTRUCTOR(arguments)){}this._parent();return this},BeginManipulate:function(g,e,h){this._parent(g,e,h);var f={viewer:e.viewer,eventChannel:"BeginManipulate",event:e,paths:this.manipulatedPaths,intersection:h,manipulator:this};this.publish("BeginManipulate",f)},Manipulate:function(g,e,h){this._parent(g,e,h);var f={viewer:e.viewer,eventChannel:"Manipulate",event:e,paths:this.manipulatedPaths,intersection:h,manipulator:this};this.publish("Manipulate",f)},EndManipulate:function(g,e,h){var f={viewer:e.viewer,eventChannel:"EndManipulate",event:e,paths:this.manipulatedPaths,intersection:h,manipulator:this};this.publish("EndManipulate",f);this._parent(g,e,h)},BeginPreactivate:function(f,e,h){var g={viewer:e.viewer,eventChannel:"BeginPreactivate",event:e,preactivated:this.preactivated,intersection:h,manipulator:this};this.publish("BeginPreactivate",g)},Preactivate:function(f,e,h){var g={viewer:e.viewer,eventChannel:"Preactivate",event:e,preactivated:this.preactivated,intersection:h,manipulator:this};this.publish("Preactivate",g)},EndPreactivate:function(f,e,h){var g={viewer:e.viewer,eventChannel:"EndPreactivate",event:e,preactivated:this.preactivated,intersection:h,manipulator:this};this.publish("EndPreactivate",g)},PrimaryPointerClick:function(f,e,h){var g={viewer:e.viewer,eventChannel:"PrimaryPointerClick",event:e,intersection:h,manipulator:this};this.publish("PrimaryPointerClick",g)},PrimaryPointerDoubleClick:function(f,e,h){var g={viewer:e.viewer,eventChannel:"PrimaryPointerDoubleClick",event:e,intersection:h,manipulator:this};this.publish("PrimaryPointerDoubleClick",g)}});return UWA.namespace("THREEDS/Manipulators/HandlePointManipulator",a)});define("Manipulators/HandlePointManipulator",["DS/Manipulators/HandlePointManipulator","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Manipulators/HandlePointManipulator");return b});define("DS/VisuDataAccess/Ox4DECRunner",["DS/VisuDataAccess/Ox4TreeTarget","DS/VisuDataAccess/Ox4DECPlanRunner","DS/VisuDataAccess/Ox4TaskPlanner","DS/VisuDataAccess/Ox4ExpandTask","DS/VisuDataAccess/Ox4xMQLSelectTaskDefinition","DS/VisuDataAccess/Ox4DECSelectTask","DS/VisuDataAccess/Ox4PLMDataHelper","DS/VisuDataAccess/Ox4TicketGeneratorTask","DS/VisuDataAccess/Ox4TypeHelper"],function(g,a,c,k,d,b,e,h,l){function f(n){var m=new Object();if(typeof(n.serverdefinition.hostname)==="undefined"){console.log("checkAndEnrichSpecification:No Hostname in CreateServerDefinition");return null}m.hostname=n.serverdefinition.hostname;if(typeof(n.serverdefinition.rooturi)==="undefined"){console.log("checkAndEnrichSpecification:No RootUri in CreateServerDefinition");return null}m.rooturi=n.serverdefinition.rooturi;m.isSecure=false;if(typeof(n.serverdefinition.protocol)!="undefined"){if(n.serverdefinition.protocol==="https"){m.isSecure=true}}m.port=-1;if(typeof(n.serverdefinition.port)!="undefined"){m.port=n.serverdefinition.port}m.rawmode=n.rawmode;m.xmqlServiceUri=function(){var p="http://";if(this.isSecure){p="https://"}var o=p+this.hostname;if(this.port!=-1){o+=":"+this.port}o+="/"+this.rooturi+"/i3dx/services/xmql";if(typeof(m.rawmode)==="boolean"&&m.rawmode){o+="?raw=true"}return o};m.threedexpServiceUri=function(){var p="http://";if(this.isSecure){p="https://"}var o=p+this.hostname;if(this.port!=-1){o+=":"+this.port}o+="/"+this.rooturi;return o};n.serverdefinition=m;n.typeHelper=l;n.shapeType="CgrViewable";n.instanceType=n.dtype;return n}var j=function(m,n){var o=f(m);var p=new g(o,n);var r=null;var s=null;var v=null;var u=n;this.run=function(C,H,E){console.log("---> Entering Ox4DECRunner");r=C;s=H;v=E;console.log("---> Building a plan for");var D=o.expand;var y=new Array();if(D==="true"){var w=new q();var B=w.buildPlan(o,y);var G=new a(B,p,r,s,v);G.executePlan()}else{y[0]=o.physicalid}if(y.length==0){y[0]=o.physicalid}for(var A=0;A<y.length;A++){o.physicalid=y[A];var x=new t();var z=x.buildPlan(o);console.log("---> Plan Constructed ");var F=new a(z,p,r,s,v);F.executePlan()}};var q=function(){this.buildPlan=function(A,y){var D=new c();var B=A.physicalid;var z=A.dtype;var x=0;var H=new Array();H.push("physicalid");var F=function(J,K){for(var I=0;I<J.length;I++){y[x]=J[4]}x++};var C=new d(A.instanceType,H,F,3);var E=new b(C,A.serverdefinition,B);D.addSequentialTask(E);var w=function(I,J){console.log("Ox4DOSTaskPlannerForPhyIds::injectRowInto3")};var G=function(K){var I=K.rootNode();var J=K.findNodeByType(z);return{rootNode:I,geometryNodes:J}};D.addEndingTask(G);return D}};var t=function(){this.buildPlan=function(N){console.log("--->Ox4DOSPlanifier:Beginning BuildPlan");console.log(N);console.log("specification.physicalid"+N.physicalid);console.log("dtype:  "+N.dtype);var z=new c();var B=N.physicalid;var I="CGR";var E=N.dtype;var w="Viewable";var D=new k(N.physicalid,N.serverdefinition,w);z.addSequentialTask(D);var A={Fetch:new Array()};A.Fetch.push("physicalid");A.Fetch.push("attribute[LPAbstractInstance.V_matrix_1]");A.Fetch.push("attribute[LPAbstractInstance.V_matrix_2]");A.Fetch.push("attribute[LPAbstractInstance.V_matrix_3]");A.Fetch.push("attribute[LPAbstractInstance.V_matrix_4]");A.Fetch.push("attribute[LPAbstractInstance.V_matrix_5]");A.Fetch.push("attribute[LPAbstractInstance.V_matrix_6]");A.Fetch.push("attribute[LPAbstractInstance.V_matrix_7]");A.Fetch.push("attribute[LPAbstractInstance.V_matrix_8]");A.Fetch.push("attribute[LPAbstractInstance.V_matrix_9]");A.Fetch.push("attribute[LPAbstractInstance.V_matrix_10]");A.Fetch.push("attribute[LPAbstractInstance.V_matrix_11]");A.Fetch.push("attribute[LPAbstractInstance.V_matrix_12]");var J=function(Q,R){var P=R.findNodeByPhysicalId(Q[1]);var O=u("Matrix");O.set(Q[2],Q[5],Q[8],Q[11]*1000,Q[3],Q[6],Q[9],Q[12]*1000,Q[4],Q[7],Q[10],Q[13]*1000,0,0,0,1);P.setMatrix(O)};var y=new d(N.instanceType,A,J,0);var x=new b(y,N.serverdefinition,B);z.addSequentialTask(x);var C={Fetch:new Array()};C.Fetch.push("physicalid");C.Fetch.push("attribute[StreamDescriptors]");C.Fetch.push("format.file.store");C.Fetch.push("format["+I+"].file");var M=new e(N.serverdefinition);var L=function(T,U){var R=U.findNodeByPhysicalId(T[3]);var S=T[6];var Q=6;var P=S.split(":");var V="";if(P.length==1){V=P[0]}else{V=P[1]}if(V.search(" ")>=0){V='"'+V+'"'}var O=M.transformSelectedFileIntoTicketRequest(T[3],I,T[5],V);R.ticketRequest=new h(O,N.serverdefinition)};var G=new d(N.shapeType,C,L,1);var F=new b(G,N.serverdefinition,B);z.addSequentialTask(F);var K=function(O,P){console.log("injectRowInto3")};var H=function(Q){var O=Q.rootNode();var P=Q.findNodeByType(N.shapeType);return{rootNode:O,geometryNodes:P}};z.addEndingTask(H);console.log("--->Ox4DOSPlanifier:Beginning BuildPlan Done");return z}}};return j});define("VisuDataAccess/Ox4DECRunner",["DS/VisuDataAccess/Ox4DECRunner","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/Ox4DECRunner");return b});define("DS/Shaders/FXAAShader",["DS/Visualization/ThreeJS_DS"],function(a){var b={uniforms:{tDiffuse:{type:"t",value:null},resolution:{type:"v2",value:new a.Vector2(1/1024,1/512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",a._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","varying vec2 vUv;","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","void main() {","vec3 rgbNW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbNE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbSW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * resolution ).xyz;","vec3 rgbSE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * resolution ).xyz;","vec4 rgbaM  = texture2D( tDiffuse,  gl_FragCoord.xy  * resolution );","vec3 rgbM  = rgbaM.xyz;","float opacity  = rgbaM.w;","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float lumaNW = dot( rgbNW, luma );","float lumaNE = dot( rgbNE, luma );","float lumaSW = dot( rgbSW, luma );","float lumaSE = dot( rgbSE, luma );","float lumaM  = dot( rgbM,  luma );","float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","dir = min( vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),","max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),","dir * rcpDirMin)) * resolution;","vec3 rgbA = 0.5 * (","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * ( 1.0 / 3.0 - 0.5 ) ).xyz +","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * ( 2.0 / 3.0 - 0.5 ) ).xyz );","vec3 rgbB = rgbA * 0.5 + 0.25 * (","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * -0.5 ).xyz +","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * 0.5 ).xyz );","float lumaB = dot( rgbB, luma );","if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) ) {","gl_FragColor = vec4( rgbA, opacity );","} else {","gl_FragColor = vec4( rgbB, opacity );","}","}"].join("\n")};return b});define("Shaders/FXAAShader",["DS/Shaders/FXAAShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/FXAAShader");return b});define("DS/Manipulators/ScalingManipulator",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator"],function(c,a,b){var d=b.extend({init:function(e){var f;if(this.DEPRECATED_CONSTRUCTOR(arguments)){f={axis:arguments[1]}}else{f=e||{}}this._parent();this.axis=f.axis;this.axis.normalize();this.centerPosition=new c.Vector3();this.offset=0;this.projector=new c.Projector();this.scalingFactor=1;return this},BeginManipulate:function(g,e,h){this._parent(g,e,h);this.initial3dIntersectionPoint=new c.Vector3().copy(h.position);this.lastProjectionPoint3D=this.initial3dIntersectionPoint;this.initial3dIntersectionPointTranslated=new c.Vector3().copy(this.initial3dIntersectionPoint);this.initial3dIntersectionPointTranslated.add(this.axis);this.offset=new c.Vector3().subVectors(this.initial3dIntersectionPoint,this.centerPosition).length();var f={viewer:e.viewer,eventChannel:"BeginManipulate",event:e,paths:this.manipulatedPaths,intersection:h,manipulator:this};this.publish("BeginManipulate",f)},Manipulate:function(n,l,e){this._parent(n,l,e);var g=new c.Vector2().copy(l.from[0].getCurrentPosition(l.viewer.canvas));var k=l.viewer.currentViewpoint.create3DRayFrom2DPoint(g);this.lastProjectionPoint3D=k.computeShortestPointToLine(this.initial3dIntersectionPoint,this.initial3dIntersectionPointTranslated);var f=new c.Vector3().subVectors(this.lastProjectionPoint3D,this.initial3dIntersectionPoint);f.projectOnVector(this.axis);var j=f.dot(this.axis);var m=new c.Matrix4();if(this.offset>0){this.scalingFactor=Math.max((this.offset+j)/this.offset,0.1);m.setPosition(new c.Vector3().copy(this.centerPosition)).scale(new c.Vector3(this.scalingFactor,this.scalingFactor,this.scalingFactor)).multiply(new c.Matrix4().setPosition(new c.Vector3().copy(this.centerPosition).multiplyScalar(-1)))}var h={viewer:l.viewer,eventChannel:"Manipulate",event:l,paths:this.manipulatedPaths,scalingMatrix:m,scalingFactor:this.scalingFactor,center:this.centerPosition,intersection:e,manipulator:this};this.publish("Manipulate",h)},EndManipulate:function(g,e,h){this.scalingFactor=1;var f={viewer:e.viewer,eventChannel:"EndManipulate",event:e,paths:this.manipulatedPaths,intersection:h,manipulator:this};this.publish("EndManipulate",f);this._parent(g,e,h)},BeginPreactivate:function(f,e,h){var g={viewer:e.viewer,eventChannel:"BeginPreactivate",event:e,preactivated:this.preactivated,intersection:h,manipulator:this};this.publish("BeginPreactivate",g)},Preactivate:function(f,e,h){var g={viewer:e.viewer,eventChannel:"Preactivate",event:e,preactivated:this.preactivated,intersection:h,manipulator:this};this.publish("Preactivate",g)},EndPreactivate:function(f,e,h){var g={viewer:e.viewer,eventChannel:"EndPreactivate",event:e,preactivated:this.preactivated,intersection:h,manipulator:this};this.publish("EndPreactivate",g)},PrimaryPointerClick:function(f,e,h){var g={viewer:e.viewer,eventChannel:"PrimaryPointerClick",event:e,intersection:h,manipulator:this};this.publish("PrimaryPointerClick",g)},PrimaryPointerDoubleClick:function(f,e,h){var g={viewer:e.viewer,eventChannel:"PrimaryPointerDoubleClick",event:e,intersection:h,manipulator:this};this.publish("PrimaryPointerDoubleClick",g)},setCenter:function(e){this.centerPosition=e},setAxis:function(e){this.axis=e}});return UWA.namespace("THREEDS/Nodes/ScalingManipulator",d)});define("Manipulators/ScalingManipulator",["DS/Manipulators/ScalingManipulator","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Manipulators/ScalingManipulator");return b});define("DS/Effects/FXAAEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ShaderPass","DS/Shaders/FXAAShader"],function(d,a,c,e){var b=a.extend({init:function(f){this._parent(f);this.mixPass=new c(e,undefined,"FXAAEffect");return this},initEffect:function(f,g){g.insertComposer(null,this.mixPass)},update:function(g,f,h){},setSize:function(h,f){var g=this._parent(h,f);if(!g){return}this.mixPass.uniforms.resolution.value.set(1/h,1/f)}});return b});define("Effects/FXAAEffect",["DS/Effects/FXAAEffect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/FXAAEffect");return b});define("DS/Manipulators/LineTranslationManipulator",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator"],function(d,a,c){var b=c.extend({init:function(e){var f;if(this.DEPRECATED_CONSTRUCTOR(arguments)){f={axis:arguments[1]}}else{f=e||{}}this._parent();this.axis=f.axis;this.axis.normalize();this.projector=new d.Projector();return this},BeginManipulate:function(g,e,h){this._parent(g,e,h);this.initialPositionProjected=e.from[0].getCurrentPosition(e.viewer.canvas);this.initial3dIntersectionPoint=h.position;this.initial3dIntersectionPointTranslated=new d.Vector3().copy(this.initial3dIntersectionPoint);this.initial3dIntersectionPointTranslated.add(this.axis);var f={viewer:e.viewer,eventChannel:"BeginManipulate",event:e,paths:this.manipulatedPaths,intersection:h,manipulator:this};this.publish("BeginManipulate",f)},Manipulate:function(l,f,m){this._parent(l,f,m);var g=new d.Vector2().copy(f.from[0].getCurrentPosition(f.viewer.canvas));var e=f.viewer.currentViewpoint.create3DRayFrom2DPoint(g);var k=e.computeShortestPointToLine(this.initial3dIntersectionPoint,this.initial3dIntersectionPointTranslated);var h=new d.Vector3().subVectors(k,this.initial3dIntersectionPoint);var j={viewer:f.viewer,eventChannel:"Manipulate",event:f,paths:this.manipulatedPaths,translationVector:h,intersection:m,manipulator:this};this.publish("Manipulate",j)},EndManipulate:function(l,f,m){var g=new d.Vector2().copy(f.from[0].getCurrentPosition(f.viewer.canvas));var e=f.viewer.currentViewpoint.create3DRayFrom2DPoint(g);var k=e.computeShortestPointToLine(this.initial3dIntersectionPoint,this.initial3dIntersectionPointTranslated);var h=new d.Vector3().subVectors(k,this.initial3dIntersectionPoint);var j={viewer:f.viewer,eventChannel:"EndManipulate",event:f,paths:this.manipulatedPaths,translationVector:h,intersection:m,manipulator:this};this.publish("EndManipulate",j);this._parent(l,f,m)},BeginPreactivate:function(f,e,h){var g={viewer:e.viewer,eventChannel:"BeginPreactivate",event:e,preactivated:this.preactivated,intersection:h,manipulator:this};this.publish("BeginPreactivate",g)},Preactivate:function(f,e,h){var g={viewer:e.viewer,eventChannel:"Preactivate",event:e,preactivated:this.preactivated,intersection:h,manipulator:this};this.publish("Preactivate",g)},EndPreactivate:function(f,e,h){var g={viewer:e.viewer,eventChannel:"EndPreactivate",event:e,preactivated:this.preactivated,intersection:h,manipulator:this};this.publish("EndPreactivate",g)},PrimaryPointerClick:function(f,e,h){var g={viewer:e.viewer,eventChannel:"PrimaryPointerClick",event:e,intersection:h,manipulator:this};this.publish("PrimaryPointerClick",g)},PrimaryPointerDoubleClick:function(f,e,h){var g={viewer:e.viewer,eventChannel:"PrimaryPointerDoubleClick",event:e,intersection:h,manipulator:this};this.publish("PrimaryPointerDoubleClick",g)}});return UWA.namespace("THREEDS/Nodes/LineTranslationManipulator",b)});define("Manipulators/LineTranslationManipulator",["DS/Manipulators/LineTranslationManipulator","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Manipulators/LineTranslationManipulator");return b});define("DS/Manipulators/ScreenPlaneManipulator",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator","DS/Visualization/PathElement"],function(d,a,b,e){var c=b.extend({init:function(f){var g;if(this.DEPRECATED_CONSTRUCTOR(arguments)){g={cameraName:arguments[1]}}else{g=f||{}}this._parent();this.projector=new d.Projector();this.setCameraName(g.cameraName);return this},BeginManipulate:function(h,f,j){this._parent(h,f,j);this.initial3dIntersectionPoint=j.position;var g={viewer:f.viewer,eventChannel:"BeginManipulate",event:f,position:this.initial3dIntersectionPoint,paths:this.manipulatedPaths,intersection:j,manipulator:this};this.publish("BeginManipulate",g)},Manipulate:function(q,p,f){this._parent(q,p,f);var j=new d.Vector2().copy(p.from[0].getCurrentPosition(p.viewer.canvas));var o=p.viewer.currentViewpoint.create3DRayFrom2DPoint(j,p.viewer.currentViewpoint[this.cameraName]);var n=p.viewer.currentViewpoint[this.cameraName];var h=new d.Vector3().copy(n.getLookAt());var l=new d.Plane().setFromNormalAndCoplanarPoint(h.multiplyScalar(-1),this.initial3dIntersectionPoint);var m=o.intersectPlane(l);var g=new d.Vector3().subVectors(m,this.initial3dIntersectionPoint);var k={viewer:p.viewer,eventChannel:"Manipulate",event:p,paths:this.manipulatedPaths,translationVector:g,intersection:f,manipulator:this};this.publish("Manipulate",k)},EndManipulate:function(h,f,j){var g={viewer:f.viewer,eventChannel:"EndManipulate",event:f,paths:this.manipulatedPaths,intersection:j,manipulator:this};this.publish("EndManipulate",g);this._parent(h,f,j)},BeginPreactivate:function(g,f,j){var h={viewer:f.viewer,eventChannel:"BeginPreactivate",event:f,preactivated:this.preactivated,intersection:j,manipulator:this};this.publish("BeginPreactivate",h)},Preactivate:function(g,f,j){var h={viewer:f.viewer,eventChannel:"Preactivate",event:f,preactivated:this.preactivated,intersection:j,manipulator:this};this.publish("Preactivate",h)},EndPreactivate:function(g,f,j){var h={viewer:f.viewer,eventChannel:"EndPreactivate",event:f,preactivated:this.preactivated,intersection:j,manipulator:this};this.publish("EndPreactivate",h)},PrimaryPointerClick:function(g,f,j){var h={viewer:f.viewer,eventChannel:"PrimaryPointerClick",event:f,intersection:j,manipulator:this};this.publish("PrimaryPointerClick",h)},PrimaryPointerDoubleClick:function(g,f,j){var h={viewer:f.viewer,eventChannel:"PrimaryPointerDoubleClick",event:f,intersection:j,manipulator:this};this.publish("PrimaryPointerDoubleClick",h)},setCameraName:function(f){this.cameraName=f?f:"camera"}});return UWA.namespace("THREEDS/Nodes/ScreenPlaneManipulator",c)});define("Manipulators/ScreenPlaneManipulator",["DS/Manipulators/ScreenPlaneManipulator","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Manipulators/ScreenPlaneManipulator");return b});define("DS/Gestures/PunctualSwipeGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(c,a,d){var b=d.extend({init:function(){this._parent("PunctualSwipe");return this},detect:function(e){this._parent(e);switch(this.state){case d.State.INIT:case d.State.BEGIN:case d.State.CHANGE:case d.State.KO:case d.State.OK:case d.State.CANCEL:default:break}}});return UWA.namespace("THREEDS/Gestures/PunctualSwipeGesture",b)});define("Gestures/PunctualSwipeGesture",["DS/Gestures/PunctualSwipeGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/PunctualSwipeGesture");return b});define("DS/Effects/CompareModelsEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ComposerContext","DS/Plugins/ClearPass","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/CompareModelsShader"],function(e,c,a,h,b,d,g){var f=c.extend({init:function(k,j){this._parent(k);this.mixPass=new d(g,undefined,"compareModelPass");this.mixPass.compileShader(k);this.tolerance=0.0001;this.composerEffects=[];this.forwardContext=null;this.passClearOld=null;this.passColorOld=null;this.passDepthOld=null;this.passDepthNew=null;this.passAll=null;this.passSectionCappingFrontFaces1=null;this.passSectionCappingFrontFaces2=null;this.passSectionCappingFrontFaces3=null;this.v6renderer=null;this.forwardPass=null;return this},initEffect:function(t,r){var l=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");l.generateMipmaps=false;var m=new a(l,r.mainComposer,"colorOldComposerContext");m.keepResult=true;var j=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");j.generateMipmaps=false;var u=new a(j,r.mainComposer,"depthOldComposerContext");u.keepResult=true;var p=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");p.generateMipmaps=false;var q=new a(p,r.mainComposer,"depthNewComposerContext");q.keepResult=true;this.composerEffects.push(m);this.composerEffects.push(u);this.composerEffects.push(q);r.customComposerContexts=[];r.customComposerContexts[0]=m;r.customComposerContexts[1]=u;r.customComposerContexts[2]=q;var o=new h("depth_clear_old");o.clearColor=new e.Color(0);o.clearAlpha=0;o.disabledByDefault=true;this.passClearOld=o;var v=new b(null,null,null,true,false,false,"color_old");v.idString="compareOld";v.disabledByDefault=true;this.passColorOld=v;var s=new b(null,null,null,true,false,false,"depth_old");s.idString="compareOld";s.disabledByDefault=true;s.setMaterialToUse(e.MaterialToUse.normalDepthMaterial);this.passDepthOld=s;var k=new b(null,null,null,true,false,false,"depth_new");k.idString="compareNew";k.disabledByDefault=true;k.setMaterialToUse(e.MaterialToUse.normalDepthMaterial);this.passDepthNew=k;var n=new b(null,null,null,true,false,false,"all_models");n.disabledByDefault=true;this.passAll=n;this.passSectionCappingFrontFaces1=new b(null,null,null,true,false,false,"colorOldCapping");this.passSectionCappingFrontFaces1.setRenderCuttingElements(true);this.passSectionCappingFrontFaces1.idString="compareOld";this.passSectionCappingFrontFaces1.setEnableStencilTest(true);this.passSectionCappingFrontFaces1.setEnableStencilWrite(true);this.passSectionCappingFrontFaces1.setDisableColorWrite(true);this.passSectionCappingFrontFaces1.setDisableDepthWrite(true);this.passSectionCappingFrontFaces1.setStencilFunc("ALWAYS");this.passSectionCappingFrontFaces1.setStencilOps("INCR_WRAP","DECR_WRAP");this.passSectionCappingFrontFaces1.setDisableBackFaceCulling(true);this.passSectionCappingFrontFaces1.setHideSurfacesAndUnclippedMeshes(true);this.passSectionCappingFrontFaces1.setDisableBackFaceClipPlanes(+1);this.passSectionCappingFrontFaces1.setRenderPluginsPre(false);this.passSectionCappingFrontFaces1.setRenderPluginsPost(false);this.passSectionCappingFrontFaces1.ignoreNoZ=true;this.passSectionCappingFrontFaces1.scene=r.scene;this.passSectionCappingFrontFaces1.disabledByDefault=true;this.passSectionCappingFrontFaces2=new b(null,null,null,true,false,false,"depthOldCapping");this.passSectionCappingFrontFaces2.setRenderCuttingElements(true);this.passSectionCappingFrontFaces2.idString="compareOld";this.passSectionCappingFrontFaces2.setEnableStencilTest(true);this.passSectionCappingFrontFaces2.setEnableStencilWrite(true);this.passSectionCappingFrontFaces2.setDisableColorWrite(true);this.passSectionCappingFrontFaces2.setDisableDepthWrite(true);this.passSectionCappingFrontFaces2.setStencilFunc("ALWAYS");this.passSectionCappingFrontFaces2.setStencilOps("INCR_WRAP","DECR_WRAP");this.passSectionCappingFrontFaces2.setDisableBackFaceCulling(true);this.passSectionCappingFrontFaces2.setHideSurfacesAndUnclippedMeshes(true);this.passSectionCappingFrontFaces2.setDisableBackFaceClipPlanes(+1);this.passSectionCappingFrontFaces2.setRenderPluginsPre(false);this.passSectionCappingFrontFaces2.setRenderPluginsPost(false);this.passSectionCappingFrontFaces2.ignoreNoZ=true;this.passSectionCappingFrontFaces2.scene=r.scene;this.passSectionCappingFrontFaces2.setMaterialToUse(e.MaterialToUse.normalDepthMaterial);this.passSectionCappingFrontFaces2.disabledByDefault=true;this.passSectionCappingFrontFaces3=new b(null,null,null,true,false,false,"depthNewCapping");this.passSectionCappingFrontFaces3.setRenderCuttingElements(true);this.passSectionCappingFrontFaces3.idString="compareNew";this.passSectionCappingFrontFaces3.setEnableStencilTest(true);this.passSectionCappingFrontFaces3.setEnableStencilWrite(true);this.passSectionCappingFrontFaces3.setDisableColorWrite(true);this.passSectionCappingFrontFaces3.setDisableDepthWrite(true);this.passSectionCappingFrontFaces3.setStencilFunc("ALWAYS");this.passSectionCappingFrontFaces3.setStencilOps("INCR_WRAP","DECR_WRAP");this.passSectionCappingFrontFaces3.setDisableBackFaceCulling(true);this.passSectionCappingFrontFaces3.setHideSurfacesAndUnclippedMeshes(true);this.passSectionCappingFrontFaces3.setDisableBackFaceClipPlanes(+1);this.passSectionCappingFrontFaces3.setRenderPluginsPre(false);this.passSectionCappingFrontFaces3.setRenderPluginsPost(false);this.passSectionCappingFrontFaces3.ignoreNoZ=true;this.passSectionCappingFrontFaces3.scene=r.scene;this.passSectionCappingFrontFaces3.setMaterialToUse(e.MaterialToUse.normalDepthMaterial);this.passSectionCappingFrontFaces3.disabledByDefault=true;r.mainComposer.insertCustomPassAfterPass(o,null);r.mainComposer.insertCustomPassAfterPass(v,o);r.mainComposer.insertCustomPassAfterPass(this.passSectionCappingFrontFaces1,v);r.mainComposer.insertCustomPassAfterPass(s,this.passSectionCappingFrontFaces1);r.mainComposer.insertCustomPassAfterPass(this.passSectionCappingFrontFaces2,s);r.mainComposer.insertCustomPassAfterPass(k,this.passSectionCappingFrontFaces2);r.mainComposer.insertCustomPassAfterPass(this.passSectionCappingFrontFaces3,k);r.mainComposer.insertCustomPassAfterPass(n,this.passSectionCappingFrontFaces3);this.v6renderer=r;this.forwardContext=r.compForwardComposerContext;this.forwardPass=r.forwardPass;r.insertComposer(null,this.mixPass);m.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tCommonColor);u.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDepthOld);q.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDepthNew)},update:function(l,k,n){var j=this.v6renderer.clippingScene?true:false;this.composerEffects[0].enablePass(this.passSectionCappingFrontFaces1,j);this.composerEffects[1].enablePass(this.passSectionCappingFrontFaces2,j);this.composerEffects[2].enablePass(this.passSectionCappingFrontFaces3,j);var m=n._renderedCamera;m.projectionMatrixInverse.getInverse(m.projectionMatrix);this.mixPass.uniforms.realProjectionMatrixInverse.value=m.projectionMatrixInverse;this.mixPass.uniforms.tolerance.value=this.tolerance},setTolerance:function(j){this.tolerance=j},setSize:function(m,j){var l=this._parent(m,j);if(!l){return}for(var k=0;k<this.composerEffects.length;k++){this.composerEffects[k].setSize(m,j)}},setEnabled:function(j){this._parent(j);var k=this.v6renderer.clippingScene?true:false;this.composerEffects[0].setPassClear(this.passClearOld,j);this.composerEffects[0].setPassClearDepth(this.passClearOld,j);this.composerEffects[0].enablePass(this.passClearOld,j);this.composerEffects[0].enablePass(this.passColorOld,j);this.composerEffects[0].enablePass(this.passSectionCappingFrontFaces1,k&&j);this.composerEffects[1].enablePass(this.passDepthOld,j);this.composerEffects[1].enablePass(this.passSectionCappingFrontFaces2,k&&j);this.composerEffects[2].enablePass(this.passDepthNew,j);this.composerEffects[2].enablePass(this.passSectionCappingFrontFaces3,k&&j);for(var l=0;l<3;l++){this.composerEffects[l].enablePass(this.forwardPass,false);this.composerEffects[l].needsUpdate=j;this.composerEffects[l].enablePass(this.v6renderer.infPlanePass,false);this.composerEffects[l].enablePass(this.v6renderer.mirrorBlendPass,false)}},});return f});define("Effects/CompareModelsEffect",["DS/Effects/CompareModelsEffect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/CompareModelsEffect");return b});define("DS/Effects/ToneMappingEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/CompositeShader","DS/Shaders/BloomShaders","DS/Plugins/ClearPass"],function(e,b,f,d,g,a,h){var c=b.extend({init:function(l,k){this._parent(l);this.renderer=l;this.rtPool=k;this.defines={TONEMAP_SIMPLE:true};this.tonemapping=1;this.brightness=0;this.passThreshold=null;this._initBloom=false;this.bloom=0;this.nbIterations=5;this.threshold=0.626;this.mixPass=new d(g,undefined,"compositePass");this.mixPass.material.blending=e.NoBlending;this.mixPass.gammaCorrectionPass=true;this.passBlurH=null;this.passBlurV=null;var j=new e.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint");this.mixPass.changeRenderTargetProperties=j;return this},initEffect:function(j,k){k.insertComposer(null,this.mixPass)},update:function(k,j,l){},setBloom:function(j){if(this.bloom!==j){this.bloom=j?1:0;this.defines.USE_BLOOM=this.bloom;this.mixPass.material.defines=this.defines;this.mixPass.material.needsUpdate=true;this.mixPass.requiredComposers=[];if(j){this._buildBloomRT();this.mixPass.addRequiredComposer(this.composers[5])}}},setToneMapping:function(j){var k={USE_BLOOM:this.bloom};this.tonemapping=j;switch(j){case 1:k.TONEMAP_SIMPLE=true;break;case 2:k.TONEMAP_LINEAR=true;break;case 3:k.TONEMAP_REINHARD=true;break;case 4:k.TONEMAP_FILMIC=true;break;case 5:k.TONEMAP_UNCHARTED=true;break;case 6:k.TONEMAP_FILMIC_NRE=true;break;case 7:k.TONEMAP_FILMIC_NRE_APPROXIMATE=true;break;case 8:k.TONEMAP_PHOTOGRAPHIC_NRE=true;break;case 9:k.TONEMAP_LINEAR_NRE=true;break;default:break}this.defines=k;this.mixPass.material.defines=k;this.mixPass.material.needsUpdate=true},setGamma:function(j){this.mixPass.uniforms.gamma.value=j},setBrightness:function(j){this.brightness=j;this.mixPass.uniforms.brightness.value=j},setBloomFactor:function(j){this.mixPass.uniforms.bloomFactor.value=j},setBloomThreshold:function(j){if(this.passThreshold){this.passThreshold.uniforms.threshold.value=j}},setSize:function(m,j){var l=this._parent(m,j);if(!l){return}if(!this.bloom){return}var k,n=0.5;this.composers[0].setSize(n*this.width,n*this.height);for(k=1;k<=this.nbIterations;k++){this.composers[k].setSize(n*this.width,n*this.height);this.passBlurH[k].uniforms.invSize.value.set(1/(n*this.width),1/(n*this.height));this.passBlurV[k].uniforms.invSize.value.set(1/(n*this.width),1/(n*this.height));n*=0.5}},_buildBloomRT:function(l){if(this._initBloom){return}this._initBloom=true;var m=0.5;this.passBlurH=[];this.passBlurV=[];var j=new e.WebGLRenderTargetProperties(m*this.width,m*this.height,"uint");this.composers[0]=new f(this.renderer,j,this.rtPool);this.passThreshold=new d(a.Threshold);this.passThreshold.uniforms.threshold.value=this.threshold;this.composers[0].addPass(this.passThreshold);for(var k=1;k<=this.nbIterations;k++){var j=new e.WebGLRenderTargetProperties(m*this.width,m*this.height,"uint");this.composers[k]=new f(this.renderer,j,this.rtPool);this.passBlurH[k]=new d(a.BlurH2);this.passBlurV[k]=new d(a.BlurV);this.passBlurH[k].material.defines={LEVEL:k};this.passBlurV[k].material.defines={LEVEL:k};this.passBlurH[k].uniforms.invSize.value.set(1/(m*this.width),1/(m*this.height));this.passBlurV[k].uniforms.invSize.value.set(1/(m*this.width),1/(m*this.height));this.passBlurH[k].material.needsUpdate=true;this.passBlurV[k].material.needsUpdate=true;this.composers[k].addPass(this.passBlurH[k]);this.composers[k].addPass(this.passBlurV[k]);m*=0.5}this.passBlurH[1].addRequiredComposer(this.composers[0]);this.passBlurH[2].addRequiredComposer(this.composers[1]);this.passBlurH[3].addRequiredComposer(this.composers[2]);this.passBlurH[4].addRequiredComposer(this.composers[3]);this.passBlurH[5].addRequiredComposer(this.composers[4]);var n=this;this.mixPass.beforeRenderCB=function(o){n.passThreshold.uniforms.tDiffuse2.value=o};this.composers[0].linkToShaderPassUniform(this.passBlurH[1],this.passBlurH[1].uniforms.tDiffuse2);this.composers[1].linkToShaderPassUniform(this.passBlurH[2],this.passBlurH[2].uniforms.tDiffuse2);this.composers[2].linkToShaderPassUniform(this.passBlurH[3],this.passBlurH[3].uniforms.tDiffuse2);this.composers[3].linkToShaderPassUniform(this.passBlurH[4],this.passBlurH[4].uniforms.tDiffuse2);this.composers[4].linkToShaderPassUniform(this.passBlurH[5],this.passBlurH[5].uniforms.tDiffuse2);this.composers[1].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2);this.composers[2].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse3);this.composers[3].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse4);this.composers[4].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse5);this.composers[5].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse6)}});return c});define("DS/Plugins/UserRenderPass",["DS/Plugins/UserPass","DS/Plugins/RenderPass"],function(a,d){function c(e){return e?true:false}"use strict";var b=a.extend({init:function(f){this._parent(f);var e=new d(null,null,null,null,null,null,"_UserRenderPass_"+this.id+"_"+this.name);this._passes.push(e)},setDisableColorWrite:function(e){this._passes[0].setDisableColorWrite(c(e))},setDisableDepthWrite:function(e){this._passes[0].setDisableDepthWrite(c(e))},setDisableBackFaceCulling:function(e){this._passes[0].setDisableBackFaceCulling(c(e))},setEnableStencilWrite:function(e){this._passes[0].setEnableStencilWrite(c(e))},setEnableStencilTest:function(e){this._passes[0].setEnableStencilTest(c(e))},setStencilOps:function(f,e){this._passes[0].setStencilOps(f,e)},setStencilOpsSeparate:function(h,e,g,f){this._passes[0].setStencilOpsSeparate(h,e,g,f)},setStencilFunc:function(e){this._passes[0].setStencilFunc(e)},setCullFaceMode:function(e){this._passes[0].setCullFaceMode(e)},setDepthFunc:function(e){this._passes[0].setDepthFunc(e)},});return b});define("DS/Shaders/MSAAShaders",["DS/Visualization/ThreeJS_DS"],function(c){var b={uniforms:{tDiffuse:{type:"t",value:null},prevMap:{type:"t",value:null},numIteration:{type:"f",value:0},},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",c._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D prevMap;","uniform float numIteration;","varying vec2 vUv;","void main() {","vec4 prevColor = texture2D( prevMap, vUv );","vec4 currColor = texture2D( tDiffuse, vUv );","gl_FragColor = vec4((prevColor * numIteration + currColor) / (numIteration + 1.0));","}"].join("\n")};var a={uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",c._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse2;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse2, vUv );","}"].join("\n")};return{Blending:b,Transfer:a}});define("DS/Shaders/ConvertLatLongToDualParaboloidShader",["DS/Visualization/ThreeJS_DS"],function(b){var a=function(d){var c={defines:{SCALE:1.2},uniforms:{map:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D map;","varying vec2 vUv;","const float PI = 3.14159265358979323846264;","float atan2(float y, float x) {","if (x > 0.0) return sign(y) * atan(abs(y/x));","else if (x < 0.0) return sign(y) * (PI - atan(abs(y/x)));","return 0.5 * PI * sign(y);","}","vec4 texture2DFromRGBE(sampler2D textureSampler, vec2 uv) {","vec4 texelRGBE = texture2D(textureSampler, uv);","float exponent = pow(2.0, 255.0 * texelRGBE.w - 128.0);","return vec4((255.0 / 256.0) * texelRGBE.xyz * exponent, 1.0);","}","vec4 texture2DBilinearFromRGBE(sampler2D textureSampler, vec2 uv, vec2 textureSize, vec2 texelSize) {","vec4 tl = texture2DFromRGBE(textureSampler, uv);","vec4 tr = texture2DFromRGBE(textureSampler, uv + vec2(texelSize.x, 0.0));","vec4 bl = texture2DFromRGBE(textureSampler, uv + vec2(0.0, texelSize.y));","vec4 br = texture2DFromRGBE(textureSampler, uv + vec2(texelSize.x, texelSize.y));","vec2 f = fract(uv.xy * textureSize.xy);","vec4 tA = mix(tl, tr, f.x);","vec4 tB = mix(bl, br, f.x);","return mix(tA, tB, f.y);","}","void main() {","gl_FragColor = vec4(0.0);","vec2 uv = vec2(fract(2.0 * vUv.x), vUv.y);","float phi = atan2(2.0 * uv.y - 1.0, 2.0 * uv.x - 1.0);","float theta;","float u;","if (vUv.x < 0.5) {","theta = 2.0 * atan(cos(phi) / (SCALE * (2.0 * uv.x - 1.0)));","u = fract(0.5*phi / PI);","} else {","theta = 2.0 * atan(SCALE * (1.0 - 2.0 * uv.x) / cos(phi));","phi += 1.0*PI;","u = fract(0.5*phi / PI);","}","float v = abs(theta / PI);"].join("\n")};if(d){c.fragmentShader=[c.fragmentShader,"gl_FragColor = texture2DBilinearFromRGBE(map, vec2(u, v), vec2(2048.0, 1024.0), vec2(1.0/2048.0, 1.0/1024.0));","}"].join("\n")}else{c.fragmentShader=[c.fragmentShader,"gl_FragColor = texture2D(map, vec2(u, v));","}"].join("\n")}return c};return{ConvertLatLongRGBEToDualParaboloid:a(true),ConvertLatLongToDualParaboloid:a(false)}});define("DS/Gestures/FlickGesture",["DS/Gestures/BasicGesture"],function(b){var a=b.extend({init:function(){this._parent();this.priority=100;this.name="FlickGesture";return this},detect:function(c){this._parent(c)}});return UWA.namespace("THREEDS/Gestures/FlickGesture",a)});define("Gestures/FlickGesture",["DS/Gestures/FlickGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/FlickGesture");return b});define("DS/Effects/MSAAEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/MSAAShaders","DS/Shaders/NothingShader"],function(e,f,a,h,d,c,g){var b=a.extend({init:function(q,p){this._parent(q);var o=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");o.generateMipmaps=false;this.composers[0]=new h(q,o,p);this.composers[0].composerContext.keepResult=true;this.passBlend=new d(c.Blending);var n=new d(g);this.composers[0].addPass(this.passBlend);this.composers[0].addPass(n);this.mixPass=new d(c.Transfer,undefined,"MSAAEffect");this.tmpResult=null;this.renderTargetPool=p;var k=new Uint8Array(2*2*4);for(var l=0;l<2*2;l++){k[4*l]=0;k[4*l+1]=0;k[4*l+2]=0;k[4*l+3]=255}this.initTexture=new e.DataTexture(k,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping(),e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter);this.initTexture.generateMipmaps=false;this.initTexture.needsUpdate=true;this.renderer.setTexture(this.initTexture,0);this.maxIteration=128;this.msaaOffset=[];for(var m=0;m<this.maxIteration;m++){var r=e.RandomLib.LowDiscrepancy2D(m);this.msaaOffset.push({x:r.x-0.5,y:r.y-0.5})}return this},initEffect:function(j,k){k.insertComposer(null,this.mixPass);this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2);this.mixPass.addRequiredComposer(this.composers[0])},update:function(k,j,l,m){m=m-1;this.passBlend.uniforms.numIteration.value=m;this.passBlend.uniforms.prevMap.value=!m?this.initTexture:this.composers[0].composerContext.renderTarget2;var n=this;this.mixPass.beforeRenderCB=function(o){if(m===0){n.passBlend.uniforms.prevMap.value=n.initTexture}else{if(m>0){n.tmpResult=n.composers[0].composerContext.getResult("main",true);n.passBlend.uniforms.prevMap.value=n.tmpResult}}};this.mixPass.afterRenderCB=function(){if(n.tmpResult){n.renderTargetPool.pushRenderTarget(n.tmpResult);n.tmpResult=null}};if(m>=this.getMaxIteration()){this.mixPass.requiredComposers=[]}else{if(!this.mixPass.requiredComposers.length){this.mixPass.addRequiredComposer(this.composers[0])}}},getMaxIteration:function(){return this.maxIteration},computeJitterCamera:function(j,l){var m=j.clone();var k=Math.min(this.getMaxIteration()-1,l);m.updateProjectionMatrix(this.msaaOffset[k].x/this.width,this.msaaOffset[k].y/this.height);return m},computeJitterValues:function(j,l){var k=Math.min(this.getMaxIteration()-1,l);return new e.Vector2(this.msaaOffset[k].x/this.width,this.msaaOffset[k].y/this.height)},setSize:function(l,j){var k=this._parent(l,j);if(!k){return}this.composers[0].setSize(this.width,this.height)}});return b});define("DS/Effects/ConvertLatLongToDualParaboloid",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/ConvertLatLongToDualParaboloidShader","DS/Shaders/DisplayIrradianceMapShader"],function(e,b,g,d,c,a){var f=b.extend({init:function(j,h){this._parent(j);this.gl=this.renderer.context;this.renderTargetPool=h;this.passConvert=null;this.texture=null;this.passDualParaboloidMap=null;return this},setSize:function(j,h){this.width=(typeof j==="string")?parseInt(j):j;this.height=(typeof h==="string")?parseInt(h):h},setEnvMap:function(m){this.texture=m;if(this.texture instanceof e.Texture){var k=parseInt(this.texture.image.width);var h=parseInt(this.texture.image.height);this.width=k;this.height=h}if(this.composers[1]){this.composers[1].setSize(this.width,this.height)}else{var l=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");l.generateMipmaps=false;l.mapping=e.LatLongReflectionMapping;this.composers[1]=new g(this.renderer,l,this.renderTargetPool);this.composers[1].composerContext.keepResult=true;this.composers[1].composerContext.noIdCheck=true;var j=c.ConvertLatLongToDualParaboloid;if(this.texture instanceof e.Texture){j=c.ConvertLatLongRGBEToDualParaboloid}this.passConvert=new d({defines:{SCALE:1.2},uniforms:j.uniforms,vertexShader:j.vertexShader,fragmentShader:j.fragmentShader},undefined,"Convert");this.composers[1].addPass(this.passConvert)}if(this.texture instanceof e.Texture){this.passConvert.uniforms.map.value=this.texture}else{this.texture.linkToShaderPassUniform(this.passConvert,this.passConvert.uniforms.map)}if(this.composers[0]){this.composers[0].setSize(this.width,this.height)}else{var l=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");l.generateMipmaps=false;l.mapping=e.LatLongReflectionMapping;this.composers[0]=new g(this.renderer,l,this.renderTargetPool);this.composers[0].composerContext.keepResult=false;this.composers[0].composerContext.noIdCheck=true;this.passDualParaboloidMap=new d(a,undefined,"DisplayConvert");this.composers[0].composerContext.setPassRenderToCanvas(this.passDualParaboloidMap,true);this.composers[0].addPass(this.passDualParaboloidMap);this.composers[1].linkToShaderPassUniform(this.passDualParaboloidMap,this.passDualParaboloidMap.uniforms.tDiffuse1)}},execute:function(){this.composers[1].render()}});return f});define("DS/VisuUnstreamers/XMLMaterialUnstreamTask",["UWA/Class","WebappsUtils/WebappsUtils","DS/VisuUnstreamers/FileInZipStreamObject","DS/Mesh/MeshUtils","DS/Visualization/MaterialManager"],function(c,g,d,h,b){var e=0;var a=false;var f=c.extend({init:function(k,l){this.id=e++;this.streamObject=k;this.materialLibrary=l;this.materialRefId=-1;var j=this.streamObject?this.streamObject.getUserData():null;if(j&&!j.materialLibraryFiles){j.materialLibraryFiles={};j.graphicMaterialFiles={};j.imageLibraryFiles={};j.imageFiles={}}return this},run:function(o,k,m){if(this.materialRefId===-1){return}if(a){console.log("("+this.id+") running XMLMaterialUnstreamTask : materialRef <"+this.streamObject.filename+"> - id <"+this.materialRefId+">")}var n=this;var j=this.streamObject.getUserData();var l=j.materialLibraryFiles[this.streamObject.filename];if(!l){j.materialLibraryFiles[this.streamObject.filename]={state:"pending",tasks:[]};this.streamObject.open();if(a){console.log("("+this.id+") begin read material library "+this.streamObject.filename+" as XML")}this.streamObject.readAsXML(function(s){n.streamObject.close();if(a){console.log("("+n.id+") parse material library "+n.streamObject.filename)}var r=j.materialLibraryFiles[n.streamObject.filename];j.materialLibraryFiles[n.streamObject.filename]=n.parseMaterialReference(s);for(var q=0;q<r.tasks.length;q++){var p=r.tasks[q];if(a){console.log("("+p.task.id+") task start again after material library read (relaunched by task ("+n.id+"))")}p.cb.apply(p.task,p.args)}n.loadGraphicMaterial(o,k)})}else{if(l.state==="pending"){if(a){console.log("("+this.id+") task waiting for material library: "+n.streamObject.filename)}l.tasks.push({task:this,cb:this.loadGraphicMaterial,args:[o,k]})}else{this.loadGraphicMaterial(o,k)}}},parseMaterialReference:function(x){var w={};var s=x.firstChild;if(s.nodeName!=="Model_3dxml"){return}for(var t=0;t<s.childNodes.length;t++){var n=s.childNodes[t];if(n.nodeName=="CATMaterialRef"){for(var q=0;q<n.childNodes.length;q++){var u=n.childNodes[q];if((u.nodeName!=="CATMatReference")&&(u.nodeName!=="MaterialDomainInstance")&&(u.nodeName!=="MaterialDomain")){continue}var m=u.getAttribute("id");var l=u.getAttribute("name");switch(u.nodeName){case"CATMatReference":if(w[m]!==undefined){w[m].name=l}else{w[m]={name:l}}break;case"MaterialDomainInstance":var v=0;var z=0;for(var p=0;p<u.childNodes.length;p++){var r=u.childNodes[p];if(r.nodeName=="IsAggregatedBy"){v=r.textContent}else{if(r.nodeName=="IsInstanceOf"){z=r.textContent}}}w[m]={parent:v,instance:z};if(w[v]!==undefined){w[v].instance=m}else{w[v]={instance:m}}break;case"MaterialDomain":var o=u.getAttribute("associatedFile");var y=[];y=o.split("urn:3DXML:");o=y[1];if(w[m]!==undefined){w[m].filename=o}else{w[m]={filename:o}}break;default:break}}}}return w},loadGraphicMaterial:function(m,p){var o=this;var l=this.streamObject.getUserData();var q=l.materialLibraryFiles[this.streamObject.filename];var s=q[this.materialRefId];if(s===undefined){return null}var k=q[s.instance];if(k===undefined){return null}var r=q[k.instance];if(r===undefined){return null}if(r.filename){var j=l.graphicMaterialFiles[r.filename];if(!j){l.graphicMaterialFiles[r.filename]={state:"pending",tasks:[]};var n=new d(this.streamObject.blob,r.filename);n.open();if(a){console.log("("+this.id+") begin read material "+r.filename+" as XML")}n.readAsXML(function(w){n.close();if(a){console.log("("+o.id+") parse material "+r.filename)}var v=l.graphicMaterialFiles[r.filename];l.graphicMaterialFiles[r.filename]=o.parseGraphicMaterial(w);for(var u=0;u<v.tasks.length;u++){var t=v.tasks[u];if(a){console.log("("+t.task.id+") task start again after material read (relaunched by task ("+o.id+"))")}t.cb.apply(t.task,t.args)}o.loadRepresentationImage(r.filename,m,p)})}else{if(j.state==="pending"){if(a){console.log("("+this.id+") task waiting for material: "+r.filename)}j.tasks.push({task:this,cb:this.loadRepresentationImage,args:[r.filename,m,p]})}else{this.loadRepresentationImage(r.filename,m,p)}}}},parseGraphicMaterial:function(u){var o={type:"material3DXML"};o.shading="Phong";o.DiffuseMapWrap=[];o.DiffuseMapRepeat=[0,0];var q=u.firstChild;if(q.nodeName!=="Osm"){return}for(var r=0;r<q.childNodes.length;r++){var m=q.childNodes[r];if((m.nodeName=="Feature")&&(m.getAttribute("Alias")=="RenderingFeature")){for(var p=0;p<m.childNodes.length;p++){var s=m.childNodes[p];if(s.nodeName=="Attr"){var v=s.getAttribute("Type");var t=s.getAttribute("Value");var k=s.getAttribute("Name");switch(v){case"int":t=parseInt(t,10);o[k]=t;switch(k){case"WrappingModeU":if(t){o.DiffuseMapWrap[0]="repeat";o.DiffuseMapRepeat[0]=1}break;case"WrappingModeV":if(t){o.DiffuseMapWrap[1]="repeat";o.DiffuseMapRepeat[1]=1}break;case"PreviewType":var l=parseInt(t);switch(l){case 0:o.mappingFunction="SPHERICAL_ENV_MAP";break;case 2:o.mappingFunction="USER_MAPPING";break}break;default:break}break;case"double":switch(k){case"DiffuseColor":o.colorDiffuse=this.getColor(t);break;case"SpecularColor":o.colorSpecular=this.getColor(t);break;case"AmbientColor":o.colorAmbient=this.getColor(t);break;case"SpecularExponent":o.shininess=128*parseFloat(t);break;case"SpecularCoef":o.specularCoef=parseFloat(t);break;case"Reflectivity":o.reflectivityCoef=parseFloat(t);break;case"Transparency":o.transparency=parseFloat(t);o.transparent=(o.transparency>0);break;default:break}break;case"boolean":t=(t==="true");switch(k){case"AlphaTest":o.alphaTest=t?0.5:0;break;default:o[k]=t;break}break;case"external":var w=[];w=t.split("urn:3DXML:");t=w[1];w=t.split("#");t=w[0];var n=w[1];if(k=="TextureImage"){o.DiffuseMap={imageLib:t,id:n}}break;default:break}}}}}return o},loadRepresentationImage:function(j,o,t){var r=this;var l=this.streamObject.getUserData();var q=new b();var m=l.graphicMaterialFiles[j];var k=m.DiffuseMap;if(k&&k.imageLib){var n=l.imageLibraryFiles[k.imageLib];if(!n){l.imageLibraryFiles[k.imageLib]={state:"pending",tasks:[]};var p=new d(this.streamObject.blob,k.imageLib);p.open();if(a){console.log("("+this.id+") begin read image library "+k.imageLib+" as XML")}p.readAsXML(function(x){p.close();if(a){console.log("("+r.id+") parse image library "+p.filename)}var w=l.imageLibraryFiles[p.filename];l.imageLibraryFiles[p.filename]=r.parseRepresentationImage(x);for(var v=0;v<w.tasks.length;v++){var u=w.tasks[v];if(a){console.log("("+u.task.id+") task start again after image library read (relaunched by task ("+r.id+"))")}u.cb.apply(u.task,u.args)}r.loadImage(j,o,t)})}else{if(n.state==="pending"){if(a){console.log("("+this.id+") task waiting for image library "+k.imageLib)}n.tasks.push({task:this,cb:this.loadImage,args:[j,o,t]})}else{this.loadImage(j,o,t)}}}else{var s=q.getMaterial3DXML(m,"/","XMLV43");if(t){t(s)}}},parseRepresentationImage:function(u){var l={};var q=u.firstChild;if(q.nodeName!=="Model_3dxml"){return}for(var r=0;r<q.childNodes.length;r++){var n=q.childNodes[r];if(n.nodeName=="CATRepImage"){for(var p=0;p<n.childNodes.length;p++){var s=n.childNodes[p];if(s.nodeName=="CATRepresentationImage"){var m=s.getAttribute("id");var k=s.getAttribute("name");var t=s.getAttribute("format");var o=s.getAttribute("associatedFile");var v=o.split("urn:3DXML:");l[m]=v[1]}}}}return l},loadImage:function(j,p,t){var r=this;var l=this.streamObject.getUserData();var n=l.graphicMaterialFiles[j];var k=n.DiffuseMap;var s=l.imageLibraryFiles[k.imageLib][k.id];var o=l.imageFiles[s];if(!o){l.imageFiles[s]={state:"pending",tasks:[]};var q=new d(this.streamObject.blob,s);q.open();if(a){console.log("("+this.id+") begin read image "+s)}var v=/(?:\.([^.]+))?$/;var m=v.exec(s)[1];var u="blob";if(m=="dds"){q.readAsArrayBuffer(function(z){q.close();var y=l.imageFiles[s];l.imageFiles[s]=z;for(var x=0;x<y.tasks.length;x++){var w=y.tasks[x];if(a){console.log("("+w.task.id+") task start again after image read (relaunched by task ("+r.id+"))")}w.cb.apply(w.task,w.args)}n.DiffuseMap={filename:s,buffer:l.imageFiles[s]};r.createMaterial(j,p,t)})}else{q.readAsBlob(function(w){q.close();var z=l.imageFiles[s];l.imageFiles[s]=w;for(var y=0;y<z.tasks.length;y++){var x=z.tasks[y];if(a){console.log("("+x.task.id+") task start again after image read (relaunched by task ("+r.id+"))")}x.cb.apply(x.task,x.args)}r.createMaterial(j,s,p,t)})}}else{if(o.state==="pending"){if(a){console.log("("+this.id+") task waiting for image "+s)}o.tasks.push({task:this,cb:this.createMaterial,args:[j,s,p,t]})}else{this.createMaterial(j,s,p,t)}}},createMaterial:function(l,o,q,k){var p=new b();var j=this.streamObject.getUserData();var m=j.graphicMaterialFiles[l];m.DiffuseMap={filename:o,buffer:j.imageFiles[o]};var n=p.getMaterial3DXML(m,"/","XMLV43",null,k);if(q&&n.map){q(n)}},getColor:function(k){var n=[];var l=new RegExp(/\[([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*))\]/);var j=l.exec(k);if(j!=null){n[0]=parseFloat(RegExp.$1);n[1]=parseFloat(RegExp.$2);n[2]=parseFloat(RegExp.$3)}else{l=new RegExp(/\[([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*))\]/);j=l.exec(k);if(j!=null){n[0]=parseFloat(RegExp.$1);n[1]=parseFloat(RegExp.$2);n[2]=parseFloat(RegExp.$3);n[3]=parseFloat(RegExp.$4)}}return n}});return UWA.namespace("THREEDS/XMLMaterialUnstreamTask",f)});define("VisuUnstreamers/XMLMaterialUnstreamTask",["DS/VisuUnstreamers/XMLMaterialUnstreamTask","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuUnstreamers/XMLMaterialUnstreamTask");return b});define("DS/VisuUnstreamers/BufferStreamObject",["UWA/Class","DS/VisuUnstreamers/StreamObject"],function(b,a){var c=a.extend({init:function(d,e){this._parent(d,e);return this},open:function(){},close:function(){},readAsArrayBuffer:function(f){var e;var d=new FileReader();d.onload=function(){e=this.result;if(f){f(e)}};d.readAsArrayBuffer(this.blob)}});return UWA.namespace("THREEDS/BufferStreamObject",c)});define("VisuUnstreamers/BufferStreamObject",["DS/VisuUnstreamers/BufferStreamObject","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuUnstreamers/BufferStreamObject");return b});define("DS/VisuLoaders/XMLV6SmartLoaderPassPlugin",["DS/Visualization/ThreeJS_DS"],function(a){return function(e){this.enabled=false;this.renderTarget=null;var b=e;var d,g,c=new a.Frustum(),f=new a.Matrix4();this.init=function(h){d=h.context;g=h};this.render=function(j,h){if(!this.enabled){return}if(b.isWebWorkerBusy()){return}this.update(j,h)};this.update=function(B,z){var y,r,x,A,v,q,w,u,k,C,l,t,h=null;if(g.autoUpdateScene){B.updateMatrixWorld()}z.matrixWorldInverse.getInverse(z.matrixWorld);f.multiplyMatrices(z.projectionMatrix,z.matrixWorldInverse);c.setFromMatrix(f);t=B.getWebGLObjects("main",0);var s=[];for(x=0,A=t.length;x<A;x++){k=t[x];if(k===null){continue}C=k.object;if(!(C instanceof a.Mesh)||!(C.frustumCulled)||c.intersectsObject(C)){if(C.name=="BBox"){var p=-1;if(C.boundingSphere!==null){var o=new a.Vector3();o.copy(C.boundingSphere.center);o.applyMatrix4(C.matrixWorld);var D=new a.Vector3();D.subVectors(o,z.position);var m=D.length();p=C.boundingSphere.radius/m}s.push({name:C._occurrence.parent.node.name,priority:p})}}}s.sort(function(n,j){if(n.priority<j.priority){return 1}if(n.priority>j.priority){return -1}return 0});b.loadGeometryFiles(s)}}});define("DS/Gestures/DragGesture",["DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture","DS/Visualization/ThreeJS_DS"],function(a,d,b){var c=d.extend({init:function(){this._parent("Drag");this.priority=10;this.identifier=null;this.minDistance=5;return this},detect:function(k){this._parent(k);switch(this.state){case d.State.INIT:this.identifier=null;var l=THREEDS.VisuEventsManager.getPrimaryPointerEventsByStates([a.State.BEGIN],this.view);if(l.length===1){if(l[0].type==="Touch"){this.identifier=l[0].identifier}this.changeState(d.State.BEGIN)}break;case d.State.BEGIN:var g=null;if(this.identifier!==null){var j=THREEDS.VisuEventsManager.getTouchEvents(this.view);if(j.length===1){g=THREEDS.VisuEventsManager.getTouchEventById(this.identifier)}}else{var f=THREEDS.VisuEventsManager.getMouseEvents(null,this.view,true);if((f.length===1)&&(f[0].getButton()===a.MouseButton.LEFT)){g=f[0]}}if(g){if(g.offsetPosition.length()>this.minDistance){var h=(g.getState()===a.State.END);var e=k[0].getJSEvent();if(!h&&e.preventDefault){e.preventDefault()}this.events=[g];this.changeState(d.State.CHANGE)}}else{this.changeState(d.State.KO)}break;case d.State.CHANGE:var g=null;if(this.identifier!==null){var j=THREEDS.VisuEventsManager.getTouchEvents(document);if(j.length===1){g=THREEDS.VisuEventsManager.getTouchEventById(this.identifier)}}else{var f=THREEDS.VisuEventsManager.getMouseEvents(null,document,true);if((f.length===1)&&(f[0].getButton()===a.MouseButton.LEFT)){g=f[0]}}if(g){var h=(g.getState()===a.State.END);var e=k[0].getJSEvent();if(!h&&e.preventDefault){e.preventDefault()}this.events=[g];this.changeState(d.State.CHANGE,h)}else{this.changeState(d.State.KO)}break;case d.State.KO:case d.State.OK:case d.State.CANCEL:this.changeState(d.State.INIT);this.identifier=null;break;default:break}},getTouchPoint:function(){if(this.getEvents().length>0){var e=this.getEvents()[0].getCurrentPosition();return e}return null},getDistanceFromOrigin:function(){if(this.getEvents().length>0){var e=this.getEvents()[0].getOffsetPosition();return e.length()}return null},getLastTraveledDistance:function(){if(this.getEvents().length>0){var e=this.getEvents()[0].getDeltaPosition();return e.length()}return null},getTotalTraveledDistFromOrigin:function(){var e=0;if(this.getEvents().length>0){e=this.getEvents()[0].getTraveledDistance();return e}return null},getLastTraveledVector:function(){if(this.getEvents().length>0){var e=this.getEvents()[0].getDeltaPosition();return e}return null},getDirectionFromOrigin:function(){if(this.getEvents().length>0){var e=this.getEvents()[0].getOffsetPosition();return e}return null}});return UWA.namespace("THREEDS/Gestures/DragGesture",c)});define("DS/Effects/ComputeSDFFontIterative",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/NothingShader","DS/Shaders/PreComputeSDFFontIterativeShaders","DS/Shaders/EncodeHDRShader"],function(d,a,g,c,f,h,b){var e=a.extend({init:function(k,j){this._parent(k);this.gl=this.renderer.context;this.renderTargetPool=j;this.__renderer=k;this.passComputeSDFFontSeed=null;this.passComputeSDFFontFlood=null;this.passComputeSDFFontMerge=null;this.OutputRatio=0.25;this.texture=null;this.passDisplayMap=null;this.passNothing=null;return this},setMap:function(n,l){this.texture=n;this.width=parseInt(n.image.width);this.height=parseInt(n.image.height);if(this.composers[1]){this.composers[1].setSize(this.width,this.height);this.passComputeSDFFontSeed.uniforms.prevMap.value=this.texture}else{var m=new d.WebGLRenderTargetProperties(this.width,this.height,"nearest");m.generateMipmaps=false;m.mapping=this.texture.mapping;this.composers[1]=new g(this.renderer,m,this.renderTargetPool);this.composers[1].composerContext.keepResult=true;this.passComputeSDFFontSeed=new c(h.ComputeSDFFontSeed);this.passComputeSDFFontSeed.compileShader(this.__renderer);this.passComputeSDFFontSeed.uniforms.prevMap.value=this.texture;this.passComputeSDFFontFlood=new c(h.ComputeSDFFontFlood);this.passComputeSDFFontMerge=new c(h.ComputeSDFFontMerge);var k=new c(f);this.composers[1].addPass(this.passComputeSDFFontSeed);this.composers[1].addPass(this.passComputeSDFFontFlood);this.composers[1].addPass(this.passComputeSDFFontMerge);this.composers[1].addPass(k)}var j=this.getOutputSize();if(this.composers[0]){this.composers[0].setSize(j.width,j.height)}else{var m=new d.WebGLRenderTargetProperties(j.width,j.height,"uint");m.generateMipmaps=false;m.mapping=this.texture.mapping;this.composers[0]=new g(this.renderer,m,this.renderTargetPool);this.composers[0].composerContext.keepResult=false;this.passDisplayMap=new c(h.ComputeSDFFontDisplay);this.passDisplayMap.renderToScreen=false;this.composers[0].addPass(this.passDisplayMap);this.composers[1].linkToShaderPassUniform(this.passDisplayMap,this.passDisplayMap.uniforms.tDiffuse)}this.passComputeSDFFontFlood.uniforms.invSize.value.set(1/this.width,1/this.height)},executeStep:function(k,j){var m=null;if(j){this.composers[1].enablePass(this.passComputeSDFFontSeed,false);this.composers[1].enablePass(this.passComputeSDFFontFlood,false);this.composers[1].enablePass(this.passComputeSDFFontMerge,true);m=this.composers[1].composerContext.getResult(undefined,true);this.passComputeSDFFontMerge.uniforms.prevMap.value=m}else{if(k>0){this.composers[1].enablePass(this.passComputeSDFFontSeed,false);this.composers[1].enablePass(this.passComputeSDFFontFlood,true);this.composers[1].enablePass(this.passComputeSDFFontMerge,false);m=this.composers[1].composerContext.getResult(undefined,true);this.passComputeSDFFontFlood.uniforms.prevMap.value=m;var l=1;this.passComputeSDFFontFlood.uniforms.invSize.value.set(l/this.width,l/this.height);if(l<1){return}}else{this.composers[1].enablePass(this.passComputeSDFFontSeed,true);this.composers[1].enablePass(this.passComputeSDFFontFlood,false);this.composers[1].enablePass(this.passComputeSDFFontMerge,false);this.passComputeSDFFontFlood.uniforms.prevMap.value=this.texture}}this.composers[1].render();if(m){this.renderTargetPool.pushRenderTarget(m);m=null}},renderToScreen:function(){this.passDisplayMap.renderToScreen=true;this.composers[0].render()},renderOffscreen:function(){this.passDisplayMap.renderToScreen=false;this.composers[0].render()},getOutputSize:function(){return{width:Math.floor(this.width*this.OutputRatio),height:Math.floor(this.height*this.OutputRatio)}}});return e});define("DS/Plugins/XMLV6SmartLoaderPassPlugin",["DS/VisuLoaders/XMLV6SmartLoaderPassPlugin"],function(a){return a});define("Plugins/XMLV6SmartLoaderPassPlugin",["DS/Plugins/XMLV6SmartLoaderPassPlugin","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Plugins/XMLV6SmartLoaderPassPlugin");return b});define("DS/Visualization/OutlineBuilder",["UWA/Class","DS/Mesh/Mesh"],function(a,b){var h=function(l){var k=1;while(k<l){k*=2}return k};var d={};d.VS_pars=["uniform sampler2D outlinePositionMaps[NB_OUTLINE_MAPS];","float far;","float near;","bool isPersp;","varying vec4 cP;","bool isOutlinePerspective(vec3 viewCurrent, vec3 viewOpposite, vec3 viewFirstSide, vec3 viewSecondSide, vec3 mv_firstNormal, vec3 mv_secondNormal) {","vec3 viewRayCurrent = normalize(viewCurrent);","vec3 viewRayOpposite = normalize(viewOpposite);","vec3 viewRayFirst = normalize(viewFirstSide);","vec3 viewRaySecond = normalize(viewSecondSide);","float dot_curr_first = dot(viewRayCurrent,mv_firstNormal);","float dot_opp_first = dot(viewRayOpposite,mv_firstNormal);","float dot_first_first = dot(viewRayFirst,mv_firstNormal);","float dot_curr_second = dot(viewRayCurrent,mv_secondNormal);","float dot_opp_second = dot(viewRayOpposite,mv_secondNormal);","float dot_second_second = dot(viewRaySecond,mv_secondNormal);","if (dot_curr_first*dot_opp_first > 0.0","&& dot_curr_first*dot_first_first > 0.0","&& dot_curr_second*dot_opp_second > 0.0","&& dot_curr_second*dot_second_second > 0.0)","{","if (dot_first_first*dot_second_second < 0.0) return true;","}","return false;","} ","bool isOutlineOrthographic(in vec3 mv_firstNormal, in vec3 mv_secondNormal) {","return mv_firstNormal.z*mv_secondNormal.z < 0.0;","}",].join("\n");d.FS_pars=["uniform sampler2D depthBuffer;","uniform vec2 depthMapSize;","varying vec4 cP;","#ifdef RENDER_TO_FLOAT_TEXTURE","vec4 getNormalDepth(in vec2 coord) {","vec4 res = texture2D( depthBuffer, coord );","vec3 normal = vec3(0.0, 0.0, 1.0);","if (dot(res.xy, res.xy) > 0.000001) {","   normal.z = 2.0 * dot(res.xy, res.xy) - 1.0;","   normal.xy = normalize(res.xy) * sqrt(1.0 - normal.z * normal.z);","}","float depth = res.w;","if (depth < 0.01) depth = 1.0;","return vec4(normal,depth);","}","float getPolygonOffset(in vec2 coord,in vec3 vN, in float depth) {","mat4 P = projectionMatrix;","bool isPersp = P[2][3] == -1.0;","float constFactor = 0.5;","float slopeFactor = isPersp ? 1.0 : 0.1;","vec2 sr = vec2(2.0)/depthMapSize;","vec2 vC = (gl_FragCoord.xy - 0.5) / depthMapSize;","vC = 2.0*vC - 1.0;","float K = dot(vec3(P[1][1] * (vC.x + P[2][0]), P[0][0] * (vC.y + P[2][1]), -P[0][0] * P[1][1]), vN);","vec2 offset = vec2(P[1][1] * vN.x*sr.x, P[0][0] * vN.y*sr.y);","float factor = (-depth - 0.5 * (P[2][2] - 1.0)) / K;","float dFdxOfZ = abs(offset.x * factor);","float dFdyOfZ = abs(offset.y * factor);","float slope = clamp(max(dFdxOfZ, dFdyOfZ), 1e-6, 0.001);","float constantDepthOffset = 9.53674316e-7;","return (slope * slopeFactor) + (constantDepthOffset * constFactor);","}","float getOffsetedDepth(in vec2 coord) {","vec4 nDepth = getNormalDepth(coord);","float offset = getPolygonOffset(coord,nDepth.xyz,nDepth.w);","return nDepth.w + offset;","}","float depthSampleTest(in vec2 coord, in float delta, in float depth) {","float fDepth = getOffsetedDepth(coord);","if ( fDepth < depth ) return delta;","return 0.0;","}","#else","float getDepth(in vec2 coord) {","vec4 rgba_depth = texture2D( depthBuffer, coord );","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth > 1e-6 ? depth + 2.0* DEPTH_PRECISION : 1.0;","}","float depthSampleTest(in vec2 coord, in float delta, in float depth) {","float fDepth = getDepth(coord);","if ( fDepth < depth ) return delta;","return 0.0;","}","#endif","void correctZFighting() {","vec2 coord = 0.5 + 0.5*cP.xy/cP.w;","float depth = 0.5 + 0.5 * cP.z / cP.w;","float delta = 1.0/9.0;","float test = 0.0;","float dx0 =  -0.5/depthMapSize.x;","float dy0 = -0.5/depthMapSize.y;","float dx1 = -dx0;","float dy1 = -dy0;","test += depthSampleTest(coord,delta, depth);","test += depthSampleTest(coord + vec2(dx0,dy0),delta, depth);","test += depthSampleTest(coord.xy + vec2( 0.0, dy0 ),delta, depth);","test += depthSampleTest(coord.xy + vec2( dx1, dy0 ),delta, depth);","test += depthSampleTest(coord.xy + vec2( dx0, 0.0 ),delta, depth);","test += depthSampleTest(coord.xy + vec2( dx1, 0.0 ),delta, depth);","test += depthSampleTest(coord.xy + vec2( dx0, dy1 ),delta, depth);","test += depthSampleTest(coord.xy + vec2( 0.0, dy1 ),delta, depth);","test += depthSampleTest(coord.xy + vec2( dx1, dy1 ),delta, depth);","if (test > 0.8) {","discard;","}","}"].join("\n");d.isOutlineChunk_VS=["float texSharingOffset = normal.z;","float i1 = position.x+texSharingOffset;","float i2 = position.y+texSharingOffset;","float i3 = position.z+texSharingOffset;","float i4 = normal.x+texSharingOffset;","float maxMapTotalSize = MAX_OUTLINE_MAP_SIZE*MAX_OUTLINE_MAP_SIZE;","int texId_1 = int(floor(i1/maxMapTotalSize));","int texId_2 = int(floor(i2/maxMapTotalSize));","int texId_3 = int(floor(i3/maxMapTotalSize));","int texId_4 = int(floor(i4/maxMapTotalSize));","float dx_1, dx_2, dx_3, dx_4;","float dy_1, dy_2, dy_3, dy_4;","float x_1, x_2, x_3, x_4;","float y_1, y_2, y_3, y_4;","float idInTexture_1 = i1 - float(texId_1)*maxMapTotalSize;","float idInTexture_2 = i2 - float(texId_2)*maxMapTotalSize;","float idInTexture_3 = i3 - float(texId_3)*maxMapTotalSize;","float idInTexture_4 = i4 - float(texId_4)*maxMapTotalSize;","if (texId_1 == NB_OUTLINE_MAPS - 1) {","dx_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_1 = floor(idInTexture_1/LAST_OUTLINE_MAP_SIZE_X);","x_1 = idInTexture_1 - y_1*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_1 = floor(idInTexture_1/MAX_OUTLINE_MAP_SIZE);","x_1 = idInTexture_1 - y_1*MAX_OUTLINE_MAP_SIZE;","}","if (texId_2 == NB_OUTLINE_MAPS - 1) {","dx_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_2 = floor(idInTexture_2/LAST_OUTLINE_MAP_SIZE_X);","x_2 = idInTexture_2 - y_2*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_2 = floor(idInTexture_2/MAX_OUTLINE_MAP_SIZE);","x_2 = idInTexture_2 - y_2*MAX_OUTLINE_MAP_SIZE;","}","if (texId_3 == NB_OUTLINE_MAPS - 1) {","dx_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_3 = floor(idInTexture_3/LAST_OUTLINE_MAP_SIZE_X);","x_3 = idInTexture_3 - y_3*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_3 = floor(idInTexture_3/MAX_OUTLINE_MAP_SIZE);","x_3 = idInTexture_3 - y_3*MAX_OUTLINE_MAP_SIZE;","}","if (texId_4 == NB_OUTLINE_MAPS - 1) {","dx_4 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_4 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_4 = floor(idInTexture_4/LAST_OUTLINE_MAP_SIZE_X);","x_4 = idInTexture_4 - y_4*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_4 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_4 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_4 = floor(idInTexture_4/MAX_OUTLINE_MAP_SIZE);","x_4 = idInTexture_4 - y_4*MAX_OUTLINE_MAP_SIZE;","}","vec3 current = texture2D( outlinePositionMaps[texId_1], vec2( dx_1 * ( x_1 + 0.5 ), dy_1 * ( y_1 + 0.5 ) ) ).xyz;","vec3 opposite = texture2D( outlinePositionMaps[texId_2], vec2( dx_2 * ( x_2 + 0.5 ), dy_2 * ( y_2 + 0.5 ) ) ).xyz;","vec3 firstSide = texture2D( outlinePositionMaps[texId_3], vec2( dx_3 * ( x_3 + 0.5 ), dy_3 * ( y_3 + 0.5 ) ) ).xyz;","vec3 secondSide = texture2D( outlinePositionMaps[texId_4], vec2( dx_4 * ( x_4 + 0.5 ), dy_4 * ( y_4 + 0.5 ) ) ).xyz;","vec3 viewCurrent = vec3(modelViewMatrix*vec4(current, 1.0));","vec3 viewOpposite = vec3(modelViewMatrix*vec4(opposite, 1.0));","vec3 viewFirst = vec3(modelViewMatrix*vec4(firstSide, 1.0));","vec3 viewSecond = vec3(modelViewMatrix*vec4(secondSide, 1.0));","float m22 = projectionMatrix[2][2];","float m32 = projectionMatrix[3][2];","isPersp = projectionMatrix[2][3] == -1.0;","if (isPersp) {","near = m32 / (m22 - 1.0);","far = ((m22 - 1.0)*near)/(m22 + 1.0);","} else {","near = (m32+1.0)/m22;","far = near - 2.0/m22;","}","vec4 mvPosition = vec4(viewCurrent, 1.0);","vec3 mvNormal = vec3(0.0,0.0,0.0);","vec3 mv_firstNormal = normalize(vec3(modelViewMatrix*vec4(normalize(cross(opposite-current, firstSide-current)),0.0)));","vec3 mv_secondNormal = normalize(vec3(modelViewMatrix*vec4(normalize(cross(secondSide-current,opposite-current)), 0.0)));","bool isOutline=false;","if (isPersp) {","isOutline = isOutlinePerspective(viewCurrent, viewOpposite, viewFirst, viewSecond, mv_firstNormal, mv_secondNormal);","if (!isOutline) mvPosition.xyz*=(1000000000.0*far);","} else {","isOutline = isOutlineOrthographic(mv_firstNormal, mv_secondNormal);","if (!isOutline) mvPosition.z = 1000000000.0*far;","}"].join("\n");d.SimpleOutlinesShader={vertexShaderPars:[d.VS_pars].join("\n"),vertexShaderBody:[d.isOutlineChunk_VS,"gl_Position = projectionMatrix*mvPosition;","   cP = gl_Position;"].join("\n"),fragmentShaderPars:d.FS_pars,fragmentShaderBody:["gl_FragColor = vec4(0.0,0.0,0.0,1.0);","correctZFighting();",].join("\n"),force:true};d.WideOutlinesShader={vertexShaderPars:["uniform float outlineHalfWidth;","uniform vec2 pixelSize;","varying vec2 screenCurr;","varying vec2 screenOpp;",d.VS_pars,].join("\n"),vertexShaderBody:[d.isOutlineChunk_VS,"if (isOutline) {","float sideExtrusion = normal.y;","bool isOpposite = mod(abs(sideExtrusion), 2.0) == 0.0;","vec4 mvpCurr = projectionMatrix*vec4(viewCurrent,1.0);","vec4 mvpOpp = projectionMatrix*vec4(viewOpposite,1.0);","vec2 testClip = vec2(sign(mvpCurr.w + mvpCurr.z), sign(mvpOpp.w + mvpOpp.z));","if ( testClip.x * testClip.y < 0.0 ){","           float a = (mvpCurr.w + mvpCurr.z)/((mvpCurr.w + mvpCurr.z) - (mvpOpp.w + mvpOpp.z));","           if (testClip.y < 0.0) {","               mvpOpp = (1.0 - a) * mvpCurr + a * mvpOpp;","           } else {","               mvpCurr = (1.0 - a) * mvpCurr + a * mvpOpp;","           }","       }","screenCurr = (mvpCurr.xy / mvpCurr.w + 1.0) / pixelSize;","screenOpp = (mvpOpp.xy / mvpOpp.w + 1.0) / pixelSize;","vec3 ndcCurr = mvpCurr.xyz/mvpCurr.w;","vec3 ndcOpp = mvpOpp.xyz/mvpOpp.w;","float offset = sign(sideExtrusion) * outlineHalfWidth;","vec2 line = normalize(screenOpp - screenCurr);","vec2 lineNormal = vec2(-line.y, line.x);","vec2 px_pos;","px_pos = screenCurr + offset*lineNormal - outlineHalfWidth*line;","vec3 ndcPos = vec3((px_pos*pixelSize - 1.0), mvpCurr.z/mvpCurr.w);","if (isOpposite) {","vec2 tmp = screenCurr;","screenCurr = screenOpp;","screenOpp = tmp;","}","vec4 clipSpacePos = vec4(ndcPos*mvpCurr.w, mvpCurr.w);","gl_Position = clipSpacePos;","cP = mvpCurr;","} else {","gl_Position = projectionMatrix*mvPosition;","}"].join("\n"),fragmentShaderPars:["uniform float outlineHalfWidth;","uniform vec2 pixelSize;","varying vec2 screenCurr;","varying vec2 screenOpp;",d.FS_pars].join("\n"),fragmentShaderBody:["gl_FragColor = vec4(0.0,0.0,0.0,1.0);","correctZFighting();","vec2 fCoord = gl_FragCoord.xy;","vec2 currOpp = screenOpp - screenCurr;","vec2 currFcoord = fCoord - screenCurr;","vec2 oppFcoord = fCoord - screenOpp;","bool toDiscard = false;","if (dot(currOpp, currFcoord ) < 0.0) {","if (length(currFcoord) > outlineHalfWidth) toDiscard = true;","} else if (dot(-currOpp, oppFcoord ) < 0.0) {","if (length(oppFcoord) > outlineHalfWidth) toDiscard = true;","} ","if (toDiscard) discard;",].join("\n"),force:true,forceSide:true};var f=[];var g=a.extend({init:function(k){this._renderable=k;this.indexArray=null;this.firstIndicesArray=null;this.lastIndexArray=null;this._Id=0;this._edgeId=0;this.width=1},createNewGeometry:function(){var m=THREEDS.Core;var l=this.createMaterial();var n=this.createDg(l);var k=new m.BufferGeometryDS();k.drawingGroups=[];n.geometry=k;k.drawingGroups.push(n);k.vertexPositionArray=this.firstIndicesArray;k.vertexNormalArray=this.lastIndexArray;k.vertexIndexArray=this.indexArray;k.boundingSphere=this._renderable.boundingSphere;k.boundingBox=this._renderable.boundingBox;j.TexturesManager.addGeometriesOfRenderable(this._renderable);return k}});var c=g.extend({init:function(k){this._parent(k);this.width=1},initArrays:function(){this.indexArray=[];this.firstIndicesArray=[];this.lastIndexArray=[]},createFinalArrays:function(){this.indexArray=new Uint32Array(this.indexArray);this.firstIndicesArray=new Float32Array(this.firstIndicesArray);this.lastIndexArray=new Float32Array(this.lastIndexArray)},addFullEdgeIndices:function(p,o,n,m){var l=this.indexArray;var r=this.firstIndicesArray;var q=this.lastIndexArray;var k=this._edgeId;r[6*k]=p;r[6*k+1]=o;r[6*k+2]=n;r[6*k+3]=o;r[6*k+4]=p;r[6*k+5]=m;q[6*k]=m;q[6*k+1]=0;q[6*k+2]=0;q[6*k+3]=n;q[6*k+4]=0;q[6*k+5]=0;this._edgeId++},createMaterial:function(){return j.TexturesManager.createSimpleMaterial()},createDg:function(l){var k=this.firstIndicesArray.length/3;var m=new b.DrawingGroup(l,l,1,0,k);m.nonIndexed=true;return m}});var e=g.extend({init:function(l,k){this._parent(l);this.width=k;this.curr_Id=0},initArrays:function(){this.indexArray=[];this.firstIndicesArray=[];this.lastIndexArray=[]},createFinalArrays:function(){this.indexArray=new Uint32Array(this.indexArray);this.firstIndicesArray=new Float32Array(this.firstIndicesArray);this.lastIndexArray=new Float32Array(this.lastIndexArray)},addFullEdgeIndices:function(p,o,n,m){var l=this.indexArray;var r=this.firstIndicesArray;var q=this.lastIndexArray;l[this._Id++]=this.curr_Id;l[this._Id++]=this.curr_Id+1;l[this._Id++]=this.curr_Id+2;l[this._Id++]=this.curr_Id+2;l[this._Id++]=this.curr_Id+1;l[this._Id++]=this.curr_Id+3;this.curr_Id+=4;var k=this._edgeId;r[12*k]=p;r[12*k+1]=o;r[12*k+2]=n;r[12*k+3]=o;r[12*k+4]=p;r[12*k+5]=m;r[12*k+6]=p;r[12*k+7]=o;r[12*k+8]=n;r[12*k+9]=o;r[12*k+10]=p;r[12*k+11]=m;q[12*k]=m;q[12*k+1]=-1;q[12*k+2]=0;q[12*k+3]=n;q[12*k+4]=+2;q[12*k+5]=0;q[12*k+6]=m;q[12*k+7]=+1;q[12*k+8]=0;q[12*k+9]=n;q[12*k+10]=-2;q[12*k+11]=0;this._edgeId++},createMaterial:function(){return j.TexturesManager.createWideMaterial(0.5*this.width)},createDg:function(l){var k=this.indexArray.length;var m=new b.DrawingGroup(l,l,4,0,k);return m}});var j=a.extend({init:function(m,k,l){this._renderable=m;if(k===1){this._oGeometry=new c(m)}else{this._oGeometry=new e(m,k)}if(j.TexturesManager.sortCount!==l){j.TexturesManager.clean();j.TexturesManager.sortCount=l}},computeOutlineGeometry:function(){var S=THREEDS.Core;var I=0;var G=0;var C=0;var D=this._renderable;var s=[];if(!D.layer){s=D.geometry}else{var B={};for(var K=0;K<D.layer.layers.length;K++){var O=D.layer.layers[K].drawableGroup;var R=D.layer.layers[K].drawableInterval;if(R.layerNum<1){continue}B[O.geometry.id]=O.geometry}for(var K in B){s.push(B[K])}s.sort(function(U,k){return U.id-k.id})}this._oGeometry.initArrays();var l=0;var m=0;var o=[];var T=[];for(var K=0;K<s.length;K++){o[K]=l;T[K]=m;l+=s[K].vertexIndexArray.length;m+=s[K].vertexPositionArray.length}var v=f;var H=0;var y=function(U,k,X,W){var Z=s[U].vertexPositionArray;var Y=s[k].vertexPositionArray;var V=0;if(Z[3*X]<Y[3*W]){V=-1}else{if(Z[3*X]>Y[3*W]){V=1}else{if(Z[3*X+1]<Y[3*W+1]){V=-1}else{if(Z[3*X+1]>Y[3*W+1]){V=1}else{if(Z[3*X+2]<Y[3*W+2]){V=-1}else{if(Z[3*X+2]>Y[3*W+2]){V=1}}}}}}return V};var r=function(Z,Y,X,U){var V=y(U,U,Z,Y)>0;if(V){var W=Z;Z=Y;Y=W}var k={i1:Z,i2:Y,i3:X,geomId:U};return k};var q=null;if(!D.layer){var p=s.length;for(var K=0;K<p;K++){var F=s[K];q=F.vertexIndexArray;for(var Q=0;Q<F.drawingGroups.length;Q++){var O=F.drawingGroups[Q];if(O._geomType===S.GeomTypeEnum.FACE){for(var J=O.start;J<O.start+O.count;J+=3){I=q[J];G=q[J+1];C=q[J+2];if(!(I===G||G===C||I===C)){var x=r(I,G,C,K);v[H++]=x;var w=r(G,C,I,K);v[H++]=w;var u=r(C,I,G,K);v[H++]=u}}}}}}else{for(var K=0;K<D.layer.layers.length;K++){var O=D.layer.layers[K].drawableGroup;var R=D.layer.layers[K].drawableInterval;if(R.layerNum<1){continue}if(O._geomType===S.GeomTypeEnum.FACE){var n=s.indexOf(O.geometry);q=O.geometry.vertexIndexArray;for(var J=R.start;J<R.start+R.count;J+=3){I=q[J];G=q[J+1];C=q[J+2];if(!(I===G||G===C||I===C)){var x=r(I,G,C,n);v[H++]=x;var w=r(G,C,I,n);v[H++]=w;var u=r(C,I,G,n);v[H++]=u}}}}}var t=function(W,U){var V=s[W.geomId].vertexPositionArray;var k=s[U.geomId].vertexPositionArray;if(V[3*W.i1]<k[3*U.i1]){return -1}else{if(V[3*W.i1]>k[3*U.i1]){return 1}else{if(V[3*W.i1+1]<k[3*U.i1+1]){return -1}else{if(V[3*W.i1+1]>k[3*U.i1+1]){return 1}else{if(V[3*W.i1+2]<k[3*U.i1+2]){return -1}else{if(V[3*W.i1+2]>k[3*U.i1+2]){return 1}else{if(V[3*W.i2]<k[3*U.i2]){return -1}else{if(V[3*W.i2]>k[3*U.i2]){return 1}else{if(V[3*W.i2+1]<k[3*U.i2+1]){return -1}else{if(V[3*W.i2+1]>k[3*U.i2+1]){return 1}else{if(V[3*W.i2+2]<k[3*U.i2+2]){return -1}else{if(V[3*W.i2+2]>k[3*U.i2+2]){return 1}else{if(W.i1===U.i1){if(W.i2===U.i2){return 0}else{return U.i2-W.i2}}else{return U.i1-W.i1}}}}}}}}}}}}}};if(H===0){return null}v.length=H;var z=v.length;v.sort(t);var K=0;var E=0;var A=0;var M=0;var L=0;var P=null;var N=null;while(K<z-1){P=v[K];N=v[K+1];M=P.geomId;L=N.geomId;E=T[M]/3;if(y(M,L,P.i1,N.i1)===0&&y(M,L,P.i2,N.i2)===0){A=T[L]/3;this._oGeometry.addFullEdgeIndices(E+P.i1,E+P.i2,E+P.i3,A+N.i3);K+=2}else{this._oGeometry.addFullEdgeIndices(E+P.i1,E+P.i2,E+P.i3,E+P.i3);K++}}this._oGeometry.createFinalArrays();return this._oGeometry.createNewGeometry()}});j.halfEdgesArray=[];j.convertOutlineGeometry=function(s,k,z,F){if(j.ConversionMaterialsManager.sortCount!==F){j.ConversionMaterialsManager.clean();j.ConversionMaterialsManager.sortCount=F}var L=THREEDS.Core;var K=null;var p=null;var C=null;var w=0;var H=0;var x=s.vertexPositionArray;var t=s.vertexNormalArray;var I=s.vertexPositionArray.length;var n=0;var m=s.drawingGroups[0].material;var G=0;var D=0;var B=0;var y=0;var v=0;var o=0;var u=0;var l=0;var q=null;var r=0;if(k<z){r=4;n=I/3;G=n/2;w=I*2;H=n*3;K=new Float32Array(w);p=new Float32Array(w);C=new Uint32Array(H);for(var E=0;E<G;E++){C[u++]=l;C[u++]=l+1;C[u++]=l+2;C[u++]=l+2;C[u++]=l+1;C[u++]=l+3;l+=4;D=x[6*E];B=x[6*E+1];y=x[6*E+2];v=t[6*E];o=t[6*E+2];K[12*E]=D;K[12*E+1]=B;K[12*E+2]=y;K[12*E+3]=B;K[12*E+4]=D;K[12*E+5]=v;K[12*E+6]=D;K[12*E+7]=B;K[12*E+8]=y;K[12*E+9]=B;K[12*E+10]=D;K[12*E+11]=v;p[12*E]=v;p[12*E+1]=-1;p[12*E+2]=o;p[12*E+3]=y;p[12*E+4]=+2;p[12*E+5]=o;p[12*E+6]=v;p[12*E+7]=+1;p[12*E+8]=o;p[12*E+9]=y;p[12*E+10]=-2;p[12*E+11]=o}q=j.ConversionMaterialsManager.createWideMaterialFromOther(m,0.5*z)}else{n=s.vertexIndexArray.length;r=1;G=n/6;w=I/2;H=n/3;K=new Float32Array(w);p=new Float32Array(w);for(var E=0;E<G;E++){D=x[12*E];B=x[12*E+1];y=x[12*E+2];v=t[12*E];o=t[12*E+2];K[6*E]=D;K[6*E+1]=B;K[6*E+2]=y;K[6*E+3]=B;K[6*E+4]=D;K[6*E+5]=v;p[6*E]=v;p[6*E+1]=0;p[6*E+2]=o;p[6*E+3]=y;p[6*E+4]=0;p[6*E+5]=o}q=j.ConversionMaterialsManager.createSimpleMaterialFromWide(m)}var J=new b.DrawingGroup(q,q,r,0,H);J.nonIndexed=r===1;var A=new L.BufferGeometryDS();A.drawingGroups=[];J.geometry=A;A.drawingGroups.push(J);A.vertexPositionArray=K;A.vertexNormalArray=p;A.vertexIndexArray=C;A.boundingSphere=s.boundingSphere;A.boundingBox=s.boundingBox;s.dispose();s=null;return A};j.convertWideWidth=function(m,l,o){if(j.ConversionMaterialsManager.sortCount!==o){j.ConversionMaterialsManager.clean();j.ConversionMaterialsManager.sortCount=o}var n=m.drawingGroups[0].material;var k=j.ConversionMaterialsManager.createWideMaterialFromOther(n,0.5*l);m.drawingGroups[0].material=k};j.TexturesManager={sortCount:-1,nbVertices:0,newSimpleMaterial:function(l,k){var n=THREEDS.Core;var m=new n.ShaderMaterialDS(d.SimpleOutlinesShader);m.vertexShaderPars=[n.ShaderChunk.clip_pars_vertex,m.vertexShaderPars].join("\n");m.vertexShaderBody=[m.vertexShaderBody,n.ShaderChunk.clip_vertex].join("\n");m.fragmentShaderPars=[n.ShaderChunk.clip_pars_fragment,m.fragmentShaderPars].join("\n");m.fragmentShaderBody=[n.ShaderChunk.clip_fragment,m.fragmentShaderBody].join("\n");m.update();m.uniforms=n.UniformsUtils.clone(n.UniformsLib.clipPlanes);m.uniforms.outlinePositionMaps={type:"tv",value:k};m.depthTest=false;m.uniforms.depthBuffer={type:"t",value:null};m.uniforms.depthMapSize={type:"v2",value:new n.Vector2(0.01,0.01)};if(l){m.defines={NB_OUTLINE_MAPS:l.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:l.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:l.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:l.LAST_OUTLINE_MAP_SIZE_Y}}else{m.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0}}m.refreshUniforms=function(q,o,p){q.requestDBuffer=true;if(!q.dBuffer){return}this.uniforms.depthBuffer.value=q.dBuffer;this.uniforms.depthMapSize.value=new n.Vector2(q.dBuffer.width,q.dBuffer.height)};m.enableClipPlanes=true;return m},newWideMaterial:function(l,k,o){var n=THREEDS.Core;var m=new n.ShaderMaterialDS(d.WideOutlinesShader);m.vertexShaderPars=[n.ShaderChunk.clip_pars_vertex,m.vertexShaderPars].join("\n");m.vertexShaderBody=[m.vertexShaderBody,n.ShaderChunk.clip_vertex].join("\n");m.fragmentShaderPars=[n.ShaderChunk.clip_pars_fragment,m.fragmentShaderPars].join("\n");m.fragmentShaderBody=[n.ShaderChunk.clip_fragment,m.fragmentShaderBody].join("\n");m.update();m.uniforms=n.UniformsUtils.clone(n.UniformsLib.clipPlanes);m.uniforms.outlinePositionMaps={type:"tv",value:k};m.depthTest=false;m.uniforms.depthBuffer={type:"t",value:null};m.uniforms.depthMapSize={type:"v2",value:new n.Vector2(0.01,0.01)};if(l){m.defines={NB_OUTLINE_MAPS:l.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:l.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:l.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:l.LAST_OUTLINE_MAP_SIZE_Y}}else{m.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0}}m.side=n.DoubleSide;m.uniforms.outlineHalfWidth={type:"f",value:o};m.uniforms.pixelSize={type:"v2",value:new n.Vector2()};m.refreshUniforms=function(r,p,q){m.uniforms.pixelSize.value.x=2/r.domElement.width;m.uniforms.pixelSize.value.y=2/r.domElement.height;r.requestDBuffer=true;if(!r.dBuffer){return}this.uniforms.depthBuffer.value=r.dBuffer;this.uniforms.depthMapSize.value=new n.Vector2(r.dBuffer.width,r.dBuffer.height)};m.enableClipPlanes=true;return m},addGeometriesOfRenderable:function(p){this.isClean=false;var n=p.geometry.length;var q=null;var m=0;if(!p.layer){for(var o=0;o<n;o++){q=p.geometry[o];this.geometriesAssociated.push({renderable:p,geom:q,renderableOffset:this.nbVertices});m+=q.vertexPositionArray.length/3}}else{var s={};var l=[];for(var o=0;o<p.layer.layers.length;o++){var r=p.layer.layers[o].drawableGroup;var k=p.layer.layers[o].drawableInterval;if(k.layerNum<1){continue}s[r.geometry.id]=r.geometry}for(var o in s){l.push(s[o])}for(var o=0;o<l.length;o++){this.geometriesAssociated.push({renderable:p,geom:l[o],renderableOffset:this.nbVertices});m+=l[o].vertexPositionArray.length/3}}this.nbVertices+=m;this._updateTextureDefines()},_updateTextureDefines:function(){var n=this.nbVertices;this.textureDefines.NB_OUTLINE_MAPS=Math.ceil(n/this.maxTextureTotalSize);var o=(n-Math.floor(n/this.maxTextureTotalSize)*this.maxTextureTotalSize);var l=Math.sqrt(o);var m=h(l);var k=h(o/m);this.textureDefines.LAST_OUTLINE_MAP_SIZE_X=m;this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y=k},geometriesAssociated:[],textureDefines:{NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:-1,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0},maxTextureTotalSize:-1,isClean:true,simpleOutlineMaterial:null,wideOutlineMaterials:null,createSimpleMaterial:function(){if(this.simpleOutlineMaterial!==null){return this.simpleOutlineMaterial}var k=this.newSimpleMaterial(null,null);this.simpleOutlineMaterial=k;return k},createWideMaterial:function(l){if(this.wideOutlineMaterials===null){this.wideOutlineMaterials={}}if(this.wideOutlineMaterials[l]){return this.wideOutlineMaterials[l]}var k=this.newWideMaterial(null,null,l);this.wideOutlineMaterials[l]=k;return k},finalize:function(){var H=THREEDS.Core;var r=this.textureDefines.NB_OUTLINE_MAPS;var u=this.maxTextureTotalSize;var x=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X;var v=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y;var z=((r-1)*u+x*v)*3;var s=new Float32Array(z);var p=0;var n=this.geometriesAssociated;var q=n.length;var C=null;var C=null;var B=null;var w=0;var G=null;for(var D=0;D<q;D++){C=n[D].geom;w=n[D].renderableOffset;B=n[D].renderable;s.set(C.vertexPositionArray,p);G=B.outlinesGeometry.geometry;var l=G.vertexNormalArray.length/3;for(var A=0;A<l;A++){G.vertexNormalArray[3*A+2]=w}p+=C.vertexPositionArray.length}var k=[];for(var y=0;y<r-1;y++){var m=new H.DataTexture(s.subarray(y*u*3,(y+1)*u*3),maxTextureSize,maxTextureSize,H.RGBFormat,H.FloatType);m.minFilter=H.NearestFilter;m.magFilter=H.NearestFilter;m.generateMipmaps=false;m.flipY=false;m.needsUpdate=true;k.push(m)}var m=new H.DataTexture(s.subarray((r-1)*u*3,z),x,v,H.RGBFormat,H.FloatType);m.minFilter=H.NearestFilter;m.magFilter=H.NearestFilter;m.generateMipmaps=false;m.flipY=false;m.needsUpdate=true;k.push(m);if(this.simpleOutlineMaterial!==null){this.simpleOutlineMaterial.uniforms.outlinePositionMaps.value=k;this.simpleOutlineMaterial.defines.NB_OUTLINE_MAPS=this.textureDefines.NB_OUTLINE_MAPS;this.simpleOutlineMaterial.defines.MAX_OUTLINE_MAP_SIZE=this.textureDefines.MAX_OUTLINE_MAP_SIZE.toFixed(1);this.simpleOutlineMaterial.defines.LAST_OUTLINE_MAP_SIZE_X=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X.toFixed(1);this.simpleOutlineMaterial.defines.LAST_OUTLINE_MAP_SIZE_Y=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y.toFixed(1)}if(this.wideOutlineMaterials!==null){var E=null;for(var F in this.wideOutlineMaterials){E=this.wideOutlineMaterials[F];E.uniforms.outlinePositionMaps.value=k;E.defines.NB_OUTLINE_MAPS=this.textureDefines.NB_OUTLINE_MAPS;E.defines.MAX_OUTLINE_MAP_SIZE=this.textureDefines.MAX_OUTLINE_MAP_SIZE.toFixed(1);E.defines.LAST_OUTLINE_MAP_SIZE_X=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X.toFixed(1);E.defines.LAST_OUTLINE_MAP_SIZE_Y=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y.toFixed(1)}}},clean:function(){this.isClean=true;this.simpleOutlineMaterial=null;this.wideOutlineMaterials=null;this.nbVertices=0;if(this.textureDefines.MAX_OUTLINE_MAP_SIZE<0){var l=debugWebGLV6Viewer.renderer.renderer.context;var k=l.getParameter(l.MAX_TEXTURE_SIZE);this.textureDefines.MAX_OUTLINE_MAP_SIZE=k;this.maxTextureTotalSize=k*k}this.textureDefines.NB_OUTLINE_MAPS=0;this.textureDefines.LAST_OUTLINE_MAP_SIZE_X=0;this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y=0;this.geometriesAssociated.length=0}};j.ConversionMaterialsManager={sortCount:-1,simpleOutlineMaterials:null,wideOutlineMaterials:null,createSimpleMaterialFromWide:function(n){if(this.simpleOutlineMaterials===null){this.simpleOutlineMaterials={}}var k=n.uniforms.outlinePositionMaps.value;if(this.simpleOutlineMaterials[k[0].id]){return this.simpleOutlineMaterials[k[0].id]}var l=n.defines;var m=j.TexturesManager.newSimpleMaterial(l,k);this.simpleOutlineMaterials[k[0].id]=m;return m},createWideMaterialFromOther:function(n,o){if(this.wideOutlineMaterials===null){this.wideOutlineMaterials={}}var k=n.uniforms.outlinePositionMaps.value;if(!this.wideOutlineMaterials[o]){this.wideOutlineMaterials[o]={}}if(this.wideOutlineMaterials[o][k[0].id]){return this.wideOutlineMaterials[o][k[0].id]}var l=n.defines;var m=j.TexturesManager.newWideMaterial(l,k,o);this.wideOutlineMaterials[o][k[0].id]=m;return m},clean:function(){this.simpleOutlineMaterials=null;this.wideOutlineMaterials=null}};return j});define("Visualization/OutlineBuilder",["DS/Visualization/OutlineBuilder","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/OutlineBuilder");return b});define("DS/Plugins/ClearMaskPass",["DS/Visualization/ThreeJS_DS"],function(a){return null});define("Plugins/ClearMaskPass",["DS/Plugins/ClearMaskPass","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Plugins/ClearMaskPass");return b});define("DS/VisuDataAccess/Ox4StreamUnStreamerTask",["DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(a){var b=function(f,c){var e=f;var d=c;this.run=function(n,g,k,p,o){var m=new a();var l=n.findNodeByType(e.typeRequested());var j=0;for(var h=0;h<l.length;h++){(function(v){var u=new Array();if(v.ticketRequest!=null){u.push(v.ticketRequest);delete v.ticketRequest}else{if(v.ticketRequests!=null){var r=v.ticketRequests;for(var t=0;t<r.length;t++){u.push(r[t])}}}e.streamsNumber(u.length);j+=u.length;for(var q=0;q<u.length;q++){if(!window.hasOwnProperty("ODTNoFCSCalls")||!window.ODTNoFCSCalls){var s=u[q].generateRequest();m.asyncTransformFCSUrlIntoRealUrl(s,d.rawmode,function(y,z){if(z.slice(0,8)=="posthttp"){var w=z.indexOf(":postparams:");var B=z.slice(9,w);var A=z.slice(w+12,z.length);var x=new Object();if(e.responseType!=null){console.log("registering otherParams reponsetype "+e.responseType);x.responseType=e.responseType}m.executePostHttpRequest2(B,"application/x-www-form-urlencoded",A,function(C){e.streamReceived(v,C,n);if(--j==0){p(this)}},x)}})}else{j--;e.streamReceived(v,null,n)}}})(l[h])}if(j==0){p(this)}}};return b});define("DS/VisuDataAccess/Ox4DOSRunner",["DS/VisuDataAccess/Ox4TreeTarget","DS/VisuDataAccess/Ox4PlanRunner","DS/VisuDataAccess/Ox4TaskPlanner","DS/VisuDataAccess/Ox4SetTask","DS/VisuDataAccess/Ox4ExpandTask","DS/VisuDataAccess/Ox4xMQLSelectTaskDefinition","DS/VisuDataAccess/Ox4SelectTask","DS/VisuDataAccess/Ox4PLMDataHelper","DS/VisuDataAccess/Ox4TicketGeneratorTask","DS/VisuDataAccess/Ox4FeatureModeler","DS/VisuDataAccess/Ox4StreamUnStreamerTaskDefinition","DS/VisuDataAccess/Ox4StreamUnStreamerTask","DS/VisuDataAccess/Ox4TypeHelper","DS/Visualization/PathElement"],function(l,a,c,m,n,d,b,e,j,h,q,o,p,k){function g(s){var r=new Object();if(typeof(s.serverdefinition.hostname)==="undefined"){console.log("checkAndEnrichSpecification:No Hostname in CreateServerDefinition");return null}r.hostname=s.serverdefinition.hostname;if(typeof(s.serverdefinition.rooturi)==="undefined"){console.log("checkAndEnrichSpecification:No RootUri in CreateServerDefinition");return null}r.rooturi=s.serverdefinition.rooturi;r.isSecure=false;if(typeof(s.serverdefinition.protocol)!="undefined"){if(s.serverdefinition.protocol==="https"){r.isSecure=true}}r.port=-1;if(typeof(s.serverdefinition.port)!="undefined"){r.port=s.serverdefinition.port}r.rawmode=s.rawmode;r.xmqlServiceUri=function(){var u="http://";if(this.isSecure){u="https://"}var t=u+this.hostname;if(this.port!=-1){t+=":"+this.port}t+="/"+this.rooturi+"/i3dx/services/xmql";if(typeof s.tenant==="string"){t+="?tenant="+s.tenant}console.log("[DOS]test rawmode type: "+typeof(r.rawmode)+"and value: "+r.rawmode);if(typeof(r.rawmode)==="boolean"&&r.rawmode){t+="?raw=true"}return t};r.threedexpServiceUri=function(){var u="http://";if(this.isSecure){u="https://"}var t=u+this.hostname;if(this.port!=-1){t+=":"+this.port}t+="/"+this.rooturi;return t};s.serverdefinition=r;s.typeHelper=p;s.referenceType="VPMReference";s.shapeType="VPMRepReference";s.instanceType="VPMInstance";return s}var f=function(r,s){if(!p.IsInit()){p.Init(r.serverdefinition,r.requiredAuth,r.proxyurl)}var t=g(r);var v=new l(t,s);var w=null;var x=null;var z=null;var y=s;this.run=function(C,A,D){console.log("---> Entering Ox4DOSRunner");w=C;x=A;z=D;console.log("---> Init Feature Modeler session");h.init();console.log("---> Building a plan for");var B=new u();B.buildPlan(t,function(F){console.log("---> Plan Constructed");v.FindRootNodeWorkType();var E=new a(F,v,t.physicalid+"_set",w,x,z);E.executePlan()})};var u=function(){this.buildPlan=function(A,C){console.log("--->Ox4DOSPlanifier:Beginning BuildPlan");console.log(A);console.log(A.physicalid);var B=false;if(A.dtype!=null){p.IsBusA(A.dtype,A.shapeType,function(N){var D=new c();var S=new m(false,A.serverdefinition);D.addSequentialTask(S);if(!N){var L=new n(A.physicalid,A.serverdefinition,"PLMInstance");D.addSequentialTask(L);var E={Fetch:new Array()};E.Fetch.push("physicalid");E.Fetch.push("attribute[LPAbstractInstance.V_matrix_1]");E.Fetch.push("attribute[LPAbstractInstance.V_matrix_2]");E.Fetch.push("attribute[LPAbstractInstance.V_matrix_3]");E.Fetch.push("attribute[LPAbstractInstance.V_matrix_4]");E.Fetch.push("attribute[LPAbstractInstance.V_matrix_5]");E.Fetch.push("attribute[LPAbstractInstance.V_matrix_6]");E.Fetch.push("attribute[LPAbstractInstance.V_matrix_7]");E.Fetch.push("attribute[LPAbstractInstance.V_matrix_8]");E.Fetch.push("attribute[LPAbstractInstance.V_matrix_9]");E.Fetch.push("attribute[LPAbstractInstance.V_matrix_10]");E.Fetch.push("attribute[LPAbstractInstance.V_matrix_11]");E.Fetch.push("attribute[LPAbstractInstance.V_matrix_12]");var T=function(Y,ab,ac){var Z=ac.findNodeByPhysicalId(ab[1]);var X=y("Matrix");X.set(ab[2],ab[5],ab[8],ab[11]*1000,ab[3],ab[6],ab[9],ab[12]*1000,ab[4],ab[7],ab[10],ab[13]*1000,0,0,0,1);Z.setMatrix(X)};var J=new d(A.instanceType,E,T,0);var Q=new b(J,A.serverdefinition);D.addSequentialTask(Q)}else{}var K={Fetch:new Array()};K.Fetch.push("physicalid");K.Fetch.push("attribute[StreamDescriptors]");K.Fetch.push("format.file.store");var W=new e(A.serverdefinition);var V=function(Y,ab,ac){var Z=ac.findNodeByPhysicalId(ab[3]);var X=W.transformSelectedSDByRoleAndFormatIntoTicketRequest(ab[3],ab[4],"cgr","''",["2","1"],ab[5]);if(X!==null){Z.ticketRequest=new j(X,A.serverdefinition)}};var P=new d(A.shapeType,K,V,1);var O=new b(P,A.serverdefinition);D.addSequentialTask(O);A.kinematics=true;if(A.kinematics){var F=function(Z,ab){var X=h.listRootFeatures(Z.id);Z.AnimFeatures=X;var Y=ab.rootNode();if(!Y.hasOwnProperty("AnimFeaturesList")){Y.AnimFeaturesList=[]}Array.prototype.push.apply(Y.AnimFeaturesList,Z.AnimFeatures)};var I={Fetch:new Array(),Path:new Array()};I.Fetch.push("physicalid");I.Fetch.push("attribute[StreamDescriptors]");I.Fetch.push("format.file.store");I.Path.push("owner.physicalid");I.Path.push("element.order");I.Path.push("element");I.Path.push("attribute[IDRel]");var U=function(af,ad,Y){if("fetch"===af){var Z=Y.findNodeByPhysicalId(ad[3]);if(h.containFeatures(Z.id)){F(Z,Y)}else{var ab=W.transformSelectedSDByRoleAndFormatIntoTicketRequest(ad[3],ad[4],"CATNonCATIADocument","'WebFormat'",["1","7"],ad[5]);if(ab!==null){Z.ticketRequest=new j(ab,A.serverdefinition)}}}else{if("path"===af){var ah=(ad.length-3)/2;var Z=Y.findNodeByPhysicalId(ad[1]);if(!Z.hasOwnProperty("SemanticRelations")){Z.SemanticRelations={}}var X=new k();X.addElement(Y.rootNode());var ae=[];var ac;for(ac=0;ac<ah;ac++){ae.push({order:ad[2+ac],instance:ad[2+ah+ac].split(",")[2]})}ae.sort(function(ai,aj){return ai.order-aj.order});for(ac=0;ac<ae.length;ac++){var ag=Y.findNodeByPhysicalId(ae[ac].instance);X.addElement(ag);if(ac<ae.length-1&&ag.children.length==1){X.addElement(ag.children[0])}}Z.SemanticRelations[ad[2+2*ah]]=X}}};var P=new d("CATANIMDISCIPLINE",I,U,1);var O=new b(P,A.serverdefinition);D.addSequentialTask(O);var H=new q("CATANIMDISCIPLINE",function(Y,ab,Z){if(ab!==null){h.loadRepresentation(Y,Y.id,ab,function(){F(Y,Z)})}else{var X=Z.rootNode();if(!X.hasOwnProperty("AnimFeaturesList")){X.AnimFeaturesList=[]}X.AnimFeaturesList.push("feature")}},function(){});H.responseType="blob";var M=new o(H,A.serverdefinition);D.addSequentialTask(M)}var G=new m(true,A.serverdefinition);D.addSequentialTask(G);var R=function(ac){var Y=ac.rootNode();var X=ac.findNodeByType(A.shapeType);var ab=[];for(var Z in X){if(X[Z].ticketRequest!==undefined){ab.push(X[Z])}}return{rootNode:Y,geometryNodes:ab}};D.addEndingTask(R);console.log("--->Ox4DOSPlanifier:Beginning BuildPlan Done");C(D)})}}}};return f});define("VisuDataAccess/Ox4DOSRunner",["DS/VisuDataAccess/Ox4DOSRunner","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/Ox4DOSRunner");return b});define("DS/Shaders/SSAOShader",["DS/Visualization/ThreeJS_DS"],function(b){var c={computeVertexPositionVS:["vec4 normalDepth = texture2D( tNormalDepth, vUv );","float z = normalDepth.w;","if ( z == 0.0 ) discard;","vec2 xy = vUv * 2.0 - 1.0;","vec4 vertexPositionProjected = vec4( xy, z, 1.0 );","vec4 vertexPositionVS = ProjectionMatrixInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","vertexPositionVS.w = 1.0;"].join("\n"),computeNormal:["vec3 normal = normalDepth.xyz * 2.0 - 1.0;"].join("\n")},a={uniforms:{tNormalDepth:{type:"t",value:null},ProjectionMatrixInverse:{type:"m4",value:new b.Matrix4()},ProjectionMatrix:{type:"m4",value:new b.Matrix4()},Intensity:{type:"f",value:2},OccluderBias:{type:"f",value:0.05},SamplingRadius:{type:"f",value:1},NbDirection:{type:"i",value:4},NbSamples:{type:"i",value:4},screenHeight:{type:"f",value:891},screenWidth:{type:"f",value:950},kernel:{type:"v2v",value:[]}},vertexShader:["varying vec2 vUv;","void main() {","vec4 pos = vec4(sign(position.xy), 0.0, 1.0);","vUv = pos.xy * vec2(0.5, 0.5) + 0.5;","gl_Position = pos;","}"].join("\n"),fragmentShader:["uniform sampler2D tNormalDepth;","uniform mat4 ProjectionMatrixInverse;","uniform mat4 ProjectionMatrix;","uniform float SamplingRadius;","uniform float OccluderBias;","uniform float Intensity;","uniform float screenHeight;","uniform float screenWidth;","uniform int NbDirection;","uniform int NbSamples;","uniform vec2 kernel[16];","const int NbDirectionMax = 10;","const int NbSamplesMax   = 10;","const float Sin45        = 0.707107;","varying vec2 vUv;","vec2 getRandom( vec2 uv){","    float rand=(fract(uv.x*(screenWidth/2.0))*0.25)+(fract(uv.y*(screenHeight/2.0))*0.5);","    return normalize(vec2(rand,rand));","}","float random(vec3 scale, float seed) {","    return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","vec3 uniformlyRandomDirection(float seed) {","    float u = random(vec3(12.9898, 78.233, 151.7182), seed);","    float v = random(vec3(63.7264, 10.873, 623.6736), seed);","    float z = 1.0-2.0 * u ;","    float r = sqrt(1.0 - z * z);","    float angle = 6.283185307179586 * v;","    return vec3(r * cos(angle), r * sin(angle),z);","}","vec3 uniformlyRandomVector(float seed) {","    return uniformlyRandomDirection(seed) * sqrt(random(vec3(36.7539, 50.3658,306.2759), seed));","}","vec3 getPosition(vec2 uv) {","    vec4 normalDepth = texture2D( tNormalDepth, uv );","    float z = normalDepth.w;","    vec2 xy = uv * 2.0 - 1.0;","    vec4 posProjected = vec4( xy, z, 1.0 );","    vec4 posVS = ProjectionMatrixInverse * posProjected;","    posVS.xyz /= posVS.w;","    posVS.w = 1.0;","    return posVS.xyz;","}","float AmbientOcclusionCalcul(vec3 Position,  vec3 Normale, vec2 uv){","    vec3 VpxToSample = getPosition(uv) - Position;","    vec3 v           = normalize(VpxToSample);","    float Dist       = length(VpxToSample);","    return max(dot(v,Normale) - OccluderBias,0.0)","           *( 1.0/(1.0 + Dist))","           * Intensity;","}","void main() {",c.computeVertexPositionVS,c.computeNormal,"vec2 randVec    = vec2(uniformlyRandomVector( vUv.x + vUv.y ));","vec2 TexelSize  = vec2(1.0/screenWidth, 1.0/screenHeight);","float srcDepth  = -z;","float occlusion = 0.0;","float kernelRadius = SamplingRadius * (1.0 - srcDepth);","int var = 0;","for (int i = 0; i < NbDirectionMax; ++i) {","    if(i < NbDirection) {","        vec2 k1 = reflect(kernel[i], randVec);","        vec2 k2 = vec2(k1.x * Sin45 - k1.y * Sin45, k1.x * Sin45 + k1.y * Sin45);","        k1 *= TexelSize;","        k2 *= TexelSize;","        var = 0;","        for(int j=1; j<=NbSamplesMax; j++) {","            if(j < NbSamples) {","                if(var == 0) {","                    occlusion += AmbientOcclusionCalcul(vertexPositionVS.xyz, normal, vUv + k1 * kernelRadius * 1.0/float(j));","                    var = 1;","                } else {","                    occlusion += AmbientOcclusionCalcul(vertexPositionVS.xyz, normal, vUv + k2 * kernelRadius * 1.0/float(j));","                    var=0;","                }","            } else {","                break;","            }","        }","    } else {","        break;","    }","}","occlusion = 1.0 - occlusion / 16.0;","occlusion = clamp(occlusion, 0.0, 1.0);","gl_FragColor = vec4(vec3(occlusion), 1.0);","}"].join("\n")};return a});define("Shaders/SSAOShader",["DS/Shaders/SSAOShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/SSAOShader");return b});define("DS/Plugins/UserSceneGraphPass",["DS/Plugins/UserPass","DS/Plugins/RenderPass"],function(a,c){function b(e){return e?true:false}"use strict";var d=a.extend({init:function(e){this._parent(e);this.mainPass=new c(null,null,null,null,null,null,"_UserSceneGraphPass_"+this.id+"_"+this.name);this.sectionCappingPass=new c(null,null,null,true,false,false,"passSectionCappingFrontFaces");this.sectionCappingPass.setRenderCuttingElements(true);this.sectionCappingPass.setEnableStencilTest(true);this.sectionCappingPass.setEnableStencilWrite(true);this.sectionCappingPass.setDisableColorWrite(true);this.sectionCappingPass.setDisableDepthWrite(true);this.sectionCappingPass.setStencilFunc("ALWAYS");this.sectionCappingPass.setStencilOps("INCR_WRAP","DECR_WRAP");this.sectionCappingPass.setDisableBackFaceCulling(true);this.sectionCappingPass.setHideSurfacesAndUnclippedMeshes(true);this.sectionCappingPass.setDisableBackFaceClipPlanes(+1);this.sectionCappingPass.setRenderPluginsPre(false);this.sectionCappingPass.setRenderPluginsPost(false);this.sectionCappingPass.ignoreNoZ=true;this._passes.push(this.mainPass);this._passes.push(this.sectionCappingPass)},setDisableColorWrite:function(e){this._passes[0].setDisableColorWrite(b(e))},setDisableDepthWrite:function(e){this._passes[0].setDisableDepthWrite(b(e))},setDisableBackFaceCulling:function(e){this._passes[0].setDisableBackFaceCulling(b(e))},setEnableStencilWrite:function(e){this._passes[0].setEnableStencilWrite(b(e))},setEnableStencilTest:function(e){this._passes[0].setEnableStencilTest(b(e))},setStencilOps:function(f,e){this._passes[0].setStencilOps(f,e)},setStencilOpsSeparate:function(h,e,g,f){this._passes[0].setStencilOpsSeparate(h,e,g,f)},setStencilFunc:function(e){this._passes[0].setStencilFunc(e)},setCullFaceMode:function(e){this._passes[0].setCullFaceMode(e)},setDepthFunc:function(e){this._passes[0].setDepthFunc(e)},});return d});define("DS/VisuDataAccess/ProxyAbstraction",["DS/Visualization/ProxyAbstraction"],function(a){return a});define("VisuDataAccess/ProxyAbstraction",["DS/VisuDataAccess/ProxyAbstraction","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuDataAccess/ProxyAbstraction");return b});define("DS/Visualization/RenderStyle",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/RenderMode"],function(a,c,b){var d=a.extend({init:function(){this._renderMode=new b();this._renderMode._setMask(c.ShowAllRenderLineMode|c.ShowAllFaces);this._faceMode=d.FaceModes.MATERIAL;this._locked=false},setOutlineWidth:function(e){this._renderMode.setOutlineWidth(e)},setRenderMode:function(f,e){if(this._locked){return false}this._renderMode.setRenderMode(f,e);return true},setFaceMode:function(e){if(this._locked){return false}this._faceMode=d.FaceModes[e];return true},clone:function(){var e=new d();e._renderMode=this._renderMode.clone();e._faceMode=this._faceMode;return e},_lock:function(){this._locked=true}});d.FaceModes={MATERIAL:1,GAS:2,ZONLY:3,BACKGROUND:4};c.RenderStyle=d;return d});define("DS/Visualization/Node3D",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/OccurrencePath","DS/Visualization/PathElement","DS/Mesh/MeshUtils","DS/CoreEvents/ModelEvents","DS/Visualization/OccurrenceRenderingOverride","DS/Visualization/SessionNodesWithSectionProfile","DS/Visualization/ClippingContext","DS/Visualization/RenderMode","DS/Visualization/RenderStyle","DS/Visualization/MaterialApplication"],function(v,o,A,p,s,g,l,z,n,h,j,c,f){var d=5;var B=0,m=0.001;var q=new A.Matrix4();var t=function(C,D){this.node=(C!==undefined)?C:null;this.parent=null;this.children=[];this.visible;this.visibilityFree;this.pickable;this.drawInHLRender;this._needBEUpdate;this._needOverridesUpdate;this._descendantNeedsOverridesUpdate;this.matrix=null;this.material=null;this.matApp=null;this.gas=null;this._setVisible(true);this._setVisibilityFree(false);this._setPickable(true);this.setDrawInHLRender(true);this.renderPriority=null;this.scene3js=(D!==undefined)?D:null;this.renderable=null;this.renderMode=null;this.faceMode=null;this._setNeedBEUpdate(true);this.passes=null;this.pickingPriorityID=null;this.clippingContext=null;this.__rdo_visited=0;this.localMatrixOverride=null;this._bsShow=undefined;this._bsNoShow=undefined;this._bbShow=undefined;this._bbNoShow=undefined;this.occurrenceRenderingOverride=null;this.originalOverrideSet=null;this.overrideLink=null;this._setNeedOverridesUpdate(false);this._setDescendantNeedsOverridesUpdate(false);return this};t.prototype.updateMatrix=function(C,D){if(D){if(C){if(this.localMatrixOverride){this.localMatrixOverride.copy(C)}else{this.localMatrixOverride=C.clone()}}else{this.localMatrixOverride.identity()}}else{this.localMatrixOverride=null}if(this.parent){if(C){if(this.parent.matrix){if(!this.matrix){this.matrix=new A.Matrix4()}this.matrix.multiplyMatrices(this.parent.matrix,C)}else{if(this.matrix){this.matrix.copy(C)}else{this.matrix=C.clone()}}}else{if(this.parent.matrix){if(this.matrix){this.matrix.copy(this.parent.matrix)}else{this.matrix=this.parent.matrix.clone()}}else{this.matrix=new A.Matrix4()}}}else{if(C){if(this.matrix){this.matrix.copy(C)}else{this.matrix=C.clone()}}else{this.matrix=new A.Matrix4()}}};t.prototype.getViewer=function(){return this.scene3js&&this.scene3js.viewer};t.prototype.getLocalMatrix=function(){return this.localMatrixOverride||this.node._matrix||q};t.prototype.requestOverridesUpdate=function(){var C=this.parent;while(C&&!C._getDescendantNeedsOverridesUpdate()){C._setDescendantNeedsOverridesUpdate(true);C=C.parent}this.traverseWithCondition(function(D){if(!D._getNeedOverridesUpdate()){if(D.parent){D.parent._setDescendantNeedsOverridesUpdate(true)}D._setNeedOverridesUpdate(true);return true}else{return null}})};t.prototype.doesADescendantNeedOverrideUpdate=function(){return this._getDescendantNeedsOverridesUpdate()};t.prototype.isOverridesUpdateRequested=function(){return this._getNeedOverridesUpdate()};t.prototype.clearOverridesUpdateRequest=function(){this.traverseWithCondition(function(C){var D=C._getDescendantNeedsOverridesUpdate()?true:null;C._setNeedOverridesUpdate(false);C._setDescendantNeedsOverridesUpdate(false);return D})};t.prototype.updateOverrideStatus=function(E){function C(M){var G=M.originalOverrideSet;if(G&&G.lib){G.lib.length=0}var K=null,L=null;if(M.parent){K=M.parent.overrideLink;L=M.parent.originalOverrideSet}if(K&&K.lib){K.lib.length=0}var I=M.overrideLink,J;var H=G||K;if(!I){if(H){J=(G&&G.visibilityFix)||(K&&K.visibilityFix);I=H.createOverrideLink(J);M.overrideLink=I}}if(I){I.combine(G,K,L)}return I}if(E){this.traverse(function(G){C(G)})}else{this.traverse(function(G){if(G.overrideLink){G.overrideLink.reset()}})}if(this.parent){this.parent.node._updateOccurrences(this.parent,this,false)}else{var F=this.children;var D=0;for(D=0;D<F.length;D++){this.node._updateOccurrences(this,F[D],!E)}}};t.prototype._tryOverridesUpdateWithAncestors=function(D){if(this._needOverridesUpdate||this._descendantNeedsOverridesUpdate){var C=this;while(C.parent){C=C.parent}C.node._tryOverridesUpdate(D||(this.scene3js&&this.scene3js.viewer))}};t.prototype.lightCopy=function(){var C,G=this.node,F=new t(G,this.scene3js);if(this.renderable!==null){C=G.createRenderable();C.name=G.name;C._occurrence=F;F.renderable=C;if(G._occurrences[0]&&G._occurrences[0]._manipulators){var E=G._occurrences[0]._manipulators;var D;for(D in E){var H=E[D];if(!F._manipulators){F._manipulators={}}F._manipulators[D]=H}}}return F};t.prototype.traverse=function(G,E){var D,C=this.children.length,F;F=G(this,E);for(D=0;D<C;D++){this.children[D].traverse(G,F)}};t.prototype.traverseWithCondition=function(G,E){var D,C=this.children.length,F;F=G(this,E);if(F){for(D=0;D<C;D++){this.children[D].traverseWithCondition(G,F)}}};t.prototype._getRenderableOccurrences=function(H){var G,F,D,E,C;G=[];F=this.children;if(this.renderable!==null){G.push(this.renderable)}var I;for(E=0;E<F.length;E++){I=F[E];if(!H||!I.node.getExcludeFromBounding()){D=I._getRenderableOccurrences();for(C=0;C<D.length;C++){G.push(D[C])}}}return G};t.prototype.getBoundingSphere=function(E,D){var C=this._getBoundingSphere(E,D);if(C){return C.clone()}else{return null}};t.prototype.getBoundingBox=function(C){return this._getBoundingBox(C)};t.prototype._getRenderModes=function(){var D=this.scene3js&&this.scene3js.viewer;if(D&&this.renderable!==null){var C=D.renderer.renderer;return C.getRenderMode(this.renderable)._gssoMask}return 0};t.prototype._getAccurateRenderableOccurrences=function(D,J,U,P){var L=P||this.node.getRatio()>0;if(U.fixedSizeNodesStatus===A.FixedSizeFiltering.Exclude&&L){return D}var E=this.children;if(this.renderable!==null){var N=this.renderable;var C=false;if(N.visibilityFree){C=N.visible}else{C=U.space?N.visible:!N.visible}if(C){var F=[];var S=this._getRenderModes();if(!N.layer){for(var R=0;R<N.geometry.length;R++){var O=N.geometry[R];for(var Q=0;Q<O.drawingGroups.length;Q++){var T=O.drawingGroups[Q];if(T.disabled(S,U.mask)){continue}F.push(T)}}}else{var I=N.layer.layers;for(var Q=0;Q<I.length;Q++){var V=I[Q];if(V.drawableGroup.disabled(S)){continue}F.push(V)}}if(F.length>0){var M=new A.Matrix4();if(U.handleMatrix!==null){M.multiplyMatrices(new A.Matrix4().getInverse(U.handleMatrix),N._getMMMatrix())}else{M=N._getMMMatrix()}var K=U.fixedSizeNodesStatus===A.FixedSizeFiltering.CenterOnly&&L?new A.Box3(new A.Vector3(0,0,0),new A.Vector3(0,0,0)):N.boundingBox.clone();var H=new A.DGBoundingBoxArray({fastBBox:K.applyMatrix4(M),matrix:M,renderable:N});H.setDGs(F);D.push(H)}}}var G;for(var R=0;R<E.length;R++){G=E[R];if(!J||!G.node.getExcludeFromBounding()){G._getAccurateRenderableOccurrences(D,J,U,L)}}return D};t.prototype.computeAccurateBoundingBox=function(C,M,N,H){var D=C==="visibleSpace";var F=[];var E=false;var L=this;while(L!=null){E=E||L.node.getRatio()>0;L=L.parent;if(E){break}}this._getAccurateRenderableOccurrences(F,true,{space:D,handleMatrix:M,fixedSizedNodesStatus:N?N:A.FixedSizeFiltering.Include,mask:H?H:0},E);var K=[];for(var I=F.length-1;I>=0;I--){if(!F[I].renderable.geometry[0].vertexPositionArray){K.push(F[I]);F.splice(I,1)}}var G=new A.Box3();G.fromDGBoundingBoxArray(F);if(K.length){var J=this.getViewer();G.union(J.renderer.boundingBoxGPUCompute.computeBoundingBoxGPU(J,K,M))}return G};t.prototype.needsBoundingElement=function(){var D,C=this.children.length;for(D=0;D<C;D++){var E=this.children[D];if(E.localMatrixOverride||E._bsShow!==undefined||E._bsNoShow!==undefined||E._bbShow!==undefined||E._bbNoShow!==undefined||(E.overrideLink&&E.overrideLink.hasVisibilityOverride())){return true}}return false};t.prototype._getBoundingSphere=function(G,E){G=G||"visibleSpace";this._updateBoundingElements();var F=null;var D=this._bsShow!==undefined?this._bsShow:this.node._bsShow;var C=this._bsNoShow!==undefined?this._bsNoShow:this.node._bsNoShow;if(this._getVisibilityFree()){if(this._getVisible()){F=D}else{F=null}}else{if(this._getVisible()){if(G==="visibleSpace"){F=D}else{F=C}}else{if(G==="visibleSpace"){F=null}else{F=x(D&&D.clone(),C,this.node.getRatio())}}}if(!F&&!E){F=new A.Sphere()}return F};t.prototype._getBoundingBox=function(F){F=F||"visibleSpace";this._updateBoundingElements();var E=null;var D=this._bbShow!==undefined?this._bbShow:this.node._bbShow;var C=this._bbNoShow!==undefined?this._bbNoShow:this.node._bbNoShow;if(this._getVisibilityFree()){if(this._getVisible()){E=D}else{E=null}}else{if(this._getVisible()){if(F==="visibleSpace"){E=D}else{E=C}}else{if(F==="visibleSpace"){E=null}else{E=y(D&&D.clone(),C)}}}if(!E){E=new A.Box3()}return E};t.prototype.updateVisibilityFlag=function(){this._invalidateBoundingElements(false)};t.prototype.updateVisibilityFreeFlag=function(){this._invalidateBoundingElements(false)};t.prototype._invalidateBoundingElements=function(C){if(!this._getNeedBEUpdate()){this._setNeedBEUpdate(true);if(this.parent&&(!this.node.getExcludeFromBounding()||C)){this.parent._invalidateBoundingElements(false)}}};t.prototype._updateBoundingElements=function(C,E){if(!C){this.node._updateBoundingElements()}if(this._getNeedBEUpdate()){if(!this.node._getForceBoundingElements()){E=this.node._updateShadowMapsIfNeeded(E);var D=0;for(D=0;D<this.children.length;D++){this.children[D]._updateBoundingElements(true,E)}this._updateBoundingElements_internal("_bsShow","_bsNoShow",x,"bSphere");this._updateBoundingElements_internal("_bbShow","_bbNoShow",y,"bBox")}this._setNeedBEUpdate(false);if(!this.parent){if(this.scene3js){this.scene3js.boundingSphere=this._getBoundingSphere("visibleSpace").clone();this.scene3js.boundingSphere.radius=100;this.scene3js.boundingBox=this._getBoundingBox("visibleSpace").clone()}}}};t.prototype._updateBoundingElements_internal=function(K,M,F,H){if(this.node._getForceBoundingElements()){return}if(this.needsBoundingElement()){if(this.children.length){var E=0,D;var G=null,J=null;var I,L,C;for(E=0;E<this.children.length;E++){D=this.children[E];if(!D.node.getExcludeFromBounding()){I=D[K]!==undefined?D[K]:D.node[K];L=D[M]!==undefined?D[M]:D.node[M];C=D.localMatrixOverride||D.node._matrix;if(D._getVisibilityFree()){if(D._getVisible()){G=F(G,I,C,D.node.getRatio());J=F(J,I,C,D.node.getRatio())}}else{if(D._getVisible()){G=F(G,I,C,D.node.getRatio());J=F(J,L,C,D.node.getRatio())}else{J=F(J,I,C,D.node.getRatio());J=F(J,L,C,D.node.getRatio())}}}}}else{if(this._getHasExplicitBE()){G=this[K]!==undefined?this[K]:this.node[H];J=null}}this[K]=G;this[M]=J}else{this[K]=undefined;this[M]=undefined}};var k=v.extend({init:function(C){this.id=B;B++;this.linkedToSceneGraph;this._forceBoundingElements;this.excludeFromBounding;this._needBEUpdate;this.visible;this.visibilityFree;this.pickable;this.drawInHLRender;this.pickParent;this._treeModified;this.notAllowedInPathElement;this._visibilityInTree;this.isManipulator;this.modelIdentification=null;this.name=(C!==undefined)?C:"";this.parents=[];this.children=[];this.setLinkedToSceneGraph(false);this._bsShow=null;this._bsNoShow=null;this._bbShow=null;this._bbNoShow=null;this._setForceBoundingElements(false);this._matrix=new A.Matrix4();this.setExcludeFromBounding(false);this.userData=null;this._setNeedBEUpdate(true);this.material=null;this._matApp=null;this._gas=null;this._setVisible(true);this._setVisibilityFree(false);this._setPickable(true);this.setDrawInHLRender(true);this._occurrences=[];var D=new t(this,this.scene3js);this._occurrences.push(D);this._setPickParent(false);this.__setTreeModified(false);this.passes=null;this.clippingContext=null;this._renderMode=null;this.setNotAllowedInPathElement(false);this.modelEvents=undefined;this.productType="";this.persistentId=0;this._setVisibilityInTree(true);this._iconInTree="";this.pickingPriorityID=null;this.clipPolyLine=null;this.setIsManipulator(false);return this},_getPickingCameraName:function(){var C=this._occurrences;var D=C[0].passes;if(D){if(D.length===1){if(D[0]==="robot"){return"connectedRobotCamera"}else{if(D[0]==="robotOrtho"){return"robotCameraOrtho"}}}}return""},_setTreeModified:function(){if(!this._getTreeModified()){this.__setTreeModified(true);var C=0;for(C=0;C<this.parents.length;C++){this.parents[C]._setTreeModified()}}},getModelIdentification:function(){return this.modelIdentification},setModelIdentification:function(C){this.modelIdentification=C},getIdentificationObject:function(){return this.modelIdentification},setIdentificationObject:function(C){this.modelIdentification=C},setNodeUsage:function(C){this.persistentId=C},getNodeUsage:function(){return this.persistentId},isOOCNode:function(){var C=this.getNodeUsage();if(C===k.REFERENCE_NODE||C===k.INSTANCE_NODE||C===k.REPRESENTATION_NODE){return true}else{return false}},isOOCRepReference:function(){return this.getNodeUsage()===k.REPRESENTATION_NODE},isOOCReference:function(){return this.getNodeUsage()===k.REFERENCE_NODE},isOOCInstance:function(){return this.getNodeUsage()===k.INSTANCE_NODE&&!this.isOOCRepInstance()},isOOCRepInstance:function(){if(this.getNodeUsage()===k.INSTANCE_NODE){var C;for(C=0;C<this.children.length;C++){if(this.children[C].isOOCRepReference()){return true}}}return false},addChild:function(D){if(a>0){throw new Error("Attempt to modify locked node hierarchy.")}this._setTreeModified();var L,I,E,C,G,M;if(D instanceof A.Object3D){console.warn("THREE.Object3D can not be a child of Node3D. This is probably due to a migration problem.")}L=(D.parents.length<this.children.length)?D.parents.indexOf(this):this.children.indexOf(D);if(L!==-1){return false}D._invalidateBoundingElements(false,false);this.children.push(D);D.parents.push(this);var O=null;var K=this;D.traverse(function(S){var R=S.clippingContext&&S.clippingContext.planes;if(R){if(!O){O=K._getAllOwningViewers()}var Q,P;for(Q=0;Q<O.length;Q++){for(P=0;P<R.length;P++){O[Q]._addClippingPlane(R[P])}}}});this.onLinkToSceneGraph(D);E=this._occurrences.length;C=D._occurrences.length;I=0;if(!E||!C){return false}for(I=0;I<E;I++){G=this._occurrences[I];M=D._occurrences[0];if(G&&G.originalOverrideSet&&G.originalOverrideSet.onAddChild){var J=G.scene3js&&G.scene3js.viewer;G.originalOverrideSet.onAddChild(J)}if((C>1)||(M.parent!==null)){M=this._copyTree(M)}G.children.push(M);M.parent=G;this._updateOccurrences(G,M,true);M.requestOverridesUpdate()}var N,F;if(!this._getNeedBEUpdate()&&!D._areBoundingElementsIncludedInParent(this)){this._invalidateBoundingElements(false,false)}var H={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"ADD",fromNode:this,toNode:D};o.publish({event:"/VISU/onSceneGraphUpdate",data:H})},removeChild:function(D){if(a>0){throw new Error("Attempt to modify locked node hierarchy.")}this._setTreeModified();var M,N,E,C,G,O,I,F;M=this.children.indexOf(D);if(M===-1){return false}this.children.splice(M,1);N=D.parents.indexOf(this);if(N===-1){return false}D.parents.splice(N,1);this.onLinkToSceneGraph(D);var P=null;var L=this;D.traverse(function(T){var S=T.clippingContext&&T.clippingContext.planes;if(S){if(!P){P=L._getAllOwningViewers()}var R,Q;for(R=0;R<P.length;R++){for(Q=0;Q<S.length;Q++){P[R]._removeClippingPlane(S[Q])}}}});E=this._occurrences.length;C=D._occurrences.length;if(!E||!C){return false}for(I=0;I<E;I++){G=this._occurrences[I];C=D._occurrences.length;O=D._occurrences[0];if(C===1){M=G.children.indexOf(O);if(M!==-1){G.children.splice(M,1)}O.parent=null;O.material=D.material;if(D._matrix){if(!O.matrix){O.matrix=D._matrix.clone()}else{O.matrix.copy(D._matrix)}}else{O.matrix=null}if(O.renderable!==null){O.renderable.setMatrix(O.matrix,false);if(O.node.getNodeType()==="Mesh3D"||O.node.getNodeType()==="ParticlesNode3D"){if(O.material!==null){O.renderable.material=O.material}if(O.matApp!==null){O.renderable.matApp=O.matApp}if(O.gas!==null){O.renderable.gas=O.gas}if((O.scene3js!==null)&&(O.scene3js.containsObject(O.renderable))){this._removeFromVisuSelection(O.renderable);O.scene3js.remove(O.renderable);if(O.node.getNodeType()==="Mesh3D"){O.renderable.releaseVBO()}}}else{if(O.node.getNodeType()==="LightNode3D"){if((O.scene3js!==null)&&(O.scene3js.containsLight(O.renderable))){O.scene3js.remove(O.renderable)}}else{if(O.node.getNodeType()==="LensFlareNode3D"){if((O.scene3js!==null)&&(O.scene3js.containsLensFlare(O.renderable))){O.scene3js.remove(O.renderable)}}else{if(O.node.getNodeType()==="CSS2DNode"||O.node.getNodeType()==="CSS3DNode"){O.renderable.element.parentNode.removeChild(O.renderable.element);if(O.scene3js!==null){O.scene3js.remove(O.renderable)}}}}}}var J=O.scene3js&&O.scene3js.viewer;if(J&&J._sceneGraphStateVersion===2){O.traverse(function K(Q){if(Q.originalOverrideSet){Q.originalOverrideSet.onDetach(J);Q.originalOverrideSet=null}Q.overrideLink=null})}O.scene3js=null;for(F=0;F<O.children.length;F++){this._updateOccurrences(O,O.children[F],true)}}else{for(F=0;F<G.children.length;F++){O=G.children[F];if(O.node===D){break}}G.children.splice(F,1);this._deleteTree(O)}}this._removeInvalidElementsInXSO(D);if(!D.getExcludeFromBounding()){this._invalidateBoundingElements(false,false)}var H={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"REMOVE",fromNode:this,toNode:D};o.publish({event:"/VISU/onSceneGraphUpdate",data:H})},removeChildren:function(){while(this.children.length){this.removeChild(this.children[0],false)}this._invalidateBoundingElements(false,false);return true},traverse:function(I,H,F){var G,D,C=false;C=I(this,H);var E=F?this.parents:this.children;D=E.length;if(!C){for(G=0;G<D;G++){C=E[G].traverse(I,H,F);if(C){break}}}return C},traverseUnique:function(H,G,D,C){var F=[];this._traverse_internal(H,G,D,C,F);var E;for(E=0;E<F.length;E++){F[E]._occurrences[0].__rdo_visited=0}return F},_traverse_internal:function(J,H,E,F,D){if(!this._occurrences[0].__rdo_visited){D.push(this);var I,G,K=false;K=J(this,H);var C=E?this.parents:this.children;G=C.length;if(!K){for(I=0;I<G;I++){C[I]._traverse_internal(J,H,E,F,D)}}this._occurrences[0].__rdo_visited=1}},getChildrenByName:function(D,C){var E={root:this,nodes:[]};this.traverse(function(G,F){if(G.name===D){F.nodes.push(G)}return false},E,C);return E.nodes},_forceGeomType:function(C){for(var D=0;D<this.children.length;D++){this.children[D]._forceGeomType(C)}},_setRatio:function(D){for(var C=0;C<this.children.length;C++){this.children[C]._setRatio(D)}},_setFixedSizeCameraName:function(D){for(var C=0;C<this.children.length;C++){this.children[C]._setFixedSizeCameraName(D)}},_setFixedSizeCenter:function(C,E){for(var D=0;D<this.children.length;D++){this.children[D]._setFixedSizeCenter(C,E)}},getChildByName:function(D,C){var E={root:this,node:null};this.traverse(function(G,F){if(G.name===D){F.node=G;return true}return false},E,C);return E.node},getChildById:function(E,C){var D={root:this,node:null};this.traverse(function(G,F){if(G.persistentId===E){F.node=G;return true}return false},D,C);return D.node},oldSetMaterial:function(G){var F,C,H,I,E,D;this.material=G;F=this._occurrences.length;for(E=0;E<F;E++){H=this._occurrences[E];H.material=G;if(H.renderable!==null){H.renderable._gsso_cache=null;if(!A.disableJHGDev||H.material!==null){H.renderable.material=H.material}}}for(E=0;E<F;E++){H=this._occurrences[E];C=H.children.length;for(D=0;D<C;D++){I=H.children[D];this._updateOccurrences(H,I,false)}}},setMaterial:function(G){var F=this;if(G&&G._source===A.AssetSource.MATERIAL_MANAGER){console.error("Error: you can't assign a material you did not create to a Node");return}var D=function(H){if(!F.linkedToSceneGraph){return}if(H&&H._source===A.AssetSource.MATERIAL_MANAGER){H._useCount--;if(H._useCount<=0){H.dispose()}for(var I in H){if(H.hasOwnProperty(I)&&H[I] instanceof A.Texture){var J=H[I];if(J._source===A.AssetSource.MATERIAL_MANAGER){J._useCount--;if(J._useCount<=0){J.dispose()}}}}D(H.line);D(H.point)}};if(!window.newMaterialInheritance){D(this.material);this.oldSetMaterial(G);return}var C=null;if(this._matApp&&(this._matApp._material===G)){C=this._matApp}if(C){this._matApp=C;this._updateMaterial()}else{D(this._matApp?this._matApp._material:null);this._matApp=null;var E={faceMaterial:G,layer:0};if(G&&G.line){E.lineMaterial=G.line}if(G&&G.point){E.pointMaterial=G.point}C=new f(E);this._setMaterialApplication(C)}},getMaterialApplication:function(){return this._matApp},setMaterialApplication:function(C){this._setMaterialApplication(C)},removeMaterialApplication:function(){this._removeMaterialApplication()},_getMaterialApplication:function(){return this._matApp},_setMaterialApplication:function(D){var C=this._getMaterialApplication();if(C){if((D._layer<C._layer)||(D._layer===C._layer&&D._inheritance>=C._inheritance)){this._matApp=D}}else{this._matApp=D}this._updateMaterial()},_removeMaterialApplication:function(){this._matApp=null;this._updateMaterial()},_updateMaterial:function(){var F,G,E,D;F=this._occurrences.length;var C=this._getMaterialApplication();for(D=0;D<F;D++){G=this._occurrences[D];E=G.parent;if(!E&&C){G.matApp=C}else{this._updateOccurrences(E,G,false)}if(G.renderable!==null){G.renderable.matApp=G.matApp}}},setGAS:function(C){this._setGAS(C)},getGAS:function(){return this._gas},_setGAS:function(G){if(!G){return}if(this._gas){this._gas.copy(G)}else{this._gas=G.clone()}var E,F,D,C;E=this._occurrences.length;for(C=0;C<E;C++){F=this._occurrences[C];D=F.parent;if(!D){F.gas=this._gas?this._gas.clone():null}else{this._updateOccurrences(D,F,false)}if(F.renderable!==null){F.renderable.gas=F.gas}}},_getGAS:function(){return this._gas},setVisibility:function(O,L){if(this._getVisible()===O){return}var E,D,G,M,J,H;this._setVisible(O);if(L){var K=this._getViewer();var N;if(K){N=K.getRobot()}if(N){if(N.isTargetGone(K.visibleSpace)){N.setConnectionState(false)}}}E=this._occurrences.length;for(J=0;J<E;J++){G=this._occurrences[J];if(G.parent){G._setVisible(G.parent._getVisible()&&this._getVisible())}else{G._setVisible(this._getVisible())}if(G.renderable!==null){G.renderable.visible=G._getVisible();if((G.renderable.highlight!==undefined)&&(G.renderable.highlight!==null)){G.renderable.highlight.visible=G._getVisible()}if((G.renderable.preHighlight!==undefined)&&(G.renderable.preHighlight!==null)){G.renderable.preHighlight.visible=G._getVisible()}if(G.renderable instanceof A.CSS2DNode||G.renderable instanceof A.CSS3DNode){var F=true;if(this._getViewer()){F=this._getViewer().visibleSpace}var C=true;if(G._getVisibilityFree()){C=G._getVisible()}else{C=F?G._getVisible():!G._getVisible()}if(!C){G.renderable.element.style.display="none"}}}G.updateVisibilityFlag()}for(J=0;J<E;J++){G=this._occurrences[J];D=G.children.length;for(H=0;H<D;H++){M=G.children[H];this._updateOccurrences(G,M,true)}}this._updateVisibilityFlag();var I={eventChannel:"/VISU/onSceneGraphUpdate",eventType:O?"SHOWTREE":"HIDETREE",fromNode:this,toNode:null};o.publish({event:"/VISU/onSceneGraphUpdate",data:I})},setVisibilityFree:function(N){if(this._getVisibilityFree()===N){return}var E,D,G,L,J,H;this._setVisibilityFree(N);var K=this._getViewer();var M;if(K){M=K.getRobot()}if(M){if(M.isTargetGone(K.visibleSpace)){M.setConnectionState(false)}}E=this._occurrences.length;for(J=0;J<E;J++){G=this._occurrences[J];if(G.parent){G._setVisibilityFree(G.parent._getVisibilityFree()||this._getVisibilityFree())}else{G._setVisibilityFree(this._getVisibilityFree())}if(G.renderable!==null){G.renderable.visibilityFree=G._getVisibilityFree();if((G.renderable.highlight!==undefined)&&(G.renderable.highlight!==null)){G.renderable.highlight.visibilityFree=G._getVisibilityFree()}if((G.renderable.preHighlight!==undefined)&&(G.renderable.preHighlight!==null)){G.renderable.preHighlight.visibilityFree=G._getVisibilityFree()}if(G.renderable instanceof A.CSS2DNode||G.renderable instanceof A.CSS3DNode){var F=true;if(this._getViewer()){F=this._getViewer().visibleSpace}var C=true;if(G._getVisibilityFree()){C=G._getVisible()}else{C=F?G._getVisible():!G._getVisible()}if(!C){G.renderable.element.style.display="none"}}}G.updateVisibilityFreeFlag()}for(J=0;J<E;J++){G=this._occurrences[J];D=G.children.length;for(H=0;H<D;H++){L=G.children[H];this._updateOccurrences(G,L,false)}}this._updateVisibilityFreeFlag();var I={eventChannel:"/VISU/onSceneGraphUpdate",eventType:N?"VISIBILITYFREE":"VISIBILITYDEPENDENT",fromNode:this,toNode:null};o.publish({event:"/VISU/onSceneGraphUpdate",data:I})},setMatrix:function(D,C){if(!D){this._matrix=null}else{if(!this._matrix){this._matrix=new A.Matrix4().copy(D)}else{this._matrix.copy(D)}}this._updateMatrix(C)},applyMatrix:function(C){if(this._matrix){this._matrix.multiplyMatrices(C,this._matrix)}else{this._matrix=new A.Matrix4();this._matrix.copy(C)}this._updateMatrix()},setVisibilityInTree:function(C){if(this._getVisibilityInTree()===C){return}this._setVisibilityInTree(C);for(var D=0;D<this.parents.length;D++){var E={eventChannel:"/VISU/onSceneGraphUpdate",eventType:C?"ADDTREE":"REMOVETREE",fromNode:this.parents[D],toNode:this};o.publish({event:"/VISU/onSceneGraphUpdate",data:E})}},getVisibilityInTree:function(){return(this._getVisibilityInTree()!==undefined)?this._getVisibilityInTree():true},setIcon:function(C){if(C===""){this._iconInTree=""}else{this._iconInTree=C}var D={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"CHANGEICON",fromNode:this,toNode:null};o.publish({event:"/VISU/onSceneGraphUpdate",data:D})},getIcon:function(){return(this._iconInTree!==undefined)?this._iconInTree:""},setName:function(C){this.name=C;var D={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"CHANGENAME",fromNode:this,toNode:null};o.publish({event:"/VISU/onSceneGraphUpdate",data:D})},getName:function(){return this.name},getPickable:function(){if(this.getDrawInHLRender()){if(this._getPickable()){return g.PICKABLE}else{return g.NOPICKABLE}}return g.NODRAWHL},setPickable:function(G){var F,C,H,I,E,D;if(typeof G==="boolean"){console.log("boolean is DEPRECATED in setPickable() method.\n Use ENUM Mesh")}this._setPickable(G===g.PICKABLE);this.setDrawInHLRender(G!==g.NODRAWHL);F=this._occurrences.length;for(E=0;E<F;E++){H=this._occurrences[E];if(H.parent){H._setPickable(H.parent._getPickable()&&this._getPickable());H.setDrawInHLRender(H.parent.getDrawInHLRender()&&this.getDrawInHLRender())}else{H._setPickable(this._getPickable());H.setDrawInHLRender(this.getDrawInHLRender())}if(H.renderable!==null){H.renderable.pickable=H._getPickable();H.renderable.drawInHLRender=H.getDrawInHLRender()}}for(E=0;E<F;E++){H=this._occurrences[E];C=H.children.length;for(D=0;D<C;D++){I=H.children[D];this._updateOccurrences(H,I,false)}}},isPickable:function(){return this._getPickable()},setPickParent:function(C){this._setPickParent(C)},getPickParent:function(){if(this._getPickParent()){return true}else{return false}},setPickingPriorityId:function(D){var G,C,H,I,F,E;if(!this.pickingPriorityID){this.pickingPriorityID={faces:null,edges:null,points:null}}if(typeof D==="string"){this.pickingPriorityID.faces=D;this.pickingPriorityID.edges=D;this.pickingPriorityID.points=D}if(D.faces||(D.faces===null)){this.pickingPriorityID.faces=D.faces}if(D.edges||(D.edges===null)){this.pickingPriorityID.edges=D.edges}if(D.points||(D.points===null)){this.pickingPriorityID.points=D.points}G=this._occurrences.length;for(F=0;F<G;F++){H=this._occurrences[F];H.pickingPriorityID=this.pickingPriorityID;if(H.renderable!==null){H.renderable.pickingPriorityID=H.pickingPriorityID}}for(F=0;F<G;F++){H=this._occurrences[F];C=H.children.length;for(E=0;E<C;E++){I=H.children[E];this._updateOccurrences(H,I,false)}}},getPickingPriorityId:function(){return this.pickingPriorityID},exludeFromBounding:function(C){this.setExcludeFromBounding(C);this._invalidateBoundingElements(false,true)},translate:function(E,D){var C=new A.Vector3();if(this._matrix){D.transformDirection(this._matrix);C.getPositionFromMatrix(this._matrix)}C.add(D.multiplyScalar(E));if(!this._matrix){this._matrix=new A.Matrix4()}this._matrix.setPosition(C);this._updateMatrix()},translateX:function(D){var C=new A.Vector3(1,0,0);this.translate(D,C)},translateY:function(D){var C=new A.Vector3(0,1,0);this.translate(D,C)},translateZ:function(D){var C=new A.Vector3(0,0,1);this.translate(D,C)},getMaterial:function(D){var C=this._getMaterialApplication();if(!C){return this.material}if(!D||(D==="Face")){return C._material}else{if(D==="GeomFace"){return C._materialGeomFace}else{if(D==="Line"){return C._materialLine}else{if(D==="Point"){return C._materialPoint}}}}return C._material},isVisible:function(){return this._getVisible()},getMatrix:function(){return this._matrix?this._matrix.clone():new A.Matrix4()},getChildren:function(){return[].concat(this.children)},getParents:function(){return[].concat(this.parents)},getNodeType:function(){return"Node3D"},whiteVectorInBlack:function(){this.modifyColor(new A.Color(0),new A.Color(16777215))},modifyColor:function(K,I,D){if(this.getNodeType()==="Mesh3D"){var C=this._occurrences[0].renderable;var M=C.geometry;if(!(M instanceof Array)){return}for(var F=0;F<M.length;F++){var N=M[F];var O=N.drawingGroups;for(var H=0;H<O.length;H++){var L=O[H];if(L.gas&&L.gas.color){if(L.gas instanceof A.ParticleBasicMaterial){continue}var E=L.gas.color;if(D&&(D!==L.glType)){continue}if(E.equals(I)){var J=L.gas.clone();J.color=K;L.gas=J}}if(L.material&&L.material.color){if(L.material instanceof A.ParticleBasicMaterial){continue}var E=L.material.color;if(D&&(D!==L.glType)){continue}if(E.equals(I)){var G=L.material.clone();G.color=K;L.material=G}}}}}for(var H=0;H<this.children.length;H++){this.children[H].modifyColor(K,I,D)}},getBoundingSphere:function(E,D){if(E==="show"){console.warn("DEPRECATED: use visibleSpace instead of show");E="visibleSpace"}if(E==="noShow"){console.warn("DEPRECATED: use invisibleSpace instead of noShow");E="invisibleSpace"}var C=this._getBoundingSphere(E,D);if(C){return C.clone()}else{return null}},_getViewer:function(){if(this._occurrences.length>0&&this._occurrences[0].scene3js){return this._occurrences[0].scene3js.viewer}return null},_getAllOwningViewers:function(){var C=[];var D,E;for(D=0;D<this._occurrences.length;D++){if(this._occurrences[D].scene3js){E=this._occurrences[D].scene3js.viewer;if(E&&C.indexOf(E)<0){C.push(E)}}}return C},_tryOverridesUpdate:function(F){var G=F.getSceneGraphOverrideSetManager();G&&G._fullOccurrencesUpdate();var E=F?F.hasSceneGraphOverrideSet():null;var C;var D=this._occurrences;for(C=0;C<D.length;C++){D[C].traverseWithCondition(function(H){if(H.isOverridesUpdateRequested()){H.updateOverrideStatus(E);return null}else{if(H.doesADescendantNeedOverrideUpdate()){return true}else{return null}}});D[C].clearOverridesUpdateRequest()}},forceBoundingElements:function(E,C,G){function F(K){function J(N){if(!N){return null}var O=new A.Vector3(2*N.radius,2*N.radius,2*N.radius);var M=new A.Box3();M.setFromCenterAndSize(N.center,O);return M}function L(N){if(!N){return null}var M=new A.Vector3(0.5*(N.min.x+N.max.x),0.5*(N.min.y+N.max.y),0.5*(N.min.z+N.max.z));var O=M.distanceTo(N.max);var P=new A.Sphere();P.center=M;P.radius=O;return P}var I=null;if(K.sphere!==undefined||K.box!==undefined){I={sphere:K.sphere||L(K.box),box:K.box||J(K.sphere)}}return I}if(!E){if(this._getForceBoundingElements()){this._setForceBoundingElements(false);this._invalidateBoundingElements(false,false)}}else{C=C||{};G=G||{};var H=F(C),D=F(G);this.__forceBoundingElements(H,D)}},__forceBoundingElements:function(D,C){this._setForceBoundingElements(true);this._bsShow=D&&D.sphere;this._bsNoShow=C&&C.sphere;this._bbShow=D&&D.box;this._bbNoShow=C&&C.box;this._invalidateBoundingElements(false,false)},getBoundingBox:function(C){if(C==="show"){console.warn("DEPRECATED: use visibleSpace instead of show");C="visibleSpace"}if(C==="noShow"){console.warn("DEPRECATED: use invisibleSpace instead of noShow");C="invisibleSpace"}return this._getBoundingBox(C).clone()},_getBoundingSphere:function(G,E){G=G||"visibleSpace";var F=null;var D,C;if(this.getHasExplicitBE()){D=this.explicitBSphere;C=null}else{this._updateBoundingElements();D=this._bsShow;C=this._bsNoShow}if(this._getVisibilityFree()){if(this._getVisible()){F=D}else{F=null}}else{if(this._getVisible()){if(G==="visibleSpace"){F=D}else{F=C}}else{if(G==="visibleSpace"){F=null}else{F=x(D&&D.clone(),C,this.getRatio())}}}if(!F&&!E){F=new A.Sphere()}return F},_getBoundingBox:function(F){F=F||"visibleSpace";var E=null;var D,C;if(this.getHasExplicitBE()){D=this.explicitBBox;C=null}else{this._updateBoundingElements();D=this._bbShow;C=this._bbNoShow}if(this._getVisibilityFree()){if(this._getVisible()){E=D}else{E=null}}else{if(this._getVisible()){if(F==="visibleSpace"){E=D}else{E=C}}else{if(F==="visibleSpace"){E=null}else{E=y(D&&D.clone(),C)}}}if(!E){E=new A.Box3()}return E},_invalidateBoundingElements:function(D,E){if(!D){var F=0;for(F=0;F<this._occurrences.length;F++){this._occurrences[F]._invalidateBoundingElements(E)}}if(!this._getNeedBEUpdate()){this._setNeedBEUpdate(true);if(!this.getExcludeFromBounding()||E){var C=0;for(C=0;C<this.parents.length;C++){this.parents[C]._invalidateBoundingElements(true,false)}}}},_updateVisibilityFlag:function(){this._invalidateBoundingElements(false,false)},_updateVisibilityFreeFlag:function(){this._invalidateBoundingElements(false,false)},_updateShadowMapsIfNeeded:function(E){var D=this._getViewer();var C=E;if(D&&D.useShadowMap){if(C===undefined){C=true;this.traverse(function(F){if(F.getExcludeFromBounding()){C=false;return true}return false},undefined,true)}C=C&&!this.getExcludeFromBounding();if(C){D._updateShadowMaps()}}return C},_updateBoundingElements:function(C,E){var D;if(this._getNeedBEUpdate()){E=this._updateShadowMapsIfNeeded(E);if(!this._getForceBoundingElements()){for(D=0;D<this.children.length;D++){this.children[D]._updateBoundingElements(true,E)}this.updateBoundingElements_internal("_bsShow","_bsNoShow",x,"bSphere");this.updateBoundingElements_internal("_bbShow","_bbNoShow",y,"bBox")}if(!C){for(D=0;D<this._occurrences.length;D++){this._occurrences[D]._updateBoundingElements(true)}}this._setNeedBEUpdate(false)}},_areBoundingElementsIncludedInParent:function(E){var H=new A.Sphere();var G=new A.Box3();var D=this._matrix;function F(J,I){if(J&&!I){return false}if(!J){return true}H.copy(J);if(D){H.applyMatrix4(D)}if(I.containsSphere(H)){return true}return false}function C(J,I){if(J&&!I){return false}if(!J){return true}G.copy(J);if(D){G.applyMatrix4(D)}if(I.containsBox(G)){return true}return false}this._updateBoundingElements();return F(this._bsShow,E._bsShow)&&C(this._bbShow,E._bbShow)&&F(this._bsNoShow,E._bsNoShow)&&C(this._bbNoShow,E._bbNoShow)},updateBoundingElements_internal:function(J,L,E,G){if(this._getForceBoundingElements()){return}var F=null,I=null;if(this.children.length){var D=0,C;var H,K;for(D=0;D<this.children.length;D++){C=this.children[D];if(!C.getExcludeFromBounding()){H=C[J];K=C[L];if(C._getVisibilityFree()){if(C._getVisible()){F=E(F,H,C._matrix,C.getRatio());I=E(I,H,C._matrix,C.getRatio())}}else{if(C._getVisible()){F=E(F,H,C._matrix,C.getRatio());I=E(I,K,C._matrix,C.getRatio())}else{I=E(I,H,C._matrix,C.getRatio());I=E(I,K,C._matrix,C.getRatio())}}}}}else{if(this.getHasExplicitBE()){F=this[G];I=null}}this[J]=F;this[L]=I},getRatio:function(){return 0},updateBoundingSphere:function(){this._invalidateBoundingElements(false,false)},updateBoundingSphereFromParentToChildren:function(){k.DEPRECATED_Method(new Error())},updateBoundingBox:function(){this._invalidateBoundingElements(false,false)},isIncludedIn:function(D){if(!this.bSphere.radius){return true}var C=this.bSphere.clone();if(this._matrix){C.applyMatrix4(this._matrix)}return(C.center.distanceTo(D.bSphere.center)+C.radius<=D.bSphere.radius)},getMatrixWorld:function(F){var E,C;if(this._occurrences.length===1){return this._occurrences[0].matrix?this._occurrences[0].matrix.clone():new A.Matrix4()}if(F===undefined){console.warn("This node is an instance. An occurrence path has to be specified.");return null}if(F instanceof p){var D=new s();D.setFromOccurrencePath(F);F=D}C=F._getOccurrences();if(C.length>1){console.warn("More than one occurrence satisfies this occurrence path. Unable to return a unique matrixWorld.");return null}if(!C.length){console.warn("No occurrence satisfies this occurrence path. Unable to return a matrixWorld.");return null}for(E=0;E<this._occurrences.length;E++){if(C[0]===this._occurrences[E]){return C[0].matrix?C[0].matrix.clone():new A.Matrix4()}}console.warn("The occurrence path has to terminate with the current node name. Unable to return a matrixWorld.");return null},isInstance:function(){return(this._occurrences.length>1)},setScene:function(I){var F,C,G,H,E,D;F=this._occurrences.length;for(E=0;E<F;E++){G=this._occurrences[E];G.scene3js=I}for(E=0;E<F;E++){G=this._occurrences[E];C=G.children.length;for(D=0;D<C;D++){H=G.children[D];this._updateOccurrences(G,H,true)}}},subscribe:function(D,C){if(this.modelEvents===undefined){this.modelEvents=new l()}this.modelEvents.subscribe(D,C)},isReady:function(){return true},_updateMatrix:function(E){var H,C,I,J,G,F,D;H=this._occurrences.length;for(G=0;G<H;G++){I=this._occurrences[G];I.updateMatrix(this._matrix);if(I.renderable!==null){I.renderable.setMatrix(I.matrix,false);I.renderable.orientation=(!I.matrix||(I.matrix.determinant()>0))?1:-1;if((I.renderable.highlight!==undefined)&&(I.renderable.highlight!==null)){I.renderable.highlight.setMatrix(I.matrix,false)}if((I.renderable.preHighlight!==undefined)&&(I.renderable.preHighlight!==null)){I.renderable.preHighlight.setMatrix(I.matrix,false)}}}for(G=0;G<H;G++){I=this._occurrences[G];C=I.children.length;for(F=0;F<C;F++){J=I.children[F];this._updateOccurrences(I,J,true,E)}}if(!E){for(G=0,D=this.parents.length;G<D;G++){if(!this.getExcludeFromBounding()){this.parents[G]._invalidateBoundingElements(false,false)}}}},_copyTree:function(G){var F,D,C,H,E;F=G.lightCopy();G.node._occurrences.push(F);G._invalidateBoundingElements(false);C=G.children.length;for(E=0;E<C;E++){H=G.children[E];D=this._copyTree(H);D.parent=F;F.children.push(D);F._invalidateBoundingElements(false)}return F},_deleteTree:function(G){var F,D,E,C,H;F=G.node;D=F._occurrences.indexOf(G);if(D!==-1){F._occurrences.splice(D,1)}if((G.renderable!==null)&&(G.scene3js!==null)){if(G.node.getNodeType()==="Mesh3D"||G.node.getNodeType()==="ParticlesNode3D"){if(G.scene3js.containsObject(G.renderable)){this._removeFromVisuSelection(G.renderable);G.scene3js.remove(G.renderable);if(G.node.getNodeType()==="Mesh3D"){G.renderable.releaseVBO()}}}else{if(G.node.getNodeType()==="LightNode3D"){if(G.scene3js.containsLight(G.renderable)){G.scene3js.remove(G.renderable)}}else{if(G.node.getNodeType()==="LensFlareNode3D"){if(G.scene3js.containsLensFlare(G.renderable)){G.scene3js.remove(G.renderable)}}else{if(G.node.getNodeType()==="CSS2DNode"||G.node.getNodeType()==="CSS3DNode"){if(G.scene3js.containsObject(G.renderable)){G.scene3js.remove(G.renderable);G.renderable.element.parentNode.removeChild(G.renderable.element)}}}}}}var I=G.scene3js&&G.scene3js.viewer;if(I&&I._sceneGraphStateVersion===2){if(G.originalOverrideSet){G.originalOverrideSet.onDetach(I);G.originalOverrideSet=null}G.overrideLink=null}G.scene3js=null;C=G.children.length;for(E=0;E<C;E++){H=G.children[E];this._deleteTree(H)}},forceUpdate:function(){this._forceUpdate()},_forceUpdate:function(){var E,D,F,G;var C=this._getAllOwningViewers();for(E=0;E<C.length;E++){if(C[E]){this._tryOverridesUpdate(C[E])}}if(this.parents.length>0){for(E=0;E<this._occurrences.length;E++){F=this._occurrences[E];this._updateOccurrences(F.parent,F,true)}}else{for(E=0;E<this.children.length;E++){this.children[E]._forceUpdate()}}},onLinkToSceneGraph:function(G){var C=G.traverseUnique(function(K){});var H=[];var F=[];var I,E;for(I=0;I<C.length;I++){E=C[I];E._occurrences[0].__rdo_visited=0}for(I=0;I<C.length;I++){var D,J;E=C[I];for(D=0;D<E.children.length;D++){J=E.children[D];J._occurrences[0].__rdo_visited++}}G._onLinkToSceneGraph_internal(true,H,F);for(I=0;I<C.length;I++){var D,J;E=C[I];E._occurrences[0].__rdo_visited=0}for(I=H.length-1;I>=0;I--){E=H[I];E._onLinkedToSceneGraph();if(E.clipPolyLine){n.addNode(E)}}for(I=F.length-1;I>=0;I--){E=F[I];E._onUnlinkedToSceneGraph();if(E.clipPolyLine){n.removeNode(E)}}if(k._onLinkToSceneGraph_DEBUG!==null){k._onLinkToSceneGraph_DEBUG(C,H,F)}},_onLinkToSceneGraph_internal:function(C,I,G){var H=false,E;var D=C,F;for(E=0;!D&&E<this.parents.length;E++){F=this.parents[E];if(F._occurrences.length>0&&F._occurrences[0].__rdo_visited===-1){D=true}}if(D){for(E=0;E<this.parents.length;E++){if(this.parents[E].getLinkedToSceneGraph()){H=true;break}}var J;if(this.getLinkedToSceneGraph()!==H){this.setLinkedToSceneGraph(H);this._occurrences[0].__rdo_visited=-1;if(H){I.push(this)}else{G.push(this)}}for(E=0;E<this.children.length;E++){J=this.children[E];J._occurrences[0].__rdo_visited--;if(J._occurrences[0].__rdo_visited===0){J._onLinkToSceneGraph_internal(false,I,G)}}}},_propagateGAS:function(C,D){if(D){if(C.gas){C.gas.copy(D)}else{C.gas=D.clone()}}else{C.gas=null}},_propagateMatApp:function(C,D){if(D){if(C.matApp){C.matApp.copy(D)}else{C.matApp=D.clone()}}else{C.matApp=null}},_updateOccurrences:function(ad,E,N,Y){var V,L,ap,am,ae;V=ad.node;L=E.node;ap=E.scene3js;var ai=null;var aq=null;var ar=null;var ao=null;var P=null;var ab=null;var J=false;var W=false,U=false;if(E.overrideLink){if(E.renderable){if(E.overrideLink.internalMaterialOverrideReset){E.overrideLink.internalMaterialOverrideReset=false;E.renderable.layer=null}if(E.overrideLink.internalMaterialOverride&&E.originalOverrideSet){var T=E.overrideLink.internalMaterialOverride;if(T.material){ae=new s();ae.setFromArray(E.originalOverrideSet.pathElement.externalPath,T.internalPath);k._applyMaterialToPath(ae,T.material)}E.overrideLink.internalMaterialOverrideReset=true}}ai=E.overrideLink.getSubstituteMatrix();aq=E.overrideLink.getVisibility();P=E.overrideLink.getVisibilityFree();ar=E.overrideLink.getPickability();ao=E.overrideLink.getClipping();ab=E.overrideLink.getRenderStyle();W=E.overrideLink.visibilityFix;if(E.originalOverrideSet){if(E.originalOverrideSet.invalidateBE){E.originalOverrideSet.unsetInvalidateBE();J=true}}if(E.overrideLink.getMatrixUpdate()){E.overrideLink.clearMatrixUpdate();U=true}}var F=null;if(E&&E.originalOverrideSet&&(E.originalOverrideSet.hasMaterialOverride()||E.originalOverrideSet.internalMaterialOverride)){F=E.overrideLink}if(E!==null){E.scene3js=ad.scene3js;if(N||U){if(ai){E.updateMatrix(ai,true)}else{ai=L._matrix;if(L._isDynamic&&E.scene3js){var R=E.scene3js.viewer.currentViewpoint;if(R){var aj=L._getDynamicMatrix(ad.matrix,null,R);if(aj){ai=aj;if(!L._matrix){L._matrix=new A.Matrix4()}L._matrix.copy(ai);if(!Y){L._invalidateBoundingElements(false,false)}}}}if(E.localMatrixOverride){J=true}if(E._relativeMatrix){ai=new A.Matrix4();ai.multiplyMatrices(ai,E._relativeMatrix)}E.updateMatrix(ai)}}var Z=ad.getViewer();E.renderMode=(ab&&ab._renderMode)||L._renderMode||ad.renderMode;var D=ab||(Z&&Z._renderStyle);E.faceMode=(D&&D._faceMode)||ad.faceMode;var S=L.passes?L.passes:ad.passes;var Q=E.scene3js&&E.scene3js.parent instanceof A.Scene?E.scene3js.parent:null;if(E.renderable&&E.renderable.fromLoadedModel){if(E.faceMode===c.FaceModes.ZONLY){S=["ZOnly"]}else{if(E.faceMode===c.FaceModes.BACKGROUND){S=["background"]}}}var af=S;var G=null;if(E.renderPriority||ad.renderPriority){G=b(ad.renderPriority,E.renderPriority)}var C=Z&&Z._renderPriorityManager&&Z._renderPriorityManager.enabled;E.renderPriority=G;var I=-1;if(C){if(!G){G=w();E.renderPriority=G}I=(G&&G.priority)||0;af=u(S,I)}var ah=af!==E.passes||(E.renderPriority&&I!==E.renderPriority.lastRenderPriority);if(E.renderPriority){E.renderPriority.lastRenderPriority=I}if(E.renderable&&Q&&ah){Q.updateObjectPasses(E.renderable,af)}E.passes=S;if(ad.material&&ad.material.force==="forceGeomTypeFACE"){E.material=L.material||ad.material}else{E.material=(ad.material!==null)?ad.material:L.material}if(ad.gas&&!L._gas){this._propagateGAS(E,ad.gas)}else{this._propagateGAS(E,L._gas)}if(ad.gas&&L._gas){E.gas.merge(ad.gas)}var ag=L._getMaterialApplication();if(ag&&ad.matApp){if((ag._inheritance!==0)&&((ag._layer<ad.matApp._layer)||((ag._layer===ad.matApp._layer)&&((ag._layer<A.MaterialLayerMax)||(ag._inheritance===2||(ag._inheritance===1&&ad.matApp._inheritance===0)))))){this._propagateMatApp(E,ag)}else{this._propagateMatApp(E,ad.matApp)}}else{if(ag){this._propagateMatApp(E,ag)}else{this._propagateMatApp(E,ad.matApp)}}var K=E._getVisible();var X=E._getVisibilityFree();if(W){E._setVisible(ad._getVisible()&&(aq?aq.visibility:L._getVisible()));E._setVisibilityFree(ad._getVisibilityFree()||(P?P.visibilityFree:L._getVisibilityFree()));E._setPickable(ad._getPickable()&&(ar?ar==="PICKABLE":L._getPickable()));E.setDrawInHLRender(ad.getDrawInHLRender()&&(ar?ar!=="IGNORED":L.getDrawInHLRender()))}else{E._setVisible(aq?aq.visibility:(ad._getVisible()&&L._getVisible()));E._setVisibilityFree(ad._getVisibilityFree()||L._getVisibilityFree());E._setPickable(ar?ar==="PICKABLE":(ad._getPickable()&&L._getPickable()));E.setDrawInHLRender(ar?ar!=="IGNORED":(ad.getDrawInHLRender()&&L.getDrawInHLRender()))}if(E._getVisible()!==K){E.updateVisibilityFlag()}if(E._getVisibilityFree()!==X){E.updateVisibilityFreeFlag()}E.pickingPriorityID=L.pickingPriorityID?L.pickingPriorityID:ad.pickingPriorityID}if(E.renderable!==null){E.renderable._gsso_cache=null;E.renderable.setMatrix(E.matrix,false);E.renderable._ratioData=L._ratioData;E.renderable.orientation=(!E.matrix||(E.matrix.determinant()>0))?1:-1;if((E.renderable.highlight!==undefined)&&(E.renderable.highlight!==null)){E.renderable.highlight.setMatrix(E.matrix,false);E.renderable.highlight.visible=E._getVisible();E.renderable.highlight.visibilityFree=E._getVisibilityFree();E.renderable.highlight._ratioData=L._ratioData}if((E.renderable.preHighlight!==undefined)&&(E.renderable.preHighlight!==null)){E.renderable.preHighlight.setMatrix(E.matrix,false);E.renderable.preHighlight.visible=E._getVisible();E.renderable.preHighlight.visibilityFree=E._getVisibilityFree();E.renderable.preHighlight._ratioData=L._ratioData}if(E.renderable instanceof A.CSS2DNode||E.renderable instanceof A.CSS3DNode){var ac=true;if(this._getViewer()){ac=this._getViewer().visibleSpace}var H=true;if(E._getVisibilityFree()){H=E._getVisible()}else{H=ac?E._getVisible():!E._getVisible()}if(!H){E.renderable.element.style.display="none"}}if(A.disableJHGDev){if(E.material!==null){E.renderable.material=E.material}}else{if(!E.material&&E.renderable._3dxmlMaterial){E.renderable.material=E.renderable._3dxmlMaterial}else{var ak=E.renderable.material;if(!ak||!ak.canvasNodeTextureSize){E.renderable.material=E.material}}}E.renderable.matApp=E.matApp;E.renderable.gas=E.gas;E.renderable.visible=E._getVisible();E.renderable.visibilityFree=E._getVisibilityFree();E.renderable.pickable=E._getPickable();E.renderable.drawInHLRender=E.getDrawInHLRender();E.renderable.pickingPriorityID=E.pickingPriorityID;if(E.scene3js!==null){if(E.node.getNodeType()==="Mesh3D"||E.node.getNodeType()==="ParticlesNode3D"||E.node.getNodeType()==="CSS3DNode"||E.node.getNodeType()==="CSS2DNode"){if(!E.scene3js.containsObject(E.renderable)){E.scene3js.add(E.renderable,E.passes);if(E.node.getNodeType()==="Mesh3D"){E.renderable.addRefVBO()}}}else{if(E.node.getNodeType()==="LightNode3D"){if(!E.scene3js.containsLight(E.renderable)){E.scene3js.add(E.renderable)}}else{if(E.node.getNodeType()==="LensFlareNode3D"){if(!E.scene3js.containsLensFlare(E.renderable)){E.scene3js.add(E.renderable)}}}}if(E.scene3js.viewer){if(!E.scene3js.viewer._lockRenderIteration){E.scene3js.viewer.renderIteration=0}if(E.renderable.castShadow){for(var al=0;al<E.scene3js.parent.__lights.length;al++){var O=E.scene3js.parent.__lights[al];if(!O.blockUpdate){O.updateShadowMap=true}}}}}else{if(ap!==null){if(E.node.getNodeType()==="Mesh3D"||E.node.getNodeType()==="ParticlesNode3D"){if(ap.containsObject(E.renderable)){this._removeFromVisuSelection(E.renderable);ap.remove(E.renderable);if(E.node.getNodeType()==="Mesh3D"){E.renderable.releaseVBO()}}}else{if(E.node.getNodeType()==="LightNode3D"){if(ap.containsLight(E.renderable)){ap.remove(E.renderable)}}else{if(E.node.getNodeType()==="LensFlareNode3D"){if(ap.containsLensFlare(E.renderable)){ap.remove(E.renderable)}}else{if(E.node.getNodeType()==="CSS2DNode"||E.node.getNodeType()==="CSS3DNode"){if(ap.containsObject(E.renderable)){ap.remove(E.renderable);E.renderable.element.parentNode.removeChild(E.renderable.element)}}}}}}}}var an=false;var M=ao||L.clippingContext;E.clippingContext=M?M._mergeWithParent(ad.clippingContext):ad.clippingContext;if(E.clippingContext!==ad.clippingContext){an=true}if(E.renderPriority!==ad.renderPriority){an=true}if(F){if(!ad.occurrenceRenderingOverride||!ad.occurrenceRenderingOverride.materialOverride||ad.occurrenceRenderingOverride.materialOverride!==F){an=true}}if(an){E.occurrenceRenderingOverride=new z();E.occurrenceRenderingOverride.clipPlanes=E.clippingContext&&E.clippingContext.planes;E.occurrenceRenderingOverride.sectionLinesProperties=E.clippingContext&&E.clippingContext.sectionLinesProperties;E.occurrenceRenderingOverride.sectionCappingMaterials=E.clippingContext&&E.clippingContext.sectionCappingMaterials;E.occurrenceRenderingOverride.materialOverride=F||(ad.occurrenceRenderingOverride&&ad.occurrenceRenderingOverride.materialOverride);E.occurrenceRenderingOverride.clippingSettings=E.clippingContext&&E.clippingContext.clippingSettings;E.occurrenceRenderingOverride.setRenderPriority(E.renderPriority)}else{E.occurrenceRenderingOverride=ad.occurrenceRenderingOverride}if(E.node._updateOccurrenceRenderingOverride){E.occurrenceRenderingOverride=E.node._updateOccurrenceRenderingOverride(E.occurrenceRenderingOverride);if(E.occurrenceRenderingOverride){E.occurrenceRenderingOverride.setReadOnly()}}if(E.renderable){E.renderable.occurrenceRenderingOverride=E.occurrenceRenderingOverride;if(E.renderable.highlight){E.renderable.highlight.occurrenceRenderingOverride=E.occurrenceRenderingOverride}}for(am=0;am<E.children.length;am++){this._updateOccurrences(E,E.children[am],N||U)}if(J){ad._invalidateBoundingElements(false)}return true},_getOccurrencesFromOccurrencePath:function(J){var F,I,C,E,D,M,L,K,H,G;if(!J.path.length){return[]}F=this.getChildByName(J.path[0]);if(F===null){F=this.getChildByName(J.path[0],1)}if(F===null){return[]}M=F._occurrences;L=[];for(G=1;G<J.path.length;G++){C=J.path[G];for(K=0;K<M.length;K++){I=M[K];E=I.children;for(H=0;H<E.length;H++){D=E[H];if(D.node.name===C){L.push(D)}}}M=L;L=[]}return M},_getRenderableOccurrencesFromOccurrencePath:function(D){var C,H,F,I,G,E;C=this._getOccurrencesFromOccurrencePath(D);H=[];for(G=0;G<C.length;G++){I=C[G];F=this._getRenderableOccurrencesFromOccurrence(I);for(E=0;E<F.length;E++){H.push(F[E])}}return H},_getRenderableOccurrencesFromOccurrence:function(H){var G,F,D,E,C;G=[];F=H.children;if(H.renderable!==null){G.push(H.renderable)}for(E=0;E<F.length;E++){D=this._getRenderableOccurrencesFromOccurrence(F[E]);for(C=0;C<D.length;C++){G.push(D[C])}}return G},_removeFromVisuSelection:function(C){o.publish({event:"/VISU/SELECTION/REMOVE",data:C})},_removeInvalidElementsInXSO:function(E){var K,J;var N=this;var O=WUX.Selection.CSOManager;var P=WUX.Selection.HSOManager;var L=WUX.Selection.PSOManager;var I=[O,P,L];for(K=0;K<I.length;K++){var H=I[K];var G=[];var D=H.get();for(J=0;J<D.length;J++){var F=D[J];var Q=F.pathElement;if(!Q&&F.options){Q=F.options.pathElement}if(!Q){continue}var M=Q._getIndexFromNode(this);if(M===-1){var C=Q.getElement(0,true)}else{if(Q.getElement(M+1,true)===E){G.push(F)}}}for(J=0;J<G.length;J++){H.remove(G[J])}}},addAsyncDependancies:function(C){console.warn("The addAsyncDependancies function doesn't do anything anymore: it shouldn't be called anymore.")},onAsyncDependancyCompleted:function(){this._onAllAsyncDependanciesCompleted()},_onAllAsyncDependanciesCompleted:function(){if(this.modelEvents!==undefined){this.modelEvents.publish("onReady")}},_onLinkedToSceneGraph:function(){},_onUnlinkedToSceneGraph:function(){},setNoZ:function(C){this.setRenderPasses(C?["noz"]:["main"])},setNoHighlightNoZ:function(C){this.setRenderPasses(C?["afterHighlightNoZ"]:["main"])},setRenderPasses:function(E){var F=E.concat([]);var D;for(D=0;D<E.length;D++){if(E[D]&&E[D]._getIdString){F[D]=E[D]._getIdString()}}E=F;var C=E;if(E.length===4&&E.indexOf("colorOld")>=0&&E.indexOf("depthOld")>=0&&E.indexOf("colorOldCapping")>=0&&E.indexOf("depthOldCapping")>=0){C=["compareOld"]}if(E.length===2&&E.indexOf("depthNew")>=0&&E.indexOf("depthNewCapping")>=0){C=["compareNew"]}this.passes=C;this._forceUpdate()},setRenderLineMode:function(D){var C=this._renderMode;if(!C){C=new j();C._useRenderPointMask=false;C._useRenderFaceMask=false;this._renderMode=C}C._setRenderLineMode(D);this._requestOverridesUpdate()},enableLocalRenderEdgeMode:function(C){var D=null;if(C){D=new j({renderLineMode:A.HideAllRenderLineMode});D._useRenderFaceMask=false;D._useRenderPointMask=false}this._renderMode=D;this._requestOverridesUpdate()},setRenderMode:function(D,C){if(!D||D.indexOf("Edge")<0){return}if(this._renderMode){this._renderMode.setRenderMode(D,C);this._requestOverridesUpdate()}},getLocalBoundingBox:function(){var E=new A.Matrix4();var O=new A.Matrix4();var P=new A.Vector3();var I=null;var N=null;var H=this._occurrences[0];var K=H.matrix;E.getInverse(K);var J=H._getRenderableOccurrences();for(var G=0;G<J.length;G++){var Q=J[G];O.multiplyMatrices(E,Q.matrix);for(var F=0;F<Q.geometry.length;F++){var M=Q.geometry[F];var L=M.vertexPositionArray;if(L){var D=L.length;if(D>=3){if(!I){P.set(L[0],L[1],L[2]);P.applyMatrix4(O);I=new A.Vector3().copy(P);N=new A.Vector3().copy(P)}for(var C=0;C<D;C+=3){P.set(L[C],L[C+1],L[C+2]);P.applyMatrix4(O);if(P.x<I.x){I.x=P.x}if(P.y<I.y){I.y=P.y}if(P.z<I.z){I.z=P.z}if(P.x>N.x){N.x=P.x}if(P.y>N.y){N.y=P.y}if(P.z>N.z){N.z=P.z}}}}}}return new A.Box3(I,N)},enableClippingPlane:function(E,D){var F,G;var C;if(D){if(!this.clippingContext){this.clippingContext=new h()}if(this.clippingContext.addPlane(E)){this._forceUpdate();C=this._getAllOwningViewers();for(F=0;F<C.length;F++){G=C[F];G._addClippingPlane(E)}}}else{if(this.clippingContext&&this.clippingContext.removePlane(E)){this._forceUpdate();C=this._getAllOwningViewers();for(F=0;F<C.length;F++){G=C[F];G._removeClippingPlane(E)}}}},setSectionCappingMaterial:function(D,C){if(!this.clippingContext){this.clippingContext=new h()}this.clippingContext.setSectionCappingMaterial(D,C);this.requestOverridesUpdate()},deleteSectionCappingMaterial:function(D){if(!this.sectionCappingMaterials){return}var C=D||null;var E=0;for(E=0;E<this.sectionCappingMaterials.length;E++){if(this.sectionCappingMaterials[E].clippingPlane===C){this.sectionCappingMaterials.splice(E,1)}}if(!this.sectionCappingMaterials.length){this.sectionCappingMaterials=null}},getSectionCappingMaterial:function(C){return this.clippingContext&&this.clippingContext.getSectionCappingMaterial(C)},removeSectionCappingMaterial:function(C){this.clippingContext&&this.clippingContext.removeSectionCappingMaterial(C)},requestOverridesUpdate:function(){var C=0;for(C=0;C<this._occurrences.length;C++){this._occurrences[C].requestOverridesUpdate()}},createRenderable:function(){return null},add:function(){this.addChild.apply(this,arguments)},remove:function(){this.removeChild.apply(this,arguments)},_requestOverridesUpdate:function(){var C;for(C=0;C<this._occurrences.length;C++){this._occurrences[C].requestOverridesUpdate()}},setClippingProfile:function(H){if(H){this.clipPolyLine={};this.clipPolyLine.planeOrigin=H.planeOrigin;this.clipPolyLine.planeU=H.planeU.clone();this.clipPolyLine.planeU.normalize();this.clipPolyLine.planeV=H.planeV.clone();this.clipPolyLine.planeV.normalize();var G=H.polyLinePoints.length;this.clipPolyLine.polyLineSize=G;var E=this.clipPolyLine.planeOrigin.dot(this.clipPolyLine.planeU);var C=this.clipPolyLine.planeOrigin.dot(this.clipPolyLine.planeV);var D=new Float32Array(G*4);var F;for(F=0;F<G;F++){D[4*F]=H.polyLinePoints[F].x+E;D[4*F+1]=H.polyLinePoints[F].y+C;D[4*F+2]=0;D[4*F+3]=1}this.clipPolyLine.clippingPolygonTexture=new A.DataTexture(D,G,1,A.RGBAFormat,A.FloatType,undefined,A.ClampToEdgeWrapping,A.ClampToEdgeWrapping,A.NearestFilter,A.NearestFilter);this.clipPolyLine.clippingPolygonTexture.needsUpdate=true;if(this.getLinkedToSceneGraph()){n.addNode(this)}}else{this.clipPolyLine=null}n.updateNode(this);var F;for(F=0;F<this._occurrences.length;F++){this._occurrences[F].requestOverridesUpdate()}},isPointOfViewDependant:function(){return false},_updateOccurrenceRenderingOverride:function(C){var D=C;if(this.clipPolyLine!==null){if(!D&&!this.clipPolyLine){return null}if(!D){D=new z()}if(D.clipPolyLine!=this.clipPolyLine){if(D.readOnly){D=D.clone()}D.clipPolyLine=this.clipPolyLine}}return D},setLocalRenderEdgeMode:function(){this.setRenderMode.apply(this,arguments)},setUserData:function(C){this.userData=C},getUserData:function(C){return this.userData}});var a=0;k._LockNodeHierarchy=function(){a++};k._UnlockNodeHierarchy=function(){a--};k._applyMaterialToPath=function(K,I){if(K===null){return false}var H=K._getRenderableOccurrences();var D=H.length;var G,C;for(G=0;G<D;G++){C=H[G];if(C){C._gsso_cache=null}}var E=K.getLastElement();if(E===null){return false}if(E instanceof k){for(var G=0;G<D;G++){var C=H[G];if(I!==null){if(!C.userData.oldMaterial){C.userData.oldMaterial=C.material}C.material=I}else{if(C.userData.oldMaterial){C.material=C.userData.oldMaterial}}}}else{if(D!==1){return false}var J=[];if(E.getType()==="rep"){var F=E.getChildren();for(var G=0;G<F.length;G++){J.push(F[G].sgNode)}}else{if(E.getType()==="primitive"){J.push(E.sgNode)}}if(H[0].layer===null){H[0].initLayers(1)}H[0].layer.addPrimitivesToLayers(J,1,I)}return true};k.DEPRECATED_SceneGraph=function(D,C){if(d!==0){console.log("[SceneGraph] DEPRECATED API USE\n"+D.stack);d--}if(!window.I_solemnly_swear_I_am_up_to_no_good&&!C){throw D}};k.DEPRECATED_Method=function(D,C){if(d!==0){console.log("[Node3D] DEPRECATED API USE\n"+D.stack);d--}};k.DEPRECATED_matrix=function(C){if(d!==0){console.warn("Node3D API : use getMatrix() accessor instead of .matrix  "+C.stack);d--;if(!d){console.warn("Node3D API : too many errors, no more errors will be reported.")}}};Object.defineProperty(k.prototype,"root",{get:function(){k.DEPRECATED_SceneGraph(new Error());return this}});Object.defineProperty(k.prototype,"bSphere",{get:function(){if(this.getHasExplicitBE()){return this.explicitBSphere}else{return this.getBoundingSphere()}},set:function(C){if(this.getHasExplicitBE()){this.explicitBSphere=C}else{throw new Error("bSphere is read-only")}}});Object.defineProperty(k.prototype,"bBox",{get:function(){if(this.getHasExplicitBE()||this.hasExplicitBE){return this.explicitBBox}else{return this.getBoundingBox()}},set:function(C){if(this.getHasExplicitBE()||this.hasExplicitBE){this.explicitBBox=C}else{throw new Error("bBox is read-only")}}});function x(G,E,D,F){if(E&&!E.isNaN()){var C=E.clone();if(F){C._updateRatio(F)}if(D){C.applyMatrix4(D)}if(!G){G=C}else{G.mergeWithSphere(C,G)}}return G}function y(G,E,C,D){if(E&&!E.isNaN()){var F=E.clone();if(D){F.max=new A.Vector3(0,0,0);F.min=new A.Vector3(0,0,0)}if(C){F.applyMatrix4(C)}if(!G){G=F}else{G.mergeWithBox(F)}}return G}Object.defineProperty(k.prototype,"matrix",{get:function(){k.DEPRECATED_matrix(new Error());return this._matrix},set:function(C){k.DEPRECATED_matrix(new Error());this._matrix=C}});var r=30;k.FORBIDDEN_ACCESS_occurrences=function(C){if(r!==0){console.log("[Node3D] INTERNAL PROPERTY ACCESS\nAccess to 'occurrences' member is strictly forbidden.\nYou must use authorized APIs.\nIf you are trying to create a pathElement using setFromOccurrence, please consider using ?new PathElement([node3d])? instead.\n"+C.stack);r--}};Object.defineProperty(k.prototype,"occurrences",{get:function(){k.FORBIDDEN_ACCESS_occurrences(new Error());return this._occurrences},set:function(C){k.FORBIDDEN_ACCESS_occurrences(new Error());this._occurrences=C}});Object.defineProperty(k.prototype,"clippingPlanes",{get:function(){return this.clippingContext&&this.clippingContext.planes},set:function(){}});function b(D,E){var C;if(!E){if(D&&(D.userPriority||D.userOpacity)){C={userPriority:false,priority:D.priority,userOpacity:false,opacity:D.opacity,lastRenderPriority:D.lastRenderPriority};return C}return{userPriority:D.userPriority,priority:D.priority,userOpacity:D.userOpacity,opacity:D.opacity,lastRenderPriority:D.lastRenderPriority}}if(!D){return{userPriority:E.userPriority,priority:E.priority,userOpacity:E.userOpacity,opacity:E.opacity,lastRenderPriority:E.lastRenderPriority}}C={userPriority:E.userPriority,priority:E.userPriority?E.priority:D.priority,userOpacity:E.userOpacity,opacity:E.userOpacity?E.opacity:D.opacity,lastRenderPriority:E.lastRenderPriority};return C}function w(){return{userPriority:false,priority:0,userOpacity:false,opacity:-1,lastRenderPriority:-1}}var e=[["renderPriority","p0"],["renderPriority","p1"],["renderPriority","p2"],["renderPriority","p3"],["renderPriority","p4"]];k.REFERENCE_NODE=-1;k.INSTANCE_NODE=-2;k.REPRESENTATION_NODE=-3;k._onLinkToSceneGraph_DEBUG=null;function u(F,E){if(!F||(F.length===1&&F[0]==="main")){return e[E]}else{var G=[],C,D;for(C=0;C<F.length;C++){D=F[C];if(D==="main"){G=G.concat(e[E])}else{G.push(D)}}return G}}t.prototype._getVisible=function(){return this.visible};t.prototype._setVisible=function(C){this.visible=C};t.prototype._getVisibilityFree=function(){return this.visibilityFree};t.prototype._setVisibilityFree=function(C){this.visibilityFree=C};t.prototype._getPickable=function(){return this.pickable};t.prototype._setPickable=function(C){this.pickable=C};t.prototype.getDrawInHLRender=function(){return this.drawInHLRender};t.prototype.setDrawInHLRender=function(C){this.drawInHLRender=C};t.prototype._getNeedBEUpdate=function(){return this._needBEUpdate};t.prototype._setNeedBEUpdate=function(C){this._needBEUpdate=C};t.prototype._getNeedOverridesUpdate=function(){return this._needOverridesUpdate};t.prototype._setNeedOverridesUpdate=function(C){this._needOverridesUpdate=C};t.prototype._getDescendantNeedsOverridesUpdate=function(){return this._descendantNeedsOverridesUpdate};t.prototype._setDescendantNeedsOverridesUpdate=function(C){this._descendantNeedsOverridesUpdate=C};k.prototype.getLinkedToSceneGraph=function(){return this.linkedToSceneGraph};k.prototype.setLinkedToSceneGraph=function(C){this.linkedToSceneGraph=C};k.prototype._getForceBoundingElements=function(){return this._forceBoundingElements};k.prototype._setForceBoundingElements=function(C){this._forceBoundingElements=C};k.prototype.getExcludeFromBounding=function(){return this.excludeFromBounding};k.prototype.setExcludeFromBounding=function(C){this.excludeFromBounding=C};k.prototype._getNeedBEUpdate=function(){return this._needBEUpdate};k.prototype._setNeedBEUpdate=function(C){this._needBEUpdate=C};k.prototype._getVisible=function(){return this.visible};k.prototype._setVisible=function(C){this.visible=C};k.prototype._getVisibilityFree=function(){return this.visibilityFree};k.prototype._setVisibilityFree=function(C){this.visibilityFree=C};k.prototype._getPickable=function(){return this.pickable};k.prototype._setPickable=function(C){this.pickable=C};k.prototype.getDrawInHLRender=function(){return this.drawInHLRender};k.prototype.setDrawInHLRender=function(C){this.drawInHLRender=C};k.prototype._getPickParent=function(){return this.pickParent};k.prototype._setPickParent=function(C){this.pickParent=C};k.prototype._getTreeModified=function(){return this._treeModified};k.prototype.__setTreeModified=function(C){this._treeModified=C};k.prototype.getNotAllowedInPathElement=function(){return this.notAllowedInPathElement};k.prototype.setNotAllowedInPathElement=function(C){this.notAllowedInPathElement=C};k.prototype._getVisibilityInTree=function(){return this._visibilityInTree};k.prototype._setVisibilityInTree=function(C){this._visibilityInTree=C};k.prototype.getIsManipulator=function(){return this.isManipulator};k.prototype.setIsManipulator=function(C){this.isManipulator=C};k.prototype.getHasExplicitBE=function(){return false};return UWA.namespace("THREEDS/Nodes/Node3D",k)});define("Visualization/Node3D",["DS/Visualization/Node3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/Node3D");return b});define("DS/SceneGraphNodes/PolyLineSectionUtils",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/OccurrenceRenderingOverride"],function(b,j,g,k){var h={makeClosedPolyLine:function(n,m,s){var p=new j.Vector3();p.subVectors(m.center,n.planeOrigin);var o=new j.Vector2(p.dot(n.planeU),p.dot(n.planeV));var q={xmin:o.x-m.radius,ymin:o.y-m.radius,xmax:o.x+m.radius,ymax:o.y+m.radius};var r=new d(q,n,s);var l=r.buildPolyLine();return l}};function c(l,q,p,o){var n=new j.Vector2();n.subVectors(q,l);var m=new j.Vector2();m.subVectors(p,o);return a(l,n,p,m)}function a(p,B,o,A){var z=B.y,t=-B.x,r=B.x*p.y-B.y*p.x;var m=A.y,l=-A.x,q=A.x*o.y-A.y*o.x;var n=z*l-t*m;if(n===0){return null}var w=(t*q-r*l)/n;var s=-(z*q-r*m)/n;return new j.Vector2(w,s)}function e(l,p,n){var o=new j.Vector2();o.subVectors(p,l);var m=new j.Vector2();m.subVectors(n,l);return o.dot(m)>=0}function f(l,r,q){var p=new j.Vector2();p.subVectors(r,l);var o=new j.Vector2();o.subVectors(q,l);var m=p.dot(o);var n=p.lengthSq();if(m>=0||m<=n){return true}return false}var d=function(m,p,o){this.bounds=m;this.points=[];this.normalExtrapolation=o;this.center=new j.Vector2((this.bounds.xmin+this.bounds.xmax)/2,(this.bounds.ymin+this.bounds.ymax)/2);this.polyLine=p;var n=[new j.Vector2(this.bounds.xmin,this.bounds.ymin),new j.Vector2(this.bounds.xmin,this.bounds.ymax),new j.Vector2(this.bounds.xmax,this.bounds.ymax),new j.Vector2(this.bounds.xmax,this.bounds.ymin)];var l;for(l=0;l<n.length;l++){this.addPoint(n[l],"corner")}};d.prototype.addPointFromLine=function(p,m,v,n,q){var t=p,o=m;if(n){t=m;o=new j.Vector2(m.x+q*(p.y-m.y),m.y-q*(p.x-m.x))}var u=false;var l=null;var s=[new j.Vector2(this.bounds.xmin,this.bounds.ymin),new j.Vector2(this.bounds.xmin,this.bounds.ymax),new j.Vector2(this.bounds.xmax,this.bounds.ymax),new j.Vector2(this.bounds.xmax,this.bounds.ymin),new j.Vector2(this.bounds.xmin,this.bounds.ymin)];var r;for(r=0;r<s.length-1&&!u;r++){l=c(t,o,s[r],s[r+1]);if(l&&e(t,o,l)){if(f(s[r],s[r+1],l)){this.addPoint(l,v);u=true}}}};d.prototype.addPoint=function(n,m){var p=new j.Vector2();p.subVectors(n,this.center);p.normalize();var s,o;if(p.y>=0){o=-1}else{o=1}s=o*Math.acos(p.x);var q,r;var l={point:n,angle:s,tag:m};for(q=0;q<this.points.length&&!r;q++){if(this.points[q].angle<s){this.points.splice(q,0,l);r=true}}if(!r){this.points.push(l)}};d.prototype.buildPolyLine=function(){var s=this.polyLine;this.addPointFromLine(new j.Vector2(s.polyLinePoints[1].x,s.polyLinePoints[1].y),new j.Vector2(s.polyLinePoints[0].x,s.polyLinePoints[0].y),"start",this.normalExtrapolation,-1);var l=s.polyLinePoints.length;this.addPointFromLine(new j.Vector2(s.polyLinePoints[l-2].x,s.polyLinePoints[l-2].y),new j.Vector2(s.polyLinePoints[l-1].x,s.polyLinePoints[l-1].y),"end",this.normalExtrapolation,+1);var m,r=-1,q=-1;for(m=0;m<this.points.length&&(r<0||q<0);m++){if(this.points[m].tag==="start"){r=m}if(this.points[m].tag==="end"){q=m}}if(r<0||q<0){return null}var o={polyLinePoints:[],planeOrigin:s.planeOrigin,planeU:s.planeU,planeV:s.planeV};o.polyLinePoints.push(this.points[r].point);var p=this.normalExtrapolation?0:1;for(m=p;m<s.polyLinePoints.length-p;m++){o.polyLinePoints.push(new j.Vector2(s.polyLinePoints[m].x,s.polyLinePoints[m].y))}o.polyLinePoints.push(this.points[q].point);var n=r<q?r+this.points.length:r;for(m=q+1;m<n;m++){o.polyLinePoints.push(this.points[m%this.points.length].point)}return o};return UWA.namespace("THREEDS/Nodes/PolyLineSectionUtils",h)});define("DS/SceneGraphNodes/CSSSVGNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/SVGLoader/SVGToNode3D","DS/Visualization/GetSVGMode"],function(d,f,e,b,a){var c;c=f.extend({init:function(l,g,n){this._parent(g);this._webGLMode=a.getWebGLMode();if(this._webGLMode){var m=new b(l);var k=m.buildNode3D();this.addChild(k);this._cssSVGNode=true;this.setPickable(e.NODRAWHL)}else{this._gNode=document.createElementNS(n.getSvgNS(),"g");this._gNode.svgV6Node=this;this._gNode.appendChild(l);this.exludeFromBounding(true);this.forbidChildren=true;var j=this._occurrences[0];var h=this.createRenderable();j.renderable=h;j.renderable.name=this.name;j.renderable._occurrence=j;this._cssSVGNode=true;this.viewer=n;this._updateSVGVisibility()}},setVisibility:function(g){if(this._webGLMode){return this._parent.apply(this,arguments)}this._setVisible(g?true:false);this._updateSVGVisibility()},setVisibilityFree:function(g){if(this._webGLMode){return this._parent.apply(this,arguments)}this._setVisibilityFree(g?true:false);this._updateSVGVisibility()},getNodeType:function(){if(this._webGLMode){return this._parent.apply(this,arguments)}return"CSSSVGNode"},createRenderable:function(){if(this._webGLMode){return this._parent.apply(this,arguments)}var g=new d.CSSSVGNode(this._gNode);g.matrixAutoUpdate=false;g.matrixWorldNeedsUpdate=false;g.pickable=false;return g},addChild:function(){if(this._webGLMode){return this._parent.apply(this,arguments)}},_updateSVGVisibility:function(){if(this._webGLMode){return}var g;if(this._getVisibilityFree()){g=this._getVisible()}else{if(this.viewer.visibleSpace){g=this._getVisible()}else{g=!this._getVisible()}}this._gNode.setAttributeNS(null,"visibility",g?"visible":"hidden")},_onLinkedToSceneGraph:function(){if(this._webGLMode){return this._parent.apply(this,arguments)}this.viewer.svgRoot.appendChild(this._gNode)},_onUnlinkedToSceneGraph:function(){if(this._webGLMode){return this._parent.apply(this,arguments)}this.viewer.svgRoot.removeChild(this._gNode)}});return c});define("DS/Visualization/Mesh3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/GraphicAttributeSet"],function(b,f,e,d,c){var g=0;var a=f.extend({init:function(o,h){this._parent(h);this.hasExpliciteBE;this._excludeFromCSO;this._excludeFromHSO;this._excludeFromPSO;this._excludeFromHL;this._excludeFromPreHL;this.isInstanceNode3D;this.setHasExplicitBE(true);this.explicitBSphere=new b.Sphere();this.explicitBBox=new b.Box3();this.mesh3js=(o!==undefined)?o:new b.Mesh();this._setExcludeFromCSO(false);this._setExcludeFromHSO(false);this._setExcludeFromPSO(false);this._setExcludeFromHL(false);this._setExcludeFromPreHL(false);this.setIsInstanceNode3D(false);this.nbInstances=0;this._bodyDim=0;var n=this;var k=function(){return n.parents[0]&&n.parents[0]._occurrences[0].scene3js?n.parents[0]._occurrences[0].scene3js.viewer.currentViewpoint:null};this._ratioData={ratio:0,center:null,vptData:k,cameraName:null};o=this.createRenderable();var j=this._occurrences[0];j.renderable=o;j.renderable.name=this.name;j.renderable._occurrence=j;if(this.mesh3js.geometry.boundingSphere){this.explicitBSphere.copy(this.mesh3js.geometry.boundingSphere)}if(this.mesh3js.geometry.boundingBox){this.explicitBBox.copy(this.mesh3js.geometry.boundingBox)}else{var m=new b.Vector3(2*this.explicitBSphere.radius,2*this.explicitBSphere.radius,2*this.explicitBSphere.radius);this.explicitBBox.setFromCenterAndSize(this.explicitBSphere.center,m)}if(!b.disableJHGDev){var l=o.geometry;if(l._type===1||(l.length>0&&l[0]._type===1)){if(o.material){this.setMaterial(o.material)}}}this._updateBEInternal();return this},getRatio:function(){return this._ratioData.ratio},getFixedSizeCenter:function(){return this._ratioData.center?this._ratioData.center.clone():null},setRatio:function(h){if(h===this._ratioData.ratio){return}var k=this._occurrences[0];if(!k){return}var j=k.renderable;if(!j){return}this._ratioData.ratio=h;this.explicitBBox.copy(j.geometry.boundingBox);this.explicitBSphere.copy(j.geometry.boundingSphere);this._updateBEInternal()},setFixedSizeCenter:function(h,j){var l=this._occurrences[0];if(!l){return}var k=l.renderable;if(!k){return}this._ratioData.center=h?h.clone():null;if(j){this._ratioData.center.multiplyScalar(j)}this.explicitBBox.copy(k.geometry.boundingBox);this.explicitBSphere.copy(k.geometry.boundingSphere);this._updateBEInternal()},setFixedSizeCameraName:function(h){this._ratioData.cameraName=h?h:"camera"},_setRatio:function(h){this.setRatio(h)},_setFixedSizeCameraName:function(h){this.setFixedSizeCameraName(h)},_setFixedSizeCenter:function(h,j){this.setFixedSizeCenter(h,j)},_updateBEInternal:function(){if(this._ratioData.ratio>0){if(this.explicitBBox){this.explicitBBox.max=new b.Vector3(0,0,0);this.explicitBBox.min=new b.Vector3(0,0,0)}if(this.explicitBSphere){if(this._ratioData.center){var h=this._ratioData.center.clone();h.multiplyScalar(1/this._ratioData.ratio);this.explicitBSphere.center.add(h)}this.explicitBSphere._updateRatio(this._ratioData.ratio)}}this._invalidateBoundingElements(false,false)},computeBoundingElements:function(){var n=this._occurrences[0];if(!n){return}var m=n.renderable;if(!m){return}var l=m.geometry.boundingBox;var h=m.geometry.boundingSphere;for(var k=0;k<m.geometry.length;k++){var j=m.geometry[k];j.computeBoundingBox();j.computeBoundingSphere();if(k){l.expandByPoint(j.boundingBox.min);l.expandByPoint(j.boundingBox.max);h.clone().mergeWithSphere(j.boundingSphere,h)}else{l.copy(j.boundingBox);h.copy(j.boundingSphere)}}for(var k=0;k<this._occurrences.length;k++){var o=this._occurrences[k];var m=this._occurrences[k].renderable;var j=m.geometry;j.boundingBox.copy(l);j.boundingSphere.copy(h);if(!m.boundingBox){m.boundingBox=new b.Box3()}if(!m.boundingSphere){m.boundingSphere=new b.Sphere()}m.boundingBox.copy(l);m.boundingSphere.copy(h);m._updateWorldCenterAndRadius()}this.explicitBBox.copy(l);this.explicitBSphere.copy(h);this._updateBEInternal()},forceBoundingSphere:function(h){this.forceBoundingElements(true,{sphere:h});this._updateBEInternal()},_forceBoundingSphere:function(h){if(!this.mesh3js){console.log("Couldn't force bounding sphere.");return}if(!this.mesh3js.geometry){console.log("Couldn't force bounding sphere.");return}this.setHasExplicitBE(true);if(!this.mesh3js.geometry.boundingSphere){this.mesh3js.geometry.boundingSphere=new b.Sphere()}this.mesh3js.geometry.boundingSphere.copy(h);this.explicitBSphere.copy(h)},forceBoundingBox:function(h){this.forceBoundingElements(true,{box:h});this._updateBEInternal()},_forceBoundingBox:function(h){if(!this.mesh3js){console.log("Couldn't force bounding box.");return}if(!this.mesh3js.geometry){console.log("Couldn't force bounding box.");return}if(!this.mesh3js.geometry.boundingBox){this.mesh3js.geometry.boundingBox=new b.Box3()}this.setHasExplicitBE(true);this.mesh3js.geometry.boundingBox.copy(h);this.explicitBBox.copy(h)},__forceBoundingElements:function(j,h){if(j){if(j.sphere){this._forceBoundingSphere(j.sphere)}if(j.box){this._forceBoundingBox(j.box)}var l;for(var k=0;k<this._occurrences.length;k++){l=this._occurrences[k];if(l.renderable!==null){l.renderable._updateWorldCenterAndRadius()}}}},_forceGeomType:function(h){var n=typeof h==="string"?b.GeomTypeEnum[h]:h;if(this.mesh3js){for(var m=0;m<this.mesh3js.geometry.length;m++){var l=this.mesh3js.geometry[m];for(var k=0;k<l.drawingGroups.length;k++){var o=l.drawingGroups[k];o._geomType=n}}}},createRenderable:function(){var l=new b.Mesh(this.mesh3js.geometry,this.mesh3js.material);l.matrixAutoUpdate=false;l.matrixWorldNeedsUpdate=false;l.visible=this.mesh3js.visible;l.pickable=this.mesh3js.pickable;l.drawInHLRender=this.mesh3js.drawInHLRender;l.renderDepth=this.mesh3js.renderDepth;l.frustumCulled=this.mesh3js.frustumCulled;l.enableNormalDepth=this.mesh3js.enableNormalDepth;l.castShadow=this.mesh3js.castShadow;l.receiveShadow=this.mesh3js.receiveShadow;l.beforeRenderCB=this.mesh3js.beforeRenderCB;l.fromLoadedModel=this.mesh3js.fromLoadedModel;l._ratioData=this.mesh3js._ratioData;l.materialMode=this.mesh3js.materialMode;l._bodyDim=this._bodyDim;if(this.mesh3js.disableMirror){l.disableMirror=this.mesh3js.disableMirror}var j=this._occurrences[0].renderable;if(j){if(j.layer){l.layer=j.layer.clone()}var k=j.selectionGroups;if(k){for(var h=0;h<k.length;h++){l.addSelectionGroup(k[h].clone())}}}this.mesh3js.copyInstancingInfos(l);return l},add:function(){return false},setRenderDepth:function(k){var h,j;if(this.mesh3js!==null){this.mesh3js.renderDepth=k}for(h=0;h<this._occurrences.length;h++){j=this._occurrences[h];if(j.renderable!==null){j.renderable.renderDepth=k}}},setFrustumCulled:function(h){var j,k;if(this.mesh3js!==null){this.mesh3js.frustumCulled=h}for(j=0;j<this._occurrences.length;j++){k=this._occurrences[j];if(k.renderable!==null){k.renderable.frustumCulled=h}}},setSSAO:function(h){var j,k;if(this.mesh3js!==null){this.mesh3js.enableNormalDepth=h}for(j=0;j<this._occurrences.length;j++){k=this._occurrences[j];if(k.renderable!==null){k.renderable.enableNormalDepth=h}}},setShadow:function(h,l){var j,k;if(this.mesh3js!==null){this.mesh3js.castShadow=h;this.mesh3js.receiveShadow=l}for(j=0;j<this._occurrences.length;j++){k=this._occurrences[j];if(k.renderable!==null){k.renderable.castShadow=h;k.renderable.receiveShadow=l}}},setMirror:function(h){var j,k;if(this.mesh3js!==null){if(h){this.mesh3js.disableMirror=0}else{this.mesh3js.disableMirror=1}}for(j=0;j<this._occurrences.length;j++){k=this._occurrences[j];if(k.renderable!==null){if(h){k.renderable.disableMirror=0}else{k.renderable.disableMirror=1}}}},excludeFromCSO:function(h){this._setExcludeFromCSO(h)},excludeFromHSO:function(h){this._excludeFromHSO=h},excludeFromPSO:function(h){this._excludeFromPSO=h},excludeFromHighlight:function(j,h){this._setExcludeFromHL(j);this._setExcludeFromPreHL(h)},clone:function(j){var l=new b.Mesh(this.mesh3js.geometry,this.mesh3js.material);var h=j?true:false;if(h){if(this.mesh3js.geometry.boundingSphere){l.geometry.boundingSphere=this.mesh3js.geometry.boundingSphere.clone()}if(this.mesh3js.geometry.boundingBox){l.geometry.boundingBox=this.mesh3js.geometry.boundingBox.clone()}}this.mesh3js.copyInstancingInfos(l);l.castShadow=this.mesh3js.castShadow;l.receiveShadow=this.mesh3js.receiveShadow;var k=new THREEDS.Nodes.Mesh(l,this.name);if(this.getIsInstanceNode3D()){k.setIsInstanceNode3D(true)}return k},getPrimitive:function(k,h){var j=this._getPrimitives(k,h);return j.length?j[0]:null},getPrimitives:function(h){return this._getPrimitives(undefined,h)},show:function(h){if(h){this._setLayer(h,1)}else{this._initLayer(1)}},hide:function(h){if(h){this._setLayer(h,0)}else{this._initLayer(0)}},setMaterial:function(h,j){if(!h||h instanceof b.Material){this._parent(h)}else{if(h){this._initLayer(1);this._setLayer(h,1,j)}}},_setGAS:function(h,j){if(!h||h instanceof c){this._parent(h)}else{if(h){this._initLayer(1);this._setLayer(h,1,undefined,j)}}},_getGas:function(h){return this._getMaterials(h,true)},_getMaterials:function(t,m){var u=this._getPrimitivesFromElts(t);var r=[];var h=this._occurrences[0].renderable;if(!h){return false}if(h.layer){for(var n=0;n<u.length;n++){var q=u[n];for(var p=0;p<h.layer.layers.length;p++){var s=h.layer.layers[p].drawableGroup;var l=h.layer.layers[p].drawableInterval;if(l.layerNum===-1){continue}if(!m&&!l.material){continue}if(m&&!l.gas){continue}for(var o=l.primitiveStart;o<l.primitiveStart+l.primitiveCount;o++){if(s.primitives[o]===q){if(m){r.push(l.gas)}else{r.push(l.material)}return r}}}}}return r},setMaterialMode:function(l){var j=l?1:(l===null)?2:0;if(this.mesh3js!==null){this.mesh3js.materialMode=j}for(var h=0;h<this._occurrences.length;h++){var k=this._occurrences[h];if(k.renderable!==null){k.renderable.materialMode=j}}},getNodeType:function(){return"Mesh3D"},getBodyDimension:function(){if(this._bodyDim){return this._bodyDim}return -1},isEditable:function(){return false},setInstancingParameters:function(q,t,v){var l;if(this.mesh3js!==undefined){l=this.mesh3js}else{return}var r=this._matApp&&this._matApp._getMaterialFromGLType(4,b.GeomTypeEnum.FACE);if(!r){r=this.material}if(!r){console.error("Error: An instancing material wasn't set to the Mesh3D.");return}else{r.isInstancingMaterial=true}this.setIsInstanceNode3D(true);this.nbInstances=q;l._instancingInfos={isInstanceNode3D:true,nbInstances:q,instancingSelectionMode:v?v:"instance",instanceAttribArrays:null,pickedInstanceId:-1};var s=new Float32Array(q);for(var p=0;p<q;p++){s[p]=5+p*5}var u={};u.id=g;g++;r.attributes={};u.instanceId={};u.instanceId.array=s;u.instanceId.buffer=null;u.instanceId.itemSize=1;r.attributes.instanceId={type:"f"};for(var o=0;o<t.length;o++){u[t[o].attribName]={};switch(t[o].type){case"f":u[t[o].attribName].array=new Float32Array(t[o].data);r.attributes[t[o].attribName]={type:"f"};u[t[o].attribName].itemSize=1;break;case"v2":if(t[o].isFlattened){u[t[o].attribName].array=new Float32Array(t[o].data)}else{u[t[o].attribName].array=new Float32Array(q*2);for(var m=0;m<q;m++){u[t[o].attribName].array[m*2]=t[o].data[m].x;u[t[o].attribName].array[m*2+1]=t[o].data[m].y}}r.attributes[t[o].attribName]={type:"v2"};u[t[o].attribName].itemSize=2;break;case"v3":if(t[o].isFlattened){u[t[o].attribName].array=new Float32Array(t[o].data)}else{u[t[o].attribName].array=new Float32Array(q*3);for(var m=0;m<q;m++){u[t[o].attribName].array[m*3]=t[o].data[m].x;u[t[o].attribName].array[m*3+1]=t[o].data[m].y;u[t[o].attribName].array[m*3+2]=t[o].data[m].z}}r.attributes[t[o].attribName]={type:"v3"};u[t[o].attribName].itemSize=3;break;case"v4":if(t[o].isFlattened){u[t[o].attribName].array=new Float32Array(t[o].data)}else{u[t[o].attribName].array=new Float32Array(q*4);for(var m=0;m<q;m++){u[t[o].attribName].array[m*4]=t[o].data[m].x;u[t[o].attribName].array[m*4+1]=t[o].data[m].y;u[t[o].attribName].array[m*4+2]=t[o].data[m].z;u[t[o].attribName].array[m*4+3]=t[o].data[m].w}}r.attributes[t[o].attribName]={type:"v4"};u[t[o].attribName].itemSize=4;break;case"m4":if(t[o].isFlattened){u[t[o].attribName].array=new Float32Array(t[o].data)}else{u[t[o].attribName].array=new Float32Array(t[o].data.length*16);for(var w=0;w<t[o].data.length;w++){var h=new Float32Array(16);h=t[o].data[w].elements;for(var p=0;p<16;p++){u[t[o].attribName].array[16*w+p]=h[p]}}}r.attributes[t[o].attribName]={type:"m4"};u[t[o].attribName].itemSize=4;u[t[o].attribName].isMat4=true;break;default:break}u[t[o].attribName].buffer=null}l._instancingInfos.instanceAttribArrays=u;if(r._PDSFXData&&r._PDSFXData.PDSFX){var k="";for(var o=0;o<t.length;o++){k+="attribute "+b.ToGLSLTypes[t[o].type].t+" "+t[o].attribName+";\n"}r._PDSFXData.pdsfxAttributesCode=k}for(var n=0;n<this._occurrences.length;n++){l.copyInstancingInfos(this._occurrences[n].renderable)}},updateInstanceAttribValue:function(l){if(!l.instanceId||!l.attribName||l.value===undefined){console.error("Error: all parameters params.instanceId, params.attribName and params.value are needed.");return}var p=this._matApp&&this._matApp._getMaterialFromGLType(4,b.GeomTypeEnum.FACE);if(!p){p=this.material}var k=this.mesh3js;if(!k._instancingInfos){console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).");return}if(l.instanceId%5!==0||l.instanceId<5||l.instanceId>k._instancingInfos.nbInstances*5){console.error("Error: the instance id is incorrect or out of range.");return}if(!(k._instancingInfos.instanceAttribArrays[l.attribName]&&p.attributes[l.attribName])){console.error("Error: the attribute "+l.attribName+" doesn't exist for this mesh node.");return}var r=l.instanceId/5-1;var q=p.attributes[l.attribName].type;var o=true;var s=k._instancingInfos.instanceAttribArrays;switch(q){case"f":if(!(typeof l.value==="number"&&!isNaN(l.value))){o=false}else{s[l.attribName].array[r]=l.value}break;case"v2":if(!(l.value instanceof b.Vector2)){o=false}else{s[l.attribName].array[r*2]=l.value.x;s[l.attribName].array[r*2+1]=l.value.y}break;case"v3":if(!(l.value instanceof b.Vector3)){o=false}else{s[l.attribName].array[r*3]=l.value.x;s[l.attribName].array[r*3+1]=l.value.y;s[l.attribName].array[r*3+2]=l.value.z}break;case"v4":if(!(l.value instanceof b.Vector4)){o=false}else{s[l.attribName].array[r*4]=l.value.x;s[l.attribName].array[r*4+1]=l.value.y;s[l.attribName].array[r*4+2]=l.value.z;s[l.attribName].array[r*4+3]=l.value.w}break;case"m4":if(!(l.value instanceof b.Matrix4)){o=false}else{var h=new Float32Array(16);h=l.value.elements;for(var n=0;n<16;n++){s[l.attribName].array[16*r+n]=h[n]}}break;default:o=true;break}if(!o){console.error("Error: the type of the new value doesn't match the type of the attribute data.");return}s[l.attribName].isDynamic=true;var j;for(var m=0;m<this._occurrences.length;m++){j=this._occurrences[m].renderable;j._instancingInfos.instanceAttribArrays[l.attribName].isDynamic=true;if(j.highlight){j.highlight._instancingInfos.instanceAttribArrays[l.attribName].isDynamic=true}}},updateInstanceAttribArray:function(l){if(!l.attribName||!l.array){return}var q=this._matApp&&this._matApp._getMaterialFromGLType(4,b.GeomTypeEnum.FACE);if(!q){q=this.material}var k=this.mesh3js;if(!k._instancingInfos){console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).");return}if(!(k._instancingInfos.instanceAttribArrays[l.attribName]&&q.attributes[l.attribName])){console.error("Error: the attribute "+l.attribName+" doesn't exist for this mesh node.");return}var p=true;var t=k._instancingInfos.instanceAttribArrays;if(l.isFlattened){if(l.array instanceof Array){l.array=new Float32Array(l.array)}t[l.attribName].array=l.array}else{var r=q.attributes[l.attribName].type;var m=l.array[0];switch(r){case"f":if(!(typeof m==="number"&&!isNaN(m))){p=false}else{t[l.attribName].array.set(new Float32Array(l.array))}break;case"v2":if(!(m instanceof b.Vector2)){p=false}else{for(var s=0;s<k._instancingInfos.nbInstances;s++){t[l.attribName].array[s*2]=l.array[s].x;t[l.attribName].array[s*2+1]=l.array[s].y}}break;case"v3":if(!(m instanceof b.Vector3)){p=false}else{for(var s=0;s<k._instancingInfos.nbInstances;s++){t[l.attribName].array[s*3]=l.array[s].x;t[l.attribName].array[s*3+1]=l.array[s].y;t[l.attribName].array[s*3+2]=l.array[s].z}}break;case"v4":if(!(m instanceof b.Vector4)){p=false}else{for(var s=0;s<k._instancingInfos.nbInstances;s++){t[l.attribName].array[s*4]=l.array[s].x;t[l.attribName].array[s*4+1]=l.array[s].y;t[l.attribName].array[s*4+2]=l.array[s].z;t[l.attribName].array[s*4+3]=l.array[s].w}}break;case"m4":if(!(m instanceof b.Matrix4)){p=false}else{var h;for(var s=0;s<k._instancingInfos.nbInstances;s++){h=l.array[s].elements;for(var o=0;o<16;o++){t[l.attribName].array[16*s+o]=h[o]}}}break;default:p=true;break}}if(!p){console.error("Error: the type of the new values don't match the type of the attribute data.");return}t[l.attribName].isDynamic=true;var j;for(var n=0;n<this._occurrences.length;n++){j=this._occurrences[n].renderable;j._instancingInfos.instanceAttribArrays[l.attribName].isDynamic=true;if(j.highlight){j.highlight._instancingInfos.instanceAttribArrays[l.attribName].isDynamic=true}}},setInstancingSelectionMode:function(l){if(this.mesh3js._instancingInfos&&this.mesh3js._instancingInfos.isInstanceNode3D){this.mesh3js._instancingInfos.instancingSelectionMode=l;var k=this._occurrences;var h=k.length;for(var j=0;j<h;j++){k[j].renderable._instancingInfos.instancingSelectionMode=l}}},_getPrimitivesFromElts:function(m){var n=[];if(m.length){if(m[0] instanceof d){for(var l=0;l<m.length;l++){if(m[l].getType()==="rep"){for(var h=0;h<m[l].sgNode.primitives.length;h++){n.push(m[l].sgNode.primitives[h])}}else{n.push(m[l].sgNode)}}}else{n=m.slice()}}return n},_setLayer:function(o,k,l,n){var j,m,h=[],p;p=this._getPrimitivesFromElts(o);if(k===-1){var m=this._occurrences[0].renderable;if(!m){return}h=m.getRenderablesFromGeometries()}else{for(j=0;j<this._occurrences.length;j++){h.push(this._occurrences[j].renderable)}}for(j=0;j<h.length;j++){m=h[j];if(!m){continue}m._gsso_cache=null;if(m.layer===null){m.initLayers(1);if(m.highlight){m.highlight.layer=m.layer.clone()}}m.layer.addPrimitivesToLayers(p,k,l,n)}},_initLayer:function(k){var h,j;for(h=0;h<this._occurrences.length;h++){j=this._occurrences[h];if(j.renderable!==null){j.renderable._gsso_cache=null;if(j.renderable.layer===null){j.renderable.initLayers(k)}}}},_removePrimitives:function(h){if(h){this._setLayer(h,-1)}},_addDynamicGeometry:function(j,h,n){var l=null;var m=this._occurrences[0].renderable;if(!m){return false}for(var k=0;k<m.geometry.length;k++){if(m.geometry[k].dynamic){l=m.geometry[k];break}}if(!l){j.dynamic=true;for(var k=0;k<this._occurrences.length;k++){m=this._occurrences[k].renderable;if(m){m.addGeometry(j)}}}else{l.merge(j,h,n)}},_optimizeBuffers:function(z){var q={invalidRatio:(z&&(z.invalidRatio!==undefined))?z.invalidRatio:0.5};var h=this._occurrences[0].renderable;if(!h){return}var m=h.geometry;if(!(m instanceof Array)){return}var t=h.layer?h.layer.layers:null;if(!t){return}var y=e.mergeGeometries({geometries:m,layers:t,invalidRatio:q.invalidRatio,force:false});if(!y){return}for(var u=0;u<this._occurrences.length;u++){var h=this._occurrences[u].renderable;if(!h){continue}h.releaseVBO();h.geometry.length=0;for(var s=0;s<y.length;s++){h.geometry.push(y[s])}for(var s=0;s<y.length;s++){y[s].addRefVBO(h)}if(y.boundingBox){h.geometry.boundingBox=y.boundingBox.clone()}if(y.boundingSphere){h.geometry.boundingSphere=y.boundingSphere.clone()}var v=h.layer.layers;var r=false;var w=[];for(var s=0;s<v.length;s++){var p=[];var x=v[s].drawableGroup;var l=v[s].drawableInterval;if((l.layerNum>0)&&l.material){r=true;for(var o=l.primitiveStart;o<l.primitiveStart+l.primitiveCount;o++){var n=x.primitives[o];if(n._newPrim){p.push(n._newPrim);delete (n._newPrim)}}w.push({layerInterval:l,primitives:p})}}h.layer=null;if(r){h.initLayers(1);for(var s=0;s<w.length;s++){h.layer.addPrimitivesToLayers(w[s].primitives,w[s].layerInterval.layerNum,w[s].layerInterval.material)}}}},_getPrimitives:function(h,n){if(h===""){h=null}var r=[];var l=this._occurrences[0].renderable;if(!l){return false}if(l.layer){for(var q=0;q<l.layer.layers.length;q++){var u=l.layer.layers[q].drawableGroup;var m=l.layer.layers[q].drawableInterval;if(m.layerNum===-1){continue}if(n&&!m.layerNum){continue}for(var p=m.primitiveStart;p<m.primitiveStart+m.primitiveCount;p++){if(h!==undefined){if(u.primitives[p].cgmId===h){r.push(d.getFromSGNode(u.primitives[p]));return r}}else{r.push(d.getFromSGNode(u.primitives[p]))}}}}else{var t=l.geometry;if(!(t instanceof Array)){return r}for(var p=0;p<t.length;p++){var s=t[p];var v=s.drawingGroups;for(var q=0;q<v.length;q++){var u=v[q];for(var o=0;o<u.primitives.length;o++){if(h!==undefined){if(u.primitives[o].cgmId===h){r.push(d.getFromSGNode(u.primitives[o]));return r}}else{r.push(d.getFromSGNode(u.primitives[o]))}}}}}return r},_setBeforeRenderCB:function(j){var h,k;if(this.mesh3js!==null){this.mesh3js.beforeRenderCB=j}for(h=0;h<this._occurrences.length;h++){k=this._occurrences[h];if(k.renderable!==null){k.renderable.beforeRenderCB=j}}}});a.prototype.getHasExplicitBE=function(){return this.hasExpliciteBE};a.prototype.setHasExplicitBE=function(h){this.hasExpliciteBE=h};a.prototype._getExcludeFromCSO=function(){return this._excludeFromCSO};a.prototype._setExcludeFromCSO=function(h){this._excludeFromCSO=h};a.prototype._getExcludeFromHSO=function(){return this._excludeFromHSO};a.prototype._setExcludeFromHSO=function(h){this._excludeFromHSO=h};a.prototype._getExcludeFromPSO=function(){return this._excludeFromPSO};a.prototype._setExcludeFromPSO=function(h){this._excludeFromPSO=h};a.prototype._getExcludeFromHL=function(){return this._excludeFromHL};a.prototype._setExcludeFromHL=function(h){this._excludeFromHL=h};a.prototype._getExcludeFromPreHL=function(){return this._excludeFromPreHL};a.prototype._setExcludeFromPreHL=function(h){this._excludeFromPreHL=h};a.prototype.getIsInstanceNode3D=function(){return this.isInstanceNode3D};a.prototype.setIsInstanceNode3D=function(h){this.isInstanceNode3D=h};return UWA.namespace("THREEDS/Nodes/Mesh",a)});define("Visualization/Mesh3D",["DS/Visualization/Mesh3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/Mesh3D");return b});define("DS/VisuLoaders/ThreeDXStreamer",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/ZipJS/zip"],function(g,b,d,f,h,m,c){var l=null;var k=new g.Box3();var e=new g.Vector3();var j=function(o){var n=document.getElementsByTagName("script");for(var q=0;q<n.length;q++){var p=n.item(q);var r=p.getAttribute("src");if(r&&r.match(o)){return r.substring(0,r.lastIndexOf("/")+1)}}return null};var a={stream:function(aj){var ag=["vertexIndexArray","vertexPositionArray","vertexNormalArray","vertexUvArray","vertexUv2Array","vertexColorArray","vertexTangentArray","vertexBinormalArray"];var ah={vertexPositionArray:1,vertexNormalArray:2,vertexUvArray:4,vertexUv2Array:8,vertexColorArray:16,vertexTangentArray:32,vertexBinormalArray:64};var u=["none","PLANAR","SPHERICAL","CUBIC","FINITE_CYLINDRICAL","INFINITE_CYLINDRICAL"];var an={1003:"NEAREST",1004:"NEAREST_MIPMAP_NEAREST",1005:"NEAREST_MIPMAP_LINEAR",1006:"LINEAR",1007:"LINEAR_MIPMAP_NEAREST",1008:"LINEAR_MIPMAP_LINEAR"};var T={1000:"REPEAT",1001:"CLAMP_TO_EDGE",1002:"MIRRORED_REPEAT"};var ae={0:"POINTS",1:"LINES",4:"TRIANGLES"};var s=!!aj.zipped||false;var R=!!aj.concat||false;var B=aj.compressNormals||false;var aE=aj.compressVertices||false;var ad=null;var N=null;var J=aj.layers||false;var A=aj.streamEdges||false;var E=aj.streamPoints||false;var X=(aj.primitives!==undefined)?aj.primitives:false;var aA=aj.reps||false;var U=aj.node?aj.node:aj;var ac=aj.metalnessToSpecularConverter?aj.metalnessToSpecularConverter:null;var r=aj.nodeCallback;var aF=aj.imageCallback;var af=aj.endCallback;var aC=null;var ao=aj.embeddedTextures||false;var q=0;var ab=0;var V=new WeakMap();var ak=0;var ai={binaries:{},vertexLayouts:{},buffers:{},images:{},textures:{},materials:{},geometries:{},nodes:{}};var ap={header:{generator:"Dassault Systemes 3DX generator",version:"3.0",upAxis:"Z",unit:"mm"},binaries:[],buffers:[],vertexLayouts:[],images:[],textures:[],materials:[],geometries:[],nodes:[],extensionsUsed:[],extensionsRequired:[],root:null};var x=new Set();var S=new Set();var Z=104857600;var K=0;var ay=1;var am={geometry:0,image:1};var al=[];var Q={json:ap,chunks:al,zipData:null};function M(aK){var aH=new ArrayBuffer(2*aK.length);var aG=new Uint16Array(aH);for(var aI=0,aJ=aK.length;aI<aJ;aI++){aG[aI]=aK.charCodeAt(aI)}return aH}function P(aL,aG,aJ,aI){var aK=aJ;for(var aH=0;aH<aI;aH++){aG[aK++]=aL[aH]}return aK}function at(aI,aG,aH){var aO=JSON.stringify(aI.json,undefined,2);var aN=M(aO);var aQ=4+aN.byteLength;if(aQ%4){aQ+=4-(aQ%4)}for(var aL=0;aL<aI.chunks.length;aL++){aQ+=aI.chunks[aL].data.byteLength;if(aQ%4){aQ+=4-(aQ%4)}}var aR=new ArrayBuffer(aQ);var aK=4;var aM=new Uint32Array(aR,0,1);var aJ=new Uint8Array(aR);aM[0]=aN.byteLength;aK=P(new Uint8Array(aN),aJ,aK,aN.byteLength);if(aK%4){aK+=4-(aK%4)}for(var aL=0;aL<aI.chunks.length;aL++){var aP=aI.chunks[aL].data;aK=P(aP,aJ,aK,aP.byteLength);if(aK%4){aK+=4-(aK%4)}}aI.concatData=aR;aG&&aG()}function W(aK,aG,aJ){if(!N){N=new c.BlobWriter()}var aN=JSON.stringify(aK.json,undefined,2);var aO=new Blob([aN],{type:"text/plain"});var aI=0;var aH=[{data:aO}];for(var aM=0;aM<aK.chunks.length;aM++){aH.push({index:aM,data:new Blob([aK.chunks[aM].data],{type:"arraybuffer"})})}function aL(){var aP=aH[aI];var aQ=!aI?"manifest.json":aK.json.binaries[aP.index].uri;ad.add(aQ,new c.BlobReader(aP.data),function(){aI++;if(aI<aH.length){aL()}else{ad.close(function(aR){aK.zipData=aR;aG&&aG()})}},null)}if(ad){aL()}else{c.createWriter(N,function(aP){ad=aP;aL()},aJ)}}function O(aH){for(var aL=0;aL<al.length;aL++){var aN=al[aL];var aM=aH.binaries[aL];aM.byteLength=aN.size;aN.data=new Uint8Array(aN.size);for(var aJ=0;aJ<aN.buffers.length;aJ++){var aO=aN.buffers[aJ];var aK=aO.buffer;var aG=aO.offset;for(var aI=0;aI<aK.byteLength;aI++){aN.data[aG+aI]=aK[aI]}}}return al}function Y(aI,aH){var aG=al[am[aH]];if(!aG||(aG.size+aI.byteLength>Z)){am[aH]=al.length;aG={size:0,buffers:[],data:null,type:aH};al.push(aG)}var aJ=aG.size;aG.buffers.push({buffer:new Uint8Array(aI.buffer,aI.byteOffset,aI.byteLength),offset:aJ});aG.size+=aI.byteLength;if(aG.size%4){aG.buffers.push({buffer:new Uint8Array(4-(aG.size%4)),offset:aG.size});aG.size+=4-(aG.size%4)}return aJ}function F(){q--;console.log("nb textures loading: "+q);if(aC&&!q){Q.chunks=O(ap);if(s){W(Q,function(){aC(Q)})}else{if(R){at(Q,function(){aC(Q)})}else{aC(Q)}}}}function w(aH,aL,aI,aJ){var aK={name:aI,format:aL};var aG=new FileReader();aG.onload=function(){var aN=new DataView(this.result);var aM=Y(aN,"image");aK.binary=n(am,"image",aJ);aK.byteOffset=aM;aK.byteLength=aN.byteLength;F()};aG.readAsArrayBuffer(aH);return aK}function v(aI,aG){var aH={name:"image_"+aI.sourceFile};var aJ=new XMLHttpRequest();aJ.open("GET",aI.sourceFile,true);aJ.responseType="blob";aJ.onload=function(aL){if(this.status===200){var aM=this.response.type;aH.format=(aM==="image/jpeg")?"jpeg":"png";var aK=new FileReader();aK.onload=function(){var aO=new DataView(this.result);var aN=Y(aO,"image");aH.binary=n(am,"image",aG);aH.byteOffset=aN;aH.byteLength=aO.byteLength;F()};aK.readAsArrayBuffer(this.response);console.log("canvas blob")}};aJ.send();return aH}function y(aL,aY,aZ){if(aL.image){if(aL.image.getContext||(aL.image.tagName&&(aL.image.tagName.toLowerCase()==="img"))){if(aL.sourceFile&&aL.sourceFile.substring(0,5)==="blob:"){var aN=ai.images[aL.sourceFile];if(!aN){q++;console.log("nb textures loading: "+q);var aG=v(aL,aY);aN={index:aY.images.length,item:aG};aY.images.push(aG);ai.images[aL.sourceFile]=aN}aZ.image=aN.index}else{var aK=aL.image;var aI="jpeg";if(!aK.getContext){if(aK.src){var aU=b.getExtension(aK.src);if(aU&&(aU.toLowerCase()==="png")){aI="png"}}aK=l?l:document.createElement("canvas");aK.width=aL.image.width;aK.height=aL.image.height;var aP=aK.getContext("2d");aP.drawImage(aL.image,0,0,aL.image.width,aL.image.height)}var aH=atob(aK.toDataURL("image/"+aI).split(",")[1]);var aT=new Array(aH.length);for(var aV=0;aV<aH.length;aV++){aT[aV]=aH.charCodeAt(aV)}var aQ=new Uint8Array(aT);var aW=new Blob([aQ],{type:"image/"+aI});var aX="img_"+ab;ab++;q++;console.log("nb textures loading: "+q);var aG=w(aW,aI,aX,aY);var aN={index:aY.images.length,item:aG};aY.images.push(aG);ai.images[aX]=aN;aZ.image=aN.index;console.log("png")}}else{if(aL.mipmaps&&aL.mipmaps.length){var aO=aL.image.width;var aM=aL.image.height;var aW=new Blob([g.ImageUtils.streamDDS(aL)],{type:"arraybuffer"});var aX="img_"+ab;ab++;q++;console.log("nb textures loading: "+q);var aG=w(aW,"dds",aX,aY);var aN={index:aY.images.length,item:aG};aY.images.push(aG);ai.images[aX]=aN;aZ.image=aN.index;console.log("dds")}else{var aO=aL.image.width;var aM=aL.image.height;var aK=l?l:document.createElement("canvas");aK.width=aO;aK.height=aM;var aP=aK.getContext("2d");var aW=aP.getImageData(0,0,aO,aM);var aJ=aW.data;if(aL.format==1021){for(var aV=0;aV<aM;aV++){for(var aS=0;aS<4*aO;aS++){aJ[(aM-aV-1)*4*aO+aS]=aL.image.data[aV*4*aO+aS]}}}else{if(aL.format==1020){for(var aV=0;aV<aM;aV++){for(var aS=0;aS<aO;aS++){for(var aR=0;aR<3;aR++){aJ[(aM-aV-1)*4*aO+aS*4+aR]=aL.image.data[aV*3*aO+aS*3+aR]}aJ[(aM-aV-1)*4*aO+aS*4+3]=255}}}else{console.log("texture format export to code :"+aL.format)}}aP.putImageData(aW,0,0,0,0,aO,aM);var aH=atob(aK.toDataURL("image/png").split(",")[1]);var aT=new Array(aH.length);for(var aV=0;aV<aH.length;aV++){aT[aV]=aH.charCodeAt(aV)}var aQ=new Uint8Array(aT);var aW=new Blob([aQ],{type:"image/png"});var aX="img_"+ab;ab++;q++;console.log("nb textures loading: "+q);var aG=w(aW,"png",aX,aY);var aN={index:aY.images.length,item:aG};aY.images.push(aG);ai.images[aX]=aN;aZ.image=aN.index;console.log("uncompressed")}}}}function aD(aK,aI,aH){var aJ;if(!aJ){var aG={anisotropy:aK.anisotropy,magFilter:an[aK.magFilter],minFilter:an[aK.minFilter],uWrap:T[aK.wrapS],vWrap:T[aK.wrapT],mapping:aI};if(aF){aF(aK,aG)}else{if(!aK.loadEndStatus||(aK.loadEndStatus==="complete")){y(aK,aH,aG)}else{if(aK.loadEndStatus==="error"){console.log("Texture corrupted: impossible to embed it in 3dx archive.");return undefined}else{aK.onLoadCallbacks.push(function(aL){y(aL,aH,aG)})}}}aJ={index:aH.textures.length,item:aG};aH.textures.push(aG)}return aJ.index}function ar(aJ,aH){var aI=ai.textures[aJ.id];if(!aI){var aG={anisotropy:aJ.anisotropy,magFilter:an[aJ.magFilter],minFilter:an[aJ.minFilter],uWrap:T[aJ.wrapS],vWrap:T[aJ.wrapT]};if(aF){aF(aJ,aG)}else{if(!aJ.loadEndStatus||(aJ.loadEndStatus==="complete")){y(aJ,aH,aG)}else{if(aJ.loadEndStatus==="error"){console.log("Texture corrupted: impossible to embed it in 3dx archive.");return undefined}else{aJ.onLoadCallbacks.push(function(aK){y(aK,aH,aG)})}}}aI={index:aH.textures.length,item:aG};aH.textures.push(aG);ai.textures[aJ.id]=aI}return aI.index}function aq(aG){return[aG.r,aG.g,aG.b]}function aB(aO,aK){var aL="Phong";if(aO instanceof g.ParticleBasicMaterial){aL="PointBasic"}else{if(aO instanceof g.LineBasicMaterial){aL="LineBasic"}else{if(aO instanceof g.MeshBasicMaterial){aL="MeshBasic"}else{if(aO instanceof g.PhysicalMaterial){aL="Physical";var aI="EXT_Material_PBR";if(!x.has(aI)){x.add(aI);ap.extensionsUsed.push(aI)}if(!S.has(aI)){S.add(aI);ap.extensionsRequired.push(aI)}}else{if(aO instanceof g.MeshLambertMaterial){aL="Lambert"}}}}}var aP={type:aL,visible:aO.visible,side:aO.side,transparent:aO.transparent,alphaTest:aO.alphaTest,depthTest:aO.depthTest,depthWrite:aO.depthWrite};if(!(aO instanceof g.PhysicalMaterial)){aP.opacity=aO.opacity;if(aO.color){aP.color=aq(aO.color)}if(aO instanceof g.ParticleBasicMaterial){aP.size=aO.size;aP.sizeAttenuation=aO.sizeAttenuation}if(aO instanceof g.LineBasicMaterial){aP.lineWidth=aO.lineWidth}if((aO instanceof g.MeshPhongMaterial)||(aO instanceof g.MeshLambertMaterial)){aP.ambient=aq(aO.ambient);aP.shininess=aO.shininess}if((aO instanceof g.MeshPhongMaterial)||(aO instanceof g.MeshLambertMaterial)){aP.emissive=aq(aO.emissive);if(aO.specular){aP.specular=aq(aO.specular)}aP.vertexColors=aO.vertexColors;if(aO.map){aP.diffuseMap=ar(aO.map,aK)}if(aO.bumpMap){aP.bumpMap=ar(aO.bumpMap,aK)}if(aO.normalMap){aP.normalMap=ar(aO.normalMap,aK)}if(aO.specularMap){aP.specularMap=ar(aO.specularMap,aK)}if(aO.lightMap){aP.lightMap=ar(aO.lightMap,aK)}if(aO.bumpMap&&(aO.bumpScale!==undefined)){aP.bumpMapScale=aO.bumpScale}if(aO.normalMap&&(aO.normalScale!==undefined)){aP.normalMapScale=aO.normalScale}}}else{var aM=function(aS,aU,aT){aP[aS]={};var aX=aP[aS];if(typeof aO[aU]!=="undefined"){if(typeof aO[aU+"Map"]==="undefined"){aX=typeof aO[aU]==="number"?aO[aU]:aO[aU].x;return}aX.value=typeof aO[aU]==="number"?aO[aU]:aO[aU].x}if(aO[aU+"Map"]){if(aT){var aV=aO[aU+"UvTransform"].elements;var aT;if(aO.mappingType>0){aT={operator:{type:u[aO.mappingType],transform:aO.mappingObjTransformation.elements},uvTransform:[aV[0],aV[1],aV[2],0,aV[3],aV[4],aV[5],0,aV[6],aV[7],aV[8],0,0,0,0,1]}}else{var aW="TEXCOORD_0";if(aO.uvSlots[aU+"Map"]&&aO.uvSlots[aU+"Map"]===2){aW="TEXCOORD_1"}aT={slot:"slot",uvTransform:[aV[0],aV[1],aV[2],0,aV[3],aV[4],aV[5],0,aV[6],aV[7],aV[8],0,0,0,0,1]}}aX.texture=aD(aO[aU+"Map"],aT,aK)}else{aX.texture=ar(aO[aU+"Map"],aK)}}if(aO[aU+"MulCoef"]>0){aX.MADCoefficients=[aO[aU+"MulCoef"],aO[aU+"AddCoef"]]}};var aN=function(aS,aU,aT){aP[aS]={};var aX=aP[aS];if(typeof aO[aU+"Map"]==="undefined"){aX=aq(aO[aU]);return}aX.value=aq(aO[aU]);if(aO[aU+"Map"]){if(aT){var aV=aO[aU+"UvTransform"].elements;var aT;if(aO.mappingType>0){aT={operator:{type:u[aO.mappingType],transform:aO.mappingObjTransformation.elements},uvTransform:[aV[0],aV[1],aV[2],0,aV[3],aV[4],aV[5],0,aV[6],aV[7],aV[8],0,0,0,0,1]}}else{var aW="TEXCOORD_0";if(aO.uvSlots[aU+"Map"]&&aO.uvSlots[aU+"Map"]===2){aW="TEXCOORD_1"}aT={slot:aW,uvTransform:[aV[0],aV[1],aV[2],0,aV[3],aV[4],aV[5],0,aV[6],aV[7],aV[8],0,0,0,0,1]}}aX.texture=aD(aO[aU+"Map"],aT,aK)}else{aX.texture=ar(aO[aU+"Map"],aK)}}if(aO[aU+"MulCoef"]){aX.MADCoefficients=[aO[aU+"MulCoef"].x,aO[aU+"MulCoef"].y,aO[aU+"MulCoef"].z,aO[aU+"AddCoef"].x,aO[aU+"AddCoef"].y,aO[aU+"AddCoef"].z]}};var aH=function(aS,aU,aT){aP[aS]={};var aX=aP[aS];if(aO[aU+"Map"]){if(aO[aU+"MapFlipY"]){aP[aU+"MapFlipY"]=aO[aU+"MapFlipY"]}if(aT){var aV=aO[aU+"UvTransform"].elements;var aT;if(aO.mappingType>0){aT={operator:{type:u[aO.mappingType],transform:aO.mappingObjTransformation.elements},uvTransform:[aV[0],aV[1],aV[2],0,aV[3],aV[4],aV[5],0,aV[6],aV[7],aV[8],0,0,0,0,1]}}else{var aW="TEXCOORD_0";if(aO.uvSlots[aU+"Map"]&&aO.uvSlots[aU+"Map"]===2){aW="TEXCOORD_1"}aT={slot:aW,uvTransform:[aV[0],aV[1],aV[2],0,aV[3],aV[4],aV[5],0,aV[6],aV[7],aV[8],0,0,0,0,1]}}aX.texture=aD(aO[aU+"Map"],aT,aK)}else{aX.texture=ar(aO[aU+"Map"],aK)}}};aP.albedo={};aP.albedo.value=aq(aO.color);if(aO.map){var aJ=aO.diffuseUvTransform.elements;var aG;if(aO.mappingType>0){aG={operator:{type:u[aO.mappingType],transform:aO.mappingObjTransformation.elements},uvTransform:[aJ[0],aJ[1],aJ[2],0,aJ[3],aJ[4],aJ[5],0,aJ[6],aJ[7],aJ[8],0,0,0,0,1]}}else{var aQ="TEXCOORD_0";if(aO.uvSlots.diffuseMap&&aO.uvSlots.diffuseMap===2){aQ="TEXCOORD_1"}aG={slot:aQ,uvTransform:[aJ[0],aJ[1],aJ[2],0,aJ[3],aJ[4],aJ[5],0,aJ[6],aJ[7],aJ[8],0,0,0,0,1]}}aP.albedo.texture=aD(aO.map,aG,aK)}if(aO.diffuseMulCoef){aP.albedo.MADCoefficients=[aO.diffuseMulCoef.x,aO.diffuseMulCoef.y,aO.diffuseMulCoef.z,aO.diffuseAddCoef.x,aO.diffuseAddCoef.y,aO.diffuseAddCoef.z]}aM("metallic","metalness",true);aM("roughness","roughness",true);aM("glossiness","glossiness",false);aM("anisotropy","anisotropy",true);aM("anisotropyRotation","anisotropyAngle",true);aH("normal","normal",true);aM("normalScale","normalScale",false);aM("transparency","transparency",true);aM("cutoutOpacity","opacity",true);aM("sheen","sheen",true);aP.sheenMode=aO.sheenMode;aM("specular","specularContrib",true);aN("specularTint","specular",true);aM("clearcoat","clearCoat",true);aM("clearcoatRoughness","clearCoatRoughness",true);aH("clearcoatNormal","clearCoatNormal",true);aM("clearcoatNormalScale","clearCoatNormalScale",false);aM("orangePeelScale","orangePeelScale",false);aP.orangePeel=aO.orangePeel;if(typeof aO.flakes!=="undefined"){aP.flakes=aO.flakes;aM("flakesRoughness","flakesRoughness",false);aM("flakesDensity","flakesDensity",false);aM("flakesScale","flakesScale",false);aM("flakesBump","flakesBump",false);aN("flakesColor","flakesColor",false);aM("pearlFlakesDensity","pearlFlakesDensity",false);aM("pearlFlakesBump","pearlFlakesBump",false);aN("pearlFlakesColor","pearlFlakesColor",false)}else{aN("flakeColor","flakesColor",true);aM("flakeRoughness","flakesRoughness",true);aM("flakeSize","flakesSize",true);aM("flakeCoverage","flakesCoverage",true)}aN("emissionColor","emissionColor",true);aM("emissionValue","emissionValue",false);aP.emissionEnergyNormalization=aO.emissionNormalized;aP.emissionMode="LUMINOUS_EMITTANCE";aP.thinWalled=aO.thinWalled;aM("ior","ior",false);aM("translucencyScale","translucencyScale",false);aN("attenuationColor","attenuationColor",false);aM("attenuationDistance","attenuationDistance",false);aN("subsurfaceColor","subsurfaceColor",false);aM("subsurfacePreset","subsurfacePreset",false);aM("displacement","displacement",false);aP.vertexColors=aO.vertexColors;aP.alphaTest=aO.alphaTest;if(aO.lightMap){aP.lightMap=ar(aO.lightMap,aK)}if(aO.occlusionMap){aP.occlusionMap=ar(aO.occlusionMap,aK)}aP.uv0Transform=[];aO.mappingUVTransformation.flattenToArray(aP.uv0Transform);var aR=aP;aP={extensions:{EXT_Material_PBR:aR}}}return aP}function n(aI,aH,aG){var aK=aI[aH];var aJ=aG.binaries[aK];if(!aJ){aG.binaries[aK]={uri:aH+"_"+aK+".bin",byteLength:0}}return aK}function L(aJ,aH){var aI=Y(aJ,"geometry");var aG={binary:n(am,"geometry",aH),byteOffset:aI,byteLength:aJ.byteLength};return aG}function D(aI,aH){var aG=L(aI,aH);if(aI instanceof Uint32Array){aG.format="UNSIGNED_INT"}else{aG.format="UNSIGNED_SHORT"}aH.buffers.push(aG);return aH.buffers.length-1}function t(aI,aH){var aG=L(aI,aH);aH.buffers.push(aG);return aH.buffers.length-1}function p(aR){var aL=aR.length/3;var aN=new Uint8Array(aL*3);for(var aK=0;aK<aL;aK++){var aM=aR[3*aK];var aJ=aR[3*aK+1];var aI=aR[3*aK+2];var aP=Math.abs(aM)+Math.abs(aJ)+Math.abs(aI);var aQ=aM/aP;var aO=aJ/aP;if(aI<0){var aH=(1-Math.abs(aO))*(aQ>=0?1:-1);var aG=(1-Math.abs(aQ))*(aO>=0?1:-1);aQ=aH;aO=aG}aQ=Math.round(4095*(0.5*aQ+0.5));aO=Math.round(4095*(0.5*aO+0.5));aN[3*aK]=Math.floor(aQ/16);aN[3*aK+1]=(aQ%16)*16+Math.floor(aO/256);aN[3*aK+2]=aO%256}return aN}function o(aH,aQ){var aP=aH.length/3;var aL=new Uint16Array(3*aP);var aG=new g.Vector3(aQ.max.x-aQ.min.x,aQ.max.y-aQ.min.y,aQ.max.z-aQ.min.z);aG.multiplyScalar(1/65535);var aJ=new g.Vector3().copy(aQ.min);aJ.x/=aG.x;aJ.y/=aG.y;aJ.z/=aG.z;aJ.x=Math.floor(aJ.x);aJ.y=Math.floor(aJ.y);aJ.z=Math.floor(aJ.z);var aK=function(aT,aS,aR){return Math.max(Math.min(aT,aR),aS)};for(var aI=0;aI<aP;aI++){var aO=Math.round(aH[3*aI]/aG.x)-aJ.x;var aN=Math.round(aH[3*aI+1]/aG.y)-aJ.y;var aM=Math.round(aH[3*aI+2]/aG.z)-aJ.z;aL[3*aI]=aK(aO,0,65535);aL[3*aI+1]=aK(aN,0,65535);aL[3*aI+2]=aK(aM,0,65535)}return aL}function z(aH,aI){var aL=ai.vertexLayouts[aH];if(aL==undefined){aL=ai.vertexLayouts[aH]=aI.vertexLayouts.length;var aJ=[];var aG=1;if((aH&aG)!=0){var aK=aE?"UNSIGNED_SHORT":"FLOAT";aJ[aJ.length]=[{attribute:"POSITION",format:aK,dimension:3}]}aG=aG<<1;if((aH&aG)!=0){var aK=B?"UNSIGNED_BYTE":"FLOAT";aJ[aJ.length]=[{attribute:"NORMAL",format:aK,dimension:3}]}aG=aG<<1;if((aH&aG)!=0){aJ[aJ.length]=[{attribute:"TEX_COORD_0",format:"FLOAT",dimension:3}]}aG=aG<<1;if((aH&aG)!=0){aJ[aJ.length]=[{attribute:"TEX_COORD_1",format:"FLOAT",dimension:3}]}aG=aG<<1;if((aH&aG)!=0){aJ[aJ.length]=[{attribute:"COLOR",format:"FLOAT",dimension:4}]}aG=aG<<1;if((aH&aG)!=0){aJ[aJ.length]=[{attribute:"TANGENT",format:"FLOAT",dimension:3}]}aG=aG<<1;if((aH&aG)!=0){aJ[aJ.length]=[{attribute:"BINORMAL",format:"FLOAT",dimension:3}]}aI.vertexLayouts[aL]=aJ}return aL}function az(aG){var aK=0;for(var aI=0;aI<aG.length;aI++){var aJ=aG[aI];var aH=aJ.group;if(aH.glType>=4){aK+=aJ.count/3}}return aK}function C(aI,aH,aG){k.makeEmpty();for(var aL=0;aL<aI.length;aL++){var aM=aI[aL];for(var aK=0;aK<aM.count;aK++){var aJ=aH[aM.start+aK];e.set(aG[3*aJ],aG[3*aJ+1],aG[3*aJ+2]);k.expandByPoint(e)}}return k.getBoundingSphere()}function I(aN,aU){var bc={indexBuffer:null,vertexBuffers:[],drawingGroups:[],normalCompression:B?"OCT_24":"NONE",positionCompression:aE?"BBOX_QUANTIZATION_16_16_16":"NONE"};var aT;var aO;if(aA){aT={};aO=[]}var a9=aN.boundingSphere;if(a9){bc.boundingSphere={center:[a9.center.x,a9.center.y,a9.center.z],radius:a9.radius}}var aS=null;if(aE){if(!aN.boundingBox){aN.computeBoundingBox()}aS=aN.boundingBox.clone();if(aS){bc.boundingBox={min:[aS.min.x,aS.min.y,aS.min.z],max:[aS.max.x,aS.max.y,aS.max.z]}}}var be=0;for(var bf=0;bf<ag.length;bf++){var aW=ag[bf];var aM=aN[aW];var bi=(aW==="vertexIndexArray");var aI=(aW==="vertexNormalArray");var aR=(aW==="vertexPositionArray");if(aM){if(aR&&aE){aM=o(aM,aS)}if(aI&&B){aM=p(aM)}if(bi){bc.indexBuffer=D(aM,aU)}else{bc.vertexBuffers.push(t(aM,aU));be+=ah[aW]}}}bc.vertexLayout=z(be,aU);for(var bf=0;bf<aN.drawingGroups.length;bf++){var aL=aN.drawingGroups[bf];if((aL.glType===1)&&!A){continue}if((aL.glType===0)&&!E){continue}if(J&&hasLayers){aL.__id__=bf}var aG=aL.primitives;var a0=d.GeomTypeString[aL._geomType];var a5={start:aL.start,count:aL.count,mode:ae[aL.glType],geometricType:a0?a0:"UNKNOWN"};var a8=[];var bh=-1;var aH=0;if(X||aA){var a2;if(X){a2=new Uint32Array(4*aG.length)}for(var bd=0;bd<aG.length;bd++){var aP=aG[bd];var a3=null;if(aA&&aP.rep){a3=V.get(aP.rep);if(!a3){var a4=C(aP.rep.primitives,aN.vertexIndexArray,aN.vertexPositionArray);var a6=az(aP.rep.primitives);var a7={uid:ak,cgmId:aP.rep.cgmId,solid:aP.rep.solid,sag:aP.rep.sag,bsphere:a4,nbTriangles:a6};a3=a7;V.set(aP.rep,a3);ak++}if(!aT[a3.uid]){aT[a3.uid]=aO.length;aO.push(a3)}if(bh<0){bh=aT[a3.uid]}}if(X){a2[4*bd]=aP.cgmId;a2[4*bd+1]=a3?aT[a3.uid]:(aP.rep?aP.rep.cgmId:0);a2[4*bd+2]=aP.start;a2[4*bd+3]=aP.count}else{if(aT[a3.uid]!==bh){a8.push({index:bh,count:aH});bh=aT[a3.uid];aH=aP.count}else{aH+=aP.count}}}if(X){a5.primitives=t(a2,aU)}else{a8.push({index:bh,count:aH});var bj=new Uint32Array(2*a8.length);for(var bg=0;bg<a8.length;bg++){bj[2*bg]=a8[bg].index;bj[2*bg+1]=a8[bg].count}a5.repRanges=t(bj,aU)}}bc.drawingGroups.push(a5);if(aL.material instanceof g.Material){var aX=ai.materials[aL.material.id];if(!aX){var aZ=aB(aL.material,aU);aX={index:aU.materials.length,item:aZ};aU.materials.push(aZ);ai.materials[aL.material.id]=aX}a5.material=aX.index}if(aL.gas){var aJ=ai.materials[aL.gas.id];if(!aJ){var aZ=aB(aL.gas,aU);aJ={index:aU.materials.length,item:aZ};aU.materials.push(aZ);ai.materials[aL.gas.id]=aJ}a5.graphicAttributes=aJ.index}}if(aA&&aO){var a1=4*aO.length;var ba=9*aO.length;var aV=new Uint8Array(4*ba);var aY=new Uint32Array(aV.buffer,0);var aK=new Float32Array(aV.buffer,4*a1);for(var bg=0;bg<aO.length;bg++){var aQ=aO[bg];aY[4*bg]=aQ.uid;aY[4*bg+1]=aQ.cgmId;aY[4*bg+2]=aQ.solid;aY[4*bg+3]=aQ.nbTriangles;aK[5*bg]=aQ.bsphere.center.x;aK[5*bg+1]=aQ.bsphere.center.y;aK[5*bg+2]=aQ.bsphere.center.z;aK[5*bg+3]=aQ.bsphere.radius;aK[5*bg+4]=aQ.sag}bc.reps=t(aV,aU)}return bc}var H=function(aT,a2){var aS=ai.nodes[aT.id];if(!aS){var aI=aT.getNodeType();aS={type:aI};if(aT._matrix&&!aT._matrix.isIdentity()){var aZ=[];aT._matrix.flattenToArray(aZ);aS.matrix=aZ}if(aT.material&&aT.material.force){var aM=ai.materials[aT.material.id];if(!aM){var aP=aB(aT.material,a2);aM={index:a2.materials.length,item:aP};a2.materials.push(aP);ai.materials[aT.material.id]=aM}aS.material=aM.index}ai.nodes[aT.id]={index:a2.nodes.length,item:aS};if(a2.root===null){a2.root=a2.nodes.length}a2.nodes.push(aS);if(aI==="Node3D"){var aJ=[];for(var aW=0;aW<aT.children.length;aW++){aJ.push(aT.children[aW].id)}aS.children=aJ}else{if(aI==="LODNode3D"){var aU=[],aO,aW,aV;for(aW=0;aW<aT._representations.length;aW++){aO=[];for(aV=0;aV<aT._representations[aW].length;aV++){aO.push(aT._representations[aW][aV].id)}aU.push(aO)}aS.representations=aU;var a1=aT._boundingSphere;if(a1){aS.boundingSphere={center:[a1.center.x,a1.center.y,a1.center.z],radius:a1.radius}}var aH=aT._boundingBox;if(aH){aS.boundingBox={min:[aH.min.x,aH.min.y,aH.min.z],max:[aH.max.x,aH.max.y,aH.max.z]}}aS.lodSelector=aT._lodSelector&&aT._lodSelector.createJSON()}else{if(aI==="URLNode3D"){aS.url=aT.url;var a1=aT._boundingSphere;if(a1){aS.boundingSphere={center:[a1.center.x,a1.center.y,a1.center.z],radius:a1.radius}}}else{if(aI==="LDHNode3D"){aS.url=aT.url;var a1=aT._boundingSphere;if(a1){aS.boundingSphere={center:[a1.center.x,a1.center.y,a1.center.z],radius:a1.radius}}aS.lodSelector=aT._lodSelector&&aT._lodSelector.createJSON()}else{if(aT._occurrences[0]&&aT._occurrences[0].renderable){var aG=aT._occurrences[0].renderable;var a1=aG.boundingSphere;var aH=aG.boundingBox;if(!aH){aH=a1.getBoundingBox()}var a0=false;if(J){for(var aW=0;aW<aT._occurrences.length;aW++){if(aT._occurrences[aW].renderable.layer){a0=true;break}}}var aN=[];for(var aW=0;aW<aG.geometry.length;aW++){var aL=aG.geometry[aW].id;var aR=ai.geometries[aL];if(!aR){var aX=I(aG.geometry[aW],a2);aR={index:a2.geometries.length,item:aX};a2.geometries.push(aX);ai.geometries[aL]=aR}aN.push(aR.index)}aS.boundingSphere={center:[a1.center.x,a1.center.y,a1.center.z],radius:a1.radius};aS.boundingBox={min:[aH.min.x,aH.min.y,aH.min.z],max:[aH.max.x,aH.max.y,aH.max.z]};aS.geometries=aN;if(J&&a0){aS.occurrences={};for(var aW=0;aW<aT._occurrences.length;aW++){var aQ=aT._occurrences[aW].renderable;if(aQ.layer){var aK=[];aS.occurrences[aW]={index:aW,layers:aK};for(var aV=0;aV<aQ.layer.layers.length;aV++){var a3=aQ.layer.layers[aV];var aY={start:a3.drawableInterval.start,count:a3.drawableInterval.count,primitiveStart:a3.drawableInterval.primitiveStart,primitiveCount:a3.drawableInterval.primitiveCount,layerNum:a3.drawableInterval.layerNum};if(a3.drawableInterval.material){aY.material=a3.drawableInterval.material.id;var aM=a2.materials[aY.material];if(!aM){aM=a3.drawableInterval.material;a2.materials[aY.material]=aB(aM,a2)}}aK.push({geometry:a3.geometry.id,drawableGroup:a3.drawableGroup.__id__,drawableInterval:aY})}}}}if(!aT.material&&aG.material&&aG.material.force){var aM=ai.materials[aG.material.id];if(!aM){var aP=aB(aG.material,a2);aM={index:a2.materials.length,item:aP};a2.materials.push(aP);ai.materials[aG.material.id]=aM}aS.material=aM.index}}else{aS.type="Node3D"}}}}}if(r){r(aT,aS)}}};U.traverse(H,ap,false,true);for(var ax=0;ax<ap.nodes.length;ax++){var U=ap.nodes[ax];var au=[];if(U.type==="LODNode3D"){for(var aw=0;aw<U.representations.length;aw++){au.push(U.representations[aw])}}else{if(U.children&&U.type!=="URLNode3D"){au.push(U.children)}}var av;for(av=0;av<au.length;av++){var G=au[av];for(var aw=0;aw<G.length;aw++){G[aw]=ai.nodes[G[aw]].index}}}if(af){aC=af}if(!q&&aC){Q.chunks=O(ap);if(s){W(Q,function(){aC(Q)})}else{if(R){at(Q,function(){aC(Q)})}else{aC(Q)}}}}};return a});define("DS/Visualization/PrimitiveIterator",["UWA/Class","DS/Mesh/MeshUtils","DS/Visualization/Mesh3D","DS/Visualization/PathElement"],function(b,e,a,d){var f={};var c=b.extend({init:function(g,h){if(h!==f){return}var j=g;this._primitives=null;this._sgRep=null;this._sgPrimitive=null;if(g instanceof d){j=g.getLastElement()}if(j instanceof a){this._primitives=j.getPrimitives()}else{if(j.sgNode){switch(j.sgNode.type){case 2:this._sgRep=j.sgNode;break;case 3:this._sgPrimitive=j.sgNode;break;default:console.log("PrimitiveIterator: unsupported SubElement type")}}}},getNbPrimitives:function(){if(this._primitives){return this._primitives.length}else{if(this._sgPrimitive){return 1}else{if(this._sgRep){return this._sgRep.primitives.length}}}throw new Error("Internal error")},getConnectivityType:function(h){var g=this._getSGNode(h);return g.group.glType},getLength:function(h){var g=this._getSGNode(h);return g.count},getOffset:function(h){var g=this._getSGNode(h);return g.start},getIndexArray:function(h){var g=this._getSGNode(h);return g.group.geometry.vertexIndexArray},getPositionArray:function(h){var g=this._getSGNode(h);return g.group.geometry.vertexPositionArray},getNormalArray:function(h){var g=this._getSGNode(h);return g.group.geometry.vertexNormalArray},getMaterial:function(h){var g=this._getSGNode(h);return g.group.material},getGas:function(h){var g=this._getSGNode(h);return g.group.gas},getGeomType:function(h){var g=this._getSGNode(h);return e.GeomTypeString[g.group._geomType]},_getSGNode:function(g){if(this._primitives){return this._primitives[g].sgNode}else{if(this._sgPrimitive&&g===0){return this._sgPrimitive}else{if(this._sgRep){return this._sgRep.primitives[g]}}}return undefined}});c.POINTS=0;c.LINES=1;c.LINE_LOOP=2;c.LINE_STRIP=3;c.TRIANGLES=4;c.TRIANGLE_STRIP=5;c.TRIANGLE_FAN=6;c._authorizedTeamsOnly_getKey=function(){return f};return c});define("DS/VisuIdentification/Converter",["UWA/Class","DS/Visualization/PathElement","DS/VisuIdentification/Node","DS/Visualization/Mesh3D","DS/Visualization/SubElement"],function(b,f,c,a,e){var g=null;var d=b.extend({init:function(){if(g){return g}g=this;return this},buildGlobalId:function(p){var u="";var r="";var q=p.getLength();var m=null;var h=null;var s=null;var k=false;var l=true;var t=true;for(var o=q-1;o>=0;o--){var j=p.getElement(o);var n=j.getModelIdentification();if(n){m=n.getSpace();k=n.getSharability();r=n.computeId();s=n.getContext();if(s&&m&&(s===h)){t=true}if(t){if(!l){r+=c.atomicDelimiter}l=false;r+=u;u=r}t=k;if(!t){h=m}}}return u},decodeGlobalId:function(t,l,p){var h=l.split(c.atomicDelimiter);var v=new f();var w=null;var s=t;v.addElement(s);for(var r=0;r<h.length;r++){var m=h[r];var o=this.findNodeByIdentifier(s,m,p);if(o){if(o instanceof e){v.addElement(o)}else{var n=o;var k=[];while(o!==s){w=o.getParents();k.push(o);o=w[0];if(w.length>1){var u=w.indexOf(s);if(u===-1){console.warn("Impossible to create a PathElement from the identifier.");return null}else{o=s}}}for(var q=k.length-1;q>=0;q--){v.addElement(k[q])}s=n}}}return v},findNodeByIdentifier:function(n,o,j){var m=o.split(c.delimiter);var l=m[0];var k=m[1];if(n instanceof a){return n.getPrimitive(parseInt(k),j)}else{var h={node:null};n.traverse(function(r,p){var s=r.getModelIdentification();var q=s?s.getLocalId():null;var t=s?s.getContext():null;if(q==k&&t===l){p.node=r;return true}return false},h);return h.node}}});return UWA.namespace("THREEDS/Identification/Converter",d)});define("DS/SceneGraphNodes/BillBoardNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],function(h,g,a){var f=new h.Projector();var e=new h.Vector3();var j=new h.Matrix4();var d=new h.Matrix4();var c=new h.Matrix4();var b=g.extend({init:function(k){this._parent(k.name);this._isDynamic=true;this.BillBoardType=k.type;this.constraintAxis=null;if(k.constraintAxis){this.constraintAxis=k.constraintAxis.clone()}if(k.attachedPoint){this.attachedPoint=k.attachedPoint.clone()}var l=this;this.cbChange=function(q){var v;if(l.isInstance()){for(var r=0;r<l._occurrences.length;r++){var p=l._occurrences[r];var m=p.parent;if(!p.scene3js){continue}var t=p.scene3js.viewer;var o=true;if(p._getVisibilityFree()){o=p._getVisible()}else{o=t.getVisibleSpace()?p._getVisible():!p._getVisible()}if(o){if(q&&q.viewpoint&&q.viewpoint.viewer){if(t!==q.viewpoint.viewer){continue}}var u=t.currentViewpoint;v=l._getDynamicMatrix(m.matrix,q,u);p.matrix.multiplyMatrices(m.matrix,v);for(var n=0;n<p.children.length;n++){l._updateOccurrences(p,p.children[n],true)}}}}else{var s=l.parents[0];if(s){var p=s._occurrences[0];if(!p.scene3js){return}var t=p.scene3js.viewer;var o=true;if(p._getVisibilityFree()){o=p._getVisible()}else{o=t.getVisibleSpace()?p.visible:!p.visible}if(o){if(q&&q.viewpoint&&q.viewpoint.viewer){if(t!==q.viewpoint.viewer){return}}var u=t.currentViewpoint;v=l._getDynamicMatrix(s.getMatrixWorld(),q,u);l.setMatrix(v)}}}};this.tokenChange=null;return this},isPointOfViewDependant:function(){return true},_onLinkedToSceneGraph:function(){var k=this;this.tokenChange=a.subscribe({event:"/VISU/"},function(l){if(l.eventType==="@onViewpointChange"){k.cbChange(l)}})},_onUnlinkedToSceneGraph:function(){a.unsubscribe(this.tokenChange)},setBillboardType:function(k){this.BillBoardType=k;this.cbChange()},getNodeType:function(){return"BillBoardNode3D"},_getDynamicMatrix:function(k,n,p){if(!k){j.identity();k=j}var m=p?p:n.viewpoint;var l=m.camera;var o=l.getLookAt();o.add(l.position);c.identity();c.extractRotation(k);if(this.BillBoardType==="Spherical"){d.identity();d.lookAt(l.position,o,l.up)}else{this._ComputeCylindricalTransform(l,l.position,o,k,(this.BillBoardType==="PseudoSpherical"))}j.getInverse(c);c.multiplyMatrices(j,d);if(this._matrix){c.setPosition(e.getPositionFromMatrix(this._matrix))}return c},_ComputeCylindricalTransform:function(){var p=new h.Vector3();var n=new h.Vector3();var m=new h.Vector3();var l=new h.Vector3();var q=new h.Vector3();var o=new h.Vector3();var k=new h.Vector3();return function(v,r,u,t,w){if(this.constraintAxis){n.copy(this.constraintAxis).transformDirection(t).normalize()}else{n.set(t.elements[8],t.elements[9],t.elements[10]).normalize()}if(w){k.getPositionFromMatrix(t);p.subVectors(k,r);o.addVectors(k,n);var s=k.clone();f.projectVector(s,v);f.projectVector(o,v);o.z=s.z;f.unprojectVector(o,v);o.sub(k);o.normalize();n.copy(o)}else{p.subVectors(u,r)}p.normalize();m.crossVectors(p,n);if(m.lengthSq()<1e-10){var x=Math.abs(p.z)<0.999?q.set(0,0,1):q.set(1,0,0);m.crossVectors(x,p)}m.normalize();l.crossVectors(n,m);l.normalize();d.set(m.x,l.x,n.x,0,m.y,l.y,n.y,0,m.z,l.z,n.z,0,0,0,0,1);return d}}(),setConstraintAxis:function(k){this.constraintAxis=k}});return UWA.namespace("THREEDS/Nodes/BillBoard",b)});define("SceneGraphNodes/BillBoardNode3D",["DS/SceneGraphNodes/BillBoardNode3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/BillBoardNode3D");return b});define("DS/SceneGraphNodes/FixedSizeNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],function(e,f,b){var d=new e.Vector3();var g=new e.Matrix4();var a=new e.Matrix4();var c=f.extend({init:function(h){var j;if(arguments.length>1){console.log("[WARNING] DEPRECATED FixedSizeNode3D construction: "+(new Error()).stack);j={name:arguments[0],ratio:arguments[1],cameraName:arguments[3],}}else{j=h||{}}this._parent(j.name);this.cameraName=j.cameraName||"camera";this._isDynamic=true;this.ratio=j.ratio;this.scaleFactor=1;var k=this;this.cbChange=function(q){if(k.isInstance()){for(var r=0;r<k._occurrences.length;r++){var p=k._occurrences[r];var m=p.parent;if(!p.scene3js||!m){continue}var t=p.scene3js.viewer;var o=true;if(p._getVisibilityFree()){o=p._getVisible()}else{o=t.getVisibleSpace()?p._getVisible():!p._getVisible()}if(o){if(q&&q.viewpoint&&q.viewpoint.viewer){if(t!==q.viewpoint.viewer){continue}}var u=t.currentViewpoint;var l=k._getDynamicMatrix(m.matrix,q,u);p.matrix.multiplyMatrices(m.matrix,l);for(var n=0;n<p.children.length;n++){k._updateOccurrences(p,p.children[n],true,true)}}}}else{var s=k.parents[0];if(!s){return}var p=s._occurrences[0];if(!p.scene3js){return}var t=p.scene3js.viewer;var o=true;if(p._getVisibilityFree()){o=p._getVisible()}else{o=t.getVisibleSpace()?p.visible:!p.visible}if(o){if(q&&q.viewpoint&&q.viewpoint.viewer){if(t!==q.viewpoint.viewer){return}}var u=t.currentViewpoint;var l=k._getDynamicMatrix(s.getMatrixWorld(),q,u);k.setMatrix(l,true)}}};this.tokenChange=null;return this},setRatio:function(h){if(h!==this.ratio){this._invalidateBoundingElements()}this.ratio=h;this.cbChange()},getRatio:function(){return this.ratio},getScaleFactor:function(){return this.scaleFactor},isPointOfViewDependant:function(){return true},_onLinkedToSceneGraph:function(){var h=this;this.tokenChange=b.subscribe({event:"/VISU/"},function(j){if(j.eventType==="@onViewpointChange"){h.cbChange(j)}})},_onUnlinkedToSceneGraph:function(){b.unsubscribe(this.tokenChange)},_getDynamicMatrix:function(j,k,n){if(!j){g.identity();j=g}var h=n?n:k.viewpoint;var m=h[this.cameraName];if(this._matrix){a.multiplyMatrices(j,this._matrix)}else{a.copy(j)}var l=a.getMaxScaleOnAxis();d.getPositionFromMatrix(a);var q=l/m.getWorldSizeFromPixelSize(1,d,h.viewer.div.clientHeight);var o=q/this.ratio;var p=o!==0?1/o:1;if(!p){p=1}if(m.fullWidth){p*=m.height/m.fullHeight}g.makeScale(p,p,p);this.scaleFactor=(this._matrix?this._matrix.getMaxScaleOnAxis():1)*p;if(this._matrix){a.multiplyMatrices(this._matrix,g);return a}else{return g}},setCameraName:function(h){this.cameraName=h||"camera"}});return UWA.namespace("THREEDS/Nodes/FixedSizeNode3D",c)});define("SceneGraphNodes/FixedSizeNode3D",["DS/SceneGraphNodes/FixedSizeNode3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/FixedSizeNode3D");return b});define("DS/Visualization/LightNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(b,c){var a=c.extend({init:function(d,f,e){this._parent(f);this.light3js=(d!==undefined)?d:new b.AmbientLight();d=this.createRenderable();this._matrix=new b.Matrix4().setPosition(new b.Vector3(0,0,1));this._intensity=d.intensity;this._color=d.color;this._attachedToVpt=e?true:false;var g=this._occurrences[0];g.renderable=d;g.renderable.name=this.name;g.renderable._occurrence=g;return this},createRenderable:function(){var d=this.light3js.clone();d.matrixAutoUpdate=false;d.visible=this.light3js.visible;d.matrixWorldNeedsUpdate=false;d.castShadow=this.light3js.castShadow;d.shadowCameraLeft=this.light3js.shadowCameraLeft;d.shadowCameraRight=this.light3js.shadowCameraRight;d.shadowCameraTop=this.light3js.shadowCameraTop;d.shadowCameraBottom=this.light3js.shadowCameraBottom;d.shadowCameraNear=this.light3js.shadowCameraNear;d.shadowCameraFar=this.light3js.shadowCameraFar;d.shadowBias=this.light3js.shadowBias;d.shadowDarkness=this.light3js.shadowDarkness;d.shadowMapWidth=this.light3js.shadowMapWidth;d.shadowMapHeight=this.light3js.shadowMapHeight;d.shadowCameraVisible=this.light3js.shadowCameraVisible;return d},add:function(){return false},updateShadowMap:function(d){var e,f;if(this.light3js!==null){this.light3js.updateShadowMap=d}for(e=0;e<this._occurrences.length;e++){f=this._occurrences[e];if(f.renderable!==null){f.renderable.updateShadowMap=d}}},attachToViewpoint:function(d){this._attachedToVpt=d},setIntensity:function(d){if(d===undefined){this._intensity=1}else{this._intensity=d}this._updateIntensity()},_updateIntensity:function(){var e,f,d;this.light3js.intensity=this._intensity;e=this._occurrences.length;for(d=0;d<e;d++){f=this._occurrences[d];f.renderable.intensity=this._intensity}},setColor:function(d){if(!d instanceof b.Color){this._color=new b.Color(hex)}else{this._color=d}this._updateColor()},_updateColor:function(){var e,f,d;this.light3js.color=this._color;e=this._occurrences.length;for(d=0;d<e;d++){f=this._occurrences[d];f.renderable.color=this._color}},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"LightNode3D"}});return UWA.namespace("THREEDS/Nodes/Light",a)});define("Visualization/LightNode3D",["DS/Visualization/LightNode3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/LightNode3D");return b});define("DS/SceneGraphNodes/SpotLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(c,a){var b=a.extend({init:function(g,f){if(!g){g={}}var e;if(g.outerAngle!==undefined&&g.outerAngle!==null){e=Math.max(Math.min(g.outerAngle,Math.PI/2),0)}else{e=Math.PI/2}var h;if(g.innerAngle!==undefined&&g.innerAngle!==null){h=Math.max(Math.min(g.innerAngle,e-0.001),0)}else{h=e-0.001}this._outerAngle=e;this._innerAngle=h;var d=g.intensity;if(d===undefined){if(g.power){d=g.power/(Math.PI*((1-Math.cos(this._outerAngle))+(1-Math.cos(this._innerAngle))))}else{d=1}}var j=new c.SpotLight(g.color,d,g.distance,e,h);if(!g.target){j.target=null}else{j.target=new c.Object3D();j.target.position=g.target}this._previousTarget=j.target;if(g.physicalAttenuation){j.isPhysicallyAttenuated=true;j.attenuationScale=g.attenuationScale?g.attenuationScale:1/1000000}this._parent(j,f);return this},attachToViewpoint:function(d){if(this._attachedToVpt!=d){var f=this._occurrences.length;if(!d){this.light3js.target=this._previousTarget;for(var e=0;e<f;e++){this._occurrences[e].renderable.target=this._previousTarget}}else{this.light3js.target=new c.Object3D();this.light3js.target.position=new c.Vector3(0,0,0);for(var e=0;e<f;e++){this._occurrences[e].renderable.target=new c.Object3D();this._occurrences[e].renderable.target.position=new c.Vector3(0,0,0)}}}this._attachedToVpt=d},setTarget:function(g){var f=null;if(g){var f=new c.Object3D();f.position=g}this.light3js.target=f;this._previousTarget=f;if(!this._attachedToVpt){var e=this._occurrences.length;for(var d=0;d<e;d++){this._occurrences[d].renderable.target=f}}},castShadows:function(e,g){var j=this._occurrences.length;if(e){this.light3js.castShadow=true;this.light3js.shadowCameraFov=this.light3js.angle*180/Math.PI*2;if(g){var d=false;if(g.bias){this.light3js.shadowBias=g.bias}if(g.near){this.light3js.shadowCameraNear=g.near}if(g.far){this.light3js.shadowCameraFar=g.far}if(g.darkness){this.light3js.shadowDarkness=g.darkness}if(g.mapWidth){this.light3js.shadowMapWidth=g.mapWidth;d=true}if(g.mapHeight){this.light3js.shadowMapHeight=g.mapHeight;d=true}if(this.light3js.shadowMap&&d){this.light3js.shadowMap.dispose();this.light3js.shadowMap=null;this.light3js.updateShadowMap=true}}for(var h=0;h<j;h++){var f=this._occurrences[h].renderable;f.castShadow=true;f.shadowCameraFov=f.angle*180/Math.PI*2;if(g){var d=false;if(g.bias){f.shadowBias=g.bias}if(g.near){f.shadowCameraNear=g.near}if(g.far){f.shadowCameraFar=g.far}if(g.darkness){f.shadowDarkness=g.darkness}if(g.mapWidth){f.shadowMapWidth=g.mapWidth;d=true}if(g.mapHeight){f.shadowMapHeight=g.mapHeight;d=true}if(f.shadowMap&&d){f.shadowMap.dispose();f.shadowMap=null;f.updateShadowMap=true}}}}else{this.light3js.castShadow=false;for(var h=0;h<j;h++){this._occurrences[h].renderable.castShadow=false}}},setAngles:function(d,e,g){if(g){var f=this._intensity*(Math.PI*((1-Math.cos(this._outerAngle))+(1-Math.cos(this._innerAngle))))}if(d!==undefined&&d!==null){d=Math.max(Math.min(d,Math.PI/2),0)}else{d=Math.PI/2}if(e!==undefined&&e!==null){e=Math.max(Math.min(e,d-0.001),0)}else{e=d-0.001}this._outerAngle=d;this._innerAngle=e;if(g){this.setIntensity(f/(Math.PI*((1-Math.cos(this._outerAngle))+(1-Math.cos(this._innerAngle)))))}this._updateAngles();this.updateShadowMap()},_updateAngles:function(){var e,f,d;this.light3js.angle=this._outerAngle;this.light3js.innerAngle=this._innerAngle;e=this._occurrences.length;for(var d=0;d<e;d++){f=this._occurrences[d];f.renderable.angle=this._outerAngle;f.renderable.innerAngle=this._innerAngle}},setPower:function(e){var d=e/(Math.PI*((1-Math.cos(this._outerAngle))+(1-Math.cos(this._innerAngle))));this.setIntensity(d)},setPhysicalAttenuation:function(d){this.light3js.isPhysicallyAttenuated=d;var f=this._occurrences.length;for(var e=0;e<f;e++){this._occurrences[e].renderable.isPhysicallyAttenuated=d}},setPhysicalAttenuationScale:function(f){this.light3js.attenuationScale=f;var e=this._occurrences.length;for(var d=0;d<e;d++){this._occurrences[d].renderable.attenuationScale=f}},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"SpotLightNode3D"}});return UWA.namespace("THREEDS/Nodes/SpotLight",b)});define("SceneGraphNodes/SpotLightNode",["DS/SceneGraphNodes/PointLightNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/SpotLightNode");return b});define("DS/Visualization/Selection",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/Selection/HSOManager","DS/Selection/PSOManager"],function(a,c,h,e,f,d,b,g){var j=a.extend({init:function(l){var n=this;this.sceneGraph=l;this.sceneHL=new h.Scene();this.selectedMeshes=new Map();this.doubleSideHighlight=true;this.matHL=null;this.lightHL=new h.DirectionalLight(16777215,1);this.lightHL.position.set(0,0,0);this.lightHL.castShadow=false;this.sceneHL.add(this.lightHL);var m={HSO:b,PSO:g};this.node3DMap=new Map();this.onSceneGraphUpdate=c.subscribe({event:"/VISU/onSceneGraphUpdate"},function(t){if(n.node3DMap.has(t.fromNode)){if(t.eventType=="ADD"){var v=n.node3DMap.get(t.fromNode);n.addNodeToMap(t.toNode,n.node3DMap,v);for(var p=0;p<v.length;p++){var s=v[p].getLastElement();var r=t.toNode;var q=[];n._getPaths(s,r,[],q);for(var o=0;o<q.length;o++){var u=new d(v[p].externalPath.slice());u.externalPath=u.externalPath.concat(q[o]);n._add(t.toNode,u)}}}if(t.eventType=="REMOVE"){n.removeNodeToMap(t.fromNode,n.node3DMap)}}});var k=m[this.eventType];this._xsoManager=k;this.toUnsubscribe=[];this.toUnsubscribe.push(k.onPostAdd(function(o){if(o!==null){var p=o.pathElement;if(!p&&o.options){p=o.options.pathElement}if(p){n.add(p,o.parameters);if(n.sceneGraph.viewer){n.sceneGraph.viewer.render({onlyPostProcess:true})}}if(o instanceof Array){o.forEach(function(q){n.add(q.pathElement,q.parameters)});if(n.sceneGraph.viewer){n.sceneGraph.viewer.render({onlyPostProcess:true})}}}}));this.toUnsubscribe.push(k.onPostRemove(function(o){if(o!==null){var p=o.pathElement;if(!p&&o.options){p=o.options.pathElement}if(p){n.remove(p,o.parameters);if(n.sceneGraph.viewer){n.sceneGraph.viewer.render({onlyPostProcess:true})}}if(o instanceof Array){o.forEach(function(q){n.remove(q.pathElement,o.parameters)});if(n.sceneGraph.viewer){n.sceneGraph.viewer.render({onlyPostProcess:true})}}}}));this.toUnsubscribe.push(k.onEmpty(function(){n.clearAll();if(n.sceneGraph.viewer){n.sceneGraph.viewer.render({onlyPostProcess:true})}}));return this},_detachEvents:function(){var k;for(k=0;k<this.toUnsubscribe.length;k++){this._xsoManager.unsubscribe(this.toUnsubscribe[k])}c.unsubscribe(this.onSceneGraphUpdate)},setDoubleSideHighlight:function(k){this.doubleSideHighlight=k},_getPaths:function(q,o,p,r){var n,k;if(o==q){r.push(p.slice(0));return}p.unshift(o);var m=o.parents;k=m.length;for(n=0;n<k;n++){this._getPaths(q,m[n],p,r)}p.shift(o)},addNodeToMap:function(k,l,m){k.traverse(function(o){var n;if(o instanceof f){n=l.get(o);if(n&&n.length){l.set(o,n.concat(m))}else{l.set(o,m)}}})},removeNodeToMap:function(k,l){k.traverse(function(n){var m;if(n instanceof f){l["delete"](n)}})},add:function(l){var k;if(l!==null&&l!==undefined){k=l.getLastElement();if(k===null){return false}if(k instanceof f){this.addNodeToMap(k,this.node3DMap,[l])}this._add(k,l)}return true},_add:function(l,p){var k=p._getRenderableOccurrences(this.sceneGraph.viewer);var n=k.length;if(l instanceof f){if(n){for(var m=0;m<n;m++){var o=k[m];if(p.instanceId!==undefined&&o._instancingInfos){o._instancingInfos.pickedInstanceId=p.instanceId}if(!this.sceneGraph.scene.containsMesh(o)){continue}this.addMesh(o)}}}else{if(n!==1){return false}if(!this.sceneGraph.scene.containsMesh(k[0])){return false}this.addPrimitive(k[0],l)}},remove:function(p){var l;if(p){var k=p._getRenderableOccurrences(this.sceneGraph.viewer);var n=k.length;l=p.getLastElement();if(l===null){return}if(l instanceof f){if(this.node3DMap.has(l)){this.removeNodeToMap(l,this.node3DMap)}if(n){for(var m=0;m<n;m++){var o=k[m];if(!this.sceneGraph.scene.containsMesh(o)){continue}this.removeMesh(o)}}}else{if(n!==1){return false}if(!this.sceneGraph.scene.containsMesh(k[0])){return false}this.removePrimitive(k[0],l)}}},addPrimitive:function(t,n){var m=null;if(!this.selectedMeshes.has(t)){m=this.duplicateMeshForHighlight(t,true);this.selectedMeshes.set(t,{hlMeshScene:null,hlMeshPrimScene:m,nbSelections:0});this.sceneHL.add(m);t.addRefVBO()}else{var q=this.selectedMeshes.get(t);if(!q.hlMeshPrimScene){q.hlMeshPrimScene=this.duplicateMeshForHighlight(t,true);this.sceneHL.add(q.hlMeshPrimScene)}m=q.hlMeshPrimScene}if((n.getType()==="rep")||(n.getType()==="selectionGroup")){var p=[];var k=[];var r=n.getChildren();for(var o=0;o<r.length;o++){var l=r[o];var s=m.highLight.primitives.indexOf(l.sgNode);if(s===-1){k.push(l)}else{p.push(l)}}if(!p.length&&(n.getType()!=="selectionGroup")){m.addHighLightRep(n.sgNode)}else{for(var o=0;o<k.length;o++){m.addHighLightPrimitive(k[o].sgNode)}}}else{if(n.getType()==="primitive"){var s=m.highLight.primitives.indexOf(n.sgNode);if(s===-1){m.addHighLightPrimitive(n.sgNode)}}}return m},addMesh:function(m){var k=null;if(!this.selectedMeshes.has(m)){k=this.duplicateMeshForHighlight(m);this.selectedMeshes.set(m,{hlMeshScene:k,hlMeshPrimScene:null,nbSelections:1});this.sceneHL.add(k);m.addRefVBO()}else{var l=this.selectedMeshes.get(m);l.nbSelections++;if(!l.hlMeshScene){l.hlMeshScene=this.duplicateMeshForHighlight(m);this.sceneHL.add(l.hlMeshScene)}k=l.hlMeshScene}return k},removeMesh:function(m){var k=null;if(m){if(this.selectedMeshes.has(m)){var l=this.selectedMeshes.get(m);k=l.hlMeshScene;if(!k){return null}l.nbSelections--;if(!l.nbSelections){l.hlMeshScene=null;this.sceneHL.remove(k);if(!l.hlMeshPrimScene){this.selectedMeshes["delete"](m);m.releaseVBO();k=null}}}}return k},removeMeshAndPrimitives:function(n){if(n){if(this.selectedMeshes.has(n)){var m=this.selectedMeshes.get(n);var k=m.hlMeshScene;var l=m.hlMeshPrimScene;k&&this.sceneHL.remove(k);l&&this.sceneHL.remove(l);this.selectedMeshes["delete"](n);n.releaseVBO()}}},removePrimitive:function(p,k){var m=null;if(p){if(this.selectedMeshes.has(p)){var o=this.selectedMeshes.get(p);m=o.hlMeshPrimScene;if(!m){return null}if(k.getType()==="rep"){m.removeHighLightRep(k.sgNode)}else{if(k.getType()==="selectionGroup"){var n=k.getChildren();for(var l=0;l<n.length;l++){m.removeHighLightPrimitive(n[l].sgNode)}}else{if(k.getType()==="primitive"){m.removeHighLightPrimitive(k.sgNode)}}}if(m.isMeshHiddenByLayer()){o.hlMeshPrimScene=null;this.sceneHL.remove(m)}if(!o.nbSelections&&!o.hlMeshPrimScene){this.selectedMeshes["delete"](p);p.releaseVBO();m=null}}}return m},updateHighlight:function(k){this.lightHL.position=k.camera.getLookAt().negate()},duplicateMeshForHighlight:function(t,r){var p,k=t.material;p=new h.Mesh(t.geometry,k);p.matApp=t.matApp;p.gas=t.gas;p.materialMode=t.materialMode;p.occurrenceRenderingOverride=t.occurrenceRenderingOverride;p._occurrence=t._occurrence;p.matrixAutoUpdate=false;p.visible=t.visible;p.visibilityFree=t.visibilityFree;p.fromLoadedModel=t.fromLoadedModel;p._ratioData=t._ratioData;if(t.layer){p.layer=t.layer.clone(r)}p.setMatrix(t.matrix);if(t._instancingInfos&&t._instancingInfos.isInstanceNode3D){p._instancingInfos={isInstanceNode3D:true,nbInstances:-1,instancingSelectionMode:t._instancingInfos.instancingSelectionMode,instanceAttribArrays:null,pickedInstanceId:-1};if(t._instancingInfos.instancingSelectionMode==="instance"){var o=t._instancingInfos.instanceAttribArrays;p._instancingInfos.nbInstances=1;p._instancingInfos.instanceAttribArrays={id:o.id};var n,l,m,q,s;for(n in o){if(n!=="id"){q=o[n].itemSize;p._instancingInfos.instanceAttribArrays[n]={itemSize:q};s=o[n].isMat4?16:q;if(s===16){p._instancingInfos.instanceAttribArrays[n].isMat4=true}l=(t._instancingInfos.pickedInstanceId/5-1)*s;m=l+s;p._instancingInfos.instanceAttribArrays[n].array=o[n].array.subarray(l,m);p._instancingInfos.instanceAttribArrays[n].buffer=null}}}else{p._instancingInfos.nbInstances=t._instancingInfos.nbInstances;p._instancingInfos.instanceAttribArrays=t._instancingInfos.instanceAttribArrays}t._instancingInfos.pickedInstanceId=-1}return p},clearAll:function(){var k=this;this.selectedMeshes.forEach(function(n,p,o){var l=n.hlMeshScene;var m=n.hlMeshPrimScene;if(l){k.sceneHL.remove(l)}if(m){k.sceneHL.remove(m)}p.releaseVBO()});this.selectedMeshes.clear();this.node3DMap.clear()}});return j});define("Visualization/Selection",["DS/Visualization/Selection","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/Selection");return b});define("DS/Visualization/PreHighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Selection","DS/Shaders/AdvancedPreHighlightShader"],function(b,d,e,c,f){var a=c.extend({init:function(g){this.eventType="PSO";this._parent(g);var h=this;this.onSelectionRemove=b.subscribe({event:"/VISU/SELECTION/REMOVE"},function(j){h.removeMeshAndPrimitives(j);j.preHighlight=null});return this},_detachEvents:function(){b.unsubscribe(this.onSelectionRemove);this._parent()},addMesh:function(j){if(!j||!j._occurrence){return null}var h=j._occurrence.node;if(h&&h._getExcludeFromPreHL()){return null}var g=this._parent(j);if(g){j.preHighlight=g}return g},removeMesh:function(h){var g=this._parent(h);h.preHighlight=g},addPrimitive:function(j,h){var g=this._parent(j,h);if(g){j.preHighlight=g}return g},removePrimitive:function(j,h){var g=this._parent(j,h);j.preHighlight=g}});return a});define("Visualization/PreHighlightSelection",["DS/Visualization/PreHighlightSelection","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/PreHighlightSelection");return b});define("DS/Visualization/HighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Selection","DS/Shaders/AdvancedHighlightShader","DS/Shaders/AdvancedHighlightShaderSinglePass"],function(b,f,g,e,a,d){var c=e.extend({init:function(h){this.eventType="HSO";this._parent(h);this.passes=[];this.colorHighlight={color:new f.Color().setRGB(1,0,0),outlineColor:new f.Color().setRGB(0,1,1),intensity:0.5,polygonOffsetParameters:{activated:false,factor:1,unit:1}};if(f.mobileVersion){this.colorHighlight.color.setRGB(0,0.6,1)}this._updateColor();this.isMultiColorSet=false;this.linkToHSO=true;var j=this;this.onSelectionRemove=b.subscribe({event:"/VISU/SELECTION/REMOVE"},function(k){j.removeMeshAndPrimitives(k);k.highlight=null});return this},_detachEvents:function(){b.unsubscribe(this.onSelectionRemove);this._parent()},add:function(j,h){if(!this.isMultiColorSet){if(!h||(h&&!h.highlightColor)){this._parent(j)}}else{if(h&&h.highlightColor&&this.isEqualColor(h.highlightColor)){this._parent(j)}}},clearAll:function(){this.passes=[];this._parent()},addMesh:function(k){if(k instanceof f.CSS2DNode){k.element.classList.add("wux-css2dnode-highlighted");return null}if(!k||!k._occurrence){return null}var j=k._occurrence.node;if(j&&j._getExcludeFromHL()){return null}var h=this._parent(k);if(h){k.highlight=h}return h},removeMesh:function(j){if(j instanceof f.CSS2DNode){j.element.classList.remove("wux-css2dnode-highlighted");return null}var h=this._parent(j);j.highlight=h},addPrimitive:function(k,j){var h=this._parent(k,j);if(h){k.highlight=h}return h},removePrimitive:function(k,j){var h=this._parent(k,j);k.highlight=h},getColorHighlight:function(){return this.colorHighlight},detachToHSO:function(){this.linkToHSO=false;this._detachEvents()},setColorHighlight:function(h){if(h.color){this.colorHighlight.color=h.color}if(h.outlineColor){this.colorHighlight.outlineColor=h.outlineColor}if(h.intensity){this.colorHighlight.intensity=h.intensity}if(h.polygonOffsetParameters){if(h.polygonOffsetParameters.activated){this.colorHighlight.polygonOffsetParameters.activated=h.polygonOffsetParameters.activated}if(h.polygonOffsetParameters.factor){this.colorHighlight.polygonOffsetParameters.factor=h.polygonOffsetParameters.factor}if(h.polygonOffsetParameters.unit){this.colorHighlight.polygonOffsetParameters.unit=h.polygonOffsetParameters.unit}}this._updateColor()},setMultiColorMode:function(h){this.isMultiColorSet=h},_updateColor:function(){this.sceneHL.colorHighlight=this.colorHighlight},isEqualColor:function(h){if(!h){return false}if(!h.color){return false}if(this.sceneHL.colorHighlight.color.r!=h.color.r||this.sceneHL.colorHighlight.color.g!=h.color.g||this.sceneHL.colorHighlight.color.b!=h.color.b){return false}if(!h.outlineColor){return false}if(this.sceneHL.colorHighlight.outlineColor.r!=h.outlineColor.r||this.sceneHL.colorHighlight.outlineColor.g!=h.outlineColor.g||this.sceneHL.colorHighlight.outlineColor.b!=h.outlineColor.b){return false}if(this.sceneHL.colorHighlight.intensity!=h.intensity){return false}if(!h.polygonOffsetParameters&&this.sceneHL.colorHighlight.polygonOffsetParameters.activated){return false}if(h.polygonOffsetParameters){if(this.sceneHL.colorHighlight.polygonOffsetParameters.activated!=h.polygonOffsetParameters.activated){return false}if(h.polygonOffsetParameters.activated){if(this.sceneHL.colorHighlight.polygonOffsetParameters.factor!=h.polygonOffsetParameters.factor){return false}if(this.sceneHL.colorHighlight.polygonOffsetParameters.unit!=h.polygonOffsetParameters.unit){return false}}}return true}});return c});define("Visualization/HighlightSelection",["DS/Visualization/HighlightSelection","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/HighlightSelection");return b});define("DS/Visualization/EditableMesh3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement"],function(c,b,e,d){var a=b.extend({init:function(g,f){this._parent(g,f);return this},clone:function(){var f=new c.Mesh(this.mesh3js.geometry,this.mesh3js.material);this.mesh3js.copyInstancingInfos(f);return new THREEDS.Nodes.EditableMesh(f,this.name)},getNodeType:function(){return"Mesh3D"},isEditable:function(){return true},getBuffer:function(f,g){var j=g?g:this.mesh3js.geometry[0];var h=this._getDataArray(f);return h?j[h]:null},getIndexBuffer:function(f){var g=f?f:this.mesh3js.geometry[0];return this._getIndexArray(g)},updateIndexBuffer:function(f,l,n){this._clearGSSOCache();var m=n?n:this.mesh3js.geometry[0];var o=this._getIndexArray(m);if(o&&m.vertexBuffer){var g=m.vertexLayout;var k=g.vertexIndexArray;k.needsUpdate=true;if(k.start===-1){k.start=f;k.count=l}else{var j=Math.min(k.start,f);var h=Math.max(k.start+k.count,f+l);k.start=j;k.count=h-j}}},updateBuffer:function(o,g,l,n){this._clearGSSOCache();var m=n?n:this.mesh3js.geometry[0];var f=this._getDataArray(o);var p=f?m[f]:null;if(p&&m.vertexBuffer){var h=m.vertexLayout;var q=h[f];q.needsUpdate=true;if(q.start===-1){q.start=g;q.count=l}else{var k=Math.min(q.start,g);var j=Math.max(q.start+q.count,g+l);q.start=k;q.count=j-k}}if(m.vertexBuffer){m.vertexBuffer.needsUpdate=true;if(m.vertexBuffer.start===null){m.vertexBuffer.start=g;m.vertexBuffer.count=l}else{var k=Math.min(m.vertexBuffer.start,g);var j=Math.max(m.vertexBuffer.start+m.vertexBuffer.count,g+l);m.vertexBuffer.start=k;m.vertexBuffer.count=j-k}}if(m.wideLines){if(m.wideLines.vertexBuffer){m.wideLines.vertexBuffer.needsUpdate=true}}},addBuffer:function(g,j,h){this._clearGSSOCache();var l=h?h:this.mesh3js.geometry[0];var k=this._getDataArray(g);var f=k?l[k]:null;if(f){return}l.needsUpdate=true;switch(g){case e.VertexComponentEnum.POSITION:l.vertexPositionArray=j;break;case e.VertexComponentEnum.NORMAL:l.vertexNormalArray=j;break;case e.VertexComponentEnum.DIFFUSE_COLOR:l.vertexColorArray=j;break;case e.VertexComponentEnum.TEX_COORD_0:l.vertexUvArray=j;break;case e.VertexComponentEnum.TEX_COORD_1:l.vertexUv2Array=j;break;case e.VertexComponentEnum.TEX_COORD_2:l.vertexTangentArray=j;break;case e.VertexComponentEnum.TEX_COORD_3:l.vertexBinormalArray=j;break;default:break}},removeBuffer:function(g,h){this._clearGSSOCache();var k=h?h:this.mesh3js.geometry[0];var j=this._getDataArray(g);var f=j?k[j]:null;if(!f){return}k.needsUpdate=true;switch(g){case e.VertexComponentEnum.POSITION:k.vertexPositionArray=null;break;case e.VertexComponentEnum.NORMAL:k.vertexNormalArray=null;break;case e.VertexComponentEnum.DIFFUSE_COLOR:k.vertexColorArray=null;break;case e.VertexComponentEnum.TEX_COORD_0:k.vertexUvArray=null;break;case e.VertexComponentEnum.TEX_COORD_1:k.vertexUv2Array=null;break;case e.VertexComponentEnum.TEX_COORD_2:k.vertexTangentArray=null;break;case e.VertexComponentEnum.TEX_COORD_3:k.vertexBinormalArray=null;break;default:break}},_getIndexArray:function(f){return f.vertexIndexArray},_getDataArray:function(f){switch(f){case e.VertexComponentEnum.POSITION:return"vertexPositionArray";case e.VertexComponentEnum.NORMAL:return"vertexNormalArray";case e.VertexComponentEnum.DIFFUSE_COLOR:return"vertexColorArray";case e.VertexComponentEnum.TEX_COORD_0:return"vertexUvArray";case e.VertexComponentEnum.TEX_COORD_1:return"vertexUv2Array";case e.VertexComponentEnum.TEX_COORD_2:return"vertexTangentArray";case e.VertexComponentEnum.TEX_COORD_3:return"vertexBinormalArray";default:break}return null},_clearGSSOCache:function(){var f,g=null,h=null;for(f=0;f<this._occurrences.length;f++){h=this._occurrences[f];g=h.renderable;if(g){g._gsso_cache=null}}}});return UWA.namespace("THREEDS/Nodes/EditableMesh",a)});define("Visualization/EditableMesh3D",["DS/Visualization/EditableMesh3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/EditableMesh3D");return b});define("DS/SceneGraphNodes/CanvasNodeTexture",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils"],function(c,g,a,f){var e=["map","transparent","alphaTest","force","canvasNodeTextureSize","canvasNodeTextureSaveParams"];var d=true;var b=g.extend({init:function(h){this.width=h.width;this.height=h.height;this.longestEdge=this.width>=this.height?"width":"height";this.maxZoom=h.maxZoom||null;this.maxPow=this.maxZoom?Math.floor(Math.log(this.maxZoom)/Math.log(2)):null;this.drawCB=h.drawCB;this.rectangleTexture=h.rectangleTexture||false;this.viewer=h.webGLV6Viewer;this.alphaTest=h.alphaTest;this.depthWrite=h.depthWrite;this.tick=0;this.materials={};this.lastTexture=null;this._canvas2DTexture=null;this._canvas2DCanvas=null;this.setMaterialParams(h.materialParams)},setMaterialParams:function(j){this.materialParams=j||{};var h;for(h in this.materials){this._updateMaterialWithParams(this.materials[h].material,this.materialParams)}},requestRedraw:function(){this._requestRedraw()},_updateMaterialWithParams:function(j,k){var h;if(j.canvasNodeTextureSaveParams){for(h in j.canvasNodeTextureSaveParams){j[h]=j.canvasNodeTextureSaveParams[h]}}for(h in k){if(e.indexOf(h)===-1){if(!j.canvasNodeTextureSaveParams){j.canvasNodeTextureSaveParams={}}j.canvasNodeTextureSaveParams[h]=j[h];j[h]=k[h]}}},startAnimation:function(h,j){this.animationDeltaTime=h;this.tick=-1;this._animationStep(j)},_animationStep:function(h){this.tick++;this.requestRedraw();if(h){h.render()}setTimeout(this._animationStep.bind(this,h),this.animationDeltaTime)},_requestRedraw:function(){var h;for(h in this.materials){this.materials[h].redrawRequested=true}if(this._canvas2DTexture){this._canvas2DTexture.redrawRequested=true}},_getCanvas2DTexture:function(){if(!this._canvas2DTexture){var h=document.createElement("canvas");h.width=this.width;h.height=this.height;this._canvas2DTexture=new c.Texture(h,undefined,c.ClampToEdgeWrapping,c.ClampToEdgeWrapping,c.NearestFilter,c.NearestFilter);this._canvas2DCanvas=h;this._redrawCanvas2DTexture()}return this._canvas2DTexture},_redrawCanvas2DTexture:function(){this._drawToCanvas(this._canvas2DCanvas,this.width,this.height);this._canvas2DTexture.needsUpdate=true;this._canvas2DTexture.redrawRequested=false},_buildMaterial:function(m,k,h,l){var j={};j.canvas=document.createElement("canvas");j.canvas.width=k;j.canvas.height=h;b.totalAllocatedTextures+=j.canvas.width*j.canvas.height;j.useCount=0;this._drawToCanvas(j.canvas,k,h);j.texture=new c.Texture(j.canvas,undefined,c.ClampToEdgeWrapping,c.ClampToEdgeWrapping,c.LinearFilter,c.LinearMipMapLinearFilter);j.texture.anisotropy=16;j.texture.needsUpdate=true;if(l){l.map=j.texture;c.cleanDeferredCache(l.id);l.updateDeferredMaterials();j.material=l}else{j.material=new c.MeshBasicMaterial({transparent:true,force:true,map:j.texture})}if(this.alphaTest!==undefined){j.material.alphaTest=this.alphaTest}if(this.depthWrite!==undefined){j.material.depthWrite=this.depthWrite}j.material.canvasNodeTextureSize=m;this._updateMaterialWithParams(j.material,this.materialParams);j.redrawRequested=false;return j},_drawToCanvas:function(m,n,h){var j=m.getContext("2d");j.setTransform(1,0,0,1,0,0);j.clearRect(0,0,n,h);j.globalAlpha=1;var l=Math.max(n,h)/Math.max(this.width,this.height);j.scale(l,l);this.drawCB(this,j,this.tick,l)},_getNewMaterial:function(x,l){var o=(l&&l.canvasNodeTextureSize)?l:null;var p=x;var m=11;if(this.maxPow!==null){m=this.maxPow}var q=0.01024;if(this.rectangleTexture){p=x/this[this.longestEdge];if(this.maxPow===null){var h=Math.ceil(Math.log(this[this.longestEdge])/Math.log(2)+q);m=Math.max(0,m-h)}}var r=Math.ceil(Math.log(p)/Math.log(2)+q);r=Math.min(r,m);var w=Math.pow(2,r);var j=this.rectangleTexture?Math.floor(w*this.width):w;var v=this.rectangleTexture?Math.floor(w*this.height):w;if(j===0||v===0){j=16;v=16}var k=o?this.materials[o.canvasNodeTextureSize]:null;var n=k?k.canvas.width:0;var u=k?k.canvas.height:0;if(!this.materials[w]&&b.totalAllocatedTextures+j*v-n*u>b.maxAllocatedTextures){if(d){console.warn("CanvasNodeTexture: max amount of allowed texture allocation has been exceeded")}if(k){w=o.canvasNodeTextureSize;j=k.canvas.width;v=k.canvas.height}else{w=this.rectangleTexture?1:512;j=this.rectangleTexture?this.width:w;v=this.rectangleTexture?this.height:w}}var t=this.materials[w];var s;if(!o||o.canvasNodeTextureSize!==w){if(o){s=this._releaseMaterial(o)}if(!t){this.materials[w]=this._buildMaterial(w,j,v,s);t=this.materials[w]}t.useCount++;if(s&&t.material!==s){s.dispose()}}if(t&&t.redrawRequested){this._drawToCanvas(t.canvas,j,v);t.texture.needsUpdate=true;t.redrawRequested=false}return t?t.material:null},_releaseMaterial:function(j){if(j.canvasNodeTextureSize){var h=j?this.materials[j.canvasNodeTextureSize]:null;var j;h.useCount--;if(h.useCount<=0){b.totalAllocatedTextures-=h.canvas.width*h.canvas.height;j=this.materials[j.canvasNodeTextureSize].material;j.map.dispose();j.map=null;delete this.materials[j.canvasNodeTextureSize];return j}}return null}});b.totalAllocatedTextures=0;b.maxAllocatedTextures=4096*4096;b.enableMemoryWarning=function(h){d=h};return b});define("DS/Visualization/TextNode",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/EditableMesh3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement"],function(c,f,a,e,d){var h={count:97,width:256,height:256,chars:{0:{yoffset:1.5,width:4,xadvance:0,y:238,x:223,height:4,xoffset:-1.5},13:{yoffset:1.5,width:4,xadvance:9.25,y:252,x:250,height:4,xoffset:-1.5},32:{yoffset:1.5,width:4,xadvance:9.25,y:252,x:246,height:4,xoffset:-1.5},33:{yoffset:27.063,width:12,xadvance:9.5,y:0,x:186,height:30,xoffset:-0.688},34:{yoffset:27.063,width:15,xadvance:18,y:15,x:210,height:14,xoffset:3},35:{yoffset:26.438,width:24,xadvance:19.5,y:125,x:48,height:28,xoffset:-1.875},36:{yoffset:32.125,width:24,xadvance:19.938,y:65,x:24,height:40,xoffset:-1.625},37:{yoffset:27.938,width:30,xadvance:31.813,y:94,x:48,height:31,xoffset:1.5},38:{yoffset:24.75,width:36,xadvance:33.25,y:38,x:0,height:27,xoffset:-0.25},39:{yoffset:27.063,width:8,xadvance:10.875,y:238,x:246,height:14,xoffset:3},40:{yoffset:33,width:16,xadvance:12,y:105,x:24,height:41,xoffset:-0.5},41:{yoffset:33,width:16,xadvance:12,y:211,x:48,height:41,xoffset:-2.188},42:{yoffset:28.938,width:19,xadvance:16.375,y:238,x:227,height:18,xoffset:0.438},43:{yoffset:20.688,width:19,xadvance:18.875,y:237,x:135,height:19,xoffset:0.25},44:{yoffset:6.938,width:11,xadvance:9.5,y:15,x:225,height:15,xoffset:-2.25},45:{yoffset:14.938,width:15,xadvance:15.063,y:247,x:181,height:7,xoffset:0.25},46:{yoffset:6.938,width:10,xadvance:9.5,y:243,x:92,height:10,xoffset:-0.875},47:{yoffset:31.875,width:22,xadvance:19.25,y:94,x:135,height:38,xoffset:-1},48:{yoffset:26.875,width:22,xadvance:21.25,y:65,x:81,height:29,xoffset:0.188},49:{yoffset:26.375,width:16,xadvance:15.75,y:0,x:74,height:28,xoffset:0},50:{yoffset:26.875,width:21,xadvance:19,y:65,x:190,height:29,xoffset:-1.438},51:{yoffset:26.813,width:22,xadvance:18.938,y:65,x:147,height:29,xoffset:-2.188},52:{yoffset:27.063,width:22,xadvance:20.188,y:65,x:125,height:29,xoffset:-0.938},53:{yoffset:26.375,width:23,xadvance:19.688,y:182,x:48,height:29,xoffset:-1.688},54:{yoffset:26.813,width:21,xadvance:20.375,y:65,x:211,height:29,xoffset:0.125},55:{yoffset:26.438,width:20,xadvance:16.875,y:65,x:232,height:29,xoffset:0.188},56:{yoffset:26.813,width:22,xadvance:21.125,y:65,x:103,height:29,xoffset:-0.688},57:{yoffset:26.813,width:21,xadvance:20.375,y:222,x:24,height:30,xoffset:0.438},58:{yoffset:20.188,width:11,xadvance:9.5,y:185,x:243,height:23,xoffset:-0.875},59:{yoffset:20.25,width:13,xadvance:9.5,y:0,x:173,height:29,xoffset:-2.25},60:{yoffset:22.563,width:20,xadvance:18.875,y:0,x:121,height:21,xoffset:0.25},61:{yoffset:18.75,width:20,xadvance:18.875,y:0,x:210,height:15,xoffset:0.688},62:{yoffset:22.563,width:20,xadvance:18.875,y:0,x:141,height:21,xoffset:-0.563},63:{yoffset:27.625,width:19,xadvance:18.625,y:185,x:0,height:30,xoffset:0.938},64:{yoffset:27.625,width:38,xadvance:37.75,y:0,x:0,height:38,xoffset:0.188},65:{yoffset:27.125,width:26,xadvance:21.563,y:209,x:201,height:29,xoffset:-3.125},66:{yoffset:27.063,width:23,xadvance:22.875,y:123,x:233,height:29,xoffset:0.188},67:{yoffset:27.625,width:24,xadvance:21.063,y:187,x:109,height:30,xoffset:0.25},68:{yoffset:27.063,width:25,xadvance:24.188,y:123,x:183,height:29,xoffset:0.188},69:{yoffset:27.063,width:22,xadvance:19.5,y:94,x:234,height:29,xoffset:0.188},70:{yoffset:27.063,width:21,xadvance:18.188,y:65,x:169,height:29,xoffset:0.188},71:{yoffset:27.625,width:25,xadvance:23.625,y:153,x:230,height:30,xoffset:0.25},72:{yoffset:27.063,width:25,xadvance:24.625,y:94,x:184,height:29,xoffset:0.188},73:{yoffset:27.063,width:12,xadvance:10.813,y:0,x:198,height:29,xoffset:0.188},74:{yoffset:27.063,width:16,xadvance:11,y:215,x:0,height:35,xoffset:-3.75},75:{yoffset:27.063,width:26,xadvance:22.438,y:209,x:227,height:29,xoffset:0.188},76:{yoffset:27.063,width:19,xadvance:18.563,y:0,x:38,height:29,xoffset:0.188},77:{yoffset:27.063,width:31,xadvance:29.188,y:94,x:78,height:29,xoffset:-1.25},78:{yoffset:27.063,width:25,xadvance:24.75,y:123,x:208,height:29,xoffset:0.188},79:{yoffset:27.625,width:26,xadvance:25.5,y:123,x:157,height:30,xoffset:0.25},80:{yoffset:27.125,width:24,xadvance:21.875,y:123,x:78,height:29,xoffset:0.188},81:{yoffset:27.625,width:26,xadvance:25.5,y:94,x:109,height:34,xoffset:0.25},82:{yoffset:27.125,width:24,xadvance:22.375,y:217,x:109,height:29,xoffset:0.188},83:{yoffset:27.625,width:24,xadvance:20.313,y:157,x:109,height:30,xoffset:-1.75},84:{yoffset:27.063,width:23,xadvance:19.375,y:153,x:48,height:29,xoffset:0.125},85:{yoffset:27.063,width:25,xadvance:24.25,y:153,x:205,height:30,xoffset:0.75},86:{yoffset:27.063,width:25,xadvance:21.625,y:94,x:209,height:29,xoffset:0.438},87:{yoffset:27.125,width:33,xadvance:30.875,y:65,x:48,height:29,xoffset:0.813},88:{yoffset:27.063,width:27,xadvance:21.063,y:94,x:157,height:29,xoffset:-3},89:{yoffset:27.063,width:25,xadvance:21,y:128,x:109,height:29,xoffset:0.125},90:{yoffset:27.063,width:24,xadvance:19.438,y:152,x:78,height:29,xoffset:-2.125},91:{yoffset:31.813,width:17,xadvance:12,y:146,x:24,height:38,xoffset:-1.625},92:{yoffset:31.875,width:20,xadvance:19.375,y:209,x:181,height:38,xoffset:-0.438},93:{yoffset:31.875,width:17,xadvance:12,y:184,x:24,height:38,xoffset:-1.938},94:{yoffset:32.688,width:22,xadvance:19.875,y:238,x:201,height:15,xoffset:0.5},95:{yoffset:-0.563,width:22,xadvance:19.25,y:248,x:157,height:7,xoffset:-3.313},96:{yoffset:31.875,width:14,xadvance:12.125,y:243,x:78,height:11,xoffset:-0.438},97:{yoffset:21.625,width:22,xadvance:21.375,y:38,x:60,height:24,xoffset:-0.375},98:{yoffset:29.438,width:22,xadvance:21.75,y:132,x:135,height:32,xoffset:-0.125},99:{yoffset:21.625,width:20,xadvance:17.25,y:38,x:211,height:24,xoffset:-0.375},100:{yoffset:29.438,width:24,xadvance:21.688,y:153,x:181,height:32,xoffset:-0.375},101:{yoffset:21.625,width:21,xadvance:19.25,y:38,x:169,height:24,xoffset:-0.375},102:{yoffset:29.5,width:24,xadvance:12.375,y:65,x:0,height:40,xoffset:-4.188},103:{yoffset:21.688,width:23,xadvance:21.625,y:216,x:157,height:32,xoffset:-1.125},104:{yoffset:29.438,width:22,xadvance:21.25,y:212,x:78,height:31,xoffset:-0.25},105:{yoffset:30.938,width:13,xadvance:10,y:0,x:108,height:33,xoffset:-0.375},106:{yoffset:30.938,width:17,xadvance:10,y:196,x:135,height:41,xoffset:-4.938},107:{yoffset:29.438,width:22,xadvance:20.813,y:181,x:78,height:31,xoffset:-0.25},108:{yoffset:29.438,width:12,xadvance:10.438,y:0,x:161,height:32,xoffset:0},109:{yoffset:21.625,width:32,xadvance:31.375,y:185,x:181,height:24,xoffset:-0.25},110:{yoffset:21.625,width:22,xadvance:21.25,y:38,x:104,height:24,xoffset:-0.25},111:{yoffset:21.625,width:22,xadvance:21.313,y:38,x:82,height:24,xoffset:-0.375},112:{yoffset:21.625,width:24,xadvance:21.75,y:153,x:157,height:32,xoffset:-1.375},113:{yoffset:21.625,width:22,xadvance:21.563,y:164,x:135,height:32,xoffset:-0.375},114:{yoffset:21.625,width:18,xadvance:14.313,y:0,x:90,height:24,xoffset:-0.25},115:{yoffset:21.563,width:20,xadvance:17.563,y:38,x:231,height:24,xoffset:-1.938},116:{yoffset:26,width:17,xadvance:13.75,y:0,x:57,height:29,xoffset:-0.563},117:{yoffset:21.063,width:21,xadvance:21.063,y:38,x:148,height:24,xoffset:0.313},118:{yoffset:21.125,width:22,xadvance:18.375,y:38,x:126,height:23,xoffset:-0.375},119:{yoffset:21.125,width:30,xadvance:27.125,y:185,x:213,height:23,xoffset:0},120:{yoffset:21.063,width:24,xadvance:18,y:38,x:36,height:23,xoffset:-3.438},121:{yoffset:21.125,width:24,xadvance:18.313,y:185,x:157,height:31,xoffset:-2.25},122:{yoffset:21.063,width:21,xadvance:16.375,y:38,x:190,height:23,xoffset:-2.5},123:{yoffset:32.438,width:16,xadvance:12,y:145,x:0,height:40,xoffset:-0.813},124:{yoffset:31.375,width:12,xadvance:14.375,y:211,x:64,height:37,xoffset:1.688},125:{yoffset:32.438,width:16,xadvance:12,y:105,x:0,height:40,xoffset:-2.313},126:{yoffset:16.125,width:21,xadvance:18.875,y:246,x:109,height:9,xoffset:-0.438}},base:41};var b=function(m,o,j,n){var l=this.opacity;if(n&&n.getOpacity()!==null){l=n.getOpacity()}o.uniform1f(j.opacity,l);var k=0;o.uniform1i(j.fontMap,k);m.setTexture(this.uniforms.fontMap.value,k);o.uniform1fv(j.quad,this.uniforms.quad.value);o.uniform2f(j.invSize,this.uniforms.invSize.value.x,this.uniforms.invSize.value.y);o.uniform1f(j.screenRatio,this.uniforms.screenRatio.value)};var g=a.extend({init:function(j){this.lineHeight=1;this.nbChars=0;this.textArray={};this.primitivePicking=true;this.billboard=false;this.billboardAxis=false;this.fixedSize=false;this.viewSpace=false;this.projectionSpace=false;this.textMaterial=null;this._initMaterial();this._setFont();var k=new c.Mesh();this._token=0;this.mesh3js=null;this._parent(k,j);this.mesh3js=this._occurrences[0].renderable;this._reallocate(512);this.setFrustumCulled(true);return this},clone:function(){var j=new c.Mesh(this.mesh3js.geometry,this.mesh3js.material);return new g(j,this.name)},getNodeType:function(){return"Mesh3D"},setPrimitivePicking:function(j){this.primitivePicking=j},setBillboard:function(j,k){if((this.billboard===j)&&(this.billboardAxis===k)){return}this.billboard=j;this.billboardAxis=k;this._updateDefines()},setFixedSize:function(j){if(this.fixedSize===j){return}this.fixedSize=j;if(j){this.billboard=true}this._updateDefines()},_setViewSpace:function(j){if(this.viewSpace===j){return}this.viewSpace=j;this.projectionSpace=!j;this._updateDefines()},_setProjectionSpace:function(j){if(this.projectionSpace===j){return}this.projectionSpace=j;this.viewSpace=!j;this._updateDefines()},_updateDefines:function(){this.textMaterial.defines={USE_BILLBOARD:this.billboard,USE_AXIS:this.billboardAxis,USE_FIXEDSIZE:this.fixedSize,USE_VIEWSPACE:this.viewSpace,USE_PROJSPACE:this.projectionSpace};this.textMaterial.updateDeferredMaterials();this.textMaterial.needsUpdate=true},getBillboard:function(){return this.billboard},addText:function(n){var m=n.string.length;var j=this._addText(n);if(j){n.primitive=j;this.textArray[j.cgmId]=n;this.nbChars+=m;return j.cgmId}var k=this._reallocate(m);var l=this._occurrences[0].renderable;j=this._addText(n,(k!==null)?l.layer.layers[k]:null,k);if(j){n.primitive=j;this.textArray[j.cgmId]=n;this.nbChars+=m;return j.cgmId}return -1},removeText:function(j){var k=this.textArray[j];if(k){this.hide([d.getFromSGNode(k.primitive)]);this.nbChars-=k.string.length;delete (this.textArray[j])}},_setFont:function(){var j=f.getWebappsAssetUrl("Visualization","");this.fontTexture=new c.ImageUtils.loadTexture(j+"fonts/default.png",undefined,null,null,true);this.fontTexture.flipY=true;this.fontTexture.anisotropy=16;if(this.textMaterial){this.textMaterial.uniforms.fontMap.value=this.fontTexture}},_reallocate:function(s){function t(k){var j=Math.log(k)/Math.LN2;return Math.pow(2,Math.ceil(j))}var C=this._occurrences[0].renderable;var L=4*s;var K=C.geometry.length;var u=K?C.geometry[K-1]:null;var r=u?u.vertexPositionArray.length/3:0;var B=!K||(r===65536);var m=B?t(L):t(r+L);var D=new c.BufferGeometryDS();D.editable=true;D.vertexIndexArray=new Uint16Array(6*m/4);D.vertexPositionArray=new Float32Array(3*m);D.vertexColorArray=new Float32Array(4*m);D.vertexNormalArray=new Float32Array(3*m);D.vertexUvArray=new Float32Array(3*m);D.vertexUv2Array=new Float32Array(3*m);D.vertexTangentArray=new Float32Array(3*m);D.vertexBinormalArray=new Float32Array(3*m);for(var H=0;H<3*m;H+=3){D.vertexPositionArray[H]=NaN}var y=null;if(B){var q=new e.SGPrimitive({cgmId:this._token,rep:null,start:0,count:6*m/4});this._token++;var J=new e.DrawingGroup(this.textMaterial,this.textMaterial,4,0,6*m/4,[q]);J.geometry=D;D.drawingGroups.push(J);q.group=J;for(var F=0;F<this._occurrences.length;F++){var o=this._occurrences[F].renderable;o.geometry.push(D);D.addRefVBO(o);o._initLayersForGeometry(0,D);var w=o.layer.getIntervals(D,null,true);y=w.length?o.layer.layers.indexOf(w[0]):-1}}else{for(var H=0;H<4*r;H++){D.vertexColorArray[H]=u.vertexColorArray[H];if(H<3*r){D.vertexPositionArray[H]=u.vertexPositionArray[H];D.vertexNormalArray[H]=u.vertexNormalArray[H];D.vertexUvArray[H]=u.vertexUvArray[H];D.vertexUv2Array[H]=u.vertexUv2Array[H];D.vertexTangentArray[H]=u.vertexTangentArray[H];D.vertexBinormalArray[H]=u.vertexBinormalArray[H]}}for(var H=0;H<6*r/4;H++){D.vertexIndexArray[H]=u.vertexIndexArray[H]}var l=u.drawingGroups[0].primitives.slice();var G=l[l.length-1];var n=G.start+G.count;var p=6*m/4-n;var A=new e.SGPrimitive({cgmId:this._token,rep:null,start:n,count:p});l.push(A);this._token++;var J=new e.DrawingGroup(this.textMaterial,this.textMaterial,4,0,6*m/4,l);J.geometry=D;D.drawingGroups.push(J);for(var F=0;F<l.length;F++){l[F].group=J}for(var F=0;F<this._occurrences.length;F++){var o=this._occurrences[F].renderable;var w=o.layer.getIntervals(o.geometry[K-1],null,true);for(var E=0;E<w.length;E++){w[E].geometry=D;w[E].drawableGroup=D.drawingGroups[0]}var x=w[w.length-1];var z=o.layer.layers.indexOf(x);if(!x.drawableInterval.layerNum){x.drawableInterval.count+=p;x.drawableInterval.primitiveCount++;y=z}else{var v=new c.DrawableInterval(0,n,p);v.primitiveStart=l.length-1;v.primitiveCount=1;var I=new c.LayerInterval(D,D.drawingGroups[0],v);o.layer.layers.splice(z+1,0,I);y=z+1}D.addRefVBO(o);o.geometry[K-1].releaseVBO(o);o.geometry.splice(K-1,1);o.geometry.push(D)}}return y},_initMaterial:function(){var j=c.UniformsUtils.mergeNoClone([{fontMap:{type:"t",value:null},quad:{type:"fv1",value:[-0.5,-0.5,0.5,-0.5,0.5,0.5,-0.5,0.5]},invSize:{type:"v2",value:new c.Vector2(512,512)},screenRatio:{type:"f",value:1},opacity:{type:"f",value:1}},c.UniformsUtils.clone(c.UniformsLib.clipPlanes)]);this.textMaterial=new c.ShaderMaterialDS({force:true,side:c.FrontSide,transparent:true,uniforms:j,vertexColors:c.VertexColors,vertexShaderPars:["varying vec4 vColor; varying vec2 vUv; uniform float quad[8]; uniform vec2 invSize; uniform float screenRatio;",c.ShaderChunk.clip_pars_vertex].join("\n"),vertexShaderBody:["vec3 corner = vec3(quad[2*int(color.w)], quad[2*int(color.w) + 1], 0.0);","#ifdef USE_BILLBOARD","#ifdef USE_FIXEDSIZE","#ifdef USE_VIEWSPACE","vec4 mvPosition = (modelMatrix * vec4(position.xyz, 1.0));","#elif defined(USE_PROJSPACE)","vec4 projPosition = vec4(position.xy, 0.0, 1.0);","#else",c._DefaultShaderChunk.model_view_transformation_vertex,"#endif","#ifdef USE_AXIS","#ifdef USE_VIEWSPACE","vec4 mvPosition2 = (modelMatrix * vec4(position.xyz + binormal, 1.0));","#elif defined(USE_PROJSPACE)","vec4 projPosition2 = vec4(binormal.xy, 0.0, 1.0);","#else",c._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPosition2","vec4(position.xyz + binormal, 1.0)"),"#endif","#endif","#else",c._DefaultShaderChunk.getModelViewTransformationChunk("vec4 _mvPos","vec4(position.xyz, 1.0)"),"vec4 mvPosition = _mvPos + vec4(normal, 0.0) + vec4(corner * vec3(uv2, 1.0), 0.0);","#endif","#else","vec3 newPosition = position + mat3(binormal, tangent, vec3(0.0, 0.0, 1.0)) * (normal + corner * vec3(uv2, 1.0));",c._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPosition","vec4(newPosition, 1.0)"),"#endif","vec3 mvNormal;","#ifdef USE_PROJSPACE","gl_Position = projPosition;","#else","gl_Position = projectionMatrix * mvPosition;","#endif","#ifdef USE_FIXEDSIZE","#ifdef USE_AXIS","#ifdef USE_PROJSPACE","vec2 toPixels = 0.5 / invSize;","vec2 projPt1 = toPixels * projPosition.xy;","vec2 projPt2 = toPixels * projPosition2.xy;","#else","vec4 glPosition2 = projectionMatrix * mvPosition2;","vec2 toPixels1 = 0.5 / (invSize * gl_Position.w);","vec2 toPixels2 = 0.5 / (invSize * glPosition2.w);","vec2 projPt1 = toPixels1 * gl_Position.xy;","vec2 projPt2 = toPixels2 * glPosition2.xy;","#endif","vec2 rightVecPx = normalize(projPt2.xy - projPt1.xy);","vec2 upVecPx = vec2(-rightVecPx.y, rightVecPx.x);","vec2 offsetVec = (normal.xy + corner.xy * uv2);","offsetVec = offsetVec.x * rightVecPx + offsetVec.y * upVecPx;","#ifdef USE_PROJSPACE","gl_Position.xy += 2.0 * invSize * offsetVec;","#else","gl_Position.xy += 2.0 * invSize * offsetVec * gl_Position.w;","#endif","#else","gl_Position.xy += 2.0 * invSize * (normal.xy + corner.xy * uv2) * gl_Position.w;","#endif","#endif","vColor = vec4(color.rgb, 1.0);","vUv = uv;","#ifdef USE_CLIPPINGPLANES","vec4 _mvPos;","if(nbClipPlanes > 0) {","for( int i = 0; i < MAX_CLIP_PLANES; i++ ) {",c._DefaultShaderChunk.getModelViewTransformationChunk("_mvPos","vec4(position.xyz, 1.0)"),"clipDist[ i ] = dot( _mvPos.xyz, clipPlaneEquations[ i ].xyz ) + clipPlaneEquations[ i ].w;","}","}","#endif"].join("\n"),fragmentShaderPars:["varying vec4 vColor; varying vec2 vUv; uniform sampler2D fontMap;","uniform float opacity;",c.ShaderChunk.clip_pars_fragment].join("\n"),fragmentShaderBody:[c.ShaderChunk.clip_fragment,"float epsilon = 0.1;","float alphaTest = 0.01;","vec4 texture = texture2D(fontMap, vUv);","#ifdef GL_OES_standard_derivatives","    float w = clamp(200.0 * epsilon * (abs(dFdx(vUv.x)) + abs(dFdy(vUv.y))), 0.0, 0.5);","#else","    float w = epsilon;","#endif","float alpha = smoothstep(0.5 - w, 0.5 + w, texture.r);","alpha = pow(alpha, 1.0/2.2);","if (alpha < alphaTest) discard;","gl_FragColor = vec4(vColor.xyz, alpha * opacity);"].join("\n")});this.textMaterial.enableClipPlanes=true;this.textMaterial.loadUniforms=b},_addText:function(n,o,l){var j=n.string.length;var k=this._occurrences[0].renderable;if(!o){for(var m=0;m<k.layer.layers.length;m++){var p=k.layer.layers[m];var q=p.drawableInterval;if(!q.layerNum&&(q.count>=6*j)){o=p;l=m;break}}}if(o){var r=this._updatePrimitives(o,l,j);this._updateBuffers(r,n);return r}return null},_updateBuffers:function(x,P){var R=new c.Box2();var n=x.group.geometry;var q=x.start/6;var N=x.start;var o=4*q;var l=P;var y=l.string.length;var t=this.getBuffer(e.VertexComponentEnum.POSITION,n);var Z=this.getBuffer(e.VertexComponentEnum.NORMAL,n);var v=this.getBuffer(e.VertexComponentEnum.DIFFUSE_COLOR,n);var m=this.getBuffer(e.VertexComponentEnum.TEX_COORD_0,n);var F=this.getBuffer(e.VertexComponentEnum.TEX_COORD_1,n);var z=this.getBuffer(e.VertexComponentEnum.TEX_COORD_2,n);var B=this.getBuffer(e.VertexComponentEnum.TEX_COORD_3,n);var A=this.getIndexBuffer(n);var M=l.size/h.base;var ab=l.lineLength?l.lineLength:0;var U=0;var O=new c.Vector3();var G=N;var T=o;var s=3*o;var J=4*o;var E=3*o;var r=3*o;var C=3*o;var H=3*o;var D=3*o;var X=0;var k=0;for(var W=0;W<y;W++){var u=l.string[W];if(u==="\n"){O.x=0;O.y-=M*this.lineHeight*h.base;U=0}else{if(ab&&u===" "){if(U>ab){O.x=0;O.y-=M*this.lineHeight*h.base;U=0;continue}}u=h.chars[u.charCodeAt(0)];if(!u){continue}k++;A[G++]=T;A[G++]=T+1;A[G++]=T+2;A[G++]=T;A[G++]=T+2;A[G++]=T+3;T+=4;m[C++]=u.x/h.width;m[C++]=(h.height-(u.y+u.height))/h.height;m[C++]=0;m[C++]=(u.x+u.width)/h.width;m[C++]=(h.height-(u.y+u.height))/h.height;m[C++]=0;m[C++]=(u.x+u.width)/h.width;m[C++]=(h.height-u.y)/h.height;m[C++]=0;m[C++]=u.x/h.width;m[C++]=(h.height-u.y)/h.height;m[C++]=0;var L=O.x+M*(0.5*u.width+u.xoffset);var K=O.y+M*(u.yoffset-0.5*u.height);var I=O.z;O.x+=M*u.xadvance;U+=M*u.xadvance;if(R){if(L-0.5*M*u.width<R.min.x){R.min.x=L-0.5*M*u.width}if(L+0.5*M*u.width>R.max.x){R.max.x=L+0.5*M*u.width}if(K-0.5*M*u.height<R.min.y){R.min.y=K-0.5*M*u.height}if(K+0.5*M*u.height>R.max.y){R.max.y=K+0.5*M*u.height}}for(var V=0;V<4;V++){v[J++]=l.color.r;v[J++]=l.color.g;v[J++]=l.color.b;v[J++]=V;Z[s++]=L;Z[s++]=K;Z[s++]=0;t[E++]=l.anchor.x;t[E++]=l.anchor.y;t[E++]=l.anchor.z;F[r++]=M*u.width;F[r++]=M*u.height;F[r++]=0;z[H++]=l.up.x;z[H++]=l.up.y;z[H++]=l.up.z;B[D++]=l.right.x;B[D++]=l.right.y;B[D++]=l.right.z}}}for(var W=0;W<6*(y-k);W++){A[G++]=0}this.updateBuffer(e.VertexComponentEnum.POSITION,o,4*y,n);this.updateBuffer(e.VertexComponentEnum.NORMAL,o,4*y,n);this.updateBuffer(e.VertexComponentEnum.DIFFUSE_COLOR,o,4*y,n);this.updateBuffer(e.VertexComponentEnum.TEX_COORD_0,o,4*y,n);this.updateBuffer(e.VertexComponentEnum.TEX_COORD_1,o,4*y,n);this.updateBuffer(e.VertexComponentEnum.TEX_COORD_2,o,4*y,n);this.updateBuffer(e.VertexComponentEnum.TEX_COORD_3,o,4*y,n);this.updateIndexBuffer(N,6*y,n);var Y=new c.Vector3(R.min.x,R.min.y,-0.5);var w=new c.Vector3(R.max.x,R.max.y,0.5);var S=this.getBoundingBox();var Q=new c.Box3(Y,w);this.forceBoundingBox(S.union(Q));if(!P.labelExtent){P.labelExtent=R}},getTextExtent:function(r){var q=new c.Box2();r.labelExtent=q;var l=r;var u=l.string.length;var s=l.size/h.base;var t=l.lineLength?l.lineLength:0;var m=0;var o=new c.Vector2();for(var p=0;p<u;p++){var n=l.string[p];if(n==="\n"){o.x=0;o.y-=s*this.lineHeight*h.base;m=0}else{if(t&&n===" "){if(m>t){o.x=0;o.y-=s*this.lineHeight*h.base;m=0;continue}}n=h.chars[n.charCodeAt(0)];if(!n){continue}var k=o.x+s*(0.5*n.width+n.xoffset);var j=o.y+s*(n.yoffset-0.5*n.height);o.x+=s*n.xadvance;m+=s*n.xadvance;if(k-0.5*s*n.width<q.min.x){q.min.x=k-0.5*s*n.width}if(k+0.5*s*n.width>q.max.x){q.max.x=k+0.5*s*n.width}if(j-0.5*s*n.height<q.min.y){q.min.y=j-0.5*s*n.height}if(j+0.5*s*n.height>q.max.y){q.max.y=j+0.5*s*n.height}}}return q},_updatePrimitives:function(q,l,A){this._mergePrimitives(q,l);var u=q.geometry;var z=u.drawingGroups[0].primitives;var t=q.drawableInterval;var r=z[t.primitiveStart];var v=r.count;r.count=6*A;var y=v-r.count;if(y>0){var x=new e.SGPrimitive({cgmId:this._token,rep:null,group:r.group,start:r.start+r.count,count:y});this._token++;z.splice(t.primitiveStart+1,0,x)}for(var o=0;o<this._occurrences.length;o++){var B=this._occurrences[o].renderable;var p=B.layer.layers[l];var m=l?B.layer.layers[l-1]:null;var s=m&&(m.geometry===p.geometry);if(m&&s&&m.drawableInterval.layerNum===1){m.drawableInterval.count+=r.count;m.drawableInterval.primitiveCount++;if(y>0){p.drawableInterval.start=r.start+r.count;p.drawableInterval.count=y;p.drawableInterval.primitiveStart++}else{B.layer.layers.splice(l,1)}}else{p.drawableInterval.count=6*A;p.drawableInterval.layerNum=1;if(y>0){var w=p.clone();w.drawableInterval.layerNum=0;w.drawableInterval.start=r.start+r.count;w.drawableInterval.count=y;B.layer.layers.splice(l+1,0,w)}}if(y>0){for(var n=l+1;n<B.layer.layers.length;n++){if(B.layer.layers[n].geometry!==u){break}B.layer.layers[n].drawableInterval.primitiveStart++}}}return r},_mergePrimitives:function(p,m){var r=p.geometry;var t=r.drawingGroups[0].primitives;var q=p.drawableInterval;if(q.primitiveCount<=1){return}var s=t[q.primitiveStart];var l=t[q.primitiveStart+q.primitiveCount-1];s.count=l.start+l.count-s.start;t.splice(q.primitiveStart+1,q.primitiveCount-1);for(var o=0;o<this._occurrences.length;o++){var u=this._occurrences[o].renderable;for(var n=m+1;n<u.layer.layers.length;n++){if(u.layer.layers[n].geometry!==r){break}u.layer.layers[n].drawableInterval.primitiveStart-=q.primitiveCount-1}}q.primitiveCount=1},});return UWA.namespace("THREEDS/Nodes/TextNode",g)});define("DS/SceneGraphNodes/CSS2DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(b,c){var a=c.extend({defaultOptions:{},init:function(k,n,f,m){var j=null;var l=null;var e=null;var h=null;if(k.hasOwnProperty("html")){j=k.html;l=k.position;e=k.name;h=k.offset}else{console.warn("DEPRECATED : create your CSS2DNode with a litteral object");j=k;l=n;e=f;h=m}if(!l){l=new b.Vector3()}this._parent(e);this._element=j;var d=document.createElement("div");d.appendChild(j);d.style.display="none";d.ondragstart=function(){return false};this.css2DNode=new b.CSS2DNode(d,l,h);this.hasExplicitBE=true;this.explicitBSphere=new b.Sphere(new b.Vector3(0,0,0),1);this.explicitBBox=null;this.css2DNode.matrixAutoUpdate=false;this.css2DNode.applyMatrix(new b.Matrix4().setPosition(l));this._alwaysOnTopIndex=null;var g=this._occurrences[0];g.renderable=this.css2DNode;g.renderable.name=this.name;g.renderable._occurrence=g;if(document.getElementById("divCss2DElement")){document.getElementById("divCss2DElement").appendChild(this.css2DNode.element)}this._matrix=this.css2DNode.matrix;this._updateMatrix();this.rank=0;this.vanish=false;return this},setPickability:function(d){this.css2DNode.element.style.pointerEvents=(d?"auto":"none")},getElement:function(){return this._element},add:function(){return false},getNodeType:function(){return"CSS2DNode"},setOffset:function(d){if(d instanceof b.Vector2){this.css2DNode.offset=d.clone();this._occurrences[0].node.css2DNode.offset=this.css2DNode.offset}},getOffset:function(){return this.css2DNode.offset},setAlwaysOnTopIndex:function(d){this._alwaysOnTopIndex=d},getAlwaysOnTopIndex:function(){return this._alwaysOnTopIndex},updatePosition:function(){var j=this._getViewer();if(j){var f=this.css2DNode;var e=j.canvas;var g=j.currentViewpoint.camera;var d=new b.Vector3();d.copy(this.css2DNode.position);if(g.getLookAt().dot(g.position.clone().sub(d))<0){var h=new b.Projector();h.projectVector(d,g);f.element.style.display="block";f.element.style.left=(this.css2DNode.offset.x+(d.x+1)/2*e.width)/(window.devicePixelRatio||1)+"px";f.element.style.top=(this.css2DNode.offset.y+(-d.y+1)/2*e.height)/(window.devicePixelRatio||1)+"px"}else{f.element.style.display="none"}}},clone:function(){return new THREEDS.Nodes.CSS2DNode(this.css2DNode.element,this.css2DNode.position,this.name)}});return UWA.namespace("THREEDS/Nodes/CSS2DNode",a)});define("SceneGraphNodes/CSS2DNode",["DS/SceneGraphNodes/CSS2DNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/CSS2DNode");return b});define("DS/SceneGraphNodes/PointLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(c,b){var a=b.extend({init:function(f,e){if(!f){f={}}var d=f.intensity;if(d===undefined){d=f.power?f.power/(4*Math.PI):1}var g=new c.PointLight(f.color,d,f.distance);if(f.physicalAttenuation){g.isPhysicallyAttenuated=true;g.attenuationScale=f.attenuationScale?f.attenuationScale:1/1000000}this._parent(g,e);return this},setPower:function(e){var d=e/(4*Math.PI);this.setIntensity(d)},setPhysicalAttenuation:function(d){this.light3js.isPhysicallyAttenuated=d;var f=this._occurrences.length;for(var e=0;e<f;e++){this._occurrences[e].renderable.isPhysicallyAttenuated=d}},setPhysicalAttenuationScale:function(f){this.light3js.attenuationScale=f;var e=this._occurrences.length;for(var d=0;d<e;d++){this._occurrences[d].renderable.attenuationScale=f}},castShadows:function(e,g){var j=this._occurrences.length;if(e){this.light3js.castShadow=true;if(g){var d=false;if(g.bias){this.light3js.shadowBias=g.bias}if(g.near){this.light3js.shadowCameraNear=g.near}if(g.far){this.light3js.shadowCameraFar=g.far}if(g.darkness){this.light3js.shadowDarkness=g.darkness}if(g.mapWidth){this.light3js.shadowMapWidth=g.mapWidth;d=true}if(g.mapHeight){this.light3js.shadowMapHeight=g.mapHeight;d=true}if(this.light3js.shadowMap&&d){this.light3js.shadowMap.dispose();this.light3js.shadowMap=null;this.light3js.updateShadowMap=true}}for(var h=0;h<j;h++){var f=this._occurrences[h].renderable;f.castShadow=true;if(g){var d=false;if(g.bias){f.shadowBias=g.bias}if(g.near){f.shadowCameraNear=g.near}if(g.far){f.shadowCameraFar=g.far}if(g.darkness){f.shadowDarkness=g.darkness}if(g.mapWidth){f.shadowMapWidth=g.mapWidth;d=true}if(g.mapHeight){f.shadowMapHeight=g.mapHeight;d=true}if(f.shadowMap&&d){f.shadowMap.dispose();f.shadowMap=null;f.updateShadowMap=true}}}}else{this.light3js.castShadow=false;for(var h=0;h<j;h++){this._occurrences[h].renderable.castShadow=false}}},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"PointLightNode3D"}});return UWA.namespace("THREEDS/Nodes/PointLight",a)});define("SceneGraphNodes/PointLightNode",["DS/SceneGraphNodes/PointLightNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/PointLightNode");return b});define("DS/Visualization/InternalSceneGraph",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents"],function(b,n,k,p,c,j,o,h,g,e,d){var l,f,a;var m=b.extend({init:function(u,r,t){this.parentSceneGraph=null;this.bShowReferenceAxisSystem=true;this.lockShowReferenceAxisSystem=t;this.scene=new n.Scene();this.scene.matrixWorldNeedsUpdate=false;this.viewer=u;this.drivesTheRobot=false;this.viewpointAdded=false;this.root=new k();this.root.setLinkedToSceneGraph(true);this.root.setNotAllowedInPathElement(true);this.userRoot=new k();this.userRoot.setLinkedToSceneGraph(true);if(r||window.userRootOutOfPathElements){this.userRoot.setNotAllowedInPathElement(true)}this.root.addChild(this.userRoot);if(this.viewer._svgMode){this.svgRoot=new k();this.svgRoot._isSVGRoot=true;this.root.addChild(this.svgRoot)}this.robotRoot=new k();this.robotRoot.exludeFromBounding(true);this.robotRoot._setVisibilityFree(true);this.root.addChild(this.robotRoot);this._robot=null;this._customReferenceAxisSystem=null;var s=this;var q=function(){s.modelEvents.publish("onready")};this.root.subscribe("onready",q);this.root3js=new n.Object3D();this.root3js.isRoot3ds=true;this.root3js.viewer=u;this.root3js.matrixAutoUpdate=false;this.root3js.matrixWorldNeedsUpdate=false;this.root.setScene(this.root3js);this.root3js.node=this.root;this.scene.add(this.root3js);this.modelEvents=new d();this.selectionHL=new o(this);this.selectionPreHL=new h(this);this._subscribedEvents=[];this._onViewpointChangedEvent=null;return this},onSelectViewpoint:function(){this.subscribeToOnViewpointChanged()},subscribeToOnViewpointChanged:function(){var s=this.viewer.currentViewpoint;var q=this._onViewpointChangedEvent;var t=false;if(q){if(s===q.object){return}else{q.object.unsubscribe(q.token);this._onViewpointChangedEvent=null;t=true}}var r=this.viewer.currentViewpoint.onMove(this.onViewpointChange.bind(this));this._onViewpointChangedEvent={object:this.viewer.currentViewpoint,token:r};if(t){this.onViewpointChange()}},onAddViewpoint:function(){this.subscribeToOnViewpointChanged();if(!this.viewpointAdded){var q=this.viewer.onViewerResize(this.onViewpointChange.bind(this));this._subscribedEvents.push({object:this.viewer,token:q})}this.viewpointAdded=true;if(!this.lockShowReferenceAxisSystem){this.showReferenceAxisSystem(this.bShowReferenceAxisSystem,true)}},onViewpointChange:function(){var q=this.viewer.currentViewpoint;if(!q){return}q._updateRobotCamera(this);if(this._robot){this._robot.onViewpointChange()}if(this.referenceAxisSystemNode){this.referenceAxisSystemNode.onViewpointChange()}},_detachEvents:function(){this.selectionPreHL._detachEvents();this.selectionHL._detachEvents();var r,q;for(r=0;r<this._subscribedEvents.length;r++){q=this._subscribedEvents[r];q.object.unsubscribe(q.token)}this._subscribedEvents=[]},getChildByName:function(q){return this.root.getChildByName(q)},getMeshMin:function(v){var r=null,q=new n.Vector3(),A,B,u,t,s,w;B=null;u=0;if(v.geometry.length>=0){B=v.geometry[0];u=v.geometry.length}else{if(v.geometry._type===2){B=v.geometry;u=1}}for(t=0;t<u;t++){w=B.vertexPositionArray;if(w===null){B=v.geometry[t+1];continue}A=v._getMMMatrix();if(B.compressedVertices){for(s=0;s<w.length;s+=2){var C=w[s];var z=w[s+1];var D=B.uncompressPoint(C,z);q.x=D.x;q.y=D.y;q.z=D.z;q.applyMatrix4(A);if((q.z<r)||(r===null)){r=q.z}}}else{for(s=0;s<w.length;s+=3){q.x=w[s];q.y=w[s+1];q.z=w[s+2];q.applyMatrix4(A);if((q.z<r)||(r===null)){r=q.z}}}B=v.geometry[t+1]}v._minZ=r;return r},getSceneMin:function(E){if(!this.root3js){return 0}if(E){if(this.root){var D=this.root.getBoundingBox("show");if(D){return D.min.z}}return 0}var q=this.root3js.children,x=null,y,C,v,s,u,z=null,s=new n.Vector3();var G,t;for(y=0,C=q.length;y<C;y++){v=q[y];var w=true;if(v.visibilityFree){w=v.visible}else{w=this.viewer.visibleSpace?v.visible:!v.visible}if(w&&v.frustumCulled&&v.geometry&&(v.geometry.boundingSphere!==null)&&v.geometry.boundingSphere.radius&&v.geometry.length&&v.geometry[0].drawingGroups.length){var B=v._getMMMatrix();s.copy(v.geometry.boundingSphere.center);s.applyMatrix4(B);v._centerZ=s.z;u=B?B.getMaxScaleOnAxis():1;G=v._centerZ+v.geometry.boundingSphere.radius*u;if((x===null)||(G<x)){x=G}}}var r=[];for(y=0,C=q.length;y<C;y++){v=q[y];var w=true;if(v.visibilityFree){w=v.visible}else{w=this.viewer.visibleSpace?v.visible:!v.visible}if(w&&v.frustumCulled&&v.geometry&&(v.geometry.boundingSphere!==null)&&v.geometry.boundingSphere.radius&&v.geometry.length&&v.geometry[0].drawingGroups.length){var B=v._getMMMatrix();u=B?B.getMaxScaleOnAxis():1;t=v._centerZ-v.geometry.boundingSphere.radius*u;if(t<x){if(!v.geometry[0].vertexPositionArray){r.push(v)}else{var F=this.getMeshMin(v)}if((z===null)||(F<z)){z=F}}}}if(r.length){var A=this.viewer.renderer.boundingBoxGPUCompute.computeZMinGPU(this.viewer,r);if(z===undefined){z=A}else{z=Math.min(A,z)}}return z},updateShaders:function(){this.viewer.renderer.recompileAllShaders()},getBoundingSphere:function(s,r){var q=this.root._occurrences[0].getBoundingSphere(s,true);if(!r&&(!q||(q.radius<=0&&q.pixelRadius<=0))){q=new n.Sphere(new n.Vector3(),100)}return q},clearSelection:function(){this.selectionHL.clearAll();this.selectionPreHL.clearAll()},addRobotNode:function(q){this.robotRoot.addChild(q)},addUserNode:function(r,q){if(q){this.userRoot.children[0].addChild(r)}else{this.userRoot.addChild(r)}},removeUserNode:function(r,q){if(q){this.userRoot.children[0].removeChild(r,true)}else{if(r instanceof k||!r){this.userRoot.removeChild(r,true)}else{this.userRoot.removeChild(r._private_root,true)}}},setRobot:function(r,s,t,q){if(r&&!q){this.lockShowReferenceAxisSystem=false}s=s||{};this.drivesTheRobot=true;this.createAxisSystem();if(this._robot&&r){this.robotRoot.remove(this._robot,true);this._robot._dispose();this._robot=null;this.robot=null}if(!this._robot){this.createRobot(t,s,l)}if(r){this._robot.setHiddenMode(false)}else{this._robot.setHiddenMode(true)}if(!q){this.robot=r?this._robot:undefined}return true},getRobot:function(){if(this.drivesTheRobot){return this.robot}else{return this.getChildByName("robot")}},setCustomReferenceAxisSystem:function(q){if(this._customReferenceAxisSystem){this.robotRoot.removeChild(this._customReferenceAxisSystem);this._customReferenceAxisSystem._dispose();this._customReferenceAxisSystem=null}if(q){this._customReferenceAxisSystem=new a(this.viewer,q);this._customReferenceAxisSystem.setRenderPasses(["robotOrtho"]);this.robotRoot.addChild(this._customReferenceAxisSystem);this._customReferenceAxisSystem.onViewpointChange()}},clearScene:function(x,u,w){this.clearSelection();var s=(x!==undefined)?x:false,t=(u!==undefined)?u:false,v=this.userRoot.children.length,r;if(w==="deprecated"){var q=this.userRoot.children[0];while(q.children.length){q.remove(q.children[0])}}else{for(r=0;r<v;r++){this.userRoot.remove(this.userRoot.children[0])}}},getUserNodes:function(q){var t=[],r;var s=this.getUserRoot(q);for(r=0;r<s.children.length;r++){t.push(s.children[r])}return t},getUserRoot:function(q){return q?this.userRoot.children[0]:this.userRoot},addDebugNode:function(q){if(!this.debugRoot){this.debugRoot=new k();this.debugRoot.excludeFromBounding=true;this.root.addChild(this.debugRoot)}this.debugRoot.addChild(q)},removeDebugNode:function(q){this.debugRoot.removeChild(q)},showReferenceAxisSystem:function(r,q){if(!q){this.lockShowReferenceAxisSystem=false}this.bShowReferenceAxisSystem=r;if(this.viewpointAdded){this.createAxisSystem();this.updateReferenceAxisSystemVisibility()}},createAxisSystem:function(){if(!this.referenceAxisSystemNode){this.referenceAxisSystemNode=new f("referenceAxisSystem",this.viewer);this.robotRoot.addChild(this.referenceAxisSystemNode);this.referenceAxisSystemNode.setCameraName("robotCameraOrtho");this.referenceAxisSystemNode.setRenderPasses(["robotOrtho"])}},createRobot:function(s,q,r){this._robot=new r(this,"robot",s,q.snapOnFace,q.showOnlyManipulated,"I solemnly swear that I am up to no good.",q.touchMode);this.onViewpointChange();this.updateReferenceAxisSystemVisibility()},updateReferenceAxisSystemVisibility:function(){if(this.referenceAxisSystemNode){this.referenceAxisSystemNode._setEnabled(this.bShowReferenceAxisSystem)}},setRobotAndRefAxisSystemEnabled:function(q){if(this._robot){this._robot._setEnabled(q)}if(this.referenceAxisSystemNode){this.referenceAxisSystemNode._setEnabled(q)}},dispose:function(){if(this._robot){this._robot._dispose()}if(this.referenceAxisSystemNode){this.referenceAxisSystemNode._dispose()}if(this._customReferenceAxisSystem){this._customReferenceAxisSystem._dispose()}this._robot=null;this.robot=null;this.referenceAxisSystemNode=null;this._detachEvents();this.clearScene();while(this.root.children.length){this.root.removeChild(this.root.children[0])}this.scene.dispose();this.selectionHL=null;this.selectionPreHL=null;var q;for(q in this){this[q]=null}}});m.setRobotClasses=function(q,s,r){l=q;f=s;a=r};return UWA.namespace("THREEDS/InternalSceneGraph",m)});define("Visualization/InternalSceneGraph",["DS/Visualization/InternalSceneGraph","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/InternalSceneGraph");return b});define("DS/SceneGraphNodes/SphereLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(b,a){var c=a.extend({init:function(f,e){var d=new b.SphereLight(f.color,f.intensity,f.radius);this._radius=d.radius;this._parent(d,e);return this},setRadius:function(d){if(d){this._radius=d}this._updateRadius()},_updateRadius:function(){var e,f,d;this.light3js.radius=this._radius;e=this._occurrences.length;for(var d=0;d<e;d++){f=this._occurrences[d];f.renderable.radius=this._radius}},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"SphereLightNode3D"}});return UWA.namespace("THREEDS/Nodes/SphereLight",c)});define("SceneGraphNodes/SphereLightNode",["DS/SceneGraphNodes/SphereLightNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/SphereLightNode");return b});define("DS/Gestures/SmartEditGesture",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture","DS/WebRecordEnabler/Adapter"],function(a,d,b,e,f){var c=e.extend({init:function(){this._parent("SmartEdit");this.priority=10;this.identifier=null;this.maxTimeTouch=300;this.maxTimeMouse=300;this.maxDistance=10;this.timer=null;this._type=-1;this.event=null;return this},detect:function(n){this._parent(n);var m=this;var l=THREEDS.VisuEventsManager.getTouchEventsByStates([b.State.BEGIN,b.State.MOVE,b.State.IDLE]);var j=THREEDS.VisuEventsManager.getMouseEvents(null,this.view);var k=null;switch(this.state){case e.State.INIT:if(l.length===1||this.onlyLeftMouse(j)){this.resetTimer();if(l.length===1){k=THREEDS.VisuEventsManager.getTouchEventsByStates([b.State.BEGIN],this.view);this._type=1}else{if(j.length){k=THREEDS.VisuEventsManager.getMouseEventsByStates([b.State.BEGIN],0,this.view);this._type=0}}if(k&&k.length===1){this.resetTimer();var g=(this._type===1)?this.maxTimeTouch:this.maxTimeMouse;this.identifier=k[0].identifier;this.event=k[0];if(!g){this.events=[k[0]];this.changeState(e.State.OK);this._type=-1}else{if(!f.isReplaying()){this.timer=setTimeout(function(){m.events=[k[0]];m.changeState(e.State.OK);m.execute(true);m._type=-1},g)}this.changeState(e.State.BEGIN)}}else{this._type=-1}}break;case e.State.BEGIN:var h=null;if(this._type===1){h=THREEDS.VisuEventsManager.getTouchEventById(this.identifier)}else{if(this._type===0){h=this.event}}if((this._type===1&&l.length!==1)||(this._type===0&&!this.onlyLeftMouse(j))||(h===null)||(h.state===b.State.END)){this.resetTimer();this.changeState(e.State.KO)}else{if(h.state===b.State.MOVE){if(h.offsetPosition.length()>this.maxDistance){this.events=[h];this.changeState(e.State.OK);this._type=-1}}}break;case e.State.KO:case e.State.OK:case e.State.CANCEL:this.changeState(e.State.INIT);break;default:break}},onlyLeftMouse:function(g){for(var h=0;h<g.length;h++){if((g[h].button!==0)&&(g[h].button!==-1)){return false}}return true},resetTimer:function(){if(this.timer!==null){clearTimeout(this.timer);this.timer=null;this._type=-1}},whenKO:function(){this.resetTimer();this.changeState(e.State.KO)}});return UWA.namespace("THREEDS/Gestures/SmartEditGesture",c)});define("DS/VisuEvents/EventsManager",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/VisuEvents/MouseEvent","DS/VisuEvents/TouchEvent","DS/VisuEvents/KeyboardEvent","DS/Gestures/ClickGesture","DS/Gestures/HoldGesture","DS/Gestures/HoldMouseDownGesture","DS/Gestures/LongHoldGesture","DS/Gestures/EditGesture","DS/Gestures/LongEditGesture","DS/Gestures/SmartEditGesture","DS/Gestures/KeyDownGesture","DS/Gestures/KeyUpGesture","DS/Gestures/MouseDownGesture","DS/Gestures/MouseUpGesture","DS/Gestures/MouseMoveGesture","DS/Gestures/MouseOutGesture","DS/Gestures/MouseWheelGesture","DS/Gestures/TouchGesture","DS/Gestures/ReleaseGesture","DS/Gestures/TapGesture","DS/Gestures/PinchGesture","DS/Gestures/PanGesture","DS/Gestures/RotateGesture","DS/Gestures/PinchPanRotateGesture","DS/Gestures/SwipeGesture","DS/Gestures/SpreadGesture","DS/Gestures/DragGesture","DS/Gestures/PinchTapGesture","DS/Gestures/PrimaryPointerDownUniqueGesture","DS/Gestures/PrimaryPointerMoveUniqueGesture","DS/Gestures/PrimaryPointerUpUniqueGesture","DS/Gestures/PrimaryPointerClickGesture","DS/Gestures/PrimaryPointerDoubleClickGesture","DS/Gestures/DoubleClickGesture","DS/Gestures/DoubleTapGesture","DS/Gestures/DoublePinchTapGesture","DS/WebRecordEnabler/Adapter","DS/Gestures/BasicGesture","DS/Gestures/MediumHoldGesture"],function(b,j,M,d,A,y,F,p,R,f,V,r,u,P,s,q,Q,L,I,g,S,U,z,k,H,m,c,C,J,e,t,w,T,O,D,l,E,v,G,o,B,N,n){var K=0;var x=b.singleton({options:{},init:function(X){this._recordViewTable={};this._maxViewIndex=-1;this.options=this.defaultOptions;UWA.extend(this.options,X);this._parent(X);this._screenEvents=[];this._currentEvents=[];this._primaryTouches=[];this.debugEvents=0;this._currentTime=0;this._gestureRecognizers=[];this._gesturesNeedSort=false;this._gesturesMap=[];this._customGesturesMap=[];this._gesturesToRemove=[];this._ODTMode=false;this._ODTPiouPiouEvents=null;this._ODTPiouPiouDragsTab=[];this.nbGesturesToLoad=0;this.simulateTouch=false;this.simulateTouchCB=false;this.fingerDivs=[];this.fingers=[];this.fingerDst=new M.Vector2(100,100);this._leftButtonPressed=false;this._shiftKeyPressed=false;this._staticKeyPressed=false;var ab=this;this.isTouch=("ontouchstart" in window);this._isTouchSupported=!!window.TouchEvent;this.isPointer=!!window.PointerEvent;var W=false;try{var Y=Object.defineProperty({},"passive",{get:function(){W=true}});window.addEventListener("test",null,Y)}catch(Z){W=false}this.supportsPassive=W;this.currentButtons=0;this._onKeyDown=function(ac){ab._keyDown.call(ab,ac)};this._onKeyUp=function(ac){ab._keyUp.call(ab,ac)};this._onMouseMove=function(ac){ab._mouseMove.call(ab,ac)};this._onMouseDown=function(ac){ab._mouseDown.call(ab,ac)};this._onMouseUp=function(ac){ab._mouseUp.call(ab,ac)};this._onMouseOut=function(ac){ab._mouseOut.call(ab,ac)};this._onMouseWheel=function(ac){ab._mouseWheel.call(ab,ac)};this._onTouchMove=function(ac){ab._touchMove.call(ab,ac)};this._onTouchStart=function(ac){ab._touchStart.call(ab,ac)};this._onTouchEnd=function(ac){ab._touchEnd.call(ab,ac)};this._onPointerDown=function(ac){ab._pointerDown.call(ab,ac)};this._onPointerMove=function(ac){ab._pointerMove.call(ab,ac)};this._onPointerUp=function(ac){ab._pointerUp.call(ab,ac)};this._onPointerCancel=function(ac){ab._pointerCancel.call(ab,ac)};this.touchDetached=true;this.pointerDetached=true;this._isIE11=((new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent)!=null));this._isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;this._attachEvents();this._isInit=true;this.holdTime=500;this.mediumHoldTime=750;this.longHoldTime=1000},_attachEvents:function(){if(B.isReplaying()){return}UWA.Element.addEvent.call(document,"mouseleave",this._onMouseOut);document.addEventListener("mousedown",this._onMouseDown,true);document.addEventListener("mousemove",this._onMouseMove,true);document.addEventListener("mouseup",this._onMouseUp,true);document.addEventListener("mousewheel",this._onMouseWheel,this.supportsPassive?{passive:false,capture:true}:true);document.addEventListener("DOMMouseScroll",this._onMouseWheel,true);if(this._isTouchSupported){this._attachTouchEvents()}else{if(this.isPointer){this._attachPointerEvents()}}document.addEventListener("keydown",this._onKeyDown,true);document.addEventListener("keyup",this._onKeyUp,true);document.addEventListener("contextmenu",this._contextMenu,true);this._screenEvents=[]},_detachEvents:function(){if(B.isReplaying()){return}UWA.Element.removeEvent.call(document,"mouseleave",this._onMouseOut);document.removeEventListener("mousedown",this._onMouseDown,true);document.removeEventListener("mousemove",this._onMouseMove,true);document.removeEventListener("mouseup",this._onMouseUp,true);document.removeEventListener("mousewheel",this._onMouseWheel,this.supportsPassive?{passive:false,capture:true}:true);document.removeEventListener("DOMMouseScroll",this._onMouseWheel,true);this._detachTouchEvents();this._detachPointerEvents();document.removeEventListener("keydown",this._onKeyDown,true);document.removeEventListener("keyup",this._onKeyUp,true);document.removeEventListener("contextmenu",this._contextMenu,true);this._screenEvents=[]},_attachTouchEvents:function(){var W=this.supportsPassive?{capture:true,passive:false}:true;if(this.touchDetached){document.addEventListener("touchmove",this._onTouchMove,W);document.addEventListener("touchstart",this._onTouchStart,W);document.addEventListener("touchend",this._onTouchEnd,W);document.addEventListener("touchcancel",this._onTouchCancel,W);this.touchDetached=false}},_attachPointerEvents:function(){if(this.pointerDetached){document.addEventListener("pointerdown",this._onPointerDown,true);document.addEventListener("pointermove",this._onPointerMove,true);document.addEventListener("pointerup",this._onPointerUp,true);document.addEventListener("pointercancel",this._onPointerCancel,true);this.pointerDetached=false}},_detachTouchEvents:function(){var W=this.supportsPassive?{capture:true,passive:false}:true;if(!this.touchDetached){document.removeEventListener("touchmove",this._onTouchMove,W);document.removeEventListener("touchstart",this._onTouchStart,W);document.removeEventListener("touchend",this._onTouchEnd,W);document.removeEventListener("touchcancel",this._onTouchCancel,W);this.touchDetached=true}},_detachPointerEvents:function(){if(!this.pointerDetached){document.removeEventListener("pointerdown",this._onPointerDown,true);document.removeEventListener("pointermove",this._onPointerMove,true);document.removeEventListener("pointerup",this._onPointerUp,true);document.removeEventListener("pointercancel",this._onPointerCancel,true);this.pointerDetached=true}},setDebugEvents:function(W){this.debugEvents=W;for(var Y=0;Y<this._gestureRecognizers.length;Y++){var X=this._gestureRecognizers[Y];X.setDebugEvents(W)}},setSimulateTouch:function(W){this.simulateTouch=W;if(W&&!this.simulateTouchCB){var X=this;j.subscribe({event:"/VISU/onBasicEvent"},function(Y){var ab=(Y.from&&Y.from.length)?Y.from[0]:null;if(ab===null){return}if(ab.getType()==="Keyboard"){var Z=ab.getKey();if(ab.getState()===d.State.BEGIN){switch(Z){case d.KeyboardKey.SHIFT:X._shiftKeyPressed=true;break;case d.KeyboardKey.S:X._staticKeyPressed=true;break;default:break}}else{if(ab.getState()===d.State.END){switch(Z){case d.KeyboardKey.SHIFT:X._shiftKeyPressed=false;break;case d.KeyboardKey.S:X._staticKeyPressed=false;break;default:break}}}}});this.simulateTouchCB=true}},_setHoldTime:function(W){this.holdTime=W},_setMediumHoldTime:function(W){this.mediumHoldTime=W},_setLongHoldTime:function(W){this.longHoldTime=W},getHoldTime:function(){return this.holdTime},getMediumHoldTime:function(){return this.mediumHoldTime},getLongHoldTime:function(){return this.longHoldTime},getScreenEvents:function(){return this._screenEvents},getMouseEvents:function(ac,Y,ad){var W=[];for(var ab=0;ab<this._screenEvents.length;ab++){var X=this._screenEvents[ab];if(!(X instanceof A)){continue}if(ad&&(X.getButton()===d.MouseButton.NONE)){continue}if((ac!==undefined)&&(ac!==null)&&(X.getButton()!==ac)){continue}if(Y){if(Y instanceof Array){if(Y.length){for(var Z=0;Z<Y.length;Z++){if(this._isInView(X,Y[Z])){break}}if(Z===Y.length){continue}}}else{if(!this._isInView(X,Y)){continue}}}W.push(X)}return W},getMouseEventsByStates:function(af,Z,ab){var ae=this.getMouseEvents(Z,ab);var ad=[];for(var Y=0;Y<ae.length;Y++){var ac=ae[Y];for(var X=0;X<af.length;X++){var W=af[X];if(ac.getState()===W){ad.push(ac);break}}}return ad},getPrimaryPointerEventsByStates:function(Y,W){var X=this.getMouseEventsByStates(Y,d.MouseButton.LEFT,W);var ab=this.getTouchEventsByStates(Y,W);for(var Z=0;Z<ab.length;Z++){if(ab[Z].isPrimary){X.push(ab[Z])}}return X},getKeyboardEvents:function(Z){var W=[];for(var Y=0;Y<this._screenEvents.length;Y++){var X=this._screenEvents[Y];if(!(X instanceof F)){continue}if((Z!==undefined)&&(X.getKey()!==Z)){continue}W.push(X)}return W},getTouchEvents:function(Y){var W=[];for(var ab=0;ab<this._screenEvents.length;ab++){var X=this._screenEvents[ab];if(!(X instanceof y)){continue}if(Y){if(Y instanceof Array){if(Y.length){for(var Z=0;Z<Y.length;Z++){if(this._isInView(X,Y[Z])){break}}if(Z===Y.length){continue}}}else{if(!this._isInView(X,Y)){continue}}}W.push(X)}return W},getTouchEventsByStates:function(Z,Y){var W=[];for(var ac=0;ac<this._screenEvents.length;ac++){var X=this._screenEvents[ac];if(!(X instanceof y)){continue}if(Y){if(Y instanceof Array){if(Y.length){for(var ab=0;ab<Y.length;ab++){if(this._isInView(X,Y[ab])){break}}if(ab===Y.length){continue}}}else{if(!this._isInView(X,Y)){continue}}}for(var ab=0;ab<Z.length;ab++){var ad=Z[ab];if(X.getState()===ad){W.push(X);break}}}return W},getTouchEventById:function(Y){for(var X=0;X<this._screenEvents.length;X++){var W=this._screenEvents[X];if(!(W instanceof y)){continue}if(W.identifier===Y){return W}}return null},getGestureRecognizers:function(){return this._gestureRecognizers},addGestureRecognizer:function(X,W){if(W){X.setView(W)}this._gestureRecognizers.push(X);this._gesturesNeedSort=true;return X.id},removeGestureRecognizer:function(X){var W=this._gestureRecognizers.indexOf(X);if(W===-1){return false}this._gestureRecognizers.splice(W,1);return true},addCustomGesture:function(W,Y,X){if(!Y){return false}if(!W&&(W==="")){return false}this._customGesturesMap[W]={gst:Y,params:X};return true},addEvent:function(W,Y,Z){if(!W){return}var X=this._getGesture(W,Y);if(X){return X.addCallback(Z)}return null},removeEvent:function(W,Z,ab){if(!W){return false}var Y=false;var X=this._getGesture(W,Z,true);if(X){Y=X.removeCallback(ab);Y&&this._gesturesToRemove.push({view:W,action:Z,gst:X})}return Y},removeEventFromToken:function(Z){var ab=Z.split("_");if(ab.length!==2){return false}var Y=false;var X=null;for(var W=0;W<this._gestureRecognizers.length;W++){var ac=this._gestureRecognizers[W];if(ac.id===parseInt(ab[0])){X=ac;break}}if(X){Y=X.removeCallbackFromToken(Z);Y&&this._gesturesToRemove.push({view:X.view[0],action:X.action,gst:X})}return Y},_getGesture:function(X,ac,ad){if(B.isActive()){if(typeof X==="string"){X=this._getViewFromRecordId(X);if(!X){return null}}else{this._registerRecordView(X)}}var Z=null;var ab=this._gesturesMap[ac];if(ab){if(X.id){Z=ab[X.id]}}if(!Z&&!ad){if(!X.id||(X.id==="")){X.id="___view___"+K;K++}var ae=x.GESTURES_MAP[ac];if(!ae){ae=this._customGesturesMap[ac];if(!ae){return}var Y=this._loadCustomGesture(X,ac,ae.gst,ae.params);iCb(Y);return}if(ae.require){var W=this._getGesture(X,ae.require);Z=this._loadGesture(X,ac,ae.gestureName,ae.params);Z.requireGesture(W)}else{Z=this._loadGesture(X,ac,ae.gestureName,ae.params)}}else{if(Z&&!ad){Z.setView(X)}}return Z},_loadGesture:function(X,Z,W,ab){if(!this._gesturesMap[Z]){this._gesturesMap[Z]=[]}var Y=this._gesturesMap[Z][X.id];if(Y){return Y}if(ab.length){Y=new W(ab[0])}else{Y=new W()}Y.setAction(Z);Y.setView(X);Y.setDebugEvents(this.debugEvents);this._gesturesMap[Z][X.id]=Y;this.addGestureRecognizer(Y);return Y},_loadCustomGesture:function(W,Y,ab,Z){if(!this._gesturesMap[Y]){this._gesturesMap[Y]=[]}var X=this._gesturesMap[Y][W.id];if(X){return X}if(Z.length){X=new ab(Z[0])}else{X=new ab()}X.setAction(Y);X.setView(W);X.setDebugEvents(this.debugEvents);this._gesturesMap[Y][W.id]=X;this.addGestureRecognizer(X);return X},_isInView:function(ac,X){var ab=ac.getView();if(ac.path){for(var Y=0;Y<ac.path.length;Y++){var Z=ac.path[Y].__impl4cf1e782hg__||ac.path[Y].impl||ac.path[Y];var W=X.__impl4cf1e782hg__||X.impl||X;if(Z===W){return true}}}else{while(ab){if(ab===X){return true}ab=ab.parentNode}}return false},_addEvent:function(W){this._screenEvents.push(W)},_removeEvent:function(W){var X=this._screenEvents.indexOf(W);if(X===-1){return false}this._screenEvents.splice(X,1)},_removeEvents:function(X){for(var Y=0;Y<X.length;Y++){var W=X[Y];this._removeEvent(W)}},_detectGestures:function(){var X;this._sortGestures();for(X=0;X<this._gestureRecognizers.length;X++){var W=this._gestureRecognizers[X];W.detect(this._currentEvents)}for(X=0;X<this._gestureRecognizers.length;X++){var W=this._gestureRecognizers[X];W.execute()}for(X=0;X<this._gestureRecognizers.length;X++){var W=this._gestureRecognizers[X];W.update()}this._cleanRemovedGestures()},_cleanRemovedGestures:function(){if(this._gesturesToRemove.length){var X;var Y=this;for(X=0;X<this._gesturesToRemove.length;X++){var W=this._gesturesToRemove[X];if(W.gst){W.gst._dispose(function(){if(!this.view.length||!this.view[0]){return}if(!this.view[0].id||(this.view[0].id==="")){return}if(!Y._gesturesMap[this.action]){return}Y.removeGestureRecognizer(this);delete Y._gesturesMap[this.action][this.view[0].id]})}}this._gesturesToRemove=[]}},_dispose:function(){this._cleanRemovedGestures();this._screenEvents=[]},_sortGestures:function(){var ac=this._gesturesNeedSort;if(!ac){for(var ab=0;ab<this._gestureRecognizers.length;ab++){var Z=this._gestureRecognizers[ab];if(Z._needsUpdate){Z._needsUpdate=false;ac=true}}}if(ac){this._gestureRecognizers.sort(function(ae,ad){return ae.priority-ad.priority});for(var ab=0;ab<this._gestureRecognizers.length;ab++){this._gestureRecognizers[ab]._order=ab}for(var ab=0;ab<this._gestureRecognizers.length;ab++){var Z=this._gestureRecognizers[ab];if(Z.gestures.length){for(var X=0;X<Z.gestures.length;X++){var W=Z.gestures[X];if(Z._order<W._order){var Y=W._order;W._order=Z._order;Z._order=Y}}}}this._gestureRecognizers.sort(function(ae,ad){return ae._order-ad._order});this._gesturesNeedSort=false}},_triggerEvent:function(Y,W){var Z={eventChannel:"/VISU/",eventType:"@onBasicEvent",eventID:"",from:Y};j.publish({event:"/VISU/onBasicEvent",data:Z});if(((this.debugEvents===1)||(this.debugEvents===6))&&Y){for(var X=0;X<Y.length;X++){console.log(Z.eventType+" | "+Y[X].getType()+" | "+Y[X].getState())}}},_getMouseButton:function(W){switch(W){case -1:return d.MouseButton.NONE;case 0:return d.MouseButton.LEFT;case 1:return d.MouseButton.MIDDLE;case 2:return d.MouseButton.RIGHT;default:break}return false},_contextMenu:function(W){W.preventDefault()},_nextStateEvents:function(X){for(var W=0;W<X.length;W++){X[W].nextState()}},_keyDown:function(Y){if(this._ODTMode&&!Y._simul){return}if(this._ODTPiouPiouEnabled("keyboard")&&Y.keyCode!==32){var X=this._ODTPiouPiouDragsTab.length&&this._ODTPiouPiouDragsTab[this._ODTPiouPiouDragsTab.length-1];if(!X||X.type!=="keyDown"||X.keyCode!==Y.keyCode){this._ODTPiouPiouDragsTab.push({type:"keyDown",keyCode:Y.keyCode})}}if(this._ODTPiouPiouDragsTab.length>0&&Y.keyCode===32){console.log("DRAG DUMP:\n"+JSON.stringify(this._ODTPiouPiouDragsTab))}this._currentTime=new Date().getTime();var W=this.getKeyboardEvents(Y.which);if(W.length){return;this._currentEvents=W}else{this._currentEvents=[new F(Y.which,Y)];this._addEvent(this._currentEvents[0])}this._currentEvents[0].update(Y);this._triggerEvent(this._currentEvents,Y);this._detectGestures();this._nextStateEvents(this._currentEvents);if(this.simulateTouch){this._simulateTouchEvent("start",Y)}},_keyUp:function(X){if(this._ODTMode&&!X._simul){return}if(this._ODTPiouPiouEnabled("keyboard")&&X.keyCode!==32){this._ODTPiouPiouDragsTab.push({type:"keyUp",keyCode:X.keyCode})}this._currentTime=new Date().getTime();var W=this.getKeyboardEvents(X.which);if(W.length){this._currentEvents=W}this._currentEvents[0].update(X);this._triggerEvent(this._currentEvents,X);this._detectGestures();this._removeEvents(this._currentEvents);this._nextStateEvents(this._currentEvents);if(this.simulateTouch){this._simulateTouchEvent("end",X)}},_mouseDown:function(Z){if(this._ODTMode&&!Z._simul){return}if(this.simulateTouch){this._simulateTouchEvent("start",Z);return}if(this._isEventSimulatedFromTouch(Z)){return true}var Y=this._getMouseButton(Z.button);this._currentTime=new Date().getTime();var X=this.getMouseEvents(Y);if(X.length){this._currentEvents=[X[0]]}else{this._currentEvents=[new A(Y,Z)];this._addEvent(this._currentEvents[0])}this._currentEvents[0].update(Z);this._triggerEvent(this._currentEvents,Z);this._detectGestures();this._nextStateEvents(this._currentEvents);if(this._ODTPiouPiouEnabled("mousedrag")){var W=this._currentEvents[0].getCurrentPosition(Z.target);this._ODTPiouPiouMouseDrag=[{x:W.x,y:W.y,timeStamp:0,button:Z.button}];this._ODTPiouPiouDragStart=(new Date()).getTime()}},_mouseMove:function(ab){if(this._ODTMode&&!ab._simul){return}if(this.simulateTouch){this._simulateTouchEvent("move",ab);return}if(this._isEventSimulatedFromTouch(ab)){return}this._currentTime=new Date().getTime();var Y=this.getMouseEvents();if(!Y.length){this._currentEvents=[new A(d.MouseButton.NONE,ab)];this._addEvent(this._currentEvents[0])}else{var ac=this.getMouseEvents(d.MouseButton.NONE);if(!ac.length){ac=new A(d.MouseButton.NONE,ab);this._addEvent(ac);Y.push(ac)}this._currentEvents=Y}for(var Z=0;Z<this._currentEvents.length;Z++){this._currentEvents[Z].update(ab)}this._triggerEvent(this._currentEvents,ab);this._detectGestures();this._nextStateEvents(this._currentEvents);if(this._ODTPiouPiouMouseDrag){var X=(new Date()).getTime()-this._ODTPiouPiouDragStart;var W=this._currentEvents[0].getCurrentPosition(ab.target);this._ODTPiouPiouMouseDrag.push({x:W.x,y:W.y,timeStamp:X,button:ab.button})}},_mouseUp:function(ab){if(this._ODTMode&&!ab._simul){return}if(this.simulateTouch){this._simulateTouchEvent("end",ab);return}if(this._isEventSimulatedFromTouch(ab)){return}this._currentTime=new Date().getTime();var Z=this._getMouseButton(ab.button);var Y=this.getMouseEvents(Z);if(Y.length){this._currentEvents=[Y[0]];Y[0].update(ab)}this._triggerEvent(this._currentEvents,ab);this._detectGestures();this._removeEvent(Y[0]);this._nextStateEvents(this._currentEvents);if(this._ODTPiouPiouMouseDrag){var X=(new Date()).getTime()-this._ODTPiouPiouDragStart;var W=this._currentEvents[0].getCurrentPosition(ab.target);this._ODTPiouPiouMouseDrag.push({x:W.x,y:W.y,timeStamp:X,button:ab.button});this._ODTPiouPiouDragsTab.push(this._ODTPiouPiouMouseDrag);delete (this._ODTPiouPiouMouseDrag);delete (this._ODTPiouPiouDragStart)}},_mouseOut:function(Y){if(this._ODTMode&&!Y._simul){return}if(this.simulateTouch){return}if(this._isEventSimulatedFromTouch(Y)){return}this._currentTime=new Date().getTime();var X=this._getMouseButton(-1);var W=this.getMouseEvents(X);if(!W.length){this._currentEvents=[new A(X,Y)];this._addEvent(this._currentEvents[0])}else{this._currentEvents=[W[0]]}this._currentEvents[0].update(Y);this._triggerEvent(this._currentEvents,Y);this._detectGestures();this._nextStateEvents(this._currentEvents)},_mouseWheel:function(X){if(this._ODTMode&&!X._simul){return}if(this.simulateTouch){return}this._currentTime=new Date().getTime();var W=this.getMouseEvents(d.MouseButton.WHEEL);if(!W.length){this._currentEvents=[new A(d.MouseButton.WHEEL,X)];this._addEvent(this._currentEvents[0])}else{this._currentEvents=W}this._currentEvents[0].update(X);this._triggerEvent(this._currentEvents,X);this._detectGestures();this._removeEvent(this._currentEvents[0]);this._nextStateEvents(this._currentEvents)},_touchStart:function(Z,W){if(this._ODTMode&&!Z._simul){return}this._currentEvents=[];this._currentTime=new Date().getTime();if(!W){this._cancelBrokenTouches(Z)}var ab=Z.changedTouches;for(var X=0;X<ab.length;X++){var Y=this.getTouchEventById(ab[X].identifier);if(Y===null){Y=new y(ab[X].identifier,Z,X);if(!this.getTouchEvents().length){Y.setPrimary(true)}this._addEvent(Y)}this._currentEvents.push(Y);Y.update(Z);this._detectFalseMouseEvents(Y)}this._triggerEvent(this._currentEvents,Z);this._detectGestures();this._nextStateEvents(this._currentEvents)},_touchMove:function(Y){if(this._ODTMode&&!Y._simul){return}this._currentEvents=[];this._currentTime=new Date().getTime();var Z=Y.changedTouches;for(var W=0;W<Z.length;W++){var ab=Z[W].identifier;var X=this.getTouchEventById(ab);this._currentEvents.push(X);X.update(Y);this._detectFalseMouseEvents(X)}this._triggerEvent(this._currentEvents,Y);this._detectGestures();this._nextStateEvents(this._currentEvents)},_touchEnd:function(Y){if(this._ODTMode&&!Y._simul){return}this._currentEvents=[];this._currentTime=new Date().getTime();var Z=Y.changedTouches;for(var W=0;W<Z.length;W++){var ab=Z[W].identifier;var X=this.getTouchEventById(ab);this._currentEvents.push(X);X.update(Y);this._detectFalseMouseEvents(X)}this._triggerEvent(this._currentEvents,Y);this._detectGestures();this._removeEvents(this._currentEvents);this._nextStateEvents(this._currentEvents)},_touchCancel:function(Y){if(this._ODTMode&&!Y._simul){return}this._currentEvents=[];this._currentTime=new Date().getTime();var Z=Y.changedTouches;for(var W=0;W<Z.length;W++){var ab=Z[W].identifier;var X=this.getTouchEventById(ab);this._currentEvents.push(X);X.update(Y);this._detectFalseMouseEvents(X)}this._triggerEvent(this._currentEvents,Y);this._detectGestures();this._removeEvents(this._currentEvents);this._nextStateEvents(this._currentEvents)},_pointerDown:function(W){var X={target:W.target,clientX:W.clientX,clientY:W.clientY};if(W._simul){X._simul=true}switch(W.pointerType){case"mouse":case"pen":return;X.type="mousedown";X.button=W.button;this.currentButtons=W.buttons;this._mouseDown(X);break;case"touch":X.type="touchstart";X.changedTouches=[{identifier:W.pointerId,clientX:W.clientX,clientY:W.clientY,target:W.target}];X.touches=[{identifier:W.pointerId,clientX:W.clientX,clientY:W.clientY,target:W.target}];this._touchStart(X,true);break}},_pointerMove:function(X){var Y={target:X.target,clientX:X.clientX,clientY:X.clientY};if(X._simul){Y._simul=true}switch(X.pointerType){case"mouse":case"pen":return;if(X.buttons!==this.currentButtons){if((X.buttons&1)>(this.currentButtons&1)){var W={type:"mousedown",button:0,target:X.target,clientX:X.clientX,clientY:X.clientY};this._mouseDown(W)}else{if((X.buttons&1)<(this.currentButtons&1)){var W={type:"mouseup",button:0,target:X.target,clientX:X.clientX,clientY:X.clientY};this._mouseUp(W)}}if((X.buttons&2)>(this.currentButtons&2)){var W={type:"mousedown",button:2,target:X.target,clientX:X.clientX,clientY:X.clientY};this._mouseDown(W)}else{if((X.buttons&2)<(this.currentButtons&2)){var W={type:"mouseup",button:2,target:X.target,clientX:X.clientX,clientY:X.clientY};this._mouseUp(W)}}if((X.buttons&4)>(this.currentButtons&4)){var W={type:"mousedown",button:1,target:X.target,clientX:X.clientX,clientY:X.clientY};this._mouseDown(W)}else{if((X.buttons&4)<(this.currentButtons&4)){var W={type:"mouseup",button:1,target:X.target,clientX:X.clientX,clientY:X.clientY};this._mouseUp(W)}}this.currentButtons=X.buttons}Y.type="mousemove";this._mouseMove(Y);break;case"touch":Y.type="touchmove";Y.changedTouches=[{identifier:X.pointerId,clientX:X.clientX,clientY:X.clientY,target:X.target}];Y.touches=[{identifier:X.pointerId,clientX:X.clientX,clientY:X.clientY,target:X.target}];this._touchMove(Y);break}},_pointerUp:function(W){var X={target:W.target,clientX:W.clientX,clientY:W.clientY};if(W._simul){X._simul=true}switch(W.pointerType){case"mouse":case"pen":return;X.type="mouseup";X.button=W.button;this.currentButtons=W.buttons;this._mouseUp(X);break;case"touch":X.type="touchend";X.changedTouches=[{identifier:W.pointerId,clientX:W.clientX,clientY:W.clientY,target:W.target}];X.touches=[{identifier:W.pointerId,clientX:W.clientX,clientY:W.clientY,target:W.target}];this._touchEnd(X);break}},_pointerCancel:function(W){var X={target:W.target,clientX:W.clientX,clientY:W.clientY};if(W._simul){X._simul=true}switch(W.pointerType){case"mouse":case"pen":return;case"touch":X.type="touchcancel";X.changedTouches=[{identifier:W.pointerId,clientX:W.clientX,clientY:W.clientY,target:W.target}];X.touches=[{identifier:W.pointerId,clientX:W.clientX,clientY:W.clientY,target:W.target}];this._touchCancel(X);break}},_detectFalseMouseEvents:function(Y){var Z=this._primaryTouches;if(Y.isPrimary){var W={x:Y._startPosition.x,y:Y._startPosition.y};Z.push(W);var X=(function(ad,ab){var ac=ad.indexOf(ab);if(ac>-1){ad.splice(ac,1)}}).bind(null,Z,W);setTimeout(X,2500)}},_isEventSimulatedFromTouch:function(Y){var ad=this._primaryTouches;var W=Y.clientX,ae=Y.clientY;for(var ac=0;ac<ad.length;ac++){var ab=ad[ac];var Z=Math.abs(W-ab.x),X=Math.abs(ae-ab.y);if(Z<=25&&X<=25){return true}}},_cancelBrokenTouches:function(X){var ac=X.touches;var Z=this.getTouchEvents();var ab=[];if(Z.length>=ac.length){for(var Y=0;Y<Z.length;Y++){var W=Z[Y];if(!this._findTouchById(ac,W.getIdentifier())){ab.push(W);console.log("Broken touch event id="+W.getIdentifier())}}this._removeEvents(ab)}},_findTouchById:function(X,Y){for(var W=0;W<X.length;W++){if(X[W].identifier===Y){return true}}},_ODTPiouPiouEnabled:function(W){if(!this._ODTPiouPiouEvents){return false}if(this._ODTPiouPiouEvents==W||(this._ODTPiouPiouEvents instanceof Array&&this._ODTPiouPiouEvents.indexOf(W)>=0)){return true}return false},_simulateTouchEvent:function(af,Z){var ah={type:"touch"+af};ah.touches=[];ah.changedTouches=[];ah.pageX=Z.pageX;ah.pageY=Z.pageY;ah.offsetX=Z.offsetX;ah.offsetY=Z.offsetY;ah.target=Z.target;ah.currentTarget=Z.currentTarget;if(Z.button===0){if(Z.type==="mousedown"){this._leftButtonPressed=true}else{if(Z.type==="mouseup"){this._leftButtonPressed=false}}}if((Z.type==="mousedown")&&(Z.button===0)){var ag={clientX:Z.clientX,clientY:Z.clientY,identifier:1,target:Z.target};this.fingers=[];this.fingers.push(ag);ah.touches.push(ag);ah.changedTouches.push(ag)}if((Z.type==="mouseup")&&(Z.button===0)){for(var ae=0;ae<this.fingers.length;ae++){ah.changedTouches.push(this.fingers[ae])}this.fingers=[]}if((Z.type==="keydown")&&this._shiftKeyPressed&&(this.fingers.length===1)){ah.touches.push(this.fingers[0]);var ag={clientX:this.fingers[0].clientX+this.fingerDst.x,clientY:this.fingers[0].clientY+this.fingerDst.y,identifier:2,target:this.fingers[0].target};this.fingers.push(ag);ah.touches.push(ag);ah.changedTouches.push(ag)}else{if(Z.type==="keydown"){return}else{if((Z.type==="keyup")&&!this._shiftKeyPressed&&(this.fingers.length===2)){ah.changedTouches.push(this.fingers[1]);this.fingers.pop()}}}if((af==="move")&&this._leftButtonPressed){var ag={clientX:Z.clientX,clientY:Z.clientY,identifier:1,target:this.fingers[0].target};if(this._staticKeyPressed){if(this.fingers[1]){this.fingerDst.set(this.fingers[1].clientX-ag.clientX,this.fingers[1].clientY-ag.clientY)}this.fingers[0]=ag}else{this.fingers[0]=ag;for(var ae=1;ae<this.fingers.length;ae++){this.fingers[ae].clientX=ag.clientX+this.fingerDst.x;this.fingers[ae].clientY=ag.clientY+this.fingerDst.y}}for(var ae=0;ae<this.fingers.length;ae++){ah.touches.push(this.fingers[ae]);ah.changedTouches.push(this.fingers[ae])}}var Y=this.fingers.length;var ac=this.fingerDivs.length;for(var ae=0;ae<Math.max(ac,Y);ae++){var ad=this.fingers[ae];var ab=this.fingerDivs[ae];if(ae<Y){if(ab){ab.style.display="block"}else{var X="position:absolute; z-index:9999; left:0; top:0; width:14px; height:14px; border:solid 2px #777;background:rgba(255,255,255,.7); border-radius:20px; pointer-events:none;margin-top:-9px; margin-left:-9px;";ab=document.createElement("div");ab.setAttribute("style",X);document.body.appendChild(ab);this.fingerDivs[ae]=ab}ab.style.left=ad.clientX+"px";ab.style.top=ad.clientY+"px"}else{ab.style.display="none"}}if(ah.touches.length||ah.changedTouches.length){var W="_touch";W+=af.charAt(0).toUpperCase();W+=af.substr(1);this[W](ah)}},disconnectFrom:function(Y){for(var X=this._gestureRecognizers.length-1;X>=0;--X){var W=this._gestureRecognizers[X];if(W){W.removeView(Y)}}},_registerRecordView:function(X){if(!X){return}var W=X._viewRecordId;if(W===undefined){W=X.nodeName+(this._maxViewIndex++);X._viewRecordId=W;this._recordViewTable[W]=X}},_getViewFromRecordId:function(W){return this._recordViewTable[W]},_record_registerObject:function(W,Y,Z){var X=W._recordRegisterName;if(!X){X=Y+"_"+(W.uniqueName||W.id);W._recordRegisterName=X;console.log("_record_registerObject: '"+X+"'");this._registeredObjects.push({name:X,object:W,elements:Z||[]})}if(Y==="WebGLV6Viewer"){console.log("this._viewerList.push(viewer#"+W.id+");");this._viewerList.push(W)}return X}});x.EVENTS_MAP={touchstart:"pointerdown",mousedown:"pointerdown",touchend:"pointerup",mouseup:"pointerup",touchmove:"pointermove",mousemove:"pointermove"};x.GESTURES_MAP={onLeftClick:{gestureName:p,params:[d.MouseButton.LEFT]},onMiddleClick:{gestureName:p,params:[d.MouseButton.MIDDLE]},onRightClick:{gestureName:p,params:[d.MouseButton.RIGHT]},onHold:{gestureName:R,params:[]},onHoldLeftMouseDown:{gestureName:f,params:[d.MouseButton.LEFT]},onHoldMiddleMouseDown:{gestureName:f,params:[d.MouseButton.MIDDLE]},onHoldRightMouseDown:{gestureName:f,params:[d.MouseButton.RIGHT]},onEdit:{gestureName:r,params:[]},onLongEdit:{gestureName:u,params:[]},onSmartEdit:{gestureName:P,params:[]},onKeyDown:{gestureName:s,params:[]},onKeyUp:{gestureName:q,params:[]},onLongHold:{gestureName:V,params:[]},onLeftMouseDown:{gestureName:Q,params:[d.MouseButton.LEFT]},onMiddleMouseDown:{gestureName:Q,params:[d.MouseButton.MIDDLE]},onRightMouseDown:{gestureName:Q,params:[d.MouseButton.RIGHT]},onMouseMove:{gestureName:I,params:[]},onMouseOut:{gestureName:g,params:[]},onLeftMouseUp:{gestureName:L,params:[d.MouseButton.LEFT]},onMiddleMouseUp:{gestureName:L,params:[d.MouseButton.MIDDLE]},onRightMouseUp:{gestureName:L,params:[d.MouseButton.RIGHT]},onMouseWheel:{gestureName:S,params:[]},onPan:{gestureName:m,params:[]},onPinch:{gestureName:H,params:[]},onPinchPanRotate:{gestureName:C,params:[]},onSpread:{gestureName:e,params:[]},onPinchTap:{gestureName:w,params:[]},onRelease:{gestureName:z,params:[]},onRotate:{gestureName:c,params:[]},onSwipe:{gestureName:J,params:[]},onDrag:{gestureName:t,params:[]},onTap:{gestureName:k,params:[]},onTouch:{gestureName:U,params:[]},onPrimaryPointerDownUnique:{gestureName:T,params:[]},onPrimaryPointerMoveUnique:{gestureName:O,params:[]},onPrimaryPointerUpUnique:{gestureName:D,params:[]},onPrimaryPointerClick:{gestureName:l,params:[]},onPrimaryPointerDoubleClick:{gestureName:E,params:[],require:"onPrimaryPointerClick"},onLeftDoubleClick:{gestureName:v,params:[d.MouseButton.LEFT],require:"onLeftClick"},onMiddleDoubleClick:{gestureName:v,params:[d.MouseButton.MIDDLE],require:"onMiddleClick"},onRightDoubleClick:{gestureName:v,params:[d.MouseButton.RIGHT],require:"onRightClick"},onDoublePinchTap:{gestureName:o,params:[],require:"onPinchTap"},onDoubleTap:{gestureName:G,params:[],require:"onTap"},onMediumHold:{gestureName:n,params:[]}};if(window.DSWebRecord){x._registeredObjects=[];x._viewerList=[];B.TraceManager.setLevel(5);if(window.DSWebRecord.env.ADL_ODT_ViewerWait){var h=B.WaitManager.addWaitCondition(1000*1000,"Waiting for start");window.goRoger=function(){B.WaitManager.removeWaitCondition(h)}}var a=document.createElement("div");a.myName="customDiv";a.style.position="absolute";a.style.left="-100px";a.style.top="-100px";a.style.width="1px";a.style.height="1px";a.setAttribute("data-rec-id","WebGLV6ViewerEventsManager");document.body.appendChild(a);B.registerComparator("DS/WebVisuRecord/SceneGraphDumpWebVisuComparator");B.private_WebVisuRecordTarget=a;B.registerElement(a,"DS/WebVisuRecord/WebGLV6ViewerRec",true,function(){x._recordReplayReady=true;console.log("Adapter.registerElement CB!!")});setTimeout(function(){x._recordReplayReady=true},2000)}return UWA.namespace("THREEDS/VisuEventsManager",x)});define("VisuEvents/EventsManager",["DS/VisuEvents/EventsManager","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuEvents/EventsManager");return b});define("DS/Visualization/TrapSelection",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent"],function(f,d,a,g,h,b,e){var c=function(k){this.extremities={xPix:0,x:0,yPix:0,y:0};this.originPoint=null;this.isActive=false;this.isInterrupted=false;this.advancedSelection=false;this.createCallbacks();if(k){this.viewer=k}if(this.viewer&&this.viewer.divTrap){this.setDiv(this.viewer.divTrap)}var j=this.viewer.currentViewpoint?this.viewer.currentViewpoint.getControl():null;this.mode=j?j._mode:1;this.downEvent=(this.mode===0?"onLeftMouseDown":"onHoldLeftMouseDown")};c.prototype.set=function(j){switch(j){case true:this.activate(false);break;case"advanced":this.activate(true);break;case false:this.disable();break}};c.prototype.updateMode=function(k,l){var j=this.viewer.picking.trapSelection;k.setSpinnerOnHold(this.mode!==0&&j?true:false);if(l!==this.mode){this.mode=l;h.removeEvent(this.viewer.canvas,this.downEvent,this.downCB);this.downEvent=(this.mode===0?"onLeftMouseDown":"onHoldLeftMouseDown");if(j){h.addEvent(this.viewer.canvas,this.downEvent,this.downCB)}}};c.prototype.setDiv=function(j){this.divTrap=j;this.divTrap.setStyles({position:"absolute",opacity:"0.8",pointerEvents:"none",border:"1px dashed black"});this.divTrap.hide()};c.prototype.activate=function(j){this.downEvent=(this.mode===0?"onLeftMouseDown":"onHoldLeftMouseDown");this.forwardSelect=null;this.advancedSelection=j;if(!this.divTrap&&this.viewer&&this.viewer.divTrap){this.setDiv(this.viewer.divTrap)}h.addEvent(this.viewer.canvas,this.downEvent,this.downCB);h.addEvent(this.viewer.canvas,"onHold",this.downCB);h.addEvent(this.viewer.canvas,"onLongHold",this.interrupt)};c.prototype.disable=function(){h.removeEvent(this.viewer.canvas,this.downEvent,this.downCB);h.removeEvent(this.viewer.canvas,"onHold",this.downCB);h.removeEvent(this.viewer.canvas,"onLongHold",this.interrupt)};c.prototype.getExtremities=function(){return this.extremities};c.prototype.setExtremities=function(o,n){if(!n){this.extremities=o;return}var l={};var k={};var j=true;if(o.xPix<n.xPix){j=true;l.xPix=o.xPix;l.x=o.x;k.xPix=n.xPix;k.x=n.x}else{j=false;l.xPix=n.xPix;l.x=n.x;k.xPix=o.xPix;k.x=o.x}if(o.yPix<n.yPix){l.yPix=o.yPix;l.y=o.y;k.yPix=n.yPix;k.y=n.y}else{l.yPix=n.yPix;l.y=n.y;k.yPix=o.yPix;k.y=o.y}this.extremities=l;this.extremities.pt=k;if(this.advancedSelection&&this.divTrap&&this.forwardSelect!==j){var m;if(j){m={border:"2px solid #f5c77e",backgroundColor:"rgba(245, 200, 125, 0.5)"}}else{m={border:"2px dashed #75cdf0",backgroundColor:"rgba(117, 205, 240, 0.5)"}}this.divTrap.setStyles(m);this.forwardSelect=j}};c.prototype.createCallbacks=function(){var j=this;this.interrupt=function(){j.softInterrupt();j.viewer.setCursor("Auto")};this.softInterrupt=function(){j.isActive=false;j.isInterrupted=true;h.removeEvent(document,"onMouseMove",j.moveCB);h.removeEvent(document,"onLeftMouseUp",j.upCB);h.removeEvent(document,"onSwipe",j.moveCB);h.removeEvent(document,"onRelease",j.upCB);j.setExtremities({x:-1,y:-1})};this.downCB=function(k){j.originPoint=j.viewer.getMousePosition(k.from[0].getCurrentPosition(j.viewer.canvas));j.setExtremities(j.originPoint);j.startTime=Date.now();j.isActive=true;if(!j.isInterrupted){j.viewer.setCursor("TrapSelection",100);h.addEvent(document,"onMouseMove",j.moveCB);h.addEvent(document,"onLeftMouseUp",j.upCB);h.addEvent(document,"onSwipe",j.moveCB);h.addEvent(document,"onRelease",j.upCB)}j.isInterrupted=false};this.moveCB=function(k){var l=j.viewer.getMousePosition(k.from[0].getCurrentPosition(j.viewer.canvas));j.setExtremities(j.originPoint,l);if(j.divTrap){j.divTrap.show();j.divTrap.setStyles({width:(j.extremities.pt.xPix-j.extremities.xPix)/(window.devicePixelRatio||1),height:(j.extremities.pt.yPix-j.extremities.yPix)/(window.devicePixelRatio||1),left:j.extremities.xPix/(window.devicePixelRatio||1),top:j.extremities.yPix/(window.devicePixelRatio||1),pointerEvents:"none"})}};this.upCB=function(k){if(j.divTrap){j.divTrap.hide();j.divTrap.setStyles({width:"0px",height:"0px",left:"0px",top:"0px",pointerEvents:"none"})}j.interrupt();j.isInterrupted=false}};return c});define("DS/Visualization/TrackballControls",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Animation/ANIM","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent","DS/WebRecordEnabler/Adapter"],function(f,n,g,d,k,e,c,h,m,a,l){var b=0;var j=function(o,p){if(h._isInit===undefined){h.init()}this.manipulatedViewList=[p];n.EventTarget.call(this);this.viewpoint=o;this.viewer=o.viewer;this.domElement=(p!==undefined)?p:document;this.isMac=navigator.platform.toUpperCase().indexOf("MAC")>=0;this.camera=o.camera;this.id=b++;if(window.DSWebRecord){h._record_registerObject(this,"TrackballControls")}this.radius=0.5*Math.max(this.domElement.clientWidth,this.domElement.clientHeight);this.radiusZoom=0.25*(this.domElement.clientWidth+this.domElement.clientHeight);this.panSpeed=1;this.rotateSpeed=1;this.zoomSpeed=5;this.lockZ=false;this.lockRotation=false;this.lockMouseRotation=false;this.lockTouchRotation=false;this.lockZoom=false;this.lockPan=false;this.lockMouse=false;this.lockReframeOnDblTap=false;this.mouseInertia=false;this.touchInertia=true;this.rotateDirection=1;this.lastLockZState=null;this.lockZRotationSpeed=0.002;this.target=o.target;this.position=o.position;this.orientation=new n.Quaternion();this.distanceToTarget=700;this._state=j.State.NONE;this._clickTimer=null;this._leftClicking=false;this._middleClicking=false;this._rightClicking=false;this._leftButtonPressed=false;this._middleButtonPressed=false;this._rightButtonPressed=false;this._ctrlKeyPressed=false;this._shiftKeyPressed=false;this._clickTolerancy=10;this._blockVptOnHold=true;this._showSpinnerOnHold=false;this._pickingCB=true;this._forcePan=false;this._forceRotate=false;this._forceZoom=false;this._forcePanCmd=null;this._forceRotateCmd=null;this._forceZoomCmd=null;this._2DMode=false;this.oldManipActive=false;this._mode=j.Mode.COMBINED;this._zoomType=j.ZoomType.ZOOM_POS_CHANGE;var q=this;this._onWindowResize=function(r){q._resize(r)};this._onContextMenu=function(r){r.preventDefault()};this._onBlurCB=function(){q._ctrlKeyPressed=false;q._shiftKeyPressed=false};this.basicEventID=0;this.editEventBeginID=0;this.editEventKOID=0;this.infiniteRender=false;this._mouseDownPos=null;this._oldCursor="";this._modelEvent=new c();this.attachEvents();this.setMode(j.Mode.COMBINED);this._createShortHoldSpinner(1,"#3da4e0");this._customZoomTokens=[];this._customPanTokens=[];this._customRotateTokens=[];this.needsRotationFinalized=false;this._isIE11=((new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent)!=null));this._isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1};j.Mode={CATIA:0,SIMPLE:1,COMBINED:2};j.State={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,FORCE_ROTATE:3,FORCE_ZOOM:4,FORCE_PAN:5,HOLD:6,ZOOM_PAN_ROTATE:7,STOP:8};j.changeEvent={type:"change"};j.prototype.setActive=function(o){if(o instanceof Object){if(o.viewpoint!==undefined){this._changeState(o.viewpoint?j.State.NONE:j.State.STOP)}if(o.picking!==undefined){this._pickingCB=o.picking}}else{this._changeState(o?j.State.NONE:j.State.STOP)}};j.prototype.setMouseActive=function(o){this.lockMouse=!o};j.prototype.setRotationActive=function(o){this.lockRotation=!o};j.prototype.setMouseRotationActive=function(o){this.lockMouseRotation=!o};j.prototype.setTouchRotationActive=function(o){this.lockTouchRotation=!o};j.prototype.getMouseRotationActive=function(){return this.lockMouseRotation};j.prototype.getTouchRotationActive=function(){return this.lockTouchRotation};j.prototype.setZoomActive=function(o){this.lockZoom=!o};j.prototype.setPanActive=function(o){this.lockPan=!o};j.prototype.setReframeOnDoubleTap=function(o){this.lockReframeOnDblTap=!o};j.prototype.setRotationRolling=function(o){this.lockZ=!o};j.prototype.setRotationInertia=function(o){if(o.mouse!==undefined){this.mouseInertia=o.mouse}if(o.touch!==undefined){this.touchInertia=o.touch}};j.prototype.setRotationSpeed=function(o){this.rotateSpeed=o;this.lockZRotationSpeed=o*0.0015};j.ZoomType={ZOOM_POS_CHANGE:0,ZOOM_FOV_CHANGE:1};j.prototype.setZoomType=function(o){this._zoomType=o};j.prototype.onPan=function(q){if(q){var p=this._modelEvent.subscribe({event:"Pan"},q);this._customPanTokens.push(p);return p}else{for(var o=0;o<this._customPanTokens.length;o++){this._modelEvent.unsubscribe(this._customPanTokens[o])}this._customPanTokens=[]}};j.prototype.onRotate=function(q){if(q){var p=this._modelEvent.subscribe({event:"Rotate"},q);this._customRotateTokens.push(p);return p}else{for(var o=0;o<this._customRotateTokens.length;o++){this._modelEvent.unsubscribe(this._customRotateTokens[o])}this._customRotateTokens=[]}};j.prototype.onZoom=function(q){if(q){var p=this._modelEvent.subscribe({event:"Zoom"},q);this._customZoomTokens.push(p);return p}else{for(var o=0;o<this._customZoomTokens.length;o++){this._modelEvent.unsubscribe(this._customZoomTokens[o])}this._customZoomTokens=[]}};j.prototype.blockViewpointOnHold=function(o){this._blockVptOnHold=o};j.prototype.setSpinnerOnHold=function(o){this._showSpinnerOnHold=o};j.prototype.isCurrentViewpoint=function(){var o=this.viewpoint.viewer.currentViewpoint;if(o){return(o===this.viewpoint)}return false};j.prototype.isLeftButtonPressed=function(){return this._leftButtonPressed};j.prototype.isMiddleButtonPressed=function(){return this._middleButtonPressed};j.prototype.isRightButtonPressed=function(){return this._rightButtonPressed};j.prototype.isCtrlKeyPressed=function(){return this._ctrlKeyPressed};j.prototype.isShiftKeyPressed=function(){return this._shiftKeyPressed};j.prototype.isLeftClick=function(){return this._leftClicking};j.prototype.isMiddleClick=function(){return this._middleClicking};j.prototype.isRightClick=function(){return this._rightClicking};j.prototype.startLeftClick=function(){var o=this;this._leftClicking=true;if(this._clickTimer){clearTimeout(this._clickTimer)}if(!l.isReplaying()){this._clickTimer=setTimeout(function(){if(h.RecordEventsManager){h.RecordEventsManager.recordSpecialEvent(o.viewer,"TrackballControls","TrackballControlCancelLeftClick")}o.cancelLeftClick()},300)}};j.prototype.cancelLeftClick=function(){this._leftClicking=false};j.prototype.cancelMiddleClick=function(){this._middleClicking=false};j.prototype.cancelRightClick=function(){this._rightClicking=false};j.prototype.resetLeftClick=function(){this._leftClicking=false;if(this._clickTimer){clearTimeout(this._clickTimer)}this._clickTimer=null};j.prototype.getManipulationState=function(){return this._state};j.prototype.isMoving=function(){if(this._state===j.State.NONE||this._state===j.State.STOP||this._state===j.State.HOLD){return false}if(this._targetAnim&&!this._targetAnim.isRunning()){return false}return true};j.prototype.setMode=function(o){if((o===undefined)||(o===this._mode)){return}this._mode=o;var p=h._getGesture(document,"onEdit");p&&p.setTimerMouse((this._mode>0)?h.getHoldTime():0);if(this.viewer.trapSelection){this.viewer.trapSelection.updateMode(this,this._mode)}};j.prototype.setDebugEvents=function(o){h.setDebugEvents(o)};j.prototype.attachEvents=function(){this.initGestureCB();this.domElement.addEventListener("contextmenu",this._onContextMenu,false);window.addEventListener("blur",this._onBlurCB)};j.prototype.detachEvents=function(){this.resetGestureCB();this.domElement.removeEventListener("contextmenu",this._onContextMenu,false);window.removeEventListener("blur",this._onBlurCB)};j.prototype._setCapture=function(){var o=this.viewer?this.viewer.canvas:null;if(!o){return}if(o.setCapture&&((this._isIE11||(this._isFirefox&&!o.draggable))&&!(o.tagName&&(o.tagName.toLowerCase()==="input")))){o.setCapture(false)}};j.prototype._releaseCapture=function(){if((this._isIE11||this._isFirefox)&&document.releaseCapture){document.releaseCapture()}};j.prototype.initGestureCB=function(){if(this.gestureCBReady){return}var o=this;this._onLeftMouseDownCB=function(q){o._onLeftMouseDown.call(o,q)};this._onMiddleMouseDownCB=function(q){o._onMiddleMouseDown.call(o,q)};this._onRightMouseDownCB=function(q){o._onRightMouseDown.call(o,q)};this._onLeftMouseUpCB=function(q){o._onLeftMouseUp.call(o,q)};this._onMiddleMouseUpCB=function(q){o._onMiddleMouseUp.call(o,q)};this._onRightMouseUpCB=function(q){o._onRightMouseUp.call(o,q)};this._onMouseMoveCB=function(q){o._onMouseMove.call(o,q)};this._onMouseOutCB=function(q){o._onMouseOut.call(o,q)};this._onSwipeCB=function(q){o._onSwipe.call(o,q)};this._onTapCB=function(q){o._onTap.call(o,q)};this._onPinchPanRotateCB=function(q){o._onPinchPanRotate.call(o,q)};this._onDoubleTapCB=function(q){o._onDoubleTap.call(o,q)};this._onDoublePinchTapCB=function(q){o._onDoublePinchTap.call(o,q)};this._onHoldCB=function(q){o._onHold.call(o,q)};this._onTouchCB=function(q){o._onTouch.call(o,q)};this._onReleaseCB=function(q){o._onRelease.call(o,q)};this._onEditCB=function(q){o._onStopManip.call(o,q)};h.addEvent(document,"onLeftMouseDown",this._onLeftMouseDownCB);h.addEvent(document,"onRightMouseDown",this._onRightMouseDownCB);h.addEvent(document,"onLeftMouseUp",this._onLeftMouseUpCB);h.addEvent(document,"onMiddleMouseUp",this._onMiddleMouseUpCB);h.addEvent(document,"onRightMouseUp",this._onRightMouseUpCB);h.addEvent(document,"onMouseMove",this._onMouseMoveCB);h.addEvent(document,"onMouseOut",this._onMouseOutCB);h.addEvent(this.domElement,"onDoubleTap",this._onDoubleTapCB);h.addEvent(this.domElement,"onDoublePinchTap",this._onDoublePinchTapCB);h.addEvent(this.domElement,"onHold",this._onHoldCB);h.addEvent(document,"onRelease",this._onReleaseCB);h.addEvent(document,"onEdit",this._onEditCB);var p=h._getGesture(document,"onEdit");p&&p.setTimerMouse((this._mode>0)?h.getHoldTime():0);this.addViewToGestures(this.domElement);if(this.viewer&&this.viewer.divCssElement){this.addViewToManipulation(this.viewer.divCssElement)}this.basicEventID=e.subscribe({event:"/VISU/onBasicEvent"},function(q){o._onBasicEvent.call(o,q)});this.editEventBeginID=e.subscribe({event:"/VISU/onEditEventBegin"},function(q){if(o._showSpinnerOnHold){o._onEditEventBegin.call(o,q)}});this.editEventKOID=e.subscribe({event:"/VISU/onEditEventKO"},function(q){o._onEditEventKO.call(o,q)});this.gestureCBReady=true};j.prototype.resetGestureCB=function(){if(!this.gestureCBReady){return}var q=this;h.removeEvent(document,"onLeftMouseDown",this._onLeftMouseDownCB);h.removeEvent(document,"onRightMouseDown",this._onRightMouseDownCB);h.removeEvent(document,"onLeftMouseUp",this._onLeftMouseUpCB);h.removeEvent(document,"onMiddleMouseUp",this._onMiddleMouseUpCB);h.removeEvent(document,"onRightMouseUp",this._onRightMouseUpCB);h.removeEvent(document,"onMouseMove",this._onMouseMoveCB);h.removeEvent(document,"onMouseOut",this._onMouseOutCB);h.removeEvent(this.domElement,"onDoubleTap",this._onDoubleTapCB);h.removeEvent(this.domElement,"onDoublePinchTap",this._onDoublePinchTapCB);h.removeEvent(this.domElement,"onHold",this._onHoldCB);h.removeEvent(document,"onRelease",this._onReleaseCB);h.removeEvent(document,"onEdit",this._onEditCB);for(var p=0;p<this.manipulatedViewList.length;p++){var o=this.manipulatedViewList[p];this.removeViewFromGestures(o)}e.unsubscribe(this.basicEventID);e.unsubscribe(this.editEventBeginID);e.unsubscribe(this.editEventKOID);this.gestureCBReady=false};j.prototype.addViewToGestures=function(o){h.addEvent(o,"onMiddleMouseDown",this._onMiddleMouseDownCB);h.addEvent(o,"onTouch",this._onTouchCB);h.addEvent(o,"onSwipe",this._onSwipeCB);h.addEvent(o,"onPinchPanRotate",this._onPinchPanRotateCB);h.addEvent(o,"onTap",this._onTapCB)};j.prototype.removeViewFromGestures=function(o){h.removeEvent(o,"onMiddleMouseDown",this._onMiddleMouseDownCB);h.removeEvent(o,"onTouch",this._onTouchCB);h.removeEvent(o,"onSwipe",this._onSwipeCB);h.removeEvent(o,"onPinchPanRotate",this._onPinchPanRotateCB);h.removeEvent(o,"onTap",this._onTapCB)};j.prototype.addViewToManipulation=function(o){var p=this.manipulatedViewList.indexOf(o);if(p!==-1){return false}this.manipulatedViewList.push(o);this.addViewToGestures(o);return true};j.prototype.removeViewFromManipulation=function(o){var p=this.manipulatedViewList.indexOf(o);if(p===-1){return false}this.manipulatedViewList.splice(p,1);this.removeViewFromGestures(o);return true};j.prototype.setTarget=function(o){this.target.copy(o)};j.prototype.onMove=function(o){return this._modelEvent.subscribe({event:"ViewpointMove"},o)};j.prototype.unsubscribe=function(p){var o=this._customZoomTokens.indexOf(p);if(o!==-1){this._customZoomTokens.splice(o,1)}else{o=this._customPanTokens.indexOf(p);if(o!==-1){this._customPanTokens.splice(o,1)}else{o=this._customRotateTokens.indexOf(p);if(o!==-1){this._customRotateTokens.splice(o,1)}}}this._modelEvent.unsubscribe(p)},j.prototype.update=function(){var p=this.camera.position.clone(),o=this.camera.quaternion.clone(),s=new n.Vector3(0,0,1),q=false;this.camera.useQuaternion=true;s.applyQuaternion(this.orientation);s.setLength(this.distanceToTarget);this.camera.position.addVectors(this.target,s);if(this.camera.isOrtho){this.camera.setVisualizedHeight(this.distanceToTarget);this.camera.updateProjectionMatrix()}this.camera.quaternion.copy(this.orientation);this.camera.up=new n.Vector3(0,1,0);this.camera.up.applyQuaternion(this.orientation);p.sub(this.camera.position);o.sub(this.camera.quaternion);this.position.copy(this.camera.position);this.camera.updateMatrix();this.camera.matrixWorld.copy(this.camera.matrix);this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld);this.camera.updateProjectionMatrix();if(this.infiniteRender||(p.lengthSq()>1e-7)||(o.lengthSq()>1e-7||this.camera._hasChanged)){q=true;this.dispatchEvent(j.changeEvent);this.viewpoint._updateFrustum();this._modelEvent.publish({event:"ViewpointMove",context:this});if(this._2DMode&&this.viewer.svgRoot){this.viewer._updateSVGVisu()}if(this.viewer){this.viewer.renderIteration=0}}this.camera._hasChanged=false;var r={eventChannel:q?"/VISU/":"/VISU/SpriteNodeInit",eventType:"@onViewpointChange",viewpoint:this.viewpoint,cameraEye:this.position,cameraTarget:this.target,cameraUp:this.camera.up};e.publish({event:q?"/VISU/":"/VISU/SpriteNodeInit",data:r});return q};j.prototype.moveTo=function(y){console.log("TrackballControls.prototype.moveTo is DEPRECATED: use Viewpoint.moveTo instead.");var r={position:y.position,target:y.target||this.target.clone(),orientation:y.orientation||this.orientation.clone(),distanceToTarget:y.distanceToTarget||this.distanceToTarget,duration:y.duration||0};if(y instanceof n.Vector3){console.warn("TrackballControls.prototype.moveTo now uses options litteral object as argument.");r.target=arguments[0];if(arguments[1]){r.orientation=arguments[1]}if(arguments[2]!==undefined){r.distanceToTarget=arguments[2]}if(arguments[3]!==undefined){r.duration=arguments[3]}}var q,u,o;if(this._targetAnim){this._targetAnim.stop()}if(this._orientationAnim){this._orientationAnim.stop()}if(this._distanceToTargetAnim){this._distanceToTargetAnim.stop()}if(r.position&&y.target){var p=new n.Vector3().subVectors(y.target,r.position);r.distanceToTarget=p.length();if(!y.orientation){var t=new n.Matrix4().lookAt(r.position,y.target,new n.Vector3(0,0,1));r.orientation.setFromRotationMatrix(t)}}else{if(r.position){var s=new n.Vector3(0,0,1);s.applyQuaternion(r.orientation);s.setLength(r.distanceToTarget);var x=new n.Vector3().subVectors(r.position,s);r.target=x}}if(r.duration===0){this.setTarget(r.target);this.orientation=r.orientation;this.distanceToTarget=r.distanceToTarget;this.update()}else{q=new d(this.target.clone(),r.target,r.duration);q.setInterpolator(function(z,A,C){var B=A.clone();B.lerp(C,z);return B});var w=this;var v=function(A){if(A===g.State.STOPPED){var z={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:w.viewpoint,cameraEye:w.camera.position,cameraUp:w.camera.up};e.publish({event:"/VISU/",data:z})}};this._targetAnim=new k(this,"setTarget",q,v);u=new d(this.orientation,r.orientation,r.duration);u.setInterpolator(function(z,A,C){var B=new n.Quaternion();n.Quaternion.slerp(A,C,B,z);return B});this._orientationAnim=new k(this,"orientation",u);o=new d(this.distanceToTarget,r.distanceToTarget,r.duration);this._distanceToTargetAnim=new k(this,"distanceToTarget",o);this._targetAnim.start();this._orientationAnim.start();this._distanceToTargetAnim.start()}};j.prototype.handleEvent=function(o){if(typeof this[o.type]=="function"){this[o.type](o)}};j.prototype.startPan=function(o){this.endRotate();this.endZoom();this._forcePan=true;if(o){this._forcePanCmd=o}if(this.viewer){this.oldManipActive=this.viewer.getManipulators();this.viewer.setManipulators({activated:false});this.viewer.setCursor("Pan",0)}};j.prototype.startRotate=function(o){this.endPan();this.endZoom();this._forceRotate=true;if(o){this._forceRotateCmd=o}if(this.viewer){this.oldManipActive=this.viewer.getManipulators();this.viewer.setManipulators({activated:false});this.viewer.setCursor("Rotate",0)}};j.prototype.startZoom=function(o){this.endPan();this.endRotate();this._forceZoom=true;if(o){this._forceZoomCmd=o}if(this.viewer){this.oldManipActive=this.viewer.getManipulators();this.viewer.setManipulators({activated:false});this.viewer.setCursor("Zoom",0)}};j.prototype.endPan=function(o){this._forcePan&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive});this._forcePan=false;if(this._forcePanCmd){this._forcePanCmd.end(true);this.viewer.setCursor("Auto",0);this._changeState(j.State.NONE);if(this.viewer.trapSelection){this.viewer.trapSelection.isInterrupted=false}}};j.prototype.endRotate=function(o){this._forceRotate&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive});this._forceRotate=false;if(this._forceRotateCmd){this._forceRotateCmd.end(true);this.viewer.setCursor("Auto",0);this._changeState(j.State.NONE);if(this.viewer.trapSelection){this.viewer.trapSelection.isInterrupted=false}}};j.prototype.endZoom=function(o){this._forceZoom&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive});this._forceZoom=false;if(this._forceZoomCmd){this._forceZoomCmd.end(true);this.viewer.setCursor("Auto",0);this._changeState(j.State.NONE);if(this.viewer.trapSelection){this.viewer.trapSelection.isInterrupted=false}}};j.prototype._getMouseProjectionOnBall=function(q){var s,r,p,o;s=new n.Vector3((q.x-this.domElement.clientWidth*0.5)/this.radius,(this.domElement.clientHeight*0.5-q.y)/this.radius,0);r=s.length();if(r>1){s.normalize()}else{s.z=Math.sqrt(1-r*r)}p=(new n.Vector3()).subVectors(this.camera.position,this.target);o=new n.Vector3();o.add(this.camera.up.clone().cross(p).setLength(s.x));o.add(this.camera.up.clone().setLength(s.y));o.add(p.clone().setLength(s.z));return o};j.prototype._pan=function(o,p){this.update();this._doPan(o.x-p.x,o.y-p.y)};j.prototype._doPan=function(q,p){var o,s,r;if((q===0)&&(p===0)){return}o=new n.Vector3().copy(this.camera.position).sub(this.target);if(this.camera.isOrtho){s=(this.camera.top-this.camera.bottom)/this.viewer.div.clientHeight}else{s=2*this.distanceToTarget*Math.tan(0.5*this.camera.fov*Math.PI/180)/this.viewer.div.clientHeight}r=new n.Vector3();r.add(o.clone().cross(this.camera.up).setLength(s*q));r.add(this.camera.up.clone().setLength(s*p));this.target.add(r)};j.prototype._rotate=function(o,s){this.update();var u,r,t,q,p;u=this._getMouseProjectionOnBall(s);r=this._getMouseProjectionOnBall(o);t=Math.acos(u.dot(r)/(u.length()*r.length()));if(t){q=(new n.Vector3()).crossVectors(u,r).normalize();t*=this.rotateSpeed;p=(new n.Quaternion()).setFromAxisAngle(q,-t);this.orientation.multiplyQuaternions(p,this.orientation.clone())}};j.prototype._rotateLockZ=function(p,o){this.update();this._stopRotation();if(this._state===j.State.ZOOM_PAN_ROTATE){if(!this.rotateDirection||this._state!==this.lastLockZState){var q=this.camera.getLookAt().z;q=+q;if(q===0||isNaN(q)){this.rotateDirection=q}else{this.rotateDirection=q>0?1:-1}}var r=this.orientation.toEuler();r.x-=o*this.lockZRotationSpeed;r.z+=this.rotateDirection*p*this.lockZRotationSpeed;r.y=0;this.orientation=(new n.Quaternion()).setFromEuler(r,"ZYX")}else{if(!this.rotateDirection||this._state!==this.lastLockZState){var q=this.camera.up.z;q=+q;if(q===0||isNaN(q)){this.rotateDirection=q}else{this.rotateDirection=q>0?1:-1}}var r=this.orientation.toEuler();r.x-=o*this.lockZRotationSpeed;r.z-=this.rotateDirection*p*this.lockZRotationSpeed;r.y=0;this.orientation=(new n.Quaternion()).setFromEuler(r,"ZYX")}this.lastLockZState=this._state;this.needsRotationFinalized=true};j.prototype._finalizeRotateLockZ=function(z,r){this._stopRotation();if(!this.needsRotationFinalized){return}if(this.lockRotation){return}if(r&&this.lockTouchRotation){return}if(!r&&this.lockMouseRotation){return}var A=z.currentTime-z.startTime;var q=0.01;var p=new n.Vector2();p.copy(z.offsetPosition);p.multiplyScalar(0.003/A);var v=p.length();if(v<1e-7){return}if(p.length()>q){p.setLength(q)}var y=new n.Quaternion().copy(this.orientation);var x=y.toEuler();var s=p.clone().normalize().multiplyScalar(0.000006);var o=p.length()/s.length();var u=new d(0,0,o);u.setInterpolator(function(E,F,H){var G=new n.Quaternion();E*=o;var I=x.clone();var C=I.x>=0?1:-1;var D=p.x*E-0.5*s.x*E*E;var B=p.y*E-0.5*s.y*E*E;I.x-=B;I.z-=C*D;I.y=0;G=(new n.Quaternion()).setFromEuler(I,"ZYX");return G});var t=function(B){this.me.orientation=B};var w={me:this,setOrientation:t};this._orientationAnim=new k(w,"setOrientation",u);this._orientationAnim.start();this.needsRotationFinalized=false};j.prototype._zoom=function(o,r){this.update();var p,q;p=o.y-r.y;p*=0.5/this.radiusZoom;q=1+p*this.zoomSpeed;if(q!==1&&q>0){if(this._zoomType===j.ZoomType.ZOOM_FOV_CHANGE){this._zoomFOVChange(new n.Vector2(Math.floor(this.viewer.SCREEN_WIDTH*0.5),Math.floor(this.viewer.SCREEN_HEIGHT*0.5)),q<1,q)}else{this.distanceToTarget*=q}}};j.prototype._zoomPanRotate=function(C,u){this.update();this._stopRotation();var t=C.getEvents();var x=t[0];var v=t[1];if(!this.lockZoom&&(!u||(u===1))){var D,A;D=C.distance-C.lastDistance;D*=0.5/this.radiusZoom;A=1-D*this.zoomSpeed;var B={gesture:C,factor:A,defaultBehavior:true};this._modelEvent.publish({event:"Zoom",data:B,context:this});if(B.defaultBehavior&&(A!==1&&A>0)){var s=new n.Vector2().addVectors(x.lastPosition,v.lastPosition).multiplyScalar(0.5);if(this._zoomType===j.ZoomType.ZOOM_FOV_CHANGE){this._zoomFOVChange(s,A<1,A)}else{this._zoomSimple(s,A<1,A)}}}if(!this.lockPan&&(!u||(u===2))){var E,r;var p=x.getCurrentPosition(this.domElement);var o=v.getCurrentPosition(this.domElement);var y=x.getLastPosition(this.domElement);var w=v.getLastPosition(this.domElement);E=0.5*(p.x+o.x)-0.5*(y.x+w.x);D=0.5*(p.y+o.y)-0.5*(y.y+w.y);var z={gesture:C,defaultBehavior:true};this._modelEvent.publish({event:"Pan",data:z,context:this});if(z.defaultBehavior){this._doPan(E,D)}}if(!this.lockRotation&&!this.lockTouchRotation&&(!u||(u===3))){var q={gesture:C,defaultBehavior:true};this._modelEvent.publish({event:"Rotate",data:q,context:this});if(q.defaultBehavior){this._rotateLockZ(-200*C.getDeltaAngle(),0)}}};j.prototype._zoomSimple=function(L,E,A){var p=new n.Projector();var w=this.viewer.getMousePosition(L);var B;if(A!==undefined){B=A}else{B=E?0.9:1.1}var w=this.viewer.getMousePosition(L);var y=this.camera.getLookAt();var H=this.camera.position;var z=this.target.clone().sub(y.clone().multiplyScalar(this.distanceToTarget*B));var s=new n.Vector3(w.x,w.y,0.5);var o=new n.Vector3(w.x,w.y,0.5);p.unprojectVector(s,this.camera);var I=null;if(this.camera instanceof n.OrthographicCamera){this.camera.setVisualizedHeight(this.distanceToTarget*B);p.unprojectVector(o,this.camera);I=s.sub(o)}else{var q,F;this.camera.matrixWorld.setPosition(z);p.unprojectVector(o,this.camera);this.camera.matrixWorld.setPosition(H);q=new n.Ray(H,s.clone().sub(H).normalize());F=new n.Ray(z,o.clone().sub(z).normalize());var v=this.viewpoint.getBoundingSphere();var r=q.at(this.camera.near/q.direction.clone().dot(y));var x=q.direction.clone().dot(v.center.clone().sub(r));var K=Math.max(0,x-v.radius);var J=Math.max(0,x+v.radius);var D=r.add(q.direction.clone().multiplyScalar((K+J)*0.5));var C=y.negate();var G=-C.clone().dot(D);var t=new n.Plane(C,G);var u=F.intersectPlane(t);I=D.clone().sub(u)}z.add(I);this.viewpoint.moveTo({eyePosition:z,distanceToTarget:this.distanceToTarget*B})};j.prototype._zoomFOVChange=function(I,A,T){var J=new n.Projector();var C=this.viewer.getMousePosition(I);var u;if(T!==undefined){u=T}else{u=A?0.9:1/0.9}var C=this.viewer.getMousePosition(I);var p=this.camera.getLookAt();var V=this.camera.position;var q=V.clone();var E=new n.Vector3(C.x,C.y,0.5);var U=new n.Vector3(C.x,C.y,0.5);J.unprojectVector(E,this.camera);var F=null;var M=this.viewpoint.getBoundingSphere();var S=this.viewpoint.getAngle()/2;var B=22.5;var X=p.clone().dot(M.center.clone().sub(V));var P=2*M.radius;if(X<P){var v=X-P;var O=p.clone().multiplyScalar(v);var t=Math.tan(n.Math.degToRad(this.viewpoint.getAngle()*0.5));var W=n.Math.radToDeg(Math.atan(t*(X+v)/X));if(W>B||W<0){W=B}else{V.add(O);q=V.clone()}S=W;this.viewpoint.setAngle(W*2);this.camera.updateProjectionMatrix();X=P}if(!A){var Q=1;if(S<B){var H=S*u;if(H>B){this.viewpoint.setAngle(B*2);Q=H/B}else{this.viewpoint.setAngle(H*2)}this.camera.updateProjectionMatrix()}else{Q=u}if(Q!=1){var R=Q*X;var O=p.clone().multiplyScalar(X-R);q.add(O)}}else{var H=S*u;var Z=u;if(X>P){var D=X-P;var Y=P/X;if(Y<u){D=X-(X*u);Z=1}else{var s=S*Y;Z=H/s}if(D>0){q.add(p.clone().multiplyScalar(D))}}if(Z!=1){this.viewpoint.setAngle(Z*S*2);this.camera.updateProjectionMatrix()}}var y,G,x;x=this.target.clone().sub(q).length();this.camera.matrixWorld.setPosition(q);J.unprojectVector(U,this.camera);this.camera.matrixWorld.setPosition(V);y=new n.Ray(V,E.clone().sub(V).normalize());G=new n.Ray(q,U.clone().sub(q).normalize());var r=y.at(this.camera.near/y.direction.clone().dot(p));var z=y.direction.clone().dot(M.center.clone().sub(r));var N=Math.max(0,z-M.radius);var w=Math.max(0,z+M.radius);var L=r.add(y.direction.clone().multiplyScalar((N+w)*0.5));var K=p.negate();var o=-K.clone().dot(L);var ac=new n.Plane(K,o);var ab=G.intersectPlane(ac);F=L.clone().sub(ab);q.add(F);this.viewpoint.setAngle(Math.min(this.viewpoint.getAngle(),45));if(this.camera instanceof n.OrthographicCamera){this.camera.setVisualizedHeight(x)}this.camera._hasChanged=true;this.viewpoint.moveTo({eyePosition:q,distanceToTarget:x})};j.prototype._mouseWheel=function(p){p.event.preventDefault();var q=UWA.Event.wheelDelta(p.getJSEvent());if(this.isMac){q*=-1}var o={evt:p,factor:q,defaultBehavior:true};this._modelEvent.publish({event:"Zoom",data:o,context:this});if(o.defaultBehavior){if(this._zoomType===j.ZoomType.ZOOM_FOV_CHANGE){!this.lockZoom&&this._zoomFOVChange(p.getCurrentPosition(this.domElement),q>0)}else{!this.lockZoom&&this._zoomSimple(p.getCurrentPosition(this.domElement),q>0)}}};j.prototype._resize=function(p,o){this.radius=0.5*Math.max(p,o);this.radiusZoom=0.25*(p+o)};j.prototype._stopRotation=function(o){if(this._orientationAnim){this._orientationAnim.stop()}};j.prototype._changeState=function(q){var o=this._state;if(this._state===j.State.NONE){this._oldCursor=this.viewer.getCursor()}this._state=q;switch(q){case j.State.ZOOM:case j.State.FORCE_ZOOM:!this.lockZoom&&this.viewer.setCursor("Zoom",100);break;case j.State.PAN:case j.State.FORCE_PAN:!this.lockPan&&this.viewer.setCursor("Pan",100);break;case j.State.ROTATE:case j.State.FORCE_ROTATE:!this.lockRotation&&this.viewer.setCursor("Rotate",100);break;case j.State.HOLD:break;default:this.viewer.setCursor(this._oldCursor,0,true);break}if(this.viewpoint){var r=(q!==j.State.NONE)&&(q!==j.State.HOLD)&&(q!==j.State.STOP);if(this.viewpoint._isMoving===r){return}this.viewpoint._isMoving=r;var p={eventChannel:"/VISU/",eventType:r?"@onViewpointBeginMove":"@onViewpointEndMove",viewpoint:this.viewpoint,cameraEye:this.viewpoint.camera.position,cameraUp:this.viewpoint.camera.up};e.publish({event:"/VISU/",data:p})}if(l.isRecording()&&this._state===j.State.NONE&&this._state!==o&&!this.isLeftClick()&&!this.isRightClick()){if(!window.WebVisuCurrentGesture.highLevelRecordJSON){window.WebVisuCurrentGesture.highLevelRecordJSON={}}window.WebVisuCurrentGesture.highLevelRecordJSON.TrackBallControls={name:this._recordRegisterName,setViewPoint:this.positionToJSON()}}};j.prototype._onBasicEvent=function(o){if(!o.from){return}for(var r=0;r<o.from.length;r++){var q=o.from[r];var v=q.getType();var t=q.getState();if(v==="Keyboard"){var p=q.getKey();if(t===m.State.BEGIN){if(p===m.KeyboardKey.CTRL){this._ctrlKeyPressed=true}if(p===m.KeyboardKey.SHIFT){this._shiftKeyPressed=true}if(this._mode>0){if(this._ctrlKeyPressed&&(this._state===j.State.ROTATE)){this._changeState(j.State.FORCE_PAN)}}}else{if(t===m.State.END){if(p===m.KeyboardKey.CTRL){this._ctrlKeyPressed=false}if(p===m.KeyboardKey.SHIFT){this._shiftKeyPressed=false}if(this._mode>0){if(!this._ctrlKeyPressed&&(this._state===j.State.PAN)){if(this.isCurrentViewpoint()){this._changeState(j.State.ROTATE)}}}}}if(h.RecordEventsManager){h.RecordEventsManager.recordSpecialEvent(this,"TrackballControls","UpdateControlKeys",{ctrl:this._ctrlKeyPressed,shift:this._shiftKeyPressed})}}else{if(v==="Mouse"){if(this.lockMouse){continue}var s=q.button;if(t===m.State.BEGIN){var u=false;if(((s===m.MouseButton.MIDDLE)||(s===m.MouseButton.WHEEL))&&q.isInView(this.manipulatedViewList)){u=true;if(q.getJSEvent().stopPropagation){q.getJSEvent().stopPropagation()}}if((s===m.MouseButton.WHEEL)&&(this._mode>0)&&q.isInView(this.manipulatedViewList)&&(this._state!==j.State.STOP)){this._mouseWheel(q)}if(u&&(s!==m.MouseButton.WHEEL||this._mode!==j.Mode.CATIA)){UWA.Event.preventDefault(q.getJSEvent())}}else{if(t===m.State.MOVE){if(q.offsetPosition.length()>this._clickTolerancy){if((s===m.MouseButton.LEFT)&&this._leftButtonPressed){if(this._leftClicking&&h.RecordEventsManager){h.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelLeftClick")}this.resetLeftClick()}if((s===m.MouseButton.MIDDLE)&&this._middleButtonPressed){if(this._middleClicking&&h.RecordEventsManager){h.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelMiddleClick")}this._middleClicking=false}if((s===m.MouseButton.RIGHT)&&this._rightButtonPressed){if(this._rightClicking&&h.RecordEventsManager){h.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelRightClick")}this._rightClicking=false}}}}}}}};j.prototype._onEditEventBegin=function(r){var s=(r.from&&r.from.length)?r.from[0]:null;if(s===null){return}var q=s instanceof a;if((this._mode>0)||q){var p=s.getCurrentPosition(this.domElement);var o=q?80:40;this._setPositionSpinner(this.ShortHoldSpinner,p,o);this._shortHoldCircleAnim=this._showSpinner(this.ShortHoldSpinner,this.SVGCircle,o,6)}};j.prototype._onEditEventKO=function(o){this._hideSpinner(this.ShortHoldSpinner,this._shortHoldCircleAnim)};j.prototype._onLeftMouseDown=function(o){if(this.handleRecordData(o)){return}if(this.lockMouse){return}var q=(o.from&&o.from.length)?o.from[0]:null;if(q===null){return}if(this._isIE11){var p=q.getJSEvent();if(p&&(p.ctrlKey!==undefined)){this._ctrlKeyPressed=p.ctrlKey}}var s=q.isInView(this.manipulatedViewList);if(s){this._setCapture()}this._publishWUXEvent("PrimaryPointerDown",o,false);this._leftButtonPressed=true;this.startLeftClick();if(!this.isCurrentViewpoint()){return}this._mouseDownPos=this.viewer.getMousePosition(q.getCurrentPosition(this.viewer.canvas));var t=this;var r=(this._forcePan||this._forceRotate||this._forceZoom);if((this._state===j.State.STOP)||(this._state===j.State.HOLD&&!r)){if(this._pickingCB&&this.viewer&&this.viewer.leftMouseDownCB){this.viewer.leftMouseDownCB(q,this)}return}if(s&&r&&(this._state===j.State.NONE||this._state===j.State.HOLD)){if(this._forcePan){this._changeState(j.State.FORCE_PAN)}else{if(this._forceRotate){this._changeState(j.State.FORCE_ROTATE)}else{if(this._forceZoom){this._changeState(j.State.FORCE_ZOOM)}}}}else{if(this._2DMode&&this._mode>0){this._changeState(j.State.PAN)}else{if(this._mode===j.Mode.SIMPLE){s&&this._changeState(j.State.ROTATE)}else{if((this._state===j.State.PAN)||(this._state===j.State.ZOOM)){this._changeState(j.State.ROTATE)}if(this._mode===j.Mode.CATIA&&this.viewer.trapSelection){this.viewer.trapSelection.interrupt()}(this._mode===j.Mode.COMBINED)&&s&&!this.lockRotation&&this._changeState(j.State.ROTATE)}}}if(this._pickingCB&&this.viewer&&this.viewer.leftMouseDownCB){this.viewer.leftMouseDownCB(q,this);if(this.viewer.trapSelection&&r){this.viewer.trapSelection.softInterrupt()}}this.tagEventIfModeNotNONE(o)};j.prototype._onMiddleMouseDown=function(o){if(this.handleRecordData(o)){return}if(this.lockMouse){return}var q=(o.from&&o.from.length)?o.from[0]:null;if(q===null){return}if(this._isIE11){var p=q.getJSEvent();if(p&&(p.ctrlKey!==undefined)){this._ctrlKeyPressed=p.ctrlKey}}var r=q.isInView(this.manipulatedViewList);if(r){this._setCapture()}this._middleButtonPressed=true;this._middleClicking=true;if(!this.isCurrentViewpoint()){return}if((this._state===j.State.STOP)||(this._state===j.State.HOLD)){if(this._pickingCB&&this.viewer&&this.viewer.centerMouseDownCB){this.viewer.centerMouseDownCB(q,this)}return}if(this._mode>0){this._changeState(j.State.PAN)}else{if(this._state===j.State.NONE){if(!this._leftButtonPressed&&!this._rightButtonPressed){this._changeState(j.State.PAN)}}}if(this._pickingCB&&this.viewer&&this.viewer.centerMouseDownCB){this.viewer.centerMouseDownCB(q,this)}this.tagEventIfModeNotNONE(o)};j.prototype._onRightMouseDown=function(o){if(this.handleRecordData(o)){return}if(this.lockMouse){return}var q=(o.from&&o.from.length)?o.from[0]:null;if(q===null){return}if(this._isIE11){var p=q.getJSEvent();if(p&&(p.ctrlKey!==undefined)){this._ctrlKeyPressed=p.ctrlKey}}var r=q.isInView(this.manipulatedViewList);if(r){this._setCapture()}this._rightClicking=true;this._rightButtonPressed=true;if(!this.isCurrentViewpoint()){return}if((this._state===j.State.STOP)||(this._state===j.State.HOLD)){return}if((this._mode>0)&&(this._state===j.State.NONE)){if(q.isInView(this.manipulatedViewList)){this._changeState(j.State.ZOOM)}}else{if((this._state===j.State.PAN)||(this._state===j.State.ZOOM)){this._changeState(j.State.ROTATE)}}this.tagEventIfModeNotNONE(o)};j.prototype._onLeftMouseUp=function(o){if(this.handleRecordData(o)){this._leftButtonPressed=false;this._mouseDownPos=null;return}if(this.lockMouse){return}var q=(o.from&&o.from.length)?o.from[0]:null;if(q===null){return}if(this._isIE11){var p=q.getJSEvent();if(p&&(p.ctrlKey!==undefined)){this._ctrlKeyPressed=p.ctrlKey}}this._releaseCapture();this._publishWUXEvent("PrimaryPointerUp",o,false);this._leftButtonPressed=false;if(!this.isCurrentViewpoint()){this.resetLeftClick();return}var r=this;if(this._state===j.State.STOP){if(this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB){this.viewer.leftMouseUpCB(q,this)}this.resetLeftClick();return}if(this._state===j.State.FORCE_PAN||this._state===j.State.FORCE_ROTATE||this._state===j.State.FORCE_ZOOM){this._changeState(j.State.NONE)}else{if(this._mode===j.Mode.SIMPLE){this._changeState(j.State.NONE);this.endRotate();if(this._2DMode){this.endPan()}}else{if(this._2DMode&&this._mode===j.Mode.COMBINED){this._changeState(j.State.NONE);this.endPan()}else{if(this._state===j.State.HOLD){this._changeState(j.State.NONE)}else{if(this._state===j.State.ROTATE){if((this._mode===j.Mode.CATIA)||((this._mode===j.Mode.COMBINED)&&this._middleButtonPressed)){if(!this._rightButtonPressed){this._changeState(j.State.ZOOM)}}else{if(this.mouseInertia&&this.lockZ&&this._finalizeRotateLockZ){this._finalizeRotateLockZ(q,false)}this._changeState(j.State.NONE);this.endRotate();this.rotateDirection=0}}}}}}if(this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB){this.viewer.leftMouseUpCB(q,this)}this.resetLeftClick();this._mouseDownPos=null;this.tagEventIfModeNotNONE(o)};j.prototype._onMiddleMouseUp=function(o){if(this.handleRecordData(o)){this._middleButtonPressed=false;this._middleClicking=false;return}if(this.lockMouse){return}var q=(o.from&&o.from.length)?o.from[0]:null;if(q===null){return}if(this._isIE11){var p=q.getJSEvent();if(p&&(p.ctrlKey!==undefined)){this._ctrlKeyPressed=p.ctrlKey}}this._releaseCapture();var r=q.isInView(this.manipulatedViewList);this._middleButtonPressed=false;if(!this.isCurrentViewpoint()){this._middleClicking=false;return}if(this._state===j.State.STOP){if(r&&this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB){this.viewer.centerMouseUpCB(q,this)}this._middleClicking=false;return}this._changeState(j.State.NONE);if(r&&this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB){this.viewer.centerMouseUpCB(q,this)}this._middleClicking=false;this.tagEventIfModeNotNONE(o)};j.prototype._onRightMouseUp=function(o){if(this.handleRecordData(o)){this._rightButtonPressed=false;this._rightClicking=false;return}if(this.lockMouse){return}var q=(o.from&&o.from.length)?o.from[0]:null;if(q===null){return}if(this._isIE11){var p=q.getJSEvent();if(p&&(p.ctrlKey!==undefined)){this._ctrlKeyPressed=p.ctrlKey}}this._releaseCapture();this._rightButtonPressed=false;if(!this.isCurrentViewpoint()){this._rightClicking=false;return}if(this._state===j.State.STOP){if(this._pickingCB&&this.viewer&&this.viewer.rightMouseUpCB){this.viewer.rightMouseUpCB(q,this)}this._rightClicking=false;return}if((this._mode>0)&&(this._state===j.State.ZOOM)){this._changeState(j.State.NONE)}else{if(this._state===j.State.HOLD){this._changeState(j.State.NONE)}else{if(this._state===j.State.ROTATE){if((this._mode===j.Mode.CATIA)||((this._mode===j.Mode.COMBINED)&&this._middleButtonPressed)){if(!this._leftButtonPressed){this._changeState(j.State.ZOOM)}}else{if(this.mouseInertia&&this.lockZ&&this._finalizeRotateLockZ){this._finalizeRotateLockZ(q,false)}this._changeState(j.State.NONE);this.endRotate();this.rotateDirection=0}}}}if(this._pickingCB&&this.viewer&&this.viewer.rightMouseUpCB){this.viewer.rightMouseUpCB(q,this)}this._rightClicking=false;this.tagEventIfModeNotNONE(o)};j.prototype._onMouseMove=function(x){if(this.handleRecordData(x)){return}if(this.lockMouse){return}var q=(x.from&&x.from.length)?x.from[0]:null;if(q===null){return}this._publishWUXEvent("PrimaryPointerMove",x,true);if(!this.isCurrentViewpoint()){return}var u=this;if((this._state===j.State.STOP)||(this._state===j.State.HOLD)){if(this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB){this.viewer.mouseMoveCB(q,this)}return}var t=q.getCurrentPosition(this.domElement);var p=q.getLastPosition(this.domElement);for(var r=0;r<x.from.length;r++){var s=x.from[r];if(s.getButton&&(s.getButton()!==m.MouseButton.NONE)){t=s.getCurrentPosition(this.domElement);p=s.getLastPosition(this.domElement);break}}if(!l.isReplaying()){if(!this.lockPan&&((this._state===j.State.PAN)||(this._state===j.State.FORCE_PAN))){var w={gesture:x.gesture,defaultBehavior:true};this._modelEvent.publish({event:"Pan",data:w,context:this});if(w.defaultBehavior){this._pan(t,p)}}else{if(!this.lockRotation&&!this.lockMouseRotation&&((this._state===j.State.ROTATE)||(this._state===j.State.FORCE_ROTATE))){var o={gesture:x.gesture,defaultBehavior:true};this._modelEvent.publish({event:"Rotate",data:o,context:this});if(o.defaultBehavior){if(this.lockZ){this._rotateLockZ(t.x-p.x,t.y-p.y)}else{this._rotate(t,p)}}}else{if(!this.lockZoom&&((this._state===j.State.ZOOM)||(this._state===j.State.FORCE_ZOOM))){var v={gesture:x.gesture,defaultBehavior:true};this._modelEvent.publish({event:"Zoom",data:v,context:this});if(v.defaultBehavior){this._zoom(t,p)}}}}}if(this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB){this.viewer.mouseMoveCB(q,this)}this.tagEventIfModeNotNONE(x)};j.prototype._onMouseOut=function(p){if(this.handleRecordData(p)){return}if(this.lockMouse){return}this._leftButtonPressed=false;this._rightButtonPressed=false;this._middleButtonPressed=false;if(!this.isCurrentViewpoint()){return}var q=(p.from&&p.from.length)?p.from[0]:null;if(q){var o=q.getJSEvent();var r=o.target;if(!r){r=o.srcElement}if(r!==this.viewer.canvas){return}var s=o.toElement;while(s){if(s===this.viewer.divCssElement){return}s=s.parentNode}}if(this._state!==j.State.STOP){this._changeState(j.State.NONE)}this.tagEventIfModeNotNONE(p)};j.prototype._onSwipe=function(p){if(this.handleRecordData(p)){return}var r=(p.from&&p.from.length)?p.from[0]:null;if(r===null){return}this._publishWUXEvent("PrimaryPointerMove",p,true);if(!this.isCurrentViewpoint()){return}if(this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB){this.viewer.mouseMoveCB(r,this)}if(this._state===j.State.STOP){return}if(this._state===j.State.HOLD){return}var o=r.currentPosition;var u=r.lastPosition;if(!this.lockPan&&(this._state===j.State.FORCE_PAN)){var s={gesture:p.gesture,defaultBehavior:true};this._modelEvent.publish({event:"Pan",data:s,context:this});if(s.defaultBehavior){this._pan(o,u)}}else{if(!this.lockRotation&&!this.lockTouchRotation&&((this._state===j.State.ROTATE)||(this._state===j.State.FORCE_ROTATE))){var t={gesture:p.gesture,defaultBehavior:true};this._modelEvent.publish({event:"Rotate",data:t,context:this});if(t.defaultBehavior){this._rotateLockZ(o.x-u.x,o.y-u.y)}}else{if(!this.lockZoom&&(this._state===j.State.FORCE_ZOOM)){var q={gesture:p.gesture,defaultBehavior:true};this._modelEvent.publish({event:"Zoom",data:q,context:this});if(q.defaultBehavior){this._zoom(o,u)}}}}this.tagEventIfModeNotNONE(p)};j.prototype._onTap=function(o){if(this.handleRecordData(o)){return}var p=(o.from&&o.from.length)?o.from[0]:null;if(p===null){return}if(!this.isCurrentViewpoint()){return}this.startLeftClick();if(this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB){this.viewer.leftMouseUpCB(p,this)}this.resetLeftClick();this.tagEventIfModeNotNONE(o)};j.prototype._onDoubleTap=function(o){if(this.handleRecordData(o)){return}var p=(o.from&&o.from.length)?o.from[0]:null;if(p===null){return}if(!this.isCurrentViewpoint()){return}this._middleClicking=true;if(this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB){this.viewer.centerMouseUpCB(p,this)}this._middleClicking=false;this.tagEventIfModeNotNONE(o)};j.prototype._onDoublePinchTap=function(o){if(this.handleRecordData(o)){return}var r=o.gesture.getEvents();if(!r.length){return}if(!this.isCurrentViewpoint()){return}if(this._state===j.State.STOP){return}this._stopRotation();var q=this.viewer.getMousePosition(r[0].currentPosition);var t=this.viewer.pick(q,"mesh",false);var s=null;if(t.length){var p=t.path[0]._getRenderableOccurrences();if(p.length){s=p[0]}}this.viewpoint.reframe(null,undefined,s);this.tagEventIfModeNotNONE(o)};j.prototype._onHold=function(o){if(this.handleRecordData(o)){return}if(!this.isCurrentViewpoint()){return}if((h.debugEvents===2)||(h.debugEvents>=4)){console.log(data)}this.tagEventIfModeNotNONE(o)};j.prototype._onStopManip=function(o){if(this.handleRecordData(o)){return}if(!this._blockVptOnHold){return}if(!this.isCurrentViewpoint()){return}if(this._state!==j.State.STOP){if((this._state!==j.State.FORCE_PAN)&&(this._state!==j.State.FORCE_ZOOM)&&(this._state!==j.State.FORCE_ROTATE)){this._changeState(j.State.HOLD)}}this.tagEventIfModeNotNONE(o)};j.prototype._onPinchPanRotate=function(o,q){if(this.handleRecordData(o)){return}var p=o.gesture;if(!this.isCurrentViewpoint()){return}if((this._state===j.State.HOLD)||(this._state===j.State.STOP)){return}this._changeState(j.State.ZOOM_PAN_ROTATE);this._zoomPanRotate(p,q);this.tagEventIfModeNotNONE(o)};j.prototype._onTouch=function(o){if(this.handleRecordData(o)){return}this._publishWUXEvent("PrimaryPointerDown",o,false);if(!this.isCurrentViewpoint()){return}if((this._state===j.State.HOLD)||(this._state===j.State.STOP)){return}if(this._forcePan){this._changeState(j.State.FORCE_PAN)}else{if(this._forceRotate){this._changeState(j.State.FORCE_ROTATE)}else{if(this._forceZoom){this._changeState(j.State.FORCE_ZOOM)}else{if(!this.lockTouchRotation){this._changeState(j.State.ROTATE)}}}}this.tagEventIfModeNotNONE(o)};j.prototype._onRelease=function(o){if(this.handleRecordData(o)){return}var p=(o.from&&o.from.length)?o.from[0]:null;if(p===null){return}this._publishWUXEvent("PrimaryPointerUp",o,false);if(!this.isCurrentViewpoint()){return}if(this._state===j.State.STOP){if(this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB){this.viewer.leftMouseUpCB(p,this)}return}if(this._state===j.State.ROTATE||this._state===j.State.ZOOM_PAN_ROTATE){if(this.touchInertia&&this._finalizeRotateLockZ){this._finalizeRotateLockZ(p,true)}this.rotateDirection=0}if(this._state===j.State.HOLD){if(this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB){this.viewer.leftMouseUpCB(p,this)}}this._changeState(j.State.NONE);this.tagEventIfModeNotNONE(o)};j.prototype._publishWUXEvent=function(p,o,q){var r={eventChannel:"/VISU/",eventType:"@on"+p,eventID:"",from:o.from};e.publish({event:"/VISU/on"+p,data:r});if((!q&&((h.debugEvents===2)||(h.debugEvents>=4)))||(q&&(h.debugEvents>=3))){console.log(r)}};j.prototype._createShortHoldSpinner=function(p,o){var q=document.createElementNS("http://www.w3.org/2000/svg","svg");q.setAttribute("id","svgNode");q.style.position="absolute";q.style.top=0;q.style.left=0;q.style.right=0;q.style.bottom=0;q.style.setProperty("pointer-events","none");q.style.setProperty("z-index",10000);var r=document.createElementNS("http://www.w3.org/2000/svg","circle");r.setAttribute("id","svgCircle");r.setAttribute("fill","none");r.style.fill="none";r.style.stroke=o;r.style.setProperty("stroke-linecap","square");if(p){this.SVGCircle=r;this.ShortHoldSpinner=q}else{this.SVGCircleLarge=r;this.ShortHoldSpinnerLarge=q}q.appendChild(r);this.viewer.div.appendChild(q)};j.prototype._showSpinner=function(r,w,v,y){var u=v-0.5*y;r.style.display="block";r.setAttribute("width",(2*v)+"px");r.setAttribute("height",(2*v)+"px");w.setAttribute("cx",v);w.setAttribute("cy",v);w.setAttribute("r",u);w.setAttribute("transform","rotate(-90, "+v+","+v+")");w.style.setProperty("stroke-width",y);w.style.setProperty("stroke-dasharray",2*Math.PI*u+1);w.style.setProperty("stroke-dashoffset",2*Math.PI*u+1);var z=function(B,A,D,E,C){this._nbLoops=1;this._duration=D;this.duration=function(){return this._duration};this.valueAt=function(H){var I=this._duration,F=(H%I)/I;if(F>=0&&F<E){return B}else{if(F<1-C){var G=(F-E)/(1-E-C);return B*(1-G)+A*G}else{return A}}}};var s=true;var o=2*Math.PI*u+1;var x=0;var q=function(A){if(A===o){if(s){r.style.display="none";s=false}}else{if(!s){r.style.display="block";s=true}this.circle.style.setProperty("stroke-dashoffset",A)}};var t={circle:w,setOffset:q};var p=new k(t,"setOffset",new z(o,x,1.2*h.getHoldTime(),0.3,0));p.start();return p};j.prototype._hideSpinner=function(o,p){if(p){p.stop()}o.style.display="none"};j.prototype._setPositionSpinner=function(q,p,o){q.style.left=(p.x-o)+"px";q.style.top=(p.y-o)+"px"};j.prototype._setCursor=function(p){var r=this;var o="auto";if(p!=="Auto"){var q=f.getWebappsAssetUrl("Visualization","")+"icons/";o="url('"+q+"WebViewer"+p+".png'), url('"+q+"WebViewer"+p+".cur'), auto"}this.viewer.canvas.style.cursor=o};j.prototype.tagEventIfModeNotNONE=function(o){if(l.isRecording()&&this._state!==j.State.NONE&&o.gesture){if(!o.gesture.highLevelRecordJSON){o.gesture.highLevelRecordJSON={}}o.gesture.highLevelRecordJSON.TrackBallControls={ignore:true}}};j.prototype.handleRecordData=function(o){if(l.isReplaying()){if(this.testRecordMoveViewpoint(o)){return true}}};j.prototype.getRecordData=function(o,p){var q=o.gesture&&o.gesture.highLevelRecordJSON&&o.gesture.highLevelRecordJSON.TrackBallControls;return q&&(!q.name||q.name===this._recordRegisterName)&&q[p]};j.prototype.testRecordMoveViewpoint=function(p){if(this.getRecordData(p,"setViewPoint")){var o=this.getRecordData(p,"setViewPoint");this.setPositionFromJSON(o);this.viewer.render();return true}return false};j.prototype.positionToJSON=function(){return{target:this.target.createJSON(),orientation:this.orientation.createJSON(),distanceToTarget:this.distanceToTarget}};j.prototype.setPositionFromJSON=function(o){this.target.setFromJSON(o.target);this.orientation.setFromJSON(o.orientation);this.distanceToTarget=o.distanceToTarget};return j});define("Visualization/TrackballControls",["DS/Visualization/TrackballControls","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/TrackballControls");return b});define("DS/SceneGraphNodes/DiskLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(c,b){var a=b.extend({init:function(e,d){var f=new c.DiskLight(e.color,e.intensity,e.radius);this._radius=f.radius;this._parent(f,d);return this},attachToViewpoint:function(d){return null},setRadius:function(d){if(d){this._radius=d}this._updateRadius()},_updateRadius:function(){var e,f,d;this.light3js.radius=this._radius;e=this._occurrences.length;for(var d=0;d<e;d++){f=this._occurrences[d];f.renderable.radius=this._radius}},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"DiskLightNode3D"}});return UWA.namespace("THREEDS/Nodes/DiskLightNode",a)});define("SceneGraphNodes/DiskLightNode",["DS/SceneGraphNodes/DiskLightNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/DiskLightNode");return b});define("DS/SceneGraphNodes/Canvas2DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils"],function(c,e,a,d){var b=e.extend({init:function(j,g){this._parent(j.name);this.hotspot=j.hotspot||new c.Vector2(0,0);this.canvasNodeTexture=j.canvasNodeTexture;var h=this.canvasNodeTexture._getCanvas2DTexture();this.material=new c.ShaderMaterialDS({transparent:true,side:c.DoubleSide,depthTest:false,uniforms:{hotspot:{type:"v2",value:this.hotspot},pixelSize:{type:"v2",value:new c.Vector2(2/400,2/400)},size:{type:"v2",value:new c.Vector2(this.canvasNodeTexture.width,this.canvasNodeTexture.height)},map:{type:"t",value:h},highlight:{type:"i",value:0}},vertexShaderPars:["uniform vec2 pixelSize;","uniform vec2 hotspot;","uniform vec2 size;","varying vec2 vUv;","varying vec2 screenPosition;"].join("\n"),vertexShaderBody:["vUv = uv;",c._DefaultShaderChunk.model_view_transformation_vertex,"vec3 mvNormal = normalMatrix * normal;","gl_Position = projectionMatrix * mvPosition;","gl_Position.x += gl_Position.w * (pixelSize.x*(-hotspot.x + vUv.x*size.x));","gl_Position.y += gl_Position.w * (pixelSize.y*(-hotspot.y + vUv.y*size.y));"].join("\n"),fragmentShaderPars:["varying vec2 vUv;","uniform sampler2D map;","uniform bool highlight;"].join("\n"),fragmentShaderBody:["gl_FragColor = texture2D(map, vUv);","if(highlight) {","  float norm = length(gl_FragColor.xyz);","  gl_FragColor.xyz = (norm/1.73205)*vec3(0.0, 0.6, 1.0);","}"].join("\n")});this.material.refreshUniforms=function(p,n){var l;if(p._smallTargetPicking&&(p.materialToUse===c.MaterialToUse.pickingMaterial||p.materialToUse===c.MaterialToUse.pickingMaterialInstancing||p.materialToUse===c.MaterialToUse.normalMaterial||p.materialToUse===c.MaterialToUse.depthMaterial)){var o=p._gpuPickingTolerance*2+1;l=new c.Vector2(2/o,2/o)}else{l=new c.Vector2(2/p.domElement.width,2/p.domElement.height)}this.uniforms.pixelSize.value=l;if(window.activateCanvas2DSuperHighlight){var m=n._occurrence.node._occurrences.length>1;this.uniforms.highlight.value=!m&&n.highlight?1:0}};this.material.force=true;this.rectangle=f(this.material,g);this.rectangle.setFrustumCulled(false);this.rectangle.setMirror(false);this.rectangle.setShadow(false,false);this.addChild(this.rectangle);this.rectangle.setRenderPasses(["canvas2D"]);this.exludeFromBounding(true);var k=this;this.rectangle._setBeforeRenderCB(function(m,l){if(h.redrawRequested){k.canvasNodeTexture._redrawCanvas2DTexture()}});return this},excludeFromHighlight:function(h,g){this.rectangle.excludeFromHighlight(h,g)}});function f(p,k){var r,u,q,m,h,g,o,y,l,n,s,z,t,w,v,x;r=10;u=new d.PrimitiveGroup();u.fillAttr=new d.FillAttributes();u.lineAttr=new d.LineAttributes();u.pointAttr=new d.PointAttributes();q=new d.Buffer();q.size=12;q.component=d.VertexComponentEnum.POSITION;q.format=d.DataTypeEnum.FLOAT;q.dimension=3;q.data=new Float32Array(q.size);m=new d.Buffer();m.size=3;m.component=d.VertexComponentEnum.NORMAL;m.format=d.DataTypeEnum.FLOAT;m.dimension=3;m.data=new Float32Array(m.size);h=new d.Buffer();h.size=12;h.component=d.VertexComponentEnum.TEX_COORD_0;h.format=d.DataTypeEnum.FLOAT;h.dimension=3;h.data=new Float32Array(h.size);g=new d.Buffer();g.indexBuffer=true;g.size=4;g.format=d.DataTypeEnum.UINT;g.dimension=1;g.data=new Uint16Array(g.size);o=new d.Buffer();o.indexBuffer=true;o.size=4;o.format=d.DataTypeEnum.UINT;o.dimension=1;o.data=new Uint16Array(o.size);y=new d.Buffer();y.indexBuffer=true;y.size=4;y.format=d.DataTypeEnum.UINT;y.dimension=1;y.data=new Uint16Array(y.size);u.addBuffer(0,q);u.addBuffer(1,m);u.addBuffer(2,g);u.addBuffer(3,o);u.addBuffer(4,h);u.addBuffer(5,y);x=g.data;w=0;x[w++]=0;x[w++]=1;x[w++]=3;x[w++]=2;x=o.data;w=0;for(v=0;v<1;v++){x[w++]=v;x[w++]=v;x[w++]=v;x[w++]=v}x=y.data;w=0;x[w++]=0;x[w++]=1;x[w++]=3;x[w++]=2;x=q.data;w=0;for(w=0;w<12;w++){x[w]=0}x=m.data;w=0;x[w++]=0;x[w++]=0;x[w++]=1;x=h.data;w=0;x[w++]=0;x[w++]=0;x[w++]=0;x[w++]=1;x[w++]=0;x[w++]=0;x[w++]=1;x[w++]=1;x[w++]=0;x[w++]=0;x[w++]=1;x[w++]=0;for(v=0;v<1;v++){l=new d.Primitive();l.nbIndices=4;l.connectivity=d.ConnectivityTypeEnum.TRIANGLE_STRIP;l.attr={fill:new d.FillAttributes(new d.Color(1-v/6,0,v/6,1),1),line:new d.LineAttributes(),point:new d.PointAttributes()};n=new d.VertexComponent();n.component=d.VertexComponentEnum.POSITION;n.nbVertices=4;n.nbValuesPerVertex=3;n.format=d.DataTypeEnum.FLOAT;n.cardinality=0;n.bufferId=0;n.indices=new d.IndexArray();n.indices.format=d.DataTypeEnum.UINT;n.indices.bufferId=2;n.indices.offset=4*v;s=new d.VertexComponent();s.component=d.VertexComponentEnum.NORMAL;s.nbVertices=4;s.nbValuesPerVertex=3;s.format=d.DataTypeEnum.FLOAT;s.cardinality=0;s.bufferId=1;s.indices=new d.IndexArray();s.indices.format=d.DataTypeEnum.UINT;s.indices.bufferId=3;s.indices.offset=4*v;z=new d.VertexComponent();z.component=d.VertexComponentEnum.TEX_COORD_0;z.nbVertices=4;z.nbValuesPerVertex=3;z.format=d.DataTypeEnum.FLOAT;z.cardinality=0;z.bufferId=4;z.indices=new d.IndexArray();z.indices.format=d.DataTypeEnum.UINT;z.indices.bufferId=5;z.indices.offset=0;l.addVertexComponent(n);l.addVertexComponent(s);l.addVertexComponent(z);u.addPrimitive(l)}t=k.createMeshNode(u,p);t.setShadow(false);return t}return UWA.namespace("THREEDS/Nodes/Canvas2DNode",b)});define("DS/SceneGraphNodes/IESLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(b,a){var c=a.extend({init:function(e,d){var f=new b.IESLight(e.color,e.intensity,e.distance,e.texture);this._texture=e.texture;this._parent(f,d);return this},setIESTexture:function(d){this._texture=d;this._updateTexture()},_updateTexture:function(){var e,f,d;this.light3js.iesTexture=this._texture;e=this._occurrences.length;for(var d=0;d<e;d++){f=this._occurrences[d];f.renderable.iesTexture=this._texture}},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"IESLightNode3D"}});return UWA.namespace("THREEDS/Nodes/IESLight",c)});define("SceneGraphNodes/IESLightNode",["DS/SceneGraphNodes/IESLightNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/IESLightNode");return b});define("DS/SceneGraphNodes/AreaLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(c,a){var b=a.extend({init:function(e,d){var f=new c.AreaLight(e.color,e.intensity,e.width,e.height);this._areaWidth=f.width;this._areaHeight=f.height;this._parent(f,d);return this},attachToViewpoint:function(d){return null},setAreaSize:function(e,d){if(e){this._areaWidth=e}if(d){this._areaHeight=d}this._updateAreaSize()},_updateAreaSize:function(){var e,f,d;this.light3js.width=this._areaWidth;this.light3js.height=this._areaHeight;e=this._occurrences.length;for(var d=0;d<e;d++){f=this._occurrences[d];f.renderable.width=this._areaWidth;f.renderable.height=this._areaHeight}},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"AreaLightNode3D"}});return UWA.namespace("THREEDS/Nodes/AreaLight",b)});define("SceneGraphNodes/AreaLightNode",["DS/SceneGraphNodes/AreaLightNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/AreaLightNode");return b});define("DS/Animation/AnimationGroup",["DS/Animation/ANIM","DS/Animation/AbstractAnimation"],function(b,c){var a=function(){c.call(this);this._children=[]};a.prototype=new c();a.prototype.duration=function(){var f=0;for(var e=0;e<this._children.length;++e){f=Math.max(f,this._children[e].offset+this._children[e].animation.duration())}return f};a.prototype.animationCount=function(){return this._children.length};a.prototype.animationAt=function(d){b.assert(0<=d&&d<this.animationCount());return this._children[d].animation};a.prototype.indexOfAnimation=function(e){for(var d=0;d<this._children.length;++d){if(this._children[d].animation===e){return d}}return -1};a.prototype.addAnimation=function(d,e){b.assert(e&&this.state()===b.State.STOPPED&&e.state()===b.State.STOPPED);b.assert(e instanceof a?!e.isAncestorOf(this):true);if(e._group){e._group.removeAnimation(e)}e.setDirection(this.direction());e.setLoop(0);this._children.push({offset:d,animation:e});e._group=this};a.prototype.removeAnimation=function(e){b.assert(e&&e._group===this&&this.state()===b.State.STOPPED);var d=this.indexOfAnimation(e);this._children.splice(d,1);e._group=null};a.prototype.moveAnimation=function(f,d){b.assert(f&&f._group===this&&this.state()===b.State.STOPPED);var e=this.indexOfAnimation(f);this._children[e].offset=d};a.prototype.clear=function(){b.assert(this.state()===b.State.STOPPED);for(var d=0;d<this._children.length;++d){this._children[d].animation._group=null}this._children=[]};a.prototype.isAncestorOf=function(d){while(d){if(d===this){return true}d=d._group}return false};a.prototype._updateCurrentTime=function(f){var e=b.State.STOPPED;for(var d=0;d<this._children.length;++d){var g=this._children[d];g.animation._time=f-g.offset;g.animation._updateCurrentTime(g.animation._time);if(g.offset<this.time()&&this.time()<g.offset+g.animation.duration()){e=this.state()}else{e=b.State.STOPPED}if(g.animation._state!==e){g.animation._state=e;g.animation._updateState(e)}}};a.prototype._updateState=function(f){var e=b.State.STOPPED;for(var d=0;d<this._children.length;++d){var g=this._children[d];if(g.offset<this.time()&&this.time()<g.offset+g.animation.duration()){e=this.state()}else{e=b.State.STOPPED}if(g.animation._state!==e){g.animation._state=e;g.animation._updateState(e)}}};a.prototype._updateDirection=function(e){for(var d=0;d<this._children.length;++d){var f=this._children[d];f.animation._direction=e;f.animation._updateDirection(e)}};return a});define("Animation/AnimationGroup",["DS/Animation/AnimationGroup","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Animation/AnimationGroup");return b});define("DS/SceneGraphNodes/CanvasNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/SceneGraphNodes/CanvasNodeTexture"],function(c,e,a,d,b){var g=e.extend({init:function(j,h){this._parent(j.name);this._isDynamic=true;this.bottomLeftCorner=j.bottomLeftcorner;this.vectors={};this.vectors.width=j.widthVector;this.vectors.height=j.heightVector;this.canvasNodeTexture=j.canvasNodeTexture;this.requestTextureUpdate=true;this.rectangle=f(null,this.bottomLeftCorner,this.vectors.width,this.vectors.height,j.canvasNodeTexture.rectangleTexture,h);var k=this;this.rectangle._setBeforeRenderCB(function(m,l){if(k.requestTextureUpdate&&l.viewpoint){k._textureUpdate(m,l.viewpoint,l.camera)}});this.rectangle.setSSAO(false);this.rectangle.setMirror(false);this.addChild(this.rectangle);this.cbChange=function(l){if(l.eventType==="@onViewpointChange"){k._onViewpointChange()}};this.tokenChange=null;return this},setFrustumCulled:function(){this.rectangle.setFrustumCulled.apply(this.rectangle,arguments)},_onLinkedToSceneGraph:function(){this.tokenChange=a.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){a.unsubscribe(this.tokenInit);a.unsubscribe(this.tokenChange);var h;for(h=0;h<this.rectangle._occurrences.length;h++){var j=this.rectangle._occurrences[h].renderable;if(j.material){this.canvasNodeTexture._releaseMaterial(j.material);j.material=null;if(j.highlight){j.highlight.material=null}if(j.preHighlight){j.preHighlight.material=null}}}},_getDynamicMatrix:function(h,j,k){this._onViewpointChange();return this.getMatrix()},_onViewpointChange:function(){this.requestTextureUpdate=true},_textureUpdate:function(l,o,p){var m=p.position;var k=this.bottomLeftCorner.clone();var r=this.vectors[this.canvasNodeTexture.longestEdge];var j=new c.Vector3(k.x+r.x,k.y+r.y,k.z+r.z);var q=l._getMMMatrix();k.applyMatrix4(q);j.applyMatrix4(q);var u=o.project(k,p);var t=o.project(j,p);var h=u.distanceTo(t);var s=l.material;var n=this.canvasNodeTexture._getNewMaterial(h,s);if(n){l._gsso_cache=null;l.material=n;if(l.highlight){l.highlight.material=n}if(l.preHighlight){l.preHighlight.material=n}}}});function f(t,n,x,w,s,l){var v,A,u,p,k,h,r,E,o,q,y,F,z,C,B,D;v=10;A=new d.PrimitiveGroup();A.fillAttr=new d.FillAttributes();A.lineAttr=new d.LineAttributes();A.pointAttr=new d.PointAttributes();u=new d.Buffer();u.size=12;u.component=d.VertexComponentEnum.POSITION;u.format=d.DataTypeEnum.FLOAT;u.dimension=3;u.data=new Float32Array(u.size);p=new d.Buffer();p.size=3;p.component=d.VertexComponentEnum.NORMAL;p.format=d.DataTypeEnum.FLOAT;p.dimension=3;p.data=new Float32Array(p.size);k=new d.Buffer();k.size=12;k.component=d.VertexComponentEnum.TEX_COORD_0;k.format=d.DataTypeEnum.FLOAT;k.dimension=3;k.data=new Float32Array(k.size);h=new d.Buffer();h.indexBuffer=true;h.size=4;h.format=d.DataTypeEnum.UINT;h.dimension=1;h.data=new Uint16Array(h.size);r=new d.Buffer();r.indexBuffer=true;r.size=4;r.format=d.DataTypeEnum.UINT;r.dimension=1;r.data=new Uint16Array(r.size);E=new d.Buffer();E.indexBuffer=true;E.size=4;E.format=d.DataTypeEnum.UINT;E.dimension=1;E.data=new Uint16Array(E.size);A.addBuffer(0,u);A.addBuffer(1,p);A.addBuffer(2,h);A.addBuffer(3,r);A.addBuffer(4,k);A.addBuffer(5,E);D=h.data;C=0;D[C++]=0;D[C++]=1;D[C++]=3;D[C++]=2;D=r.data;C=0;for(B=0;B<1;B++){D[C++]=B;D[C++]=B;D[C++]=B;D[C++]=B}D=E.data;C=0;D[C++]=0;D[C++]=1;D[C++]=3;D[C++]=2;D=u.data;C=0;D[C++]=n.x;D[C++]=n.y;D[C++]=n.z;D[C++]=n.x+x.x;D[C++]=n.y+x.y;D[C++]=n.z+x.z;D[C++]=n.x+x.x+w.x;D[C++]=n.y+x.y+w.y;D[C++]=n.z+x.z+w.z;D[C++]=n.x+w.x;D[C++]=n.y+w.y;D[C++]=n.z+w.z;D=p.data;C=0;D[C++]=0;D[C++]=0;D[C++]=1;var m=s?1:w.length()/x.length();D=k.data;C=0;D[C++]=0;D[C++]=1-m;D[C++]=0;D[C++]=1;D[C++]=1-m;D[C++]=0;D[C++]=1;D[C++]=1;D[C++]=0;D[C++]=0;D[C++]=1;D[C++]=0;for(B=0;B<1;B++){o=new d.Primitive();o.nbIndices=4;o.connectivity=d.ConnectivityTypeEnum.TRIANGLE_STRIP;o.attr={fill:new d.FillAttributes(new d.Color(1-B/6,0,B/6,1),1),line:new d.LineAttributes(),point:new d.PointAttributes()};q=new d.VertexComponent();q.component=d.VertexComponentEnum.POSITION;q.nbVertices=4;q.nbValuesPerVertex=3;q.format=d.DataTypeEnum.FLOAT;q.cardinality=0;q.bufferId=0;q.indices=new d.IndexArray();q.indices.format=d.DataTypeEnum.UINT;q.indices.bufferId=2;q.indices.offset=4*B;y=new d.VertexComponent();y.component=d.VertexComponentEnum.NORMAL;y.nbVertices=4;y.nbValuesPerVertex=3;y.format=d.DataTypeEnum.FLOAT;y.cardinality=0;y.bufferId=1;y.indices=new d.IndexArray();y.indices.format=d.DataTypeEnum.UINT;y.indices.bufferId=3;y.indices.offset=4*B;F=new d.VertexComponent();F.component=d.VertexComponentEnum.TEX_COORD_0;F.nbVertices=4;F.nbValuesPerVertex=3;F.format=d.DataTypeEnum.FLOAT;F.cardinality=0;F.bufferId=4;F.indices=new d.IndexArray();F.indices.format=d.DataTypeEnum.UINT;F.indices.bufferId=5;F.indices.offset=0;o.addVertexComponent(q);o.addVertexComponent(y);o.addVertexComponent(F);A.addPrimitive(o)}z=l.createMeshNode(A,t);z.setShadow(false);return z}return UWA.namespace("THREEDS/Nodes/CanvasNode",g)});define("DS/VisuLoaders/MTLLoader",["DS/Visualization/ThreeJS_DS"],function(a){var b=function(d,c){a.EventDispatcher.call(this);this.baseUrl=d;this.options=c};b.prototype={load:function(c){var d=this;var f=new XMLHttpRequest();function e(g){if(g.target.status===200||g.target.status===0){var h=d.parse(g.target.responseText);d.dispatchEvent({type:"load",content:h})}else{d.dispatchEvent({type:"error",message:"Couldn't load URL ["+c+"]",response:g.target.responseText})}}f.addEventListener("load",e,false);f.addEventListener("progress",function(g){d.dispatchEvent({type:"progress",loaded:g.loaded,total:g.total})},false);f.addEventListener("error",function(){d.dispatchEvent({type:"error",message:"Couldn't load URL ["+c+"]"})},false);f.open("GET",c,true);f.send(null)},parse:function(l){var n=l.split("\n");var d={};var e=/\s+/;var c={};for(var f=0;f<n.length;f++){var o=n[f];o=o.trim();if(o.length===0||o.charAt(0)==="#"){continue}var h=o.indexOf(" ");var k=(h>=0)?o.substring(0,h):o;k=k.toLowerCase();var j=(h>=0)?o.substring(h+1):"";j=j.trim();if(k==="newmtl"){d={name:j};c[j]=d}else{if(d){if(k==="ka"||k==="kd"||k==="ks"){var m=j.split(e,3);d[k]=[parseFloat(m[0]),parseFloat(m[1]),parseFloat(m[2])]}else{d[k]=j}}}}var g=new b.MaterialCreator(this.baseUrl,this.options);g.setMaterials(c);return g}};b.MaterialCreator=function(d,c){a.EventDispatcher.call(this);this.baseUrl=d;this.options=c;this.materialsInfo={};this.materials={};this.materialsArray=[];this.nameLookup={};this.side=(this.options&&this.options.side)?this.options.side:a.FrontSide;this.wrap=(this.options&&this.options.wrap)?this.options.wrap:a.RepeatWrapping};b.MaterialCreator.prototype={setMaterials:function(c){this.materialsInfo=this.convert(c);this.materials={};this.materialsArray=[];this.nameLookup={}},convert:function(c){if(!this.options){return c}var k={};for(var e in c){var l=c[e];var j={};k[e]=j;for(var d in l){var f=true;var h=l[d];var g=d.toLowerCase();switch(g){case"kd":case"ka":case"ks":if(this.options&&this.options.normalizeRGB){h=[h[0]/255,h[1]/255,h[2]/255]}if(this.options&&this.options.ignoreZeroRGBs){if(h[0]===0&&h[1]===0&&h[1]===0){f=false}}break;case"d":if(this.options&&this.options.invertTransparency){h=1-h}break;default:break}if(f){j[g]=h}}}return k},preload:function(){for(var c in this.materialsInfo){this.create(c)}},getIndex:function(c){return this.nameLookup[c]},getAsArray:function(){var c=0;for(var d in this.materialsInfo){this.materialsArray[c]=this.create(d);this.nameLookup[d]=c;c++}return this.materialsArray},create:function(c){if(this.materials[c]===undefined){this.createMaterial_(c)}return this.materials[c]},createMaterial_:function(g){var c=this.materialsInfo[g];var e={name:g,side:this.side};for(var f in c){var d=c[f];switch(f.toLowerCase()){case"kd":e.diffuse=new a.Color().setRGB(d[0],d[1],d[2]);break;case"ka":e.ambient=new a.Color().setRGB(d[0],d[1],d[2]);break;case"ks":e.specular=new a.Color().setRGB(d[0],d[1],d[2]);break;case"map_kd":e.map=b.loadTexture(this.baseUrl+d);e.map.wrapS=this.wrap;e.map.wrapT=this.wrap;break;case"ns":e.shininess=d;break;case"d":if(d<1){e.transparent=true;e.opacity=d}break;default:break}}if(e.diffuse){if(!e.ambient){e.ambient=e.diffuse}e.color=e.diffuse}this.materials[g]=new a.MeshPhongMaterial(e);return this.materials[g]}};b.loadTexture=function(f,e,g,j){var d=/\.dds$/i.test(f);if(d){var h=a.ImageUtils.loadCompressedTexture(f,e,g,j)}else{var k=new Image();var h=new a.Texture(k,e);var c=new a.ImageLoader();c.addEventListener("load",function(l){h.image=b.ensurePowerOfTwo_(l.content);h.needsUpdate=true;if(g){g(h)}});c.addEventListener("error",function(l){if(j){j(l.message)}});c.crossOrigin=this.crossOrigin;c.load(f,k)}return h};b.ensurePowerOfTwo_=function(e){if(!b.isPowerOfTwo_(e.width)||!b.isPowerOfTwo_(e.height)){var d=document.createElement("canvas");d.width=b.nextHighestPowerOfTwo_(e.width);d.height=b.nextHighestPowerOfTwo_(e.height);var c=d.getContext("2d");c.drawImage(e,0,0,e.width,e.height,0,0,d.width,d.height);return d}return e};b.isPowerOfTwo_=function(c){return(c&(c-1))===0};b.nextHighestPowerOfTwo_=function(c){--c;for(var d=1;d<32;d<<=1){c=c|c>>d}return c+1};return b});define("DS/Visualization/ViewManager",["UWA/Class","DS/CoreEvents/ModelEvents","DS/CSICommandBinder/CSICommandBinder","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/WebVisuParameters/CSIViewParameter"],function(a,b,j,h,f,k){var g={};var d={};var e={};var l={};var m=false;var c=null,n=a.extend({init:function(q){if(!m&&q&&!q.newModelIdentification){var r=this;k.prototype.declareType();var p=function(s){var t=s.readObject("view","CSIViewParam");if(!t){return false}r._executeParameter(t);return true};var o=j.getDefaultResponse();o.onAnswerDomain("view",p);m=true}if(c){this.views=c.views;if(q){c.viewer=q}this.viewer=c.viewer;this._updatePlane=c._updatePlane;return this}this.views={};this.viewer=q;this._updatePlane=true;c=this;return this},_executeParameter:function(o){o.setStaticMaterials(g);o.setDefaultMaterials(e);o.setTemporaryBodies(l);o.execute(this);this.viewer._modelEvent.publish({event:"VisuAnswer",context:this});this.viewer.render({updateInfinitePlane:this._updatePlane})},clear:function(){for(var o in this.views){delete this.views[o]}},addView:function(p,q){var o=this.views[p];if(!o){o=q;this.views[p]=o}return o},removeView:function(p){var o=this.views[p];if(o){o=null;this.views[p]=o}return o},getView:function(p){var o=this.views[p];if(!o){o=new f();this.viewer.addNode(o);this.views[p]=o}return o},getKey:function(o){for(var p in this.views){if(o===this.views[p]){return p}}return null},onVisuAnswer:function(o){return this.viewer._modelEvent.subscribe({event:"VisuAnswer"},o)},unsubscribe:function(o){this.viewer._modelEvent.unsubscribe(o)},_publishVisuAnswer:function(o){if(o){this.viewer._modelEvent.publish({event:"VisuAnswer",context:this})}this.viewer.render({updateInfinitePlane:this._updatePlane})},setStaticMaterial:function(o,p){if(o===""||!p){return false}g[o]=p;return true},getStaticMaterial:function(o){return g[o]},setStaticLook:function(o,p){if(o===""||!p){return false}d[o]=p;return true},getStaticLook:function(o){return d[o]},setDefaultMaterials:function(o){e=o},getDefaultMaterials:function(){return e},setTemporaryBodies:function(o){l=o||{}},updatePlaneOnViewMessage:function(o){this._updatePlane=o}});return UWA.namespace("THREEDS/ViewManager",n)});define("DS/SceneGraphNodes/InstancedCylinderImpostorsNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils"],function(c,e,a,d){var b=e.extend({init:function(m){this._isIE11=((new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent)!=null));this._name=m.name||"cylinderImpostors";this._parent(this._name);var D=m.material?m.material:new c.MeshPhongMaterial({force:true});D.transparent=true;var v=this._createMaterial(D);var r=m.nbInstances||1;var x=null;if(this._isIE11){x=this._createCoarseImpostor(6,v)}else{x=this._createFlatImpostor(0,v)}var y=new a(x,"");var E=m.positions;var o=m.radii;var l=m.axes;var A=m.colors;var s=function(M,K,N,I){var O=N.dot(N);var J=new c.Vector3(I*Math.sqrt(1-N.x*N.x/O),I*Math.sqrt(1-N.y*N.y/O),I*Math.sqrt(1-N.z*N.z/O));var L=new c.Vector3().subVectors(M,J);L.min(new c.Vector3().subVectors(K,J));var H=new c.Vector3().addVectors(M,J);H.max(new c.Vector3().addVectors(K,J));return new c.Box3(L,H)};var w=new c.Vector3(Infinity,Infinity,Infinity);var B=new c.Vector3(-Infinity,-Infinity,-Infinity);var u=new Float32Array(r*4);var p=new Float32Array(r*2);var C=new Float32Array(r*3);var j=new c.Vector3();var h=new c.Vector3();var g=new c.Vector3();var f;for(var z=0;z<r;z++){u[4*z]=E[3*z];u[4*z+1]=E[3*z+1];u[4*z+2]=E[3*z+2];u[4*z+3]=o[z];C[3*z]=l[3*z];C[3*z+1]=l[3*z+1];C[3*z+2]=l[3*z+2];j.set(C[3*z],C[3*z+1],C[3*z+2]);g.addVectors(new c.Vector3(E[3*z],E[3*z+1],E[3*z+2]),new c.Vector3(0.5*l[3*z],0.5*l[3*z+1],0.5*l[3*z+2]));h.subVectors(new c.Vector3(E[3*z],E[3*z+1],E[3*z+2]),new c.Vector3(0.5*l[3*z],0.5*l[3*z+1],0.5*l[3*z+2]));f=s(h,g,j,o[z]);w.min(f.min);B.max(f.max);p[2*z]=Math.floor(255*A[4*z])+Math.floor(255*A[4*z+1])*256+Math.floor(255*A[4*z+2])*65536;p[2*z+1]=A[4*z+3]}var F=new c.Vector3().addVectors(w,B).multiplyScalar(0.5);var q=new c.Vector3().addVectors(F,new c.Vector3().subVectors(w,F).multiplyScalar(1.05));var t=new c.Vector3().addVectors(F,new c.Vector3().subVectors(B,F).multiplyScalar(1.05));var f=new c.Box3(q,t);var n={data:u,type:"v4",isFlattened:true,attribName:"instancePositionAndRadius"};var G={data:C,type:"v3",isFlattened:true,attribName:"cylinderAxis"};var k={data:p,type:"v2",isFlattened:true,attribName:"instanceColor"};y.setMaterial(v);y.setInstancingParameters(r,[n,G,k],"instance");y.forceBoundingBox(f);this.addChild(y);return this},_createFlatImpostor:function(g){var k=[];var m=new c.BufferGeometryDS();m.drawingGroups=[];var l=new d.DrawingGroup(g,g,4,0,6);l.geometry=m;m.drawingGroups.push(l);var n=4;var j=new Float32Array([0,0,0,1,0,0,1,1,0,0,1,0]);m.vertexPositionArray=j;var h=(6);var f=new Uint16Array([0,1,2,0,2,3]);m.vertexIndexArray=f;k.push(m);var o=new c.Mesh(k,g);o.matrixAutoUpdate=false;return o},_createCoarseImpostor:function(u,n){var r=[];var t=new c.BufferGeometryDS();t.drawingGroups=[];var o=12*u;var s=new d.DrawingGroup(n,n,4,0,o);s.geometry=t;t.drawingGroups.push(s);var v=2*u+2;var p=new Float32Array(v*3);var h=0;var f=0;p[h++]=0;p[h++]=0;p[h++]=-1;for(var l=0;l<u;l++){f=l/u;p[h++]=Math.cos(f*2*Math.PI);p[h++]=Math.sin(f*2*Math.PI);p[h++]=-1;p[h++]=Math.cos(f*2*Math.PI);p[h++]=Math.sin(f*2*Math.PI);p[h++]=+1}p[h++]=0;p[h++]=0;p[h++]=+1;t.vertexPositionArray=p;var m=new Uint16Array(o);var g=0;for(var l=0;l<u*2;l+=2){var q=v-1;if(l===10){q=v-2}m[g++]=0;m[g++]=(l+3)%q;m[g++]=l+1;m[g++]=l+1;m[g++]=(l+3)%q;m[g++]=l+2;m[g++]=(l+3)%q;m[g++]=(l+4)%q;m[g++]=l+2;m[g++]=v-1;m[g++]=l+2;m[g++]=(l+4)%q}t.vertexIndexArray=m;r.push(t);var w=new c.Mesh(r,n);w.matrixAutoUpdate=false;return w},_createMaterial:function(h){var j=h;j.activatePDSFX();j.setPDSFXVaryings({viewCenterPos:{type:"v3"},radius:{type:"f"},radius2:{type:"f"},vaColor:{type:"v4"},viewAxis:{type:"v3"},half_height:{type:"f"},rightAndLeft:{type:"v2"}});j.setPDSFXGlobalShaderCode(["vec3 _viewCenterPos;"].join("\n"),["vec3 viewPositionOnCylinder;","vec3 viewNormalOnCylinder;","bool toDiscard;","bool isPerspective;","vec2 viewport;","void intersectionWithCylinderPERSP() {","float minDistance;","float minDistance2;","vec3 viewPos = vGetViewPosition();","vec3 ray = normalize(viewPos);","vec3 cameraToCenter = viewCenterPos;","vec3 D = cross(ray, viewAxis);","float lengthD = length(D);","if (lengthD == 0.0) {","float adjacentInTriangle = dot(ray, cameraToCenter);","minDistance2 = dot(cameraToCenter, cameraToCenter) - adjacentInTriangle*adjacentInTriangle;","if (minDistance2 > radius2) {","	toDiscard = true;","	return;","}","viewNormalOnCylinder = -ray;","viewPositionOnCylinder = adjacentInTriangle*ray;","return;","}","D = normalize(D);","minDistance = abs(dot(-cameraToCenter, D));","if (minDistance > radius) {","	toDiscard = true;","	return;","}","float t = -dot(cross(-cameraToCenter, viewAxis), D)/lengthD;","vec3 O = normalize(cross(D, viewAxis));","float s = abs(sqrt(radius2 - minDistance*minDistance)/dot(ray, O));","vec3 intersection_in = (t-s)*ray;","vec3 intersection_out = (t+s)*ray;","vec3 intersectionToCenter_in = viewCenterPos - intersection_in;","vec3 intersectionToCenter_out = viewCenterPos - intersection_out;","float dot_in_axis = abs(dot(intersectionToCenter_in, viewAxis));","if (dot_in_axis > half_height) {","if (abs(dot(intersectionToCenter_out, viewAxis)) > half_height && ","dot(intersectionToCenter_in, viewAxis)*dot(intersectionToCenter_out, viewAxis) > 0.0) {","toDiscard = true;","return;","}","float diff = dot_in_axis - half_height;","float _dot = dot(ray, viewAxis);","viewNormalOnCylinder = - sign(_dot) * viewAxis;","float x;","x = diff/abs(_dot);","viewPositionOnCylinder = intersection_in + x*ray;","return;","} ","vec3 intersectionProj;","intersectionProj = viewCenterPos + dot(-intersectionToCenter_in, viewAxis)*viewAxis;","viewNormalOnCylinder = normalize(intersection_in - intersectionProj);","viewPositionOnCylinder = intersection_in;","}","void intersectionWithCylinderORTHO() {","float minDistance;","vec3 ray = vec3(0.0,0.0, -1.0);","vec3 viewRayBase = vec3((2.0*(gl_FragCoord.xy/viewport.xy) - 1.0)*rightAndLeft.xy, 0.0);","vec3 cameraToCenter = vec3(0.0,0.0,viewCenterPos.z);","vec3 D = cross(ray, viewAxis);","float lengthD = length(D);","if (lengthD == 0.0) {","minDistance = length(viewRayBase.xy - viewCenterPos.xy);","if (minDistance > radius) {","	toDiscard = true;","	return;","}","viewNormalOnCylinder = -ray;","viewPositionOnCylinder = viewRayBase + cameraToCenter + vec3(0.0,0.0,half_height);","return;","}","D = normalize(D);","minDistance = abs(dot(viewCenterPos - viewRayBase, D));","if (minDistance > radius) {","	toDiscard = true;","	return;","}","float t = -dot(cross(viewRayBase - viewCenterPos, viewAxis), D)/lengthD;","vec3 O = normalize(cross(D, viewAxis));","float s = abs(sqrt(radius2 - minDistance*minDistance)/dot(ray, O));","vec3 intersection_in = viewRayBase + (t-s)*ray;","vec3 intersection_out = viewRayBase + (t+s)*ray;","vec3 intersectionToCenter_in = viewCenterPos - intersection_in;","vec3 intersectionToCenter_out = viewCenterPos - intersection_out;","float dot_in_axis = abs(dot(intersectionToCenter_in, viewAxis));","if (dot_in_axis > half_height) {","if (abs(dot(intersectionToCenter_out, viewAxis)) > half_height && ","dot(intersectionToCenter_in, viewAxis)*dot(intersectionToCenter_out, viewAxis) > 0.0) {","toDiscard = true;","return;","}","float diff = dot_in_axis - half_height;","float _dot = dot(ray, viewAxis);","viewNormalOnCylinder = - sign(_dot) * viewAxis;","float x;","x = diff/abs(_dot);","viewPositionOnCylinder = intersection_in + x*ray;","return;","} ","vec3 intersectionProj;","intersectionProj = viewCenterPos + dot(-intersectionToCenter_in, viewAxis)*viewAxis;","viewNormalOnCylinder = normalize(intersection_in - intersectionProj);","viewPositionOnCylinder = intersection_in;","}"].join("\n"));var g={ComputeCommonValues:["void ComputeCommonValues() {","radius = instancePositionAndRadius.w;","radius2 = radius * radius;","viewAxis = normalize(vec3(vGetViewMatrix()*vec4(cylinderAxis, 0.0)));","half_height = length(cylinderAxis)/2.0;","viewCenterPos = vec3(vGetViewMatrix() * vec4(instancePositionAndRadius.xyz, 1.0));","}"].join("\n"),ComputeVaryingValues:["void ComputeVaryingValues() {","vec4 color;","color.a = instanceColor.y;","color.b = floor(instanceColor.x / 65536.0);","float tmp = instanceColor.x - color.b * 65536.0;","color.g = floor(tmp / 256.0);","color.r = floor(tmp - color.g * 256.0);","color.xyz /= 255.0;","#ifdef GAMMA_INPUT","vaColor = color * color;","#else","vaColor = color;","#endif","mat4 pMatrix = vGetProjectionMatrix();","rightAndLeft = vec2(1.0/pMatrix[0][0], 1.0/pMatrix[1][1]);","}"].join("\n")};if(this._isIE11){g.ProcessViewTangentSpace=["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","vec3 zVec = vec3(0.0,0.0,1.0);","vec3 n_cylinderAxis = normalize(cylinderAxis);","vec3 rotAxis = cross(n_cylinderAxis, zVec);","float s = length(rotAxis);","float c = dot(n_cylinderAxis, zVec);","float t = 1.0 - c;","rotAxis = normalize(rotAxis);","float x = rotAxis.x;","float y = rotAxis.y;","float z = rotAxis.z;","float tx = t*x;","float ty = t*y;","mat4 rotMat = mat4(","vec4(tx * x + c, tx * y - s * z, tx * z + s * y, 0),","vec4(tx * y + s * z, ty * y + c, ty * z - s * x, 0),","vec4(tx * z - s * y, ty * z + s * x, t * z * z + c, 0),","vec4(0.0,0.0,0.0,1.0)",");","vec3 localPosition = vGetAttribPosition();","localPosition.xy *= radius*1.1547;","localPosition.z *= half_height;","localPosition = vec3(rotMat*vec4(localPosition,1.0));","ioWorldViewTS.Position = vec3(vGetWorldViewMatrix()*vec4(instancePositionAndRadius.xyz + localPosition, 1.0));","}"].join("\n")}else{g.ProcessViewTangentSpace=["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","vec3 localPosition = vGetAttribPosition() - vec3(0.5, 0.5, 0.0);","mat4 pMatrix = vGetProjectionMatrix();","bool isPersp = pMatrix[2][3] == -1.0;","vec3 _z;","_z = -sign(dot( -viewCenterPos, viewAxis))*viewAxis;","vec3 C0 = viewCenterPos - half_height*_z;","vec3 C1 = viewCenterPos + half_height*_z;","if (isPersp) {","vec3 v =  - C0;","vec3 _x = normalize(cross(v, _z));","vec3 _y = normalize(cross(_z, _x));","vec3 y_1;","vec3 x_2;","float cos_alpha;","float sin_alpha;","float tan_alpha;","vec3 O_1 = C0 + dot(-C0, _y)*_y;","float OC_L = length(C0 - O_1);","sin_alpha = radius/OC_L;","bool rectBillboard = true;","if (sin_alpha <= 0.5) {","cos_alpha = sqrt(1.0 - sin_alpha*sin_alpha);","tan_alpha = sin_alpha/cos_alpha;","y_1 = radius*_y;","x_2 = (OC_L -radius)*tan_alpha*_x;","rectBillboard = false;","}","float flatCylCoeff = -1.0;","vec3 C0Plus_y = C0+radius*_y;","float z_plane = viewCenterPos.z;","vec3 C0_n = normalize(C0);","vec3 C0_plane = (z_plane/C0_n.z) * C0_n;","vec3 C1_n = normalize(C1);","vec3 C1_plane = (z_plane/C1_n.z) * C1_n;","vec3 Y_y_n = normalize(C0Plus_y);","vec3 Y_plane = (z_plane/Y_y_n.z) * Y_y_n;","float dot_C0_C1_y = dot(C1_plane - C0_plane, Y_plane - C0_plane);","if (dot_C0_C1_y*_y.z < 0.0)","if (dot_C0_C1_y < 0.0) flatCylCoeff = 1.0;","vec3 newMvPosition;","float sgn = sign(localPosition.y);","float inc_coeff = 1.03;","_x*=inc_coeff;","_y*=inc_coeff;","y_1*=inc_coeff;","x_2*=inc_coeff;","if (localPosition.x < 0.0) {","if (rectBillboard) {","newMvPosition = C0 - radius*_y + sgn* radius*_x;","}","else newMvPosition = C0 + flatCylCoeff * radius*_y + sgn* tan_alpha*(radius+OC_L)*_x;","} else {","vec3 point;","if (rectBillboard) {","vec3 ray = normalize(C1 + radius*_y);","float len = dot(viewAxis, C0)/dot(viewAxis, ray);","vec3 intsc = len*ray;","if (dot(intsc, _y) > dot(C0Plus_y, _y)) {","point = intsc;","} else {","point = C0Plus_y;","}","newMvPosition = point + sgn* radius*_x;","}","else newMvPosition = C1 + y_1 + sgn* x_2;","}","ioWorldViewTS.Position = newMvPosition;","} else {","vec3 _y = normalize(vec3(C1.xy-C0.xy,0.0));","vec3 _x = vec3(-_y.y, _y.x, 0.0);","float medZ = 0.5*(C0.z+C1.z);","C0.z = medZ;","C1.z = medZ;","float coeff = 1.03;","float y_radius = 0.0;","if (viewAxis.z != 0.0) {","vec3 orthAxis = normalize(vec3(viewAxis.xy, -dot(viewAxis.xy,viewAxis.xy)/viewAxis.z));","y_radius = radius*abs(dot(orthAxis, _y));","}","if (localPosition.x < 0.0) {","ioWorldViewTS.Position = C0 +coeff*(sign(localPosition.y) *_x*radius - _y*y_radius);","} else {","ioWorldViewTS.Position = C1 + coeff*(sign(localPosition.y) *_x*radius + _y*y_radius);","}","}","}"].join("\n")}var f={ComputeCommonValues:["void ComputeCommonValues() {","mat4 pMatrix = vGetProjectionMatrix();","isPerspective = pMatrix[2][3] == -1.0;","toDiscard = false;","viewport = vec2(vGetViewportSize());","if (isPerspective) intersectionWithCylinderPERSP();","else intersectionWithCylinderORTHO();","}"].join("\n"),ComputeDiscard:["bool ComputeDiscard() {","return toDiscard;","}"].join("\n"),ComputeAlbedo:["vec3 ComputeAlbedo() {","	return vaColor.xyz;","}"].join("\n"),ComputeViewNormal:["vec3 ComputeViewNormal() {","return viewNormalOnCylinder;","}"].join("\n")};if(this._isIE11){f.ComputeViewPosition=["vec3 ComputeViewPosition() {","return viewPositionOnCylinder;","}"].join("\n")}else{f.ComputeViewPosition=["vec3 ComputeViewPosition() {","float linearDepth = -viewPositionOnCylinder.z;","vec3 near_far = vGetNearFarLogFactor();","float near = near_far.x;","float far = near_far.y;","float fragDepth;","if (isPerspective) {","fragDepth = (1.0/linearDepth - 1.0/near)/(1.0/far - 1.0/near);","} else {","fragDepth = (linearDepth - near)/(far - near);","}","vSetFragDepth(fragDepth);","return viewPositionOnCylinder;","}"].join("\n")}j.setPDSFXOverridableFunctions(g,f);return j},setName:function(f){this._name=f},});return UWA.namespace("THREEDS/Nodes/InstancedCylinderImpostorsNode",b)});define("SceneGraphNodes/InstancedCylinderImpostorsNode",["DS/SceneGraphNodes/InstancedCylinderImpostorsNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/InstancedCylinderImpostorsNode");return b});define("DS/VisuLoaders/OBJMTLLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/VisuLoaders/MTLLoader","DS/Visualization/ProxyAbstraction"],function(a,e,b,d){var c=function(){a.EventDispatcher.call(this)};c.prototype={constructor:a.OBJMTLLoader,load:function(l,h,p){var m=this;var n=new d();e.setProxyFromSpec(l,n);var q=l.serverurl?l.serverurl:"";q+=l.filename?l.filename:"";var f;var k;var j;var o=new b(q.substr(0,q.lastIndexOf("/")+1),p);o.addEventListener("load",g);o.addEventListener("error",g);if(h){o.load(h);f=false}else{f=true}function g(r){if(r.type==="load"){if(r.content instanceof b.MaterialCreator){f=true;j=r.content;j.preload()}}else{if(r.type==="error"){f=true}else{var s=r;if(h){k=m.parse(s)}else{k=m.parse(s,function(t){f=false;o.load(o.baseUrl+t)})}}}if(f&&k){if(j){k.traverse(function(t){if(t instanceof a.Mesh){if(t.material.name){var u=j.create(t.material.name);if(u){t.material=u}}}})}m.dispatchEvent({type:"load",content:k})}}n.executeGetHttpRequest(q,"text",null,g,function(){m.dispatchEvent({type:"error",message:"Couldn't load URL ["+q+"]"})})},parse:function(G,F){G=G.replace(/\ \\\r\n/g,"");function h(I,K,J){return new a.Vector3(I,K,J)}function n(J,I){return new a.Vector2(J,I)}function q(J,I,L,K){return new a.Face3(J,I,L,K)}function p(J,I,M,L,K){return new a.Face4(J,I,M,L,K)}function w(I,J){if(l.vertices.length>0){l.mergeVertices();l.computeCentroids();l.computeFaceNormals();l.computeBoundingSphere();H.add(f);l=new a.Geometry();f=new a.Mesh(l,u);j=0}if(I!==undefined){f.name=I}if(J!==undefined){u=new a.MeshLambertMaterial();u.name=J;f.material=u}}var o=new a.Object3D();var H=o;var l=new a.Geometry();var u=new a.MeshLambertMaterial();var f=new a.Mesh(l,u);var m=[];var j=0;var v=[];var r=[];var x=/v( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/;var y=/vn( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/;var C=/vt( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/;var E=/f( +\d+)( +\d+)( +\d+)( +\d+)?/;var D=/f( +(\d+)\/(\d+))( +(\d+)\/(\d+))( +(\d+)\/(\d+))( +(\d+)\/(\d+))?/;var B=/f( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))?/;var A=/f( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))?/;var g=G.split("\n");for(var z=0;z<g.length;z++){var t=g[z];t=t.trim();var s;if(t.length===0||t.charAt(0)==="#"){continue}else{if((s=x.exec(t))!==null){m.push(h(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3])))}else{if((s=y.exec(t))!==null){v.push(h(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3])))}else{if((s=C.exec(t))!==null){r.push(n(parseFloat(s[1]),parseFloat(s[2])))}else{if((s=E.exec(t))!==null){if(s[4]===undefined){l.vertices.push(m[parseInt(s[1])-1],m[parseInt(s[2])-1],m[parseInt(s[3])-1]);l.faces.push(q(j++,j++,j++))}else{l.vertices.push(m[parseInt(s[1])-1],m[parseInt(s[2])-1],m[parseInt(s[3])-1],m[parseInt(s[4])-1]);l.faces.push(p(j++,j++,j++,j++))}}else{if((s=D.exec(t))!==null){if(s[10]===undefined){l.vertices.push(m[parseInt(s[2])-1],m[parseInt(s[5])-1],m[parseInt(s[8])-1]);l.faces.push(q(j++,j++,j++));l.faceVertexUvs[0].push([r[parseInt(s[3])-1],r[parseInt(s[6])-1],r[parseInt(s[9])-1]])}else{l.vertices.push(m[parseInt(s[2])-1],m[parseInt(s[5])-1],m[parseInt(s[8])-1],m[parseInt(s[11])-1]);l.faces.push(p(j++,j++,j++,j++));l.faceVertexUvs[0].push([r[parseInt(s[3])-1],r[parseInt(s[6])-1],r[parseInt(s[9])-1],r[parseInt(s[12])-1]])}}else{if((s=B.exec(t))!==null){if(s[13]===undefined){l.vertices.push(m[parseInt(s[2])-1],m[parseInt(s[6])-1],m[parseInt(s[10])-1]);l.faces.push(q(j++,j++,j++,[v[parseInt(s[4])-1],v[parseInt(s[8])-1],v[parseInt(s[12])-1]]));l.faceVertexUvs[0].push([r[parseInt(s[3])-1],r[parseInt(s[7])-1],r[parseInt(s[11])-1]])}else{l.vertices.push(m[parseInt(s[2])-1],m[parseInt(s[6])-1],m[parseInt(s[10])-1],m[parseInt(s[14])-1]);l.faces.push(p(j++,j++,j++,j++,[v[parseInt(s[4])-1],v[parseInt(s[8])-1],v[parseInt(s[12])-1],v[parseInt(s[16])-1]]));l.faceVertexUvs[0].push([r[parseInt(s[3])-1],r[parseInt(s[7])-1],r[parseInt(s[11])-1],r[parseInt(s[15])-1]])}}else{if((s=A.exec(t))!==null){if(s[10]===undefined){l.vertices.push(m[parseInt(s[2])-1],m[parseInt(s[5])-1],m[parseInt(s[8])-1]);l.faces.push(q(j++,j++,j++,[v[parseInt(s[3])-1],v[parseInt(s[6])-1],v[parseInt(s[9])-1]]))}else{l.vertices.push(m[parseInt(s[2])-1],m[parseInt(s[5])-1],m[parseInt(s[8])-1],m[parseInt(s[11])-1]);l.faces.push(p(j++,j++,j++,j++,[v[parseInt(s[3])-1],v[parseInt(s[6])-1],v[parseInt(s[9])-1],v[parseInt(s[12])-1]]))}}else{if(/^o /.test(t)){H=new a.Object3D();H.name=t.substring(2).trim();o.add(H)}else{if(/^g /.test(t)){w(t.substring(2).trim(),undefined)}else{if(/^usemtl /.test(t)){w(undefined,t.substring(7).trim())}else{if(/^mtllib /.test(t)){if(F){var k=t.substring(7);k=k.trim();F(k)}}else{if(/^s /.test(t)){}else{console.log("THREE.OBJMTLLoader: Unhandled line "+t)}}}}}}}}}}}}}}w(undefined,undefined);return o}};return c});define("DS/VisuLoaders/XMLV6Loader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager"],function(d,f,e,b,a){var c=function(B,r,x,m){var q=B;var y=(typeof x==="undefined")?false:x;var S=(r!==undefined)?r:null;var T=null;var V=null;var O=null;var n;var p=null;var Q=0;var F=0;var W=0;var t=[];var D=[];var X=[];var k=[];var h=[];var L=[];var s=[];var K=[];var H;var P=null;var o=[];var E;var U=m;this.setGeometryMode=function(Z){U=Z};function C(){T=null;V=null;O=null;n="";Q=0;F=0;W=0;t=[];D=[];X=[];k=[];h=[];L=[];s=[];K=[];H="";P=null;o=[];E=null}this.load=function(ab,af,ae,Z){C();n=ab;var ac=ab+"/Manifest.3dxml";if(document.implementation&&document.implementation.createDocument){var ad=new XMLHttpRequest();ad.onreadystatechange=function(){if(ad.readyState===4){if(ad.status===0||ad.status===200){if(ad.responseXML){T=af;V=Z;O=ae;u(ad.responseXML,undefined,ac)}else{console.error("XMLV6Loader: Empty or non-existing file ("+ac+")")}}}};ad.open("GET",ac,true);if(ad.overrideMimeType){ad.overrideMimeType("text/xml")}ad.send(null)}else{alert("Don't know how to parse XML!")}};function u(af){var ad=af.firstChild;if(ad&&ad.childNodes){for(var ac=0;ac<ad.childNodes.length;ac++){var ag=ad.childNodes[ac];switch(ag.nodeName){case"XMLContent":var ae=ag.getAttribute("Domain");var Z=ag.getAttribute("Location");var ab=ag.getAttribute("Name");if(ae==="Geometry"){t.push({path:Z,filename:ab})}else{if(ae==="Material"){s.push(Z+"/"+ab)}else{if(ae==="Link"){h.push(Z+"/"+ab)}else{if(ae==="Product3D"){if(ab==="Product.3dxmlproduct3d"){H=Z+"/"+ab}}}}}break;case"Other":break}}}E=new e();if(h.length){M(0)}}function M(Z){if(Z<h.length){z(Z)}else{v(0)}}function v(Z){if(Z<s.length){N(Z)}else{g()}}function g(){H=n+"/"+H;if(document.implementation&&document.implementation.createDocument){var Z=new XMLHttpRequest();Z.onreadystatechange=function(){if(Z.readyState===4){if(Z.status===0||Z.status===200){if(Z.responseXML){var ac=Z.responseXML.firstChild;if(ac&&ac.childNodes){for(var ap=0;ap<ac.childNodes.length;ap++){var ad=ac.childNodes[ap];if((ad.nodeName!=="Product")&&(ad.nodeName!=="ProductInst")&&(ad.nodeName!=="RepUsage")){continue}var aj=ad.getAttribute("id");var ak=new e();ak.name=aj;ak.getPersistentId=function(){return this.name};switch(ad.nodeName){case"Product":o[aj]=ak;if(P===null){P=ak}break;case"ProductInst":o[aj]=ak;var ao="";var aq="";var am=null;for(var an=0;an<ad.childNodes.length;an++){var ai=ad.childNodes[an];if(ai.nodeName==="Owned"){ao=ai.getAttribute("idref")}else{if(ai.nodeName==="Instancing"){aq=ai.getAttribute("idref")}else{if(ai.nodeName==="RelativeTransformation3D"){for(var al=0;al<ai.childNodes.length;al++){var af=ai.childNodes[al];if(af.nodeName==="Translation3D"){var at=G(af.textContent);if(at.length===3){if(am===null){am=new d.Matrix4()}am.setPosition(new d.Vector3(at[0]*1000,at[1]*1000,at[2]*1000))}}else{if(af.nodeName==="Rotation3D"){var at=G(af.textContent);if(at.length===9){if(am===null){am=new d.Matrix4()}var ae=[at[0],at[3],at[6],at[1],at[4],at[7],at[2],at[5],at[8]];am.setRotation(ae)}}}}}}}}if(am!==null){ak.setMatrix(am)}if((ao!=="")&&(aq!=="")){o[ao].addChild(ak);ak.addChild(o[aq])}break;case"RepUsage":o[aj]=ak;var ao="";var aq="";var ab={};for(var an=0;an<ad.childNodes.length;an++){var ai=ad.childNodes[an];if(ai.nodeName==="Owned"){ao=ai.getAttribute("idref")}else{if(ai.nodeName==="Instancing"){aq=ai.getAttribute("linkidref")}else{if(ai.nodeName==="BoundingBox"){for(var al=0;al<ai.childNodes.length;al++){var ah=ai.childNodes[al];if(ah.nodeName==="MinPoint"){ab.min=G(ah.textContent)}else{if(ah.nodeName==="MaxPoint"){ab.max=G(ah.textContent)}}}}}}}if((ao!=="")&&(aq!=="")){o[ao].addChild(ak);var ar=L[aq].target;D[ar]=ak;if(ab.min!==undefined){X[ak.name]=ar}else{k.push(ar)}F++;W++}if((ab.min!==undefined)&&(ab.max!==undefined)){var ag=l(ab);ak.addChild(ag)}break;default:break}}if(P!==null){E.addChild(P)}}}else{console.error("XMLV6Loader: Empty or non-existing file ("+H+")")}J()}}};Z.open("GET",H,true);if(Z.overrideMimeType){Z.overrideMimeType("text/xml")}Z.send(null)}else{alert("Don't know how to parse XML!")}}function z(Z){var ac=n+"/"+h[Z];if(document.implementation&&document.implementation.createDocument){var ab=new XMLHttpRequest();ab.onreadystatechange=function(){if(ab.readyState===4){if(ab.status===0||ab.status===200){if(ab.responseXML){var ae=ab.responseXML.firstChild;if(ae&&ae.childNodes){var ad=0;while(ad<ae.childNodes.length){if(ae.childNodes[ad].nodeName==="Links"){ae=ae.childNodes[ad];break}ad++}if(ae&&ae.childNodes){for(var ad=0;ad<ae.childNodes.length;ad++){var ai=ae.childNodes[ad];if(ai.nodeName==="Link"){var af=ai.getAttribute("Source");var ag=ai.getAttribute("Target");var ah=ai.getAttribute("id");L[ah]={source:af,target:ag}}}}}M(Z+1)}else{console.error("XMLV6Loader: Empty or non-existing file ("+ac+")")}}}};ab.open("GET",ac,true);if(ab.overrideMimeType){ab.overrideMimeType("text/xml")}ab.send(null)}else{alert("Don't know how to parse XML!")}}function N(ab){var Z=n+"/"+s[ab];if(document.implementation&&document.implementation.createDocument){var ac=new XMLHttpRequest();ac.onreadystatechange=function(){if(ac.readyState===4){if(ac.status===0||ac.status===200){if(ac.responseXML){var ae=ac.responseXML.firstChild;if(ae&&ae.childNodes){var ad=0;while(ad<ae.childNodes.length){if(ae.childNodes[ad].nodeName==="AppliedAppearanceGroup"){ae=ae.childNodes[ad];break}ad++}if(ae&&ae.childNodes){var af=new a();for(var ad=0;ad<ae.childNodes.length;ad++){var ai=ae.childNodes[ad];if(ai.nodeName==="AppliedAppearance"){var ah=ai.getAttribute("id");var ag=j(ai);K[ah]=af.createMaterial(ag,n+"/resources","XMLV6")}}}}v(ab+1)}else{console.error("XMLV6Loader: Empty or non-existing file ("+Z+")")}}}};ac.open("GET",Z,true);if(ac.overrideMimeType){ac.overrideMimeType("text/xml")}ac.send(null)}else{alert("Don't know how to parse XML!")}}function j(ag){var ah={};var af=null;for(var aj=0;aj<ag.childNodes.length;aj++){if(ag.childNodes[aj].nodeName==="ShadingModel"){af=ag.childNodes[aj];break}}if(af){for(var aj=0;aj<af.childNodes.length;aj++){var ae=af.childNodes[aj];switch(ae.nodeName){case"IlluminationModel":if(ae.textContent==="PHONG"){ah.shading="Phong"}break;case"DiffuseColor":ah.colorDiffuse=A(ae.textContent);break;case"SpecularColor":ah.colorSpecular=A(ae.textContent);break;case"AmbientColor":ah.colorAmbient=A(ae.textContent);break;case"SpecularCoefficient":ah.specularCoef=parseFloat(ae.textContent);break;case"SpecularExponent":ah.shininess=128*parseFloat(ae.textContent);break;case"ReflectivityCoefficient":ah.reflectivityCoef=parseFloat(ae.textContent);break;case"TransparencyCoefficient":ah.transparency=parseFloat(ae.textContent);ah.transparent=(ah.transparency>0);break;case"DiffuseMap":case"ReflectionMap":var ac=-1;var ab=-1;var ad=-1;var Z=-1;var am=1;var al=1;ah[ae.nodeName+"Wrap"]=[];for(var ai=0;ai<ae.childNodes.length;ai++){var ak=ae.childNodes[ai];switch(ak.nodeName){case"WrappingU":ac=(ak.textContent==="REPEAT")?1:0;break;case"WrappingV":ab=(ak.textContent==="REPEAT")?1:0;break;case"FlipU":ad=(ak.textContent==="true")?1:-1;break;case"FlipV":Z=(ak.textContent==="true")?1:-1;break;case"ScaleU":am=parseFloat(ak.textContent);break;case"ScaleV":al=parseFloat(ak.textContent);break;case"MapFile":ah[ae.nodeName]=L[ak.textContent].target;break;default:break}}if((ac>=0)||(ab>=0)){if(ac===1){ah[ae.nodeName+"Wrap"][0]="repeat"}if(ab===1){ah[ae.nodeName+"Wrap"][1]="repeat"}ah[ae.nodeName+"Repeat"]=[ac,ab];if(am!==1){ah[ae.nodeName+"Repeat"][0]=am}if(al!==1){ah[ae.nodeName+"Repeat"][1]=al}}if(ad===1){ah[ae.nodeName+"Wrap"][0]="mirror"}if(Z===1){ah[ae.nodeName+"Wrap"][1]="mirror"}break;default:break}}}return ah}function A(ab){var ad=[];var ac=new RegExp(/RGB\(\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*\)/i);var Z=ac.exec(ab);if(Z!==null){ad[0]=parseFloat(RegExp.$1);ad[1]=parseFloat(RegExp.$2);ad[2]=parseFloat(RegExp.$3)}else{ac=new RegExp(/RGBA\(\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*\)/i);Z=ac.exec(ab);if(Z!==null){ad[0]=parseFloat(RegExp.$1);ad[1]=parseFloat(RegExp.$2);ad[2]=parseFloat(RegExp.$3);ad[3]=parseFloat(RegExp.$4)}}return ad}function J(){if(p!==null){p.terminate();p=null}if(p===null){if(U==="3dxmlgeometry"){p=new Worker(f.getWebappsBaseUrl()+"Workers/XMLV6Worker.js")}else{p=new Worker(f.getWebappsBaseUrl()+"Workers/CGRWorker.js")}p.onmessage=function(af){var ae=af.data;var ag=D[ae.node];Q--;F--;if(ag){var ad=null;if(ae.rep.length>0){ad=R(ae.rep)}else{ad=I()}ag.removeChild(ag.getChildByName("BBox"));ag.addChild(ad);ag.setVisibility(true)}if(O!==null){O({loaded:W-F,total:W})}if(S!==null){S({hack:true,updateInfinitePlane:true})}if(!F&&(V!==null)){V()}}}Q+=k.length;for(var ab=0;ab<k.length;ab++){var ac=k[ab];if(ac!==undefined){var Z=n+"/3dxmlcontent/"+ac;if(ac!==""){if(p){p.postMessage({path:Z,node:ac})}}}}if(T){T(E)}}this.loadGeometryFiles=function(ac){var ad=Math.min(ac.length,1);Q+=ad;for(var ab=0;ab<ad;ab++){var ae=X[ac[ab].name];if(ae!==undefined){var Z=n+"/3dxmlcontent/"+ae;if(ae!==""){if(p){p.postMessage({path:Z,node:ae})}}delete X[ac[ab].name]}}};this.isWebWorkerBusy=function(){return(Q>0)};function R(ak){var Z=null;var ag=[];var af=null;var at=null;var av=new d.Sphere();var ab=new d.Box3();var ai=new a();for(var ar=0;ar<ak.length;ar++){var ac=ak[ar];var ah=new d.BufferGeometryDS();var an=new d.Vector3(ac.AABB.min[0],ac.AABB.min[1],ac.AABB.min[2]);var aq=new d.Vector3(ac.AABB.max[0],ac.AABB.max[1],ac.AABB.max[2]);if(af===null){af=an}if(at===null){at=aq}if(an.x<af.x){af.x=an.x}if(an.y<af.y){af.y=an.y}if(an.z<af.z){af.z=an.z}if(aq.x>at.x){at.x=aq.x}if(aq.y>at.y){at.y=aq.y}if(aq.z>at.z){at.z=aq.z}ab.set(af,at);av.radius=at.clone().sub(af).multiplyScalar(0.5).length();av.center=at.clone().add(af).multiplyScalar(0.5);for(var ap=0;ap<ac.drawingGroups.length;ap++){ac.drawingGroups[ap].geometry=ah;var al=ac.drawingGroups[ap].gas;var aj=ac.drawingGroups[ap].material;if(aj!==null){aj=aj.id}if((aj!==null)&&L[aj]){var am=L[aj].target;var au=[];au=am.split("#");ac.drawingGroups[ap].gas=K[au[1]]}else{if(al!==null){var ao=new d.Color();ao.setRGB(al.color.r,al.color.g,al.color.b);ac.drawingGroups[ap].gas=ai.getMaterialFromGAS({color:ao,opacity:al.opacity,lineWidth:(al.lineWidth?al.lineWidth:al.linewidth),solid:al.solid})}}}ah.drawingGroups=ac.drawingGroups;ah.vertexPositionArray=ac.vertexPositionArray;if(ac.vertexNormalArray!==null){ah.vertexNormalArray=ac.vertexNormalArray}if(ac.vertexUvArray!==null){ah.vertexUvArray=ac.vertexUvArray}ah.vertexIndexArray=ac.vertexIndexArray;ag.push(ah)}var ae=new d.Color();ae.setRGB(ak[0].gas.fill.color.r,ak[0].gas.fill.color.g,ak[0].gas.fill.color.b);var ad=new d.Color();ad.setRGB(ak[0].gas.line.color.r,ak[0].gas.line.color.g,ak[0].gas.line.color.b);var aj=ai.getMaterialFromGAS({color:ae,opacity:ak[0].gas.fill.opacity,solid:ak[0].gas.fill.solid});aj.line=ai.getMaterialFromGAS({color:ad,opacity:ak[0].gas.line.opacity,lineWidth:(ak[0].gas.line.lineWidth?ak[0].gas.line.lineWidth:ak[0].gas.line.linewidth)});ag.boundingSphere=av;ag.boundingBox=ab;Z=new d.Mesh(ag,aj);Z.matrixAutoUpdate=false;Z.castShadow=true;Z.receiveShadow=true;return new b(Z)}function I(){var ab=new d.BufferGeometryDS();ab.boundingSphere=new d.Sphere();ab.boundingBox=new d.Box3();var Z=new d.MeshPhongMaterial();var ac=new d.Mesh(ab,Z);ac.matrixAutoUpdate=false;ac.castShadow=true;ac.receiveShadow=true;return new b(ac)}function G(ae){var ab=Y(ae);var ad=[];for(var ac=0,Z=ab.length;ac<Z;ac++){ad.push(parseFloat(ab[ac]))}return ad}function Y(Z){return(Z.length>0)?w(Z).split(/\s+/):[]}function w(Z){return Z.replace(/^\s+/,"").replace(/\s+$/,"")}function l(Z){var ad=new d.BufferGeometryDS();var ae=new Float32Array(72);var aj=new Float32Array(72);var ac=new Uint16Array(36);var ao=0;var am=0;var al=0;for(var ap=0;ap<6;ap++){ac[am++]=al;ac[am++]=al+1;ac[am++]=al+2;ac[am++]=al;ac[am++]=al+2;ac[am++]=al+3;al+=4}for(var ag=0;ag<12;ag+=3){aj[ao+ag]=0;aj[ao+ag+1]=-1;aj[ao+ag+2]=0}ae[ao++]=Z.min[0];ae[ao++]=Z.min[1];ae[ao++]=Z.min[2];ae[ao++]=Z.max[0];ae[ao++]=Z.min[1];ae[ao++]=Z.min[2];ae[ao++]=Z.max[0];ae[ao++]=Z.min[1];ae[ao++]=Z.max[2];ae[ao++]=Z.min[0];ae[ao++]=Z.min[1];ae[ao++]=Z.max[2];for(var ag=0;ag<12;ag+=3){aj[ao+ag]=0;aj[ao+ag+1]=1;aj[ao+ag+2]=0}ae[ao++]=Z.min[0];ae[ao++]=Z.max[1];ae[ao++]=Z.min[2];ae[ao++]=Z.min[0];ae[ao++]=Z.max[1];ae[ao++]=Z.max[2];ae[ao++]=Z.max[0];ae[ao++]=Z.max[1];ae[ao++]=Z.max[2];ae[ao++]=Z.max[0];ae[ao++]=Z.max[1];ae[ao++]=Z.min[2];for(var ag=0;ag<12;ag+=3){aj[ao+ag]=0;aj[ao+ag+1]=0;aj[ao+ag+2]=1}ae[ao++]=Z.max[0];ae[ao++]=Z.max[1];ae[ao++]=Z.max[2];ae[ao++]=Z.min[0];ae[ao++]=Z.max[1];ae[ao++]=Z.max[2];ae[ao++]=Z.min[0];ae[ao++]=Z.min[1];ae[ao++]=Z.max[2];ae[ao++]=Z.max[0];ae[ao++]=Z.min[1];ae[ao++]=Z.max[2];for(var ag=0;ag<12;ag+=3){aj[ao+ag]=0;aj[ao+ag+1]=0;aj[ao+ag+2]=-1}ae[ao++]=Z.min[0];ae[ao++]=Z.min[1];ae[ao++]=Z.min[2];ae[ao++]=Z.min[0];ae[ao++]=Z.max[1];ae[ao++]=Z.min[2];ae[ao++]=Z.max[0];ae[ao++]=Z.max[1];ae[ao++]=Z.min[2];ae[ao++]=Z.max[0];ae[ao++]=Z.min[1];ae[ao++]=Z.min[2];for(var ag=0;ag<12;ag+=3){aj[ao+ag]=1;aj[ao+ag+1]=0;aj[ao+ag+2]=0}ae[ao++]=Z.max[0];ae[ao++]=Z.min[1];ae[ao++]=Z.min[2];ae[ao++]=Z.max[0];ae[ao++]=Z.max[1];ae[ao++]=Z.min[2];ae[ao++]=Z.max[0];ae[ao++]=Z.max[1];ae[ao++]=Z.max[2];ae[ao++]=Z.max[0];ae[ao++]=Z.min[1];ae[ao++]=Z.max[2];for(var ag=0;ag<12;ag+=3){aj[ao+ag]=-1;aj[ao+ag+1]=0;aj[ao+ag+2]=0}ae[ao++]=Z.min[0];ae[ao++]=Z.min[1];ae[ao++]=Z.max[2];ae[ao++]=Z.min[0];ae[ao++]=Z.max[1];ae[ao++]=Z.max[2];ae[ao++]=Z.min[0];ae[ao++]=Z.max[1];ae[ao++]=Z.min[2];ae[ao++]=Z.min[0];ae[ao++]=Z.min[1];ae[ao++]=Z.min[2];var af=new a();var ar=af.getMaterialFromGAS({color:new d.Color(16729156),opacity:0});ad.drawingGroups=[];ad.drawingGroups.push({start:0,count:36,glType:4,gas:ar});var ak=new d.Vector3(Z.min[0],Z.min[1],Z.min[2]);var an=new d.Vector3(Z.max[0],Z.max[1],Z.max[2]);var ab=an.clone().sub(ak).multiplyScalar(0.5).length();var aq=an.clone().add(ak).multiplyScalar(0.5);ad.boundingSphere=new d.Sphere(aq,ab);ad.boundingBox=new d.Box3(ak,an);ad.vertexPositionArray=ae;ad.vertexNormalArray=aj;ad.vertexIndexArray=ac;var ah=new d.Mesh(ad,ar);ah.matrixAutoUpdate=false;var ai=new b(ah,"BBox");return ai}};return c});define("DS/SceneGraphNodes/HemisphereLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(c,a){var b=a.extend({init:function(f,e){var d=new c.HemisphereLight(f.color,f.groundColor,f.intensity);this._groundColor=f.groundColor;this._parent(d,e);return this},attachToViewpoint:function(d){return null},setGroundColor:function(d){if(!d instanceof c.Color){this._groundColor=new c.Color(hex)}else{this._groundColor=d}this._updateGroundColor()},_updateGroundColor:function(){var e,f,d;this.light3js.groundColor=this._groundColor;e=this._occurrences.length;for(var d=0;d<e;d++){f=this._occurrences[d];f.renderable.groundColor=this._groundColor}},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"HemisphereLightNode3D"}});return UWA.namespace("THREEDS/Nodes/HemisphereLight",b)});define("SceneGraphNodes/HemisphereLightNode",["DS/SceneGraphNodes/HemisphereLightNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/HemisphereLightNode");return b});define("DS/Visualization/XMLV6Loader",["DS/VisuLoaders/XMLV6Loader"],function(a){return a});define("Visualization/XMLV6Loader",["DS/Visualization/XMLV6Loader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/XMLV6Loader");return b});define("DS/Visualization/SpriteNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],function(c,d,a){var b=d.extend({init:function(e,f){this._parent(f);this.anchor=e;var g=this;this.cbInit=function(j){var h=new c.Matrix4().lookAt(j.cameraEye,j.cameraTarget,j.cameraUp);h.setPosition(g.anchor);g.setMatrix(h)};this.cbChange=function(j){if(j.eventType==="@onViewpointChange"){var h=new c.Matrix4().lookAt(j.cameraEye,j.cameraTarget,j.cameraUp);h.setPosition(g.anchor);g.setMatrix(h)}};return this},_onLinkedToSceneGraph:function(){this.tokenInit=a.subscribe({event:"/VISU/SpriteNodeInit"},this.cbInit);this.tokenChange=a.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){a.unsubscribe(this.tokenInit);a.unsubscribe(this.tokenChange)},getNodeType:function(){return"SpriteNode3D"}});return UWA.namespace("THREEDS/Nodes/Sprite",b)});define("Visualization/SpriteNode3D",["DS/Visualization/SpriteNode3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/SpriteNode3D");return b});define("DS/Plugins/MaskPass",["DS/Visualization/ThreeJS_DS"],function(a){return null});define("Plugins/MaskPass",["DS/Plugins/MaskPass","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Plugins/MaskPass");return b});define("DS/Robot/CustomReferenceAxisSystem",["DS/Visualization/Node3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/Visualization/ThreeJS_DS"],function(d,a,b){var c=d.extend({init:function(g,f){f=f||{};this._parent("customReferenceAxisSystem");this._subscribedEvents=[];this.viewer=g;this.ratio=f.ratio||7;this.fixedSizeNode3D=new a({name:"fixedSizeNode3D",ratio:this.ratio});this.addChild(this.fixedSizeNode3D);this.fixedSizeNode3D.addChild(f.node);this.fixedSizeNode3D.setCameraName("robotCameraOrtho");this.node=f.node;this.removeGeomTypes=f.removeGeomTypes;this.getPosition=f.getPosition||function(k,j){return{x:2*(k-100)/k-1,y:Math.max(2*100/j-1,-0.85)}};this.notifyNodesHierarchyUpdate();var h=this;var e=this.viewer.currentViewpoint.onMove(function(){h.onViewpointChange()});this._subscribedEvents.push({object:this.viewer.currentViewpoint,token:e});e=this.viewer.onViewerResize(function(){h.onViewpointChange()});this._subscribedEvents.push({object:this.viewer,token:e})},setRatio:function(e){this.fixedSizeNode3D.setRatio(e)},notifyNodesHierarchyUpdate:function(){var e=this;this.fixedSizeNode3D.traverse(function(h){if(h.getNodeType()==="Mesh3D"){h.excludeFromHighlight(true,true);h.setShadow(false);h.setFrustumCulled(false);h.excludeFromCSO(true);if(e.removeGeomTypes&&h.mesh3js&&h.mesh3js.geometry){var g;for(g=0;g<h.mesh3js.geometry.length;g++){var f;var k=h.mesh3js.geometry[g];for(f=0;f<k.drawingGroups.length;f++){k.drawingGroups[f]._geomType=0}}}}})},onViewpointChange:function(){var g=this.viewer.currentViewpoint;if(!g){return}g._updateRobotCamera(this.viewer.internalSceneGraph);var j,k,e;e=this.getPosition(this.viewer.canvas.width,this.viewer.canvas.height);k=e.x;j=e.y;function h(l,s){var p=g.robotCameraOrtho;var o=new b.Vector3(l,s,0);var r=new b.Projector();r.unprojectVector(o,p);var q;if(p instanceof b.PerspectiveCamera){var n=new b.Ray(data.cameraEye,o.sub(data.cameraEye).normalize());var m=new b.Plane(this.viewer.currentViewpoint.camera.getLookAt(),0);q=n.intersectPlane(m)}else{q=o}return new b.Matrix4().setPosition(q)}var f;f=h(k,j);this.setMatrix(f)},_dispose:function(){var f,e;for(f=0;f<this._subscribedEvents.length;f++){e=this._subscribedEvents[f];e.object.unsubscribe(e.token)}this._subscribedEvents=[]},CallBackEventHandlerViewPoint:function(){this.onViewpointChange.apply(this,arguments)}});return c});define("DS/SceneGraphNodes/TubeLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(b,a){var c=a.extend({init:function(e,d){var f=new b.TubeLight(e.color,e.intensity,e.radius,e.width);this._radius=f.radius;this._width=f.width;this._parent(f,d);return this},setRadius:function(d){if(d){this._radius=d}this._updateRadius()},_updateRadius:function(){var e,f,d;this.light3js.radius=this._radius;e=this._occurrences.length;for(var d=0;d<e;d++){f=this._occurrences[d];f.renderable.radius=this._radius}},setWidth:function(d){if(d){this._width=d}this._updateWidth()},_updateWidth:function(){var e,f,d;this.light3js.width=this._width;e=this._occurrences.length;for(var d=0;d<e;d++){f=this._occurrences[d];f.renderable.width=this._width}},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"TubeLightNode3D"}});return UWA.namespace("THREEDS/Nodes/TubeLight",c)});define("SceneGraphNodes/TubeLightNode",["DS/SceneGraphNodes/TubeLightNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/TubeLightNode");return b});define("DS/Plugins/UserClearPass",["DS/Plugins/UserPass","DS/Plugins/ClearPass"],function(a,d){function b(e){return e?true:false}"use strict";var c=a.extend({init:function(f){this._parent(f);var e=new d("_UserClearPass_"+this.id+"_"+this.name);e.defaults.clear=false;e.clear=false;this._passes.push(e)},setClearDepth:function(e){this._passes[0].defaults.doClearDepth=b(e)},setClearStencil:function(e,f){if(f!==undefined){this._passes[0].clearStencilValue=f}this._passes[0].clearStencil=e}});return c});define("DS/Plugins/UserPassManager",["UWA/Class","DS/Plugins/UserRenderPass","DS/Plugins/UserClearPass","DS/Plugins/UserRenderList","DS/Plugins/UserPass","DS/Plugins/UserSceneGraphPass"],function(d,c,h,e,a,f){var b=d.extend({init:function(j){this.viewer=j;this._activeUserPasses=[];this._activeRenderLists=null;this._updateRenderLists()},createUserRenderPass:function(j,k){var l=new c({manager:this,name:j,renderList:k});if(k){this._setUserPassRenderList(l,k)}return l},createUserClearPass:function(j,l){var k=new h({manager:this,name:j,renderList:l});if(l){this._setUserPassRenderList(k,l)}return k},createUserSceneGraphPass:function(j,l){var k=new f({manager:this,name:j,renderList:l});if(l){this._setUserPassRenderList(k,l)}return k},getSystemPass:function(j){var k=g[j];return k||null},insertUserPassAfterPass:function(l,j){if(l._systemPass){console.warn("ERROR: Invalid arguments");return}if(l._inserted){console.warn("ERROR: Already inserted pass");return}var k;if(j instanceof a){k=j._passes[j._passes.length-1]}else{k=j._list}if(this._getMainComposer().insertCustomPassAfterNEW(l._passes,k)){l._inserted=true;this._activeUserPasses.push(l);this._updateRenderLists()}},insertUserPassBeforePass:function(l,j){if(l._systemPass){console.warn("ERROR: Invalid arguments");return}if(l._inserted){console.warn("ERROR: Already inserted pass");return}var k;if(j instanceof a){k=j._passes[0]}else{k=j._list}if(this._getMainComposer().insertCustomPassBeforeNEW(l._passes,k)){l._inserted=true;this._activeUserPasses.push(l);this._updateRenderLists()}},removeUserPass:function(k){var j=this._activeUserPasses.indexOf(k);if(j>=0){this._getMainComposer().removeCustomPassNEW(k._passes);this._activeUserPasses.splice(j,1);k._inserted=false;this._updateRenderLists()}},_setUserPassRenderList:function(l,k){var j;for(j=0;j<l._passes.length;j++){l._passes[j].idString=k._getIdString()}},_updateRenderLists:function(){var k,l;this._activeRenderLists=["main","noz","afterHighlightNoZ"];for(k=0;k<this._activeUserPasses.length;k++){l=this._activeUserPasses[k];if(l.renderList&&l.enabled){var j=l.renderList._getIdString();if(this._activeRenderLists.indexOf(j)<0){this._activeRenderLists.push(j)}}}},_getActiveRenderLists:function(){return this._activeRenderLists},_getMainComposer:function(){return this.viewer.renderer.mainComposer},_dispose:function(){this.viewer=null;this._activeUserPasses=null;this._activeRenderLists=null}});var g={infinitePlane:{_list:"infPlane",_systemPass:true},main:{_list:"main",_systemPass:true},noz:{_list:"noz",_systemPass:true},afterHighlightNoz:{_list:"afterHighlightNoz",_systemPass:true},robot:{_list:"robot",_systemPass:true},canvas2D:{_list:"noEffectCanvas2DPass",_systemPass:true}};return b});define("DS/Effects/ComputeSDFFontMergeTiles",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/NothingShader","DS/Shaders/PreComputeSDFFontIterativeShaders"],function(d,b,f,c,e,g){var a=b.extend({init:function(j,h){this._parent(j);this.renderer=j;this.rtPool=h;this.width=512;this.height=512;this.tileMin=new d.Vector2();this.tileMax=new d.Vector2();this.realTileMax=new d.Vector2();this.map=null;this.passMergeTile=null;this.passNothing=null;return this},setSize:function(j,h){this.width=parseInt(j);this.height=parseInt(h)},setTileInfos:function(m,k,l,j,h,n){this.tileMin.set(m/this.width,k/this.height);this.tileMax.set((m+l)/this.width,(k+j)/this.height);this.realTileMax.set((m+h)/this.width,(k+n)/this.height);if(this.passMergeTile){this.passMergeTile.uniforms.tileMin.value=this.tileMin;this.passMergeTile.uniforms.tileMax.value=this.tileMax;this.passMergeTile.uniforms.realTileMax.value=this.realTileMax}},setInput:function(h){if(!h){return}this.map=h;if(this.composers[0]){this.composers[0].setSize(this.width,this.height)}else{var j=new d.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers[0]=new f(this.renderer,j,this.rtPool);this.composers[0].composerContext.keepResult=true;this.passMergeTile=new c(g.MergeTiles);this.passMergeTile.renderToScreen=false;this.passNothing=new c(e);this.composers[0].addPass(this.passMergeTile);this.composers[0].addPass(this.passNothing)}this.map.linkToShaderPassUniform(this.passMergeTile,this.passMergeTile.uniforms.tDiffuse2)},execute:function(){this.composers[0].render()}});return a});define("DS/Visualization/LensFlareNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(a,b){var c=b.extend({init:function(e,d){this._parent(d);this.lensflare3js=(e!==undefined)?e:new a.ParticleSystem();e=this.createRenderable();var f=this._occurrences[0];f.renderable=e;f.renderable.name=this.name;f.renderable._occurrence=f;return this},createRenderable:function(){var d=this.lensflare3js.clone();d.matrixAutoUpdate=false;d.matrixWorldNeedsUpdate=false;d.visible=this.lensflare3js.visible;d.pickable=false;d.drawInHLRender=false;d.enableNormalDepth=false;return d},add:function(){return false},getNodeType:function(){return"LensFlareNode3D"}});return UWA.namespace("THREEDS/Nodes/LensFlare",c)});define("Visualization/LensFlareNode3D",["DS/Visualization/LensFlareNode3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/LensFlareNode3D");return b});define("DS/Effects/SpatialOccupationEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ClearPass"],function(d,b,e,a,f){var c=b.extend({init:function(l,h){this._parent(l.renderer.renderer);var k;switch(h.filtering){case"linear":k="uint";break;case"nearest":k="uintNearest";break;default:k="uintNearest";break}var g=h.name?h.name:"offScreenPass";this.viewer=l;this.renderer=l.renderer.renderer;var j=l.renderer.renderTargetPool;this.sceneGraph=l.internalSceneGraph;this.viewpoint=l.viewpoints[0];this.width=h.targetWidth?h.targetWidth:l.SCREEN_WIDTH;this.height=h.targetHeight?h.targetHeight:l.SCREEN_HEIGHT;this.renderTarget=new d.WebGLRenderTargetProperties(this.width,this.height,k);this.composers.push(new e(this.renderer,this.renderTarget,j));this.composers[0].composerContext.keepResult=false;this.renderPass=new a(null,null,null,undefined,undefined,undefined,g);this.renderPass.idString=g;this.renderPass.setMaterialToUse(d.MaterialToUse.pickingMaterial);this.clearPass=new f("customClearPass");this.composers[0].addPass(this.clearPass);this.composers[0].addPass(this.renderPass);this.composers[0].composerContext.enablePass(this.renderPass,true);this.renderPass.setScene(this.sceneGraph.scene);this.composers[0].composerContext.setPassClear(this.clearPass,true,new d.Color(0),1);this.renderPass.renderFaces=this.renderer.renderFaces;this.renderPass.renderLineMode=this.renderer.renderLineMode;this.renderPass.renderPoints=this.renderer.renderPoints;this.renderPass.renderSurfacicPoints=this.renderer.renderSurfacicPoints;return this},renderResult:function(s){this._setSize(this.width,this.height);this.composers[0].updateScene(this.sceneGraph.scene);var n=this.renderer.context;var g={main:this.viewpoint._renderedCamera,connectedRobotCamera:this.viewpoint.connectedRobotCamera,robotCameraOrtho:this.viewpoint.robotCameraOrtho};var m=this.viewpoint._renderedCamera.pixelCulling;this.viewpoint.setPixelCulling(m*Math.min(this.width/this.viewer.SCREEN_WIDTH,this.height/this.viewer.SCREEN_HEIGHT));this.composers[0].render(undefined,undefined,g,"main");this.viewpoint.setPixelCulling(m);var q=new Uint8Array(4*this.width*this.height);n.readPixels(0,0,this.width,this.height,n.RGBA,n.UNSIGNED_BYTE,q);if(s.flipImage){var h=this.width;var r=this.height;var p=new Array();for(var l=0;l<r;l++){for(var k=0;k<h;k++){for(var o=0;o<4;o++){p.push(q[h*4*(r-1-l)+4*k+o])}}}return{data:p,width:h,height:r,}}else{return{data:q,width:this.width,height:this.height,}}},_setSize:function(h,g){this._parent(h,g);this.composers[0].setSize(h,g);this.width=h;this.height=g},});return c});define("Effects/SpatialOccupationEffect",["DS/Effects/SpatialOccupationEffect","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Effects/SpatialOccupationEffect");return b});define("DS/Shaders/SSAO2Shader",["DS/Visualization/ThreeJS_DS"],function(b){var a={computeVertexPositionVS:["vec4 normalDepth = texture2D( tNormalDepth, vUv );","float z = normalDepth.w;","if ( z == 0.0 ) return;","vec2 xy = vUv * 2.0 - 1.0;","vec4 vertexPositionProjected = vec4( xy, 2.0 * z - 1.0, 1.0 );","vec4 vertexPositionVS = realProjectionMatrixInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","vertexPositionVS.w = 1.0;"].join("\n"),computeNormal:["vec3 normal = vec3(0.0, 0.0, 1.0);","if (dot(normalDepth.xy, normalDepth.xy) > 0.000001) {","   normal.z = 2.0 * dot(normalDepth.xy, normalDepth.xy) - 1.0;","   normal.xy = normalize(normalDepth.xy) * sqrt(1.0 - normal.z * normal.z);","}"].join("\n")},c={uniforms:{tNormalDepth:{type:"t",value:null},tRandomTex:{type:"t",value:null},realProjectionMatrix:{type:"m4",value:new b.Matrix4()},realProjectionMatrixInverse:{type:"m4",value:new b.Matrix4()},nbSamples:{type:"i",value:12},kernel:{type:"fv",value:[]},kernelRadius:{type:"fv1",value:[]},radius:{type:"f",value:0.5},thresholdAngle:{type:"f",value:0.071}},vertexShader:["varying vec2 vUv;","void main() {","  vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform mat4 realProjectionMatrix;","uniform mat4 realProjectionMatrixInverse;","uniform float radius;","uniform int nbSamples;","uniform vec3 kernel[32];","uniform float kernelRadius[32];","uniform float thresholdAngle;","uniform sampler2D tNormalDepth;","uniform sampler2D tRandomTex;","varying vec2 vUv;","const float fov = 0.7853981634;","const int kernelSize = 32;","const float PI = 3.14159265358979323846264;","const float one_over_tan_225 = 2.414213562373095;","float random(vec3 scale, float seed) {","  return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","vec2 getScreenPos(vec3 pos) {","  vec4 offset = realProjectionMatrix * vec4(pos, 1.0);","  offset.xy /= offset.w;","  offset.xy = offset.xy * 0.5 + 0.5;","  return offset.xy;","}","void main() {","  vec2 screenPos = vUv;","  gl_FragColor = vec4( 1.0 );",a.computeVertexPositionVS,a.computeNormal,"  vec3 origin = vertexPositionVS.xyz;","  float minRadius = - one_over_tan_225 * radius / origin.z;","  float scaleRadius = max(1.0, 0.1 / minRadius);","  minRadius = scaleRadius * radius;","  float occlusion = 0.0;","  vec3 randVec = texture2D( tRandomTex, mod(gl_FragCoord.xy, 256.0) * vec2(1.0/256.0, 1.0/256.0) ).xyz;","  randVec = normalize(2.0 * randVec - 1.0);","  for (int i = 0; i < kernelSize; ++i) {","    if (i >= nbSamples) { continue; }","    vec3 svec = reflect(kernel[i], randVec);","    float angle = dot(svec, normal);","    float randRadius = minRadius * sign(angle);","    randRadius *= kernelRadius[i];","    vec3 sample = origin + randRadius * svec;","    vec2 sampleScreenPos = getScreenPos(sample);","    bvec4 inScreen4 = bvec4(sampleScreenPos.x >= 0.0, sampleScreenPos.x <= 1.0, sampleScreenPos.y >= 0.0, sampleScreenPos.y <= 1.0);","    if(!all(inScreen4)) { continue; }","    vec4 normalDepth = texture2D( tNormalDepth, sampleScreenPos );","    float z = normalDepth.w;","    if (z > 0.0) {","      vec2 xy = sampleScreenPos * 2.0 - 1.0;","      vec4 posProjected = vec4(xy, 2.0 * z - 1.0, 1.0);","      vec4 posVS = realProjectionMatrixInverse * posProjected;","      float sampleBufferDepth = posVS.z / posVS.w;","      float range_check = abs(origin.z - sampleBufferDepth);","      if (range_check < minRadius && sampleBufferDepth > sample.z && angle > thresholdAngle) {","        float l = range_check / minRadius;","        occlusion += 1.0 / (l*l + 1.0);","      }","    }","  }","  occlusion = 1.0 - occlusion / float(nbSamples);","  gl_FragColor = vec4( vec3(occlusion), 1.0 );","}"].join("\n")};return c});define("Shaders/SSAO2Shader",["DS/Shaders/SSAO2Shader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/SSAO2Shader");return b});define("DS/Gestures/TwoFingerTapGesture",["DS/Gestures/BasicGesture"],function(b){var a=b.extend({init:function(){this._parent();this.priority=100;this.name="TwoFingerTapGesture";return this},detect:function(c){this._parent(c)}});return UWA.namespace("THREEDS/Gestures/TwoFingerTapGesture",a)});define("Gestures/TwoFingerTapGesture",["DS/Gestures/TwoFingerTapGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/TwoFingerTapGesture");return b});define("DS/Shaders/SSAOIterativeShader",["DS/Visualization/ThreeJS_DS"],function(b){var c={computeVertexPositionVS:["vec4 normalDepth = texture2D( tNormalDepth, vUv );","float z = normalDepth.w;","if ( z == 0.0 ) return;","vec2 xy = vUv * 2.0 - 1.0;","vec4 vertexPositionProjected = vec4(xy, 2.0 * z - 1.0, 1.0);","vec4 vertexPositionVS = realProjectionMatrixInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","vertexPositionVS.w = 1.0;"].join("\n"),computeNormal:["vec3 normal = vec3(0.0, 0.0, 1.0);","if (dot(normalDepth.xy, normalDepth.xy) > 0.000001) {","   normal.z = 2.0 * dot(normalDepth.xy, normalDepth.xy) - 1.0;","   normal.xy = normalize(normalDepth.xy) * sqrt(1.0 - normal.z * normal.z);","}"].join("\n")},a={uniforms:{tNormalDepth:{type:"t",value:null},prevMap:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new b.Matrix4()},screenMin:{type:"f",value:1000},screenRatio:{type:"f",value:0.5},numIteration:{type:"f",value:0},firstSample:{type:"i",value:0},radius:{type:"f",value:0.5},thresholdAngle:{type:"f",value:0.071}},vertexShader:["varying vec2 vUv;","void main() {","  vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform mat4 realProjectionMatrixInverse;","uniform float screenMin;","uniform float screenRatio;","uniform float radius;","uniform float thresholdAngle;","uniform float numIteration;","uniform int firstSample;","uniform sampler2D tNormalDepth;","uniform sampler2D prevMap;","varying vec2 vUv;","const float PI = 3.14159265358979323846264;","const float one_over_tan_225 = 2.414213562373095;","const float sigma = 0.25;","float HaltonSequence(int n, int base) {","float val = 0.0;","float invBase = 1.0 / float(base);","float invBi = invBase;","for (int i = 0; i < 32; i++) {","if (n == 0) break;","float d_i = mod(float(n), float(base));","val += float(d_i) * invBi;","n /= base;","invBi *= invBase;","}","return val;","}","vec2 LowDiscrepancy2D(int index) {","vec2 res;","res.x = HaltonSequence(index, 2);","res.y = HaltonSequence(index, 5);","return res;","}","float random(vec3 scale, float seed) {","  return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","float Random1D(float seed) {","return random(vec3(12.9898, 78.233, 151.7182), seed);","}","void main() {","  gl_FragColor = vec4(1.0);",c.computeVertexPositionVS,c.computeNormal,"  vec3 origin = vertexPositionVS.xyz;","  float projRadius = - 0.5 * one_over_tan_225 * radius / origin.z;","  float minDelta = projRadius / 12.0;","  float scaleRadius = max(1.0, (8.0 / screenMin) / minDelta);","  projRadius *= scaleRadius;","  float newRadius = scaleRadius * radius;","  float newRadius2 = newRadius * newRadius;","  float occlusion = 0.0;","  float phi = 100.0 * Random1D(vUv.x + vUv.y);","  for (int i = 0; i < 8; ++i) {","	 vec2 E = LowDiscrepancy2D(firstSample + i);","	 E *= vec2(2.0 * PI, projRadius);","	 E += vec2(phi, 0.1 * projRadius);","    vec2 u = vec2(screenRatio * cos(E.x), sin(E.x));","	 vec2 uvSample = vUv + E.y * u;","    float z = texture2D(tNormalDepth, uvSample).w;","    bvec4 inScreen4 = bvec4(uvSample.x >= 0.0, uvSample.x <= 1.0, uvSample.y >= 0.0, uvSample.y <= 1.0);","    bool inScreen = all(inScreen4);","    if (all(bvec2(inScreen, z > 0.0))) {","      vec4 posProjected = vec4(uvSample * 2.0 - 1.0, 2.0 * z - 1.0, 1.0);","      vec4 posVS = realProjectionMatrixInverse * posProjected;","      posVS.xyz /= posVS.w;","      vec3 Vi = posVS.xyz - origin;","      occlusion += max(0.0, dot(normalize(Vi), normal) - thresholdAngle) * max(0.0, newRadius2 - dot(Vi, Vi)) / (newRadius2 + 0.0001);","    }","  }","  occlusion = max(0.0, 1.0 - 2.0 * sigma * (2.0 - 1.0 * abs(normal.z)) * occlusion / 8.0);","  float prevAO = texture2D( prevMap, vUv ).r;","  gl_FragColor = vec4(vec3((prevAO * numIteration + occlusion) / (numIteration + 1.0)), 1.0);","}"].join("\n")};return a});define("DS/Effects/SSAOIterativeEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/SSAOIterativeShader","DS/Shaders/MultiplicativeBlendShader","DS/Shaders/NothingShader"],function(g,b,d,e,c,a,j,f){var h=d.extend({init:function(p,o){var r=this._parent(p);var q=new g.WebGLRenderTargetProperties(this.width,this.height,"linear");this.influenceRadius=0.2;var m=new e(p,q,o);m.composerContext.keepResult=true;this.composers.push(m);this.effectSSAO=new c(a);var n=new c(f);this.composers[0].addPass(this.effectSSAO);this.composers[0].addPass(n);this.mixPass=new c(j,undefined,"SSAOIterativeEffect");var k=new Uint8Array(2*2*4);for(var l=0;l<2*2;l++){k[4*l]=0;k[4*l+1]=0;k[4*l+2]=0;k[4*l+3]=255}this.initTexture=new g.DataTexture(k,2,2,g.RGBAFormat,g.UnsignedByteType,new g.LatLongReflectionMapping(),g.ClampToEdgeWrapping,g.ClampToEdgeWrapping,g.LinearFilter,g.LinearFilter);this.initTexture.generateMipmaps=false;this.initTexture.needsUpdate=true;this.renderer.setTexture(this.initTexture,0);this.setStrength(0.95);return this},initEffect:function(l,m){var k=m.getComposer("normalDepth");k.linkToShaderPassUniform(this.effectSSAO,this.effectSSAO.uniforms.tNormalDepth);m.insertComposer(this.composers[0],this.mixPass);this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2);this.mixPass.addRequiredComposer(this.composers[0])},update:function(s,l,o,p){o._renderedCamera.projectionMatrixInverse.getInverse(o._renderedCamera.projectionMatrix);this.effectSSAO.uniforms.realProjectionMatrixInverse.value=o._renderedCamera.projectionMatrixInverse;var n=l.getBoundingSphere(),r=this.influenceRadius*n.radius,k=(new g.Vector3().subVectors(o.target,o._renderedCamera.position)).length(),q=this.influenceRadius*k*Math.tan(0.5*o._renderedCamera.fov*(Math.PI/180));r=(r>q)?q:r;this.effectSSAO.uniforms.radius.value=r;this.effectSSAO.uniforms.numIteration.value=p;this.effectSSAO.uniforms.firstSample.value=8*p;this.effectSSAO.uniforms.prevMap.value=!p?this.initTexture:this.composers[0].composerContext.renderTarget2;var m=Math.min(8*p,this.getMaxIteration())/this.getMaxIteration();this.setStrength(Math.min(1,Math.max(0,0.95*m)))},setStrength:function(l){var k=Math.min(Math.max(l,0.000001),1);this.mixPass.uniforms.strength.value=Math.log(k)+0.7},setThresholdAngle:function(k){this.effectSSAO.uniforms.thresholdAngle.value=Math.cos(k)},setRadius:function(k){this.influenceRadius=Math.max(0,Math.min(k,1))},setSize:function(m,k){var l=this._parent(m,k);if(!l){return}this.composers[0].setSize(this.width,this.height);this.effectSSAO.uniforms.screenMin.value=Math.min(this.width,this.height);this.effectSSAO.uniforms.screenRatio.value=this.height/this.width},getMaxIteration:function(){return 64}});return h});define("DS/Shaders/CopyShader",["DS/Visualization/ThreeJS_DS"],function(a){var b={uniforms:{tDiffuse:{type:"t",value:null},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",a._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")};return b});define("Shaders/CopyShader",["DS/Shaders/CopyShader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Shaders/CopyShader");return b});define("DS/Visualization/BoundingBoxGPUCompute",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(a,b){var c=a.extend({init:function(d){this.renderer=d;this.minMaxExtension=b.supportedExtensions.minMaxBlending;this.useBackUpAlgorithm=true;this._pixels=this.useBackUpAlgorithm?1:32;this.renderTarget=null;this.zRenderTarget=null;this.zMaterial=null;this.material=null;this._useUnindexed=((new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent)!=null));return this},setPixelCount:function(d){this._pixels=d;if(this.renderTarget){_initRenderTarget()}},_initMaterial:function(){var g=new b.ParticleBasicMaterial();g.sizeAttenuation=false;g.fog=false;g.activatePDSFX();var d={orientationMatrix:{type:"m4",value:new b.Matrix4()}};g.setPDSFXUniforms(d);var f={vPos:{type:"v3"}};g.setPDSFXVaryings(f);var e={ComputeVaryingValues:["void ComputeVaryingValues() {","vPos=vec3(orientationMatrix * modelMatrix * vec4( position, 1.0 )).xyz;","float xPos = fract(sin(vPos.z)*1000.0)*2.0-1.0;","gl_Position=vec4(xPos,0.0,0.0,1.0);","}"].join("\n"),ComputeObjectTexCoord0:["vec4 ComputeObjectTexCoord0() {","	return vec4(0.0,0.0, 0.0, 0.0);","}"].join("\n"),ComputeObjectNormal:["vec3 ComputeObjectNormal() {","	return vec3(0.0,0.0,1.0);","}"].join("\n")};var h={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor.xyz = vPos;","}"].join("\n")};g.setPDSFXOverridableFunctions(e,h);return g},_initBackUpMaterial:function(){var g=new b.ParticleBasicMaterial();g.sizeAttenuation=false;g.fog=false;g.activatePDSFX();var d={composante:{type:"v3",value:new b.Vector3()},orientationMatrix:{type:"m4",value:new b.Matrix4()},zMin:{type:"f",value:0},zMax:{type:"f",value:0},};g.setPDSFXUniforms(d);var f={vZ:{type:"f"}};g.setPDSFXVaryings(f);var e={ComputeVaryingValues:["void ComputeVaryingValues() {","vZ=dot(composante,vec3(orientationMatrix * modelMatrix * vec4( position, 1.0 )));","gl_Position=vec4(0.0,0.0,2.0*(vZ)/(zMax-zMin)-(zMin+zMax)/(zMax-zMin),1.0);","}"].join("\n"),ComputeObjectTexCoord0:["vec4 ComputeObjectTexCoord0() {","	return vec4(0.0,0.0, 0.0, 0.0);","}"].join("\n"),ComputeObjectNormal:["vec3 ComputeObjectNormal() {","	return vec3(0.0,0.0,1.0);","}"].join("\n")};var h={ProcessFinalColor:["float shift_right(float v, float amt) {","v = floor(v) + 0.5;","return floor(v / exp2(amt));","}","float shift_left(float v, float amt) {","return floor(v * exp2(amt) + 0.5);","}","float mask_last(float v, float bits) {","return mod(v, shift_left(1.0, bits));","}","float extract_bits(float num, float from, float to) {","from = floor(from + 0.5);","to = floor(to + 0.5);","return mask_last(shift_right(num, from), to - from);","}","vec4 encode_float(float val) {","if (val == 0.0)","return vec4(0, 0, 0, 0);","float sign = val > 0.0 ? 0.0 : 1.0;","val = abs(val);","float exponent = floor(log2(val));","float biased_exponent = exponent + 127.0;","float fraction = ((val / exp2(exponent)) - 1.0) * 8388608.0;","float t = biased_exponent / 2.0;","float last_bit_of_biased_exponent = fract(t) * 2.0;","float remaining_bits_of_biased_exponent = floor(t);","float byte4 = extract_bits(fraction, 0.0, 8.0) / 255.0;","float byte3 = extract_bits(fraction, 8.0, 16.0) / 255.0;","float byte2 = (last_bit_of_biased_exponent * 128.0 + extract_bits(fraction, 16.0, 23.0)) / 255.0;","float byte1 = (sign * 128.0 + remaining_bits_of_biased_exponent) / 255.0;","return vec4(byte4, byte3, byte2, byte1);","}","void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = encode_float(vZ);","}"].join("\n")};g.setPDSFXOverridableFunctions(e,h);return g},_initRenderTarget:function(){if(this.useBackUpAlgorithm){var d={minFilter:b.NearestFilter,magFilter:b.NearestFilter,type:b.UnsignedByteType,format:b.RGBAFormat};this.renderTarget=new b.WebGLRenderTarget(6,this._pixels,d)}else{var d={minFilter:b.NearestFilter,magFilter:b.NearestFilter,type:b.FloatType,format:b.RGBAFormat};this.renderTarget=new b.WebGLRenderTarget(this._pixels,2,d)}},_initZRenderTarget:function(){var d={minFilter:b.NearestFilter,magFilter:b.NearestFilter,type:b.UnsignedByteType,format:b.RGBAFormat};this.zRenderTarget=new b.WebGLRenderTarget(1,1,d)},_render:function(n,l){var y=new b.Scene();var r=new b.OrthographicCamera();var h=this.renderTarget;var x=false;var g=true;var m=false;var u=false;var s=new b.StateSortingResult();s.init();var d=new b.DisplayList({name:"MYPOINT",priority:0,zSort:b.FrontToBack,side:b.Constants.DoubleSide,polygonOffset:false});s.addDisplayList(d);var t=new b.DisplayRangeList(l,null);d._displayRangeLists[0]=t;var w=d._materialList;var o={material:l,occurrenceRenderingOverride:null,id:0,occurrenceRenderingOverrideId:-1};w[d.usefulListLength++]=o;var k=[];var f=0;for(var q=0;q<n.length;q++){var e=n[q];for(var p=0;p<e.obj.length;p++){var v=e.obj[p];k[f++]=v.glType;v.glType=0;var z={0:e.renderable,1:v.geometry,2:v,3:v.start,4:v.count,next:null};if(t.first===null){t.first=t.last=z}else{t.last.next=z;t.last=z}}}this.renderer.renderer.currentPass={isOITPass:false};this.renderer.renderer.render(y,r,this.renderTarget,x,g,s,m,u);this.renderer.renderer.currentPass=null;for(var q=n.length-1;q>=0;q--){var e=n[q];for(var p=e.obj.length-1;p>=0;p--){var v=e.obj[p];v.glType=k[--f]}}},_drawBBDGs:function(f){var h=true;var g=new b.OrthographicCamera();for(var e=0;e<f.length;e++){var m=f[e];for(var d=0;d<m.obj.length;d++){var l=m.obj[d];var k=l.glType;l.glType=0;this.renderer.renderer.renderInterval(g,[],null,m.renderable,this.material,null,l.geometry,l,l.start,l.count,null,null,h,null);l.glType=k;h=false}}},_drawBBDGsDepth:function(n,d,s,g,e){if(!this.material){this.material=this._initBackUpMaterial()}this.material.updatePDSFXUniform("orientationMatrix",d);this.material.updatePDSFXUniform("composante",e);this.material.updatePDSFXUniform("zMin",s);this.material.updatePDSFXUniform("zMax",g);this.material.id++;var t=true;var o=new b.OrthographicCamera();if(!this._useUnindexed){for(var m=0;m<n.length;m++){var f=n[m];if(!f.renderable._modelViewMatrix){f.renderable._modelViewMatrix=new b.Matrix4()}for(var k=0;k<f.obj.length;k++){var r=f.obj[k];var h=r.glType;r.glType=0;this.renderer.renderer.renderInterval(o,[],null,f.renderable,this.material,null,r.geometry,r,r.start,r.count,null,null,t,null);r.glType=h;t=false}}}else{for(var m=0;m<n.length;m++){var l=n[m].renderable;if(!l._modelViewMatrix){l._modelViewMatrix=new b.Matrix4()}for(var k=0;k<l.geometry.length;k++){var q=l.geometry[k];var p=0;if(q.vertexPositionArray){p=q.compressedVertices?q.vertexPositionArray.length/2:q.vertexPositionArray.length/3}else{p=q.verticeCount}var r={glType:0,start:0,count:p,nonIndexed:true};this.renderer.renderer.renderInterval(o,[],null,l,this.material,null,q,r,r.start,r.count,null,null,t,null);t=false}}}},_drawZMinDGsDepth:function(d,o,e){if(!this.zMaterial){this.zMaterial=this._initBackUpMaterial()}this.zMaterial.updatePDSFXUniform("orientationMatrix",new b.Matrix4());this.zMaterial.updatePDSFXUniform("composante",new b.Vector3(0,0,1));this.zMaterial.updatePDSFXUniform("zMin",o);this.zMaterial.updatePDSFXUniform("zMax",e);this.zMaterial.id++;var p=true;var k=new b.OrthographicCamera();for(var h=0;h<d.length;h++){var g=d[h];if(!g._modelViewMatrix){g._modelViewMatrix=new b.Matrix4()}for(var f=0;f<g.geometry.length;f++){var n=g.geometry[f];var m=0;if(n.vertexPositionArray){m=n.compressedVertices?n.vertexPositionArray.length/2:n.vertexPositionArray.length/3}else{m=n.verticeCount}var l={glType:0,start:0,count:m,nonIndexed:true};this.renderer.renderer.renderInterval(k,[],null,g,this.zMaterial,null,n,l,l.start,l.count,null,null,p,null);p=false}}},_setRendererState:function(){var e,g;var h=this.renderer.gl.getParameter(this.renderer.gl.SCISSOR_BOX);g=this.renderer.renderer.getViewport();e=this.renderer.renderer.getScissorTest();var f=this.renderer.renderer.enablerenderPluginsPre;this.renderer.renderer.enableRenderPluginsPre=false;var j=this.renderer.renderer.renderPoints;this.renderer.renderer.renderPoints=true;this.renderer.renderer.materialToUse=0;var k=this.renderer.renderer._oldDepthTest;var d={scissor:e,scissorValue:h,viewport:g,enablerenderpluginsPre:f,renderPoints:j,depthTest:k};return d},_resetRendererState:function(e){this.renderer.renderer.setViewport(e.viewport.x,e.viewport.y,e.viewport.width,e.viewport.height);this.renderer.renderer.enableScissorTest(e.scissor);this.renderer.renderer.setScissor(e.scissorValue[0],e.scissorValue[1],e.scissorValue[2],e.scissorValue[3]);this.renderer.renderer.renderPoints=e.renderPoints;this.renderer.renderer.setDepthTest(e.depthTest);this.renderer.renderer.enableRenderPluginsPre=e.enablerenderpluginsPre;var f=this.renderer.renderer.getClearColor();var d=this.renderer.renderer.getClearAlpha();this.renderer.gl.clearColor(f.r,f.g,f.b,d)},computeZMinGPU:function(l,k){if(!this.zRenderTarget){this._initZRenderTarget()}this.renderer.renderer.setRenderTarget(this.zRenderTarget);var e=this._setRendererState();var f=l.getSceneBoundingSphere();if(f.pixelRadius>0){var j=l.currentViewpoint.camera;var d=j.getWorldSizeFromPixelSize(1,f.center,l.div.clientHeight);if(typeof j.fullWidth!=="undefined"&&j.fullWidth>0){var h=Math.max(j.width*1/j.fullWidth,j.height*1/j.fullHeight);d*=h}f.radius+=d*f.pixelRadius}var g=this._computeZMin(k,f);this._resetRendererState(e);return g},computeBoundingBoxGPU:function(g,l,e){if(!e){e=new b.Matrix4()}var f=new b.Matrix4().getInverse(e);if(!this.renderTarget){this._initRenderTarget()}this.renderer.renderer.setRenderTarget(this.renderTarget);var m=this._setRendererState();var n=g.getSceneBoundingSphere();n.center.applyMatrix4(f);if(n.pixelRadius>0){var h=g.currentViewpoint.camera;var d=h.getWorldSizeFromPixelSize(1,n.center,g.div.clientHeight);if(typeof h.fullWidth!=="undefined"&&h.fullWidth>0){var k=Math.max(h.width*1/h.fullWidth,h.height*1/h.fullHeight);d*=k}n.radius+=d*n.pixelRadius}var j;if(this.useBackUpAlgorithm){j=this._computeBoundingBoxBackUp(l,f,n)}else{j=this._computeBoundingBoxMain(l,f,n)}this._resetRendererState(m);return j},_computeBoundingBoxMain:function(n,j,o){this.renderer.gl.clearColor(o.center.x+o.radius*2,o.center.y+o.radius*2,o.center.z+o.radius*2,1);this.renderer.renderer.clear();this.renderer.renderer.setDepthTest(false);this.renderer.gl.enable(this.renderer.gl.BLEND);this.renderer.gl.blendEquation(this.minMaxExtension.MIN_EXT);this.renderer.renderer.setViewport(0,0,this._pixels,1);if(!this.material){this.material=this._initMaterial()}this.material.updatePDSFXUniform("orientationMatrix",j);this.material.blendEquation=b.MinEquation;this._drawBBDGs(n);this.renderer.gl.blendEquation(this.minMaxExtension.MAX_EXT);this.renderer.renderer.setViewport(0,1,this._pixels,1);this.renderer.renderer.enableScissorTest(true);this.renderer.renderer.setScissor(0,1,this._pixels,1);this.renderer.gl.clearColor(o.center.x-o.radius*2,o.center.y-o.radius*2,o.center.z-o.radius*2,1);this.renderer.renderer.clear();this.material.blendEquation=b.MaxEquation;this._drawBBDGs(n);var l=new Float32Array(4*this._pixels*2);this.renderer.gl.readPixels(0,0,this._pixels,2,this.renderer.gl.RGBA,this.renderer.gl.FLOAT,l);var h=l[0];var g=l[1];var f=l[2];var m=this._pixels*4;var e=l[m];var d=l[m+1];var p=l[m+2];for(var k=1;k<this._pixels;k++){h=Math.min(h,l[k*4]);g=Math.min(g,l[k*4+1]);f=Math.min(f,l[k*4+2]);e=Math.max(e,l[m+k*4]);d=Math.max(d,l[m+k*4+1]);p=Math.max(p,l[m+k*4+2])}return new b.Box3(new b.Vector3(h,g,f),new b.Vector3(e,d,p))},_computeZMin:function(g,d){this.renderer.gl.clearColor(0,0,0,0);this.renderer.renderer.clear();this.renderer.gl.disable(this.renderer.gl.BLEND);this.renderer.renderer.setDepthTest(true);this.renderer.gl.depthFunc(this.renderer.gl.LESS);var h=d.center.z;this._drawZMinDGsDepth(g,h-d.radius,h+d.radius);this.renderer.gl.depthFunc(this.renderer.gl.LEQUAL);this.renderer.renderer.setViewport(0,0,1,1);var f=new Uint8Array(4*1);this.renderer.gl.readPixels(0,0,1,1,this.renderer.gl.RGBA,this.renderer.gl.UNSIGNED_BYTE,f);var e=new Float32Array(f.buffer);return e[0]},_computeBoundingBoxBackUp:function(r,k,s){this.renderer.gl.clearColor(0,0,0,0);this.renderer.renderer.clear();this.renderer.gl.disable(this.renderer.gl.BLEND);this.renderer.renderer.setDepthTest(true);this.renderer.gl.depthFunc(this.renderer.gl.LEQUAL);for(var n=0;n<6;n++){this.renderer.renderer.setViewport(n,0,1,this._pixels);var h=new b.Matrix4();var l=new b.Vector3(0,0,1);var p=s.center.z;if(n==1){l.set(1,0,0);p=s.center.x}else{if(n==2){l.set(0,1,0);p=s.center.y}else{if(n==3){this.renderer.gl.depthFunc(this.renderer.gl.GEQUAL);this.renderer.gl.clearDepth(-1);this.renderer.renderer.clear(false,true,false)}else{if(n==4){l.set(1,0,0);p=s.center.x}else{if(n==5){l.set(0,1,0);p=s.center.y}}}}}this._drawBBDGsDepth(r,k,p-s.radius,p+s.radius,l)}this.renderer.gl.clearDepth(1);this.renderer.gl.depthFunc(this.renderer.gl.LEQUAL);var q=new Uint8Array(4*6*this._pixels);this.renderer.gl.readPixels(0,0,6,this._pixels,this.renderer.gl.RGBA,this.renderer.gl.UNSIGNED_BYTE,q);var o=new Float32Array(q.buffer);var f=o[0];var j=o[1];var g=o[2];var t=o[3];var e=o[4];var d=o[5];for(var n=1;n<this._pixels;n++){f=Math.min(f,o[n*6]);j=Math.min(j,o[n*6+1]);g=Math.min(g,o[n*6+2]);t=Math.max(t,o[n*6+3]);e=Math.max(e,o[n*6+4]);d=Math.max(d,o[n*6+5])}return new b.Box3(new b.Vector3(j,g,f),new b.Vector3(e,d,t))},});return UWA.namespace("THREEDS/BoundingBoxGPUCompute",c)});define("DS/Shaders/FlipXShader",["DS/Visualization/ThreeJS_DS"],function(a){var b={uniforms:{tDiffuse:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",a._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","    gl_FragColor = texture2D(tDiffuse, vec2(1.0 - vUv.x, vUv.y));","}"].join("\n")};return b});define("DS/Manipulators/ManipulatorManager",["UWA/Class","DS/CoreEvents/Events","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/Visualization/TrackballControls","DS/Manipulators/Manipulator"],function(a,c,e,k,g,b){var h=5;var l=function(m){if(h!==0){console.log("[Manipulator] Manipulate method does not define the intersection argument anymore.\nIf you really need the picking result, you have to explicitly call setPickingDuringManipulation(true) on your manipulator.\n"+m.stack);h--}};var f=function(m,n){this._path=null;this._position=null;this._normal=null;this._tangent=null;this._uv=null;this._ray=null;this.__viewer=m;this.__event=n};var j=function(m){l(new Error());if(!m._path&&m.__viewer&&m.__event){var p;if(!m.__event.gesture){p=m.__event.from[0]}else{var o=m.__event.gesture.getEvents();p=o[0]}var n=m.__viewer.getMousePosition(p.getCurrentPosition(m.__viewer.canvas));n.event=p;var q=m.__viewer.pick(n,"mesh",true);m._path=q.path;m._position=q.position;m._normal=q.normal;m._tangent=q.tangent;m._uv=q.uv;m._ray=q.ray}};Object.defineProperty(f.prototype,"path",{get:function(){j(this);return this._path}});Object.defineProperty(f.prototype,"position",{get:function(){j(this);return this._position}});Object.defineProperty(f.prototype,"normal",{get:function(){j(this);return this._normal}});Object.defineProperty(f.prototype,"tangent",{get:function(){j(this);return this._tangent}});Object.defineProperty(f.prototype,"uv",{get:function(){j(this);return this._uv}});Object.defineProperty(f.prototype,"ray",{get:function(){j(this);return this._ray}});var d=a.extend({init:function(m){this.viewer=m;this.enabled=true;this.preActivation=true;this.manipulatedManipulators={};this.hoveredManipulator=null;this._attachEvents()},getActivate:function(){return this.enabled},setActivate:function(m){this.enabled=m},setPreActivate:function(m){this.preActivation=m},isInManipulation:function(r,n){for(var o in this.manipulatedManipulators){var q=this.manipulatedManipulators[o];var m=q.links[o];if(r&&(!m||(m.states.manipulateState===b.State.END))){continue}var p=(!n&&!q.getPickingInManipulation())||(n&&!q.getPrePickingDuringManipulation());if(p){return true}}return false},isPreActivationDisabledOnManipulatedManipulators:function(){for(var n in this.manipulatedManipulators){var o=this.manipulatedManipulators[n];var m=o.links[n];if(!m||(m.states.manipulateState===b.State.END)){continue}if(!o.getPreActivationDuringManipulation()){return true}}return false},_attachEvents:function(){var m=this;this.onPrimaryPointerEventCB=function(n){m._resetManipulatedManipulators();n.viewer=m.viewer;m._onEdit.call(m,n,1)};e.addEvent(document,"onPrimaryPointerDownUnique",this.onPrimaryPointerEventCB);this.onLeftClickCB=function(n){n.viewer=m.viewer;m._resetManipulatedManipulators();m._onLeftClick.call(m,n)};e.addEvent(document,"onPrimaryPointerClick",this.onLeftClickCB);this.onLeftDoubleClickCB=function(n){n.viewer=m.viewer;m._resetManipulatedManipulators();m._onLeftDoubleClick.call(m,n)};e.addEvent(document,"onPrimaryPointerDoubleClick",this.onLeftDoubleClickCB);this.onEditCB=function(n){n.viewer=m.viewer;m._resetManipulatedManipulators();m._onEdit.call(m,n,0)};e.addEvent(document,"onEdit",this.onEditCB);this.onSmartEditCB=function(n){n.viewer=m.viewer;m._resetManipulatedManipulators();m._onEdit.call(m,n,2)};e.addEvent(document,"onSmartEdit",this.onSmartEditCB);this.onMouseMoveCB=function(n){n.viewer=m.viewer;m._onMove.call(m,n,true)};e.addEvent(document,"onMouseMove",this.onMouseMoveCB);this.onSwipeCB=function(n){n.viewer=m.viewer;m._onMove.call(m,n,false)};e.addEvent(this.viewer.div,"onSwipe",this.onSwipeCB);this.onLeftMouseUpCB=function(n){n.viewer=m.viewer;m._onRelease.call(m,n)};e.addEvent(document,"onLeftMouseUp",this.onLeftMouseUpCB);this.onReleaseCB=function(n){n.viewer=m.viewer;m._onRelease.call(m,n)};e.addEvent(document,"onRelease",this.onReleaseCB);this.onEditEvent=c.subscribe({event:"/VISU/onEdit"},function(n){n.viewer=m.viewer});this.onMouseMoveEvent=c.subscribe({event:"/VISU/onMouseMove"},function(n){n.viewer=m.viewer});this.onSwipeEvent=c.subscribe({event:"/VISU/onSwipe"},function(n){n.viewer=m.viewer});this.onLeftMouseUpEvent=c.subscribe({event:"/VISU/onLeftMouseUp"},function(n){n.viewer=m.viewer});this.onReleaseEvent=c.subscribe({event:"/VISU/onRelease"},function(n){n.viewer=m.viewer});this.onLongHoldCB=function(n){n.viewer=m.viewer;m._onLongHold.call(m,n)};e.addEvent(document,"onLongHold",this.onLongHoldCB)},_detachEvents:function(){e.removeEvent(document,"onPrimaryPointerDownUnique",this.onPrimaryPointerEventCB);e.removeEvent(document,"onPrimaryPointerClick",this.onLeftClickCB);e.removeEvent(document,"onPrimaryPointerDoubleClick",this.onLeftDoubleClickCB);e.removeEvent(document,"onLongHold",this.onLongHoldCB);e.removeEvent(document,"onEdit",this.onEditCB);e.removeEvent(document,"onMouseMove",this.onMouseMoveCB);e.removeEvent(this.viewer.div,"onSwipe",this.onSwipeCB);e.removeEvent(document,"onLeftMouseUp",this.onLeftMouseUpCB);e.removeEvent(document,"onRelease",this.onReleaseCB)},_addToManipulators:function(n,m){if(this.manipulatedManipulators[m]){return}this.manipulatedManipulators[m]=n},_resetManipulatedManipulators:function(){for(var m in this.manipulatedManipulators){var o=this.manipulatedManipulators[m];var n=o.links[m];if(!n||(n.states.manipulateState===b.State.END)){delete (this.manipulatedManipulators[m])}}},_applyToManipulatorsOverPointer:function(x,y,z,p){if(!this.viewer||!this.viewer.canvas){return}var u,n;var o;if(!x.gesture){o=x.from[0]}else{var m=x.gesture.getEvents();o=m[0]}u=this.viewer.getMousePosition(p?o.getStartPosition(this.viewer.canvas):o.getCurrentPosition(this.viewer.canvas));u.event=o;if(this.viewer.currentViewpoint!==null){var w=o.isInView([this.viewer.canvas,this.viewer.divCssElement]);if(w){n=this.viewer.pick(u,"mesh",true)}var r;var v;if(w&&n.path.length){var q=n.path[0]._getRenderableOccurrences(this.viewer);if(q.length!==1){return}var s=q[0];var t=false;if(s._manipulators){for(r in s._manipulators){var v=s._manipulators[r];if(v.active){t=true;y.call(this,v,r,n)}}if(t){return}}}if(w){for(r in this.viewer._manipulators){v=this.viewer._manipulators[r];if(v.active){y.call(this,v,r,n);return}}}if(z){z.call(this,n)}}},_applyToManipulatedManipulators:function(u,v,s){var n=null;var q;var o;if(!u.gesture){o=u.from[0]}else{var m=u.gesture.getEvents();o=m[0]}q=this.viewer.getMousePosition(o.getCurrentPosition(this.viewer.canvas));q.event=o;if(this.viewer.currentViewpoint!==null){var p;for(p in this.manipulatedManipulators){var r=this.manipulatedManipulators[p];var t=r.links[p];if(!t||(t.states.manipulateState===b.State.END)){continue}if(r.active){if(s||r.getPickingDuringManipulation()){n=this.viewer.pick(q,"mesh",true)}v.call(this,r,p,n)}}}},_onLeftClick:function(m){if(!this.enabled){return}this._applyToManipulatorsOverPointer(m,function(q,n,r){var o=q.links[n];if(!o){return}var p=o.states.manipulateState;if((p===b.State.NONE)||(p===b.State.END)){q.PrimaryPointerClick(o.path?o.path:o.node,m,r)}})},_onLeftDoubleClick:function(m){if(!this.enabled){return}this._applyToManipulatorsOverPointer(m,function(q,n,r){var o=q.links[n];if(!o){return}var p=o.states.manipulateState;if((p===b.State.NONE)||(p===b.State.END)){q.PrimaryPointerDoubleClick(o.path?o.path:o.node,m,r)}})},_onEdit:function(o,q){if(!this.enabled){return}var n=true;var m=false;var p=false;var r=false;this._applyToManipulatorsOverPointer(o,function(z,u,t){var x=null;if(this.viewer.currentViewpoint){x=this.viewer.currentViewpoint.control}var v=!z._selectionAllowed&&(q===1)&&z.hasPriority;var y=!z._selectionAllowed&&!q&&!z.hasPriority;var B=z._selectionAllowed&&(q===2);if(v||y||B){var A=z.links[u];if(!A){return}var s=A.states.manipulateState;if((s===b.State.NONE)||(s===b.State.END)){if(n){n=false;for(var w in this.manipulatedManipulators){m=true}}if(m){return}z.BeginManipulate(A.path?A.path:A.node,o,t);A.states.manipulateState=b.State.BEGIN;this._addToManipulators(z,u);if(!r&&!z.noCursorChange){this.viewer.setCursor("Grab");r=true}}}if(z._selectionAllowed&&(q===1)){x&&x._onStopManip(o)}if(!z._selectionAllowed&&(q===1)&&!z.hasPriority){if(x&&!p&&!x._showSpinnerOnHold){x._onEditEventBegin(o);p=true}}},null,(q===2))},_onMove:function(n,o){if(!this.enabled){return}var m=o&&this.viewer&&this.preActivation&&!this.isPreActivationDisabledOnManipulatedManipulators()&&(!this.viewer.pPicking.disableWhileMoving||(this.viewer.pPicking.disableWhileMoving&&this.viewer.currentViewpoint&&!this.viewer.currentViewpoint.isMoving()));if(m){this._applyToManipulatorsOverPointer(n,function(r,p,s){if(r.active){var q=r.links[p];if(!q){return}if(!this.hoveredManipulator){r.preactivated.path=s.path[0];r.BeginPreactivate(q.path?q.path:q.node,n,s);q.states.preActivateState=b.State.BEGIN;this.hoveredManipulator={token:p,manip:r}}else{if(p!==this.hoveredManipulator.token){this.lastLink=this.hoveredManipulator.manip.links[this.hoveredManipulator.token];if(this.lastLink){this.hoveredManipulator.manip.EndPreactivate(this.lastLink.path?this.lastLink.path:this.lastLink.node,n,s);this.lastLink.states.preActivateState=b.State.END}r.preactivated.path=s.path[0];r.BeginPreactivate(q.path?q.path:q.node,n,s);q.states.preActivateState=b.State.BEGIN;this.hoveredManipulator={token:p,manip:r}}else{q.states.preActivateState=b.State.MOVE;r.Preactivate(q.path?q.path:q.node,n,s)}}}},function(p){if(this.hoveredManipulator){this.lastLink=this.hoveredManipulator.manip.links[this.hoveredManipulator.token];if(this.lastLink){this.hoveredManipulator.manip.EndPreactivate(this.lastLink.path?this.lastLink.path:this.lastLink.node,n,p);this.lastLink.states.preActivateState=b.State.END}this.hoveredManipulator=null}})}this._applyToManipulatedManipulators(n,function(r,p,s){var q=r.links[p];if(!q){return}if((q.states.manipulateState===b.State.BEGIN)||(q.states.manipulateState===b.State.MOVE)){if(!s){s=new f(this.viewer,n)}r.Manipulate(q.path?q.path:q.node,n,s);q.states.manipulateState=b.State.MOVE}},false)},_onRelease:function(m){if(!this.enabled){return}this._applyToManipulatedManipulators(m,function(p,n,q){var o=p.links[n];if(!o){return}if((o.states.manipulateState===b.State.BEGIN)||(o.states.manipulateState===b.State.MOVE)){p.EndManipulate(o.path?o.path:o.node,m,q);o.states.manipulateState=b.State.END}},true)},_onLongHold:function(m){if(!this.enabled){return}this._applyToManipulatedManipulators(m,function(p,n){var o=p.links[n];if(!o){return}if((o.states.manipulateState===b.State.BEGIN)||(o.states.manipulateState===b.State.MOVE)){if(p.HandleLongHold(o.path?o.path:o.node,m)){o.states.manipulateState=b.State.END}}},false)}});return UWA.namespace("THREEDS/ManipulatorManager",d)});define("Manipulators/ManipulatorManager",["DS/Manipulators/ManipulatorManager","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Manipulators/ManipulatorManager");return b});define("DS/SceneGraphNodes/InstancedSphereImpostorsNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils"],function(c,e,b,d){var a=e.extend({init:function(h){this._isIE11=((new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent)!=null));this._name=h.name||"sphereImpostors";this._parent(this._name);var w=h.material?h.material:new c.MeshPhongMaterial({force:true});w.transparent=true;var r=this._createMaterial(w);var n=h.nbInstances||1;var t=null;if(this._isIE11){t=this._createCoarseImpostor(8,r)}else{t=this._createFlatImpostor(6,r)}var m=new b(t,"");var y=h.positions;var k=h.radii;var u=h.colors;var s=new c.Vector3(Infinity,Infinity,Infinity);var v=new c.Vector3(-Infinity,-Infinity,-Infinity);var q=new Float32Array(n*4);var l=new Float32Array(n*2);for(var x=0;x<n;x++){q[4*x]=y[3*x];q[4*x+1]=y[3*x+1];q[4*x+2]=y[3*x+2];q[4*x+3]=k[x];l[2*x]=Math.floor(255*u[4*x])+Math.floor(255*u[4*x+1])*256+Math.floor(255*u[4*x+2])*65536;l[2*x+1]=u[4*x+3];s.x=Math.min(s.x,y[3*x]-k[x]);s.y=Math.min(s.y,y[3*x+1]-k[x]);s.z=Math.min(s.z,y[3*x+2]-k[x]);v.x=Math.max(v.x,y[3*x]+k[x]);v.y=Math.max(v.y,y[3*x+1]+k[x]);v.z=Math.max(v.z,y[3*x+2]+k[x])}var z=new c.Vector3().addVectors(s,v).multiplyScalar(0.5);var o=new c.Vector3().addVectors(z,new c.Vector3().subVectors(s,z).multiplyScalar(1.05));var p=new c.Vector3().addVectors(z,new c.Vector3().subVectors(v,z).multiplyScalar(1.05));var f=new c.Box3(o,p);var j={data:q,type:"v4",isFlattened:true,attribName:"instancePositionAndRadius"};var g={data:l,type:"v2",isFlattened:true,attribName:"instanceColor"};m.setMaterial(r);m.setInstancingParameters(n,[j,g],"instance");m.forceBoundingBox(f);this.addChild(m);return this},_createFlatImpostor:function(t,n){var q=[];var s=new c.BufferGeometryDS();s.drawingGroups=[];var o=t*3;var r=new d.DrawingGroup(n,n,4,0,o);r.geometry=s;s.drawingGroups.push(r);var u=t+1;var p=new Float32Array(u*3);var h=0;var f;p[h++]=0;p[h++]=0;p[h++]=0;for(var l=0;l<t;l++){f=l/t;p[h++]=Math.cos(f*2*Math.PI);p[h++]=Math.sin(f*2*Math.PI);p[h++]=0}s.vertexPositionArray=p;var m=new Uint16Array(o);var g=0;for(var l=0;l<t;l++){m[g++]=0;m[g++]=l+1;m[g++]=(l+2)>6?(l+2)%t:(l+2)}s.vertexIndexArray=m;q.push(s);var v=new c.Mesh(q,n);v.matrixAutoUpdate=false;return v},_createCoarseImpostor:function(p,q){var o=[];var r=new c.BufferGeometryDS();r.drawingGroups=[];var n=6*p*(p-1);var w=new d.DrawingGroup(q,q,4,0,n);w.geometry=r;r.drawingGroups.push(w);var z=2+(p-1)*p;var t=new Float32Array(z*3);var s=0;var h=0;var g=0;t[s++]=0;t[s++]=0;t[s++]=-1;var l=0;var x=0;for(var v=0;v<p;v++){for(var u=-p/2+1;u<=p/2-1;u++){h=v/p;g=u/p;l=h*2*Math.PI;x=(g)*Math.PI;t[s++]=Math.cos(l)*Math.cos(x);t[s++]=Math.sin(l)*Math.cos(x);t[s++]=Math.sin(x)}}t[s++]=0;t[s++]=0;t[s++]=1;r.vertexPositionArray=t;var m=new Uint16Array(n);s=0;var y=0;for(var v=0;v<p;v++){y=v===(p-1)?(z-2):(z-1);m[s++]=0;m[s++]=((v+1)*(p-1)+1)%y;m[s++]=v*(p-1)+1;for(var u=1;u<p-1;u++){m[s++]=((v+1)*(p-1)+u)%y;m[s++]=v*(p-1)+u+1;m[s++]=v*(p-1)+u;m[s++]=((v+1)*(p-1)+u)%y;m[s++]=((v+1)*(p-1)+u+1)%y;m[s++]=v*(p-1)+u+1}m[s++]=((v+1)*(p-1)+p-1)%y;m[s++]=z-1;m[s++]=v*(p-1)+p-1}r.vertexIndexArray=m;o.push(r);var f=new c.Mesh(o,q);f.matrixAutoUpdate=false;return f},_createMaterial:function(f){var g=f;g.activatePDSFX();g.setPDSFXVaryings({viewCenterPos:{type:"v3"},radius:{type:"f"},radius2:{type:"f"},vaColor:{type:"v4"},rightAndLeft:{type:"v2"}});g.setPDSFXGlobalShaderCode(["float _radius;","float _radius2;","vec4 instancePosition;",].join("\n"),["vec3 newViewPosition;","bool toDiscard;","bool isPerspective;","vec2 viewport;","vec3 intersectionWithSpherePERSP(in vec3 ray) {","vec3 cameraToCenter = viewCenterPos;","float adjacentInTriangle = dot(cameraToCenter, ray);","float distRayToCenter2 = dot(cameraToCenter, cameraToCenter) - adjacentInTriangle * adjacentInTriangle;","if (distRayToCenter2 > (radius*radius)) {","toDiscard = true;","return vec3(0.0,0.0,0.0);","}","float projToIntersection = sqrt(radius*radius - distRayToCenter2);","float cameraToIntersection = adjacentInTriangle - projToIntersection;","return cameraToIntersection * ray;","}","vec3 intersectionWithSphereORTHO(in vec3 ray) {","vec3 viewRayBase = vec3((2.0*(gl_FragCoord.xy/viewport.xy) - 1.0)*rightAndLeft.xy, 0.0);","vec2 projToCenter = viewCenterPos.xy - viewRayBase.xy;","float distRayToCenter2 = dot(projToCenter,projToCenter);","if (distRayToCenter2 > radius2) {","toDiscard = true;","return vec3(0.0,0.0,0.0);","}","float projToIntersection = sqrt(radius2 - distRayToCenter2);","vec3 projRayOnImpostor = vec3(viewRayBase.xy, viewCenterPos.z);","return projRayOnImpostor - projToIntersection*ray;","}"].join("\n"));var j={ComputeCommonValues:["void ComputeCommonValues() {","_radius = instancePositionAndRadius.w;","_radius2 = _radius * _radius;","instancePosition = vec4(instancePositionAndRadius.xyz, 0.0);","}"].join("\n"),ComputeVaryingValues:["void ComputeVaryingValues() {","radius = _radius;","radius2 = _radius2;","vec4 color;","color.a = instanceColor.y;","color.b = floor(instanceColor.x / 65536.0);","float tmp = instanceColor.x - color.b * 65536.0;","color.g = floor(tmp / 256.0);","color.r = floor(tmp - color.g * 256.0);","color.xyz /= 255.0;","#ifdef GAMMA_INPUT","vaColor = color * color;","#else","vaColor = color;","#endif","mat4 pMatrix = vGetProjectionMatrix();","rightAndLeft = vec2(1.0/pMatrix[0][0], 1.0/pMatrix[1][1]);","}"].join("\n")};if(this._isIE11){j.ProcessViewTangentSpace=["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","viewCenterPos = vec3(vGetViewMatrix()*vec4(instancePosition.xyz,1.0));","vec3 localPos = 1.1*_radius*vGetAttribPosition();","ioWorldViewTS.Position = vec3(vGetWorldViewMatrix() * vec4( instancePosition.xyz + localPos, 1.0));","}"].join("\n")}else{j.ProcessViewTangentSpace=["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","vec3 localPos = vGetAttribPosition();","mat4 pMatrix = vGetProjectionMatrix();","bool isPersp = pMatrix[2][3] == -1.0;","float minScale;","viewCenterPos = vec3(vGetViewMatrix()*vec4(instancePosition.xyz,1.0));","if (isPersp) {","vec3 CR = - viewCenterPos;","float CR_L = length(CR);","float CR_L_2 = CR_L*CR_L;","float d = sqrt(CR_L_2 - _radius2);","vec3 CP = localPos;","float dotCRCP = dot(CR,CP);","vec3 CR_y = CR - dotCRCP*CP;","vec2 _R = vec2(dotCRCP, length(CR_y));","float _Y1 = _radius*(_radius*_R.y + d*_R.x)/CR_L_2;","float _X1 = (_radius2 - _Y1*_R.y)/_R.x;","float _Y2 = _radius*(_radius*_R.y - d*_R.x)/CR_L_2;","float _X2 = (_radius2 - _Y2*_R.y)/_R.x;","float minScale1 = abs(_radius2/_X1);","float minScale2 = abs(_radius2/_X2);","minScale = max(minScale1, minScale2);","float bonusCoeff = (minScale - _radius)*0.1547005/(0.4*_radius) + 1.0;","minScale = minScale*1.1547005*bonusCoeff;","minScale = min(_radius*1.8, minScale);","if (abs(dotCRCP) < 0.0001) minScale = _radius*1.1547;","} else {","minScale = _radius*1.1547;","}","ioWorldViewTS.Position = vec3( viewCenterPos + minScale * localPos);","}"].join("\n")}var h={ComputeCommonValues:["void ComputeCommonValues() {","toDiscard = false;","mat4 pMatrix = vGetProjectionMatrix();","viewport = vec2(vGetViewportSize());","isPerspective = pMatrix[2][3] == -1.0;","if(isPerspective) {","vec3 ray = normalize(vGetViewPosition());","newViewPosition = intersectionWithSpherePERSP(ray);","} else {","vec3 ray = vec3(0.0, 0.0, -1.0);","newViewPosition = intersectionWithSphereORTHO(ray);","}","}"].join("\n"),ComputeDiscard:["bool ComputeDiscard() {","return toDiscard;","}"].join("\n"),ComputeAlbedo:["vec3 ComputeAlbedo() {","	return vaColor.xyz;","}"].join("\n"),ComputeViewNormal:["vec3 ComputeViewNormal() {","return normalize(newViewPosition - viewCenterPos);","}"].join("\n")};if(this._isIE11){h.ComputeViewPosition=["vec3 ComputeViewPosition() {","return newViewPosition;","}"].join("\n")}else{h.ComputeViewPosition=["vec3 ComputeViewPosition() {","float linearDepth = -newViewPosition.z;","vec3 near_far= vGetNearFarLogFactor();","float near = near_far.x;","float far = near_far.y;","float fragDepth;","if (isPerspective) {","fragDepth = (1.0/linearDepth - 1.0/near)/(1.0/far - 1.0/near);","} else {","fragDepth = (linearDepth - near)/(far - near);","}","vSetFragDepth(fragDepth);","return newViewPosition;","}"].join("\n")}g.setPDSFXOverridableFunctions(j,h);return g},setName:function(f){this._name=f},});return UWA.namespace("THREEDS/Nodes/InstancedSphereImpostorsNode",a)});define("SceneGraphNodes/InstancedSphereImpostorsNode",["DS/SceneGraphNodes/InstancedSphereImpostorsNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/InstancedSphereImpostorsNode");return b});define("DS/Shaders/SSAO2IterativeShader",["DS/Visualization/ThreeJS_DS"],function(b){var c={computeVertexPositionVS:["vec4 normalDepth = texture2D( tNormalDepth, vUv );","float z = normalDepth.w;","if ( z == 0.0 ) return;","vec2 xy = vUv * 2.0 - 1.0;","vec4 vertexPositionProjected = vec4( xy, 2.0 * z - 1.0, 1.0 );","vec4 vertexPositionVS = realProjectionMatrixInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","vertexPositionVS.w = 1.0;"].join("\n"),computeNormal:["vec3 normal = vec3(0.0, 0.0, 1.0);","if (dot(normalDepth.xy, normalDepth.xy) > 0.000001) {","   normal.z = 2.0 * dot(normalDepth.xy, normalDepth.xy) - 1.0;","   normal.xy = normalize(normalDepth.xy) * sqrt(1.0 - normal.z * normal.z);","}"].join("\n")},a={uniforms:{tNormalDepth:{type:"t",value:null},prevMap:{type:"t",value:null},tRandSeq:{type:"t",value:null},realProjectionMatrix:{type:"m4",value:new b.Matrix4()},realProjectionMatrixInverse:{type:"m4",value:new b.Matrix4()},radius:{type:"f",value:0.5},thresholdAngle:{type:"f",value:0.071},numIteration:{type:"i",value:0},firstSample:{type:"i",value:0},screenSize:{type:"v2",value:new b.Vector2(800,600)},invSize:{type:"v2",value:new b.Vector2(1/800,1/600)}},vertexShader:["varying vec2 vUv;","void main() {","  vUv = uv;",b._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform mat4 realProjectionMatrix;","uniform mat4 realProjectionMatrixInverse;","uniform float radius;","uniform float thresholdAngle;","uniform int numIteration;","uniform int firstSample;","uniform sampler2D tNormalDepth;","uniform sampler2D prevMap;","uniform sampler2D tRandSeq;","uniform vec2 screenSize;","uniform vec2 invSize;","varying vec2 vUv;","const int nbSamples = 16;","const float fov = 0.7853981634;","const float PI = 3.14159265358979323846264;","const float one_over_tan_225 = 2.414213562373095;","float random(vec3 scale, float seed) {","  return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","float Random1D(float seed) {","return random(vec3(12.9898, 78.233, 151.7182), seed);","}","float HaltonSequenceShift(int n, int base, float shift) {","float val = 0.0;","float invBase = 1.0 / float(base);","float invBi = invBase;","for (int i = 0; i < 32; i++) {","if (n == 0) break;","float d_i = mod(float(n), float(base));","val += float(d_i) * invBi;","n /= base;","invBi *= invBase;","}","return fract(val + shift);","}","vec3 LowDiscrepancy3DShift(int index, vec2 shift) {","int yy = index / 64;","float xx = mod(float(index), 64.0);","vec2 offset = vec2(xx, float(yy));","vec3 res = texture2D(tRandSeq, 0.015625 * (offset + 0.5)).xyz;","return fract(res + shift.xyx);","}","vec3 uniformlySampleSphere(vec2 E) {","  float z = 1.0 - 2.0 * E.x;","  float r = sqrt(1.0 - z * z);","  float angle = 6.283185307179586 * E.y;","  return vec3(r * cos(angle), r * sin(angle), z);","}","vec2 getScreenPos(vec3 pos) {","  vec4 offset = realProjectionMatrix * vec4(pos, 1.0);","  offset.xy /= offset.w;","  offset.xy = offset.xy * 0.5 + 0.5;","  offset.xy = floor(screenSize * offset.xy) + vec2(0.5);","  offset.xy *= invSize;","  return offset.xy;","}","void main() {","  vec2 screenPos = vUv;","  gl_FragColor = vec4( 1.0 );",c.computeVertexPositionVS,c.computeNormal,"  vec3 origin = vertexPositionVS.xyz;","  float minRadius = - one_over_tan_225 * radius / origin.z;","  float scaleRadius = max(1.0, 0.1 / minRadius);","  minRadius = scaleRadius * radius;","  float occlusion = 0.0;","  vec2 shift = vec2(Random1D(gl_FragCoord.x + gl_FragCoord.y), Random1D(gl_FragCoord.x * gl_FragCoord.y));","  for (int i = 0; i < nbSamples; ++i) {","    vec3 E = LowDiscrepancy3DShift(firstSample + i + 1, shift);","    vec3 svec = uniformlySampleSphere(E.xy);","    float angle = dot(svec, normal);","    float randRadius = minRadius * sign(angle);","    randRadius *= E.z;","    vec3 sample = origin + randRadius * svec;","    vec2 sampleScreenPos = getScreenPos(sample);","   vec2 isSameUV = step(invSize, abs(sampleScreenPos - vUv));","    bvec4 inScreen4 = bvec4(sampleScreenPos.x >= 0.0, sampleScreenPos.x <= 1.0, sampleScreenPos.y >= 0.0, sampleScreenPos.y <= 1.0);","    if(!all(inScreen4)) { continue; }","    vec4 normalDepth = texture2D( tNormalDepth, sampleScreenPos );","    float z = normalDepth.w;","    if (z > 0.0) {","      vec2 xy = sampleScreenPos * 2.0 - 1.0;","      vec4 posProjected = vec4(xy, 2.0 * z - 1.0, 1.0);","      vec4 posVS = realProjectionMatrixInverse * posProjected;","      float sampleBufferDepth = posVS.z / posVS.w;","      float range_check = abs(origin.z - sampleBufferDepth);","      if (range_check < minRadius && sampleBufferDepth > sample.z && angle > thresholdAngle) {","        float l = range_check / minRadius;","        occlusion += isSameUV.x * isSameUV.y / (l*l + 1.0);","      }","    }","  }","  occlusion = 1.0 - occlusion / float(nbSamples);","  float prevAO = texture2D( prevMap, vUv ).r;","  gl_FragColor = vec4(vec3((prevAO * float(numIteration) + occlusion) / (float(numIteration) + 1.0)), 1.0);","}"].join("\n")};return a});define("DS/Visualization/OccurrenceInterface",["UWA/Class","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS"],function(a,e,d){function c(f){if(!f._occurrenceExplorer._occurrenceInterfaceList){var g=new Error("Use of expired OccurrenceInterface (= outside of callback function given to OccurrenceExplorer.explore())");g.expiredOccurrenceInterfaceError=true;throw g}var h=f._occurrenceExplorer._occurrenceList[f._node][f._index].occurrence;return h}var b=a.extend({init:function(h,g,f){this._node=h;this._index=g;this._occurrenceExplorer=f},getNbChildren:function(){var f=c(this);return f.children.length},getParent:function(){var g=c(this);var f=this._occurrenceExplorer.getOccurrenceInterface(g.parent);return f},getChild:function(g){var h=c(this);var f=this._occurrenceExplorer.getOccurrenceInterface(h.children[g]);return f},getChildren:function(){var h=c(this);var g=[];var f;for(f=0;f<h.children.length;f++){g.push(this._occurrenceExplorer.getOccurrenceInterface(h.children[f]))}return g},traverse:function(l,h){var k=c(this);var f=l(this,h);if(!f){var g=0;var j;for(g=0;g<k.children.length;g++){j=this._occurrenceExplorer.getOccurrenceInterface(k.children[g]);j.traverse(l,h)}}},getNode:function(){var f=c(this);return f.node},getMesh3D:function(){var f=c(this);if(f.node.getNodeType()==="Mesh3D"){return f.node}return null},getColor:function(f){var n=c(this);this._tryOverridesUpdate(n);if(n.renderable){var m=n.occurrenceRenderingOverride&&n.occurrenceRenderingOverride.materialOverride;var l=(m&&m.getColor())||null;var g=m&&m.getFullMaterial();var k=n.renderable.matApp&&n.renderable.matApp._getMaterialFromGLType(4,d.GeomTypeEnum.FACE);var j=false;if(!k&&n.renderable.material){k=n.renderable.material;j=true;if(k&&(f||!k.force)){k=null}}else{if(k&&f){k=null}}var h=null;if((l!==null||g)&&(!k||!k.color||k.overridable)){h=(g&&g.color&&g.color.clone());if(l!==null&&(!h||g.overridable)){h=new d.Color(l)}}else{h=k&&k.color&&(!j||k.force)&&k.color.clone()}}return h},getWorldMatrix:function(f){var g=c(this);this._tryOverridesUpdate(g);if(f){f.copy(g.matrix);return f}else{return g.matrix.clone()}},getMatrix:function(g){var h=c(this);this._tryOverridesUpdate(h);var f=h.getLocalMatrix();if(g){g.copy(f);return g}else{return f.clone()}},getMatrixInAxisSystem:function(j,h){var g=this.getWorldMatrix();if(!g){return null}var f=h||new d.Matrix4();var k=new d.Matrix4();k.getInverse(j);f.multiplyMatrices(k,g);return f},getRenderableDescendants:function(){var h=c(this);var f=[];var g=this;h.traverse(function(j){if(j.renderable){f.push(g._occurrenceExplorer.getOccurrenceInterface(j))}});return f},buildPathElement:function(f){var g=new e();var h=c(this);if(g.setFromOccurrence(h,null,f)){return g}else{return null}},getVisibility:function(){var f=c(this);this._tryOverridesUpdate(f);return f._getVisible()},getBoundingSphere:function(f){var g=c(this);return g.getBoundingSphere(f,false)},getBoundingBox:function(f){var g=c(this);return g.getBoundingBox(f)},isAParentOf:function(f){var g=f;while(g&&this!==g){g=g.getParent()}return g===this},findAncestor:function(f){var h=this.getParent();var g=null;while(h&&!g){if(f(h)){g=h}h=h.getParent()}return g},_tryOverridesUpdate:function(h){var f;var g=this._occurrenceExplorer.viewer;if(h._getNeedOverridesUpdate()){f=h;while(f.parent){f=f.parent}g=g||(h.scene3js&&h.scene3js.viewer);f.node._tryOverridesUpdate(g)}}});return b});define("DS/Visualization/OccurrenceExplorer",["UWA/Class","DS/Visualization/OccurrenceInterface","DS/Visualization/Node3D","DS/Visualization/OccurrenceInterfaceFactory"],function(b,c,e,d){var a=b.extend({init:function(g){this.viewer=g},explore:function(g){if(!g){return}this._exploreInternal(null,g)},exploreQuick:function(h,g){if(!h||!g){return}this._exploreInternal(h,g)},_exploreInternal:function(k,j){var l=new f();var g=new d(l,this.viewer);e._LockNodeHierarchy();try{if(k){var m=g.getOccurrenceItf(k);j(m,g)}else{j(g)}e._UnlockNodeHierarchy();l.cleanUp()}catch(h){e._UnlockNodeHierarchy();l.cleanUp();throw h}}});var f=function(){this._occurrenceList=[];this._occurrenceInterfaceList=[]};f.prototype.cleanUp=function(){this._occurrenceList=null;this._occurrenceInterfaceList=null};f.prototype.getOccurrenceInterface=function(l){if(!l||!this._occurrenceList){return null}if(!this._occurrenceList[l.node.id]){this._occurrenceList[l.node.id]=[]}var g=this._occurrenceList[l.node.id];var h;var k;var j=-1;for(k=0;j<0&&k<g.length;k++){if(g[k].occurrence===l){j=g[k].index}}if(j<0){h=new c(l.node.id,g.length,this);g.push({occurrence:l,index:this._occurrenceInterfaceList.length});this._occurrenceInterfaceList.push(h)}else{h=this._occurrenceInterfaceList[j]}return h};return a});define("DS/Effects/SSAO2IterativeEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/SSAO2IterativeShader","DS/Shaders/MultiplicativeBlendShader","DS/Shaders/NothingShader"],function(h,c,e,f,d,a,j,g){var b=e.extend({init:function(p,r){var o=this._parent(p);var l=new h.WebGLRenderTargetProperties(this.width,this.height,"linear");this.influenceRadius=0.2;var k=new f(p,l,r);k.composerContext.keepResult=true;this.composers.push(k);this.renderTargetPool=r;this.effectSSAO=new d(a);var q=new d(g);this.tmpResult=null;var s=h.RandomLib.computeHaltonSequence4D(64);s.minFilter=h.NearestFilter;s.magFilter=h.NearestFilter;s.needsUpdate=true;this.effectSSAO.uniforms.tRandSeq.value=s;this.composers[0].addPass(this.effectSSAO);this.composers[0].addPass(q);this.mixPass=new d(j,undefined,"SSAO2IterativeEffect");var n=new Uint8Array(2*2*4);for(var m=0;m<2*2;m++){n[4*m]=0;n[4*m+1]=0;n[4*m+2]=0;n[4*m+3]=255}this.initTexture=new h.DataTexture(n,2,2,h.RGBAFormat,h.UnsignedByteType,new h.LatLongReflectionMapping(),h.ClampToEdgeWrapping,h.ClampToEdgeWrapping,h.LinearFilter,h.LinearFilter);this.initTexture.generateMipmaps=false;this.initTexture.needsUpdate=true;this.renderer.setTexture(this.initTexture,0);this.setStrength(0.7);return this},initEffect:function(l,m){var k=m.getComposer("normalDepth");k.linkToShaderPassUniform(this.effectSSAO,this.effectSSAO.uniforms.tNormalDepth);m.insertComposer(this.composers[0],this.mixPass);this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2);this.mixPass.addRequiredComposer(this.composers[0])},update:function(t,l,o,p){p--;this.mixPass.composer.contexts[0].enablePass(this.mixPass,(p>=0));this.composers[0].enablePass(this.effectSSAO,(p>=0));o._renderedCamera.projectionMatrixInverse.getInverse(o._renderedCamera.projectionMatrix);this.effectSSAO.uniforms.realProjectionMatrixInverse.value=o._renderedCamera.projectionMatrixInverse;this.effectSSAO.uniforms.realProjectionMatrix.value=o._renderedCamera.projectionMatrix;var n=l.getBoundingSphere(),s=this.influenceRadius*n.radius,k=(new h.Vector3().subVectors(o.target,o._renderedCamera.position)).length(),q=this.influenceRadius*k*Math.tan(0.5*o._renderedCamera.fov*(Math.PI/180));s=(s>q)?q:s;this.effectSSAO.uniforms.radius.value=s;this.effectSSAO.uniforms.numIteration.value=p;this.effectSSAO.uniforms.firstSample.value=16*p;this.effectSSAO.uniforms.prevMap.value=!p?this.initTexture:this.composers[0].composerContext.renderTarget2;var r=this;this.mixPass.beforeRenderCB=function(u){if(p===0){r.effectSSAO.uniforms.prevMap.value=r.initTexture}else{if(p>0){r.tmpResult=r.composers[0].composerContext.getResult("main",true);r.effectSSAO.uniforms.prevMap.value=r.tmpResult}}};this.mixPass.afterRenderCB=function(){if(r.tmpResult){r.renderTargetPool.pushRenderTarget(r.tmpResult);r.tmpResult=null}};var m=Math.min(16*p,this.getMaxIteration())/this.getMaxIteration();this.setStrength(Math.min(1,Math.max(0,0.7*m)))},setStrength:function(l){var k=Math.min(Math.max(l,0.000001),1);this.mixPass.uniforms.strength.value=Math.log(k)+0.7},setThresholdAngle:function(k){this.effectSSAO.uniforms.thresholdAngle.value=Math.cos(k)},setRadius:function(k){this.influenceRadius=Math.max(0,Math.min(k,1))},setSize:function(m,k){var l=this._parent(m,k);if(!l){return}this.composers[0].setSize(this.width,this.height);this.effectSSAO.uniforms.screenSize.value.set(this.width,this.height);this.effectSSAO.uniforms.invSize.value.set(1/this.width,1/this.height)},getMaxIteration:function(){return 64}});return b});define("DS/Visualization/ParticlesNode3D",["DS/Mesh/Mesh","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(c,a,b){var d=b.extend({init:function(j,f){this._parent(f);var g=j.material?j.material:null;if(!a.disableJHGDev){this.material=g}this.particles3js=(j!==undefined)?j:new a.ParticleSystem();var e=a.convertParticleSystemToBufferGeometryDS(this.particles3js.geometry);this.particles3js=new a.Mesh(e,g);this.particles3js.frustumCulled=false;j=this.createRenderable();var h=this._occurrences[0];h.renderable=j;h.renderable.name=this.name;h.renderable._occurrence=h;this.hasExplicitBE=true;this.explicitBSphere=null;this.explicitBBox=null;if(this.particles3js.geometry.boundingSphere!==undefined){this.explicitBSphere=this.particles3js.geometry.boundingSphere.clone()}return this},createRenderable:function(){var e=this.particles3js.clone();e.matrixAutoUpdate=false;e.matrixWorldNeedsUpdate=false;e.visible=this.particles3js.visible;e.pickable=this.particles3js.pickable;e.drawInHLRender=this.particles3js.drawInHLRender;e.renderDepth=this.particles3js.renderDepth;e.frustumCulled=this.particles3js.frustumCulled;e.enableNormalDepth=false;return e},add:function(){return false},setPickable:function(f){var e,g;if(typeof f==="boolean"){console.log("boolean is DEPRECATED in setPickable() method.\n Use ENUM Mesh")}if(this.particles3js!==null){this.particles3js.pickable=(f===c.PICKABLE);this.particles3js.drawInHLRender=(f!==c.NODRAWHL)}for(e=0;e<this._occurrences.length;e++){g=this._occurrences[e];if(g.renderable!==null){g.renderable.pickable=this.particles3js.pickable;g.renderable.drawInHLRender=this.particles3js.drawInHLRender}}},getNodeType:function(){return"ParticlesNode3D"}});return UWA.namespace("THREEDS/Nodes/Particles",d)});define("Visualization/ParticlesNode3D",["DS/Visualization/ParticlesNode3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/ParticlesNode3D");return b});define("DS/SceneGraphNodes/CSS3DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(b,c){var a=c.extend({init:function(h,l,g){this._parent(g);this.scale=l?l:1;this.css3DNode=new b.CSS3DNode(h);var f=this.createRenderable();var j=h.style.width;j=j.substring(0,j.length-2);var e=h.style.height;e=e.substring(0,e.length-2);var d=0.5*l*Math.sqrt(j*j+e*e);this.hasExplicitBE=true;this.explicitBSphere=new b.Sphere(new b.Vector3(0,0,0),d);this.explicitBBox=null;f.matrixAutoUpdate=false;f.visible=this.css3DNode.visible;var k=this._occurrences[0];k.renderable=f;k.renderable.name=this.name;k.renderable._occurrence=k;k.renderable.scaleCSS=new b.Matrix4().scale(new b.Vector3(this.scale,this.scale,this.scale));if(document.getElementById("camera")){document.getElementById("camera").appendChild(this.css3DNode.element)}return this},createRenderable:function(){var d=new b.CSS3DNode(this.css3DNode.element);d.matrixAutoUpdate=false;d.matrixWorldNeedsUpdate=false;d.pickable=true;d.visible=this.css3DNode.visible;return d},setPickability:function(d){this.css3DNode.element.style.pointerEvents=(d?"auto":"none")},add:function(){return false},getNodeType:function(){return"CSS3DNode"},clone:function(){var d=new b.CSS3DNode(this.css3DNode.element);return new THREEDS.Nodes.CSS3DNode(d.element,this.name)}});return UWA.namespace("THREEDS/Nodes/CSS3DNode",a)});define("SceneGraphNodes/CSS3DNode",["DS/SceneGraphNodes/CSS3DNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/CSS3DNode");return b});define("DS/VisuUnstreamers/XMLMeshUnstreamTask",["UWA/Class","WebappsUtils/WebappsUtils","UWA/Utils","DS/Visualization/Utils","DS/VisuUnstreamers/UnstreamTaskDriver","DS/VisuUnstreamers/FileInZipStreamObject","DS/Mesh/MeshUtils","DS/Visualization/MaterialManager","DS/Visualization/Mesh3D"],function(b,e,l,c,k,g,d){var m=null;var n=false;var a=0;var j=[];var h=[];var f=false;var o=b.extend({init:function(q,p){this.streamObject=q;this.targetNode=p;this.contextID=a++;j[this.contextID]={so:this.streamObject,target:this.targetNode};return this},run:function(s,y,w){j[this.contextID].cbSuccess=y;j[this.contextID].cbError=w;j[this.contextID].cbProgress=s;j[this.contextID].nbMaterials=0;j[this.contextID].remainingMaterials=0;j[this.contextID].modelLoaded=false;console.log("running XMLMeshUnstreamTask");var u=this;if(!this.targetNode){console.error("XMLMeshUnstreamTask execution failed : target node undefined !");return}var q={launched:false};h[this.contextID]=q;if(m===null&&!f){f=true;var v=!l.matchUrl(e.getWebappsBaseUrl(),window.location)?"Passport":null;var x={provider:"FILE",filename:"AmdLoader.js",serverurl:e.getWebappsBaseUrl()+"AmdLoader/",requiredAuth:v};var r={provider:"FILE",filename:"EasySax.js",serverurl:e.getWebappsBaseUrl()+"EasySax/",requiredAuth:v};var p={provider:"FILE",filename:"ThreeJS_Base.js",serverurl:e.getWebappsBaseUrl()+"Mesh/",requiredAuth:v};var A={provider:"FILE",filename:"Mesh.js",serverurl:e.getWebappsBaseUrl()+"Mesh/",requiredAuth:v};var z={provider:"FILE",filename:"XMLV43Worker.js",serverurl:e.getWebappsBaseUrl()+"Workers/",requiredAuth:v};var t=[x,r,p,A,z];c.getWorkerFromSpecs(t,function(B){m=B;m.onmessage=function(J){var F=J.data;if(F.loaded){if(!n){n=true;u.internalLoad()}}else{var L=F.contextID;var C=null;if(F.rep.length>0){var D=[];for(var G=0;G<F.rep.length;G++){var K=F.rep[G];for(var E=0;E<K.drawingGroups.length;E++){var I=K.drawingGroups[E].material;if((I!==null)&&(I.file!=="")){D.push({dg:K.drawingGroups[E],name:I.file})}}}j[L].nbMaterials=D.length;j[L].remainingMaterials=D.length;for(var G=0;G<D.length;G++){var M=D[G];var H=new g(j[L].so.blob,M.name);k.getTask("XMLMaterial",H,null,function(N){return function(O){O.materialRefId=N.material.id;O.run(null,function(Q){N.material=Q;var P=j[L];P.remainingMaterials--;if(P.cbProgress){P.cbProgress({material:Q,loaded:P.nbMaterials-P.remainingMaterials,total:P.nbMaterials})}if(!P.remainingMaterials&&P.modelLoaded&&P.cbSuccess){P.cbSuccess(C,true)}})}}(M.dg))}C=d.convertTo3js(F.rep)}else{C=d.createEmptyMesh()}j[L].target.add(C);j[L].so.close();if(j[L].cbSuccess){j[L].modelLoaded=true}delete h[L];u.internalLoad()}}})}else{if(n){this.internalLoad()}}},internalLoad:function(){for(var p in h){if(h[p].launched===false){h[p].launched=true;this.workerLoaded(p)}}},workerLoaded:function(p){var q=j[p].so;q.open();q.readAsText(function(r){m.postMessage({path:r,contextID:p})})}});return UWA.namespace("THREEDS/XMLMeshUnstreamTask",o)});define("VisuUnstreamers/XMLMeshUnstreamTask",["DS/VisuUnstreamers/XMLMeshUnstreamTask","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuUnstreamers/XMLMeshUnstreamTask");return b});define("DS/Shaders/PreComputeShaders",["DS/Visualization/ThreeJS_DS"],function(d){var b=["uniform sampler2D tEnvMap;","uniform float roughness;","const float PI = 3.14159265358979323846264;","varying vec2 vUv;","#define INV_GOLDEN_RATIO 0.6180339887","int ComputeIndex(int id, int N) {","float val = float(id) * (float(N) * 24.0);","int n = int( val / float(N));","int m = int(mod(val, float(N)));","return n + m;","}","vec2 LowDiscrepancy2D(int i, int N)","{","int id = ComputeIndex(i, N);","return vec2(fract((float(id) + 0.5) / float(N)* INV_GOLDEN_RATIO), fract(float(id) * INV_GOLDEN_RATIO));","}","vec2 vLogComplex(in float value) {","float real = log(abs(value));","float im = atan(0.0,value);","return vec2(real,im);","}","vec2 invComplex(in vec2 value) {","return vec2(value.x,-value.y)/(value.x * value.x + value.y * value.y);","}","vec3 GetLightVector(in vec3 R, in vec3 H) {","#if MODE == 3","return H;","#else","return 2.0 * dot(R, H) * H - R;","#endif","}","float GetWeight(in float NoL) {","#if MODE != 0","return 1.0;","#else","return NoL;","#endif","}","vec3 ImportanceSample(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * PI * Xi.x;","#if MODE != 3","float a = roughness * roughness;","float a2 = a*a;","#endif","#if MODE == 0","float CosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a2 - 1.0) * Xi.y));","float SinTheta = sqrt(1.0 - CosTheta * CosTheta);","#endif","#if MODE == 1","float interiorTerm = 4.0*a2*exp(1.0/a2)/(4.0*a2*Xi.y + Xi.y - 1.0);","vec2 exteriorTerm = a2*vLogComplex(interiorTerm);","vec2 value = invComplex(exteriorTerm);","float val = min(length(value),1.0);","float SinTheta = sqrt(val);","float CosTheta = sqrt(1.0 - val);","#endif","#if MODE == 2","float loga = 8.0*a2*log(1.0-Xi.y);","float value = loga / (loga - 1.0);","float SinTheta = sqrt(value);","float CosTheta = sqrt(1.0 - value);","#endif","#if MODE == 3","float value = Xi.y;","float SinTheta = sqrt(value);","float CosTheta = sqrt(1.0 - value);","#endif","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return H;","}","vec3 TangentToWorld(vec3 Vec, vec3 TangentZ) {","vec3 UpVector = abs(TangentZ.z) < 0.999 ? vec3(0,0,1) : vec3(1,0,0);","vec3 TangentX = normalize(cross(UpVector, TangentZ));","vec3 TangentY = cross(TangentZ, TangentX);","return TangentX * Vec.x + TangentY * Vec.y + TangentZ * Vec.z;","}","float computeLODFromDirection(vec3 dir, float pdf) {","float d = 2.0 * DP_SCALE;","d *= (1.0 + abs(dir.z));","d *= d;","float lod = 0.5 * log2(pdf * d);","return max(LOD_CST - lod, 0.0);","}","vec3 sampleLatLongFromLocation(vec3 dir) {","float theta = acos(dir.z);","float phi = atan(dir.y, dir.x);","float u = 0.5 + 0.5 * phi / PI;","float v = theta / PI;","vec4 texelRGBE = texture2D(tEnvMap, vec2(u, v));","return (255.0 / 256.0) * texelRGBE.rgb * pow(2.0, 255.0 * texelRGBE.w - 128.0);","}","vec4 ImportanceSamplePDF(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * PI * Xi.x;","float D = 0.0;","float normalisationTerm = 1.0/PI;","#if MODE != 3","float a = roughness * roughness;","float a2 = a*a;","#endif","#if MODE == 0","float CosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a2 - 1.0) * Xi.y));","float SinTheta = sqrt(1.0 - CosTheta * CosTheta);","float d = (a2 - 1.0) * CosTheta*CosTheta + 1.0;","D = a2 / (PI * d * d);","#endif","#if MODE == 1","float interiorTerm = 4.0*a2*exp(1.0/a2)/(4.0*a2*Xi.y + Xi.y - 1.0);","vec2 exteriorTerm = a2*vLogComplex(interiorTerm);","vec2 value = invComplex(exteriorTerm);","float val = min(length(value),1.0);","float SinTheta = sqrt(val);","float CosTheta = sqrt(1.0-val);","float cosine2 = max(CosTheta*CosTheta,1e-6);","float sine2 = max(SinTheta*SinTheta,1e-6);","normalisationTerm *= 1.0/(1.0 + 4.0*a2);","float sine4 = max(sine2 * sine2,1e-6);","float cotan2 = cosine2/sine2;","float value2 = -cotan2 / a2;","D = 1.0 + 4.0 * exp(value2)/ sine4;","D *= normalisationTerm;","#endif","#if MODE == 2","float loga = 8.0*a2*log(1.0-Xi.y);","float value = loga / (loga - 1.0);","float SinTheta = sqrt(value);","float CosTheta = sqrt(1.0 - value);","float cosine2 = max(CosTheta*CosTheta,1e-6);","float sine2 = max(SinTheta*SinTheta,1e-6);","normalisationTerm *= 1.0/(8.0*a2);","float cosine4 = max(cosine2 * cosine2,1e-6);","float tan2 = sine2/cosine2;","float value2 = -tan2/(a2*8.0);","D = exp(value2) / cosine4 ;","D *= normalisationTerm ;","#endif","#if MODE == 3","float value = Xi.y;","float SinTheta = sqrt(value);","float CosTheta = sqrt(1.0 - value);","D = normalisationTerm;","#endif","float PDF = D * CosTheta;","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return vec4(H, PDF);","}","vec3 sampleDualParaboloidFromLocation(vec3 dir, float lod) {","vec2 st = vec2(0.5);","if (dir.z < 0.0) {","st *= 0.5 * (1.0 - dir.xy / (DP_SCALE * (1.0 - dir.z)));","} else {","st *= 0.5 * (1.0 + dir.xy / (DP_SCALE * (1.0 + dir.z)));","st.x += 0.5;","}","float mipValue = floor(lod);","float mipNextValue = mipValue + 1.0;","float mipCoef = fract(lod);","if (lod >= float(MAX_LOD)) {","mipValue = float(MAX_LOD);","mipNextValue = float(MAX_LOD);","mipCoef = 1.0;","}","vec3 color1;","vec3 color2;","vec2 uv1 = st;","vec2 uv2 = st;","float scale1 = pow(2.0, -mipValue);","float scale2 = pow(2.0, -mipNextValue);","uv1 *= scale1;","uv2 *= scale2;","uv1.y += 1.0 - scale1;","uv2.y += 1.0 - scale2;","color1 = texture2D(tEnvMap, uv1).xyz;","color2 = texture2D(tEnvMap, uv2).xyz;","return mix(color1, color2, mipCoef);","}","vec3 GetIterativeFilteredColor(in vec3 L, in vec4 perturbedZ_PDF, in vec3 H, in vec3 R, in float roughness, in float NoL) {","#if MODE == 3","float lod = computeLODFromDirection(L, perturbedZ_PDF.w);","#else","float lod = computeLODFromDirection(L, perturbedZ_PDF.w/ (4.0 * clamp(dot(R,H),1e-6,1.0)));","#endif","vec3 filteredColor = min(sampleDualParaboloidFromLocation(L, lod),vec3(100.0)) * GetWeight(NoL);","return filteredColor;","}",].join("\n");var e={defines:{NB_SAMPLES:256,DP_SCALE:1.2,MODE:0,MAX_LOD:9,},uniforms:{tEnvMap:{type:"t",value:null},roughness:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:[b,"vec3 prefilterEnvMap(float roughness, vec3 R, vec2 UV) {","vec3 filteredColor;","float weight = 0.0;","for (int i = 0; i < NB_SAMPLES; i++) {","vec2 E = LowDiscrepancy2D(i,NB_SAMPLES);","vec3 perturbedZ = ImportanceSample(E, roughness);","vec3 H = TangentToWorld(perturbedZ, R);","vec3 L = GetLightVector(R,H);","float NoL = clamp(dot(R, L), 0.0, 1.0);","if (NoL > 0.0) {","filteredColor += min(sampleLatLongFromLocation(L), vec3(100.0)) * GetWeight(NoL);","weight += GetWeight(NoL);","}","}","return filteredColor / max(weight, 0.001);","}","void main() {","gl_FragColor = vec4(0.0);","float phi = PI * (2.0 * vUv.x - 1.0);","float theta = PI * vUv.y;","vec3 R;","R.x = sin(theta) * cos(phi);","R.y = sin(theta) * sin(phi);","R.z = cos(theta);","gl_FragColor = vec4(prefilterEnvMap(roughness, R, vUv), 1.0);","}"].join("\n")};var a={defines:{NB_SAMPLES:256,DP_SCALE:1.2,LOD_CST:7.707519,MODE:0,MAX_LOD:9,},uniforms:{tEnvMap:{type:"t",value:null},roughness:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:[b,"vec3 prefilterEnvMap(float roughness, vec3 R, vec2 UV) {","vec3 filteredColor;","float weight = 0.0;","for (int i = 0; i < NB_SAMPLES; i++) {","vec2 E = LowDiscrepancy2D(i,NB_SAMPLES);","vec4 perturbedZ_PDF = ImportanceSamplePDF(E, roughness);","vec3 H = TangentToWorld(perturbedZ_PDF.xyz, R);","vec3 L = GetLightVector(R,H);","float NoL = clamp(dot(R, L), 0.0, 1.0);","if (NoL > 0.0) {","filteredColor += GetIterativeFilteredColor(L, perturbedZ_PDF, H, R, roughness, NoL);","weight += GetWeight(NoL);","}","}","return filteredColor / max(weight, 0.001);","}","void main() {","gl_FragColor = vec4(0.0);","float phi = PI * (2.0 * vUv.x - 1.0);","float theta = PI * vUv.y;","vec3 R;","R.x = sin(theta) * cos(phi);","R.y = sin(theta) * sin(phi);","R.z = cos(theta);","gl_FragColor = vec4(prefilterEnvMap(roughness, R, vUv), 1.0);","}"].join("\n")};var c={defines:{NB_SAMPLES:256,NB_SAMPLES_IT:256,DP_SCALE:1.2,LOD_CST:7.707519,MODE:0,MAX_LOD:9,},uniforms:{prevMap:{type:"t",value:null},tEnvMap:{type:"t",value:null},roughness:{type:"f",value:0},firstSample:{type:"i",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",d._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D prevMap;","uniform int firstSample;",b,"vec4 prefilterEnvMap(float roughness, vec3 R, vec2 UV) {","vec3 filteredColor;","float weight = 0.0;","for (int i = 0; i < NB_SAMPLES_IT; i++) {","int newI = firstSample + i;","vec2 E = LowDiscrepancy2D(newI,NB_SAMPLES);","vec4 perturbedZ_PDF = ImportanceSamplePDF(E, roughness);","vec3 H = TangentToWorld(perturbedZ_PDF.xyz, R);","vec3 L = GetLightVector(R,H);","float NoL = clamp(dot(R, L), 0.0, 1.0);","if (NoL > 0.0) {","filteredColor += GetIterativeFilteredColor(L, perturbedZ_PDF, H, R, roughness, NoL);","weight += GetWeight(NoL);","}","}","return vec4(filteredColor / max(weight, 0.001),max(weight, 0.001));","}","void main() {","gl_FragColor = vec4(0.0);","float phi = PI * (2.0 * vUv.x - 1.0);","float theta = PI * vUv.y;","vec3 R;","R.x = sin(theta) * cos(phi);","R.y = sin(theta) * sin(phi);","R.z = cos(theta);","vec4 prevTex = texture2D(prevMap, vUv);","vec4 res = prefilterEnvMap(roughness, R, vUv);","gl_FragColor = vec4((prevTex.rgb * prevTex.a + res.rgb * res.a) / (prevTex.a + res.a), prevTex.a + res.a);","}"].join("\n")};return{ComputeMipMapRoughness:e,ComputeMipMapRoughnessFIS:a,ComputeMipMapRoughnessIterative:c}});define("DS/VisuLoaders/StreamVisuLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager"],function(d,g,f,e,c,b){var a=function(n){var k=performance.now();var j=(n!==undefined)?n:null;this.modelsToLoad={};this.loadIndex=0;var l=new d.MeshPhongMaterial({side:d.DoubleSide,color:new d.Color(16777215)});var h=new d.MeshBasicMaterial({color:new d.Color(16777215)});var m={};this.createTextures=function(o,p){var q,t;for(q in o){var t=o[q];var s=null;if(p.imagesCallback){s=p.imagesCallback(t,p)}else{var r=t.format;if(!r){r=g.getExtension(t.path)}if(r==="hdr"){s=d.ImageUtils.loadHDRTexture(p.path+t.path+p.urlOptions)}else{if(r==="dds"){var u=false;s=d.ImageUtils.loadCompressedTexture(p.path+t.path+p.urlOptions,undefined,null,null,u)}else{s=d.ImageUtils.loadTexture2(p.path+t.path+p.urlOptions)}}s.wrapS=t.wrapS||1000;s.wrapT=t.wrapT||1000;s.anisotropy=t.anisotropy||8;s.minFilter=t.minFilter||1008;s.magFilter=t.magFilter||1006;s.repeat=t.repeat||{x:1,y:1};s.sRGB=(r==="jpg")||(r==="jpeg")}p.data.textures[t.id]=s}};this.createMaterials=function(o,t,q){var r,u;for(r in o){var u=o[r];var s=null;if(q.materialsCallback){s=q.materialsCallback(u,q)}else{var p={visible:u.visible,force:u.force,side:u.side,enableClipPlanes:u.enableClipPlanes,transparent:u.transparent,opacity:u.opacity,depthTest:u.depthTest,depthWrite:u.depthWrite};if(u.forceSide){p.forceSide=u.forceSide}if(u.NRECompatibility!==undefined){p.NRECompatibility=u.NRECompatibility}if(u.needTangentBinormal){p.needTangentBinormal=u.needTangentBinormal}if(u.alphaTest){p.alphaTest=u.alphaTest}if(u.color){p.color=new d.Color().setRGB(u.color.r,u.color.g,u.color.b)}if(u.ambient){p.ambient=new d.Color().setRGB(u.ambient.r,u.ambient.g,u.ambient.b)}if(u.emissive){p.emissive=new d.Color().setRGB(u.emissive.r,u.emissive.g,u.emissive.b)}if(u.specular){p.specular=new d.Color().setRGB(u.specular.r,u.specular.g,u.specular.b)}if(u.shininess){p.shininess=u.shininess}if(u.vertexColors){p.vertexColors=u.vertexColors}if(u.diffuseMap!==undefined){p.map=t.textures[u.diffuseMap]}if(u.opacityMap!==undefined){p.opacityMap=t.textures[u.opacityMap];p.transparent=true}if(u.normalMap!==undefined){p.normalMap=t.textures[u.normalMap];p.needTangentBinormal=true;if(u.needTangentBinormal!==undefined){p.needTangentBinormal=u.needTangentBinormal}}if(u.normalMapScale!==undefined){p.normalScale=new d.Vector2(u.normalMapScale.x,u.normalMapScale.y)}if(u.normalMapFlipY!==undefined){p.normalMapFlipY=u.normalMapFlipY}if(u.bumpMap!==undefined){p.bumpMap=t.textures[u.bumpMap]}if(u.bumpScale!==undefined){p.bumpScale=u.bumpScale}if(u.glossiness!==undefined){p.glossiness=u.glossiness}if(u.glossinessMap!==undefined){p.glossinessMap=t.textures[u.glossinessMap]}if(u.specularMap!==undefined){p.specularMap=t.textures[u.specularMap]}if(u.specularMap!==undefined){p.specularMap=t.textures[u.specularMap];p.specularMapLinear=!p.specularMap.sRGB}if(u.lightMap!==undefined){p.lightMap=t.textures[u.lightMap]}if(u.type=="Physical"){if(u.emissiveMap!==undefined){p.emissiveMap=t.textures[u.emissiveMap]}if(u.metalnessMap!==undefined){if(u.metalness===undefined){u.metalness=1}p.metalnessMap=t.textures[u.metalnessMap]}if(u.metalness!==undefined){p.metalness=u.metalness}if(u.coating!==undefined){p.coating=u.coating}if(u.coatingGlossiness!==undefined){p.coatingGlossiness=u.coatingGlossiness}}if(u.iterative!==undefined){p.iterative=u.iterative}if(u.sslr!==undefined){p.sslr=u.sslr}s=new d[u.type+"Material"](p)}t.materials[u.id]=s}};this.createGeometries=function(z,s){var K,y;var J=s.data;for(K in z){var y=z[K];var D=new d.BufferGeometryDS();J.geometries[y.id]=D;for(var u in y){var q=y[u];if((u==="vertexPositionArray"||u==="vertexIndexArray"||u==="vertexColorArray"||u==="vertexNormalArray"||u==="vertexBinormalArray"||u==="vertexTangentArray"||u==="vertexUvArray"||u==="vertexUv2Array")&&(q!==null)){if(u==="vertexIndexArray"){if(q.bpe===4){D[u]=new Uint32Array(J.chunks[q.chunk],q.offset,q.byteLength/q.bpe)}else{D[u]=new Uint16Array(J.chunks[q.chunk],q.offset,q.byteLength/q.bpe)}}else{D[u]=new Float32Array(J.chunks[q.chunk],q.offset,q.byteLength/q.bpe)}}}for(var G=0;G<y.dgs.length;G++){var I=y.dgs[G];var t=I.primitives;t=new Uint32Array(J.chunks[t.chunk],t.offset,t.byteLength/t.bpe);var w=I.canonicals;var L=(w!=undefined);var r=null;if(L){r=new Uint8Array(J.chunks[w.chunk],w.offset,w.byteLength/w.bpe)}var B=0;var x=D.vertexNormalArray?l:h;var H=[];if((I.gas!==undefined)&&J.materials[I.gas]){x=J.materials[I.gas]}var v=new f.DrawingGroup(x,null,I.glType,I.start,I.count,H,undefined,d.GeomTypeEnum[I.geomType],0);v.geometry=D;D.drawingGroups.push(v);for(var F=0;F<t.length;F+=4){var A=new f.SGPrimitive({cgmId:t[F],group:v,start:t[F+2],count:t[F+3]});if(s.unstreamReps){var p=t[F+1];var o=J.reps[p];if(!o){o=new f.SGRep({cgmId:p});J.reps[p]=o}A.rep=o;o.primitives.push(A)}if(L){var C=r[B++];if(C){A.decoration=new Array();for(var E=0;E<C;++E){A.decoration.push(r[B++])}}}H.push(A)}}}};this.createNodes=function(p,w){var C,u;var v=w.data;for(C in p){var u=p[C];var r=null;if(u.type==="Node3D"){r=new e();m[r.id]=u.children}else{var o=u.mesh3js.bs.c;var x=u.mesh3js.bs.r;var s=u.mesh3js.bbox.min;var A=u.mesh3js.bbox.max;var E=new d.Box3(new d.Vector3(s[0],s[1],s[2]),new d.Vector3(A[0],A[1],A[2]));var D=new d.Sphere(new d.Vector3(o[0],o[1],o[2]),x);var z=[];z.boundingSphere=D;z.boundingBox=E;for(var t=0;t<u.mesh3js.geometries.length;t++){z.push(v.geometries[u.mesh3js.geometries[t]])}var y=(z.length&&z[0]["vertexNormalArray"])?l:h;if(u.mesh3js.material!==undefined){y=v.materials[u.mesh3js.material]}var q=new d.Mesh(z,y);q.castShadow=(u.mesh3js.castShadow!==undefined)?u.mesh3js.castShadow:true;q.receiveShadow=(u.mesh3js.receiveShadow!==undefined)?u.mesh3js.receiveShadow:true;q.enableNormalDepth=(u.mesh3js.enableNormalDepth!==undefined)?u.mesh3js.enableNormalDepth:true;r=new c(q)}r.name=u.id;if(u.material!==undefined){r.setMaterial(v.materials[u.material])}v.nodes[u.id]=r;if(!v.root){v.root=r}if(u.matrix){var B=new d.Matrix4().setFromArray(u.matrix);r.setMatrix(B)}if(w.nodeCallback){w.nodeCallback(u,w,r)}}};this.createLayers=function(o,v){var s=v.data;for(var B in s.nodes){var p=s.nodes[B];var y=o[B];for(var t in y.occurrences){var x=y.occurrences[t].index;var r=y.occurrences[t];if(!r.layers.length){continue}p._occurrences[x].renderable.layer=new d.BufferLayer();for(var q=0;q<r.layers.length;q++){var u=r.layers[q];var A=s.geometries[u.geometry];var z=new d.DrawableInterval(u.drawableInterval.layerNum,u.drawableInterval.start,u.drawableInterval.count,s.materials[u.drawableInterval.material]);z.primitiveStart=u.drawableInterval.primitiveStart;z.primitiveCount=u.drawableInterval.primitiveCount;var w=new d.LayerInterval(A,A.drawingGroups[u.drawableGroup],z);p._occurrences[x].renderable.layer.addLayerInterval(w)}}}};this.processJSON=function(o){o.data.nbChunks=o.json.nbChunks;var p=o.json.zbin?"zbin":"bin";if(!o.data.chunks.length){this.getChunks(o.data.nbChunks,o,this.processChunks,p)}else{this.processChunks(o)}};this.processChunks=function(o){k=performance.now();var t=o.json;this.createTextures(t.textures,o);this.createMaterials(t.materials,o.data,o);this.createGeometries(t.geometries,o);this.createNodes(t.nodes,o);k=performance.now();for(var q in o.data.nodes){var r=o.data.nodes[q];var s=m[r.id];if(s){for(var p=0;p<s.length;p++){r.add(o.data.nodes[s[p]])}}m[r.id]=null}o.unstreamLayers&&this.createLayers(t.nodes,o);k=performance.now();o.destinationNode.add(o.data.root);if(o.doneCallback){o.doneCallback()}if(o.readyCallback){o.readyCallback()}delete this.modelsToLoad[o.loadIndex]};this.internalLoad=function(p){var q=this;var o=this.modelsToLoad[p];k=performance.now();if(!o.json){UWA.Ajax.request(o.url+".json"+o.urlOptions,{async:true,cors:true,withCredentials:true,onComplete:function(r){k=performance.now();o.json=JSON.parse(r);q.processJSON(o)}})}else{this.processJSON(o)}};this.getChunks=function(q,p,o,r){var t=this;if(!q){o.call(this,p);return}q--;var s=new XMLHttpRequest();s.open("GET",p.url+"__"+q+"__."+r+p.urlOptions,true);s.responseType="arraybuffer";s.withCredentials=true;s.onreadystatechange=function(u){if(s.readyState===4){if(s.status===0||s.status===200){p.data.chunks[q]=this.response;t.getChunks(q,p,o,r)}}};s.send(null)};this.load=function(G,B,o,t,C){var r=G;var E="";var D=null;var v=[];var z=B;var F=o;var u=t;var q=null;var y=null;var x=null;var w=C;var p=false;var s=false;if(G.destinationNode){r=G.url;E=G.urlOptions?G.urlOptions:"";D=G.json;v=G.chunks?G.chunks:[];z=G.readyCallback;F=G.progressCallback;u=G.doneCallback;q=G.nodeCallback;y=G.imageCallback;x=G.materialCallback;w=G.destinationNode;p=!!G.layers;s=!!G.reps}var A={url:r,urlOptions:E,path:r?g.parseUrl(r+".json").directoryPath:null,json:D,readyCallback:z,progressCallback:F,doneCallback:u,imagesCallback:y,materialsCallback:x,nodeCallback:q,destinationNode:w,unstreamLayers:p,unstreamReps:s,loadIndex:this.loadIndex,data:{nbChunks:v?v.length:0,chunks:v,root:null,nodes:{},geometries:{},textures:{},materials:{},reps:{}}};this.modelsToLoad[this.loadIndex]=A;this.internalLoad(this.loadIndex);this.loadIndex++}};return a});define("Visualization/StreamVisuLoader",["DS/Visualization/StreamVisuLoader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/StreamVisuLoader");return b});define("DS/Effects/ComputeMipMapRoughness",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/PreComputeShaders","DS/Shaders/DisplayMipsRoughnessShader","DS/Shaders/EncodeHDRShader","DS/Shaders/FlipXShader"],function(h,d,f,c,l,e,g,j){var b=d.extend({init:function(n,m){this._parent(n);this.gl=this.renderer.context;this.renderTargetPool=m;this.nbSamples=64;this.nbIterations=32;this.passFilterEnvMap=[];this.passMergeMips=null;this.saveComposer=null;this.passFlipX=null;this.passEncodeHDR=null;this.modeValue=0;this.shader=null;this.texture=null;this.nbMipMaps=7;this.inputLods=9;this.lodCst=7.707519;return this},setSize:function(n,m){this.width=(typeof n==="string")?parseInt(n):n;this.height=(typeof m==="string")?parseInt(m):m;this.inputLods=Math.round(Math.log(Math.min(this.width,this.height))/Math.log(2))-1},setNbSamples:function(p){this.nbSamples=p;var n=0.5*Math.log(0.5*this.width*this.height/this.nbSamples)/Math.log(2);this.lodCst=n.toFixed(8);for(var o=1;o<=this.nbMipMaps;o++){var q=o-1;var m=this.getCoeff(q);if(this.passFilterEnvMap[q]){this.passFilterEnvMap[q].material.defines.NB_SAMPLES=m*this.nbSamples;this.passFilterEnvMap[q].material.defines.NB_SAMPLES_IT=m*this.nbSamples/this.nbIterations;this.passFilterEnvMap[q].material.defines.LOD_CST=this.lodCst;this.passFilterEnvMap[q].material.needsUpdate=true}}},getCoeff:function(m){if(this.modeValue===1){return m>2?16:1}else{return m===6?32:(m>3?4:1)}},setMode:function(n){this.modeValue=0;switch(n){case"ASHIKMIN":this.modeValue=1;break;case"BECKMANN":this.modeValue=2;break;default:}for(var m=1;m<=this.nbMipMaps;m++){var o=m-1;if(this.passFilterEnvMap[o]){this.passFilterEnvMap[o].material.defines.MODE=m===7?3:this.modeValue;this.passFilterEnvMap[o].material.needsUpdate=true;this.passFilterEnvMap[o].uniforms.roughness.value=(this.modeValue===1||this.modeValue===4)?1-Math.pow(2,(m-6)/1.15):Math.pow(2,(m-6)/1.15)}}},setInput:function(r){this.texture=r;if(this.hasOwnProperty("iter")){this.iter=0}var p=[1,1,0.5,0.5,0.25,0.25,0.25,0.25];for(var s=1;s<=this.nbMipMaps;s++){var m=s-1;var n=p[s]*this.width;var w=p[s]*this.height;if(this.composers[m]){this.composers[m].setSize(n,w);this.passFilterEnvMap[m].uniforms.tEnvMap.value=this.texture}else{var u=new h.WebGLRenderTargetProperties(n,w,"linear");u.generateMipmaps=false;u.mapping=this.texture.mapping;this.composers[m]=new f(this.renderer,u,this.renderTargetPool);this.composers[m].composerContext.keepResult=true;this.composers[m].composerContext.noIdCheck=true;var q=this.nbSamples;var o=this.nbIterations;var t=this.getCoeff(m);var v={defines:{NB_SAMPLES:t*q,NB_SAMPLES_IT:t*q/o,DP_SCALE:this.shader.defines.DP_SCALE,LOD_CST:this.lodCst,MODE:s===7?3:(this.modeValue||0),MAX_LOD:this.inputLods},uniforms:this.shader.uniforms,vertexShader:this.shader.vertexShader,fragmentShader:this.shader.fragmentShader};this.passFilterEnvMap[m]=new c(v);this.passFilterEnvMap[m].uniforms.roughness.value=(this.modeValue===1||this.modeValue===4)?1-Math.pow(2,(s-6)/1.15):Math.pow(2,(s-6)/1.15);this.composers[m].addPass(this.passFilterEnvMap[m])}this.texture.linkToShaderPassUniform(this.passFilterEnvMap[m],this.passFilterEnvMap[m].uniforms.tEnvMap)}this.setComposers()},setComposers:function(){var n=this.nbMipMaps;if(this.composers[n]){this.composers[n].setSize(this.width,2*this.height)}else{var o=new h.WebGLRenderTargetProperties(this.width,2*this.height,"linear");o.generateMipmaps=false;this.composers[n]=new f(this.renderer,o,this.renderTargetPool);this.composers[n].composerContext.keepResult=true;this.composers[n].composerContext.noIdCheck=true;this.passMergeMips=new c(e.MergeMips);this.passMergeMips.renderToScreen=false;this.passFlipX=new c(j);this.composers[n].addPass(this.passMergeMips);this.composers[n].addPass(this.passFlipX);for(var m=1;m<=this.nbMipMaps;m++){var p=m-1;this.composers[p].linkToShaderPassUniform(this.passMergeMips,this.passMergeMips.uniforms["tDiffuse"+m])}}if(this.saveComposer){this.saveComposer.setSize(this.width,2*this.height)}else{var o=new h.WebGLRenderTargetProperties(this.width,2*this.height,"uintNearest");o.generateMipmaps=false;o.mapping=this.texture.mapping;this.saveComposer=new f(this.renderer,o,this.renderTargetPool);this.saveComposer.composerContext.keepResult=true;this.saveComposer.composerContext.noIdCheck=true;this.passEncodeHDR=new c(g);this.saveComposer.composerContext.setPassRenderToCanvas(this.passEncodeHDR,false);this.saveComposer.addPass(this.passEncodeHDR)}},encodeRGBE:function(){var o=this.composers[this.nbMipMaps];var p=o.composerContext.renderTargetProperties.width;var n=o.composerContext.renderTargetProperties.height;var m=this.saveComposer.composerContext.getResult(undefined,true);if(m){this.renderTargetPool.pushRenderTarget(m)}var q=o.composerContext.getResult(undefined,true);this.passEncodeHDR.uniforms.map.value=q;this.saveComposer.render();if(q){this.renderTargetPool.pushRenderTarget(q)}}});var a=b.extend({init:function(n,m){this._parent(n,m);this.shader=l.ComputeMipMapRoughnessFIS;return this},execute:function(m){if(m!==undefined){var o=this.composers[m].composerContext.getResult(undefined,true);this.composers[m].render();if(o){this.renderTargetPool.pushRenderTarget(o)}}else{for(var n=0;n<this.nbMipMaps;n++){if(this.modeValue>0&&n===6){continue}this.execute(n)}this.composers[this.nbMipMaps].render()}},});var k=b.extend({init:function(p,o){this._parent(p,o);this.iter=0;this.shader=l.ComputeMipMapRoughnessIterative;var m=new Uint8Array(2*2*4);for(var n=0;n<2*2*4;n++){m[n]=0}this.initTexture=new h.DataTexture(m,2,2,h.RGBAFormat,h.UnsignedByteType,new h.LatLongReflectionMapping(),h.ClampToEdgeWrapping,h.ClampToEdgeWrapping,h.LinearFilter,h.LinearFilter);this.initTexture.generateMipmaps=false;this.initTexture.needsUpdate=true;this.renderer.setTexture(this.initTexture,0);return this},execute:function(n){if(this.iter>=this.nbIterations){return}var m=this.iter;if(n!==undefined){var q=this.composers[n].composerContext.getResult(undefined,true);var o=this.getCoeff(n);this.passFilterEnvMap[n].uniforms.prevMap.value=!m?this.initTexture:q;this.passFilterEnvMap[n].uniforms.firstSample.value=o*m*this.nbSamples/this.nbIterations;this.composers[n].render();if(q){this.renderTargetPool.pushRenderTarget(q)}}else{for(var p=0;p<this.nbMipMaps;p++){if(this.modeValue>0&&p===6){continue}this.execute(p)}this.iter++;this.composers[this.nbMipMaps].render()}},});return{ComputeMipMapRoughnessFIS:a,ComputeMipMapRoughnessIterative:k}});define("DS/Visualization/StreamVisuLoader",["DS/VisuLoaders/StreamVisuLoader"],function(a){return a});define("Visualization/StreamVisuLoader",["DS/Visualization/StreamVisuLoader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/StreamVisuLoader");return b});define("DS/Effects/GenerateMipMaps",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/DownSamplingShaders","DS/Plugins/ClearPass","DS/Shaders/DisplayIrradianceMapShader"],function(d,b,e,c,a,h,g){var f=b.extend({init:function(k,j){this._parent(k);this.renderer=k;this.rtPool=j;this.map=null;this.nbIterations=9;this.passMip=[];this.passMergeMips=null;this.passDisplayMap=null;return this},setSize:function(k,j){this.width=(typeof k==="string")?parseInt(k):k;this.height=(typeof j==="string")?parseInt(j):j;this.nbIterations=Math.round(Math.log(Math.min(this.width,this.height))/Math.log(2))-1},setInput:function(p){if(!p){return}this.map=p;var o=0.5;if(this.composers[0]){for(var k=0;k<this.nbIterations;k++){this.composers[k].setSize(o*this.width,o*this.height);this.passMip[k].uniforms.invSize.value.set(1/(o*this.width),1/(o*this.height));o*=0.5}this.composers[this.nbIterations].setSize(this.width,2*this.height)}else{for(var k=0;k<this.nbIterations;k++){var j=new d.WebGLRenderTargetProperties(o*this.width,o*this.height,"linear");this.composers[k]=new e(this.renderer,j,this.rtPool);this.composers[k].composerContext.keepResult=false;this.composers[k].composerContext.noIdCheck=true;this.passMip[k]=new c(a.DownSamplingBlur,undefined,"GenerateMips"+k);this.passMip[k].uniforms.invSize.value.set(1/(o*this.width),1/(o*this.height));this.passMip[k].material.needsUpdate=true;this.passMip[k].renderToScreen=false;this.composers[k].addPass(this.passMip[k]);o*=0.5}var l=new d.WebGLRenderTargetProperties(this.width,2*this.height,"linear");this.composers[this.nbIterations]=new e(this.renderer,l,this.rtPool);this.composers[this.nbIterations].composerContext.keepResult=false;this.composers[this.nbIterations].composerContext.noIdCheck=true;this.passMergeMips=new c(a.MergeMips(this.nbIterations),undefined,"MergeMips");this.passMergeMips.renderToScreen=false;this.composers[this.nbIterations].addPass(this.passMergeMips);for(var k=1;k<this.nbIterations;k++){this.passMip[k].addRequiredComposer(this.composers[k-1]);this.composers[k-1].linkToShaderPassUniform(this.passMip[k],this.passMip[k].uniforms.tDiffuse2)}this.passMergeMips.addRequiredComposer(this.composers[this.nbIterations-1]);this.map.linkToShaderPassUniform(this.passMergeMips,this.passMergeMips.uniforms.tDiffuse1);for(var k=0;k<this.nbIterations;k++){this.composers[k].linkToShaderPassUniform(this.passMergeMips,this.passMergeMips.uniforms["tDiffuse"+(k+2)])}}this.map.linkToShaderPassUniform(this.passMip[0],this.passMip[0].uniforms.tDiffuse2);var n=this.nbIterations+1;if(this.composers[n]){this.composers[n].setSize(this.width,2*this.height)}else{var m=new d.WebGLRenderTargetProperties(this.width,2*this.height,"uint");m.generateMipmaps=false;this.composers[n]=new e(this.renderer,m,this.rtPool);this.composers[n].composerContext.keepResult=false;this.composers[n].composerContext.noIdCheck=true;this.passDisplayMap=new c(g,undefined,"DisplayMips");this.composers[n].composerContext.setPassRenderToCanvas(this.passDisplayMap,true);this.composers[n].addPass(this.passDisplayMap);this.composers[this.nbIterations].linkToShaderPassUniform(this.passDisplayMap,this.passDisplayMap.uniforms.tDiffuse1)}},execute:function(){this.composers[this.nbIterations].render()},renderToScreen:function(){this.composers[this.nbIterations+1].render()}});return f});define("DS/Visualization/AmbianceGenerator",["DS/CoreEvents/Events","UWA/Class","DS/Effects/ConvertLatLongToDualParaboloid","DS/Effects/GenerateMipMaps","DS/Effects/ComputeMipMapRoughness","DS/Visualization/ThreeJS_R57"],function(d,b,c,g,a,k){var j=b.extend({init:function(l,n){this.viewers=k._AmbianceGenerators.viewers;this.nbSamples=n;this.onDoneCallBack=null;k.EventDispatcher.call(this);this.finished=false;var m=this;this.addEventListener("done",function(o){if(o.isDone){m.viewers.forEach(function(p){p.render()})}if(o.isDone){console.log("INFO: Finished computing ambiance")}if(m.onDoneCallBack&&o.isDone){m.onDoneCallBack()}});this.renderer=l.renderer.renderer;this.convertEffect=new c(this.renderer,l.renderer.renderTargetPool);this.mipMapEffect=new g(this.renderer,l.renderer.renderTargetPool);this.computeEffect=null;this.frameIndex=0;this.init=false},dispose:function(){this.convertEffect.dispose();this.convertEffect=null;this.mipMapEffect.dispose();this.mipMapEffect=null;this.computeEffect.dispose();this.computeEffect=null;this.init=false},_setNbSamples:function(){console.warn("A virtual function has been called")},setValues:function(m,o){if(m){var n=m.composerContext&&m.composerContext.width;var l=m.composerContext&&m.composerContext.height;if(m instanceof k.Texture){n=m.image.width;l=m.image.height}this.convertEffect.setSize(n,l);this.mipMapEffect.setSize(n,l);this.computeEffect.setSize(n,l);this.convertEffect.setEnvMap(m);this.mipMapEffect.setInput(this.convertEffect.composers[1]);this.computeEffect.setInput(this.mipMapEffect.composers[this.mipMapEffect.nbIterations]);this._setNbSamples();this.computeEffect.setMode(o);this.init=true}},_execute:function(){if(this.init){this.convertEffect.execute();this.mipMapEffect.execute();this.computeEffect.execute();this.computeEffect.encodeRGBE()}},_getResult:function(){if(!this.init){return{}}var m=this.isDone();var l=this.computeEffect.saveComposer.composerContext.getResult(undefined,m);if(l){l.hdr=true;l.hasDiffuse=this.computeEffect.modeValue===0;l.mapping=new k.LatLongReflectionMapping()}return l},setCallBack:function(l){this.onDoneCallBack=l},isDone:function(){return this.finished},});var h=j.extend({init:function(l,m){this._parent(l,m);this.computeEffect=new a.ComputeMipMapRoughnessFIS(this.renderer,l.renderer.renderTargetPool)},execute:function(){var l=Date.now();this._execute();this.finished=true;this.dispatchEvent({type:"done",time:l,isDone:this.isDone()});return this._getResult()},_setNbSamples:function(){this.computeEffect.setNbSamples(this.nbSamples)}});var f=j.extend({init:function(l,m){this._parent(l,m);this.computeEffect=new a.ComputeMipMapRoughnessIterative(this.renderer,l.renderer.renderTargetPool)},_isExecuteReady:function(m){var l=true;this.viewers.forEach(function(n){l=l&&(n.renderIteration>0&&(m-n.timeIter0>n.delayBeforeIteration))});return l},execute:function(){var m=Date.now();var l=this.computeEffect.iter===0||this._isExecuteReady(m);if(l){this._execute();this.finished=this.computeEffect.iter>=this.computeEffect.nbIterations;this.dispatchEvent({type:"done",time:m,iteration:this.computeEffect.iter,isDone:this.isDone()})}return this._getResult()},_setNbSamples:function(){this.computeEffect.setNbSamples(this.nbSamples)}});var e=b.extend({init:function(l){this.generators=new Map();this.generated=new Map();this.toCompute=[];this.viewers=k._AmbianceGenerators.viewers;this.cb=l},_getViewer:function(){return this.viewers[0]},_getGenerator:function(l,m){if(m){l+="-iterative"}if(!this.generators.has(l)){var o=this._getViewer();var n=m?new f(o,o.ODTMode?256:2048):new h(o,o.ODTMode?256:1024);if(this.cb){n.setCallBack(this.cb)}this.generators.set(l,n)}return this.generators.get(l)},_getAmbiance:function(l,m){if(m){l+="-iterative"}return this.generated.get(l)},_updateAmbiance:function(o,n,p,l,m){if(p){n+="-iterative"}this.generated.set(n,{ambiance:o,complete:l,usedBy:m})},_disposeGenerator:function(l,m){if(m){l+="-iterative"}if(this.generators.has(l)){var n=this.generators.get(l);this.generators["delete"](l);n.dispose()}},_setCB:function(l){this.cb=l;this.generators.forEach(function(n,m,o){n.setCallBack(l)})},getAmbiance:function(l,o,p,q){var n=l;if(o){l+="-iterative"}if(!this.generated.has(l)){this.generated.set(l,{ambiance:null,complete:false,usedBy:new Set()});this.toCompute.push({name:n,iterative:o,hdr:p.hdr,brdf:p.brdf})}var m=this.generated.get(l);m.usedBy.add(q);return m},decreaseUseCount:function(l){this.generated.forEach(function(n,m,o){n.usedBy["delete"](l);if((n.usedBy.size<1)&&(n.ambiance)){n.ambiance.dispose();o["delete"](m)}})},dispose:function(){this.generated.forEach(function(m,l,n){if(m.ambiance){m.ambiance.dispose()}});this.generated.clear();this.generators.forEach(function(m,l,n){m.dispose()});this.generators.clear()},update:function(l,s){var p=this.toCompute;var t=0;for(var o=0;o<p.length;o++){var n=p[o];var q=this._getAmbiance(n.name,n.iterative);if(!q||q.complete){this._disposeGenerator(n.name,n.iterative);t++;continue}var r=this._getGenerator(n.name,n.iterative);if(!r.init){r.setValues(n.hdr,n.brdf)}if(r.renderer===s&&r.frameIndex<l&&!r.isDone()){var m=r.execute();this._updateAmbiance(m,n.name,n.iterative,r.isDone(),q.usedBy);r.frameIndex=l;if(r.isDone()){this._disposeGenerator(n.name,n.iterative);t++}}}if(t===p.length){this.toCompute=[];this.generators.clear()}this.viewers.forEach(function(u){u.forceRender=true})},});return e});define("DS/Shaders/ConvertCubemapToLatlongShader",["DS/Visualization/ThreeJS_DS"],function(a){var b={defines:{ORIENTATION:0,},uniforms:{cubemap:{type:"t",value:null},},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",a._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform samplerCube cubemap;","const float PI = 3.14159265358979323846264;","varying vec2 vUv;","void main() {","gl_FragColor = vec4(0.0);","vec3 N;","float phi = PI * (2.0 * vUv.x - 1.0);","#if ORIENTATION > 0","float theta = PI * vUv.y;","N.x = sin(theta) * sin(phi);","N.y = cos(theta);","N.z = sin(theta) * cos(phi);","#else","float theta = PI * (1.0 - vUv.y);","N.x = sin(theta) * cos(phi);","N.y = sin(theta) * sin(phi);","N.z = cos(theta);","#endif","gl_FragColor = textureCube(cubemap, N);","}"].join("\n")};return{ConvertCubemapToLatlong:b}});define("DS/Effects/DownSamplingEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/DownSamplingShaders","DS/Plugins/ClearPass"],function(e,c,f,d,b,g){var a=c.extend({init:function(j,h){this._parent(j);this.renderer=j;this.rtPool=h;this.map=null;this.nbIterations=3;this.passBlurH=[];return this},setSize:function(j,h){this.width=parseInt(j);this.height=parseInt(h)},setInput:function(l){if(!l){return}this.map=l;var k=0.5;if(this.composers[0]){for(var j=0;j<this.nbIterations;j++){this.composers[j].setSize(k*this.width,k*this.height);this.passBlurH[j].uniforms.invSize.value.set(1/(k*this.width),1/(k*this.height));k*=0.5}}else{for(var j=0;j<this.nbIterations;j++){var h=new e.WebGLRenderTargetProperties(k*this.width,k*this.height,"uint");this.composers[j]=new f(this.renderer,h,this.rtPool);this.composers[j].composerContext.keepResult=false;this.passBlurH[j]=new d(b.DownSampling);this.passBlurH[j].uniforms.invSize.value.set(1/(k*this.width),1/(k*this.height));this.passBlurH[j].material.needsUpdate=true;this.passBlurH[j].renderToScreen=false;this.composers[j].addPass(this.passBlurH[j]);k*=0.5}this.composers[this.nbIterations-1].composerContext.keepResult=false;for(var j=1;j<this.nbIterations;j++){this.passBlurH[j].addRequiredComposer(this.composers[j-1]);this.composers[j-1].linkToShaderPassUniform(this.passBlurH[j],this.passBlurH[j].uniforms.tDiffuse2)}}this.map.linkToShaderPassUniform(this.passBlurH[0],this.passBlurH[0].uniforms.tDiffuse2)},execute:function(){this.composers[this.nbIterations-1].render()}});return a});define("DS/Visualization/SceneGraphFactory",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/EditableMesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/CanvasNodeTexture","DS/SceneGraphNodes/CanvasNode","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/Canvas2DNode","DS/Effects/ComputeSDFFontIterative","DS/Effects/DownSamplingEffect","DS/Effects/ComputeSDFFontMergeTiles"],function(t,j,d,a,r,f,o,k,p,w,l,n,v,x,c,u){var b=new p();var s={textCanvas:null,iterativeCompute:null,downSampling:null,mergeTiles:null};var q=["left","center","right"];var h=[0,0.5,1];var m=["top","bottom","middle","alphabetic","hanging"];var g=[0,1,0.5,1,0];var e={createMeshNode:function(C,B,M,J){var y,K,F,E=(M!==undefined)?M:0,N=(B!==undefined)?B:C.material,O,Q,z,V,D;if(t.disableJHGDev){if((N===undefined)||(N===null)){y=new t.Color();K=new t.Color(6710886);F=new t.Color();N=new t.MeshPhongMaterial({color:y.getHex(),opacity:1});N.line=new t.LineBasicMaterial({color:K.getHex(),lineWidth:1,opacity:1});N.point=new t.ParticleBasicMaterial({color:F.getHex(),size:1,opacity:1})}}O=new f.SGBag();Q=new f.SGRep({cgmId:E,parent:O});f.validatePrimitiveGroup(C);var I=f.checkMeshOptimizable(C);var P=I&&C.editable;var W=I&&(C.editable||C.optimized);var G=!P&&C.sharing;if(W){V=[f.createGeometryOptimized(C,Q)];if(P){V[0].editable=true}}else{if(C.editable){console.warn("Could not make the mesh editable since it does not satisfy the editability rules : no strips and fans, no multi-indexation, 1 buffer per vertex component, 1 index buffer.")}else{if(C.optimized){console.warn("Could not optimize the mesh build since it does not satisfy the editability rules : no strips and fans, no multi-indexation, 1 buffer per vertex component, 1 index buffer.")}}for(var U=0;U<C.buffers.length;U++){var S=C.buffers[U];if(S&&S.component===f.VertexComponentEnum.DIFFUSE_COLOR){if(S.dimension===3){S.dimension=4;S.size*=4/3;var X=S.data;var H=X.length/3;var L=new Float32Array(4*H);var R=0;for(var T=0;T<H;T++){L[R]=X[3*T];L[R+1]=X[3*T+1];L[R+2]=X[3*T+2];L[R+3]=1;R+=4}S.data=L}else{if(S.dimension!==4){console.error("ERROR : Your Color Buffer should have 4 values per vertex (RGBA)")}}break}}z=f.convertToGeometry3js(C,undefined,undefined,undefined,J);z.rep=Q;V=f.divideRep(z);V.sceneGraph=O;if(C.patternOffsets){V.patternOffsets=C.patternOffsets}}D=f.convertTo3jsMesh(V,N,true,G);var A;if(P){A=new a(D)}else{A=new d(D)}if(!t.disableJHGDev&&N){A.setMaterial(N)}if(C.noz){A.setRenderPasses(["noz"])}return A},isReady:function(){return this.root.isReady()},applyMaterialOpacityOverrideToPath:function(){return false},applyMaterialOverrideToPath:function(){return false},removeAnyMaterialOverride:function(){return false},createCuboidNode:function(z){var y=b.CreateVis3DCuboid(z);return this.createMeshNode(y,z.material)},createSphereNode:function(z){var y=b.CreateVis3DSphere(z);return this.createMeshNode(y,z.material,undefined,"mono")},createTubeNode:function(z){var y=b.CreateVis3DTube(z);return this.createMeshNode(y,z.material,undefined,"mono")},createCylinderNode:function(z){var y=b.CreateVis3DCylinder(z);return this.createMeshNode(y,z.material,undefined,"mono")},createConeNode:function(z){var y=b.CreateVis3DCone(z);return this.createMeshNode(y,z.material,undefined,"mono")},createCylinderCustomNode:function(z){var y=b.CreateVis3DCylinderCustom(z);return this.createMeshNode(y,z.material,undefined,"mono")},createLineNode:function(z){var y=b.createLine(z);return this.createMeshNode(y,z.material)},createRectangleNode:function(z){var y=b.createRectangle(z);return this.createMeshNode(y,z.material)},createCircleNode:function(z){var y=b.createCircle(z);return this.createMeshNode(y,z.material)},createTorusNode:function(z){var y=b.createTorus(z);return this.createMeshNode(y,z.material)},createPointsNode:function(z){var y=b.createPoints(z.positions,z.color,z.size,z.layerNb);return this.createMeshNode(y,z.material)},createSimpleMeshNode:function(z){var y=b.createMesh(z.bufferPosition,z.bufferNormal,z.bufferUV,z.bufferIndex,z.glType,z.color,undefined,z.axis,z.layerNb);return this.createMeshNode(y,z.material)},createTextNode:function(y){if(y.sdf){return this.createSDFTextNode.apply(this,arguments)}else{return this.createTextNodeZoomable.apply(this,arguments)}},createSDFTextNode:function(A){A.resolutionCoef=256;if(!A.color){A.color=new t.Color("white")}var aq,S,I,at,ad,C,P,av,U,T,E,N;aq="font-family: "+A.font+"; font-size: "+A.resolutionCoef+"px;";S=b._determineTextSize(A.text,aq);I=S.width;at=S.height;ad=I/at;if(!s.textCanvas){s.textCanvas=document.createElement("canvas")}C=s.textCanvas;C.width=I;C.height=at;P=C.getContext("2d");av=0;U=0;P.fillStyle="#ffffff";P.fillRect(0,0,I,at);P.fillStyle="#000000";P.lineWidth=0;P.strokeStyle="#000000";P.font=A.resolutionCoef+"px "+A.font;P.textAlign="left";P.textBaseline="top";P.fillText(A.text,av,U);P.restore();T=I/A.resolutionCoef;E=b.createRectangle(A.fontSize*T,A.fontSize*T/ad,true,undefined,undefined,A.layerNb);E.noz=A.layerNb>0;var af=null;var aj=50;if(C.width!==0||C.height!==0){if(!s.iterativeCompute){s.iterativeCompute=new x(debugWebGLV6Viewer.renderer.renderer,debugWebGLV6Viewer.renderer.renderTargetPool)}if(!s.downSampling){s.downSampling=new c(debugWebGLV6Viewer.renderer.renderer,debugWebGLV6Viewer.renderer.renderTargetPool)}if(!s.mergeTiles){s.mergeTiles=new u(debugWebGLV6Viewer.renderer.renderer,debugWebGLV6Viewer.renderer.renderTargetPool)}var G=s.iterativeCompute.gl;var Y=performance.now();var R=Y;var am=P.getImageData(0,0,C.width,C.height);var O=new ArrayBuffer(am.data.length);var ai=512;var B=512;var ax=64;var ac=8;var ae=ai/ac;var y=B/ac;var W=Math.floor(C.width/ac);var J=Math.floor(C.height/ac);var X=1+Math.ceil((C.width-ai)/(ai-ax));var V=1+Math.ceil((C.height-B)/(B-ax));var au=new Uint8Array(4*ai*B);var z=new Uint8Array(4*ae*y);var Q=new Uint8Array(4*W*J);var N=null;var L=performance.now();for(var ap=0;ap<V;ap++){var Z=(B-ax)*ap;var F=Z/ac;for(var ao=0;ao<X;ao++){var ab=(ai-ax)*ao;var H=ab/ac;var al=(ao===X-1)?(C.width-ao*(ai-ax)):ai;var ak=(ap===V-1)?(C.height-ap*(B-ax)):B;var ah=Math.floor(al/ac);var ag=Math.floor(ak/ac);var M=Z*C.width+ab;var D=0;Y=performance.now();for(var K=0;K<B;K++){for(var aw=0;aw<ai;aw++){if(aw<al&&K<ak){var an=M+K*C.width+aw;au[D++]=am.data[4*an];au[D++]=am.data[4*an+1];au[D++]=am.data[4*an+2];au[D++]=am.data[4*an+3]}else{au[D++]=255;au[D++]=255;au[D++]=255;au[D++]=255}}}if(!N){N=new t.DataTexture(au,ai,B,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping(),t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.NearestFilter,t.NearestFilter);s.iterativeCompute.setMap(N,aj);s.downSampling.setSize(ai,B);s.downSampling.setInput(s.iterativeCompute.composers[1]);s.mergeTiles.setSize(W,J);s.mergeTiles.setInput(s.downSampling.composers[2])}N.needsUpdate=true;Y=performance.now();for(var ar=0;ar<aj;ar++){s.iterativeCompute.executeStep(ar,(ar===(aj-1)))}s.downSampling.execute();s.mergeTiles.setTileInfos(H,F,ae,y,ah,ag);s.mergeTiles.execute()}}Y=performance.now();G.readPixels(0,0,W,J,G.RGBA,G.UNSIGNED_BYTE,Q);af=new t.DataTexture(Q,W,J,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping(),t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearMipMapLinearFilter);af.needsUpdate=true;af.flipY=true;console.log(">>>>> generated SDF from bitmap in "+(performance.now()-R)+"ms")}E.material=new t.ShaderMaterialDS({force:true,side:t.FrontSide,transparent:true,uniforms:{fontMap:{type:"t",value:af},color:{type:"v3",value:new t.Vector3(A.color.r,A.color.g,A.color.b)},ratio:{type:"f",value:J/W},},vertexShaderPars:"varying vec2 vUv;",vertexShaderBody:[t._DefaultShaderChunk.model_view_transformation_vertex,t._DefaultShaderChunk.model_view_normal_vertex,"vUv = uv;","gl_Position = projectionMatrix * mvPosition;",].join("\n"),fragmentShaderPars:["varying vec2 vUv;","uniform sampler2D fontMap;","uniform vec3 color;","uniform float ratio;"].join("\n"),fragmentShaderBody:["float epsilon = 0.003;","float alphaTest = 0.01;","float texel = texture2D(fontMap, vUv).r;","#ifdef GL_OES_standard_derivatives","    float w = clamp(200.0 * epsilon * (abs(dFdx(texel)) + abs(dFdy(texel))), 0.0, 0.5);","#else","    float w = epsilon;","#endif","float alpha = smoothstep(0.5 - w, 0.5 + w, 1.0 - texel);","alpha = pow(alpha, 1.0/2.2);","if (alpha < alphaTest) discard;","gl_FragColor = vec4(color, alpha);"].join("\n")});return this.createMeshNode(E)},createTextNodeZoomable:function(Q){var O=Q.resolutionCoef||32;var B="font-family: "+Q.font+"; font-size: "+O+"px;";var K=b._determineTextSize(Q.text,B);var A=K.width;var M=K.height;var F=A/M;var E=Q.textAlign?q[Q.textAlign]:"left";var P=Q.textBaseline?m[Q.textBaseline]:"top";var C=Q.textAlign?h[Q.textAlign]:0;var R=Q.textBaseline?g[Q.textBaseline]:0;var z=Q.zoom||1;var J=A/O;var N=Q.fontSize*J*z;var L=Q.fontSize*J/F*z;var G=Q.stroke?Q.stroke:false;var S=A;var I=M;if(Q._fix&&(!S||!I||!isFinite(I)||!isFinite(S))){return null}var y=new w({width:S,height:I,drawCB:function(W,T,V){var X=C*S;var U=R*I;try{T.fillStyle="#"+Q.color.getHexString();T.lineWidth=0;T.strokeStyle="#"+Q.color.getHexString();T.font=(Q.bold?"bold ":"")+O+"px "+Q.font;T.textAlign=E;T.textBaseline=P;if(G){T.strokeText(Q.text,X,U)}else{T.fillText(Q.text,X,U)}if(Q._debug){T.strokeStyle="red";T.moveTo(0,U);T.lineTo(S,U);T.stroke();T.moveTo(0,0);T.moveTo(X,0);T.lineTo(X,I);T.stroke();T.moveTo(0,0)}if(window.WUXDisableTextNodes){T.clearRect(0,0,S,I);return}}catch(Y){}},rectangleTexture:true,maxZoom:8,depthWrite:Q.depthWrite});var D;var H=Q.hotspot||{x:0,y:0};if(Q.bbox){D=new l({name:Q.name,bottomLeftcorner:new t.Vector3(Q.bbox[0],Q.bbox[2],0),widthVector:new t.Vector3(Q.bbox[1]-Q.bbox[0],0,0),heightVector:new t.Vector3(0,Q.bbox[3]-Q.bbox[2],0),canvasNodeTexture:y},e)}else{D=new l({name:Q.name,bottomLeftcorner:new t.Vector3(-H.x*N,-H.y*L,0),widthVector:new t.Vector3(N,0,0),heightVector:new t.Vector3(0,L,0),canvasNodeTexture:y},e)}return D},createCanvasNode:function(y){return new l(y,e)},createCanvas2DNode:function(y){return new v(y,e)},createNodeFromTHREEMesh:function(z){var y=b.convertFromTHREEMesh(z);return this.createMeshNode(y)},createFixedSizeNode:function(z){z=z||{};var y=new n({name:z.name,ratio:z.ratio||1});return y},createGeometry3:function(at,Q,ab,an){var K,I,Z,H,R,ah,ai,av,G,ao,aj,am,J,C,S,V,ak,ac,W,ad,ae,ag,ar,U,L,M,P,N,X,A,ap,z,E,B,O,af,au,T,Y,D,aq,al;K=false;var y=(at.byteLength>28);R=null;if(y){if(typeof an==="undefined"){I=new t.Color();Z=new t.Color(3355443);H=new t.Color();an=new t.MeshPhongMaterial({color:I.getHex(),opacity:1,side:t.DoubleSide});an.line=new t.LineBasicMaterial({color:Z.getHex(),lineWidth:1,opacity:1});an.point=new t.ParticleBasicMaterial({color:H.getHex(),size:1,opacity:1});an.force=true}R=new f.Mesh()}ah=0;ai=(new Uint32Array(at,ah,1))[0];ah+=4;if(y){av=(new Uint32Array(at,ah,1))[0];ah+=4;G=new f.SGRep({cgmId:av});R.rep=G;ao=(new Uint32Array(at,ah,1))[0];ah+=4;aj=0;am=[];J=[];for(aq=0;aq<ao;aq++){C=new Uint32Array(at,ah,3);ah+=12;S=C[0];V=C[1];ak=C[2];ac=new f.MeshPrimitive(S,0,V,ak);aj+=ak;J.push(ac)}W=new f.DrawingGroup(an,an,4,0,aj);W.geometry=R;W.primitives=J;for(aq=0;aq<J.length;aq++){J[aq].groupIndex=W}R.drawingGroups.push(W);ad=aj;ae=[];ag=[];ar=(new Uint32Array(at,ah,1))[0];ah+=4;for(aq=0;aq<ar;aq++){U=new Uint32Array(at,ah,3);ah+=12;L=U[0];V=U[1];ak=U[2];M=new f.MeshPrimitive(L,0,V,ak);aj+=ak;ag.push(M)}P=new f.DrawingGroup(an.line,an.line,1,ad,aj-ad);P.geometry=R;P.primitives=ag;for(aq=0;aq<ag.length;aq++){ag[aq].groupIndex=P}R.drawingGroups.push(P);N=new Uint32Array(at,ah,4);ah+=Q?16:12;X=N[0];A=N[1];ap=N[2];z=N[3];E=new Uint32Array(at,ah,X);ah+=4*X;B=new Float32Array(at,ah,3*A);ah+=12*A;O=new Float32Array(at,ah,3*ap);ah+=12*ap;if(Q){af=new Float32Array(at,ah,3*z);ah+=12*z;R.vertexUvArray=af}R.vertexPositionArray=B;R.vertexNormalArray=O;R.vertexIndexArray=E;au=[0,0,0];T=[0,0,0];Y=R.vertexPositionArray.length;if(Y>=3){au=[R.vertexPositionArray[0],R.vertexPositionArray[1],R.vertexPositionArray[2]];T=[R.vertexPositionArray[0],R.vertexPositionArray[1],R.vertexPositionArray[2]];for(al=0;al<Y;al+=3){if(R.vertexPositionArray[al]<au[0]){au[0]=R.vertexPositionArray[al]}if(R.vertexPositionArray[al+1]<au[1]){au[1]=R.vertexPositionArray[al+1]}if(R.vertexPositionArray[al+2]<au[2]){au[2]=R.vertexPositionArray[al+2]}if(R.vertexPositionArray[al]>T[0]){T[0]=R.vertexPositionArray[al]}if(R.vertexPositionArray[al+1]>T[1]){T[1]=R.vertexPositionArray[al+1]}if(R.vertexPositionArray[al+2]>T[2]){T[2]=R.vertexPositionArray[al+2]}}}R.AABB={min:au,max:T};D=f.divideRep(R);R=f.convertTo3jsMesh(D,an);R=new d(R,"dim-"+ai)}if(ab){var F={name:"dim-"+ai,mesh:null};ab.traverse(function(ax,aw){if(ax.name===aw.name){aw.mesh=ax;return true}return false},F);if(F.mesh!==null){ab.remove(F.mesh)}if(y){ab.add(R)}}at={eventChannel:"/VISU/",eventType:"@onServerDone",eventID:"",from:""};o.publish({event:"/VISU/",data:at});return R},};return e});define("Visualization/SceneGraphFactory",["DS/Visualization/SceneGraphFactory","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/SceneGraphFactory");return b});define("DS/Visualization/PolygonTessellator",["UWA/Class","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Mesh/MeshUtils","libtess/libtess.min"],function(b,h,g,f,a){var c=0;var d=b.extend({init:function(){this.polygons=[];this.polygonGroupEnd=[];this.currentPolygon=this._createEmptyPolygon()},addPointToCurrentPolygonLoop:function(n,o,m){if(this.currentPolygon.points.length===0){this.currentPolygon.userData=m}var l;if(this.currentPolygon.points.length>0){l=this.currentPolygon.points.length-2;if(this.currentPolygon.points[l]===n&&this.currentPolygon.points[l+1]===o){return}}this.currentPolygon.points.push(n);this.currentPolygon.points.push(o)},closeCurrentPolygonLoop:function(){if(this.currentPolygon.points.length>2){this.currentPolygon.closed=true;this.polygons.push(this.currentPolygon)}this.currentPolygon=this._createEmptyPolygon()},endCurrentPolygon:function(){this._startNewPolygon();this.polygonGroupEnd.push(this.polygons.length)},createNode3D:function(w,t){var s,v,x;var C;var B=new g();var u,D;var y,A=[];var o,l;var n=0,m=this.polygonGroupEnd.length;for(o=n;o<m;o++){l=true;u=[];for(s=(o===0)?0:this.polygonGroupEnd[o-1];s<this.polygonGroupEnd[o]&&l;s++){if(this.polygons[s].closed){D=[];v=this.polygons[s].points;for(x=0;x<v.length;x+=2){D.push(v[x],-v[x+1])}D.push(v[0],-v[1]);u.push(D)}else{l=false}}if(u.length&&l){y=j(u,t);A=A.concat(y)}else{if(u.length){throw new Error("fill open polygon")}}}if(A.length===0){return null}var p=new Uint32Array(A.length/3);for(var E=0;E<p.length;++E){p[E]=E}var r=[];for(E=0;E<A.length;E+=3){r.push(0,0,1)}var q=h.createSimpleMeshNode({bufferPosition:A,bufferIndex:p,glType:f.ConnectivityTypeEnum.TRIANGLES,material:w,bufferNormal:r});B.addChild(q);return B},_startNewPolygon:function(){if(this.currentPolygon.points.length>2){this.polygons.push(this.currentPolygon)}this.currentPolygon=this._createEmptyPolygon()},_createEmptyPolygon:function(){return{points:[],closed:false,userData:null,id:c++}}});var e=(function k(){function n(s,r){r[r.length]=s[0];r[r.length]=s[1];r[r.length]=s[2]}function q(r){if(r!==a.primitiveType.GL_TRIANGLES){console.log("expected TRIANGLES but got type: "+r)}}function l(r){console.log("error callback");console.log("error number: "+r)}function p(t,s,r){return[t[0],t[1],t[2]]}function m(r){}var o=new a.GluTesselator();o.gluTessCallback(a.gluEnum.GLU_TESS_VERTEX_DATA,n);o.gluTessCallback(a.gluEnum.GLU_TESS_BEGIN,q);o.gluTessCallback(a.gluEnum.GLU_TESS_ERROR,l);o.gluTessCallback(a.gluEnum.GLU_TESS_COMBINE,p);o.gluTessCallback(a.gluEnum.GLU_TESS_EDGE_FLAG,m);return o})();function j(r,q){e.gluTessNormal(0,0,1);var o=[];e.gluTessBeginPolygon(o);for(var n=0;n<r.length;n++){e.gluTessBeginContour();var m=r[n];for(var l=0;l<m.length;l+=2){var p=[m[l],m[l+1],q];e.gluTessVertex(p,p)}e.gluTessEndContour()}e.gluTessEndPolygon();return o}return d});define("DS/SceneGraphNodes/RefPlaneNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory","DS/Visualization/TextNode","DS/Visualization/MaterialApplication"],function(j,g,c,m,d,f,k,h,a,b){var l=new j.Matrix4();var e=g.extend({init:function(q){this._parent(q.name);this._isDynamic=true;this.matInherit=window.newMaterialInheritance;this.fixedSize=q.fixedSize;var u=this;this.cbChange=function(y){for(var v=0;v<u._occurrences.length;v++){var x=u._occurrences[v];var w=x.parent;if(!x.scene3js||!w){continue}var A=x.scene3js.viewer;var B=true;if(x._getVisibilityFree()){B=x._getVisible()}else{B=A.getVisibleSpace()?x.visible:!x.visible}if(B){if(y&&y.viewpoint&&y.viewpoint.viewer){if(A!==y.viewpoint.viewer){continue}}var z=A.currentViewpoint;u._updateNode(x.matrix,y,z)}}};this.tokenChange=null;this._length=new j.Vector2(10,10);this._frontBorderMaterial=new j.LineBasicMaterial({color:new j.Color("green"),opacity:0.7,lineWidth:2,side:2,polite:true,force:!this.matInherit,forceSide:true,enableClipPlanes:false});this._frontBorderMaterial.line=this._frontBorderMaterial;var p=this._frontBorderMaterial.color.getHSL();var r=p.h+20/255;var t=Math.min(1,1.3*p.l);this._backBorderMaterial=new j.LineBasicMaterial({color:new j.Color().setHSL(r,p.s,t),opacity:0.7,lineWidth:2,side:2,polite:true,force:!this.matInherit,forceSide:true,enableClipPlanes:false});this._backBorderMaterial.line=this._backBorderMaterial;this._frontPlaneMaterial=new j.MeshBasicMaterial({color:new j.Color("green"),opacity:0.2,side:0,polygonOffset:true,polygonOffsetFactor:0.5,force:!this.matInherit,forceSide:true,enableClipPlanes:false});var s=this._frontPlaneMaterial.color.getHSL();r=s.h+20/255;t=Math.min(1,1.3*s.l);this._backPlaneMaterial=new j.MeshBasicMaterial({color:new j.Color().setHSL(r,s.s,t),opacity:0.2,side:1,polygonOffset:true,polygonOffsetFactor:0.5,force:!this.matInherit,forceSide:true,enableClipPlanes:false});this._xIndicatorMaterial=new j.MeshBasicMaterial({color:new j.Color("green"),opacity:0.5,side:2,force:!this.matInherit,forceSide:true,depthTest:false,enableClipPlanes:false});this._margin=0.02;this._frontText={data:"",color:new j.Color("green"),opacity:0.7,size:0.5,token:null,textNode:new g()};this._backText={data:"",color:new j.Color("green"),opacity:0.7,size:0.5,token:null,textNode:new g()};this._frontPlane=this._buildEditableRectangle(false,this._frontPlaneMaterial.color,this._frontPlaneMaterial.opacity);this._frontPlaneGAS=this._frontPlane._occurrences[0].renderable.geometry[0].drawingGroups[0].gas;if(this.matInherit){var o=new b({faceMaterial:this._frontPlaneMaterial,layer:0,mergeWithGAS:true});this._frontPlane.setMaterialApplication(o);this._frontPlane.setMaterialMode(true)}else{this._frontPlane.setMaterial(this._frontPlaneMaterial)}this._frontPlane.setShadow(false);this._frontPlane.setSSAO(false);this._frontPlane.setFrustumCulled(false);this._frontPlane.setPickParent(true);this._frontPlane.excludeFromHighlight(true,true);this._backPlane=this._buildEditableRectangle(false,this._backPlaneMaterial.color,this._backPlaneMaterial.opacity);this._backPlaneGAS=this._backPlane._occurrences[0].renderable.geometry[0].drawingGroups[0].gas;if(this.matInherit){var o=new b({faceMaterial:this._backPlaneMaterial,layer:0,mergeWithGAS:true});this._backPlane.setMaterialApplication(o);this._backPlane.setMaterialMode(true)}else{this._backPlane.setMaterial(this._backPlaneMaterial)}this._backPlane.setShadow(false);this._backPlane.setSSAO(false);this._backPlane.setFrustumCulled(false);this._backPlane.setPickParent(true);this._backPlane.excludeFromHighlight(true,true);this._frontBorder=this._buildEditableRectangle(true,this._frontBorderMaterial.color,this._frontBorderMaterial.opacity);this._frontBorderGAS=this._frontBorder._occurrences[0].renderable.geometry[0].drawingGroups[0].gas;if(this.matInherit){var o=new b({lineMaterial:this._frontBorderMaterial,layer:0,mergeWithGAS:true});this._frontBorder.setMaterialApplication(o);this._frontBorder.setMaterialMode(true)}else{this._frontBorder.setMaterial(this._frontBorderMaterial)}this._frontBorder.setShadow(false);this._frontBorder.setSSAO(false);this._frontBorder.setFrustumCulled(false);this._frontBorder.setPickParent(true);this._frontBorder.setPickingPriorityId({edges:"RefPlaneEdges"});this._backBorder=this._buildEditableRectangle(true,this._backBorderMaterial.color,this._backBorderMaterial.opacity);this._backBorderGAS=this._backBorder._occurrences[0].renderable.geometry[0].drawingGroups[0].gas;if(this.matInherit){var o=new b({lineMaterial:this._backBorderMaterial,layer:0,mergeWithGAS:true});this._backBorder.setMaterialApplication(o);this._backBorder.setMaterialMode(true)}else{this._backBorder.setMaterial(this._backBorderMaterial)}this._backBorder.setShadow(false);this._backBorder.setSSAO(false);this._backBorder.setFrustumCulled(false);this._backBorder.setPickParent(true);this._backBorder.setPickingPriorityId({edges:"RefPlaneEdges"});this._fixedSizeFrontText=new m({name:"fixedSizeNodeFrontText",ratio:1});this._fixedSizeBackText=new m({name:"fixedSizeNodeBackText",ratio:1});this._fixedSizeArrowIndicator=new m({name:"fixedSizeNodeArrowIndicator",ratio:20});this._fixedSizeFrontText.setPickable(f.NOPICKABLE);this._fixedSizeBackText.setPickable(f.NOPICKABLE);this._fixedSizeArrowIndicator.setPickable(f.NOPICKABLE);this._xArrowIndicator=this._buildXIndicator(this._xIndicatorMaterial.color,this._xIndicatorMaterial.opacity);this._xArrowIndicator.setShadow(false);this._xArrowIndicator.setSSAO(false);this._xArrowIndicatorGAS=this._xArrowIndicator._occurrences[0].renderable.geometry[0].drawingGroups[0].gas;this._displayArrowOrientation=true;if(this.matInherit){var o=new b({faceMaterial:this._xIndicatorMaterial,layer:0,mergeWithGAS:true});this._xArrowIndicator.setMaterialApplication(o);this._xArrowIndicator.setMaterialMode(true)}else{this._xArrowIndicator.setMaterial(this._xIndicatorMaterial)}this._xArrowIndicator.excludeFromHighlight(true,true);this._fixedSizeArrowIndicator.addChild(this._xArrowIndicator);this._fixedSizeArrowIndicator.setMatrix(new j.Matrix4().makeTranslation(0.5*this._length.x,0,0));this.setParameters(q);var n=new g("RefPlaneNode");n.setPickParent(true);n.addChild(this._frontPlane);n.addChild(this._backPlane);n.addChild(this._frontBorder);n.addChild(this._backBorder);if(this.fixedSize){this._frontPlane._setRatio(1);this._backPlane._setRatio(1);this._frontBorder._setRatio(1);this._backBorder._setRatio(1);this._subNode=new m({name:"FixedSizeForText&Arrow",ratio:1});this._subNode.addChild(this._fixedSizeFrontText);this._subNode.addChild(this._fixedSizeBackText);this._subNode.addChild(this._fixedSizeArrowIndicator);n.addChild(this._subNode)}else{n.addChild(this._fixedSizeFrontText);n.addChild(this._fixedSizeBackText);n.addChild(this._fixedSizeArrowIndicator)}this._fixedSizeFrontText.addChild(this._frontText.textNode);this._fixedSizeBackText.addChild(this._backText.textNode);this._updateTextPosition();this.addChild(n);return this},_updateTextPosition:function(D){var w=0;if(D){var F=D.camera;var B=new j.Vector3();var n=new j.Vector3();var E=new j.Vector3();var p=new j.Vector3();var s=new j.Vector3();var r=new j.Vector3();var q=new j.Vector3();var o=new j.Vector3();var t=this._subNode?this._subNode._occurrences[0].matrix:this._occurrences[0].matrix;t.extractBasis(B,n,E);B.multiplyScalar(0.5*this._length.x);n.multiplyScalar(0.5*this._length.y);p.getPositionFromMatrix(t);s.addVectors(B,n);s.negate();s.addVectors(s,p);r.subVectors(B,n);r.addVectors(r,p);q.addVectors(B,n);q.addVectors(q,p);o.subVectors(n,B);o.addVectors(o,p);var C=D.project(s,F);var z=D.project(r,F);var y=D.project(q,F);var x=D.project(o,F);var A=0;var G=z.x-C.x;if(G>0){w=0;A=G}G=y.x-z.x;if(G>0){if(G>A){A=G;w=1}}G=x.x-y.x;if(G>0){if(G>A){A=G;w=2}}G=C.x-x.x;if(G>0){if(G>A){A=G;w=3}}}var v=(w%2)?this._length.y:this._length.x;var u=(w%2)?this._length.x:this._length.y;l.makeRotationAxis(new j.Vector3(0,0,1),0.5*Math.PI*w);l.translate(new j.Vector3(-(0.5-this._margin)*v,-(0.5-this._margin)*u,0));this._fixedSizeFrontText.setMatrix(l);l.makeRotationAxis(new j.Vector3(0,0,1),Math.PI+0.5*Math.PI*w);l.rotateY(Math.PI);l.translate(new j.Vector3(-(0.5-this._margin)*v,-(0.5-this._margin)*u,0));this._fixedSizeBackText.setMatrix(l)},setParameters:function(s){if(s.size){this._length.copy(s.size);this._updateRectangleSize(this._frontPlane);this._updateRectangleSize(this._backPlane);this._updateRectangleSize(this._frontBorder);this._updateRectangleSize(this._backBorder);this._updateTextPosition();this._fixedSizeArrowIndicator.setMatrix(new j.Matrix4().makeTranslation(0.5*this._length.x,0,0))}var o=s.planeAttributes;if(o){if(o.front){if(o.front.color){this._frontPlaneMaterial.color.copy(o.front.color);this._xIndicatorMaterial.color.copy(o.front.color);this.matInherit&&this._frontPlaneGAS._color.copy(o.front.color);this.matInherit&&this._xArrowIndicatorGAS._color.copy(o.front.color);if(!o.back||!o.back.color){var t=this._frontPlaneMaterial.color.getHSL();var r=t.h+20/255;var u=Math.min(1,1.3*t.l);this._backPlaneMaterial.color.setHSL(r,t.s,u);this.matInherit&&this._backPlaneGAS._color.copy(this._backPlaneMaterial.color)}}if(o.front.opacity){this._frontPlaneMaterial.opacity=o.front.opacity;if(this.matInherit){this._frontPlaneGAS._alpha=o.front.opacity}}}if(o.back){if(o.back.color){this._backPlaneMaterial.color.copy(o.back.color);this.matInherit&&this._backPlaneGAS._color.copy(o.back.color)}if(o.back.opacity){this._backPlaneMaterial.opacity=o.back.opacity;if(this.matInherit){this._backPlaneGAS._alpha=o.back.opacity}}}}var n=s.borderAttributes;if(n){if(n.front){if(n.front.color){this._frontBorderMaterial.color.copy(n.front.color);this.matInherit&&this._frontBorderGAS._color.copy(n.front.color);if(!n.back||!n.back.color){var q=this._frontBorderMaterial.color.getHSL();var r=q.h+20/255;var u=Math.min(1,1.3*q.l);this._backBorderMaterial.color.setHSL(r,q.s,u);this.matInherit&&this._backBorderGAS._color.copy(this._backBorderMaterial.color)}}if(n.front.opacity){this._frontBorderMaterial.opacity=n.front.opacity;if(this.matInherit){this._frontBorderGAS._alpha=n.front.opacity}}if(n.front.width){this._frontBorderMaterial.lineWidth=n.front.width}}if(n.back){if(n.back.color){this._backBorderMaterial.color.copy(n.back.color);this.matInherit&&this._backBorderGAS._color.copy(n.front.color)}if(n.back.opacity){this._backBorderMaterial.opacity=n.back.opacity;if(this.matInherit){this._backBorderGAS._alpha=n.back.opacity}}if(n.back.width){this._backBorderMaterial.lineWidth=n.back.width;this._backBorderMaterial.needsUpdate=true}}}var p=s.textAttributes;if(p){if(p.front){if(p.front.data){this._frontText.data=p.front.data}if(p.front.size){this._frontText.size=p.front.size}if(p.front.opacity){this._frontText.opacity=p.front.opacity}if(p.front.color){this._frontText.color.copy(p.front.color)}}if(p.back){if(p.back.data){this._backText.data=p.back.data}if(p.back.size){this._backText.size=p.back.size}if(p.back.opacity){this._backText.opacity=p.back.opacity}if(p.back.color){this._backText.color.copy(p.back.color)}}this._frontText.token&&this._frontText.textNode.removeChild(this._frontText.token);this._backText.token&&this._backText.textNode.removeChild(this._backText.token);if(this._frontText.data!==""){this._frontText.token=h.createTextNode({text:this._frontText.data,font:"Trebuchet MS",fontSize:this._frontText.size,color:this._frontText.color,depthWrite:false});this._frontText.token.children[0].excludeFromHighlight(true,true);this._frontText.textNode.addChild(this._frontText.token)}if(this._backText.data!==""){this._backText.token=h.createTextNode({text:this._backText.data,font:"Trebuchet MS",fontSize:this._backText.size,color:this._backText.color,depthWrite:false});this._backText.token.children[0].excludeFromHighlight(true,true);this._backText.textNode.addChild(this._backText.token)}}if(s.orientationArrow!==undefined){if(this._displayArrowOrientation!==s.orientationArrow){if(s.orientationArrow){this._fixedSizeArrowIndicator.addChild(this._xArrowIndicator)}else{this._fixedSizeArrowIndicator.removeChild(this._xArrowIndicator)}this._displayArrowOrientation=s.orientationArrow}}},_onLinkedToSceneGraph:function(){var n=this;this.tokenChange=c.subscribe({event:"/VISU/"},function(o){if(o.eventType==="@onViewpointChange"){n.cbChange(o)}})},_onUnlinkedToSceneGraph:function(){c.unsubscribe(this.tokenChange)},_getDynamicMatrix:function(){return null},_updateNode:function(v,w,x){var u=x?x:w.viewpoint;this._updateTextPosition(u);var A=u.getEyePosition();var s=v.elements;var r=new j.Vector3();r.set(s[12],s[13],s[14]);var t=new j.Vector3();t.subVectors(A,r);t.normalize();var z=new j.Vector3();z.set(s[8],s[9],s[10]);var p=t.dot(z);var o=(p>0);this._fixedSizeFrontText.setVisibility(o);this._fixedSizeBackText.setVisibility(!o);this._frontBorder.setVisibility(o);this._backBorder.setVisibility(!o);this._fixedSizeArrowIndicator.setVisibility(true);var y=(2*this._fixedSizeFrontText.getBoundingSphere().radius*this._fixedSizeFrontText.getScaleFactor()<0.9*Math.min(this._length.x,this._length.y));var q=(2*this._fixedSizeBackText.getBoundingSphere().radius*this._fixedSizeBackText.getScaleFactor()<0.9*Math.min(this._length.x,this._length.y));var n=this._fixedSizeArrowIndicator.getScaleFactor()<0.3*Math.min(this._length.x,this._length.y);this._fixedSizeFrontText.setVisibility(o&&y);this._fixedSizeBackText.setVisibility(!o&&q);this._fixedSizeArrowIndicator.setVisibility(n)},_buildXIndicator:function(){var o=new f.PrimitiveGroup();o.fillAttr=new f.FillAttributes();var s=new f.Buffer({component:f.VertexComponentEnum.POSITION,data:new Float32Array(9)});var t=new f.Buffer({component:f.VertexComponentEnum.NORMAL,data:new Float32Array(9)});o.addBuffer(0,s);o.addBuffer(1,t);var q=s.data;var r=0;q[r++]=-1;q[r++]=-0.3;q[r++]=0;q[r++]=-0.25;q[r++]=0;q[r++]=0;q[r++]=-1;q[r++]=0.3;q[r++]=0;q=t.data;r=0;for(var p=0;p<3;p++){q[r++]=0;q[r++]=0;q[r++]=1}var n=new f.Primitive({nbIndices:3,connectivity:f.ConnectivityTypeEnum.TRIANGLES,fillGAS:new f.FillAttributes()});var u=new f.VertexComponent({nbVertices:3,bufferId:0});var v=new f.VertexComponent({nbVertices:3,bufferId:1});n.addVertexComponent(u);n.addVertexComponent(v);o.addPrimitive(n);return h.createMeshNode(o)},_buildEditableRectangle:function(u,p,o){var z=new f.PrimitiveGroup();z.editable=true;z.fillAttr=new f.FillAttributes();z.lineAttr=new f.LineAttributes();z.pointAttr=new f.PointAttributes();var t=new f.Buffer({component:f.VertexComponentEnum.POSITION,data:new Float32Array(12)});var v=new f.Buffer({component:f.VertexComponentEnum.NORMAL,data:new Float32Array(12)});var w=new f.Buffer({indexBuffer:true,data:new Uint16Array(u?8:6)});z.addBuffer(0,t);z.addBuffer(1,v);z.addBuffer(2,w);var s=w.data;var r=0;if(u){s[0]=0;s[1]=1;s[2]=1;s[3]=2;s[4]=2;s[5]=3;s[6]=3;s[7]=0}else{s[r++]=0;s[r++]=1;s[r++]=2;s[r++]=0;s[r++]=2;s[r++]=3}s=t.data;r=0;s[r++]=0.5*this._length.x;s[r++]=-0.5*this._length.y;s[r++]=0;s[r++]=0.5*this._length.x;s[r++]=0.5*this._length.y;s[r++]=0;s[r++]=-0.5*this._length.x;s[r++]=0.5*this._length.y;s[r++]=0;s[r++]=-0.5*this._length.x;s[r++]=-0.5*this._length.y;s[r++]=0;s=v.data;r=0;for(var q=0;q<4;q++){s[r++]=0;s[r++]=0;s[r++]=1}var n=new f.Primitive({nbIndices:u?8:6,connectivity:u?f.ConnectivityTypeEnum.LINES:f.ConnectivityTypeEnum.TRIANGLES,fillGAS:new f.FillAttributes(new f.Color(p.r,p.g,p.b,o)),lineGAS:new f.LineAttributes(new f.Color(p.r,p.g,p.b,o))});var x=new f.VertexComponent({nbVertices:4,bufferId:0,indices:new f.IndexArray({bufferId:2,offset:0})});var y=new f.VertexComponent({nbVertices:4,bufferId:1,indices:new f.IndexArray({bufferId:2,offset:0})});n.addVertexComponent(x);n.addVertexComponent(y);z.addPrimitive(n);return h.createMeshNode(z)},_updateRectangleSize:function(o){var r=o.getBuffer(f.VertexComponentEnum.POSITION);r[0]=0.5*this._length.x;r[1]=-0.5*this._length.y;r[3]=0.5*this._length.x;r[4]=0.5*this._length.y;r[6]=-0.5*this._length.x;r[7]=0.5*this._length.y;r[9]=-0.5*this._length.x;r[10]=-0.5*this._length.y;o.updateBuffer(f.VertexComponentEnum.POSITION,0,4);var n=Math.sqrt(0.25*this._length.x*this._length.x+0.25*this._length.x*this._length.x);var q=new j.Sphere(new j.Vector3(0,0,0),n);var p=new j.Box3(new j.Vector3(-0.5*this._length.x,-0.5*this._length.y,0),new j.Vector3(0.5*this._length.x,0.5*this._length.y,0));o.forceBoundingElements(true,{sphere:q,box:p})}});return UWA.namespace("THREEDS/Nodes/RefPlaneNode",e)});define("DS/Visualization/PlaneGrid",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/TextNode"],function(c,h,n,m,a){var f=new n.Color().setRGB(1,1,1);var p=new n.Vector3(0,0,1);var k=new n.Vector3(0,0,-1);var j=new n.Vector3(1,0,0);var q=new n.Vector3(0,1,0);var g=new n.Vector3(-1,0,0);var r=new n.Vector3(0,-1,0);var d=new n.Vector3();var l=new n.Vector2();var o=new n.Vector2();var e=function(s,t,u){if(typeof u==="undefined"||+u===0){return Math[s](t)}t=+t;u=+u;if(isNaN(t)||!(typeof u==="number"&&u%1===0)){return NaN}t=t.toString().split("e");t=Math[s](+(t[0]+"e"+(t[1]?(+t[1]-u):-u)));t=t.toString().split("e");return +(t[0]+"e"+(t[1]?(+t[1]+u):u))};if(!Math.round10){Math.round10=function(s,t){return e("round",s,t)}}var b=c.extend({init:function(s){this.viewer=s;this.position=new n.Vector3();this.size=100;this.displayLabels=false;this.gridLabels=null;this.labelColor=f;this.labelCB=null;this.displayLabelCB=null;this.labels={rightNS:[],rightWE:[],bottomNS:[],bottomWE:[],all:[]};this.displayGrid=s.displayGrid;this.displayGridFromBelow=s.displayGridFromBelow;this.gridScreenSize=50;this.gridNbSteps=s.gridNbSteps;this.gridUnit=1;this.gridOffset=new n.Vector2();this.gridCoeff=0;this.gridFalloff=0;this.gridColor=s.gridColor;this.displayPlane=1;this.planeFalloff=0;this.planeColor=s.planeColor;this.planeOpacity=1;this.planeTexture=null;this.planeTextureScale=1;this.planeBorder=false;this.edgeColor=new n.Color();this.mesh=null;this.matrix=new n.Matrix4();this.material=null;this.gridTextures={};this.viewProjMatrix=new n.Matrix4();this.tmpFrustum=new n.Frustum();this.tmpPoly1=new n.CGPolygon();this.tmpPoly2=new n.CGPolygon();this.tmpLine=new n.Line3(new n.Vector3(),new n.Vector3())},setGridNbSteps:function(s){this.gridNbSteps=s;this.setGridTextures()},setLabels:function(s){if(s===this.displayLabels){return}this.displayLabels=s;if(s&&!this.gridLabels){this.gridLabels=new a("gridLabels");this.gridLabels.setBillboard(true,true);this.gridLabels.setFixedSize(true);this.gridLabels._setProjectionSpace(true);var t=this.gridLabels._occurrences[0].renderable;t.renderDepth=0;t.receiveShadow=false;this.viewer.sceneBackground.add(t)}if(this.gridLabels){this.gridLabels.setVisibility(s);this.gridLabels.setVisibilityFree(s)}},setLabelColor:function(s){this.labelColor=new n.Color();this.labelColor.set(s)},setLabelCallback:function(s){this.labelCB=s},setDisplayLabelCallback:function(s){this.displayLabelCB=s},getUnitGridTexture:function(t){if(this.gridTextures[t]){return this.gridTextures[t]}var v=new Uint8Array(t*t);for(var s=0;s<t;++s){v[s]=255;v[t*(t-1)+s]=255;v[t*s]=255;v[(t*s)+t-1]=255}var u=new n.DataTexture(v,t,t,n.AlphaFormat,n.UnsignedByteType,new n.UVMapping(),n.RepeatWrapping,n.RepeatWrapping,n.LinearFilter,n.LinearMipMapLinearFilter,16);u.needsUpdate=true;this.gridTextures[t]=u;return u},setGridTextures:function(){if(!this.material){return}var y=function(A){var z=Math.log(A)/Math.LN2;return Math.pow(2,Math.round(z))};var w=64;var x=2;var t=this.gridNbSteps/x;var v=y(w*t);var u=y(w*t*t);var s=Math.min(y(w*t*t*t),4096);this.material.uniforms.gridTexture.value=this.getUnitGridTexture(w);this.material.uniforms.gridTexture2.value=this.getUnitGridTexture(v);this.material.uniforms.gridTexture3.value=this.getUnitGridTexture(u);this.material.uniforms.gridTexture4.value=this.getUnitGridTexture(s)},createPlaneGrid:function(u,z,x,y){this.size=u;this.position=z;this.computeGridUnit(x.camera,Math.abs(x.camera.position.z-this.position.z));var v=this.gridNbSteps*this.gridUnit;this.gridOffset.x=y?(z.x-v*Math.floor(z.x/v)):0;this.gridOffset.y=y?(z.y-v*Math.floor(z.y/v)):0;if(!this.mesh){var w=n.InfinitePlaneShader;var A={defines:{PLANE_V2:true},fragmentShader:w.fragmentShader,vertexShader:w.vertexShader,uniforms:n.UniformsUtils.clone(w.uniforms)};var t=new n.ShaderMaterial(A);this.material=t;t.lights=true;t.useBlending=true;t.depthTest=false;t.depthWrite=false;t.side=n.DoubleSide;t.uniforms.ambient.value.copyGammaToLinear(new n.Color(328965));t.force=true;this.setGridTextures();var s=m.createRectangleNode({width:1,height:1,fill:true,noEdge:true,material:t});s.setVisibilityFree(true);this.mesh=s._occurrences[0].renderable;this.mesh.frustumCulled=false;this.mesh.receiveShadow=false;this.mesh.renderDepth=1;this.viewer.sceneBackground.add(this.mesh);this.mesh.pickable=false}this.mesh.visible=true;this.mesh.position.set(z.x-0.5*u,z.y-0.5*u,z.z);this.mesh.scale.set(u,u,1);this.mesh.updateMatrix();this.material.uniforms.displayPlane.value=this.displayPlane;this.material.uniforms.displayGrid.value=this.displayGrid;this.material.uniforms.gridFromBelow.value=this.displayGridFromBelow;this.material.uniforms.diffuse.value.copyGammaToLinear(this.planeColor);this.material.uniforms.planeOpacity.value=this.planeOpacity;if((this.material.map&&!this.planeTexture)||(!this.material.map&&this.planeTexture)){this.material.needsUpdate=true}this.material.map=this.planeTexture;this.material.uniforms.map.value=this.planeTexture;this.material.uniforms.uvScale.value=this.planeTextureScale;this.material.uniforms.border.value.copyGammaToLinear(this.edgeColor);this.material.uniforms.attenuation.value=this.viewer.planeAttenuation?1:0;this.material.uniforms.planeBorder.value=this.planeBorder?1:0;this.material.uniforms.planeFalloff.value=this.planeFalloff;this.material.uniforms.gridFalloff.value=this.gridFalloff;this.material.uniforms.gridUnit.value=this.gridUnit;this.material.uniforms.gridOffset.value.copy(this.gridOffset);this.material.uniforms.gridCoeff.value=this.gridCoeff;this.material.uniforms.gridColor.value.copyGammaToLinear(this.gridColor);this.material.uniforms.planeSize.value=u;this.material.uniforms.nbSteps.value=this.gridNbSteps},computeGridUnit:function(t,w){var s=1;if(t instanceof n.PerspectiveCamera){s=2*this.gridScreenSize*Math.tan(Math.PI*t.fov/360)*w/this.viewer.div.clientHeight}else{if(t instanceof n.OrthographicCamera){s=this.gridScreenSize*(t.top-t.bottom)/this.viewer.div.clientHeight}}var v=1/(this.gridNbSteps*this.gridNbSteps);var u=0;while(v<s){if(this.gridNbSteps===1){v++}else{v*=this.gridNbSteps}u++}this.gridUnit=v;if(this.gridNbSteps===1){this.gridCoeff=(s-v-1)}else{this.gridCoeff=(s-v/this.gridNbSteps)/(v-v/this.gridNbSteps)}},updateLabels:function(s){if(!this.displayLabels){return}this.cleanLabels();this.computeLabelPositions(s.camera);this.displayLabelsFunc();this.gridLabels&&this.gridLabels.textMaterial.uniforms.invSize.value.set(1/this.viewer.renderer.deviceWidth,1/this.viewer.renderer.deviceHeight);if(this.gridLabels){this.gridLabels.textMaterial.uniforms.screenRatio.value=this.viewer.renderer.deviceWidth/this.viewer.renderer.deviceHeight}},addLabel:function(z,y,B,D,C,E,A){var w=(E==="x")?j:q;var s={string:z,anchor:y,color:this.labelColor,size:20*window.devicePixelRatio,lineLength:500,up:p,right:w,isRight:false};var G=this.gridLabels.getTextExtent(s);var u=Math.abs(G.max.x-G.min.x);var t=Math.abs(G.max.y-G.min.y);G.min.x=-t;G.min.y=-t;G.max.x=t;G.max.y=t;G.translate(B);d.addVectors(y,w);var x=this.viewer.currentViewpoint.project(d,A);l.set(x.x-B.x,x.y-B.y);l.normalize();if(l.x<0){s.right=(E==="x")?g:r}var F=false;if(C){F=true;if(l.x>0){l.negate()}}else{if(((l.x<0)&&(l.y<0))||((l.x>0)&&(l.y>0))){F=true}if((l.x>0)&&(l.y>0)){l.negate()}}if(F){l.multiplyScalar(u);B.x+=l.x;B.y+=l.y}s.anchor=this.viewer.currentViewpoint.unProject(B,A);s.right=new n.Vector3().addVectors(s.anchor,s.right);s.anchor.applyProjection(this.viewProjMatrix);s.right.applyProjection(this.viewProjMatrix);l.set(s.right.x-s.anchor.x,s.right.y-s.anchor.y);l.normalize();s.right.copy(s.anchor);s.right.x+=l.x;s.right.y+=l.y;if(!this.displayLabelCB){for(var v=0;v<D.length;v++){if(G.isIntersectionBox(D[v]._text.labelExtent)){return}}}var H={token:null,_text:s,isRight:C,display:true};D.push(H);this.labels.all.push(H)},isBottomRightEdge:function(s){var t=2;if(s.x<t){return false}if(s.y<t){return false}return true},isRightEdgeFunc:function(s){var t=2;return(s.x>this.viewer.SCREEN_WIDTH-t)},isInsideFrustum:function(s){if(s.x<-1||s.x>this.viewer.SCREEN_WIDTH+1){return false}if(s.y<-1||s.y>this.viewer.SCREEN_HEIGHT+1){return false}if(s.z<-1.001||s.z>1.001){return false}return true},cleanLabels:function(){for(var s=0;s<this.labels.all.length;s++){(this.labels.all[s].token!==null)&&this.gridLabels.removeText(this.labels.all[s].token)}this.labels={rightNS:[],rightWE:[],bottomNS:[],bottomWE:[],all:[]}},displayLabelsFunc:function(){this.displayLabelCB&&this.displayLabelCB(this.labels.all);for(var u=0;u<this.labels.all.length;u++){var v=this.labels.all[u];if(!v.display){continue}if(v.offset||v.offsetFromScreenEdge||v.offsetFromAxis){var s=v.offset?v.offset.x:0;var w=v.offset?v.offset.y:0;l.set(0.5*this.viewer.SCREEN_WIDTH*(v._text.right.x-v._text.anchor.x),0.5*this.viewer.SCREEN_HEIGHT*(v._text.right.y-v._text.anchor.y));l.normalize();o.set(-l.y,l.x);if(v.isRight||(l.y<0)){l.negate()}if(!v.isRight&&(l.y<0)){o.negate()}o.multiplyScalar(v.offsetFromAxis||0);l.multiplyScalar(v.offsetFromScreenEdge||0);v._text.anchor.x+=2*(s+o.x+l.x)/this.viewer.SCREEN_WIDTH;v._text.anchor.y+=2*(w+o.y+l.y)/this.viewer.SCREEN_HEIGHT;v._text.right.x+=2*(s+o.x+l.x)/this.viewer.SCREEN_WIDTH;v._text.right.y+=2*(w+o.y+l.y)/this.viewer.SCREEN_HEIGHT}if(v.size){v._text.size=v.size*window.devicePixelRatio}if(v.color){v._text.color=v.color}var t=this.gridLabels.addText(v._text);v.token=t}},computeIntersectionsForLabels:function(L,C,F,D,u,H,N){var t="y";var B=this.labels.rightWE;var A=this.labels.bottomWE;var x="E";var I="W";if(L==="y"){t="x";B=this.labels.rightWE;A=this.labels.bottomWE;x="N";I="S"}var G=Math.round((C.min[L]-this.position[L])/this.gridUnit);var O=Math.round((C.max[L]-this.position[L])/this.gridUnit);if(F<0){O=Math.min(G+1000,O)}else{G=Math.max(O-1000,G)}var E=this.tmpLine;for(var M=G;M<=O;M++){E.start[L]=M*this.gridUnit+this.position[L];E.start[t]=-0.5*this.size+this.position[t];E.start.z=this.position.z;E.end[L]=E.start[L];E.end[t]=0.5*this.size+this.position[t];E.end.z=this.position.z;var w=D.planes[u];var J=w.intersectLine(E);var y=J&&H.project(J,N);var v=!!J&&this.isInsideFrustum(y)&&this.isBottomRightEdge(y);var z=v&&this.isRightEdgeFunc(y);if(v){var K=(M*this.gridUnit)+this.position[L];var P=Math.round10(K,-2);var s=(P>=0);var Q;if(this.labelCB){Q=this.labelCB(K,(s?x:I))}else{Q=Math.abs(P)+" "+(s?x:I)}this.addLabel(Q,J,y,z?B:A,z,t,N)}}},computeLabelPositions:function(){var w=this.viewer.currentViewpoint;var z=this.viewer.cameraBackground;this.viewProjMatrix.multiplyMatrices(z.projectionMatrix,z.matrixWorldInverse);var G=this.tmpFrustum;G.setFromMatrix(this.viewProjMatrix);var H=G.getCorners();var A=this.tmpPoly1;A.addPoints([new n.Vector3().copy(H[0]),new n.Vector3().copy(H[1]),new n.Vector3().copy(H[5]),new n.Vector3().copy(H[4]),]);var E=this.tmpPoly2;E.addPoints([new n.Vector3().copy(H[1]),new n.Vector3().copy(H[2]),new n.Vector3().copy(H[6]),new n.Vector3().copy(H[5]),]);var x=new n.Plane();x.setFromNormalAndCoplanarPoint(k,this.position);var B=A.clipByPlane(x,new n.CGPolygon());var I=E.clipByPlane(x,new n.CGPolygon());var F=new n.Vector2();var t=new n.Vector2();var D,C,u,s;var v=null;var y=null;if(B.corner.length===2){F.subVectors(B.corner[1],B.corner[0]);F.normalize();D=F.dot(j);C=F.dot(q);v=new n.Box3().setFromPoints([B.corner[0],B.corner[1]])}if(I.corner.length===2){t.subVectors(I.corner[1],I.corner[0]);t.normalize();u=t.dot(j);s=t.dot(q);y=new n.Box3().setFromPoints([I.corner[0],I.corner[1]])}if(Math.abs(D)>0.707){v&&this.computeIntersectionsForLabels("x",v,D,G,2,w,z);y&&this.computeIntersectionsForLabels("y",y,s,G,0,w,z)}else{v&&this.computeIntersectionsForLabels("y",v,C,G,2,w,z);y&&this.computeIntersectionsForLabels("x",y,u,G,0,w,z)}this.gridLabels.setFrustumCulled(false)}});return b});define("DS/SceneGraphNodes/FixedSizeArrowNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory","DS/Visualization/MaterialApplication"],function(j,g,b,l,d,c,e,k,h,a){var f=g.extend({init:function(t){this._parent(t.name);this.matInherit=window.newMaterialInheritance;this._arrowWidth=t.arrowWidth;this._headLength=t.headLength;this._arrowLength=t.arrowLength;this.viewpoint=t.viewpoint;this.globalSelection=t.globalSelection;var E=new j.Vector3(0,0,1);this._color=t.color;this._head=t.head;this._noZ=t.removeNoZ?false:true;this._pickable=t.pickable?true:false;var m=null;var x=c.getWebappsAssetUrl("SceneGraphNodes","");var y=null;if(this._head){this._headLength=(this._headLength)?this._headLength:this._arrowLength/8;y={name:"billBoardNode",viewpoint:this.viewpoint};var u=this;var C=function(){};if(this._head===1){y.constraintAxis=E;y.type="Cylindrical";m=new j.ImageUtils.loadTexture(x+"models/textures/head.png",undefined,C,C,j.ImageUtils.crossOriginPolicy)}if(this._head===2){y.type="Spherical";m=new j.ImageUtils.loadTexture(x+"models/textures/headDisk.png",undefined,C,C,j.ImageUtils.crossOriginPolicy)}}else{this._headLength=0}var z=this._arrowLength-this._headLength;var p=new k();var q=this._noZ?1:0;var o=p.createRectangle({width:this._arrowWidth,height:z,fill:true,color:new e.Color(0,0,0,1),noEdge:true,layerNb:q});var r=p.createRectangle({width:this._headLength,height:this._headLength,fill:true,color:new e.Color(0,0,0,1),noEdge:true,layerNb:q});var B=new j.MeshBasicMaterial({map:m,side:j.DoubleSide,transparent:true,alphaTest:0.05,color:this._color,force:!this.matInherit});var A=h.createMeshNode(r,!this.matInherit?B:undefined);A.setShadow(false);A.setFrustumCulled(false);if(this.globalSelection){A.setPickParent(true)}if(this.matInherit){A.setMaterialApplication(new a({faceMaterial:B,layer:0,mergeWithGAS:true}));A.setMaterialMode(true)}if(!this._pickable){A.setPickable(e.NOPICKABLE)}A.name="Arrow's head";var s=new j.MeshBasicMaterial({side:j.DoubleSide,transparent:true,alphaTest:0.05,color:this._color,force:!this.matInherit});var v=h.createMeshNode(o,!this.matInherit?s:undefined);v.setShadow(false);v.setFrustumCulled(false);if(this.globalSelection){v.setPickParent(true)}if(this.matInherit){v.setMaterialApplication(new a({faceMaterial:s,layer:0,mergeWithGAS:true}));v.setMaterialMode(true)}if(!this._pickable){v.setPickable(e.NOPICKABLE)}v.name="Arrow's body";v.setMatrix(new j.Matrix4().rotateX(0.5*Math.PI).translate(new j.Vector3(-this._arrowWidth/2,0,0)));var G={constraintAxis:E,name:"billBoardNode",type:"Cylindrical",viewpoint:this.viewpoint};var w=new d(G);if(this.globalSelection){w.setPickParent(true)}w.addChild(v);if(this._head===2){A.setMatrix(new j.Matrix4().translate(new j.Vector3(-this._headLength/2,-this._headLength/2,0)))}else{if(this._head===1){A.setMatrix(new j.Matrix4().rotateX(0.5*Math.PI).translate(new j.Vector3(-this._headLength/2,0,0)))}}if(y){var n=new d(y);if(this.globalSelection){n.setPickParent(true)}n.addChild(A);var F=new l({name:"myFixedSizeNode",ratio:1});if(this.globalSelection){F.setPickParent(true)}F.addChild(n);F.setMatrix(new j.Matrix4().setPosition(new j.Vector3().copy(E).multiplyScalar(z/E.length())))}var D=new l({name:"myFixedSizeNodeG",ratio:1});if(this.globalSelection){D.setPickParent(true)}if(y){D.addChild(F)}D.addChild(w);this.addChild(D);return this},setColor:function(m){this._color=m},setName:function(m){this._name=m},getNodeType:function(){return"FixedSizeArrowNode"}});f.types={NONE:null,ARROW:1,DISK:2};return UWA.namespace("THREEDS/Nodes/FixedSizeArrowNode",f)});define("SceneGraphNodes/FixedSizeArrowNode",["DS/SceneGraphNodes/FixedSizeArrowNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/FixedSizeArrowNode");return b});define("DS/Robot/XZRotationNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/RotationManipulator","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory"],function(j,f,c,k,d,l,e,b,a,h){var g=f.extend({init:function(w){var r=this;this._parent(w.name);this.axis=w.constraintAxis;this._modelEvent=new a();this.isPreactivated=false;this.isManipulated=false;this.enablePreactivate=true;var q=new k();var t={width:8.5,height:8.5,fill:true,fillColor:null,noEdge:true};var u=q.createRectangle(t);var s=this;var v=c.getWebappsAssetUrl("Robot","");var o=new j.ImageUtils.loadTexture(v+"models/textures/Arc.png",undefined,null,null,j.ImageUtils.crossOriginPolicy);o.flipY=false;o.minFilter=j.LinearMipMapLinearFilter;this.planeMat=new j.MeshBasicMaterial({map:o,side:j.DoubleSide,transparent:true,alphaTest:0.05,enableClipPlanes:false});this.planeMat.force=true;var m=h.createMeshNode(u,this.planeMat);m.setShadow(false);m.setFrustumCulled(false);m.excludeFromCSO(true);m.excludeFromHighlight(true,true);m.setMatrix(new j.Matrix4().rotateX(0.5*Math.PI));this.addChild(m);if(this.touchMode){m.setPickable(e.NODRAWHL);var n=new j.ImageUtils.loadTexture(v+"models/textures/Arc_picking.png",undefined,null,null,j.ImageUtils.crossOriginPolicy);n.flipY=false;n.minFilter=j.LinearMipMapLinearFilter;this.planeMat_picking=new j.MeshBasicMaterial({map:n,side:j.DoubleSide,transparent:true,alphaTest:0.05,enableClipPlanes:false,opacity:0});this.planeMat_picking.force=true;var p=h.createMeshNode(u,this.planeMat_picking);p.setShadow(false);p.setFrustumCulled(false);p.excludeFromCSO(true);p.excludeFromHighlight(true,true);p.setMatrix(new j.Matrix4().rotateX(0.5*Math.PI));this.addChild(p)}this.manipulator=new l({axis:this.axis});this.manipulator.setExclusive(true);this.manipulator.linkToNode(this);this.manipulator.onBeginManipulate(function(x){r._modelEvent.publish({event:"RotationBegin",data:x,context:this});r.planeMat.opacity=1;r.planeMat.color=new j.Color("#1B6E9C");r.isManipulated=true});this.manipulator.onManipulate(function(x){r._modelEvent.publish({event:"RotationManipulation",data:x,context:this})});this.manipulator.onEndManipulate(function(x){r._modelEvent.publish({event:"RotationEnd",data:x,context:this});if(!r.isPreactivated){r.planeMat.color=new j.Color("#FFFFFF")}else{r.planeMat.color=new j.Color("#A1D9ED")}r.isManipulated=false});this.manipulator.onBeginPreactivate(function(x){r._modelEvent.publish({event:"BeginPreactivate",data:x,context:this});if(!r.isManipulated&&r.enablePreactivate){x.viewer.setTemporaryCursor("pointer")}r.isPreactivated=true;if(!r.isManipulated&&r.enablePreactivate){r.planeMat.color=new j.Color("#A1D9ED")}x.viewer.render()});this.manipulator.onEndPreactivate(function(x){r._modelEvent.publish({event:"EndPreactivate",data:x,context:this});if(!r.isManipulated&&r.enablePreactivate){x.viewer.unsetTemporaryCursor()}r.isPreactivated=false;if(!r.isManipulated){r.planeMat.color=new j.Color("#FFFFFF")}x.viewer.render()});this.manipulator.onPrimaryPointerClick(function(x){r._modelEvent.publish({event:"PrimaryPointerClick",data:x,context:this})})},setCenter:function(m){this.manipulator.setCenter(m)},setAxis:function(m){this.axis=m;this.manipulator.axis=m},setParentManipulated:function(m){this.enablePreactivate=!m},setToGhostState:function(){this.planeMat.opacity=0},setToNonGhostState:function(){this.planeMat.opacity=1}});return UWA.namespace("THREEDS/Robot/XZRotationNode",g)});define("Robot/XZRotationNode",["DS/Robot/XZRotationNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Robot/XZRotationNode");return b});define("DS/SceneGraphNodes/FixedSizePlaneNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory"],function(h,f,a,k,d,c,e,j,g){var b=f.extend({init:function(t){this._parent(t.name);this.setColor(t.color);this.setName(t.name);var m=t.length?t.length:10;var s=t.origin?t.origin:new h.Vector3();var o=t.direction1?t.direction1.normalize():new h.Vector3(0,1,0);var n=t.direction2?t.direction2.normalize():new h.Vector3(1,0,0);var l=new h.Vector3().crossVectors(o,n);var q=g.createRectangleNode({color:this._color,width:m,height:m,fill:t.fill,sharing:t.sharing,cornerPoint:new h.Vector2(-m/2,-m/2)});q.setShadow(false);q.setFrustumCulled(false);var r=new h.Matrix4();r.makeBasis(o,n,l);r.setPosition(s);var p=new f("NodeForPlane");p.setMatrix(r);p.addChild(q);this.addChild(p);p._setRatio(1);return this},setColor:function(l){this._color=l},setName:function(l){this._name=l},});return UWA.namespace("THREEDS/Nodes/FixedSizePlaneNode",b)});define("DS/Robot/XYRotationNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/RotationManipulator","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory"],function(j,g,d,k,e,l,f,c,b,h){var a=g.extend({init:function(w){var q=this;this._parent(w.name);this.axis=w.constraintAxis;this._modelEvent=new b();this.isPreactivated=false;this.isManipulated=false;this.enablePreactivate=true;this.touchMode=w.touchMode;var p=new k();var s={width:17,height:17,fill:true,fillColor:null,noEdge:true};var u=p.createRectangle(s);var r=this;var v=d.getWebappsAssetUrl("Robot","");var o=new j.ImageUtils.loadTexture(v+"models/textures/Rotation_FullArc_B.png",undefined,null,null,j.ImageUtils.crossOriginPolicy);o.flipY=false;o.minFilter=j.LinearMipMapLinearFilter;this.privilegedPlaneMat=new j.MeshBasicMaterial({map:o,side:j.DoubleSide,transparent:true,alphaTest:0.05,opacity:1,enableClipPlanes:false});this.privilegedPlaneMat.force=true;var n=h.createMeshNode(u,this.privilegedPlaneMat);n.setShadow(false);n.setFrustumCulled(false);n.excludeFromCSO(true);n.excludeFromHighlight(true,true);n.setMatrix(new j.Matrix4().setPosition(new j.Vector3(-8.5,-8.5,0)));this.addChild(n);if(this.touchMode){n.setPickable(f.NODRAWHL);var m=new j.ImageUtils.loadTexture(v+"models/textures/Rotation_FullArc_picking.png",undefined,null,null,j.ImageUtils.crossOriginPolicy);m.flipY=false;m.minFilter=j.LinearMipMapLinearFilter;this.privilegedPlaneMatPicking=new j.MeshBasicMaterial({map:m,side:j.DoubleSide,transparent:true,alphaTest:0.05,opacity:0,enableClipPlanes:false});this.privilegedPlaneMatPicking.force=true;var t=h.createMeshNode(u,this.privilegedPlaneMatPicking);t.setShadow(false);t.setFrustumCulled(false);t.excludeFromCSO(true);t.excludeFromHighlight(true,true);t.setMatrix(new j.Matrix4().setPosition(new j.Vector3(-8.5,-8.5,0)));this.addChild(t)}this.manipulator=new l({axis:this.axis});this.manipulator.setExclusive(true);this.manipulator.linkToNode(this);this.manipulator.onBeginManipulate(function(x){q._modelEvent.publish({event:"RotationBegin",data:x,context:this});q.privilegedPlaneMat.opacity=1;q.privilegedPlaneMat.color=new j.Color("#1B6E9C");q.isManipulated=true});this.manipulator.onManipulate(function(x){q._modelEvent.publish({event:"RotationManipulation",data:x,context:this})});this.manipulator.onEndManipulate(function(x){q._modelEvent.publish({event:"RotationEnd",data:x,context:this});if(!q.isPreactivated){q.privilegedPlaneMat.color=new j.Color("#FFFFFF")}else{q.privilegedPlaneMat.color=new j.Color("#A1D9ED")}q.isManipulated=false});this.manipulator.onBeginPreactivate(function(x){q._modelEvent.publish({event:"BeginPreactivate",data:x,context:this});if(!q.isManipulated&&q.enablePreactivate){x.viewer.setTemporaryCursor("pointer")}q.isPreactivated=true;if(!q.isManipulated&&q.enablePreactivate){q.privilegedPlaneMat.color=new j.Color("#A1D9ED")}x.viewer.render()});this.manipulator.onEndPreactivate(function(x){q._modelEvent.publish({event:"EndPreactivate",data:x,context:this});if(!q.isManipulated&&q.enablePreactivate){x.viewer.unsetTemporaryCursor()}q.isPreactivated=false;if(!q.isManipulated){q.privilegedPlaneMat.color=new j.Color("#FFFFFF")}x.viewer.render()});this.manipulator.onPrimaryPointerClick(function(x){q._modelEvent.publish({event:"PrimaryPointerClick",data:x,context:this})})},setCenter:function(m){this.manipulator.setCenter(m)},setAxis:function(m){this.axis=m;this.manipulator.setAxis(m)},setParentManipulated:function(m){this.enablePreactivate=!m},setToGhostState:function(){this.privilegedPlaneMat.opacity=0},setToNonGhostState:function(){this.privilegedPlaneMat.opacity=1}});return UWA.namespace("THREEDS/Robot/XYRotationNode",a)});define("Robot/XYRotationNode",["DS/Robot/XYRotationNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Robot/XYRotationNode");return b});define("DS/Robot/XZPlaneTranslationNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/PlaneTranslationManipulator","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils"],function(h,e,b,k,c,j,a,f,d){var g=e.extend({init:function(v){var q=this;this._parent(v.name);this.axis=v.constraintAxis;this._modelEvent=new a();this.isPreactivated=false;this.isManipulated=false;this.enablePreactivate=true;this.touchMode=v.touchMode;var p=new k();var s={width:6,height:6,fill:true,fillColor:null,noEdge:true};var t=p.createRectangle(s);var r=this;var u=b.getWebappsAssetUrl("Robot","");var n=new h.ImageUtils.loadTexture(u+"models/textures/PlaneTranslationNode.png",undefined,null,null,h.ImageUtils.crossOriginPolicy);n.flipY=false;n.minFilter=h.LinearMipMapLinearFilter;this.planeMat=new h.MeshBasicMaterial({map:n,side:h.DoubleSide,transparent:true,alphaTest:0.05,enableClipPlanes:false});this.planeMat.force=true;var m=f.createMeshNode(t,this.planeMat);m.setShadow(false);m.setFrustumCulled(false);m.excludeFromCSO(true);m.excludeFromHighlight(true,true);m.setMatrix(new h.Matrix4().rotateX(0.5*Math.PI).translate(new h.Vector3(0.5,0.5,0)));this.addChild(m);if(this.touchMode){m.setPickable(d.NODRAWHL);var l=new h.ImageUtils.loadTexture(u+"models/textures/PlaneTranslationNode_picking.png",undefined,null,null,h.ImageUtils.crossOriginPolicy);l.flipY=false;l.minFilter=h.LinearMipMapLinearFilter;this.planeMat_picking=new h.MeshBasicMaterial({map:l,side:h.DoubleSide,transparent:true,alphaTest:0.05,enableClipPlanes:false,opacity:0});this.planeMat_picking.force=true;var o=f.createMeshNode(t,this.planeMat_picking);o.setShadow(false);o.setFrustumCulled(false);o.excludeFromCSO(true);o.excludeFromHighlight(true,true);o.setMatrix(new h.Matrix4().rotateX(0.5*Math.PI).translate(new h.Vector3(0.5,0.5,0)));this.addChild(o)}this.manipulator=new j({axis:this.axis});this.manipulator.setExclusive(true);this.manipulator.linkToNode(this);this.manipulator.onPrimaryPointerClick(function(w){q._modelEvent.publish({event:"PrimaryPointerClick",data:{node:this},context:this})});this.manipulator.onBeginManipulate(function(w){q._modelEvent.publish({event:"PlaneTranslationBegin",data:w,context:this});q.planeMat.opacity=1;q.planeMat.color=new h.Color("#1B6E9C");q.isManipulated=true});this.manipulator.onManipulate(function(w){q._modelEvent.publish({event:"PlaneTranslationManipulation",data:w,context:this})});this.manipulator.onEndManipulate(function(w){q._modelEvent.publish({event:"PlaneTranslationEnd",data:w,context:this});if(!q.isPreactivated){q.planeMat.color=new h.Color("#FFFFFF")}else{q.planeMat.color=new h.Color("#A1D9ED")}q.isManipulated=false});this.manipulator.onBeginPreactivate(function(w){q._modelEvent.publish({event:"BeginPreactivate",data:w,context:this});if(!q.isManipulated&&q.enablePreactivate){w.viewer.setTemporaryCursor("pointer")}q.isPreactivated=true;if(!q.isManipulated&&q.enablePreactivate){q.planeMat.color=new h.Color("#A1D9ED")}w.viewer.render()});this.manipulator.onEndPreactivate(function(w){q._modelEvent.publish({event:"EndPreactivate",data:w,context:this});if(!q.isManipulated&&q.enablePreactivate){w.viewer.unsetTemporaryCursor()}q.isPreactivated=false;if(!q.isManipulated){q.planeMat.color=new h.Color("#FFFFFF")}w.viewer.render()})},setAxis:function(l){this.axis=l;this.manipulator.axis=l},setParentManipulated:function(l){this.enablePreactivate=!l},setToGhostState:function(){this.planeMat.opacity=0},setToNonGhostState:function(){this.planeMat.opacity=1}});return UWA.namespace("THREEDS/Robot/XZPlaneTranslationNode",g)});define("Robot/XZPlaneTranslationNode",["DS/Robot/XZPlaneTranslationNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Robot/XZPlaneTranslationNode");return b});define("DS/Robot/YZRotationNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/RotationManipulator","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory"],function(j,g,c,k,d,l,e,b,a,h){var f=g.extend({init:function(w){var p=this;this._parent(w.name);this.axis=w.constraintAxis;this._modelEvent=new a();this.isPreactivated=false;this.isManipulated=false;this.enablePreactivate=true;this.touchMode=w.touchMode;var o=new k();var r={width:8.5,height:8.5,fill:true,fillColor:null,noEdge:true};var t=o.createRectangle(r);var q=this;var u=c.getWebappsAssetUrl("Robot","");var n=new j.ImageUtils.loadTexture(u+"models/textures/Arc.png",undefined,null,null,j.ImageUtils.crossOriginPolicy);n.flipY=false;n.minFilter=j.LinearMipMapLinearFilter;this.planeMat=new j.MeshBasicMaterial({map:n,side:j.DoubleSide,transparent:true,alphaTest:0.05,opacity:1,enableClipPlanes:false});this.planeMat.force=true;var v=h.createMeshNode(t,this.planeMat);v.setShadow(false);v.setFrustumCulled(false);v.excludeFromCSO(true);v.excludeFromHighlight(true,true);v.setMatrix(new j.Matrix4().rotateY(-0.5*Math.PI));this.addChild(v);if(this.touchMode){v.setPickable(e.NODRAWHL);var m=new j.ImageUtils.loadTexture(u+"models/textures/Arc_picking.png",undefined,null,null,j.ImageUtils.crossOriginPolicy);m.flipY=false;m.minFilter=j.LinearMipMapLinearFilter;this.planeMat_picking=new j.MeshBasicMaterial({map:m,side:j.DoubleSide,transparent:true,alphaTest:0.05,opacity:0,enableClipPlanes:false});this.planeMat_picking.force=true;var s=h.createMeshNode(t,this.planeMat_picking);s.setShadow(false);s.setFrustumCulled(false);s.excludeFromCSO(true);s.excludeFromHighlight(true,true);s.setMatrix(new j.Matrix4().rotateY(-0.5*Math.PI));this.addChild(s)}this.manipulator=new l({axis:this.axis});this.manipulator.setExclusive(true);this.manipulator.linkToNode(this);this.manipulator.onBeginManipulate(function(x){p._modelEvent.publish({event:"RotationBegin",data:x,context:this});p.planeMat.opacity=1;p.planeMat.color=new j.Color("#1B6E9C");p.isManipulated=true});this.manipulator.onManipulate(function(x){p._modelEvent.publish({event:"RotationManipulation",data:x,context:this})});this.manipulator.onEndManipulate(function(x){p._modelEvent.publish({event:"RotationEnd",data:x,context:this});if(!p.isPreactivated){p.planeMat.color=new j.Color("#FFFFFF")}else{p.planeMat.color=new j.Color("#A1D9ED")}p.isManipulated=false});this.manipulator.onBeginPreactivate(function(x){p._modelEvent.publish({event:"BeginPreactivate",data:x,context:this});if(!p.isManipulated&&p.enablePreactivate){x.viewer.setTemporaryCursor("pointer")}p.isPreactivated=true;if(!p.isManipulated&&p.enablePreactivate){p.planeMat.color=new j.Color("#A1D9ED")}x.viewer.render()});this.manipulator.onEndPreactivate(function(x){p._modelEvent.publish({event:"EndPreactivate",data:x,context:this});if(!p.isManipulated&&p.enablePreactivate){x.viewer.unsetTemporaryCursor()}p.isPreactivated=false;if(!p.isManipulated){p.planeMat.color=new j.Color("#FFFFFF")}x.viewer.render()});this.manipulator.onPrimaryPointerClick(function(x){p._modelEvent.publish({event:"PrimaryPointerClick",data:x,context:this})})},setCenter:function(m){this.manipulator.setCenter(m)},setAxis:function(m){this.axis=m;this.manipulator.axis=m},setParentManipulated:function(m){this.enablePreactivate=!m},setToGhostState:function(){this.planeMat.opacity=0},setToNonGhostState:function(){this.planeMat.opacity=1}});return UWA.namespace("THREEDS/Robot/YZRotationNode",f)});define("Robot/YZRotationNode",["DS/Robot/YZRotationNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Robot/YZRotationNode");return b});define("DS/Robot/YZPlaneTranslationNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/PlaneTranslationManipulator","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils"],function(h,f,b,k,c,j,a,g,d){var e=f.extend({init:function(v){var o=this;this._parent(v.name);this._modelEvent=new a();this.axis=v.constraintAxis;this.isPreactivated=false;this.isManipulated=false;this.enablePreactivate=true;this.touchMode=v.touchMode;var n=new k();var q={width:6,height:6,fill:true,fillColor:null,noEdge:true};var s=n.createRectangle(q);var p=this;var t=b.getWebappsAssetUrl("Robot","");var m=new h.ImageUtils.loadTexture(t+"models/textures/PlaneTranslationNode.png",undefined,null,null,h.ImageUtils.crossOriginPolicy);m.flipY=false;m.minFilter=h.LinearMipMapLinearFilter;this.planeMat=new h.MeshBasicMaterial({map:m,side:h.DoubleSide,transparent:true,alphaTest:0.05,enableClipPlanes:false,opacity:1});this.planeMat.force=true;var u=g.createMeshNode(s,this.planeMat);u.setShadow(false);u.setFrustumCulled(false);u.excludeFromCSO(true);u.excludeFromHighlight(true,true);u.setMatrix(new h.Matrix4().rotateY(-0.5*Math.PI).translate(new h.Vector3(0.5,0.5,0)));this.addChild(u);if(this.touchMode){u.setPickable(d.NODRAWHL);var l=new h.ImageUtils.loadTexture(t+"models/textures/PlaneTranslationNode_picking.png",undefined,null,null,h.ImageUtils.crossOriginPolicy);l.flipY=false;l.minFilter=h.LinearMipMapLinearFilter;this.planeMat_picking=new h.MeshBasicMaterial({map:l,side:h.DoubleSide,transparent:true,alphaTest:0.05,enableClipPlanes:false,opacity:0});this.planeMat_picking.force=true;var r=g.createMeshNode(s,this.planeMat_picking);r.setShadow(false);r.setFrustumCulled(false);r.excludeFromCSO(true);r.excludeFromHighlight(true,true);r.setMatrix(new h.Matrix4().rotateY(-0.5*Math.PI).translate(new h.Vector3(0.5,0.5,0)));this.addChild(r)}this.manipulator=new j({axis:this.axis});this.manipulator.setExclusive(true);this.manipulator.linkToNode(this);this.manipulator.onPrimaryPointerClick(function(w){o._modelEvent.publish({event:"PrimaryPointerClick",data:{node:this},context:this})});this.manipulator.onBeginManipulate(function(w){o._modelEvent.publish({event:"PlaneTranslationBegin",data:w,context:this});o.planeMat.opacity=1;o.planeMat.color=new h.Color("#1B6E9C");o.isManipulated=true});this.manipulator.onManipulate(function(w){o._modelEvent.publish({event:"PlaneTranslationManipulation",data:w,context:this})});this.manipulator.onEndManipulate(function(w){o._modelEvent.publish({event:"PlaneTranslationEnd",data:w,context:this});if(!o.isPreactivated){o.planeMat.color=new h.Color("#FFFFFF")}else{o.planeMat.color=new h.Color("#A1D9ED")}o.isManipulated=false});this.manipulator.onBeginPreactivate(function(w){o._modelEvent.publish({event:"BeginPreactivate",data:w,context:this});if(!o.isManipulated&&o.enablePreactivate){w.viewer.setTemporaryCursor("pointer")}o.isPreactivated=true;if(!o.isManipulated&&o.enablePreactivate){o.planeMat.color=new h.Color("#A1D9ED")}w.viewer.render()});this.manipulator.onEndPreactivate(function(w){o._modelEvent.publish({event:"EndPreactivate",data:w,context:this});if(!o.isManipulated&&o.enablePreactivate){w.viewer.unsetTemporaryCursor()}o.isPreactivated=false;if(!o.isManipulated){o.planeMat.color=new h.Color("#FFFFFF")}w.viewer.render()})},setCenter:function(l){this.manipulator.setCenter(l)},setAxis:function(l){this.axis=l;this.manipulator.axis=l},setParentManipulated:function(l){this.enablePreactivate=!l},setToGhostState:function(){this.planeMat.opacity=0},setToNonGhostState:function(){this.planeMat.opacity=1}});return UWA.namespace("THREEDS/Robot/YZPlaneTranslationNode",e)});define("Robot/YZPlaneTranslationNode",["DS/Robot/YZPlaneTranslationNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Robot/YZPlaneTranslationNode");return b});define("DS/Robot/LineTranslationNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/LineTranslationManipulator","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory"],function(k,h,e,l,f,c,g,d,b,j){var a=h.extend({init:function(z){var r=this;this._parent(z.name);this.axis=new k.Vector3(0,0,1);this.position=z.position;this._modelEvent=new b();this.isPreactivated=false;this.isManipulated=false;this.enablePreactivate=true;this.touchMode=z.touchMode;this.labelText=null;this.labelBillBoardNode=null;this.labelDistance=11.5;this.labelColor=null;var q=new l();var x={width:2,height:9,fill:true,fillColor:null,noEdge:true};var B={width:2,height:9.5,fill:true,fillColor:null,noEdge:true};var w=q.createRectangle(x);var p=q.createRectangle(B);var s=this;var y=e.getWebappsAssetUrl("Robot","");var v=new k.ImageUtils.loadTexture(y+"models/textures/AS_Arrow.png",undefined,null,null,k.ImageUtils.crossOriginPolicy);v.flipY=false;this.mat=new k.MeshBasicMaterial({map:v,side:k.DoubleSide,transparent:true,alphaTest:0.05,enableClipPlanes:false});this.mat.force=true;var n=j.createMeshNode(w,this.mat);n.setShadow(false);n.setFrustumCulled(false);n.excludeFromCSO(true);n.excludeFromHighlight(true,true);if(this.touchMode){n.setPickable(g.NODRAWHL);var u=new k.MeshBasicMaterial({map:v,transparent:true,opacity:0,enableClipPlanes:false,force:true});var m={bottomCenterPoint:new k.Vector3(0,0,0),topCenterPoint:new k.Vector3(0,0,7),radius:1,sag:60,material:u};var A=j.createCylinderNode(m);A.excludeFromCSO(true);A.excludeFromHighlight(true,true);A.setShadow(false);A.setFrustumCulled(false);this.addChild(A)}n.setMatrix(new k.Matrix4().rotateX(0.5*Math.PI).translate(new k.Vector3(-1,-1,0)));var o={position:this.position,name:"billBoardNode",type:"Cylindrical"};this.billBoardNode=new f(o);this.billBoardNode.addChild(n);var t=new k.Matrix4();t.setPosition(new k.Vector3().getPositionFromMatrix(this.getMatrix()));this.setMatrix(t);this.addChild(this.billBoardNode);this.manipulator=new c({axis:this.axis});this.manipulator.setExclusive(true);this.manipulator.linkToNode(this);this.manipulator.onPrimaryPointerClick(function(C){r._modelEvent.publish({event:"PrimaryPointerClick",data:C,context:this})});this.manipulator.onBeginManipulate(function(C){r._modelEvent.publish({event:"LineTranslationBegin",data:C,context:this});r.mat.opacity=1;r.mat.color=new k.Color("#1B6E9C");r.isManipulated=true});this.manipulator.onManipulate(function(C){r._modelEvent.publish({event:"LineTranslationManipulation",data:C,context:this})});this.manipulator.onEndManipulate(function(C){r._modelEvent.publish({event:"LineTranslationEnd",data:C,context:this});if(!r.isPreactivated){r.mat.color=new k.Color("#FFFFFF")}else{C.viewer.setTemporaryCursor("pointer")}r.isManipulated=false});this.manipulator.onBeginPreactivate(function(C){r._modelEvent.publish({event:"BeginPreactivate",data:{preactivated:C.preactivated,node:n},context:this});r.isPreactivated=true;if(!r.isManipulated&&r.enablePreactivate){r.mat.color=new k.Color("#A1D9ED")}if(!r.isManipulated&&r.enablePreactivate){C.viewer.setTemporaryCursor("pointer")}C.viewer.render()});this.manipulator.onEndPreactivate(function(C){r._modelEvent.publish({event:"EndPreactivate",data:{preactivated:C.preactivated,node:n},context:this});r.isPreactivated=false;if(!r.isManipulated){r.mat.color=new k.Color("#FFFFFF")}if(!r.isManipulated&&r.enablePreactivate){C.viewer.unsetTemporaryCursor()}C.viewer.render()})},setLabel:function(o,m){m=m||"grey";if(o!==this.labelText||this.labelColor!=m){this.labelColor=m;this.labelText=o;if(this.labelBillBoardNode){this.removeChild(this.labelBillBoardNode);this.labelBillBoardNode=null}if(o){var n=j.createTextNode({text:o,font:"Trebuchet MS",fontSize:2,color:new k.Color(m),hotspot:{x:0.5,y:0.5},zoom:1.3,_fix:true});if(n){this.labelBillBoardNode=new f({name:"labelBillBoardNode",type:"Spherical"});this._updateLabelPosition();n.setFrustumCulled(false);this.labelBillBoardNode.addChild(n);this.labelBillBoardNode.setPickable(g.NODRAWHL);this.addChild(this.labelBillBoardNode)}else{this.labelColor=null;this.labelText=null}}}},setAxis:function(m){this.manipulator.axis=m},_updateLabelPosition:function(n){if(n){this.labelDistance=n}if(this.labelBillBoardNode){var o=new k.Vector3(0,0,this.labelDistance);var m=new k.Matrix4();m.setPosition(o);this.labelBillBoardNode.setMatrix(m)}},setParentManipulated:function(m){this.enablePreactivate=!m},setToGhostState:function(){this.mat.opacity=0},setToNonGhostState:function(){this.mat.opacity=1},setToDragState:function(){this.mat.opacity=0.2}});return UWA.namespace("THREEDS/Robot/LineTranslationNode",a)});define("Robot/LineTranslationNode",["DS/Robot/LineTranslationNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Robot/LineTranslationNode");return b});define("DS/Robot/RobotHandle",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/ScreenPlaneManipulator","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory"],function(k,g,d,l,e,h,f,c,b,j){var a=g.extend({init:function(x){this._parent(x.name);this.position=x.position;this._modelEvent=new b();this.isPreactivated=false;this.isManipulated=false;this.enablePreactivate=true;this.touchMode=x.touchMode;var p=this;var o=new l();var r={width:4,height:4,fill:true,fillColor:null,noEdge:true};var v=o.createRectangle(r);var q=this;var w=d.getWebappsAssetUrl("Robot","");var u=new k.ImageUtils.loadTexture(w+"models/textures/Point.png",undefined,null,null,k.ImageUtils.crossOriginPolicy);u.flipY=false;u.minFilter=k.LinearMipMapLinearFilter;this.pointMat=new k.MeshBasicMaterial({map:u,side:k.DoubleSide,transparent:true,alphaTest:0.05,enableClipPlanes:false});this.pointMat.force=true;var s=j.createMeshNode(v,this.pointMat);s.setShadow(false);s.setFrustumCulled(false);s.name="diskNode";s.excludeFromCSO(true);s.excludeFromHighlight(true,true);s.setMatrix(new k.Matrix4().setPosition(new k.Vector3(-2,-2,0)));if(this.touchMode){s.setPickable(f.NODRAWHL);var t=new k.MeshBasicMaterial({transparent:true,opacity:0,enableClipPlanes:false,color:new k.Color("red"),force:true});var n=j.createSphereNode({radius:3,material:t});n.setShadow(false);n.setFrustumCulled(false);n.name="sphereNode";n.excludeFromCSO(true);n.excludeFromHighlight(true,true);this.addChild(n)}var m={position:this.position,name:"billBoard1",type:"Spherical"};this.billBoardNode=new e(m);this.billBoardNode.addChild(s);this.addChild(this.billBoardNode);this.screenPlaneManipulator=new h({cameraName:x.cameraName});this.screenPlaneManipulator.setExclusive(true);this.screenPlaneManipulator.linkToNode(this);this.screenPlaneManipulator.onBeginManipulate(function(y){p._modelEvent.publish({event:"ScreenPlaneTranslationBegin",data:y,context:this});p.pointMat.color=new k.Color("#1B6E9C");p.pointMat.opacity=1;p.isManipulated=true});this.screenPlaneManipulator.onManipulate(function(y){p._modelEvent.publish({event:"ScreenPlaneTranslationManipulation",data:y,context:this})});this.screenPlaneManipulator.onEndManipulate(function(y){p._modelEvent.publish({event:"ScreenPlaneTranslationEnd",data:y,context:this});if(!p.isPreactivated){p.pointMat.color=new k.Color("#FFFFFF")}else{p.pointMat.color=new k.Color("#A1D9ED")}p.isManipulated=false});this.screenPlaneManipulator.onBeginPreactivate(function(y){p._modelEvent.publish({event:"BeginPreactivate",data:y,context:this});if(!p.isManipulated&&p.enablePreactivate){y.viewer.setTemporaryCursor("pointer")}p.isPreactivated=true;if(!p.isManipulated&&p.enablePreactivate){p.pointMat.color=new k.Color("#A1D9ED")}y.viewer.render()});this.screenPlaneManipulator.onEndPreactivate(function(y){p._modelEvent.publish({event:"EndPreactivate",data:y,context:this});if(!p.isManipulated&&p.enablePreactivate){y.viewer.unsetTemporaryCursor()}p.isPreactivated=false;if(!p.isManipulated){p.pointMat.color=new k.Color("#FFFFFF")}y.viewer.render()})},setParentManipulated:function(m){this.enablePreactivate=!m},setToGhostState:function(){this.pointMat.opacity=0},setToNonGhostState:function(){this.pointMat.opacity=1},setCameraName:function(m){this.screenPlaneManipulator.setCameraName(m)}});return UWA.namespace("THREEDS/Robot/RobotHandle",a)});define("Robot/RobotHandle",["DS/Robot/RobotHandle","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Robot/RobotHandle");return b});define("DS/Robot/ReferenceAxisSystemNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/BillBoardNode3D","DS/Mesh/MeshUtils"],function(e,g,b,d,a,f){var c=g.extend({init:function(h,j){this._parent(h);this.viewer=j;this.setVisibilityFree(true);this.fixedSizeNode=new b({name:"AxisSystemDisplayFixedSizeNode",ratio:4});this._createAxis();this.addChild(this.fixedSizeNode);this.setPickable(f.NODRAWHL);this.wantedVisibility=true;this._enabled=true;this.eventToken=this.viewer._modelEvent.subscribe({event:"UpdateReferenceAxisSystemVisibility"},this.onUpdateVisibility.bind(this))},onViewpointChange:function(){var k=this.viewer.currentViewpoint;if(!k){return}var m=Math.max(2*100/this.viewer.canvas.height-1,-0.85);var o=o=2*(this.viewer.canvas.width-100)/this.viewer.canvas.width-1;function l(p,w){var t=k.robotCameraOrtho;var s=new e.Vector3(p,w,0);var v=new e.Projector();v.unprojectVector(s,t);var u;if(t instanceof e.PerspectiveCamera){var r=new e.Ray(data.cameraEye,s.sub(data.cameraEye).normalize());var q=new e.Plane(k.camera.getLookAt(),0);u=r.intersectPlane(q)}else{u=s}return new e.Matrix4().setPosition(u)}var h;var j;var n=window.devicePixelRatio;h=l(2*(this.viewer.canvas.width-n*34)/this.viewer.canvas.width-1,Math.max(n*2*70/this.viewer.canvas.height-1,-0.85));this._changeMatrix(h,k.robotCameraOrtho)},onUpdateVisibility:function(h){this.wantedVisibility=h.visible;this.applyVisibility()},setCameraName:function(h){this.fixedSizeNode.setCameraName(h)},applyVisibility:function(){this.setVisibility(this.wantedVisibility&&this._enabled)},_dispose:function(){this.viewer._modelEvent.unsubscribe(this.eventToken);this.eventToken=null},_setEnabled:function(h){this._enabled=h;this.applyVisibility()},_changeMatrix:function(o,l){this.setMatrix(o);var k=new e.Vector3(),j=new e.Vector3(),r=new e.Vector3(),n=l.getLookAt();o.extractBasis(k,j,r);var m=new e.Vector3();var q=0.01;function h(s,t){m.crossVectors(s,n);if(m.lengthSq()<q*q){t.setVisibility(false)}else{t.setVisibility(true)}}var p=this._hasAxis();if(!this._hasAxis()){p=this._createAxis()}if(p){h(k,this.xAxis);h(j,this.yAxis);h(r,this.zAxis)}},_hasAxis:function(){if(!this.xAxis||!this.yAxis||!this.zAxis){return false}else{return true}},_createAxis:function(){var j=new e.MeshBasicMaterial({color:"black"});var h=5.5;function k(q,s){var m=d.createTextNode({text:s,hotspot:{x:0.5,y:0.5},font:"Trebuchet MS",color:new e.Color("black"),fontSize:4,bold:false,_fix:true});if(!m){return null}m.setFrustumCulled(false);var p=new g();var r=d.createLineNode({points:[new e.Vector3(0,0,0),new e.Vector3(h*q.x,h*q.y,h*q.z)],material:j});r.setFrustumCulled(false);r.setShadow(false);p.addChild(r);var o=new a({type:"Spherical"});var l=new e.Matrix4();var n=1.2;l.setPosition(new e.Vector3(n*h*q.x,n*h*q.y,n*h*q.z));o.setMatrix(l);o.addChild(m);p.addChild(o);return p}this.xAxis=k(new e.Vector3(1,0,0),"x");this.yAxis=k(new e.Vector3(0,1,0),"y");this.zAxis=k(new e.Vector3(0,0,1),"z");if(this.xAxis&&this.yAxis&&this.zAxis){this.fixedSizeNode.addChild(this.xAxis);this.fixedSizeNode.addChild(this.yAxis);this.fixedSizeNode.addChild(this.zAxis);return true}else{this.xAxis=null;this.yAxis=null;this.zAxis=null;return false}},CallBackEventHandlerViewPoint:function(){this.onViewpointChange.apply(this,arguments)}});return c});define("DS/Robot/XYPlaneTranslationNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/PlaneTranslationManipulator","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils"],function(g,e,b,k,c,h,a,f,d){var j=e.extend({init:function(v){var p=this;this._parent(v.name);this.axis=v.constraintAxis;this._modelEvent=new a();this.isPreactivated=false;this.isManipulated=false;this.enablePreactivate=true;this.touchMode=v.touchMode;var o=new k();var r={width:15,height:15,fill:true,fillColor:null,noEdge:true};var t=o.createRectangle(r);var q=this;var u=b.getWebappsAssetUrl("Robot","");var n=new g.ImageUtils.loadTexture(u+"models/textures/Translation_FullPlane.png",undefined,null,null,g.ImageUtils.crossOriginPolicy);n.flipY=false;this.planeMat=new g.MeshBasicMaterial({map:n,side:g.DoubleSide,transparent:true,shading:g.NoShading,alphaTest:0.05,opacity:1,enableClipPlanes:false});this.planeMat.force=true;var m=f.createMeshNode(t,this.planeMat);m.setShadow(false);m.setFrustumCulled(false);m.excludeFromCSO(true);m.excludeFromHighlight(true,true);m.setMatrix(new g.Matrix4().setPosition(new g.Vector3(-7.5,-7.5,0)));this.addChild(m);if(this.touchMode){m.setPickable(d.NODRAWHL);var l=new g.ImageUtils.loadTexture(u+"models/textures/Translation_FullPlane_picking.png",undefined,null,null,g.ImageUtils.crossOriginPolicy);l.flipY=false;this.planeMatPicking=new g.MeshBasicMaterial({map:l,side:g.DoubleSide,transparent:true,shading:g.NoShading,alphaTest:0.05,opacity:0,enableClipPlanes:false});this.planeMatPicking.force=true;var s=f.createMeshNode(t,this.planeMatPicking);s.setShadow(false);s.setFrustumCulled(false);s.excludeFromCSO(true);s.excludeFromHighlight(true,true);s.setMatrix(new g.Matrix4().setPosition(new g.Vector3(-7.5,-7.5,0)));this.addChild(s)}this.manipulator=new h({axis:this.axis});this.manipulator.setExclusive(true);this.manipulator.linkToNode(this);this.manipulator.onPrimaryPointerClick(function(w){p._modelEvent.publish({event:"PrimaryPointerClick",data:{node:this},context:this})});this.manipulator.onBeginManipulate(function(w){p._modelEvent.publish({event:"PlaneTranslationBegin",data:w,context:this});p.planeMat.opacity=1;p.planeMat.color=new g.Color("#1B6E9C");p.isManipulated=true});this.manipulator.onManipulate(function(w){p._modelEvent.publish({event:"PlaneTranslationManipulation",data:w,context:this})});this.manipulator.onEndManipulate(function(w){p._modelEvent.publish({event:"PlaneTranslationEnd",data:w,context:this});if(!p.isPreactivated){p.planeMat.color=new g.Color("#FFFFFF")}else{p.planeMat.color=new g.Color("#A1D9ED")}p.isManipulated=false;w.viewer.render()});this.manipulator.onBeginPreactivate(function(w){p._modelEvent.publish({event:"BeginPreactivate",data:w,context:this});if(!p.isManipulated&&p.enablePreactivate){w.viewer.setTemporaryCursor("pointer")}p.isPreactivated=true;if(!p.isManipulated&&p.enablePreactivate){p.planeMat.color=new g.Color("#A1D9ED")}w.viewer.render()});this.manipulator.onEndPreactivate(function(w){p._modelEvent.publish({event:"EndPreactivate",data:w,context:this});if(!p.isManipulated&&p.enablePreactivate){w.viewer.unsetTemporaryCursor()}p.isPreactivated=false;if(!p.isManipulated){p.planeMat.color=new g.Color("#FFFFFF")}w.viewer.render()})},setAxis:function(l){this.axis=l;this.manipulator.axis=l},setParentManipulated:function(l){this.enablePreactivate=!l},setToGhostState:function(){this.planeMat.opacity=0},setToNonGhostState:function(){this.planeMat.opacity=1},setToDragState:function(){this.planeMat.opacity=0.3}});return UWA.namespace("THREEDS/Robot/XYPlaneTranslationNode",j)});define("Robot/XYPlaneTranslationNode",["DS/Robot/XYPlaneTranslationNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Robot/XYPlaneTranslationNode");return b});define("DS/SceneGraphNodes/ArrowNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory"],function(k,h,a,o,c,b,e,m,j){var g=new k.Vector3();var n=new k.Matrix4();var f=new k.Matrix4();var d=new k.Matrix4();var l=h.extend({init:function(r){this._parent(r.name);this._isDynamic=true;this._headLength=r.headLength?r.headLength:20;this.viewpoint=r.viewpoint;this._initialPoint=r.initialPoint;this._finalPoint=r.finalPoint;this._head=r.head?r.head:0;this._noZ=r.removeNoZ?false:true;this.direction=new k.Vector3().subVectors(this._finalPoint,this._initialPoint);this.constraintAxis=new k.Vector3().copy(this.direction).normalize();this.arrowLength=this.direction.length();var q=null;var p=b.getWebappsAssetUrl("SceneGraphNodes","");this.mapHead=new k.ImageUtils.loadTexture(p+"models/textures/head.png",undefined,null,null,k.ImageUtils.crossOriginPolicy);this.mapHeadDisk=new k.ImageUtils.loadTexture(p+"models/textures/headDisk.png",undefined,null,null,k.ImageUtils.crossOriginPolicy);this.mapHead.anisotropy=8;this.materialArrow=new k.LineBasicMaterial({side:k.DoubleSide,color:r.color,scale:r.arrowScale?r.arrowScale:6.666,lineWidth:r.arrowWidth?r.arrowWidth:1,dashType:r.arrowDashType?r.arrowDashType:"None",linecap:"butt",transparent:true,isCPUPattern:true,alphaTest:0.05});this.materialArrow.force=true;this.materialHead=new k.MeshBasicMaterial({map:null,side:k.DoubleSide,color:r.color,transparent:true,alphaTest:0.05});this.materialHead.force=true;var v=new m();this.nodeArrowBody=j.createLineNode({points:[new k.Vector3(0,0,0),new k.Vector3(0,0,1)],material:this.materialArrow,layerNb:this._noZ?1:0});this.nodeArrowBody.setShadow(false);this.nodeArrowBody.setFrustumCulled(false);this.nodeArrowBody.setPickParent(true);this.nodeArrowBody.name="tronc de la flÃ¨che";var t={constraintAxis:this.constraintAxis,name:"billBoardNode_body",type:"Cylindrical",viewpoint:this.viewpoint};this.billBoardArrowBody=new c(t);this.billBoardArrowBody.addChild(this.nodeArrowBody);this.billBoardArrowBody.setPickParent(true);this.addChild(this.billBoardArrowBody);var s=v.createRectangle({width:1,height:1,fill:true,fillColor:null,noEdge:true,layerNb:this._noZ?1:0});this.nodeArrowHead=j.createMeshNode(s,this.materialHead);this.nodeArrowHead.setShadow(false);this.nodeArrowHead.setFrustumCulled(false);this.nodeArrowHead.setPickParent(true);this.nodeArrowHead.name="tÃªte de la flÃ¨che";this.billBoardArrowHead=new c({name:"billBoardNode_head",viewpoint:this.viewpoint});this.billBoardArrowHead.addChild(this.nodeArrowHead);this.billBoardArrowHead.setPickParent(true);this.nodeArrowHeadParent=new h();this.nodeArrowHeadParent.setPickParent(true);this.addChild(this.nodeArrowHeadParent);this.nodeArrowHeadParent.addChild(this.billBoardArrowHead);this._updateData();this.setMatrix(new k.Matrix4().setPosition(this._initialPoint));this.name="CustomizableArrow";var u=this;this.cbChange=function(w){if(u.viewpoint&&(u.viewpoint!==w.viewpoint)){return}if(w.eventType==="@onViewpointChange"){u._CallBackEventHandler(w)}};this.tokenChange=null;return this},_onLinkedToSceneGraph:function(){var p=this;this.tokenChange=a.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){a.unsubscribe(this.tokenChange)},_getDynamicMatrix:function(p,q,r){this._CallBackEventHandler(q,r);return this.getMatrix()},_CallBackEventHandler:function(s,w){var r=this.getMatrixWorld();var u=r.getMaxScaleOnAxis();g.getPositionFromMatrix(this.nodeArrowHead.getMatrixWorld());var q=w?w:s.viewpoint;var v=q.camera;var x=u/v.getWorldSizeFromPixelSize(1,g,q.viewer.div.clientHeight);var y=1/x;var t=y*(this._head?this._headLength:0);var p=(this._head===2)?this.arrowLength-t/2:this.arrowLength-t;n.makeScale(t,t,t);f.makeScale(1,1,p);if(this._head===1){this.nodeArrowHeadParent.setMatrix(d);g.set(-t/2,0,0);this.nodeArrowHead.setMatrix(n.rotateX(0.5*Math.PI).setPosition(g));g.copy(this.constraintAxis).multiplyScalar(p);n.identity();this.nodeArrowHeadParent.setMatrix(n.setPosition(g))}else{if(this._head===2){g.set(-t/2,-t/2,0);this.nodeArrowHead.setMatrix(n.setPosition(g));g.copy(this.constraintAxis).multiplyScalar(p);n.identity();this.nodeArrowHeadParent.setMatrix(n.setPosition(g))}}this.nodeArrowBody.setMatrix(f);this.billBoardArrowBody.cbChange(s);this.billBoardArrowHead.cbChange(s)},updateInitialPosition:function(p){this._initialPoint=p;this.setMatrix(new k.Matrix4().setPosition(this._initialPoint));this._updateData();this._CallBackEventHandler({viewpoint:this.viewpoint})},updateFinalPosition:function(p){this._finalPoint=p;this._updateData();this._CallBackEventHandler({viewpoint:this.viewpoint})},updateColor:function(p){this.materialArrow.color=p;this.materialHead.color=p},setArrowWidth:function(p){this.materialArrow.setLineWidth(p);this._CallBackEventHandler({viewpoint:this.viewpoint})},setArrowPattern:function(p){this.materialArrow.setDashPatternType(p);this._CallBackEventHandler({viewpoint:this.viewpoint})},setArrowPatternScale:function(p){this.materialArrow.setScale(p);this._CallBackEventHandler({viewpoint:this.viewpoint})},setHeadSize:function(p){this._headLength=p;this._CallBackEventHandler({viewpoint:this.viewpoint})},setHeadType:function(p){this._head=p;this._updateData();this._CallBackEventHandler({viewpoint:this.viewpoint})},getNodeType:function(){return"ArrowNode"},_updateData:function(){this.direction.subVectors(this._finalPoint,this._initialPoint);this.constraintAxis.copy(this.direction).normalize();this.arrowLength=this.direction.length();this.billBoardArrowBody.setConstraintAxis(this.constraintAxis);switch(this._head){case 0:this.billBoardArrowHead.setVisibility(false);this.billBoardArrowHead.setVisibilityFree(true);break;case 1:this.billBoardArrowHead.setVisibility(true);this.billBoardArrowHead.setVisibilityFree(false);this.billBoardArrowHead.setConstraintAxis(this.constraintAxis);this.billBoardArrowHead.setBillboardType("PseudoSpherical");this.materialHead.map=this.mapHead;break;case 2:this.billBoardArrowHead.setVisibility(true);this.billBoardArrowHead.setVisibilityFree(false);this.billBoardArrowHead.setBillboardType("Spherical");this.materialHead.map=this.mapHeadDisk;break;default:break}}});l.types={NONE:0,ARROW:1,DISK:2};return UWA.namespace("THREEDS/Nodes/ArrowNode",l)});define("SceneGraphNodes/ArrowNode",["DS/SceneGraphNodes/ArrowNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/ArrowNode");return b});define("DS/SceneGraphNodes/AxisSystemNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/FixedSizeArrowNode","DS/SceneGraphNodes/ArrowNode"],function(h,f,a,l,c,b,d,k,e,j){var g=f.extend({init:function(s){this._parent(s.name);this._sgRep=s.sgRep?s.sgRep:null;this.headLength=s.headLength;this.arrowLength=s.arrowLength;this.arrowWidth=s.arrowWidth;this.sceneGraph=s.sceneGraph;this.viewpoint=s.viewpoint;this.zoomable=s.zoomable||false;this._colorX=new d.Color(1,0,0,0);this._colorY=new d.Color(0,1,0,0);this._colorZ=new d.Color(0,0,1,0);if(s.colors){this._colorX=(s.colors.colorX)?s.colors.colorX:this._colorX;this._colorY=(s.colors.colorY)?s.colors.colorY:this._colorY;this._colorZ=(s.colors.colorZ)?s.colors.colorZ:this._colorZ}this._nameX="X";this._nameY="Y";this._nameZ="Z";if(s.names){this._nameX=(s.names.nameX)?s.names.nameX:this._nameX;this._nameY=(s.names.nameY)?s.names.nameY:this._nameY;this._nameZ=(s.names.nameZ)?s.names.nameZ:this._nameZ}this.head=s.head;var r={sceneGraph:this.sceneGraph,headLength:this.headLength,color:this._colorZ,arrowLength:this.arrowLength,arrowWidth:this.arrowWidth,head:this.head,name:this._nameZ,pickable:true,viewpoint:this.viewpoint,removeNoZ:true};var o=null;if(this.zoomable){r.initialPoint=new h.Vector3();r.finalPoint=new h.Vector3(0,0,this.arrowLength);o=new j(r)}else{o=new e(r)}var q={sceneGraph:this.sceneGraph,headLength:this.headLength,direction:new h.Vector3(1,0,0),color:this._colorX,arrowLength:this.arrowLength,arrowWidth:this.arrowWidth,head:this.head,name:this._nameX,pickable:true,viewpoint:this.viewpoint,removeNoZ:true};var n=null;if(this.zoomable){q.initialPoint=new h.Vector3();q.finalPoint=new h.Vector3(this.arrowLength,0,0);n=new j(q)}else{n=new e(q);n.setMatrix(new h.Matrix4().rotateY(Math.PI/2))}var p={sceneGraph:this.sceneGraph,headLength:this.headLength,color:this._colorY,arrowLength:this.arrowLength,arrowWidth:this.arrowWidth,head:this.head,name:this._nameY,pickable:true,viewpoint:this.viewpoint,removeNoZ:true};var m=null;if(this.zoomable){p.initialPoint=new h.Vector3();p.finalPoint=new h.Vector3(0,this.arrowLength,0);m=new j(p)}else{m=new e(p);m.setMatrix(new h.Matrix4().rotateX(-Math.PI/2))}this.addChild(m);this.addChild(n);this.addChild(o);this.setNoZ(true);return this},getNodeType:function(){return"AxisSystemNode"},getSGRep:function(){return this._sgRep}});g.types={NONE:null,ARROW:1,DISK:2};return UWA.namespace("THREEDS/Nodes/AxisSystemNode",g)});define("SceneGraphNodes/AxisSystemNode",["DS/SceneGraphNodes/AxisSystemNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/AxisSystemNode");return b});define("DS/Robot/ScalingNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/ScalingManipulator","DS/Mesh/MeshUtils","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory"],function(g,e,b,h,c,k,d,a,f){var j=e.extend({init:function(u){var n=this;this._parent(u.name);this.axis=u.constraintAxis;this._modelEvent=new a();this.isPreactivated=false;this.isManipulated=false;this.enablePreactivate=true;var m=new h();var p={width:2,height:2,fill:true,fillColor:null,noEdge:true};var s=m.createRectangle(p);var o=this;var t=b.getWebappsAssetUrl("Robot","");var r=new g.ImageUtils.loadTexture(t+"models/textures/Point.png",undefined,null,null,g.ImageUtils.crossOriginPolicy);r.flipY=false;r.minFilter=g.LinearMipMapLinearFilter;this.pointMat=new g.MeshBasicMaterial({map:r,side:g.DoubleSide,transparent:true,alphaTest:0.05,enableClipPlanes:false});this.pointMat.force=true;var q=f.createMeshNode(s,this.pointMat);q.setShadow(false);q.setFrustumCulled(false);q.name="diskNode";q.excludeFromCSO(true);q.excludeFromHighlight(true,true);q.setMatrix(new g.Matrix4().setPosition(new g.Vector3(-1,-1,0)));var l={position:this.position,name:"billBoard1",type:"Spherical"};this.billBoardNode=new c(l);this.billBoardNode.addChild(q);this.addChild(this.billBoardNode);this.name="handleNode";this.manipulator=new k({axis:this.axis});this.manipulator.setExclusive(true);this.manipulator.linkToNode(this);this.manipulator.onBeginManipulate(function(v){n._modelEvent.publish({event:"ScalingBegin",data:v,context:this});n.pointMat.opacity=1;n.pointMat.color=new g.Color("#1B6E9C");n.isManipulated=true});this.manipulator.onManipulate(function(v){n._modelEvent.publish({event:"ScalingManipulation",data:v,context:this})});this.manipulator.onEndManipulate(function(v){n._modelEvent.publish({event:"ScalingEnd",data:v,context:this});if(!n.isPreactivated){n.pointMat.color=new g.Color("#FFFFFF")}else{n.pointMat.color=new g.Color("#A1D9ED")}n.isManipulated=false});this.manipulator.onBeginPreactivate(function(v){n._modelEvent.publish({event:"BeginPreactivate",data:v,context:this});if(!n.isManipulated&&n.enablePreactivate){v.viewer.setTemporaryCursor("pointer")}n.isPreactivated=true;if(!n.isManipulated&&n.enablePreactivate){n.pointMat.color=new g.Color("#A1D9ED")}v.viewer.render()});this.manipulator.onEndPreactivate(function(v){n._modelEvent.publish({event:"EndPreactivate",data:v,context:this});if(!n.isManipulated&&n.enablePreactivate){v.viewer.unsetTemporaryCursor()}n.isPreactivated=false;if(!n.isManipulated){n.pointMat.color=new g.Color("#FFFFFF")}v.viewer.render()});this.manipulator.onPrimaryPointerClick(function(v){n._modelEvent.publish({event:"PrimaryPointerClick",data:v,context:this})})},setCenter:function(l){this.manipulator.setCenter(l)},setAxis:function(l){this.axis=l;this.manipulator.axis=l},setParentManipulated:function(l){this.enablePreactivate=!l},setToGhostState:function(){this.pointMat.opacity=0},setToNonGhostState:function(){this.pointMat.opacity=1}});return UWA.namespace("THREEDS/Robot/ScalingNode",j)});define("Robot/ScalingNode",["DS/Robot/ScalingNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Robot/ScalingNode");return b});define("DS/Robot/FreeRobot",["DS/SceneGraphNodes/FixedSizeNode3D","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Robot/LineTranslationNode","DS/Robot/XYRotationNode","DS/Robot/XZRotationNode","DS/Robot/YZRotationNode","DS/Robot/YZPlaneTranslationNode","DS/Robot/XYPlaneTranslationNode","DS/Robot/XZPlaneTranslationNode","DS/Robot/RobotHandle","DS/Robot/ScalingNode","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Selection/HSOManager"],function(m,b,s,g,k,l,o,c,p,d,f,q,r,n,j,e){var a=false;var h=g.extend({init:function(L,w,A,y,z){this._parent(L);this.setParameters(A,y);var D=this;this.isManipulated=false;this.sceneGraphState=null;this.mode="NODE";this._labels={};this._modelEvent=new j();this._subscribedEvents=[];var u={position:new s.Vector3(0,0,0),touchMode:z||false};this.arrowZ=new k(u);this.arrowZ.setMatrix(new s.Matrix4().setPosition(new s.Vector3(0,0,2)));this.arrowZ.name="arrowZ";this.arrowY=new k(u);this.arrowY.setMatrix(new s.Matrix4().rotateX(-Math.PI/2).setPosition(new s.Vector3(0,2,0)));this.arrowY.name="arrowY";this.arrowX=new k(u);this.arrowX.setMatrix(new s.Matrix4().rotateY(Math.PI/2).setPosition(new s.Vector3(2,0,0)));this.arrowX.name="arrowX";var I={constraintAxis:new s.Vector3(0,0,1),touchMode:z||false};this.rotationArcXY=new l(I);var J={constraintAxis:new s.Vector3(0,1,0),touchMode:z||false};this.rotationArcXZ=new o(J);this.rotationArcXZ.name="rotationArcXZ";var K={constraintAxis:new s.Vector3(1,0,0),touchMode:z||false};this.rotationArcYZ=new c(K);this.rotationArcYZ.name="rotationArcYZ";var E={position:new s.Vector3(0,0,0),touchMode:z||false};this.robotHandle=new q(E);var H={constraintAxis:new s.Vector3(1,0,0),touchMode:z||false};this.scalingNodeX=new r(H);this.scalingNodeX.setMatrix(new s.Matrix4().setPosition(new s.Vector3(11,0,0)));var G={constraintAxis:new s.Vector3(0,1,0),touchMode:z||false};this.scalingNodeY=new r(G);this.scalingNodeY.setMatrix(new s.Matrix4().setPosition(new s.Vector3(0,11,0)));var F={constraintAxis:new s.Vector3(0,0,1),touchMode:z||false};this.scalingNodeZ=new r(F);this.scalingNodeZ.setMatrix(new s.Matrix4().setPosition(new s.Vector3(0,0,11)));var C={constraintAxis:new s.Vector3(0,0,1),touchMode:z||false};var B={constraintAxis:new s.Vector3(0,1,0),touchMode:z||false};var t={constraintAxis:new s.Vector3(1,0,0),touchMode:z||false};this.translationPlaneXY=new d(C);this.translationPlaneXZ=new f(B);this.translationPlaneYZ=new p(t);this.name="robot";this.fixedSizeNode3D=new m({name:"fixedSizeNode3D",ratio:7});this.fixedSizeNode3D.addChild(this.rotationArcXY);this.fixedSizeNode3D.addChild(this.rotationArcYZ);this.fixedSizeNode3D.addChild(this.rotationArcXZ);this.fixedSizeNode3D.addChild(this.arrowZ);this.fixedSizeNode3D.addChild(this.arrowX);this.fixedSizeNode3D.addChild(this.arrowY);this.fixedSizeNode3D.addChild(this.robotHandle);this.fixedSizeNode3D.addChild(this.scalingNodeZ);this.fixedSizeNode3D.addChild(this.scalingNodeY);this.fixedSizeNode3D.addChild(this.scalingNodeX);this.fixedSizeNode3D.addChild(this.translationPlaneYZ);this.fixedSizeNode3D.addChild(this.translationPlaneXY);this.fixedSizeNode3D.addChild(this.translationPlaneXZ);this.addChild(this.fixedSizeNode3D);this.setVisibilityInTree(false);this.setRenderPasses(["robot"]);this._subscribeModelEvent(this.arrowX,"LineTranslationBegin",D.LineTranslationBeginCB.bind(D));this._subscribeModelEvent(this.arrowX,"LineTranslationManipulation",D.LineTranslationManipulationCB.bind(D));this._subscribeModelEvent(this.arrowX,"LineTranslationEnd",D.LineTranslationEndCB.bind(D));this._subscribeModelEvent(this.arrowY,"LineTranslationBegin",D.LineTranslationBeginCB.bind(D));this._subscribeModelEvent(this.arrowY,"LineTranslationManipulation",D.LineTranslationManipulationCB.bind(D));this._subscribeModelEvent(this.arrowY,"LineTranslationEnd",D.LineTranslationEndCB.bind(D));this._subscribeModelEvent(this.arrowZ,"LineTranslationBegin",D.LineTranslationBeginCB.bind(D));this._subscribeModelEvent(this.arrowZ,"LineTranslationManipulation",D.LineTranslationManipulationCB.bind(D));this._subscribeModelEvent(this.arrowZ,"LineTranslationEnd",D.LineTranslationEndCB.bind(D));this._subscribeModelEvent(this.translationPlaneYZ,"PlaneTranslationBegin",D.PlaneTranslationBeginCB.bind(D));this._subscribeModelEvent(this.translationPlaneYZ,"PlaneTranslationManipulation",D.PlaneTranslationManipulationCB.bind(D));this._subscribeModelEvent(this.translationPlaneYZ,"PlaneTranslationEnd",D.PlaneTranslationEndCB.bind(D));this._subscribeModelEvent(this.translationPlaneXZ,"PlaneTranslationBegin",D.PlaneTranslationBeginCB.bind(D));this._subscribeModelEvent(this.translationPlaneXZ,"PlaneTranslationManipulation",D.PlaneTranslationManipulationCB.bind(D));this.translationPlaneXZ._modelEvent.subscribe({event:"PlaneTranslationEnd"},D.PlaneTranslationEndCB.bind(D));this._subscribeModelEvent(this.translationPlaneXY,"PlaneTranslationBegin",D.PlaneTranslationBeginCB.bind(D));this._subscribeModelEvent(this.translationPlaneXY,"PlaneTranslationManipulation",D.PlaneTranslationManipulationCB.bind(D));this._subscribeModelEvent(this.translationPlaneXY,"PlaneTranslationEnd",D.PlaneTranslationEndCB.bind(D));this._subscribeModelEvent(this.rotationArcXY,"RotationBegin",D.RotationBeginCB.bind(D));this._subscribeModelEvent(this.rotationArcXY,"RotationManipulation",D.RotationManipulationCB.bind(D));this._subscribeModelEvent(this.rotationArcXY,"RotationEnd",D.RotationEndCB.bind(D));this._subscribeModelEvent(this.rotationArcXZ,"RotationBegin",D.RotationBeginCB.bind(D));this._subscribeModelEvent(this.rotationArcXZ,"RotationManipulation",D.RotationManipulationCB.bind(D));this._subscribeModelEvent(this.rotationArcXZ,"RotationEnd",D.RotationEndCB.bind(D));this._subscribeModelEvent(this.rotationArcYZ,"RotationBegin",D.RotationBeginCB.bind(D));this._subscribeModelEvent(this.rotationArcYZ,"RotationManipulation",D.RotationManipulationCB.bind(D));this._subscribeModelEvent(this.rotationArcYZ,"RotationEnd",D.RotationEndCB.bind(D));this._subscribeModelEvent(this.scalingNodeX,"ScalingBegin",D.ScalingBeginCB.bind(D));this._subscribeModelEvent(this.scalingNodeX,"ScalingManipulation",D.ScalingManipulationCB.bind(D));this._subscribeModelEvent(this.scalingNodeX,"ScalingEnd",D.ScalingEndCB.bind(D));this._subscribeModelEvent(this.scalingNodeY,"ScalingBegin",D.ScalingBeginCB.bind(D));this._subscribeModelEvent(this.scalingNodeY,"ScalingManipulation",D.ScalingManipulationCB.bind(D));this._subscribeModelEvent(this.scalingNodeY,"ScalingEnd",D.ScalingEndCB.bind(D));this._subscribeModelEvent(this.scalingNodeZ,"ScalingBegin",D.ScalingBeginCB.bind(D));this._subscribeModelEvent(this.scalingNodeZ,"ScalingManipulation",D.ScalingManipulationCB.bind(D));this._subscribeModelEvent(this.scalingNodeZ,"ScalingEnd",D.ScalingEndCB.bind(D));this._subscribeModelEvent(this.robotHandle,"ScreenPlaneTranslationBegin",D.ScreenPlaneTranslationBeginCB.bind(D));this._subscribeModelEvent(this.robotHandle,"ScreenPlaneTranslationManipulation",D.ScreenPlaneTranslationManipulationCB.bind(D));this._subscribeModelEvent(this.robotHandle,"ScreenPlaneTranslationEnd",D.ScreenPlaneTranslationEndCB.bind(D));this._labelColor=null;this._updateLabelColor(w);var v=w.onBackgroundModify(function x(){D._updateLabelColor(w);D.setLabels(D._labels)});this._subscribedEvents.push({object:w,token:v});this.snapFilterCallback=null;this.snapTranslationCallback=null;this.snapRotationCallback=null;this.target=null;this.initialMatrix=null;this.initialTargetWorldMatrix=null;this.robotRotationMatrix=null},setRatio:function(t){t=t||{ratio:7};this.fixedSizeNode3D.setRatio(t.ratio)},setParameters:function(u,t){this.snapOnFace=u;this.showOnlyManipulated=t},setLabels:function(t){t=t||{};this._labels=t;this.arrowX.setLabel(t.labelX,this._labelColor);this.arrowY.setLabel(t.labelY,this._labelColor);this.arrowZ.setLabel(t.labelZ,this._labelColor)},setMoveMode:function(u,t){if(u==="OCCURRENCE"){if(!a){console.warn("OCCURRENCE move mode is no more supported");a=true}return}this.mode=u;this.sceneGraphState=t?t.sceneGraphState:null},setDisplayScalingNodes:function(t){this.scalingNodeX.setVisibility(t?true:false);this.scalingNodeY.setVisibility(t?true:false);this.scalingNodeZ.setVisibility(t?true:false);var u=t?11.5:9;this.arrowX._updateLabelPosition(u);this.arrowY._updateLabelPosition(u);this.arrowZ._updateLabelPosition(u)},getNodeType:function(){return"FreeRobot"},LineTranslationBeginCB:function(t){if(this.target){this.setManipulated(true);this.initialMatrix=new s.Matrix4().copy(this.getMatrix());this.initialTargetWorldMatrix=new s.Matrix4().copy(this.target.getWorldMatrix(t.viewer));if(this.showOnlyManipulated){this.setToGhostState()}t.viewer.render()}this._modelEvent.publish({event:"LineTranslationBegin",data:{eventChannel:"LineTranslationBegin",target:this.target,intersection:t.intersection,manipulator:t.manipulator,event:t.event}})},LineTranslationManipulationCB:function(z){var u=z.translationVector;if(this.target){var A=z.paths[0].externalPath;if(this.contains(this,A)){if(this.snapTranslationCallback){u=this.snapTranslationCallback({translationVector:u,target:this.target,intersection:z.intersection});if(!u){return}}var C=new s.Vector3();C.getPositionFromMatrix(this.initialMatrix);C.add(u);var D=new s.Matrix4().copy(this.getMatrix());this.setMatrix(D.setPosition(C));this.updateCenterPosition(C);var B=new s.Vector3();B.getPositionFromMatrix(this.initialTargetWorldMatrix);B.add(u);var F=new s.Matrix4().copy(this.initialTargetWorldMatrix).setPosition(B);if(this.sceneGraphState&&this.mode==="OCCURRENCE_secret"){this.sceneGraphState.applyAbsolutePositionToPath(this.target,F)}else{if(this.mode==="NODE"){var t=this.target.externalPath;var E;var v=this.target.getParentPath();if(v){E=v.getWorldMatrix(z.viewer)}else{E=new s.Matrix4()}var y=new s.Matrix4();y.getInverse(E);var x=y.multiply(F);var w=t[t.length-1];w.setMatrix(x)}}z.viewer.render()}}this._modelEvent.publish({event:"LineTranslationManipulation",data:{eventChannel:"LineTranslationManipulation",target:this.target,translationVector:u,intersection:z.intersection,manipulator:z.manipulator,event:z.event}})},LineTranslationEndCB:function(t){if(this.target){this.setManipulated(false);if(this.showOnlyManipulated){this.setToNonGhostState()}t.viewer.render()}this._modelEvent.publish({event:"LineTranslationEnd",data:{eventChannel:"LineTranslationEnd",target:this.target,intersection:t.intersection,manipulator:t.manipulator,event:t.event}})},PlaneTranslationBeginCB:function(t){if(this.target){this.setManipulated(true);this.initialMatrix=new s.Matrix4().copy(this.getMatrix());this.initialTargetWorldMatrix=new s.Matrix4().copy(this.target.getWorldMatrix(t.viewer));if(this.showOnlyManipulated){this.setToGhostState()}t.viewer.render()}this._modelEvent.publish({event:"PlaneTranslationBegin",data:{eventChannel:"PlaneTranslationBegin",target:this.target,intersection:t.intersection,manipulator:t.manipulator,event:t.event}})},PlaneTranslationManipulationCB:function(y){if(this.target){var z=y.paths[0].externalPath;if(this.contains(this,z)){var B=new s.Vector3();B.getPositionFromMatrix(this.initialMatrix);B.add(y.translationVector);var C=new s.Matrix4().copy(this.getMatrix());this.setMatrix(C.setPosition(B));this.updateCenterPosition(B)}var A=new s.Vector3();A.getPositionFromMatrix(this.initialTargetWorldMatrix);A.add(y.translationVector);var E=(new s.Matrix4().copy(this.initialTargetWorldMatrix)).setPosition(A);if(this.sceneGraphState&&this.mode==="OCCURRENCE_secret"){this.sceneGraphState.applyAbsolutePositionToPath(this.target,E)}else{if(this.mode==="NODE"){var t=this.target.externalPath;var D;var u=this.target.getParentPath();if(u){D=u.getWorldMatrix(y.viewer)}else{D=new s.Matrix4()}var x=new s.Matrix4();x.getInverse(D);var w=x.multiply(E);var v=t[t.length-1];v.setMatrix(w)}}y.viewer.render()}this._modelEvent.publish({event:"PlaneTranslationManipulation",data:{eventChannel:"PlaneTranslationManipulation",target:this.target,translationVector:y.translationVector,intersection:y.intersection,manipulator:y.manipulator,event:y.event}})},PlaneTranslationEndCB:function(t){if(this.target){this.setManipulated(false);if(this.showOnlyManipulated){this.setToNonGhostState()}t.viewer.render()}this._modelEvent.publish({event:"PlaneTranslationEnd",data:{eventChannel:"PlaneTranslationEnd",target:this.target,intersection:t.intersection,manipulator:t.manipulator,event:t.event}})},RotationBeginCB:function(t){if(this.target){this.setManipulated(true);this.initialMatrix=new s.Matrix4().copy(this.getMatrix());this.initialTargetWorldMatrix=new s.Matrix4();this.target.getWorldMatrix(t.viewer,this.initialTargetWorldMatrix);if(this.showOnlyManipulated){this.setToGhostState()}t.viewer.render()}this._modelEvent.publish({event:"RotationBegin",data:{eventChannel:"RotationBegin",target:this.target,intersection:t.intersection,manipulator:t.manipulator,event:t.event}})},RotationManipulationCB:function(L){var w=L.angle;var K=L.axis;if(this.target){var z=L.paths[0].externalPath;var C=L.rotationMatrix;if(this.snapRotationCallback){var H=this.snapRotationCallback({axis:L.axis,angle:L.angle,target:this.target,intersection:L.intersection});w=H.value;K=H.axis;if((w===undefined)||!K){return}w=Math.PI*w/180;C=new s.Matrix4().makeRotationAxis(K,w)}if(this.contains(this,z)){var G=new s.Matrix4().copy(C);G.multiply(new s.Matrix4().extractRotation(this.initialMatrix));var I=G.setPosition(new s.Vector3().getPositionFromMatrix(this.initialMatrix));this.setMatrix(I)}var F=new s.Matrix4().copy(this.initialTargetWorldMatrix);var C=new s.Matrix4().makeRotationAxis(K,w);var v=new s.Matrix4().setPosition(new s.Vector3().getPositionFromMatrix(this.initialMatrix));var x=new s.Matrix4().getInverse(v).multiply(F);var A=new s.Matrix4().copy(C).multiply(x);var J=new s.Matrix4().copy(v).multiply(A);if(this.sceneGraphState&&this.mode==="OCCURRENCE_secret"){this.sceneGraphState.applyAbsolutePositionToPath(this.target,J)}else{if(this.mode==="NODE"){var D=this.target.externalPath;var u=new s.Matrix4();var y=this.target.getParentPath();if(y){y.getWorldMatrix(L.viewer,u)}var t=new s.Matrix4();t.getInverse(u);var B=t.multiply(J);var E=D[D.length-1];E.setMatrix(B)}}L.viewer.render()}this._modelEvent.publish({event:"RotationManipulation",data:{eventChannel:"RotationManipulation",target:this.target,rotationMatrix:L.rotationMatrix,rotationCenter:L.center,angle:w,axis:K,intersection:L.intersection,manipulator:L.manipulator,event:L.event}})},RotationEndCB:function(u){if(this.target){this.setManipulated(false);this.robotRotationMatrix=new s.Matrix4().extractRotation(this.getMatrix());var w=new s.Vector3(this.robotRotationMatrix.elements[0],this.robotRotationMatrix.elements[1],this.robotRotationMatrix.elements[2]).normalize();var v=new s.Vector3(this.robotRotationMatrix.elements[4],this.robotRotationMatrix.elements[5],this.robotRotationMatrix.elements[6]).normalize();var t=new s.Vector3(this.robotRotationMatrix.elements[8],this.robotRotationMatrix.elements[9],this.robotRotationMatrix.elements[10]).normalize();this.updateAxis(w,v,t);if(this.showOnlyManipulated){this.setToNonGhostState()}u.viewer.render()}this._modelEvent.publish({event:"RotationEnd",data:{eventChannel:"RotationEnd",target:this.target,intersection:u.intersection,manipulator:u.manipulator,event:u.event}})},ScalingBeginCB:function(t){if(this.target){this.setManipulated(true);this.initialMatrix=new s.Matrix4().copy(this.target.getWorldMatrix(t.viewer));if(this.showOnlyManipulated){this.setToGhostState()}t.viewer.render()}this._modelEvent.publish({event:"ScalingBegin",data:{eventChannel:"ScalingBegin",target:this.target,intersection:t.intersection,manipulator:t.manipulator,event:t.event}})},ScalingManipulationCB:function(z){if(this.target){var A=z.paths[0].externalPath;if(this.contains(this,A)){var t=new s.Matrix4();t.copy(z.scalingMatrix);t.multiply(new s.Matrix4().copy(this.initialMatrix));if(this.sceneGraphState&&this.mode==="OCCURRENCE_secret"){this.sceneGraphState.applyAbsolutePositionToPath(this.target,t)}else{if(this.mode==="NODE"){var u=this.target.externalPath;var B;var v=this.target.getParentPath();if(v){B=v.getWorldMatrix(z.viewer)}else{B=new s.Matrix4()}var y=new s.Matrix4();y.getInverse(B);var x=y.multiply(t);var w=u[u.length-1];w.setMatrix(x)}}z.viewer.render()}}this._modelEvent.publish({event:"ScalingManipulation",data:{eventChannel:"ScalingManipulation",target:this.target,scalingFactor:z.scalingFactor,scalingCenter:z.center,intersection:z.intersection,manipulator:z.manipulator,event:z.event}})},ScalingEndCB:function(t){if(this.target){this.setManipulated(false);if(this.showOnlyManipulated){this.setToNonGhostState()}t.viewer.render()}this._modelEvent.publish({event:"ScalingEnd",data:{eventChannel:"ScalingEnd",target:this.target,scalingFactor:t.scalingFactor,scalingCenter:t.center,intersection:t.intersection,manipulator:t.manipulator,event:t.event}})},ScreenPlaneTranslationBeginCB:function(t){this._modelEvent.publish({event:"ScreenPlaneTranslationBegin",data:{eventChannel:"ScreenPlaneTranslationBegin",position:t.position,intersection:t.intersection,manipulator:t.manipulator,event:t.event}})},ScreenPlaneTranslationManipulationCB:function(t){this._modelEvent.publish({event:"ScreenPlaneTranslationManipulation",data:{eventChannel:"ScreenPlaneTranslationManipulation",intersection:t.intersection,manipulator:t.manipulator,event:t.event}})},ScreenPlaneTranslationEndCB:function(t){this._modelEvent.publish({event:"ScreenPlaneTranslationEnd",data:{eventChannel:"ScreenPlaneTranslationEnd",target:this.target,intersection:t.intersection,manipulator:t.manipulator,event:t.event}})},setRobotMatrix:function(t){this.setMatrix(t);this.updateCenterPosition(new s.Vector3().getPositionFromMatrix(t));var w=new s.Vector3();var v=new s.Vector3();var u=new s.Vector3();t.extractBasis(w,v,u);this.updateAxis(w,v,u)},updateCenterPosition:function(t){this.rotationArcXY.setCenter(t);this.rotationArcXZ.setCenter(t);this.rotationArcYZ.setCenter(t);this.scalingNodeZ.setCenter(t);this.scalingNodeX.setCenter(t);this.scalingNodeY.setCenter(t)},updateAxis:function(v,u,t){this.arrowX.setAxis(v);this.arrowY.setAxis(u);this.arrowZ.setAxis(t);this.translationPlaneYZ.setAxis(v);this.translationPlaneXY.setAxis(t);this.translationPlaneXZ.setAxis(u);this.scalingNodeY.setAxis(u);this.scalingNodeX.setAxis(v);this.scalingNodeZ.setAxis(t);this.rotationArcYZ.setAxis(v);this.rotationArcXZ.setAxis(u);this.rotationArcXY.setAxis(t)},setManipulated:function(t){this.isManipulated=t;this.arrowX.setParentManipulated(t);this.arrowY.setParentManipulated(t);this.arrowZ.setParentManipulated(t);this.translationPlaneYZ.setParentManipulated(t);this.translationPlaneXY.setParentManipulated(t);this.translationPlaneXZ.setParentManipulated(t);this.scalingNodeY.setParentManipulated(t);this.scalingNodeX.setParentManipulated(t);this.scalingNodeZ.setParentManipulated(t);this.rotationArcYZ.setParentManipulated(t);this.rotationArcXZ.setParentManipulated(t);this.rotationArcXY.setParentManipulated(t);this.robotHandle.setParentManipulated(t)},setToGhostState:function(){this.arrowX.setToGhostState();this.arrowY.setToGhostState();this.arrowZ.setToGhostState();this.translationPlaneYZ.setToGhostState();this.translationPlaneXY.setToGhostState();this.translationPlaneXZ.setToGhostState();this.scalingNodeY.setToGhostState();this.scalingNodeX.setToGhostState();this.scalingNodeZ.setToGhostState();this.robotHandle.setToGhostState();this.rotationArcYZ.setToGhostState();this.rotationArcXZ.setToGhostState();this.rotationArcXY.setToGhostState()},setToNonGhostState:function(){this.arrowX.setToNonGhostState();this.arrowY.setToNonGhostState();this.arrowZ.setToNonGhostState();this.translationPlaneYZ.setToNonGhostState();this.translationPlaneXY.setToNonGhostState();this.translationPlaneXZ.setToNonGhostState();this.scalingNodeY.setToNonGhostState();this.scalingNodeX.setToNonGhostState();this.scalingNodeZ.setToNonGhostState();this.robotHandle.setToNonGhostState();this.rotationArcYZ.setToNonGhostState();this.rotationArcXZ.setToNonGhostState();this.rotationArcXY.setToNonGhostState()},subscribe:function(t,u){return this._modelEvent.subscribe({event:t},u)},unsubscribe:function(t){this._modelEvent.unsubscribe(t)},setTarget:function(B,u,t){this.target=B;var z=u?u.clone():null;if(!z){z=this.target.getWorldMatrix(t);var A=this.target.getBoundingSphere();z.setPosition(A.center)}this.setMatrix(z);var w=new s.Vector3();w.getPositionFromMatrix(z);this.updateCenterPosition(w);var y=new s.Vector3();var x=new s.Vector3();var v=new s.Vector3();this.getMatrix().extractBasis(y,x,v);this.updateAxis(y,x,v)},contains:function(u,v){for(var t=0;t<v.length;t++){if(v[t]===u){return true}}return false},_dispose:function(){var u,t;for(u=0;u<this._subscribedEvents.length;u++){t=this._subscribedEvents[u];t.object.unsubscribe(t.token)}this._subscribedEvents=[];this._modelEvent.destroy()},_subscribeModelEvent:function(u,t,v){this._subscribe(u._modelEvent,t,v)},_subscribe:function(u,t,w){var v=u.subscribe({event:t},w);this._subscribedEvents.push({object:u,token:v})},_updateLabelColor:function(v){var t=new s.Color(v.backgroundColor);var u=Math.round(((t.r*255*299)+(t.g*255*587)+(t.b*255*114))/1000);if(u>125){this._labelColor="grey"}else{this._labelColor="white"}}});return UWA.namespace("THREEDS/Nodes/FreeRobot",h)});define("Robot/FreeRobot",["DS/Robot/FreeRobot","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Robot/FreeRobot");return b});define("DS/Visualization/SceneGraphUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Visualization/PathElement","DS/SceneGraphNodes/AxisSystemNode"],function(o,b,l,q,c,j,p,g,f,e,d,n,h,m){var r=null;var a={applyMaterialToOccurrencePath:function(s,t,v){var w=s._getRenderableOccurrencesFromOccurrencePath(t),u;for(u=0;u<w.length;u++){w[u].material=v}return},applyMaterialToPath:function(t,s){return l._applyMaterialToPath(t,s)},applyVisibilityToPath:function(A,s){if(A===null){return false}var y=A._getRenderableOccurrences();var u=y.length;var x,t;for(x=0;x<u;x++){t=y[x];if(t){t._gsso_cache=null}}var v=A.getLastElement();if(v===null){return false}if(v instanceof l){if(s===2){v.setVisibility(!v.visible,true)}else{v.setVisibility(s,true)}}else{if(u!==1){return false}var z=[];if(v.getType()==="rep"){var w=v.getChildren();for(var x=0;x<w.length;x++){z.push(w[x].sgNode)}}else{if(v.getType()==="primitive"){z.push(v.sgNode)}}if(y[0].layer===null){y[0].initLayers(1)}y[0].layer.addPrimitivesToLayers(z,s)}return true},getVisibilityFromPath:function(C){if(!C){return false}var A=C._getRenderableOccurrences();var t=A.length;var v=C.getLastElement();if(!v){return false}if(v instanceof l){return v.isVisible()}else{if(t!==1){return false}var s=A[0];if(s.layer===null){return true}var z;if(v.getType()==="rep"){var x=v.getChildren();if(x[0]){z=x[0].sgNode}}else{if(v.getType()==="primitive"){z=v.sgNode}}for(var y=0;y<s.layer.layers.length;y++){var B=s.layer.layers[y].drawableGroup;var u=s.layer.layers[y].drawableInterval;for(var w=u.primitiveStart;w<u.primitiveStart+u.primitiveCount;w++){if(B.primitives[w]===z){return(u.layerNum===1)}}}}return false},getOrientedBoundingBoxFromPathElements:function(v,z,x){var t=new o.Box3();var w=new o.Matrix4().extractRotation(z);for(var u=0;u<v.length;++u){var y=v[u].getOrientedBoundingBox(z,x);if(y){t=t.union(y)}}var s={cornerPoint:new o.Vector3().copy(t.min).applyMatrix4(z),firstAxis:new o.Vector3(t.max.x-t.min.x,0,0).applyMatrix4(w),secondAxis:new o.Vector3(0,t.max.y-t.min.y,0).applyMatrix4(w),thirdAxis:new o.Vector3(0,0,t.max.z-t.min.z).applyMatrix4(w),localBBox:t};return s},getMaterialsFromPath:function(v,t,x){v.getRootNode()._tryOverridesUpdate(v);var y=t._getUniqueOccurrence(),s;var B=null,A=null,z=null;if(y&&y.renderable){A=[];this._traversePathMaterials(y,function u(C){if(A.indexOf(C)<0){A.push(C)}},function w(){},null,false);if(y.overrideLink){z={color:y.overrideLink.getColor(),opacity:y.overrideLink.getOpacity(),material:y.overrideLink.getFullMaterial()}}B={materials:A,overrides:z}}return B},buildModelIdPath:function(v){var s={elements:[],subElements:[]};var x,u,t;var w=v.getLastElement();if(w instanceof m&&w._sgRep){x={id:w._sgRep.cgmId,namingContext:w._sgRep.namingContext};s.elements.push(x)}else{for(u=0;u<v.internalPath.length;u++){t=v.internalPath[u].sgNode;if(t.type===1||t.type===2){x={id:t.cgmId,namingContext:t.namingContext};s.elements.push(x)}else{if(t.type===3){s.subElements.push(t.cgmId)}}}}return s},buildPathElementFromModelIdPath:function(E,G){var s=E.getLastElement(true);if(!(s instanceof q)){return null}var L=null;var x=G.elements;var t;var B=null;var J,I,H,u,A,w,K,D,C=false,v;if(G.subElements.length>0){var L=G.subElements[0];if(L>0){for(J=0;J<s.mesh3js.geometry.length&&!C;J++){w=s.mesh3js.geometry[J];for(I=0;I<w.drawingGroups.length&&!C;I++){K=w.drawingGroups[I];for(H=0;H<K.primitives.length&&!C;H++){D=K.primitives[H];if(D.cgmId===L){u=x.length-1;A=D.rep;while(A&&u>=0&&A.cgmId===x[u].id){A=A.parent;u--}if(!A&&u<0){C=true}}}}}}}if(C){v=E._getUniqueOccurrence();if(v){B=new h();B.setFromOccurrence(v,c.getFromSGNode(D))}}else{if(x.length===1){var y=s.parents[0];var z=y&&y.getChildByName("AxisSystems");if(z){for(J=0;J<z.children.length&&!C;J++){var F=z.children[J]._sgRep;if(F&&F.cgmId===x[0].id){C=z.children[J]}}if(C){B=new h();for(J=0;J<E.externalPath.length&&E.externalPath[J]!==s;J++){B.addElement(E.externalPath[J])}B.addElement(z);B.addElement(C)}}}}return B},buildPathesLeadingToNode:function(v,s){var u;var t=[];var x,w;for(u=0;u<v._occurrences.length;u++){x=v._occurrences[u];w=new h();if(w.setFromOccurrence(x,null,s)){t.push(w)}}return t},setRenderPriority:function(u,t,w){if(k.indexOf(t)<0){console.warn("SceneGraphUtils.setRenderPriority invalid input priority value");return false}var x=u._getUniqueOccurrence(w);if(x){var v=x.renderPriority;var s={userPriority:t!==null,priority:t,userOpacity:v&&v.userOpacity?true:false,opacity:v?v.opacity:null,lastRenderPriority:v?v.lastRenderPriority:-1};x.renderPriority=s;x.node._forceUpdate();return true}console.warn("SceneGraphUtils.setRenderPriority error: invalid pathElement");return false},setRenderPriorityOpacity:function(u,t,w){if(!t&&t!==0){t=null}var x=u._getUniqueOccurrence(w);if(x){var v=x.renderPriority;var s={userPriority:v&&v.userPriority?true:false,priority:v?v.priority:null,userOpacity:t!==null,opacity:t,lastRenderPriority:v?v.lastRenderPriority:-1};x.renderPriority=s;x.node._forceUpdate();return true}console.warn("SceneGraphUtils.setRenderPriority error: invalid pathElement");return false},_traversePathMaterials:function(w,G,D,x,E,y){if(w===null){return null}var v={};v[0]=0;v[3]=1;v[2]=1;v[1]=1;v[5]=2;v[6]=2;v[4]=2;function C(P){var N=[];var Q=0;for(Q=0;Q<P.geometry.length;Q++){var S=0;var R=P.geometry[Q];for(S=0;S<R.drawingGroups.length;S++){var O=R.drawingGroups[S];if(!N[v[O.glType]]){N[v[O.glType]]=O.gas}else{if(N[v[O.glType]]!==O.gas){return null}}}}return N}var H=[];if(w.renderable){H.push(w.renderable)}var u=H.length;for(var K=0;K<u;K++){var J=H[K];var M=!y&&C(J);if(J.material&&J.material.force){var B=(J.userData&&J.userData.oldMaterial)?J.userData.oldMaterial:J.material;G(B,B,function(N){J.material=N},J)}else{if(M){var F=M[2];if(!F){F=new o.MeshBasicMaterial()}if(M[0]){F.point=M[0]}if(M[1]){F.line=M[1]}G(M[2],F,function(N){N.force=true;J.material=N},J)}else{if(!E&&!J.layer){if(x){x(J)}var I=0;for(I=0;I<J.geometry.length;I++){var L=0;var z=J.geometry[I];for(L=0;L<z.drawingGroups.length;L++){var s=z.drawingGroups[L];if(s&&(!y||s._geomType===y)){G(s.gas,s.gas,function(N){J.layer.addPrimitivesToLayers(s.primitives,1,N)})}}}}else{var A=0;for(A=0;A<J.layer.layers.length;A++){var t=J.layer.layers[A];if(!y||t.drawableGroup._geomType===y){if(t.drawableInterval.material){G(t.drawableInterval.material,t.drawableInterval.material,function(N){t.drawableInterval.material=N})}else{G(t.drawableGroup.gas,t.drawableGroup.gas,function(N){t.drawableInterval.material=N})}}}}}}D()}},streamVisu:function(G){var A=["vertexIndexArray","vertexPositionArray","vertexNormalArray","vertexUvArray","vertexUv2Array","vertexTangentArray","vertexBinormalArray","vertexColorArray"];var x=G.layers||false;var K=G.node?G.node:G;var M=G.nodejsContext;var t=G.nodeCallback;var H=G.imageCallback;var w=G.loadedTexturesCallback;var I=null;var B=G.embeddedTextures||false;var O=0;var s={textures:{},materials:{},geometries:{},nodes:{}};var E=100000000;var y=0;var D=[{size:0,buffers:[],data:null}];var C={json:s,chunks:D};function J(S){var U="";if(S.substring(0,5)==="blob:"){return null}else{if(S.substring(0,7)==="http://"){U=S}else{if(S.substring(0,8)==="https://"){U=S}else{if(S.substring(0,1)==="/"){U=S}else{if(S.substring(0,7)==="file://"){return null}else{var T=location.href;var R=T.indexOf("?");if(R!==-1){T=T.substring(0,R)}var Q=T.lastIndexOf("/");if(Q!==-1){T=T.substring(0,Q+1)}U=T+S}}}}}return U}function N(){for(var T=0;T<D.length;T++){var S=D[T];S.data=new Uint8Array(S.size);for(var R=0;R<S.buffers.length;R++){var W=S.buffers[R];var V=W.buffer;var U=W.offset;for(var Q=0;Q<V.byteLength;Q++){S.data[U+Q]=V[Q]}}}return D}function F(S){if(D[y].size+S.byteLength>E){y++;D[y]={size:0,buffers:[],data:null}}var R=D[y];var T=R.size;R.buffers.push({buffer:new Uint8Array(S.buffer,S.byteOffset,S.byteLength),offset:T});R.size+=S.byteLength;if(R.size%4){R.buffers.push({buffer:new Uint8Array(4-(R.size%4)),offset:R.size});R.size+=4-(R.size%4)}return T;if(nodejsContext){var Q=new Buffer(new Uint8Array(S.buffer,S.byteOffset,S.byteLength));if(binaryData===null){binaryData=Q}else{binaryData=Buffer.concat([binaryData,Q])}}}function z(){O--;console.log("nb textures loading: "+O);if(I&&!O){I(C)}}function L(V,W){if(V.image){if(V.image.getContext||(V.image.tagName&&(V.image.tagName.toLowerCase()==="img"))){if(V.sourceFile&&V.sourceFile.substring(0,5)==="blob:"){var ad=new XMLHttpRequest();ad.open("GET",V.sourceFile,true);ad.responseType="blob";ad.onload=function(af){if(this.status===200){var ag=this.response.type;W.format=(ag==="image/jpeg")?"jpeg":"png";W.data=this.response;W.path="texture_"+W.id+"."+W.format;console.log("canvas blob");z()}};ad.send()}else{if(V.image.getContext){var ae=V.image.getContext("2d");var Q=ae.getImageData(0,0,V.image.width,V.image.height);W.format="png";W.data=Q;W.path="texture_"+W.id+"."+W.format;console.log("png");z()}}}else{if(V.mipmaps&&V.mipmaps.length){var R=V.image.width;var ac=V.image.height;W.format="dds";W.data=new Blob([o.ImageUtils.streamDDS(V)],{type:"arraybuffer"});W.path="texture_"+W.id+"."+W.format;console.log("dds");z()}else{var R=V.image.width;var ac=V.image.height;var ab=r?r:document.createElement("canvas");ab.width=R;ab.height=ac;var ae=ab.getContext("2d");var Q=ae.getImageData(0,0,R,ac);var T=Q.data;for(var U=0;U<ac;U++){for(var S=0;S<4*R;S++){T[(ac-U-1)*4*R+S]=V.image.data[U*4*R+S]}}ae.putImageData(Q,0,0,0,0,R,ac);var Z=atob(ab.toDataURL("image/png").split(",")[1]);var Y=new Array(Z.length);for(var U=0;U<Z.length;U++){Y[U]=Z.charCodeAt(U)}var X=new Uint8Array(Y);W.format="png";W.data=new Blob([X],{type:"image/png"});W.path="texture_"+W.id+"."+W.format;console.log("uncompressed");z()}}}}function v(U,R){var S=R.textures[U.id];if(!S){var Q={id:U.id,anisotropy:U.anisotropy,magFilter:U.magFilter,minFilter:U.minFilter,wrapS:U.wrapS,wrapT:U.wrapT,repeat:U.repeat};if(H){H(U,Q)}else{if(B){if(!U.loadEndStatus||(U.loadEndStatus==="complete")){O++;console.log("nb textures loading: "+O);L(U,Q)}else{if(U.loadEndStatus==="error"){console.log("texture was not loaded: impossible to embed it in streamvisu.");return undefined}else{O++;console.log("nb textures loading: "+O);U.onLoadCallbacks.push(function(V){L(V,Q)})}}}else{if(U.sourceFile){Q.format=b.getExtension(U.sourceFile);var T=J(U.sourceFile);if(T){Q.path=T}}}}R.textures[U.id]=Q}return U.id}function P(T,S){var Q="MeshPhong";if(T instanceof o.LineBasicMaterial){Q="LineBasic"}else{if(T instanceof o.PhysicalMaterial){Q="Physical"}else{if(T instanceof o.MeshLambertMaterial){Q="MeshLambert"}}}var R={id:T.id,type:Q,visible:T.visible,force:T.force,side:T.side,enableClipPlanes:T.enableClipPlanes,transparent:T.transparent,opacity:T.opacity,alphaTest:T.alphaTest,depthTest:T.depthTest,depthWrite:T.depthWrite};if(T.color){R.color=T.color}if((T instanceof o.MeshPhongMaterial)||(T instanceof o.MeshLambertMaterial)||(T instanceof o.PhysicalMaterial)){R.ambient=T.ambient;R.emissive=T.emissive;R.specular=T.specular;R.shininess=T.shininess;R.vertexColors=T.vertexColors;if(T.glossiness!==undefined){R.glossiness=T.glossiness}if(T.metalness!==undefined){R.metalness=T.metalness}if(T.map){R.diffuseMap=v(T.map,S)}if(T.bumpMap){R.bumpMap=v(T.bumpMap,S)}if(T.normalMap){R.normalMap=v(T.normalMap,S)}if(T.specularMap){R.specularMap=v(T.specularMap,S)}if(T.lightMap){R.lightMap=v(T.lightMap,S)}if(T.emissiveMap){R.emissiveMap=v(T.emissiveMap,S)}if(T.metalnessMap){R.metalnessMap=v(T.metalnessMap,S)}if(T.glossinessMap){R.glossinessMap=v(T.glossinessMap,S)}if(T.bumpMap&&(T.bumpScale!==undefined)){R.bumpScale=T.bumpScale}if(T.coating){R.coating=T.coating}if(T.coating&&(T.coatingGlossiness!==undefined)){R.coatingGlossiness=T.coatingGlossiness}}return R}var u=function(at,aj){var ao=aj.nodes[at.id];if(!ao){var aE=at.getNodeType();ao={id:at.id,type:aE};if(at._matrix&&!at._matrix.isIdentity()){var T=[];at._matrix.flattenToArray(T);ao.matrix=T}if(at.material){var az=aj.materials[at.material.id];if(!az){az=at.material;aj.materials[at.material.id]=P(az,aj)}ao.material=at.material.id}aj.nodes[at.id]=ao;if(aE==="Node3D"){var ae=[];for(var aC=0;aC<at.children.length;aC++){ae.push(at.children[aC].id)}ao.children=ae}else{var ai=at._occurrences[0].renderable;var aw=ai.boundingSphere;var ag=ai.boundingBox;if(!ag){ag=aw.getBoundingBox()}var ah=false;if(x){for(var aC=0;aC<at._occurrences.length;aC++){if(at._occurrences[aC].renderable.layer){ah=true;break}}}var Y=[];for(var aC=0;aC<ai.geometry.length;aC++){var an=ai.geometry[aC].id;Y.push(an);var W=aj.geometries[an];if(!W){W=ai.geometry[aC];var ax={};ax.id=W.id;for(var aB=0;aB<A.length;aB++){var ad=W[A[aB]];if(ad){var au=F(ad);var S={chunk:y,offset:au,byteLength:ad.byteLength,bpe:ad.BYTES_PER_ELEMENT,itemSize:ad.itemSize};ax[A[aB]]=S}}ax.dgs=[];for(var aB=0;aB<W.drawingGroups.length;aB++){var ac=W.drawingGroups[aB];if(x&&ah){ac.__id__=aB}var Q=ac.primitives;var ak=0;for(var aA=0;aA<Q.length;aA++){var U=Q[aA].decoration;if(U&&U.length){ak+=U.length}}var ap=new Uint32Array(4*Q.length);var ab=new Uint8Array(ak);var am=0;for(var aA=0;aA<Q.length;aA++){var af=Q[aA];ap[4*aA]=af.cgmId;ap[4*aA+1]=af.rep?af.rep.cgmId:0;ap[4*aA+2]=af.start;ap[4*aA+3]=af.count;var U=Q[aA].decoration;if(U&&U.length){console.log(U.length);if(U.length>255){console.log("panic")}ab[am++]=U.length;for(var ay=0;ay<U.length;++ay){ab[am++]=U[ay]}}else{ab[am++]=0}}var au=F(ap);var X={chunk:y,offset:au,byteLength:ap.byteLength,bpe:ap.BYTES_PER_ELEMENT,itemSize:ap.itemSize};var aD=undefined;if(ak){var ar=F(ab);aD={chunk:y,offset:ar,byteLength:ab.byteLength,bpe:ab.BYTES_PER_ELEMENT,itemSize:ab.itemSize}}ax.dgs[aB]={start:ac.start,count:ac.count,geomType:j.GeomTypeString[ac._geomType],glType:ac.glType,primitives:X,canonicals:aD};if(ac.material instanceof o.Material){var al=aj.materials[ac.material.id];if(!al){aj.materials[ac.material.id]=P(ac.material,aj)}ax.dgs[aB].material=ac.material.id}else{if(ac.gas){var V=aj.materials[ac.gas.id];if(!V){aj.materials[ac.gas.id]=P(ac.gas,aj)}ax.dgs[aB].gas=ac.gas.id}}}aj.geometries[an]=ax}}ao.mesh3js={bs:{c:[aw.center.x,aw.center.y,aw.center.z],r:aw.radius},bbox:{min:[ag.min.x,ag.min.y,ag.min.z],max:[ag.max.x,ag.max.y,ag.max.z]},geometries:Y};if(x&&ah){ao.occurrences={};for(var aC=0;aC<at._occurrences.length;aC++){var aq=at._occurrences[aC].renderable;if(aq.layer){var av=[];ao.occurrences[aC]={index:aC,layers:av};for(var aB=0;aB<aq.layer.layers.length;aB++){var R=aq.layer.layers[aB];var Z={start:R.drawableInterval.start,count:R.drawableInterval.count,primitiveStart:R.drawableInterval.primitiveStart,primitiveCount:R.drawableInterval.primitiveCount,layerNum:R.drawableInterval.layerNum};if(R.drawableInterval.material){Z.material=R.drawableInterval.material.id;var az=aj.materials[Z.material];if(!az){az=R.drawableInterval.material;aj.materials[Z.material]=P(az,aj)}}av.push({geometry:R.geometry.id,drawableGroup:R.drawableGroup.__id__,drawableInterval:Z})}}}}if(ai.material){var az=aj.materials[ai.material.id];if(!az){az=ai.material;aj.materials[ai.material.id]=P(az,aj)}ao.mesh3js.material=ai.material.id}}if(t){t(at,ao)}}};K.traverse(u,s);s.nbChunks=D.length;if(w){I=w}C.chunks=N();if(!O&&I){I(C)}return C}};var k=[0,1,2,3,4];return a});define("DS/Visualization/SceneGraph",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Visualization/SceneGraphUtils"],function(b,m,k,o,d,j,n,h,g,f,e,l,a){if(!window.undoSceneGraphMigrationStep2){return function c(){}}});define("Visualization/SceneGraph",["DS/Visualization/SceneGraph","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/SceneGraph");return b});define("DS/VisuLoaders/SceneGraphConverter",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraph","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory"],function(c,f,h,g,b,a,d){var e=c.extend({init:function(k,j){this.glContext=k;this.v6SceneGraph=new g();this.v6SceneGraph.name="convertedSceneGraph";this.nodes=[this.v6SceneGraph];this.convert(j)},getRootNode:function(){return this.v6SceneGraph},traverse:function(m,n){n.call(this,m,this.nodes);var k,j;for(k=0,j=m.children.length;k<j;k++){this.traverse(m.children[k],n)}if(m instanceof f.Object3D&&!(m instanceof f.Mesh)){this.nodes.pop()}},convert:function(j){this.traverse(j,function(p,m){var o,n,l,k;if(p instanceof f.Mesh){o=new a();n=o.convertFromTHREEMesh(p);l=d.createMeshNode(n,undefined,undefined,"mono");l.setMatrix(p.matrix);m[m.length-1].addChild(l)}else{if(p instanceof f.Object3D){l=new g(p.name);l.setMatrix(p.matrix);if(p.children.length){m[m.length-1].addChild(l)}m.push(l)}else{console.log("SceneGraph converter : unsupported node "+p)}}})}});return e});define("DS/Visualization/Viewpoint",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Animation/ANIM","DS/Animation/PropertyAnimation","DS/Animation/AnimationPath","DS/Visualization/TrackballControls","DS/Visualization/SceneGraph","DS/Visualization/Node3D"],function(b,d,m,e,h,c,g,a,k){var j=new m.Projector();var f=new m.Matrix4();var l=b.extend({init:function(y,o,t,r,p){var s,q,v;var u;if(y.hasOwnProperty("viewer")){this.viewer=y.viewer;this.projectionType=(y.projectionType!==undefined?y.projectionType:l.PERSPECTIVE);s=(y.angle!==undefined)?y.angle:(y.fov!==undefined)?y.fov:45;if(y.fov){console.warn("Deprecated. Use options.angle instead.")}q=(y.near!==undefined)?y.near:10;v=(y.far!==undefined)?y.far:2500;u=(y.defaultController!==undefined)?y.defaultController:true}else{console.warn("Deprecated. You must use a litteral object to define your viewpoint.");this.viewer=y;s=(o!==undefined)?o:45;q=(t!==undefined)?t:10;v=(r!==undefined)?r:2500;this.projectionType=l.PERSPECTIVE;u=(p!==undefined)?p:true}this.divCameraCSSElement=UWA.createElement("div");this.divCameraCSSElement.style.WebkitTransformStyle="preserve-3d";this.divCameraCSSElement.style.MozTransformStyle="preserve-3d";this.divCameraCSSElement.style.oTransformStyle="preserve-3d";this.divCameraCSSElement.style.transformStyle="preserve-3d";this.divCameraCSSElement.id="camera";this.viewer.divCss3DElement.appendChild(this.divCameraCSSElement);this.viewer.divCss3DElement.style.overflow="hidden";this.divCameraCSSElement.style.width=this.viewer.divCss3DElement.style.width;this.divCameraCSSElement.style.height=this.viewer.divCss3DElement.style.height;var n=(this.viewer.canvas.offsetWidth?this.viewer.canvas.offsetWidth:1),x=(this.viewer.canvas.offsetHeight?this.viewer.canvas.offsetHeight:1),w=n/x,u;if(this.projectionType===l.PERSPECTIVE){this.camera=new m.PerspectiveCamera(s,w,q,v)}else{this.camera=new m.OrthographicCamera(0,0,0,0,q,v);this.camera.setVisualizedHeight(null,w,s)}this._renderedCamera=this.camera;this.camera._viewpoint=this;this.robotCameraOrtho=new m.OrthographicCamera(0,0,0,0,q,v);this.camera.clone(this.robotCameraOrtho);this.robotCameraOrtho.setVisualizedHeight(null,w,s);this.robotCameraOrtho._viewpoint=this;this.connectedRobotCamera=this.camera.clone();this.connectedRobotCamera._viewpoint=this;this.target=new m.Vector3();this.position=new m.Vector3();this.sceneGraphRoot=null;this.control=null;this._isMoving=false;this.updateAnimation=function(z){};this._viewpointAnimation=null;this._frustum=new m.Frustum();this.setDefaultController(u);if(!u){this.resetCameraOrientation()}if(this.viewer.internalSceneGraph){this._updateRobotCamera(this.viewer.internalSceneGraph)}this._customReframeCB=null;this._customCenterCameraCB=null;this._2DMode=false;this._focusMode=l._FOCUS_MODE.TRANSLATION;return this},getCamera:function(){return this.camera},getCameraTarget:function(){console.warn("DEPRECATED");return this.target},getCameraPosition:function(){console.warn("DEPRECATED");return this.position},getControl:function(){return this.control},setEyePosition:function(n){var o=n.clone().add(this.getSightDirection().multiplyScalar(this.getTargetDistance()));this.control.setTarget(o);this.control.update()},getEyePosition:function(){return this.camera.position.clone()},setSightDirection:function(q){q.normalize();var o=this.camera.getLookAt();o.normalize();var s=Math.acos(q.clone().dot(o));if(s){var p=q.clone().cross(o);p.normalize();var n=new m.Quaternion().setFromAxisAngle(p,-s);this.control.orientation.multiplyQuaternions(n,this.control.orientation.clone());var r=this.getEyePosition().add(q.clone().multiplyScalar(this.getTargetDistance()));this.control.setTarget(r)}this.control.update()},getSightDirection:function(){return this.camera.getLookAt()},setUpDirection:function(q){q.normalize();var p=this.camera.up.clone();var r=Math.acos(q.dot(p));if(r){var o=q.clone().cross(p);o.normalize();var n=new m.Quaternion().setFromAxisAngle(o,-r);this.control.orientation.multiplyQuaternions(n,this.control.orientation.clone())}this.control.update()},getUpDirection:function(){return this.camera.up.clone()},setAngle:function(n){this.camera.fov=(360+n)%360;this.control.update()},getAngle:function(){return this.camera.fov},setTarget:function(q){var n=this.getEyePosition();var s=q.clone().sub(n).normalize();var r=Math.acos(s.dot(this.getSightDirection()));if(r){var p=(s.clone().cross(this.getSightDirection())).normalize();var o=new m.Quaternion().setFromAxisAngle(p,-r);this.getControl().orientation.multiplyQuaternions(o,this.control.orientation.clone())}this.getControl().setTarget(q);this.getControl().distanceToTarget=q.distanceTo(n);this.control.update()},getTarget:function(){return this.target.clone()},setTargetDistance:function(n){var o=this.getEyePosition().add(this.getSightDirection().multiplyScalar(n));this.control.setTarget(o);this.control.distanceToTarget=n;if(this.projectionType===l.ORTHOGRAPHIC){this.camera.setVisualizedHeight(n)}this.control.update()},getTargetDistance:function(){return this.getControl().distanceToTarget},setProjectionType:function(p){if(p!==this.projectionType){this.projectionType=p;if(!this.cameraOther){var q=this.camera.near;var n=this.camera.far;if(p===l.PERSPECTIVE){this.cameraOther=new m.PerspectiveCamera(this.camera.fov,this.camera.aspect,q,n)}else{this.cameraOther=new m.OrthographicCamera(0,0,0,0,q,n)}this.cameraOther._viewpoint=this}this.cameraOther.position=this.camera.position;this.cameraOther.fov=this.camera.fov;this.cameraOther.aspect=this.camera.aspect;this.cameraOther.pixelCulling=this.camera.pixelCulling;if(this.camera.fullWidth){this.cameraOther.setViewOffsetInternal(this.camera.fullWidth,this.camera.fullHeight,this.camera.x,this.camera.y,this.camera.width,this.camera.height)}var o=this.camera;this.camera=this.cameraOther;this.connectedRobotCamera=this.camera.clone();this.connectedRobotCamera._viewpoint=this;this.cameraOther=o;this.camera.updateMatrix();this.camera.matrixWorld.copy(this.camera.matrix);this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld);this.camera._hasChanged=true;this.control.camera=this.camera;this.control.update();this.viewer.render()}},getProjectionType:function(){return this.projectionType},_setIntraOccularDistance:function(n){},setPixelCulling:function(o,n){this.viewer&&this.viewer.setPixelCulling(o,n)},_setPixelCulling:function(n){this.camera.pixelCulling=n},setDefaultController:function(n,p){var o={SIMPLE:g.Mode.SIMPLE,CATIA:g.Mode.CATIA,COMBINED:g.Mode.COMBINED};if(!n&&(this.control===null)){return}if(n&&(this.control!==null)){if(p!==undefined){this.control.setMode(o[p])}return}if(n){this.control=new g(this,this.viewer.canvas);if(p!==undefined){this.control.setMode(o[p])}this.control.rotateSpeed=1;this.control.lockZRotationSpeed=0.002;this.control.zoomSpeed=5;this.control.panSpeed=1.1}else{if(this.control!==null){this.control.detachEvents()}this.control=null}this.resetCameraOrientation()},setControlActive:function(n){if(this.control!==null){this.control.setActive(n)}},addDivToManipulation:function(n){if(this.control){return this.control.addViewToManipulation(n)}return false},removeDivToManipulation:function(n){if(this.control){return this.control.removeViewFromManipulation(n)}return false},onReframe:function(n){this._customReframeCB=n},onCenterCamera:function(n){this._customCenterCameraCB=n},_setFocusMode:function(n){this._focusMode=n},__rotatedFocusMoveTo:function(q){q.sight=q.sightDirection;q.position=q.eyePosition;var r=true;var u,v,F,w,E,p;w=q.distanceToTarget;if(q.orientation){p=q.orientation;var n=new m.Vector3(0,0,-1);n.applyQuaternion(p);n.normalize();v=n}else{if(q.sight){v=q.sight.clone().normalize();var D=this.camera.getLookAt().clone().normalize();var A=Math.acos(v.dot(D));if(A){var o=(v.clone().cross(D)).normalize();var y=new m.Quaternion().setFromAxisAngle(o,-A);p=new m.Quaternion().multiplyQuaternions(y,this.control.orientation.clone())}else{p=this.control.orientation.clone();v=D}}}F=q.position;E=new m.Vector3().addVectors(F,v.clone().multiplyScalar(w));var C={position:F,target:E,distanceToTarget:w,orientation:p,duration:q.duration||0};if(this._viewpointAnimation){this._viewpointAnimation.stop()}var s={eventChannel:"/VISU/",eventType:"@onViewpointBeginMove_bis",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};if(C.duration===0){d.publish({event:"/VISU/",data:s});var n=new m.Vector3(0,0,-1);n.applyQuaternion(C.orientation);n.normalize();var E=new m.Vector3().addVectors(this.control.position,n.multiplyScalar(C.distanceToTarget));this.control.setTarget(E);this.control.orientation=C.orientation.clone();this.control.distanceToTarget=C.distanceToTarget;this.control.update();var B={eventChannel:"/VISU/",eventType:"@onViewpointEndMove_bis",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};d.publish({event:"/VISU/",data:B})}else{var x=new c({orientation:this.control.orientation.clone(),distanceToTarget:this.control.distanceToTarget},{orientation:C.orientation,distanceToTarget:C.distanceToTarget},C.duration);x.setInterpolator(function(H,I,J){var G={};var K=new m.Quaternion();m.Quaternion.slerp(I.orientation,J.orientation,K,H);G.orientation=K;G.distanceToTarget=I.distanceToTarget+(J.distanceToTarget-I.distanceToTarget)*H;return G});this.updateAnimation=function(G){if(this.control){var H=new m.Vector3(0,0,-1);H.applyQuaternion(G.orientation);H.normalize();var I=new m.Vector3().addVectors(this.control.position,H.multiplyScalar(G.distanceToTarget));this.control.setTarget(I);this.control.orientation=G.orientation.clone();this.control.distanceToTarget=G.distanceToTarget;this.control.update()}};var z=this;var t=function(H){if(H===e.State.STOPPED){var G={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:z,cameraEye:z.camera.position,cameraUp:z.camera.up};d.publish({event:"/VISU/",data:G})}};this._viewpointAnimation=new h(this,"updateAnimation",x,t);this._viewpointAnimation.start();d.publish({event:"/VISU/",data:s})}},moveTo:function(r){if(r.up||r.sight||r.position){console.log("DEPRECATED Naming: options.up => options.upDirection, options.sight => options.sightDirection, options.position => options.eyePosition.")}else{r.up=r.upDirection;r.sight=r.sightDirection;r.position=r.eyePosition}var u,v,G,w,F,q;w=r.distanceToTarget||this.control.distanceToTarget;if(r.orientation){q=r.orientation;var H=new m.Vector3(0,1,0);H.applyQuaternion(q);H.normalize();u=H;var n=new m.Vector3(0,0,-1);n.applyQuaternion(q);n.normalize();v=n}else{if(r.up&&r.sight){u=r.up.clone().normalize();v=r.sight.clone().normalize()}else{if(r.up){u=r.up.clone().normalize();var p=this.camera.up.clone().normalize();var B=Math.acos(u.dot(p));if(B){var o=(u.clone().cross(p)).normalize();var y=new m.Quaternion().setFromAxisAngle(o,-B);v=this.camera.getLookAt().clone().applyQuaternion(y).normalize();q=new m.Quaternion().multiplyQuaternions(y,this.control.orientation.clone())}else{q=this.control.orientation.clone();u=p;v=this.camera.getLookAt().clone().normalize()}}else{if(r.sight){v=r.sight.clone().normalize();var E=this.camera.getLookAt().clone().normalize();var B=Math.acos(v.dot(E));if(B){var o=(v.clone().cross(E)).normalize();var y=new m.Quaternion().setFromAxisAngle(o,-B);u=this.camera.up.clone().applyQuaternion(y).normalize();q=new m.Quaternion().multiplyQuaternions(y,this.control.orientation.clone())}else{q=this.control.orientation.clone();v=E;u=this.camera.up.clone().normalize()}}else{q=this.control.orientation.clone();var H=new m.Vector3(0,1,0);H.applyQuaternion(this.control.orientation);H.normalize();u=H;var n=new m.Vector3(0,0,-1);n.applyQuaternion(this.control.orientation);n.normalize();v=n}}}}if(r.position){G=r.position;F=new m.Vector3().addVectors(G,v.clone().multiplyScalar(w))}else{G=new m.Vector3().subVectors(this.control.target,v.clone().multiplyScalar(w));F=this.control.target.clone()}if(!q){q=new m.Quaternion();var A=new m.Matrix4();A.lookAt(G,F,u);q.setFromRotationMatrix(A)}var D={position:G,target:F,distanceToTarget:w,orientation:q,duration:r.duration||0};if(this._viewpointAnimation){this._viewpointAnimation.stop()}var s={eventChannel:"/VISU/",eventType:"@onViewpointBeginMove_bis",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};if(D.duration===0){d.publish({event:"/VISU/",data:s});this.control.setTarget(D.target);this.control.orientation=D.orientation;this.control.distanceToTarget=D.distanceToTarget;this.control.update();var C={eventChannel:"/VISU/",eventType:"@onViewpointEndMove_bis",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};d.publish({event:"/VISU/",data:C})}else{var x=new c({target:this.control.target.clone(),orientation:this.control.orientation.clone(),distanceToTarget:this.control.distanceToTarget},{target:D.target,orientation:D.orientation,distanceToTarget:D.distanceToTarget},D.duration);x.setInterpolator(function(K,L,M){var J={};var I=L.target.clone();I.lerp(M.target,K);J.target=I;var N=new m.Quaternion();m.Quaternion.slerp(L.orientation,M.orientation,N,K);J.orientation=N;J.distanceToTarget=L.distanceToTarget+(M.distanceToTarget-L.distanceToTarget)*K;return J});this.updateAnimation=function(I){if(this.control){this.control.setTarget(I.target);this.control.orientation=I.orientation.clone();this.control.distanceToTarget=I.distanceToTarget;this.control.update()}};var z=this;var t=function(J){if(J===e.State.STOPPED){var I={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:z,cameraEye:z.camera.position,cameraUp:z.camera.up};d.publish({event:"/VISU/",data:I})}};this._viewpointAnimation=new h(this,"updateAnimation",x,t);this._viewpointAnimation.start();d.publish({event:"/VISU/",data:s})}},onMove:function(n){if(this.control){return this.control.onMove(n)}},unsubscribe:function(n){if(this.control){this.control.unsubscribe(n)}},isMoving:function(){return this._isMoving},resize:function(o,n){if(this.robotCameraOrtho&&this.camera){this.robotCameraOrtho.setVisualizedHeight(null,undefined,this.camera.fov)}if(this.control!==null){this.control._resize(o,n)}},setSceneGraph:function(n){k.DEPRECATED_SceneGraph(new Error());if(n instanceof a){this.sceneGraph=n}},_setNode:function(n){this.sceneGraphRoot=n},_set2DMode:function(n){this._2DMode=n;if(n){this.setSightDirection(new m.Vector3(0,0,-1));this.setUpDirection(new m.Vector3(0,1,0));this.setProjectionType(1);if(this.control){this.control._2DMode=true;this.control.setMouseRotationActive(false);this.control.setTouchRotationActive(false)}}else{this.control._2DMode=false;this.control.setMouseRotationActive(true);this.control.setTouchRotationActive(true)}},resetCameraOrientation:function(){if(this._2DMode){return}var q,o,n,r;q=new m.Vector3(0.35*Math.PI,0,0.75*Math.PI);o=new m.Quaternion();o.setFromEuler(q,"ZXY");n=1.1*100/Math.tan(22.5*Math.PI/180);if(this.sceneGraphRoot!==null){r=this.getBoundingSphere().radius;n=1.1*r/Math.tan(22.5*Math.PI/180)}this.camera.position=new m.Vector3(n,n,n).multiplyScalar(1/Math.sqrt(3));if(this.control===null){this.camera.quaternion=o;this.camera.useQuaternion=true;this.camera.updateMatrix()}else{this.control.orientation=o;var p=new m.Vector3(0,0,-1);p.applyQuaternion(o);p.normalize();this.moveTo({orientation:o,eyePosition:p.clone().multiplyScalar(-n),distanceToTarget:n,duration:0})}},reframe:function(t,p,r,o,q){if(!this.sceneGraphRoot){return}if(this.control===null){return}if(!o&&this.viewer){o=this.viewer.visibleSpace?"visibleSpace":"invisibleSpace"}if(this._customReframeCB){this._customReframeCB(t,p,r,o);return}var s,n,v;n=(p!==undefined)?p:400;if(r||!this._2DMode){if((r!==undefined)&&(r instanceof m.Mesh)){s=r.boundingSphere.clone();s.applyMatrix4(r.matrixWorld)}else{if((r!==undefined)&&(r instanceof m.Sphere)){s=r.clone()}else{s=this.getBoundingSphere(o,q)}}v=this._buildReframeTarget(s,t)}else{v=this._buildReframeTarget2D(o)}if(v){var u=new m.Vector3(0,0,-1);u.applyQuaternion(v.orientation);u.normalize();this.moveTo({orientation:v.orientation,eyePosition:new m.Vector3().addVectors(v.target,u.clone().multiplyScalar(-v.distanceToTarget)),distanceToTarget:v.distanceToTarget,duration:n})}},_buildReframeTarget2D:function(o){var v=null,r,u,t,s;var q=this.getBoundingBox2D(o);if(q.empty()){q.set(new m.Vector2(-100,-100),new m.Vector2(100,100))}r=new m.Vector3((q.min.x+q.max.x)/2,(q.min.y+q.max.y)/2,0);var n=this.camera.aspect;var p=0.5/Math.tan(this.camera.fov*Math.PI/360);t=p*(q.max.x-q.min.x)/n;s=p*(q.max.y-q.min.y);u=Math.max(t,s);return{target:r,orientation:new m.Quaternion(),distanceToTarget:u,}},_buildReframeTarget:function(s,t){var v=null,n,p,u,r,q,o;if(s||boundingBox2D){p=this.target.clone();n=this.control.orientation.clone();u=this.control.distanceToTarget;if(t==null||this._2DMode){u=1.1*s.radius/Math.tan(this.camera.fov*Math.PI/360);p=s.center.clone()}else{if(t==="right"){o=new m.Vector3(0.5*Math.PI,0,Math.PI);n=new m.Quaternion();n.setFromEuler(o,"ZXY")}else{if(t==="left"){o=new m.Vector3(0.5*Math.PI,0,0);n=new m.Quaternion();n.setFromEuler(o,"ZXY")}else{if(t==="top"){o=new m.Vector3(0,0,0.5*Math.PI);n=new m.Quaternion();n.setFromEuler(o,"ZXY")}else{if(t==="bottom"){o=new m.Vector3(Math.PI,0,0.5*Math.PI);n=new m.Quaternion();n.setFromEuler(o,"ZXY")}else{if(t==="front"){o=new m.Vector3(0.5*Math.PI,0,0.5*Math.PI);n=new m.Quaternion();n.setFromEuler(o,"ZXY")}else{if(t==="back"){o=new m.Vector3(0.5*Math.PI,0,-0.5*Math.PI);n=new m.Quaternion();n.setFromEuler(o,"ZXY")}else{if(t==="iso"){o=new m.Vector3(0.35*Math.PI,0,0.75*Math.PI);n=new m.Quaternion();n.setFromEuler(o,"ZXY")}}}}}}}}v={target:p,orientation:n,distanceToTarget:u,}}return v},centerCamera:function(s){if(this.control===null){return}if(this._customCenterCameraCB){this._customCenterCameraCB(s);return}if(s===null){return}var v=s.clone();var p=this.control.orientation.clone();var x=v.distanceTo(this.camera.position);if(this._focusMode===l._FOCUS_MODE.TRANSLATION){var A=new m.Vector3(0,0,-1);A.applyQuaternion(p);A.normalize();var z=this.viewer.ODTMode;var u=new m.Vector3().addVectors(v.clone(),A.clone().multiplyScalar(-x));this.moveTo({eyePosition:u,distanceToTarget:x,duration:z?0:200})}else{if(this._focusMode===l._FOCUS_MODE.ROTATION){var o=new m.Vector3().subVectors(v,this.control.position).normalize();var z=this.viewer.ODTMode;if(this.control.lockZ||m.mobileVersion){var w=this.camera.getLookAt().clone().normalize();var t=null;var r=Math.acos(o.dot(w));if(r){var q=(o.clone().cross(w)).normalize();var y=new m.Quaternion().setFromAxisAngle(q,-r);t=new m.Quaternion().multiplyQuaternions(y,this.control.orientation.clone())}else{t=this.control.orientation.clone();o=w}var n=t.toEuler();n.y=0;t=(new m.Quaternion()).setFromEuler(n,"ZYX");this.__rotatedFocusMoveTo({eyePosition:this.control.position,orientation:t,distanceToTarget:x,duration:z?0:200})}else{this.__rotatedFocusMoveTo({eyePosition:this.control.position,sightDirection:o,distanceToTarget:x,duration:z?0:200})}}}},centerCameraSVG:function(p,o){this.control.update();var v=p.x-o.x;var u=p.y-o.y;var q,r,s;if((v===0)&&(u===0)){return}q=new m.Vector3().copy(this.camera.position).sub(this.target);r=(this.camera.top-this.camera.bottom)/this.viewer.div.clientHeight;s=new m.Vector3();s.add(q.clone().cross(this.camera.up).setLength(r*v));s.add(this.camera.up.clone().setLength(r*u));var t=this.viewer.ODTMode;var n=this.camera.position.clone().add(s);this.moveTo({eyePosition:n,duration:t?0:200})},pan:function(p){if(this.control===null){return}var s=new m.Vector3(),r,o,n;switch(p){case"left":s.x=-1;break;case"right":s.x=1;break;case"top":s.y=1;break;case"bottom":s.y=-1;break;default:s.x=1}s.applyQuaternion(this.control.orientation);s.setLength(0.05*this.control.distanceToTarget);r=this.target.clone().add(s);o=this.control.orientation.clone();n=this.control.distanceToTarget;var q=this.viewer.ODTMode;this.moveTo({eyePosition:new m.Vector3().addVectors(r,this.getCamera().getLookAt().clone().normalize().multiplyScalar(-n)),duration:q?0:100})},zoom:function(q){if(this.control===null){return}var p=0.9,s,o,n;if(q==="out"){p=1.1}s=this.target.clone();o=this.control.orientation.clone();n=this.control.distanceToTarget*p;var r=this.viewer.ODTMode;this.moveTo({eyePosition:new m.Vector3().addVectors(s,this.getCamera().getLookAt().clone().normalize().multiplyScalar(-n)),distanceToTarget:n,duration:r?0:100})},rotateCameraForPerfos:function(o,s,n){if(this.control===null){return}var p=function(){var t=new m.Vector3(0.35*Math.PI,0,0.75*Math.PI);this._orientation=(new m.Quaternion()).setFromEuler(t,"ZXY");this._key1=new m.Quaternion();this._key2=(new m.Quaternion()).setFromAxisAngle(new m.Vector3(0,0,1),Math.PI/2);this._key3=(new m.Quaternion()).setFromAxisAngle(new m.Vector3(0,0,1),Math.PI);this._key4=(new m.Quaternion()).setFromAxisAngle(new m.Vector3(0,0,1),3*Math.PI/2);this._nbLoops=(o!==undefined)?o:5;this._duration=(s!==undefined)?s:10000;this.duration=function(){return this._duration};this.valueAt=function(x){var u,A,z,w,y=this._duration/this._nbLoops,v=(x%y)/y;if(v>=0&&v<0.25){u=this._key1;A=this._key2;w=v/0.25}else{if(v>=0.25&&v<0.5){u=this._key2;A=this._key3;w=(v-0.25)/0.25}else{if(v>=0.5&&v<0.75){u=this._key3;A=this._key4;w=(v-0.5)/0.25}else{u=this._key4;A=this._key1;w=(v-0.75)/0.25}}}z=new m.Quaternion();m.Quaternion.slerp(u,A,z,w);return z.multiply(this._orientation)}},r=new p(),q=new h(this.control,"orientation",r);if(n){q.setLoop(1)}q.start()},getBoundingBox2D:function(q){if(!this._2DMode){return null}var t=this.viewer||this.sceneGraphRoot._getViewer();var r=null;var o;if(t.svgRoot){var s=this.viewer.svgRoot.getBBox();o=new m.Box2(new m.Vector2(s.x,-s.y-s.height),new m.Vector2(s.x+s.width,-s.y))}var n=t?t.getSceneBoundingBox(q):this.sceneGraphRoot.getBoundingBox(q);var p=new m.Box2(new m.Vector2(n.min.x,n.min.y),new m.Vector2(n.max.x,n.max.y));if(o){p.union(o)}return p},getBoundingSphere:function(o,p){var q=this.viewer||this.sceneGraphRoot._getViewer();var n=q?q.getSceneBoundingSphere(o,true):this.sceneGraphRoot.getBoundingSphere(o,true);if(!n){n=new m.Sphere(new m.Vector3(),100)}else{if(n.radius===0&&n.pixelRadius>0){if(p!==undefined){n.radius=p}else{n.radius=n.pixelRadius}}else{if(n.radius===0){if(p!==undefined){n.radius=p}else{n.radius=100}}}}return n},setViewOffset:function(p){function o(u,w){if(!p){u.setViewOffsetInternal(0,0,0,0,w.SCREEN_WIDTH,w.SCREEN_HEIGHT)}else{if(p.camera){u=p.camera}var v=p.fullWidth?p.fullWidth:w.SCREEN_WIDTH,s=p.fullHeight?p.fullHeight:w.SCREEN_HEIGHT,r=p.x?p.x:0,z=p.y?p.y:0,t=p.width?p.width:w.SCREEN_WIDTH,q=p.height?p.height:w.SCREEN_HEIGHT;u.setViewOffsetInternal(v,s,r,z,t,q)}}var n=this.camera;o(n,this.viewer);n.clone(this.robotCameraOrtho);this.robotCameraOrtho.setVisualizedHeight(null,undefined,n.fov)},project:function(p,q){var o=q||this.camera;var n=p.clone();j.projectVector(n,o);n.x=0.5*this.viewer.canvas.offsetWidth*(n.x+1);n.y=0.5*this.viewer.canvas.offsetHeight*(1-n.y);return n},unProject:function(q,r){var p=r||this.camera;var n=(q.x/this.viewer.canvas.offsetWidth)*2-1;var s=-(q.y/this.viewer.canvas.offsetHeight)*2+1;var o=new m.Vector3(n,s,q.z);j.unprojectVector(o,p);return o},create3DRayFrom2DPoint:function(p,r){var n=(p.x/this.viewer.canvas.offsetWidth)*2-1;var t=-(p.y/this.viewer.canvas.offsetHeight)*2+1;var o=new m.Vector3(n,t,-1);j.unprojectVector(o,r?r:this.camera);var s=new m.Vector3(n,t,1);j.unprojectVector(s,r?r:this.camera);var q=new m.Vector3().copy(s).sub(o);q.normalize();return new m.Ray(o,q)},dump:function(){var n="viewpoint.control.target = new THREE.Vector3("+this.control.target.x+", "+this.control.target.y+", "+this.control.target.z+");\nviewpoint.control.orientation = new THREE.Quaternion("+this.control.orientation.x+", "+this.control.orientation.y+", "+this.control.orientation.z+", "+this.control.orientation.w+");\nviewpoint.control.distanceToTarget = "+this.control.distanceToTarget+";";console.log(n)},setFromJSON:function(n){},_setPickingViewOffset:function(o){function n(s,r){var q=s._hasChanged;if(o.reset){s.setViewOffsetInternal(0,0,0,0,r.SCREEN_WIDTH,r.SCREEN_HEIGHT,{});s._hasChanged=q}else{var w=o.fullWidth?o.fullWidth:r.SCREEN_WIDTH,u=o.fullHeight?o.fullHeight:r.SCREEN_HEIGHT,v=o.x?o.x:0,t=o.y?o.y:0,p=o.width?o.width:r.SCREEN_WIDTH,z=o.height?o.height:r.SCREEN_HEIGHT;s.setViewOffsetInternal(w,u,v,t,p,z,{ratioW:o.pickingRatioW,ratioH:o.pickingRatioH});s._hasChanged=q}}if(o&&o.cameraSet){n(o.cameraSet.main,this.viewer);n(o.cameraSet.robotCameraOrtho,this.viewer);n(o.cameraSet.connectedRobotCamera,this.viewer)}},_updateRobotCamera:function(t){function r(E,D){var F=new m.Vector3().subVectors(E.center,D.position);var C=D.getLookAt();var G=F.dot(C);return{near:G-E.radius,far:G+E.radius}}var u=this.camera;u.clone(this.robotCameraOrtho);this.robotCameraOrtho.position.set(0,0,0);this.robotCameraOrtho.updateMatrix();this.robotCameraOrtho.updateMatrixWorld();this.robotCameraOrtho.updateProjectionMatrix();this.robotCameraOrtho.projectionMatrixInverse.getInverse(this.robotCameraOrtho.projectionMatrix);u.clone(this.connectedRobotCamera);var x=t.robotRoot;var q,y,s,n,A,z,B;y=x.getMatrixWorld();s=x.getBoundingSphere();if(s.pixelRadius>0){var o=this.robotCameraOrtho.getWorldSizeFromPixelSize(1,s.center,this.viewer.div.clientHeight);if((typeof this.robotCameraOrtho.fullWidth!=="undefined")&&this.robotCameraOrtho.fullWidth>0){var w=Math.max(this.robotCameraOrtho.width*1/this.robotCameraOrtho.fullWidth,this.robotCameraOrtho.height*1/this.robotCameraOrtho.fullHeight);o*=w}s.radius+=o*s.pixelRadius}if(s.radius===0){s.radius=10}if(s){z=r(s,this.robotCameraOrtho);this.robotCameraOrtho.near=z.near;this.robotCameraOrtho.far=z.far;this.robotCameraOrtho.updateProjectionMatrix();this.robotCameraOrtho.projectionMatrixInverse.getInverse(this.robotCameraOrtho.projectionMatrix);var p=t._robot;if(p){var v=!p.isConnected||p.isManipulatedInPlane;if(!v){q=p.getMatrixWorld();n=p.getBoundingSphere();if(n.pixelRadius>0){var o=this.connectedRobotCamera.getWorldSizeFromPixelSize(1,n.center,this.viewer.div.clientHeight);if((typeof this.connectedRobotCamera.fullWidth!=="undefined")&&this.connectedRobotCamera.fullWidth>0){var w=Math.max(this.connectedRobotCamera.width*1/this.connectedRobotCamera.fullWidth,this.connectedRobotCamera.height*1/this.connectedRobotCamera.fullHeight);o*=w}n.radius+=o*n.pixelRadius}n.applyMatrix4(q);B=r(n,this.camera);this.connectedRobotCamera.near=Math.min(B.near,u.near);this.connectedRobotCamera.far=Math.max(B.far,u.far);this.connectedRobotCamera.updateProjectionMatrix();this.connectedRobotCamera.projectionMatrixInverse.getInverse(this.connectedRobotCamera.projectionMatrix)}}}},_updateFrustum:function(){var n=this.camera;f.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse);this._frustum.setFromMatrix(f)}});l._FOCUS_MODE={TRANSLATION:0,ROTATION:1};l.PERSPECTIVE=0;l.ORTHOGRAPHIC=1;return UWA.namespace("THREEDS/Viewpoint",l)});define("Visualization/Viewpoint",["DS/Visualization/Viewpoint","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/Viewpoint");return b});define("DS/Robot/Robot",["DS/Robot/FreeRobot","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/Robot/ReferenceAxisSystemNode"],function(b,h,k,f,c,d,g,e){var a={x:new k.Vector3(),y:new k.Vector3(),z:new k.Vector3()};var j=b.extend({init:function(m,l,n,q,p,r,o){if(r!=="I solemnly swear that I am up to no good."){console.warn("DEPRECATED API USE: create Robot using 'webGLV6Viewer.setRobot(true, {snapOnFace: true});\nStack: "+(new Error()).stack)}this._parent(l,n,q,p,o);this.viewer=n;this.sceneGraph=m;this._addToCSO=true;this._addToHSO=true;this.hiddenMode=false;this.moveViewpointOnClickDuration=1000;this._enabled=true;this._showLabels=true;this._viewPlane=null;this._viewPlaneOrientation=0;this.ratio=null;this.isConnected=false;this.isManipulatedInPlane=false;this._getPositionCB=null;var s=this;this.setVisibilityFree(true);n._addRobot(this,this.sceneGraph);this._subscribe(this.translationPlaneXY._modelEvent,"PrimaryPointerClick",function(t){s.moveViewToPlane("XY")});this._subscribe(this.translationPlaneXZ._modelEvent,"PrimaryPointerClick",function(t){s.moveViewToPlane("XZ")});this._subscribe(this.translationPlaneYZ._modelEvent,"PrimaryPointerClick",function(t){s.moveViewToPlane("YZ")});this._subscribe(this.rotationArcXY._modelEvent,"PrimaryPointerClick",function(t){s.moveViewToPlane("XY")});this._subscribe(this.rotationArcXZ._modelEvent,"PrimaryPointerClick",function(t){s.moveViewToPlane("XZ")});this._subscribe(this.rotationArcYZ._modelEvent,"PrimaryPointerClick",function(t){s.moveViewToPlane("YZ")});this._subscribe(this.arrowZ._modelEvent,"PrimaryPointerClick",function(t){s.moveViewToPlane("XY")});this._subscribe(this.arrowY._modelEvent,"PrimaryPointerClick",function(t){s.moveViewToPlane("XZ")});this._subscribe(this.arrowX._modelEvent,"PrimaryPointerClick",function(t){s.moveViewToPlane("YZ")});this._subscribe(this.scalingNodeZ._modelEvent,"PrimaryPointerClick",function(t){s.moveViewToPlane("XY")});this._subscribe(this.scalingNodeY._modelEvent,"PrimaryPointerClick",function(t){s.moveViewToPlane("XZ")});this._subscribe(this.scalingNodeX._modelEvent,"PrimaryPointerClick",function(t){s.moveViewToPlane("YZ")});this.robotHandle.setCameraName("robotCameraOrtho");this.snapFilterCallback=null;this.snapTranslationCallback=null;this.snapRotationCallback=null;this.manipulationX=0;this.manipulationY=0;this._setOrthoState(true);this.setRatio(null)},setRatio:function(l){this.ratio=l||{docked:7,moving:10,connected:10};this._updateRatio()},setAddToCSO:function(l){this._addToCSO=l},setAddToHSO:function(l){this._addToHSO=l},getNodeType:function(){return"Robot"},ScreenPlaneTranslationBeginCB:function(m){this.isManipulatedInPlane=true;this.setManipulated(true);this.initialMatrix=new k.Matrix4().copy(this.getMatrix());this._updateRatio();this.setPickable(h.NODRAWHL);this.viewer.renderer.pickingGPUComposerContext.needsUpdate=true;this.viewer.renderer.depthComposerContext.needsUpdate=true;this.viewer.renderer.normalComposerContext.needsUpdate=true;var o=new k.Vector3(1,0,0);var n=new k.Vector3(0,1,0);var l=new k.Vector3(0,0,1);this.updateAxis(o,n,l);if(this.showOnlyManipulated){this.setToDragState()}this._parent(m);var p=this.getMousePosition(m.event);this.manipulationX=p.x;this.manipulationY=p.y;this._setOrthoState(true);this.onViewpointChange();this._updateLabelsAndReferenceAxisSystem()},ScreenPlaneTranslationManipulationCB:function(l){this._setOrthoState(true);var n=l.paths[0].externalPath;if(this.contains(this,n)){var m=this.getMousePosition(l.event);this.manipulationX=m.x;this.manipulationY=m.y;this.onViewpointChange();this.viewer.render();this._parent(l)}this._updateLabelsAndReferenceAxisSystem()},getMousePosition:function(l){var m=l.from[1]||l.from[0];return m.getCurrentPosition(this.viewer.canvas)},ScreenPlaneTranslationEndCB:function(s){this.isManipulatedInPlane=false;this.setManipulated(false);var l=s.intersection;var t=l.position&&l.path.length;var v=t?l.path[0]:null;if(t&&this.snapFilterCallback){v=this.snapFilterCallback(v);if(v===null||v===undefined){t=false}}if(t){this._setOrthoState(false);this.isConnected=true;this.target=v;if(this._addToHSO){d.empty();d.add({pathElement:this.target})}if(this._addToCSO){g.empty();g.add({pathElement:this.target})}var w=new k.Matrix4();if(this.snapOnFace){var n=l.normal;n.normalize();var p=new k.Vector3(1,0,0).projectOnPlane(n);var u=p.length();var o=new k.Vector3(0,1,0).projectOnPlane(n);var r=o.length();var m=new k.Vector3().crossVectors(new k.Vector3(0,0,1),n);var q=new k.Vector3(0,0,1).dot(n);if(Math.abs(q)>0.999){if(Math.abs(u-r)<0.0005){p.normalize();o.normalize()}else{if(u<r){o=new k.Vector3(0,1,0).projectOnPlane(n);o.normalize();p=new k.Vector3().crossVectors(o,n).normalize()}else{p=new k.Vector3(1,0,0).projectOnPlane(n);p.normalize();o=new k.Vector3().crossVectors(n,p).normalize()}}}else{p=m.normalize();o=new k.Vector3().crossVectors(n,p).normalize()}w=new k.Matrix4(p.x,o.x,n.x,0,p.y,o.y,n.y,0,p.z,o.z,n.z,0,0,0,0,1);w.setPosition(l.position);this.setRobotMatrix(w)}else{this.updateCenterPosition(l.position);w.setPosition(l.position);this.setMatrix(w)}}else{this._setOrthoState(true);this.target=null;this.isConnected=false;this.viewer.render()}this.setPickable(h.PICKABLE);if(this.showOnlyManipulated){this.setToNonGhostState()}this.viewer.render();this._parent(s);this._updateRatio();this.onViewpointChange();this._updateLabelsAndReferenceAxisSystem()},onViewpointChange:function(){var n=this.viewer.currentViewpoint;if(!n){return}var r;r=window.devicePixelRatio;var l;if(this._getPositionCB){l=this._getPositionCB(this.viewer.canvas.width,this.viewer.canvas.height,r)}else{l=this._getPosition_default(this.viewer.canvas.width,this.viewer.canvas.height,r)}var p=l.y;var q=l.x;function o(s,B){var w=n.robotCameraOrtho;var v=new k.Vector3(s,B,0);var A=new k.Projector();A.unprojectVector(v,w);var z;if(w instanceof k.PerspectiveCamera){var u=new k.Ray(data.cameraEye,v.sub(data.cameraEye).normalize());var t=new k.Plane(n.camera.getLookAt(),0);z=u.intersectPlane(t)}else{z=v}return new k.Matrix4().setPosition(z)}var m;if(this.isManipulatedInPlane){m=o(2*r*this.manipulationX/this.viewer.canvas.width-1,2*(1-r*this.manipulationY/this.viewer.canvas.height)-1);this.setMatrix(m)}else{if(!this.isConnected&&!this.isManipulated){m=o(q,p);this.setMatrix(m)}}this._updateLabelsAndReferenceAxisSystem()},setConnectionState:function(l){if(!this.isManipulated){if(l){this.connect()}else{this.disconnect()}this._updateLabelsAndReferenceAxisSystem();return true}else{this._updateLabelsAndReferenceAxisSystem();this._updateRatio();return false}},setCheckTarget:function(l){this.checkTarget=l},isTargetGone:function(o){if(!this.checkTarget){return false}if(this.target===null||typeof this.target==="undefined"){return true}var m=0;var q=1;var p=this.target.externalPath;for(var n=0;n<p.length;n++){var l=p[n];if(l._getVisibilityFree()){m=1}if(!l._getVisible()){q=0}}if(m){return !q}if(o===q){return false}return true},setSnapFilterCallback:function(l){this.snapFilterCallback=l},setSnapTranslationCallback:function(l){this.snapTranslationCallback=l},setSnapRotationCallback:function(l){this.snapRotationCallback=l},moveViewToPlane:function(l){if(!this.isConnected&&this.moveViewpointOnClickDuration>=0){var r=this.viewer.currentViewpoint.control;var n=new k.Matrix4();if(this._viewPlane===l){this._viewPlaneOrientation*=-1}else{this._viewPlaneOrientation=1}this._viewPlane=l;var o=this._viewPlaneOrientation>0?0:Math.PI;if(l==="XY"){n.rotateX(0+o);n.rotateZ(Math.PI/2)}else{if(l==="XZ"){n.rotateX(Math.PI/2);n.rotateY(Math.PI+o)}else{if(l==="YZ"){n.rotateY(Math.PI/2+o);n.rotateZ(Math.PI/2+o)}}}var m=n.decompose();var q=new k.Vector3(0,1,0);q.applyQuaternion(m[1]);q.normalize();var p=new k.Vector3(0,0,-1);p.applyQuaternion(m[1]);p.normalize();this.viewer.currentViewpoint.moveTo({upDirection:q,sightDirection:p,duration:this.moveViewpointOnClickDuration})}},connect:function(){this._setOrthoState(false);this.isConnected=true;this._updateRatio();this._updateLabelsAndReferenceAxisSystem()},disconnect:function(){this._setOrthoState(true);this.isConnected=false;this._updateRatio();this.onViewpointChange();this.viewer.render();this.target=null;this._updateLabelsAndReferenceAxisSystem()},setToDragState:function(){this.arrowX.setToDragState();this.arrowY.setToDragState();this.translationPlaneYZ.setToGhostState();this.translationPlaneXZ.setToGhostState();this.translationPlaneXY.setToDragState();this.scalingNodeY.setToGhostState();this.scalingNodeX.setToGhostState();this.scalingNodeZ.setToGhostState();this.rotationArcYZ.setToGhostState();this.rotationArcXZ.setToGhostState();this.rotationArcXY.setToGhostState()},setVisibility:function(l){this.setHiddenMode(!l);this._parent(l)},setHiddenMode:function(l){this.hiddenMode=l;this._updateLabelsAndReferenceAxisSystem()},_setOrthoState:function(l){if(l){this.setRenderPasses(["robotOrtho"]);this._setCameraName("robotCameraOrtho")}else{this.setRenderPasses(["robot"]);this._setCameraName("connectedRobotCamera")}},setDrivenConnectionMode:function(){this.setDrivenMode.apply(this,arguments)},setDrivenMode:function(){this.setConnectionState.apply(this,arguments)},_setCameraName:function(l){this.fixedSizeNode3D.setCameraName(l)},_updateLabelsAndReferenceAxisSystem:function(){var n=this;function m(p){var o=p&&n._enabled;if(n.fixedSizeNode3D._getVisible()!==o){n.fixedSizeNode3D.setVisibility(o)}}function l(p){var o=p&&n._enabled;n.viewer._modelEvent.publish({event:"UpdateReferenceAxisSystemVisibility",data:{visible:p}})}if(this.hiddenMode){m(false);l(true)}else{if(this.isManipulated){m(true);l(true);this.setLabels(null)}else{if(this.isConnected){if(this._showLabels){this._setLocalLabels()}else{this.setLabels(null)}m(true);l(true)}else{if(this._showLabels){this.setLabels({labelX:"x",labelY:"y",labelZ:"z"})}else{this.setLabels(null)}m(true);l(false)}}}},_setLocalLabels:function(){var l=this.getMatrix();l.extractBasis(a.x,a.y,a.z);function m(o,p){o.normalize();var q=null;var n=0.9995;if(o.x>n){q="x"}else{if(o.y>n){q="y"}else{if(o.z>n){q="z"}}}if(q){return p+"|"+q}else{return p}}this.setLabels({labelX:m(a.x,"u"),labelY:m(a.y,"v"),labelZ:m(a.z,"w")})},setMatrix:function(){this._parent.apply(this,arguments);this._updateLabelsAndReferenceAxisSystem()},setManipulated:function(m){var l=m!==this.isManipulated;this._parent.apply(this,arguments);if(l){this._updateLabelsAndReferenceAxisSystem()}},showLabels:function(l){this._showLabels=l;this._updateLabelsAndReferenceAxisSystem()},setMoveViewpointOnClickDuration:function(l){this.moveViewpointOnClickDuration=l},setGetPositionCB:function(l){this._getPositionCB=l;this.onViewpointChange()},_setEnabled:function(l){var m=l?true:false;if(this._enabled!==m){this._enabled=m;this.onViewpointChange()}},_isEnabled:function(){return this._enabled},_updateRatio:function(){if(this.isManipulatedInPlane){this.fixedSizeNode3D.setRatio((this.ratio.moving||this.ratio.ratio))}else{if(this.isConnected){this.fixedSizeNode3D.setRatio((this.ratio.connected||this.ratio.ratio))}else{this.fixedSizeNode3D.setRatio((this.ratio.docked||this.ratio.ratio))}}},_dispose:function(){this._getPositionCB=null;this._parent()},_getPosition_default:function(n,l,o){var m,o;m=this.fixedSizeNode3D.ratio/7;return{x:2*(n-o*100*m)/n-1,y:Math.max(2*100*o*m/l-1,-0.85)}},CallBackEventHandlerViewPoint:function(){this.onViewpointChange.apply(this,arguments)}});return UWA.namespace("THREEDS/Nodes/Robot",j)});define("Robot/Robot",["DS/Robot/Robot","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Robot/Robot");return b});define("DS/Visualization/CGRNode",["UWA/Class","DS/Visualization/SceneGraphUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/PathElement"],function(a,b,j,g,e,c,d){var h=function(o,r,p){var n,k=o.children?o.children.length:0,m=o.primitives?o.primitives.length:0,q;q=r(o,p);if(!q.stop){for(n=0;n<k;n++){h(o.children[n],r,q)}for(n=0;n<m;n++){q=r(o.primitives[n],q)}}else{q.stop=false}};var f=g.extend({init:function(l,k){this._parent(k);this.internalSceneGraph=l;return this},setInternalSceneGraph:function(k){this.internalSceneGraph=k},setHighlight:function(s){var m=0,k=0,o=false;var q=this._getPrimitives(s);for(m in q){o=true;var p=WUX.Selection.HSOManager;var u=q[m].mesh;var n=u._occurrence;var t=new d();var r=q[m].primitives;for(k=0;k<r.length;k++){var t=new d();t.setFromOccurrence(n,r[k]);var l={pathElement:t};var u=l.pathElement.getLastElement(true);if(!u._excludeFromHL){p.add(l)}}}return o},removeHighlight:function(v){var o=0,m=0,q=false;var t=this._getPrimitives(v);for(o in t){q=true;var r=WUX.Selection.HSOManager;var x=t[o].mesh;var p=x._occurrence;var u=t[o].primitives;for(m=0;m<u.length;m++){var w=new d();w.setFromOccurrence(p,u[m]);var n={pathElement:w};var s=false;var k=r.get();for(var o=0;o<k.length;o++){var l=k[o];var w=l.pathElement;if(!w&&l.options){w=l.options.pathElement}if(w&&w.isEqual(n.pathElement)){r.remove(l);s=true;break}}}}return q},show:function(m){var l=0,o=false;var q=this._getPrimitives(m);for(l in q){o=true;var p=q[l].mesh;var k=p._occurrence.node;var n=q[l].primitives;k.show(n)}return o},hide:function(m){var l=0,o=false;var q=this._getPrimitives(m);for(l in q){o=true;var p=q[l].mesh;var k=p._occurrence.node;var n=q[l].primitives;k.hide(n)}return o},getPathElement:function(v,l){var q=0,p=0,s=[];var t=this._getPrimitivesNew(v);for(q in t){var x=t[q].mesh;var r=x._occurrence;var n=r.node;var u=[];while(n.id!==this.id&&n.parents&&n.parents[0]){u.unshift(n);n=n.parents[0]}if(l&&l.externalPath){u=l.externalPath.concat(u)}var m=t[q].reps;for(p=0;p<m.length;p++){var o=[m[p]];var n=m[p];if(m[p].getType()=="primitive"){n=THREEDS.SubElement.getFromSGNode(m[p].sgNode.rep);o.unshift(n)}while(n&&n.sgNode&&n.sgNode.parent){var k=THREEDS.SubElement.getFromSGNode(n.sgNode.parent);o.unshift(k);n=k}var w=new d();w.setFromArray(u,o);s.push(w)}}return s},_getPrimitives:function(o){var n={};if(!(o instanceof Array)){return n}var m=function(t,s){var q,r=t.length;for(q=0;q<r;q++){if(t[q].id==s){return true}}return false};var l=function(s,u){if(s.type==3){var q=new c(s);var t=s.group;if(t&&t.geometry){var v=t.geometry.meshList[0];var r=v.id;if(u.res[r]){if(!m(u.res[r].primitives,q.id)){u.res[r].primitives.push(q)}}else{u.res[r]={mesh:v,primitives:[q]}}}}return u};var p=function(r,s){var q=function(t,u){if(t.cgmId==u.path[u.index]){u.index++;if(u.path.length==u.index){u.res.push(t);u.stop=true;return u}return u}u.stop=true;return u};h(r,q,s)};var k=function(r,t){var x,w,u,y,s=r.children?r.children.length:0,v=t.idArray.length;for(x=0;x<v;x++){if(r.cgmId==t.idArray[x][0]){var q=[];p(r,{path:t.idArray[x],index:0,res:q,stop:false});if(q.length){h(q[0],l,t)}}}return t};h(this.internalSceneGraph,k,{idArray:o,res:n,stop:false});return n},_getPrimitivesNew:function(o){var n={};if(!(o instanceof Array)){return n}var m=function(t,s){var q,r=t.length;for(q=0;q<r;q++){if(t[q].id==s){return true}}return false};var l=function(r,u){if(r.type==2){u.stop=true;if(r.primitives&&r.primitives.length){var t=r.primitives[0].group;var s=THREEDS.SubElement.getFromSGNode(r);if(t&&t.geometry){var v=t.geometry.meshList[0];var q=v.id;if(u.res[q]){if(!m(u.res[q].reps,s.id)){u.res[q].reps.push(s)}}else{u.res[q]={mesh:v,reps:[s]}}}}}return u};var p=function(r,s){var q=function(t,u){if(t.cgmId==u.path[u.index]){u.index++;if(u.path.length==u.index){u.res.push(t);u.stop=true;return u}return u}u.stop=true;return u};h(r,q,s)};var k=function(t,v){var z,y,w,C,u=t.children?t.children.length:0,x=v.idArray.length;for(z=0;z<x;z++){if(t.cgmId==v.idArray[z][0]){var q=[];p(t,{path:v.idArray[z],index:0,res:q,stop:false});if(q.length){if(q[0].type==3){var A=THREEDS.SubElement.getFromSGNode(q[0]);var s=q[0].group;if(s&&s.geometry){var B=s.geometry.meshList[0];var r=B.id;if(v.res[r]){if(!m(v.res[r].reps,A.id)){v.res[r].reps.push(A)}}else{v.res[r]={mesh:B,reps:[A]}}}}else{h(q[0],l,v)}}}}return v};h(this.internalSceneGraph,k,{idArray:o,res:n,stop:false});return n}});return UWA.namespace("THREEDS/Nodes/CGRNode",f)});define("Visualization/CGRNode",["DS/Visualization/CGRNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/CGRNode");return b});define("DS/Visualization/LoaderUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/CGRNode","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Mesh/Mesh","DS/SceneGraphNodes/AxisSystemNode","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/FixedSizePlaneNode","DS/Visualization/SceneGraphFactory"],function(l,g,h,m,p,f,k,e,n,d,j){var a=function(x,r){var t=r.materialLibrary;var v=r.baseUrl;var w=new p();var q=t[x];if(q===undefined){return null}var s=t[q.instance];if(s===undefined){return null}var u=t[s.instance];if(u===undefined){return null}if((u.material===undefined)&&(u.params!==undefined)){u.material=w.getMaterial3DXML(u.params,v,"XMLV43");u.material.force=true}else{if(u.params===undefined){u.material=new l.MeshLambertMaterial();u.material.force=true}}return u.material};var o=function(u,D,y,w,s){var t=5;var H=u.length/t;var G=new Array(H);var r=[];var B=-1;var q=null;var v=0;var x=0;var A=0;var z=null;var C=null;var E=0;for(var F=0;F<H;F++){B=u[E++]-1;q=D[u[E++]];v=u[E++];x=u[E++];A=u[E++];C=new f.SGPrimitive({cgmId:B,rep:q,start:v,count:x,decoration:A,group:y});G[F]=C;q.primitives.push(C)}if(w&&w.noShowPrim&&w.noShowPrim.length){for(var F=0;F<w.noShowPrim.length;F++){r.push(G[w.noShowPrim[F]])}}return{primitives:G,noShowPrim:r}};var b=function(y,N,x,q,r,B,K){var L,v=null,Y,Q=false,z=false,H=null,w=[],O=null,G=null,S=new l.Sphere(),C=new l.Box3(),T=[];var s=K.sgRep;var u=K.decorations;var E=new p();for(var X=0;X<y.length;X++){var P=y[X];var D=K.noMeshInRAM;var J=new l.BufferGeometryDS();var ab=new l.Vector3(P.AABB.min[0],P.AABB.min[1],P.AABB.min[2]);var I=new l.Vector3(P.AABB.max[0],P.AABB.max[1],P.AABB.max[2]);J.boundingBox=new l.Box3(ab,I);J.boundingSphere=J.boundingBox.getBoundingSphere();if(O===null){O=ab}if(G===null){G=I}if(ab.x<O.x){O.x=ab.x}if(ab.y<O.y){O.y=ab.y}if(ab.z<O.z){O.z=ab.z}if(I.x>G.x){G.x=I.x}if(I.y>G.y){G.y=I.y}if(I.z>G.z){G.z=I.z}C.set(O,G);S.radius=G.clone().sub(O).multiplyScalar(0.5).length();S.center=G.clone().add(O).multiplyScalar(0.5);for(var W=0;W<P.drawingGroups.length;W++){v=P.drawingGroups[W];P.drawingGroups[W]=new f.DrawingGroup(v.gas,v.material,v.glType,v.start,v.count,v.primitives,null,v._geomType,v.gasIndex);P.drawingGroups[W].cullingData=v.cullingData;if(K.fromCGR){var A=o(v.primitives,s,P.drawingGroups[W],v,K);P.drawingGroups[W].primitives=A.primitives;T=T.concat(A.noShowPrim)}else{v=P.drawingGroups[W];Y=v.primitives;for(var V=0;V<Y.length;V++){Y[V].group=v}}v=P.drawingGroups[W];v.geometry=J;var t=v.gas;var U=v.material;v.gas=null;v.material=null;if((U!==null)&&(U.file!=="")){v.material=a(U.id,B)}else{if((U!==null)&&(U.id!==-1)&&((v.glType===4)||(t.forceMaterial))){if(r[U.id]){L=r[U.id]}else{if(U.shading){x[U.id].shading=U.shading}L=E.getMaterialCgr(x[U.id],undefined,"CGR",q);r[U.id]=L;if(typeof L.needTangentBinormal!=="undefined"){if(!L.needTangentBinormal||!P.vertexTangentArray||!P.vertexBinormalArray){L.needTangentBinormal=false}}}v.material=L}}if(t!==null){var M=new l.Color();M.setRGB(t.color.r,t.color.g,t.color.b);if(t.lineWidth&&K&&!K.edgeTransparency){t.opacity=1}if((t.pattern>1)||(t.lineWidth>1)){D=false}v.gas=E.getMaterialFromGAS({color:M,opacity:t.opacity,pattern:t.pattern,lineWidth:t.lineWidth,forceLineWidth:t.forceLineWidth,solid:t.solid,symbol:t.symbol,basic:t.basic,resource:q})}}J.drawingGroups=P.drawingGroups;J.decorations=u;J.vertexPositionArray=P.vertexPositionArray;if(P.vertexNormalArray!==null){J.vertexNormalArray=P.vertexNormalArray}if(P.vertexUvArray!==null){J.vertexUvArray=P.vertexUvArray}if(P.vertexTangentArray!==null){J.vertexTangentArray=P.vertexTangentArray}if(P.vertexBinormalArray!==null){J.vertexBinormalArray=P.vertexBinormalArray}J.vertexIndexArray=P.vertexIndexArray;if(K&&K.sharedBuffers){J.sharedBuffers=true}J.noMeshInRAM=D;w.push(J)}var ac=new l.Color();ac.setRGB(y[0].gas.fill.color.r,y[0].gas.fill.color.g,y[0].gas.fill.color.b);var Z=new l.Color();Z.setRGB(y[0].gas.line.color.r,y[0].gas.line.color.g,y[0].gas.line.color.b);var U=E.getMaterialFromGAS({color:ac,opacity:y[0].gas.fill.opacity,solid:y[0].gas.fill.solid,basic:y[0].gas.fill.basic,resource:q});U.line=E.getMaterialFromGAS({color:Z,opacity:y[0].gas.line.opacity,lineWidth:y[0].gas.line.lineWidth});w.boundingSphere=S;w.boundingBox=C;H=new l.Mesh(w,U);H.fromLoadedModel=true;for(var X=0;X<w.length;X++){var R=f.unindexPoints(w[X]);if(R){w[X].sharedBuffers=false}}H.matrixAutoUpdate=false;H.castShadow=true;H.receiveShadow=true;var F=new m(H);if(T.length){F.hide(T)}return F};var c={__storeCGRNames:1,createEmptyMesh:function(){var r=new l.BufferGeometryDS();r.boundingSphere=new l.Sphere(new l.Vector3(),0);r.boundingBox=new l.Box3();var q=new l.MeshPhongMaterial();var s=new l.Mesh(r,q);s.matrixAutoUpdate=false;s.castShadow=true;s.receiveShadow=true;return new m(s)},processData:function(ar,aq,L,X,V){var aj=function(aA,aL){var aD,aH,aG,aF,aB,r,ay;aD=aA.view32UInt[aA.offset++];aH=aA.view8UInt[aA.offset*4];switch(aH){case 1:aG=aA.view8UInt[aA.offset*4+1];aA.offset++;aF=aA.view32UInt[aA.offset++];ay=new f.SGBag({cgmId:aD,solid:aG,parent:aL});for(aB=0;aB<aF;aB++){r=aj(aA,ay);ay.children.push(r)}break;case 2:aG=aA.view8UInt[aA.offset*4+1];aA.offset++;aF=aA.view32UInt[aA.offset++];ay=new f.SGRep({cgmId:aD,solid:aG,parent:aL});for(aB=0;aB<aF;aB++){aD=aA.view32UInt[aA.offset++];aH=aA.view8UInt[aA.offset*4];var aE,ax,aI,az,aK,aJ,aC,aw;aw=aA.view8UInt[aA.offset*4+1];aC=aA.view8UInt[aA.offset*4+2];aA.offset++;aE=aA.view32UInt[aA.offset++];ax=aA.view32UInt[aA.offset++];if(aC){aK=[];for(aB=0;aB<aC+1;aB++){aK.push(aA.view8UInt[aA.offset*4+aB])}aA.offset+=((aC+1)/4>>0)+1}if(aw){aJ={center:[],radius:0};aJ.center[0]=aA.view32F[aA.offset++];aJ.center[1]=aA.view32F[aA.offset++];aJ.center[2]=aA.view32F[aA.offset++];aJ.radius=aA.view32F[aA.offset++]}}break;case 3:var aE,ax,aI,az,aK,aJ,aC,aw;aw=aA.view8UInt[aA.offset*4+1];aC=aA.view8UInt[aA.offset*4+2];aA.offset++;aE=aA.view32UInt[aA.offset++];ax=aA.view32UInt[aA.offset++];az=aA.view32UInt[aA.offset++];if(az==aA.groupArray.length){aI={group:az,primitives:[]};aA.groupArray[az]=aI}else{aI=aA.groupArray[az]}if(aC){aK=[];for(aB=0;aB<aC+1;aB++){aK.push(aA.view8UInt[aA.offset*4+aB])}aA.offset+=((aC+1)/4>>0)+1}if(aw){aJ={center:[],radius:0};aJ.center[0]=aA.view32F[aA.offset++];aJ.center[1]=aA.view32F[aA.offset++];aJ.center[2]=aA.view32F[aA.offset++];aJ.radius=aA.view32F[aA.offset++]}break}return};var t=function(ay){var ax=ay.length;for(var aw=0;aw<ay.length;aw++){var aA=ay[aw].img;var az=ay[aw].format;if(az==2){for(var r=0;r<aA.length;r+=3){if(aA[r]==255&&aA[r+1]==255&&aA[r+2]==255){aA[r]=0;aA[r+1]=0;aA[r+2]=0}}}if(az==3){for(var r=0;r<aA.length;r+=4){if((aA[r]==255&&aA[r+1]==255&&aA[r+2]==255)){aA[r]=0;aA[r+1]=0;aA[r+2]=0}}}}};var D=function(aA,aw){if(!aA){return[]}var az=3;if(aw.withSAG){az+=1}if(aw.primitiveWithBS){az+=4}var ay=aA.length/az;var aB=new Array(ay);var r=0;if(aw.withSAG){if(aw.primitiveWithBS){for(var ax=0;ax<ay;ax++){aB[ax]=new f.SGRep({cgmId:aA[r++]-1,solid:aA[r++],namingContext:aA[r++],sag:aA[r++],boundingSphere:{radius:aA[r++],center:[aA[r++],aA[r++],aA[r++]]}})}}else{for(var ax=0;ax<ay;ax++){aB[ax]=new f.SGRep({cgmId:aA[r++]-1,solid:aA[r++],namingContext:aA[r++],sag:aA[r++]})}}}else{if(aw.primitiveWithBS){for(var ax=0;ax<ay;ax++){aB[ax]=new f.SGRep({cgmId:aA[r++]-1,solid:aA[r++],namingContext:aA[r++],boundingSphere:{radius:aA[r++],center:[aA[r++],aA[r++],aA[r++]]}})}}else{for(var ax=0;ax<ay;ax++){aB[ax]=new f.SGRep({cgmId:aA[r++]-1,solid:aA[r++],namingContext:aA[r++]})}}}return aB};var ai=function(ay,aA){if(!ay||!aA){return}var aw=ay.children;var az=null;var r=aw.length;for(var ax=0;ax<r;ax++){if(aw[ax].children){ai(aw[ax],aA)}else{if(!az){az=[]}if(aw[ax].parent){}else{aA[aw[ax]].parent=ay;az.push(aA[aw[ax]])}}}if(az){ay.children=az}};var Z=function(aA){var r=[];for(var ay=0;ay<aA.length;){var az=aA[ay]+1;var ax=new Uint8Array(az);for(var aw=0;aw<az;aw++){ax[aw]=aA[ay++]}r.push(ax)}return r};var A=function(){this.children=[]};A.prototype.addChild=function(r){this.children.push(r)};var M=null,J=null,U=null,ae=[],w=[],O=[],v;if(!V){V={}}if(V&&V.textureInBlack&&aq){t(aq.resource)}if(X){v=new g(aq.sceneGraph)}else{v=new A()}var P=new p();P.cleanResources();var I=true;if(aq.rep){if(aq.rep.length>0){M=b(aq.rep,ae,aq.material,aq.resource,w,L,V)}if(M){v.addChild(M);I=false}}else{V.fromCGR=true;var C=D(aq.sgRep,V);if(X){ai(aq.sceneGraph,C)}V.sgRep=C;V.decorations=aq.decorations;for(var ap=0;ap<aq.reps.length;ap++){if(!aq.reps[ap].length){continue}if(ap&1){M=new h();M.name=aq.node+"_parallelToScreen";for(var ao=0;ao<aq.reps[ap].length;++ao){var ac=b(aq.reps[ap][ao].tab,ae,aq.material,aq.resource,w,L,V);var ab=aq.reps[ap][ao].globalMatrix;var q={type:"Spherical",};var al=new e(q);al.addChild(ac);al.setMatrix(new l.Matrix4().setFromArray(ab.elements));M.addChild(al)}if(M.children.length==0){M=null}}else{M=b(aq.reps[ap],ae,aq.material,aq.resource,w,L,V);if(this.__storeCGRNames===1){M.name=aq.node}}if(ap&2){M.setExcludeFromBounding(true)}if(ap&4){M.setNoZ(true)}if(M){O.push(M);v.addChild(M);I=false}}}if(V.processText&&aq.texts&&aq.texts.length>0){for(var ap=0;ap<aq.texts.length;++ap){var ad=aq.texts[ap];var Y=new l.Color(ad.color.r*255,ad.color.g*255,ad.color.b*255);var at=j.createTextNode({bbox:ad.bbox,text:ad.text,font:ad.fontName,color:Y,stroke:ad.stroke,fontSize:ad.bbox[3]-ad.bbox[2],textAlign:ad.horJustif,resolutionCoef:128,path:ad.path});if(ad.matrix){at.setMatrix(new l.Matrix4().setFromArray(ad.matrix.elements))}O.push(at);v.addChild(at);I=false}}if(aq.refPlanes&&aq.refPlanes.length>0){var an=new h();U=new h("RefPlanes");U.setNoZ(true);U.setVisibility(false);U.setVisibilityInTree(false);var y=0.264583333;for(var ap=0;ap<aq.refPlanes.length;++ap){for(var ao=0;ao<aq.refPlanes[ap].length;ao++){var s=aq.refPlanes[ap][ao];var av=null;var K=s.length*0.7071068*window.devicePixelRatio/y;var am=new l.Vector3(s.origin[0],s.origin[1],s.origin[2]);var Y=new f.Color(s.color[0],s.color[1],s.color[2],s.color[3]);if(s.zoomable){av=j.createRectangleNode({color:Y,width:K,height:K,fill:false});av.setShadow(false);av.setFrustumCulled(false);var af=new l.Vector3(-K/2,-K/2,0);var z=new l.Matrix4().setPosition(af);av.setMatrix(z)}else{var q={sgRep:C[s.rep],origin:am,direction2:new l.Vector3(s.xAxis[0]+s.yAxis[0],s.xAxis[1]+s.yAxis[1],s.xAxis[2]+s.yAxis[2]),direction1:new l.Vector3(s.xAxis[0]-s.yAxis[0],s.xAxis[1]-s.yAxis[1],s.xAxis[2]-s.yAxis[2]),sceneGraph:an,color:Y,length:K,name:"ref Plane "+ap,};av=new d(q)}U.addChild(av)}}}if(U){U._forceGeomType("INFINITE_FACE");O.push(U);v.addChild(U);I=false}if(aq.axisSystems&&aq.axisSystems.length>0){var an=new h();J=new h("AxisSystems");J.setVisibility(false);J.setVisibilityFree(true);J.setVisibilityInTree(false);var y=0.264583333;for(var ap=0;ap<aq.axisSystems.length;++ap){var B=aq.axisSystems[ap];var u=null;var S=B.zoomable||false;var q={sgRep:C[B.rep],headLength:10,arrowLength:S?B.length:50,arrowWidth:2,sceneGraph:an,colors:{colorX:new f.Color(B.color[0]/255,B.color[1]/255,B.color[2]/255,0),colorY:new f.Color(B.color[0]/255,B.color[1]/255,B.color[2]/255,0),colorZ:new f.Color(B.color[0]/255,B.color[1]/255,B.color[2]/255,0),},name:"axis System 1",head:k.types.ARROW,zoomable:S};u=new k(q);var H=new l.Matrix4();var x=[];x[0]=B.xAxis[0];x[1]=B.xAxis[1];x[2]=B.xAxis[2];x[3]=0;x[4]=B.yAxis[0];x[5]=B.yAxis[1];x[6]=B.yAxis[2];x[7]=0;x[8]=B.zAxis[0];x[9]=B.zAxis[1];x[10]=B.zAxis[2];x[11]=0;x[12]=B.origin[0];x[13]=B.origin[1];x[14]=B.origin[2];x[15]=1;H.setFromArray(x);u.setMatrix(H);J.addChild(u);if(B.refPlanes!==undefined){var G=null;if(S){G=new h();var F=null;for(var ak=0;ak<B.refPlanes.length;ak++){var Y=new f.Color(B.color[0]/255,B.color[1]/255,B.color[2]/255,B.color[3]/255);F=B.refPlanes[ak];var R=new l.Vector3(F[0],F[1],F[2]);var Q=new l.Vector3(F[3],F[4],F[5]);var N=new l.Vector3(F[6],F[7],F[8]);var ah=[R,Q,N];var av=j.createLineNode({points:ah,color:Y});av.setShadow(false);av.setFrustumCulled(false);G.addChild(av)}}else{G=new h("fixedSizeHalfPlanes");var au=new l.Matrix4().getInverse(H);var ag=[B.xAxis,B.yAxis,B.zAxis];for(var ak=0;ak<B.refPlanes.length&&B.refPlanes[ak].mode===1;ak++){var K=B.refPlanes[ak].length*window.devicePixelRatio/y;var Y=new f.Color(B.color[0]/255,B.color[1]/255,B.color[2]/255,B.color[3]/255);var T=B.refPlanes[ak].direction1;var E=B.refPlanes[ak].direction2;var Q=new l.Vector3(0.5*K*T[0],0.5*K*T[1],0.5*K*T[2]);var R=new l.Vector3(Q.x+0.5*0.5*K*(T[0]+E[0]),Q.y+0.5*0.5*K*(T[1]+E[1]),Q.z+0.5*0.5*K*(T[2]+E[2]));var N=new l.Vector3(Q.x+0.5*0.5*K*(T[0]-E[0]),Q.y+0.5*0.5*K*(T[1]-E[1]),Q.z+0.5*0.5*K*(T[2]-E[2]));var ah=[R,Q,N];var av=j.createLineNode({points:ah,color:Y});av.setShadow(false);av.setFrustumCulled(false);G.addChild(av)}var W=new l.Matrix4().multiplyMatrices(au,new l.Matrix4().setPosition(new l.Vector3(B.origin[0],B.origin[1],B.origin[2])));G.setMatrix(W);G._setRatio(1)}G.setNoZ(true);u.addChild(G)}}}if(J){J._forceGeomType("AXIS_SYSTEM");O.push(J);v.addChild(J);I=false}if(ar&&!V.unlinkToSG){if(X){for(var ap=0;ap<ar.length;ap++){if(ar[ap]){if(I){M=c.createEmptyMesh();M.name=aq.node;ar[ap].addChild(M)}else{ar[ap].addChild(v);O=[v]}if(aq.sceneGraph&&aq.sceneGraph.noShow){v.setVisibility(false)}}}}else{for(var ap=0;ap<ar.length;ap++){if(ar[ap]){if(I){M=c.createEmptyMesh();M.name=aq.node;ar[ap].addChild(M)}else{for(var ao=0;ao<v.children.length;ao++){ar[ap].addChild(v.children[ao])}}}}}}return O}};return c});define("DS/VisuDataAccess/Ox4MQLV6Loader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","UWA/Utils","DS/Visualization/Utils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/VisuDataAccess/Ox4DOSRunner","DS/VisuDataAccess/Ox4DECRunner","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/VisuDataAccess/Ox4TypeHelper","DS/WAFData/WAFData","DS/Visualization/LoaderUtils","DS/VisuDataAccess/Ox4TreeTarget"],function(l,d,h,a,f,n,r,b,e,m,g,k,c,q){var o=function(t){var s=document.getElementsByTagName("script");for(var v=0;v<s.length;v++){var u=s.item(v);var w=u.getAttribute("src");if(w&&w.match(t)){return w.substring(0,w.lastIndexOf("/")+1)}}return"scripts/ThreeDS/Visualization/"};var j="scripts/ThreeDS/Visualization/";var p=function(L,A,G,u){var z=L;var H=(typeof G=="undefined")?false:G;var ad=(A!==undefined)?A:null;var ae=null;var ag=null;var Z=null;var w;var F=null;var s=false;var B=0;var X=0;var P=0;var ab=[];var C=[];var Y=[];var y=[];var R=[];var W=[];var ai=[];var V=[];var U={};var J;var O=null;var D=[];var N;var v=null;var af=u;this.setGeometryMode=function(ak){af=ak};function M(){if(F!=null){F.terminate();F=null;s=false}ae=null;ag=null;Z=null;w="";B=0;X=0;P=0;ab=[];C=[];Y=[];y=[];R=[];W=[];ai=[];V=[];J="";O=null;D=[];N=null;v=null;U={}}this.load=function(ao,aq,am,al,ap,at){U=at?at:{};v={value:false};ae=aq;Z=am;ag=function(){M();if(al){al()}};console.log("Ox4 Version V");console.log("Ox4 ObjectDisplaySpecification");console.log(ao.physicalid);console.log(ao.dtype);var ak=function(au){if(au==="Node"){var av=new f();av.isPLMInstance=q.isPLMInstance;av.isPLMReference=q.isPLMReference;av.isPLMRepReference=q.isPLMRepReference;return av}if(au==="Matrix"){return new l.Matrix4()}};if(ao.dtype==null){ao.dtype="VPMReference"}var an=ao.dtype;var ar=null;g.InitWithUrl(ao.serverurl,ao.tenant,ao.requiredAuth,ao.proxyurl);Q(an,function(aw){if(aw){ar=new b(ao,ak)}else{if(I(an)){ar=new e(ao,ak)}else{ap({type:"LOAD",url:"type "+an})}}if(ar==null){return}var av=null;var au=ap;var ax=v;var ay=function(aA){if(!ax.value){console.log("success........");N=aA.rootNode;var az=aA.geometryNodes;P=az.length;B=P;X=P;for(var aC=0;aC<az.length;aC++){var aB=az[aC].ticketRequest.generateRequest();C[aB.data]=az[aC];y.push(aB)}if(!window.hasOwnProperty("ODTNoFCSCalls")||!window.ODTNoFCSCalls){T(ax)}else{if(ae){ae(N)}if(ag){ag()}}console.log("Ox4 Plan runned")}};ar.run(av,ay,au)})};this.abort=function(){if(v!==null){v.value=true;M()}};function Q(ak,al){g.IsBusA(ak,"VPMReference",function(am){if(!am){g.IsBusA(ak,"VPMRepReference",al)}else{al(true)}})}function I(ak){if(ak==="SW Assembly Family"){return true}if(ak==="SW Component Family"){return true}if(ak==="SW Assembly Instance"){return true}if(ak==="SW Component Instance"){return true}if(ak==="CATPart"){return true}if(ak==="CATProduct"){return true}if(g.IsBusA(ak,"MCAD Model")){console.log("Ox4MQLV6Loader: Either customized or other than considered DEC Type provided : "+ak);return true}return false}function x(ak){af=ak}function T(ap){if(F===null){var an=!h.matchUrl(d.getWebappsBaseUrl(),window.location)?"Passport":null;var al={provider:"FILE",filename:"AmdLoader.js",serverurl:d.getWebappsBaseUrl()+"AmdLoader/",requiredAuth:an};var ar={provider:"FILE",filename:"ThreeJS_Base.js",serverurl:d.getWebappsBaseUrl()+"Mesh/",requiredAuth:an};var am={provider:"FILE",filename:"Mesh.js",serverurl:d.getWebappsBaseUrl()+"Mesh/",requiredAuth:an};var aq={provider:"FILE",filename:"CGRFile.js",serverurl:d.getWebappsBaseUrl()+"Formats/",requiredAuth:an};var ak={provider:"FILE",filename:"CGRWorkerNewInfra.js",serverurl:d.getWebappsBaseUrl()+"Workers/",requiredAuth:an};var ao=[al,ar,am,aq,ak];a.getWorkerFromSpecs(ao,function(at){if(ap.value){at.terminate()}else{F=at;F.onmessage=function(aw){var av=aw.data;if(av.loaded){if(!s){s=true;K(ap)}}else{var au=C[av.node.data];B--;X--;if(au){c.processData([au],av,undefined,U.withSceneGraph,U)}if(Z!==null){Z({loaded:P-X,total:P})}if(ad!==null){ad({hack:true,updateInfinitePlane:true})}if(!X&&(ag!==null)){ag()}}}}})}else{if(s){K(ap)}}}function ah(ak,ao,ap,aq){if(ak.slice(0,8)=="posthttp"){var al=ak.indexOf(":postparams:");var ar=ak.slice(9,al);var am=ak.slice(al+12,ak.length);var at={cors:true,timeout:100000,method:"POST",data:am,type:"arraybuffer",async:true,headers:{Accept:"text/plain",},onComplete:ao,onFailure:ap};var an=k.authenticatedRequest(ar,at)}}function K(ao){B+=y.length;var ap=new m();var ak=0;var an=function(){var aq=y[ak++];if(aq!==undefined){ap.asyncTransformFCSUrlIntoRealUrl(aq,false,function(ar,at){if(!ao.value){if(ar!==""){(function(au){ah(at,function(av){if(!ao.value){F.postMessage({inputFile:av,node:au,withSceneGraph:U.withSceneGraph?U.withSceneGraph:false},[av]);an()}})})(ar)}}})}};if(!window.hasOwnProperty("ODTNoFCSCalls")&&Z!==null){Z({loaded:0,total:y.length})}var am=y.length>8?8:y.length;for(var al=0;al<am;al++){an()}if(ae){ae(N)}if(y.length===0){ag()}}function ac(ak,al){if(ak.color==null||al.color==null){return false}if((ak.color.r!=al.color.r)||(ak.color.g!=al.color.g)||(ak.color.b!=al.color.b)){return false}if(ak.thickness&&al.thickness&&(ak.thickness!=al.thickness)){return false}if(ak.opacity!=al.opacity){return false}return true}function S(ao){var al=aj(ao);var an=[];for(var am=0,ak=al.length;am<ak;am++){an.push(parseFloat(al[am]))}return an}function aj(ak){return(ak.length>0)?E(ak).split(/\s+/):[]}function E(ak){return ak.replace(/^\s+/,"").replace(/\s+$/,"")}function t(ak){var an=new l.BufferGeometryDS();var ao=new Float32Array(72);var av=new Float32Array(72);var am=new Uint16Array(36);var aA=0;var ay=0;var ax=0;for(var aB=0;aB<6;aB++){am[ay++]=ax;am[ay++]=ax+1;am[ay++]=ax+2;am[ay++]=ax;am[ay++]=ax+2;am[ay++]=ax+3;ax+=4}for(var ar=0;ar<12;ar+=3){av[aA+ar]=0;av[aA+ar+1]=-1;av[aA+ar+2]=0}ao[aA++]=ak.min[0];ao[aA++]=ak.min[1];ao[aA++]=ak.min[2];ao[aA++]=ak.max[0];ao[aA++]=ak.min[1];ao[aA++]=ak.min[2];ao[aA++]=ak.max[0];ao[aA++]=ak.min[1];ao[aA++]=ak.max[2];ao[aA++]=ak.min[0];ao[aA++]=ak.min[1];ao[aA++]=ak.max[2];for(var ar=0;ar<12;ar+=3){av[aA+ar]=0;av[aA+ar+1]=1;av[aA+ar+2]=0}ao[aA++]=ak.min[0];ao[aA++]=ak.max[1];ao[aA++]=ak.min[2];ao[aA++]=ak.min[0];ao[aA++]=ak.max[1];ao[aA++]=ak.max[2];ao[aA++]=ak.max[0];ao[aA++]=ak.max[1];ao[aA++]=ak.max[2];ao[aA++]=ak.max[0];ao[aA++]=ak.max[1];ao[aA++]=ak.min[2];for(var ar=0;ar<12;ar+=3){av[aA+ar]=0;av[aA+ar+1]=0;av[aA+ar+2]=1}ao[aA++]=ak.max[0];ao[aA++]=ak.max[1];ao[aA++]=ak.max[2];ao[aA++]=ak.min[0];ao[aA++]=ak.max[1];ao[aA++]=ak.max[2];ao[aA++]=ak.min[0];ao[aA++]=ak.min[1];ao[aA++]=ak.max[2];ao[aA++]=ak.max[0];ao[aA++]=ak.min[1];ao[aA++]=ak.max[2];for(var ar=0;ar<12;ar+=3){av[aA+ar]=0;av[aA+ar+1]=0;av[aA+ar+2]=-1}ao[aA++]=ak.min[0];ao[aA++]=ak.min[1];ao[aA++]=ak.min[2];ao[aA++]=ak.min[0];ao[aA++]=ak.max[1];ao[aA++]=ak.min[2];ao[aA++]=ak.max[0];ao[aA++]=ak.max[1];ao[aA++]=ak.min[2];ao[aA++]=ak.max[0];ao[aA++]=ak.min[1];ao[aA++]=ak.min[2];for(var ar=0;ar<12;ar+=3){av[aA+ar]=1;av[aA+ar+1]=0;av[aA+ar+2]=0}ao[aA++]=ak.max[0];ao[aA++]=ak.min[1];ao[aA++]=ak.min[2];ao[aA++]=ak.max[0];ao[aA++]=ak.max[1];ao[aA++]=ak.min[2];ao[aA++]=ak.max[0];ao[aA++]=ak.max[1];ao[aA++]=ak.max[2];ao[aA++]=ak.max[0];ao[aA++]=ak.min[1];ao[aA++]=ak.max[2];for(var ar=0;ar<12;ar+=3){av[aA+ar]=-1;av[aA+ar+1]=0;av[aA+ar+2]=0}ao[aA++]=ak.min[0];ao[aA++]=ak.min[1];ao[aA++]=ak.max[2];ao[aA++]=ak.min[0];ao[aA++]=ak.max[1];ao[aA++]=ak.max[2];ao[aA++]=ak.min[0];ao[aA++]=ak.max[1];ao[aA++]=ak.min[2];ao[aA++]=ak.min[0];ao[aA++]=ak.min[1];ao[aA++]=ak.min[2];var aq=new r();var ap=aq.getMaterialFromGAS({color:new l.Color(16729156),opacity:0.2});an.drawingGroups=[];an.drawingGroups.push({start:0,count:36,glType:z.TRIANGLES,gas:ap});var aw=new l.Vector3(ak.min[0],ak.min[1],ak.min[2]);var az=new l.Vector3(ak.max[0],ak.max[1],ak.max[2]);var al=az.clone().sub(aw).multiplyScalar(0.5).length();var aC=az.clone().add(aw).multiplyScalar(0.5);an.boundingSphere=new l.Sphere(aC,al);an.boundingBox=new l.Box3(aw,az);an.vertexPositionArray=ao;an.vertexNormalArray=av;an.vertexIndexArray=am;var at=new l.Mesh(an,ap);at.matrixAutoUpdate=false;var au=new n(at,"BBox");if(!H){au.setVisibility(false)}return au}};return p});define("DS/Visualization/WebGLV6Viewer",["DS/Visualization/WebGLViewer","DS/Robot/Robot","DS/Robot/ReferenceAxisSystemNode","DS/Robot/CustomReferenceAxisSystem","DS/Visualization/InternalSceneGraph","DS/SceneGraphOverrides/SceneGraphState","DS/SceneGraphOverrides/SceneGraphOverrideSetManager","DS/Visualization/OccurrenceRenderingOverride","DS/SceneGraphOverrides/OverrideLink2","DS/QualityManager/QMController"],function(c,g,d,b,h,e,f,k,a,j){var l=c.extend({init:function(p){this._ignoreQM=(p.ignoreQM!==undefined)?!!p.ignoreQM:false;this._QMModif=false;this._QMSettings={AntiAliasing:{modified:false,value:{"static":"SMAA",dynamic:"SMAA"}},AllowOutline:{modified:false,value:{"static":true,dynamic:true}},PixelCulling:{modified:false,value:{"static":4.5,dynamic:4.5}},Transparency:{modified:false,value:{"static":"AlphaBlending",dynamic:"AlphaBlending"}},AllowGroundShadows:{modified:false,value:{"static":true,dynamic:true}},AllowInterObjectShadows:{modified:false,value:{"static":true,dynamic:true}},ShadowQuality:{modified:false,value:{"static":"Medium",dynamic:"Medium"}},ShadowFilter:{modified:false,value:{"static":"PCFOptimized",dynamic:"PCFOptimized"}},AllowGroundReflection:{modified:false,value:{"static":true,dynamic:true}},AllowSSAO:{modified:false,value:{"static":true,dynamic:true}},AllowBloom:{modified:false,value:{"static":true,dynamic:true}},AllowDepthOfField:{modified:false,value:{"static":true,dynamic:true}},ZPrePass:{modified:false,value:{"static":false,dynamic:false}},};if(!j.isInitialized){j.init();j.initPresetDB("QualityPresets")}j.linkToViewer(this);this._parent(p);this._sceneGraphOverrideSetManager=new f(this);this._iterativeAA=false;this._staticAAPostPro="SMAA";var o=j.getCurrentGlobalPreset("Static");var n=j.getPresetValue("Static",o);if(n){var m={AntiAliasing:n.AntiAliasing.IterativeAntiAliasing?"MSAA":n.AntiAliasing.AntiAliasing,AllowOutline:n.OutlineViewMode.AllowOutline,PixelCulling:n.PixelCulling.PixelCulling,Transparency:n.Transparency.Transparency,AllowGroundShadows:n.Shadows.AllowGroundShadows,AllowInterObjectShadows:n.Shadows.AllowInterObjectShadows,ShadowQuality:n.Shadows.ShadowQuality,ShadowFilter:n.Shadows.ShadowFilter,AllowGroundReflection:n.Reflections.AllowGroundReflection,AllowSSAO:n.AmbientOcclusion.AllowSSAO,AllowBloom:n.Bloom.AllowBloom,AllowDepthOfField:n.DepthOfField.AllowDepthOfField};this._iterativeAA=!!n.AntiAliasing.IterativeAntiAliasing;this._staticAAPostPro=n.AntiAliasing.AntiAliasing;!this.ODTMode&&this._setQMSettings(m,"static")}o=j.getCurrentGlobalPreset("Dynamic");n=j.getPresetValue("Dynamic",o);if(n){var m={AntiAliasing:n.AntiAliasing.AntiAliasing,AllowOutline:n.OutlineViewMode.AllowOutline,PixelCulling:n.PixelCulling.PixelCulling,Transparency:n.Transparency.Transparency,AllowGroundShadows:n.Shadows.AllowGroundShadows,AllowInterObjectShadows:n.Shadows.AllowInterObjectShadows,ShadowQuality:n.Shadows.ShadowQuality,ShadowFilter:n.Shadows.ShadowFilter,AllowGroundReflection:n.Reflections.AllowGroundReflection,AllowSSAO:n.AmbientOcclusion.AllowSSAO,AllowBloom:n.Bloom.AllowBloom,AllowDepthOfField:n.DepthOfField.AllowDepthOfField};!this.ODTMode&&this._setQMSettings(m,"dynamic")}},setRobot:function(m,n){if(this.internalSceneGraph&&this.internalSceneGraph.setRobot(m,n,this)){this.render()}},getRobot:function(){if(!this.internalSceneGraph){return null}return this.internalSceneGraph.getRobot()},setCustomReferenceAxisSystem:function(m){if(this.internalSceneGraph){this.internalSceneGraph.setCustomReferenceAxisSystem(m);this.render()}},getCustomReferenceAxisSystem:function(){return this.internalSceneGraph&&this.internalSceneGraph._customReferenceAxisSystem},setReferenceAxisSystem:function(m){this.internalSceneGraph.showReferenceAxisSystem(m,undefined)},createSceneGraphState:function(){if(this._sceneGraphStateVersion&&this._sceneGraphStateVersion!==1){console.warn("Cannot use both v1 and v2 sceneGraphStates");throw Error()}if(!this._sceneGraphStateVersion){this._sceneGraphStateVersion=1}var m=this.getRootNode();if(m){return new e(this,this.getRootNode())}},setCurrentSceneGraphState:function(n){if(this._sceneGraphStateMode&&this._sceneGraphStateVersio!==1){console.warn("Cannot use both v1 and v2 sceneGraphStates");throw Error()}if(!this._sceneGraphStateVersion){this._sceneGraphStateVersion=1}if(n instanceof e||(this.sceneGraphState instanceof e&&!n)){var m=this.getRootNode();if(!n||(n.viewer===this&&n.sceneGraph===m)){if(n!==this.sceneGraphState){if(this.sceneGraphState){this.sceneGraphState.onDeactivation(m)}if(n){n.onActivation(m)}this.sceneGraphState=n;this.internalSceneGraph.root._occurrences[0].requestOverridesUpdate()}}}},_qmSetShadow:function(m,n){if(m&&!this._QMSettings.AllowInterObjectShadows.value[n]){if(this._QMModif){return false}else{this._QMSettings.AllowInterObjectShadows.value[n]=true;this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowInterObjectShadows",value:true,staticValue:this._QMSettings.AllowInterObjectShadows.value["static"],dynamicValue:this._QMSettings.AllowInterObjectShadows.value.dynamic,viewer:this}})}}return true},_qmSetOIT:function(m,o){var n=m?"WeightedAverage":"AlphaBlending";this._QMSettings.Transparency.value[o]=n;if(!this._QMModif){this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"Transparency",value:n,staticValue:this._QMSettings.Transparency.value["static"],dynamicValue:this._QMSettings.Transparency.value.dynamic,viewer:this}})}return true},_qmEnableZPrePass:function(m,n){this._QMSettings.ZPrePass.value[n]=m;if(!this._QMModif){this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"ZPrePass",value:m,staticValue:this._QMSettings.ZPrePass.value["static"],dynamicValue:this._QMSettings.ZPrePass.value.dynamic,viewer:this}})}return true},_qmSetShadowFilter:function(m,n){this._QMSettings.ShadowFilter.value[n]=m;if(!this._QMModif){this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"ShadowFilter",value:m,staticValue:this._QMSettings.ShadowFilter.value["static"],dynamicValue:this._QMSettings.ShadowFilter.value.dynamic,viewer:this}})}return true},_qmSetShadowQuality:function(m,n){this._QMSettings.ShadowQuality.value[n]=m;if(!this._QMModif){this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"ShadowQuality",value:m,staticValue:this._QMSettings.ShadowQuality.value["static"],dynamicValue:this._QMSettings.ShadowQuality.value.dynamic,viewer:this}})}return true},_qmSetGroundShadow:function(m,n){if(m&&!this._QMSettings.AllowGroundShadows.value[n]){if(this._QMModif){return false}else{this._QMSettings.AllowGroundShadows.value[n]=true;this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowGroundShadows",value:true,staticValue:this._QMSettings.AllowGroundShadows.value["static"],dynamicValue:this._QMSettings.AllowGroundShadows.value.dynamic,viewer:this}})}}return true},_qmSetMirror:function(m,n){if(m&&!this._QMSettings.AllowGroundReflection.value[n]){if(this._QMModif){return false}else{this._QMSettings.AllowGroundReflection.value[n]=true;this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowGroundReflection",value:true,staticValue:this._QMSettings.AllowGroundReflection.value["static"],dynamicValue:this._QMSettings.AllowGroundReflection.value.dynamic,viewer:this}})}}return true},_qmSetAntiAliasing:function(m,n){this._QMSettings.AntiAliasing.value[n]=m;if(!this._QMModif){this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AntiAliasing",value:m,staticValue:this._QMSettings.AntiAliasing.value["static"],dynamicValue:this._QMSettings.AntiAliasing.value.dynamic,viewer:this}})}return true},_qmSetPixelCulling:function(n,m){this._QMSettings.PixelCulling.value[m]=n;if(!this._QMModif){this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"PixelCulling",value:n,staticValue:this._QMSettings.PixelCulling.value["static"],dynamicValue:this._QMSettings.PixelCulling.value.dynamic,viewer:this}})}return true},_qmSetSSAO:function(m,n){if(m&&!this._QMSettings.AllowSSAO.value[n]){if(this._QMModif){return false}else{this._QMSettings.AllowSSAO.value[n]=true;this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowSSAO",value:true,staticValue:this._QMSettings.AllowSSAO.value["static"],dynamicValue:this._QMSettings.AllowSSAO.value.dynamic,viewer:this}})}}return true},_qmSetDOF:function(m,n){if(m&&!this._QMSettings.AllowDepthOfField.value[n]){if(this._QMModif){return false}else{this._QMSettings.AllowDepthOfField.value[n]=true;this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowDepthOfField",value:true,staticValue:this._QMSettings.AllowDepthOfField.value["static"],dynamicValue:this._QMSettings.AllowDepthOfField.value.dynamic,viewer:this}})}}return true},_qmSetBloom:function(m,n){if(m&&!this._QMSettings.AllowBloom.value[n]){if(this._QMModif){return false}else{this._QMSettings.AllowBloom.value[n]=true;this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowBloom",value:true,staticValue:this._QMSettings.AllowBloom.value["static"],dynamicValue:this._QMSettings.AllowBloom.value.dynamic,viewer:this}})}}return true},setVisuEnv:function(m){this._QMModif=true;this._parent(m);this._QMModif=false},_setQMSettings:function(n,o){if(this._ignoreQM){return}this._QMModif=true;o=o.toLowerCase();if((o!=="static")&&(o!=="dynamic")){o="static"}if(o==="dynamic"){if(n.AntiAliasing!==undefined){this.setAntiAliasing(n.AntiAliasing,o)}}else{if(n.AntiAliasing!==undefined){this._staticAAPostPro=n.AntiAliasing}if(n.IterativeAntiAliasing!==undefined){if(n.IterativeAntiAliasing){this._iterativeAA=true;this.setAntiAliasing("MSAA",o)}else{this._iterativeAA=false;this.setAntiAliasing(this._staticAAPostPro,o)}}else{if(n.AntiAliasing!==undefined){if(!this._iterativeAA){this.setAntiAliasing(this._staticAAPostPro,o)}}}}if(n.PixelCulling!==undefined){this.setPixelCulling(n.PixelCulling,o)}if(n.Transparency!==undefined){if(!this._QMSettings.Transparency.modified){this.setOIT(n.Transparency==="WeightedAverage",o)}}if(n.AllowGroundShadows!==undefined){if(!this._QMSettings.AllowGroundShadows.modified){this._QMSettings.AllowGroundShadows.value[o]=n.AllowGroundShadows;if(!n.AllowGroundShadows){this.setGroundShadow(false,o)}}}if(n.AllowInterObjectShadows!==undefined){if(!this._QMSettings.AllowInterObjectShadows.modified){this._QMSettings.AllowInterObjectShadows.value[o]=n.AllowInterObjectShadows;if(!n.AllowInterObjectShadows){this.setShadow(false,false,o)}}}if(n.ShadowQuality!==undefined){if(!this._QMSettings.ShadowQuality.modified){this.setShadowQuality(n.ShadowQuality,o)}}if(n.ShadowFilter!==undefined){if(!this._QMSettings.ShadowFilter.modified){var m=(n.ShadowFilter==="PCF")?"PCFOptimized":n.ShadowFilter;this.setShadowFilter(m,o)}}if(n.AllowGroundReflection!==undefined){if(!this._QMSettings.AllowGroundReflection.modified){this._QMSettings.AllowGroundReflection.value[o]=n.AllowGroundReflection;if(!n.AllowGroundReflection){this.setMirror(false,true,o)}}}if(n.AllowSSAO!==undefined){if(!this._QMSettings.AllowSSAO.modified){this._QMSettings.AllowSSAO.value[o]=n.AllowSSAO;if(!n.AllowSSAO){this.setSSAO(false,o)}}}if(n.AllowBloom!==undefined){if(!this._QMSettings.AllowBloom.modified){this._QMSettings.AllowBloom.value[o]=n.AllowBloom;if(!n.AllowBloom){this.setBloom(false,o)}}}if(n.AllowDepthOfField!==undefined){if(!this._QMSettings.AllowDepthOfField.modified){this._QMSettings.AllowDepthOfField.value[o]=n.AllowDepthOfField;if(!n.AllowDepthOfField){this.setDOF(false,o)}}}this._QMModif=false},_getQMSetting:function(m){var n=this._QMSettings[m];if(m==="IterativeAntiAliasing"){n={modified:false,value:{"static":this._iterativeAA,dynamic:false}}}else{if(!n){return null}}return{modified:n.modified,value:n.value["static"],staticValue:n.value["static"],dynamicValue:n.value.dynamic}},_onQMSettingModified:function(m){return this._modelEvent.subscribe({event:"QMSettingModified"},m)},dispose:function(){j.dispose();this._parent()}});h.setRobotClasses(g,d,b);k.setOverrideLink2Class(a);return UWA.namespace("THREEDS/WebGLV6Viewer",l)});define("Visualization/WebGLV6Viewer",["DS/Visualization/WebGLV6Viewer","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/WebGLV6Viewer");return b});define("DS/Visualization/CSIViewer",["DS/Visualization/WebGLV6Viewer","DS/Visualization/ViewManager"],function(c,b){var a=c.extend({init:function(d){this._parent(d);this.newModelIdentification=(d.newModelIdentification!==undefined)?d.newModelIdentification:false;this.viewManager=new b(this);return this},onVisuAnswer:function(d){return this.viewManager.onVisuAnswer(d)},setStaticMaterial:function(d,e){console.warn("setStaticMaterial method is deprecated. Use setStaticLook instead.");this.viewManager.setStaticMaterial(d,e)},setStaticLook:function(d,e){this.viewManager.setStaticLook(d,e)},setDefaultMaterials:function(d){this.viewManager.setDefaultMaterials(d)},setAlternativeEditDisplay:function(d){this.viewManager.setTemporaryBodies(d)},empty:function(e,d){this._parent(e,d);this.viewManager.clear()},updatePlaneOnViewMessage:function(d){this.viewManager.updatePlaneOnViewMessage(d)}});return UWA.namespace("THREEDS/CSIViewer",a)});define("DS/Visualization/ModelLoader",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Visualization/SceneGraph","DS/VisuEvents/EventsManager"],function(b,d,e,f,a){var c=b.extend({init:function(g,h){this.fileType="xmlv43";this.geometryMode="3dxmlgeometry";this.smartLoading=false;this.filterNavReps=false;this.modelName="";this.Ox4MQLV6Loader=null;this.cgrLoader=null;this.uvrLoader=null;this.xmlv43Loader=null;this.xmlv6Loader=null;this.xmlv6SmartLoader=null;this.colladaLoader=null;this.jsonLoader=null;this.objLoader=null;this.xcadLoader=null;this.particlesLoader=null;this.streamVisuLoader=null;this.threeDXLoader=null;this.multipartMode=false;this.CGRNewInfra=true;this.keepLoaderMode=false;this.expandMode=false;this.readDecoration=false;this.primitiveWithBS=false;this.withSAG=false;this.useUvrWorker=true;this.withSceneGraph=false;this.smartStaticBatching=true;this.edgeTransparency=true;this.sharedBuffers=true;this.noMeshInRAM=false;this.processText=false;this.targetNode=null;this.glContext=g;this.renderer=null;this.renderCB=null;this.onLoadedCB=function(){if(a.RecordEventsManager){a.RecordEventsManager.sendSynchroPoint("ModelLoaded")}window.webVisuPerfo.endPerfo("load");d.loadingModels=false};this.onLoadedPrdCB=null;this.onProgressCB=null;this.onErrorCB=null;this.refreshTime=2000;this.debugBBox=(h!==undefined)?h:false;this.poolOfModels={xmlv43:{loading:false,models:[]},xmlv6:{loading:false,models:[]},Ox4MQLV6:{loading:false,models:[]},OxMQLV5:{loading:false,models:[]},cgr:{loading:false,models:[]},streamvisu:{loading:false,models:[]},"3dx":{loading:false,models:[]}};this._Ox4ProxyAbstraction=null;return this},setSceneGraph:function(g){this.targetNode=g},setTargetNode:function(g){this.targetNode=g},setWebGLContext:function(g){this.glContext=g},getCGROptions:function(){return{readDeco:this.readDecoration,primWithBS:this.primitiveWithBS,edgeTransparency:this.getEdgeTransparency(),cgrWithSG:this.getCGRWithSG(),sharedBuffers:this.getSharedBuffers(),noMeshInRAM:this.getNoMeshInRAM(),smartStaticBatching:this.smartStaticBatching,withSAG:this.withSAG,withSceneGraph:this.getCGRWithSG(),uvrWorker:this.useUvrWorker,cgrMultipartMode:this.getMultipartMode(),cgrExpandMode:this.getExpandMode(),processText:this.processText}},setRenderCallback:function(g,h){this.renderCB=g;this.refreshTime=h?h:2000},setOnLoadedCallback:function(g){this.onLoadedCB=function(h){window.webVisuPerfo.endPerfo("load");if(a.RecordEventsManager){a.RecordEventsManager.sendSynchroPoint("ModelLoaded")}d.loadingModels=false;if(g){g.call(this,h)}}},setOnLoadedProductStructureCallback:function(g){this.onLoadedPrdCB=g},setOnProgressCallback:function(g){this.onProgressCB=g},setOnErrorCallback:function(g){this.onErrorCB=g},activateSmartLoading:function(g){if(g===null){return}this.renderer=g;this.smartLoading=true},deactivateSmartLoading:function(){this.smartLoading=false},setFilterNavReps:function(g){this.filterNavReps=g},getFileType:function(){return this.fileType},setFileType:function(g){this.fileType=g},getGeometryMode:function(){return this.geometryMode},setGeometryMode:function(g){this.geometryMode=g;if(this.xmlv6Loader!==null){this.xmlv6Loader.setGeometryMode(g)}},getMultipartMode:function(){return this.multipartMode},setMultipartMode:function(g){this.multipartMode=g},getCGRNewInfra:function(){return this.CGRNewInfra},setKeepLoaderMode:function(g){if(this.cgrLoader){this.cgrLoader.setKeepLoaderMode(g)}this.keepLoaderMode=g},getKeepLoaderMode:function(){return this.keepLoaderMode},setCGRNewInfra:function(g){this.CGRNewInfra=g},getCGRWithSG:function(){return this.withSceneGraph},setCGRWithSG:function(g){this.withSceneGraph=g},getEdgeTransparency:function(){return this.edgeTransparency},setEdgeTransparency:function(g){this.edgeTransparency=g},getSharedBuffers:function(){return this.sharedBuffers},setSharedBuffers:function(g){this.sharedBuffers=g},getNoMeshInRAM:function(){return this.noMeshInRAM},setNoMeshInRAM:function(g){this.noMeshInRAM=g},getExpandMode:function(){return this.expandMode},setExpandMode:function(g){this.expandMode=g},enableLDH:function(l,h,k,j,n,g){var m=this;require(["DS/SelectiveLoading/SelectiveLoadingAsync"],function(o){m.LDH=o;m.LDH.Helpers._enableLDH(m,l,h,k,n,g);if(m.LDHAsyncDestruction!==undefined){m.destructLDH()}else{if(j){j()}}},function(p){var o=p.requireModules&&p.requireModules[0];console.error("Module "+o+" is missing.");if(m.onErrorCB){m.onErrorCB()}})},getLDHInterface:function(){return this._ldhInterface},destructLDH:function(){if(this.LDH===undefined){this.LDHAsyncDestruction=true}else{this.LDH.Helpers._ldhCleanup(this);delete this.LDHAsyncDestruction;delete this.LDH}},_onModuleError:function(g,h){return function(k){var j=k.requireModules&&k.requireModules[0];console.log("Module "+j+" is missing.");if(g){g({url:h,type:"FORMAT"})}}},_xmlv43LoaderCB:function(g){this.xmlv43Loader.load(g.jsonSettings,function(h){g.destination.addChild(h);if(g.loadedProductCB!==null){g.loadedProductCB(h)}if(g.renderCB!==null){g.renderCB({needReframe:false})}g.destination=null},g.progressCB,g.loadedCB,g.errorCB,g.filterNavReps,g.refreshTime,g.readDecoration,g.cgrNewInfra,g.primitiveWithBS,g.edgeTransparency,g.cgrWithSG,g.sharedBuffers,g.noMeshInRAM,g.smartStaticBatching,g.cgrWithSAG,g.uvrWorker,g.applicativeContainers,g.processText)},_xmlv6LoaderCB:function(g){this.xmlv6Loader.load(g.modelName,function(h){g.destination.addChild(h);if(g.loadedProductCB!==null){g.loadedProductCB(h)}if(g.renderCB!==null){g.renderCB({needReframe:true})}g.destination=null},g.progressCB,g.loadedCB)},_Ox4MQLV6LoaderCB:function(g){this.Ox4MQLV6Loader.load(g.jsonSettings,function(h){g.destination.addChild(h);if(g.loadedProductCB!==null){g.loadedProductCB(h)}if(g.renderCB!==null){g.renderCB({needReframe:false})}g.destination=null},g.progressCB,g.loadedCB,g.errorCB,{edgeTransparency:g.edgeTransparency})},_OxMQLV5LoaderCB:function(g){this.OxMQLV5Loader.load(g.jsonSettings,function(h){g.destination.addChild(h);if(g.loadedProductCB!==null){g.loadedProductCB(h)}if(g.renderCB!==null){g.renderCB({needReframe:false})}},g.progressCB,g.loadedCB,g.errorCB,{edgeTransparency:g.edgeTransparency})},_cgrLoaderCB:function(h){var j={isBuffer:h.isBuffer,destination:h.destination,isMultipartMode:h.cgrMultipartMode,isExpandMode:h.cgrExpandMode,isCGRNewInfra:h.cgrNewInfra,readDeco:h.readDecoration,primWithBS:h.primitiveWithBS,smartStaticBatching:h.smartStaticBatching,withSAG:h.cgrWithSAG,edgeTransparency:h.edgeTransparency,sharedBuffers:h.sharedBuffers,noMeshInRAM:h.noMeshInRAM,withSceneGraph:h.cgrWithSG,applicativeContainers:h.applicativeContainers,processText:h.processText};var k=function(l){if(h.loadedProductCB!==null){h.loadedProductCB(l)}};var g={readyCallback:k,doneCallback:h.loadedCB,errorCallback:h.errorCB,progressCallback:h.progressCB};this.cgrLoader.load(h.jsonSettings,g,j);h.destination=null},_streamVisuLoaderCB:function(g){this.streamVisuLoader.load(g.modelName,function(h){if(g.loadedProductCB!==null){g.loadedProductCB(h)}},null,g.loadedCB,g.destination)},_threeDXLoaderCB:function(h){this.threeDXLoader.setMode(h.fileType==="3dxc"?"concat":"zipped");this.threeDXLoader.setSharedBuffers(h.sharedBuffers);this.threeDXLoader.setNoMeshInRAM(h.noMeshInRAM);var j=true;var g=false;var k=false;var l=h.jsonSettings&&h.jsonSettings.loaderSettings;if(l){j=l.primitives;g=l.reps;k=l.ssb}this.threeDXLoader.load({url:h.modelName,primitives:j,reps:g,ssb:k,lightMapAsIrradiance:l&&l.lightMapAsIrradiance,destinationNode:h.destination,readyCallback:function(m){if(h.loadedProductCB!==null){h.loadedProductCB(m)}},doneCallback:h.loadedCB,errorCallback:h.errorCB,gasSharing:(l&&l.gasSharing)?true:false})},loadModelFromBuffer:function(j,g,h){return this.loadModel(j,g,true,h)},loadModel:function(g,l,p,n){window.webVisuPerfo.startPerfo("load",-1);d.loadingModels=true;if((this.LDH!==undefined)&&(g.localAABox!==undefined)){return this.LDH.Helpers._onLoadModel(this,g,l,p)}var j=this,o=null,m=(l!==undefined)?l:j.targetNode;if(m===null){return false}p=p!==undefined?p:false;if(!p){var h=(typeof g==="string");o=this.buildPath(g);this.modelName=o.serverurl?o.serverurl:"";this.modelName+=o.filename?o.filename:"";this.setFileTypeFromSpec(o)}var k={modelName:this.modelName,fileType:this.fileType,jsonSettings:o,destination:m,isBuffer:p,geometryMode:this.geometryMode,renderCB:this.renderCB,loadedProductCB:this.onLoadedPrdCB,progressCB:this.onProgressCB,loadedCB:this.onLoadedCB,errorCB:this.onErrorCB,filterNavReps:this.filterNavReps,refreshTime:this.refreshTime,readDecoration:this.readDecoration,cgrNewInfra:this.getCGRNewInfra(),primitiveWithBS:this.primitiveWithBS,edgeTransparency:this.getEdgeTransparency(),cgrWithSG:this.getCGRWithSG(),sharedBuffers:this.getSharedBuffers(),noMeshInRAM:this.getNoMeshInRAM(),smartStaticBatching:this.smartStaticBatching,cgrWithSAG:this.withSAG,uvrWorker:this.useUvrWorker,cgrMultipartMode:this.getMultipartMode(),cgrExpandMode:this.getExpandMode(),waitMaterial:this.waitMaterial,processText:this.processText};if(this.fileType==="xmlv43"){if(p){return false}if(n&&n.applicativeContainers){k.applicativeContainers=n.applicativeContainers}if(!this.xmlv43Loader){this.poolOfModels.xmlv43.models.push(k);if(!this.poolOfModels.xmlv43.loading){this.poolOfModels.xmlv43.loading=true;require(["DS/VisuLoaders/XMLV43Loader"],function(s){j.poolOfModels.xmlv43.loading=false;j.xmlv43Loader=new s(j.glContext,j.renderCB);var r=j.poolOfModels.xmlv43.models;for(var q=0;q<r.length;q++){j._xmlv43LoaderCB(r[q])}j.poolOfModels.xmlv43.models=[]},this._onModuleError(k.errorCB,k.modelName))}}else{this._xmlv43LoaderCB(k)}}else{if(this.fileType==="xmlv6"){if(p){return false}if(!this.xmlv6Loader){this.poolOfModels.xmlv6.models.push(k);if(!this.poolOfModels.xmlv6.loading){this.poolOfModels.xmlv6.loading=true;require(["DS/VisuLoaders/XMLV6Loader","DS/VisuLoaders/XMLV6SmartLoaderPassPlugin"],function(r,t){j.poolOfModels.xmlv6.loading=false;j.xmlv6Loader=new r(j.glContext,j.renderCB,j.debugBBox,j.geometryMode);if(j.smartLoading&&(j.xmlv6SmartLoader===null)){j.xmlv6SmartLoader=new t(j.xmlv6Loader);j.xmlv6SmartLoader.enabled=true;j.xmlv6SmartLoader.renderTarget=null;j.renderer.addPrePlugin(j.xmlv6SmartLoader)}else{if(!j.smartLoading&&(j.xmlv6SmartLoader!==null)){j.xmlv6SmartLoader.enabled=false}else{if(j.xmlv6SmartLoader!==null){j.xmlv6SmartLoader.enabled=true}}}var s=j.poolOfModels.xmlv6.models;for(var q=0;q<s.length;q++){j._xmlv6LoaderCB(s[q])}j.poolOfModels.xmlv6.models=[]},this._onModuleError(k.errorCB,k.modelName))}}else{this._xmlv6LoaderCB(k)}}else{if(this.fileType=="Ox4MQLV6"){if(!this.Ox4MQLV6Loader){this.poolOfModels.Ox4MQLV6.models.push(k);if(!this.poolOfModels.Ox4MQLV6.loading){this.poolOfModels.Ox4MQLV6.loading=true;require(["DS/VisuDataAccess/Ox4MQLV6Loader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(t,s){j.poolOfModels.Ox4MQLV6.loading=false;j._Ox4ProxyAbstraction=s;j.Ox4MQLV6Loader=new t(j.glContext,j.renderCB,j.debugBBox,j.geometryMode);var r=j.poolOfModels.Ox4MQLV6.models;for(var q=0;q<r.length;q++){e.setProxyFromSpec(r[q].jsonSettings,s);j._Ox4MQLV6LoaderCB(r[q])}j.poolOfModels.Ox4MQLV6.models=[]},this._onModuleError(k.errorCB,k.modelName))}}else{e.setProxyFromSpec(k.jsonSettings,this._Ox4ProxyAbstraction);this._Ox4MQLV6LoaderCB(k)}}else{if(this.fileType=="svg"){require(["DS/SVGLoader/SVGLoader"],function(q){var r=new q({renderCB:j.renderCB,onProgressCB:j.onProgressCB,onLoadedCB:j.onLoadedCB,onErrorCB:j.onErrorCB});r.load(o,m)})}else{if(this.fileType=="OxMQLV5"){if(!this.OxMQLV5Loader){this.poolOfModels.OxMQLV5.models.push(k);if(!this.poolOfModels.OxMQLV5.loading){this.poolOfModels.OxMQLV5.loading=true;require(["DS/EV53DPlay/OxMQLV5Loader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(r,t){j.poolOfModels.OxMQLV5.loading=false;j._Ox4ProxyAbstraction=t;j.OxMQLV5Loader=new r(j.glContext,j.renderCB);var s=j.poolOfModels.OxMQLV5.models;for(var q=0;q<s.length;q++){e.setProxyFromSpec(s[q].jsonSettings,t);j._OxMQLV5LoaderCB(s[q])}j.poolOfModels.OxMQLV5.models=[]},this._onModuleError(k.errorCB,k.modelName))}}else{e.setProxyFromSpec(k.jsonSettings,j._Ox4ProxyAbstraction);this._OxMQLV5LoaderCB(k)}}else{if(this.fileType==="cgr"||this.fileType==="uvr"){if(n&&n.applicativeContainers){k.applicativeContainers=n.applicativeContainers}if(!this.cgrLoader){if(p){k.jsonSettings=g}this.poolOfModels.cgr.models.push(k);if(!this.poolOfModels.cgr.loading){this.poolOfModels.cgr.loading=true;require(["DS/VisuLoaders/CGRReader"],function(r){j.poolOfModels.cgr.loading=false;j.cgrLoader=new r(j.glContext,j.renderCB,{keepLoader:j.getKeepLoaderMode()});var s=j.poolOfModels.cgr.models;for(var q=0;q<s.length;q++){j._cgrLoaderCB(s[q])}j.poolOfModels.cgr.models=[]},this._onModuleError(k.errorCB,k.modelName))}}else{if(p){k.jsonSettings=g}this._cgrLoaderCB(k)}}else{if(this.fileType==="dae"){if(p){return false}require(["DS/VisuLoaders/DAEReader"],function(q){if(j.colladaLoader===null){j.colladaLoader=new q(j.glContext,j.renderCB)}if(j.waitMaterial){j.colladaLoader.setWaitMaterial(j.waitMaterial)}j.colladaLoader.loadFromSpec(o,function r(s){m.addChild(s);if(j.onLoadedPrdCB!==null){j.onLoadedPrdCB(s)}if(j.renderCB!==null){j.renderCB({needReframe:false})}m=null},null,j.onLoadedCB)},function(r){var q=r.requireModules&&r.requireModules[0];console.log("Module "+q+" is missing.");if(j.onErrorCB){j.onErrorCB({url:j.modelName,type:"FORMAT"})}})}else{if(this.fileType==="json"){if(p){return false}require(["DS/VisuLoaders/JSONReader"],function(r){if(j.jsonLoader===null){j.jsonLoader=new r(j.glContext,j.renderCB)}j.jsonLoader.load(j.modelName,function q(s){m.addChild(s);if(j.onLoadedPrdCB!==null){j.onLoadedPrdCB(s)}if(j.renderCB!==null){j.renderCB({needReframe:false})}m=null},null,j.onLoadedCB)},function(r){var q=r.requireModules&&r.requireModules[0];console.log("Module "+q+" is missing.");if(j.onErrorCB){j.onErrorCB({url:j.modelName,type:"FORMAT"})}})}else{if(this.fileType==="obj"){if(p){return false}require(["DS/VisuLoaders/OBJReader"],function(r){if(j.objLoader===null){j.objLoader=new r(j.glContext,j.renderCB)}j.objLoader.load(o,function q(s){m.addChild(s);if(j.onLoadedPrdCB!==null){j.onLoadedPrdCB(s)}if(j.renderCB!==null){j.renderCB({needReframe:false})}m=null},null,j.onLoadedCB)},function(r){var q=r.requireModules&&r.requireModules[0];console.log("Module "+q+" is missing.");if(j.onErrorCB){j.onErrorCB({url:j.modelName,type:"FORMAT"})}})}else{if(this.fileType==="streamvisu"){if(p){return false}if(!this.streamVisuLoader){this.poolOfModels.streamvisu.models.push(k);if(!this.poolOfModels.streamvisu.loading){this.poolOfModels.streamvisu.loading=true;require(["DS/VisuLoaders/StreamVisuLoader"],function(q){j.poolOfModels.streamvisu.loading=false;j.streamVisuLoader=new q(j.renderCB);var s=j.poolOfModels.streamvisu.models;for(var r=0;r<s.length;r++){j._streamVisuLoaderCB(s[r])}j.poolOfModels.streamvisu.models=[]},this._onModuleError(k.errorCB,k.modelName))}}else{this._streamVisuLoaderCB(k)}}else{if(this.fileType==="3dx"||this.fileType==="3dxc"||this.fileType==="3dxm"){if(p){return false}if(!this.threeDXLoader){this.poolOfModels["3dx"].models.push(k);if(!this.poolOfModels["3dx"].loading){this.poolOfModels["3dx"].loading=true;require(["DS/VisuLoaders/ThreeDXLoader"],function(q){j.poolOfModels["3dx"].loading=false;j.threeDXLoader=new q();var s=j.poolOfModels["3dx"].models;for(var r=0;r<s.length;r++){j._threeDXLoaderCB(s[r])}j.poolOfModels["3dx"].models=[]},this._onModuleError(k.errorCB,k.modelName))}}else{this._threeDXLoaderCB(k)}}else{if(this.fileType==="stp"||this.fileType==="step"||this.fileType==="stl"){require(["DS/XCADLoader/XCADModelLoaderPlug"],function(t){var s=[new t()];var q=function(u){m.addChild(u);if(j.onLoadedPrdCB!==null){j.onLoadedPrdCB(u)}if(j.renderCB!==null){j.renderCB({needReframe:false})}};for(var r=0;r<s.length;r++){if(s[r].isManagedType(j.fileType)){if(p){return false}s[r].loadModel(j.fileType,j.glContext,j.renderCB,j.modelName,q,j.onProgressCB,j.onLoadedCB,j.onErrorCB,j.filterNavReps,j.refreshTime,m,o)}}},function(r){var q=r.requireModules&&r.requireModules[0];console.log("Module "+q+" is missing.");if(j.onErrorCB){j.onErrorCB({url:j.modelName,type:"FORMAT"})}})}else{if(this.fileType==="particles"){require(["DS/VisuLoaders/ParticlesLoader"],function(q){if(j.particlesLoader===null){j.particlesLoader=new q(j.sceneGraph,j.renderCB)}var r=o;if(p){r=g}j.particlesLoader.load(r,function s(t){m.add(t);if(j.onLoadedPrdCB!==null){j.onLoadedPrdCB(t)}if(j.renderCB!==null){j.renderCB({needReframe:false})}m=null},null,j.onLoadedCB)},function(r){var q=r.requireModules&&r.requireModules[0];console.log("Module "+q+" is missing.");if(j.onErrorCB){j.onErrorCB({url:j.modelName,type:"FORMAT"})}})}else{require(["DS/ModelLoader_"+this.fileType.toLowerCase()+"/loader"],function(q){var r=new q();var t=o;if(p){t=g}r.load(t,function s(u){m.addChild(u);if(j.onLoadedPrdCB!==null){j.onLoadedPrdCB(u)}m=null},j.onProgressCB,j.onLoadedCB,j.onErrorCB,j.renderCB)},function(r){var q=r.requireModules&&r.requireModules[0];console.log("Module "+q+" is missing.");if(j.onErrorCB){j.onErrorCB({url:j.modelName,type:"FORMAT"})}})}}}}}}}}}}}}}return true},getLoader:function(g,j){var h=this;switch(g){case"3dx":require(["DS/VisuLoaders/ThreeDXLoader"],function(k){if(h.threeDXLoader===null){h.threeDXLoader=new k()}j&&j(h.threeDXLoader)});break;default:break}return this.threeDXLoader},buildPath:function(k){if(typeof k==="string"){var n="";var m="";if(k.substring(0,5)==="blob:"){return k={provider:"FILE",serverurl:"",filename:k,requiredAuth:null,proxyurl:"none"}}else{if(k.substring(0,7)==="http://"){n=k}else{if(k.substring(0,8)==="https://"){n=k}else{if(k.substring(0,1)==="/"){n=k}else{if(k.substring(0,10)==="ms-appx://"){n=k}else{if(k.substring(0,7)==="file://"){n=k}else{var l=location.href;var h=l.indexOf("?");if(h!==-1){l=l.substring(0,h)}var g=l.lastIndexOf("/");if(g!==-1){l=l.substring(0,g+1)}n=l+k}}}}}}n=e.parseUrl(n);m=n.protocol;if(n.protocol!==""){m+="://"}m+=n.authority+n.path.substring(0,n.path.lastIndexOf("/"))+"/";var j=n.path.substring(n.path.lastIndexOf("/")+1,n.path.length);if(n.query!==""){j=j+"?"+n.query}k={provider:"FILE",serverurl:m,filename:j,requiredAuth:null,proxyurl:"none"};return k}else{if(k.provider==="EV6"){n=e.parseUrl(k.serverurl);k.serverdefinition={};k.serverdefinition.protocol=n.protocol;k.serverdefinition.hostname=(n.user!=="")?n.user+"@"+n.domain:n.domain;k.serverdefinition.port=n.port;k.serverdefinition.rooturi=n.path;if(k.serverdefinition.rooturi.slice(0,1)==="/"){k.serverdefinition.rooturi=k.serverdefinition.rooturi.slice(1,k.serverdefinition.rooturi.length)}}return k}},setFileTypeFromSpec:function(h){var k="xmlv43";var j="";if((typeof h)==="string"){j=e.getExtension(h)}else{if(!h.provider||(h.provider==="FILE")){if(h.format&&(h.format!=="")){j=h.format}else{var g=h.serverurl?h.serverurl:"";g+=h.filename?h.filename:"";j=e.getExtension(g)}}else{if(h.provider==="EV6"){this.fileType="Ox4MQLV6"}else{if(h.provider==="EV5"){this.fileType="OxMQLV5"}else{this.fileType=h.provider}}}}if(j!==""){if(j.toLowerCase){j=j.toLowerCase()}this.fileType=(j==="3dxml")?"xmlv43":j}},reloadUVR:function(h,j,g,k){var l=this;require(["DS/VisuUnstreamers/UnstreamTaskDriver","DS/VisuUnstreamers/FileInZipStreamObject","DS/Visualization/ProxyAbstraction"],function(o,m,r){var s=l.buildPath(h);var t=new r();e.setProxyFromSpec(s,t);var u=s.serverurl?s.serverurl:"";u+=s.filename?s.filename:"";var p=[];for(var n=0;n<j.length;n++){p.push(j[n].name)}var q=function(x){for(var w=0;w<p.length;w++){var v=new m(x,p[w]);(function(y){o.getTask("CGR",v,j[y],function(z){var B=l.getCGROptions();if(k&&k.applicativeContainers){B.applicativeContainers=k.applicativeContainers}B.unlinkToSG=true;B.destination=[];for(var A=0;A<j[y].parents.length;A++){B.destination.push(j[y].parents[A])}z.run(function(F){var D=F.nodes;if(j&&j[y]&&j[y].parents){var H=j[y].parents.length;for(var E=0;E<H;E++){var G=j[y].parents[E];G.removeChildren();for(var C=0;C<D.length;C++){G.addChild(D[C])}}}},g?g.onLoadedCB:null,g?g.onErrorCB:null,B)})})(w)}};t.executeGetHttpRequest(u,"blob",null,q,l.onErrorCB)})},setWaitMaterial:function(g){this.waitMaterial=g.clone()},abort:function(){if(this.cgrLoader!==null){this.cgrLoader.abort()}if(this.xmlv43Loader!==null){this.xmlv43Loader.abort()}}});return UWA.namespace("THREEDS/ModelLoader",c)});define("Visualization/ModelLoader",["DS/Visualization/ModelLoader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/ModelLoader");return b});define("DS/VisuLoaders/CGRReader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","UWA/Utils","DS/Visualization/Utils","DS/Visualization/ProxyAbstraction","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/SceneGraphNodes/AxisSystemNode","DS/Mesh/Mesh","DS/SceneGraphNodes/BillBoardNode3D","DS/Visualization/LoaderUtils","DS/ZipJS/LoaderInflate"],function(s,f,b,j,o,m,d,c,n,g,k,u,t){var e=!b.matchUrl(f.getWebappsBaseUrl(),window.location)?"Passport":null;var r={provider:"FILE",filename:"AmdLoader.js",serverurl:f.getWebappsBaseUrl()+"AmdLoader/",requiredAuth:e};var p={provider:"FILE",filename:"ThreeJS_Base.js",serverurl:f.getWebappsBaseUrl()+"Mesh/",requiredAuth:e};var h={provider:"FILE",filename:"Mesh.js",serverurl:f.getWebappsBaseUrl()+"Mesh/",requiredAuth:e};var l={provider:"FILE",filename:"CGRFile.js",serverurl:f.getWebappsBaseUrl()+"Formats/",requiredAuth:e};var a={provider:"FILE",filename:"CGRWorkerNewInfra.js",serverurl:f.getWebappsBaseUrl()+"Workers/",requiredAuth:e};var q=function(y,A,D){if(!D){D={}}this.gl=y;var C=undefined;if(s.supportedExtensions){C=s.supportedExtensions.elementIndexUint?true:undefined}this.renderCallbackFunc=(A!==undefined)?A:null;this.isWorkerLoading=false;this.workers=null;this.workerJobs=null;this.urlToRevoke="";this.keepLoader=D.keepLoader?D.keepLoader:false;this.type="";this.dataArray=[];this.materials=[];var E=[];this.modelsToLoad={};this.modelsToLoadCount=0;this.loadIndex=0;this.nbWorkers=4;this.workersLoaded=[];this.workerActivate=false;this.currentDownload=0;this.maxParrallelDownload=40;var z=-1;q.prototype.cleanLoader=function(){this.materials=[];E=[]};var B=0;var w=function(F){var H=[];if(!F){return H}for(var G in F){H.push(G)}return H};var x=function(L){var G,I,F,K,J,H;G="";F=L.length;I=0;while(I<F){K=L[I++];switch(K>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:G+=String.fromCharCode(K);break;case 12:case 13:J=L[I++];G+=String.fromCharCode(((K&31)<<6)|(J&63));break;case 14:J=L[I++];H=L[I++];G+=String.fromCharCode(((K&15)<<12)|((J&63)<<6)|((H&63)<<0));break}}return G};var v=function(J,L,G){if(L&&J){for(var R in L){var H=L[R].doneCallback;var O=L[R].errorCallback;if(J[R]){var M=J[R];if(!M){O({node:G});continue}var K=M.buffer.subarray(M.options.offset,M.options.compressed+M.options.offset);if(K.length<=2){O({node:G});continue}if(K[0]!==120){O({node:G});continue}if(K[1]!==218){O({node:G});continue}var F=2;var I=K.subarray(F,M.options.compressed);var P=new t();var Q=P.Inflate(I);var N=x(Q);H({xml:N,node:G})}else{H({node:G})}}}};this.internalLoad=function(H){var L=this;var K=this.modelsToLoad[H];var F=K.url;K.launched=true;var I=w(K.applicativeContainers);if(K.isBuffer){var G=this.workersLoaded[H%this.workersLoaded.length];this.workers[G].postMessage({loadIndex:H,inputFile:F,readDecoration:K.readDecoration,primitiveWithBS:K.primitiveWithBS,withSAG:K.withSAG,withSceneGraph:K.withSceneGraph,smartStaticBatching:K.smartStaticBatching,edgeTransparency:K.edgeTransparency,node:"CGR",uint32Index:C,applicativesContainers:I})}else{this.currentDownload++;var M=new o();j.setProxyFromSpec(F,M);var N=F.serverurl?F.serverurl:"";N+=F.filename?F.filename:"";var J=function(O){L.currentDownload--;K.errorCallback(O)};M.executeGetHttpRequest(N,"arraybuffer",null,function(R){L.currentDownload--;var P=false;if(P){var V=new DataView(R);var O=new Blob([V],{type:"application/octet-binary"});var T=URL.createObjectURL(O);console.log("url : "+T)}var U=0;for(var S=0;S<L.workersLoaded.length;++S){var X=0;for(var Q=0;Q<L.workerJobs[L.workersLoaded[S]].length;++Q){X+=L.workerJobs[L.workersLoaded[S]][Q]}if(X>U){U=X}}var Y=U;var W=L.workersLoaded[0];for(var S=0;S<L.workersLoaded.length;++S){var X=0;for(var Q=0;Q<L.workerJobs[L.workersLoaded[S]].length;++Q){X+=L.workerJobs[L.workersLoaded[S]][Q]}if(X<Y){Y=X;W=L.workersLoaded[S]}}L.workerJobs[W].push(R.byteLength);L.workers[W].postMessage({inputFile:R,loadIndex:H,node:F.filename,readDecoration:K.readDecoration,primitiveWithBS:K.primitiveWithBS,smartStaticBatching:K.smartStaticBatching,withSAG:K.withSAG,edgeTransparency:K.edgeTransparency,withSceneGraph:K.withSceneGraph,uint32Index:C,applicativesContainers:I},[R])},J)}};this.setKeepLoaderMode=function(F){this.keepLoader=F;if(!this.keepLoader&&this.modelsToLoadCount==0){this.abort()}};this.load=function(F,H,N){var L=this;this.cleanLoader();var M=N.isBuffer!==undefined?N.isBuffer:false;function J(O,P){return function(T){console.log("index :  "+O);if(P){P(T)}var Q=L.modelsToLoad[O];if(Q.applicativeContainers){for(var S in Q.applicativeContainers){if(Q.applicativeContainers[S].errorCallback){Q.applicativeContainers[S].errorCallback(T)}}}delete L.modelsToLoad[O];L.modelsToLoadCount--;var R=true;for(var S in L.modelsToLoad){R=false}if(R){if(L.renderCallbackFunc!==null){L.renderCallbackFunc({hack:true,updateInfinitePlane:true,reframe:true})}if(Q.doneCallback){Q.doneCallback()}}E=[];for(var S in L.modelsToLoad){if(L.currentDownload<L.maxParrallelDownload&&L.modelsToLoad[S].launched===false){L.internalLoad(S)}}}}var K=J(this.loadIndex,H.errorCallback);var G={url:F,readyCallback:H.readyCallback,progressCallback:H.progressCallback,doneCallback:H.doneCallback,errorCallback:K,isBuffer:N.isBuffer,destinationNode:N.destination,readDecoration:N.readDeco,primitiveWithBS:N.primWithBS,smartStaticBatching:N.smartStaticBatching,withSAG:N.withSAG,withSceneGraph:N.withSceneGraph,edgeTransparency:N.edgeTransparency,sharedBuffers:N.sharedBuffers,noMeshInRAM:N.noMeshInRAM,unlinkToSG:N.unlinkToSG,applicativeContainers:N.applicativeContainers?N.applicativeContainers:null,launched:false,processText:N.processText};this.modelsToLoad[this.loadIndex++]=G;this.modelsToLoadCount++;if(this.workers){if((this.currentDownload<this.maxParrallelDownload)&&this.workerActivate){this.internalLoad(this.loadIndex-1)}}else{if(!this.isWorkerLoading){this.type="cgr";this.isWorkerLoading=true;var I;I=[r,p,h,l,a];j.getWorkerBlobFromSpecs(I,function(Q){L.workers=[];L.workerJobs=[];L.urlToRevoke=Q;for(var O=0;O<L.nbWorkers;++O){L.workers[O]=new Worker(Q);L.workerJobs[O]=[];L.workers[O].onerror=function(R){console.log("error worker"+R)};var P=0;(function(R){L.workers[R].onmessage=function(Z){var X=Z.data;if(X.error&&X.loadIndex){var U=L.modelsToLoad[X.loadIndex];if(U.errorCallback){U.errorCallback(X)}return}if(X.loaded){L.workersLoaded.push(R);if(!L.workerActivate){L.workerActivate=true;for(var V in L.modelsToLoad){if(L.currentDownload<L.maxParrallelDownload){if(L.modelsToLoad[V].launched===false){L.internalLoad(V)}}else{break}}}}else{L.workerJobs[R].shift();var U=L.modelsToLoad[Z.data.loadIndex];var T={processText:U.processText,edgeTransparency:U.edgeTransparency,sharedBuffers:U.sharedBuffers,noMeshInRAM:U.noMeshInRAM,fromCGR:true,primitiveWithBS:U.primitiveWithBS,unlinkToSG:U.unlinkToSG,withSAG:U.withSAG};var S=u.processData([U.destinationNode],X,undefined,U.withSceneGraph,T);if(L.renderCallbackFunc!==null){var Y=performance.now();var W=(z<0||(Y-z>=200000));if(W){L.renderCallbackFunc({hack:true,updateInfinitePlane:true});z=Y}}if(U.readyCallback){U.readyCallback({nodes:S})}if(X.applicativesContainers){v(X.applicativesContainers,U.applicativeContainers,U.destinationNode)}delete L.modelsToLoad[Z.data.loadIndex];L.modelsToLoadCount--;E=[];if(L.modelsToLoadCount==0){if(L.renderCallbackFunc!==null){L.renderCallbackFunc({hack:true,updateInfinitePlane:true,reframe:true})}if(U.doneCallback){U.doneCallback({isLast:true})}}E=[];if(!L.keepLoader&&Object.getOwnPropertyNames(L.modelsToLoad).length==0){L.abort()}else{for(var V in L.modelsToLoad){if(L.currentDownload<L.maxParrallelDownload){if(L.modelsToLoad[V].launched===false){L.internalLoad(V)}}else{break}}}U=null}}})(O)}})}}};this.loadUVR=function(G,J,H,F,I){this.load(G,J,H,F,I);return};q.prototype.abort=function(){if(this.workers){for(var F=0;F<this.workers.length;++F){this.workers[F].terminate();this.workers[F]=null}window.URL.revokeObjectURL(this.urlToRevoke)}this.workers=null;this.urlToRevoke="";this.isWorkerLoading=false;this.modelsToLoad={};this.modelsToLoadCount=0;this.workersLoaded=[];this.workerActivate=false;this.cleanLoader()}};return q});define("DS/Visualization/SceneGraphTree",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/SceneGraph","DS/Controls/Tree","DS/Controls/TreeNode","DS/Controls/Tile","DS/CoreEvents/Events"],function(b,c,k,d,h,l,e,a){var f=d.getWebappsAssetUrl("Visualization","icons/");var n=false;var m=function(p){var o=p.node;return !o.productType||(o.productType!=="ReferenceRep"&&o.productType!=="InstanceRep")};var j=function(){if(this.isExpanded()){return}var s,r;var w=this.getChildren().length?this.getNthChild(0):null;var t=this.options.tree.options.viewer;if(w&&(w.options.label==="__dummy__")){this.removeChildren();var C=this.options.pathElement;var p=C.getLastElement();if(p instanceof h){var q=C._getUniqueOccurrence(t);if(!q){return}for(s=0;s<q.children.length;s++){var z=q.children[s];if((!n||(n&&m(z)))&&z.node.getVisibilityInTree()){var v=z.node._occurrences;var y="",s;var x=z.node._iconInTree?z.node._iconInTree:(f+"SWXUiConvertEntitiesHeader.png");if(z.node.isInstance()){for(r=0;r<v.length;r++){if(v[r]===z){break}}y=" (inst_"+r+")"}var u=C.clone();u.addElement(z.node);var A=z.node.name+y;if(A===""){A="-"}var o=new WUX.Controls.TreeNode({backgroundColor:"rgba(255, 255,255,0.5)",label:A,pathElement:u,icons:[x],renderSaver:0});this.addChild(o);if(!z._getVisible()){o.options.UI=UWA.extend(UWA.clone(this.getTree().options.UI,"false"),{label:{filter:"grayscale(100%)",opacity:0.3}})}else{o.options.UI=this.getTree().options.UI}if(z.children.length){var B=new WUX.Controls.TreeNode({label:"__dummy__"});o.addChild(B);o.onPreExpand(j)}}}}}};var g=b.extend({init:function(o,q){var p={viewer:q};this.tree=new WUX.Controls.Tree(p);this.tree.inject(document.body);var s=null;var r=this;this.toUnsubscribe=c.subscribe({event:"/VISU/onSceneGraphUpdate"},function(O){if(!r._sg){return}var I=O.fromNode,x=O.toNode,K,J;var G=[];for(K=0;K<I._occurrences.length;K++){var P=I._occurrences[K];var E=new e();E.setFromOccurrence(P);if(E){G.push(E)}}var v=[];for(K=0;K<G.length;K++){var E=G[K];var F=r.getTreeNode(E);if(F){v.push(F)}}var z=[];for(K=0;K<v.length;K++){var F=v[K];if(!x){if(O.eventType==="CHANGEICON"){F.setIcon({picture:I._iconInTree})}else{if(O.eventType==="CHANGENAME"){F.setLabel(I.name)}else{if((O.eventType==="SHOWTREE")||(O.eventType==="HIDETREE")){r._applyVisibilityToTreeNodes(F,I._occurrences[K])}}}continue}var y=F.getChildren();var w=(y&&y.length)?F.getNthChild(0):null;if(w&&(w.options.label==="__dummy__")){continue}else{if(y){var D=F.getPathElement?F.getPathElement():null;if(!D&&F.options&&F.options.pathElement){D=F.options.pathElement}if((O.eventType==="REMOVE")||(O.eventType==="REMOVETREE")){var C=F.getChildren().length;for(J=0;J<C;J++){var A=F.getNthChild(J);if(!A.getPathElement()){continue}var H=A.getPathElement().getLastElement();if(H===x){z.push({fromNode:F,toNode:A})}}}else{if(((O.eventType==="ADD")||(O.eventType==="ADDTREE"))&&x.getVisibilityInTree()){var u=D.clone();u.addElement(x);var t=x.name;if(t===""){t="-"}var L=x._iconInTree?x._iconInTree:(f+"SWXUiConvertEntitiesHeader.png");var N=new WUX.Controls.TreeNode({backgroundColor:"rgba(255, 255,255,0.5)",label:t,pathElement:u,icons:[L]});F.addChild(N);if(x.children.length){var M=new WUX.Controls.TreeNode({label:"__dummy__"});N.addChild(M);N.onPreExpand(j)}}}}else{var M=new WUX.Controls.TreeNode({label:"__dummy__"});F.addChild(M);F.onPreExpand(j)}}}for(K=0;K<z.length;K++){var B=z[K];B.fromNode.removeChild(B.toNode,false)}});return this},setSceneGraph:function(p){this._sg=null;var o=this.tree.getRoots();var s=null;if(o.length){s=this.tree.getNthRoot(0);s.removeChildren();s.collapse();if(s._updateView){s._updateView(true)}}else{var r=null;if(p instanceof a){r=p._private_root._occurrences[0]}else{r=p._occurrences[0]}var t=new e();t.setFromOccurrence(r);var u=r.node.name;if(u===""){u="-"}this.tree.addRoot({backgroundColor:"rgba(255, 255, 255, 0.498039)",label:u,pathElement:t,icons:[f+"SWXUiCustomizeHeader.png"]});s=this.tree.getNthRoot(0)}var q=new WUX.Controls.TreeNode({label:"__dummy__"});s.addChild(q);s.onPreExpand(j);this._sg=p},getTreeNode:function(p){var o=this.tree.getNthRoot(0);if(!o){return}var q={node:null};this.traverse(o,function(s,t){var r=s.getPathElement?s.getPathElement():null;if(!r&&s.options&&s.options.pathElement){r=s.options.pathElement}if(r){if(r.isEqual(p)){t.node=s;return true}}return false},q);return q.node},traverse:function(r,t,s){var q,p,o=false;o=t(r,s);p=r.getChildren()?r.getChildren().length:0;if(!o){for(q=0;q<p;q++){o=this.traverse(r.getNthChild(q),t,s);if(o){break}}}return o},dispose:function(){c.unsubscribe(this.toUnsubscribe);this.toUnsubscribe=null;this.tree.remove();this._sg=null},_applyVisibilityToTreeNodes:function(q,p){if(!q||!p){return}if(!p._getVisible()){q.options.UI=UWA.extend(UWA.clone(q.getTree().options.UI,"false"),{label:{filter:"grayscale(100%)",opacity:0.3}})}else{q.options.UI=q.getTree().options.UI}for(var o=0;o<p.children.length;o++){this._applyVisibilityToTreeNodes(q.getNthChild(o),p.children[o])}q._updateView(true)}});return UWA.namespace("THREEDS/SceneGraphTree",g)});define("Visualization/SceneGraphTree",["DS/Visualization/SceneGraphTree","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/SceneGraphTree");return b});define("DS/VisuLoaders/OBJReader",["DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/VisuLoaders/OBJMTLLoader","DS/VisuLoaders/SceneGraphConverter"],function(e,b,a,f,c){var d=function(k,n){var m,g,j,l,h;m=k;g=(n!==undefined)?n:null;h=null;this.load=function(p,t,s,o){var r=new e();r.productType="Reference3D";var q=new f();q.addEventListener("load",function(v){var u=v.content;h=new c(m,u);r.add(h.getRootNode());if(g!==null){g({hack:true,updateInfinitePlane:true})}if(o){o()}});q.load(p);if(t){t(r)}}};return d});define("Visualization/OBJReader",["DS/Visualization/OBJReader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/OBJReader");return b});define("DS/VisuUnstreamers/CGRUnstreamTask",["UWA/Class","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/VisuLoaders/CGRReader"],function(b,d,c,h){var e=null;var a=0;var j=[];var g=[];var f=b.extend({init:function(l,k){this.streamObject=l;this.targetNode=k;this.contextID=a++;j[this.contextID]={so:this.streamObject,target:this.targetNode};return this},run:function(p,k,m,l){j[this.contextID].cbProgress=p;j[this.contextID].cbError=m;j[this.contextID].cbDone=k;j[this.contextID].options=l;j[this.contextID].modelLoaded=false;var n=this;if(!this.targetNode){console.error("CGRUnstreamTask execution failed : target node undefined !");return}var o={launched:false};g[this.contextID]=o;if(e===null){e=new h()}if(e){this.internalLoad()}},internalLoad:function(){for(var k in g){if(g[k].launched===false){g[k].launched=true;this.loadCGR(k)}}},loadCGR:function(l){var n=j[l].so;var m=j[l].options;m.isBuffer=true;var k={readyCallback:j[this.contextID].cbProgress,errorCallback:j[this.contextID].cbError,doneCallback:j[this.contextID].cbDone};n.open();n.readAsArrayBuffer(function(o){e.load(o,k,m)})}});return UWA.namespace("THREEDS/CGRUnstreamTask",f)});define("VisuUnstreamers/CGRUnstreamTask",["DS/VisuUnstreamers/CGRUnstreamTask","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("VisuUnstreamers/CGRUnstreamTask");return b});define("DS/SceneGraphNodes/CSS2DNodeManager",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/SceneGraphNodes/CSS2DNode"],function(c,a,e,d,b){var f=c.extend({options:{},init:function(g){this.billboards=[];this._divLayers=[];this.mainLayer=document.createElement("div");this.mainLayer.id="HTMLBillboards";g.divCss2DElement.appendChild(this.mainLayer);this.viewer=g;this.rank=4;this._subscribe();this.update()},add:function(h,g){if(!(h instanceof b)){return error.log("This is not a CSS2DNode")}h.rank=g?g.rank||0:0;h.vanish=g?g.vanish||false:false;this.billboards.push(h);if(!this._divLayers[h.rank]){this._divLayers[h.rank]=document.createElement("div");this._divLayers[h.rank].id="layer-"+h.rank;this.mainLayer.appendChild(this._divLayers[h.rank])}this._divLayers[h.rank].appendChild(h.css2DNode.element);this.update()},remove:function(g){if(this.billboards.indexOf(g)!==-1){this.billboards.splice(this.billboards.indexOf(g),1)}},update:function(){this.cameraPosition=this.viewer.viewpoints[0].camera.position;var j=this.viewer.getSceneBoundingSphere();this.centerScene=j.center;this.fadingDistance=j.radius;var h=0;var g=this.billboards.length;for(h=0;h<g;++h){this._follow3D(this.billboards[h])}this._zIndexManager()},_subscribe:function(){var g=this;a.subscribe({event:"/VISU/"},function(h){if(h.eventType==="@onViewpointChange"){g.update.call(g)}});a.subscribe({event:"/VISU/onWindowResized"},function(h){g.update.call(g)})},_follow3D:function(j){if(j.css2DNode.visible){j.css2DNode.element.style.display="initial";if(j.rank>this.rank){j.css2DNode.element.style.display="none";return}if(j.vanish){var h=j.css2DNode.position.clone().distanceTo(this.cameraPosition);var g=1-(h-this.fadingDistance*5)/(this.fadingDistance*15-this.fadingDistance*5);if(g<0){j.css2DNode.element.style.display="none"}else{if(g<1){j.css2DNode.element.style.opacity=g}}}}},_zIndexManager:function(){var k=this.cameraPosition;this.billboards.sort(function(l,m){return k.distanceTo(m.css2DNode.position)-k.distanceTo(l.css2DNode.position)});var h=0;var g=this.billboards.length;var j=null;for(h=0;h<g;++h){this.billboards[h].css2DNode.element.style["z-index"]=h}}});return f});define("SceneGraphNodes/CSS2DNodeManager",["DS/SceneGraphNodes/CSS2DNodeManager","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/CSS2DNodeManager");return b});define("DS/Visualization/CGRReader",["DS/VisuLoaders/CGRReader"],function(a){return a});define("Visualization/CGRReader",["DS/Visualization/CGRReader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/CGRReader");return b});define("DS/VisuLoaders/ParticlesLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/Visualization/GeometryHelper","DS/Visualization/Utils","DS/Visualization/ProxyAbstraction","DS/Animation/PropertyAnimation","DS/Visualization/SceneGraphFactory"],function(f,d,b,h,a,j,c,e){var g=function(p,o){var l=p;var k=(o!==undefined)?o:null;var m=[];var n=null;this.load=function(s,v,u,r){var t=new j();a.setProxyFromSpec(s,t);var q=s.serverurl?s.serverurl:"";q+=s.filename?s.filename:"";t.executeGetHttpRequest(q,"text",null,function(W){var z=JSON.parse(W);if(1){var B=new f.ShaderMaterialDS({side:f.FrontSide,transparent:true,blending:f.NormalBlending,defines:{MAX_STEPS:256,TM_MIN:0.05,EPS:0.0001,PI:3.14159265,HALFPI:1.57079633,ROOTTHREE:1.73205081},uniforms:{nbCol:{type:"i",value:0},map:{type:"t",value:null},mapDim:{type:"v3",value:new f.Vector3()},uTMK:{type:"f",value:16},modelMatrixInv:{type:"m4",value:new f.Matrix4()}},vertexShaderPars:["varying vec3 worldPos;","varying vec3 objPos;","varying vec3 camPosLocal;","uniform mat4 modelMatrixInv;"].join("\n"),vertexShaderBody:[f._DefaultShaderChunk.model_view_transformation_vertex,f._DefaultShaderChunk.model_view_normal_vertex,"gl_Position = projectionMatrix * mvPosition;","worldPos = ( modelMatrix * vec4(position, 1.0) ).xyz;","objPos = position;","camPosLocal = (modelMatrixInv * vec4(cameraPosition, 1.0)).xyz;"].join("\n"),fragmentShaderPars:["varying vec3 worldPos;","varying vec3 objPos;","varying vec3 camPosLocal;","uniform int nbCol;","uniform sampler2D map;","uniform vec3 mapDim;","uniform float uTMK;","float stepSize;","float nbTexelsX;","float nbTexelsY;","const vec3 weight = vec3(1.0, 0.04, 0.01);","vec4 sampleVolTex(vec3 pos) {","float rowID = floor(pos.z / float(nbCol));","float rowID2 = rowID;","float colID = mod(floor(pos.z), float(nbCol));","float colID2 = mod(ceil(pos.z), float(nbCol));","if (colID2 == 0.0) { rowID2 = rowID2 + 1.0; }","float x1 = colID  * mapDim.x + pos.x;","float x2 = colID2 * mapDim.x + pos.x;","float y1 = rowID  * mapDim.y + pos.y;","float y2 = rowID2 * mapDim.y + pos.y;","vec2 mapUV  = vec2(x1 / nbTexelsX, 1.0 - y1 / nbTexelsY);","vec2 mapUV2 = vec2(x2 / nbTexelsX, 1.0 - y2 / nbTexelsY);","vec4 alpha1 = texture2D(map, mapUV);","vec4 alpha2 = texture2D(map, mapUV2);","return mix(alpha1, alpha2, fract(pos.z));","}","vec4 raymarchNoLight(vec3 ro, vec3 rd) {","vec3 step = rd * stepSize;","vec3 pos = ro;","vec3 col = vec3(0.0);","float tm = 1.0;","for (int i=0; i<MAX_STEPS; ++i) {","vec4 rgba = sampleVolTex(pos);","float dtm = exp( -uTMK * stepSize * dot(rgba.rgb, weight) * 0.01 );","tm *= dtm;","col += (1.0 - 0.995*dtm) * rgba.rgb * rgba.rgb * tm;","pos += step;","if (tm < 0.0 || pos.x > mapDim.x - 1.0 || pos.x < 0.0 || pos.y > mapDim.y - 1.0 || pos.y < 0.0 || pos.z > mapDim.z - 1.0 || pos.z < 0.0)","break;","}","float alpha = 1.0 - tm;","return vec4(col / alpha, alpha);","}"].join("\n"),fragmentShaderBody:["vec3 ro = objPos;","vec3 rd = normalize(ro - camPosLocal);","stepSize = max(mapDim.x, max(mapDim.y, mapDim.z)) * ROOTTHREE / float(MAX_STEPS);","nbTexelsX = float(nbCol) * mapDim.x;","nbTexelsY = float(nbCol) * mapDim.y;","gl_FragColor = raymarchNoLight(ro, rd);"].join("\n")});B.force=true;var D=z.results.length;var H=new f.Vector3(10000,10000,10000);var L=new f.Vector3(-10000,-10000,-10000);for(var K=0;K<D;K++){var C=z.results[K];var S=C.positions;for(var N=0;N<S.length;N++){if(S[N].X<H.x){H.x=S[N].X}if(S[N].Y<H.y){H.y=S[N].Y}if(S[N].Z<H.z){H.z=S[N].Z}if(S[N].X>L.x){L.x=S[N].X}if(S[N].Y>L.y){L.y=S[N].Y}if(S[N].Z>L.z){L.z=S[N].Z}}}var J=new f.Vector3(L.x-H.x+1,L.y-H.y+1,L.z-H.z+1);var w=Math.ceil(Math.sqrt(J.z));m=[];for(var K=0;K<D;K++){m[K]=new Uint8Array(4*w*w*J.x*J.y);for(var N=0;N<w*w*J.x*J.y;N++){m[K][4*N]=0;m[K][4*N+1]=0;m[K][4*N+2]=0;m[K][4*N+3]=0}var C=z.results[K];var S=C.positions;for(var N=0;N<S.length;N++){var V=S[N].X-H.x;var U=S[N].Y-H.y;var T=S[N].Z-H.z;var y=Math.floor(T/w);var M=T%w;var G=(y*J.y+U)*(w*J.x)+M*J.x+V;m[K][4*G]=255*S[N].R;m[K][4*G+1]=255*S[N].G;m[K][4*G+2]=255*S[N].B;m[K][4*G+3]=Math.min(128,255*Math.pow(2*S[N].V,0.8))}}n=new f.DataTexture(m[0],w*J.x,w*J.y,f.RGBAFormat,f.UnsignedByteType,new f.LatLongReflectionMapping(),f.ClampToEdgeWrapping,f.ClampToEdgeWrapping,f.LinearFilter,f.LinearFilter);n.generateMipmaps=false;n.needsUpdate=true;var A=null;var P=function(){this._nbLoops=5;this._duration=50000;this.duration=function(){return this._duration};this.valueAt=function(Y){var Z=this._duration/this._nbLoops;var X=(Y%Z)/Z;return X}};var F=new P();var O=function(Z){var Y=Math.floor(Z*(this.buffer.length));this.map.image.data=this.buffer[Y];this.map.needsUpdate=true;if(A){var X=new f.Matrix4();X.getInverse(A._occurrences[0].renderable.matrixWorld);B.uniforms.modelMatrixInv.value=X}if(k!==null){k()}};var R={map:n,buffer:m,animate:O};var I=new c(R,"animate",F);I.setLoop(1);I.start();B.uniforms.nbCol.value=w;B.uniforms.map.value=n;B.uniforms.mapDim.value.x=J.x;B.uniforms.mapDim.value.y=J.y;B.uniforms.mapDim.value.z=J.z;var x=new h();var E=x.CreateVis3DCuboid({cornerPoint:new f.Vector3(),firstAxis:new f.Vector3(J.x-1,0,0),secondAxis:new f.Vector3(0,J.y-1,0),thirdAxis:new f.Vector3(0,0,J.z-1)});A=e.createMeshNode(E);var Q=new f.Matrix4().makeTranslation(H.x,H.y,H.z);A.setSSAO(false);A.setMatrix(Q);A.setMaterial(B);if(v){v(A)}if(r){r()}return}})}};return g});define("DS/SceneGraphNodes/DirectionalLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(c,a){var b=a.extend({init:function(f,e){if(!f){f={}}var d=new c.DirectionalLight(f.color,f.intensity);if(!f.target){d.target=null}else{d.target=new c.Object3D();d.target.position=f.target}this._previousTarget=d.target;this._parent(d,e);return this},castShadows:function(e,g){var j=this._occurrences.length;if(e){this.light3js.castShadow=true;if(g){var d=false;if(g.bias){this.light3js.shadowBias=g.bias}if(g.left){this.light3js.shadowCameraLeft=g.left}if(g.right){this.light3js.shadowCameraRight=g.right}if(g.bottom){this.light3js.shadowCameraBottom=g.bottom}if(g.top){this.light3js.shadowCameraTop=g.top}if(g.near){this.light3js.shadowCameraNear=g.near}if(g.far){this.light3js.shadowCameraFar=g.far}if(g.darkness){this.light3js.shadowDarkness=g.darkness}if(g.mapWidth){this.light3js.shadowMapWidth=g.mapWidth;d=true}if(g.mapHeight){this.light3js.shadowMapHeight=g.mapHeight;d=true}if(this.light3js.shadowMap&&d){this.light3js.shadowMap.dispose();this.light3js.shadowMap=null;this.light3js.updateShadowMap=true}}for(var h=0;h<j;h++){var f=this._occurrences[h].renderable;f.castShadow=true;if(g){var d=false;if(g.bias){f.shadowBias=g.bias}if(g.left){f.shadowCameraLeft=g.left}if(g.right){f.shadowCameraRight=g.right}if(g.bottom){f.shadowCameraBottom=g.bottom}if(g.top){f.shadowCameraTop=g.top}if(g.near){f.shadowCameraNear=g.near}if(g.far){f.shadowCameraFar=g.far}if(g.darkness){f.shadowDarkness=g.darkness}if(g.mapWidth){f.shadowMapWidth=g.mapWidth;d=true}if(g.mapHeight){f.shadowMapHeight=g.mapHeight;d=true}if(f.shadowMap&&d){f.shadowMap.dispose();f.shadowMap=null;f.updateShadowMap=true}}}}else{this.light3js.castShadow=false;for(var h=0;h<j;h++){this._occurrences[h].renderable.castShadow=false}}},attachToViewpoint:function(d){if(this._attachedToVpt!=d){var f=this._occurrences.length;if(!d){this.light3js.target=this._previousTarget;for(var e=0;e<f;e++){this._occurrences[e].renderable.target=this._previousTarget}}else{this.light3js.target=new c.Object3D();this.light3js.target.position=new c.Vector3(0,0,0);for(var e=0;e<f;e++){this._occurrences[e].renderable.target=new c.Object3D();this._occurrences[e].renderable.target.position=new c.Vector3(0,0,0)}}}this._attachedToVpt=d},setTarget:function(g){var f=null;if(g){var f=new c.Object3D();f.position=g}this.light3js.target=f;this._previousTarget=f;if(!this._attachedToVpt){var e=this._occurrences.length;for(var d=0;d<e;d++){this._occurrences[d].renderable.target=f}}},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"DirectionalLightNode3D"}});return UWA.namespace("THREEDS/Nodes/DirectionalLight",b)});define("SceneGraphNodes/DirectionalLightNode",["DS/SceneGraphNodes/DirectionalLightNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("SceneGraphNodes/DirectionalLightNode");return b});define("DS/Visualization/ParticlesLoader",["DS/VisuLoaders/ParticlesLoader"],function(a){return a});define("Visualization/ParticlesLoader",["DS/Visualization/ParticlesLoader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/ParticlesLoader");return b});define("DS/Gestures/HoldDragGesture",["DS/Gestures/BasicGesture"],function(b){var a=b.extend({init:function(){this._parent();this.priority=100;this.name="HoldDragGesture";return this},detect:function(c){this._parent(c)}});return UWA.namespace("THREEDS/Gestures/HoldDragGesture",a)});define("Gestures/HoldDragGesture",["DS/Gestures/HoldDragGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/HoldDragGesture");return b});define("DS/Visualization/OBJReader",["DS/VisuLoaders/OBJReader"],function(a){return a});define("Visualization/OBJReader",["DS/Visualization/OBJReader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/OBJReader");return b});define("DS/Gestures/HoldTapGesture",["DS/Gestures/BasicGesture"],function(b){var a=b.extend({init:function(){this._parent();this.priority=100;this.name="HoldTapGesture";return this},detect:function(c){this._parent(c)}});return UWA.namespace("THREEDS/Gestures/HoldTapGesture",a)});define("Gestures/HoldTapGesture",["DS/Gestures/HoldTapGesture","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Gestures/HoldTapGesture");return b});define("DS/Visualization/SceneGraphConverter",["DS/VisuLoaders/SceneGraphConverter"],function(a){return a});define("Visualization/SceneGraphConverter",["DS/Visualization/SceneGraphConverter","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/SceneGraphConverter");return b});define("DS/Magnifier/Magnifier",["UWA/Class","UWA/Controls/Abstract","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/VisuEvents/ScreenEvent","DS/VisuEvents/EventsManager"],function(c,h,a,e,d,b,g){var f=h.extend({defaultOptions:{activated:true,viewer:null,dim:83,shiftVector:{x:-40,y:110}},init:function(j){this._parent(j);this._buildView();this.displayed=false;this.enableSelection=false;this.devicePixelRatio=window.devicePixelRatio||1;this.container=this.elements.container;this.content=this.elements.container.firstChild;this.setUpCBs();this.setOption(this.options);this.viewer.divCssElement.appendChild(this.container);this.onRenderCB=null},setOption:function(j){if(j.viewer){this.viewer=j.viewer}if(j.dim){this._setDimension(j.dim)}if(j.shiftVector){this.shiftVector=j.shiftVector}else{this.shiftVector=new e.Vector2()}if(j.activated){this._activate()}else{this._desactivate()}},_buildView:function(){this.elements.container=UWA.Element("div",{id:"magnify-div",html:[{tag:"canvas",id:"magnify-canvas",}],styles:{position:"absolute",display:"none","box-shadow":"-1px 2px 5px 1px rgba(0, 0, 0, 0.7)",border:"1px solid #ccc",}})},_setDimension:function(j){this.devicePixelRatio=window.devicePixelRatio||1;this.dim=(j%2===0)?(j+1):j;this.container.setStyle("width",this.dim);this.container.setStyle("height",this.dim);this.container.setStyle("overflow","hidden");this.container.setStyle("border-radius","50%");this.content.setStyle("width","100%");this.content.setStyle("height","100%");this.content.width=this.dim*(window.devicePixelRatio||1);this.content.height=this.dim*(window.devicePixelRatio||1)},_updateMagnifier:function(j){var m=(window.devicePixelRatio||1);if(m!==this.devicePixelRatio){this.devicePixelRatio=m;this._setDimension(this.dim)}var k={x:this.viewer.renderer.deviceWidth,y:this.viewer.renderer.deviceHeight};var l={x:Math.round(this.dim*m),y:Math.round(this.dim*m)};var n={x:Math.min(Math.max(0,j.xPix+this.shiftVector.x*m),k.x-l.x),y:Math.min(Math.max(0,j.yPix-this.shiftVector.y*m),k.y-l.y)};this.container.show();this.displayed=true;this._renderOffscreen(this.viewer,this.viewer.currentViewpoint,this.content,k,l,j);this.container.setStyles({left:Math.round(n.x/m),top:Math.round(n.y/m)})},_renderOffscreen:function(q,u,m,A,v,s){var x={x:s.xPix-v.x/2,y:s.yPix+v.y/2};var o={data:null,width:v.x,height:v.y,x:Math.round(x.x),y:Math.round(A.y-x.y)};q.renderToTarget(o,u,true);var z=m.getContext("2d");var w=z.getImageData(0,0,v.x,v.y);var t=w.data;for(var n=0;n<w.height;n++){for(var p=0;p<w.width;p++){var k=this._getBufferIndex(p,n,w.width,w.height,false);var r=this._getBufferIndex(p,n,o.width,o.height,true);t[4*k]=o.data[4*r];t[4*k+1]=o.data[4*r+1];t[4*k+2]=o.data[4*r+2];t[4*k+3]=o.data[4*r+3]}}z.putImageData(w,0,0);z.drawImage(z.canvas,0,0,v.x,v.y);var l=Math.floor(v.x/2)+0.5;var y=Math.floor(v.y/2)+0.5;z.fillStyle="rgba(0, 255, 255, 0.5)";z.fillRect(l-2,y-8,4,16);z.fillRect(l-8,y-2,16,4);z.fillStyle="rgba(0, 0, 0, 0.5)";z.fillRect(l-1.5,y-7.5,3,15);z.fillRect(l-7.5,y-1.5,15,3);z.fillStyle="rgba(255, 255, 255, 1)";z.fillRect(l-0.5,y-6.5,1,13);z.fillRect(l-6.5,y-0.5,13,1);if(this.onRenderCB){this.onRenderCB()}},_getBufferIndex:function(m,l,k,n,o){if(o){l=n-l;return k*Math.floor(l-1)+Math.floor(m)}return k*Math.floor(l)+Math.floor(m)},_activate:function(){this.active=true;g.addEvent(this.viewer.canvas,"onLongHold",this.startCB)},_desactivate:function(){this.active=false;g.removeEvent(this.viewer.canvas,"onLongHold",this.startCB)},setUpCBs:function(){var j=this;j.displayed=false;this.startCB=function(k){if(!j.viewer.currentViewpoint.control.isMiddleButtonPressed()&&!j.viewer.currentViewpoint.control.isRightButtonPressed()){j._updateMagnifier(j.viewer.getMousePosition(k.from[0].getCurrentPosition(j.viewer.canvas)));g.addEvent(j.viewer.canvas,"onSwipe",j.moveCB);g.addEvent(j.viewer.canvas,"onRelease",j.endCB)}};this.moveCB=function(k){if(k.from[0].deltaPosition.length()<300){j._updateMagnifier(j.viewer.getMousePosition(k.from[0].getCurrentPosition(j.viewer.canvas)))}else{j.container.hide()}if(k.from[0].offsetPosition.length()>10){j.enableSelection=true}};this.endCB=function(){j.container.hide();g.removeEvent(j.viewer.canvas,"onSwipe",j.moveCB);g.removeEvent(j.viewer.canvas,"onRelease",j.endCB)}}});return f});define("Magnifier/Magnifier",["DS/Magnifier/Magnifier","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Magnifier/Magnifier");return b});define("DS/VisuLoaders/DAEReader",["DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Visualization/ThreeJS_DS","DS/VisuLoaders/ColladaLoader","DS/VisuLoaders/SceneGraphConverter"],function(b,f,j,e,c,a){var g=function(l){var n,k,m,o;k=document.getElementsByTagName("script");for(n=0;n<k.length;n++){m=k.item(n);o=m.getAttribute("src");if(o&&o.match(l)){return o.substring(0,o.lastIndexOf("/")+1)}}return"scripts/ThreeDS/Visualization/"};var d="scripts/ThreeDS/Visualization/";var h=function(n,r){var q,u,t,l,s,k,p,v,m;q=n;u=(r!==undefined)?r:null;t=null;l=null;k=null;m=null;function o(){t=null;l=null;k=null;s="";p=null;v=null}this.loadFromSpec=function(x,z,y,w){this.load(x,z,y,w,true)};this.load=function(y,B,A,w,x){o();s=y;if(B!==undefined){t=B}if(w!==undefined){l=w}p=new b();if(k===null){k=new c();k.options.convertUpAxis=true;if(this.waitMaterial){k.options.waitMaterial=this.waitMaterial}var z=x?k.loadFromSpec:k.load;z(y,function(C){m=new a(q,C.scene);p.addChild(m.getRootNode());v=C.skins[0];if(u!==null){u({hack:true,updateInfinitePlane:true})}if(l!==null){l()}});if(t){t(p)}}};this.setWaitMaterial=function(w){this.waitMaterial=w}};return h});define("DS/Visualization/AnnotationServices",["UWA/Class","DS/Visualization/Utils","DS/Formats/CGRFile","DS/Visualization/ModelLoader","DS/Visualization/ProxyAbstraction","DS/ZipJS/LoaderInflate"],function(b,g,h,e,f,d){var a=null,c=b.extend({init:function(){if(a!==null){this.loader=a.loader;this.modelLoader=a.modelLoader;return this}this.loader=new h();this.modelLoader=new e();a=this;return this},cleanAll:function(){this.loader=null;this.modelLoader=null},getApplicativeContainer:function(k,j,l,n,p){if(p){var r=this.modelLoader.buildPath(k);var s=new f();g.setProxyFromSpec(r,s);var t=r.serverurl?r.serverurl:"";t+=r.filename?r.filename:"";var m=this;var o=function(u){return function(w){m.loader.setFileBuffer(new Uint8Array(w));var v=m.loader.getApplicativeContainerOld(u);l(v)}};var q=o(j);s.executeGetHttpRequest(t,"arraybuffer",null,q,n)}else{this.getFTAContainer(k,j,l,n)}},getApplicativeContainerNew:function(k,j,l,n){var q=this.modelLoader.buildPath(k);var r=new f();g.setProxyFromSpec(q,r);var s=q.serverurl?q.serverurl:"";s+=q.filename?q.filename:"";var m=this;var o=function(t){return function(v){m.loader.setFileBuffer(new Uint8Array(v));var u=m.loader.getApplicativeContainer(t);l(u)}};var p=o(j);r.executeGetHttpRequest(s,"arraybuffer",null,p,n)},processFTABuffer:function(m){var j=function(w){var r,t,q,v,u,s;r="";q=w.length;t=0;while(t<q){v=w[t++];switch(v>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:r+=String.fromCharCode(v);break;case 12:case 13:u=w[t++];r+=String.fromCharCode(((v&31)<<6)|(u&63));break;case 14:u=w[t++];s=w[t++];r+=String.fromCharCode(((v&15)<<12)|((u&63)<<6)|((s&63)<<0));break}}return r};if(!m){return null}var k=m.buffer.subarray(m.options.offset,m.options.compressed+m.options.offset);if(k.length<=2){return null}if(k[0]!==120){return null}if(k[1]!==218){return null}var p=2;var l=k.subarray(p,m.options.compressed);var n=new d();var o=n.Inflate(l);return j(o)},getFTAContainer:function(k,l,o,m){var p=this;var j=function(r){var q=p.processFTABuffer(r);if(q){o({xml:q})}else{o()}};var n=this.getApplicativeContainerNew(k,l,j,m)},openSceneGraph:function(j){return this.loader.openSceneGraph(j)}});return UWA.namespace("THREEDS/AnnotationServices",c)});define("Visualization/AnnotationServices",["DS/Visualization/AnnotationServices","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/AnnotationServices");return b});define("DS/Visualization/DAEReader",["DS/VisuLoaders/DAEReader"],function(a){return a});define("Visualization/DAEReader",["DS/Visualization/DAEReader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/DAEReader");return b});define("DS/VisuLoaders/JSONReader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/VisuLoaders/SceneGraphConverter"],function(f,g,c,b,e){var h=function(k){var m,j,l,n;j=document.getElementsByTagName("script");for(m=0;m<j.length;m++){l=j.item(m);n=l.getAttribute("src");if(n&&n.match(k)){return n.substring(0,n.lastIndexOf("/")+1)}}return"scripts/ThreeDS/Visualization/"};var a="scripts/ThreeDS/Visualization/";var d=function(l,p){var o,s,r,j,q,t,n,u,k;o=l;s=(p!==undefined)?p:null;r=null;j=null;t=null;k=null;function m(){r=null;j=null;t=null;q="";n=null;u=null}this.load=function(w,y,x,v){m();q=w;if(y!==undefined){r=y}if(v!==undefined){j=v}n=new g();if(t===null){t=new f.JSONLoader();t.load(w,function(A,z){k=new e(o,new f.Mesh(A,(z&&z.length)?z[0]:null));n.add(k.getRootNode());if(s!==null){s({hack:true,updateInfinitePlane:true})}if(j!==null){j()}});if(r){r(n)}}}};return d});define("DS/Plugins/CSSNodesPass",["DS/Visualization/ThreeJS_DS"],function(b){var a=function(d,c){this.scene=d;this.name=c;this.cameraName="main"};a.prototype={getDefaultState:function(){return{enabled:false,renderPlugins:false}},setScene:function(c){this.scene=c},render:function(h,k,e,j,g,l,c,m,f){var d=c[m];h.updateCSSNodes(this.scene,d)}};return a});define("DS/Effects/ConvertCubemapToLatlong",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/NothingShader","DS/Shaders/ConvertCubemapToLatlongShader","DS/Shaders/DisplayIrradianceMapShader","DS/Shaders/EncodeHDRShader"],function(h,c,e,b,f,d,a,g){var j=c.extend({init:function(l,k){this._parent(l);this.gl=this.renderer.context;this.renderTargetPool=k;this.passConvert=null;this.texture=null;this.passDisplayLatlongMap=null;this.saveComposer=null;this.passEncodeHDR=null;return this},setEnvMap:function(o,l){this.texture=o;var m=2*parseInt(this.texture.width);var k=parseInt(this.texture.width);this.width=m;this.height=k;if(this.composers[1]){this.composers[1].setSize(m,k)}else{var n=new h.WebGLRenderTargetProperties(m,k,"linear");n.generateMipmaps=false;n.mapping=this.texture.mapping;this.composers[1]=new e(this.renderer,n,this.renderTargetPool);this.composers[1].composerContext.keepResult=true;d.ConvertCubemapToLatlong.defines.ORIENTATION=(l&&l>0)?1:0;this.passConvert=new b(d.ConvertCubemapToLatlong);this.composers[1].addPass(this.passConvert)}this.passConvert.uniforms.cubemap.value=this.texture;if(this.composers[0]){this.composers[0].setSize(this.width,this.height)}else{var n=new h.WebGLRenderTargetProperties(this.width,this.height,"uint");n.generateMipmaps=false;n.mapping=this.texture.mapping;this.composers[0]=new e(this.renderer,n,this.renderTargetPool);this.composers[0].composerContext.keepResult=false;this.passDisplayLatlongMap=new b(a);this.composers[0].composerContext.setPassRenderToCanvas(this.passDisplayLatlongMap,true);this.composers[0].addPass(this.passDisplayLatlongMap);this.composers[1].linkToShaderPassUniform(this.passDisplayLatlongMap,this.passDisplayLatlongMap.uniforms.tDiffuse1)}},execute:function(){this.composers[1].render()},getResult:function(l){var k=this.composers[1].composerContext.getResult(undefined,l);k.hdr=true;k.mapping=new h.LatLongReflectionMapping();return k},getResultRGBE:function(l){this.encodeRGBE();var k=this.saveComposer.composerContext.getResult(undefined,l);k.hdr=true;k.mapping=new h.LatLongReflectionMapping();return k},encodeRGBE:function(){var l=this.composers[1];var m=l.composerContext.renderTargetProperties.width;var k=l.composerContext.renderTargetProperties.height;if(this.saveComposer){this.saveComposer.setSize(m,k)}else{var n=new h.WebGLRenderTargetProperties(m,k,"nearest");n.generateMipmaps=false;n.mapping=this.texture.mapping;this.saveComposer=new e(this.renderer,n,this.renderTargetPool);this.saveComposer.composerContext.keepResult=true;this.passEncodeHDR=new b(g);this.saveComposer.composerContext.setPassRenderToCanvas(this.passEncodeHDR,false);this.saveComposer.addPass(this.passEncodeHDR)}this.passEncodeHDR.uniforms.map.value=l.composerContext.renderTarget2;this.saveComposer.render()}});return j});define("DS/Visualization/WebGLV6Renderer",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/CompositeShader","DS/Shaders/MirrorShaders","DS/Shaders/BloomShaders","DS/Effects/FXAAEffect","DS/Effects/MLAAEffect","DS/Effects/MSAAEffect","DS/Effects/SMAAEffect","DS/Effects/HighlightEffect","DS/Effects/VignettingEffect","DS/Effects/SSAO2Effect","DS/Effects/SSAO2IterativeEffect","DS/Effects/SSLREffect","DS/Effects/BokehDOFEffect","DS/Effects/ToneMappingEffect","DS/Effects/FlareEffect","DS/Effects/DebugPassEffect","DS/Effects/DebugShadowMapsEffect","DS/Shaders/DeferredShaders","DS/Effects/PreHighlightEffect","DS/Plugins/ComposerContext","DS/Plugins/ClearPass","DS/Visualization/RenderTargetPool","DS/Plugins/PluginPass","DS/Shaders/StereoShaders","DS/CoreEvents/Events","DS/Effects/OITEffect","DS/Plugins/CSSNodesPass","DS/Visualization/BoundingBoxGPUCompute"],function(C,I,G,f,H,v,t,E,A,r,k,m,B,u,n,e,x,s,h,b,q,p,J,y,j,g,d,w,c,z,a,F,o){var D=-1;var l=C.extend({init:function(M){this.useCompositing=M.useCompositing!==undefined?M.useCompositing:true;this.NoOperator=0;this.SimpleOperator=1;this.LinearOperator=2;this.ReinhardOperator=3;this.FilmicOperator=4;this.UnchartedOperator=5;if(M.canvas===undefined){return}this.canvas=M.canvas;this.divCSS=M.divCSS;this.useOffscreenCanvas=M.useOffscreenCanvas;this.bgColor=M.bgColor!==undefined?M.bgColor:0;this.bgAlpha=M.bgAlpha!==undefined?M.bgAlpha:1;this.setBackgroundColor(this.bgColor,this.bgAlpha);this.antiAliasing=M.antiAliasing!==undefined?M.antiAliasing:"NoAA";if(!this.useOffscreenCanvas){this.cssWidth=Math.max(2,M.canvas.offsetWidth);this.cssHeight=Math.max(2,M.canvas.offsetHeight)}else{this.cssWidth=Math.max(2,M.canvas.width);this.cssHeight=Math.max(2,M.canvas.height)}this.devicePixelRatio=window.devicePixelRatio||1;this.deviceWidth=Math.floor(this.devicePixelRatio*this.cssWidth);this.deviceHeight=Math.floor(this.devicePixelRatio*this.cssHeight);this.viewportWidth=this.deviceWidth;this.viewportHeight=this.deviceHeight;this.brightness=M.brightness!==undefined?M.brightness:1;this.tonemapping=M.tonemapping!==undefined?M.tonemapping:1;this.disableBackFaceCulling=false;this.visibleSpace=M.visibleSpace!==undefined?M.visibleSpace:1;this.useOIT=false;this.renderer=new I.WebGLRenderer({context:M.context,alpha:true,premultipliedAlpha:false,antialias:(this.antiAliasing===true),canvas:this.canvas,divCSS:this.divCSS,visibleSpace:this.visibleSpace,preserveDrawingBuffer:M.preserveDrawingBuffer,debugContext:M.debugContext,sortRenderListByBuffer:true});this.renderTargetPool=new d(this.renderer);if(!this.useOffscreenCanvas){this.renderer.setGLSize(this.cssWidth,this.cssHeight,this.cssWidth,this.cssHeight)}else{this.renderer.setGLSize(Math.max(2,this.canvas.width),Math.max(2,this.canvas.height),this.viewportWidth,this.viewportHeight)}this.renderer.setClearColorHex(0,0);this.renderer.gammaInput=true;this.renderer.gammaOutput=!this.useCompositing;this.renderer.autoClear=false;this.renderer.shadowMapCascade=false;this.renderer._gpuPickingTolerance=2;this.renderer._smallTargetPicking=I.mobileVersion;this.gl=this.renderer.context;this.info={memory:new I.MemoryInfo(),render:new I.RenderInfo()};this.compPickingGPU=null;this.compDepth=null;this.compNormal=null;this.compNormalDepth=null;this.compMirror=null;this.compForward=null;this.composers=[];this.passPickingGPU=null;this.passDepth=null;this.passNormal=null;this.passColor=null;this.passNormalDepth=null;this.passMirror=null;this.passMirrorBlur=null;this.passMirrorBlur1=null;this.passMirrorBlur2=null;this.passMirrorBlur3=null;this.infPlanePass=null;this.mirrorBlendPass=null;this.shadowPass=null;this.zPrePass=null;this.forwardPass=null;this.ZOnlyPass=null;this.backgroundPass=null;this.highlightSinglePass=null;this.passLightFullscreen=null;this.passLightProxy=null;this.OITEffect=null;this.PreHighlightEffect=null;this.BokehDOFEffect=null;this.ToneMappingEffect=null;this.FlareEffect=null;this.HighlightEffect=null;this.VignettingEffect=null;this.SSAOEffect=null;this.SSAOIterativeEffect=null;this.SSLREffect=null;this.FXAAEffect=null;this.MLAAEffect=null;this.SMAAEffect=null;this.MSAAEffect=null;this.DebugPassEffect=null;this.DebugShadowMapsEffect=null;this.customEffects=[];this.allEffects=[];this.forwardPassStateSortingResult=null;this.sectionCappingEnabled=false;this.meshesGPU={};this.positionsGPU={};this.normalsGPU={};this.currentGPUPickPosition={x:-1,y:-1};var N=I.FloatType;var L=I.LinearFilter;if(!this.renderer.supportsFloatTextures()){N=I.UnsignedByteType}if(!this.renderer.supportsFloatLinearTextures()){L=I.NearestFilter}this.rtParamsFloatLinear={minFilter:L,magFilter:L,stencilBuffer:true,format:I.RGBAFormat,type:N};this.rtParamsFloatNearest={minFilter:I.NearestFilter,magFilter:I.NearestFilter,stencilBuffer:false,format:I.RGBAFormat,type:N};this.rtParamsFloatNearestStencilBuffer={minFilter:I.NearestFilter,magFilter:I.NearestFilter,stencilBuffer:true,format:I.RGBAFormat,type:N};this.rtParamsUByteNearest={minFilter:I.NearestFilter,magFilter:I.NearestFilter,stencilBuffer:false,format:I.RGBAFormat,type:I.UnsignedByteType};this.rtParamsUByteWithStencilBuffer={minFilter:I.NearestFilter,magFilter:I.LinearFilter,stencilBuffer:true,format:I.RGBAFormat,type:I.UnsignedByteType};this.rtParamsUByte2={minFilter:I.LinearFilter,magFilter:I.LinearFilter,stencilBuffer:false,format:I.RGBAFormat,type:I.UnsignedByteType};this.boundingBoxGPUCompute=new o(this);var K=["-->(initClear)","initClearPass","-->infPlane","infPlanePass","mirrorClearDepth","mirrorBlendPass","afterMirrorClearDepth","shadowPass","-->main","backgroundPass","renderPriorityClear","renderPriorityStencilP4","renderPriorityStencilP3","renderPriorityStencilP2","renderPriorityStencilP1","renderPriorityStencilP0","renderPriorityDrawP3","renderPriorityDrawP2","renderPriorityDrawP1","renderPriorityDrawP0","passSectionCappingFrontFaces","cssPass","zPrePass","forwardPass","ZOnlyPass","oitPass","lensFlarePass","-->(postEffects1)","passMirrorBlur","passMirrorBlur1","passMirrorBlur2","passMirrorBlur3","SSAOEffect","SSAO2IterativeEffect","SSAOIterativeEffect","compareModelPass","-->noz","noEffectNozClearPass","noEffectNozPass","-->(postEffects2)","compositePass","SSLREffect","BokehDOFEffect","FlareEffect","MSAAEffect","HighlightEffect","PreHighlightEffect","highlightClearPass","highlightSinglePass","DebugPassEffect","DebugShadowMapsEffect","-->afterHighlightNoz","noEffectAfterHighlightNozClearPass","noEffectAfterHighlightNozPass","-->robot","noEffectRobotClearPass","noEffectRobotPass","noEffectRobotOrthoPass","-->(postEffects3)","VignettingEffect","FXAAEffect","MLAAEffect","SMAAEffect","-->canvas2D","noEffectCanvas2DPass"];this.mainComposer=new G(this.renderer,undefined,this.renderTargetPool,K);this.initForwardRender();this.highlightPass=null;this.pickingGPUComposerContext=null;this.normalComposerContext=null;this.depthComposerContext=null;this.normalDepthComposerContext=null;this.outlineDepthComposerContext=null;this.clippingScene=null;this.superFinalComposer=null;this.customComposerContexts=null},initEffect:function(K){if(I.mobileVersion){return null}if(!this.useCompositing){if((K!=="Highlight")&&(K!=="PreHighlight")&&(K!=="SSAO")){return null}}var L=null;switch(K){case"OIT":this.OITEffect=new a(this.renderer,this.renderTargetPool,this.forwardPassStateSortingResult);L=this.OITEffect;break;case"FXAA":this.FXAAEffect=new A(this.renderer,this.renderTargetPool);L=this.FXAAEffect;break;case"MLAA":this.MLAAEffect=new r(this.renderer,this.renderTargetPool);L=this.MLAAEffect;break;case"MSAA":this.MSAAEffect=new k(this.renderer,this.renderTargetPool);L=this.MSAAEffect;break;case"SMAA":this.SMAAEffect=new m(this.renderer,this.renderTargetPool);L=this.SMAAEffect;break;case"Vignetting":this.VignettingEffect=new u(this.renderer,this.renderTargetPool);L=this.VignettingEffect;break;case"Highlight":this.HighlightEffect=new B(this.renderer,this.renderTargetPool,!this.useCompositing);L=this.HighlightEffect;break;case"PreHighlight":this.PreHighlightEffect=new y(this.renderer,this.renderTargetPool);L=this.PreHighlightEffect;break;case"SSAO":this.SSAOEffect=new n(this.renderer,this.renderTargetPool);L=this.SSAOEffect;break;case"SSAOIterative":this.SSAOIterativeEffect=new e(this.renderer,this.renderTargetPool);L=this.SSAOIterativeEffect;break;case"SSLR":this.SSLREffect=new x(this.renderer,this.renderTargetPool);L=this.SSLREffect;break;case"DOF":this.BokehDOFEffect=new s(this.renderer,this.renderTargetPool);L=this.BokehDOFEffect;break;case"Bloom":break;case"ToneMapping":this.ToneMappingEffect=new h(this.renderer,this.renderTargetPool);L=this.ToneMappingEffect;break;case"Flare":this.FlareEffect=new b(this.renderer,this.renderTargetPool);L=this.FlareEffect;break;case"DebugPass":this.DebugPassEffect=new q(this.renderer,this.renderTargetPool);L=this.DebugPassEffect;break;case"DebugShadowMaps":this.DebugShadowMapsEffect=new p(this.renderer,this.renderTargetPool);L=this.DebugShadowMapsEffect;break;default:break}if(L!==null){L.updateComposersName(K);L.setSize(this.viewportWidth,this.viewportHeight);L.initEffect(!this.useCompositing,this);this.allEffects.push(L)}return L},setEffect:function(O,L){var N=null;var P=false;if(I.mobileVersion){return}if(!this.useCompositing){if((O!=="Highlight")&&(O!=="PreHighlight")&&(O!=="SSAO")){return}}switch(O){case"OIT":N=this.OITEffect;P=!this.isDeviceCompatibleWithOIT();this.useOIT=L&&!P;this.compForwardComposerContext.needRequiredReadBuffer=this.useOIT;this.zPrePass.isOITPass=this.useOIT;this.forwardPass.isOITPass=this.useOIT;this.renderer.useOIT=this.useOIT;var K=this.forwardPassStateSortingResult;K.getDisplayListByName("TRANSPAR").depthWrite=this.useOIT;K.getDisplayListByName("TRANSPAR1D").depthWrite=this.useOIT;break;case"FXAA":N=this.FXAAEffect;this.antiAliasing=L?O:"NoAA";break;case"MLAA":N=this.MLAAEffect;this.antiAliasing=L?O:"NoAA";break;case"MSAA":N=this.MSAAEffect;this.antiAliasing=L?O:"NoAA";break;case"SMAA":N=this.SMAAEffect;this.antiAliasing=L?O:"NoAA";break;case"FSAA":case"SSAA":if(L){if(this.compMirrorComposerContext){this.compMirrorComposerContext.setSize(2*this.viewportWidth,2*this.viewportHeight)}this.compForwardComposerContext.setSize(2*this.viewportWidth,2*this.viewportHeight)}else{if(this.compMirrorComposerContext){this.compMirrorComposerContext.setSize(this.viewportWidth,this.viewportHeight)}this.compForwardComposerContext.setSize(this.viewportWidth,this.viewportHeight)}this.antiAliasing=L?O:"NoAA";break;case"Vignetting":N=this.VignettingEffect;break;case"Highlight":N=this.HighlightEffect;break;case"PreHighlight":N=this.PreHighlightEffect;break;case"SSAO":N=this.SSAOEffect;P=!this.isDeviceCompatibleWithSSAO();break;case"SSAOIterative":N=this.SSAOIterativeEffect;P=!this.isDeviceCompatibleWithSSAO();break;case"SSLR":N=this.SSLREffect;break;case"DOF":N=this.BokehDOFEffect;break;case"Bloom":N=this.ToneMappingEffect;break;case"ToneMapping":N=this.ToneMappingEffect;break;case"Flare":N=this.FlareEffect;break;case"DebugPass":N=this.DebugPassEffect;break;case"DebugShadowMaps":N=this.DebugShadowMapsEffect;break}if(L&&!P){if(!N){N=this.initEffect(O)}}if(N!==null){var M=L&&!P;(O==="Bloom")?N.setBloom(M):N.setEnabled(M);if(this.compMirrorComposerContext&&O==="OIT"){this.compMirrorComposerContext.enablePass(N.mixPass,this.useOIT);this.compMirrorComposerContext.needRequiredReadBuffer=this.useOIT}M&&N.setSize(this.viewportWidth,this.viewportHeight)}this.updateFinalComposer(true)},getCustomEffect:function(K){return this.customEffects[K]},addCustomEffect:function(K){if(!K){return -1}var L=this.customEffects.length;this.customEffects.push(K);K.updateComposersName("customEffect_"+this.customEffects.length);K.setSize(this.viewportWidth,this.viewportHeight);K.initEffect("",this);return L},setCustomEffect:function(M,K){var L=this.customEffects[M];if(L!==null){L.setEnabled(K);if(K){L.setSize(this.viewportWidth,this.viewportHeight)}}this.updateFinalComposer(true)},updateEffects:function(L,N,O,K){if(this.SSAOEffect&&this.SSAOEffect.enabled){this.SSAOEffect.update("deferred",L,N,O)}if(this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled){this.SSAOIterativeEffect.update("deferred",L,N,O)}if(this.SSLREffect&&this.SSLREffect.enabled){this.SSLREffect.update("deferred",L,N)}if(this.HighlightEffect&&this.HighlightEffect.enabled){this.HighlightEffect.update("forward",L,N,O,K)}if(this.PreHighlightEffect&&this.PreHighlightEffect.enabled){this.PreHighlightEffect.update("forward",L,N,O,K)}if(this.BokehDOFEffect&&this.BokehDOFEffect.enabled){this.BokehDOFEffect.update("deferred",L,N)}if(this.DebugShadowMapsEffect&&this.DebugShadowMapsEffect.enabled){this.DebugShadowMapsEffect.update("forward",L,N)}if(this.MSAAEffect&&this.MSAAEffect.enabled){this.MSAAEffect.update("forward",L,N,O)}for(var M=0;M<this.customEffects.length;M++){var P=this.customEffects[M];if(P&&P.enabled){P.update("forward",L,N)}}},getMaxIterationEffects:function(){var K=0;if(this.SSAOEffect&&this.SSAOEffect.enabled){K=Math.max(K,this.SSAOEffect.getMaxIteration())}if(this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled){K=Math.max(K,this.SSAOIterativeEffect.getMaxIteration())}if(this.MSAAEffect&&this.MSAAEffect.enabled){K=Math.max(K,this.MSAAEffect.getMaxIteration())}return K},setRendererSize:function(N,K,P,L,M,O){if(this.cssWidth!==N||this.cssHeight!==K||this.devicePixelRatio!==O||P){this.devicePixelRatio=O;this.cssWidth=Math.max(2,N);this.cssHeight=Math.max(2,K);this.deviceWidth=Math.floor(O*this.cssWidth);this.deviceHeight=Math.floor(O*this.cssHeight);this.viewportWidth=Math.floor(O*Math.max(2,L));this.viewportHeight=Math.floor(O*Math.max(2,M));this.renderer.setGLSize(this.cssWidth,this.cssHeight,L,M);this.setScale()}},setBackgroundColor:function(L,M){this.bgColor=L;this.bgAlpha=M;var K=new I.Color(this.bgColor);if(this.useCompositing){K.convertGammaToLinear()}this.bgColor=K.getHex()},resetGSSOCache:function(){this.renderer.resetGSSOCache()},computeIntersectionGPU:function(T,X,ad,ab,V,al,ag,ao,ae,ak,K){var ai=this.gl,ap=T.scene,ac,L={},an=new Array(),P,ah;var aj=X.camera;var au={main:aj,mainNoJittering:aj,connectedRobotCamera:X.connectedRobotCamera,robotCameraOrtho:X.robotCameraOrtho};this.renderer.currentFrameIndex++;if(!this.pickingGPUComposerContext){this.initComposer("PickingGPU")}this.renderer.gammaInput=false;var S=this.renderer.gammaOutput;this.renderer.gammaOutput=false;this.renderer.autoClear=false;this.renderer.lensFlareEnabled=false;this.mainComposer.updateScene(ap);if(this.OITEffect){this.OITEffect.revealPass.scene=ap;this.OITEffect.accumPass.scene=ap}this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.renderer.materialToUse=I.MaterialToUse.pickingMaterial;var Z=this.renderer.renderFaces;this.renderer.renderFaces=al;var Y=this.renderer.renderLineMode;this.renderer.renderLineMode=ag;var ar=this.renderer.renderPoints;this.renderer.renderPoints=ao;var O=this.renderer.renderHiddenEdges;this.renderer.renderHiddenEdges=false;var R=this.renderer.renderPointMode;this.renderer.renderPointMode=ae;this.renderer.setPickingPriorityMapping(ak,this.renderer._stateSortingResult);var am=this.forwardPass.getUsedStateSortingResult(this.renderer);this.renderer.setPickingPriorityMapping(ak,am);this.mainComposer.setComposerContext(this.pickingGPUComposerContext);this.mainComposer.render(undefined,undefined,au,"main");this.pickingGPUComposerContext.needsUpdate=false;this.renderer.setPickingPriorityMapping(null,this.renderer._stateSortingResult);this.renderer.setPickingPriorityMapping(null,am);var aq=this.computeMeshPick(T,ad,V);var U;var M=aq&&aq.tab.length==1&&aq.tab[0]&&aq.tab[0]._instancingInfos&&aq.tab[0]._instancingInfos.isInstanceNode3D;if(M&&aq.tab[0]._instancingInfos.instancingSelectionMode==="instance"){if(!this.pickingGPUComposerContext){this.initComposer("PickingGPU")}var W=new I.Scene();var at=aq.tab[0].clone();aq.tab[0].copyInstancingInfos(at);W.add(at);this.renderer.autoUpdateScene=true;W.updateMatrixWorld();this.mainComposer.updateScene(W);if(this.OITEffect){this.OITEffect.revealPass.scene=W;this.OITEffect.accumPass.scene=W}this.renderer.materialToUse=I.MaterialToUse.pickingMaterialInstancing;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.mainComposer.setComposerContext(this.pickingGPUComposerContext);this.pickingGPUComposerContext.needsUpdate=true;this.mainComposer.render(undefined,undefined,au,"main");this.pickingGPUComposerContext.needsUpdate=false;U=this.computeInstancePick(T,ad,V);this.pickingGPUComposerContext.needsUpdate=true;W.dispose();W=null}ab=ab||(K&&M);var P=aq.tab;for(ah=0;ah<P.length;++ah){if(P[ah]){var L={};L.object=P[ah];L.type=aq.type;if(ah==0&&P.length==1&&U!==undefined){L.instanceId=U}an.push(L)}}if(!an.length){an.push({object:null})}if(ab){if(!this.normalComposerContext){this.initComposer("Normal")}if(!this.depthComposerContext){this.initComposer("Depth")}this.renderer.autoUpdateScene=true;ap.updateMatrixWorld();this.mainComposer.updateScene(ap);if(this.OITEffect){this.OITEffect.revealPass.scene=ap;this.OITEffect.accumPass.scene=ap}this.renderer.materialToUse=I.MaterialToUse.normalMaterial;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.mainComposer.setComposerContext(this.normalComposerContext);this.mainComposer.render(undefined,undefined,au,"main");this.normalComposerContext.needsUpdate=false;this.computeNormalPick(an,aj,aq.outMouse);this.renderer.autoUpdateScene=true;ap.updateMatrixWorld();this.mainComposer.updateScene(ap);if(this.OITEffect){this.OITEffect.revealPass.scene=ap;this.OITEffect.accumPass.scene=ap}this.renderer.materialToUse=I.MaterialToUse.depthMaterial;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.mainComposer.setComposerContext(this.depthComposerContext);this.mainComposer.render(undefined,undefined,au,"main");this.depthComposerContext.needsUpdate=false;var N=aj,af=(an[0].object&&an[0].object._occurrence)?an[0].object._occurrence.node:null;var Q="";if(af){Q=af._getPickingCameraName();if(Q!==""){aj=X[Q]}}this.computePositionPick(an,aj,aq.outMouse)}this.renderer.lensFlareEnabled=true;this.renderer.gammaOutput=S;this.renderer.renderFaces=Z;this.renderer.renderLineMode=Y;this.renderer.renderPoints=ar;this.renderer.renderPointMode=R;this.renderer.renderHiddenEdges=O;return an},computeIntersectionGPUSmallTarget:function(aC,ax,al,W,aP,ao,ay,Y,U,ap,au){var T=this.gl,ag=aC.scene,aj,O={},an=new Array(),aE,aG;var aw=this.renderer.getViewportSize();var aA=aw.width;var V=aw.height;var ad=Math.round(al.xPix);var P=Math.round(al.yPix);var Z=ax.camera;var aO={main:Z,mainNoJittering:Z,connectedRobotCamera:ax.connectedRobotCamera,robotCameraOrtho:ax.robotCameraOrtho};var az=null;if(Z.fullWidth){az={fullWidth:Z.fullWidth,fullHeight:Z.fullHeight,x:Z.x,y:Z.y,width:Z.width,height:Z.height}}aO.main.useRealSize=true;aO.connectedRobotCamera.useRealSize=true;aO.robotCameraOrtho.useRealSize=true;var N=this.gpuPickingTolerance*2+1;var aK=this.gpuPickingTolerance;var aJ=this.gpuPickingTolerance;var af=0;var S=0;if(aP&&al.pt){af=Math.round(Math.abs(al.xPix-al.pt.xPix));S=Math.round(Math.abs(al.yPix-al.pt.yPix))}if(az){var X=1;var ab=1;X=az.width/az.fullWidth;ab=az.height/az.fullHeight;var ai=az.fullWidth/aA;var K=az.fullHeight/V;aA=az.fullWidth;V=az.fullHeight;ad*=ai;P*=K;ad=ad*X+az.x;P=P*ab+az.y;aK=aK*X;aJ=aJ*ab;af=af*X;S=S*ab}var av=(aP&&af!==0)?af:2*aK+1;var aI=(aP&&S!==0)?S:2*aJ+1;var ah=aP?ad:ad-aK;var ak=aP?P:P-aJ;ax._setPickingViewOffset({cameraSet:aO,fullHeight:V,fullWidth:aA,x:ah,y:ak-1,width:av,height:aI,pickingRatioW:N/aw.width,pickingRatioH:N/aw.height,});this.renderer.currentFrameIndex++;if(!this.pickingGPUComposerContext){this.initComposer("PickingGPU",true)}if(aP){this.pickingGPUComposerContext.setSize(Math.abs(ad-al.pt.xPix),Math.abs(P-al.pt.yPix))}var ar=false;if(this.currentGPUPickPosition.x!=ad||this.currentGPUPickPosition.y!=P){this.currentGPUPickPosition.x=ad;this.currentGPUPickPosition.y=P;ar=true}this.renderer.gammaInput=false;var aF=this.renderer.gammaOutput;this.renderer.gammaOutput=false;this.renderer.autoClear=false;this.renderer.lensFlareEnabled=false;this.mainComposer.updateScene(ag);if(this.OITEffect){this.OITEffect.revealPass.scene=ag;this.OITEffect.accumPass.scene=ag}this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.renderer.materialToUse=I.MaterialToUse.pickingMaterial;var Q=this.renderer.renderFaces;this.renderer.renderFaces=ao;var aL=this.renderer.renderLineMode;this.renderer.renderLineMode=ay;var aH=this.renderer.renderPoints;this.renderer.renderPoints=Y;var at=this.renderer.renderHiddenEdges;this.renderer.renderHiddenEdges=false;var am=this.renderer.renderPointMode;this.renderer.renderPointMode=U;this.renderer.setPickingPriorityMapping(ap,this.renderer._stateSortingResult);var aN=this.forwardPass.getUsedStateSortingResult(this.renderer);this.renderer.setPickingPriorityMapping(ap,aN);this.mainComposer.setComposerContext(this.pickingGPUComposerContext);this.pickingGPUComposerContext.needsUpdate=ar||this.pickingGPUComposerContext.needsUpdate;this.mainComposer.render(undefined,undefined,aO,"main");this.pickingGPUComposerContext.needsUpdate=false;this.renderer.setPickingPriorityMapping(null,this.renderer._stateSortingResult);this.renderer.setPickingPriorityMapping(null,aN);var aM=this.computeMeshPickSmallTarget(aC,al,aP);var R;var L=aM&&aM.tab.length==1&&aM.tab[0]&&aM.tab[0]._instancingInfos&&aM.tab[0]._instancingInfos.isInstanceNode3D;if(L&&aM.tab[0]._instancingInfos.instancingSelectionMode==="instance"){if(!this.pickingGPUComposerContext){this.initComposer("PickingGPU",true)}var aB=new I.Scene();var ac=aM.tab[0].clone();aM.tab[0].copyInstancingInfos(ac);aB.add(ac);this.renderer.autoUpdateScene=true;aB.updateMatrixWorld();this.mainComposer.updateScene(aB);if(this.OITEffect){this.OITEffect.revealPass.scene=aB;this.OITEffect.accumPass.scene=aB}this.renderer.materialToUse=I.MaterialToUse.pickingMaterialInstancing;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.mainComposer.setComposerContext(this.pickingGPUComposerContext);this.pickingGPUComposerContext.needsUpdate=true;this.mainComposer.render(undefined,undefined,aO,"main");this.pickingGPUComposerContext.needsUpdate=false;R=this.computeInstancePickSmallTarget(aC,al,aP);this.pickingGPUComposerContext.needsUpdate=true;aB.dispose();aB=null}W=W||(au&&L);var aE=aM.tab;for(aG=0;aG<aE.length;++aG){if(aE[aG]){var O={};O.object=aE[aG];O.type=aM.type;if(aG==0&&aE.length==1&&R!==undefined){O.instanceId=R}an.push(O)}}if(!an.length){an.push({object:null})}if(W){if(!this.normalComposerContext){this.initComposer("Normal",true)}if(!this.depthComposerContext){this.initComposer("Depth",true)}if(aP){ax._setPickingViewOffset({cameraSet:aO,fullHeight:aw.height,fullWidth:aw.width,x:ad-aK,y:P-aJ-1,width:2*aK+1,height:2*aJ+1})}this.renderer.autoUpdateScene=true;ag.updateMatrixWorld();this.mainComposer.updateScene(ag);if(this.OITEffect){this.OITEffect.revealPass.scene=ag;this.OITEffect.accumPass.scene=ag}this.renderer.materialToUse=I.MaterialToUse.normalMaterial;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.mainComposer.setComposerContext(this.normalComposerContext);this.normalComposerContext.needsUpdate=ar||this.normalComposerContext.needsUpdate;this.mainComposer.render(undefined,undefined,aO,"main");this.normalComposerContext.needsUpdate=false;this.computeNormalPickSmallTarget(an,Z,aM.outMouse);this.renderer.autoUpdateScene=true;ag.updateMatrixWorld();this.mainComposer.updateScene(ag);if(this.OITEffect){this.OITEffect.revealPass.scene=ag;this.OITEffect.accumPass.scene=ag}this.renderer.materialToUse=I.MaterialToUse.depthMaterial;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.mainComposer.setComposerContext(this.depthComposerContext);this.depthComposerContext.needsUpdate=ar||this.depthComposerContext.needsUpdate;this.mainComposer.render(undefined,undefined,aO,"main");this.depthComposerContext.needsUpdate=false;var aD=Z,aq=(an[0].object&&an[0].object._occurrence)?an[0].object._occurrence.node:null;var M="";if(aq){M=aq._getPickingCameraName();if(M!==""){Z=ax[M]}}this.computePositionPickSmallTarget(an,Z,aM.outMouse)}this.renderer.lensFlareEnabled=true;this.renderer.gammaOutput=aF;this.renderer.renderFaces=Q;this.renderer.renderLineMode=aL;this.renderer.renderPoints=aH;this.renderer.renderPointMode=am;this.renderer.renderHiddenEdges=at;ax._setPickingViewOffset({cameraSet:aO,reset:true});if(az){var ae=ax.camera._hasChanged;ax.setViewOffset(az);ax.camera._hasChanged=ae}aO.main.useRealSize=false;aO.connectedRobotCamera.useRealSize=false;aO.robotCameraOrtho.useRealSize=false;if(aP){this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)}return an},computeDepthBuffer:function(K,L,M){var O={main:L.camera,mainNoJittering:L.camera,connectedRobotCamera:L.connectedRobotCamera,robotCameraOrtho:L.robotCameraOrtho};var N=K.scene;if(!this.depthComposerContext){this.initComposer("Depth")}if(M){this.depthComposerContext.needsUpdate=true}this.renderer.gammaInput=false;var P=this.renderer.gammaOutput;this.renderer.gammaOutput=false;this.renderer.autoClear=false;this.renderer.lensFlareEnabled=false;this.renderer.materialToUse=I.MaterialToUse.depthMaterial;this.renderer.autoUpdateScene=true;N.updateMatrixWorld();this.mainComposer.updateScene(N);if(this.OITEffect){this.OITEffect.revealPass.scene=N;this.OITEffect.accumPass.scene=N}this.mainComposer.setComposerContext(this.depthComposerContext);this.mainComposer.render(undefined,undefined,O,"main");this.depthComposerContext.needsUpdate=false;this.renderer.lensFlareEnabled=true;this.renderer.gammaOutput=P},computePositionGPU:function(M,O,S){var P=this.gl,Q=M.scene,R,N=[];var K={main:O.camera,mainNoJittering:O.camera,connectedRobotCamera:O.connectedRobotCamera,robotCameraOrtho:O.robotCameraOrtho};this.renderer.gammaInput=false;var L=this.renderer.gammaOutput;this.renderer.gammaOutput=false;this.renderer.autoClear=false;this.renderer.lensFlareEnabled=false;if(!this.depthComposerContext){this.initComposer("Depth")}this.renderer.autoUpdateScene=true;Q.updateMatrixWorld();this.mainComposer.updateScene(Q);if(this.OITEffect){this.OITEffect.revealPass.scene=Q;this.OITEffect.accumPass.scene=Q}this.renderer.materialToUse=I.MaterialToUse.depthMaterial;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.mainComposer.setComposerContext(this.depthComposerContext);this.mainComposer.render(undefined,undefined,K,"main");this.depthComposerContext.needsUpdate=false;N[0]={point:null};this.computePositionPick(N,camera,S);this.renderer.lensFlareEnabled=true;this.renderer.gammaOutput=L;return N[0].point},overrideUpdate:function(K){function M(){var N;var O=K.root._occurrences;for(N=0;N<O.length;N++){O[N].requestOverridesUpdate()}}var L=K.root._getViewer();if(K.root._getTreeModified()&&L.getCurrentSceneGraphState()){M()}if(K.root._getTreeModified()&&L._sceneGraphOverrideSetManager){L._sceneGraphOverrideSetManager._updateOverridesWithMissingTarget(L)}K.root._tryOverridesUpdate(L);if(K.root._getTreeModified()){K.root.traverse(function(N){N.__setTreeModified(false);if(N.isOOCNode()){return true}})}},renderRealDepth:function(U,P,O,K,R,S,L){if(!this.outlineDepthComposerContext){this.initComposer("OutlineDepth")}this.outlineDepthComposerContext.setCameraName(U);this.mainComposer.updateScene(P);if(this.OITEffect){this.OITEffect.revealPass.scene=P;this.OITEffect.accumPass.scene=P}var Q=this.renderer.supportsFloatTextures();this.renderer.materialToUse=Q?I.MaterialToUse.normalDepthMaterial:I.MaterialToUse.shadowMapDepthMaterial;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;O.stencilOp(O.REPLACE,O.REPLACE,O.REPLACE);O.stencilFunc(O.ALWAYS,1,4294967295);O.clearStencil(0);this.renderer.lensFlareEnabled=false;this.zPrePass.setDLsToDisable(["EDGE","POINT","TRANSPAR1D"]);this.forwardPass.setDLsToDisable(["EDGE","POINT","TRANSPAR1D"]);this.ZOnlyPass.setDLsToDisable(["EDGE","POINT","TRANSPAR1D"]);this.backgroundPass.setDLsToDisable(["EDGE","POINT","TRANSPAR1D"]);this.outlineDepthComposerContext.setPassClear(this.initClearPass,true,new I.Color(0),0);this.outlineDepthComposerContext.enableRenderCuttingElementsPasses(S);this.mainComposer.setComposerContext(this.outlineDepthComposerContext);var V,T;if(this.renderer.splitScreenMode){V=this.renderer.getScissorTest();this.renderer.enableScissorTest(false);T=this.renderer.getViewport();this.renderer.setViewport(0,0,T.width,T.height)}var N=L.root._getViewer();var M=false;if(N.infPlaneSmall!==null){M=N.infPlaneSmall.visible;N.infPlaneSmall.visible=false}this.mainComposer.render(undefined,undefined,K,R);if(N.infPlaneSmall!==null){N.infPlaneSmall.visible=M}if(this.renderer.splitScreenMode){this.renderer.setViewport(T.x,T.y,T.width,T.height);this.renderer.enableScissorTest(V)}this.renderer.dBuffer=this.mainComposer.getRenderResult("main");this.renderer.requestDBuffer=false;this.renderer.lensFlareEnabled=true;this.zPrePass.setDLsToDisable([]);this.forwardPass.setDLsToDisable([]);this.ZOnlyPass.setDLsToDisable([]);this.backgroundPass.setDLsToDisable([])},render:function(aM,af,aL,aD,aQ,aE,U,V,L,aN,ay,aj,aw,Y,P,aO,al,ap){this.renderer.renderIteration=aO;this.renderer.currentFrameIndex++;this.renderer.info.render.calls=0;this.renderer.info.render.vertices=0;this.renderer.info.render.faces=0;this.renderer.info.render.points=0;this.renderer.info.render.lines=0;this.renderer.info.render.meshes=0;this.renderer.info.render.culledMeshes=0;aQ.mainNoJittering=aQ.main;if(this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&this.BokehDOFEffect.iterative){var ar=null;if(this.MSAAEffect&&this.MSAAEffect.enabled){ar=this.MSAAEffect.computeJitterValues(aQ.main,aO)}aQ.main=this.BokehDOFEffect.computeJitterCamera(aQ.main,aO,ar);aQ.cameraBackground=this.BokehDOFEffect.computeJitterCamera(aQ.cameraBackground,aO,ar)}else{if(this.MSAAEffect&&this.MSAAEffect.enabled){aQ.main=this.MSAAEffect.computeJitterCamera(aQ.main,aO);aQ.cameraBackground=this.MSAAEffect.computeJitterCamera(aQ.cameraBackground,aO);if(aQ.mirrorCamera){aQ.mirrorCamera=this.MSAAEffect.computeJitterCamera(aQ.mirrorCamera,aO)}}}this.renderer.fixedSizeArrayPool.makeArraysReusable();this.overrideUpdate(aE,ay);var M,ao,aq,aG,aI,aH,au,an,W=this.gl,N,S;this.renderer.gammaInput=true;this.renderer.materialToUse=I.MaterialToUse.originalMaterial;an=aE.scene;this.shadowPass.setScene(an);var Q=!aj&&(L||((this.renderer.getViewportSize().width===this.viewportWidth)&&(this.renderer.getViewportSize().height===this.viewportHeight)));var X=WUX.Selection.HSOManager;var ae=WUX.Selection.PSOManager;N=this.HighlightEffect&&!X.isEmpty();S=this.PreHighlightEffect&&!ae.isEmpty();N&&this.HighlightEffect.setEnabled(N);N&&this.HighlightEffect.setSize(this.viewportWidth,this.viewportHeight);S&&this.PreHighlightEffect.setEnabled(S);S&&this.PreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight);var ag=this.HighlightEffect&&this.HighlightEffect.enabled;var R=this.PreHighlightEffect&&this.PreHighlightEffect.enabled;this.updateFinalComposer(L);var ai=false;if(this.sectionCappingEnabled&&this.renderer.clipPlanes.length>0){ai=true}if(this.afterMirrorClearDepth){this.afterMirrorClearDepth.setClearStencil(ai)}if(ai){if(!this.clippingScene){this.clippingScene=new I.Scene(),aI;this.clippingScene.autoUpdateScene=false;this.clippingScene.matrixWorldNeedsUpdate=false;this.clippingScene.matrixAutoUpdate=false;var T=aE.getBoundingSphere();var av=new I.PlaneGeometry(50*T.radius,50*T.radius);var aC;for(aI=0;aI<this.renderer.clipPlanes.length;aI++){aC=this.renderer.clipPlanes[aI].clippingContext[this.renderer.id];var Z=aC.sectionCappingMaterial;if(Z){Z=Z.clone();Z.clipPlaneIndex=aI+1}var ak=new I.Mesh(av,Z||new I.MeshPhongMaterial({color:"purple"}));ak.clippingPlane=this.renderer.clipPlanes[aI];aC.clippingMeshIndex=aI+1;this.clippingScene.add(ak)}for(aI=0;aI<an.children.length;aI++){var aB=an.children[aI];if(aB instanceof I.Light){this.clippingScene.add(aB.clone())}}}var am=this.mainComposer.getAllPasses(),K;for(aI=0;aI<am.length;aI++){K=am[aI];if(K.renderCuttingElements){K.setCuttingScene(this.clippingScene)}}this.updateClippingScene(aE)}if(!aN||!this.useCompositing||!this.highlightPass){if(this.pickingGPUComposerContext){this.pickingGPUComposerContext.needsUpdate=true;this.meshesGPU={}}if(this.normalComposerContext){this.normalComposerContext.needsUpdate=true;this.normalsGPU={}}if(this.depthComposerContext){this.depthComposerContext.needsUpdate=true;this.positionsGPU={}}this.currentGPUPickPosition={x:-1,y:-1};this.renderer.autoUpdateScene=true;an.updateMatrixWorld();this.renderer.initWebGLObjects(an);var ac=(!aO||al)&&((this.SSAOEffect&&this.SSAOEffect.enabled)||(this.SSLREffect&&this.SSLREffect.enabled)||(this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&!this.BokehDOFEffect.iterative)||(an.__webglFlares&&an.__webglFlares.length));ac=ac||(this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&((aO===1)||((aO>1)&&this.MSAAEffect&&this.MSAAEffect.enabled)));if(ac){if(!this.normalDepthComposerContext){this.initComposer("NormalDepth")}this.mainComposer.updateScene(an);if(this.OITEffect){this.OITEffect.revealPass.scene=an;this.OITEffect.accumPass.scene=an}this.renderer.materialToUse=I.MaterialToUse.normalDepthMaterial;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;W.stencilOp(W.REPLACE,W.REPLACE,W.REPLACE);W.stencilFunc(W.ALWAYS,1,4294967295);W.clearStencil(0);this.renderer.lensFlareEnabled=false;this.zPrePass.setDLsToDisable(["EDGE","POINT","TRANSPAR1D"]);this.forwardPass.setDLsToDisable(["EDGE","POINT","TRANSPAR1D"]);this.ZOnlyPass.setDLsToDisable(["EDGE","POINT","TRANSPAR1D"]);this.normalDepthComposerContext.setPassClear(this.initClearPass,true,new I.Color(0),0);this.normalDepthComposerContext.enableRenderCuttingElementsPasses(ai);this.mainComposer.setComposerContext(this.normalDepthComposerContext);var aK,aA;if(this.renderer.splitScreenMode){aK=this.renderer.getScissorTest();this.renderer.enableScissorTest(false);aA=this.renderer.getViewport();this.renderer.setViewport(0,0,aA.width,aA.height)}this.mainComposer.render(undefined,undefined,aQ,ap);if(this.renderer.splitScreenMode){this.renderer.setViewport(aA.x,aA.y,aA.width,aA.height);this.renderer.enableScissorTest(aK)}this.renderer.lensFlareEnabled=true;this.zPrePass.setDLsToDisable([]);this.forwardPass.setDLsToDisable([]);this.ZOnlyPass.setDLsToDisable([])}this.renderer.materialToUse=I.MaterialToUse.originalMaterial;var az=this.renderer.requestDBuffer||(this.renderer.getRenderMode(null)._mask&I.OutlineMask);if(af&&this.useCompositing){if(az){this.renderRealDepth("mirrorCamera",an,W,aQ,ap,ai,aE)}this.renderer.materialToUse=I.MaterialToUse.originalMaterial;this.compMirrorComposerContext.setPassClear(this.initClearPass,true,new I.Color(0),0);this.compMirrorComposerContext.enableRenderCuttingElementsPasses(ai);this.mainComposer.updateScene(an);if(this.OITEffect){this.OITEffect.revealPass.scene=an;this.OITEffect.accumPass.scene=an}var ah=false;if(U!==null){ah=U.visible;U.visible=false}var aJ=false;var aF=(1-V)*20;this.passMirrorBlur.uniforms.radius.value=aF;if(aF>0){aJ=true}this.compMirrorComposerContext.enablePass(this.passMirrorBlur,aJ);aJ=false;if(aF>12){aJ=true}this.compMirrorComposerContext.enablePass(this.passMirrorBlur1,aJ);aJ=false;if(aF>16){aJ=true}this.compMirrorComposerContext.enablePass(this.passMirrorBlur2,aJ);aJ=false;if(aF>18){aJ=true}this.compMirrorComposerContext.enablePass(this.passMirrorBlur3,aJ);this.compMirrorComposerContext.setRenderPlugins(this.forwardPass,true);this.compMirrorComposerContext.enablePass(this.zPrePass,false);this.renderer.shadowMapEnabled=aL;this.renderer.shadowMapSoft=false;this.mainComposer.setComposerContext(this.compMirrorComposerContext);this.mainComposer.render(0.1,undefined,aQ,ap);if(U!==null){U.visible=ah}}if(az){this.renderRealDepth("main",an,W,aQ,ap,ai,aE)}this.renderer.materialToUse=I.MaterialToUse.originalMaterial;this.renderer.autoClear=false;this.compForwardComposerContext.enablePass(this.infPlanePass,aM);this.compForwardComposerContext.setPassClear(this.initClearPass,true,new I.Color(this.bgColor),this.bgAlpha);this.infPlanePass.scene=aD;this.compForwardComposerContext.enableRenderCuttingElementsPasses(ai);if(this.useCompositing){this.compForwardComposerContext.enablePass(this.mirrorBlendPass,aM&&af);this.compForwardComposerContext.enablePass(this.mirrorClearDepth,aM&&af);this.compForwardComposerContext.enablePass(this.afterMirrorClearDepth,af);this.compForwardComposerContext.setPassClear(this.mirrorClearDepth,true,new I.Color(0),1);this.compForwardComposerContext.setPassClear(this.afterMirrorClearDepth,false,new I.Color(0),1);this.compForwardComposerContext.setPassClearDepth(this.afterMirrorClearDepth,true)}this.compForwardComposerContext.setPassClear(this.initClearPass,true,new I.Color(this.bgColor),this.bgAlpha);this.forwardPass.scene=an;this.zPrePass.scene=an;this.backgroundPass.scene=an;this.ZOnlyPass.scene=an;this.mainComposer.updateScene(an);if(this.OITEffect){this.OITEffect.revealPass.scene=an;this.OITEffect.accumPass.scene=an}if(I.mobileVersion){this.compForwardComposerContext.setPassClear(this.highlightClearPass,false,new I.Color(0),0);this.compForwardComposerContext.setPassClearDepth(this.highlightClearPass,true);this.highlightSinglePass.scene=aE.selectionHL.sceneHL}this.renderer.shadowMapEnabled=aL;this.renderer.shadowMapSoft=aL;if(this.customComposerContexts){var ab=this.mainComposer.getPostEffectPasses();for(aH=0;aH<ab.length;aH++){for(aI=0;aI<this.customComposerContexts.length;aI++){this.customComposerContexts[aI].enablePass(ab[aH],false)}}for(aI=0;aI<this.customComposerContexts.length;aI++){this.customComposerContexts[aI].enablePass(this.afterMirrorClearDepth,false);this.customComposerContexts[aI].enableRenderCuttingElementsPasses(ai);this.mainComposer.setComposerContext(this.customComposerContexts[aI]);this.mainComposer.render(undefined,undefined,aQ,ap)}}if(aw){var ax=new I.WebGLRenderTargetProperties(Y,Y,"cubelinear");var aP=this.compForwardComposerContext.originalRenderTargetProperties;var ad=this.compForwardComposerContext.keepResult;var at=this.compForwardComposerContext.renderResults.main;var O=at.useCount;this.compForwardComposerContext.keepResult=true;at.useCount=1;this.compForwardComposerContext.releaseRenderTargets(this.mainComposer.renderTargetPool);this.compForwardComposerContext.originalRenderTargetProperties=ax;this.mainComposer.setComposerContext(this.compForwardComposerContext);if(this.ToneMappingEffect){this.compForwardComposerContext.setAsLastPass(this.ToneMappingEffect.mixPass,true)}this.mainComposer.render(0.1,P,aQ,ap);if(this.ToneMappingEffect){this.compForwardComposerContext.setAsLastPass(this.ToneMappingEffect.mixPass,false)}this.compForwardComposerContext.originalRenderTargetProperties=aP;this.compForwardComposerContext.keepResult=ad;at.useCount=O}else{this.mainComposer.setComposerContext(this.compForwardComposerContext);if(this.MSAAEffect&&this.MSAAEffect.enabled){this.mainComposer.setPreviousNormalDepthBuffer(this.normalDepthComposerContext);this.mainComposer.setPreviousColorBuffer(this.MSAAEffect.composers[0].composerContext)}this.mainComposer.render(0.1,undefined,aQ,ap)}this.renderer.shadowMapEnabled=false;this.renderer.shadowMapSoft=false;this.updateInfos()}else{if(this.customComposerContexts){var ab=this.mainComposer.getPostEffectPasses();for(aH=0;aH<ab.length;aH++){for(aI=0;aI<this.customComposerContexts.length;aI++){this.customComposerContexts[aI].enablePass(ab[aH],false)}}for(aI=0;aI<this.customComposerContexts.length;aI++){this.customComposerContexts[aI].enablePass(this.afterMirrorClearDepth,false);this.customComposerContexts[aI].enableRenderCuttingElementsPasses(ai);this.mainComposer.setComposerContext(this.customComposerContexts[aI]);this.mainComposer.render(undefined,undefined,aQ,ap)}}this.mainComposer.setComposerContext(this.compForwardComposerContext);this.mainComposer.updateLinks(ap);this.mainComposer.setComposerContext(this.compForwardComposerContext);this.mainComposer.render(0.1,undefined,aQ,ap,this.highlightPass)}this.renderer.renderAssets();this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;W.depthFunc(W.LEQUAL)},combineResults:function(K,N,M){if(!M.isReady()){return false}if(!this.superFinalComposer){var O=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint");O.generateMipmaps=false;this.superFinalComposer=new G(this.renderer,O,this.renderTargetPool);this.superFinalComposer.composerContext.name="superFinalComposer";M.createPasses(this.superFinalComposer)}M.updatePasses(K,N,this.compForwardComposerContext.renderResults);var L=this.renderer.getViewportSize();this.renderer.setViewport(0,0,this.deviceWidth,this.deviceHeight);this.superFinalComposer.render(0.1,undefined,{},"superFinal");this.renderer.setViewport(0,0,L.width,L.height);return true},computeMeshPick:function(Q,ac,S){var U=Math.round(ac.xPix),T=Math.round(ac.yPix),W=(S&&ac.pt&&Math.round(ac.xPix-ac.pt.xPix)!==0)?Math.round(Math.abs(ac.xPix-ac.pt.xPix)):1,al=(S&&ac.pt&&Math.round(ac.yPix-ac.pt.yPix)!==0)?Math.round(Math.abs(ac.yPix-ac.pt.yPix)):1,ab=this.viewportHeight,ad,aj,ah,ag,af,M={},ar=[];var R=U;var ak=T;var L=true;if(S==false){L=this.pickingGPUComposerContext.needsUpdate;for(var aj=U-this.gpuPickingTolerance;aj<=U+this.gpuPickingTolerance;++aj){for(var ah=T-this.gpuPickingTolerance;ah<=T+this.gpuPickingTolerance;++ah){if(!this.meshesGPU[ah*this.viewportWidth+aj]){L=true}}}R=U-this.gpuPickingTolerance;ak=T-this.gpuPickingTolerance;W=2*this.gpuPickingTolerance+1;al=2*this.gpuPickingTolerance+1}if(L){var ai=new Uint8Array(4*W*al);this.gl.readPixels(R,ab-ak-al+1,W,al,this.gl.RGBA,this.gl.UNSIGNED_BYTE,ai);for(aj=0;aj<W;++aj){for(ah=0;ah<al;++ah){af=4*(ah*W+aj);ad=((ai[af]&63)<<16)|(ai[af+1]<<8)|(ai[af+2]);var O=ai[af]>>6&3;var X=M[ad];if(X===undefined){X=this.getObjectById(Q.scene,ad);M[ad]=X;if(X){ar.push(X)}}this.meshesGPU[(ak+al-ah-1)*this.viewportWidth+R+aj]={object:X,glType:O}}}}if(S){return{tab:ar,outMouse:ac}}else{var V=0;var K=0;var Z=null;var ap=false;var P=2;var N=this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;var Y=[N,N,0];for(var aj=R;aj<R+W;++aj){for(var ah=ak;ah<ak+al;++ah){var ao=aj-U;var an=ah-T;var ae=ao*ao+an*an;var X=this.meshesGPU[ah*this.viewportWidth+aj];if(X){var aq=X.object;var O=X.glType;var am=aq&&aq.hasPriorityManipulators&&aq.hasPriorityManipulators();if(ap&&!am){continue}if(aq&&aq.pickable&&((!ap&&am)||(O<=P&&ae<=Y[O]))){ap=am;Y[O]=ae;Z=aq;P=O;V=aj;K=ah}}}}if(Z){return{tab:[Z],outMouse:{xPix:V,yPix:K,x:(V-this.viewportWidth/2)/(this.viewportWidth/2),y:(this.viewportHeight/2-K)/(this.viewportHeight/2)},type:P}}else{return{tab:[],outMouse:ac}}}},computeInstancePick:function(M,U,O){if(O){return}var Q=Math.round(U.xPix),P=Math.round(U.yPix),R=(O&&U.pt&&Math.round(U.xPix-U.pt.xPix)!==0)?Math.round(Math.abs(U.xPix-U.pt.xPix)):1,ag=(O&&U.pt&&Math.round(U.yPix-U.pt.yPix)!==0)?Math.round(Math.abs(U.yPix-U.pt.yPix)):1,T=this.viewportHeight,V,ae,Z,Y,X,ab={};var N=Q;var af=P;var K=true;N=Q-this.gpuPickingTolerance;af=P-this.gpuPickingTolerance;R=2*this.gpuPickingTolerance+1;ag=2*this.gpuPickingTolerance+1;var ad=new Uint8Array(4*R*ag);this.gl.readPixels(N,T-af-ag+1,R,ag,this.gl.RGBA,this.gl.UNSIGNED_BYTE,ad);var ac=0;var L=this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;for(ae=0;ae<R;++ae){for(Z=0;Z<ag;++Z){X=4*(Z*R+ae);V=((ad[X])<<16)|(ad[X+1]<<8)|(ad[X+2]);if(V===0||V>16777215){continue}else{var S=V%5;if(S!==0){if(S>3){V=V+5-S}else{if(S<3){V=V-S}else{V=undefined}}}if(V===0){continue}}if(V!==undefined){var ai=ae+N-Q;var ah=Z+af-P;var W=ai*ai+ah*ah;if(W<L){ac=V}}}}if(ac===0){ac=undefined}return ac},computePositionPick:function(K,O,P){var T=P.xPix,R=P.yPix,U=this.viewportHeight,S=new Uint8Array(4),N,Q,M;if(!this.depthComposerContext.needsUpdate&&this.positionsGPU[R*this.viewportWidth+T]){N=this.positionsGPU[R*this.viewportWidth+T]}else{this.gl.readPixels(T,U-R,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,S);Q=new Float32Array(S.buffer);if(!Q[0]){M=1}else{M=2*Q[0]-1}N=new I.Vector4(P.x,P.y,M,1);N.applyMatrix4(O.projectionMatrixInverse);N.multiplyScalar(1/N.w);N.applyMatrix4(O.matrixWorld);this.positionsGPU[R*this.viewportWidth+T]=N.clone()}for(var L=0;L<K.length;++L){K[L].point=new I.Vector3(N.x,N.y,N.z)}},computeNormalPick:function(L,Q,R){var W=R.xPix,U=R.yPix,X=this.viewportHeight,V=new Uint8Array(4),P;if(!this.normalComposerContext.needsUpdate&&this.normalsGPU[U*this.viewportWidth+W]){P=this.normalsGPU[U*this.viewportWidth+W]}else{this.gl.readPixels(W,X-U,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,V);P=new I.Vector4((V[0]/255)*2-1,(V[1]/255)*2-1,(V[2]/255)*2-1,0);var K=P.x,T=P.y,M=P.z;var O=Q.matrixWorld.elements;var S=1/(O[3]*K+O[7]*T+O[11]*M+O[15]);P.x=(O[0]*K+O[4]*T+O[8]*M)*S;P.y=(O[1]*K+O[5]*T+O[9]*M)*S;P.z=(O[2]*K+O[6]*T+O[10]*M)*S;this.normalsGPU[U*this.viewportWidth+W]=P.clone()}for(var N=0;N<L.length;++N){L[N].normal=new I.Vector3(P.x,P.y,P.z);L[N].tangent=null}},computeMeshPickSmallTarget:function(R,ad,T){var V=Math.round(ad.xPix),U=Math.round(ad.yPix),X=(T&&ad.pt&&Math.round(ad.xPix-ad.pt.xPix)!==0)?Math.round(Math.abs(ad.xPix-ad.pt.xPix)):1,an=(T&&ad.pt&&Math.round(ad.yPix-ad.pt.yPix)!==0)?Math.round(Math.abs(ad.yPix-ad.pt.yPix)):1,ac=this.viewportHeight,ae,al,aj,ai,ah,N={},au=[];var S=V;var am=U;var M=true;if(T==false){M=this.pickingGPUComposerContext.needsUpdate;for(var al=V-this.gpuPickingTolerance;al<=V+this.gpuPickingTolerance;++al){for(var aj=U-this.gpuPickingTolerance;aj<=U+this.gpuPickingTolerance;++aj){if(!this.meshesGPU[aj*this.viewportWidth+al]){M=true}}}S=V-this.gpuPickingTolerance;am=U-this.gpuPickingTolerance;X=2*this.gpuPickingTolerance+1;an=2*this.gpuPickingTolerance+1}if(M){var ak=new Uint8Array(4*X*an);this.gl.readPixels(0,0,X,an,this.gl.RGBA,this.gl.UNSIGNED_BYTE,ak);for(al=0;al<X;++al){for(aj=0;aj<an;++aj){ah=4*(aj*X+al);ae=((ak[ah]&63)<<16)|(ak[ah+1]<<8)|(ak[ah+2]);var P=ak[ah]>>6&3;var Y=N[ae];if(Y===undefined){Y=this.getObjectById(R.scene,ae);N[ae]=Y;if(Y){au.push(Y)}}this.meshesGPU[(am+an-aj-1)*this.viewportWidth+S+al]={object:Y,glType:P}}}}if(T){return{tab:au,outMouse:ad}}else{var W=0;var L=0;var ag=0;var K=0;var ab=null;var ar=false;var Q=2;var O=this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;var Z=[O,O,0];for(var al=S;al<S+X;++al){for(var aj=am;aj<am+an;++aj){var aq=al-V;var ap=aj-U;var af=aq*aq+ap*ap;var Y=this.meshesGPU[aj*this.viewportWidth+al];if(Y){var at=Y.object;var P=Y.glType;var ao=at&&at.hasPriorityManipulators&&at.hasPriorityManipulators();if(ar&&!ao){continue}if(at&&at.pickable&&((!ar&&ao)||(P<=Q&&af<=Z[P]))){ar=ao;Z[P]=af;ab=at;Q=P;W=al;L=aj;ag=al-S;K=aj-am}}}}if(ab){return{tab:[ab],outMouse:{xPix:W,yPix:L,xDev:ag,yDev:K,x:(W-this.viewportWidth/2)/(this.viewportWidth/2),y:(this.viewportHeight/2-L)/(this.viewportHeight/2)},type:Q}}else{return{tab:[],outMouse:ad}}}},computeInstancePickSmallTarget:function(M,U,O){if(O){return}var Q=Math.round(U.xPix),P=Math.round(U.yPix),R=(O&&U.pt&&Math.round(U.xPix-U.pt.xPix)!==0)?Math.round(Math.abs(U.xPix-U.pt.xPix)):1,ag=(O&&U.pt&&Math.round(U.yPix-U.pt.yPix)!==0)?Math.round(Math.abs(U.yPix-U.pt.yPix)):1,T=this.viewportHeight,V,ae,Z,Y,X,ab={};var N=Q;var af=P;var K=true;N=Q-this.gpuPickingTolerance;af=P-this.gpuPickingTolerance;R=2*this.gpuPickingTolerance+1;ag=2*this.gpuPickingTolerance+1;var ad=new Uint8Array(4*R*ag);this.gl.readPixels(0,0,R,ag,this.gl.RGBA,this.gl.UNSIGNED_BYTE,ad);var ac=0;var L=this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;for(ae=0;ae<R;++ae){for(Z=0;Z<ag;++Z){X=4*(Z*R+ae);V=((ad[X])<<16)|(ad[X+1]<<8)|(ad[X+2]);if(V===0||V>16777215){continue}else{var S=V%5;if(S!==0){if(S>3){V=V+5-S}else{if(S<3){V=V-S}else{V=undefined}}}if(V===0){continue}}if(V!==undefined){var ai=ae+N-Q;var ah=Z+af-P;var W=ai*ai+ah*ah;if(W<L){ac=V}}}}if(ac===0){ac=undefined}return ac},computePositionPickSmallTarget:function(K,P,Q){var U=Q.xPix,S=Q.yPix,V=this.viewportHeight,T=new Uint8Array(4),O,R,M;if(!this.depthComposerContext.needsUpdate&&this.positionsGPU[S*this.viewportWidth+U]){O=this.positionsGPU[S*this.viewportWidth+U]}else{var N=2*this.gpuPickingTolerance+1;this.gl.readPixels(Q.xDev,N-Q.yDev-1,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,T);R=new Float32Array(T.buffer);if(!R[0]){M=1}else{M=2*R[0]-1}O=new I.Vector4(Q.x,Q.y,M,1);O.applyMatrix4(P.realProjectionMatrixInverse);O.multiplyScalar(1/O.w);O.applyMatrix4(P.matrixWorld);this.positionsGPU[S*this.viewportWidth+U]=O.clone()}for(var L=0;L<K.length;++L){K[L].point=new I.Vector3(O.x,O.y,O.z)}},computeNormalPickSmallTarget:function(L,R,S){var X=S.xPix,V=S.yPix,Y=this.viewportHeight,W=new Uint8Array(4),Q;if(!this.normalComposerContext.needsUpdate&&this.normalsGPU[V*this.viewportWidth+X]){Q=this.normalsGPU[V*this.viewportWidth+X]}else{var O=2*this.gpuPickingTolerance+1;this.gl.readPixels(S.xDev,O-S.yDev-1,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,W);Q=new I.Vector4((W[0]/255)*2-1,(W[1]/255)*2-1,(W[2]/255)*2-1,0);var K=Q.x,U=Q.y,M=Q.z;var P=R.matrixWorld.elements;var T=1/(P[3]*K+P[7]*U+P[11]*M+P[15]);Q.x=(P[0]*K+P[4]*U+P[8]*M)*T;Q.y=(P[1]*K+P[5]*U+P[9]*M)*T;Q.z=(P[2]*K+P[6]*U+P[10]*M)*T;this.normalsGPU[V*this.viewportWidth+X]=Q.clone()}for(var N=0;N<L.length;++N){L[N].normal=new I.Vector3(Q.x,Q.y,Q.z);L[N].tangent=null}},getObjectById:function(L,O){var N,K,M;if(L.id===O){return L}for(N=0,K=L.children.length;N<K;N++){M=this.getObjectById(L.children[N],O);if(M!==null){return M}}return null},insertComposer:function(K,L){if(I.mobileVersion){return}if(K!==null){this.composers.push(K)}L.disabledByDefault=true;this.mainComposer.addPass(L);this.compForwardComposerContext.enablePass(L,true);if(L.name==="HighlightEffect"){this.highlightPass=L}this.updateFinalComposer(true)},updateFinalComposer:function(O){if(I.mobileVersion){return}var L=this.mainComposer;var Q=this.compForwardComposerContext;if(!L){return}var N=L.getAllPasses();var R=N.length,M,K,P;for(M=0;M<R;M++){Q.setPassRenderToCanvas(N[M],false)}if(O){for(M=R-1;M>=0;M--){P=N[M];if(Q.passStates[M].enabled&&P instanceof H){Q.setPassRenderToCanvas(P,true);break}}for(K=R-1;K>=0;K--){P=N[K];if(Q.passStates[K].enabled&&P instanceof H){break}if(Q.passStates[K].enabled&&(P instanceof f||P instanceof g)){Q.setPassRenderToCanvas(P,true)}}}},getComposer:function(K){if(K==="normalDepth"){if(!this.normalDepthComposerContext){this.initComposer("NormalDepth")}return this.normalDepthComposerContext}else{if(K==="result"){return this.compForwardComposerContext}else{if(K==="previousColor"){if(this.MSAAEffect&&this.MSAAEffect.enabled){return this.MSAAEffect.composers[0].composerContext}}}}return null},updateInfos:function(){this.renderer.info.memory.copyTo(this.info.memory);this.forwardPass.info.copyTo(this.info.render)},getInfos:function(){return this.info},setScale:function(){this.renderTargetPool.resetRenderTargetPool();var O,M,N,P,L,R,K;if(this.antiAliasing==="FSAA"||this.antiAliasing==="SSAA"){if(this.compMirrorComposerContext){this.compMirrorComposerContext.setSize(2*this.viewportWidth,2*this.viewportHeight)}if(this.compForwardComposerContext){this.compForwardComposerContext.setSize(2*this.viewportWidth,2*this.viewportHeight)}}else{if(this.compForwardComposerContext){this.compForwardComposerContext.setSize(this.viewportWidth,this.viewportHeight)}if(this.compMirrorComposerContext){this.compMirrorComposerContext.setSize(this.viewportWidth,this.viewportHeight)}}if(this.normalDepthComposerContext){this.normalDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight)}if(this.outlineDepthComposerContext){this.outlineDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight)}if(!this.smallTargetPicking){if(this.pickingGPUComposerContext){this.pickingGPUComposerContext.setSize(this.viewportWidth,this.viewportHeight)}if(this.normalComposerContext){this.normalComposerContext.setSize(this.viewportWidth,this.viewportHeight)}if(this.depthComposerContext){this.depthComposerContext.setSize(this.viewportWidth,this.viewportHeight)}}if(this.FXAAEffect&&this.FXAAEffect.enabled){this.FXAAEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.MLAAEffect&&this.MLAAEffect.enabled){this.MLAAEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.MSAAEffect&&this.MSAAEffect.enabled){this.MSAAEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.SMAAEffect&&this.SMAAEffect.enabled){this.SMAAEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.SSAOEffect&&this.SSAOEffect.enabled){this.SSAOEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled){this.SSAOIterativeEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.SSLREffect&&this.SSLREffect.enabled){this.SSLREffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.BokehDOFEffect&&this.BokehDOFEffect.enabled){this.BokehDOFEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.ToneMappingEffect&&this.ToneMappingEffect.enabled){this.ToneMappingEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.FlareEffect&&this.FlareEffect.enabled){this.FlareEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.HighlightEffect&&this.HighlightEffect.enabled){this.HighlightEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.PreHighlightEffect&&this.PreHighlightEffect.enabled){this.PreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.DebugPassEffect&&this.DebugPassEffect.enabled){this.DebugPassEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.DebugShadowMapsEffect&&this.DebugShadowMapsEffect.enabled){this.DebugShadowMapsEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.OITEffect&&this.OITEffect.enabled){this.OITEffect.setSize(this.viewportWidth,this.viewportHeight)}for(var O=0;O<this.customEffects.length;O++){var Q=this.customEffects[O];if(Q&&Q.enabled){Q.setSize(this.viewportWidth,this.viewportHeight)}}if(this.passMirrorBlur!==null){this.passMirrorBlur.uniforms.invSize.value.x=1/this.viewportWidth;this.passMirrorBlur.uniforms.invSize.value.y=1/this.viewportHeight}},initComposer:function(L,P){switch(L){case"Depth":var K;if(P){K=new I.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest")}else{K=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest")}K.generateMipmaps=false;this.depthComposerContext=new j(K,this.mainComposer,"depthComposerContext");this.setupPickingComposerContext(this.depthComposerContext,0,0);break;case"Normal":var M;if(P){M=new I.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest")}else{M=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest")}this.normalComposerContext=new j(M,this.mainComposer,"normalComposerContext");this.setupPickingComposerContext(this.normalComposerContext,0,1);break;case"NormalDepth":var R=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"nearest");R.generateMipmaps=false;this.normalDepthComposerContext=new j(R,this.mainComposer,"normalDepthComposerContext");this.normalDepthComposerContext.keepResult=true;this.normalDepthComposerContext.enablePass(this.mirrorBlendPass,false);this.normalDepthComposerContext.enablePass(this.mirrorClearDepth,false);this.normalDepthComposerContext.enablePass(this.afterMirrorClearDepth,false);this.normalDepthComposerContext.enablePass(this.infPlanePass,false);this.normalDepthComposerContext.setRenderPlugins(this.forwardPass,false);this.normalDepthComposerContext.setOnEffectComposerChangeCallback(function(U){var T=U.composer.getPostEffectPasses();var S;for(S=0;S<T.length;S++){U.enablePass(T[S],false)}});this.normalDepthComposerContext.linkTo_internal(this.lensFlarePass.plugin._lensFlare.uniforms.tNormalDepth,undefined,"main");if(this.highlightSinglePass){this.normalDepthComposerContext.enablePass(this.highlightClearPass,false)}break;case"OutlineDepth":var N=this.renderer.supportsFloatTextures();var Q=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,N?"nearest":"uintNearest");Q.generateMipmaps=false;this.outlineDepthComposerContext=new j(Q,this.mainComposer,"outlineDepthComposerContext");this.outlineDepthComposerContext.keepResult=true;this.outlineDepthComposerContext.enablePass(this.mirrorBlendPass,false);this.outlineDepthComposerContext.enablePass(this.mirrorClearDepth,false);this.outlineDepthComposerContext.enablePass(this.afterMirrorClearDepth,false);this.outlineDepthComposerContext.enablePass(this.infPlanePass,false);this.outlineDepthComposerContext.setRenderPlugins(this.forwardPass,false);this.outlineDepthComposerContext.setOnEffectComposerChangeCallback(function(U){var T=U.composer.getPostEffectPasses();var S;for(S=0;S<T.length;S++){U.enablePass(T[S],false)}});break;case"PickingGPU":var O;if(P){O=new I.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest")}else{O=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest")}O.generateMipmaps=false;this.pickingGPUComposerContext=new j(O,this.mainComposer,"pickingGPUComposerContext");this.setupPickingComposerContext(this.pickingGPUComposerContext,0,1);break;default:break}},setupPickingComposerContext:function(O,P,K){O.keepResult=true;O.setPassClear(this.initClearPass,true,new I.Color(P),K);O.enablePass(this.infPlanePass,false);O.enablePass(this.mirrorBlendPass,false);O.enablePass(this.mirrorClearDepth,false);O.enablePass(this.afterMirrorClearDepth,false);var M;var L=this.mainComposer.getAllPasses(),N;for(M=0;M<L.length;M++){N=L[M];if(N.renderCuttingElements){O.enablePass(N,false)}}O.enablePass(this.noEffectRobotClearPass,true);O.setPassClear(this.noEffectRobotClearPass,false);O.setPassClearDepth(this.noEffectRobotClearPass,true);O.enablePass(this.noEffectRobotPass,true);O.enablePass(this.noEffectRobotOrthoPass,true);O.enablePass(this.noEffectCanvas2DPass,true);O.enablePass(this.noEffectNozClearPass,true);O.setPassClear(this.noEffectNozClearPass,false);O.setPassClearDepth(this.noEffectNozClearPass,true);O.enablePass(this.noEffectNozPass,true);O.enablePass(this.noEffectAfterHighlightNozClearPass,true);O.setPassClear(this.noEffectAfterHighlightNozClearPass,false);O.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,true);O.enablePass(this.noEffectAfterHighlightNozPass,true);O.setRenderPlugins(this.forwardPass,false);if(this.highlightSinglePass){O.enablePass(this.highlightClearPass,false);O.enablePass(this.highlightSinglePass,false)}},initForwardRender:function(){var O=null,P=null,N;this.initClearPass=new g("initClearPass");this.infPlanePass=new f(null,null,null,null,null,null,"infPlanePass");this.infPlanePass.lockScene=true;this.infPlanePass.setCameraName("cameraBackground");this.shadowPass=new w(null,null,"shadowPass",new I.ShadowMapPlugin(),this.renderer);this.zPrePass=new f(null,null,null,null,null,null,"zPrePass");this.zPrePass.setDisableColorWrite(true);this.zPrePass.forcePolygonOffset=I.PolygonOffsetForceStatus.ENABLED;this.forwardPass=new f(null,null,null,null,null,null,"forwardPass");this.forwardPassStateSortingResult=new I.StateSortingResult();this.forwardPassStateSortingResult.init();this.forwardPass.setStateSortingResult(this.forwardPassStateSortingResult,true);this.cssPass=new F(null,"cssPass");this.backgroundPass=new f(null,null,null,null,null,null,"backgroundPass");this.backgroundPass.idString="background";this.backgroundPass.setMaterialToUse(I.MaterialToUse.ZOnlyMaterial);this.ZOnlyPass=new f(null,null,null,null,null,null,"ZOnlyPass");this.ZOnlyPass.idString="ZOnly";this.ZOnlyPass.setMaterialToUse(I.MaterialToUse.ZOnlyMaterial);this.lensFlarePass=new w(null,null,"lensFlarePass",new I.LensFlarePlugin(),this.renderer);this.forwardPass.setDisableBackFaceCulling(this.disableBackFaceCulling);this.zPrePass.setDisableBackFaceCulling(this.disableBackFaceCulling);if(this.useCompositing){this.mirrorBlendPass=new H(t.blend,undefined,"mirrorBlendPass");P=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint");O=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear")}this.compForwardComposerContext=new j(O,this.mainComposer,"compForwardComposerContext");if(D===-1){if(true){D=true;console.log("#############\n## GSSOCache has been enabled !!!\n#############")}else{D=false}}if(D){this.compForwardComposerContext.setGSSOCache(true);this.forwardPass.setGSSOCache(true)}this.compForwardComposerContext.keepResult=true;this.mainComposer.addPass(this.initClearPass);this.mainComposer.addPass(this.infPlanePass);if(this.mirrorBlendPass!==null){this.mirrorClearDepth=new g("mirrorClearDepth");this.mirrorClearDepth.clear=false;this.mirrorClearDepth.setClearDepth(false);this.afterMirrorClearDepth=new g("afterMirrorClearDepth");this.mainComposer.addPass(this.mirrorBlendPass);this.mainComposer.addPass(this.afterMirrorClearDepth)}this.passSectionCappingFrontFaces=new f(null,null,null,true,false,false,"passSectionCappingFrontFaces");this.passSectionCappingFrontFaces.setRenderCuttingElements(true);this.passSectionCappingFrontFaces.setEnableStencilTest(true);this.passSectionCappingFrontFaces.setEnableStencilWrite(true);this.passSectionCappingFrontFaces.setDisableColorWrite(true);this.passSectionCappingFrontFaces.setDisableDepthWrite(true);this.passSectionCappingFrontFaces.setStencilFunc("ALWAYS");this.passSectionCappingFrontFaces.setStencilOps("INCR_WRAP","DECR_WRAP");this.passSectionCappingFrontFaces.setDisableBackFaceCulling(true);this.passSectionCappingFrontFaces.setHideSurfacesAndUnclippedMeshes(true);this.passSectionCappingFrontFaces.setDisableBackFaceClipPlanes(1);this.passSectionCappingFrontFaces.setRenderPluginsPre(false);this.passSectionCappingFrontFaces.setRenderPluginsPost(false);this.passSectionCappingFrontFaces.ignoreNoZ=true;this.mainComposer.addPass(this.shadowPass);this.mainComposer.addPass(this.cssPass);this.mainComposer.addPass(this.zPrePass);this.mainComposer.addPass(this.forwardPass);this.mainComposer.addPass(this.backgroundPass);this.mainComposer.addPass(this.ZOnlyPass);this.setEffect("OIT",this.useOIT);this.mainComposer.addPass(this.lensFlarePass);this.mainComposer.addPass(this.passSectionCappingFrontFaces);this.compForwardComposerContext.enablePass(this.zPrePass,false);this.compForwardComposerContext.setRenderPlugins(this.forwardPass,true);this.compForwardComposerContext.enablePass(this.shadowPass,true);this.compForwardComposerContext.enablePass(this.lensFlarePass,true);this.compForwardComposerContext.enablePass(this.backgroundPass,true);this.compForwardComposerContext.enablePass(this.ZOnlyPass,true);this.compForwardComposerContext.enablePass(this.cssPass,true);this.passMirrorBlur=new H(E.PoissonBlur,undefined,"passMirrorBlur");this.passMirrorBlur.material.needsUpdate=true;this.passMirrorBlur.disabledByDefault=true;this.passMirrorBlur1=new H(E.PoissonBlur,undefined,"passMirrorBlur1");this.passMirrorBlur1.disabledByDefault=true;this.passMirrorBlur2=new H(E.PoissonBlur,undefined,"passMirrorBlur2");this.passMirrorBlur2.disabledByDefault=true;this.passMirrorBlur3=new H(E.PoissonBlur,undefined,"passMirrorBlur3");this.passMirrorBlur3.disabledByDefault=true;this.passMirrorBlur.uniforms.invSize.value.x=1/this.viewportWidth;this.passMirrorBlur.uniforms.invSize.value.y=1/this.viewportHeight;this.passMirrorBlur3.uniforms.invSize=this.passMirrorBlur2.uniforms.invSize=this.passMirrorBlur1.uniforms.invSize=this.passMirrorBlur.uniforms.invSize;this.mainComposer.addPass(this.passMirrorBlur);this.mainComposer.addPass(this.passMirrorBlur1);this.mainComposer.addPass(this.passMirrorBlur2);this.mainComposer.addPass(this.passMirrorBlur3);this.noEffectNozClearPass=new g("noEffectNozClearPass");this.noEffectNozClearPass.idString="noz";this.noEffectNozPass=new f(null,null,null,undefined,undefined,undefined,"noEffectNozPass");this.noEffectNozPass.idString="noz";this.mainComposer.addPass(this.noEffectNozClearPass);this.mainComposer.addPass(this.noEffectNozPass);if(I.mobileVersion){this.highlightClearPass=new g("highlightClearPass");this.mainComposer.addPass(this.highlightClearPass);this.highlightSinglePass=new f(null,null,null,undefined,undefined,undefined,"highlightSinglePass");this.highlightSinglePass.setRenderPluginsPre(false);this.highlightSinglePass.setRenderPluginsPost(false);this.highlightSinglePass.setMaterialToUse(I.MaterialToUse.highlightMaterial);this.highlightSinglePass.setDisableBackFaceCulling(true);this.mainComposer.addPass(this.highlightSinglePass)}this.noEffectAfterHighlightNozClearPass=new g("noEffectAfterHighlightNozClearPass");this.noEffectAfterHighlightNozClearPass.idString="afterHighlightNoZ";this.noEffectAfterHighlightNozClearPass.order=60;this.noEffectAfterHighlightNozPass=new f(null,null,null,undefined,undefined,undefined,"noEffectAfterHighlightNozPass");this.noEffectAfterHighlightNozPass.idString="afterHighlightNoZ";this.noEffectAfterHighlightNozPass.order=61;this.noEffectAfterHighlightNozPass.setCameraName("mainNoJittering");this.mainComposer.addPass(this.noEffectAfterHighlightNozClearPass);this.mainComposer.addPass(this.noEffectAfterHighlightNozPass);this.noEffectRobotClearPass=new g("noEffectRobotClearPass");this.noEffectRobotClearPass.order=70;this.noEffectRobotPass=new f(null,null,null,undefined,undefined,undefined,"noEffectRobotPass");this.noEffectRobotPass.idString="robot";this.noEffectRobotPass.setDisableClippingPlanes(true);this.noEffectRobotPass.setDisableToneMapping(true);this.noEffectRobotPass.isRobotPass=true;this.noEffectRobotPass.setCameraName("connectedRobotCamera");this.noEffectRobotPass.order=71;this.noEffectRobotPass.setForceMaterialMode(true);this.noEffectRobotOrthoPass=new f(null,null,null,undefined,undefined,undefined,"noEffectRobotOrthoPass");this.noEffectRobotOrthoPass.idString="robotOrtho";this.noEffectRobotOrthoPass.setDisableClippingPlanes(true);this.noEffectRobotOrthoPass.setCameraName("robotCameraOrtho");this.noEffectRobotOrthoPass.order=72;this.noEffectRobotOrthoPass.isRobotPass=true;this.noEffectRobotOrthoPass.setDisableToneMapping(true);this.noEffectRobotOrthoPass.setForceMaterialMode(true);this.noEffectCanvas2DPass=new f(null,null,null,undefined,undefined,undefined,"noEffectCanvas2DPass");this.noEffectCanvas2DPass.idString="canvas2D";this.noEffectCanvas2DPass.disabledByDefault=true;this.noEffectCanvas2DPass.setDisableClippingPlanes(true);this.noEffectCanvas2DPass.order=100000;this.noEffectCanvas2DPass.setDisableToneMapping(true);this.noEffectCanvas2DPass.setCameraName("mainNoJittering");this.mainComposer.addPass(this.noEffectRobotClearPass);this.mainComposer.addPass(this.noEffectRobotPass);this.mainComposer.addPass(this.noEffectRobotOrthoPass);this.mainComposer.addPass(this.noEffectCanvas2DPass);this.compForwardComposerContext.enablePass(this.noEffectCanvas2DPass,true);if(this.useCompositing){this.compMirrorComposerContext=new j(P,this.mainComposer,"compMirrorComposerContext");this.compMirrorComposerContext.linkToShaderPassUniform(this.mirrorBlendPass,this.mirrorBlendPass.uniforms.tReflectedScene);this.compMirrorComposerContext.enablePass(this.mirrorBlendPass,false);this.compMirrorComposerContext.enablePass(this.mirrorClearDepth,false);this.compMirrorComposerContext.enablePass(this.afterMirrorClearDepth,false);this.compMirrorComposerContext.enableRenderCuttingElementsPasses(true);this.compMirrorComposerContext.enablePass(this.infPlanePass,false);this.compMirrorComposerContext.enablePass(this.shadowPass,true);this.compMirrorComposerContext.enablePass(this.noEffectRobotClearPass,false);this.compMirrorComposerContext.enablePass(this.noEffectRobotOrthoPass,false);this.compMirrorComposerContext.setPassClear(this.noEffectRobotClearPass,false);this.compMirrorComposerContext.setPassClearDepth(this.noEffectRobotClearPass,true);this.compMirrorComposerContext.enablePass(this.noEffectNozPass,false);this.compMirrorComposerContext.setPassClear(this.noEffectNozClearPass,false);this.compMirrorComposerContext.setPassClearDepth(this.noEffectNozClearPass,true);this.compMirrorComposerContext.enablePass(this.noEffectAfterHighlightNozPass,false);this.compMirrorComposerContext.setPassClear(this.noEffectAfterHighlightNozClearPass,false);this.compMirrorComposerContext.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,true);this.compMirrorComposerContext.setCameraName("mirrorCamera");this.compMirrorComposerContext.setBeforeRenderCB(function M(S){S.composer.renderer.initWebGLObjects(S.composer.renderScene);var T=S.composer.renderScene.getAllWebGLObjects(S.composer.renderer.currentFrameIndex);var R;var Q;for(Q=0;Q<T.length;Q++){if(T[Q]===null){continue}R=T[Q].object;if(R.disableMirror&&R.visible){R.visible=false;R.disableMirror=2}}});this.compMirrorComposerContext.setAfterRenderCB(function K(S){var T=S.composer.renderScene.getAllWebGLObjects(S.composer.renderer.currentFrameIndex);var R;var Q;for(Q=0;Q<T.length;Q++){if(T[Q]===null){continue}R=T[Q].object;if(R.disableMirror===2){R.visible=true;R.disableMirror=1}}});var L=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint");L.generateMipmaps=false;this.compositeClearPass=new g("compositeClearPass");this.compositeClearPass.invertTarget=true;this.canvas2DPass=new f(null,null,null,undefined,undefined,undefined,"canvas2DPass");this.canvas2DPass.order=1100;this.canvas2DPass.idString="canvas2D";this.canvas2DPass.setDisableToneMapping(true);this.canvas2DPass.setDisableClippingPlanes(true);this.compositeClearPass.order=5;this.setEffect("ToneMapping",true);this.ToneMappingEffect.setBrightness(this.brightness);this.ToneMappingEffect.setToneMapping(this.tonemapping)}this.compForwardComposerContext.setPassClear(this.noEffectRobotClearPass,false);this.compForwardComposerContext.setPassClearDepth(this.noEffectRobotClearPass,true);this.compForwardComposerContext.setPassClear(this.noEffectNozClearPass,false);this.compForwardComposerContext.setPassClearDepth(this.noEffectNozClearPass,true);this.compForwardComposerContext.setPassClear(this.noEffectAfterHighlightNozClearPass,false);this.compForwardComposerContext.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,true)},resetClippingScene:function(){this.clippingScene=null},_enableZPrePass:function(K){if(!this.forwardPass){return}if(K){this.forwardPass.setDisableDepthWrite(true);this.forwardPass.forcePolygonOffset=I.PolygonOffsetForceStatus.DISABLED;this.compForwardComposerContext.enablePass(this.zPrePass,true);this.compMirrorComposerContext&&this.compMirrorComposerContext.enablePass(this.zPrePass,true)}else{this.forwardPass.forcePolygonOffset=I.PolygonOffsetForceStatus.DEFAULT;this.forwardPass.setDisableDepthWrite(false);this.compForwardComposerContext.enablePass(this.zPrePass,false);this.compMirrorComposerContext&&this.compMirrorComposerContext.enablePass(this.zPrePass,false)}},dispose:function(){if(this.compForwardComposerContext){this.compForwardComposerContext.dispose();this.compForwardComposerContext=null}if(this.compMirrorComposerContext){this.compMirrorComposerContext.dispose();this.compMirrorComposerContext=null}if(this.depthComposerContext){this.depthComposerContext.dispose();this.depthComposerContext=null}if(this.normalComposerContext){this.normalComposerContext.dispose();this.normalComposerContext=null}if(this.normalDepthComposerContext){this.normalDepthComposerContext.dispose();this.normalDepthComposerContext=null}if(this.outlineDepthComposerContext){this.outlineDepthComposerContext.dispose();this.outlineDepthComposerContext=null}if(this.pickingGPUComposerContext){this.pickingGPUComposerContext.dispose();this.pickingGPUComposerContext=null}if(this.lensFlarePass){this.lensFlarePass.dispose();this.lensFlarePass=null}for(var L=0;L<this.allEffects.length;L++){if(this.allEffects[L]&&this.allEffects[L].dispose){this.allEffects[L].dispose()}}for(var L=0;L<this.customEffects.length;L++){if(this.customEffects[L]&&this.customEffects[L].dispose){this.customEffects[L].dispose()}}this.allEffects=null;this.customEffects=null;this.mainComposer.dispose();this.renderer.dispose();var K;for(K in this){if(this.hasOwnProperty(K)){this[K]=null}}},isDeviceCompatibleWithSSAO:function(){return this.renderer.supportsFloatTextures()},isDeviceCompatibleWithOIT:function(){if(!this.renderer.supportsFloatTextures()){console.warn("Warning: your device is not compatible with OITs")}return this.renderer.supportsFloatTextures()},setDisableBackFaceCulling:function(K){this.disableBackFaceCulling=K;if(this.forwardPass){this.forwardPass.setDisableBackFaceCulling(this.disableBackFaceCulling);this.zPrePass.setDisableBackFaceCulling(this.disableBackFaceCulling)}},clearCameraSystemData:function(){this.superFinalComposer=null},recompileAllShaders:function(){this.renderer.recompileAllShaders()},updateClippingScene:function(K){var R=K.getBoundingSphere();var O,M=new I.Vector3();for(O=0;O<this.renderer.clipPlanes.length;O++){var P=this.renderer.clipPlanes[O];P.projectPoint(R.center,M);var U=this.clippingScene.children[O];U.matrixAutoUpdate=false;U.matrixWorldNeedsUpdate=false;var Q=P.normal.clone().multiplyScalar(-1);var N=-P.constant;var T=new I.Vector3();var S=new I.Vector3(1,0,0);var L=1;if(Math.abs(Q.y)<=0.01&&Math.abs(Q.z)<=0.01){S=new I.Vector3(0,1,0)}T.crossVectors(Q,S);T.normalize();S.crossVectors(Q,T);U.matrixWorld.set(L*T.x,L*S.x,L*Q.x,M.x,L*T.y,L*S.y,L*Q.y,M.y,L*T.z,L*S.z,L*Q.z,M.z,0,0,0,1)}}});Object.defineProperty(l.prototype,"gpuPickingTolerance",{get:function(){return this.renderer._gpuPickingTolerance},set:function(K){this.renderer._gpuPickingTolerance=K;if(this.smallTargetPicking){if(this.pickingGPUComposerContext){this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1);this.pickingGPUComposerContext.needsUpdate=true}if(this.normalComposerContext){this.normalComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1);this.normalComposerContext.needsUpdate=true}if(this.depthComposerContext){this.depthComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1);this.depthComposerContext.needsUpdate=true}}}});Object.defineProperty(l.prototype,"smallTargetPicking",{get:function(){return this.renderer._smallTargetPicking},set:function(K){this.renderer._smallTargetPicking=K;if(K){if(this.pickingGPUComposerContext){this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)}if(this.normalComposerContext){this.normalComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)}if(this.depthComposerContext){this.depthComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)}}else{if(this.pickingGPUComposerContext){this.pickingGPUComposerContext.setSize(this.viewportWidth,this.viewportHeight)}if(this.normalComposerContext){this.normalComposerContext.setSize(this.viewportWidth,this.viewportHeight)}if(this.depthComposerContext){this.depthComposerContext.setSize(this.viewportWidth,this.viewportHeight)}}}});l.testMode=false;return l});define("Visualization/WebGLV6Renderer",["DS/Visualization/WebGLV6Renderer","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/WebGLV6Renderer");return b});define("DS/Visualization/Ambience",["DS/Visualization/ThreeJS_DS","DS/Effects/ConvertCubemapToLatlong","DS/Visualization/SceneGraphFactory","DS/Visualization/Utils"],function(h,j,g,a){var e=function(n,o){switch(n){case"cubemap":return new h.CubeEnvMapping();break;case"environment":return new h.LatLongReflectionMapping();break;case"latlong":return new h.LatLongEnvMapping();break;case"backplate":return new h.SimpleEnvMapping()}};var c=function(r,u){r=r||{};var t=r.image!==undefined?r.image:null;var s=r.format!==undefined?r.format:null;var p=r.type!==undefined?r.type:"url";var q=r.texture!==undefined?r.texture:null;var o=u!==undefined?u:null;var n=function(){console.log("loading image error")};this.stream=function(){if(q){return{texture:q,format:s}}return null};this.getTexture=function(){return q};this.getImage=function(){return t};this.getFormat=function(){return s};this.getType=function(){return p};this.setTexture=function(v){q=v};this.setFormat=function(v){s=v};this.setType=function(v){p=v};this.loadImage=function(v){var w=this.getImage();if(this.getType()=="url"){if(this.getFormat()=="hdr"){q=h.ImageUtils.loadHDRTexture(w,v,o,n,false,false);q.minFilter=h.NearestFilter;q.magFilter=h.NearestFilter}else{if(this.getFormat()=="dds"){q=h.ImageUtils.loadCompressedTexture(w,v,o)}else{q=new h.ImageUtils.loadTexture(w,v,o,null,h.ImageUtils.crossOriginPolicy)}}}if(this.getType()=="urlCube"){q=h.ImageUtils.loadTextureCube(w,v,o)}else{if(w&&w instanceof h.Texture){q=w;if(q.loadEndStatus==="complete"){o()}else{q.onLoadCallbacks.push(o)}}}}};var k=function(){var u=false;this.needUpdate=false;this.needUpdateParameters=false;var w="latlong";var n=[];var o=0;var q=new c();var v="bestFit";var r=1;var x=null;var p=0;var s=this;var t=function(){s.needUpdate=true};this.setFromJson=function(y){u=true;this.needUpdate=true;if(y.type){w=y.type}if(y.sizeScaling){v=y.sizeScaling}if(y.intensity){r=y.intensity}if(y.blur){p=y.blur}if(y.horizonHeight){o=y.horizonHeight}if(y.image&&y.image.texture){q.setTexture(y.image.texture);q.setFormat(y.image.format)}if(y.colors){for(var z=0;z<y.colors.length;z++){n.push(new h.Color().setRGB(y.colors[z][0],y.colors[z][1],y.colors[z][2]))}}};this.stream=function(){if(u){var A={};A.type=w;if(n.length){var z=[];for(var y=0;y<n.length;y++){z.push([n[y].r,n[y].g,n[y].b])}A.colors=z}A.horizonHeight=o;A.sizeScaling=v;A.intensity=r;A.blur=p;A.image=q.stream();return A}return null};this.isActivated=function(){return u};this.getType=function(){return w};this.initDefaultColors=function(y){n=[];for(var z=0;z<y;z++){n.push(new h.Color())}};this.getColors=function(){switch(this.getType()){case"gradient":if(n.length!=2){this.initDefaultColors(2)}break;case"gradient3":if(n.length!=3){this.initDefaultColors(3)}break;case"gradientWithHorizon":if(n.length!=4){this.initDefaultColors(4)}break}return n};this.getHorizonHeight=function(){return o};this.getImage=function(){return q};this.getSizeScaling=function(){return v};this.getIntensity=function(){return r};this.getBlur=function(){return p};this.getBackplateCB=function(){return x};this.setActivated=function(y){if(y!=u){this.needUpdate=true}u=y};this.setType=function(y){if(w!=y){w=y;this.needUpdate=true}if(!u){this.setActivated(true)}};this.setColors=function(y){n=y;var z;switch(n.length){case 2:z="gradient";break;case 3:z="gradient3";break;case 4:z="gradientWithHorizon";break;default:return false}this.setType(z);this.needUpdateParameters=true};this.setHorizonHeight=function(y){o=y;this.needUpdateParameters=true};this.setSizeScaling=function(y){v=y;this.needUpdateParameters=true};this.setIntensity=function(y){r=y;this.needUpdateParameters=true};this.setBlur=function(y){p=y;this.needUpdateParameters=true};this.setBackplateCB=function(y){x=y;this.needUpdateParameters=true};this.hasGradient=function(){return(u&&(w=="gradient"||w=="gradientWithHorizon"))};this.loadImage=function(y){y.type="url";if(y&&y.image&&y.image instanceof h.Texture){y.type="THREETexture"}if(y&&y.image&&y.image instanceof Array){y.type="urlCube"}q=new c(y,t);q.loadImage(e(this.getType(),this.getSizeScaling()))};this.withImage=function(){if(!q.getTexture()){return false}var y=this.getType();if((y=="cubemap")||(y=="latlong")||(y=="backplate")){return true}else{return false}}};var d=function(){var o=false;this.needUpdate=false;this.needUpdateParameters=false;var q="sphere";var p=5000;var n=new h.Vector3(0,0,0.5);this.setFromJson=function(r){o=true;this.needUpdate=true;if(r.type){q=r.type}if(r.size){p=r.size}if(r.shootPosition){n.set(r.shootPosition[0]/r.size,r.shootPosition[1]/r.size,r.shootPosition[2]/r.size)}};this.stream=function(){if(o){var r={};r.type=q;r.size=p;r.shootPosition=n.toArray();return r}return null};this.isActivated=function(){return o};this.getType=function(){return q};this.getSize=function(){return p};this.getShootPosition=function(){return n};this.getWorldShootPosition=function(r){var s=new h.Matrix4().extractRotation(r);return n.clone().applyMatrix4(s)};this.setActivated=function(r){if(r!=o){this.needUpdate=true}o=r};this.setType=function(r){q=r;this.needUpdate=true};this.setSize=function(r){p=r;this.needUpdateParameters=true};this.setShootPosition=function(r){n=r;this.needUpdateParameters=true}};var f=function(){var o=false;this.needUpdate=false;this.needUpdateParameters=false;var t="transparent";var n=0;var u=0;var r=1;var p=0;var s=null;var q=true;this.setFromJson=function(v){o=true;this.needUpdate=true;if(v.type){t=v.type}if(v.height!==undefined){n=v.height}if(v.reflectivity!==undefined){u=v.reflectivity}if(v.glossiness!==undefined){r=v.glossiness}if(v.shadowIntensity!==undefined){p=v.shadowIntensity}if(v.material){s=v.material}};this.stream=function(){if(o){var v={};v.type=t;v.height=n;v.autoHeight=q;v.reflectivity=u;v.glossiness=r;v.shadowIntensity=p;v.material=s;return v}return null};this.isActivated=function(){return o};this.getType=function(){return t};this.getHeight=function(){return n};this.getAutoHeight=function(){return q};this.getReflectivity=function(){return u};this.getGlossiness=function(){return r};this.getShadowIntensity=function(){return p};this.getMaterial=function(){return s};this.setActivated=function(v){if(v!=o){this.needUpdate=true;this.needUpdateParameters=true}o=v};this.setType=function(v){if(o&&(t!=v)){this.needUpdate=true}t=v};this.setHeight=function(v){n=v;this.needUpdateParameters=true};this.setAutoHeight=function(v){q=v;this.needUpdateParameters=true};this.setReflectivity=function(v){if((u===0||v===0)&&(u>0||v>0)){this.needUpdate=true}u=v;this.needUpdateParameters=true};this.setGlossiness=function(v){r=v;this.needUpdateParameters=true};this.setShadowIntensity=function(v){if((p===0||v===0)&&(p>0||v>0)){this.needUpdate=true;this.needUpdateParameters=true}p=v};this.setMaterial=function(v){s=v;this.needUpdateParameters=true}};var m=function(x){var t=false;this.needUpdate=false;this.needUpdateParameters=false;var u=x;var o=new c();var r="latlong";var n=new h.Color(16777215);var p=1;var v=new h.Matrix4();var w=new h.Matrix4();var q=this;var s=function(){q.needUpdate=true};this.setFromJson=function(B,A){t=true;if(B.projection){r=B.projection}if(B.emissionColor){n=n.setRGB(B.emissionColor[0],B.emissionColor[1],B.emissionColor[2])}if(B.emissionValue){p=B.emissionValue}if(u){if(B.matrix){var y=new h.Matrix4().setFromArray(B.matrix);v.multiplyMatrices(v,y)}this.updateMatrix()}else{v.rotateZ(-Math.PI/2);if(B.matrix){var y=new h.Matrix4().setFromArray(B.matrix);var z=new h.Matrix4().getInverse(y);v.multiplyMatrices(v,z)}}if(B.image&&B.image.texture){o.setTexture(B.image.texture);o.setFormat(B.image.format);this.needUpdate=true}};this.updateMatrix=function(){w.identity();w.rotateZ(-Math.PI/2);var y=new h.Matrix4().getInverse(v);w.multiplyMatrices(w,y)};this.stream=function(){if(t){var y={};y.projection=r;y.emissionColor=[n.r,n.g,n.b];y.emissionValue=p;y.matrix=v.elements.slice(0);y.image=o.stream();return y}return null};this.isActivated=function(){return t};this.getImage=function(){return o};this.getProjection=function(){return scale};this.getValue=function(){return value};this.getMatrix=function(){return v};this.getInverseMatrix=function(){return w};this.getIntensity=function(){return p};this.setActivated=function(y){if(y!=t){this.needUpdate=true;t=y}};this.setValue=function(y){value=y;this.needUpdateParameters=true};this.setIntensity=function(y){p=y;this.needUpdateParameters=true};this.setMatrix=function(y){v=y;if(u){this.updateMatrix()}this.needUpdateParameters=true};this.loadImage=function(z){z.type="url";if(z&&z.image&&z.image instanceof h.Texture){z.type="THREETexture"}if(z&&z.image&&z.image instanceof Array){z.type="urlCube"}var y;if(z.cb){y=function(){z.cb();s()}}else{y=s}o=new c(z,y);o.loadImage(new h.LatLongReflectionMapping())};this.updateMatrix()};var l=function(){var o=new h.Vector3(0,0,0);var p=new h.Vector3(0,0,1);var r=new h.Vector3(0,0,0);var n=1;var q=true;this.needUpdateParameters=false;this.setFromJson=function(s){if(s.groundPosition){o=s.groundPosition}if(s.groundNormal){p=s.groundNormal}if(s.sceneHeight){r=s.sceneHeight}if(s.groundScale){n=s.groundScale}if(s.withGround){q=s.withGround}};this.updateFromMatrix=function(s){o.getPositionFromMatrix(s);var t=new h.Matrix4().extractRotation(s);p.set(0,0,1);p.applyMatrix4(t)};this.stream=function(){var s={};s.groundPosition=o;s.groundNormal=p;s.sceneHeight=r;s.groundScale=n;s.withGround=q;return s};this.isWithGround=function(){return q};this.getGroundPosition=function(){return o};this.getGroundNormal=function(){return p};this.getSceneHeight=function(){return r};this.getGroundScale=function(){return n};this.setGroundPosition=function(s){o.copy(s);this.needUpdateParameters=true};this.setWithGround=function(s){q=s};this.setGroundNormal=function(s){console.warn("DEPRECATED: use setTransfrom instead of setGroundNormal")};this.setSceneHeight=function(s){r=s;this.needUpdateParameters=true};this.setGroundScale=function(s){n=s;this.needUpdateParameters=true}};var b=function(ae){var r=this;if(!ae){ae={}}var U=ae.viewer!==undefined?ae.viewer:null;var N=ae.roughnessMap!==undefined?ae.roughnessMap:null;var x="";var ag=ae.v2!==undefined?ae.v2:false;var W=new k();var s=new d();var p=new f();var H=new m(ag);var ab=new l();var K=new h.Matrix4();var L=new h.Matrix4();var I={};var z=false;var ac=false;var X=[];var y=[];if(ae.finiteEnv){s.setActivated(true)}var B=null;if(ae.autoGroundOffset===false){p.setAutoHeight(false)}var o=new h.Color(0);var A=1;var ad=null;var G=1920;var C=1080;var v=1;var q=false;this.needUpdateIBL=false;this.updateAmbience=function(){Y();t();this.needUpdateIBL=true};this.setGroundOptions=function(ah){if(U){U.setGroundOptions(ah);I=U._getGroundOptions()}};this.updateMatrix=function(){L.identity();L.rotateZ(-Math.PI/2);var ah=new h.Matrix4().getInverse(K);ah.elements[12]=K.elements[12];ah.elements[13]=K.elements[13];ah.elements[14]=K.elements[14];L.multiplyMatrices(L,ah)};this.loadFrom3dx=function(am,ah,an){var aj=am;if(an){ag=true}if(aj.name){x=aj.name}if(ag){if(aj.transform){var ak=new h.Matrix4().setFromArray(aj.transform);K.multiplyMatrices(K,ak);ab.updateFromMatrix(K)}this.updateMatrix()}else{K.rotateZ(-Math.PI/2);if(aj.transform){var ak=new h.Matrix4().setFromArray(aj.transform);var al=new h.Matrix4().getInverse(ak);al.elements[12]=ak.elements[12];al.elements[13]=ak.elements[13];al.elements[14]=ak.elements[14];K.multiplyMatrices(K,al)}}if(aj.backgroundGeometry){s.setFromJson(aj.backgroundGeometry)}if(aj.ground){p.setFromJson(aj.ground)}else{if(an){this.setGroundGeometry(false)}}if(aj.environmentLight){H.setFromJson(aj.environmentLight,an)}p.setAutoHeight(false);if(aj.background){if(aj.background.type=="color"&&aj.background.type=="color"){var ai=aj.background.colors[0];o.setRGB(ai[0],ai[1],ai[2]);A=ai[3];U.setBackgroundColor(o.getHex(),A)}else{W.setFromJson(aj.background)}}if(ah){this.loadImageFrom3dx(ah)}else{this.needUpdateIBL=true}};this.loadImageFrom3dx=function(ah){if(ae.images){if(ae.images.background){W.loadImage({image:ae.images.background.data,format:ae.images.background.format})}if(ae.images.environmentLight){if(ae.images.environmentLight.format=="hdr"){var ai=function(){r.needUpdateIBL=true;var ao=r.getEnvironmentLight().getImage().getTexture();if(ao&&ao.image){var ak=ao.image;var am=parseInt(ak.width,10);var aj=parseInt(ak.height,10);if(!isNaN(am)&&!isNaN(aj)){if(!((aj*2)==am)){console.warn("ibl width should be 2x ibl height");N=ao}}if(am<8||aj<4){var an=new Uint8Array(8*4*4);for(var al=0;al<8*4;al++){an[al*4]=ak.data[0];an[al*4+1]=ak.data[1];an[al*4+2]=ak.data[2];an[al*4+3]=ak.data[3]}ak.height="4";ak.width="8";ak.data=an;N=null}}};H.loadImage({cb:ai,image:ae.images.environmentLight.data,format:ae.images.environmentLight.format})}else{if(ae.images.environmentLight.format=="dds"){var ai=function(){if(!ad){ad=new j(U.renderer.renderer,U.renderer.renderTargetPool)}var aj=H.getImage().getTexture();ad.setEnvMap(aj,1);ad.execute();var ak=ad.getResultRGBE(true);H.getImage().setTexture(ak);r.needUpdateIBL=true;N=null};H.loadImage({cb:ai,image:ae.images.environmentLight.data,format:ae.images.environmentLight.format})}else{if(ae.images.environmentLight.format=="png"){var ai=function(){N=H.getImage().getTexture();r.needUpdateIBL=true}}}}}else{this.needUpdateIBL=true}}};this.isFiniteMode=function(){return s.isActivated()};this.getTransform=function(){return K};this.setTransform=function(ah){K=ah;if(ag){this.updateMatrix();ab.updateFromMatrix(K)}q=true};this.getEnvironmentLightMatrix=function(ah){if(ah&&ag){return H.getInverseMatrix()}return H.getMatrix()};this.getGroundOptions=function(){return I};this.setEnvironmentLightMatrix=function(ah){H.setMatrix(ah);q=true};this.getBackgroundGeometryEditor=function(){return ab};this.getBackgroundGeometry=function(){return s};this.getBackground=function(){return W};this.getGround=function(){return p};this.getEnvironmentLight=function(){return H};this.getBackgroundColor=function(){return o};this.getBackgroundAlpha=function(){return A};this.setBackgroundAlpha=function(ah){A=ah};this.setBackgroundColor=function(ah){o=new h.Color(ah)};this.update=function(){if(W.needUpdate){t();W.needUpdate=false;W.needUpdateParameters=false;H.needUpdateParameters=false}if(s.needUpdate){t();s.needUpdate=false;W.needUpdateParameters=false;H.needUpdateParameters=false;s.needUpdateParameters=false}if(H.needUpdate){H.needUpdate=false}if(p.needUpdate){p.needUpdate=false;Y()}if(q||p.needUpdateParameters||W.needUpdateParameters||H.needUpdateParameters||s.needUpdateParameters||ab.needUpdateParameters){V();W.needUpdateParameters=false;H.needUpdateParameters=false;p.needUpdateParameters=false;s.needUpdateParameters=false;ab.needUpdateParameters=false;q=false}};var t=function(){if(W.isActivated()){switch(W.getType()){case"gradient":case"gradient3":case"gradientWithHorizon":P();break;case"cubemap":if(s.isActivated()){if(s.getType()=="sphere"){O()}}else{T()}break;case"latlong":if(s.isActivated()){if(s.getType()=="sphere"){O()}}else{F()}break;case"backplate":af();break;default:return false}}if(B){B.side=h.DoubleSide;B.depthTest=false;B.force=true;B.forceSide=true}V()};var w=function(){if(U&&U.renderer&&U.renderer.mirrorBlendPass){return U.renderer.mirrorBlendPass}};var V=function(){if(W.isActivated()){if(W.withImage()){var ai=W.getImage();B.uniforms.tEnvMap.value=ai.getTexture();if(B.uniforms.tEnvMap.value.envMapExposure){B.uniforms.tEnvMap.value.envMapExposure=W.getIntensity()}B.uniforms.envMapExposure.value=W.getIntensity();if(B.defines.HDR!=(ai.getFormat()=="hdr")){B.defines.HDR=(ai.getFormat()=="hdr");B.needsUpdate=true}if(B.defines.sRGB==(ai.getFormat()=="hdr")){B.defines.sRGB=!(ai.getFormat()=="hdr");B.needsUpdate=true}}if(s.isActivated()){if(W.getType()=="gradient"||W.getType()=="gradientWithHorizon"||W.getType()=="gradient3"){u(W.getType()=="gradientWithHorizon")}else{if(W.getType()=="backplate"){n()}else{R()}}}else{if(W.getType()=="latlong"){D()}if(W.getType()=="cubemap"){Z()}if(W.getType()=="backplate"){n()}if(W.getType()=="gradient"||W.getType()=="gradientWithHorizon"||W.getType()=="gradient3"){u(W.getType()=="gradientWithHorizon")}}}if(H.isActivated()){var ah=H.getImage().getTexture();if(ah){ah.envMapExposure=H.getIntensity()}if(N){N.envMapExposure=H.getIntensity()}}if(p.isActivated()){M()}};var M=function(){if(p.getReflectivity()>0){var ah=w();if(ah){ah.uniforms.reflectivity.value=p.getReflectivity()}}};var u=function(al){B.uniforms.colors.value=[];var ah=B.uniforms.colors.value;var ai=W.getColors();for(var ak=0;ak<ai.length;ak++){var aj=ai[ak];ah.push(aj.r);ah.push(aj.g);ah.push(aj.b)}if(al){B.uniforms.horizonHeight.value=W.getHorizonHeight()}};var n=function(){J()};var Z=function(){var ai=W.getImage();var ah=ai.getTexture();if(ah){if(ag){B.uniforms.ambienceMatrix.value=L}else{B.uniforms.ambienceMatrix.value=K}}};var D=function(){var ak=W.getImage();var aj=ak.getTexture();if(aj){aj.minFilter=h.LinearFilter;var ai=2048;var ah=1024;if(aj.image){ai=aj.image.width;ah=aj.image.height}else{if(aj.width&&aj.height){ai=aj.width;ah=aj.height}}B.uniforms.envMapHDRSize.value.x=parseInt(ai);B.uniforms.envMapHDRSize.value.y=parseInt(ah);if(ag){B.uniforms.ambienceMatrix.value=L}else{B.uniforms.ambienceMatrix.value=K}if(W.getBlur()&&N){B.uniforms.tEnvMap2.value=N;B.uniforms.blurCoef.value=W.getBlur();if(!B.defines.ENVMAP2){B.defines.ENVMAP2=true;B.needsUpdate=true}}}};var R=function(){var ak=W.getImage();var aj=ak.getTexture();if(aj){aj.minFilter=h.LinearFilter;var ai=2048;var ah=1024;if(aj.image){ai=aj.image.width;ah=aj.image.height}else{if(aj.width&&aj.height){ai=aj.width;ah=aj.height}}B.uniforms.tEnvMap.value=aj;if(ag){B.uniforms.ambienceMatrix.value=L;B.uniforms.groundHeight.value=s.getWorldShootPosition(K)}else{B.uniforms.ambienceMatrix.value=K;B.uniforms.groundHeight.value=s.getShootPosition()}B.uniforms.envMapHDRSize.value.x=parseInt(ai);B.uniforms.envMapHDRSize.value.y=parseInt(ah);B.uniforms.groundPosition.value=ab.getGroundPosition();B.uniforms.groundNormal.value=ab.getGroundNormal();B.uniforms.groundOffset.value=p.getHeight();B.uniforms.sceneHeight.value=ab.getSceneHeight();B.uniforms.groundRadius.value=s.getSize();B.uniforms.groundScale.value=ab.getGroundScale();B.uniforms.withGround.value=ab.isWithGround();if(B.defines.LATLONG_MAP!=!(W.getType()=="cubemap")){B.defines.LATLONG_MAP=!(W.getType()=="cubemap");B.needsUpdate=true}}};var P=function(){var ah=W.getType();var aj;switch(ah){case"gradient":aj=h.GradientBackgroundShader2;break;case"gradient3":aj=h.GradientBackgroundShader3;break;case"gradientWithHorizon":aj=h.GradientBackgroundShader4;break;default:return false}var ai={fragmentShader:aj.fragmentShader,vertexShader:aj.vertexShader,uniforms:aj.uniforms,};B=new h.ShaderMaterial(ai)};var O=function(){var ai=h.FiniteEnvMap;var ah={fragmentShader:ai.fragmentShader,vertexShader:ai.vertexShader,uniforms:ai.uniforms,defines:ai.defines};ai.defines.LATLONG_MAP=(W.getType()=="latlong");if(ag){ai.defines.AMBIENCE_V2=true}else{ai.defines.AMBIENCE_V2=false}B=new h.ShaderMaterial(ah)};var Y=function(){if(U){if(p.isActivated()&&p.getReflectivity()>0){U.setMirror(true,undefined,null,p.getReflectivity(),p.getGlossiness())}else{U.setMirror(false)}if(p.isActivated()&&p.getShadowIntensity()>0){U.setShadowPlane(true);U.setGroundShadow(true)}else{U.setGroundShadow(false)}}};var F=function(){var aj=W.getImage();var ai=h.LatLongMapShader;var ah={fragmentShader:ai.fragmentShader,vertexShader:ai.vertexShader,uniforms:ai.uniforms,defines:ai.defines};ah.defines.HDR=(aj.getFormat()=="hdr");ah.defines.sRGB=(!(aj.getFormat()=="hdr"));if(N&&(W.getBlur()>=0)){ah.defines.ENVMAP2=true}ah.defines.sRGB=(!(aj.getFormat()=="hdr"));B=new h.ShaderMaterial(ah)};var T=function(){var ai=h.CubeMapShader;var ah={fragmentShader:ai.fragmentShader,vertexShader:ai.vertexShader,uniforms:ai.uniforms,defines:ai.defines};B=new h.ShaderMaterial(ah)};var af=function(){var aj=W.getImage();var ai=h.SimpleMapShader;var ah={fragmentShader:ai.fragmentShader,vertexShader:ai.vertexShader,uniforms:h.UniformsUtils.clone(h.SimpleMapShader.uniforms),defines:ai.defines};ah.defines.HDR=(aj.getFormat()=="hdr");ah.defines.sRGB=(!(aj.getFormat()=="hdr"));B=new h.ShaderMaterial(ah);J()};var S=function(ak){var al;if(ak.url){if(ak.url instanceof Array){al=h.ImageUtils.loadTextureCube(ak.url,ak.mapping,ak.onMapsLoaded)}else{if(ak.hdr){al=h.ImageUtils.loadHDRTexture(ak.url,ak.mapping);ak.hdr=true;al.onLoadCallbacks.push(ak.onMapsLoaded)}else{var ai=ak.url.split(".");var ah=ai[ai.length-2];var am=ai[ai.length-1];am=am.toLowerCase();if(am=="hdr"){al=h.ImageUtils.loadHDRTexture(ak.url,ak.mapping);ak.hdr=true;al.onLoadCallbacks.push(ak.onMapsLoaded)}else{if(am=="dds"){var aj=h.ImageUtils.loadCompressedTexture(iParams.envMap,new h.LatLongReflectionMapping(),function(){if(!ad){ad=new j(U.renderer.renderer,U.renderer.renderTargetPool)}ad.setEnvMap(aj,1);ad.execute();al=ad.getResultRGBE(true);ak.onMapsLoaded()})}else{al=new h.ImageUtils.loadTexture(ak.url,ak.mapping,ak.onMapsLoaded,null,h.ImageUtils.crossOriginPolicy)}}}}}return al};var E=function(an,ah,aj){var ai=W.getImage();ai.setTexture(an);var ao=aj?"hdr":"png";ai.setFormat(ao);var al=an;var ap=!!aj;var am;var ak;if(ah instanceof h.SimpleEnvMapping){am="backplate";ak="simple"}else{if(ah instanceof h.SimpleEnvMappingCustom){am="backplate";ak="custom"}else{if(ah instanceof h.SimpleEnvMappingFit){am="backplate";ak="fit"}else{if(ah instanceof h.SimpleEnvMappingPreserveRatio){am="backplate";ak="bestFit"}else{if(ah instanceof h.SimpleEnvMappingFitWidth){am="backplate";ak="fitWidth"}else{if(ah instanceof h.SimpleEnvMappingFitHeight){am="backplate";ak="fitHeight"}else{if(ah instanceof h.LatLongEnvMapping){am="latlong"}else{if(ah instanceof h.CubeEnvMapping){am="cubemap"}}}}}}}}if(ap){al.minFilter=h.NearestFilter;al.magFilter=h.NearestFilter;al.wrapS=h.RepeatWrapping;al.wrapT=h.RepeatWrapping}if((am!=W.getType())||(!B)||((W.getType()=="backplate")&&(W.getSizeScaling()!=ak))){W.setType(am);if(ak){W.setSizeScaling(ak)}t()}else{q=true}};var J=function(){var aj=W.getImage();var ao=aj.getTexture();if(W.getType()=="backplate"&&ao){var ah=2048;var ap=1024;if(ao.image){ah=ao.image.width;ap=ao.image.height}else{if(ao.width&&ao.height){ah=ao.width;ap=ao.height}}var al=ah/ap;var an=G/C;var am=0;var ak=0;if(W.getSizeScaling()=="custom"){var ai=W.getBackplateCB();if(ai){ai({textureWidth:ah,textureHeight:ap,viewportWidth:G,viewportHeight:C,devicePixelRatio:v})}}else{if(W.getSizeScaling()=="simple"){ah=G;ap=C;B.uniforms.invSize.value.set(1/(v*ah),1/(v*ap))}else{if(W.getSizeScaling()=="fitHeight"){ah=C*al;ap=C;am=0.5*(G-ah);B.uniforms.offset.value.set((v*am),(v*ak));B.uniforms.invSize.value.set(1/(v*ah),1/(v*ap))}else{if(W.getSizeScaling()=="fitWidth"){ah=G;ap=G/al;ak=0.5*(C-ap);B.uniforms.offset.value.set((v*am),(v*ak));B.uniforms.invSize.value.set(1/(v*ah),1/(v*ap))}else{if(W.getSizeScaling()=="bestFit"){if(al>an){ap=C;ah=ap*al}else{ah=G;ap=ah/al}B.uniforms.offset.value.set((v*am),(v*ak));B.uniforms.invSize.value.set(1/(v*ah),1/(v*ap))}else{if(W.getSizeScaling()=="fit"){if(al>an){ah=G;ap=G/al;ak=0.5*(C-ap)}else{ah=C*al;ap=C;am=0.5*(G-ah)}B.uniforms.offset.value.set((v*am),(v*ak));B.uniforms.invSize.value.set(1/(v*ah),1/(v*ap))}}}}}}}};var Q=function(){var ah=g.createSphereNode({radius:1,sag:64,material:B});var ai=ah._occurrences[0].renderable;ai.frustumCulled=false;ai.renderDepth=2;ai.visible=true;ai.visibilityFree=true;return ai};this.getIblMap=function(){if(H.isActivated()){var ah=H.getImage().getTexture();if(ah&&ah.loadEndStatus=="complete"){return ah}}return null};this.getRoughnessMap=function(){if(H.isActivated()){return N}return null};this.getRadiusEnvMap=function(){return(s.getSize()*ab.getGroundScale())*2};this.getCenter=function(){var ai;var ah;if(ag){ai=ab.getSceneHeight().clone();ai.multiplyScalar(s.getSize());ai.add(ab.getGroundPosition())}else{ai=ab.getGroundNormal().clone().multiply(ab.getSceneHeight());ai.multiplyScalar(s.getSize());ah=ab.getGroundPosition().clone().applyMatrix4(K);ai.add(ah)}return ai};this.getRadius=function(){var ah=s.getSize()*ab.getGroundScale();return ah};this.getProjectionCenter=function(){var ai;var ah;if(ag){ai=s.getShootPosition().clone();ai.multiplyScalar(s.getSize());ai.add(ab.getGroundPosition())}else{ai=ab.getGroundNormal().clone().multiply(s.getShootPosition());ai.multiplyScalar(s.getSize());ah=ab.getGroundPosition().clone().applyMatrix4(K);ai.add(ah);ai.z+=p.getHeight()}return ai};this.updateCamera=function(ak,al,ai){if(B){if(W.getType()=="latlong"||W.getType()=="gradientWithHorizon"||W.getType()=="gradient"||W.getType()=="gradient3"){var am=B.uniforms;if(am&&am.startOffset){if(ai.fullWidth){am.invScreenSize.value.x=1/(ai.width);am.invScreenSize.value.y=1/(ai.height);am.startOffset.value.x=ai.x/ai.fullWidth;am.endOffset.value.y=1-(ai.y/ai.fullHeight);am.endOffset.value.x=(ai.x+ai.width)/ai.fullWidth;am.startOffset.value.y=1-((ai.y+ai.height)/ai.fullHeight)}else{var aj=al.renderer.getViewportSize();am.invScreenSize.value.x=1/aj.width;am.invScreenSize.value.y=1/aj.height;am.startOffset.value.x=0;am.startOffset.value.y=0;am.endOffset.value.x=1;am.endOffset.value.y=1}}if(am&&am.cameraSight){var ah=Math.tan(0.5*h.Math.degToRad(ak.camera.fov));am.cameraSight.value.copy(ak.getSightDirection());am.cameraUp.value.copy(ak.camera.up).multiplyScalar(ah);am.cameraRight.value.crossVectors(ak.getSightDirection(),ak.camera.up);am.cameraRight.value.multiplyScalar(ak.camera.aspect*ah);am.invScreenSize.value.x=1/al.deviceWidth;am.invScreenSize.value.y=1/al.deviceHeight}}}};this.resize=function(ai,aj,ah){G=ai;C=aj;v=ah;if(W.getType()=="backplate"){J()}};this.getSphere=function(){return Q()};this.createGroundGeometry=function(){var ah=g.createCircleNode({radius:p.getScale(),segments:512,fill:true,material:p.getMaterial()?p.getMaterial():new h.PhysicalMaterial()});return ah};this.updateSphere=function(ai,al,aj){var ah,ak;if(s.isActivated()){ah=new h.Vector3().getPositionFromMatrix(K);if(!ag){ah.add(ab.getGroundPosition())}ak=s.getSize()*ab.getGroundScale()*2}else{ah=al;ak=ai}aj.position.set(ah.x,ah.y,ah.z);aj.scale.set(ak,ak,ak);aj.updateMatrix();if(B){aj.material=B}aj.visible=true};this.updateGround=function(ai){var aj=p.getScale();var ah=ab.getGroundPosition();ah.z+=p.getHeight();ah.applyMatrix4(K);ai.position.set(ah.x,ah.y,ah.z);ai.scale.set(aj,aj,aj);ai.updateMatrix();if(p.getMaterial()){ai.material=p.getMaterial()}ai.visible=true};this.setIblMap=function(ah){var aj=this;var ai=null;ah.onMapsLoaded=function(){var ak=ai;H.getImage().setTexture(ak);H.setActivated(true);ak.minFilter=h.NearestFilter;ak.magFilter=h.NearestFilter;ak.wrapS=h.RepeatWrapping;ak.wrapT=h.RepeatWrapping;if(ah.mapping){ak.mapping=ah.mapping}if(ah.hdr){ak.hdr=ah.hdr}if(ah.generateRougnessMap){var am=U.getRenderer().ambianceGenerators;ac=false;for(var al=0;al<y.length;al++){y[al].setIblMap({texture:map,mapping:ah.mapping,hdr:ah.hdr})}y=[];if(ah.doneCallback){ah.doneCallback()}aj.needUpdateIBL=true;N=null}if(ah.doneCallback&&!ah.generateRougnessMap){ac=false;for(var al=0;al<y.length;al++){y[al].setIblMap({texture:map,mapping:ah.mapping,hdr:ah.hdr})}y=[];ah.doneCallback();aj.needUpdateIBL=true}};if(ah.url){ac=true;ai=S(ah)}else{if(ah.texture&&ah.texture instanceof h.Texture){ac=true;ai=ah.texture;if(ai.loadEndStatus==="complete"){ah.onMapsLoaded()}else{ai.onLoadCallbacks.push(ah.onMapsLoaded)}}}};this.setReflectionMap=function(al){var an=this;var am=null;var ak=al.url;var aj=null;al.onMapsLoaded=function(){var ao=am;H.getImage().setTexture(ao);H.setActivated(true);N=aj;ao.minFilter=N.minFilter=h.NearestFilter;ao.magFilter=N.magFilter=h.NearestFilter;ao.wrapS=N.wrapS=h.RepeatWrapping;ao.wrapT=N.wrapT=h.RepeatWrapping;al.doneCallback&&al.doneCallback();an.needUpdateIBL=true};var ah=(a.getExtension(ak)==="dds");if(ah){var ai=h.ImageUtils.loadCompressedTexture(ak,new h.LatLongReflectionMapping(),function(){if(!ad){ad=new j(U.renderer.renderer,U.renderer.renderTargetPool)}ad.setEnvMap(ai,1);ad.execute();aj=null;am=ad.getResultRGBE(true);al.onMapsLoaded()})}};this.setRoughnessMap=function(ai){var aj=this;var ah=null;ai.onMapsLoaded=function(){N=ah;N.minFilter=h.NearestFilter;N.magFilter=h.NearestFilter;N.wrapS=h.RepeatWrapping;N.wrapT=h.RepeatWrapping;if(ai.mapping){ah.mapping=ai.mapping}if(ai.hdr){ah.hdr=ai.hdr}ai.doneCallback&&ai.doneCallback();aj.needUpdateIBL=true};if(ai.url){ah=S(ai)}else{if(ai.texture&&ai.texture instanceof h.Texture){ah=ai.texture;if(ah.loadEndStatus==="complete"){ai.onMapsLoaded()}else{ah.onLoadCallbacks.push(ai.onMapsLoaded)}}}};this.setBackplateMap=function(ah){var ai=null;var aj=this;ah.onMapsLoaded=function(){aj.setFiniteMode(false);E(ai,ah.mapping,ah.hdr);ah.doneCallback&&ah.doneCallback()};if(ah.url){ai=S(ah)}else{if(ah.texture&&ah.texture instanceof h.Texture){ai=ah.texture;if(!ah.mapping){ah.mapping=ai.mapping}if(!ah.hdr){ah.hdr=ai.hdr}if(ai.loadEndStatus==="complete"){ah.onMapsLoaded()}else{ai.onLoadCallbacks.push(ah.onMapsLoaded)}}}};this.setBackGroundMap=function(ah){var ai=null;ah.onMapsLoaded=function(){E(ai,ah.mapping,ah.hdr);z=false;for(var aj=0;aj<X.length;aj++){X[aj].setBackGroundMap({texture:ai,mapping:ah.mapping,hdr:ah.hdr})}X=[];ah.doneCallback&&ah.doneCallback()};if(ah.url){z=true;ai=S(ah)}else{if(ah.texture&&ah.texture instanceof h.Texture){z=true;ai=ah.texture;if(!ah.mapping){ah.mapping=ai.mapping}if(!ah.hdr){ah.hdr=ai.hdr}if(ai.loadEndStatus==="complete"){ah.onMapsLoaded()}else{ai.onLoadCallbacks.push(ah.onMapsLoaded)}}}};this.setExposure=function(ah){W.setIntensity(ah);H.setIntensity(ah)};this.getEnvMapExposure=function(){return W.getIntensity()};this.setFiniteMode=function(ah){if(s.isActivated()==ah){return}s.setActivated(ah)};this.setGroundGeometry=function(ah){ab.setWithGround(ah)};this.getGroundPosition=function(){return ab.getGroundPosition()};this.setGroundPosition=function(ah){ab.setGroundPosition(ah)};this.setGroundNormal=function(ah){console.warn("DEPRECATED: use setTransfrom instead of setGroundNormal");ab.setGroundNormal(ah)};this.setSceneHeight=function(ah){ab.setSceneHeight(ah)};this.setGroundHeight=function(ah){s.setShootPosition(ah)};this.setGroundRadius=function(ah){s.setSize(ah);if(U&&U.planeV2&&U.planeGrid){U.planeGrid.size=ah*2}};this.displayGround=function(ah){p.setActivated(ah);if(U){U.displayInfinitePlane(ah)}};this.setGroundScale=function(ah){ab.setGroundScale(ah)};this.updateScene=function(ah){ab.setGroundPosition(ah)};this.isAutoGroundOffset=function(){return p.getAutoHeight()};this.setAutoGroundOffset=function(ah){p.setAutoHeight(ah)};this.setGroundOffset=function(ah){p.setHeight(ah)};this.setEnvMapBlur=function(ah){W.setBlur(ah)};this.getOffset=function(){return p.getHeight()};this.setEnvMapOffset=function(ah){K.makeRotationZ(ah);H.getMatrix().makeRotationZ(ah);if(ag){H.updateMatrix();this.updateMatrix()}q=true};this.setGroundReflectivitiy=function(ah){p.setReflectivity(ah);p.setActivated(true)};this.setGroundReflectivity=function(ah){p.setReflectivity(ah);p.setActivated(true)};this.setGroundShadowIntensity=function(ah){p.setShadowIntensity(ah);p.setActivated(true)};this.isUsedMirror=function(){return(p.isActivated()&&p.getType()=="transparent"&&p.getReflectivity()>0)};this._setMirror=function(ah){if(ah||p.getType()=="transparent"){p.setActivated(ah);p.setType("transparent");p.setReflectivity(0.3)}};this.getGroundGlossiness=function(){return p.getGlossiness()};this.setCustomBackplateCallback=function(ah){W.setType("backplate");W.setSizeScaling("custom");W.setBackplateCB(ah)};this.setBackplateOffset=function(ah,ai){if(B&&B.uniforms&&B.uniforms.offset){B.uniforms.offset.value.set(ah,ai)}};this.setBackplateSize=function(ai,ah){if(B&&B.uniforms&&B.uniforms.invSize){B.uniforms.invSize.value.set(ai,ah)}};this.setGroundGlossiness=function(ah){p.setGlossiness(ah)};this.setTranslation=function(ah){K.translate(ah);if(ag){this.updateMatrix()}};this.dispose=function(){if(N){N.dispose()}if(this.getIblMap()){this.getIblMap().dispose()}var ai=W.getImage();var ah=ai.getTexture();if(ah){ah.dispose()}W.setActivated(false);H.setActivated(false);s.setActivated(false);this.needUpdateIBL=true};this.clone=function(al){if(!al){al={}}var ak=al.viewer!==undefined?al.viewer:null;var ai={roughnessMap:N,viewer:ak};var ah={};ah.name=x;ah.backgroundGeometryEditor=ab.stream();ah.transform=K.elements.slice(0);ah.background=W.stream();ah.backgroundGeometry=s.stream();ah.environmentLight=H.stream();ah.ground=p.stream();ai.v2=ag;ai.ambiance=ah;var aj=new b(ai);aj.getGround().setAutoHeight(true);aj.setBackgroundColor(o.getHex());aj.setBackgroundAlpha(A);if(ak){ak.setBackgroundColor(o.getHex(),A)}if(z){X.push(aj)}if(ac){y.push(aj)}return aj};this.updateMatrix();if(ae.ambiance){this.loadFrom3dx(ae.ambiance,ae.images,ae.from3DX)}t()};return b});define("DS/VisuLoaders/ThreeDXLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Visualization/LightNode3D","DS/Visualization/Viewpoint","DS/Visualization/Ambience","DS/ZipJS/zip"],function(D,o,l,s,e,d,E,u,b,B){window.THREEDXLOADER_DEBUG_MODE=false;var t=function(H){window.THREEDXLOADER_DEBUG_MODE&&console.log("3DX Loader >> "+H)};var x={indexMap:null,indices:null,positions:null,normals:null};var h=0;var q=0;var F=0;var z=0;var w=0;var k=function(){var H=100000;var J=new D.Vector3();var I=new D.Vector3();this.computeBoundingVolume=function(O){var N={min:new D.Vector3(Infinity,Infinity,Infinity),max:new D.Vector3(-Infinity,-Infinity,-Infinity)};for(var K=0;K<O.length;K++){var L=O[K];var M=L.bbox;if(M[0]<N.min.x){N.min.x=M[0]}if(M[1]<N.min.y){N.min.y=M[1]}if(M[2]<N.min.z){N.min.z=M[2]}if(M[3]>N.max.x){N.max.x=M[3]}if(M[4]>N.max.y){N.max.y=M[4]}if(M[5]>N.max.z){N.max.z=M[5]}}return N};this.countTriangles=function(M){var L=0;for(var K=0;K<M.length;K++){L+=M[K].nbTriangles}return L};this.partitionObjects=function(O,M){var L=J;L.subVectors(M.max,M.min);var K=0;var N=L.x;if(L.y>L.x){K=1;N=L.y}if(L.z>N){K=2;N=L.z}O.sort(function(R,Q){var P=R.bbox[3+K];var S=Q.bbox[3+K];if(P===S){P=R.bbox[3+(K+1)%3];S=Q.bbox[3+(K+1)%3];if(P===S){P=R.bbox[3+(K+2)%3];S=Q.bbox[3+(K+2)%3];return S-P}return S-P}return S-P});return Math.floor(0.5*O.length)};this.buildBVH=function(Q,P,K){var M={type:0,objects:null,bbox:null,leftRightNode:[]};M.bbox=this.computeBoundingVolume(Q);if(P){P.leftRightNode[K]=M}if((Q.length===1)||(this.countTriangles(Q)<=H)){M.type=1;M.objects=Q}else{var O=this.partitionObjects(Q,M.bbox);var L=Q.slice(0,O);var N=Q.slice(O,Q.length);if(L.length){this.buildBVH(L,M,0)}if(N.length){this.buildBVH(N,M,1)}}return M};this.getRenderListFromBVH=function(K,M,L){if(L&&!this.cullingBVH(K.bbox,L)){return}if(K.type===1){M.push(K)}else{K.leftRightNode[0]&&this.getRenderListFromBVH(K.leftRightNode[0],M,L);K.leftRightNode[1]&&this.getRenderListFromBVH(K.leftRightNode[1],M,L)}}};var n={1:"vertexPositionArray",2:"vertexNormalArray",4:"vertexUvArray",8:"vertexUv2Array",16:"vertexColorArray",32:"vertexTangentArray",64:"vertexBinormalArray"};var g={1:3,2:3,4:2,8:2,16:4,32:3,64:3};var r={1:0,2:3,4:6,8:8,16:10,32:14,64:17};var a={NEAREST:1003,NEAREST_MIPMAP_NEAREST:1004,NEAREST_MIPMAP_LINEAR:1005,LINEAR:1006,LINEAR_MIPMAP_NEAREST:1007,LINEAR_MIPMAP_LINEAR:1008};var m={REPEAT:1000,CLAMP_TO_EDGE:1001,MIRRORED_REPEAT:1002};var C={POINTS:0,LINES:1,TRIANGLES:4};var G={Physical:"PhysicalMaterial",Phong:"MeshPhongMaterial",PointBasic:"ParticleBasicMaterial",LineBasic:"LineBasicMaterial",MeshBasic:"MeshBasicMaterial"};var A={PLANAR:1,SPHERICAL:2,CUBIC:4,FINITE_CYLINDRICAL:5,INFINITE_CYLINDRICAL:6};var c=function(H){var I=null;if(H.length==16){I=new D.Matrix3(H[0],H[4],H[12],H[1],H[5],H[13],H[3],H[7],H[15])}else{if(H.length==9){I=new D.Matrix3(H[0],H[3],H[6],H[1],H[4],H[7],H[2],H[5],H[8])}}return I};var y=function(H){this.options={};this.isGAS=true;this.id="";this.data=H};y.prototype.read=function(J,I,H){this.options={visible:J.visible,force:true,side:J.side,transparent:J.transparent,depthTest:J.depthTest,depthWrite:J.depthWrite};this.isGAS=true;this.id="VIS"+this.options.visible+"S"+this.options.side+"T"+this.options.transparent;this.id+="DT"+this.options.depthTest+"DW"+this.options.depthWrite;if(typeof J.NRECompatibility!=="undefined"){this.options.NRECompatibility=J.NRECompatibility}if(J.needTangentBinormal){this.options.needTangentBinormal=J.needTangentBinormal}if(J.alphaTest){this.options.alphaTest=J.alphaTest}if(J.vertexColors){this.options.vertexColors=J.vertexColors}if(typeof J.normalMap!=="undefined"){this.options.normalMap=this.data.textures[J.normalMap].texture;this.options.needTangentBinormal=true;if(typeof J.needTangentBinormal!=="undefined"){this.options.needTangentBinormal=J.needTangentBinormal}this.isGAS=false}if(typeof J.normalMapFlipY!=="undefined"){this.options.normalMapFlipY=J.normalMapFlipY}if(typeof J.bumpMap!=="undefined"){this.options.bumpMap=this.data.textures[J.bumpMap].texture;this.isGAS=false}if(typeof J.lightMap!=="undefined"){this.options.lightMap=this.data.textures[J.lightMap].texture;this.isGAS=false}if(typeof J.iterative!=="undefined"){this.options.iterative=J.iterative}if(typeof J.sslr!=="undefined"){this.options.sslr=J.sslr}};var j=function(H){y.call(this,H)};j.prototype=Object.create(y.prototype);j.prototype.buildGenericColor=function(J,H,K,L){if(typeof J[H]!=="undefined"){var I=J[H];this.options[K]=new D.Color().setRGB(I[0],I[1],I[2]);if(L!==null){this.id+=L+this.options[K].getStyle()}}};j.prototype.buildGenericFloat=function(I,H,K,L){if(typeof I[H]!=="undefined"){var J=I[H];if((H==="shininess")&&(J<1)){J*=255}this.options[K]=J;if(L!==null){this.id+=L+this.options[K]}}};j.prototype.buildGenericMap=function(J,I,L,H){if(typeof J[I]!=="undefined"){this.isGAS=false;var K=this.data.textures[J[I]].texture;this.options[L]=K;this.options.transparent=this.options.transparent||L==="opacityMap";if(H){this.options[L+"Linear"]=!this.options[L].sRGB}}};j.prototype.read=function(L,J,H){y.prototype.read.apply(this,arguments);this.buildGenericFloat(L,"opacity","opacity","O");this.buildGenericColor(L,"color","color","C");this.buildGenericColor(L,"ambient","ambient","A");this.buildGenericColor(L,"emissive","emissive","E");this.buildGenericColor(L,"specular","specular","SP");this.buildGenericFloat(L,"shininess","shininess","SH");this.buildGenericFloat(L,"glossiness","glossiness","G");this.buildGenericMap(L,"glossinessMap","glossinessMap",false);this.buildGenericMap(L,"specularMap","specularMap",true);this.buildGenericMap(L,"opacityMap","opacityMap",false);if(typeof L.diffuseMap!=="undefined"){this.isGAS=false;var K=this.data.textures[L.diffuseMap];this.options.map=K.texture;if(this.options.color&&(J.content==="material")){this.options.color.setRGB(1,1,1)}if(K.lods){this.options.map.setAsLOD(J.switchLODTextureCB?J.switchLODTextureCB:H);for(var I=0;I<K.lods.length;I++){this.options.map.lods.push(new D.LODTextureData(K.lods[I].textureData,null,K.lods[I].loadCB))}}}if(typeof L.normalMapScale!=="undefined"){this.options.normalScale=L.normalMapScale}if(typeof L.bumpMapScale!=="undefined"){this.options.bumpScale=L.bumpMapScale}if(typeof L.size!=="undefined"){this.options.size=L.size}if(typeof L.sizeAttenuation!=="undefined"){this.options.sizeAttenuation=L.sizeAttenuation}if(typeof L.lineWidth!=="undefined"){this.options.lineWidth=L.lineWidth}if(typeof L.envMap!=="undefined"){this.options.envMap=this.data.textures[L.envMap].texture}if(typeof L.refractionRatio!=="undefined"){this.options.refractionRatio=L.refractionRatio}if(typeof L.refractionRatioMap!=="undefined"){this.options.refractionRatioMap=this.data.textures[L.refractionRatioMap].texture}};var v=function(H){y.call(this,H);this.isGAS=false};v.prototype=Object.create(y.prototype);v.prototype.buildGenericPhysicalColorOptions=function(K,O,M,L,R,P){if(typeof K[O]!=="undefined"){var I=K[O];if(I.length){this.options[M]=new D.Color().setRGB(I[0],I[1],I[2]);return}if(typeof I.value!=="undefined"){var N=I.value;this.options[M]=new D.Color().setRGB(N[0],N[1],N[2])}else{if(R!==null){this.options[M]=R}}if(typeof I.texture!=="undefined"){var Q=I.texture;if(typeof I.value==="undefined"){this.options[M]=new D.Color().setRGB(1,1,1)}this.options[M+"Map"]=this.data.textures[Q].texture;this.options[M+"MapLinear"]=P;if(L&&this.data.textures[Q].mapping){var H=this.data.textures[Q].mapping;if(H.uvTransform){this.options[M+"UvTransform"]=c(H.uvTransform)}if(H.operator){var J=H.operator;this.options.mappingUseFragment=true;this.options.mappingType=A[J.type];this.options.mappingObjTransformation=new D.Matrix4();if(J.transform){this.options.mappingObjTransformation.elements=J.transform}}if(H.slot){this.options.uvSlots[M+"Map"]=(H.slot==="TEX_COORD_1")?2:1}}}if(typeof I.MADCoefficients!=="undefined"){var S=I.MADCoefficients;this.options[M+"MulCoef"]=new D.Vector3(S[0],S[1],S[2]);this.options[M+"AddCoef"]=new D.Vector3(S[3],S[4],S[5])}}else{if(R!==null){this.options[M]=R}}};v.prototype.buildGenericPhysicalFloatOptions=function(L,O,N,M,R,P){if(typeof L[O]!=="undefined"){var I=L[O];if(typeof I!=="object"){this.options[N]=I;return}if(typeof I.value!=="undefined"){var S=I.value;this.options[N]=S}else{if(R!==null){this.options[N]=R}}if(typeof I.texture!=="undefined"){var Q=I.texture;if(typeof I.value==="undefined"){this.options[N]=1}this.options.transparent=this.options.transparent||(N==="opacity"||N==="transparency");this.options[N+"Map"]=this.data.textures[Q].texture;this.options[N+"MapLinear"]=P;if(M&&this.data.textures[Q].mapping){var H=this.data.textures[Q].mapping;if(H.uvTransform){var K=H.uvTransform;this.options[N+"UvTransform"]=c(H.uvTransform)}if(H.operator){var J=H.operator;this.options.mappingUseFragment=true;this.options.mappingType=A[J.type];this.options.mappingObjTransformation=new D.Matrix4();if(J.transform){this.options.mappingObjTransformation.elements=J.transform}}if(H.slot){this.options.uvSlots[N+"Map"]=(H.slot==="TEX_COORD_1")?2:1}}}if(typeof I.MADCoefficients!=="undefined"){var T=I.MADCoefficients;this.options[N+"MulCoef"]=T[0];this.options[N+"AddCoef"]=T[1]}}else{if(R!==null){this.options[N]=R}}};v.prototype.buildGenericPhysicalFloat2Options=function(K,N,M,L,Q,O){if(typeof K[N]!=="undefined"){var I=K[N];if(typeof I.value!=="undefined"){var R=I.value;if(typeof R==="number"){this.options[M]=new D.Vector2(R,R)}else{this.options[M]=new D.Vector2(R[0],R[1])}}else{if(Q!==null){this.options[M]=Q}}if(typeof I.texture!=="undefined"){var P=I.texture;if(typeof I.value==="undefined"){this.options[M]=new D.Vector2(1,1)}this.options[M+"Map"]=this.data.textures[P].texture;this.options[M+"MapLinear"]=O;if(L&&this.data.textures[P].mapping){var H=this.data.textures[P].mapping;if(H.uvTransform){this.options[M+"UvTransform"]=c(H.uvTransform)}if(H.operator){var J=H.operator;this.options.mappingUseFragment=true;this.options.mappingType=A[J.type];this.options.mappingObjTransformation=new D.Matrix4();if(J.transform){this.options.mappingObjTransformation.elements=J.transform}}if(H.slot){this.options.uvSlots[M+"Map"]=(H.slot==="TEX_COORD_1")?2:1}}}if(typeof I.MADCoefficients!=="undefined"){var S=I.MADCoefficients;this.options[M+"MulCoef"]=S[0];this.options[M+"AddCoef"]=S[1]}}else{if(Q!==null){this.options[M]=Q}}};v.prototype.buildGenericPhysicalNormalOptions=function(M,H,O,L){var K=H+"Map";if(typeof M[K]!=="undefined"){var N=M[K];this.options[O+"Map"]=this.data.textures[N].texture;if(L&&this.data.textures[N].mapping){var J=this.data.textures[N].mapping;if(J.uvTransform){this.options[O+"UvTransform"]=c(J.uvTransform)}if(J.operator){var I=J.operator;this.options.mappingUseFragment=true;this.options.mappingType=A[I.type];this.options.mappingObjTransformation=new D.Matrix4();if(I.transform){this.options.mappingObjTransformation.elements=I.transform}}if(J.slot){this.options.uvSlots[O+"Map"]=(J.slot==="TEX_COORD_1")?2:1}}}if(typeof M[H+"MapFlipY"]!=="undefined"){this.options[H+"MapFlipY"]=M[H+"MapFlipY"]}};v.prototype._startread=function(K,I,H){y.prototype.read.call(this,K,undefined,undefined);this.options.uvSlots={diffuseMap:1,specularMap:1,roughnessMap:1,normalMap:1,lightMap:2};this.options.NRECompatibility=true;if(typeof K.useAlphaDiffuseChannel!=="undefined"){this.options.useAlphaFromDiffuseMap=K.useAlphaDiffuseChannel}this.buildGenericPhysicalNormalOptions(K,"normal","normal",true);if(typeof K.lightMap!=="undefined"){var J=this.data.textures[K.lightMap].mapping;if(J){if(J.uvTransform){this.options.lightMapUvTransform=c(J.uvTransform)}else{this.options.lightMapUvTransform=new D.Matrix3()}if(J.operator){this.options.mappingUseFragment=true;this.options.mappingType=A[J.operator.type];this.options.mappingObjTransformation=new D.Matrix4();if(J.operator.transform){this.options.mappingObjTransformation.elements=J.operator.transform}}if(J.slot){this.options.uvSlots.lightMap=(J.slot==="TEX_COORD_1")?2:1}}}this.buildGenericPhysicalFloatOptions(K,"displacement","displacement",false,null,true)};v.prototype._endread=function(J,I,H){if(typeof J.uv0Transform!=="undefined"){if(!this.options.mappingType){this.options.mappingType=0}var K=J.uv0Transform;this.options.mappingUVTransformation=new D.Matrix3(K[0],K[3],K[6],K[1],K[4],K[7],K[2],K[5],K[8])}if(this.options.mappingObjTransformation){this.options.mappingNormTransformation=new D.Matrix3().getInverse(this.options.mappingObjTransformation).transpose()}};v.prototype.read=function(N,L,I){this._startread(N,L,I);this.options.color=new D.Color().setRGB(0,0,0);if(typeof N.diffuse!=="undefined"){if(N.diffuse.value!==undefined){this.options.color=new D.Color().setRGB(N.diffuse.value[0],N.diffuse.value[1],N.diffuse.value[2])}var J=N.diffuse.texture;if(typeof J!=="undefined"){var M=this.data.textures[J];this.options.map=M.texture;this.options.diffuseMapLinear=false;if(M.lods){this.options.map.setAsLOD(L.switchLODTextureCB?L.switchLODTextureCB:I);for(var K=0;K<M.lods.length;K++){this.options.map.lods.push(new D.LODTextureData(M.lods[K].textureData,null,M.lods[K].loadCB))}}var H=this.data.textures[J].mapping;if(H){if(H.uvTransform){this.options.diffuseUvTransform=c(H.uvTransform)}else{this.options.diffuseUvTransform=new D.Matrix3()}if(H.operator){this.options.mappingUseFragment=true;this.options.mappingType=A[H.operator.type];this.options.mappingObjTransformation=new D.Matrix4();if(H.operator.transform){this.options.mappingObjTransformation.elements=H.operator.transform}}if(H.slot){this.options.uvSlots.diffuseMap=(H.slot==="TEX_COORD_1")?2:1}}}if(typeof N.diffuse.MADCoefficients!=="undefined"){this.options.diffuseMulCoef=new D.Vector3(N.diffuse.MADCoefficients[0],N.diffuse.MADCoefficients[1],N.diffuse.MADCoefficients[2]);this.options.diffuseAddCoef=new D.Vector3(N.diffuse.MADCoefficients[3],N.diffuse.MADCoefficients[4],N.diffuse.MADCoefficients[5])}}this.buildGenericPhysicalColorOptions(N,"emissive","emissive",true,new D.Color().setRGB(0,0,0),false);this.buildGenericPhysicalColorOptions(N,"specular","specular",true,new D.Color().setRGB(0.04,0.04,0.04),false);this.buildGenericPhysicalColorOptions(N,"coatingSpecular","coatingSpecular",false,null,false);this.buildGenericPhysicalColorOptions(N,"flakesColor","flakesColor",false,new D.Color().setRGB(0,0,0),false,false);this.buildGenericPhysicalColorOptions(N,"pearlFlakesColor","pearlFlakesColor",false,new D.Color().setRGB(0,0,0),false,false);this.buildGenericPhysicalFloatOptions(N,"opacity","opacity",true,1,true);this.buildGenericPhysicalFloatOptions(N,"glossiness","glossiness",true,0,true);this.buildGenericPhysicalFloatOptions(N,"anisotropy","anisotropy",true,0,true);this.buildGenericPhysicalFloatOptions(N,"anisotropyAngle","anisotropyAngle",true,0,true);this.buildGenericPhysicalFloatOptions(N,"bumpScale","bumpScale",false,1,true);this.buildGenericPhysicalFloatOptions(N,"metalness","metalness",true,null,true);this.buildGenericPhysicalFloatOptions(N,"fresnelTransparency","transparency",false,0,true);this.buildGenericPhysicalFloatOptions(N,"coating","coating",true,false,true);if(typeof N.coatingNormalMap!=="undefined"){this.options.clearCoatNormalMap=this.data.textures[N.coatingNormalMap].texture}this.buildGenericPhysicalFloatOptions(N,"coatingGlossiness","coatingGlossiness",true,1,true);this.buildGenericPhysicalFloatOptions(N,"proceduralCoating","orangePeel",false,false,true);this.buildGenericPhysicalFloatOptions(N,"coatingNormalBump","orangePeelScale",false,0,true);this.buildGenericPhysicalFloatOptions(N,"coatingNormalScale","clearCoatNormalScale",false,0,true);this.buildGenericPhysicalFloatOptions(N,"flakes","flakes",false,false,true);this.buildGenericPhysicalFloatOptions(N,"flakesScale","flakesScale",false,0.5,true);this.buildGenericPhysicalFloatOptions(N,"flakesBump","flakesBump",false,1,true);this.buildGenericPhysicalFloatOptions(N,"flakesRoughness","flakesRoughness",false,0.25,true);this.buildGenericPhysicalFloatOptions(N,"flakesDensity","flakesDensity",false,1,true);this.buildGenericPhysicalFloatOptions(N,"pearlFlakesBump","pearlFlakesBump",false,1,true);this.buildGenericPhysicalFloatOptions(N,"pearlFlakesDensity","pearlFlakesDensity",false,1,true);this.buildGenericPhysicalFloat2Options(N,"normalScale","normalScale",false,null,true);this.buildGenericPhysicalFloatOptions(N,"diffuseAlpha","alphaToCoverage",false,null,true);this._endread(N,L,I);this.isGAS=false};var p=function(H){v.call(this,H)};p.prototype=Object.create(v.prototype);p.prototype.buildGenericPhysicalNormalOptions=function(L,H,N,K){if(typeof L[H]!=="undefined"){var O=L[H];if(typeof O.texture!=="undefined"){var M=O.texture;this.options[N+"Map"]=this.data.textures[M].texture;if(K&&this.data.textures[M].mapping){var J=this.data.textures[M].mapping;if(J.uvTransform){this.options[N+"UvTransform"]=c(J.uvTransform)}if(J.operator){var I=J.operator;this.options.mappingUseFragment=true;this.options.mappingType=A[I.type];this.options.mappingObjTransformation=new D.Matrix4();if(I.transform){this.options.mappingObjTransformation.elements=I.transform}}if(J.slot){this.options.uvSlots[N+"Map"]=(J.slot==="TEX_COORD_1")?2:1}}}if(typeof L[H+"MapFlipY"]!=="undefined"){this.options[H+"MapFlipY"]=L[H+"MapFlipY"]}}};p.prototype.read=function(M,K,I){this._startread(M,K,I);if(typeof M.albedo!=="undefined"){if(M.albedo.value!==undefined){this.options.color=new D.Color().setRGB(M.albedo.value[0],M.albedo.value[1],M.albedo.value[2])}var J=M.albedo.texture;if(typeof J!=="undefined"){var L=this.data.textures[J];this.options.map=L.texture;this.options.diffuseMapLinear=false;var H=this.data.textures[J].mapping;if(H){if(H.uvTransform){this.options.diffuseUvTransform=c(H.uvTransform)}else{this.options.diffuseUvTransform=new D.Matrix3()}if(H.operator){this.options.mappingUseFragment=true;this.options.mappingType=A[H.operator.type];this.options.mappingObjTransformation=new D.Matrix4();if(H.operator.transform){this.options.mappingObjTransformation.elements=H.operator.transform}}if(H.slot){this.options.uvSlots.diffuseMap=(H.slot==="TEX_COORD_1")?2:1}}}if(typeof M.albedo.MADCoefficients!=="undefined"){this.options.diffuseMulCoef=new D.Vector3(M.albedo.MADCoefficients[0],M.albedo.MADCoefficients[1],M.albedo.MADCoefficients[2]);this.options.diffuseAddCoef=new D.Vector3(M.albedo.MADCoefficients[3],M.albedo.MADCoefficients[4],M.albedo.MADCoefficients[5])}}if(K.lightMapAsIrradiance){this.options.lightMapMode=1}this.buildGenericPhysicalFloatOptions(M,"metallic","metalness",true,null,true);this.buildGenericPhysicalFloatOptions(M,"roughness","roughness",true,0,true);this.buildGenericPhysicalFloatOptions(M,"anisotropy","anisotropy",true,0,true);this.buildGenericPhysicalFloatOptions(M,"anisotropyRotation","anisotropyAngle",true,0,true);this.buildGenericPhysicalFloatOptions(M,"transparency","transparency",true,0,true);this.buildGenericPhysicalFloatOptions(M,"cutoutOpacity","opacity",true,1,true);this.buildGenericPhysicalFloatOptions(M,"sheen","sheen",true,0,true);if(typeof M.sheenMode!=="undefined"){this.options.sheenMode=M.sheenMode}this.buildGenericPhysicalFloatOptions(M,"specular","specularContrib",true,1,true);this.buildGenericPhysicalColorOptions(M,"specularTint","specular",true,new D.Color().setRGB(1,1,1),false);this.buildGenericPhysicalFloatOptions(M,"clearcoat","clearCoat",true,0,true);this.buildGenericPhysicalFloatOptions(M,"clearcoatRoughness","clearCoatRoughness",true,0,true);this.buildGenericPhysicalNormalOptions(M,"clearcoatNormal","clearCoatNormal",true);if(typeof M.orangePeel!=="undefined"){this.options.orangePeel=M.orangePeel}this.buildGenericPhysicalFloatOptions(M,"orangePeelScale","orangePeelScale",false,0,false);this.buildGenericPhysicalColorOptions(M,"emissionColor","emissionColor",true,new D.Color().setRGB(1,1,1),false);this.buildGenericPhysicalFloatOptions(M,"emissionValue","emissionValue",false,0,false);this.options.emissionNormalized=false;if(typeof M.emissionEnergyNormalization!=="undefined"){this.options.emissionNormalized=M.emissionEnergyNormalization}this.options.thinWalled=true;if(typeof M.thinWalled!=="undefined"){this.options.thinWalled=M.thinWalled}this.buildGenericPhysicalFloatOptions(M,"ior","ior",false,1.5,false);this.buildGenericPhysicalColorOptions(M,"attenuationColor","attenuationColor",false,new D.Color().setRGB(1,1,1),false);this.buildGenericPhysicalColorOptions(M,"subsurfaceColor","subsurfaceColor",false,new D.Color().setRGB(0,0,0),false);this.buildGenericPhysicalFloatOptions(M,"attenuationDistance","attenuationDistance",false,1000000000000,false);this.buildGenericPhysicalFloatOptions(M,"translucencyScale","translucencyScale",false,1,false);this.buildGenericPhysicalFloatOptions(M,"subsurfacePreset","subsurfacePreset",false,null,false);this.buildGenericPhysicalColorOptions(M,"flakeColor","flakesColor",false,new D.Color().setRGB(1,1,1),false);this.buildGenericPhysicalFloatOptions(M,"flakeSize","flakesSize",true,0.5,true);this.buildGenericPhysicalFloatOptions(M,"flakeCoverage","flakesCoverage",true,0,true);this.buildGenericPhysicalFloatOptions(M,"flakeRoughness","flakesRoughness",true,0,true);this._endread(M,K,I)};var f=function(L){var J=performance.now();var I=(L!==undefined)?L:null;this.mode=undefined;this.sharedBuffers=false;this.noMeshInRAM=false;this.baseUrl="";this.modelsToLoad={};this.loadIndex=0;this.nbModelsToLoad=0;this.extensionsRequired=new Set();this.extensionsUsed=new Set();this.globalOldFlipTexture=false;this.SSBMinNbReps=1;this.SSBMinNbTriangles=1000;var M=this;var K=new D.MeshPhongMaterial({side:D.DoubleSide,color:new D.Color(16777215)});var H=new D.MeshBasicMaterial({color:new D.Color(16777215)});this.getURI=function(Q,S){var R="";if(Q.substring(0,7)==="http://"){R=Q}else{if(Q.substring(0,8)==="https://"){R=Q}else{if(Q.substring(0,1)==="/"){R=Q}else{var P=S;if((S.substring(0,5)==="blob:")||(S==="/")){P=location.href;var O=P.indexOf("?");if(O!==-1){P=P.substring(0,O)}var N=P.lastIndexOf("/");if(N!==-1){P=P.substring(0,N+1)}}R=P+Q}}}return R};this.getEntryFile=function(P,O,N){var Q=((O==="blob")||(O==="arraybuffer"))?new B.BlobWriter():new B.TextWriter();P.getData(Q,function(S){if(O==="arraybuffer"){var R=new FileReader();R.onload=function(){N(this.result)};R.readAsArrayBuffer(S)}else{N(S.target.result)}},null)};this.createAmbience=function(ae,R){var V=ae.ambiance;var P=null;if(!V){return}if(R.destinationNode){var Y=R.destinationNode;for(var ac=0;ac<Y._occurrences.length;ac++){var af=Y._occurrences[ac];var ad=af.parent;if(!af.scene3js){continue}var P=af.scene3js.viewer}}var Q=null;var N=null;if(V.background&&(V.background.type=="gradient")){var Z=V.background.colors[0];V.background.colors[0]=V.background.colors[1];V.background.colors[1]=Z}if(V.background&&(V.background.image!==undefined)){var X=R.data.images[V.background.image];if(X.data){var W=window.URL.createObjectURL(X.data);Q={data:W,format:X.format}}}var T=false;if(V.environmentLight&&(V.environmentLight.light!==undefined)){var ab;if(V.environmentLight.matrix){ab=V.environmentLight.matrix}var U=R.json.lights[V.environmentLight.light];var S=U.image;var X=R.data.images[S];if(X.data){var W=window.URL.createObjectURL(X.data);N={data:W,format:X.format}}V.environmentLight=U;if(ab){V.environmentLight.matrix=ab}T=true}if(V.directionalLights){for(var ac=0;ac<V.directionalLights.length;ac++){if(!ae.lightInstances||!ae.lightInstances.length){ae.lightInstances=[]}V.directionalLights[ac].castShadows=V.directionalLights[ac].castShadows&&!T;V.directionalLights[ac].ambianceTransform=V.transform;ae.lightInstances.push(V.directionalLights[ac])}}if(P){P.setAmbientLight(0);P.setIntensityCorrection(true);if(P.useDefaultLights){P.setTriLights(false);P.directionalLight.intensity=0;P.directionalLight2.intensity=0}if(P.renderer.ToneMappingEffect){P.renderer.ToneMappingEffect.setToneMapping(9)}var O=new b({viewer:P,ambiance:V,images:{background:Q,environmentLight:N,from3DX:true}});P.setAmbience(O)}};this.createImages=function(V,T){if(!V){return}for(var S=0;S<V.length;S++){var O=V[S];var W=O.format.toLowerCase();if(W==="png"||W==="jpeg"||W==="jpg"||W==="dds"||W==="hdr"){var U="image/"+W;if((W==="dds")||(W==="hdr")){U="arraybuffer"}var P=T.data.chunks[O.binary];if(P){var R=P.buffer?P.buffer:P;var Q=P.byteOffset?P.byteOffset:0;var X=new Uint8Array(R,Q+O.byteOffset,O.byteLength);var N=new Blob([X],{type:U});T.data.images.push({data:N,format:W})}else{T.data.images.push({uri:T.json.binaries[O.binary].uri,width:O.width,height:O.height,format:W})}}}};this.createBuffers=function(ae,N){if(!ae){return}for(var Z=0;Z<ae.length;Z++){var V=ae[Z];var R=N.data.chunks[V.binary];var ac=R.buffer?R.buffer:R;var O=R.buffer?R.byteOffset+V.byteOffset:V.byteOffset;if(V.format){var af;if(V.format==="UNSIGNED_SHORT"){af=new Uint16Array(ac,O,V.byteLength/2)}else{if(V.format==="UNSIGNED_INT"){af=new Uint32Array(ac,O,V.byteLength/4)}else{if(V.format==="UNSIGNED_BYTE"){var S=new Uint8Array(ac,O,V.byteLength);af=new Uint16Array(V.byteLength);for(var Y=0;Y<V.byteLength;Y++){af[Y]=S[Y]}}}}N.data.buffers.push(af)}else{if(V.attributes){var U=n[V.attributes];if(U){var af=new Float32Array(ac,O,V.byteLength/4);N.data.buffers.push({attribute:U,buffer:af})}else{var S=new Float32Array(ac,O,V.byteLength/4);var ah=[];N.data.buffers.push(ah);var P=0;for(var Y in n){if(V.attributes&Y){P+=g[Y]}}var ag=S.length/P;for(var Y in n){if(V.attributes&Y){var X=g[Y];var af=new Float32Array(ag*X);var Q={attribute:n[Y],buffer:af};var T=r[Y];for(var W=0;W<ag;W++){for(var ad=0;ad<X;ad++){af[W++]=S[T+ad]}T+=P}ah.push(Q)}}}}else{if(V.geometricType){var af=new Uint32Array(ac,O,V.byteLength/4);N.data.buffers.push({geometricType:V.geometricType,buffer:af})}else{var af=new Uint8Array(ac,O,V.byteLength);N.data.buffers.push({buffer:af})}}}}};this.getBuffers=function(ae,O,Q,P,N){if(!ae){return}var Y=ae[Q];var U=O.data.chunks[Y.binary];var ad=U.buffer?U.buffer:U;var R=U.buffer?U.byteOffset+Y.byteOffset:Y.byteOffset;if(Y.format){var af;if(Y.format==="UNSIGNED_SHORT"){af=new Uint16Array(ad,R,Y.byteLength/2)}else{if(Y.format==="UNSIGNED_INT"){af=new Uint32Array(ad,R,Y.byteLength/4)}else{if(Y.format==="UNSIGNED_BYTE"){var V=new Uint8Array(ad,R,Y.byteLength);af=new Uint16Array(Y.byteLength);for(var ac=0;ac<Y.byteLength;ac++){af[ac]=V[ac]}}}}return af}else{if(P){if(P.length==1){var S=P[0];var af;if(S.format==="UNSIGNED_SHORT"){af=new Uint16Array(ad,R,Y.byteLength/2)}else{if(S.format==="UNSIGNED_INT"){af=new Uint32Array(ad,R,Y.byteLength/4)}else{if(S.format==="UNSIGNED_BYTE"){var V=new Uint8Array(ad,R,Y.byteLength);af=new Uint16Array(Y.byteLength);for(var ac=0;ac<Y.byteLength;ac++){af[ac]=V[ac]}}else{af=new Float32Array(ad,R,Y.byteLength/4)}}}return af}else{var af=new Float32Array(ad,R,Y.byteLength/4);var ah=[];var T=0;for(var ac in P){T+=P[ac].dimension}var ag=af.length/T;for(var ac in P){var S=P[ac];ah[ac]=new Float32Array(ag*S.dimension)}var W=0;for(var ac in P){var Q=0;var S=P[ac];for(var Z=0;Z<ag;Z++){for(var X=0;X<S.dimension;X++){ah[ac][Q++]=af[Z*T+W+X]}}W+=S.dimension}return ah}}else{if(N){var af=new Uint32Array(ad,R,Y.byteLength/4);return{geometricType:N,buffer:af}}else{var af=new Uint8Array(ad,R,Y.byteLength);return af}}}};this.getGenericBuffer=function(V,R,S,T){if(!V){return}var Q=V[S];var N=R.data.chunks[Q.binary];var O=N.buffer?N.buffer:N;var P=N.buffer?N.byteOffset+Q.byteOffset:Q.byteOffset;var U;switch(T){case"Float32":U=new Float32Array(O,P,Q.byteLength/4);break;case"Uint32":U=new Uint32Array(O,P,Q.byteLength/4);break;default:U=new Uint8Array(O,P,Q.byteLength);break}return U};this.onImageLoaded=function(N){N.data.nbImagesToLoad--;if(!N.data.nbImagesToLoad&&N.onTexturesLoadedCB){N.onTexturesLoadedCB()}};this.createTextures=function(O,P){if(!O){return}var X=this;var N={};for(var ab=0;ab<O.length;ab++){var R=O[ab];if(!N[R.image]){N[R.image]=[];if(!P.imagesCallback&&P.data.images[R.image]){P.data.nbImagesToLoad++}}N[R.image].push({texture:ab,lod:-1});if(!R.lods){continue}for(var Z=0;Z<R.lods.length;Z++){var S=R.lods[Z];if(!N[S]){N[S]=[]}N[S].push({texture:ab,lod:Z})}}for(var ad in N){var af=null;var T,ae;if(P.imagesCallback){af=P.imagesCallback(R,P)}else{var Q=P.data.images[ad];var W=(N[ad][0].lod>=0);var V;if(!W){if(Q.data){V=window.URL.createObjectURL(Q.data)}else{V=Q.uri}if(Q.format==="dds"){af=D.ImageUtils.loadCompressedTexture(V,null,(function(ag){return function(){X.onImageLoaded(ag)}})(P),(function(ag){return function(){X.onImageLoaded(ag)}})(P),true)}else{if(Q.format==="hdr"){af=D.ImageUtils.loadHDRTexture(V,null,(function(ag){return function(){X.onImageLoaded(ag)}})(P),(function(ag){return function(){X.onImageLoaded(ag)}})(P),true,false,true)}else{af=D.ImageUtils.loadTexture(V,null,(function(ag){return function(){X.onImageLoaded(ag)}})(P),(function(ag){return function(){X.onImageLoaded(ag)}})(P),undefined,true);af.flipY=true}}}else{af=Q.uri;T=Q.width;ae=Q.height}}var U=N[ad];for(var Z=0;Z<U.length;Z++){var R=O[U[Z].texture];if(U[Z].lod===-1){af.wrapS=m[R.uWrap]||1000;af.wrapT=m[R.vWrap]||1000;af.anisotropy=R.anisotropy||8;af.minFilter=a[R.minFilter]||1008;af.magFilter=a[R.magFilter]||1006;if(af.magFilter!=1003&&af.magFilter!=1006){af.magFilter=1006}af.repeat=R.repeat||{x:1,y:1};var ac=P.json.images[R.image].format;af.sRGB=(R.format==="jpg")||(R.format==="jpeg");if(!af.sRGB&&(ac==="jpg"||ac==="jpeg")){af.sRGB=true}var Y={texture:af,mapping:R.mapping};P.data.textures[U[Z].texture]=Y}else{var Y=P.data.textures[U[Z].texture];if(!Y.lods){Y.lods=[]}Y.lods.push({textureData:{texture:af,width:T,height:ae},loadCB:this.loadLODTextureCB})}}}};this.loadLODTextureCB=function(N){var O=o.parseUrl(this.imageData.texture);O=(O.protocol==="")?(M.baseUrl+O.source):O.source;var P=D.ImageUtils.loadTexture(O,undefined,undefined,undefined,undefined,true);P.flipY=true;if(N){P.wrapS=N.wrapS;P.wrapT=N.wrapT;P.anisotropy=N.anisotropy;P.minFilter=N.minFilter;P.magFilter=N.magFilter;P.repeat=N.repeat;P.sRGB=N.sRGB}return P};this.switchLODTextureCB=function(Q){var X=Q.matrix,V=Q.bSphere,T=V.radius*X.getMaxScaleOnAxis(),O=new D.Vector3();if(V){O.copy(V.center)}else{O.set(0,0,0)}O.applyMatrix4(X);var U=Q.camera.matrixWorldInverse.elements;var W=Math.abs(U[2]*O.x+U[6]*O.y+U[10]*O.z+U[14])-T;var R=D.glStates.currentHeight/Math.tan(0.5*Q.camera.fov*Math.PI/180);var N=R*T/Math.abs(W);if(N<Math.min(Q.texture.image.width,Q.texture.image.height)){return -1}var P,S;for(P=0;P<Q.lods.length;P++){S=Q.lods[P];if(N<Math.min(S.imageData.width,S.imageData.height)){break}}return(P===Q.lods.length)?P-1:P};this.createMaterialsV2=function(X,Q,S){if(!X){return}var T=new d();for(var R=0;R<X.length;R++){var P=X[R];var U=null;if(S.materialsCallback){U=S.materialsCallback(P,S)}else{if(P.type==="External"){var O={uri:P.uri,destinationNodes:[],destinationDGforGAS:[],destinationDGforMaterial:[]};S.data.modelsToLoad.push(O);Q.materials[R]=O;continue}else{var Y={visible:P.visible,force:P.force,side:P.side,transparent:P.transparent,opacity:P.opacity,depthTest:P.depthTest,depthWrite:P.depthWrite};var N=true;var W="VIS"+Y.visible+"S"+Y.side+"T"+Y.transparent;W+="O"+Y.opacity;W+="DT"+Y.depthTest+"DW"+Y.depthWrite;if(P.forceSide){Y.forceSide=P.forceSide;U+="FS"+Y.forceSide}if(P.NRECompatibility!==undefined){Y.NRECompatibility=P.NRECompatibility}if(P.needTangentBinormal){Y.needTangentBinormal=P.needTangentBinormal}if(P.alphaTest){Y.alphaTest=P.alphaTest}if(P.color){Y.color=new D.Color().setRGB(P.color[0],P.color[1],P.color[2]);W+="C"+Y.color.getStyle()}if(P.ambient){Y.ambient=new D.Color().setRGB(P.ambient[0],P.ambient[1],P.ambient[2]);W+="A"+Y.ambient.getStyle()}if(P.emissive){Y.emissive=new D.Color().setRGB(P.emissive[0],P.emissive[1],P.emissive[2]);W+="E"+Y.emissive.getStyle()}if(P.specular){Y.specular=new D.Color().setRGB(P.specular[0],P.specular[1],P.specular[2]);W+="SP"+Y.specular.getStyle()}if(P.shininess){Y.shininess=P.shininess;W+="SH"+Y.shininess}if(P.vertexColors){Y.vertexColors=P.vertexColors}if(P.diffuseMap!==undefined){N=false;Y.map=Q.textures[P.diffuseMap].texture}if(P.opacityMap!==undefined){N=false;Y.opacityMap=Q.textures[P.opacityMap].texture;Y.transparent=true}if(P.normalMap!==undefined){N=false;Y.normalMap=Q.textures[P.normalMap].texture;Y.needTangentBinormal=true;if(P.needTangentBinormal!==undefined){Y.needTangentBinormal=P.needTangentBinormal}}if(P.normalMapScale!==undefined){Y.normalScale=new D.Vector2(P.normalMapScale.x,P.normalMapScale.y)}if(P.normalMapFlipY!==undefined){Y.normalMapFlipY=P.normalMapFlipY}if(P.bumpMap!==undefined){N=false;Y.bumpMap=Q.textures[P.bumpMap].texture}if(P.bumpMapScale!==undefined){Y.bumpScale=P.bumpMapScale}if(P.glossiness!==undefined){Y.glossiness=P.glossiness;W+="G"+Y.glossiness}if(P.glossinessMap!==undefined){N=false;Y.glossinessMap=Q.textures[P.glossinessMap].texture}if(P.specularMap!==undefined){N=false;Y.specularMap=Q.textures[P.specularMap].texture;Y.specularMapLinear=!Y.specularMap.sRGB}if(P.lightMap!==undefined){N=false;Y.lightMap=Q.textures[P.lightMap].texture}if(P.type==="Physical"){N=false;if(P.emissiveMap!==undefined){Y.emissiveMap=Q.textures[P.emissiveMap].texture}if(P.metalnessMap!==undefined){if(P.metalness===undefined){P.metalness=1}Y.metalnessMap=Q.textures[P.metalnessMap].texture}if(P.metalness!==undefined){Y.metalness=P.metalness}if(P.coating!==undefined){Y.coating=P.coating}if(P.coatingGlossiness!==undefined){Y.coatingGlossiness=P.coatingGlossiness}}if(P.iterative!==undefined){Y.iterative=P.iterative}if(P.sslr!==undefined){Y.sslr=P.sslr}var V=G[P.type];W="id"+W.hashCode();if(N&&S.gasSharing){U=T.get3DXMaterial(W)}if(!U&&V){U=new D[V](Y);if(N&&S.gasSharing){T.set3DXMaterial(W,U)}}}}Q.materials[R]=U}};this.createMaterials=function(Z,Q,T){if(!Z){return}var U=new d();var P=this.extensionsRequired.has("EXT_Material_PBR")||this.extensionsUsed.has("EXT_Material_PBR");for(var R=0;R<Z.length;R++){var O=Z[R];var V=null;var W=false;if(O.extensions&&O.extensions.EXT_Material_PBR){O=O.extensions.EXT_Material_PBR;W=P}if(T.materialsCallback){V=T.materialsCallback(O,T)}else{if(O.type==="External"){var N={uri:O.uri,destinationNodes:[],destinationDGforGAS:[],destinationDGforMaterial:[]};T.data.modelsToLoad.push(N);Q.materials[R]=N;continue}else{var S=null;var X=G[O.type];if(W){X=G.Physical;S=new p(Q)}else{if(O.type!=="Physical"){S=new j(Q)}else{if(O.type==="Physical"){S=new v(Q)}}}S.read(O,T,this.switchLODTextureCB);var Y="id"+S.id.hashCode();if(S.isGAS&&T.gasSharing){V=U.get3DXMaterial(Y)}if(!V&&X){V=new D[X](S.options);if(S.isGAS&&T.gasSharing){U.set3DXMaterial(Y,V)}}}}Q.materials[R]=V}};this.createGeometriesV2=function(U,S){if(!U){return}var ak=S.data;for(var ad=0;ad<U.length;ad++){var ai=U[ad];var Z=new D.BufferGeometryDS();Z.compressedNormals=ai.compressedNormals||(typeof ai.normalCompression!=="undefined"&&ai.normalCompression==="OCT_24");Z.compressedVertices=ai.compressedVertices||(typeof ai.positionCompression!=="undefined"&&ai.positionCompression==="BBOX_QUANTIZATION_16_16_16");ak.geometries[ad]=Z;Z.sharedBuffers=this.sharedBuffers;Z.noMeshInRAM=this.noMeshInRAM;Z.vertexIndexArray=ak.buffers[ai.indexBuffer];for(var ac=0;ac<ai.vertexBuffers.length;ac++){var Q=ak.buffers[ai.vertexBuffers[ac]];if(Q.attribute){Z[Q.attribute]=Q.buffer}else{if(Q.length){for(var ab=0;ab<Q.length;ab++){Z[Q[ab].attribute]=Q[ab].buffer}}}}for(var ac=0;ac<ai.drawingGroups.length;ac++){var ag=ai.drawingGroups[ac];var aj=(ag.primitives!==undefined);var am=(ag.canonicals!==undefined);var Y=Z.vertexNormalArray?K:H;var ae=[];var T=new l.DrawingGroup(Y,null,C[ag.mode],ag.start,ag.count,ae,undefined,D.GeomTypeEnum.UNKNOWN,0);T.geometry=Z;Z.drawingGroups.push(T);if((ag.graphicAttributes!==undefined)&&ak.materials[ag.graphicAttributes]){var al=ak.materials[ag.graphicAttributes];if(al.uri){al.destinationDGforGAS.push(T)}else{T.gas=al}}if((ag.material!==undefined)&&ak.materials[ag.material]){var al=ak.materials[ag.material];if(al.uri){al.destinationDGforMaterial.push(T)}else{T.material=al}}if(aj){var af=ak.buffers[ag.primitives];var R=af.buffer;var W=0;var P=am?ak.buffers[ag.canonicals].buffer:null;T._geomType=D.GeomTypeEnum[af.geometricType];for(var ab=0;ab<R.length;ab+=4){var V=new l.SGPrimitive({cgmId:R[ab],group:T,start:R[ab+2],count:R[ab+3]});if(S.unstreamReps){var O=R[ab+1];var N=ak.reps[O];if(!N){N=new l.SGRep({cgmId:O});ak.reps[O]=N}V.rep=N;N.primitives.push(V)}if(am){var X=P[W++];if(X){V.decoration=new Array();for(var ah=0;ah<X;ah++){V.decoration.push(P[W++])}}}ae.push(V)}}else{var V=new l.SGPrimitive({cgmId:0,group:T,start:ag.start,count:ag.count});ae.push(V)}}}};this.getInternalDimensionBuffer=function(N,U,S){var R=U;if(S=="POSITION"){R=U}else{if(S=="NORMAL"){R=U}else{if(S=="TEX_COORD_0"){R=3}else{if(S=="TEX_COORD_1"){R=3}else{if(S=="COLOR"){R=4}else{if(S=="TANGENT"){R=3}else{if(S=="BINORMAL"){R=3}}}}}}}if(R==U){return N}else{if(U>0){var Q=N.length/U;var T=new Float32Array(Q*R);if(U<R){for(var P=0;P<Q;P++){for(var O=0;O<U;O++){T[P*R+O]=N[P*U+O]}for(var O=U;O<R;O++){T[P*R+O]=0}}}else{for(var P=0;P<Q;P++){for(var O=0;O<R;O++){T[P*R+O]=N[P*U+O]}}}return T}else{console.log("wrong definition of buffer dimension");return N}}};this.createGeometries=function(af,at,av,Q){if(!af){return}var a3=Q.data;for(var a0=0;a0<af.length;a0++){var aV=af[a0];var am={};var Y=0;var aA=aV.reps&&!(aV.reps instanceof Object);var an,ae;if(aA){var ao=this.getGenericBuffer(at,Q,aV.reps,"Uint8");an=new Uint32Array(ao.buffer,ao.byteOffset);var a5=4*ao.byteLength/9;ae=new Float32Array(ao.buffer,ao.byteOffset+a5)}var ay=av[aV.vertexLayout];var ad=new D.BufferGeometryDS();ad.compressedNormals=aV.compressedNormals||(typeof aV.normalCompression!=="undefined"&&aV.normalCompression==="OCT_24");ad.compressedVertices=aV.compressedVertices||(typeof aV.positionCompression!=="undefined"&&aV.positionCompression==="BBOX_QUANTIZATION_16_16_16");a3.geometries[a0]=ad;ad.sharedBuffers=this.sharedBuffers;ad.noMeshInRAM=this.noMeshInRAM;if(aV.indexBuffer===undefined){if(aV.drawingGroups&&aV.drawingGroups[0].count){ad.vertexIndexArray=new Uint32Array(aV.drawingGroups[0].count);for(var aX=0;aX<aV.drawingGroups[0].count;aX++){ad.vertexIndexArray[aX]=aX}}}else{ad.vertexIndexArray=this.getBuffers(at,Q,aV.indexBuffer)}if(aV.boundingSphere){var O=aV.boundingSphere.center;var aR=aV.boundingSphere.radius;ad.boundingSphere=new D.Sphere(new D.Vector3(O[0],O[1],O[2]),aR)}if(aV.boundingBox){var a4=aV.boundingBox.min;var ap=aV.boundingBox.max;if(ad.compressedVertices){ad.quantizedVector=new D.Vector3(ap[0]-a4[0],ap[1]-a4[1],ap[2]-a4[2]);ad.quantizedVector.multiplyScalar(1/65535);ad.offsetVector=new D.Vector3(a4[0],a4[1],a4[2]);ad.offsetVector.x/=ad.quantizedVector.x;ad.offsetVector.y/=ad.quantizedVector.y;ad.offsetVector.z/=ad.quantizedVector.z;ad.offsetVector.x=Math.floor(ad.offsetVector.x);ad.offsetVector.y=Math.floor(ad.offsetVector.y);ad.offsetVector.z=Math.floor(ad.offsetVector.z)}}if(ay[0].length===1){for(var aZ=0;aZ<aV.vertexBuffers.length;aZ++){var a6=ay[aZ];var aq=this.getBuffers(at,Q,aV.vertexBuffers[aZ],a6);var a1=a6[0];if(a1.attribute=="POSITION"){ad.vertexPositionArray=this.getInternalDimensionBuffer(aq,a1.dimension,a1.attribute);if(ad.compressedVertices){var aP=ad.vertexPositionArray;var T=aP.length/3;ad.vertexPositionArray=new Float32Array(T*2);for(var aX=0;aX<T;aX++){var aK=aP[3*aX];var aI=aP[3*aX+1];var aO=Math.floor(aI/256);var aU=aI%256;var aG=aP[3*aX+2];ad.vertexPositionArray[2*aX]=aK*256+aO;ad.vertexPositionArray[2*aX+1]=aG*256+aU}}}else{if(a1.attribute=="NORMAL"){ad.vertexNormalArray=this.getInternalDimensionBuffer(aq,a1.dimension,a1.attribute);if(ad.compressedNormals){var aw=ad.vertexNormalArray;var aY=aw.length/3;ad.vertexNormalArray=new Float32Array(aY);for(var aX=0;aX<aY;aX++){var aK=aw[3*aX];var aI=aw[3*aX+1];var aG=aw[3*aX+2];var aL=16*aK+Math.floor(aI/16);var aJ=(aI%16)*256+aG;ad.vertexNormalArray[aX]=aL*4096+aJ}}}else{if(a1.attribute=="TEX_COORD_0"){ad.vertexUvArray=this.getInternalDimensionBuffer(aq,a1.dimension,a1.attribute)}else{if(a1.attribute=="TEX_COORD_1"){ad.vertexUv2Array=this.getInternalDimensionBuffer(aq,a1.dimension,a1.attribute)}else{if(a1.attribute=="COLOR"){ad.vertexColorArray=this.getInternalDimensionBuffer(aq,a1.dimension,a1.attribute)}else{if(a1.attribute=="TANGENT"){ad.vertexTangentArray=this.getInternalDimensionBuffer(aq,a1.dimension,a1.attribute)}else{if(a1.attribute=="BINORMAL"){ad.vertexBinormalArray=this.getInternalDimensionBuffer(aq,a1.dimension,a1.attribute)}else{ad[a1.attribute]=aq}}}}}}}}}else{var a6=ay[0];var V=this.getBuffers(at,Q,aV.vertexBuffers[0],a6);for(var aZ=0;aZ<a6.length;aZ++){var a1=a6[aZ];if(a1.attribute=="POSITION"){ad.vertexPositionArray=this.getInternalDimensionBuffer(V[aZ],a1.dimension,a1.attribute)}else{if(a1.attribute=="NORMAL"){ad.vertexNormalArray=this.getInternalDimensionBuffer(V[aZ],a1.dimension,a1.attribute)}else{if(a1.attribute=="TEX_COORD_0"){ad.vertexUvArray=this.getInternalDimensionBuffer(V[aZ],a1.dimension,a1.attribute)}else{if(a1.attribute=="TEX_COORD_1"){ad.vertexUv2Array=this.getInternalDimensionBuffer(V[aZ],a1.dimension,a1.attribute)}else{if(a1.attribute=="COLOR"){ad.vertexColorArray=this.getInternalDimensionBuffer(V[aZ],a1.dimension,a1.attribute)}else{if(a1.attribute=="TANGENT"){ad.vertexTangentArray=this.getInternalDimensionBuffer(V[aZ],a1.dimension,a1.attribute)}else{if(a1.attribute=="BINORMAL"){ad.vertexBinormalArray=this.getInternalDimensionBuffer(V[aZ],a1.dimension,a1.attribute)}else{ad[a1.attribute]=V[aZ]}}}}}}}}}for(var aZ=0;aZ<aV.drawingGroups.length;aZ++){var ag=aV.drawingGroups[aZ];var ac=(ag.repRanges!==undefined);var aN=(ag.primitives!==undefined);var R=(ag.canonicals!==undefined);var ar=(ag.cullingData!==undefined);var ab=ad.vertexNormalArray?K:H;var P=[];var aC=new l.DrawingGroup(ab,null,C[ag.mode],ag.start,ag.count,P,undefined,D.GeomTypeEnum.UNKNOWN,0);aC.geometry=ad;aC._geomType=D.GeomTypeEnum[ag.geometricType];ad.drawingGroups.push(aC);if((ag.graphicAttributes!==undefined)&&a3.materials[ag.graphicAttributes]){var aH=a3.materials[ag.graphicAttributes];if(aH.uri){aH.destinationDGforGAS.push(aC)}else{aC.gas=aH}}if((ag.material!==undefined)&&a3.materials[ag.material]){var aH=a3.materials[ag.material];if(aH.uri){aH.destinationDGforMaterial.push(aC)}else{aC.material=aH}}if(ar){aC.cullingData=[];var X=this.getGenericBuffer(at,Q,ag.cullingData.start,"Uint32");var aE=this.getGenericBuffer(at,Q,ag.cullingData.radius,"Float32");for(var aX=0;aX<X.length;aX++){aC.cullingData.push({start:X[aX],radius:aE[aX]})}}if(ac&&!aN){var ai=this.getGenericBuffer(at,Q,ag.repRanges,"Uint32");var aF=ag.start;for(var aX=0;aX<ai.length;aX+=2){var U=new l.SGPrimitive({cgmId:0,group:aC,start:aF,count:ai[aX+1]});aF+=U.count;if(Q.unstreamReps&&aV.reps){var al=ai[aX];var N=an[4*al];var aD=a3.reps[N];if(!aD){aD={rep:new l.SGRep({cgmId:an[4*al+1],solid:an[4*al+2],sag:ae[5*al+4]}),bsphere:[ae[5*al],ae[5*al+1],ae[5*al+2],ae[5*al+3]],nbTriangles:an[4*al+3]};am[al]=aD;a3.reps[N]=aD;Y++}U.rep=aD.rep;aD.rep.primitives.push(U)}P.push(U)}}else{if(aN&&Q.unstreamPrimitives){var Z=this.getBuffers(at,Q,ag.primitives,undefined,ag.geometricType);var aB=Z.buffer;var au=0;var ak=R?this.getBuffers(at,Q,ag.canonicals).buffer:null;for(var aX=0;aX<aB.length;aX+=4){var aj=new l.SGPrimitive({cgmId:aB[aX],group:aC,start:aB[aX+2],count:aB[aX+3]});if(Q.unstreamReps&&aV.reps){var al=aB[aX+1];var N=aA?an[4*al]:0;var aD=aA?a3.reps[N]:am[al];if(!aD){if(aA){aD={rep:new l.SGRep({cgmId:an[4*al+1],solid:an[4*al+2],sag:ae[5*al+4]}),bsphere:[ae[5*al],ae[5*al+1],ae[5*al+2],ae[5*al+3]],nbTriangles:an[4*al+3]};a3.reps[N]=aD}else{var aQ=aV.reps[al];aD={rep:new l.SGRep({cgmId:aQ.cgmId,solid:aQ.solid,sag:aQ.sag}),bbox:aQ.bbox,nbTriangles:aQ.nbTriangles}}am[al]=aD;Y++}aj.rep=aD.rep;aD.rep.primitives.push(aj)}if(R){var ah=ak[au++];if(ah){aj.decoration=new Array();for(var a2=0;a2<ah;a2++){aj.decoration.push(ak[au++])}}}P.push(aj)}}else{var aj=new l.SGPrimitive({cgmId:0,group:aC,start:ag.start,count:ag.count});P.push(aj)}}}if(Q.unstreamSSB&&(Y>this.SSBMinNbReps)){var S=performance.now();var aT=[];var aM=0;var aW=null;var az=new D.Sphere();var W=new D.Sphere();for(var ax in am){var aS=am[ax].bsphere;W.center.set(aS[0],aS[1],aS[2]);W.radius=aS[3];if(!aW){aW=W.clone()}else{az.copy(aW);az.mergeWithSphere(W,aW)}am[ax].rep.boundingSphere={center:[W.center.x,W.center.y,W.center.z],radius:W.radius};aM+=am[ax].nbTriangles;aT.push(am[ax])}if(aM>this.SSBMinNbTriangles){ad.bvhCells=[];S=performance.now();x.indexMap=new Uint32Array(ad.vertexIndexArray.length);if(!x.positions||x.positions.length<ad.vertexPositionArray.length){x.positions=new Float32Array(ad.vertexPositionArray.length)}if(!x.normals||x.normals.length<ad.vertexNormalArray.length){x.normals=new Float32Array(ad.vertexNormalArray.length)}console.log("allocate indexMap/positions/normals in "+(performance.now()-S)+" ms.");ad.bvhCells.push(this.batchBVHCell({objects:aT},ad,x,aW))}}}};this.batchBVHCell=function(W,ad,ai,N){var X=performance.now();var ac=new D.BufferGeometryDS();ac.sharedBuffers=this.sharedBuffers;ac.noMeshInRAM=this.noMeshInRAM;if(N){ac.boundingSphere=N;ac.boundingBox=ac.boundingSphere.getBoundingBox()}else{ac.boundingBox=new D.Box3(W.bbox.min,W.bbox.max);ac.boundingSphere=ac.boundingBox.getBoundingSphere()}ac.compressedVertices=ad.compressedVertices;ac.compressedNormals=ad.compressedNormals;ac.quantizedVector=ad.quantizedVector;ac.offsetVector=ad.offsetVector;var al=ai.indexMap;var S=ai.positions;var Y=ai.normals;h+=performance.now()-X;X=performance.now();var ab=0;var R=0;var aj=[];var ah=[];var V=0;for(var ag=0;ag<W.objects.length;ag++){var O=W.objects[ag];for(var af=0;af<O.rep.primitives.length;af++){var Z=O.rep.primitives[af];V+=Z.count;ah.push(Z)}}q+=performance.now()-X;X=performance.now();var P=new Uint32Array(V);ah.sort(function(an,am){if(an.group.glType<am.group.glType){return -1}if(an.group.glType>am.group.glType){return 1}if(an.group._geomType<am.group._geomType){return -1}if(an.group._geomType>am.group._geomType){return 1}if(an.group.gas.id<am.group.gas.id){return -1}if(an.group.gas.id>am.group.gas.id){return 1}if(an.group.material&&!am.group.material){return -1}if(!an.group.material&&am.group.material){return 1}if(an.group.material&&am.group.material){if(an.group.material.id<am.group.material.id){return -1}if(an.group.material.id>am.group.material.id){return 1}}if(an.rep.boundingSphere.radius>am.rep.boundingSphere.radius){return -1}if(an.rep.boundingSphere.radius<am.rep.boundingSphere.radius){return 1}return 0});F+=performance.now()-X;X=performance.now();var ak;var O;var T;var Z;for(var af=0;af<ah.length;af++){Z=ah[af];if(Z.group!==ak){ak=Z.group;T=new l.DrawingGroup(Z.group.gas,Z.group.material,Z.group.glType,R,0,[],undefined,Z.group._geomType,0);T.geometry=ac;ac.drawingGroups.push(T);O=null;T.cullingData=[]}if(Z.rep!==O){O=Z.rep;T.cullingData.push({start:R,radius:O.boundingSphere.radius})}var U=R;for(var ae=0;ae<Z.count;ae++){var Q=ad.vertexIndexArray[Z.start+ae];if(al[Q]===0){al[Q]=ab+1;if(ad.compressedVertices){S[2*ab]=ad.vertexPositionArray[2*Q];S[2*ab+1]=ad.vertexPositionArray[2*Q+1]}else{S[3*ab]=ad.vertexPositionArray[3*Q];S[3*ab+1]=ad.vertexPositionArray[3*Q+1];S[3*ab+2]=ad.vertexPositionArray[3*Q+2]}if(ad.compressedNormals){Y[ab]=ad.vertexNormalArray[Q]}else{Y[3*ab]=ad.vertexNormalArray[3*Q];Y[3*ab+1]=ad.vertexNormalArray[3*Q+1];Y[3*ab+2]=ad.vertexNormalArray[3*Q+2]}ab++}P[R]=al[Q]-1;R++}Z.start=U;Z.group=T;T.count+=Z.count;T.primitives.push(Z)}z+=performance.now()-X;X=performance.now();ac.vertexIndexArray=P;ac.vertexPositionArray=new Float32Array(S.buffer.slice(0,4*(ad.compressedVertices?2:3)*ab));ac.vertexNormalArray=new Float32Array(Y.buffer.slice(0,4*(ad.compressedNormals?1:3)*ab));w+=performance.now()-X;return ac};this.createNodes=function(U,Q){if(!U){return}if(!Q.data.children){Q.data.children=[]}var ag=Q.data;for(var ac=0;ac<U.length;ac++){var ad=U[ac];var V=null;if(ad.type==="External"){V=new s();Q.data.modelsToLoad.push({destinationNode:V,uri:ad.uri})}else{if(ad.type==="Node3D"){V=new s();Q.data.children[ac]=ad.children}else{var ae=null;var N=null;if(ad.boundingSphere){var af=ad.boundingSphere.center;var R=ad.boundingSphere.radius;ae=new D.Sphere(new D.Vector3(af[0],af[1],af[2]),R)}if(ad.boundingBox){var W=ad.boundingBox.min;var ab=ad.boundingBox.max;N=new D.Box3(new D.Vector3(W[0],W[1],W[2]),new D.Vector3(ab[0],ab[1],ab[2]))}var S=[];for(var Z=0;Z<ad.geometries.length;Z++){var P=ag.geometries[ad.geometries[Z]];if(P.bvhCells){for(var X=0;X<P.bvhCells.length;X++){S.push(P.bvhCells[X])}}else{S.push(P)}}if(!N){S[0].computeBoundingBox();N=S[0].boundingBox}S.boundingBox=N;if(!ae){S[0].computeBoundingSphere();ae=S[0].boundingSphere}S.boundingSphere=ae;var T=(S.length&&S[0]["vertexNormalArray"])?K:H;var O=new D.Mesh(S,T);O.fromLoadedModel=true;O.castShadow=(ad.castShadow!==undefined)?ad.castShadow:true;O.receiveShadow=(ad.receiveShadow!==undefined)?ad.receiveShadow:true;O.enableNormalDepth=(ad.enableNormalDepth!==undefined)?ad.enableNormalDepth:true;V=new e(O);if(ad.lightmaps){for(var Z=0;Z<ad.lightmaps.length;Z++){S[Z].lightMap=ag.textures[ad.lightmaps[Z]].texture}}}}if(ad.material!==undefined){var ah=ag.materials[ad.material];if(ah.uri){ah.destinationNodes.push(V)}else{V.setMaterial(ah)}}ag.nodes[ac]=V;if(ad.matrix){var Y=new D.Matrix4().setFromArray(ad.matrix);V.setMatrix(Y)}if(ad.name){V.setName(ad.name)}if(Q.nodeCallback){Q.nodeCallback(ad,Q,V)}}};this.createLayers=function(N,U){var R=U.data;for(var ab in R.nodes){var O=R.nodes[ab];var X=N[ab];for(var S in X.occurrences){var W=X.occurrences[S].index;var Q=X.occurrences[S];if(!Q.layers.length){continue}O._occurrences[W].renderable.layer=new D.BufferLayer();for(var P=0;P<Q.layers.length;P++){var T=Q.layers[P];var Z=R.geometries[T.geometry];var Y=new D.DrawableInterval(T.drawableInterval.layerNum,T.drawableInterval.start,T.drawableInterval.count,R.materials[T.drawableInterval.material]);Y.primitiveStart=T.drawableInterval.primitiveStart;Y.primitiveCount=T.drawableInterval.primitiveCount;var V=new D.LayerInterval(Z,Z.drawingGroups[T.drawableGroup],Y);O._occurrences[W].renderable.layer.addLayerInterval(V)}}}};this.applyLights=function(Q){var ae=Q.json.lightInstances;if(!ae||!ae.length){return}var O=null;var T=Q.destinationNodes?Q.destinationNodes[0]:Q.destinationNode;if(T._occurrences[0].scene3js){O=T._occurrences[0].scene3js.viewer;O.setAmbientLight(0);O.setIntensityCorrection(true);if(O.useDefaultLights){O.setTriLights(false);O.directionalLight.intensity=0;O.directionalLight2.intensity=0}O.renderer.ToneMappingEffect.setToneMapping(9)}var S=1;if(Q.rootMatrix){S=Q.rootMatrix.elements[0]}T._updateBoundingElements();var ak=Q.json.lights;var U=[];for(var ac=0;ac<ak.length;ac++){var V=ak[ac];var R=V.emissionColor?V.emissionColor:V.color;if(V.energyNormalization){var ah=0.2126*R[0]+0.7152*R[1]+0.0722*R[2];R[0]=R[0]/ah;R[1]=R[1]/ah;R[2]=R[2]/ah}var N=new D.Color().setRGB(R[0],R[1],R[2]);var W="rgb("+R[0]*255+","+R[1]*255+","+R[2]*255+")";var Y=V.emissionValue?V.emissionValue:V.value;if(V.type=="directional"){Y=Y/(S*S);Y=Y;var aj=new D.DirectionalLight(W,Y);aj.color=N}else{if(V.type=="point"){if(!V.emissionMode||V.emissionMode=="LUMINOUS_POWER"){Y=Y/(4*Math.PI)}var aj=new D.PointLight(W,Y,0);aj.color=N;aj.isPhysicallyAttenuated=true;aj.attenuationScale=1/1000000}else{if(V.type=="spot"){var ab=V.cutoffAngle*Math.PI/180;var X=V.falloffAngle*Math.PI/180;if(!V.emissionMode||V.emissionMode=="LUMINOUS_POWER"){Y=Y/(Math.PI*((1-Math.cos(ab))+(1-Math.cos(X))))}var aj=new D.SpotLight(W,Y,0,ab,X);aj.color=N;aj.isPhysicallyAttenuated=true;aj.attenuationScale=1/1000000}else{if(V.type=="rectangle"){if(!V.emissionMode||V.emissionMode=="LUMINOUS_POWER"){Y=Y/(V.width*V.height)}var aj=new D.AreaLight(W,Y,V.width,V.height);aj.color=N}else{if(V.type=="disk"){if(!V.emissionMode||V.emissionMode=="LUMINOUS_POWER"){Y=Y/(V.radius*V.radius*Math.PI)}var aj=new D.DiskLight(W,Y,V.radius);aj.color=N}else{if(V.type=="sphere"){if(!V.emissionMode||V.emissionMode=="LUMINOUS_POWER"){Y=Y/(V.radius*V.radius*4*PI)}var aj=new D.SphereLight(W,Y,V.radius);aj.color=N}else{if(V.type=="tube"){if(!V.emissionMode||V.emissionMode=="LUMINOUS_POWER"){Y=Y/(2*Math.PI*V.width*V.radius+V.radius*V.radius*4*PI)}var aj=new D.SphereLight(W,Y,V.radius,V.width);aj.color=N}else{var aj={}}}}}}}}U.push(aj)}for(var ac=0;ac<ae.length;ac++){var af=ae[ac];if(ak[af.light].type=="environment"){continue}var P=U[af.light];if(af.castShadows&&!(P instanceof D.PointLight)){P.castShadow=true;P.shadowBias=-0.05;P.shadowDarkness=1/ae.length}else{P.castShadow=false}var Z=new D.Matrix4();if(af.matrix){Z.setFromArray(af.matrix);P.target=null}var ad=new D.Matrix4();if(af.ambianceTransform){ad.setFromArray(af.ambianceTransform)}Z=new D.Matrix4().multiplyMatrices(ad,Z);if(Q.rootMatrix){Z=new D.Matrix4().multiplyMatrices(Q.rootMatrix,Z)}if(P instanceof D.DirectionalLight&&P.castShadow){var ag=new D.Vector3();ag.set(0,0,1);ag.applyMatrix4(new D.Matrix4().extractRotation(Z));ag.normalize();ag.multiplyScalar(T._bsShow.radius*1.5);var al=new D.Vector3().addVectors(T._bsShow.center,ag);Z.setPosition(al);P.shadowCameraLeft=-T._bsShow.radius;P.shadowCameraRight=T._bsShow.radius;P.shadowCameraTop=T._bsShow.radius;P.shadowCameraBottom=-T._bsShow.radius;P.shadowCameraNear=al.distanceTo(T._bsShow.center)-T._bsShow.radius;P.shadowCameraFar=al.distanceTo(T._bsShow.center)+T._bsShow.radius;P.shadowMapHeight=1024;P.shadowMapWidth=1024}var ai=new E(P);ai.setMatrix(Z);T.add(ai)}};this.applyCamera=function(R){var Y=R.destinationNodes?R.destinationNodes[0]:R.destinationNode;if(!Y._occurrences[0].scene3js){return}var Q=Y._occurrences[0].scene3js.viewer;var ab=R.json.renderFrames;var S=R.json.currentRenderFrame?R.json.currentRenderFrame:0;if(!ab||!ab.length){return}for(var ah=0;ah<ab.length;ah++){var ac=ab[ah];var ai=R.json.cameras[ac.camera];var ae=ac.resolution;var af=ac.activeEffects;var ag=new D.Matrix4().setFromArray(ai.matrix);var U=new D.Vector3();var P=new D.Quaternion();var an=new D.Vector3();ag.decompose(U,P,an);var X;var ak=10,O=2500;var W=1;if(R.rootMatrix){W=R.rootMatrix.elements[0]}U.multiplyScalar(W);var V=ai.focusDistance*W;if(!ai.autoNearFar&&ai.nearFar){ak=ai.nearFar[0];O=ai.nearFar[1];ak*=W;O*=W}var al=ai.sensorSize?ai.sensorSize:[36,24];al[0]*=W;al[1]*=W;var N;if(ai.type&&ai.Type=="orthographic"){N=u.ORTHOGRAPHIC}else{N=u.PERSPECTIVE;var T=ai.focalLength?ai.focalLength:50;T*=W;var aj=(2*Math.atan(al[0]/(2*T)))*180/Math.PI}var X=new u({viewer:Q,projectionType:N,angle:aj,near:ak,far:O,defaultController:true});X.onMove(Q.render);X.moveTo({eyePosition:U,orientation:P});X.setTargetDistance(V);Q.addViewpoint(X)}var af=ab[S].effects;var ad={bloom:false,aa:false,tonemapping:-1};if(af){for(var ah=0;ah<af.length;ah++){if(effect.type==="bloom"){ad.bloom=true}else{if(effect.type==="downsampling"){ad.aa=true}else{if(effect.type==="toneMapper"){if(effect.toneMapperType==="filmic"){result.tonemapping=6}else{if(effect.toneMapperType==="photographic"){result.tonemapping=8}}if(effect.toneMapperType==="reinhard"){result.tonemapping=3}if(effect.toneMapperType==="gamma"){result.tonemapping=9}if(effect.toneMapperType==="exposure"){}if(effect.toneMapperType==="iccProfile"){}}else{if(effect.type==="vignetting"){}else{if(effect.type==="reconstructionFilter"){}}}}}}}Q.setAntiAliasing(ad.aa);if(ad.tonemapping>-1){Q.getEffect("ToneMapping").setToneMapping(ad.tonemapping)}Q.setBloom(ad.bloom);var Z=Q.getViewpoints();var am=Z.length-ab.length;Q.selectViewpoint(am+S)};this.parseHeader=function(O){var P=O.json.header;if(!P||!P.version){return false}if(parseFloat(P.version)!==2&&parseFloat(P.version)!==3&&parseFloat(P.version)!==3.1){return false}O.version=parseFloat(P.version);if(P.content==="material"){O.content=P.content}var N=new D.Matrix4();if(P.unit==="m"||P.unit==="meter"||P.unit==="meters"){N.makeScale(1000,1000,1000)}else{if(P.unit==="inch"||P.unit==="inches"){N.makeScale(25.4,25.4,25.4)}}if(P.upAxis==="Y"){N.rotateX(0.5*Math.PI)}else{if(P.upAxis==="X"){N.rotateY(0.5*Math.PI)}}if(!N.isIdentity()){O.rootMatrix=N}return true};this.processJSON=function(N){var O=this.parseHeader(N);if(!O){return}if(!N.data.chunks.length&&N.json.binaries){this.getChunks(N.json.binaries.length,N,this.processChunks)}else{this.processChunks(N)}};this.processChunks=function(X){J=performance.now();var Z=X.json;if(typeof Z.extensionsUsed!=="undefined"){for(var W=0;W<Z.extensionsUsed.length;W++){this.extensionsUsed.add(Z.extensionsUsed[W])}}if(typeof Z.extensionsRequired!=="undefined"){for(var W=0;W<Z.extensionsRequired.length;W++){this.extensionsRequired.add(Z.extensionsRequired[W])}}this.createImages(Z.images,X);if(X.content!=="material"){this.createAmbience(Z,X);if(X.version===2){this.createBuffers(Z.buffers,X)}}this.createTextures(Z.textures,X);if(X.version===2){this.createMaterialsV2(Z.materials,X.data,X)}else{this.createMaterials(Z.materials,X.data,X)}if(X.content!=="material"){if(Z.root!==undefined){if(X.version===2){this.createGeometriesV2(Z.geometries,X)}else{this.createGeometries(Z.geometries,Z.buffers,Z.vertexLayouts,X)}this.createNodes(Z.nodes,X);t("processed data in "+(performance.now()-J)+" ms.");J=performance.now();for(var W=0;W<X.data.nodes.length;W++){var Q=X.data.nodes[W];var T=X.data.children;if(T[W]){for(var U=0;U<T[W].length;U++){Q.add(X.data.nodes[T[W][U]],true)}}if(Q.__representations){var U;for(U=0;U<Q.__representations.length;U++){var S,R=[];for(S=0;S<Q.__representations[U].length;S++){R.push(X.data.nodes[Q.__representations[U][S]])}Q._pushRepresentation(R)}}}X.unstreamLayers&&this.createLayers(Z.nodes,X);t("Created links between nodes in "+(performance.now()-J)+" ms.");J=performance.now();var O=X.data.nodes[Z.root];if(X.rootMatrix){var ab=new D.Matrix4().multiplyMatrices(X.rootMatrix,O.getMatrix());O.setMatrix(ab)}if(X.destinationNodes){for(var W=0;W<X.destinationNodes.length;W++){X.destinationNodes[W].add(O)}}else{X.destinationNode.add(O)}t("Attached to scenegraph in "+(performance.now()-J)+" ms.")}else{if(X.data.materials.length===1){for(var W=0;W<X.destinationNodes.length;W++){X.destinationNodes[W].setMaterial(X.data.materials[0])}for(var W=0;W<X.destinationDGforGAS.length;W++){X.destinationDGforGAS[W].gas=X.data.materials[0]}for(var W=0;W<X.destinationDGforMaterial.length;W++){X.destinationDGforMaterial[W].material=X.data.materials[0]}}}this.applyLights(X);this.applyCamera(X)}var Y=X.data.modelsToLoad.length;if(Y){var P=0;for(var W=0;W<Y;W++){var N=X.data.modelsToLoad[W];this.load({url:this.getURI(N.uri,X.path),destinationNode:N.destinationNode,destinationNodes:N.destinationNodes,destinationDGforGAS:N.destinationDGforGAS,destinationDGforMaterial:N.destinationDGforMaterial,zipped:true,layers:X.unstreamLayers,reps:X.unstreamReps,doneCallback:function(){P++;if(P===Y){if(X.doneCallback){X.doneCallback()}}}})}}else{this.nbModelsToLoad--;if(X.doneCallback){var V={isLast:!this.nbModelsToLoad,json:X.json};if((X.content==="material")&&(X.data.materials.length>0)){V.material=X.data.materials[0];V.materials=X.data.materials.slice()}X.doneCallback(V)}}if(X.readyCallback){X.readyCallback()}delete this.modelsToLoad[X.loadIndex]};this.internalLoad=function(P){var T=this;var O=this.modelsToLoad[P];J=performance.now();if(!O.json){var S=O.url;var N="text";if(O.zipped){N="blob"}if(O.concat){N="arraybuffer"}var R=function(ac){t("file downloaded in "+(performance.now()-J)+" ms.");J=performance.now();if(O.zipped){var U=function(af){t("zip file reader created in "+(performance.now()-J)+" ms.");O.zipEntries=af;var ah=null;for(var ag=0;ag<af.length;ag++){if(af[ag].filename==="manifest.json"){ah=af[ag]}}J=performance.now();T.getEntryFile(ah,"text",function(ai){t("unzipped JSON file in "+(performance.now()-J)+" ms.");J=performance.now();O.json=JSON.parse(ai);t("parsed JSON file in "+(performance.now()-J)+" ms.");T.processJSON(O)})};B.createReader(new B.BlobReader(ac),function(af){af.getEntries(U)},O.errorCallback)}else{if(O.concat){var V=new Uint8Array(ac);var Z=new Uint32Array(ac,0,1);var Y=Z[0];var ad=new Uint16Array(V.buffer,4,Y/2);var W=[];var X=65535;for(var ab=0;ab*X<ad.length;ab++){W.push(String.fromCharCode.apply(null,ad.subarray(ab*X,(ab+1)*X)))}var ae=W.join("");t("unbinarized JSON file in "+(performance.now()-J)+" ms.");J=performance.now();O.json=JSON.parse(ae);t("parsed JSON file in "+(performance.now()-J)+" ms.");O.concatBinaries={data:V,offset:V.byteLength};T.processJSON(O)}else{t("JSON file downloaded in "+(performance.now()-J)+" ms.");J=performance.now();O.json=JSON.parse(ac);t("parsed JSON file in "+(performance.now()-J)+" ms.");T.processJSON(O)}}};if(S.slice(0,5)=="file:"){var Q=new XMLHttpRequest();Q.open("GET",S,true);Q.responseType=N;Q.withCredentials=true;Q.onreadystatechange=function(U){if(Q.readyState===4){if(Q.status===0||Q.status===200){R(Q.response)}else{O.errorCallback()}}};Q.send(null)}else{UWA.Ajax.request(S,{async:true,cors:true,withCredentials:true,responseType:N,onComplete:R,onFailure:O.errorCallback})}}else{this.processJSON(O)}};this.getChunks=function(S,T,N){var R=this;if(!S){if(T.concatBinaries){T.concatBinaries.data=null}N.call(this,T);return}S--;J=performance.now();if(T.zipped){var W=null;for(var Q=0;Q<T.zipEntries.length;Q++){if(T.zipEntries[Q].filename===T.json.binaries[S].uri){W=T.zipEntries[Q]}}if(W){this.getEntryFile(W,"arraybuffer",function(Z){t("unzipped binary file "+S+" in "+(performance.now()-J)+" ms.");T.data.chunks[S]=Z;R.getChunks(S,T,N)})}else{R.getChunks(S,T,N)}}else{if(T.concat){J=performance.now();var U=T.json.binaries[S];if(U.concatenated===false){R.getChunks(S,T,N);return}var P=U.byteLength;if(P%4){P+=4-(P%4)}T.concatBinaries.offset-=P;if(T.concatBinaries.data.buffer.slice){var Y=T.concatBinaries.data.buffer.slice(T.concatBinaries.offset,T.concatBinaries.offset+U.byteLength);T.data.chunks[S]=new Uint8Array(Y)}else{var Y=new Uint8Array(T.concatBinaries.data.buffer,T.concatBinaries.offset,U.byteLength);var V=new Uint8Array(U.byteLength);for(var O=0;O<U.byteLength;O++){V[O]=Y[O]}T.data.chunks[S]=V}t("splitted binary file "+S+" in "+(performance.now()-J)+" ms.");R.getChunks(S,T,N)}else{var X=new XMLHttpRequest();X.open("GET",T.path+T.json.binaries[S].uri,true);X.responseType="arraybuffer";X.withCredentials=true;X.onreadystatechange=function(Z){if(X.readyState===4){if(X.status===0||X.status===200){t("xhr binary file "+S+" in "+(performance.now()-J)+" ms.");T.data.chunks[S]=this.response;R.getChunks(S,T,N)}}};X.send(null)}}};this.setMode=function(N){this.mode=N};this.setSharedBuffers=function(N){this.sharedBuffers=N};this.setNoMeshInRAM=function(N){this.noMeshInRAM=N};this.setBaseUrl=function(N){this.baseUrl=N};this.load=function(O){var N={version:3,content:"sceneGraph",url:O.url,path:O.url?o.parseUrl(O.url+".json").directoryPath:null,zipped:(O.zipped!==undefined)?O.zipped:((this.mode===undefined)||(this.mode==="zipped")),concat:(O.concat!==undefined)?O.concat:(this.mode==="concat"),json:O.json,readyCallback:O.readyCallback,progressCallback:O.progressCallback,doneCallback:O.doneCallback,errorCallback:O.errorCallback,imagesCallback:O.imageCallback,materialsCallback:O.materialCallback,nodeCallback:O.nodeCallback,switchLODTextureCB:O.switchLODTextureCallback,onTexturesLoadedCB:O.onTexturesLoadedCallback,destinationNode:O.destinationNode,destinationNodes:O.destinationNodes,destinationDGforGAS:O.destinationDGforGAS,destinationDGforMaterial:O.destinationDGforMaterial,unstreamLayers:(O.layers!==undefined)?O.layers:false,unstreamReps:(O.reps!==undefined)?O.reps:false,unstreamPrimitives:(O.primitives!==undefined)?O.primitives:false,unstreamSSB:(O.ssb!==undefined)?O.ssb:false,gasSharing:(O.gasSharing!==undefined)?O.gasSharing:false,lightMapAsIrradiance:(O.lightMapAsIrradiance!==undefined)?O.lightMapAsIrradiance:false,loadIndex:this.loadIndex,data:{chunks:O.chunks?O.chunks:[],header:{},nodes:[],children:[],buffers:[],geometries:[],images:[],textures:[],materials:[],reps:{},modelsToLoad:[],nbImagesToLoad:0}};this.modelsToLoad[this.loadIndex]=N;this.nbModelsToLoad++;this.internalLoad(this.loadIndex);this.loadIndex++};this.loadMaterial=function(P){if(!P.json){return false}P.zipped=false;P.chunks=[];var N=0;if(P.json.binaries&&P.binaries){for(var O=0;O<P.json.binaries.length;O++){var Q=P.json.binaries[O];if(!Q.extUri){P.chunks.push(P.binaries[N]);N++}}}this.load(P)}};return f});define("DS/Visualization/ThreeDXLoader",["DS/VisuLoaders/ThreeDXLoader"],function(a){return a});define("DS/Visualization/JSONReader",["DS/VisuLoaders/JSONReader"],function(a){return a});define("Visualization/JSONReader",["DS/Visualization/JSONReader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/JSONReader");return b});define("DS/Manipulators/PointHandle",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/HandlePointManipulator","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/SceneGraphNodes/FixedSizeNode3D","DS/Visualization/SceneGraphFactory"],function(j,g,c,k,d,f,e,b,a,m,h){var l=g.extend({init:function(v){this._parent(v.name);this.sceneGraph=v.sceneGraph;this.size=v.size?v.size:20;this.fillColor=v.fillColor?v.fillColor:new j.Color("#FFFFFF");this.opacity=v.opacity?v.opacity:1;this._modelEvent=new a();this.isPreactivated=false;this.isManipulated=false;var w=v.noz!==undefined?v.noz:true;var p=this;var o=new k();var q={width:1,height:1,fill:true,fillColor:null,noEdge:true,layerNb:w?1:0};var t=o.createRectangle(q);var u=c.getWebappsAssetUrl("Robot","");var s=new j.ImageUtils.loadTexture(u+"models/textures/Point.png",undefined,null,null,j.ImageUtils.crossOriginPolicy);s.flipY=false;s.minFilter=j.LinearMipMapLinearFilter;this.pointMat=new j.MeshBasicMaterial({map:s,side:j.DoubleSide,transparent:true,alphaTest:0.05,enableClipPlanes:false,opacity:this.opacity});this.pointMat.force=true;var r=h.createMeshNode(t,this.pointMat);r.setShadow(false);r.setFrustumCulled(false);r.name="diskNode";r.excludeFromCSO(true);r.excludeFromHighlight(true,true);r.setMatrix(new j.Matrix4().setPosition(new j.Vector3(-0.5,-0.5,0)));this.diskNode=r;var n={position:this.position,name:"billBoard1",type:"Spherical"};this.billBoardNode=new d(n);this.billBoardNode.add(r);this.fixedSizeNode=new m({name:"fixedSizeNode3D",ratio:this.size});this.fixedSizeNode.add(this.billBoardNode);this.add(this.fixedSizeNode);this.sceneGraph.add(this);this.manipulator=new f();this.manipulator.setExclusive(true);this.manipToken=this.manipulator.linkToNode(this);this.manipulator.onBeginManipulate(function(x){p._modelEvent.publish({event:"BeginManipulate",data:x,context:this});p.pointMat.color=new j.Color("#1B6E9C");x.viewer.setCursor("-webkit-grabbing");p.isManipulated=true;p.fixedSizeNode.setRatio(1.2*p.size);x.viewer.render()});this.manipulator.onManipulate(function(x){p._modelEvent.publish({event:"Manipulate",data:x,context:this});x.viewer.setCursor("-webkit-grabbing")});this.manipulator.onEndManipulate(function(x){p._modelEvent.publish({event:"EndManipulate",data:x,context:this});if(!p.isPreactivated){x.viewer.setCursor("auto");p.pointMat.color=p.fillColor;p.fixedSizeNode.setRatio(p.size)}else{x.viewer.setCursor("pointer");p.pointMat.color=new j.Color("#A1D9ED")}p.isManipulated=false;x.viewer.render()});this.manipulator.onBeginPreactivate(function(x){p._modelEvent.publish({event:"BeginPreactivate",data:x,context:this});x.viewer.setCursor("pointer");p.isPreactivated=true;if(!p.isManipulated){p.pointMat.color=new j.Color("#A1D9ED")}p.fixedSizeNode.setRatio(1.2*p.size);x.viewer.render()});this.manipulator.onPreactivate(function(x){p._modelEvent.publish({event:"Preactivate",data:x,context:this})});this.manipulator.onEndPreactivate(function(x){p._modelEvent.publish({event:"EndPreactivate",data:x,context:this});x.viewer.setCursor("auto");p.isPreactivated=false;if(!p.isManipulated){p.pointMat.color=p.fillColor;p.fixedSizeNode.setRatio(p.size)}x.viewer.render()})},setSize:function(n){this.size=n;this.fixedSizeNode.setRatio(this.size)},setFillColor:function(n){this.fillColor=n;this.pointMat.color=this.fillColor},setOpacity:function(n){this.opacity=n;this.pointMat.opacity=this.opacity},subscribe:function(n,o){return this._modelEvent.subscribe({event:n},o)},unsubscribe:function(n){this._modelEvent.unsubscribe(n)},dispose:function(){if(this.manipulator){this.manipulator.unlink(this.manipToken);this.manipulator=null}this.sceneGraph.remove(this)}});return UWA.namespace("THREEDS/Nodes/PointHandle",l)});define("Manipulators/PointHandle",["DS/Manipulators/PointHandle","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Manipulators/PointHandle");return b});define("DS/VisuLoaders/XMLV43Loader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","UWA/Utils","DS/Visualization/Utils","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/ZipJS/zip-fs","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Visualization/PathElement","DS/Visualization/SceneGraph","DS/SceneGraphNodes/AxisSystemNode","DS/Mesh/Mesh","DS/Visualization/LoaderUtils","DS/VisuLoaders/ThreeDXLoader","DS/ZipJS/LoaderInflate"],function(r,e,a,g,m,q,h,c,b,l,k,j,f,t,d,s){var n=function(v){var u=document.getElementsByTagName("script");for(var x=0;x<u.length;x++){var w=u.item(x);var y=w.getAttribute("src");if(y&&y.match(v)){return y.substring(0,y.lastIndexOf("/")+1)}}return"scripts/ThreeDS/Visualization/"};var p={TECHREP:{module:"DS/SIMAnimationWebMdl",file:"SIMAnimationRepRefUnstreamer"}};var o=function(aX,T){var E=false;var M=false;var aA=aX;var aW=undefined;if(r.supportedExtensions){aW=r.supportedExtensions.elementIndexUint?true:undefined}var Z=[];var aP=false;var at=null;var J=(T!==undefined)?T:null;var aO=null;var aU=null;var ax=null;var al=null;var aV;var an=true;var B=null;var aI=4;var aq=null;var aK=[];var aL=false;var L=0;var am=0;var ah=4;var aS=0;var aF=[];var aZ=null;var W="TESSELLATED";var S=[];var x=[];var aM=new Date().getTime();var N=2000;var aj=false;var v=false;var I=false;var ac=false;var aw=null;var ao={};var D=[];var ak=true;var aQ=false;var aC=false;var av=false;var ai=false;var A=true;var az=[];var aJ=false;var ab=[];var H={};var aY={};var R;var aH=null;var ae=[];var U={};function w(a2,a8,a3,a4,a5,a6){if(E){if(document.implementation&&document.implementation.createDocument){var a7=new XMLHttpRequest();if(a7.overrideMimeType){a7.overrideMimeType(a3)}if(a8==="blob"){a7.responseType="blob"}if(a8==="arraybuffer"){a7.responseType="arraybuffer"}a7.onreadystatechange=function(){if(a7.readyState===4){if(a7.status===0||a7.status===200){if(a7.response&&a7.responseType==="blob"){var bc=new Blob([a7.response],{type:a3});a4(bc,a2,a6)}if(a7.response&&a7.responseType==="arraybuffer"){a4(a7.response,a2,a6)}else{if(a7.responseXML){a4(a7.responseXML,a2,a6)}else{if(a7.responseText){a4(a7.responseText,a2,a6)}else{console.error("XMLV43Loader: Empty or non-existing file ("+a2+")");(typeof a5!=="undefined")&&a5(a2)}}}}else{(typeof a5!=="undefined")&&a5(a2)}}};a7.open("GET",a2,true);a7.send(null)}else{alert("Don't know how to parse XML!");(typeof a5!=="undefined")&&a5(a2)}}else{var a1=a2.replace(/^.*[\\\/]/,"");var a9=at.find(a1);if(a9&&(aS<ah)){aS++;if(a8==="blob"){a9.getBlob(a3,function(bd){aS--;if(aF.length>0){var bc=aF[0];w(bc.url,bc.type,bc.mime,bc.cbLoad,bc.cbError,bc.args);aF.splice(0,1)}a4(bd,a2,a6)})}else{if(a8==="arraybuffer"){a9.getBlob(a3,function(be){aS--;if(aF.length>0){var bd=aF[0];w(bd.url,bd.type,bd.mime,bd.cbLoad,bd.cbError,bd.args);aF.splice(0,1)}var bc=new FileReader();bc.onload=function(bf){a4(bf.target.result,a2,a6)};bc.readAsArrayBuffer(be)})}else{a9.getText(function(be){aS--;if(aF.length>0){var bd=aF[0];w(bd.url,bd.type,bd.mime,bd.cbLoad,bd.cbError,bd.args);aF.splice(0,1)}if(a8==="xml"){try{var bg=new DOMParser();var bf=bg.parseFromString(be.target.result,"text/xml");a4(bf,a2,a6)}catch(bc){(typeof a5!=="undefined")&&a5(a2)}}else{if(a8==="string"){a4(be.target.result,a2,a6)}}})}}}else{if(aS>=ah){aF.push({url:a2,type:a8,mime:a3,cbLoad:a4,cbError:a5,args:a6})}else{(typeof a5!=="undefined")&&a5(a2);if(aF.length>0){var ba=aF[0];aF.splice(0,1);w(ba.url,ba.type,ba.mime,ba.cbLoad,ba.cbError,ba.args)}}}}}function aE(a2){if(a2 instanceof Object){var a1="Error loading 3DXML : "+a2.url+"\n";switch(a2.type){case"LOAD":case"LOAD_ARCHIVE":a1+="Could not load the 3DXML file.";break;case"LOAD_ENTRY":a1+="Could not read Zip entries for this 3DXML.";break;case"PARSE":a1+="Could not parse XML data.";break;case"REPFORMAT":a1+="Rep format is not supported.";break;case"VERSION":a1+="This version is not supported.";break;case"REVIEW_MISSING":a1+="3DXML file does not contain any review data, only briefcase.";break}}a1+="The model is not found, corrupted or not entirely supported.";console.warn(a1)}function C(a1){D=[];if(!a1){return}for(var a2 in a1){D.push(a2)}}this.abort=function(){Z=[];am=0;if(aq!==null){for(var a1=0;a1<aq.length;++a1){if(aq[a1]!==null){aq[a1].terminate()}}aK=[];aL=false;aq=null}if(B){B=null}ag()};this.load=function(a3,be,a1,a7,a5,bg,ba,a6,a2,a8,bd,bj,bh,bk,bf,a9,bc,bi,a4){if(aP){Z.push({url:a3,readyCallback:be,progressCallback:a1,doneCallback:a7,errorCallback:a5,filterNavReps:bg,refreshTime:ba,readDeco:a6,newInfra:a2,primWithBS:a8,edgeTrans:bd,withSG:bj,sharedBuff:bh,nmir:bk,ssb:bf,sag:a9,uvrWorker:bc,iapplicativeContainers:bi});return}aP=true;aV=a3;if(a3 instanceof Object){aV=a3.serverurl?a3.serverurl:"";aV+=a3.filename?a3.filename:"";if(a3.loaderSettings&&!!a3.loaderSettings.uncompressed){E=!!a3.loaderSettings.uncompressed;W=a3.loaderSettings.repType?a3.loaderSettings.repType:"CGR";if(W==="3DX"&&!aZ){aZ=new d()}}}ak=bd;aQ=a4;aC=bh;av=bk;aO=be;aU=a7;ax=a1;al=a5;M=bg;N=ba;aj=a6;v=a8;I=bf;ac=a9;an=bc;aw=bi;C(aw);ai=bj;A=a2;if(E){w(a3+"/CATMaterialRef.3dxml","xml","text/xml",af,function(bl){af(null,bl,true)})}else{at=new q.fs.FS();at.importHttpContent(a3,false,function(){var bl=w(aV+"/CATMaterialRef.3dxml","xml","text/xml",af,function(bm){w(aV+"/CATMaterialDisciplines.3dxml","xml","text/xml",af,function(bn){af(null,bn,true)})})},a5?a5:aE)}};var ay=this.load;function ag(){if(at){at.closeZipReader();at=null}aO=null;aU=null;ax=null;al=null;aV="";L=0;am=0;aS=0;aF=[];W="TESSELLATED";S=[];x=[];aM=new Date().getTime();az=[];aJ=false;ab=[];H={};aY={};R="";aH=null;ae=[];U={};aP=false;if(Z.length){var a1=Z.shift();ay(a1.url,a1.readyCallback,a1.progressCallback,a1.doneCallback,a1.errorCallback,a1.filterNavReps,a1.refreshTime,a1.readDeco,a1.newInfra,a1.primWithBS,a1.edgeTrans,a1.withSG,a1.sharedBuff,a1.nmir,a1.ssb,a1.sag,a1.uvrWorker,a1.iapplicativeContainers)}}function af(bj,a3,a9){if((a9===undefined)||!a9){var a1=bj.firstChild;if(a1.nodeName!=="Model_3dxml"){return}for(var be=0;be<a1.childNodes.length;be++){var a4=a1.childNodes[be];if(a4.nodeName==="CATMaterialRef"){for(var bc=0;bc<a4.childNodes.length;bc++){var a7=a4.childNodes[bc];if((a7.nodeName!=="CATMatReference")&&(a7.nodeName!=="MaterialDomainInstance")&&(a7.nodeName!=="MaterialDomain")){continue}var a8=a7.getAttribute("id");var bk=a7.getAttribute("name");switch(a7.nodeName){case"CATMatReference":if(H[a8]!==undefined){H[a8].name=bk}else{H[a8]={name:bk}}break;case"MaterialDomainInstance":var bd=0;var bg=0;for(var ba=0;ba<a7.childNodes.length;ba++){var a6=a7.childNodes[ba];if(a6.nodeName==="IsAggregatedBy"){bd=a6.textContent}else{if(a6.nodeName==="IsInstanceOf"){bg=a6.textContent}}}H[a8]={parent:bd,instance:bg};if(H[bd]!==undefined){H[bd].instance=a8}else{H[bd]={instance:a8}}break;case"MaterialDomain":var bi=a7.getAttribute("associatedFile");var bf=a7.getAttribute("format");var bh=[];bh=bi.split("urn:3DXML:");bi=bh[1];var a2=true;for(var ba=0;ba<a7.childNodes.length;ba++){var a6=a7.childNodes[ba];var a5=a6.textContent;if((a6.nodeName==="V_MatDomain")&&(a5.toUpperCase()!=="RENDERING")){a2=false;break}}if(!a2){break}if(H[a8]!==undefined){H[a8].filename=bi;H[a8].format=bf}else{H[a8]={filename:bi,format:bf}}break;default:break}}}}}w(aV+"/CATRepImage.3dxml","xml","text/xml",K,function(bl){w(aV+"/PLMDmtDocument.3dxml","xml","text/xml",K,function(bm){K(null,bm,true)})})}function K(be,a3,bg){if((bg===undefined)||!bg){var a7="";var a9=be.firstChild;if(a9.nodeName!=="Model_3dxml"){return}for(var ba=0;ba<a9.childNodes.length;ba++){var a5=a9.childNodes[ba];if(a5.nodeName==="CATRepImage"){for(var a8=0;a8<a5.childNodes.length;a8++){var bc=a5.childNodes[a8];if(bc.nodeName==="CATRepresentationImage"){var a4=bc.getAttribute("id");var a2=bc.getAttribute("name");var bd=bc.getAttribute("format");var a6=bc.getAttribute("associatedFile");var bh=a6.split("urn:3DXML:");aY[a4]={filename:bh[1],buffer:null}}}}}}var a1=0;for(var bf in aY){if(aY.hasOwnProperty(bf)){a1++}}u(a1?(a1-1):0)}function au(a1,a2){var a5=0;var a4=null;for(var a3 in a1){if(a1.hasOwnProperty(a3)){if(a5===a2){a4=a3;break}a5++}}return a4}function u(a8){if(a8===-1){var a5=0;for(var a2 in H){if(H.hasOwnProperty(a2)){a5++}}aN(a5?(a5-1):0);return}var a6=au(aY,a8);if((aY[a6]===undefined)||(aY[a6].filename===undefined)||(aY[a6].filename==="")){u(a8-1)}else{var a4=/(?:\.([^.]+))?$/;var a3=a4.exec(aY[a6].filename)[1];var a7="image/";if(a3==="jpg"){a3="jpeg"}a7=a7+a3;var a1="blob";if(a3==="dds"){a7="application/octet-stream";a1="arraybuffer"}w(aV+"/"+aY[a6].filename,a1,a7,F,(function(a9){return function(){u(a9-1)}})(a8),a8)}}function F(a3,a1,a4){var a2=au(aY,a4);aY[a2].buffer=a3;u(a4-1)}function aN(a2){if(a2===-1){w(aV+"/Manifest.xml","xml","text/xml",ap);return}var a1=au(H,a2);if((H[a1]===undefined)||(H[a1].filename===undefined)){aN(a2-1)}else{if(H[a1].format!=="UVR"){w(aV+"/"+H[a1].filename,"xml","text/xml",aG,function(){},a2)}else{aN(a2-1)}}}function aG(bg,a2,a3){var a8={};a8.shading="Phong";a8.DiffuseMapWrap=[];a8.DiffuseMapRepeat=[0,0];var ba=bg.firstChild;if(ba.nodeName!=="Osm"){aN(a3-1);return}for(var bc=0;bc<ba.childNodes.length;bc++){var a5=ba.childNodes[bc];var a6=(a5.nodeName==="Feature")&&a5.getAttribute("Alias");if(a6&&(a6.indexOf("RenderingFeature")!==-1)){for(var a9=0;a9<a5.childNodes.length;a9++){var bd=a5.childNodes[a9];if(bd.nodeName==="Attr"){var bf=bd.getAttribute("Type");var be=bd.getAttribute("Value");var a1=bd.getAttribute("Name");switch(bf){case"int":be=parseInt(be,10);a8[a1]=be;switch(a1){case"WrappingModeU":if(be){a8.DiffuseMapWrap[0]="repeat";a8.DiffuseMapRepeat[0]=1}break;case"WrappingModeV":if(be){a8.DiffuseMapWrap[1]="repeat";a8.DiffuseMapRepeat[1]=1}break;case"PreviewType":var a4=parseInt(be);switch(a4){case 0:a8.mappingFunction="SPHERICAL_ENV_MAP";break;case 2:a8.mappingFunction="USER_MAPPING";break}break;default:break}break;case"double":switch(a1){case"DiffuseColor":a8.colorDiffuse=Y(be);break;case"SpecularColor":a8.colorSpecular=Y(be);break;case"AmbientColor":a8.colorAmbient=Y(be);break;case"SpecularExponent":a8.shininess=128*parseFloat(be);break;case"SpecularCoef":a8.specularCoef=parseFloat(be);break;case"Reflectivity":a8.reflectivityCoef=parseFloat(be);break;case"Transparency":a8.transparency=parseFloat(be);a8.transparent=(a8.transparency>0);break;default:break}break;case"boolean":be=(be==="true");switch(a1){case"AlphaTest":a8.alphaTest=be?0.5:0;break;default:a8[a1]=be;break}break;case"external":var bi=[];bi=be.split("urn:3DXML:");be=bi[1];bi=be.split("#");be=bi[0];var a7=bi[1];if((a1==="TextureImage")&&aY[a7]&&aY[a7].buffer){a8.DiffuseMap=aY[a7]}break;default:break}}}}}if(a3!==undefined){var bh=au(H,a3);if(H[bh]===undefined){H[bh]={}}a8.type="material3DXML";H[bh].params=a8}aN(a3-1)}function ap(a4,a1){var a3=a4.firstChild;if(a3&&a3.childNodes){for(var a2=0;a2<a3.childNodes.length;a2++){var a5=a3.childNodes[a2];switch(a5.nodeName){case"Root":R=a5.textContent;break;default:break}}}w(aV+"/"+R,"xml","text/xml",P,function(a6){var a7=al?al:aE;if(a7){a7({url:a6,type:"REVIEW_MISSING"})}})}function P(bq,a3){var a1=bq.firstChild;if(a1&&a1.nodeName==="Model_3dxml"){for(var bh=0;bh<a1.childNodes.length;bh++){var a5=a1.childNodes[bh];if(a5.nodeName==="Header"){for(var bf=0;bf<a5.childNodes.length;bf++){var a8=a5.childNodes[bf];if(a8.nodeName!=="SchemaVersion"){continue}var a2=a8.textContent;var bk=a2.substring(0,1);if(bk<4){var bj=al?al:aE;if(bj){bj({url:a3,type:"VERSION"})}return}}continue}if(a5.nodeName!=="ProductStructure"){continue}var bo=a5.getAttribute("root");for(var bf=0;bf<a5.childNodes.length;bf++){var a8=a5.childNodes[bf];if(a8.nodeName!=="Reference3D"&&a8.nodeName!=="Instance3D"&&a8.nodeName!=="ReferenceRep"&&a8.nodeName!=="InstanceRep"){continue}var a9=a8.getAttribute("id");var br=a8.getAttribute("name");var ba=new h();switch(a8.nodeName){case"Reference3D":if(ae[a9]===undefined){ae[a9]=ba}else{ba=ae[a9]}if((bo===a9)&&(aH===null)){aH=ba}break;case"Instance3D":case"InstanceRep":ae[a9]=ba;var bg="";var bm="";var be=null;for(var bd=0;bd<a8.childNodes.length;bd++){var a7=a8.childNodes[bd];if(a7.nodeName==="IsAggregatedBy"){bg=a7.textContent}else{if(a7.nodeName==="IsInstanceOf"){bm=a7.textContent}else{if(a7.nodeName==="RelativeMatrix"){var bp=y(a7.textContent);if(be===null){be=new r.Matrix4()}be.set(bp[0],bp[3],bp[6],bp[9],bp[1],bp[4],bp[7],bp[10],bp[2],bp[5],bp[8],bp[11],0,0,0,1)}}}}if(be!==null){ba._matrix=be}if((bg!=="")&&(bm!=="")){if(ae[bg]===undefined){ae[bg]=new h()}ae[bg].addChild(ba);if(ae[bm]===undefined){ae[bm]=new h()}ba.addChild(ae[bm])}break;case"ReferenceRep":if(ae[a9]===undefined){ae[a9]=ba}else{ba=ae[a9]}var bm="";var a4=a8.getAttribute("format");var bl;if(a4&&(typeof a4==="string")){bl=a4.toUpperCase()}var bc=a8.getAttribute("associatedFile");if(bl==="UVR"||bl==="TESSELLATED"){if(W!=="3DX"){a4=bl;W=bl}else{a4="3DX"}}var bn=[];bn=bc.split("urn:3DXML:");bc=bn[1];var bi={file:bc,format:a4,node:ba};if(S[bc]!==undefined){S[bc].push(ba)}else{S[bc]=[ba];if(g.getExtension(bc)!=="ifc"){x.push(bi)}}U[ba.id]=bi;break;default:break}ba.name=br;ba.productType=a8.nodeName;ba.persistentId=a9;ba.getPersistentId=function(){return this.persistentId}}}for(var bh=0;bh<a1.childNodes.length;bh++){var a5=a1.childNodes[bh];if(a5.nodeName!=="DefaultView"){continue}for(var bf=0;bf<a5.childNodes.length;bf++){var a8=a5.childNodes[bf];if(a8.nodeName!=="DefaultViewProperty"){continue}z(a8)}}for(var bh=0;bh<a1.childNodes.length;bh++){var a5=a1.childNodes[bh];if(a5.nodeName!=="CATMaterial"){continue}for(var bf=0;bf<a5.childNodes.length;bf++){var a8=a5.childNodes[bf];if(a8.nodeName!=="CATMatConnection"){continue}aR(a8)}}}if(M&&aH){aH.traverse(function(bt,bs){var bu=bs.indexOf(bt);if(bu!==-1){bs.splice(bu,1);if(bt.productType==="ReferenceRep"){if(U[bt.id]){console.log(U[bt.id]);bu=x.indexOf(U[bt.id]);if(bu!==-1){x.splice(bu,1)}}}for(var bv=0;bv<bt.children.length;bv++){bs.push(bt.children[bv])}return false}if(bt.productType==="Reference3D"){var bw=[];var bx=false;for(var bv=0;bv<bt.children.length;bv++){var by=bt.children[bv];bx=bx||(by.productType==="Instance3D");if(by.productType==="InstanceRep"){bw.push(by)}}if(bx){for(var bv=0;bv<bw.length;bv++){bs.push(bw[bv])}}}return false},new Array)}if(!x.length){var a6=aU;ag();a6()}else{aD()}}function z(a3){var bj=[];var a1=true;var a4=false;var a9=null;var bf=null;var bd=new r.Color();var a2=1;for(var bh=0;bh<a3.childNodes.length;bh++){var a5=a3.childNodes[bh];if(a5.nodeName==="OccurenceId"){for(var bg=0;bg<a5.childNodes.length;bg++){var bc=a5.childNodes[bg];if(bc.nodeName==="id"){var a7="";var a6="";var bi=[];bi=bc.textContent.split("urn:3DXML:");a6=bi[1];bi=a6.split("#");a7=bi[0];a6=bi[1];if(ae[a6]!==undefined&&(bj.length===0||ae[a6]!==bj[bj.length-1])){bj.push(ae[a6]);if(ae[a6].children[0]!==undefined){bj.push(ae[a6].children[0])}}}}}else{if(a5.nodeName==="GraphicProperties"){for(var bg=0;bg<a5.childNodes.length;bg++){var bc=a5.childNodes[bg];if(bc.nodeName==="SurfaceAttributes"){for(var be=0;be<bc.childNodes.length;be++){var ba=bc.childNodes[be];if(ba.nodeName==="Color"){a4=true;bd.r=parseFloat(ba.getAttribute("red"));bd.g=parseFloat(ba.getAttribute("green"));bd.b=parseFloat(ba.getAttribute("blue"));if(ba.getAttribute("alpha")){a2=parseFloat(ba.getAttribute("alpha"))}if(bd.r===-1){return}}}}else{if(bc.nodeName==="GeneralAttributes"){if(bc.getAttribute("visible")){a1=(bc.getAttribute("visible")==="true")}}}}}else{if(a5.nodeName==="RelativePosition"){var bk=y(a5.textContent);bf=new r.Matrix4();bf.set(bk[0],bk[3],bk[6],bk[9],bk[1],bk[4],bk[7],bk[10],bk[2],bk[5],bk[8],bk[11],0,0,0,1)}}}}if(a4){var a8=new b();a9=a8.getMaterialFromGAS({color:bd,opacity:a2})}az.push({occPath:new l(bj),material:a9,matrix:bf,visible:a1});if(bf){aJ=true}}function aR(a8){var a3=a8.getAttribute("id");var a2=a8.getAttribute("name");var bd="";var a9="";var bf=[];var be=null;for(var ba=0;ba<a8.childNodes.length;ba++){var a4=a8.childNodes[ba];if(a4.nodeName==="IsAggregatedBy"){bd=a4.textContent}else{if(a4.nodeName==="PLMRelation"){for(var a6=0;a6<a4.childNodes.length;a6++){var bc=a4.childNodes[a6];if(bc.nodeName==="C_Role"){a9=bc.textContent}else{if(bc.nodeName==="Ids"){for(var a5=0;a5<bc.childNodes.length;a5++){var a7=bc.childNodes[a5];if(a7.nodeName==="id"){if((a9==="CATMaterialMadeOfLink")||(a9==="CATMaterialDressByLink")){if(ae[a7.textContent]!==undefined&&(bf.length===0||ae[a7.textContent]!==bf[bf.length-1])){bf.push(ae[a7.textContent]);if(ae[a7.textContent].children[0]!==undefined){bf.push(ae[a7.textContent].children[0])}}}else{if(a9==="CATMaterialToReferenceLink"){var bh=[];bh=a7.textContent.split("urn:3DXML:");var bg=bh[1];bh=bg.split("#");var a1=bh[0];bg=bh[1];be={file:a1,id:bg}}}}}}}}}}}if(be!==null){az.push({occPath:new l(bf),material:X(be.id),visible:null})}}var aT=function(a7){var a2,a4,a1,a6,a5,a3;a2="";a1=a7.length;a4=0;while(a4<a1){a6=a7[a4++];switch(a6>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:a2+=String.fromCharCode(a6);break;case 12:case 13:a5=a7[a4++];a2+=String.fromCharCode(((a6&31)<<6)|(a5&63));break;case 14:a5=a7[a4++];a3=a7[a4++];a2+=String.fromCharCode(((a6&15)<<12)|((a5&63)<<6)|((a3&63)<<0));break}}return a2};var a0=function(a3,a5,be){if(a5&&a3){for(var bf in a5){var a9=a5[bf].errorCallback;var bd=a5[bf].binaryOutput;if(a3[bf]){var a6=a3[bf];if(bd){if(!ao[bf]){ao[bf]=[]}for(var a7=0;a7<be.length;a7++){ao[bf].push({node:be[a7],data:a6})}}else{if(!a6){a9();delete a5[bf];continue}var a4=a6.buffer.subarray(a6.options.offset,a6.options.compressed+a6.options.offset);if(a4.length<=2){a9();delete a5[bf];continue}if(a4[0]!==120){a9();delete a5[bf];continue}if(a4[1]!==218){a9();delete a5[bf];continue}var a1=2;var a2=a4.subarray(a1,a6.options.compressed);var ba=new s();var bc=ba.Inflate(a2);var a8=aT(bc);if(!ao[bf]){ao[bf]=[]}for(var a7=0;a7<be.length;a7++){ao[bf].push({node:be[a7],xml:a8})}}}}}};function aD(){if(aJ){for(var a7=0;a7<az.length;a7++){var bd=az[a7];if((bd!==undefined)&&bd.matrix){var a4=bd.occPath._getOccurrences();if(a4.length){for(var a6=0;a6<a4.length;a6++){a4[a6]._relativeMatrix=bd.matrix}}}}aH&&aH._updateMatrix()}if(W==="3DX"){ar(aO);return}if(aq!==null){for(var a7=0;a7<aI;++a7){aq[a7].terminate()}}aq=null;aK=[];aL=false;var a8="";if(an||(W==="TESSELLATED")){if(aq===null){var a9=!a.matchUrl(e.getWebappsBaseUrl(),window.location)?"Passport":null;var a5=[];var a1={provider:"FILE",filename:"AmdLoader.js",serverurl:e.getWebappsBaseUrl()+"AmdLoader/",requiredAuth:a9};var ba={provider:"FILE",filename:"EasySax.js",serverurl:e.getWebappsBaseUrl()+"EasySax/",requiredAuth:a9};var a3={provider:"FILE",filename:"ThreeJS_Base.js",serverurl:e.getWebappsBaseUrl()+"Mesh/",requiredAuth:a9};var bc={provider:"FILE",filename:"Mesh.js",serverurl:e.getWebappsBaseUrl()+"Mesh/",requiredAuth:a9};var a2={provider:"FILE",filename:"CGRFile.js",serverurl:e.getWebappsBaseUrl()+"Formats/",requiredAuth:a9};if((W==="UVR")||(W==="CGR")){a8={provider:"FILE",filename:"CGRWorkerNewInfra.js",serverurl:e.getWebappsBaseUrl()+"Workers/",requiredAuth:a9};a5=[a1,a3,bc,a2,a8];a5.realWorkerUrl=e.getWebappsBaseUrl()+"Workers/CGRWorkerNewInfra.js"}else{if(W==="TESSELLATED"){a8={provider:"FILE",filename:"XMLV43Worker.js",serverurl:e.getWebappsBaseUrl()+"Workers/",requiredAuth:a9};a5=[a1,ba,a3,bc,a8];a5.realWorkerUrl=e.getWebappsBaseUrl()+"Workers/XMLV43Worker.js"}}g.getWorkerBlobFromSpecs(a5,function(bg){aq=[];var be={processText:aQ,edgeTransparency:ak,sharedBuffers:aC,noMeshInRAM:av,primitiveWithBS:v,withSAG:ac};for(var bf=0;bf<aI;++bf){aq[bf]=new Worker(bg)}for(var bf=0;bf<aI;++bf){(function(bh){aq[bh].onmessage=function(bo){var bm=bo.data;if(bm.loaded){aK.push(bh);if(!aL){aL=true;ar(aO)}}else{var bq=S[bm.node];am--;if(bm.CGR){be.fromCGR=true}t.processData(bq,bm,{materialLibrary:H,baseUrl:aV},ai,be);if(bm.applicativesContainers){a0(bm.applicativesContainers,aw,bq)}if(ax!==null){ax({loaded:L-am,total:L})}var bi=new Date().getTime();if((aM+N<bi)||!am){if(J){J({hack:true,updateInfinitePlane:true})}aM=bi;for(var bn=0;bn<az.length;bn++){var br=az[bn];if(br!==undefined){var bj=br.occPath._getRenderableOccurrences();if(bj.length){for(var bl=0;bl<bj.length;bl++){if(br.material){br.material.force=true;bj[bl]._3dxmlMaterial=br.material;bj[bl].material=br.material}if(br.visible!==null){bj[bl].visible=br.visible;bj[bl]._occurrence.visible=br.visible}}az[bn]=undefined}}}}if(am<=0){if(aq!==null){for(var bn=0;bn<aq.length;++bn){if(aq[bn]!==null){aq[bn].terminate()}}}if(B){B=null}aK=[];aL=false;aq=null;if(aU!==null){var bk=aU;ag();bk();if(aw){for(var bp in aw){if(aw[bp].doneCallback){if(ao&&ao[bp]&&aw[bp].doneCallback){aw[bp].doneCallback(ao[bp])}else{aw[bp].doneCallback([])}}}}}}}}})(bf)}})}else{if(aL){ar(aO)}}}else{if(!B){require(["DS/Formats/CGRFile"],function(be){B=be;ar(aO)},function(bf){var be=bf.requireModules&&bf.requireModules[0];console.log("Module "+be+" is missing.");if(al){al()}})}else{ar(aO)}}}function O(){am--;if(ax){ax({loaded:L-am,total:L})}if(am===0){if(aq!==null){for(var a2=0;a2<aq.length;++a2){if(aq[a2]!==null){aq[a2].terminate()}}aK=[];aL=false;aq=null}if(B){B=null}if(aU){var a1=aU;ag();a1();if(aw){for(var a3 in aw){if(aw[a3].doneCallback){if(ao&&ao[a3]&&aw[a3].doneCallback){aw[a3].doneCallback(ao[a3])}else{aw[a3].doneCallback([])}}}}}}}function ar(a9){am=x.length;L=am;for(var a5=0;a5<x.length;a5++){var a6=x[a5];var a3=a6.file;var a7=a6.format;var a2=a6.node;if(a3!==undefined){var a1=aV+"/"+a3;var a4=a1;if(a3!==""){if(a7==="3DX"){a4+=".3dxc";var a8=S[a3];aZ.load({url:a4,concat:true,zipped:false,primitives:true,reps:true,ssb:false,destinationNodes:a8,readyCallback:function(bd){am--;if(ax!==null){ax({loaded:L-am,total:L})}var bc=new Date().getTime();if((aM+N<bc)||!am){if(J){J({hack:true,updateInfinitePlane:true})}aM=bc}if(am<=0){if(aU!==null){var ba=aU;ag();ba()}}}})}else{if(!an&&B&&(a7==="UVR")){(function(bc,ba){w(a1,"arraybuffer","text/plain",function(bj){var bo={processText:aQ,fromCGR:true,edgeTransparency:ak,sharedBuffers:aC,noMeshInRAM:av,primitiveWithBS:v,withSAG:ac};var be=new Uint8Array(bj);var bd=new B([],false,v,ai,aW,I,ac);bd.setFileBuffer(be);var bl=bd.open();var bm=S[bc];am--;t.processData(bm,bl,{materialLibrary:H,baseUrl:aV},undefined,bo);if(ax!==null){ax({loaded:L-am,total:L})}var bf=new Date().getTime();if((aM+N<bf)||!am){if(J){J({hack:true,updateInfinitePlane:true})}aM=bf;for(var bk=0;bk<az.length;bk++){var bn=az[bk];if(bn!==undefined){var bg=bn.occPath._getRenderableOccurrences();if(bg.length){for(var bi=0;bi<bg.length;bi++){if(bn.material){bn.material.force=true;bg[bi]._3dxmlMaterial=bn.material;bg[bi].material=bn.material}if(bn.visible!==null){bg[bi].visible=bn.visible;bg[bi]._occurrence.visible=bn.visible}}az[bk]=undefined}}}}if(am<=0){if(aq!==null){for(var bk=0;bk<aq.length;++bk){if(aq[bk]!==null){aq[bk].terminate()}}aK=[];aL=false;aq=null}if(B){B=null}if(aU!==null){var bh=aU;ag();bh()}}})})(a3,a5)}else{if(aq){switch(a7){case"UVR":case"CGR":if(a7==="CGR"){a4+=".cgr"}(function(bc,ba){w(a4,"arraybuffer","text/plain",function(be,bd){var bf=aK[ba%aK.length];aq&&aq[bf].postMessage({inputFile:be,node:bc,readDecoration:aj,primitiveWithBS:v,smartStaticBatching:I,withSAG:ac,applicativesContainers:D,withSceneGraph:ai,uint32Index:aW,uvr:true},[be])})})(a3,a5);break;case"TESSELLATED":(function(bc,ba){w(a1,"string","text/plain",function(be,bd){var bf=aK[ba%aK.length];aq&&aq[bf].postMessage({path:be,node:bc,uint32Index:aW})})})(a3,a5);break;default:if(p[a7]){(function(ba,bd,bc){w(a1,"xml","text/xml",function(bg,be){var bf=p[bd].module+"/"+p[bd].file;require([bf],function(bh){var bi=new bh();bi.unstream(bg,ba,bc);O()},function(bi){var bh=bi.requireModules&&bi.requireModules[0];console.log("Module "+bh+" is missing.");var bj=al||aE;O();if(bj){bj({url:be,type:"REPFORMAT"})}})},function(be){var bf=al||aE;O();if(bf){bf({url:be,type:"REPFORMAT"})}})})(a3,a7,a2)}else{O()}break}}else{O()}}}}}}if(a9){if(aH===null){aH=new h()}a9(aH)}}function Y(a2){var a4=[];var a3=new RegExp(/\[([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?)),([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?)),([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?))\]/);var a1=a3.exec(a2);if(a1!==null){a4[0]=parseFloat(RegExp.$1);a4[1]=parseFloat(RegExp.$2);a4[2]=parseFloat(RegExp.$3)}else{a3=new RegExp(/\[([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?)),([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?)),([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?)),([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?))\]/);a1=a3.exec(a2);if(a1!==null){a4[0]=parseFloat(RegExp.$1);a4[1]=parseFloat(RegExp.$2);a4[2]=parseFloat(RegExp.$3);a4[3]=parseFloat(RegExp.$4)}}return a4}function X(a5){var a4=new b();var a1=H[a5];if(a1===undefined){return null}var a2=H[a1.instance];if(a2===undefined){return null}var a3=H[a2.instance];if(a3===undefined){return null}if((a3.material===undefined)&&(a3.params!==undefined)){a3.material=a4.getMaterial3DXML(a3.params,aV,"XMLV43");a3.material.force=true}else{if(a3.params===undefined){a3.material=new r.MeshLambertMaterial();a3.material.force=true}}return a3.material}function ad(bf,a9,bi){var a1=null;var a8=[];var a7=null;var bo=null;var bp=new r.Sphere();var a2=new r.Box3();var bc=new b();bc.cleanResources();var bn;for(var bm=0;bm<bf.length;bm++){var a3=bf[bm];var ba=new r.BufferGeometryDS();var bh=new r.Vector3(a3.AABB.min[0],a3.AABB.min[1],a3.AABB.min[2]);var bl=new r.Vector3(a3.AABB.max[0],a3.AABB.max[1],a3.AABB.max[2]);if(a7===null){a7=bh}if(bo===null){bo=bl}if(bh.x<a7.x){a7.x=bh.x}if(bh.y<a7.y){a7.y=bh.y}if(bh.z<a7.z){a7.z=bh.z}if(bl.x>bo.x){bo.x=bl.x}if(bl.y>bo.y){bo.y=bl.y}if(bl.z>bo.z){bo.z=bl.z}a2.set(a7,bo);bp.radius=bo.clone().sub(a7).multiplyScalar(0.5).length();bp.center=bo.clone().add(a7).multiplyScalar(0.5);var a5=null;var be=null;for(var bk=0;bk<a3.drawingGroups.length;bk++){a3.drawingGroups[bk].geometry=ba;var bg=a3.drawingGroups[bk].gas;var bd=a3.drawingGroups[bk].material;if((bd!==null)&&(bd.file!=="")){a3.drawingGroups[bk].material=X(bd.id)}else{if((bd!==null)&&bd.id!==-1){if(ab[bd.id]!==null&&ab[bd.id]!==undefined){bn=ab[bd.id]}else{bn=bc.getMaterialCgr(a9[bd.id],undefined,"CGR",bi);ab[bd.id]=bn}a3.drawingGroups[bk].material=bn}}if(bg!==null){var bj=new r.Color();bj.setRGB(bg.color.r,bg.color.g,bg.color.b);a3.drawingGroups[bk].gas=bc.getMaterialFromGAS({color:bj,opacity:bg.opacity,linewidth:bg.linewidth,solid:bg.solid,symbol:bg.symbol,basic:bg.basic})}}ba.drawingGroups=a3.drawingGroups;ba.vertexPositionArray=a3.vertexPositionArray;if(a3.vertexNormalArray!==null){ba.vertexNormalArray=a3.vertexNormalArray}if(a3.vertexUvArray!==null){ba.vertexUvArray=a3.vertexUvArray}ba.vertexIndexArray=a3.vertexIndexArray;a8.push(ba)}var a6=new r.Color();a6.setRGB(bf[0].gas.fill.color.r,bf[0].gas.fill.color.g,bf[0].gas.fill.color.b);var a4=new r.Color();a4.setRGB(bf[0].gas.line.color.r,bf[0].gas.line.color.g,bf[0].gas.line.color.b);var bd=bc.getMaterialFromGAS({color:a6,opacity:bf[0].gas.fill.opacity,solid:bf[0].gas.fill.solid,basic:bf[0].gas.fill.basic});bd.line=bc.getMaterialFromGAS({color:a4,opacity:bf[0].gas.line.opacity,linewidth:bf[0].gas.line.linewidth});a8.boundingSphere=bp;a8.boundingBox=a2;a1=new r.Mesh(a8,bd);a1.matrixAutoUpdate=false;a1.castShadow=true;a1.receiveShadow=true;return new c(a1)}function aB(){var a2=new r.BufferGeometryDS();a2.boundingSphere=new r.Sphere();a2.boundingBox=new r.Box3();var a1=new r.MeshPhongMaterial();var a3=new r.Mesh(a2,a1);a3.matrixAutoUpdate=false;if(r.REVISION==="48"){a3.doubleSided=true}a3.castShadow=true;a3.receiveShadow=true;return new c(a3)}function V(a1,a2){if(a1.color===null||a2.color===null){return false}if((a1.color.r!==a2.color.r)||(a1.color.g!==a2.color.g)||(a1.color.b!==a2.color.b)){return false}if(a1.thickness&&a2.thickness&&(a1.thickness!==a2.thickness)){return false}if(a1.opacity!==a2.opacity){return false}return true}function y(a5){var a2=Q(a5);var a4=[];for(var a3=0,a1=a2.length;a3<a1;a3++){a4.push(parseFloat(a2[a3]))}return a4}function Q(a1){return(a1.length>0)?G(a1).split(/\s+/):[]}function G(a1){return a1.replace(/^\s+/,"").replace(/\s+$/,"")}};return o});define("DS/Visualization/XMLV43Loader",["DS/VisuLoaders/XMLV43Loader"],function(a){return a});define("Visualization/XMLV43Loader",["DS/Visualization/XMLV43Loader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/XMLV43Loader");return b});