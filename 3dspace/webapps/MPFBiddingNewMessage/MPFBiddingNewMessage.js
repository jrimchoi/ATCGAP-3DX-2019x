define("DS/MPFBiddingNewMessage/BiddingCartHelper",["DS/MPFCartModel/CartPatchOperation","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel"],function(a,c,d){var b;b={getSubmittedStateCartOperation:function(g,h,f){var e={currentState:c.States.SUBMITTED,ShopID:g};if(h){e.ShipTo=f}return new a(a.Operations.modify,"/",e)},getDeliveryRequestItemOperation:function(g,e,f){return new a(a.Operations.add,"/cart-items/",{"@type":"MP_DeliveryServiceRequest",CartID:g,currentState:d.STATUS.submitted,Quantity:1,ShopID:f,DeliveryServiceName:e?"Shipping":"Pickup"})},getModifyCartItemAttributesOperation:function(e){return new a(a.Operations.modify,"/cart-items/"+e.get("id"),e.getPendingChanges())},getSubmittedStateCartItemOperation:function(f){if(f.hasPendingChanges()){var e;e=f.getPendingChanges();e.currentState=d.STATUS.submitted;return new a(a.Operations.modify,"/cart-items/"+f.get("id"),e)}else{return new a(a.Operations.modify,"/cart-items/"+f.get("id"),{currentState:d.STATUS.submitted})}},getDeliveredStateCartItemOperation:function(f){if(f.hasPendingChanges()){var e;e=f.getPendingChanges();e.currentState=d.STATUS.delivered;return new a(a.Operations.modify,"/cart-items/"+f.get("id"),e)}else{return new a(a.Operations.modify,"/cart-items/"+f.get("id"),{currentState:d.STATUS.delivered})}},getReadyStateCartItemOperation:function(f){if(f.hasPendingChanges()){var e;e=f.getPendingChanges();e.currentState=d.STATUS.ready;return new a(a.Operations.modify,"/cart-items/"+f.get("id"),e)}else{return new a(a.Operations.modify,"/cart-items/"+f.get("id"),{currentState:d.STATUS.ready})}},getShippedStateCartItemOperation:function(f){if(f.hasPendingChanges()){var e;e=f.getPendingChanges();e.currentState=d.STATUS.shipped;return new a(a.Operations.modify,"/cart-items/"+f.get("id"),e)}else{return new a(a.Operations.modify,"/cart-items/"+f.get("id"),{currentState:d.STATUS.shipped})}},getProcessingStateCartItemOperation:function(f){if(f.hasPendingChanges()){var e;e=f.getPendingChanges();e.currentState=d.STATUS.processing;return new a(a.Operations.modify,"/cart-items/"+f.get("id"),e)}else{return new a(a.Operations.modify,"/cart-items/"+f.get("id"),{currentState:d.STATUS.processing})}},getAcceptedStateCartItemOperation:function(f){if(f.hasPendingChanges()){var e;e=f.getPendingChanges();e.currentState=d.STATUS.accepted;return new a(a.Operations.modify,"/cart-items/"+f.get("id"),e)}else{return new a(a.Operations.modify,"/cart-items/"+f.get("id"),{currentState:d.STATUS.accepted})}},getAddContractOperation:function(e,f){return new a(a.Operations.add,"/contracts",{ContractID:e,CartItemID:f})},getCancelRequestOperation:function(){return new a(a.Operations.modify,"/",{currentState:c.States.CANCELLED})},getAddBiddingDocOperation:function(f,e){return new a(a.Operations.add,"/bidding-documents",{CartItemID:f,DocumentID:e})},getAddMessageOperation:function(h,g,e,f){return new a(a.Operations.add,"/message",{author:h?"mdpeoplecompany/people/"+f.getOwnerId():"/mdshop/shops/"+f.getShopID(),documentIDs:g,message:e})}};return b});define("DS/MPFBiddingNewMessage/BiddingAddress",["UWA/Core","UWA/String","UWA/Class/View","DS/UIKIT/Input/Button","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFCartModel/CartModel","DS/MPFModelFactory/CartFactory","DS/MPFModelFactory/CartItemFactory","DS/MPFModelFactory/CompanyFactory","DS/MPFModelFactory/AddressFactory","DS/MPFCompanyModel/CompanyModel","DS/MPFPersonModel/PersonModel","DS/MPFAddressModel/AddressCollection","DS/MPFBuyerAddressComponent/BuyerAddressBook","DS/MPFFiniteStateMachine/FiniteStateMachine","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(o,l,e,j,p,m,s,n,h,i,f,c,r,q,b,a,k){var d={};d.PICK_UP="pickUp";d.SHIPPING_NO_ADDRESS="shippingNoAddress";d.SHIPPING_ADDRESS_SELECTED="shippingAddressSelected";var g=e.extend({className:"mpf-bidding-address",setup:function(t){t||(t={});this._checkPrototypes(t);this.buyerType=t.buyerType;this.addresses=t.addresses;this.addressFactory=t.addressFactory;this.companyFactory=t.companyFactory;this.cartFactory=t.cartFactory;this.cartItemFactory=t.cartItemFactory;this.me=t.me;this.company=t.company;this.cart=t.cart;this.stateMachine=this._createStateMachine();this.buyerAddressBook=this._initBuyerAddressBook();this.listenTo(this.buyerAddressBook,"onSelected",this._addressSelected.bind(this));this.addAddressButton=this._createButton(k.get("addAddress"));this.changeAddressButton=this._createButton(k.get("changeAddress"))},render:function(){var t=this.stateMachine.getState();if(t===d.SHIPPING_NO_ADDRESS){this.container.setContent([this.addAddressButton,this.buyerAddressBook.render()])}else{if(t===d.SHIPPING_ADDRESS_SELECTED){this._displayAddressLabel()}else{this.container.setContent("")}}return this},manageAddressChoices:function(t){if(t){if(o.is(this.buyerAddressBook.getSelectedAddress())){this.stateMachine.changeState(d.SHIPPING_ADDRESS_SELECTED)}else{this.stateMachine.changeState(d.SHIPPING_NO_ADDRESS)}}else{this.stateMachine.changeState(d.PICK_UP)}this.render()},getSelectedAddress:function(){return this.buyerAddressBook.getSelectedAddress()},_initBuyerAddressBook:function(){return new b({model:this.addresses,me:this.me,buyer:this.buyerType===m.COMPANY?this.company:this.me,addressFactory:this.addressFactory,companyFactory:this.companyFactory,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory})},_createButton:function(u){var t=this;return new j({className:"link",value:u,events:{onClick:function(){t.buyerAddressBook.show()}}})},_addressSelected:function(t){if(t.ok){this.stateMachine.changeState(d.SHIPPING_ADDRESS_SELECTED);this.render()}},_displayAddressLabel:function(){var t;t=o.createElement("div",{"class":"mpf-bidding-address-selected",html:[o.createElement("span",{text:k.get("shipTo")}),this._getAddressTitle(this.buyerAddressBook.getSelectedAddress()),this.changeAddressButton]});this.container.setContent([t,this.buyerAddressBook.render()])},_getAddressTitle:function(t){var u="";["addressLine1","addressLine2","addressLine3","addressLine4","city","county","state","postalCode","country"].map(function(v){return t.get(v)}).filter(function(v){return v&&v.length>0}).map(function(v){u=u+" "+v+",";return u});return l.truncate(u,u.length-1,"")},_createStateMachine:function(){return new a({state:d.SHIPPING_NO_ADDRESS,states:[d.PICK_UP,d.SHIPPING_NO_ADDRESS,d.SHIPPING_ADDRESS_SELECTED],transitions:[{from:d.PICK_UP,to:d.SHIPPING_NO_ADDRESS},{from:d.PICK_UP,to:d.SHIPPING_ADDRESS_SELECTED},{from:d.SHIPPING_NO_ADDRESS,to:d.PICK_UP},{from:d.SHIPPING_NO_ADDRESS,to:d.SHIPPING_ADDRESS_SELECTED},{from:d.SHIPPING_ADDRESS_SELECTED,to:d.PICK_UP}]})},_checkPrototypes:function(t){p.requiredOfPrototype(t.me,r,"options.me must be a PersonModel");p.requiredOfPrototype(t.cart,s,"options.cart must be a CartModel");p.requiredOfPrototype(t.companyFactory,i,"options.companyFactory must be a CompanyFactory");p.requiredOfPrototype(t.addressFactory,f,"options.addressFactory must be an AddressFactory");p.requiredOfPrototype(t.cartItemFactory,h,"options.cartItemFactory must be a CartItemFactory");p.requiredOfPrototype(t.cartFactory,n,"options.cartFactory must be a CartFactory");if(this.buyerView){p.requiredOfPrototype(t.addresses,q,"options.addresses must be an AddressCollection")}if(this.buyerView&&this.buyerType===m.COMPANY){p.requiredOfPrototype(t.company,c,"options.company must be a CompanyModel")}}});return g});define("DS/MPFBiddingNewMessage/BiddingActions",[],function(){var a=Object.freeze({ACCEPT:"accept",SEND_MESSAGE:"message",CANCEL:"cancel",NOTIFY_WORK_STARTED:"workStarted",NOTIFY_READY:"ready",PAY:"pay",VALIDATE_PHASE:"validate"});return a});define("DS/MPFBiddingNewMessage/BiddingDeliveryMethod",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Toggle","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(g,f,e,b,c,a){var d=f.extend({className:"mpf-bidding-delivery-method",setup:function(h){h||(h={});b.requiredOfPrototype(h.cart,c,"options.cart must be a CartModel");this.cart=h.cart;this.shippingRadio=this._createShippingRadio();this.pickUpRadio=this._createPickUpRadio()},render:function(){if(this.cart.getState()===c.States.DRAFT){this.container.setContent([a.get("delivery"),this.pickUpRadio,this.shippingRadio])}else{this.container.setContent("")}return this},isShippingSelected:function(){return this.shippingRadio.isChecked()},_createShippingRadio:function(){var h=this;return new e({checked:true,type:"radio",value:a.get("shipping"),className:"primary",events:{onChange:function(){if(this.isChecked()){h.pickUpRadio.setCheck(false);h.dispatchEvent("deliveryMethodChanged",h.shippingRadio.isChecked())}}}})},_createPickUpRadio:function(){var h=this;return new e({type:"radio",value:a.get("pickUp"),className:"primary",events:{onChange:function(){if(this.isChecked()){h.shippingRadio.setCheck(false);h.dispatchEvent("deliveryMethodChanged",h.shippingRadio.isChecked())}}}})}});return d});define("DS/MPFBiddingNewMessage/BiddingUploadFileComponent",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Select","DS/UIKIT/Input/File","DS/MPFServices/ObjectService","DS/MPFView/GuidanceHelper","DS/MPFModelFactory/TCDocumentFactory","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(i,c,a,j,k,g,d,e,f,h){var b=c.extend({tagName:"div",className:"mpf-bidding-upload-files",setup:function(l){l||(l={});k.requiredOfPrototype(l.tcDocumentFactory,d,"options.tcDocumentFactory must be a TCDocumentFactory");k.requiredOfPrototype(l.cart,e,"options.cart must be a CartModel");k.requiredOfPrototype(l.cartItem,f,"options.cartItem must be a CartItemModel");this.buyerView=l.buyerView===true;this.tcDocumentFactory=l.tcDocumentFactory;this.cart=l.cart;this.cartItem=l.cartItem;this.inputDocument=this._createInputDocument();this.selectTypeDocument=this._createSelectTypeDocument();this.infoIcon=this._createInfoGuidanceHelper()},render:function(){this.container.setContent([this.selectTypeDocument,this.infoIcon]);return this},_createInfoGuidanceHelper:function(){if(this.buyerView&&this._isBuyerAllowedToUploadNDA()){return new g({position:"right",content:h.get("uploadFileDetailsBuyer")})}else{if(!this.buyerView&&this._isSellerAllowedToUploadSalesConditions()){return new g({position:"right",content:h.get("uploadFileDetailsSeller")})}}},_createInputDocument:function(){var l=this;return new j({events:{onChange:function(n){var o;var m;var p=l.selectTypeDocument.getValue()[0];m=n.target.files[0];l.selectTypeDocument.clear(true);if(p==="NDA"){o=l.tcDocumentFactory.createModel("new-NDA")}if(p==="salesConditions"){o=l.tcDocumentFactory.createModel("new-CustomTCSellers")}if(p==="other"){o=l.tcDocumentFactory.createModel("cart-bidding")}o.saveDocument({file:m}).then(function(q){l.dispatchEvent("docSaved",{docName:m.name,docID:o.get("documentID")||Object.keys(o.get("documentIDs"))[0],docType:p})})}}})},_createSelectTypeDocument:function(){var l=this;return new a({className:"mpf-type-doc",placeholder:h.get("attachDoc"),options:this._getDocTypeOptions(),events:{onChange:function(){l.inputDocument.elements.input.click()}}})},_getDocTypeOptions:function(){var l=[{value:"other",label:h.get("otherDoc")}];if(this.buyerView&&this._isBuyerAllowedToUploadNDA()){l.push({value:"NDA",label:h.get("nda")})}else{if(!this.buyerView&&this._isSellerAllowedToUploadSalesConditions()){l.push({value:"salesConditions",label:h.get("salesConditions")})}}return l},_isSellerAllowedToUploadSalesConditions:function(){var l;var m;l=this.cart.getState()===e.States.SUBMITTED;m=this.cartItem.getState()===f.STATUS.submitted||this.cartItem.getState()===f.STATUS.accepted;return l&&m},_isBuyerAllowedToUploadNDA:function(){var l;var m;l=this.cart.getState()===e.States.DRAFT||this.cart.getState()===e.States.SUBMITTED;m=this.cartItem.getState()===f.STATUS.draft||this.cartItem.getState()===f.STATUS.submitted;return l&&m}});return b});define("DS/MPFBiddingNewMessage/EngineeringBiddingOptions",["DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFBiddingNewMessage/BiddingActions","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,g,b,c){var f;var a={};var d={};a[e.States.SUBMITTED]={};a[e.States.PAYMENT_ACCEPTED]={};a[e.States.PROCESSING]={};a[e.States.DELIVERED]={};a[e.States.SUBMITTED][g.STATUS.submitted]=[{value:b.ACCEPT,text:c.get("proposeSchedule"),icon:"check"},{value:b.SEND_MESSAGE,text:c.get("askForInformation"),icon:"question-circle"},{value:b.CANCEL,text:c.get("rejectRequest"),icon:"close"}];a[e.States.SUBMITTED][g.STATUS.accepted]=[{value:b.SEND_MESSAGE,text:c.get("askForInformation"),icon:"question-circle"},{value:b.CANCEL,text:c.get("rejectRequest"),icon:"close"}];a[e.States.PAYMENT_ACCEPTED][g.STATUS.pendingProcessing]=[{value:b.NOTIFY_WORK_STARTED,text:c.get("workStarted"),icon:"play"},{value:b.SEND_MESSAGE,text:c.get("askForInformation"),icon:"question-circle"}];a[e.States.PROCESSING][g.STATUS.processing]=[{value:b.NOTIFY_READY,text:c.get("notifyReadiness"),icon:"check"},{value:b.SEND_MESSAGE,text:c.get("askForInformation"),icon:"question-circle"}];d[e.States.DRAFT]={};d[e.States.SUBMITTED]={};d[e.States.PAYMENT_ACCEPTED]={};d[e.States.PROCESSING]={};d[e.States.DELIVERED]={};d[e.States.SUBMITTED][g.STATUS.submitted]=[{value:b.SEND_MESSAGE,text:c.get("askForInformation"),icon:"question-circle"},{value:b.CANCEL,text:c.get("cancelRequest"),icon:"close"}];d[e.States.SUBMITTED][g.STATUS.accepted]=[{value:b.PAY,text:c.get("confirmAndPay"),icon:"credit-card"},{value:b.SEND_MESSAGE,text:c.get("askForInformation"),icon:"question-circle"},{value:b.CANCEL,text:c.get("cancelRequest"),icon:"close"}];f={buyerOptionsCart:d,sellerOptionsCart:a};return f});define("DS/MPFBiddingNewMessage/BiddingMessageContent",["UWA/Core","UWA/Promise","UWA/Class/View","DS/UIKIT/Input/Text","DS/UIKIT/Badge","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFShopModel/ShopModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemCollection","DS/MPFModelFactory/CartFactory","DS/MPFModelFactory/CartItemFactory","DS/MPFModelFactory/TCContractFactory","DS/MPFModelFactory/CompanyFactory","DS/MPFModelFactory/AddressFactory","DS/MPFCompanyModel/CompanyModel","DS/MPFAddressModel/AddressCollection","DS/MPFModalConfiguratorComponent/CheckoutLauncherFactory","DS/MPFCompanyModel/CompanyHelper","DS/MPFBiddingNewMessage/BiddingCartHelper","DS/MPFBiddingNewMessage/BiddingAddress","DS/MPFBiddingNewMessage/BiddingActions","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(r,a,e,i,t,u,c,o,y,m,z,v,p,h,w,j,f,b,x,l,n,d,g,q,k){var s=e.extend({className:"mpf-bidding-message-content",setup:function(A){A||(A={});this._checkPrototypes(A);this.buyerView=A.buyerView===true;this.isDeliveryActive=A.isDeliveryActive===true;this.buyerType=A.buyerType;this.me=A.me;this.company=A.company;this.shop=A.shop;this.cart=A.cart;this.cartItems=A.cartItems;this.cartFactory=A.cartFactory;this.cartItemFactory=A.cartItemFactory;this.tcContractFactory=A.tcContractFactory;this.addressFactory=A.addressFactory;this.companyFactory=A.companyFactory;this.addresses=A.addresses;this.request=this.cartItems.find(function(B){return B.getType()==="MP3DP_PrintRequest"||B.getType()==="MPENG_EngineeringItem"});this.textInput=this._createTextInput();this.fileListContainer=this._createFileListContainer();this.annotationListContainer=this._createAnnotationListContainer();this.uploadedFiles=[];if(this.cart.getState()===z.States.DRAFT&&this.isDeliveryActive){this.isShipping=true;this.biddingAddressComponent=new g({buyerView:this.buyerView,buyerType:this.buyerType,me:this.me,company:this.company,addresses:this.addresses,cart:this.cart,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory,companyFactory:this.companyFactory,addressFactory:this.addressFactory})}},render:function(){var A=[];if(r.is(this.biddingAddressComponent)){A.push(this.biddingAddressComponent.render())}Array.prototype.push.apply(A,[this.textInput,this.fileListContainer,this.annotationListContainer]);this.container.setContent(A);return this},getCartPatchOperations:function(F){var E=this;var G=[];var D;var A=[];var B;var C;if(this.buyerView){B=this.uploadedFiles.filter(function(H){return H.docType==="NDA"})}else{B=this.uploadedFiles.filter(function(H){return H.docType==="salesConditions"})}D=this.uploadedFiles.filter(function(H){return H.docType==="other"});if(F===""&&this.cart.getState()===z.States.DRAFT){G.push(d.getSubmittedStateCartOperation(this.cart.getShopID(),this.isDeliveryActive,this.isShipping?this.biddingAddressComponent.getSelectedAddress().get("id"):""));if(this.isDeliveryActive){G.push(d.getDeliveryRequestItemOperation(this.cart.get("id"),this.isShipping,this.cart.getShopID()))}G.push(d.getSubmittedStateCartItemOperation(this.request))}if(F===q.ACCEPT){G.push(d.getAcceptedStateCartItemOperation(this.request))}if(F===q.CANCEL){G.push(d.getCancelRequestOperation())}if(F===q.NOTIFY_WORK_STARTED){this.cartItems.forEach(function(H){G.push(d.getProcessingStateCartItemOperation(H))})}if(F===q.NOTIFY_READY){this.cartItems.forEach(function(H){G.push(d.getReadyStateCartItemOperation(H))})}if(F===q.PAY){C=new l({serviceRequest:c.ENGINEERING,service:"3DPrint",idCart:this.cart.get("id")});C.whenReady().then(function(){C.show()})}D.forEach(function(H){A.push(H.docID);G.push(d.getAddBiddingDocOperation(E.request.get("id"),H.docID))});G.push(d.getAddMessageOperation(this.buyerView,A,this.textInput.getValue(),this.cart));return this._saveContract(B).then(function(H){if(r.is(H)){G.push(d.getAddContractOperation(H.get("id"),E.request.get("id")))}return G})},_saveContract:function(B){var D;var C;var A;if(r.is(B)&&B.length>0){D=B[0];if(D.docType==="NDA"){A={consumerID:this.shop.getOwner(),documentID:D.docID,supplierID:this.buyerType===o.COMPANY?this.company.get("id"):this.me.get("id")}}if(D.docType==="salesConditions"){A={consumerID:this.cart.getOwnerId(),documentID:D.docID,supplierID:n.getIdFromUrl(this.me.get("company"))}}C=this.tcContractFactory.createModel("existing-document",A);return C.savePromise()}else{return a.resolve()}},displayAddressChoices:function(A,B){this.isShipping=A;this.biddingAddressComponent.manageAddressChoices(A)},displayBadge:function(B){var C=this;var A;if(B.docType==="NDA"||B.docType==="salesConditions"){this._keepOnlyOneCopy(B.docType)}A=new t({closable:true,content:B.docName,icon:"doc",events:{onClose:function(){C._deleteFile(B.docName);this.destroy()}}});this.fileListContainer.addContent(A);this.uploadedFiles.push(B)},_keepOnlyOneCopy:function(D){var B;var A;var C;B=this.uploadedFiles.filter(function(E){return E.docType===D});if(B.length>0){B=B[0];A=this.container.getElements("span.badge-content");C=A.filter(function(E){return E.getText()===B.docName});C[0].getParent().outerHTML=""}},_deleteFile:function(A){this.uploadedFiles=this.uploadedFiles.filter(function(B){return B.docName!==A})},_createFileListContainer:function(){return r.createElement("div",{"class":"mpf-file-list"})},_createAnnotationListContainer:function(){return r.createElement("div",{"class":"mpf-annotation-list"})},_createTextInput:function(){return new i({placeholder:k.get("typeMessage"),rows:4,multiline:true})},_checkPrototypes:function(A){u.requiredOfPrototype(A.me,y,"options.me must be a PersonModel");u.requiredOfPrototype(A.shop,m,"options.shop must be a ShopModel");u.requiredOfPrototype(A.cart,z,"options.cart must be a CartModel");u.requiredOfPrototype(A.cartItems,v,"options.cartItems must be a CartItemCollection");u.requiredOfPrototype(A.tcContractFactory,w,"options.tcContractFactory must be a TCContractFactory");u.requiredOfPrototype(A.companyFactory,j,"options.companyFactory must be a CompanyFactory");u.requiredOfPrototype(A.addressFactory,f,"options.addressFactory must be an AddressFactory");u.requiredOfPrototype(A.cartItemFactory,h,"options.cartItemFactory must be a CartItemFactory");u.requiredOfPrototype(A.cartFactory,p,"options.cartFactory must be a CartFactory");if(this.buyerView){u.requiredOfPrototype(A.addresses,x,"options.addresses must be an AddressCollection")}if(this.buyerView&&this.buyerType===o.COMPANY){u.requiredOfPrototype(A.company,b,"options.company must be a CompanyModel")}}});return s});define("DS/MPFBiddingNewMessage/ButtonsOptions",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Button","DS/MPFServices/ObjectService","DS/MPFBiddingNewMessage/EngineeringBiddingOptions","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFUtils/MPFUtils","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(f,a,h,g,j,b,c,d,e){var i=a.extend({className:"mpf-bidding-options-container",setup:function(k){k||(k={});g.requiredOfPrototype(k.cart,b,"options.cart must be a CartModel");g.requiredOfPrototype(k.cartItem,c,"options.cartItem must be a CartItemModel");this.buyerView=k.buyerView===true;this.cart=k.cart;this.cartItem=k.cartItem;this.buttons=this._createButtonsOptions()},render:function(){if(f.is(this.buttons)){this.container.setContent([this.buttons])}return this},getActionButton:function(k){return d.findInArray(this.buttons,function(l){return l.getName()===k})},_createButtonsOptions:function(){var n=this;var k;var m=[];var l;if(this.buyerView){k=j.buyerOptionsCart[this.cart.getState()][this.cartItem.getState()]}else{k=j.sellerOptionsCart[this.cart.getState()][this.cartItem.getState()]}if(f.is(k)&&k.length>0){k.forEach(function(o){l=new h({icon:o.icon,value:o.text,name:o.value,events:{onClick:function(){n.dispatchEvent("optionSelected",o)}}});m.push(l)});return m}}});return i});define("DS/MPFBiddingNewMessage/BiddingNewMessage",["UWA/Core","UWA/Promise","UWA/Class/View","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFShopModel/ShopModel","DS/MPFCompanyModel/CompanyModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFCartModel/CartItemCollection","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","DS/MPFModelFactory/CartFactory","DS/MPFModelFactory/CartItemFactory","DS/MPFModelFactory/CompanyFactory","DS/MPFModelFactory/AddressFactory","DS/MPFModelFactory/TCDocumentFactory","DS/MPFModelFactory/TCContractFactory","DS/MPFAddressModel/AddressCollection","DS/MPFBiddingNewMessage/ButtonsOptions","DS/MPFBiddingNewMessage/BiddingDeliveryMethod","DS/MPFBiddingNewMessage/BiddingUploadFileComponent","DS/MPFBiddingNewMessage/BiddingMessageContent","DS/MPFUtils/MPFUtils","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage","css!DS/MPFBiddingNewMessage/MPFBiddingNewMessage"],function(q,b,g,m,y,t,o,B,n,c,C,u,v,i,d,p,j,k,h,a,w,A,z,s,f,r,x,l){var e=g.extend({tagName:"div",className:"mpf-bidding-new-message",setup:function(D){D||(D={});this._checkPrototypes(D);this.isDeliveryActive=D.isDeliveryActive===true;this.buyerView=D.buyerView===true;this.buyerType=D.buyerType;this.cartFactory=D.cartFactory;this.cartItemFactory=D.cartItemFactory;this.addressFactory=D.addressFactory;this.companyFactory=D.companyFactory;this.tcDocumentFactory=D.tcDocumentFactory;this.tcContractFactory=D.tcContractFactory;this.cart=D.cart;this.cartItems=D.cartItems;this.me=D.me;this.company=D.company;this.shop=D.shop;this.addresses=D.addresses;this.onMenuRefresh=D.onMenuRefresh||x.doNothing;this.validateSend=D.validateSend||x.alwaysTrue;this.buyerTermsOfUseComponent=D.buyerTermsOfUseComponent;this.request=this.cartItems.find(function(E){return E.getType()==="MP3DP_PrintRequest"||E.getType()==="MPENG_EngineeringItem"});this.request.changeTracker.reset();this.sendButton=this._createSendButton();this.messageLabelContainer=this._createMessageLabelContainer();this.biddingDeliveryMethodComponent=this._createBiddingDeliveryMethodComponent();this.messageContentComponent=this._createBiddingMessageComponent();this.uploadFileComponent=this._createUploadFileComponent();this.optionsMenu=this._createOptionsMenuComponent();this._initListeners()},render:function(){var D;D=[this.optionsMenu.render()];if(this.isDeliveryActive){D.push(this.biddingDeliveryMethodComponent.render())}Array.prototype.push.apply(D,[this.messageLabelContainer,this.messageContentComponent.render(),this.uploadFileComponent.render(),this.sendButton]);if(q.is(this.buyerTermsOfUseComponent)){D.push(this.buyerTermsOfUseComponent.render())}this.container.setContent(D);if(q.is(this.optionsMenu.buttons)){this.messageLabelContainer.hide();this.messageContentComponent.hide();this.uploadFileComponent.hide();this.sendButton.hide()}return this},getCartItems:function(){return this.cartItems},_sendMessage:function(){var F=this;var G;var E=new i();var D=q.is(this.selectedOption)?this.selectedOption.value:"";G=this.validateSend({action:D,cart:this.cart,cartItems:this.cartItems});if(G){y.mask(this.container);return this._saveBuyerTCs().then(this.messageContentComponent.getCartPatchOperations.bind(this.messageContentComponent,D)).then(function(H){E.addAll(H);return F.cart.megaPatch(E)}).then(this._refresh.bind(this)).then(this._patchToDeliveryStateIfReady.bind(this))["finally"](function(){y.unmask(F.container)})}},_saveBuyerTCs:function(){if(q.is(this.buyerTermsOfUseComponent)){if(this.buyerTermsOfUseComponent.isChecked()){return this.buyerTermsOfUseComponent.createContract()}else{return b.reject("TCs must be signed")}}else{return b.resolve()}},_patchToDeliveryStateIfReady:function(){var D=new i();if(this.cart.getState()===C.States.PROCESSING&&this.request.getState()===u.States.ready){D.add(new d(d.Operations.modify,"/cart-items/"+this.request.get("id"),{currentState:u.STATUS.delivered}));return this.cart.megaPatch(D).then(this._refresh.bind(this))}else{return b.resolve()}},_refresh:function(){this.cartItems=this.cartItemFactory.createCollection("",this.cart.getItems());this.cartItems.setParentResourceId(this.cart.get("id"));this.request=this.cartItems.find(function(D){return D.getType()==="MP3DP_PrintRequest"||D.getType()==="MPENG_EngineeringItem"});this.request.changeTracker.reset();this.sendButton=this._createSendButton();this.messageLabelContainer=this._createMessageLabelContainer();this.biddingDeliveryMethodComponent=this._createBiddingDeliveryMethodComponent();this.messageContentComponent=this._createBiddingMessageComponent();this.uploadFileComponent=this._createUploadFileComponent();this.optionsMenu=this._createOptionsMenuComponent();this._initListeners();this.render()},_onNewOptionSelected:function(D){this.selectedOption=D;this.sendButton.setValue(D.value==="message"?l.get("send"):D.text);this.messageLabelContainer.show();this.messageContentComponent.show();this.uploadFileComponent.show();this.sendButton.show();this.dispatchEvent("optionSelected",D.value)},_createMessageLabelContainer:function(){return q.createElement("div",{"class":"mpf-label-message",text:l.get("message")})},_createSendButton:function(){return new m({className:"primary mpf-send-button",disabled:q.is(this.buyerTermsOfUseComponent),value:this.cart.getState()===C.States.DRAFT?l.get("sendForQuote"):l.get("send"),events:{onClick:this._sendMessage.bind(this)}})},_initListeners:function(){var D=this;if(this.isDeliveryActive){this.listenTo(this.biddingDeliveryMethodComponent,"deliveryMethodChanged",this.messageContentComponent.displayAddressChoices.bind(this.messageContentComponent))}this.listenTo(this.uploadFileComponent,"docSaved",this.messageContentComponent.displayBadge.bind(this.messageContentComponent));this.listenTo(this.optionsMenu,"optionSelected",this._onNewOptionSelected.bind(this));if(q.is(this.buyerTermsOfUseComponent)){this.listenTo(this.buyerTermsOfUseComponent.checkbox,"valueChanged",function(){D.sendButton.setDisabled(!D.buyerTermsOfUseComponent.isChecked())})}},_createOptionsMenuComponent:function(){var D;D=new z({buyerView:this.buyerView,cart:this.cart,cartItem:this.request});this.onMenuRefresh(D);return D},_createUploadFileComponent:function(){return new f({buyerView:this.buyerView,tcDocumentFactory:this.tcDocumentFactory,cart:this.cart,cartItem:this.request})},_createBiddingMessageComponent:function(){return new r({buyerView:this.buyerView,buyerType:this.buyerType,isDeliveryActive:this.isDeliveryActive,me:this.me,company:this.company,shop:this.shop,cart:this.cart,cartItems:this.cartItems,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory,tcContractFactory:this.tcContractFactory,addressFactory:this.addressFactory,companyFactory:this.companyFactory,addresses:this.addresses})},_createBiddingDeliveryMethodComponent:function(){if(this.isDeliveryActive){return new s({cart:this.cart})}},_checkPrototypes:function(D){t.requiredOfPrototype(D.cart,C,"options.cart must be a CartModel");t.requiredOfPrototype(D.cartItems,v,"options.cartItems must be a CartItemCollection");t.requiredOfPrototype(D.me,B,"options.me must be a PersonModel");t.requiredOfPrototype(D.shop,n,"options.shop must be a ShopModel");t.requiredOfPrototype(D.tcContractFactory,w,"options.tcContractFactory must be a TCContractFactory");t.requiredOfPrototype(D.tcDocumentFactory,a,"options.tcDocumentFactory must be a TCDocumentFactory");t.requiredOfPrototype(D.companyFactory,k,"options.companyFactory must be a CompanyFactory");t.requiredOfPrototype(D.addressFactory,h,"options.addressFactory must be an AddressFactory");t.requiredOfPrototype(D.cartItemFactory,j,"options.cartItemFactory must be a CartItemFactory");t.requiredOfPrototype(D.cartFactory,p,"options.cartFactory must be a CartFactory");if(this.buyerView){t.requiredOfPrototype(D.addresses,A,"options.addresses must be an AddressCollection")}if(this.buyerView&&this.buyerType===o.COMPANY){t.requiredOfPrototype(D.company,c,"options.company must be a CompanyModel")}}});return e});define("DS/MPFBiddingNewMessage/BiddingNewMessageFactory",["UWA/Core","UWA/Class","UWA/Promise","DS/MPFConnector/Connector","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFTcContractComponent/TermsOfUseOrderFactory","DS/MPFModelFactory/PersonFactory","DS/MPFModelFactory/ShopFactory","DS/MPFModelFactory/CartFactory","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFCompanyModel/CompanyHelper","DS/MPFCartModel/CartModel","DS/MPFBiddingNewMessage/BiddingNewMessage"],function(j,a,k,e,n,h,g,m,l,i,c,f,d,o){var b=a.extend({init:function(p){p||(p={});i.requiredOfPrototype(p.connector,e,"options.connector must be a Connector");this.connector=p.connector;this.buyerView=p.buyerView===true;this.isDeliveryActive=p.isDeliveryActive===true;this.cartID=p.cartID;this.shopID=p.shopID;this.onMenuRefresh=p.onMenuRefresh;this.validateSend=p.validateSend},getBiddingNewMessageComponent:function(){return this._initFactories().then(this._fetchMeCartShop.bind(this)).then(this._fetchCompany.bind(this)).then(this._fetchAddresses.bind(this)).then(this._initCartItems.bind(this)).then(this._getTCsForBuyer.bind(this)).then(this._buildBiddingNewMessageComponent.bind(this))},_initFactories:function(){var p=this;this.factories=n.getInstance(this.connector);return k.all([this.factories.getFactory(n.Types.PERSON),this.factories.getFactory(n.Types.COMPANY),this.factories.getFactory(n.Types.SHOP),this.factories.getFactory(n.Types.ADDRESS),this.factories.getFactory(n.Types.CART),this.factories.getFactory(n.Types.CART_ITEM),this.factories.getFactory(n.Types.TC_DOCUMENT),this.factories.getFactory(n.Types.TC_CONTRACT)]).then(function(q){p.personFactory=q[0];p.companyFactory=q[1];p.shopFactory=q[2];p.addressFactory=q[3];p.cartFactory=q[4];p.cartItemFactory=q[5];p.tcDocumentFactory=q[6];p.tcContractFactory=q[7];p.companyFactory.addressFactory=p.addressFactory;return p.addressFactory.whenReady()})},_fetchMeCartShop:function(){this.me=this.personFactory.createModel(g.Types.ME);this.shop=this.shopFactory.createModel(m.Types.SHOP,{id:this.shopID});this.cart=this.cartFactory.createModel(l.Types.CART,{id:this.cartID});return k.all([this.me.fetchPromise(),this.shop.fetchPromise(),this.cart.fetchPromise({expand:["cart-items"]})])},_fetchCompany:function(){if(this.buyerView){this.company=f.getCompanyFromPerson(this.me,this.companyFactory);if(j.is(this.company)){this.buyerType=c.COMPANY;return this.company.fetchPromise()}}},_fetchAddresses:function(){if(this.buyerView){if(this.buyerType===c.COMPANY){this.addresses=this.company.addresses;this.addresses.setParentResourceId("id")}else{this.addresses=this.addressFactory.createCollection("me");this.me.addresses=this.addresses;return this.addresses.fetchPromise()}}},_initCartItems:function(){this.cartItems=this.cartItemFactory.createCollection("",this.cart.getItems());this.cartItems.setParentResourceId(this.cartID);return this.cartItems},_getTCsForBuyer:function(){var q=this;var p;if(this.buyerView&&this.cart.getState()===d.States.DRAFT){p=new h({connector:this.connector,callback:function(){this.dispatchEvent("valueChanged")}});return p.displayTermsOfUse().then(function(r){q.buyerTermsOfUseComponent=r})}else{return k.resolve()}},_buildBiddingNewMessageComponent:function(){return new o({isDeliveryActive:this.isDeliveryActive,buyerView:this.buyerView,buyerType:this.buyerType,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory,addressFactory:this.addressFactory,companyFactory:this.companyFactory,tcDocumentFactory:this.tcDocumentFactory,tcContractFactory:this.tcContractFactory,me:this.me,company:this.company,shop:this.shop,addresses:this.addresses,cart:this.cart,cartItems:this.cartItems,onMenuRefresh:this.onMenuRefresh,validateSend:this.validateSend,buyerTermsOfUseComponent:this.buyerTermsOfUseComponent})}});return b});