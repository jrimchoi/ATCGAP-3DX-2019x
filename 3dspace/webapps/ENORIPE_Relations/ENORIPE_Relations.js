/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/ENORIPE_Relations/RelationsTabSettings",["UWA/Class","UWA/Core","UWA/Class/Options","UWA/Promise","DS/PlatformAPI/PlatformAPI","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","text!DS/SNNavigationMap/assets/SNNavigationMap.settings.json","i18n!DS/ENORIPE_Relations/assets/nls/Relations","i18n!DS/SNNavigationMap/assets/nls/SNNavigationMap_DEC","i18n!DS/SNNavigationMap/assets/nls/SNNavigationMap_V6Design","i18n!DS/SNNavigationMap/assets/nls/SNNavigationMap_V6Manufacturing","i18n!DS/SNNavigationMap/assets/nls/SNNavigationMap_Customer","i18n!DS/SNNavigationMap/assets/nls/SNNavigationMap_Simulation","i18n!DS/SNNavigationMap/assets/nls/SNNavigationMap_DBM","i18n!DS/SNNavigationMap/assets/nls/SNNavigationMap_GEBOM","i18n!DS/SNNavigationMap/assets/nls/SNNavigationMap_V6Knowledgeware","i18n!DS/SNNavigationMap/assets/nls/SNNavigationMap_Material","css!DS/ENORIPE_Relations/ENORIPE_Relations"],function(n,a,l,e,d,h,b,i,o,c,p,k,f,j,r,g,m){var q=n.singleton(l,{name:"relations_tab_settings",_localKey:null,init:function(){try{var t=JSON.parse(b);this.setOptions(t);this.setOptions("user_granted_roles","");this.setOption("isDraggable",false);a.merge(i,o);a.merge(i,c);a.merge(i,p);a.merge(i,k);a.merge(i,f);a.merge(i,j);a.merge(i,r);a.merge(i,g);a.merge(i,m);this._localKey="RelationsTab";if(typeof widget!=="undefined"&&widget!==null){if(widget.getValue("x3dSharedId")!==undefined){this._localKey="/"+widget.getValue("x3dSharedId")}else{if(widget.getValue("x3dAppId")!==undefined){this._localKey="/"+widget.getValue("x3dAppId")}else{if(widget.getValue("appId")!==undefined){this._localKey="/"+widget.getValue("appId")+"_"+widget.id}}}}}catch(s){console.error(s)}return},isAvailable:function(u,t){var s={},v=this;s.isAvailable=false;s.roles=[];if(t&&t.addinmode){this.setOption("addinmode",t.addinmode)}if(t&&t.lockedApp){this.setOption("lockedapp",t.lockedApp)}if(t&&t.appID){var w=t.appID;this.setOption("appID",w);if(w==="X3DSEAR_AP"){this.setOption("automode",true)}}else{this.setOption("appID","defaultID")}return new e(function(y,x){if(v.getOption("user_granted_roles")){s=v.parseRoles(v.getOption("user_granted_roles"),u);y(s)}else{h.getGrantedRoles(function(A){if(A){v.setOption("user_granted_roles",A);s=v.parseRoles(A,u);var z=false;if(t&&t.isDraggable){z=t.isDraggable}v.setOption("isDraggable",z);y(s)}else{x()}})}})},parseRoles:function(x,y){var t=[],B={},A=false,z=false,w=(y&&y.getPlatformID)?y.getPlatformID():"OnPremise",s;B.roles=[];B.isAvailable=false;if(x){if(typeof x==="string"&&(x[0]==="{"||x[0]==="[")){x=JSON.parse(x)}if(a.is(x,"array")){for(var v=0;v<x.length;v++){if(x[v].id==="InternalDS"){A=true;t.push(x[v].id)}if(y){if(x[v].platforms){for(var u=0;u<x[v].platforms.length;u++){if(w===x[v].platforms[u]){if(t.indexOf(x[v].id)===-1){t.push(x[v].id)}else{break}}}}}else{t.push(x[v].id)}}}B.roles=t;if(y&&y.getServiceID){s=y.getServiceID()||"3DSpace"}else{s="3DSpace"}if(t.indexOf("CSV")>-1||t.indexOf("InternalDS")>-1){A=true}if(s==="3DSpace"){z=true}if(A&&z){B.isAvailable=true;B.facetInfo={require:"DS/ENORIPE_Relations/views/RelationsTab",facet:{name:"relations",text:i.get("relations_tab"),icon:"component"},alwaysVisible:true}}}return B},getLang:function(){var s;if(window&&window.dsLang){s=window.dsLang}else{var t;if(window&&window.clntlang){t=window.clntlang}else{if(navigator&&navigator.languages&&a.is(navigator.languages,"array")&&navigator.languages.length>0){t=navigator.languages[0]}else{t=(navigator?(navigator.language||navigator.systemLanguage):"en")}}s=t.toLowerCase().split("-")[0]}return s},setProfile:function(s){var t=this;this._saveValuesForProfile("LastUsedProfile",s);require(["DS/PlatformAPI/PlatformAPI"],function(u){var v=t.getLocalKey()+"/setProfile";var w={profile:s};u.publish(v,w)})},getLocalKey:function(){return this._localKey},getUserID:function(){var s=d.getUser(),t=(s!==null&&s!==undefined&&s.login!==undefined)?d.getUser().login:"";return t},_saveValuesForProfile:function(s,t){if(s){s=s+"-"+this.getOption("appID")}if(s&&t){if(typeof widget!=="undefined"){widget.setValue(s,t)}else{localStorage.setItem(s,t)}}}});return q});define("DS/ENORIPE_Relations/views/RelationsView",["UWA/Core","UWA/Class/View","UWA/Class","DS/WAFData/WAFData","DS/TransientWidget/TransientWidget","DS/CollectionView/ResponsiveLargeTilesCollectionView","DS/TreeModel/TreeDocument","DS/Tree/TreeNodeModel","DS/Controls/ComboBox","UWA/Class/Model","UWA/Date","UWA/Utils/InterCom","DS/i3DXCompassPlatformServices/OpenWith","DS/i3DXCompassServices/i3DXCompassPubSub","DS/i3DXSNDictionaryAPI/3DXSearchDictionaryAccess","i18n!DS/ENORIPE_Relations/assets/nls/Relations","DS/UIKIT/Mask","DS/PlatformAPI/PlatformAPI","DS/WebappsUtils/WebappsUtils","DS/Controls/TileView","DS/UIKIT/Tooltip","DS/UIKIT/Spinner","DS/UIKIT/DropdownMenu","DS/Core/PointerEvents"],function(a,r,w,b,v,q,k,n,i,p,t,u,f,d,m,l,y,c,e,j,s,h,o,g){var x=r.extend({name:"list-view",isInitialized:false,_currentRequest:null,models:{},responsiveTiles:[],_selectedModels:[],tiles:[],isSetTypesCallbackSubscribed:false,_compassSocket:{},_platformId:"",_serviceName:"",_separator:"",_nameLabel:null,_detailLabel1:null,_detailLabel2:null,_selectUuid:a.Utils.getUUID(),className:function(){return this.getClassNames("-container multisel-off")},setup:function(A){var B=this;this._widgetId=A.widgetId||null;this._tenant=A.tenant||"OnPremise";this._url=A.serviceURL+"/resources/enorelnav/navigate/getecosystem?tenant="+this._tenant;this.isDraggable=A.isDraggable||false;this.currentProfile=A.currentProfile;this._separator=A.separator;this._nameLabel=A.nameLabel;this._detailLabel1=A.detailLabel1;this._detailLabel2=A.detailLabel2;this._lang=A.lang;this._is3DSearch=A.is3DSearch||false;this._autoNavMode=A.autoNavMode||false;this._addinMode=A.addinmode;this._lockedApp=A.lockedApp;this.mapAccordion=new a.createElement("ul",{"class":"relations-accordion"});if(!this._is3DSearch){this._setUpComboBox(A);this.header=new a.createElement("div",{"class":"relations-header",events:{click:function(){B.dispatchEvent("ENORIPERelations_ShowProfiles")}}}).inject(this.container);var z=a.createElement("div",{"class":"comboBox-component",minWidth:150,title:l.get("Profiles")}).inject(this.header);this._profileCombobox.inject(z)}this.mapAccordion.inject(this.container);var D="com.ds."+this._widgetId;this._compassSocket=new u.Socket(D);var C="com.ds.compass";this._compassSocket.subscribeServer(C,window.parent);if(!this.isSetTypesCallbackSubscribed){d.subscribe("setTypesCallback",this._setTypesCallback.bind(this));this.isSetTypesCallbackSubscribed=true}this.container.addEventListener("contextmenu",function(E){E.preventDefault();return false})},setModel:function(z){if(this._currentRequest){this._currentRequest.cancel()}this.model=(this.model===z)?this.model:z;this._platformId=z.get("platformId")||"OnPremise";this._serviceName=z.get("serviceName")||"3DSpace";this._getDetail(this.model.get("id"))},_getDetail:function(B){var z=this,A={widgetId:this._widgetId,id:this.model.get("id"),ecoSystemWithDetail:true,debug:false};if(this._url){this._currentRequest=b.authenticatedRequest(this._url,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",data:JSON.stringify(A),onComplete:function(C){z._currentRequest=null;z._getNlsData(JSON.parse(C)).then(function(D){z.render(D)})},onFailure:function(D){console.log(D);var C={};C.message=l.get("generic");z.dispatchEvent("ENORIPERelations_handleErrorMsgs",[C]);z.removeLoader();z.hidePanel()},onTimeout:function(D){console.log(D);var C={};C.message=l.get("timeout");z.dispatchEvent("ENORIPERelations_handleErrorMsgs",[C]);z.removeLoader();z.hidePanel()}})}},_getNlsData:function(C){var E=this,D={},H={},F=null;for(var z in C){if(C.hasOwnProperty(z)){for(var G in C[z]){if(C[z].hasOwnProperty(G)){for(var B=0;B<C[z][G].length;B++){F=C[z][G][B];for(var A in F){if(F.hasOwnProperty(A)&&A.contains("ds6w")){if(D[A]){if(D[A].indexOf(F[A])===-1){D[A].push(F[A])}}else{D[A]=[F[A]]}}}}}}}}return new w.Promise(function(J,I){if(!E.isWebInWin){m.getNlsOfPropertiesValues(JSON.stringify(D),{tenantId:E._tenant,lang:E._lang,onComplete:function(K){H=E._convertToNls(C,K);J(H)},onFailure:function(K){console.log("Error in fetching NLS data from SearchDictionaryAccess.getNlsOfPropertiesValues, the error is ::"+K);J(C)}})}else{J(C)}})},_convertToNls:function(F,B){if(B){var E=null,A=null;for(var z in F){if(F.hasOwnProperty(z)){for(var D in F[z]){if(F[z].hasOwnProperty(D)){for(var C=0;C<F[z][D].length;C++){E=F[z][D][C];for(var G in E){if(E.hasOwnProperty(G)&&G.contains("ds6w")){if(B[G]&&B[G].hasOwnProperty(E[G])){A=B[G][E[G]];E[G]=A}}}}}}}}}return F},_setUpComboBox:function(J){this.profileArray=J.profileArray;var B=J.currentProfile,H=160,A=0,I,G=[],z=J.lang||null;for(var C=0;C<this.profileArray.length;C++){G[C]=l.get(this.profileArray[C].name);if(z){I=(z==="ja")?14:7}else{I=7}H=(H<G[C].length*I)?G[C].length*I:H;if(B!==null&&B!==""&&B!==undefined){if(this.profileArray[C].name===B){A=C}if(B==="AutoModeProfile"){this._autoNavMode=true}else{this._autoNavMode=false}}}this.profileTreeDocument=new k();for(var D=0;D<G.length;D++){var E={label:G[D],data:{name:this.profileArray[D].name}};if(this.profileArray[D].type){E.data.type=this.profileArray[D].type}var F=new n(E);this.profileTreeDocument.addRoot(F)}this.comboOptions={elementsTree:this.profileTreeDocument,nbDisplayedElements:G.length,enableSearchFlag:false,actionOnClickFlag:false,selectedIndex:A,touchMode:true};this._profileCombobox=new i(this.comboOptions);this._profileCombobox.addEventListener("change",this._handleProfileChange.bind(this));this.currentProfile=this.profileArray[this._profileCombobox.selectedIndex].name;this._profileCombobox.elements.container.style.width=H+"px"},_renderComboBox:function(){},render:function(Z){if(Z&&Z.status&&Z.status==="KO"){var C={};C.message=l.get("generic");this.dispatchEvent("ENORIPERelations_handleErrorMsgs",[C]);this.removeLoader();this.hidePanel();return this}var I=0,O="",N,J=this,A={},Y,B,aa,H,R,D,K,T=[],X={height:"inherit",displayTitleTooltip:true,displayPropertiesTooltip:true,displayedOptionalCellProperties:["description","contextualMenu"],useDragAndDrop:this.isDraggable},S=[];this.responsiveTiles=[];this._selectedModels=[];this.models={};this.clearAccordion();if(this.isDraggable){X.onDragStartCell=this._onDragStart.bind(this)}for(var M in Z){if(Z.hasOwnProperty(M)){if(Object.keys(Z[M]).length===0&&Z[M].constructor===Object){this.removeLoader();this.renderError();return this}for(var L in Z[M]){if(this.availableRelations.indexOf(L)===-1&&!this._autoNavMode){continue}if(Z[M].hasOwnProperty(L)){I=Z[M][L].length;if(I>0){A=a.createElement("li",{html:'<input type="checkbox"><i></i><h2>'+l.get(L)+" ("+I+")</h2>"});R=new q(X);R.selectionBehavior={unselectAllOnEmptyArea:true,toggle:true,canMultiSelect:true,canInteractiveMultiselectWithCheckboxClick:true,enableShiftSelection:true,enableFeedbackForActiveCell:false};var G=true;if(this._addinMode&&this._lockedApp){if(this._addinMode==="catiav5"&&(this._lockedApp==="true"||this._lockedApp===true)){G=false}}if(G){R.onContextualEvent={"this":J,callback:this._handleMenuClick}}S=[];for(var Q=0;Q<I;Q++){N=Z[M][L][Q];Y=new p({id:N.id,modelType:"node",columnID:0,focus:false,isAnchor:false,name:N.name,type:N.type});this.models[N.id]=Y;T.push(Y);B=N["ds6w:responsible"];aa=t.strftime(new Date(N["ds6w:modified"]),"%m/%d/%Y %r");H=B+" - "+aa;var F=this._getLabels(N,this._nameLabel);var W=this._getLabels(N,this._detailLabel1);var U=this._getLabels(N,this._detailLabel2);var z={label:F,icons:[N.icon_url],subLabel:W,description:U,thumbnail:N.thumbnail,data:{id:N.id,type:N.type,element:N},};if(G){z.contextualMenu="A"}K=new n(z);S.push(K)}R.model=S;D=a.createElement("div",{"class":"list-tiles-container"});var P=R.model.length*80+21,V=1240;var E=Math.min(P,V)+"px";D.setStyle("height",E);R.getContent().inject(D);D.inject(A);this.mapAccordion.addContent(A);this.responsiveTiles.push(R)}}}I=0;O=""}}if(T.length===0){this.renderError()}else{this.showPanel()}if(this.responsiveTiles.length>0){this.responsiveTiles.forEach(this._setUpEvents.bind(this))}this.removeLoader();return this},_getSelectedProfile:function(){var z=this.profileTreeDocument.getRoots()[this._profileCombobox.selectedIndex];if(z){return z}},_handleProfileChange:function(){if(this._noHandleProfileChange){this._noHandleProfileChange=false;return}this.currentProfile=this._getSelectedProfile().options.data.name;if(this.currentProfile==="AutoModeProfile"){this._autoNav=true}else{this._autoNav=false}this.dispatchEvent("ENORIPE_updateRelations",[this.currentProfile])},changeComboboxProfile:function(A){if(this._profileCombobox&&this.profileArray){for(var z=0;z<this.profileArray.length;z++){if(A===this.profileArray[z].name&&this._profileCombobox.selectedIndex!==z){this._noHandleProfileChange=true;this._profileCombobox.selectedIndex=z;this._profileCombobox._applySelectedIndex();break}}}},_handleMenuClick:function(C){var F=this,H;if(C&&C.infos&&C.infos.target){H=C.infos.target}else{if(C&&C.data&&C.data.target){H=C.data.target}}var I=("event" in window)?event:window.event,A;if(!I){if(C&&C.data&&C.data.windowPosition&&C.data.windowPosition.x&&C.data.windowPosition.y){var E=C.data.windowPosition;A={x:E.x,y:E.y}}}else{if(I.clientX){A={x:I.clientX,y:I.clientY};if(!H){H=I.target}}}var D={target:H,altPosition:A,items:[],events:{onHide:function(){this.destroy()},onClickOutside:function(){this.destroy()}}};var z=new o(D);C.cellInfos.cellModel._options.data.dropdown=z;var B=null;if(C.cellInfos&&C.cellInfos.cellModel){B=C.cellInfos.cellModel._options.data.element}else{if(C.context&&C.context.cellInfos&&C.context.cellInfos.cellModel){B=C.context.cellInfos.cellModel._options.data.element}}var G=this._getContentForOpenWith(B);new f().set3DXContent(G).render(z);z.show()},_getContentForOpenWith:function(A){if(A){var B={data:{items:[{serviceId:this._serviceName,envId:this._platformId||"OnPremise",objectId:A.id,objectType:A.type}]}};if(A.taxonomies&&A.taxonomies.length>0){var z=this._getTaxonomies(A.taxonomies);if(z&&z.length>0){B.data.items[0].objectTaxonomies=z}}return B}},_getTaxonomies:function(D){if(D&&D.length>0){var z=D.split(","),B="";for(var A=0;A<z.length;A++){if(z[A].contains("types")){z=z[A];break}}var C=z.split("/");if(C.length>1){C.splice(0,1);return C}else{return[]}}},_getLabels:function(D,A){if(!A){return}var z="",C=0,F="";for(var B=0;B<A.length;B++){F="";if(D.hasOwnProperty(A[B])){F=D[A[B]];if(A[B].contains("modified")){if(F!==""){var E=new Date(F);F=t.strftime(E,"%m/%d/%Y %r")}}}if(F&&F.length>0){z=(z.length>0)?(z+this._separator+F):F;C++}if(C===3){break}}return z},updateHeader:function(){if(this._is3DSearch){return}this.header.getChildren()[0].setHTML(l.get(this.currentProfile))},_onDragStart:function(B,C){var A={protocol:"3DXContent",version:"1.0",source:"ENORIPE_AP",data:{items:this.getSelectedItems({serviceId:this._serviceName,objectId:C.cellModel._options.data.id,objectType:C.cellModel._options.data.type,displayName:C.cellModel._options.label})}};try{B.dataTransfer.setData("text/searchitems",JSON.stringify(A));B.dataTransfer.setData("text",JSON.stringify(A))}catch(z){console.log(z);B.dataTransfer.setData("text",JSON.stringify(A))}v.closeWidget()},_setUpEvents:function(A){var C=this,B=function(E){var H=A,I=E._options.data.id,D=(E.isSelected())?"add":"remove",G=C.models[I];if(D==="add"&&C._selectedModels.indexOf(G)===-1){C._selectedModels.push(G)}else{if(D==="remove"&&C._selectedModels.indexOf(G)!==-1){var F=C._selectedModels.indexOf(G);C._selectedModels.splice(F,1)}}C._syncObjectToCompass()},z=A.TreedocModel.getXSO().onChange(B)},renderError:function(){var z=this;this.errorDiv=new a.createElement("div",{"class":"empty-relation-div",html:[{tag:"p","class":"icon-empty-list",html:'<i class= "wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-object-related-cog" ></i>'},{tag:"p","class":"empty-relation-para",html:(z._is3DSearch)?l.get("NoResultFound")+l.get("Relations"):l.get("NoResultFound")}]});this.errorDiv.inject(this.mapAccordion);if(this._is3DSearch){return}this.errorSpan=new a.createElement("span",{"class":"empty-relation-span",html:l.get(z.currentProfile)});this.errorSpan.inject(this.errorDiv);z.errorSpan.addEvent("click",function(){z._profileCombobox._showPopup()})},_syncObjectToCompass:function(){var B=this._selectedModels;if(0===B.length){this.updateSelection(null);d.publish("resetTypes")}else{var A={widgetId:this._widgetId};d.publish("setTypes",A)}if(1===B.length){this.updateSelection(B[0])}var z=this._buildCompassData({widgetId:this._widgetId,envId:this._platformId,selectedModels:B});this._compassSocket.dispatchEvent("onSetX3DContent",z);if(widget.getValue("x3dAppId")!=="ENOFOL3_AP"){this._publishSelectionEvent(B)}},_publishSelectionEvent:function(E){var z=[],A=require("DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext"),C={metadata:{uid:a.Utils.getUUID(),originUid:this._selectUuid,timestamp:Date.now(),appid:"/no_private_channel",originWidgetId:widget.id,ignoreFromSameWidgetId:true},data:{tenant:this._tenant,version:"1.1"}};if(typeof widget!=="undefined"&&widget!==null){if(widget.getValue("x3dSharedId")!==undefined){C.metadata.appid="/"+widget.getValue("x3dSharedId")}else{if(widget.getValue("x3dAppId")!==undefined){C.metadata.appid="/"+widget.getValue("x3dAppId")}else{if(widget.getValue("appId")!==undefined){C.metadata.appid="/"+widget.getValue("appId")+"_"+widget.id}}}}for(var B=0;B<E.length;B++){z.push(E[B].get("id"))}C.data.paths=[z];try{C.data.changeControl=A.get()}catch(D){console.warn("No Change")}c.publish("DS/PADUtils/PADCommandProxy/select",C)},updateSelection:function(z){if(null===z){var B={objectId:"",envId:this._platformId,contextId:""};this._compassSocket.dispatchEvent("onSetObject",B);this._compassSocket.dispatchEvent("onResetX3DContent",{});return}var A={objectId:z.get("id"),envId:this._platformId,contextId:""};if(this._compassSocket.dispatchEvent){this._compassSocket.dispatchEvent("onSetObject",A);var C={widgetId:this._widgetId};d.publish("setTypes",C)}},_buildCompassData:function(C){var A=this,B={};if(a.is(C)){var z=C.selectedModels;if(a.is(z,"array")){B={protocol:"3DXContent",version:"1.1",source:"ENORIPE_AP",widgetId:C.widgetId,data:{items:[]}};var D=[];z.forEach(function(F){var E={envId:C.envId,serviceId:A._serviceName,contextId:"",objectId:F.id,objectType:F.get("type"),displayName:F.get("name"),displayType:F.get("type")};D.push(E)});B.data.items=D}}return B},_setTypesCallback:function(z){if(z.widgetId===this._widgetId){var A={appId:z.appId,widgetId:z.widgetId};if(this._selectedModels.length>0){var B=this.buildSelectionForNativeApps();A.fileName="-file";A.fileContent=B}d.publish("launchApp",A)}},buildSelectionForNativeApps:function(){var B={version:"2.1",results:[],structures:[{structure:[]}]},z;for(var A=0;A<this._selectedModels.length;A++){z=JSON.stringify(A+1);B.results.push({id:z,phid:this._selectedModels[A].id});B.structures[0].structure.push({id:z,show:true,select:true,children:[]})}return JSON.stringify(B)},getSelectedItems:function(E){var B=[],D=this,F=false,z=this._platformId,A=null;E.envId=z;B.push(E);for(var C=0;C<this.responsiveTiles.length;C++){A=this.responsiveTiles[C].TreedocModel.getSelectedNodes();if(A&&A.length>0){A.forEach(function(G){if(G._options.data.id!==E.objectId){B.push({envId:z,serviceId:D._serviceName,objectId:G._options.data.id,objectType:G._options.data.type,displayName:G._options.label})}})}}return B},hidePanel:function(){this.container.hide()},showPanel:function(){this.container.show()},removeLoader:function(z){y.unmask(this.getOption("forMaskManagement"))},clearAccordion:function(){this.mapAccordion.empty()},clearPanel:function(){this.clearAccordion();this.model=null;this._selectedModels=[];this.models={}},destroy:function(){this.clearPanel();this._parent();this.container=null}});return x});define("DS/ENORIPE_Relations/views/RelationsTab",["UWA/Core","UWA/Class","UWA/Promise","DS/ENORIPE_Relations/RelationsTabSettings","DS/EditPropWidget/facets/Common/FacetsBase","DS/EditPropWidget/constants/EditPropConstants","UWA/Class/Model","DS/WAFData/WAFData","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/UIKIT/Popover","DS/Controls/Toggle","DS/Controls/Button","i18n!DS/ENORIPE_Relations/assets/nls/Relations","DS/PlatformAPI/PlatformAPI"],function(a,o,e,q,p,j,k,b,g,r,f,n,d,l,h,c){var i=function(){var v="",s=new Date(),t=s.getDay()+s.getMonth()+s.getFullYear(),u=t+"-"+s.getHours()+":"+s.getMinutes()+":"+s.getSeconds();v="ENORIPE_Relations_Preview_"+Math.floor(Math.random()*10000)+"_"+u;return v};var m=p.extend({_widgetID:i(),_appID:q.getOption("appID"),_3dSpaceUrl:null,_availableRelations:[],_profileInfo:null,profilePopover:null,_toggles:[],_tenant:null,_subscriptions:[],_autoNavMode:q.getOption("automode"),init:function(u){var w=this;this._parent.apply(this,arguments);if(!this.elements.container){this.elements.container=a.createElement("div",{styles:{height:"100%"}})}if(u&&u.defaultProfile&&a.is(u.defaultProfile,"string")){if(widget){var s=this._getValuesForProfile("LastUsedProfile");if(typeof s==="undefined"){this._saveValuesForProfile("LastUsedProfile",u.defaultProfile)}}else{this._saveValuesForProfile("LastUsedProfile",u.defaultProfile)}}var t=q.getLocalKey()+"/setProfile";var v=c.subscribe(t,function(x){w.setProfile(x.profile)});this._subscriptions.push(v)},updateFacet:function(){var t=this,s=t.getModel();this._tenant=s.get("tenant");this.addLoader();return new o.Promise(function(v,u){if(t._3dSpaceUrl===null){g.getServiceUrl({serviceName:s.get("source"),platformId:s.get("tenant"),onComplete:function(w){t._3dSpaceUrl=w;q.isAvailable().then(t._getProfiles.bind(t)).then(t._parseRelations.bind(t)).then(t._setPreferences.bind(t)).then(function(){t._renderListView();v()})},onFailure:function(w){console.log(w);t.removeLoader();u()}})}else{if(typeof t.currentProfile!=="undefined"){t._setPreferences().then(function(){t._renderListView();v()})}}})},_renderListView:function(){var u=this,v=[];if(u.elements&&u.elements.container){var s=u.getModel();if(!s){return false}if(!u.listView){for(var t=0;t<u._profileInfo.length;t++){if(u._profileInfo[t].type){v[t]={name:u._profileInfo[t].name,type:u._profileInfo[t].type}}else{v[t]={name:u._profileInfo[t].name}}}require(["DS/ENORIPE_Relations/views/RelationsView"],function(w){u.listView=new w({fireEventOnSlide:true,widgetId:u._widgetID,debugMode:true,serviceURL:u._3dSpaceUrl,currentProfile:u.currentProfile,profileArray:v,tenant:u._tenant,separator:q.getOption("displayNameSeparator"),nameLabel:q.getOption("displayNameAttributes"),detailLabel1:q.getOption("detailAttributesLevel1"),detailLabel2:q.getOption("detailAttributesLevel2"),lang:q.getLang(),isDraggable:q.getOption("isDraggable"),is3DSearch:u._is3dsearch(),autoNavMode:u._autoNavMode,forMaskManagement:u.elements.container,addinmode:q.getOption("addinmode"),lockedApp:q.getOption("lockedapp")});u.listView.inject(u.elements.container);u.listView.availableRelations=u._availableRelations;u.listView.setModel(new k({id:s.get("objectId"),serviceName:s.get("source")||"3DSpace",platformId:s.get("tenant")||"OnPremise"}));if(u._is3dsearch()){return}u.listView.addEvent("ENORIPERelations_handleErrorMsgs",u._showNotif,u);u.listView.addEvent("ENORIPE_updateRelations",u._updateRelations,u)})}else{u.listView.availableRelations=u._availableRelations;u.listView.setModel(new k({id:s.get("objectId"),serviceName:s.get("source")||"3DSpace",platformId:s.get("tenant")||"OnPremise"}))}}},_is3dsearch:function(){var s=false,t=q.getOption("appID");if(t&&t==="X3DSEAR_AP"){s=true}return s},_updateRelations:function(t){if(t){var s=this;this.addLoader();this.setProfile(t)}},createPromise:function(s){var u=JSON.stringify(s.params);var t=this;return new o.Promise(function(w,v){b.authenticatedRequest(s.url,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",data:u,onComplete:w,onFailure:function(x){console.log(x);t._showNotif({message:h.get("generic")});t.removeLoader();v(x)},onTimeout:function(x){console.log(x);t._showNotif({message:h.get("timeout")});t.removeLoader();v(x)}})})},_getProfiles:function(s){var t=this;return this.createPromise({url:t._3dSpaceUrl+"/resources/enorelnav/navigate/getProfiles?tenant="+t._tenant,params:{widgetId:t._widgetID,roles:s.roles,profileVersion:2}})},_parseRelations:function(v){this._availableRelations=[];if(v){var y=this,s=JSON.parse(v),A=s.profiles[0],t={name:"AutoModeProfile"},C=this._getValuesForProfile("LastUsedProfile"),B;t.relations=[];s.profiles.unshift(t);var z=this._getRelationsSet();if(z){for(var x=0;x<z.length;x++){s.profiles.splice(x+1,0,z[x])}}this._profileInfo=s.profiles;if(C!==null&&C!==""&&C!==undefined){B=C}else{B=s.profiles[0].name}this.currentProfile=s.profiles[0].name;for(var w=0;w<s.profiles.length;w++){if(B===s.profiles[w].name){A=s.profiles[w];this.currentProfile=s.profiles[w].name;break}}if(this.currentProfile==="AutoModeProfile"){this._autoNavMode=true}else{this._autoNavMode=false}for(var u=0;u<this._profileInfo.length;u++){}}return new e(function(G,F){if(A){var D=A.relations;for(var E=0;E<D.length;E++){y._availableRelations.push(D[E].name)}G()}else{F()}})},_setPreferences:function(){var t=this,s=[];s=s.concat(q.getOption("displayNameAttributes"));s=s.concat(q.getOption("detailAttributesLevel1"));s=s.concat(q.getOption("detailAttributesLevel2"));t._saveValuesForProfile("LastUsedProfile",this.currentProfile);return this.createPromise({url:t._3dSpaceUrl+"/resources/enorelnav/navigate/setpreferences?tenant="+t._tenant,params:{widgetId:t._widgetID,relations:(t._autoNavMode)?["use-auto-by-type-relations"]:t._availableRelations,countmanagement:true,attributes_for_detailview:s}})},_getValuesForProfile:function(s){var t;if(s){s=s+"-"+this._appID;if(widget){t=widget.getValue(s)}else{t=localStorage.getItem(s)}if(t){return t}}},_saveValuesForProfile:function(s,t){if(s){s=s+"-"+this._appID}if(s&&t){if(widget){widget.setValue(s,t)}else{localStorage.setItem(s,t)}}},_getRelationsSet:function(){var s=localStorage.getItem(q.getUserID()+"_ENORIPE_CustomRelationsSet");if(s){return JSON.parse(s)}},_showNotif:function(s){if(this.alert){this.alert.destroy()}this.alert=new f({visible:true,autoHide:true,hideDelay:3000,animate:true}).inject(this.elements.container);this.alert.add({className:"error",message:s.message})},addLoader:function(){r.mask(this.elements.container)},removeLoader:function(s){r.unmask(this.elements.container)},getProfilesAndRelations:function(){return this._profileInfo},getCurrentProfile:function(){if(this.currentProfile){return this.currentProfile}else{var s=this._getValuesForProfile("LastUsedProfile");return s}},getProfiles:function(){var s=[];if(this._profileInfo&&this._profileInfo.length>0){this._profileInfo.forEach(function(t){s.push(t.name)})}return s},setProfile:function(w){if(w===""||w===null||w===undefined){console.log("Invalid profile name");return}var x=this,u=false;for(var v=0;v<this._profileInfo.length;v++){if(this._profileInfo[v].name===w&&this.currentProfile!==w){u=true;this.currentProfile=this._profileInfo[v].name;this.listView.currentProfile=this.currentProfile;var t=this._profileInfo[v].relations;this._availableRelations=[];if(w==="AutoModeProfile"){this._autoNavMode=true;this.listView._autoNavMode=true}else{this._autoNavMode=false;this.listView._autoNavMode=false}for(var s=0;s<t.length;s++){this._availableRelations.push(t[s].name)}this.listView.availableRelations=this._availableRelations;break}}return new o.Promise(function(z,y){if(u){if(x.listView){x.listView.changeComboboxProfile(w)}x._setPreferences().then(function(){x._renderListView();z()},function(){y()})}else{z()}})},destroyComponent:function(){if(a.is(this.destroy,"function")){this.destroy()}}});return m});