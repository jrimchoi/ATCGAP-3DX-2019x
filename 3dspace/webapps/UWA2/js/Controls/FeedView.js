define("UWA/Controls/FeedView",["UWA/Core","UWA/Class","UWA/Event","UWA/String","UWA/Controls/Abstract","UWA/Controls/Ellipsis","UWA/Controls/Scroller","UWA/Controls/Pager"],function(e,b,i,c,g,h,d,a){var f=g.extend({defaultOptions:{nbItems:10,showDate:true,messages:{noItem:"There is no news in this feed.",loadMore:"Load more news.",websiteLink:"Go to website",readMore:"Read more"},images:{loader:e.hosts.uwa+e.paths.css+"base/img/loader.gif",image:e.hosts.uwa+e.paths.css+"base/img/article.png"},scroller:{lockDirection:true,momentum:true,bounce:true},pager:{type:0,showMoreLink:true}},pagerPosition:"bottom",scrollPosition:"top",itemPerPage:0,init:function(j){this._parent(j);this.itemsEllipsis=[];this.itemsImages={loaded:[],loading:[],waiting:[],maxLoading:2};this.buildSkeleton()},buildSkeleton:function(){var k=this,j=k.pagerPosition;k.container=e.createElement("div",{"class":"uwa-feedview content uwa-feedview-"+k.viewName.replace(/ /g," uwa-feedview-"),events:{resize:this.dispatchAsEventListener("onResize"),mousedown:this.dispatchAsEventListener("onMouseDown")}});this.buildItems();k.buildScroller();if(j){if(["top","both"].indexOf(j)!==-1){k.buildPager("top")}if(["bottom","both"].indexOf(j)!==-1){k.buildPager("bottom")}}return k.container},buildItems:function(){var l=this,j=l.options,k=j.messages,m=l.elements;m.item=[];m.items=e.createElement("div",{"class":"items"});m.itemsActions=e.createElement("div",{"class":"actions",html:[{tag:"div","class":"loadMore action",html:{tag:"a",href:"#",text:e.i18n(k.loadMore)},styles:{display:"none"}},{tag:"div","class":"noItem action",text:e.i18n(k.noItem),styles:{display:"none"}},{tag:"div","class":"websiteLink action",html:{tag:"a",href:"#",text:e.i18n(k.websiteLink)},styles:{display:"none"}}]}).inject(m.items);m.items.inject(l.container);return m.items},buildScroller:function(){var j=this,k=j.elements,l=e.merge({events:{onRefresh:function(){j.refreshPager();j.loadItemsImages()},onScrollEnd:function(){j.loadItemsImages()}}},j.options.scroller);k.scrollarea=e.createElement("div",{"class":"scrollarea"}).grab(k.items).inject(j.container,"top");j.scroller=new d(j.elements.items,l)},setScrollerHeight:function(j){if(this.pager){j-=this.pager.getContent().getDimensions().outerHeight}if(this.elements.top){j-=this.elements.top.getDimensions().outerHeight}if(this.elements.scrollarea){this.elements.scrollarea.setStyle("height",j+"px")}else{this.container.setStyle("height",j+"px")}this.refreshScroller()},refreshScroller:function(){var k=this,j=k.scroller;if(j){j.dispatchEvent("onRefresh")}},buildPager:function(j){var k=this,l=e.merge({_root:false,events:{onOffsetChange:function(n){var m=k.options.source.getItems();k.showItem(m[n])}}},k.options.pager);k.pager=new a(l);k.pager.inject(k.container,j)},refreshPager:function(){var k,n,m,o=this,j=o.pager,l=o.options,p=l.source;if(j){k=p.getItems();m=o.getItemsPerPage();n=k.indexOf(o.currentItem);j.options.moreLink=p.getLink();j.setLength(k.length);j.setLimit(m);j.setOffset(n===-1?0:n);j.dispatchEvent("onRefresh")}},getItemsPerPage:function(){var n,j,o=this,m=0,k=o.elements.item;for(n=0,j=k.length;n<j;n++){if(o.scroller.isInViewport(k[n])){m++}}o.itemPerPage=m;return o.itemPerPage},buildItem:function(l){var k,j=this.options,n=j.source.isItemRead(l),m=j.showDate&&l.date?c.parseRelativeTime(l.date.toString()):false;k=e.createElement("div",{"class":"item "+(n?"read":"unread"),html:{tag:"div","class":"content",html:{tag:"div","class":"infos",html:[{tag:"div","class":"title",html:[{tag:"a","class":"link ellipsis",href:l.link,html:c.stripTags(l.title)},{tag:"div","class":"separator"}]},m&&{tag:"div","class":"date",html:[{tag:"span",html:m},{tag:"div","class":"separator"}]}]}},events:{click:this.dispatchAsEventListener("onItemClick",l)}});this.addEllipsis({reference:k.getElement(".content"),element:k.getElement(".ellipsis")});k.setData("href",l.link);k.setData("item-index",l.index);return k},getItem:function(k){var j=k.index,l=this.elements.item;if(!l[j]){l[j]=this.buildItem(k)}return l[j]},getItems:function(j){return j.map(this.getItem,this)},refreshItems:function(){var l=this,k=l.options,m=k.source,j=m.getItems();l.injectItems(j)},injectItems:function(p){var o=this,n=o.getItems(p),q=n.length,j=o.elements,r=o.options,k=r.source,l=k.getItems().length,m=k.hasMore(j.items.length);j.itemsActions.getElement(".loadMore").toggle(m);j.itemsActions.getElement(".noItem").toggle(!l);n=n.splice(0,r.nbItems);n.push(j.itemsActions);n.forEach(function(s,t){if(t===0){s.addClassName("first")}else{if(t===(q-1)){s.addClassName("last")}}s.addClassName(t%2===0?"odd":"even")});j.items.addContent(n);if(!o.currentItem&&p[0]){o.showItem(p[0])}},showItem:function(m){var l=this,k=l.currentItem,j=l.options,n=j.source;if(k!==m){if(k){l.getItem(k).removeClassName("active")}l.getItem(m).removeClassName("unread").addClassName("read").addClassName("active");n.setItemRead(m);l.currentItem=m;if(l.scroller){l.scroller.scrollToElement(l.getItem(m),l.scrollPosition)}}},loadMore:function(k){var m=this,l=m.options,j=l.source.getLoaded();k=k||l.nbItems;this.injectItems(j.splice(m.elements.items.length,k))},destroy:function(){if(this.container){this.container.destroy()}},addEllipsis:function(j){this.itemsEllipsis.push(j)},loadEllipsis:function(){var n,j,k,o=this,m=o.itemsEllipsis;for(n=0,j=m.length;n<j;n++){k=m[n];if(!k.ellipsis){k.ellipsis=new h(k.element,{_root:false,reference:k.element.getParent()})}}o.refreshEllipsis()},refreshEllipsis:function(){var n,j,k,m=this.itemsEllipsis;for(n=0,j=m.length;n<j;n++){k=m[n];if(k.ellipsis){k.ellipsis.dispatchEvent("onRefresh")}}},resizeItemImage:function(k){var o,n,m,j,l,p=k&&k.getElement("img");k=p&&p.getParent();if(k&&k.offsetWidth>0&&k.isInjected()){o={width:"auto",height:"auto",marginTop:0,marginLeft:0};p.setStyles(o);n={width:p.offsetWidth,height:p.offsetHeight};m={width:k.offsetWidth,height:k.offsetHeight};l=m.width/m.height;j=n.width/n.height;if(this.options.images.loader===p.src&&(m.width>n.width||m.height>n.height)){o.marginLeft=(m.width/2)-(n.width/2)+"px";o.marginTop=(m.height/2)-(n.height/2)+"px"}else{if(l<j){o.height="100%";o.marginLeft=(-(m.height*j-m.width)/2)+"px"}else{o.width="100%";o.marginTop=(-((m.width/j)-m.height)/2)+"px"}}p.setStyles(o)}},buildItemImage:function(r,n){var m=this,k=m.options.images,j=k[n],q=r[n]||j,l=e.createElement("img"),o=e.createElement("div",{"class":"image",html:{tag:"a",title:c.stripTags(r.title),href:r.link,html:l}}),p=m.resizeItemImage.bind(m,o);this.addItemImage({item:r,container:o,src:q,onLoad:function(){l.setAttribute("src",q);p()},onError:function(){l.setAttribute("src",j);p()},onLoading:function(){l.setAttribute("src",k.loader);p()}});return o},addItemImage:function(j){this.itemsImages.waiting.push(j)},loadItemsImages:function(){var k,j,p,n=this,m=[],o=n.itemsImages;for(k=0,j=o.waiting.length;k<j;k++){p=o.waiting[k];if(p.item===n.currentItem||n.scroller.isInViewport(p.container,true)){m.push(p)}}for(k=0,j=m.length;k<j;k++){n.loadItemImage(m[k])}},loadItemImage:function(n){var j,k=this,m=k.itemsImages,l=function(){var r,p,q,o,s=[];q=m.loading.indexOf(n);if(q!==-1){m.loading.splice(q,1)}q=m.loaded.indexOf(n);if(q===-1){m.loaded.push(n);for(r=0,p=m.waiting.length;r<p;r++){o=m.waiting[r];if(n.src===o.src){s.push(o);m.loaded.push(o)}}for(r=0,p=s.length;r<p;r++){k.loadItemImage(s[r])}}};j=m.waiting.indexOf(n);if(j!==-1){m.waiting.splice(j,1)}if(m.loaded.indexOf(n)!==-1){n.onLoad();l()}else{n.onLoading();m.loading.push(n);e.createElement("img",{styles:{display:"none"},events:{load:function(){n.onLoad();this.destroy();l()},error:function(){n.onError();this.destroy();l()}}}).inject(document.body).setAttribute("src",n.src)}},onPostInject:function(){this.refreshItems()},onResize:function(){this.itemPerPage=0;this.refreshScroller()},onItemClick:function(l,k){var j=this;if(k&&j.showItem(k)){i.stop(l)}j.refreshPager()},onMouseDown:function(j){i.preventDefault(j)}});f.Full=f.extend({buildItem:function(l){var j,k=this._parent(l),m=k.getElement(".content");j=e.createElement("div",{"class":"description ellipsis",html:{tag:"div",html:c.stripTags(l.content)}}).inject(m);this.addEllipsis({reference:j,element:j.getElement("div")});this.buildItemImage(l,"image").inject(k,"top");return k}});f.Presentable=f.Full.extend({presentedItem:null,buildSkeleton:function(){return this._parent().grab(this.buildItemTop(),"top")},buildItemTop:function(){this.elements.top=e.createElement("div",{"class":"top",html:{tag:"div","class":"actions",html:{tag:"div","class":"readMore action",html:{tag:"a",text:e.i18n(this.options.messages.readMore)}}}});return this.elements.top},showItem:function(l){var k,j=this.elements.top;this._parent(l);if(!this.presentedItem||this.presentedItem.getData("item-index")!==l.index){if(this.presentedItem){this.presentedItem.remove()}k=this.buildItem(l);k.inject(j,"top");j.getElement(".readMore").getElement("a").setAttribute("href",l.link);this.presentedItem=k;this.loadItemsImages();return true}}});f.Adapter={};f.Adapter.Abstract=b.extend({init:function(j){this.object=j},hasMore:function(){return false},isItemRead:function(){return false},setItemRead:function(){return false},getItems:function(){return[]},getLink:function(){return null}});f.Adapter.Feed=f.Adapter.Abstract.extend({getItems:function(){return this.object.getItems()},isItemRead:function(j){return this.object.isItemRead(j.index)},setItemRead:function(j){return this.object.setItemRead(j.index)},getLink:function(){return this.object.getLink()}});return e.namespace("Controls/FeedView",f,e,true)});