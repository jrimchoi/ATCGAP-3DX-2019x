define("UWA/Controls/SchemaForm",["UWA/Core","UWA/Array","UWA/Class","UWA/Promise","UWA/Controls/Abstract","UWA/Controls/SchemaForm/Inputs","UWA/Controls/SchemaForm/Sanitizers","UWA/Controls/SchemaForm/Validators","UWA/Controls/Input"],function(e,b,a,j,g,k,d,c,i){var f,h;f=g.extend({name:"uwa-schemaform",fields:null,onChangePaused:false,isPropagatingChanges:false,options:{schema:null,initialValue:{},inputs:k,sanitizers:d,validators:c,submitButton:true,clearButton:false,data:null,baseInputOptions:{}},init:function(l){this._parent(l);this._initFields()},_initFields:function(){this.fields={};Object.keys(this.options.schema.fields).forEach(function(m){var l=this.options.initialValue&&this.options.initialValue[m];this.fields[m]=new h(this,m,this.options.schema.fields[m],l)},this)},getContent:function(){if(!this.elements.container){this._buildContent()}return this.elements.container},buildNotice:function(m,l,n){l=l?l:"tooltip";if(!this.notices[n]){this.notices[n]=e.createElement("div",{"class":this.getClassNames("-notice uwa-icon "+l),html:m})}else{this.notices[n].innerHTML=m}this.notices[n].inject(n?this.fields[n].getContent():this.elements.container)},_buildContent:function(){var l=this;this.elements.container=e.createElement("div",{"class":this.getClassNames()});this.notices={};if(this.options.schema.notice){this.buildNotice(this.options.schema.notice.text,this.options.schema.notice.icon)}Object.keys(this.fields).forEach(function(m){this.elements.container.addContent(this.fields[m].getContent());if(this.fields[m].schema.input.options&&this.fields[m].schema.input.options.hidden){this.fields[m].getContent().hide()}},this);if(this.options.submitButton||this.options.clearButton){this.elements.buttonContainer=e.createElement("div",{"class":this.getClassNames("-buttons")}).inject(this.elements.container);if(this.options.clearButton){this.elements.clearButton=new i.Button(e.merge({_root:false,value:"Clear",events:{onClick:function(){l.clearValue()}}},this.options.baseInputOptions)).inject(this.elements.buttonContainer)}if(this.options.submitButton){this.elements.submitButton=new i.Button(e.merge({_root:false,value:"Submit",events:{onClick:function(){l.isValid().then(function(){l.dispatchEvent("onSubmit",[{value:l.getValue()}])})}}},this.options.baseInputOptions)).inject(this.elements.buttonContainer)}}return this.elements.container},getValue:function(){var l={};Object.keys(this.fields).forEach(function(m){l[m]=this.fields[m].getValue()||null},this);return l},getDisplayValue:function(){var l={};Object.keys(this.fields).forEach(function(m){l[m]=this.fields[m].getDisplayValue()},this);return l},getFieldValue:function(m){var l=this.fields[m];return l?l.getValue():null},setFieldValue:function(m,l){if(this.fields[m]){this.fields[m].setValue(l);this._onFieldChanged(m)}},setFieldTitle:function(m,l){if(this.fields[m]){this.fields[m].setTitle(l)}},getValidatedValue:function(){var l=this.getValue();return this.isValid().then(function(){return l})},getValidatedFieldValue:function(m){var l=this.fields[m];return l.isValid().then(function(){return l.getValue()})},setValue:function(l){this.onChangePaused=true;l=l||{};Object.keys(this.fields).forEach(function(m){if(l.hasOwnProperty(m)){this.fields[m].setValue(l[m])}},this);this.updateValidityMessages();this.onChangePaused=false},clearValue:function(){this.onChangePaused=true;Object.keys(this.fields).forEach(function(l){this.fields[l].setValue(null)},this);this.updateValidityMessages();this.onChangePaused=false},isValid:function(){return j.allSettled(Object.keys(this.fields).map(function(l){return this.fields[l].isValid().fail(function(m){return j.reject(Object.assign(m,{fieldName:l}))})},this)).then(function(l){var m={};l.forEach(function(n){if(n.state==="rejected"){m[n.reason.fieldName]=n.reason}});if(Object.keys(m).length!==0){throw Object.assign(new Error("There is an error within a field"),{fieldErrors:m})}})},updateValidityMessages:function(){Object.keys(this.fields).forEach(function(l){this.fields[l].updateValidityMessage({forceValidation:true})},this)},getSchemaformData:function(){return this.options.data},_createContextForField:function(){var l={getFieldValue:this.getFieldValue.bind(this),setFieldValue:this.setFieldValue.bind(this),getValidatedFieldValue:this.getValidatedFieldValue.bind(this),getSchemaformData:this.getSchemaformData.bind(this),hideField:this.hideField.bind(this),showField:this.showField.bind(this),buildNotice:this.buildNotice.bind(this),addValidityMessage:this.addValidityMessage.bind(this),hideValidityMessage:this.hideValidityMessage.bind(this),setFieldTitle:this.setFieldTitle.bind(this)};return l},addValidityMessage:function(m,l){if(this.fields[m]){this.fields[m].addValidityMessage(l)}},hideValidityMessage:function(l){if(this.fields[l]){this.fields[l].hideValidityMessage()}},hideField:function(l){if(this.fields[l]){this.fields[l].getContent().hide()}},showField:function(l){if(this.fields[l]){this.fields[l].getContent().show()}},_executeSanitizers:function(p,n,o){var m=this;var l=o;var q=this._getSanitizersFor(p);q.forEach(function(t){var s=m._evaluateOptions(t,n),r=m.options.sanitizers[t.id];l=r(l,s)});return l},_executeValidators:function(q,o,p){var n=this;var l;var m=this._getValidatorsFor(q);l=j.all(m.map(function(r){var u=n._evaluateOptions(r,o),s=n.options.validators[r.id],t=s.bind(null,p,u,q);return j.resolve().then(t)}));return l},_getSanitizersFor:function(l){return l.sanitizers?l.sanitizers:l.sanitizer?[l.sanitizer]:[]},_getValidatorsFor:function(l){return l.validators?l.validators:l.validator?[l.validator]:[]},_evaluateOptions:function(r,q){var m;if(r.computedOptions){m={};var l=r.computedOptions;for(var p in l){if(l.hasOwnProperty(p)){var s=l[p],n=s.sourceFieldName,o=this.getFieldValue(n);o=this._executeSanitizers(s,q,o);m[p]=o}}if(r.options){m=e.merge(m,r.options)}}else{if(r.options){m=r.options}else{m={}}}m=e.merge(m,{context:q});return m},_findDependencies:function(q){if(!q){return[]}var u=[];if(q.computedOptions){var r=q.computedOptions;for(var m in r){if(r.hasOwnProperty(m)){var p=r[m],o=this._getSanitizersFor(p);if(typeof(p.sourceFieldName)==="string"&&p.sourceFieldName!==""){u.push(p.sourceFieldName)}if(o){for(var t=0;t<o.length;t++){var l=o[t],n=this._findDependencies(l);u=u.concat(n)}}}}}return u},_onFieldChanged:function(l){if(this.isPropagatingChanges){return}this._propagateChanges([l]);if(!this.onChangePaused){this.dispatchEvent("onChange",[{value:this.getValue()}])}},_propagateChanges:function(n){this.isPropagatingChanges=true;var m=0;while(n.length){var q=[];for(var o=0;o<Object.keys(this.fields).length;o++){var r=Object.keys(this.fields)[o],p=this.fields[r],l=p.onFieldsChanged(n);if(l){q.push(r)}}n=q;if(++m>500){throw new Error("I reckon there might be some good old cyclical references in your computedOptions, partner.")}}this.isPropagatingChanges=false},destroy:function(){Object.keys(this.fields).forEach(function(l){this.fields[l].destroy()},this);this._parent()}});h=a.extend({host:null,schema:null,elements:null,fallbackValue:undefined,context:null,dependencies:null,validationCacheIsFor:null,cachedValidationPromise:null,init:function(o,q,p,m){var n=this;this.host=o;this.schema=p;this.name=q;this.elements={};this.fallbackValue=m;this.context=o._createContextForField(this);function l(s){var r=[];s.forEach(function(t){r=r.concat(n.host._findDependencies(t))});return r}this.dependencies={input:this.host._findDependencies(this.schema.input),sanitizer:l(this.host._getSanitizersFor(this.schema)),validator:l(this.host._getValidatorsFor(this.schema))}},getContent:function(){if(!this.elements.container){this._buildContent()}return this.elements.container},_buildContent:function(){this.elements.container=e.createElement("div",{"class":this.host.getClassNames("-field")+" input-"+this.schema.input.id});this.elements.validityMessage=e.createElement("div",{"class":this.host.getClassNames("-field-validity-message")}).inject(this.elements.container);this.elements.title=e.createElement("div",{"class":this.host.getClassNames("-field-title"),text:this.schema.title}).inject(this.elements.container);this.elements.inputWrapper=e.createElement("div",{"class":this.host.getClassNames("-field-wrapper")}).inject(this.elements.container);this._buildInput();if(this.schema.notice){this.context.buildNotice(this.schema.notice.text,this.schema.notice.icon,this.name)}},setTitle:function(l){if(this.elements.title){this.elements.title.setText(l)}},_buildInput:function(){if(this.elements.control){this.elements.control.destroy();this.elements.inputWrapper.empty()}var m=this.host.options.inputs[this.schema.input.id];var l=e.clone(this.host._evaluateOptions(this.schema.input,this.context));Object.assign(l,this.host.options.baseInputOptions,{_root:false,context:this.context,schema:this.schema,name:this.name});if(this.fallbackValue){Object.assign(l,{value:this.fallbackValue})}this.elements.control=new m(l).inject(this.elements.inputWrapper);if(this.elements.control.addEvent){this.elements.control.addEvent("onChange",function(){this.fallbackValue=this.elements.control.getValue();this.updateValidityMessage();this.host._onFieldChanged(this.name)},this)}},_isValidationCacheUpToDate:function(){return(this.cachedValidationPromise&&this.validationCacheIsFor===this._getRawValue())},getValue:function(){return this._sanitize(this._getRawValue())},getDisplayValue:function(){if(this.elements.control&&this.elements.control.getDisplayValue){return this.elements.control.getDisplayValue()}else{return this._getRawValue()}},_getRawValue:function(){if(this.elements.control){return this.elements.control.getValue()}else{return this.fallbackValue}},_sanitize:function(l){return this.host._executeSanitizers(this.schema,this.context,l)},setValue:function(l){if(this.elements.control){this.elements.control.setValue(l)}else{this.fallbackValue=l}},isEmpty:function(){if(this.elements.control){return this.elements.control.isEmpty()}return true},isValid:function(){var l=this.host._getValidatorsFor(this.schema).filter(function(m){return m.id==="one-of"}).length;if(!this._isValidationCacheUpToDate()||l){this.validationCacheIsFor=this._getRawValue();this.cachedValidationPromise=this.host._executeValidators(this.schema,this.context,this.getValue())}return this.cachedValidationPromise},updateValidityMessage:function(m){var l=this;if(this.fallbackValue!==undefined||(m&&m.forceValidation)){this.isValid().then(function(){l.hideValidityMessage()},function(n){l.addValidityMessage(n)})}},addValidityMessage:function(l){if(this.elements.validityMessage){this.elements.validityMessage.textContent=l.message;this.elements.container.addClassName("invalid")}},hideValidityMessage:function(){if(this.elements.validityMessage){this.elements.validityMessage.textContent="";this.elements.container.removeClassName("invalid")}},onFieldsChanged:function(o){var n=this;var m=false;function l(q){var p=n.dependencies[q];return o.some(function(r){return p.indexOf(r)>-1})}if(l("input")&&this.elements.container){m=true;this._buildInput()}if(l("sanitizer")){m=true}if(l("validator")){this.validationCacheIsFor=null;this.updateValidityMessage()}return m},destroy:function(){if(this.elements.container){this.elements.container.destroy();if(this.elements.control.destroy){this.elements.control.destroy()}}}});return e.namespace("Controls/SchemaForm",f,e,"replace")});