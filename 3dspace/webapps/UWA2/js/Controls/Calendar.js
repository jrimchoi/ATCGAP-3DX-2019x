define("UWA/Controls/Calendar",["UWA/Core","UWA/Date","UWA/Event","UWA/Controls/Abstract","UWA/String"],function(c,f,h,e,b){var g=c.i18n,a;function d(m,k){var l=!m,j=!k;return l===j&&(l||(m.getFullYear()===k.getFullYear()&&m.getMonth()===k.getMonth()&&m.getDate()===k.getDate()))}function i(k,l,m){var j=k.getDate();if(m===undefined){m=1}if(l==="year"){m*=12;l="month"}else{if(l==="week"){m*=7;l="day"}}if(l==="month"){k.setDate(1);k.setMonth(k.getMonth()+m+1);k.setDate(0);if(j<k.getDate()){k.setDate(j)}}else{if(l==="day"){k.setDate(j+m)}else{throw new Error('Unknown unit "'+l+'"')}}}a=e.extend({name:"uwa-calendar",defaultOptions:{view:"month",weekFirstDay:"monday",limit:{}},weekOffset:{monday:1,sunday:0,saturday:6},init:function(j){this._parent(j);this.buildSkeleton();this.bound={refreshLimit:this.refreshLimit.bind(this)};this.setLimit(this.options.limit);this.setDate(this.options.date);this.displayView(this.options.view)},getWeekOffset:function(){return this.weekOffset[this.options.weekFirstDay]||0},getMonthFirstDay:function(){var k=this.displayDate,j=new Date(k.getFullYear(),k.getMonth(),1);return(j.getDay()-this.getWeekOffset()+7)%7},getWeekFirstDay:function(){var j=this.displayDate;return j.getDate()-(7+j.getDay()-this.getWeekOffset())%7},iterateWeek:function(k,p){var o,m=this.displayDate,j=new Date(m.getFullYear(),m.getMonth(),this.getWeekFirstDay()),l=j.getDate();for(o=0;o<7;o+=1){var n=new Date(j);n.setDate(l+o);k.call(p,o,n)}return this},displayView:function(j){if(["month","week"].indexOf(j)<0){throw new Error("Unknown view "+j+"options")}if(j!==this.currentView){this.container.setContent(this["build"+b.ucfirst(j)+"View"]());this.currentView=j;this.dispatchEvent("onRefresh")}return this},setDate:function(j,k){if(!k){if(!j){j=new Date();j.setHours(0);j.setMinutes(0);j.setSeconds(0);j.setMilliseconds(0)}k=j}var l=!d(j,this.selectDate);if(l||!d(k,this.displayDate)){this.selectDate=j;this.displayDate=k;this.dispatchEvent("onRefresh");if(l){this.dispatchEvent("onDateChange",[j])}}return this},getDate:function(){return this.selectDate||null},setLimit:function(j){if(!j){j={}}var k=this.options.limit;this.options.limit=j;[k.max,k.min,j.max,j.min].forEach(function(m,n){if(m instanceof a){m[n<2?"removeEvent":"addEvent"]("onDateChange",this.bound.refreshLimit)}},this);this.refreshLimit();return this},getLimit:function(){var m,l,n,k=this.options.limit||{},j={};for(m=0;m<2;m+=1){l=m?"max":"min";n=k[l];j[l]=(n&&new Date((n.getTime||n.getDate||n).call(n)).getTime())||(m?Infinity:-Infinity)}j.min-=86400000;return j},refreshLimit:function(){var j=this.getLimit();if(j.end<j.start){throw new Error("Bad limit specified")}if(this.selectDate){this.preventRefresh();this.setDate(new Date(Math.max(Math.min(j.max,this.selectDate),j.min)));this.allowRefresh()}return this.dispatchEvent("onRefresh")},preventRefresh:function(){this.doNotRefresh=this.doNotRefresh+1||1;return this},allowRefresh:function(){this.doNotRefresh=this.doNotRefresh-1||0;return this},buildSkeleton:function(){this.container=c.createElement("div",{"class":this.getClassNames(),events:{click:this.onClick.bind(this),mousedown:h.preventDefault}})},buildMonthView:function(){var m,o,q,k=c.createElement("div",{"class":"monthView"}),n=c.createElement("div",{"class":"top"}).inject(k),l=c.createElement("table").inject(k),j=c.createElement("tbody").inject(l),p=c.createElement("tr").inject(j);this.iterateWeek(function(s,r){c.createElement("th",{text:f.strftime(r,"%a")[0]}).inject(p)});for(o=0;o<42;o+=1){if(o%7===0){m=c.createElement("tr").inject(j)}q=c.createElement("td").inject(m);c.createElement("div",{"class":"day"}).inject(q)}c.createElement("span",{"class":"previous uwa-icon","data-icon":"l"}).inject(n);c.createElement("span",{"class":"title"}).inject(n);c.createElement("span",{"class":"next uwa-icon","data-icon":"m"}).inject(n);this.elements.monthView=k;return k},buildWeekView:function(){var m,o,k=c.createElement("div",{"class":"weekView"}),n=c.createElement("div",{"class":"top"}).inject(k),l=c.createElement("table").inject(k),j=c.createElement("tbody").inject(l),p=c.createElement("tr").inject(j);this.iterateWeek(function(r,q){c.createElement("th",{text:f.strftime(q,"%a")[0]}).inject(p)});for(o=0;o<7;o+=1){if(o%7===0){m=c.createElement("tr").inject(j)}c.createElement("td",{html:{tag:"div","class":"day"}}).inject(m)}c.createElement("span",{"class":"previous",text:"←"}).inject(n);c.createElement("span",{"class":"title"}).inject(n);c.createElement("span",{"class":"next",text:"→"}).inject(n);this.elements.weekView=k;return k},refreshMonthView:function(){var n,j,k=this.displayDate,m=new Date(k.getFullYear(),k.getMonth(),-this.getMonthFirstDay()),p=this.elements.monthView,o=p.getElements(".day");for(n=0,j=o.length;n<j;n+=1){m.setDate(m.getDate()+1);o[n]=this.buildDay(o[n],m)}p.getElement("tbody").getElements("tr")[6][m.getDate()>6?"hide":"show"]();p.getElement(".title").setText(f.strftime(k,g("%B %Y")))},refreshWeekView:function(){var p,k,q,n=this.displayDate,o=new Date(n.getFullYear(),n.getMonth(),this.getWeekFirstDay()),m=f.strftime(o,g("%e %B")),j=this.elements.weekView,r=j.getElements(".day");for(p=0,k=r.length;p<k;p+=1){r[p]=this.buildDay(r[p],o);o.setDate(o.getDate()+1)}o.setDate(o.getDate()-1);q=f.strftime(o,g("%e %B %Y"));j.getElement(".title").setText(m+" - "+q)},buildDay:function(l,n){var k=new Date(),m=this.displayDate,j=this.getLimit(),o=l.getClosest("td");o.toggleClassName("currentDay",d(n,m)).toggleClassName("selectDate",d(n,this.selectDate)).toggleClassName("today",d(n,k)).toggleClassName("currentMonth",n.getMonth()===m.getMonth()).toggleClassName("disabled",n<j.min||n>j.max);l.setText(n.getDate());return l},onRefresh:function(){var j=this.currentView;if(j&&!this.doNotRefresh){this["refresh"+b.ucfirst(j)+"View"]()}},onClick:function(n){var o,l=this.container,m=h.getElement(n),k=m.hasClassName("next")?1:m.hasClassName("previous")?-1:0,j=new Date(this.displayDate);if(!m.getClosest(".disabled")){if(m.hasClassName("day")){o=l.getElements(".day");i(j,"day",o.indexOf(m)-o.indexOf(l.getElement(".currentDay .day")));this.setDate(j);this.dispatchEvent("onDateSelect",[j])}else{if(k){i(j,this.currentView,k);this.setDate(this.selectDate,j)}}}}});return c.namespace("Controls/Calendar",a,c)});