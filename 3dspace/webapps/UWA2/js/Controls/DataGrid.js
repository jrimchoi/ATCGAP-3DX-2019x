define("UWA/Controls/DataGrid",["UWA/Core","UWA/Event","UWA/String","UWA/Element","UWA/Controls/Abstract","UWA/Controls/Scroller"],function(e,i,c,b,f,d){function g(k){var j=e.createElement(k.tag||"th",{"class":k.dataIndex,html:{tag:"span",html:k.text}});if(k.sortable){var l=e.createElement("span",{"class":"sort",text:""}).inject(j);j.addClassName("sortable");if(k.isSorted){l.setText(k.sortReverse?"D":"E")}}else{j.addClassName("no-sortable");if(!k.text){j.addClassName("empty")}}if(k.className){j.addClassName(k.className)}if(k.isFirst){j.addClassName("first")}if(k.color){j.setStyles({"background-color":k.color,color:"#FFFFFF"})}return j}function a(l){var j=e.createElement(l.tag||"td",{"class":l.dataIndex,"data-itemId":l.itemId,html:l.format?l.format(l.text):l.text});if(l.className){j.addClassName(l.className)}if(l.isFixed){j.addClassName("is-fixed")}if(l.isFirst){j.addClassName("first")}else{j.addClassName("grid-data")}if(l.color){var k=c.hexToRgb(l.color,true);j.setStyle("background-color","rgba("+k.toString()+",0.2)")}return j}var h=f.extend({defaultOptions:{className:"",data:null,columns:null,sortable:false,orderBy:"",sortReverse:false,scrollerOptions:{}},name:"uwa-datagrid",dataGrid:null,columns:null,init:function(j){this._parent(j);this.dataGrid=j.data;this.columns=j.columns;this.buildSkeleton();this.fillGrid();this.initEvents()},buildSkeleton:function(){var j=this.options,k=this.elements;k.container=e.createElement("div",{"class":this.getClassNames()});k.grid=e.createElement("table",{"class":this.getClassNames("-table")}).inject(k.container);if(j.sortable){k.grid.addClassName("sortable")}},initEvents:function(){this.elements.container.addEvent("click",this.handleEvent.bind(this))},handleEvent:function(j){var k=i.getElement(j).getClosest("th");if(this.options.sortable&&k&&!k.hasClassName("no-sortable")){this.onOrderColumn(k.className.split(" ")[0])}},fillGrid:function(){this.fillHeader();this.fillBody()},fillHeader:function(){var m,k,o,n=this.elements,j=this.columns;n.grid.empty();o=e.createElement("tr").inject(n.grid);for(m=0,k=j.length;m<k;m++){g({isSorted:this.options.orderBy===j[m].dataIndex,sortReverse:this.options.sortReverse,className:j[m].className,dataIndex:j[m].dataIndex,text:j[m].text,isFirst:j[m].isFirst,sortable:this.options.sortable&&!j[m].noSortable,color:j[m].color}).inject(o)}},fillBody:function(){var r,n,p,o,s,m=this.elements,v=this.options,t=this.columns,q=this.dataGrid;if(v.sortable&&v.orderBy){q=this.sortData()}for(r=0,n=q.length;r<n;r++){s=e.createElement("tr").inject(m.grid);for(p=0,o=t.length;p<o;p++){var u=q[r][t[p].dataIndex];a({text:u,isFixed:q[r].isFixed||t[p].isFixed,className:(q[r].className||"")+" "+(t[p].className||""),dataIndex:t[p].dataIndex,itemId:e.is(u,"object")&&u.itemId,format:t[p].format,isFirst:t[p].isFirst,color:t[p].color}).inject(s)}}},sortData:function(){var k=this.options,l=this.dataGrid,j=this.columns.filter(function(m){return m.dataIndex===k.orderBy})[0];l.sort(function(n,m){var p,o;p=j.sortKey?j.sortKey(n[k.orderBy]):n[k.orderBy];o=j.sortKey?j.sortKey(m[k.orderBy]):m[k.orderBy];if(p<o){return(!k.sortReverse)?-1:1}if(p>o){return(!k.sortReverse)?1:-1}return 0});return l},onOrderColumn:function(k){var j=this.options;if(j.orderBy===k){j.sortReverse=!j.sortReverse}else{j.sortReverse=false}j.orderBy=k;this.fillGrid();if(this.scroller){this.scroller.updateFixedHeaders(this.elements.grid)}this.dispatchEvent("updateSortOptions",j)},updateData:function(j,k){this.dataGrid=k;this.columns=j;this.fillGrid();if(this.scroller){this.updateScroller()}},addScroller:function(){this.scroller=new h.GridScroller(this.elements.grid,e.extend({_root:false},this.options.scrollerOptions))},updateScroller:function(){if(this.scroller){this.scroller.destroy()}this.addScroller()}});h.GridScroller=d.extend({defaultOptions:{lockDirection:false},init:function(j){this._parent.apply(this,arguments);this.updateFixedHeaders(j)},_buildFixedHeaders:function(j){var m=this._getFixedHeadersSize(j),l=m.top,k=m.left;if(m.left){m.left=this._buildFixedHeader(j,m.left,Infinity)}if(m.bottom){m.bottom=this._buildFixedHeader(j,Infinity,-m.bottom)}if(m.right){m.right=this._buildFixedHeader(j,-m.right,Infinity)}if(m.top){m.top=this._buildFixedHeader(j,Infinity,m.top);if(m.left){m.topLeft=this._buildFixedHeader(j,k,l)}}this._fixedHeaders=m},_isHeaderCell:function(j){return b.getTagName.call(j)==="th"||b.hasClassName.call(j,"is-fixed")},_getFixedHeadersSize:function(l){var j={top:0,bottom:0,left:Infinity,right:Infinity},m=true,k=this;b.getElements.call(l,"tr").forEach(function(p){var q=0,n=0,o=true;b.getChildren.call(p).forEach(function(r){if(k._isHeaderCell(r)){if(o){q++}n++}else{o=false;n=0}});j.left=Math.min(j.left,q);j.right=Math.min(j.right,n);if(o){if(m){j.top++}j.bottom++}else{m=false;j.bottom=0}});return j},_buildFixedHeader:function(o,m,k){function p(s,r){return r<0?s.slice(r):s.slice(0,r)}var j,n={tag:"tbody",html:[]},q={width:0,height:0},l=true;p(b.getElements.call(o,"tr"),k).forEach(function(t){var r={tag:"tr",html:[]},s=b.getDimensions.call(t);q.height+=s.outerHeight;n.html.push(r);p(b.getChildren.call(t),m).forEach(function(u){var v=b.getDimensions.call(u),w=u.cloneNode(true);b.setStyles.call(w,{width:v.innerWidth,height:v.innerHeight});if(l){q.width+=v.outerWidth}r.html.push(w)});l=false});j=o.cloneNode();b.set.call(j,{html:n,styles:q});b.addClassName.call(j,"fixed-column");this.elements.scroller.grab(j);return j},_updateHeaderPositions:function(j){var k=this._fixedHeaders;if(k.top){b.setPosition.call(k.top,{y:0,x:j.x})}if(k.left){b.setPosition.call(k.left,{y:j.y,x:0})}if(k.right){b.setPosition.call(k.right,{y:j.y,x:this.scroll.width-b.getSize.call(k.right).width})}if(k.bottom){b.setPosition.call(k.bottom,{x:j.x,y:this.scroll.height-b.getSize.call(k.bottom).height})}if(k.topLeft){b.setPosition.call(k.topLeft,{y:0,x:0})}},updateFixedHeaders:function(j){var k;if(this._fixedHeaders){for(k in this._fixedHeaders){if(this._fixedHeaders[k]){b.destroy.call(this._fixedHeaders[k])}}}this._buildFixedHeaders(j);this._updateHeaderPositions(this.position)},onScroll:function(){this._parent.apply(this,arguments);this._updateHeaderPositions(this.getPosition(true))}});return e.namespace("Controls/DataGrid",h,e)});