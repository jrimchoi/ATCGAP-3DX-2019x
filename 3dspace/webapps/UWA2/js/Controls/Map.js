define("UWA/Controls/Map",["UWA/Core","UWA/Utils","UWA/Array","UWA/Controls/Abstract","UWA/Class/Timed"],function(f,c,a,e,d){var b=e.extend(d,{id:null,api:null,map:null,defaultOptions:{width:320,height:240,className:"uwa-map",googleApiKey:null,api:{zoom:15}},init:function(h){this._parent(h);this.id=c.random(100000);this.apiCallbacks=[];if(!b.States.apiLoading&&!b.States.apiLoaded){b.States.apiLoading=true;var g="https://maps.google.com/maps/api/js?callback=UWA.Controls.Map.onApiLoad";if(this.options.googleApiKey){g+="&key="+this.options.googleApiKey}f.createElement("script",{type:"text/javascript",src:g}).inject(document.body)}this.setPeriodical("checkLoad",function(){if(b.States.apiLoaded){this.clearPeriodical("checkLoad");this.onApiReady()}},100);this.buildSkeleton()},buildSkeleton:function(){var g=this.options,h=this.elements;h.container=f.createElement("div",{id:"map_canvas"+this.id,"class":g.className,styles:{height:g.height+"px",width:g.width+"px"},events:{resize:this.dispatchEvent.bind(this,"onResize")}})},callApi:function(g){if(!b.States.apiLoaded){this.apiCallbacks.push(g)}else{g.call(this,this.api,this.map)}},setPosition:function(g){this.callApi(function(){this.map.setCenter(new this.api.LatLng(g.coords.latitude,g.coords.longitude))}.bind(this))},addMarker:function(g,j,i){var h=this;this.callApi(function(){var k=h.api,m=h.map,l=new k.InfoWindow({content:i});h.marker=new k.Marker({position:new k.LatLng(g.coords.latitude,g.coords.longitude),map:m,title:j});k.event.addListener(h.marker,"click",function(){l.open(m,h.marker)})})},onApiReady:function(){var g=this.options,h=this.elements;this.api=google.maps;this.map=new this.api.Map(h.container,f.extend({mapTypeControl:true,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU},navigationControl:true,navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL},mapTypeId:google.maps.MapTypeId.HYBRID},g.api));this.dispatchEvent("onLoad");if(this.apiCallbacks.length){a.invoke(this.apiCallbacks,"call",this,this.api,this.map);this.apiCallbacks.length=0}},onLoad:function(){},onResize:function(){this.setDelayed("resize",function(){if(this.map&&this.api){this.api.event.trigger(this.map,"resize")}},500)}});b.States={apiLoading:false,apiLoaded:false};b.onApiLoad=function(){b.States.apiLoading=false;b.States.apiLoaded=true};return f.namespace("Controls/Map",b,f)});