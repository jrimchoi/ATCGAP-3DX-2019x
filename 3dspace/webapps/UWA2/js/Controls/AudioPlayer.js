define("UWA/Controls/AudioPlayer",["UWA/Core","UWA/Utils","UWA/Utils/Client","UWA/Event","UWA/Element","UWA/Controls/Abstract","UWA/Controls/Flash","UWA/Controls/Slider"],function(d,h,b,i,a,f,c,e){var j=0;var g=f.extend({name:"uwa-audioplayer",defaultOptions:{url:"",autoPlay:false,handleButton:true,closeButton:true,preload:"none",className:"",isTouch:b.Features.touchEvents,player:{html:[{tag:"div","class":"uwa-icon play-pause"},{tag:"div","class":"controls-times",html:[{tag:"span","class":"played",text:"00:00"},{tag:"span","class":"duration duration-hide",text:"00:00"}]},{tag:"div","class":"controls-slider"},{tag:"div","class":"controls-right",html:{tag:"div","class":"uwa-icon close close-hide"}}],playPauseClass:"play-pause",timeClass:"time",durationClass:"duration",playedClass:"played",errorMessageClass:"error-message",playingClass:"playing",waitingClass:"waiting",errorClass:"error",closeClass:"close"}},adapter:null,init:function(k){var l=this;this.id=j;j++;d.Controls.AudioPlayer.Instances["x"+this.id]=this;k=k||{};this._parent(k);this.eventNames={start:this.options.isTouch?"touchstart":"mousedown",move:this.options.isTouch?"touchmove":"mousemove",end:this.options.isTouch?"touchend":"mouseup"};this.body=k.body||document.body;this.buildSkeleton();this.attachEvents();this.reset();if(this.options.url){this[this.options.autoPlay?"play":"load"]()}this.container.addEvent("resize",function(){var n=30,m=10,r=7,p,u,v,o,s,t,q;p=l.elements;p.slider.show();p.controlsTimes.show();p.controlsRight.show();u=l.container.getSize().width;v=p.playPause.getSize().width;o=p.slider.getSize().width;s=p.controlsTimes.getSize().width;t=p.controlsRight.getSize().width;if(o<n){p.slider.hide();q=v+s+t;if(q>u-m){p.controlsTimes.hide();q-=s;if(q>u-r){p.controlsRight.hide()}}}})},getAdapter:function(l){var n,k,m=d.Controls.AudioPlayer.Adapter;for(n in m){if(m.hasOwnProperty(n)){if(!k&&m[n].isAvailable(l)){k=m[n]}}}if(!k){window.open(l)}else{if(!this.adapter){this.adapter=k.build(this)}this.adapter.setUrl(l);return this.adapter}},buildSkeleton:function(){var l,n,o=this,m=o.options,k=m.player;l=d.createElement("div",{"class":this.getClassNames(),html:m.player.html});n=l.getElement.bind(l);o.elements={playPause:n(".play-pause"),slider:null,controlsTimes:n(".controls-times"),controlsRight:n(".controls-right"),played:n("."+k.playedClass),duration:n("."+k.durationClass),play:n("."+k.playPauseClass),close:n("."+k.closeClass)};if(o.options.closeButton){o.elements.close.removeClassName("close-hide")}o.container=l;return o},attachEvents:function(){var k=this,l=k.elements,m=k.dispatchEvent.bind(k);l.play.addEvent("click",m.bind(k,"onPlayPause"));if(this.options.closeButton){l.close.addEvent("click",m.bind(k,"close"))}k.slider=new e({_root:false,container:k.container,events:{onChange:function(o){var n=(o*k.adapter.getDuration())/100;k.adapter.setCurrentTime(n);l.played.setText(k.formatTime(n))}}});k.elements.slider=k.slider.elements.scrubber;return this},reset:function(){var k=this,l=k.elements;k.loadedPercent=0;k.canPlay=false;k.shouldPlay=false;l.duration.setText(k.formatTime(0));l.played.setText(k.formatTime(0))},load:function(k){k=k||this.options.url;this.stop();this.reset();this.show();this.adapter=this.getAdapter(k)},play:function(k,l){this.load(k,l);this.adapter.play();this.shouldPlay=true},pause:function(){if(this.adapter){this.adapter.pause()}this.shouldPlay=false},stop:function(){if(this.adapter){this.adapter.stop();this.slider.reset()}},close:function(){this.stop();this.slider.reset();this.hide()},onPlayPause:function(){if(this.adapter){this.adapter[this.adapter.isPaused()?"play":"pause"]()}},onPlay:function(){this.container.addClassName(this.options.player.playingClass).removeClassName("paused");if(!this.canPlay){this.container.addClassName(this.options.player.waitingClass)}this.shouldPlay=true},onPause:function(){this.container.removeClassName(this.options.player.waitingClass).removeClassName(this.options.player.playingClass).addClassName("paused");this.shouldPlay=false},onCanPlay:function(){if(this.options.preload||this.options.preload!=="none"){this.trackLoadProgress()}this.container.removeClassName(this.options.player.waitingClass);this.canPlay=true;if(this.shouldPlay&&this.adapter&&this.adapter.isPaused()){this.adapter.play()}},onMetadataLoaded:function(){this.elements.duration.setText(this.formatTime(this.adapter.getDuration()))},onTimeUpdate:function(){this.elements.played.setText(this.formatTime(this.adapter.getCurrentTime()));var k=this.adapter.getCurrentTime()*100/this.adapter.getDuration();this.slider.setValue(k)},trackLoadProgress:function(){if(this.loadTimer){clearTimeout(this.loadTimer)}if(this.loadedPercent<1){this.loadTimer=setTimeout(function(){this.onLoadProgress();this.trackLoadProgress()}.bind(this),400)}},onLoadProgress:function(){this.loadedPercent=this.adapter?this.adapter.getLoadProgress():0;if(this.loadedPercent){this.slider.setLoadedValue(this.loadedPercent)}},formatTime:function(m){var n=parseInt(m,10),l=Math.floor(n/60,10),k=n-l*60;k=!isNaN(k)?k:0;l=!isNaN(l)?l:0;return l+":"+(k<10?"0"+k:k)}});g.Instances={};g.Adapter={audio:{audioTag:null,isAvailable:function(k){var l=document.createElement("audio");if(l.canPlayType){return(/\.mp3$/.test(k)&&""!==l.canPlayType("audio/mpeg"))||(/\.m4a$/.test(k)&&""!==l.canPlayType("audio/x-m4a"))||(/\.ogg$/.test(k)&&""!==l.canPlayType('audio/ogg; codecs="vorbis"'))}return false},build:function(k){this.audioTag=d.createElement("audio",{id:"uwa-audioplayer-audio-"+k.id,preload:k.options.preload,events:{play:k.onPlay.bind(k),pause:k.onPause.bind(k),ended:function(){k.pause();k.elements.played.setText(k.formatTime(0));k.slider.reset()},timeupdate:function(){k.dispatchEvent("onTimeUpdate");k.onLoadProgress()},loadedmetadata:k.onMetadataLoaded.bind(k),canplay:k.dispatchEvent.bind(k,"onCanPlay")}}).setStyles({position:"absolute",top:"-100000px"});this.audioTag.inject(k.container);return this},isPaused:function(){return this.audioTag.paused},play:function(){this.audioTag.play()},pause:function(){this.audioTag.pause()},stop:function(){this.audioTag.pause()},setCurrentTime:function(l){try{this.audioTag.currentTime=l}catch(k){}},getCurrentTime:function(){return this.audioTag.currentTime},getDuration:function(){return this.audioTag.duration},getLoadProgress:function(){var l=0,k=this.audioTag;if(k&&k.buffered&&k.buffered.length>0&&k.buffered.end&&k.duration){l=k.buffered.end(0)/k.duration}else{if(k&&k.bytesTotal!==undefined&&k.bytesTotal>0&&k.bufferedBytes!==undefined){l=k.bufferedBytes/k.bytesTotal}}return l*100},setVolume:function(k){this.audioTag.volume=parseFloat(k/200)},getVolume:function(){return this.audioTag.volume*200},setUrl:function(k){this.audioTag.src=k;this.audioTag.load()}},flash:{flashTag:null,isAvailable:function(k){return c.prototype.detectFlashVersion().major!==0&&/\.mp3$/.test(k)},build:function(o){var l,m="uwa-audioplayer-flash-"+o.id,k=new c({_root:false,id:m,url:d.hosts.uwa+"/lib/UWA/assets/img/flash/player_mp3_js.swf",width:1,height:1,flashVars:"listener=UWA.Controls.AudioPlayer.Instances.x"+o.id+".adapter.listener&interval=750&userexternalinterface=1",allowScriptAccess:"always"});this.pendingVariables=[];this.control=o;this.listener={isPlaying:false,ready:false,onInit:this.onReady.bind(this),onUpdate:function(){o.onMetadataLoaded();o.dispatchEvent("onTimeUpdate");o.onLoadProgress()}};this.flashTag=k.getFlashContainer();this.flashTag.setStyles({position:"absolute",top:"-100000px"});if(b.Engine.ie){try{l=document.createElement("<script for="+m+" event=FSCommand(command,args)><\/script>");l.text="eval(args);";document.body.appendChild(l)}catch(n){}}this.flashTag.inject(o.container);return this},SetVariable:function(k,m){var l=this;if(!l.listener.ready){l.pendingVariables.push([k,m]);return}l.variableTimers=l.variableTimers||{};try{clearTimeout(l.variableTimers[k]);l.flashTag.SetVariable(k,m)}catch(n){l.variableTimers[k]=setTimeout(function(){l.flashTag.SetVariable(k,m)},500)}},onReady:function(){this.listener.ready=true;this.pendingVariables.forEach(function(k){this.SetVariable.apply(this,k)},this);this.control.dispatchEvent("onCanPlay")},isPaused:function(){return this.listener.isPlaying!=="true"},play:function(){this.SetVariable("enabled","true");this.SetVariable("method:play");this.control.onPlay()},pause:function(){this.SetVariable("method:pause");this.control.onPause()},stop:function(){this.SetVariable("method:setPosition",0);this.SetVariable("method:stop");this.control.onPause()},setCurrentTime:function(k){this.SetVariable("enabled","false");this.SetVariable("method:setPosition",Math.round(k*1000));this.SetVariable("enabled","true")},getCurrentTime:function(){return this.listener.position/1000},getDuration:function(){return this.listener.duration/1000},getLoadProgress:function(){var k=this.listener.bytesPercent;return isNaN(k)?100:k},setVolume:function(k){k=(!isNaN(k)?k:100);this.SetVariable("method:setVolume",k)},getVolume:function(){return this.listener.volume},setUrl:function(k){this.SetVariable("method:setUrl",k)}}};return d.namespace("Controls/AudioPlayer",g,d)});