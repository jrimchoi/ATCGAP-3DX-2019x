define("UWA/Controls/Autocomplete",["UWA/Core","UWA/Array","UWA/Class/Timed","UWA/Promise","UWA/Utils/Scroll","UWA/Controls/AutocompleteAdaptors/Data","UWA/Controls/Abstract","UWA/Controls/EnhancedTextarea","UWA/Controls/Input","UWA/Controls/DropDown","UWA/Controls/ThemedScroller","UWA/Event"],function(d,b,f,j,h,l,e,n,g,a,i,m){var c,k;c=n.extend({setInlineText:function(o){this.elements.inlineText.setText(o)},getInlineText:function(){return this.elements.inlineText.getText()},buildSkeleton:function(){this._parent();this.elements.inlineText=d.createElement("span",{"class":this.getClassNames("-inline-text")})},buildContentMimic:function(){return[this._parent(),"\u200B",this.elements.inlineText]}});k=e.extend(f,{name:"uwa-autocomplete",options:{typeDelay:500,adaptor:null,adaptorOptions:{},inputOptions:{},multiline:false,floatingSuggestions:false,previewSuggestion:false,minLength:1,suggestFormat:"{name}",suggestUrl:null,dataParser:null,placeholder:""},init:function(o){this._parent(o)},isFloating:function(){return this.options.multiline&&this.options.floatingSuggestions},getAdaptor:function(){if(!this._adaptor){var p=this.options,o=d.typeOf(p.adaptor);this._adaptor=o==="class"?new p.adaptor(p.adaptorOptions):o==="object"?p.adaptor:new l(d.merge({format:p.suggestFormat,url:p.suggestUrl,dataParser:p.dataParser,minLength:p.minLength},p.adaptorOptions))}return this._adaptor},getContent:function(){if(!this.elements.container){this.buildSkeleton()}return this.elements.container},getInputControl:function(){if(!this.elements.input){this.buildSkeleton()}return this.elements.input},getInputElement:function(){return this.getInputControl().getInputElement()},buildSkeleton:function(){var p=this,o=p.options,r=p.elements,q=d.clone(o.inputOptions),s=this.isFloating();if(o.placeholder){if(!q.attributes){q.attributes={}}q.attributes.placeholder=o.placeholder}q._root=false;r.input=o.multiline?new c(q):new g.Text(q);if(o.multiline){r.input.addEvent("onResize",function(){r.dropdown.updatePosition()})}r.input.addEvents({onKeyDown:this.dispatchEvent.bind(this,"onKeyDown"),onChange:this.dispatchEvent.bind(this,"onChange")});r.input.getInputElement().addEvents({blur:function(){this.elements.container.removeClassName("focus");this.setDelayed("blur-hide-suggestions",this.hideSuggestions,1)}.bind(this),focus:function(){this.elements.container.addClassName("focus");this.setDelayed("focus-update-suggestion",this.updateSuggestions,400)}.bind(this)});if(s){r.dropdown=new a.Pointy({_root:false,target:r.input.getCaretElement(),className:this.getClassNames("-floating-dropdown"),autoPosition:["below-center","above-center"],positionOptions:{fit:"resize-max"}})}else{r.dropdown=new a({_root:false,className:this.getClassNames("-dropdown"),position:function(){return{x:0,y:r.input.getContent().getSize().height}},positionOptions:{fit:"resize-max",relative:r.container,boundaryMargin:4}})}r.suggestions=d.createElement("div",{"class":this.getClassNames("-suggestions"),events:{mousedown:this._selectionMouseHandler.bind(this),mouseover:this._selectionMouseHandler.bind(this)}});r.scroller=new i({_root:false});r.scroller.getInnerElement().setContent(r.suggestions);r.dropdown.getInnerElement().setContent(r.scroller);r.dropdown.addEvents({onHide:function(){p.dispatchEvent("onHideSuggestions")},onPreUpdatePosition:function(){r.scroller.getContent().setStyle("height",Math.min(r.suggestions.scrollHeight,200));var t=this.getContent();t.setStyles({"max-height":null,"max-width":null})},onShow:function(){var t=Math.min(r.dropdown.getContent().getComputedSize("maxHeight"),r.suggestions.getSize().height,200);r.scroller.getContent().setStyle("height",t);p.dispatchEvent("onShowSuggestions")}});r.container=d.createElement("div",{"class":this.getClassNames()+(s?" floating":" not-floating")+(o.multiline?" multiline":" singleline"),html:[r.input,r.dropdown]})},updateSuggestions:function(r){var u=this.getValue();var o=j.deferred();var p=this.getInputElement();var v=p.selectionStart;var s=u+"-"+v;var t=r&&r.resetInput;var q=r&&d.is(r.typeDelay)?r.typeDelay:this.options.typeDelay;if(p.getDocument().activeElement!==p){this.hideSuggestions({resetInput:t});this.clearDelayed("getSuggestions");o.resolve()}else{if(!this._updateSuggestionRun||s!==this._updateSuggestionRun.key){this._updateSuggestionRun={promise:o.promise,key:s};this.setDelayed("hideSuggestionsIfGettingThemIsToSlow",function(){this.hideSuggestions({resetInput:t,cancelUpdateSuggestions:false})},100);this.setDelayed("getSuggestions",function(){this.getSuggestions(u,v).done(function(w){if(this._updateSuggestionRun&&s===this._updateSuggestionRun.key){if(w.length){this.displaySuggestions(w)}else{this.hideSuggestions({resetInput:false,cancelUpdateSuggestions:false})}this.clearDelayed("hideSuggestionsIfGettingThemIsToSlow");o.resolve()}else{o.reject(new Error("Aborted by another call to updateSuggestion"))}}.bind(this))},q)}else{if(this._updateSuggestionRun){this._updateSuggestionRun.promise.then(o.resolve,o.reject)}}}return o.promise},getSuggestions:function(p,o){return j.cast(this.getAdaptor().getSuggestions(p,o)).then(function(q){return(q||[]).map(function(r){return typeof r==="string"?{fullValue:r}:r})})},areSuggestionsDisplayed:function(){return Boolean(this._displayedSuggestions)},displaySuggestions:function(o){this._displayedSuggestions=o;this._currentSuggestionIndex=null;var r=this.elements.dropdown,p=this.elements.suggestions;p.setContent(this.getAdaptor().renderSuggestions(o));r.show();if(this._useFX){p.setStyle("height",p.scrollHeight)}var q=o[0];if(this._isInlineSuggestionAvailable(q)||!this.options.previewSuggestion){this._highlightSuggestion(q)}},hideSuggestions:function(o){this._resetSuggestion(!o||o.resetInput);if(!o||o.cancelUpdateSuggestions!==false){this._updateSuggestionRun=null}this._displayedSuggestions=null;if(this._useFX){this.elements.suggestions.setStyle("height",8)}else{this.elements.dropdown.hide()}},getValue:function(){return this.getInputControl().getValue()},setValue:function(o){this.getInputControl().setValue(o);this.updateSuggestions({resetInput:false})},_selectionMouseHandler:function(p){var o,q=m.findElement(p,".suggestion");if(q){o=this._getSuggestion(q);if(o){if(p.type==="mousedown"){this._setSuggestion(o)}else{this._highlightSuggestion(o)}m.stop(p)}}},_getParts:function(q,o){var p=this.getInputElement();if(q===undefined){q=p.selectionStart}if(o===undefined){o=p.selectionEnd}return{before:p.value.slice(0,q),between:p.value.slice(q,o),after:p.value.slice(o)}},_setParts:function(r,q){var p=this.getInputElement();p.value=r.before+r.between+r.after;var s=r.before.length;var o=s+r.between.length;switch(q){case"start":o=s;break;case"end":s=o;break}p.selectionStart=s;p.selectionEnd=o},_getSuggestionIndex:function(o){if(!d.is(o)){o=this._currentSuggestionIndex;if(!d.is(o)){return}}if(o.nodeType){o=this.elements.suggestions.getElements(".suggestion").indexOf(o)}else{if(typeof o==="object"){o=this._displayedSuggestions.indexOf(o)}}return d.is(o,"number")&&o>=0?o:undefined},_getSuggestion:function(o){o=this._getSuggestionIndex(o);if(o===undefined){return}return this._displayedSuggestions?this._displayedSuggestions[o]:undefined},_getSuggestionElement:function(o){o=this._getSuggestionIndex(o);if(o===undefined){return}return this.elements.suggestions.getElements(".suggestion")[o]},_resetSuggestion:function(q){var p=this._getSuggestion();if(!p){return}b.invoke(this.elements.suggestions.getElements(".current"),"removeClassName","current");if(this.options.multiline){this.elements.input.setInlineText("")}if(q!==false&&this.options.previewSuggestion){var o=this._previousValue||"";var r=this._getParts();r.between=o;this._setParts(r,"end")}this._previousValue=null;this._currentSuggestionIndex=null},_getSuggestionParts:function(q){var p=this.getInputElement(),o;if(q.inlineValue){o=this._getParts();o.previous=o.between;o.between=q.inlineValue}else{if(q.fullValue){o=this._getParts(q.start!==undefined?q.start:0,q.end!==undefined?q.end:p.value.length+q.fullValue.length);o.previous=o.between;o.between=q.fullValue}}return o},_highlightSuggestion:function(o){o=this._getSuggestion(o);if(o===undefined){return}this._resetSuggestion();this._currentSuggestionIndex=this._getSuggestionIndex(o);var p=this._getSuggestionElement(o),q=p.getParent(".category");p.addClassName("current");h.scrollToElement(p);if(q){q.addClassName("current")}var r=this._getSuggestionParts(o);if(this._isInlineSuggestionAvailable(o)){this.elements.input.setInlineText(r.between)}else{if(this.options.previewSuggestion){this._setParts(r,"around")}}this._previousValue=r.previous},_isInlineSuggestionAvailable:function(p){var o=this.getInputElement();return p.inlineValue&&this.options.multiline&&o.selectionStart===o.value.length},_setSuggestion:function(o,p){o=this._getSuggestion(o);if(!o){return}this._resetSuggestion();this._setParts(this._getSuggestionParts(o),p&&p.selectionAtStart?"start":"end");this.hideSuggestions();this.dispatchEvent("onSetSuggestion",[o]);this.getInputControl()._dispatchOnChange()},onHideSuggestions:function(){var o=this.elements;o.container.removeClassName("suggestions-displayed")},onShowSuggestions:function(){var o=this.elements;o.container.addClassName("suggestions-displayed")},onClick:function(){this.elements.input.focus()},onKeyDown:function(o){var t=this,r=m.whichKey(o),w=this._currentSuggestionIndex!==null,q=true;function v(){return Array.prototype.indexOf.call(arguments,r)>=0}function p(){t.setDelayed("updateSuggestions",t.updateSuggestions.bind(t,{resetInput:false}),5)}function u(){t.dispatchEvent("onSubmit",[t.getValue()])}function s(z){var x=t._currentSuggestionIndex;var y=t._displayedSuggestions.length;if(x===null){x=z<0?y:-1}t._highlightSuggestion(t._getSuggestion((x+z+y)%y))}if(!this.areSuggestionsDisplayed()){if(v("return")&&this.hasEvent("onSubmit")){u()}else{p();q=false}}else{if(v("up","shift+tab")){s(-1)}else{if(v("down","tab")){s(1)}else{if(v("return")&&w){this._setSuggestion(null,{selectionAtStart:v("left")})}else{if(v("return")&&this.hasEvent("onSubmit")){this.hideSuggestions({resetInput:false});u()}else{if(v("esc")){this.hideSuggestions()}else{if(!v("shift")){p();q=false}}}}}}}if(q){m.stop(o)}}});return d.namespace("Controls/Autocomplete",k,d)});