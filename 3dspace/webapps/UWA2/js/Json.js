define("UWA/Json",["UWA/Core","UWA/String","UWA/Utils","UWA/Utils/Client","UWA/Ajax"],function(UWA,UWAString,Utils,Client,Ajax){var Json={jsonp:{},encode:JSON.stringify,decode:JSON.parse,prune:function(rootObject,options){var backreferences=[],toJSON=(options&&options.toJSON)||function(i){return UWA.is(i)&&UWA.is(i.toJSON,"function")?i.toJSON():i},fallback=(options&&options.fallback)||function(){return null};function iter(object){var result,key;object=toJSON(object);switch(UWA.typeOf(object)){case"string":case"number":case"boolean":return object;case"array":if(backreferences.indexOf(object)!==-1){return fallback(object,"circular")}backreferences.push(object);result=object.map(iter);backreferences.pop();return result;case"object":if(!UWA.is(object,"plain")){return fallback(object,"unsupported")}if(backreferences.indexOf(object)!==-1){return fallback(object,"circular")}backreferences.push(object);result={};for(key in object){if(UWA.owns(object,key)){result[key]=iter(object[key])}}backreferences.pop();return result;default:return object===null?object:fallback(object,"unsupported")}}return iter(rootObject)},isJson:function(value){var isJson=false;if(UWA.is(value,"string")){try{JSON.parse(value);isJson=true}catch(e){}}return isJson},xmlToJson:function(xml){var i,l,result,childNode,attribute,nodeName,toString=function(){return this.nodeValue},valueOf=function(){return parseInt(this.nodeValue,10)};if(typeof xml==="string"){xml=Utils.loadXml(xml)}if((!xml.attributes||xml.attributes.length===0)&&xml.childNodes&&xml.childNodes.length===1&&xml.childNodes[0].nodeName.indexOf("#")!==-1){result=xml.childNodes[0].nodeValue}else{result={};if(xml.attributes){for(i=0,l=xml.attributes.length;i<l;i++){attribute=xml.attributes[i];nodeName=attribute.nodeName;if(result[nodeName]){result[nodeName]=Utils.splat(result[nodeName]);result[nodeName].push(attribute.nodeValue)}else{result[nodeName]=attribute.nodeValue}}}for(i=0,l=xml.childNodes.length;i<l;i++){childNode=xml.childNodes[i];nodeName=childNode.nodeName;if(result[nodeName]){result[nodeName]=Utils.splat(result[nodeName]);result[nodeName].push(Json.xmlToJson(childNode))}else{if(nodeName.indexOf("#")===-1){result[nodeName]=Json.xmlToJson(childNode)}else{if(childNode.nodeValue.trim().length>0){result.nodeValue=childNode.nodeValue;result.toString=toString;result.valueOf=valueOf}}}}}return result},path:(function(){var valueStr="VALUE",pathStr="PATH",sepStr=";",queryPath="$",regExps=[/[\['](\??\(.*?\))[\]']|\['(.*?)'\]/g,/'?\.'?|\['?/g,/;;;|;;/g,/;$|'?\]|'$/g,/#([0-9]+)/g,/^\$;?/,/(^|[^\\])@/g,/\\@/g,/^[0-9*]+$/,/^(-?[0-9]*):(-?[0-9]*):?(-?[0-9]*)$/g,/^\(.*?\)$/,/^\?\(.*?\)$/,/^\?\((.*?)\)$/,/^(-?[0-9]*):(-?[0-9]*):?([0-9]*)$/,/,/,/'?,'?/];function normalize(expr){var subx=[];return expr.replace(regExps[0],function($0,$1,$2){return"[#"+(subx.push($1||$2)-1)+"]"}).replace(regExps[1],sepStr).replace(regExps[2],";..;").replace(regExps[3],"").replace(regExps[4],function($0,$1){return subx[$1]}).replace(regExps[5],"")}function run(obj,query,val){var queryEval="var valueEval = arguments[2];"+query.replace(regExps[6],"$1valueEval").replace(regExps[7],"@");try{return obj&&val&&eval(queryEval)}catch(e){throw new SyntaxError("UWA.Json.path error: "+e.message+' for query "'+query+'"')}}function asPath(path){var i,n,x=path.split(sepStr),p=queryPath;for(i=1,n=x.length;i<n;i++){p+=regExps[8].test(x[i])?("["+x[i]+"]"):("['"+x[i]+"']")}return p}function store(p,v,result,resultType){if(p){result[result.length]=(resultType===pathStr?asPath(p):v)}return Boolean(p)}function walk(loc,expr,val,path,f){var i,n,m,type=UWA.typeOf(val);if(type==="array"){for(i=0,n=val.length;i<n;i++){if(val.hasOwnProperty(i)){f(i,loc,expr,val,path)}}}else{if(type==="object"){for(m in val){if(val.hasOwnProperty(m)){f(m,loc,expr,val,path)}}}}}function slice(loc,expr,val,path,result,resultType){if(Array.isArray(val)){var i,len=val.length,start=0,step=1,end=len;loc.replace(regExps[9],function($0,$1,$2,$3){start=parseInt($1||start,10);end=parseInt($2||end,10);step=parseInt($3||step,10)});start=(start<0)?Math.max(0,start+len):Math.min(len,start);end=(end<0)?Math.max(0,end+len):Math.min(len,end);for(i=start;i<end;i+=step){trace(i+sepStr+expr,val,path,result,resultType)}}}function trace(expr,val,path,result,resultType){if(expr!==""){var s,i,n,x=expr.split(sepStr),loc=x.shift();x=x.join(sepStr);if(val&&val.hasOwnProperty(loc)){trace(x,val[loc],path+sepStr+loc,result,resultType)}else{if(loc==="*"){walk(loc,x,val,path,function(m,l,currentX,v,p){trace(m+sepStr+currentX,v,p,result,resultType)})}else{if(loc===".."){trace(x,val,path,result,resultType);walk(loc,x,val,path,function(m,l,currentX,v,p){if(typeof v[m]==="object"){trace("..;"+currentX,v[m],p+sepStr+m,result,resultType)}})}else{if(regExps[10].test(loc)){expr=run(val,loc,val,path.substr(path.lastIndexOf(sepStr)+1))+sepStr+x;trace(expr,val,path,result,resultType)}else{if(regExps[11].test(loc)){walk(loc,x,val,path,function(m,l,currentX,v,p){if(run(val,l.replace(regExps[12],"$1"),Array.isArray(v)?v[m]:v,m)){trace(m+sepStr+currentX,v,p,result,resultType)}})}else{if(regExps[13].test(loc)){slice(loc,x,val,path,result,resultType)}else{if(regExps[14].test(loc)){for(s=loc.split(regExps[15]),i=0,n=s.length;i<n;i++){expr=s[i]+sepStr+x;trace(expr,val,path,result,resultType)}}}}}}}}}else{store(path,val,result,resultType)}}return function(obj,expr,arg){var result=[],resultType=(arg&&arg.resultType)||valueStr;if(obj&&expr&&(resultType===valueStr||resultType===pathStr)){trace(normalize(expr),obj,queryPath,result,resultType)}return result.length?result:false}}()),request:function(url,options){options=options||{};var request,jsonpId,callbackMode,onFailure,onComplete,onTimeout,useOfflineCache,fromDataRequest,head,script,intervalStartTime,intervalRequest,poller,useJsonpRequest=options.useJsonpRequest?true:Utils.matchUrl(url,window.location)?false:UWA.Data&&UWA.Data.useJsonpRequest&&!UWA.Data.allowCrossOriginRequest,originalUrl=url,isOnline=Client.isOnline,jsonp=Json.jsonp,defaultOptions={fromDataRequest:false,useOfflineCache:false,async:true,timeout:false,callback:"jsonp"+(Date.now()+Utils.random(1,10000)),callbackName:"callback",callbackMode:"function",callbackModeName:"callbackMode",onCancel:function(){},onFailure:function(error){throw error},onComplete:function(){}};options=UWA.merge(options||{},defaultOptions);if(options.timeout===false){if(options.useOfflineCache){options.timeout=15000}else{options.timeout=25000}}else{options.timeout=parseInt(options.timeout,10)}if(options.data){url+=((url.indexOf("?")>-1)?"&":"?")+Utils.toQueryString(options.data)}jsonpId=options.callback.replace(/[^a-zA-Z0-9_.]/g,"");callbackMode=options.callbackMode;if(callbackMode){url=url.replace(/\=(\?|%3F)/g,"="+jsonpId);url+=(url.indexOf("?")>-1?"&":"?")+options.callbackName+"="+jsonpId;url+="&"+options.callbackModeName+"="+callbackMode}if(url.length>2048){throw new Error("Proxified url is more than 2048 characters, you should consider using POST and CORS Ajax.")}onFailure=options.onFailure;onTimeout=options.onTimeout||onFailure;onComplete=options.onComplete;useOfflineCache=options.useOfflineCache;fromDataRequest=options.fromDataRequest;options.onFailure=function(error){Json.cleanRequest(jsonpId,options);if(useOfflineCache&&fromDataRequest===false){var cachedJsonData=Json.getFromCache(originalUrl);if(!UWA.is(cachedJsonData)){onFailure(error)}else{if(isOnline()){isOnline(false,5000)}onComplete(cachedJsonData)}}else{onFailure(error)}};options.onTimeout=function(error){Json.cleanRequest(jsonpId,options);if(useOfflineCache&&fromDataRequest===false){var cachedJsonData=Json.getFromCache(originalUrl);if(!UWA.is(cachedJsonData)){onTimeout(error)}else{if(isOnline()){isOnline(false,5000)}onComplete(cachedJsonData)}}else{onTimeout(error)}};options.onComplete=function(jsonData){Json.cleanRequest(jsonpId,options);try{if(fromDataRequest&&jsonData&&jsonData.error&&jsonData.error.type&&jsonData.error.type==="UWA_Platform_Exposition"){throw new Error(UWAString.format('ObjectError: url "{0}" return Error with value "{1}"',fromDataRequest,jsonData.error.message||jsonData.error))}onComplete(jsonData)}catch(error){onFailure(error)}};if(options.cache<0){url+=(url.indexOf("?")>-1?"&":"?")+"_="+Date.now()}if(useOfflineCache&&isOnline()===false){options.onFailure(new Error("Network is Offline"))}else{if(!useJsonpRequest){request=Ajax.request(url,UWA.merge({headers:{Accept:"application/json,text/javascript,*/*","X-Request":"JSON"},onComplete:function(data){if(callbackMode&&!Json.isJson(data)){var match;if(callbackMode==="object"){match=data.match(/=\s\(?([\s\S]*?)\)?;?\s*$/)}else{match=data.match(/\(([\s\S]*?)\);?\s*$/)}if(match){data=match[1]}}if(Json.isJson(data)){options.onComplete(UWA.Json.decode(data))}else{options.onFailure(new Error('Invalid JSON Response: "'+data+'"'))}},onFailure:options.onFailure},options))}else{jsonp[jsonpId]={readyState:false,options:options};if(callbackMode==="object"){intervalStartTime=Date.now();intervalRequest=13;poller=function(){var waitingTime,currentTime=Date.now();if(window[jsonpId]!==undefined){jsonp[jsonpId].readyState="loaded";options.onComplete(window[jsonpId])}else{if(currentTime>(intervalStartTime+options.timeout)){waitingTime=(currentTime-intervalStartTime);options.onTimeout(new Error("Request timed out after "+waitingTime+"ms with timeout value "+options.timeout+" ms"))}else{jsonp[jsonpId].poll=setTimeout(poller.bind(this),intervalRequest)}}}}else{window[jsonpId]=function(tmp){if(jsonp[jsonpId]!==undefined){jsonp[jsonpId].data=tmp;jsonp[jsonpId].readyState="loaded"}};intervalStartTime=Date.now();intervalRequest=13;poller=function(){var waitingTime,currentTime=Date.now();if(jsonp[jsonpId].readyState==="loaded"){options.onComplete(jsonp[jsonpId].data)}else{if(currentTime>(intervalStartTime+options.timeout)){waitingTime=(currentTime-intervalStartTime);options.onTimeout(new Error("Timout request after "+waitingTime+"ms with timeout value "+options.timeout+" ms"))}else{jsonp[jsonpId].poll=setTimeout(poller.bind(this),intervalRequest)}}}}head=document.getElementsByTagName("head")[0];script=UWA.createElement("script",{type:"text/javascript",src:url,async:options.async});script.addEvent("error",function(){options.onFailure(new Error("Syntax or http error: "+url))});script.inject(head);jsonp[jsonpId].script=script;poller(options);request={jsonId:jsonpId,script:script,cancel:function(){jsonp[jsonpId].aborted=true;Json.cleanRequest(jsonpId)}}}}return request},cleanRequest:function(jsonpId){var options,head=document.getElementsByTagName("head")[0],jsonp=Json.jsonp[jsonpId];if(jsonp){options=jsonp.options;clearTimeout(jsonp.poll);if(options.callbackMode!=="object"){window[jsonpId]=function(){try{delete window[jsonpId]}catch(e){}}}if(jsonp.script){head.removeChild(jsonp.script);delete jsonp.script}if(jsonp.aborted){options.onCancel(null,options)}}}};return UWA.namespace("Json",Json,UWA)});