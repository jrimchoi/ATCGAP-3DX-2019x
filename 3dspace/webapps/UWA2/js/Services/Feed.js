define("UWA/Services/Feed",["UWA/Core","UWA/Class","UWA/Class/Options","UWA/Utils","UWA/Json","UWA/Data","UWA/Internal/StringMap"],function(h,d,c,g,b,f,a){var e=d.extend(c,{id:null,timeOffset:null,lastFetchedDate:null,error:null,defaultOptions:{id:0,timeOffset:0,readOnly:true,bufferItemMaxLen:30,itemLinkFilters:[],itemEnclosureFilters:[(function(){var i=/feedads|icon|button|addthis|feed|feedburner/;return function(j){return !i.test(j)}}())]},init:function(i){this.data={dir:"ltr",flags:{read:0,unread:0},items:[]};this.setOptions(i)},setOptions:function(i){var j=this;j._parent(i);i=j.options;j.id=i.id;j.timeOffset=i.timeOffset;if(i.error){j.setError(i.error)}else{if(i.data){j.setData(i.data);delete i.data}}return j},setError:function(i){var j=this;j.error=i;return j},getError:function(){return this.error},isReadOnly:function(){return(this.options.readOnly===true)},setLastFetchedDate:function(i){this.lastFetchedDate=parseInt(i,10);return this},getLastFetchedDate:function(){return parseInt(this.lastFetchedDate,10)},setData:function(o,l){l=l||{};var j,n=this,i=o.server_time||Math.round(Date.now()/1000),k=o.items,m=this.getItemsLength();delete o.items;if(l.last_update){n.addItems(k,"before");n.setLastFetchedDate(i)}else{if(l.published_before){n.addItems(k,"after")}else{h.extend(n.data,o,true);this.addItems(k);this.setLastFetchedDate(i);if(o.url){this.ownerURL=o.url;this.feedSiteUrlDomain=g.parseUrl(o.url).domain}}}j={data:h.clone(this.data),addedItem:m-this.data.length};if(l.callback){l.onComplete=l.callback;delete l.callback}if(h.is(l.onComplete,"function")){l.onComplete(j)}return j},addItems:function(m,n){if(Array.isArray(m)&&m.length>0){var o,k,p,j=this.getItems();if(n==="before"){for(o=m.length-1;o>=0;o--){p=this.preProcessItem(m[o]);j.unshift(p)}this.setItemsIndexes()}else{if(n==="after"){for(o=0,k=m.length;o<k;o++){p=this.preProcessItem(m[o]);j.push(p)}this.setItemsIndexes()}else{for(o=0,k=m.length;o<k;o++){p=this.preProcessItem(m[o]);j.push(p)}this.sortItemsByDate()}}}},sortItemsByDate:function(i){this.getItems().sort(function(k,j){var l=new Date(k.date).getTime();var m=new Date(j.date).getTime();return(i==="asc"?l-m:m-l)});this.setItemsIndexes()},setItemsIndexes:function(){var j,i=this.getItemsLength();for(j=0;j<i;j++){this.getItem(j).index=j}},preProcessItem:function(i){if(!i.__preProcessed){i.content=i.content||"";i.title=i.title||"";i.flags=i.flags||{};this.preProcessItemEnclosures(i);this.applyItemLinkFilters(i);this.applyItemEnclosureFilters(i);i.__preProcessed=true}return i},preProcessItemEnclosures:(function(){function i(p,k,q){var n,m,r,o,s=[],j=p.getElementsByTagName(k);for(n=0,m=j.length;n<m;n++){o=j[n];r=j[n].getAttribute(q);if(r&&((k==="img"&&(!o.height||o.height>1)&&(!o.width||o.width>1))||(k==="a"&&(o.href&&o.href.indexOf("#")>1)))){s.push(r)}}return s}return function(E){var D,w,B,v,r,q,F,A,n,u=/\.(jpeg|gif|jpg|bmp|png)$/i,z=/\.(m4a|ogg|mp3|acc)$/i,k=/\.(flv|mp4|h264|avi|mpeg|mpg)$/i,s=this,p=s.options,t=s.getUrl(),x=E.enclosures,C=p.itemEnclosureFilters,y=[],o={image:[],video:[],audio:[]};if(Array.isArray(x)){x.forEach(function(m){var j=m.url,l=m.type;if(j){if((l&&/^image\/(jpeg|gif|jpg|bmp|png)$/.test(l))||u.test(j)){o.image.push(j)}else{if((l&&/^audio\/mpeg$/.test(l))||z.test(j)){o.audio.push(j)}else{if((l&&/^video/.test(l))||k.test(j)){o.video.push(j)}}}}})}r=g.loadHtml(E.content);y=y.concat(i(r,"img","src"));y=y.concat(i(r,"a","href"));for(D=0,w=y.length;D<w;D++){q=y[D];if(!E.image&&u.test(q)){o.image.push(q)}else{if(!E.audio&&z.test(q)){o.audio.push(q)}else{if(!E.video&&k.test(q)){o.video.push(q)}}}}if(!E.image||!E.video){y=E.content.match(/http:\/\/www.youtube.com\/v\/([\w|\-]+)/);if(y&&y.length>0){E.video=y[0];E.image="https://i2.ytimg.com/vi/"+y[1]+"/hqdefault.jpg"}}for(F in o){y=o[F];for(D=0,w=y.length;D<w;D++){q=y[D];A=true;if(Array.isArray(C)){for(B=0,v=C.length;B<v&&A;B++){n=C[B];A=n(q,E)}}if(A){E[F]=g.buildUrl(t,q)}}}E.thumbnail=E.image;E.watchable=Boolean(E.video);return E}}()),addItemLinkFilter:function(j){var i=this.options;if(!h.is(i.itemLinkFilters,"array")){i.itemLinkFilters=[]}if(h.is(j,"function")){i.itemLinkFilters.push(j)}},applyItemLinkFilters:function(n){var m,k,j,o=this.options.itemLinkFilters;if(Array.isArray(o)&&!n.__linksFiltered){for(k=0,j=o.length;k<j;k++){m=o[k];if(h.is(m,"function")&&n.link){n.link=m(n.link,n,this)}}n.__linksFiltered=true}},addItemEnclosureFilter:function(j){var i=this.options;if(!h.is(i.itemEnclosureFilters,"array")){i.itemEnclosureFilters=[]}if(h.is(j,"function")){i.itemEnclosureFilters.push(j)}},applyItemEnclosureFilters:function(v){var p,n,o,k,t,s,u=this,r=u.options.itemEnclosureFilters,q=["image","audio","video"];if(Array.isArray(r)&&!v.__enclosuresFiltered){for(p=0,n=r.length;p<n;p++){s=r[p];if(h.is(s,"function")){for(o=0,k=q.length;o<k;o++){t=q[o];if(v[t]&&!s(v[t],v)){delete v[t]}}}}v.__enclosuresFiltered=true}},getTitle:function(){return this.data.title},getDir:function(){return this.data.dir},getUrl:function(){return this.data.url},getLink:function(){return this.data.link},getType:function(){return this.data.type},getItems:function(){return this.data.items},getItem:function(i){return this.getItems()[i]},getItemByGuid:function(i){return this.getItemByProperty("guid",i)},getItemByProperty:function(m,l){var k,j,i=this.getItemsLength();for(j=0;k<i;j++){k=this.getItem(j);if(k[m]===l){break}}return k},getLastItemId:function(){var i=this.getItem(this.getItemsLength()-1);return i&&i.id},getItemsLength:function(){return this.data.items.length},getUnread:function(t){t=t||{};var o,m,q,j,k=0,p=0,n=this.data,s=this.infos,r=this.getItemsLength();if(s&&r>0){q=n.flags;j=(q&&q.read)?q.read:0;p=s.item_count-j;if(t.onlyNFirst){t.onlyNFirst=(t.onlyNFirst<=r)?t.onlyNFirst:r;for(o=0,m=t.onlyNFirst;o<m;o++){if(!this.isItemRead(o)){k++}}p=k}}return(p>=0)?p:0},isItemRead:function(i){var j=this.getItem(i);return Boolean(j&&j.flags&&j.flags.read)},setItemRead:function(i,j){if(!this.isItemRead(i)){this.data.flags.read++;this.setItemsFlag({indexes:[i],flag:"read",value:Math.ceil(Date.now()/1000),save:j})}},setItemUnread:function(i,j){if(this.isItemRead(i)){this.data.flags.read--;this.setItemsFlag({indexes:[i],flag:"read",value:false,save:j})}},setAllItemsRead:function(m){var k,j,l=this,i=l.getItemsLength();for(k=0;k<i;k++){l.setItemRead(k,false);j.push(k)}l.setItemsFlag({indexes:j,flag:"read",value:Math.ceil(Date.now()/1000),save:m})},setAllItemsUnread:function(m){var k,l=this,j=l.getItemsLength(),i=[];for(k=0;k<j;k++){l.setItemRead(k,false);i.push(k)}l.setItemsFlag({indexes:i,flag:"read",value:false,save:m})},setItemsFlag:function(m){var n,k,q,p=this,j=[],o=(p.isReadOnly()?false:(m.save||true));if(m.index){m.indexes=[m.index]}for(n=0,k=m.indexes.length;n<k;n++){q=p.getItem(n);j.push(q.id);if(m.value&&m.value!==false){q.flags[m.flag]=m.value}else{delete q.flags[m.flag]}}if(o){e.Adapter.Netvibes.feedApiRequest({readState:((m.value&&m.value!==false)?"add":"remove"),feedIds:p.id,feedItemIds:j})}}});e.Utils={adapterName:(f.allowCrossOriginRequest?"Ajax":"Proxy"),load:function(i,j){j=j||this.adapterName;i=i||{};if(i.callback){i.onComplete=i.callback;delete i.callback}return e.Adapter.Cache.load(i,j)},getIdFromUrl:function(i){return Math.abs(parseInt(g.getCRC32(i),10)).toString(36)},cleanFeedUrl:function(i){if(i.contains("flvProxy.php")){i=g.getQueryString(i,"url")}else{if(i.contains("commeaucinemaProxy.php")){i="http://www.commeaucinema.com/rssfile.php?feed=netvibes_"+g.getQueryString(i,"id")}else{if(/^feed:\/\/(.*)/.test(i)){i=i.replace("feed:","");if(!/^http(s)?:\/\/(.*)/.test(i)){i="http://"+i}}}}if(!/^http(s)?:\/\/(.*)/.test(i)){i=h.hosts.netvibes+i}return i}};e.Adapter={Cache:{load:function(s,j){var m,k,o,r,n={},p=s.urls||[],q=[];for(m=0,k=p.length;m<k;m++){o=e.Utils.cleanFeedUrl(p[m]);r=this.getFromCache(o);if(r){n[o]=new e(r)}else{q.push(o)}}if(q.length>0){s.urls=q;e.Adapter[j].load(s,n)}else{if(h.is(s.onComplete,"function")){s.onComplete(n)}}},getCache:function(){if(!this.data){this.data=new a()}return this.data},storeInCache:function(i,j){return this.getCache().set(i,j)},getFromCache:function(i){return this.getCache().get(i)}},Proxy:{load:function(s,o){var n,m,r=0,q=s.urls||[];o=o||{};function k(t,l){var i={url:t,readOnly:true,data:{title:l.title,dir:l.dir,url:l.url,link:l.link,type:l.type,items:l.items}};o[t]=new e(i);e.Adapter.Cache.storeInCache(t,i);r++;if(q.length===r&&h.is(s.onComplete,"function")){s.onComplete(o)}}function j(l,i){o[l]=new e({url:l,readOnly:true,error:i});r++;if(q.length===r&&h.is(s.onComplete,"function")){s.onComplete(o)}}for(n=0,m=q.length;n<m;n++){var p=e.Utils.cleanFeedUrl(q[n]);f.request(p,{proxy:"feed",type:"json",onComplete:k.bind(null,p),onFailure:j.bind(null,p)})}}},Ajax:{load:(function(){function k(q){var m,n,p,o;if(!Array.isArray(q.link)){p=q.link.href||q.link}else{p=q.link[0].href||q.link[0];for(n=0,m=q.link.length;n<m;n++){o=q.link[n];if(o.rel&&["self","alternate"].indexOf(o.rel)!==-1){p=o.href}}}return p}function l(n){var m=n.toString?n.toString():n;return h.is(m)&&m.length>0?m:""}function i(m){return new Date(Date.parse(m)).toGMTString()}function j(r,s){r=b.xmlToJson(r);var n,p,o,m,q={dir:"ltr",url:s,items:[]};if(r.feed){h.extend(q,{title:l(r.feed.title),link:k(r.feed)});n=g.splat(r.feed.entry);for(o=0,m=n.length;o<m;o++){p=n[o];q.items[o]={id:o,title:l(p.title),link:k(p),content:l(p.content),date:i(p.updated)};if(p["media:thumbnail"]&&p["media:thumbnail"].url){q.items[o].image=p["media:thumbnail"].url}}}else{if(r["rdf:RDF"]){r.rdf=r["rdf:RDF"];h.extend(q,{title:l(r.rdf.channel.title),link:k(r.rdf.channel)});n=g.splat(r.rss.channel.item);for(o=0,m=n.length;o<m;o++){p=n[o];q.items[o]={id:o,title:l(p.title),link:k(p),content:l(p.description),date:i(p["dc:date"])};if(p["media:content"]&&p["media:content"].url){q.items[o].image=p["media:content"].url}}}else{if(r.rss){h.extend(q,{title:l(r.rss.channel.title),link:k(r.rss.channel)});n=g.splat(r.rss.channel.item);for(o=0,m=n.length;o<m;o++){p=n[o];q.items[o]={id:o,title:l(p.title),link:k(p),content:l(p["content:encoded"]||p.description),date:i(p.pubDate)};if(typeof q.items[o].content!=="string"){q.items[o].content=""}if(p.enclosure){q.items[o].enclosures=[p.enclosure]}if(p["media:thumbnail"]&&p["media:thumbnail"].url){q.items[o].image=l(p["media:thumbnail"].url)}}}else{throw new Error("Unable to Parse Feed using Ajax Adapter.")}}}return q}return function(u,q){q=q||{};var p,o,t=0,s=u.urls||[];function n(y,x){var v,w=j(x,y);v=new e({url:y,readOnly:true,data:w});q[y]=new e(v);e.Adapter.Cache.storeInCache(y,v);t++;if(s.length===t&&h.is(u.onComplete,"function")){u.onComplete(q)}}function m(w,v){q[w]=new e({url:w,readOnly:true,error:v});t++;if(s.length===t&&h.is(u.onComplete,"function")){u.onComplete(q)}}for(p=0,o=s.length;p<o;p++){var r=e.Utils.cleanFeedUrl(s[p]);f.request(r,{method:"GET",onComplete:n.bind(null,r),onFailure:m.bind(null,r)})}}}())},Netvibes:{load:function(){}}};return h.namespace("Services/Feed",e,h)});