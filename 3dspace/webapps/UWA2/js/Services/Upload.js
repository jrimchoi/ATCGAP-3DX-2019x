define("UWA/Services/Upload",["UWA/Core","UWA/Utils","UWA/Class","UWA/Class/Options","UWA/Json"],function(f,e,d,b,a){var c=d.extend(b,{intervalId:null,timeoutId:null,defaultOptions:{isUploadSuccess:function(g){return(g.status==="uploaded")},isUploadFailed:function(g){return(g.status==="failed")},formElement:"undefined",onUpload:"",onUploadSuccess:"",onUploadFailed:"",frameIdPrefix:"",timeout:10000,polling:1000,urls:{statusScript:"",uploadScript:""}},init:function(g){this.setOptions(g);this.options.formElement=f.extendElement(g.formElement);var h=this.buildIframe();this.buildFormRequirements(h);this.options.formElement.addEvent("submit",function(i){if(g.urls.statusScript!==undefined){this.setTimer(i)}this.options.onUpload()}.bind(this,h))},buildIframe:function(){var k,h=this.options,i=h.frameIdPrefix+e.random(1,100000),g=f.createElement("div"),j=false;k=f.createElement("iframe",{src:"about:blank",id:i,name:i,styles:{position:"absolute",top:"-2000px",left:"0px"}}).inject(g);k.addEvent("load",function(){if(j){h.onUploadSuccess()}j=true});document.body.appendChild(g);return i},buildFormRequirements:function(h){var g=this.options.formElement;g.setAttributes({target:h,method:"post",enctype:"multipart/form-data",action:this.options.urls.uploadScript});f.createElement("input",{type:"hidden",name:"frameId",value:h}).inject(g)},setTimer:function(g){this.intervalId=setInterval(this.checkStatus.bind(this,g),this.options.polling);this.timeoutId=setTimeout(function(){clearInterval(this.intervalId);this.options.onUploadFailed({status:"failed",details:{errors:{TimeoutError:"Upload timeout after "+this.options.timeout+"ms."}}})}.bind(this),this.options.timeout)},checkStatus:function(g){a.request(this.options.urls.statusScript+"?format=jsonp&frameId="+g,{onComplete:function(h){if(this.options.isUploadSuccess(h)){this.options.onUploadSuccess(h)}else{if(this.options.isUploadFailed(h)){this.options.onUploadFailed(h)}else{return}}clearTimeout(this.timeoutId);clearInterval(this.intervalId)}.bind(this)})}});return f.namespace("Services/Upload",c,f)});