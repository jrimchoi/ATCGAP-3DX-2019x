define("UWA/Widget",["UWA/Core","UWA/String","UWA/Array","UWA/Class","UWA/Class/Options","UWA/Class/Timed","UWA/Class/Events","UWA/Class/Debug","UWA/Utils","UWA/Utils/Client","UWA/Data","UWA/Element"],function(i,f,e,b,l,j,p,o,k,g,n,d){function h(r){if(!Array.isArray(r)){throw new Error(r+" should be an array")}r.forEach(function(s){if(typeof s!=="string"){throw new Error(s+" should be a string")}})}function q(s){if(!s){return[]}var r;if(Array.isArray(s)){r=s}else{try{r=JSON.parse(s)}catch(t){throw new Error("While parsing JSON value `"+s+"`: "+t)}}h(r);return r}function c(r,s){if(r){if(r.multiple||r.type==="checklist"){try{s=q(s)}catch(t){throw new Error("While decoding value for preference "+r.name+": "+t)}}if(r.type==="boolean"&&s===""){s=false}}return s}function a(r,s){if(r){if(r.multiple||r.type==="checklist"){h(s);s=JSON.stringify(s)}}return s}var m=b.extend(l,j,p,o,{init:function(){var s=this,r=g.Locale;s.id=null;s.environment=null;s.launched=false;s.title=null;s.icon=null;s.counter=0;s.counterType=null;s.metas={};s.preferences=[];s.defaultData=Object.create(null);s.data={};s.menus=[];s.plugins=[];s.events={};s.elements={};s.body=null;s.lang=r.lang;s.locale=r.locale;s.dir=r.dir;s.readOnly=false;s.isEdit=false},launch:function(s,t){var r=this;r.launched=false;if(t!==undefined){r.readOnly=Boolean(t)}r.initPreferences();r.initPlugins();r.setValues(s);r.dispatchEvent("onInitConfig",{metas:r.metas,plugins:r.plugins,preferences:r.getPreferences()});r.dispatchEvent("beforeLoad");r.addEventOnce("onLoad",function(){r.launched=true},r,1);r.dispatchEvent("onLoad");if(r.launched){r.dispatchEvent("afterLoad")}return r.launched},destroy:function(){var r,s=this,t=s.elements;s.clearDelayed();s.clearPeriodical();for(r in t){if(t.hasOwnProperty(r)){t[r].destroy()}}s.removeEvent();s.launched=false},setOptions:function(r){var s,u,t=this;for(s in r){u="set"+f.capitalize(s);if(i.is(t[u],"function")){t[u](r[s])}}return t._parent(r)},setAutoRefresh:function(r){r=parseInt(r,10);var s=this;if(r&&r>0){s.setPeriodical("autoRefresh",s.dispatchEvent.bind(s,"onRefresh"),r*1000*60)}else{s.clearPeriodical("autoRefresh")}s.metas.autoRefresh=r},setCounter:function(t,r){var s=this;if(s.counter!==t||(i.is(r)&&s.counterType!==r)){s.counter=t;s.counterType=r;s.dispatchEvent("onUpdateCounter",[t,r])}},getTitle:function(){return i.is(this.title,"string")?f.stripTags(this.title):""},setTitle:function(t,r){var s=this;if(i.is(t,"string")&&s.title!==t||(r&&s._titleUrl!==r)){s.title=t;s._titleUrl=r;s.dispatchEvent("onUpdateTitle",[t,r])}return s.title},setIcon:function(s,r){var t=this;if(s&&i.is(s,"string")){if(r){s=n.proxifyUrl(s,{proxy:"icon"})}if(t.icon!==s){t.icon=s;t.dispatchEvent("onUpdateIcon",[s])}}return t.icon},setMenu:function(u){var r=this.environment,x=u.name.split("/"),s=x[0],t,v,w;if(x.length>2){throw new Error("Adding more than one submenu level is not supported by setMenu")}w=this.getMenu(u.name);if(w){i.extend(w,u)}else{if(x.length>1){t=this.getMenu(s);if(!t){t={label:s};this.menus.push(t)}if(!t.items){t.items=[]}v=t.items}else{v=this.menus}v.push(u)}this.setDelayed("onUpdateMenu",function(){r.dispatchEvent("onUpdateMenu",[this.menus])},20)},getMenu:function(r){var t,s;if(i.is(r,"string")){s=r.split("/");t=e.detect(this.menus,function(u){return u.name===s[0]});if(t&&s.length>1){t=t.items&&e.detect(t.items,function(u){return u.name===r})}}return t},removeMenu:function(s){var t,r,v,u;u=function(w){return w.name!==s};for(t=0,r=this.menus.length;t<r;t++){v=this.menus[t];if(v.name===s){this.menus.remove(v);break}if(v.items){v.items=v.items.filter(u)}}},setDir:function(r){var t=this,s=t.dir,u=t.elements.wrapper;r=(r==="rtl"?"rtl":"ltr");if(u&&s!==r){u.setAttribute("dir",r);u.addClassName(r);u.removeClassName(s)}t.dir=r;return r},setMetas:function(s){var r=this;i.merge(r.metas,s);if(i.is(s.debugMode)){r.setDebugMode(s.debugMode);if(r.environment){r.environment.setDebugMode(s.debugMode)}}if(i.is(s.autoRefresh)){r.setAutoRefresh(s.autoRefresh)}return r.metas},setBody:function(r){if(!this.body){throw new Error("Widget.body is not yet available")}this.body.setContent(r)},addBody:function(r){this.body.addContent(r)},getElements:function(r){return this.body.getElements(r)},getElement:function(r){return this.body.getElement(r)},createElement:function(s,r){return i.createElement(s,r)},setStyle:function(s){var t=this,u=t.id?"#m_"+t.id:".moduleWrapper",r=u;if(t.id){t.elements.wrapper.setAttribute("id","m_"+t.id)}k.setCss(false,s,r,t.getUrl())},mutate:function(t,s){var r=this.environment;if(!t){throw new Error("Missing or empty first param on widget.mutate")}if(r&&r.mutate){r.mutate(t,s)}else{throw new Error("Current Environment do not support widget.mutate")}},getUrl:function(){var s,t=this,r=window.location.href;if(t.uwaUrl){s=t.uwaUrl}else{s=k.getQueryString(r,"uwaUrl",r)}return s},addStar:function(s){var r=this.environment;if(r&&r.addStar){r.addStar(s)}},getViewportDimensions:function(){var v,B,y=this,r=y.elements,x=r.body,z=d.getDimensions,s=d.isInjected,D=d.getComputedSize,w=g.getSize(),A=z.call(r.wrapper),u=z.call(x),C=w.height,t=A.width;["header","footer"].forEach(function(E){v=r[E];if(v&&s.call(v)){C-=z.call(v).outerHeight}});v=x;B=r.wrapper.parentNode;do{if(v!==r.wrapper){t-=D.call(v,"innerWidth","outerWidth")}else{t-=D.call(v,"innerWidth")}C-=D.call(v,"innerHeight","outerHeight");v=v.parentNode}while(v&&v!==B);if(u.maxHeight>0&&C>u.maxHeight){C=u.maxHeight}else{if(u.minHeight>0&&C<u.minHeight){C=u.minHeight}}return{height:C<0?240+C:C,width:t<0?320+t:t}},setPlugins:function(r){this.plugins=r},initPlugins:function(){var t,s,v,u=this,r=i.clone(u.plugins);for(t=0,s=r.length;t<s;t++){v=r[t];if(i.Plugins[v.name]){v.instance=new i.Plugins[v.name](u,v.options)}}},initPreferences:function(){var r=this;r.setPreferences(r.preferences)},hasPreferences:function(){var s=this,r=s.preferences;return !s.readOnly&&r.length>0&&r.some(function(t){return t.type!=="hidden"})},_getRawPreference:function(r){return e.detect(this.preferences,function(s){return s.name===r})},getPreference:function(r){var s=this._getRawPreference(r);if(s){s=i.clone(s);s.value=this.getValue(r)}return s},hasPreference:function(r){return this.preferences.some(function(s){return s.name===r})},addPreference:(function(){var r=["hidden","text","list","checklist","range","password","boolean"];function s(t){return t.name&&t.type&&r.indexOf(t.type)!==-1}return function(w){var v,u=-1,x=this,t=x.preferences;if(s(w)){w=i.clone(w);v=w.defaultValue!==undefined;if(w.multiple&&typeof w.multiple!=="boolean"){w.multiple=w.multiple==="true"}if(v){w.defaultValue=c(w,w.defaultValue)}t.forEach(function(y,z){if(w.name===y.name){u=z}});if(!w.label){w.label=w.name}if(u!==-1){t[u]=w}else{t.push(w)}x.defaultData[w.name]=w.defaultValue;if(x.launched){x.dispatchEvent("onUpdatePreferences",[x.getPreferences()])}}}}()),setPreferences:function(u){var s,r,t=this;t.preferences=[];t.defaultData={};for(s=0,r=u.length;s<r;s++){t.addPreference(u[s])}},mergePreferences:function(u){var s,r,t=this;for(s=0,r=u.length;s<r;s++){if(!t.hasPreference(u[s].name)){t.addPreference(u[s])}}},getPreferences:function(){var w,s,u,r,v,x,y=this,t=i.clone(y.preferences);for(w=0,s=t.length;w<s;w++){v=t[w];v.value=y.getValue(v.name);v.label=i.i18n(v.label);if(i.is(v.options,"array")){for(u=0,r=v.options.length;u<r;u++){x=v.options[u];x.label=i.i18n(x.label)}}}return t},getValue:function(s){var u=this;var r=u.environment;var t=u.data[s];if(!i.is(t)&&r&&r.getData){t=c(u._getRawPreference(s),r.getData(s))}if(!i.is(t)){t=u.defaultData[s]}if(i.is(t)){u.data[s]=t}else{t=undefined;delete u.data[s]}return t},getInt:function(r){var s=this.getValue(r);if(s==="true"||s===true){s=1}else{s=parseInt(s,10)}return isNaN(s)?0:s},getBool:(function(){var r=[1,"1","true",true];return function(s){return(r.indexOf(this.getValue(s))!==-1)}}()),setValue:function(s,v){var u=this,r=u.environment,t=u._getRawPreference(s),w=true;v=c(t,v);if(!i.equals(u.data[s],v)){if(!i.is(v)){if(u.data.hasOwnProperty(s)){delete u.data[s]}else{w=false}if(r&&r.deleteData){r.deleteData(s)}else{if(r&&r.setData){r.setData(s,undefined)}}}else{v=i.clone(v);u.data[s]=v;if(r&&r.setData){r.setData(s,a(t,v),t?i.equals(t.defaultValue,v):false)}}if(w){u.dispatchEvent("onUpdateValue",[s,v])}}return v},setValues:function(r){var s;for(s in r){if(r.hasOwnProperty(s)){this.setValue(s,r[s])}}},deleteValue:function(r){return this.setValue(r)},toggleEdit:function(){var t;var s=this,r=s.isEdit?"endEdit":"onEdit";s.dispatchEvent(r);if(s.environment&&s.environment.html.menus&&s.getMenu("options/preferences")){t=s.environment.html.menus.getElement('[data-name="options"]');if(t){t.toggleClassName("active",!s.isEdit)}}},dispatchEvent:function(t,s,x,w){var v=this,r=v.environment,u=(!w&&r)||t==="onLoad"||v.launched;if(!w&&r){r.dispatchEvent(t,s,x)}else{if(u){v._parent(t,s,x)}}return v},addEvent:function(r,u,w,s){var t=this,v=r==="onLoad"&&t.launched;t._parent(r,u,w,s);if(v){t.addEventOnce("_onLoadImmediate",u,w,s);this.setImmediate("_onLoadImmediate",function(){t.dispatchEvent("_onLoadImmediate")})}return t},addEventOnce:function(r,u,w,s){var t=this,v=r==="onLoad"&&t.launched;if(v){t.addEventOnce("_onLoadImmediate",u,w,s);this.setImmediate("_onLoadImmediate",function(){t.dispatchEvent("_onLoadImmediate")})}else{t._parent(r,u,w,s)}return t},requestView:function(r){if(i.is(r,"string")){r={type:r}}this.dispatchEvent("onViewRequest",[r]);return this},getView:function(){return this._view||{type:"windowed"}},getAvailableViews:function(){var r=this.metas.availableViews||"";return e.invoke(r.split(";"),"trim").filter(function(s){return s}).map(function(t){var v=t.match(/\S*/)[0],u=t.slice(v.length).trim(),s;if(u){try{s=JSON.parse(u)}catch(w){this.log("Failed to parse availableViews options")}}if(!s){s={}}s.type=v;return s},this)},onEdit:function(){this.isEdit=true},endEdit:function(){this.isEdit=false}});return i.namespace("Widget",m,i)});