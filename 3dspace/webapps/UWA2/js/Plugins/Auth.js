define("UWA/Plugins/Auth",["UWA/Core","UWA/Plugins/Abstract","UWA/Utils/Client","UWA/Event","UWA/Controls/Form","UWA/Services/Auth"],function(g,f,d,a,c,e){var b=f.extend({defaultOptions:{formOptions:{loginLabel:"Login",passwordLabel:"Password",logoutLabel:"Logout",submitLabel:"Sign In",loadingCredential:"Credentials validation loading...",requireCredential:"Authentication required!",invalidCredential:"Login / Password combination is incorrect."}},state:0,init:function(i,h){this.elements={};this._parent(i,h);this.auth=new e(this.options);this.saveWidgetBody();if(d.isOnline()){this.addEvent("onLoad",this.checkIdentity,this,1);this.addEvent("onRefresh",this.checkIdentity,this,1)}else{this.onAuthenticateFailure("offline")}},checkIdentity:function(){if(this.state===0){this.state=1;this.onAuthenticateLoading();this.auth.hasIdentity(this.onAuthenticateSuccess.bind(this),this.onAuthenticateFailure.bind(this))}return this.state===4},onAuthenticateSuccess:function(){this.state=4;this.addLogout();this.restoreWidgetBody();this.dispatchEvent("onLoad")},onAuthenticateFailure:function(h){this.error=h;if(this.state===2){this.state=3}this.addForm()},onAuthenticateLoading:function(){this.addLoading()},onClearIdentity:function(){this.auth.clearIdentity();this.state=0;this.addForm()},onFormSubmit:function(h){a.stop(h);this.elements.form.getField("signin").disabled=true;this.onAuthenticateLoading();this.state=2;this.auth.authenticate(this.onAuthenticateSuccess.bind(this),this.onAuthenticateFailure.bind(this),this.elements.form.getFormValues())},saveWidgetBody:function(){if(!this.widgetBody){var j,h,m=this.widget,k=m.body.getChildren();this.widgetBody=document.createDocumentFragment();for(j=0,h=k.length;j<h;j++){this.widgetBody.appendChild(k[j])}}},restoreWidgetBody:function(){this.widget.setBody(this.widgetBody);this.widgetBody=false},addLoading:function(){var h=this,i=h.widget;h.elements.loading=i.createElement("p",{text:g.i18n(this.options.formOptions.loadingCredential),styles:{textAlign:"center"}}).inject(i.elements.body.empty())},addForm:function(){var i=this,k=g.i18n,j=i.widget,h=i.options.formOptions;this.removeLogout();i.elements.form=new c({fields:[{type:"img",src:h.logoUrl},{type:"html",html:{tag:"p",title:this.error&&(this.error.message||this.error),text:(this.state===3?h.invalidCredential:h.requireCredential),styles:{textAlign:"center"}}},{type:"text",name:"login",label:k(h.loginLabel),value:""},{type:"password",name:"password",label:k(h.passwordLabel),value:""},{type:"submit",name:"signin",value:k(h.submitLabel)},{type:"html",html:[{tag:"b",text:h.warningTitle},{tag:"p",text:h.warningText,styles:{textAlign:"justify"}}]}],events:{onSubmit:this.onFormSubmit.bind(this)}}).inject(j.elements.body.empty());if(j.environment.name!=="vista"){i.elements.form.getField("login").focus()}},removeLogout:function(){var h=this.elements.logout;if(h){h.remove()}},addLogout:function(){var i=this,j=i.widget,h=g.i18n(i.options.formOptions.logoutLabel);i.elements.logout=j.createElement("a",{title:h,styles:{border:"none",position:"absolute",top:"0px",right:"5px"},html:{tag:"img",src:g.hosts.uwa+g.paths.css+"base/img/logout.png",height:18,width:20,alt:h},events:{click:function(k){a.stop(k);i.onClearIdentity()}}}).inject(j.elements.content)}});return g.namespace("Plugins/Auth",b,g)});