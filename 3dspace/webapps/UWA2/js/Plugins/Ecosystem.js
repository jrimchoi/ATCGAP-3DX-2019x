define("UWA/Plugins/Ecosystem",["UWA/Core","UWA/Plugins/Abstract","UWA/Utils","UWA/Utils/Client","UWA/Data","UWA/Storage"],function(g,f,d,e,b,c){var a=f.extend({defaultOptions:{api:g.hosts.ecosystem.replace("://","://api."),front:g.hosts.ecosystem,interval:86400,messages:{unavailable:"This Application is not available because it's under maintenance.",suspended:"This Application is not available because it's suspended."}},status:["unknown","online","unavailable","suspended"],init:function(i,h){this._parent(i,h);this.database=new c({database:"__plugin_ecosystem_"+d.getCheckSum(i.getUrl())});if(e.isOnline()){this.addEvent("onLoad",this.checkStatus)}},checkStatus:function(){var h=this.getStatus();if(!this.database.isReady){this.environment.setDelayed("EcosystemCheckStatus",this.checkStatus.bind(this),5000)}else{if(!g.is(h)){b.request(this.options.api+"/widget/status",{onComplete:this.checkStatusComplete.bind(this),onFailure:this.checkStatusFailure.bind(this),cache:false,type:"json",data:{url:this.widget.getUrl(),format:"json"}})}else{this.removeEvent("onLoad",this.checkStatus);this.checkStatusComplete(h)}}return false},checkStatusComplete:function(j){var h=this.status,i=j.state?parseInt(j.state,10):1;this.saveStatus(i);if(i>1){this.setStatusMessage(h[i])}else{this.dispatchEvent("onLoad")}},checkStatusFailure:function(){this.saveStatus(0);this.dispatchEvent("onLoad")},getStatus:function(){var h=this.database.get("status"),j=parseInt(this.database.get("status_timestamp"),10),i=(Math.round(Date.now()/1000)-this.options.interval);return(!g.is(h)||j<i?null:h)},saveStatus:function(h){this.database.set("status",h);this.database.set("status_timestamp",Math.round(Date.now()/1000))},setStatusMessage:function(h,i){var k=g.i18n,j=this.widget;i=i||this.options.messages[h];j.setTitle(k("Unavailable Application"));j.setBody(k(i))}});return g.namespace("Plugins/Ecosystem",a,g)});