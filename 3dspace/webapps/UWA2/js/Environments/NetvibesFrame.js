/*!
  Script: NetvibesFrame.js

    This file is part of UWA JS Runtime.

  About: License

    Copyright 2006-2012 Netvibes, a Dassault SystÃ¨mes company.
    All rights reserved.
*/
define("UWA/Environments/NetvibesFrame",["UWA/Core","UWA/Utils","UWA/Utils/Client","UWA/Utils/InterCom","UWA/Element","UWA/Environment","UWA/Controls/Scroller","UWA/Storage/Adapter/Object"],function(h,f,g,c,b,d,a){var e=d.extend({name:"netvibesFrame",disableRemote:true,communicationType:null,onInit:function(){var j=document.body,i=b.getElement.bind(j);if(!i(".moduleFrame")){this.buildSkeleton(j)}this.html={wrapper:i(".module"),header:i(".moduleHeader"),content:i(".moduleWrapper"),body:i(".moduleContent"),edit:i(".moduleEdit"),footer:i(".moduleFooter"),counter:i(".counter"),title:i(".title"),icon:i(".icon"),shareAction:i(".share"),refreshAction:i(".refresh"),editAction:i(".edit")};this.onResize()},buildSkeleton:function(j){var k=h.i18n,l=["module moduleUwa"],i=[];i.push({tag:"div","class":"moduleWrapper",html:[{tag:"div","class":"moduleContent",html:k("Loading...")}]});b.setContent.call(j,{tag:"div","class":l.join(" "),html:i})},onRegisterWidget:function(){this._parent();this.sendRemote("onRegisterWidget")},onUpdateCounter:function(j,i){this.sendRemote("setCounter",j,i)},onUpdateTitle:function(i){this.sendRemote("setTitle",false,i)},onUpdateIcon:function(i,j){this.sendRemote("setIcon",false,i)},onUpdateValue:function(i,j){this.sendRemote("setValue",i,j)},onUpdatePreferences:function(){this.sendRemote("onUpdatePreferences",this.widget.getPreferences())},addStar:function(i){this.sendRemote("addStar",false,h.Json.encode(i))},onResize:function(){var j,l=this.html.wrapper,k=l.offsetWidth,i=l.offsetHeight;if(i>0&&i!==this.prevHeight){j=(this.prevHeight?(i>100||i>this.prevHeight?150:250):500);this.setDelayed("resizeHeight",function(m){this.sendRemote("resizeHeight",false,m);this.prevHeight=m}.bind(this,i),j,this)}if(this.prevWidth!==k){this.prevWidth=k;this.dispatchEvent("onResize")}else{return false}},openURL:function(i){var l,j,k=h.Utils.parseUrl(i);if(k.subprotocol==="feed"){j=String(k.anchor)||0;k.subprotocol=k.anchor=null;l=h.Utils.composeUrl(k);h.Services.Feed.Utils.load({readOnly:true,urls:[l],callback:function(o){var n,m;for(m in o){if(o.hasOwnProperty(m)){n=o[m];break}}this.sendRemote("feedReader","open",{index:j,feedData:n.data})}.bind(this)})}else{window.open(k.source)}return true},sendRemote:function(m,j,l){var o,k,i=this.communicationType;if(i==="HTML5postMessage"){o=(parent.postMessage?parent:(parent.document.postMessage?parent.document:undefined));if(o&&o.postMessage){k=h.Json.encode({id:this.widget.id,action:m,name:j,value:l});o.postMessage(k,"*")}else{this.log("Unable to sendRemote cause: postMessage interface not available")}}else{if(i==="TUApolling"||i==="TMUpolling"){try{k=h.Json.encode({id:this.widget.id,action:m,name:j,value:l});this.widget.widgetObject.poll.push(k)}catch(n){this.log("Unable to sendRemote cause: parent widget object not ready on widget #"+this.widget.id+": ("+m+","+j+","+l+")")}}}},publicInterface:function(k,i,j){this.log("Received publicInterface call on widget #"+this.widget.id+": ("+k+","+i+","+j+")");if(k){switch(k){case"onUpdateTheme":this.updateTheme(j);break;case"launchModule":this.launchWidget(j);break;case"setValue":this.widget.setValue(i,j);break;case"deleteValue":this.widget.deleteValue(i);break;case"onEdit":case"endEdit":case"onRefresh":case"onSearch":case"onResetSearch":case"onResetUnreadCount":case"onKeyboardAction":this.widget.dispatchEvent(k,j);break}}},initRemote:function(i){this.communicationType=i||this.communicationType;this.log("Init Remote using "+this.communicationType+" as communication layer.");this.widget.publicInterface=this.publicInterface.bind(this);switch(this.communicationType){case"HTML5postMessage":this.initHTML5postMessage();break;case"TUApolling":this.initTUApolling();break;case"TMUpolling":this.initTMUpolling();break;default:throw'Unable to init Remote for unknown "'+this.communicationType+'" communication layer.'}},initHTML5postMessage:function(){var i=function(l){var j=String(l.origin),k=h.Json.decode(l.data);if(j.contains(this.widget.subspaceDomain)===false){h.log("No relay for message from "+j)}else{if(k){this.publicInterface(k.action,k.name,k.value)}}}.bind(this);if(window.addEventListener){window.addEventListener("message",i,false)}else{if(window.attachEvent){window.attachEvent("onmessage",i)}}this.sendRemote("widgetIsReady")},initTUApolling:function(){this.createRemoteframe();this.initRemotePolling()},initTMUpolling:function(){document.domain=this.widget.subspaceDomain;this.widget.widgetObject=parent.widgetObject;this.widget.widgetObject.widget=this.widget;this.initRemotePolling();this.widget.widgetObject.poll.push('{"action":"widgetIsReady"}')},createRemoteframe:function(){var i=h.createElement("iframe",{src:"http://"+location.hostname+"/tuaproxy.html#id="+this.widget.id+"&subspaceDomain="+this.widget.subspaceDomain,styles:{position:"absolute",width:"100px",left:"-300px"}});document.body.appendChild(i)},initRemotePolling:function(){this.widget.poll=[];this.setPeriodical("poll",function(){if(h.Json.isJson(this.widget.poll[0])){var i=h.Json.decode(this.widget.poll[0]);if(i){this.publicInterface(i.action,i.name,i.value);this.widget.poll.shift()}}},250)}});return h.namespace("Environments/NetvibesFrame",e,h)});