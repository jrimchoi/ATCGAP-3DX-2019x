define("UWA/Embedded",["UWA/Core","UWA/String","UWA/Class","UWA/Class/Options","UWA/Class/Debug","UWA/Class/Events","UWA/Utils","UWA/Utils/InterCom"],function(f,d,a,i,l,n,h,m){function b(p,q){var o;for(o in q){if(q.hasOwnProperty(o)){p.style[o]=q[o]}}}function k(p,o){var r,q;for(q in o){if(o.hasOwnProperty(q)){r=o[q];if(q==="styles"){b(p,r)}else{if(q==="html"){p.innerHTML=r}else{if(q==="text"){p.innerHTML="";p.appendChild(document.createTextNode(r))}else{p.setAttribute(q,r)}}}}}}function e(q,o,r){var p=document.createElement(q);if(o){k(p,o)}if(r){r.appendChild(p)}return p}function g(o){var p;if(typeof o!=="object"){return false}for(p in o){if(o.hasOwnProperty(p)){return false}}return true}function j(o){return typeof o==="boolean"?(o===false?"0":"1"):h.encodeUrl(o)}var c=a.extend(i,l,n,{url:"",id:null,data:null,version:f.version,elements:null,preferences:null,disableRemote:true,defaultOptions:{container:null,className:"module",title:null,themeUrl:null,color:"white",height:"auto",width:"100%",maxHeight:false,bookmarklet:false,lang:null,id:null,readOnly:false,data:{},buildHeader:false,displayHeader:true,displayFooter:true,displayScroller:false,displayEdit:true,cache:null,useAsyncFrame:false,useAppCache:false,offlineMode:false,autoLaunch:true,subDomain:false,subDomainPattern:"{id}.widget.",remoteName:"uwa.embedded",sandbox:false,exposition:f.hosts.exposition,uwa:f.hosts.uwa},socket:null,init:function(s,r){this.url=s;this.data={};this.elements={};this.preferences=[];this._remoteQueue=[];this.startTime=new Date().getTime();this.setOptions(r);r=this.options;var o,p,q,t=typeof r.container;if(t==="string"){this.container=document.getElementById(r.container)}else{if(t==="object"&&this.options.container!==null){this.container=r.container}else{q=document.getElementById("UWA_ASYNC");this.container=e("div",{id:this.id,"class":r.className});if(q){q.parentNode.insertBefore(this.container,q.nextSibling)}else{o=document.getElementsByTagName("script");p=o[o.length-1];p.parentNode.insertBefore(this.container,p)}}}c.Instances[this.id]=this;if(!this.container){throw new Error("UWA.Embedded is unable to get container element with container "+this.container+".")}else{if(typeof this.url!=="string"){throw new Error("UWA.Embedded expect url defined has first param")}else{this.log('Init new instance with container id "'+this.id+'" and widget url "'+this.url+'"');this.render()}}},destroy:function(){},setOptions:function(o){this._parent(o);o=this.options;if(o.title){o.buildHeader=true}if(o.buildHeader){o.displayHeader=false}this.data=o.data||{};if(o.id||!this.id){this.id=o.id||this.generateId()}return this},generateId:function(){var o;do{o="uwa-"+h.getCheckSum(this.url)+"-"+h.random(1,100000)}while(document.getElementById(o)&&c.Instances[o]!==null);return o},render:function(){var s,r={},p=this.options,o=this.container,q=navigator.userAgent.toLowerCase().match(/ip(?:ad|od|hone)/);r.wrapper=e("div",{"class":"moduleWrapper"});if(p.buildHeader){r.header=e("div",{"class":"moduleHeader",styles:{position:"relative",overflow:"hidden",height:"23px",padding:"5px 5px 0 5px"}},r.wrapper);r.iconContainer=e("span",{styles:{padding:"0 5px 0 0"}},r.header);r.icon=e("img",{src:p.uwa+f.paths.img+"icon.png","class":"moduleIcon",height:16,width:16,styles:{border:"none",height:16,width:16}},r.iconContainer);r.title=e("span",{text:p.title||"Loading...","class":"moduleTitle",styles:{font:'bold 11px/20px "Lucida Grande",Tahoma,Helvetica,Arial,sans-serif',verticalAlign:"top"}},r.header)}r.body=e("div",{"class":"moduleContent"},r.wrapper);s={id:"frame-"+this.id,frameBorder:0,width:"100%",scrolling:p.maxHeight||p.height!=="auto"?"auto":"no"};if(p.sandbox){s.sandbox="allow-same-origin allow-forms allow-scripts allow-popups"}r.iframe=e("iframe",s,r.body);b(r.iframe,{display:"block"});if(p.bookmarklet){p.displayScroller=true;p.height="100%";p.width="320px";b(r.wrapper,{position:"fixed",top:0,right:0,height:p.height,width:p.width,"z-index":99999998})}if(p.height!=="auto"){r.iframe.height=p.height}if(q&&p.displayScroller){r.iframe.scrolling="no"}this.elements=r;o.innerHTML="";o.appendChild(r.wrapper);if(p.useAsyncFrame){this.renderIframeAsync()}else{this.renderIframe()}this.setChromeColor(p.color);this.initRemote()},renderIframe:function(){var p=this.elements.iframe,o=this.getIframeUrl();if(!p.previousIframeUrl||p.previousIframeUrl!==o){p.previousIframeUrl=o;p.src=o}},renderIframeAsync:function(){var r,q=this,s=JSON.stringify,p=q.options,u=q.elements.iframe.contentWindow.document,o=p.exposition+"/widget/amd/js?uwaUrl="+j(q.url),t={id:q.id,widgetDomain:window.location.toString().replace(/#.*$/,"")};if(p.cache){o+="&cache="+j(p.cache)}r=["<!DOCTYPE html>","<html>","<head>",'<meta charset="UTF-8" />','<script type="text/javascript">',"   var UWA = {hosts:"+s(f.hosts)+"},",'       curl = {apiName: "require"};',"<\/script>",'<script type="text/javascript" src="'+p.uwa+"/lib/vendors/curl.js?v="+q.version+'"><\/script>','<script type="text/javascript" src="'+o+"&v="+q.version+'"><\/script>',"</head>","<body>",'<script type="text/javascript">','   define("'+q.id+'", ["'+q.url+'"], function (widget) {',"       UWA.extend(widget, "+s(t)+");","   });","<\/script>","</body>","</html>"];u.open();u.write(r.join("\n"));u.close()},getIframeUrl:function(){var q,p,s=this,r=[],o=s.options,t=s.data,u={uwaUrl:s.url,id:s.id,cache:o.cache,header:o.displayHeader,footer:o.displayFooter,scroller:o.displayScroller,displayEdit:o.displayEdit,autoLaunch:o.autoLaunch&&!o.offlineMode,useAppCache:o.useAppCache,offlineMode:o.offlineMode,chromeColor:o.color,widgetDomain:window.location.toString().replace(/#.*$/,""),themeUrl:o.themeUrl,lang:o.lang};if(!o.offlineMode){u.readOnly=o.readOnly;for(q in t){if(t.hasOwnProperty(q)&&!u.hasOwnProperty(q)){u[q]=t[q]}}}for(q in u){if(u.hasOwnProperty(q)&&u[q]!==null){r.push(q+"="+j(u[q]))}}p=s.getIframeDomain()+"?"+r.join("&");if(p.length>2048){throw new Error("UWA.Embedded iframe url is more than 2048 characters please implement UWA.Embedded using offlineMode=true.")}return p},getIframeDomain:function(){var o,p=this.options,q=p.exposition;if(p.subDomain){o=h.getCheckSum(this.url);q=q.replace("://","://"+p.subDomainPattern.replace("{id}",o))}q+="/widget/frame";return q},initRemote:function(){var o,q=this,p=q.options;if(!q.socket){if(!c.Servers[p.remoteName]){c.Servers[p.remoteName]=new m.Server(p.remoteName)}o=new m.Socket(q.id+"-master");o.subscribeServer(p.remoteName,window,window.location.toString());o.addListener("widgetMessage",function(t){var r=t.args,s=r.shift();q.disableRemote=s;q.dispatchEvent(s,r);q.disableRemote=false});q.socket=o;q._runRemoteQueue()}},_runRemoteQueue:function(){var q,o,p=this;if(!p.socket||p._remoteQueue.length===0){return}o=p._remoteQueue.shift();if(p.disableRemote===true||p.disableRemote===o[0]){p.log("sendRemote message ignored: "+o)}else{q={id:p.id,args:o};p.log("sendRemote message: "+o);p.socket.dispatchEvent("environmentMessage",q,[q.id+"-slave"])}p._runRemoteQueue()},sendRemote:function(){var o=this;o._remoteQueue.push(h.toArray(arguments));o._runRemoteQueue()},launch:function(o,p){if(p!==undefined){this.options.readOnly=p}if(o!==undefined){this.data=o}this.disableRemote=false;this.sendRemote("launchWidget",this.data,this.options.readOnly)},setChromeColor:function(o){this.dispatchEvent("onColorize",[o]);this.sendRemote("onColorize",o)},setTitle:function(o){this.dispatchEvent("onUpdateTitle",[o]);this.sendRemote("onUpdateTitle",o)},setIcon:function(o,p){this.dispatchEvent("onUpdateIcon",[o,p]);this.sendRemote("onUpdateIcon",o,p)},setValue:function(o,p){this.dispatchEvent("onUpdateValue",[o,p]);this.sendRemote("onUpdateValue",o,p)},setValues:function(o){var p;for(p in o){if(o.hasOwnProperty(p)){this.setValue(p,o[p])}}},resizeHeight:function(p,o){this.dispatchEvent("onResizeHeight",[p,o]);this.sendRemote("onResize")},resizeWidth:function(p,o){this.dispatchEvent("onResizeWidth",[p,o]);this.sendRemote("onResize")},onRegisterWidget:function(){var p=this,o=p.options;p.loadTime=new Date().getTime();p.disableRemote=false;if(o.autoLaunch&&(o.offlineMode||o.useAsyncFrame)){p.launch()}},onUpdateTitle:function(o){if(this.title!==o){this.title=o;if(this.elements.title&&this.options.buildHeader&&this.options.title===null){k(this.elements.title,{text:d.stripTags(o)})}}},onUpdateIcon:function(o){if(this.icon!==o){this.icon=o;if(this.options.buildHeader){var p=this.elements.icon,q=e("img",{src:o,onload:function(){p.src=o}});if(q.complete&&q.width>0){p.src=o}}}},onUpdatePreferences:function(o){this.preferences=o},onUpdateValue:function(o,p){if(this.data[o]!==p){this.data[o]=p}},onResizeHeight:function(r,q){var o=this.options,p=o.maxHeight,s=p&&r>p;if(this.elements.iframe&&(q||o.height==="auto")){this.elements.iframe.height=s?p:r}},onResizeWidth:function(q,p){var o=this.options;if(this.elements.iframe&&(p||o.width==="auto")){this.elements.iframe.width=q}},onColorize:function(o){var p=this.options,q=this.elements;p.color=o;if(p.buildHeader){if(o!=="transparent"){b(q.header,{background:'url("'+p.uwa+f.paths.css+"themes/blueberry/img/moduleheader"+(o!=="white"?"_"+o:"")+".png?v="+this.version+'") repeat-x scroll center top transparent'})}else{b(q.header,{background:null})}b(q.title,{color:(o!=="transparent"?"white":"black")})}},onViewRequest:function(o){if(!o){o={}}o.error="No view implementation in Embedded mode";this.sendRemote("onViewError",o)},getCode:function(x){var u,s,o,q,v=this,p=v.url,y=JSON.stringify,z=v.options,r={},t=["/lib/c/UWA/js/UWA_Embedded.js"],w={uwa:z.uwa,exposition:z.exposition};for(o in z){if(z.hasOwnProperty(o)){if(o!=="container"&&z[o]!==null&&v.defaultOptions[o]!==z[o]){if(!g(z[o])){r[o]=z[o]}}}}if(x&&t.length===1){q=['<script type="text/javascript">',"var UWA = {hosts:"+y(w)+"}, UWA_ASYNC = UWA_ASYNC || [];",'    UWA_ASYNC.push({url: "'+p+'",options:'+y(r)+"});","(function () {",'    var a = document.getElementsByTagName("script"), b = a[a.length - 1] || document.body.lastChild,','        c = b.parentNode, d = document.createElement("script"), e = document.createElement("div");','    e.id = "UWA_ASYNC"; d.type = "text/javascript"; d.async = true;','    d.src = ("https:" == document.location.protocol ? "https://" : "http://") + UWA.hosts.uwa.split("://")[1] + "'+t[0]+"?v="+this.version+'";',"    c.insertBefore(d, b); c.insertBefore(e, b)","})();","<\/script>"]}else{q=[];q.push('<script type="text/javascript"> var UWA = {hosts:'+y(w)+"}; <\/script>");for(u=0,s=t.length;u<s;u++){q.push('<script type="text/javascript" src="'+z.uwa+t[u]+"?v="+this.version+'"><\/script>')}q.push('<script type="text/javascript">');q.push('var MyWidget = new UWA.Embedded("'+p+'"'+(!g(r)?","+y(r):"")+");");q.push("<\/script>")}return q.join("\n")}});c.Instances={};c.Servers={};(function(){var p,o,q;if(window.UWA_ASYNC){q=window.UWA_ASYNC;f.Widgets=f.Widgets||[];for(p=0,o=q.length;p<o;p++){f.Widgets[p]=new c(q[p].url,q[p].options||{})}}}());return f.namespace("Embedded",c,f)});