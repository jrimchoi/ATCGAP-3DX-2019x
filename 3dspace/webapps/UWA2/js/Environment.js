define("UWA/Environment",["UWA/Core","UWA/String","UWA/Array","UWA/Class","UWA/Class/Timed","UWA/Class/Events","UWA/Class/Debug","UWA/Class/Options","UWA/Utils","UWA/Element","UWA/Event","UWA/Json","UWA/Data","UWA/Internal/StringMap","UWA/Widget","UWA/Controls/Form","UWA/Controls/WidgetPopupMenu","UWA/Embedded","UWA/Promise","UWA/Utils/Client","UWA/Utils/Asset"],function(k,b,r,u,a,o,w,s,f,p,x,c,i,v,e,l,d,h,g,q,t){function m(y){var A=k.hosts.netvibes+"/subscribe.php",z={module:"UWA",moduleUrl:y.getUrl()};y.getPreferences().forEach(function(B){z[B.name]=B.value});return A+"?"+f.toQueryString(z)}var j=Object.create(null);var n=u.extend(a,o,w,s,{name:null,inited:false,registered:false,launched:false,widget:null,html:null,features:{},views:{},defaultOptions:{formOptions:{nativeInputs:false},defaultView:{type:"windowed"},initialView:null},init:function(y){var z=this;z.setOptions(y);z.html={};z.view={};z.dispatchInit()},dispatchInit:function(){var y=this;y.setPeriodical("init",function(){if(document.body&&!y.inited){y.clearPeriodical("init");y.dispatchEvent("onInit");y.inited=true}},100,true)},hasFeature:function(z,y){var B,A=k.owns(this.features,z)&&this.features[z];if(!A){return false}if(y){for(B in y){if(k.owns(y,B)&&(!k.owns(A,B)||y[B]!==A[B])){return false}}}return true},getWidget:function(){var y=this,z=y.widget||new e();if(!y.widget){y.registerWidget(z)}return z},registerWidget:function(z){var y=this;y.widget=z;y.setPeriodical("register",function(){if(y.inited&&!y.registered){var B,A=y.html;y.clearPeriodical("register");z.environment=y;for(B in A){if(A.hasOwnProperty(B)&&A[B]!==window){z.elements[B]=k.extendElement(A[B])}}z.body=A.body;k.Widgets=k.Widgets||{};k.Widgets.instances=k.Widgets.instances||[];k.Widgets.instances.push(z);y.dispatchEvent("onRegisterWidget");y.registerMenus();y.registered=true}},100,true)},launchWidget:function(A,B){var z,y=this;y.setPeriodical("launch",function(){if(y.isDataReady()&&y.registered){y.clearPeriodical("launch");z=y.getWidget();z.launch(A,B)}},100,true)},destroy:function(){var A,y,B=this,z=B.html,C=B.widget;if(C){k.Widgets.instances.splice(k.Widgets.instances.indexOf(C),1);C.destroy();B.widget=null}B.clearDelayed();B.clearPeriodical();for(A in z){if(z.hasOwnProperty(A)){p.destroy.call(z[A])}}for(y in B.view){if(B.view.hasOwnProperty(y)&&B.view[y]){B.view[y].destroy()}}B.removeEvent();B.registered=false;B.launched=false},onInit:function(){},onRegisterWidget:function(){var z=this,y=z.html,A=z.widget;z.data=new v();if(y.menus){p.addEvent.call(y.menus,"click",function(C){var B=x.getElement(C),D=z.widget.getMenu(B.getAttribute("data-name"));if(D){z.dispatchEvent("onMenuExecute",[D]);if(D.items){if(!z.popupMenu){z.popupMenu=new d(z).inject(document.body)}z.popupMenu.setTarget(B).setItems(D.items).toggle()}}})}if(y.editAction){p.show.call(y.editAction);p.addEvent.call(y.editAction,"click",function(B){x.stop(B);z.dispatchEvent("toggleEdit")})}if(y.refreshAction){p.show.call(y.refreshAction);p.addEvent.call(y.refreshAction,"click",function(B){x.stop(B);z.dispatchEvent("onRefresh")})}if(y.shareAction){y.shareAction.href=m(A);p.addEvent.call(y.shareAction,"click",function(B){x.stop(B);z.dispatchEvent("onOpenURL",m(A))})}if(y.wrapper){p.handleExternalLinks.call(y.wrapper,function(B,C){z.dispatchEvent("onOpenURL",[B,C])})}if((y.viewport||y.wrapper)){p.addEvent.call((y.viewport||y.wrapper),"resize",function(){z.dispatchEvent("onResize")})}p.addEvent.call(document,"keydown",function(B){var C=B.which||B.keyCode;z.dispatchEvent("onKeyboardAction",[C,B])});if(y.body){[q.Engine.name,q.Engine.name+q.Engine.version,q.Platform.name,q.Features.touchEvents?"touch":"no-touch",A.readOnly&&"readonly",z.name&&"environment-"+z.name].forEach(function(B){if(B){p.addClassName.call(y.body,B)}})}z.dispatchEvent("onResize");z.dispatchEvent("onViewRequest",[z.options.initialView])},registerMenus:function(){},onUpdateMenu:function(y){if(!this.html.menus){return}if(!y){y=this.widget.menus}this.html.menus.empty();y.forEach(function(B){var A,z;if(k.is(B.visible,"function")){A=B.visible()}else{A=(B.visible!==false)}if(A!==false){z=k.createElement("span",{"class":"uwa-widget-menu-button","data-name":B.name});if(B.help){z.set("title",B.help);z.set("uwa-tooltip",b.escapeHTML(B.help))}if(B.icon){z.addClassName("uwa-icon "+B.icon)}if(B.className){z.addClassName(B.className)}z.inject(this.html.menus);if(this.html.header){this.html.header.set("data-menus-items",this.html.menus.childNodes.length)}}},this)},onMenuExecute:function(y){if(k.is(y.onExecute,"string")){this.widget.dispatchEvent(y.onExecute,[y])}},isDataReady:function(){return !k.Storage||k.Storage.allInstancesReady()},getAllData:function(){return this.data.getAll()},getData:function(y){this.log("getData:"+y);return this.data.get(y)},setData:function(y,z){this.log("setData:"+y+","+z);return this.data.set(y,z)},deleteData:function(y){this.log("deleteData:"+y);return this.data.remove(y)},dispatchEvent:function(A,z,D,C){this.log("environment.event:"+A);var y=this,B=y.widget;if(!C&&B){y.addEventOnce(A,B.dispatchEvent.bind(B,A,z,D,true))}y._parent(A,z,D)},loadWidget:function(A,z){var y={onFailure:function(B){throw B},onTimeout:function(B){throw B},onComplete:function(){}};z=k.extend(y,z);A=f.buildUrl(window.location.toString(),A);if(z.embedded){this.loadEmbeddedWidget(A,z)}else{this.loadInlinedWidget(A,z)}return this},loadInlinedWidget:(function(){var z,y={};function A(C,D,B){if(y[C]){r.invoke(y[C],D,B);delete y[C]}}z=function(D,B){var C=B.expositionError||B.error||B.errors;if(C&&!(k.is(C,"array")&&C.length===0)){A(D,"onFailure",C);return}B=this.convertSourceToJson(B);if(!B.className){if(!B.checksum){B.checksum=f.getCRC32(D)}B.className="w-"+B.checksum}if(B.style){f.setCss(B.className,B.style,"."+B.className,D);delete B.style}if(typeof B.script==="string"){B.script=new Function("widget",B.script)}B.styles=this.filterExternalResources("style",B.styles||[]);B.scripts=this.filterExternalResources("script",B.scripts||[]);var E=[];while(B.styles.length){E.push(t.css(f.buildUrl(D,B.styles.shift())))}while(B.scripts.length){E.push(t.js(f.buildUrl(D,B.scripts.shift())))}g.all(E).done(function(){var F=y[D];y[D]=B;if(k.is(F,"array")){r.invoke(F,"onComplete",B)}},function(F){A(D,"onFailure",F)})};return function(C,B){var G=y[C],E=B.fetcher||"XML",F=B.onComplete,D=this;B.onComplete=function(H){var I=D.getWidget();I.uwaUrl=C;I.setTitle(H.title);I.setIcon(H.icon);I.setMetas(H.metas);I.setPreferences(H.preferences);I.setPlugins(H.plugins);I.setBody(H.body);D.html.wrapper.addClassName(H.className);if(H.script){H.script(I)}F(I,D)};if(k.is(G,"object")){B.onComplete(G)}else{if(k.is(G,"array")){G.push(B)}else{y[C]=[B]}B=k.merge({onComplete:z.bind(this,C),onTimeout:A.bind(this,C,"onTimeout"),onFailure:A.bind(this,C,"onFailure")},B);if(k.is(E,"function")){E.call(this,C,B)}else{if(!k.is(E,"string")||E.length>4){B.onComplete(E)}else{E=E.toUpperCase();if(E==="JSON"){this.fetchJsonWidget(C,B)}else{this.fetchXmlWidget(C,B)}}}}return this}}()),loadEmbeddedWidget:function(B,A){var C,E,y=this,D=p.setStyle,z={cache:A.cache,container:y.html.body,displayHeader:false,displayFooter:false,displayEdit:true,autoLaunch:false};if(k.is(A.embedded,"object")){k.extend(z,A.embedded)}C=new h(B,z);D.call(y.html.body,"padding",0);D.call(C.elements.body,"padding",0);y.addEvent("onRegisterWidget",function(){var F={},G={onUpdateValue:true,onRefresh:true,onUpdateTitle:true,onUpdateIcon:true,onUpdateCounter:true,onSearch:true,onResetSearch:true,onShowEdit:true,onKeyboardAction:true,onViewError:true,onViewChange:true,onEdit:true,endEdit:true,onLoad:function(){C.launch(y.getAllData(),y.getWidget().readOnly)}};Object.keys(G).forEach(function(I){var H=G[I];if(H===true){H=C.sendRemote.bind(C,I)}F[I]=H});y.addEvents(F)});E=y.getWidget();C.addEvent("onRegisterWidget",function(){var F={},G={onRefresh:true,onUpdateTitle:true,onUpdateIcon:true,onUpdateCounter:true,onSearch:true,onResetSearch:true,onHideEdit:true,onShowEdit:true,onOpenURL:true,onViewRequest:true,onInitConfig:function(H){if(H.preferences){E.setPreferences(H.preferences)}if(H.plugins){E.setPlugins(H.plugins)}if(H.metas){E.setMetas(H.metas)}},onUpdatePreferences:function(H){E.setPreferences(H)},onUpdateValue:function(H,I){E.setValue(H,I)}};if(!z.displayEdit){k.merge(G,{onEdit:true,endEdit:true})}Object.keys(G).forEach(function(I){var H=G[I];if(H===true){H=function(){E.dispatchEvent(I,arguments)}}F[I]=H});C.addEvents(F);A.onComplete(E,y)});y.embedded=C;return y},convertSourceToJson:(function(){var E=["name","defaultValue","type","label","step","min","max"],D=["label","value"],z=/(java|ecma)script$/i;function y(J,K,F){var I,G,H,L=[].slice.call(J.childNodes);for(I=0,G=L.length;I<G;I++){H=L[I];if(!F||H.nodeType===1){K(H,H.nodeValue)}}}function C(J,K){var H,F,I,G=J.attributes||[];for(H=0,F=G.length;H<F;H++){I=G[H];K(I.name,I.value)}}var A={"widget:preferences":function(F,G){y(G,function(J){var H,I={};C(J,function(K,L){if(E.indexOf(K)!==-1){I[K]=L}});if(I.name){if(I.type==="list"||I.type==="checklist"){H=[];y(J,function(K){var L={};C(K,function(M,N){if(D.indexOf(M)!==-1){L[M]=N}});if(L.label){H.push(L)}},true);I.options=H}F.preferences.push(I)}},true)},"widget:plugins":function(F,G){y(G,function(H){var I={name:G.getAttribute("name"),options:{}};C(H,function(J,K){I[J]=K});y(H,function(K){var J=K.getAttribute("name"),M=K.getAttribute("value"),L=K.tagName;if(L==="widget:options"){I.options[J]={};y(K,function(O){var N=O.getAttribute("name"),P=O.getAttribute("value");if(N){I.options[J][N]=P}},true)}else{if(J){I.options[J]=M}}},true);if(I.name){F.plugins.push(I)}})},link:function(H,I,F){if(F.href){var G=F.rel;if(G==="icon"){H.icon=F.href}else{if(G==="stylesheet"&&!F.href.contains("UWA/assets")&&!F.href.contains("standalone.css")&&!F.href.contains("uwa/style.css")){H.styles.push(F.href)}}}},meta:function(H,I,F){var G=F.content;G=(G==="false"?false:(G==="true")?true:G);H.metas[F.name]=G},script:function(H,I,F){if(!F.src&&((!F.language&&!F.type)||z.test(F.type)||F.language)){var G="";y(I,function(K,J){G+=J});if(!/UWA(\s+)?=/.test(G)){H.script+=G}}else{if(F.src&&!F.src.contains("Standalone")&&!F.src.contains("load.js.php")){H.scripts.push(F.src)}else{return I}}},title:function(F,G){y(G,function(I,H){F.title+=H})},style:function(F,G){y(G,function(I,H){F.style+=H})},fallback:function(H,I,F,J){var G;if(J==="body"){G=document.createElement("div");G.className=I.className;H.body=G}else{G=document.createElement(J)}C(I,function(K,L){G.setAttribute(K,L)});y(I,function(L,K){switch(L.nodeType){case 1:var M=B(L,H);if(M){G.appendChild(M)}break;case 4:case 3:G.appendChild(document.createTextNode(K));break;case 8:break}});return G}};function B(F,G){if(F.nodeType===9){F=F.childNodes[0]}var I=F.nodeName.toLowerCase(),H={};C(F,function(J,K){H[J]=K});return A[A.hasOwnProperty(I)?I:"fallback"](G,F,H,I)}return function(H){if(k.is(H,"string")){try{H=f.loadXml(H)}catch(G){k.log("Invalid UWA XHTML source detected, fallback on HTML parsor.");H=f.loadHtml(H)}}var F;if(!k.is(H,"object")){F={title:"",icon:"",preferences:[],plugins:[],metas:{},body:[],script:"",scripts:[],style:"",styles:[]};B(H,F)}else{F=H}return F}}()),fetchJsonWidget:function(z,y){if(!(z in j)){j[z]=new g(function(D,C){var A,B={mode:"full",uwaUrl:z};if(k.debug){B.flush=1;B.mode="full_debug"}A=(y.server||k.hosts.exposition)+"/widget/json";c.request(A,{data:B,onComplete:D,onFailure:C,useJsonpRequest:true})})}j[z].then(y.onComplete,y.onError)},fetchXmlWidget:function(z,y){i.request(z,{cache:y.cache,type:"text",onFailure:y.onFailure,onTimeout:y.onTimeout,onComplete:y.onComplete})},filterExternalResources:function(y,z){return z},onRefresh:function(){var y=this.getWidget();y.data={};if(!y.hasEvent("onRefresh")){y.dispatchEvent("onLoad",undefined,undefined,true)}},onUpdateIcon:function(A){var B=this,y=B.html;function z(){y.iconLoader.destroy();delete y.iconLoader}if(y.icon){if(y.iconLoader){z()}y.iconLoader=k.createElement("img",{styles:{display:"none"},events:{load:function(){y.icon.getElement("img").setAttribute("src",A);z()},error:function(){z()}}}).inject(B.html.wrapper);y.iconLoader.setAttribute("src",A)}},onUpdateTitle:function(z){var y=this.html.title;if(y){y.setHTML(z)}},onUpdateCounter:function(z){var y=this.html.counter;if(y){y.setText(z?"("+(z===true?"●":z)+")":"")}},onEdit:function(){var A=this,z=A.html,B=A.getWidget(),y=B.metas,D=B.getPreferences();if(z.edit){z.edit.empty();if(B.hasPreferences()){if(z.preferences){var C=z.preferences.getFormValues();D.forEach(function(E){if(k.is(C[E.name])){E.value=C[E.name]}})}D.push({type:"submit",name:"endEdit",value:k.i18n("Done")});if(z.preferences){z.preferences.destroy()}z.preferences=new l({nativeInputs:this.options.formOptions.nativeInputs,darkBackground:this.options.formOptions.darkBackground,fields:D,events:{onChange:function(F,E,G){B.setValue(E,G);if(A.embedded){A.embedded.sendRemote("dispatchEvent",F,E,G)}else{A.dispatchEvent(F,[E,G])}},onSubmit:function(G,E){var F=false;A.addEventOnce("onUpdateValue",function(){F=true});Object.keys(E).forEach(function(H){B.setValue(H,E[H])});A.dispatchEvent("endEdit");if(F){A.dispatchEvent("onRefresh")}}}}).inject(z.edit)}if(y.author){z.edit.addContent({tag:"div","class":"moduleInfos",html:[{tag:"p",html:[k.i18n("Widget by")+" ",{tag:"strong",html:y.website?{tag:"a",href:y.website,text:y.author}:{tag:"span",text:y.author}}]}]})}}A.dispatchEvent("onShowEdit")},onShowEdit:function(){var y=this.html;if(y.wrapper){y.wrapper.addClassName("onEdit")}},endEdit:function(){var y=this;y.dispatchEvent("onHideEdit")},onHideEdit:function(){var y=this.html;if(y.wrapper){y.wrapper.removeClassName("onEdit")}},onCloseEdit:function(){var y=this;y.html.preferences.destroy();y.html.preferences=null},onOpenURL:function(y){y=f.parseUrl(y);if(!window.open(y.source,"_blank")){window.alert(b.format(k.i18n('Unable to open "{0}", Please turn off your popup blocker and try again.'),b.truncate(y.source,50)));return false}},onViewRequest:(function(){function A(D,C,B){if(B){C.error=B}D.dispatchEvent(B?"onViewError":"onViewChange",[C])}function z(B,C,D){if(B[C]){B[C].destroy()}B[C]=D}function y(B,D){var E=B.views[D.type],C=E&&new E(B,D);return C&&C.addEvents({onEnter:function(){if(B.view.next===this){z(B.view,"current",this);if(this.isSingle()){n._currentSingleView=this}B.view.next=null;A(B,this.event)}},onLeave:function(){if(B.view.current===this){if(n._currentSingleView===this){n._currentSingleView=null}if(!B.view.next){B.view.next=y(B,B.options.defaultView)}B.view.next.enter()}},onError:function(F){if(B.view.next===this){z(B.view,"next");B.view.current.enter()}A(B,this.event,F)}})}return function(D){var B,C=this;if(!D){D=C.options.defaultView}D=k.clone(D);if(C.view.current&&C.view.current.event){D.previous=k.clone(C.view.current.event);delete D.previous.previous}if(C.view.current&&C.view.current.matchEvent(D)){A(C,D,"This view is already active.")}else{B=y(C,D);if(!B){A(C,D,'No implementation available for the view "'+D.type+'".')}else{if(B.isSingle()&&n._currentSingleView&&n._currentSingleView!==C.view.current){A(C,D,"An environment is already in single view.");B.destroy()}else{z(C.view,"next",B);if(!C.view.current){C.view.next.enter()}else{C.view.current.leave()}}}}}}()),onViewChange:function(y){this.getWidget()._view=y},onViewError:function(y){this.log("View error: "+c.encode(y))}});n.AbstractView=u.extend(o,{event:null,environment:null,init:function(y,z){this.environment=y;this.event=z},destroy:function(){this.removeEvents();if(n._currentSingleView===this){n._currentSingleView=null}},enter:function(){this.dispatchEvent("onEnter")},leave:function(){this.dispatchEvent("onLeave")},isSingle:function(){return false},matchEvent:function(y){return this.event.type===y.type},onEnter:function(){var y=this.environment.html;if(y.wrapper&&y.body){r.invoke([y.wrapper,y.body],"addClassName",this.event.type+"-view")}},onLeave:function(){var y=this.environment.html;if(y.wrapper&&y.body){r.invoke([y.wrapper,y.body],"removeClassName",this.event.type+"-view")}}});n.prototype.views.windowed=n.AbstractView.extend({});if(q.Features.fullscreen){n.prototype.views.fullscreen=n.AbstractView.extend({enter:function(){var z,y=this,A=y.getTarget();z={fullscreenchange:function(){if(document.fullscreenElement===A){y.dispatchEvent("onEnter")}else{y.dispatchEvent("onLeave");p.removeEvents.call(document,z)}},fullscreenerror:function(){y.dispatchEvent("onError",["Error while trying to set the fullscreen"]);p.removeEvents.call(document,z)}};p.addEvents.call(document,z);A.requestFullscreen()},leave:function(){if(document.fullscreenElement===this.getTarget()){document.exitFullscreen()}else{this.dispatchEvent("onLeave")}},isSingle:function(){return true},getTarget:function(){var y=this.environment.html;return y.content||y.body}})}return k.namespace("Environment",n,k)});