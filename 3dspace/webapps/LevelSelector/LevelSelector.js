/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/LevelSelector/LevelSelector",["UWA/Core","UWA/Class","UWA/Element","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","css!DS/LevelSelector/LevelSelector.css"],function(n,p,e,m,q){var o="#285a78",c="#558caa";var l="#82bedc",r="#c0c0c0";var b="#dcdcdc",s="#bebebe";var f=20,k=7,a=5,d=f+2*a;var h;var j=p.extend({init:function(){var af,H,O,W,R,t;var Z=n.createElement("div",{id:"LevelSelector"});var U=n.createElement("div",{id:"selector-indic","class":"levelselector-indic"});var S=n.createElement("div",{id:"selector-name","class":"levelselector-info levelSelectorTextProperties"});var T=n.createElement("div",{"class":"transparent"});T.setStyle("position","absolute");var P,u,z,I,L,J,M=0,ag=false;var B,G,ai=false,A,ah;var E=function(ak){var al=false;if(ak&&ak.type&&(ak.type==="touchmove"||ak.type==="touchstart"||ak.type==="touchend")){al=true}return al};function aa(ak){return ai?((ak+1)*10+5):(ak*14+10)}function y(){if(A&&A.backgroundColor){var al=new q.Color(A.backgroundColor);var ak=al.getHSL().l*255;if(ak>120){S.removeClassName("white")}else{S.addClassName("white")}S.setStyle("background-color","rgb("+(al.r*255)+","+(al.g*255)+","+(al.b*255)+")")}}var Y=(function(){var ak;function al(ao,ap,aq,an){ao.forEach(function(ar){if(aq){ar.addClassName(ap)}else{ar.removeClassName(ap)}});if(an){an()}}return function am(ap,ao,an){clearTimeout(ak);ak=undefined;if(ao){al(ap,"transparent",ao);if(h!==true){ak=setTimeout(function(){al(ap,"hidden",ao,an)},100)}else{al(ap,"hidden",ao,an)}}else{al(ap,"hidden",ao);if(h!==true){setTimeout(function(){al(ap,"transparent",ao,an)},10)}else{al(ap,"transparent",ao,an)}}}})();var ac=function(aq){if(aq&&W){var ak=parseInt(aq.id.replace("levelSelector-",""),10);var ao=aq.getElement("canvas");if(!ao){return}var an=aa(ak);var am=ao.getContext("2d");am.clearRect(0,0,f,an);am.lineWidth=B===ak&&(!z||z!==I)?2:1;am.strokeStyle=B===ak?R:s;am.fillStyle=W[ak-1].canvasColor?W[ak-1].canvasColor:b;var ap=W[ak-1].selection;if(aq===I){am.lineWidth=1;am.strokeStyle=s;am.fillStyle=ap==="notSelectable"?r:l;am.fillStyle=B===ak?t:am.fillStyle;if(aq===z){am.fillStyle=ap==="notCurrent"?o:(ap==="notSelectable"?r:R)}var al=n.is(u);U.setStyles({"border-bottom-color":(al?am.fillStyle:""),"border-top-color":(al?"":am.fillStyle)});S.setStyle("border-color",am.fillStyle)}else{if(z&&z===I&&z!==aq){am.strokeStyle=s}}am.beginPath();am.moveTo(f-1,1);am.lineTo(f-1,an-1);am.lineTo(1,an-6);am.lineTo(1,ai?1:6);am.lineTo(f-1,1);am.fill();am.beginPath();am.moveTo(f-1,1);am.lineTo(f-1,an-1);am.lineTo(1,an-6);am.lineTo(1,ai?1:6);am.lineTo(f-1,1);am.stroke()}};var V=function(al,am){if(am&&al){var ak=parseInt(al.id.replace("levelSelector-",""),10);am({pathElement:W[ak-1].pathElement})}};var ab=function(am){if((am.labelWidth&&am.iconWidth)||(am.labelWidth&&!am.iconWidth&&!am.icon)||(!am.labelWidth&&am.iconWidth&&!am.name)){return}if(!am.labelWidth&&am.name){var an=n.createElement("span",{"class":"levelSelectorTextProperties transparent"});an.innerHTML=am.name;an.inject(T);var al=setInterval(function(){if(!W){an.destroy();clearInterval(al)}else{if(an.offsetWidth>0){am.labelWidth=an.offsetWidth;an.destroy();clearInterval(al)}}},10)}if(!am.iconWidth&&am.icon){var ak=n.createElement("img",{"class":"transparent"}),ao;ak.src=am.icon;ak.inject(T);ak.onerror=function(){am.icon="";ak.destroy();clearInterval(ao)};ao=setInterval(function(){if(!W){ak.destroy();clearInterval(ao)}else{if(ak.naturalWidth>0){am.iconWidth=ak.naturalWidth;ak.destroy();clearInterval(ao)}}},10)}};var D=(function(){function ak(){M=0;Y([U,S],true,function(){S.empty(true);S.setHTML("");S.removeAttribute("style");y()})}return function(az){if(W){for(var ar=0;ar<W.length;ar++){ab(W[ar])}var aA=I&&az===I?az:(G?Z.querySelector("#levelSelector-"+B):null);if(aA){var aE=parseInt(aA.id.replace("levelSelector-",""),10);var ay=W[aE-1];var aF=ay.name,aB=ay.icon,aq=n.is(u);var ao=aF&&(typeof aF==="string")&&aF.trim();var at=aB&&(typeof aB==="string")&&aB.trim();if(ao||at){var av=aa(W.length);var aD=[S];if(!ai){aD.push(U)}Y(aD,false);if(!ai){U.style.left=((aE-1)*d+f/2+a-U.offsetWidth/2)+"px";U.style.top=aq?"-15px":(av+13)+"px";if(aq){U.setStyles({"border-bottom-width":"16px","border-bottom-style":"solid","border-top-width":"","border-top-style":""})}else{U.setStyles({"border-top-width":"16px","border-top-style":"solid","border-bottom-width":"","border-bottom-style":""})}}if(!ai){S.setStyles({top:aq?"-53px":(av+35)+"px"})}if(ao){S.setHTML(aF);var aw=ay.labelWidth||aF.length*8;aw+=16;if(at){var ap=ay.iconWidth||16;S.setStyle("background-image","url("+aB+")");S.setStyle("padding-left",(ap+10)+"px");aw+=(ap+5)}else{S.setStyles({"background-image":"","padding-left":""})}if(!ai){var an=Z.offsetLeft;var ax=an+15-aw/2;var au=an+(aE-1)*30-2+15+aw/2;var al=(aE-1)*30+15-aw/2;if(ax<0){al-=ax}else{var aC=P.getParent().getSize().width;if(au>aC){al-=(au-aC)}}S.setStyle("left",al+"px")}}else{S.setHTML("");S.setStyles({"background-image":"","padding-left":""});n.createElement("img",{"class":"levelselector-info-icon",src:aB}).inject(S);S.setStyle("left",((aE-1)*30-2)+"px")}var am=Z.querySelector(".levels");if(am&&ai){am.setStyle("top",S.offsetHeight+"px")}}else{ak()}}else{ak()}}}})();var v=false;var K=function(ak){if(J&&ak.eventType==="@onViewpointBeginMove"){v=true}else{if(J&&ak.eventType==="@onViewpointChange"&&v){Z.addClassName("hidden")}else{if(J&&ak.eventType==="@onViewpointEndMove"){Z.removeClassName("hidden");v=false}else{if(ag&&ak.eventType==="@onMoveEvent"&&ak.event&&ak.event.deltaPosition&&(ak.event.deltaPosition.x!==0||ak.event.deltaPosition.y!==0)){M++;if(M>=5){ac(I);V(I,O);I=null;D()}}}}}};var Q=function(ao){var am=null;var al=ao.changedTouches[0].clientX,ak=ao.changedTouches[0].clientY;var an=Z.getPosition();Z.getElements('div[id^="levelSelector"]').some(function(at){var av=at.getPosition(),aq=at.getDimensions();var ar=av.x+an.x,aw=ar+aq.width;var ap=av.y+an.y,au=ap+aq.height;if(ar<=al&&al<=aw&&ap<=ak&&ak<=au){am=at;return true}return false});return am};var C=function(am){var ar=am.type==="keydown";ag=true;M=0;u=undefined;var ap=am.key||am.keyIdentifier,au=am.which||am.keyCode,at=null;if(ar&&(au===39||au===38||ap==="ArrowRight"||ap==="ArrowUp")){if(I){at=parseInt(I.id.replace("levelSelector-",""),10);at++;if(at>W.length){at=W.length}}else{at=1}}else{if(ar&&(au===37||au===40||ap==="ArrowLeft"||ap==="ArrowDown")){if(I){at=parseInt(I.id.replace("levelSelector-",""),10);at--;if(at<1){at=1}}else{at=W.length}}else{if(au===13||ap==="Enter"){if(I){if(ar){z=I;ac(I)}else{var an=z;z=null;if(an&&an===I){if(!an.hasClassName("notselectable")){if(B){var ao=parseInt(an.id.replace("levelSelector-",""),10);if(W[ao-1].selection!=="notCurrent"&&B!==ao){var aq=Z.querySelector("#levelSelector-"+B);B=ao;ac(aq)}}V(an,af)}ac(an)}}}return}}}if(at){var al=Z.querySelector("#levelSelector-"+at);if(al!==I){var ak=I;I=Z.querySelector("#levelSelector-"+at);ac(ak);V(ak,O);ac(I);D(I);V(I,H)}}};var w;var ae=function(ak){ag=false;if(ak.button!==0||ak.buttons!==1){z=null;return}w=m.subscribe({event:"/VISU/onLeftMouseUp"},function(am){m.unsubscribe(w);w=undefined;if(!am||!am.from||am.from.length===0||!am.from[0].view||!am.from[0].view.className||(am.from[0].view.className.search("level")!==0&&am.from[0].view.className.search("canvas")!==0)){z=null}});u=undefined;z=this;ac(z);if(!z.hasClassName("notselectable")){if(B){var al=Z.getElement("div#levelSelector-"+B);if(al!==z){ac(al)}}}};var ad=function(ak){ag=false;if(ak.touches.length!==1){return}u=ak.touches[0].identifier;ak.preventDefault();ak.stopPropagation();ak.stopImmediatePropagation();I=Q(ak);V(I,H);ac(I);D(I)};var x=function(al){ag=false;var ak=this,an;if(E(al)){al.preventDefault();al.stopPropagation();ak=Q(al)}if(ak!==I){var am=I;I=ak;ac(am);V(am,O);if(z&&am===z&&B){an=Z.getElement("div#levelSelector-"+B);if(an!==z){ac(an)}}if(E(al)){if(!ak||!n.is(u)||al.changedTouches.length!==1||u!==al.changedTouches[0].identifier){D(ak);I=undefined;return}}V(ak,H);ac(ak);if(z&&B&&!ak.hasClassName("notselectable")){an=Z.getElement("div#levelSelector-"+B);if(an!==z&&an!==ak){ac(an)}}D(ak)}};var N=function(){u=undefined;ag=false;var ak=I;I=undefined;ac(ak);if(z&&ak===z&&B){var al=Z.getElement("div#levelSelector-"+B);if(al!==z){ac(al)}}V(ak,O);D()};var aj=function(am){ag=false;if(am.button!==0||am.buttons!==0){return}var an=z;z=null;if(an&&an===this){if(!an.hasClassName("notselectable")){if(B){var al=Z.querySelector("#levelSelector-"+B);var ak=parseInt(an.id.replace("levelSelector-",""),10);if(W[ak-1].selection!=="notCurrent"){B=ak}ac(al)}V(an,af)}ac(an)}else{ac(an)}};var X=function(ak){ag=false;ak.preventDefault();ak.stopPropagation();var am=Q(ak);if(!am||!n.is(u)||ak.changedTouches.length!==1||u!==ak.changedTouches[0].identifier){return}z=am;ac(am);if(B){var al=Z.getElement("div#levelSelector-"+B);if(al!==z){ac(al)}}setTimeout(function(){var an=z;I=z=undefined;ac(an);V(an,O);if(!an.hasClassName("notselectable")){V(an,af);if(B){B=parseInt(an.id.replace("levelSelector-",""),10)}}ac(an);D()},100)};var F;this.createView=function(aB){if(F){clearTimeout(F);F=undefined;Z.remove();Z.empty(true)}if(L){Z.remove();Z.empty(true);af=H=O=W=undefined;P=u=I=B=z=undefined;m.unsubscribe(L);L=undefined;if(A){A.unsubscribe(ah);ah=A=undefined}e.removeEvent.call(document,"keydown",C);e.removeEvent.call(document,"keyup",C)}if(!aB.uiFrame||(!aB.hasOwnProperty("display")&&((typeof aB.positionX!=="number")||(typeof aB.positionY!=="number")))||(aB.hasOwnProperty("display")&&(!aB.display||!aB.display.type||(aB.display.type!=="position"&&aB.display.type!=="docked")||(aB.display.type==="position"&&(typeof aB.display.x!=="number"||typeof aB.display.y!=="number"))||(aB.display.type==="docked"&&aB.hasOwnProperty("marginW")&&(typeof aB.display.marginW!=="number"))||(aB.display.type==="docked"&&aB.hasOwnProperty("marginH")&&(typeof aB.display.marginH!=="number"))))||!aB.getLevels||(typeof aB.getLevels!=="function")||!aB.onSelect||(typeof aB.onSelect!=="function")||(aB.onHover&&(typeof aB.onHover!=="function"))||(aB.onLeave&&(typeof aB.onLeave!=="function"))){return undefined}ai=aB.display&&aB.display.type==="docked";var an;W=null;B=null;G=false;R=o;t=c;var aA=aB.getLevels(function(){D(I);if(an&&W){an.getChildren().forEach(function(aC){ac(aC)})}});if(aA instanceof Array){W=aA;B=G=undefined}else{if(aA instanceof Object){W=aA.levels;B=typeof aA.currentLevel==="number"?aA.currentLevel+1:undefined;if(B&&(B<=0||B>W.length)){B=undefined}if(B){R=typeof aA.selectColor==="string"?aA.selectColor:R;t=typeof aA.selectOverColor==="string"?aA.selectOverColor:t}G=B&&ai}}if(!(W instanceof Array)||W.length<=0||!W.every(function(aC){return aC&&aC.pathElement!==null&&aC.pathElement!==undefined})){W=undefined;return undefined}P=aB.uiFrame;af=aB.onSelect;H=aB.onHover;O=aB.onLeave;Z.addClassName("animatable");Z.removeAttribute("style");Z.removeClassName("hidden");if(h===true){Z.removeClassName("animatable")}U.removeAttribute("style");U.addClassName("transparent");U.addClassName("hidden");S.removeAttribute("style");S.addClassName("transparent");S.addClassName("hidden");S.removeClassName("white");S.empty(true);var at=W.length;if(ai){Z.addClassName("docked");if(typeof aB.display.marginW==="number"){Z.setStyle("margin-right",aB.display.marginW+"px")}if(typeof aB.display.marginH==="number"){Z.setStyle("margin-top",aB.display.marginH+"px")}}else{Z.removeClassName("docked");var ao=P.getParent().getSize();var ax=ao.width;var al=ao.height;var ar=aa(at);var am=(typeof aB.positionX==="number")?aB.positionX+10:aB.display.x-d/2;var ak=(typeof aB.positionY==="number")?aB.positionY-ar/2:aB.display.y-ar/2-k;if((am+d*at)>ax){am=ax-d*at}else{if(am<0){am=0}}if((ak+ar+60)>al){ak=al-60-ar}if(ak<0){ak=0}Z.setStyles({left:am,top:ak})}an=n.createElement("div",{"class":"levels"}).inject(Z);for(var az=1;az<=at;az++){var ay=aa(az);var aw=n.createElement("div",{id:"levelSelector-"+az,"class":"level"});aw.setStyle("height",(ay+2*k)+"px");if(!ai){aw.setStyle("top",((at-az)*7)+"px")}aw.addEvents({mouseenter:x,mouseleave:N,mouseup:aj,mousedown:ae});aw.addEvents({touchstart:ad,touchmove:x,touchend:X});if(W[az-1].selection==="notSelectable"){aw.addClassName("notselectable")}var av=n.createElement("canvas",{id:"canvas"+az,"class":"canvas"});av.inject(aw);av.setAttributes({width:f+"px",height:ay+"px"});ac(aw);if(h!==true){av.addClassName("transparent")}aw.inject(an)}A=undefined;if(ai&&aB.background&&aB.background.backgroundColor){A=aB.background;y()}Z.inject(P);an.inject(Z);if(!ai){U.inject(Z)}S.inject(Z);T.inject(Z);if(G){D()}var aq=50/at;var au=1;if(h!==true){var ap=setInterval(function(){var aC=an.querySelector("#canvas"+au);if(aC){aC.removeClassName("transparent");au++}else{clearInterval(ap)}},aq)}J=aB.displayWhileViewpointIsManipulated!==true;if(aB.displayWhileViewpointIsManipulated!==true||aB.disableKeyboard!==true){L=m.subscribe({event:"/VISU/"},K)}if(A&&A.onBackgroundModify&&A.unsubscribe){ah=A.onBackgroundModify(y)}if(aB.disableKeyboard!==true){e.addEvent.call(document,"keydown",C);e.addEvent.call(document,"keyup",C)}return 0};this.destroyView=function(){if(F){return}if(h!==true){if(Z){var al=Z.querySelectorAll(".canvas");for(var ak=0;ak<al.length;++ak){al[ak].addClassName("transparent")}U.addClassName("transparent");S.addClassName("transparent");F=setTimeout(function(){Z.remove();Z.empty(true);F=undefined},100)}}else{Z.remove();Z.empty(true)}af=H=O=W=undefined;P=u=I=B=z=undefined;m.unsubscribe(L);L=undefined;if(A){A.unsubscribe(ah);ah=A=undefined}e.removeEvent.call(document,"keydown",C);e.removeEvent.call(document,"keyup",C)}}});var g;var i=p.singleton({init:function(){Object.defineProperty(this,"_noAnim",{get:function(){return h},set:function(t){h=t===true?true:undefined}})},createView:function(t){if(!g){g=new j()}return g.createView(t)},destroyView:function(){if(g){return g.destroyView()}return undefined}});i.init();return i});