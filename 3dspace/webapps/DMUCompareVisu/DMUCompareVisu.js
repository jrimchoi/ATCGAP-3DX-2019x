define("DS/DMUCompareVisu/DMUBaseCompareServices",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Effects/CompareModelsEffect","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/EXPUtils","DS/DMUControls/EXPNotify","DS/DMUBaseUI/DMUTools3DCompare","DS/DMUControls/panels/DMU3DComparePanel","DS/WebappsUtils/WebappsUtils","i18n!DS/DMUCompareVisu/assets/nls/DMUCompareVisu"],function(b,j,a,l,f,g,e,h,c,m){var k,d=null;var i=b.extend({init:function(K,q){var I=this;var M,D,A=null;var t=[],w=[];var H=[],G=[],F=[],B=[];var r,s,E;var v,C;var o=false;var z;var J;var L;var u=true;this.compare=function(O){I.clean();if(!o){z=K.getViewer().renderer.renderer.materialMode;K.getViewer().setMaterialMode(true);if(navigator.appVersion.indexOf("Win")!==-1||navigator.appVersion.indexOf("Mac")!==-1){if(!d){d=new a(K.getViewer().renderer.renderer,K.getViewer().renderer.renderTargetPool);k=K.getViewer().renderer.addCustomEffect(d)}}o=true}var N=false;if(((O.New&&O.New.pathElement)||(O.New&&O.New.pathElements&&O.New.pathElements.length))&&((O.Old&&O.Old.pathElement)||(O.Old&&O.Old.pathElements&&O.Old.pathElements.length))){p(O);N=true}else{if(((O.New&&O.New.pathElement)||(O.New&&O.New.pathElements&&O.New.pathElements.length))||((O.Old&&O.Old.pathElement)||(O.Old&&O.Old.pathElements&&O.Old.pathElements.length))){L=new g({body:K.getUIFrame(),type:"info",messages:m.compareNotify_onemodel})}else{L=new g({body:K.getUIFrame(),type:"info",messages:m.compareNotify_nomodel})}}return N};this.updateCompareModel=function(N){y("New");y("Old");if(N.Old||N.New){n("Old"," ");n("New"," ");if(N.Old){if(N.Old.name){n("Old",N.Old.name)}x("Old",N.Old)}if(N.New){if(N.New.name){n("New",N.New.name)}x("New",N.New)}if(!N.noAutomaticReframe){K.getViewer().currentViewpoint.reframe(null,0)}K.getViewer().render()}};this.displayPanel=function(N){console.warn('"displayPanel" method is deprecated. Use "setLegendVisibleFlag" method instead');return I.setLegendVisibleFlag(N)};this.setLegendVisibleFlag=function(N){u=N;if(v){v.displaying(u)}};this.getLegendVisibleFlag=function(){return u};this.clean=function(){if(q&&q.removeReviewObjects&&K.removeReviewModel){K.removeReviewModel()}y("New");y("Old");if(L){L.destroy()}if(k!==undefined){K.getViewer().renderer.setCustomEffect(k,false)}K.getViewer().setSSAO(J);if(v){v.clean()}l.removeSceneGraphOverrideSet(K.getViewer(),C);if(z){K.getViewer().setMaterialMode(z)}t=[];w=[];H=[];G=[];F=[];B=[];r=s=E=null;M=D=A=J=null;v=C=L=null;K.getViewer().render()};function p(O){var N;if(O.New.pathElements&&O.New.pathElements.length){for(N=0;N<O.New.pathElements.length;N++){t.push(O.New.pathElements[N].clone())}}else{t.push(O.New.pathElement.clone())}if(O.Old.pathElements&&O.Old.pathElements.length){for(N=0;N<O.Old.pathElements.length;N++){w.push(O.Old.pathElements[N].clone())}}else{w.push(O.Old.pathElement.clone())}J=K.getViewer().useSSAO;if(J){K.getViewer().setSSAO(false)}if(k!==undefined){K.getViewer().renderer.setCustomEffect(k,true)}C=l.createSceneGraphOverrideSet(K.getViewer());r=O.Common.color?O.Common.color:"#EEEEEE";s=O.New.color?O.New.color:"#00FF00";E=O.Old.color?O.Old.color:"#FF0000";M=new j.MeshLambertMaterial({color:f.hexToColor(r),side:j.DoubleSide});M.force=true;D=new j.MeshLambertMaterial({color:f.hexToColor(s),side:j.DoubleSide});D.force=true;A=new j.MeshLambertMaterial({color:f.hexToColor(E),side:j.DoubleSide});A.force=true;if(v){v.clean()}else{v=new h()}v.buildPanel({title:O.TitleNls,icon:c.getWebappsAssetUrl("DMUBaseCommands","icons/32/")+"I_NavCompare.png",immersiveFrame:K.getImmersiveFrame(),newStyleColor:s,newStyleLabel:O.New.name,oldStyleColor:E,oldStyleLabel:O.Old.name,commonStyleColor:r,commonStyleLabel:O.Common.nls,displayType:O.panel});x("Old",O.Old);x("New",O.New);if(!O.noAutomaticReframe){K.getViewer().currentViewpoint.reframe(null,0)}K.getViewer().render()}function x(R,T){var N=l.getSceneRoot(K.getViewer());var Q;if(R==="Old"&&((T.pathElements&&T.pathElements.length)||T.pathElement)){w=[];H=[];F=[];if(T.pathElements&&T.pathElements.length){for(Q=0;Q<T.pathElements.length;Q++){w.push(T.pathElements[Q].clone())}}else{w.push(T.pathElement.clone())}for(Q=0;Q<w.length;Q++){var P=l.getRenderables(w[Q]);var U=l.getSceneGraphOverride(C,w[Q]);if(U){U.setVisibility(false)}if(!E||!A.color||E!==T.color){E=T.color?T.color:"#FF0000";A.color=f.hexToColor(E)}H.push(e.addGeometryToPass(N,P,M,["colorOld","depthOld","colorOldCapping","depthOldCapping"],T.name));F.push(e.addGeometryToPass(N,P,A,undefined,T.name))}}else{if(R==="New"&&((T.pathElements&&T.pathElements.length)||T.pathElement)){t=[];if(T.pathElements&&T.pathElements.length){for(Q=0;Q<T.pathElements.length;Q++){t.push(T.pathElements[Q].clone())}}else{t.push(T.pathElement.clone())}for(Q=0;Q<t.length;Q++){var O=l.getRenderables(t[Q]);var S=l.getSceneGraphOverride(C,t[Q]);if(S){S.setVisibility(false)}if(!s||!D.color||s!==T.color){s=T.color?T.color:"#00FF00";D.color=f.hexToColor(s)}G.push(e.addGeometryToPass(N,O,M,["depthNew","depthNewCapping"],T.name));B.push(e.addGeometryToPass(N,O,D,undefined,T.name))}}}}function y(P){var N=l.getSceneRoot(K.getViewer());var O;if(P==="Old"){for(O=0;O<H.length;O++){N.removeChild(H[O])}for(O=0;O<F.length;O++){N.removeChild(F[O])}if(w&&w.length){for(O=0;O<w.length;O++){l.removeSceneGraphOverride(C,w[O])}}w=[]}else{if(P==="New"){for(O=0;O<G.length;O++){N.removeChild(G[O])}for(O=0;O<B.length;O++){N.removeChild(B[O])}if(t&&t.length){for(O=0;O<t.length;O++){l.removeSceneGraphOverride(C,t[O])}}t=[]}}}function n(N,O){if(!v){return}if(N==="Old"){v.updatePanel({secondLabel:O})}else{if(N==="New"){v.updatePanel({firstLabel:O})}}}}});return i});