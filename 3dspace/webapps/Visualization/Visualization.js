/*!  COPYRIGHT DASSAULT SYSTEMES 2014   */
/*! based on Three.js Copyright Â© 2010-2014 three.js authors */
/*! Uses SMAA. Copyright (C) 2011 by Jorge Jimenez, Jose I. Echevarria,
Belen Masia, Fernando Navarro and Diego Gutierrez. */
var Stats=function(){var I,P,C=0,B=0,H=Date.now(),v=H,A=H,E=0,z=1000,y=0,L,G,K,O=[[16,16,48],[0,255,255]],D=0,x=1000,w=0,M,F,J,N=[[16,48,16],[0,255,0]];I=document.createElement("div");I.style.cursor="pointer";I.style.width="80px";I.style.opacity="0.9";I.style.zIndex="10001";I.addEventListener("mousedown",function(b){b.preventDefault();C=(C+1)%2;C==0?(L.style.display="block",M.style.display="none"):(L.style.display="none",M.style.display="block")},!1);L=document.createElement("div");L.style.textAlign="left";L.style.lineHeight="1.2em";L.style.backgroundColor="rgb("+Math.floor(O[0][0]/2)+","+Math.floor(O[0][1]/2)+","+Math.floor(O[0][2]/2)+")";L.style.padding="0 0 3px 3px";I.appendChild(L);G=document.createElement("div");G.style.fontFamily="Helvetica, Arial, sans-serif";G.style.fontSize="9px";G.style.color="rgb("+O[1][0]+","+O[1][1]+","+O[1][2]+")";G.style.fontWeight="bold";G.innerHTML="FPS";L.appendChild(G);K=document.createElement("div");K.style.position="relative";K.style.width="74px";K.style.height="30px";K.style.backgroundColor="rgb("+O[1][0]+","+O[1][1]+","+O[1][2]+")";for(L.appendChild(K);K.children.length<74;){P=document.createElement("span"),P.style.width="1px",P.style.height="30px",P.style.cssFloat="left",P.style.backgroundColor="rgb("+O[0][0]+","+O[0][1]+","+O[0][2]+")",K.appendChild(P)}M=document.createElement("div");M.style.textAlign="left";M.style.lineHeight="1.2em";M.style.backgroundColor="rgb("+Math.floor(N[0][0]/2)+","+Math.floor(N[0][1]/2)+","+Math.floor(N[0][2]/2)+")";M.style.padding="0 0 3px 3px";M.style.display="none";I.appendChild(M);F=document.createElement("div");F.style.fontFamily="Helvetica, Arial, sans-serif";F.style.fontSize="9px";F.style.color="rgb("+N[1][0]+","+N[1][1]+","+N[1][2]+")";F.style.fontWeight="bold";F.innerHTML="MS";M.appendChild(F);J=document.createElement("div");J.style.position="relative";J.style.width="74px";J.style.height="30px";J.style.backgroundColor="rgb("+N[1][0]+","+N[1][1]+","+N[1][2]+")";for(M.appendChild(J);J.children.length<74;){P=document.createElement("span"),P.style.width="1px",P.style.height=Math.random()*30+"px",P.style.cssFloat="left",P.style.backgroundColor="rgb("+N[0][0]+","+N[0][1]+","+N[0][2]+")",J.appendChild(P)}return{domElement:I,update:function(){H=Date.now();D=H-v;x=Math.min(x,D);w=Math.max(w,D);F.textContent=D+" MS ("+x+"-"+w+")";var b=Math.min(30,30-D/200*30);J.appendChild(J.firstChild).style.height=b+"px";v=H;B++;if(H>A+1000){E=Math.round(B*1000/(H-A)),z=Math.min(z,E),y=Math.max(y,E),G.textContent=E+" FPS ("+z+"-"+y+")",b=Math.min(30,30-E/100*30),K.appendChild(K.firstChild).style.height=b+"px",A=H,B=0}}}};define("DS/Visualization/JSONReader",["DS/VisuLoaders/JSONReader"],function(a){return a});define("Visualization/JSONReader",["DS/Visualization/JSONReader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/JSONReader");return b});define("DS/Visualization/SubsurfaceGenerator",["DS/Visualization/ThreeJS_R57"],function(a){var b=function(){this.loaded=true;this.computedTextures=new Map();this.size=128;this.ready=true;var e=this.utilities.linspace(0.5,1/16,this.size);this.r=this.utilities.applyToArray(e,function(f){return 1/f});this.s=this.utilities.linspace(0.5,16,this.size);var d=this.utilities.linspace(-1,1,this.size);this.theta=this.utilities.applyToArray(d,function(f){return Math.acos(f)});this.sinTheta=this.utilities.applyToArray(this.theta,function(f){if(f>0.5*Math.PI){return 0}return Math.sin(f)});this.aux=Math.PI*Math.PI*Math.sqrt(0.31830988618)/this.size};var c=function(h,g){var f=Math.abs(h.scatteringCoeffs[0]-g.scatteringCoeffs[0])<0.000001&&Math.abs(h.scatteringCoeffs[1]-g.scatteringCoeffs[1])<0.000001&&Math.abs(h.scatteringCoeffs[2]-g.scatteringCoeffs[2])<0.000001;var e=Math.abs(h.absorptionCoeffs[0]-g.absorptionCoeffs[0])<0.000001&&Math.abs(h.absorptionCoeffs[1]-g.absorptionCoeffs[1])<0.000001&&Math.abs(h.absorptionCoeffs[2]-g.absorptionCoeffs[2])<0.000001;var d=Math.abs(h.eta-g.eta)<0.000001;return f&&e&&d};b.prototype={constructor:b,modelFunction:function(n){var f=this.utilities.sumArray(n.absorptionCoeffs,n.scatteringCoeffs);var j=this.utilities.applyToArray(this.utilities.multiplyArray(n.absorptionCoeffs,f),function(o){return Math.sqrt(3*o)});var e=this.utilities.applyToArray(f,function(o){return 0.33333/o});var l=-1.44/(n.eta*n.eta)+0.71/n.eta+0.668+0.0636*n.eta;var k=this.utilities.applyToArray(f,function(o){return 1/o});var m=this.utilities.applyToArray(e,function(o){return 4*(1+l)/(1-l)*o});var h=this.utilities.sumArray(m,k);var d=function(q,p,o){return(p*q+1)*Math.exp(-p*q)/(q*q*q*o)};var g=function(w,q){var v=Math.sqrt(q*q+k[w]*k[w]);var u=Math.sqrt(q*q+h[w]*h[w]);var s=j[w];var p=f[w];var o=0.25*(d(v,s,p)+h[w]*d(u,s,p))/Math.PI;return o};return{red:function(o){return g(0,o)},green:function(o){return g(1,o)},blue:function(o){return g(2,o)}}},sssLUTBuilder:function(f,e,g){var d=function(k){var l=Math.max(Math.cos(g+k),0);var j=f(Math.abs(2*e*Math.sin(k/2)));return l*j};var h=function(j){return f(Math.abs(2*e*Math.sin(j/2)))};return this.utilities.integrate(d,-Math.PI,Math.PI)/this.utilities.integrate(h,-Math.PI,Math.PI)},translucencyLUTBuilder:function(e,f){var d=function(g){var h=2*Math.PI*g*e(Math.sqrt(g*g+f*f));return h};return this.utilities.integrate(d,0,64)},setTexture:function(g,e,d){var f=new a.DataTexture(g,e,d,a.RGBFormat,a.FloatType);f.minFilter=a.NearestFilter;f.magFilter=a.NearestFilter;f.generateMipmaps=false;f.flipY=false;f.needsUpdate=true;return f},decreaseUseCount:function(d){if(this.computedTextures.has(d)){var e=this.computedTextures.get(d);e.useCount--;if(e.useCount===0){e.textures.sssLUT.dispose();e.textures.translucencyLUT.dispose();e.textures.sssIBLLUT.dispose();this.computedTextures["delete"](d)}}},dispose:function(){this.computedTextures.forEach(function(e,d,f){e.textures.sssLUT.dispose();e.textures.translucencyLUT.dispose();e.textures.sssIBLLUT.dispose()});this.computedTextures.clear()},_getComputedTextures:function(d){var e=-1;this.computedTextures.forEach(function(g,f,h){if(c(g.options,d)){g.useCount++;e=f}});if(e>-1){return this.computedTextures.get(e).textures}return null},compute:function(g){var d=this._getComputedTextures(g);if(d!==null){return d}var m=Date.now();var q=new Float32Array(this.size*this.size*3),A=new Float32Array(this.size*6),l=new Float32Array(this.size*6);var h=this.modelFunction(g);for(var z=0;z<this.size;z++){var k=this.r[z];var E=this.s[z];var x=0,t=0,u=0;var w,C,D;w=this.translucencyLUTBuilder(h.red,E);C=this.translucencyLUTBuilder(h.green,E);D=this.translucencyLUTBuilder(h.blue,E);A[3*z+0]=w;A[3*z+1]=C;A[3*z+2]=D;A[3*this.size+3*z+0]=w;A[3*this.size+3*z+1]=C;A[3*this.size+3*z+2]=D;for(var y=0;y<this.size;y++){var B=this.theta[y];var s,r,p;s=this.sssLUTBuilder(h.red,k,B);p=this.sssLUTBuilder(h.green,k,B);r=this.sssLUTBuilder(h.blue,k,B);q[3*this.size*z+3*y+0]=s;q[3*this.size*z+3*y+1]=p;q[3*this.size*z+3*y+2]=r;x+=s*this.sinTheta[y];t+=p*this.sinTheta[y];u+=r*this.sinTheta[y]}x*=this.aux;t*=this.aux;u*=this.aux;l[3*z+0]=x;l[3*z+1]=t;l[3*z+2]=u;l[3*this.size+3*z+0]=x;l[3*this.size+3*z+1]=t;l[3*this.size+3*z+2]=u}var o=this.setTexture(q,this.size,this.size),f=this.setTexture(A,this.size,2),v=this.setTexture(l,this.size,2);var n=Date.now();console.log((n-m)/1000);var e={sssLUT:o,translucencyLUT:f,sssIBLLUT:v};this.computedTextures.set(o.id,{textures:e,options:{eta:g.eta,absorptionCoeffs:g.absorptionCoeffs.slice(0),scatteringCoeffs:g.scatteringCoeffs.slice(0)},useCount:1});return e},toImage:function(){var e=document.createElement("canvas");document.body.appendChild(e);var d=e.getContext("2d");var g=this;var f=function(l,o,k,n){e.height=k;e.width=o;for(var p=0;p<k;++p){for(var j=0;j<o;++j){d.fillStyle="rgb("+255*l[3*g.size*p+3*j]+", "+255*l[3*g.size*p+3*j+1]+",+"+255*l[3*g.size*p+3*j+2]+")";d.fillRect(j,p,1,1)}}var m=e.toDataURL("image/png");var h=document.createElement("a");h.download=n;h.innerHTML="Download File";h.href=m;h.click()};this.computedTextures.forEach(function(j,h,k){f(j.textures.sssLUT.image.data,j.textures.sssLUT.image.width,j.textures.sssLUT.image.height,"Scattering");f(j.textures.translucencyLUT.image.data,j.textures.translucencyLUT.image.width,j.textures.translucencyLUT.image.height,"Translucency");f(j.textures.sssIBLLUT.image.data,j.textures.sssIBLLUT.image.width,j.textures.sssIBLLUT.image.height,"IBL")})},utilities:{linspace:function(g,f,k){var d=Math.floor(k);if(d<=1){return[f]}var e=(f-g)/(k-1);var j=[];for(var h=0;h<d;h++){j[h]=g+h*e}return j},sumElements:function(f){var e=0;for(var d=0;d<f.length;d++){e+=f[d]}return e},multiplyArray:function(h,g){var d=Math.min(g.length,h.length);var f=[];for(var e=0;e<d;e++){f[e]=h[e]*g[e]}return f},sumArray:function(h,g){var d=Math.min(g.length,h.length);var f=[];for(var e=0;e<d;e++){f[e]=h[e]+g[e]}return f},applyToArray:function(g,f){var e=[];for(var d=0;d<g.length;d++){e[d]=f(g[d])}return e},integrate:function(k,j,g){var e=128;var d=this.linspace(j,g,e);var h=this.applyToArray(d,k);var f=0.5*(g-j)/e;return f*(2*this.sumElements(h)-h[e-1]-h[0])}}};return b});window.disposedViewers=[];var __WebGLViewer_prereqs=["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/Viewpoint","DS/Visualization/InternalSceneGraph","DS/Mesh/MeshUtils","DS/Animation/AnimationEngine","DS/Visualization/WebGLV6Renderer","DS/Visualization/OccurrencePath","UWA/Controls/Abstract","DS/Magnifier/Magnifier","DS/Visualization/TrapSelection","DS/Visualization/MaterialManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/SubElement","DS/VisuEvents/EventsManager","DS/Manipulators/ManipulatorManager","DS/Visualization/SceneGraph","DS/Visualization/SceneGraphUtils","DS/Visualization/SceneGraphFactory","DS/Visualization/HighlightSelection","DS/Visualization/SessionNodesWithSectionProfile","DS/CoreEvents/ModelEvents","DS/Plugins/UserPassManager","DS/Effects/BlurShadowEffect","DS/Effects/ESMEffect","DS/Visualization/PlaneGrid","DS/Manipulators/TrapSelectionManipulator","DS/Visualization/ClippingContext","DS/Visualization/GetSVGMode","DS/Visualization/RenderPriorityManager","DS/WebRecordEnabler/Adapter","DS/Effects/ConvertCubemapToLatlong","DS/Visualization/Ambience","DS/Visualization/RenderMode","DS/Visualization/RenderStyle","DS/Visualization/BudgetedRenderManager"];if(window.location.protocol!=="file:"){__WebGLViewer_prereqs.push("text!Visualization/assets/ambiences.json")}define("DS/Visualization/WebGLViewer",__WebGLViewer_prereqs,function(h,M,J,o,Q,T,O,j,N,q,e,c,Y,X,n,C,L,s,t,b,W,B,z,l,I,P,U,p,u,a,V,v,y,G,m,d,k,D,K,A,S,g,w,f){var r=null;if(f){r=JSON.parse(f)}var R=function(aa){var Z=document.getElementsByTagName("script"),ac,ab,ad;for(ac=0;ac<Z.length;ac++){ab=Z.item(ac);ad=ab.getAttribute("src");if(ad&&ad.match(aa)){return ad.substring(0,ad.lastIndexOf("/")+1)}}return"scripts/ThreeDS/Visualization/"};var F=0;var H=0.0001;var x=0;var E=X.extend({init:function(al){this.id=F++;window.debugWebGLV6Viewer=this;var ag=this,ad;if(al.uniqueName){this.uniqueName=al.uniqueName}this.clearThis=function(){ag=null};this.version="9.0";this._parent();this._manipulators={};this.trapSelectionManipulator=null;this.disposed=false;this._fillXSOMode=true;al=al||{};this._svgMode=al.svgMode?true:false;this._2DMode=false;this.div=null;this.divCssElement=null;this.materialManager=null;this.context2D=null;this._nearFarBigScale=window.nearFarBigScale?true:false;this._sceneGraph=null;this._sceneGraphOverrideSetManager=null;this._sceneGraphStateVersion=null;this._userPassManager=new a(this);this._renderPriorityManager=null;this._modelEvent=new u();this.trapSelection=null;this._renderStyle=null;this._forceSceneMinValue=null;if(al.capturer){this.capturer=al.capturer;this.capturer.setViewer(this);al.preserveDrawingBuffer=true}if(al.div!==undefined){this.div=al.div}if(al.divCssElement!==undefined){this.divCssElement=al.divCssElement}this.buildSkeleton();this.buildSkeletonCss();if(window.DSWebRecord){console.log("registering viewer#"+this.id);B._record_registerObject(this,"WebGLV6Viewer",[this.canvas,this.divTrap])}this.previousMaxSectionPolyLineSize=0;this.ODTMode=al.ODTMode||false;if(this.ODTMode&&al.ODTAmbiences){r=JSON.parse(al.ODTAmbiences)}this.mobile=al.mobile!==undefined?al.mobile:(navigator.userAgent.match(/(Android|iPhone|iPad)/i)?true:false);M.mobileVersion=this.mobile;this.useHDR=al.hdr!==undefined?al.hdr:true;this.multiViewer=al.multiViewer!==undefined?al.multiViewer:false;this.multiViewerFix=true;this.defaultAnimationLoop=al.defaultAnimationLoop!==undefined?al.defaultAnimationLoop:true;if(D.isReplaying()){this.defaultAnimationLoop=false}this.autoUpdateFrustum=al.autoUpdateFrustum!==undefined?al.autoUpdateFrustum:true;this.autoUpdateLights=true;this.triLights=al.triLights!==undefined?al.triLights:false;this.ambience=new A({viewer:this});this.ambience.setBackgroundColor((al.backgroundColor!==undefined?al.backgroundColor:0));this.ambience.setBackgroundAlpha((al.backgroundAlpha!==undefined?al.backgroundAlpha:1));this.__tempBackgroundColorODT=(al.backgroundColor!==undefined?al.backgroundColor:0);this.planeColor=new M.Color(15658734);this.gridColor=new M.Color(15658734);this.showBgAlpha=this.ambience.getBackgroundAlpha();this.noShowColor=new M.Color().setRGB(150/255,185/255,165/255);this.noShowAlpha=0.5;this.saturationRatio=1;this.blendingRatio=0.5;this.showBgColor=this.ambience.getBackgroundColor().getHex();this.showPlaneColor=new M.Color(this.planeColor.getHex());this.showGridColor=new M.Color(this.gridColor.getHex());this.showGradientBackground=[];this.visibleSpace=al.visibleSpace!==undefined?al.visibleSpace:1;this.axisFilterStatus=false;this.pointsFilterStatus=true;this.linesFilterStatus=true;this.lockedRenderMode=new Map();this.sceneGraphState=null;this.cameraSystem=null;this.cameraSystemUpdated=false;this.lastNbTexturesBeingLoaded=0;this.highlightColor=null;this.highlightSets=[];this.picking={activated:true,trapSelection:false,displayHL:true,gpu:true,computeNormalDepth:true,primitive:false,tolerance:2};if(al.highlight!==undefined){this.setPicking(al.highlight)}this.pPicking={activated:false,trapSelection:false,displayHL:true,gpu:true,computeNormalDepth:false,primitive:false,disableWhileMoving:true,tolerance:2};if(al.pHighlight!==undefined){this.setPrePicking(al.pHighlight)}this.lastAddedToPSO=null;if((al.usePicking!==undefined)||(al.usePickingGPU!==undefined)){console.log("usePicking and usePickingGPU parameters are deprecated.\n Use highlight and pHighlight objects instead.")}if(al.usePicking!==undefined){this.picking.activated=al.usePicking}if(al.usePickingGPU!==undefined){this.picking.gpu=al.usePickingGPU}this.infinitePlane=(al.infinitePlane!==undefined?al.infinitePlane:true);this._infinitePlane=this.infinitePlane;this.displayGrid=(al.displayGrid!==undefined?al.displayGrid:false);this._displayGrid=this.displayGrid;this.displayGridFromBelow=false;this.autoUpdatePlane=al.autoUpdatePlane!==undefined?al.autoUpdatePlane:true;this.useMirror=al.mirror!==undefined?(!this.mobile&&al.mirror):false;this.blurryMirror=false;this.planeAttenuation=false;this.useShadowPlane=this._infinitePlane;this.useDefaultLights=al.defaultLights!==undefined?al.defaultLights:true;this.useGroundShadow=al.useGroundShadow!==undefined?al.useGroundShadow:false;this.useShadowMap=al.useShadowMap!==undefined?al.useShadowMap:true;if(this.mobile){this.useShadowMap=false}this.shadowFilter="PCF";this.shadowQuality="Low";this.shadowMapWidth=al.shadowMapWidth!==undefined?al.shadowMapWidth:4096;this.shadowMapHeight=al.shadowMapHeight!==undefined?al.shadowMapHeight:4096;this.deferred=al.deferred!==undefined?al.deferred:false;this.antiAliasing=al.antiAliasing!==undefined?al.antiAliasing:"NoAA";if(this.antiAliasing===true){this.antiAliasing="SMAA"}else{if(this.antiAliasing===false){this.antiAliasing="NoAA"}}this.useOIT=al.useOIT!==undefined?al.useOIT&&!this.mobile:false;if(al.svgMode){this.useOIT=false}this.forceRender=false;this.visuEnv="None";if(al.displayHighlight!==undefined){this.displayHighlight=al.displayHighlight;this.setPicking({activated:this.displayHighlight,displayHL:this.displayHighlight})}this.useVignetting=al.useVignetting!==undefined?al.useVignetting:false;this.useSSAO=al.ssao!==undefined?al.ssao:false;this.useSSAOIterative=al.ssaoIterative!==undefined?al.ssaoIterative:false;this.useSSLR=al.sslr!==undefined?al.sslr:false;this.useBloom=al.bloom!==undefined?al.bloom:false;this.useFlare=al.flare!==undefined?al.flare:false;this.useDOF=al.dof!==undefined?al.dof:false;this._effectSettings={AntiAliasing:{"static":this.antiAliasing,dynamic:(this.antiAliasing!=="MSAA")?this.antiAliasing:"SMAA"},Outline:{"static":true,dynamic:false},PixelCulling:{"static":4.5,dynamic:4.5},Transparency:{"static":this.useOIT?"WeightedAverage":"AlphaBlending",dynamic:this.useOIT?"WeightedAverage":"AlphaBlending",},GroundShadows:{"static":this.useGroundShadow,dynamic:this.useGroundShadow},InterObjectShadows:{"static":this.useShadowMap,dynamic:this.useShadowMap},ShadowQuality:{"static":this.shadowQuality,dynamic:this.shadowQuality},ShadowFilter:{"static":this.shadowFilter,dynamic:this.shadowFilter},GroundReflection:{"static":this.useMirror,dynamic:this.useMirror},SSAO:{"static":this.useSSAO,dynamic:this.useSSAO},Bloom:{"static":this.useBloom,dynamic:this.useBloom},DepthOfField:{"static":this.useDOF,dynamic:this.useDOF},ZPrePass:{"static":false,dynamic:false}};this.magnifier=null;this.debugShadowLight=al.debugShadowLight!==undefined?al.debugShadowLight:false;this.debugBSphere=al.debugBSphere!==undefined?al.debugBSphere:false;this.debugPrimitiveBSphere=al.debugPrimitiveBSphere!==undefined?al.debugPrimitiveBSphere:false;this.debugRepBBox=al.debugRepBBox!==undefined?al.debugRepBBox:false;this.debugPicking=al.debugPicking!==undefined?al.debugPicking:false;this.debugNormals=al.debugNormals!==undefined?al.debugNormals:false;this.debugBackfaceCulling=al.debugBackfaceCulling!==undefined?al.debugBackfaceCulling:false;this.debugPickHybrid=false;var ac=null;this.debugPostProcessing=false;this.debugShadowMaps=false;this.debugEvents=0;this.debugFPS=false;this.debugFPSInfos={fpsCounter:null,fpsArray:[],fpsIndex:0,fpsValue:30,fpsCumul:1200,fpsWindow:40,fpsLastTime:0};this.viewpoints=[];this.currentViewpoint=null;this.trackingViewpoint=null;this.internalSceneGraph=null;this.manipulatorManager=null;this.temporaryEmptyScene=new M.Scene();this.centerMouseDownCB=null;this.mouseMoveCB=null;this.centerMouseUpCB=null;this.leftMouseDownCB=null;this.leftMouseUpCB=null;this.rightMouseUpCB=null;this._defaultPicking=null;this.setDefaultPicking(true);this.pickingPriorityMapping=null;this.forceMultiSel=false;this.sceneBackground=new M.Scene();this.sceneBackground.isBackground=true;this.cameraBackgroundNear=0.0001;this.cameraBackgroundFar=1;this.cameraBackground=new M.PerspectiveCamera();this.sceneBackground.add(this.cameraBackground);this.cameraReflected=new M.PerspectiveCamera();this.infPlane=null;this.infPlaneSmall=null;this.planeSize=200;this.grid=null;this.bigGrid=null;this.gridSize=200;this.gridUnit=1;this.gridStep=0.005;this.gridNbSteps=5;this.offsetPlaneSmall=new M.Vector3();this.offsetPlaneBackground=new M.Vector3();this.planeV2=al.planeV2!==undefined?al.planeV2:false;this.planeGrid=this.planeV2?new y(this):null;this.ground=null;this.envMap=null;this.envMap2=null;this.envMapExposure=1;this.envMapOffset=0;this.envMapBlur=0;this.sphereEnv=null;this.isRenderIteration=true;this._lockRenderIteration=false;this.renderIteration=0;this.timeIter0=0;this.delayBeforeIteration=500;this.devicePixelRatio=window.devicePixelRatio||1;this.SCREEN_WIDTH=800;this.SCREEN_HEIGHT=600;this.lazyResize=al.lazyResize!==undefined?al.lazyResize:false;this.lazyResizeTime=300;this.oldCanvasSize={width:this.SCREEN_WIDTH,height:this.SCREEN_HEIGHT,dpr:this.devicePixelRatio,time:new Date().getTime()};this.initMousePos=null;this.currMousePos=null;this.bSphere=null;this.bBox=null;this.primitiveBSphere=null;this.debugPickingNode=new M.Object3D();this.debugNormalNode=new M.Object3D();this.renderer=null;this._requestRender=false;this._onlyPostProcess=true;this._renderParams=[];this.renderFrameCB=null;this.beginRenderFrameCB=null;this.ambientLight=new M.AmbientLight(new M.Color(0));this.directionalLight=null;this.directionalLight2=null;this.directionalLight3=null;this.dirLightGroundShadow=null;this.probeLight=null;this.dirLightLatitude=0.25;this.dirLightVector=new M.Vector3(2,1.5,2.5);this.dirLight2Vector=new M.Vector3(0,0,1);this.dirLight3Vector=new M.Vector3(0,0,1);this.dirLightType=[false,false,false];this.lights=[];M.intensityCorrection=false;this.budgetedRenderManager=new w(this);ad=new Date();this._oldTime=ad.getTime();this.overrideCursors=true;this._changeCursorDelay=null;this._temporaryCursorData=null;this._forcePRZ=false;this.startPan=function(am){var an=this.currentViewpoint.getControl();if(an!==null){an.startPan(am)}this._forcePRZ=true};this.startRotate=function(am){var an=this.currentViewpoint.getControl();if(an!==null){an.startRotate(am)}this._forcePRZ=true};this.startZoom=function(am){var an=this.currentViewpoint.getControl();if(an!==null){an.startZoom(am)}this._forcePRZ=true};this.endPan=function(am){var an=this.currentViewpoint.getControl();if(an!==null){an.endPan(am);this.setCursor("Auto",0)}this._forcePRZ=false};this.endRotate=function(am){var an=this.currentViewpoint.getControl();if(an!==null){an.endRotate(am);this.setCursor("Auto",0)}this._forcePRZ=false};this.endZoom=function(am){var an=this.currentViewpoint.getControl();if(an!==null){an.endZoom(am);this.setCursor("Auto",0)}this._forcePRZ=false};this._getPaths=function(aq,at,ap,ar){var ao,am;if(at.count==at.stop){ar.push(ap.slice(0));return}at.count++;ap.push(aq);var an=aq.children;am=an.length;for(ao=0;ao<am;ao++){this._getPaths(an[ao],at,ap,ar)}ap.pop();at.count--},this.addPathToHso=function(an){var ao=[];var ap=t;this._getPaths(this.getRootNode().children[0],{count:0,stop:an},[],ao);for(var am=0;am<ao.length;am++){ap.add({pathElement:new O(ao[am])})}return ao};this.render=function(am){if(ag==null){return}if(am===undefined){am={}}if(am.budgeted){ag.budgetedRenderManager._askForRender(am);return}else{if(am.budgeted===undefined){ag.budgetedRenderManager._resetShift()}}ag._renderParams.push(am);ag._requestRender=true;if(!am||!am.onlyPostProcess){ag._onlyPostProcess=false}};this.glRender=function(bk){if(this.budgetedRenderManager._isActive){this.budgetedRenderManager._setAsRenderFrame()}if(this.beginRenderFrameCB){this.beginRenderFrameCB()}if(p.maxPolyLineSize!==this.previousMaxSectionPolyLineSize){this.previousMaxSectionPolyLineSize=p.maxPolyLineSize;this.renderer&&this.renderer.recompileAllShaders()}if(M.webGLStats){M.webGLStats.reset()}var aO,aF,bv,a7,aK,aJ,ao,ay,ax,aV,bd,aI,at,bm,bj,aP,ar,a9,a6,aB,aW,aU,aT,aR,bb;var aP=false,a8=null;var a9=false;var bs=false;var bm=ag.currentViewpoint;var aQ=true;var bp=!!bk.length;var aX=!!bk.length;var by=false;var aC=512;var bc=0;var bo=0;var bl=false;for(aU=0;aU<bk.length;aU++){if(bk[aU].needReframe!==undefined){aP=bk[aU].needReframe}if(bk[aU].reframeSpace!==undefined){a8=bk[aU].reframeSpace}if(bk[aU].updateInfinitePlane!==undefined){a9=a9||bk[aU].updateInfinitePlane}if(bk[aU].updateInfinitePlaneFast!==undefined){bs=bs||bk[aU].updateInfinitePlaneFast}if(bk[aU].renderIteration!==undefined){bo=bk[aU].renderIteration}if(bk[aU].isStillFrame!==undefined){bl=bk[aU].isStillFrame}if(bk[aU].viewpoint!==undefined){bm=bk[aU].viewpoint}if(bk[aU].toScreen!==undefined){aQ=bk[aU].toScreen}if(!bk[aU].onlyPostProcess){bp=false}if(!bk[aU].onlyForward){aX=false}if(bk[aU].cubemap!==undefined){by=bk[aU].cubemap}if(bk[aU].cubemapResolution!==undefined){aC=bk[aU].cubemapResolution}if(bk[aU].cubeFace!==undefined){bc=bk[aU].cubeFace}}var bn=(bo===0)?"dynamic":"static";ag._setPixelCulling(bn);ag._setAntiAliasing(bn);ag._setShadow(bn);ag._setShadowFilter(bn);ag._setShadowQuality(bn);ag._setGroundShadow(bn);ag._setOIT(bn);ag._enableZPrePass(bn);ag._setMirror(bn);ag._setSSAO(bn);ag._setBloom(bn);ag._setDOF(bn);ag._modelEvent.publish({event:"PreRender",data:{viewer:ag,viewpoint:ag.currentViewpoint,onlyPostProcess:bp}});bj=bm.camera;aI=(ag.internalSceneGraph===null)?ag.temporaryEmptyScene:ag.internalSceneGraph.scene;at=(ag.internalSceneGraph===null)?new M.Sphere(new M.Vector3(0,0,0),100):ag.getSceneBoundingSphere(this.visibleSpace?"visibleSpace":"invisibleSpace");if(at.pixelRadius>0){var bf=bj.getWorldSizeFromPixelSize(1,at.center,this.div.clientHeight);if(typeof bj.fullWidth!=="undefined"&&bj.fullWidth>0){var bg=Math.max(bj.width*1/bj.fullWidth,bj.height*1/bj.fullHeight);bf*=bg}at.radius+=bf*at.pixelRadius}if(bm!==null){bj.updateMatrix();bj.matrixWorld.copy(bj.matrix);bj.matrixWorldInverse.getInverse(bj.matrixWorld);this.ambience.update();if(this.sphereEnv){this.ambience.updateCamera(bm,this.renderer,bj)}}if(ag.directionalLight){ag.directionalLight.shadowCameraVisible=ag.debugShadowLight}if(ag.debugBSphere){if(ag.bSphere){ag.bSphere.visibilityFree=true;ag.bSphere.visible=true;ag.bSphere.matrix=new M.Matrix4();aO=new M.Matrix4();aO.makeScale(at.radius,at.radius,at.radius);aO.setPosition(at.center);ag.bSphere.setMatrix(aO)}else{if(aI!==null){bv=new M.MeshPhongMaterial({color:16729156,opacity:0.2,transparent:true,force:true});var aM=P.createSphereNode({radius:1,sag:32,material:bv});aM.setPickable(2);ag.bSphere=aM._occurrences[0].renderable;ag.bSphere.frustumCulled=false;ag.bSphere.drawInHLRender=false;aI.add(ag.bSphere)}}}else{if(ag.bSphere){ag.bSphere.visibilityFree=true;ag.bSphere.visible=false}}if(ag.debugPrimitiveBSphere){var a1=null;var aY=null;var be=WUX.Selection.HSOManager.get();if(be[0]){var aq=be[0].pathElement;var a5=aq.getLastElement();if(a5.sgNode&&a5.sgNode.boundingSphere){a1=a5.sgNode.boundingSphere;aY=aq.getWorldMatrix(this)}}if(a1){if(ag.primitiveBSphere){ag.primitiveBSphere.visible=true;ag.primitiveBSphere.matrix=new M.Matrix4();aO=new M.Matrix4();aO.makeScale(a1.radius,a1.radius,a1.radius);aO.setPosition({x:a1.center[0],y:a1.center[1],z:a1.center[2]});aY.multiplyMatrices(aY,aO);ag.primitiveBSphere.setMatrix(aY)}else{if(aI!==null){bv=new M.MeshPhongMaterial({color:16729156,opacity:0.3,transparent:true,force:true});var aM=P.createSphereNode({radius:1,sag:32,material:bv});aM.setPickable(2);ag.primitiveBSphere=aM._occurrences[0].renderable;ag.primitiveBSphere.frustumCulled=false;aI.add(ag.primitiveBSphere)}}}else{if(ag.primitiveBSphere){ag.primitiveBSphere.visible=false}}}if(ag.debugRepBSphere){var a4=null;var aY=null;var be=WUX.Selection.HSOManager.get();if(be[0]){var aq=be[0].pathElement;var a5=aq.getLastElement();if(a5.sgNode&&a5.sgNode.rep&&a5.sgNode.rep.boundingSphere){a4=a5.sgNode.rep.boundingSphere;aY=aq.getWorldMatrix(this)}}if(a4){if(ag.repBSphere){ag.repBSphere.visible=true;ag.repBSphere.matrix=new M.Matrix4();aO=new M.Matrix4();aO.makeScale(a4.radius,a4.radius,a4.radius);aO.setPosition({x:a4.center[0],y:a4.center[1],z:a4.center[2]});aY.multiplyMatrices(aY,aO);ag.repBSphere.setMatrix(aY)}else{if(aI!==null){bv=new M.MeshPhongMaterial({color:16729156,opacity:0.3,transparent:true,force:true});var aM=P.createSphereNode({radius:1,sag:32,material:bv});aM.setPickable(2);ag.repBSphere=aM._occurrences[0].renderable;ag.repBSphere.frustumCulled=false;aI.add(ag.repBSphere)}}}else{if(ag.repBSphere){ag.repBSphere.visible=false}}}if(ag.debugRepBBox){var aE=null;var aY=null;var be=WUX.Selection.HSOManager.get();if(be[0]){var aq=be[0].pathElement;var a5=aq.getLastElement();if(a5.getBoundingBox()){aE=a5.getBoundingBox();aY=aq.getWorldMatrix(this)}}else{aE=this.getSceneBoundingBox();aY=this.internalSceneGraph.root.getMatrix()}if(aE){if(ag.bBox){ag.bBox.visible=true;ag.bBox.matrix=new M.Matrix4();aO=new M.Matrix4();aO.makeScale(aE.max.x-aE.min.x,aE.max.y-aE.min.y,aE.max.z-aE.min.z);aO.setPosition({x:aE.min.x+(aE.max.x-aE.min.x)/2,y:aE.min.y+(aE.max.y-aE.min.y)/2,z:aE.min.z+(aE.max.z-aE.min.z)/2});aY.multiplyMatrices(aY,aO);ag.bBox.setMatrix(aY)}else{if(aI!==null){bv=new M.MeshPhongMaterial({color:16729156,opacity:0.3,transparent:true,force:true});var bu=P.createCuboidNode({cornerPoint:new M.Vector3(-0.5,-0.5,-0.5),firstAxis:new M.Vector3(1,0,0),secondAxis:new M.Vector3(0,1,0),thirdAxis:new M.Vector3(0,0,1),material:bv});ag.bBox=bu._occurrences[0].renderable;ag.bBox.frustumCulled=false;ag.bBox.pickable=false;aI.add(ag.bBox)}}}}else{if(ag.bBox){ag.bBox.visible=false}}if(ag.debugLocalBBox){var ap=new M.Matrix4().identity();if(ag.debugHandleMatrix){ap.copy(ag.currentViewpoint.camera.matrix)}var be=WUX.Selection.HSOManager.get();var bq=[];for(var aU=0;aU<be.length;aU++){bq.push(be[aU].pathElement)}var a3=I.getOrientedBoundingBoxFromPathElements(bq,ap,ag).localBBox;if(a3){if(ag.localBBox){ag.localBBox.visible=true;ag.localBBox.matrix=new M.Matrix4();aO=new M.Matrix4();aO.makeScale(a3.max.x-a3.min.x,a3.max.y-a3.min.y,a3.max.z-a3.min.z);aO.setPosition({x:a3.min.x+0.5*(a3.max.x-a3.min.x),y:a3.min.y+0.5*(a3.max.y-a3.min.y),z:a3.min.z+0.5*(a3.max.z-a3.min.z)});ap.multiplyMatrices(ap,aO);ag.localBBox.setMatrix(ap)}else{if(aI){bv=new M.MeshPhongMaterial({color:16729156,opacity:0.3,transparent:true,force:true});var bu=P.createCuboidNode({cornerPoint:new M.Vector3(-0.5,-0.5,-0.5),firstAxis:new M.Vector3(1,0,0),secondAxis:new M.Vector3(0,1,0),thirdAxis:new M.Vector3(0,0,1),material:bv});bu.setPickable(2);ag.localBBox=bu._occurrences[0].renderable;ag.localBBox.frustumCulled=false;aI.add(ag.localBBox)}}}else{if(ag.localBBox){ag.localBBox.visible=false}}}if(ag.debugBBox){var ap=new M.Matrix4().identity();if(ag.debugHandleMatrix){ap.copy(ag.currentViewpoint.camera.matrix)}var am=this.computeSceneAccurateBoundingBox(ag.visibleSpace?"visibleSpace":"invisibleSpace",ag.debugHandleMatrix?ap:null);if(am){if(ag.BBox){ag.BBox.visible=true;ag.BBox.matrix=new M.Matrix4();aO=new M.Matrix4();aO.makeScale(am.max.x-am.min.x,am.max.y-am.min.y,am.max.z-am.min.z);aO.setPosition({x:am.min.x+0.5*(am.max.x-am.min.x),y:am.min.y+0.5*(am.max.y-am.min.y),z:am.min.z+0.5*(am.max.z-am.min.z)});ap.multiplyMatrices(ap,aO);ag.BBox.setMatrix(ap)}else{if(aI){bv=new M.MeshPhongMaterial({color:16729156,opacity:0.3,transparent:true,force:true});var bu=P.createCuboidNode({cornerPoint:new M.Vector3(-0.5,-0.5,-0.5),firstAxis:new M.Vector3(1,0,0),secondAxis:new M.Vector3(0,1,0),thirdAxis:new M.Vector3(0,0,1),material:bv});bu.setPickable(2);ag.BBox=bu._occurrences[0].renderable;ag.BBox.frustumCulled=false;aI.add(ag.BBox)}}}else{if(ag.BBox){ag.BBox.visible=false}}}else{if(ag.BBox){ag.BBox.visible=false}}if(ag.debugPicking){aI.add(ag.debugPickingNode)}else{aI.remove(ag.debugPickingNode)}if(ag.debugNormals){if(!ag.debugNormalNode.children.length){aj()}aI.add(ag.debugNormalNode)}else{aI.remove(ag.debugNormalNode);ag.debugNormalNode.children=[]}for(var aU=0;aU<aI.__lights.length;aU++){var a7=aI.__lights[aU];var av=false;if(a7._occurrence){av=a7._occurrence.node._attachedToVpt}if(av){a7._vptPosition=bm.getEyePosition();if(a7.hasOwnProperty("target")){aB=bj.getLookAt();ao=bm.getEyePosition().add(aB);a7.target.position=ao}}}if(ag.useDefaultLights){a7=ag.directionalLight;aK=ag.directionalLight2;aJ=ag.directionalLight3;if(at!==null){if(ag.triLights){var aN=bm.getUpDirection();var aH=bm.getSightDirection();var a2=new M.Vector3().crossVectors(aH,aN);if(ag.autoUpdateLights){ao=new M.Vector3(2*at.radius,2*at.radius,2*at.radius);a7.position=new M.Vector3().copy(at.center).add(ao);a7.lookAt(at.center);ay=new M.Vector3().copy(aN).sub(aH).sub(a2).multiplyScalar(2*at.radius);aK.position=new M.Vector3().copy(at.center).add(ay);aK.lookAt(at.center);ax=new M.Vector3().copy(a2).sub(aH).multiplyScalar(2*at.radius);aJ.position=new M.Vector3().copy(at.center).add(ax);aJ.lookAt(at.center)}else{if(!ag.dirLightType[0]){ao=new M.Vector3().copy(ag.dirLightVector).multiplyScalar(at.radius)}else{ao=new M.Vector3(a2.x*ag.dirLightVector.x+aN.x*ag.dirLightVector.y-aH.x*ag.dirLightVector.z,a2.y*ag.dirLightVector.x+aN.y*ag.dirLightVector.y-aH.y*ag.dirLightVector.z,a2.z*ag.dirLightVector.x+aN.z*ag.dirLightVector.y-aH.z*ag.dirLightVector.z).multiplyScalar(at.radius);a7.updateShadowMap=true}a7.position=new M.Vector3().copy(at.center).add(ao);a7.lookAt(at.center);if(!ag.dirLightType[1]){ay=new M.Vector3().copy(ag.dirLight2Vector).multiplyScalar(at.radius)}else{ay=new M.Vector3(a2.x*ag.dirLight2Vector.x+aN.x*ag.dirLight2Vector.y-aH.x*ag.dirLight2Vector.z,a2.y*ag.dirLight2Vector.x+aN.y*ag.dirLight2Vector.y-aH.y*ag.dirLight2Vector.z,a2.z*ag.dirLight2Vector.x+aN.z*ag.dirLight2Vector.y-aH.z*ag.dirLight2Vector.z).multiplyScalar(at.radius)}aK.position=new M.Vector3().copy(at.center).add(ay);aK.lookAt(at.center);if(!ag.dirLightType[2]){ax=new M.Vector3().copy(ag.dirLight3Vector).multiplyScalar(at.radius)}else{ax=new M.Vector3(a2.x*ag.dirLight3Vector.x+aN.x*ag.dirLight3Vector.y-aH.x*ag.dirLight3Vector.z,a2.y*ag.dirLight3Vector.x+aN.y*ag.dirLight3Vector.y-aH.y*ag.dirLight3Vector.z,a2.z*ag.dirLight3Vector.x+aN.z*ag.dirLight3Vector.y-aH.z*ag.dirLight3Vector.z).multiplyScalar(at.radius)}aJ.position=new M.Vector3().copy(at.center).add(ax);aJ.lookAt(at.center)}}else{if(ag.autoUpdateLights){if(ag.dirLightType[0]){aB=bj.getLookAt();ao=new M.Vector3(-2*aB.x*at.radius,-2*aB.y*at.radius,-2*aB.z*at.radius);a7.position=new M.Vector3().copy(at.center).add(ao)}else{ag.dirLightVector.set(2,1.5,2.5);a7.position=new M.Vector3().copy(ag.dirLightVector).multiplyScalar(at.radius).add(at.center)}ay=new M.Vector3(-2*at.radius,1.5*at.radius,2.5*at.radius);aK.position=new M.Vector3().copy(at.center).add(ay)}else{a7.position=new M.Vector3().copy(ag.dirLightVector).multiplyScalar(2*at.radius).add(at.center);ay=new M.Vector3(-2*at.radius,1.5*at.radius,2.5*at.radius);aK.position=new M.Vector3().copy(at.center).add(ay)}}a7.lookAt(at.center);a7.target.position.copy(at.center);a7.target.updateMatrixWorld();aK.target.position.copy(at.center);aK.target.updateMatrixWorld();if(aJ){aJ.target.position.copy(at.center);aJ.target.updateMatrixWorld()}}if(ag.useShadowMap){a7.castShadow=true;if(at!==null){aV=a7.position.distanceTo(at.center);var aD=Math.PI*Math.max(0.1,0.5-ag.dirLightLatitude);var bw=Math.sin(aD)+(Math.cos(aD)+1)/Math.tan(aD);if(a7.shadowCamera&&!a7.LiSPSM){a7.updateShadowMap=a7.updateShadowMap||(a7.shadowCamera.top!==at.radius);a7.shadowCamera.far=aV+bw*at.radius;a7.shadowCamera.near=Math.max(0.001*a7.shadowCamera.far,aV-at.radius);a7.shadowCamera.left=-at.radius;a7.shadowCamera.right=at.radius;a7.shadowCamera.bottom=-at.radius;a7.shadowCamera.top=at.radius;a7.shadowCamera.updateProjectionMatrix()}else{a7.shadowCameraFar=aV+bw*at.radius;a7.shadowCameraNear=Math.max(0.001*a7.shadowCameraFar,aV-at.radius);a7.updateShadowMap=true}}}else{a7.castShadow=false}}if(ag._infinitePlane||ag._displayGrid){ag.updateBackgroundLights()}if(!this._2DMode){if(this.ambience.getBackground().isActivated()){var au=bm?bm.camera.position:this.currentViewpoint.camera.position;if(!this.sphereEnv){this._setSphereEnv(this.ambience.getSphere())}this.internalSceneGraph.scene.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(true);this.ambience.updateSphere(0.9*ag.cameraBackgroundFar,au,this.sphereEnv)}else{ag.removeEnvMap()}if(this.ambience.getGround().isActivated()){if(this.ambience.getGround().getType()=="physical"){if(!this.ground){this._setPhysicalGround(this.ambience.createGroundGeometry())}this.ambience.updateGround(this.ground)}else{if(this.ground){this.ground.visible=false}}}else{if(this.ground){this.ground.visible=false}}}if(this.ambience.needUpdateIBL){var bx=this.ambience.getIblMap();var aZ=this.ambience.getRoughnessMap();var an=false;var bt=(!!ag.internalSceneGraph.scene.envMipMap[0])&&(!!ag.internalSceneGraph.scene.envMipMap[1]);if(bx){this.internalSceneGraph.scene.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(true);an=!bt;ag.internalSceneGraph.scene.envMipMap[0]=bx;ag.internalSceneGraph.scene.envMipMap[1]=aZ}else{an=bt;ag.internalSceneGraph.scene.envMipMap=[]}if(ag.internalSceneGraph.scene.envMipMapID){ag.renderer.renderer.ambianceGenerators.decreaseUseCount(ag.internalSceneGraph.scene.envMipMapID);ag.internalSceneGraph.scene.envMipMapID=null}if(an){ag.renderer&&ag.renderer.recompileAllShaders()}this.ambience.needUpdateIBL=false}if(!ag._displayGrid&&((ag.grid!==null&&ag.grid.visible)||(ag.bigGrid!==null&&ag.bigGrid.visible))){ag._removeGrid()}ar=100;if((bm!==null)&&(at!==null)&&(ag._displayGrid||ag._infinitePlane||ag.useShadowPlane||ag.ambience.getGround().isActivated()||ag.ambience.isFiniteMode())){ag.offsetPlaneSmall.x=at.center.x;ag.offsetPlaneSmall.y=at.center.y;var ba=2*at.radius;ag._updateOffsetPlane(at,bj,a9,ag._forceSceneMinValue,ag.internalSceneGraph,bs);var aG=ag._getPlaneSize(at,bj,ag.gridUnit,ag.gridStep);if(aG!==ag.planeSize){ag.planeSize=aG;ag._updateNearFar()}bd=-bj.getLookAt().z;ar=bj.isOrtho?bd:bj.position.z-ag.offsetPlaneBackground.z;if((ar>0)&&ag.useShadowPlane&&!ag._2DMode){var aL=new M.Vector3().copy(ag.offsetPlaneSmall);aL.z-=0.001*ar;var aD=Math.PI*Math.max(0.1,0.5-ag.dirLightLatitude);var bw=Math.sin(aD)+(Math.cos(aD)+1)/Math.tan(aD);ba*=bw;ag.createInfinitePlane(ag.infPlaneSmall,0,ba,aL)}else{ag._removeInfinitePlane(ag.infPlaneSmall)}if(ag.planeV2&&ag.planeGrid){ag.planeGrid.createPlaneGrid(ag.planeSize,ag.offsetPlaneBackground,bm,ag.ambience.isAutoGroundOffset())}else{if(ag._infinitePlane){ag.createInfinitePlane(ag.infPlane,1,ag.planeSize,ag.offsetPlaneBackground)}if(ag._displayGrid){if((ar>0)||this.displayGridFromBelow){ag.createGrid(ag.planeSize,ag.offsetPlaneBackground,Math.abs(bj.position.z-ag.offsetPlaneBackground.z),Math.abs(bd),a9)}else{ag._removeGrid()}}aW=new M.Vector3().copy(ag.offsetPlaneBackground);aW.applyMatrix4(bj.matrixWorldInverse);if(this.grid!==null){this.grid.material.uniforms.gridCenter.value.copy(aW);if(this.bigGrid!==null){this.bigGrid.material.uniforms.gridCenter.value.copy(aW)}}}if(ag.useGroundShadow){var aA=ag.dirLightGroundShadow;var aN=bm.getUpDirection();var aH=bm.getSightDirection();var a2=new M.Vector3().crossVectors(aH,aN);ao=new M.Vector3(0,0,2*at.radius);aA.position=new M.Vector3().copy(at.center).add(ao);aA.lookAt(at.center);aA.target.position.copy(at.center);aA.target.updateMatrixWorld();aA.castGroundShadow=true;aV=aA.position.distanceTo(at.center);if(aA.shadowCamera){aA.updateShadowMap=!aA.blockUpdate&&(aA.updateShadowMap||(aA.shadowCamera.top!==0.5*ba));aA.shadowCamera.far=aV+at.radius;aA.shadowCamera.near=Math.max(0.001*aA.shadowCamera.far,aV-at.radius);aA.shadowCamera.left=-0.5*ba;aA.shadowCamera.right=0.5*ba;aA.shadowCamera.bottom=-0.5*ba;aA.shadowCamera.top=0.5*ba;aA.shadowCamera.updateProjectionMatrix()}else{aA.shadowCameraFar=aV+at.radius;aA.shadowCameraNear=Math.max(0.001*aA.shadowCameraFar,aV-at.radius);aA.shadowCameraLeft=-0.5*ba;aA.shadowCameraRight=0.5*ba;aA.shadowCameraBottom=-0.5*ba;aA.shadowCameraTop=0.5*ba;aA.updateShadowMap=true}}else{ag.dirLightGroundShadow.castGroundShadow=false}}if(ag.useGroundShadow&&ag.useShadowPlane&&!ag._2DMode){ag.__setGroundShadow()}if(!this.cameraSystem){this.renderCamera(bj,null,aQ,bp,aX,by,aC,bc,bo,bl,"main",ar)}else{var bh,aw,aS=this.trackingViewpoint||bm;bh=this.cameraSystem.computeCameraArray(bm,aS.camera.near,aS.camera.far);if(this.cameraSystem.useExternalProjectionMatrix){var a0=H*this.cameraBackgroundFar;if(this._nearFarBigScale){a0=Math.min(0.001,a0)}aw=this.cameraSystem.computeCameraArray(bm,a0,this.cameraBackgroundFar)}var bi=[],br=this.renderer.renderer.getViewportSize();for(aU=0;aU<bh.length;aU++){this.renderer.renderer.cameraSystem_cameraIndex=aU;bi.push("cameraSystem"+aU);if(this.mobile||!this.useHDR){this.renderer.renderer.setSplitScreenMode(aU*br.width,0)}else{this.renderer.renderer.removeSplitScreenMode()}if(this.sphereEnv&&this.sphereEnv.material){var az=this.sphereEnv.material.uniforms;if(az&&az.cameraSight){if(bh[aU].fullWidth){az.invScreenSize.value.x=1/bh[aU].width;az.invScreenSize.value.y=1/bh[aU].height;az.startOffset.value.x=bh[aU].x/bh[aU].fullWidth;az.startOffset.value.y=bh[aU].y/bh[aU].fullHeight;az.endOffset.value.x=(bh[aU].x+bh[aU].width)/bh[aU].fullWidth;az.endOffset.value.y=(bh[aU].y+bh[aU].height)/bh[aU].fullHeight}else{az.invScreenSize.value.x=1/br.width;az.invScreenSize.value.y=1/br.height;az.startOffset.value.x=0;az.startOffset.value.y=0;az.endOffset.value.x=1;az.endOffset.value.y=1}}}this.renderCamera(bh[aU],aw&&aw[aU],false,bp,aX,by,aC,bc,bo,bl,bi[aU],ar)}if(!this.mobile&&this.useHDR){if(!this.renderer.combineResults(bi,aQ,this.cameraSystem)){this.render()}}else{this.renderer.renderer.enableScissorTest(false)}}if((bm!==null)&&aP&&(at!==null)){bm.resetCameraOrientation();bm.reframe(undefined,undefined,undefined,a8)}if(this.ODTMode){if(M.ImageUtils.nbTexturesBeingLoaded>0){ag.render()}else{if(ag.renderFrameCB){ag.renderFrameCB()}}}else{if(ag.renderFrameCB){ag.renderFrameCB()}}if(M.webGLStats){M.webGLStats.dump()}};this.renderCamera=function(aB,ao,aC,aH,ay,aG,aF,aE,ap,an,az,aA){var av=this.currentViewpoint;av._renderedCamera=aB;if(this.internalSceneGraph&&av){this.internalSceneGraph.selectionHL.updateHighlight(av);this.internalSceneGraph.selectionPreHL.updateHighlight(av);this.renderer.updateEffects(this.internalSceneGraph,this.currentViewpoint,ap,aH)}if(ao){this.sceneBackground.remove(this.cameraBackground);this.cameraBackground=ao;this.sceneBackground.add(this.cameraBackground)}else{if((!this.cameraBackground.isOrtho&&!aB.isOrtho)||(this.cameraBackground.isOrtho&&aB.isOrtho)){aB.clone(this.cameraBackground)}else{this.sceneBackground.remove(this.cameraBackground);this.cameraBackground=aB.clone();this.sceneBackground.add(this.cameraBackground)}var au=H*this.cameraBackgroundFar;if(this._nearFarBigScale){au=Math.min(0.001,au)}this.cameraBackground.near=au;this.cameraBackground.far=this.cameraBackgroundFar;if(this.cameraBackground.isOrtho){this.cameraBackground.near=this.cameraBackgroundNear}this.cameraBackground.updateProjectionMatrix();this.cameraBackground.projectionMatrixInverse.getInverse(this.cameraBackground.projectionMatrix)}if((!this.cameraReflected.isOrtho&&!aB.isOrtho)||(this.cameraReflected.isOrtho&&aB.isOrtho)){aB.clone(this.cameraReflected)}else{this.cameraReflected=aB.clone()}this.cameraReflected.matrixAutoUpdate=false;var aw=new M.Matrix4(1,0,0,0,0,1,0,0,0,0,-1,2*this.offsetPlaneBackground.z,0,0,0,1);var aD=new M.Matrix4().copy(aB.matrixWorld);aw.multiply(aD);this.cameraReflected.setMatrix(aw);if(this.SCREEN_WIDTH&&this.SCREEN_HEIGHT){var ax=(aA>0)&&this.useMirror;var ar=(this._infinitePlane||this._displayGrid||this.ambience.getBackground().isActivated()||ax);var at=(this.useDefaultLights&&this.useShadowMap)||this.isShadowMap();var av=this.currentViewpoint;av._updateRobotCamera(this.internalSceneGraph);this.planeGrid&&this.planeGrid.updateLabels(av);var aI={main:aB,cameraBackground:this.cameraBackground,connectedRobotCamera:av.connectedRobotCamera,robotCameraOrtho:av.robotCameraOrtho,mirrorCamera:this.cameraReflected};this.renderer.render(ar,ax,at,this.sceneBackground,aI,this.internalSceneGraph,this.infPlaneSmall,this.ambience.getGroundGlossiness(),aC,aH,this.hasSceneGraphOverrideSet(),ay,aG,aF,aE,ap,an,az);if(window.__debugLoop__){var aq=performance.now();var am=0;while(am<600){am=performance.now()-aq}}}};this.renderToTarget=function(aH,a1,ao){var aQ=false;if(!ag.SCREEN_WIDTH||!ag.SCREEN_HEIGHT){return}var aR=window.devicePixelRatio||1;var ay=Math.floor(aR*ag.SCREEN_WIDTH);var a0=Math.floor(aR*ag.SCREEN_HEIGHT);if(!aH){aH={data:null,width:ay,height:a0,bufferWidth:0,bufferHeight:0,x:0,y:0}}if((aH.width>ay)||(aH.height>a0)){aQ=true}if((aH.data===null)||(aH.bufferWidth<aH.width)||(aH.bufferHeight<aH.height)){aH.data=new Uint8Array(4*aH.width*aH.height);aH.bufferWidth=aH.width;aH.bufferHeight=aH.height}if(!aH.x){aH.x=0}if(!aH.y){aH.y=0}if(ag.autoUpdateFrustum){ag._updateNearFar()}var aD=a1.camera;aD.updateProjectionMatrix();aD.projectionMatrixInverse.getInverse(aD.projectionMatrix);var aw=ag.getWebGLContext();var aU=ag.getRenderer();aU.removeSplitScreenMode();if(aQ){var aZ=ay;var a9=a0;var aT=Math.ceil(aH.width/aZ);var aS=Math.ceil(aH.height/a9);var aG=aH.width;var ax=aH.height;var a6=aG-aT*aZ;var an=ax-aS*a9;var aK=0;var aL=0;var at=aG;var aI=ax;var aA=aZ;var aJ=a9;if(a1.camera.fullWidth){var a2={fullWidth:a1.camera.fullWidth,fullHeight:a1.camera.fullHeight,x:a1.camera.x,y:a1.camera.y,width:a1.camera.width,height:a1.camera.height};var aC=a2.width/aG;var aF=a2.height/ax;at=a2.fullWidth;aI=a2.fullHeight;aK=a2.x;aL=a2.y;aA*=aC;aJ*=aF}var a3=a1.camera;var au=new Uint8Array(4*aZ*a9);for(var a7=0;a7<aS;a7++){for(var a8=0;a8<aT;a8++){var bb=Math.min(aZ,aH.width-a8*aZ);var aq=Math.min(a9,aH.height-a7*a9);var aE=a3.clone();aE.setViewOffset(at,aI,a8*aA+aK,a7*aJ+aL,aA,aJ);a1.camera=aE;ag.glRender([{viewpoint:a1,toScreen:false}]);aw.readPixels(0,0,aZ,a9,aw.RGBA,aw.UNSIGNED_BYTE,au);var ap=aS-a7-1;var aY=0;if(ap>0){aY=ap*a9+an}for(var a5=0;a5<aq;a5++){for(var a4=0;a4<bb;a4++){var az=aG*(aY+a5)+a8*aZ+a4;var aN=(a9-aq+a5)*aZ+a4;var aB=a5*aG+a4;aH.data[4*az]=au[4*aN];aH.data[4*az+1]=au[4*aN+1];aH.data[4*az+2]=au[4*aN+2];aH.data[4*az+3]=au[4*aN+3]}}}}a1.camera=a3}else{if(ao){var aV={xMin:Math.max(0,-aH.x),xMax:Math.max(0,aH.x+aH.width-ay),yMin:Math.max(0,-aH.y),yMax:Math.max(0,aH.y+aH.height-a0)};var av=(aV.xMin>0)||(aV.xMax>0)||(aV.yMin>0)||(aV.yMax>0);var aX=aH.x;var aW=aH.y;if(av){var a3=a1.camera;var ba=a3.clone();ba.setViewOffsetInternal(ay,a0,(aV.xMin>0)?-aV.xMin:((aV.xMax>0)?aV.xMax:0),(aV.yMin>0)?aV.yMin:((aV.yMax>0)?-aV.yMax:0),ay,a0);a1.camera=ba;aX=(aV.xMin>0)?0:((aV.xMax>0)?ay-aH.width:aH.x);aW=(aV.yMin>0)?0:((aV.yMax>0)?a0-aH.height:aH.y)}aU.setScissor(aX,aW,aH.width,aH.height);aU.enableScissorTest(true);ag.glRender([{viewpoint:a1,toScreen:false}]);aU.enableScissorTest(false);if(av){a1.camera=a3}aw.readPixels(aX,aW,aH.width,aH.height,aw.RGBA,aw.UNSIGNED_BYTE,aH.data)}else{var a3=a1.camera;var ba=a3.clone();var aX=0.5*(ay-aH.width);var aW=0.5*(a0-aH.height);if(a3.fullWidth){aX=0;aW=a0-aH.height;var aM=aH.width/aH.height;var am=aM*a3.height;ba.x-=0.5*(am-ba.width);ba.width=am;var aP=ay/aH.width;var aO=a0/aH.height;ba.width*=aP;ba.height*=aO}else{var ar=Math.tan(M.Math.degToRad(a3.fov*0.5))*a3.near;ba.fov=M.Math.radToDeg(2*Math.atan((a0/aH.height)*ar/a3.near))}ba.updateProjectionMatrix();ba.projectionMatrixInverse.getInverse(ba.projectionMatrix);a1.camera=ba;aU.setScissor(aX,aW,aH.width,aH.height);aU.enableScissorTest(true);ag.glRender([{viewpoint:a1,toScreen:false}]);aU.enableScissorTest(false);a1.camera=a3;aw.readPixels(aX,aW,aH.width,aH.height,aw.RGBA,aw.UNSIGNED_BYTE,aH.data)}}if(ag.mobile){ag.glRender([{viewpoint:a1,onlyPostProcess:false}])}else{ag.render({onlyPostProcess:false})}};this._renderToCanvas=function(ao,ap){var aw,au;if(this.svgRootNode){var am;var ar=this.svgRootNode;am=ar.cloneNode(true);am.setAttributeNS(null,"width",this.canvas.width);am.setAttributeNS(null,"height",this.canvas.height);am.style.left=0;am.style.top=0;am.style.width=this.canvas.width+"px";am.style.height=this.canvas.height+"px";var aq=(am.outerHTML)?am.outerHTML:(new XMLSerializer()).serializeToString(am);var aE=new Blob([aq],{type:"image/svg+xml;charset=utf-8"});var aC=window.URL.createObjectURL(aE);var aG=new Image();var ax=this;aG.onload=function(){aw=ax.canvas.width;au=ax.canvas.height;aG.width=aw;aG.height=au;var aK={width:aw,height:au,data:null};ax.renderToTarget(aK,ax.currentViewpoint);var aP=document.createElement("canvas");aP.width=aw;aP.height=au;var aI=aP.getContext("2d");var aO=aI.createImageData(aw,au);var aN=aO.data;for(var aJ=0;aJ<aO.height;aJ++){for(var aL=0;aL<aO.width;aL++){var aH=aL+aJ*aw;var aM=aL+(au-aJ-1)*aw;aN[4*aH]=aK.data[4*aM];aN[4*aH+1]=aK.data[4*aM+1];aN[4*aH+2]=aK.data[4*aM+2];aN[4*aH+3]=aK.data[4*aM+3]}}aI.putImageData(aO,0,0);setTimeout(function(){var aR=document.createElement("canvas");aR.width=aw;aR.height=au;var aQ=aR.getContext("2d");aQ.drawImage(aG,0,0);aQ.drawImage(aP,0,0);window.URL.revokeObjectURL(aC);ao(aR)},100)};aG.onerror=function(){window.URL.revokeObjectURL(aC);ap()};aG.src=aC}else{aw=this.canvas.width;au=this.canvas.height;var ay={width:aw,height:au,data:null};this.renderToTarget(ay,this.currentViewpoint);var aD=document.createElement("canvas");aD.width=aw;aD.height=au;var aB=aD.getContext("2d");var av=aB.createImageData(aw,au);var aF=av.data;for(var az=0;az<av.height;az++){for(var aA=0;aA<av.width;aA++){var an=aA+az*aw;var at=aA+(au-az-1)*aw;aF[4*an]=ay.data[4*at];aF[4*an+1]=ay.data[4*at+1];aF[4*an+2]=ay.data[4*at+2];aF[4*an+3]=ay.data[4*at+3]}}aB.putImageData(av,0,0);ao(aD)}};this.renderCubemap=function(av,ar,aq,aw,ap){var aA;var an=function(aC,aB){aA=UWA.createElement("canvas");aA.setStyles({position:"absolute",top:"0px",left:"0px",width:aC+"px",height:aB+"px"});webGLV6Viewer.div.appendChild(aA);aA.width=aC;aA.height=aB};var ay=function(aG,aD,aQ,aC,aO){console.log("display map, width="+aD+" height="+aQ);function aI(aU,aT,aS,aV,aW){if(aW){aT=aV-aT}return aS*Math.floor(aT)+Math.floor(aU)}var aR=aA.getContext("2d");var aN=aR.getImageData(0,0,aC,aO);var aL=aN.data;var aM=(aD-1)/(aC-1);var aE=(aQ-1)/(aO-1);for(var aF=0;aF<aO;aF++){for(var aH=0;aH<aC;aH++){var aB=aI(aH,aF,aC,aO,false);var aP=aM*aH;var aJ=aE*aF;var aK=aI(aP,aJ,aD,aQ,true);aL[4*aB]=255*aG[4*aK];aL[4*aB+1]=255*aG[4*aK+1];aL[4*aB+2]=255*aG[4*aK+2];aL[4*aB+3]=255}}aR.putImageData(aN,0,0,0,0,aC,aO)};var at=new j(this,90,undefined,undefined,false);var ax=at.camera;ax.aspect=1;ax.position=av;ax.useQuaternion=true;var ao=new M.Vector3();for(var au=0;au<6;au++){switch(au){case 0:ax.up.set(0,-1,0);ax.lookAt(ao.addVectors(av,new M.Vector3(1,0,0)));break;case 1:ax.up.set(0,-1,0);ax.lookAt(ao.addVectors(av,new M.Vector3(-1,0,0)));break;case 2:ax.up.set(0,0,1);ax.lookAt(ao.addVectors(av,new M.Vector3(0,1,0)));break;case 3:ax.up.set(0,0,-1);ax.lookAt(ao.addVectors(av,new M.Vector3(0,-1,0)));break;case 4:ax.up.set(0,-1,0);ax.lookAt(ao.addVectors(av,new M.Vector3(0,0,1)));break;case 5:ax.up.set(0,-1,0);ax.lookAt(ao.addVectors(av,new M.Vector3(0,0,-1)));break;default:break}ax.updateMatrix();if(ag.autoUpdateFrustum){ag._updateNearFar()}ax.updateProjectionMatrix();ax.projectionMatrixInverse.getInverse(ax.projectionMatrix);ag.glRender([{viewpoint:at,toScreen:false,onlyForward:true,cubemap:true,cubemapResolution:ar,cubeFace:au}])}var am=this.renderer.compForwardComposerContext.renderResults.main;var az=["DS/EffectsDebug/ConvertCubemapToLatlong","DS/Visualization/AmbianceGenerator"];require(az,function(aC,aE){if(!ag.renderer.compConvertCubeMapToLatLong){ag.renderer.compConvertCubeMapToLatLong=new aC(ag.renderer.renderer,ag.renderer.renderTargetPool)}if(aq){ag.renderer.compConvertCubeMapToLatLong.setEnvMap(am);var aD=ag.getRenderer().ambianceGenerators;if(!aD.manager){aD.manager=new aE(aD.cb)}var aG=ag.renderer.compConvertCubeMapToLatLong.composers[1];var aB="shoot360";var aF=aD.manager._getGenerator(aB,false);var aH=function(){var aK=ag.renderer.compConvertCubeMapToLatLong.saveComposer.composerContext.getResult(undefined,true);aK.hdr=true;aK.mapping=new M.LatLongReflectionMapping();var aJ=aF._getResult();if(aw){var aI={map0:aK,map1:aJ,position:aw.position,geomProxy:new M.Box3(aw.minAABB,aw.maxAABB)};ag.internalSceneGraph.scene.reflectionProbes.push(aI);ag.internalSceneGraph.scene.recompileShaders()}else{ag.internalSceneGraph.scene.envMipMap[0]=aK;ag.internalSceneGraph.scene.envMipMap[1]=aJ}if(ag.internalSceneGraph.scene.envMipMapID){ag.renderer.renderer.ambianceGenerators.decreaseUseCount(ag.internalSceneGraph.scene.envMipMapID);ag.internalSceneGraph.scene.envMipMapID=null}ap&&ap()};aF.setCallBack(aH);aF.setValues(aG);ag.renderer.compConvertCubeMapToLatLong.execute();ag.renderer.compConvertCubeMapToLatLong.encodeRGBE();aF.execute();aD.manager._disposeGenerator(aB,false)}else{ag.renderer.compConvertCubeMapToLatLong.setEnvMap(am);ag.renderer.compConvertCubeMapToLatLong.execute();ag.renderer.compConvertCubeMapToLatLong.renderToScreen();ag.renderer.compConvertCubeMapToLatLong.saveAsHDR("reflection");ap&&ap()}})};this.grabDepthBuffer=function(am){if(!ag.SCREEN_WIDTH||!ag.SCREEN_HEIGHT){return}var aq=window.devicePixelRatio||1;var an=Math.floor(aq*ag.SCREEN_WIDTH);var ao=Math.floor(aq*ag.SCREEN_HEIGHT);if(!am){am={data:null,_dataUint8:null,width:an,height:ao,bufferWidth:0,bufferHeight:0}}if((am.width>an)||(am.height>ao)){am.width=an;am.height=ao}if(!am._dataUint8||(am.bufferWidth<am.width)||(am.bufferHeight<am.height)){am._dataUint8=new Uint8Array(4*am.width*am.height);am.data=null;am.bufferWidth=am.width;am.bufferHeight=am.height}var ap=ag.getWebGLContext();this.renderer.computeDepthBuffer(this.internalSceneGraph,this.currentViewpoint,true);ap.readPixels(0,0,am.width,am.height,ap.RGBA,ap.UNSIGNED_BYTE,am._dataUint8);am.data=new Float32Array(am._dataUint8.buffer);return am};if(!this.useOffscreenCanvas){this.SCREEN_WIDTH=this.canvas.offsetWidth;this.SCREEN_HEIGHT=this.canvas.offsetHeight}else{this.SCREEN_WIDTH=this.canvas.width;this.SCREEN_HEIGHT=this.canvas.height}this.initResources(this.canvas);this.onWebGLContextLost=function af(am){console.log("WebGL context Lost !");am.preventDefault()};this.canvas.addEventListener("webglcontextlost",this.onWebGLContextLost,false);this.onWebGLContextRestore=function ah(){window.__debugLoop__=false;ag.renderer.renderer.restoreGLContext();ag.render()};this.canvas.addEventListener("webglcontextrestored",this.onWebGLContextRestore,false);this.renderer=new c({canvas:this.canvas,context:this.materialManager.getContext(),divCSS:this.divCss3DElement,useOffscreenCanvas:this.useOffscreenCanvas,deferred:this.deferred,useCompositing:!this.mobile&&this.useHDR,tonemapping:1,bgColor:this.ambience.getBackgroundColor().getHex(),bgAlpha:this.ambience.getBackgroundAlpha(),viewer:this,visibleSpace:this.visibleSpace,antiAliasing:((!this.useHDR||this.mobile)&&this.antiAliasing&&(this.antiAliasing!=="NoAA"))?true:"NoAA",preserveDrawingBuffer:al.preserveDrawingBuffer,debugContext:al.debugContext});this.renderer.renderer.precomputedTexture1=this.materialManager.precomputedTexture1;this.renderer.renderer.precomputedTexture2=this.materialManager.precomputedTexture2;this.renderer.renderer.precomputedTexture3=this.materialManager.precomputedTexture3;this.renderer.renderer.precomputedAreaGGX1texture=this.materialManager.precomputedAreaGGX1texture;this.renderer.renderer.precomputedAreaGGX2texture=this.materialManager.precomputedAreaGGX2texture;this.renderer.renderer.precomputedAreaSheentexture=this.materialManager.precomputedAreaSheentexture;this.renderer.renderer.ambianceGenerators=M._AmbianceGenerators;this.renderer.renderer.ambianceGenerators.viewers.push(this);this.renderer.renderer.visibleSpace=this.visibleSpace;this.renderer.renderer.newMaterialInheritance=window.newMaterialInheritance;switch(this.antiAliasing){case"NoAA":break;case"FXAA":this.renderer.setEffect("FXAA",true);break;case"MLAA":this.renderer.setEffect("MLAA",true);break;case"SMAA":this.renderer.setEffect("SMAA",true);break;case"MSAA":this.renderer.setEffect("MSAA",true);break;case"FSAA":case"SSAA":this.renderer.setEffect("FSAA",true);break;default:break}this.renderer.setEffect("Vignetting",this.useVignetting);this.renderer.setEffect("SSAO",this.useSSAO&&!this.useSSAOIterative);this.renderer.setEffect("SSAOIterative",this.useSSAO&&this.useSSAOIterative);this.renderer.setEffect("SSLR",this.useSSLR);this.renderer.setEffect("DOF",this.useDOF);this.renderer.setEffect("Bloom",this.useBloom);this.renderer.setEffect("Flare",this.useFlare);this.renderer.setEffect("OIT",this.useOIT);this.useOIT=this.renderer.useOIT;this.setPicking({});this.setPrePicking({});if(this.useDefaultLights){ak()}this.setIntensityCorrection(true);ai();aa.apply(this);if(this.defaultAnimationLoop){ab(0,false)}function ai(){ag.dirLightGroundShadow=new M.DirectionalLight(16777215,0);var am=ag.dirLightGroundShadow;am.position.set(0,0,40);am.castGroundShadow=ag.useGroundShadow;am.onlyShadow=true;am.shadowCascade=false;am.shadowMapWidth=ag.shadowMapWidth;am.shadowMapHeight=ag.shadowMapHeight;am.shadowCameraNear=40;am.shadowCameraFar=150;am.shadowBias=-0.001;am.shadowDarkness=0.65}function ak(){ag.setAmbientLight(2236962);ag.directionalLight=new M.DirectionalLight(16777215,0.9);var am=ag.directionalLight;am.position.set(40,40,40);am.castShadow=ag.useShadowMap;am.shadowCameraNear=40;am.shadowCameraFar=150;am.shadowBias=-0.001;am.shadowDarkness=0.65;am.shadowMapWidth=ag.shadowMapWidth;am.shadowMapHeight=ag.shadowMapHeight;ag.renderer.renderer.shadowMapAutoUpdate=true;am.shadowCascade=false;if(ag.triLights){am.intensity=0.7;am.shadowDarkness=0.3;ag.directionalLight2=new M.DirectionalLight(16777215,0.7);ag.directionalLight3=new M.DirectionalLight(16777215,0.7);ag.directionalLight3.position.set(40,-40,40)}else{ag.directionalLight2=new M.DirectionalLight(3827071,1)}ag.directionalLight2.position.set(40,-40,40)}function aa(){this.div.appendChild(this.renderer.renderer.domElement);if(B._isInit===undefined){B.init()}this.manipulatorManager=new z(this)}function ab(at,au){if(!ag){return}if(ag.fpsCounter){ag.fpsCounter.onAnimate()}if(B.RecordEventsManager){B.RecordEventsManager.pushRecordAnimateEvent(ag)}if(!au&&ag.defaultAnimationLoop){requestAnimationFrame(ab)}if(!ag.isRenderIteration){ag.renderIteration=0}if(ag.capturer){ag.capturer.capture(ag.canvas,ag.renderIteration)}var aE,av,am,aw,aG,aF,aq=new e(),aH=new Date(),ao=aH.getTime()-ag._oldTime;ag._oldTime=aH.getTime();aq.step(ao);aG=false;var ax,aC,aB;aB=window.devicePixelRatio||1;if(!ag.useOffscreenCanvas){ax=ag.div.offsetWidth||1;aC=ag.div.offsetHeight||1}else{ax=ag.canvas.width||1;aC=ag.canvas.height||1}var aK=false;if(ag.lazyResize){if((ag.oldCanvasSize.width!==ax)||(ag.oldCanvasSize.height!==aC)||(ag.oldCanvasSize.dpr!==aB)){ag.oldCanvasSize.width=ax;ag.oldCanvasSize.height=aC;ag.oldCanvasSize.dpr=aB;ag.oldCanvasSize.time=new Date().getTime();aG=true}else{if((ag.oldCanvasSize.time>=0)&&(new Date().getTime()-ag.oldCanvasSize.time>300)){ag.oldCanvasSize.time=-1;aK=true}}}else{if((ag.SCREEN_WIDTH!==ax)||(ag.SCREEN_HEIGHT!==aC)||(ag.devicePixelRatio!==aB)){aK=true;aG=true}}if(aG&&ag.currentViewpoint){ag.currentViewpoint.camera._hasChanged=true}if(ag.cameraSystemUpdated){ag.cameraSystemUpdated=false;aK=2}if(aK){Z(undefined,aK===2)}if(ag.currentViewpoint===null){return}av=ag.currentViewpoint.getControl();if(av!==null){av.update()}aE=ag.currentViewpoint.camera;if(aE){aE.updateMatrix();aE.matrixWorld.copy(aE.matrix);aE.matrixWorldInverse.getInverse(aE.matrixWorld)}if(ag.autoUpdateFrustum){var az=ag._updateNearFar();if(az){ag.renderIteration=0}}aE.updateProjectionMatrix();aE.projectionMatrixInverse.getInverse(aE.projectionMatrix);am=aE.getLookAt();am.add(aE.position);if(aG){h.publish({event:"/VISU/onWindowResized",data:{eventChannel:"/VISU/onWindowResized",eventType:"@onWindowResized",viewpoint:ag.currentViewpoint,cameraEye:aE.position,cameraTarget:am,cameraUp:aE.up}});ag._modelEvent.publish({event:"Resize",data:{width:ax,height:aC}})}if(M.ImageUtils.nbTexturesBeingLoaded<ag.lastNbTexturesBeingLoaded){ag.render()}ag.lastNbTexturesBeingLoaded=M.ImageUtils.nbTexturesBeingLoaded;var ay=ag._requestRender;if(ay&&!ag._onlyPostProcess){ag.renderIteration=0}ag._onlyPostProcess=true;var aA=false;ag._setAntiAliasing((ag.renderIteration>0)?"static":"dynamic");if(ag.renderIteration<ag.renderer.getMaxIterationEffects()){aA=true}var aD=(aH.getTime()-ag.timeIter0>ag.delayBeforeIteration);var aJ=aD&&(ag.renderIteration===1);var ar=aD&&(ag.renderIteration>0);if(ay||(ar&&aA)||ag.forceRender||aJ){ag.forceRender=false;ag._requestRender=false;aF=ag._renderParams;ag._renderParams=[];if(aF.length){aF[0].renderIteration=ag.renderIteration;aF[0].isStillFrame=ar;aF[0].onlyPostProcess=aF[0].onlyPostProcess&&!aA}else{aF.push({renderIteration:ag.renderIteration,isStillFrame:ar})}if(ag.debugFPS){var aI=performance.now()-ag.debugFPSInfos.fpsLastTime;ag.debugFPSInfos.fpsLastTime=performance.now();var ap=1000/Math.max(aI,0.1);ag.debugFPSInfos.fpsCumul+=ap;ag.debugFPSInfos.fpsCumul-=ag.debugFPSInfos.fpsArray[ag.debugFPSInfos.fpsIndex];ag.debugFPSInfos.fpsValue=ag.debugFPSInfos.fpsCumul/ag.debugFPSInfos.fpsWindow;ag.debugFPSInfos.fpsArray[ag.debugFPSInfos.fpsIndex]=ap;ag.debugFPSInfos.fpsIndex=(ag.debugFPSInfos.fpsIndex+1)%ag.debugFPSInfos.fpsWindow;ag.debugFPSInfos.fpsCounter.setHTML(Math.ceil(ag.debugFPSInfos.fpsValue).toString())}ag.glRender(aF);if(!ag){return}if(ag.renderIteration===0){ag.timeIter0=aH.getTime()}ag.renderIteration++;if(ag.multiViewer){var an=ag.materialManager.getCanvas();ag.context2D.globalCompositeOperation="copy";ag.context2D.drawImage(an,0,an.height-ag.canvas.height,ag.canvas.width,ag.canvas.height,0,0,ag.canvas.width,ag.canvas.height)}ag._modelEvent.publish({event:"PostRender",data:{viewer:ag,viewpoint:ag.currentViewpoint}})}}function Z(aq,at){ag.devicePixelRatio=window.devicePixelRatio||1;if(!ag.useOffscreenCanvas){ag.SCREEN_WIDTH=ag.div.offsetWidth||1;ag.SCREEN_HEIGHT=ag.div.offsetHeight||1}else{ag.SCREEN_WIDTH=ag.canvas.width||1;ag.SCREEN_HEIGHT=ag.canvas.height||1}if(ag.svgRoot){ag._updateSVGVisu()}if(ag.multiViewer){var ap=Math.floor(ag.devicePixelRatio*ag.SCREEN_WIDTH);var ar=Math.floor(ag.devicePixelRatio*ag.SCREEN_HEIGHT);ag.materialManager.setCanvasSize(ap,ar)}var an,ao;if(!ag.cameraSystem){an=ag.SCREEN_WIDTH;ao=ag.SCREEN_HEIGHT}else{var am=ag.cameraSystem.getViewportSize(ag.SCREEN_WIDTH,ag.SCREEN_HEIGHT);an=am.width;ao=am.height}ag.renderer.setRendererSize(ag.SCREEN_WIDTH,ag.SCREEN_HEIGHT,ag.useOffscreenCanvas||at,an,ao,ag.devicePixelRatio);if(ag.currentViewpoint!==null){ag.currentViewpoint.camera.aspect=an/(ao);ag.currentViewpoint.camera.updateProjectionMatrix();ag.currentViewpoint.connectedRobotCamera.aspect=an/(ao);ag.currentViewpoint.connectedRobotCamera.updateProjectionMatrix();ag.currentViewpoint.robotCameraOrtho.aspect=an/(ao);ag.currentViewpoint.robotCameraOrtho.setVisualizedHeight(null,ag.currentViewpoint.robotCameraOrtho.aspect);ag.currentViewpoint.robotCameraOrtho.updateProjectionMatrix();ag.currentViewpoint.resize(an,ao)}ag.ambience.resize(an,ao,ag.devicePixelRatio);ag.renderIteration=0;ag.render()}this.animate=ab;function aj(){if(ag.internalSceneGraph===null){return}var am,aD,ao,aC,an,ar,ax,av,aw,aG,ap,at,au,ay,aE=ag.internalSceneGraph.scene,aq=aE.getMeshInstances(),aF,aB,aA,az;for(aB=0;aB<aq.length;aB++){am=aq[aB];aD=0.05*am.boundingSphere.radius;ao=null;aC=0;if(am.geometry.length>=0){ao=am.geometry[0];aC=am.geometry.length}else{if(am.geometry._type===2){ao=am.geometry;aC=1}}an=[];for(az=0;az<aC;az++){ar=ao.vertexPositionArray;ax=ao.vertexNormalArray;if(ax!==null){for(aA=0;aA<ar.length;aA+=3){an.push({x:ar[aA],y:ar[aA+1],z:ar[aA+2]});an.push({x:ar[aA]+aD*ax[aA],y:ar[aA+1]+aD*ax[aA+1],z:ar[aA+2]+aD*ax[aA+2]})}}ao=am.geometry[az+1]}if(an.length){av=new q.PrimitiveGroup();av.fillAttr=new q.FillAttributes();av.lineAttr=new q.LineAttributes();av.pointAttr=new q.PointAttributes();aw=new q.Buffer();aw.size=3*an.length;aw.component=q.VertexComponentEnum.POSITION;aw.format=q.DataTypeEnum.FLOAT;aw.dimension=3;aw.data=new Float32Array(aw.size);av.addBuffer(0,aw);aF=aw.data;az=0;for(aA=0;aA<an.length;aA++){aF[az++]=an[aA].x;aF[az++]=an[aA].y;aF[az++]=an[aA].z}aG=Math.ceil(an.length/65534);ap=0;for(aA=0;aA<aG;aA++){at=new q.Primitive();at.nbIndices=Math.min(an.length-ap,65534);at.connectivity=q.ConnectivityTypeEnum.LINES;at.attr={fill:new q.FillAttributes(),line:new q.LineAttributes(new q.Color(0,0,1,1)),point:new q.PointAttributes()};au=new q.VertexComponent();au.component=q.VertexComponentEnum.POSITION;au.nbVertices=3*Math.min(an.length-ap,65534);au.nbValuesPerVertex=3;au.format=q.DataTypeEnum.FLOAT;au.cardinality=0;au.bufferId=0;au.offset=ap;au.indices=null;at.addVertexComponent(au);av.addPrimitive(at);ap+=65534}ay=P.createMeshNode(av);ay.mesh3js.setMatrix(new M.Matrix4().copy(am.matrixWorld));ay.setPickable(false);ay.mesh3js.castShadow=false;ay.mesh3js.receiveShadow=false;ag.debugNormalNode.add(ay.mesh3js)}}}this.addEvent("onPostInject",function ae(){ab(0,true)});console.log("DS WebGL Viewer R"+this.version);this.internalSceneGraph=new N(this,this.multiViewerFix,al.showReferenceAxisSystem?false:true);if(this.mobile){this.setScanIntensity(1)}if(this.currentViewpoint!==null){this.internalSceneGraph.scene.add(this.currentViewpoint.getCamera())}this.internalSceneGraph.scene.add(this.ambientLight);if(this.useDefaultLights){this.internalSceneGraph.scene.add(this.directionalLight);this.internalSceneGraph.scene.add(this.directionalLight2);if(this.triLights){this.internalSceneGraph.scene.add(this.directionalLight3)}}this.internalSceneGraph.scene.add(this.dirLightGroundShadow);this._glFPSCounter=null;this._glInfoCounter=null;this._glNodeCounter=null;this.fpsCounter=null;this.blurShadowEffect=null;this.displayHighlight=false;this.name="";this.debugLocalBBox=false;this.debugBBox=false;this.debugHandleMatrix=false;this.localBBox=null;this.BBox=null;return this},buildSkeleton:function(){if(this.div===null){this.elements.container=UWA.createElement("div");this.div=this.elements.container;this.div.setStyles({width:"100%",height:"100%"})}else{this.elements.container=UWA.extendElement(this.div)}this.div.style["-ms-touch-action"]="none";this.canvas=UWA.createElement("canvas");if(D.isActive()){this.canvas.setAttribute("data-rec-id","FakeRecManager");D.registerElement(this.canvas,"DS/WebVisuRecord/FakeRec",true)}var Z={width:"100%",height:"100%"};if(this._svgMode&&!d.getWebGLMode()){Z.zIndex=10;Z.position="absolute";Z.left="0px";var aa=document.createElementNS(this.getSvgNS(),"svg");aa.setAttribute("xmlns","http://www.w3.org/2000/svg");aa.style.position="absolute";aa.style.width="100%";aa.style.height="100%";aa.style.top="0px";aa.style.left="0px";aa.style.backgroundColor="white";aa.style.zIndex=0;this.svgRootNode=aa;this.svgRoot=document.createElementNS(this.getSvgNS(),"g");this.svgRootNode.appendChild(this.svgRoot);this.div.appendChild(this.svgRootNode)}this.canvas.setStyles(Z);if(this.useOffscreenCanvas){this.canvas.width=this.div.width;this.canvas.height=this.div.height}this.div.appendChild(this.canvas);if(D.isActive()){this.canvas.webGLViewer=this;this.canvas.isWebGLCanvas=function(){return true}}},getSvgNS:function(){return"http://www.w3.org/2000/svg"},addBackgroundSVGNode:function(aa){if(!aa||!aa._cssSVGNode){return}this.renderer.resetGSSOCache();var Z=this.internalSceneGraph.svgRoot;Z.addChild(aa);this._updateSVGVisu()},removeBackgroundSVGNode:function(aa){if(!aa||!aa._cssSVGNode){return}this.renderer.resetGSSOCache();var Z=this.internalSceneGraph.svgRoot;Z.removeChild(aa);this._updateSVGVisu()},getAllBackgroundSVGNodes:function(){var Z=this.internalSceneGraph.svgRoot;return Z.children.concat([])},clearBackgroundSVGNodes:function(){this.renderer.resetGSSOCache();var aa=this.getAllBackgroundSVGNodes();var Z;for(Z=0;Z<aa.length;Z++){this.removeBackgroundSVGNode(aa[Z])}},buildSkeletonCss:function(){if(this.divCssElement===null){this.divCssElement=UWA.createElement("div");this.divCssElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"});this.div.appendChild(this.divCssElement)}else{this.divCssElement=UWA.extendElement(this.divCssElement)}this.divCssElement.style.WebkitTransformStyle="preserve-3d";this.divCssElement.style.MozTransformStyle="preserve-3d";this.divCssElement.style.oTransformStyle="preserve-3d";this.divCssElement.style.transformStyle="preserve-3d";this.divCssElement.id="divCssElement";this.divCss3DElement=UWA.createElement("div");this.divCss3DElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"});this.divCss3DElement.style.WebkitTransformStyle="preserve-3d";this.divCss3DElement.style.MozTransformStyle="preserve-3d";this.divCss3DElement.style.oTransformStyle="preserve-3d";this.divCss3DElement.style.transformStyle="preserve-3d";this.divCss3DElement.id="divCss3DElement";this.divCssElement.appendChild(this.divCss3DElement);this.divCss2DElement=UWA.createElement("div");this.divCss2DElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"});this.divCss2DElement.id="divCss2DElement";this.divCssElement.appendChild(this.divCss2DElement);this.divTrap=UWA.createElement("div",{id:"trapSelection"});this.div.appendChild(this.divTrap)},initResources:function(Z){var ab=(!this.useHDR||this.mobile)&&this.antiAliasing&&(this.antiAliasing!=="NoAA");this.materialManager=new L(c.testMode.testMode,this.multiViewer,ab,this);if(this.multiViewer){this.materialManager.setCanvasSize(Z.offsetWidth,Z.offsetHeight);this.context2D=Z.getContext("2d")}},onBackgroundModify:function(Z){return this._modelEvent.subscribe({event:"VisuBackgroundColor",data:this.ambience.getBackgroundColor().getHex()},Z)},onSwapVisibleSpace:function(Z){return this._modelEvent.subscribe({event:"SwapVisibleSpace",},Z)},onViewerResize:function(Z){return this._modelEvent.subscribe({event:"Resize"},Z)},onPreRender:function(Z){return this._modelEvent.subscribe({event:"PreRender"},Z)},onPostRender:function(Z){return this._modelEvent.subscribe({event:"PostRender"},Z)},onActivate:function(Z){return this._modelEvent.subscribe({event:"Activate"},Z)},onPreactivate:function(Z){return this._modelEvent.subscribe({event:"Preactivate"},Z)},onContext:function(Z){return this._modelEvent.subscribe({event:"Context"},Z)},unsubscribe:function(Z){this._modelEvent.unsubscribe(Z)},setMaterialMode:function(Z){this.renderer.resetGSSOCache();this.renderer.renderer.materialMode=Z;if(this._renderStyle){this._renderStyle._faceMode=Z?g.FaceModes.MATERIAL:g.FaceModes.GAS}this.internalSceneGraph.root.forceUpdate()},setGasLookMode:function(Z){this.renderer.resetGSSOCache();this.renderer.renderer.gasLookMode=Z},setDefaultPicking:function(aa){this._defaultPicking=aa?true:false;var ab=null;if(aa){var Z=WUX.Selection.PSOManager;this.centerMouseDownCB=function(ad,ac){};this.mouseMoveCB=function(aj,ah){var ak=aj.view;if(B.RecordEventsManager&&!ak){return}var am=aj.path&&this.canvas.impl?this.canvas.impl:this.canvas;if((ak!==am)&&!ak.renderable){while((ak!==am)&&ak.parentElement&&!ak.renderable){ak=ak.parentElement}if(!ak.renderable){if(this.lastAddedToPSO&&!this.lastAddedToPSO.ownedByUser){Z.remove(this.lastAddedToPSO);this.lastAddedToPSO=null}return}}if(!ah||ah.isMiddleButtonPressed()){return}var al,ad,ao,an;al=this.getMousePosition(aj.getCurrentPosition(this.canvas));if(this.pPicking.activated&&(!this.manipulatorManager||!this.manipulatorManager.isInManipulation(true,true))&&(!this.pPicking.disableWhileMoving||(this.pPicking.disableWhileMoving&&this.currentViewpoint&&!this.currentViewpoint.isMoving()))){an="mesh";if(this.pPicking.gpu){if(this.picking.primitive===2){an="repHybrid"}else{if(this.pPicking.primitive){an="primHybrid"}else{an="mesh"}}}else{if(this.picking.primitive===2){an="rep"}else{if(this.pPicking.primitive){an="prim"}else{an="mesh"}}}ad=this.pick(al,an,this.pPicking.computeNormalDepth);ao=false;if(!Z.isEmpty()||ad.path.length){ao=true}if(this._fillXSOMode){if(!ad.path.length){if(!Z.isEmpty()){this.lastAddedToPSO=null;Z.empty()}}else{if(this.pPicking.displayHL){var at=null;if(ad.path[0]){at=ad.path[0].getLastElement(true)}if(at instanceof T){if(!(at._getExcludeFromPreHL())&&!(at._getExcludeFromPSO())){var ac=ad.path[0];while(ac&&ac.getLastElement(true).getPickParent()){ac=ac.getParentPath()}if(!this.multiViewerFix&&!window.userRootOutOfPathElements){var ar;ar=ac;if(ar&&ar.externalPath.length>1){var ai=ar.externalPath.concat([]);ai.shift();ac=new O();if(ar.instanceId!==undefined){ac.instanceId=ar.instanceId}ac.setFromArray(ai,ar.internalPath)}}var ag={pathElement:ac,event:aj};if(!Z.isIn(ag)||Z.get().length>1){var aq=Z.get().slice();Z.remove(aq);Z.add(ag)}this.lastAddedToPSO=ag}}}}}this._modelEvent.publish({event:"Preactivate",data:{viewer:this,event:aj,pickingResult:ad,ctrl:ah.isCtrlKeyPressed(),shift:ah.isShiftKeyPressed()}})}if(ao){this.render({onlyPostProcess:true})}var ap="@pickNothing";var af;if(ad&&ad.path.length){var ae=ad.path[0].getLastElement();if(ae instanceof THREEDS.SubElement){if(ae.getType()==="primitive"){ap="@pickPrimitive"}else{if(ae.getType()==="rep"){ap="@pickRep"}}}else{if(ae!==null){ap="@pickMesh"}}}if(ap==="@pickNothing"){af={eventChannel:"/VISU/",eventType:"@onMoveEvent",eventID:ap,event:aj}}else{af={eventChannel:"/VISU/",eventType:"@onMoveEvent",eventID:ap,event:aj,from:ad.path[0],point:ad.position,normal:ad.normal,tangent:ad.tangent,uv:ad.uv,ray:ad.ray}}h.publish({event:"/VISU/",data:af});if(this.debugEvents>=6){console.log(af)}};this.centerMouseUpCB=function(af,ae){if(!ae||!ae.isMiddleClick()){return}var ac,ag;ac=this.getMousePosition(af.getCurrentPosition(this.canvas));if(!ae.lockPan&&!ae.lockReframeOnDblTap&&this.currentViewpoint!==null){ag=this.pick(ac,"mesh",true);if(ag.position!==null){this.currentViewpoint.centerCamera(ag.position)}else{if(ae._2DMode){this.currentViewpoint.centerCameraSVG(new M.Vector2(this.div.clientWidth*0.5,this.div.clientHeight*0.5),new M.Vector2(ac.xPix,ac.yPix))}}}var ad={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@middleClick",event:af};h.publish({event:"/VISU/",data:ad});if(this.debugEvents>=6){console.log(ad)}};this.leftMouseDownCB=function(ai,ah){var aj=ai.view;if(B.RecordEventsManager&&!aj){return}var ae=ai.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap;var al=ai.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(aj===ae){aj=al}if((aj!==al)&&!aj.renderable){while((aj!==al)&&aj.parentElement&&!aj.renderable){aj=aj.parentElement}if(!aj.renderable){return}}if(!ah||ah.isMiddleButtonPressed()||!ah.isLeftClick()){return}if(this.picking.trapSelection&&this.trapSelection){var ak=this.getMousePosition(ai.getCurrentPosition(this.canvas));var ac=this.pick(ak,"mesh",false);if(ac&&ac.path&&ac.path.length){var ad=ac.path[0].externalPath;for(var ag=0;ag<ad.length;ag++){if(ad[ag].getIsManipulator()){this.trapSelection.interrupt();break}}}}var af={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@leftClickDown",event:ai};h.publish({event:"/VISU/",data:af});if(this.debugEvents>=6){console.log(af)}};this.leftMouseUpCB=function(ad,ac){this._doPickingFromMouseEvent(ad,ac,null)},this._doPickingFromMouseEvent=function(aB,aq,aw){if(!this._defaultPicking){return}var am=aw||this.trapSelection;var at;var aE=aB.view;if(B.RecordEventsManager&&!aE){return}var aC=aB.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap;var ac=aB.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(aE===aC){aE=ac}var ad=false;if(this.picking.trapSelection&&am){at=am.getExtremities();ad=((at.pt!==undefined)&&((at.xPix!=at.pt.xPix)||(at.yPix!=at.pt.yPix)))}if(!ad&&(aE!==ac)&&!aE.renderable){while((aE!==ac)&&aE.parentElement&&!aE.renderable){aE=aE.parentElement}if(!aE.renderable){ab=null;return}}if(!aq||aq.isMiddleButtonPressed()){ab=null;return}if(this.picking.activated){var ap,ak,au,ax,aF,ao,al,ag;ax=null;aF=null;ao=null;al=null;if(!ad){at=this.getMousePosition(aB.getCurrentPosition(this.canvas))}var ae=am&&am.isActive;var av=this.magnifier&&this.magnifier.active&&(aB.getType()==="Touch");var az=aB.contextButton?aq.isRightClick():aq.isLeftClick();if(!ae&&(!av||(window.magnifierCheckDistance&&!this.magnifier.displayed))&&!az){return}if(window.magnifierCheckDistance&&av&&this.magnifier.displayed){this.magnifier.displayed=false;if(!this.magnifier.enableSelection){return}this.magnifier.enableSelection=false}if(!aw&&this.manipulatorManager&&this.manipulatorManager.isInManipulation()){return}if(aE!==ac){at.event=aB}ag="mesh";if(ad&&(this.picking.trapSelectionMesh||this.picking.trapSelection)){if(this.picking.trapSelection&&!this.picking.trapSelectionMesh&&this.picking.primitive){ag="primCPU"}else{ag="meshCPU"}}else{if(this.picking.gpu){if(this.picking.primitive===2){ag="repHybrid"}else{if(this.picking.primitive){ag="primHybrid"}else{ag="mesh"}}}else{if(this.picking.primitive===2){ag="rep"}else{if(this.picking.primitive){ag="prim"}else{if(am&&at.pt){ag="meshCPU"}else{ag="mesh"}}}}}ap=this.pick(at,ag,this.picking.computeNormalDepth,undefined,aw);var ai=aq.isShiftKeyPressed();var aj=(aq.isCtrlKeyPressed()||this.forceMultiSel);var ad=((at.pt!==undefined)&&((at.xPix!=at.pt.xPix)||(at.yPix!=at.pt.yPix)));var an=0,aA;if(!this.multiViewerFix&&!window.userRootOutOfPathElements){for(an=0;an<ap.path.length;an++){aA=ap.path[an];if(aA&&aA.externalPath.length>1){var ah=aA.externalPath.concat([]);ah.shift();ap.path[an]=new O();ap.path[an].setFromArray(ah,aA.internalPath);if(aA.instanceId!==undefined){ap.path[an].instanceId=aA.instanceId}}}}var ar;if(this._fillXSOMode){ar=this.addToCSOHSO(ap,{event:aB,multiSel:aj,additiveMode:ai,trapSel:ad})}if(this.internalSceneGraph!==null){if(this._fillXSOMode){var ay="@pickNothing";if(ap.path.length){var af=ap.path[0].getLastElement();if(af instanceof THREEDS.SubElement){if(af.getType()==="primitive"){ay="@pickPrimitive"}else{if(af.getType()==="rep"){ay="@pickRep"}}}else{if(af!==null){ay="@pickMesh"}}}var aD={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:ay,event:aB,from:ap.path[0],addedToCSO:ar.addedToCSO,removedFromCSO:ar.removedFromCSO,point:ap.position,normal:ap.normal,tangent:ap.tangent,uv:ap.uv,ray:ap.ray};h.publish({event:"/VISU/",data:aD});if(this.debugEvents>=6){console.log(aD)}}this._modelEvent.publish({event:"Activate",data:{viewer:this,event:aB,pickingResult:ap,ctrl:aq.isCtrlKeyPressed(),shift:aq.isShiftKeyPressed(),trapSelection:ad,contextButton:aB.contextButton?true:false}})}this.render({onlyPostProcess:true})}else{var ak=WUX.Selection.HSOManager;if(!ak.isEmpty()){ak.empty();this.render({onlyPostProcess:true})}}ab=null};this.rightMouseUpCB=function(ae,ad){if(ae.view!==this.canvas){return}if(!ad||ad.isMiddleButtonPressed()||ad.isLeftButtonPressed()||!ad.isRightClick()){return}if(this.picking.contextPick){ae.contextButton=true;this.leftMouseUpCB(ae,ad)}var ac={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@rightClick",event:ae};h.publish({event:"/VISU/",data:ac});this._modelEvent.publish({event:"Context",data:{viewer:this,event:ae,ctrl:ad.isCtrlKeyPressed()}});if(this.debugEvents>=6){console.log(ac)}}}else{this.centerMouseDownCB=null;this.mouseMoveCB=null;this.leftMouseDownCB=null;this.leftMouseUpCB=function(ag,af){var ae=ag.view;if(B.RecordEventsManager&&!ae){return}var ad=ag.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap;var ac=ag.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(ae===ad){ae=ac}if((ae!==ac)&&!ae.renderable){while((ae!==ac)&&ae.parentElement&&!ae.renderable){ae=ae.parentElement}if(!ae.renderable){return}}if(!af||af.isMiddleButtonPressed()){return}if((!this.trapSelection||(this.trapSelection&&!this.trapSelection.isActive))&&!af.isLeftClick()){return}if(this.manipulatorManager&&this.manipulatorManager.isInManipulation()){return}this._modelEvent.publish({event:"Activate",data:{viewer:this,event:ag,ctrl:af.isCtrlKeyPressed(),shift:af.isShiftKeyPressed()}})};this.rightMouseUpCB=null}},getDefaultPicking:function(){return this._defaultPicking},setCurrentHighlightSet:function(aa){this.renderer.resetGSSOCache();if(!aa){this.highlightColor=null;return}var Z=aa.sceneHL.colorHighlight;this.highlightColor=Z},setAmbience:function(aa,Z){this.renderer.resetGSSOCache();this.ambience=aa;this.ambience.resize(this.SCREEN_WIDTH,this.SCREEN_HEIGHT,this.devicePixelRatio);if(Z){this.setGroundOptions({groundSize:100,groundShadow:false,displayPlane:false,displayGrid:false,displayGridFromBelow:false,gridNbSteps:5,gridLabels:null,gridLabelCallback:null,gridDisplayLabelCallback:null,planeMirror:false,blurryMirror:false,planeColor:"#EEEEEE",planeOpacity:1,planeTexture:null,planeTextureScale:1,gridColor:"#EEEEEE",gridFalloff:0,planeFalloff:0,planeBorder:false,planeBorderColor:"#FFFFFF",});this.setGroundOptions(aa.getGroundOptions())}this.ambience.updateAmbience()},removeAmbience:function(){this.removeEnvMap();var Z=new A({viewer:this});this.setAmbience(Z,true)},createHighlightSet:function(Z,ac){if(this.mobile){return null}var aa=this._getHighlightSet(Z,ac);if(aa){return aa}aa=new U(this.internalSceneGraph);aa.setColorHighlight(Z);aa.setMultiColorMode(true);var ab=this.getEffect("Highlight");ab.addScene(aa);if(!ac){aa.detachToHSO()}this.internalSceneGraph.selectionHL.sceneHL.colorHighlight={color:new M.Color().setRGB(0,0.6,1),outlineColor:new M.Color().setRGB(0,1,1),intensity:0.5,polygonOffsetParameters:{activated:false,factor:1,unit:1}};this.highlightSets.push(aa);return aa},removeHighlightSet:function(Z){this.renderer.resetGSSOCache();var ab=this._removeHighlightSet(Z.getColorHighlight(),Z.linkToHSO);var aa=this.getEffect("Highlight");aa.removeScene(Z);Z.detachToHSO();Z.clearAll()},_getHighlightSet:function(Z,ac){var ab=this.highlightSets;for(var aa=0;aa<ab.length;aa++){var ad=ab[aa];if((ad.linkToHSO==ac)&&(ad.isEqualColor(Z))){return ad}}return null},_removeHighlightSet:function(Z,ac){var ab=this.highlightSets;for(var aa=0;aa<ab.length;aa++){var ad=ab[aa];if((ad.linkToHSO==ac)&&(ad.isEqualColor(Z))){ab.splice(aa,1);return true}}return false},addToCSOHSO:function(Z,ak){function aa(ar){var ap,ay,ax,aw=[],al=[],at=false;for(ap=0;ap<Z.path.length&&!at;ap++){ay=Z.path[ap];ax=ay.getLastElement(true);if(!(ax._excludeFromCSO)){aw.push(ay);if(!ar){at=true}}}if(!aw.length&&Z.path.length){return null}var av={CSO:[],HSO:[]};var an=[],au;var ao,aq,am;for(ap=0;ap<aw.length;ap++){ay=aw[ap];au=false;while(ay.getLastElement(true).getPickParent()){ay=ay.getParentPath();au=true}aq=false;if(au){for(ao=0;ao<an.length;ao++){if(an[ao].isEqual(ay)){aq=true}}if(!aq){an.push(ay)}}if(!aq){av.CSO.push(ay);am=ay.getLastElement(true);if(!(am._excludeFromHL)&&!(am._excludeFromHSO)){av.HSO.push(ay)}}}return av}function ag(al){var ap=al.get();var ao=[];for(var am=0;am<ap.length;am++){var an=ap[am];var aq=an.pathElement;if(!aq&&an.options){aq=an.options.pathElement}if(aq){ao.push(aq)}}return ao}function aj(av,ao,au,am){var at={removed:[],added:[]};if(au){at.removed=ag(ao);ao.empty()}var ar,ap;var al,aA,aw=[],an=[],ay={highlightColor:ae.highlightColor};al=ao.get();var az,aq,ax;for(ar=0;ar<av.length;ar++){aA=av[ar];az=false;for(ap=0;ap<al.length&&!az;ap++){aq=al[ap];ax=aq.pathElement;if(!ax&&aq.options){ax=aq.options.pathElement}if(aA.isEqual(al[ap].pathElement)){aw.push(al[ap]);az=true}}if(!az){an.push({pathElement:aA,event:ak.event,parameters:ay})}}if(am){if(aw.length>0){ao.remove(aw)}for(ar=0;ar<aw.length;ar++){at.removed.push(aw[ar].pathElement)}}if(an.length>0){ao.add(an)}for(ar=0;ar<an.length;ar++){at.added.push(an[ar].pathElement)}return at}var ae=this;var ah=WUX.Selection.HSOManager;var af=WUX.Selection.CSOManager;var ai=aa(ak.trapSel);if(!ai){return{addedToCSO:[],removedFromCSO:[]}}var ad=!ak.multiSel;var ab=!ak.additiveMode;var ac=aj(ai.CSO,af,ad,ab);if(this.picking.displayHL){aj(ai.HSO,ah,ad,ab)}return{addedToCSO:ac.added,removedFromCSO:ac.removed}},getVersion:function(){return this.version},getWebGLContext:function(){return this.renderer.renderer.getContext()},getRenderer:function(){return this.renderer.renderer},getInfos:function(){return this.renderer.getInfos()},addViewpoint:function(Z){if(Z!==null){Z._setNode(this.internalSceneGraph.root);if(this._2DMode){Z._set2DMode(true)}this.viewpoints.push(Z)}if(this.viewpoints.length===1){this.selectViewpoint(0)}this.internalSceneGraph.onAddViewpoint()},removeViewpoint:function(Z){if(Z<0||Z>=this.viewpoints.length){return}if(this.viewpoints[Z]==this.currentViewpoint){if(this.internalSceneGraph!==null){this.internalSceneGraph.scene.remove(this.currentViewpoint.getCamera())}this.currentViewpoint=null}this.viewpoints.splice(Z,1);if(this.viewpoints.length>0){this.selectViewpoint(0)}},selectViewpoint:function(Z){if(Z<0||Z>=this.viewpoints.length){return}if((this.currentViewpoint!==null)&&(this.internalSceneGraph!==null)){this.internalSceneGraph.scene.remove(this.currentViewpoint.getCamera())}this.currentViewpoint=this.viewpoints[Z];this.internalSceneGraph.onSelectViewpoint();if(this.internalSceneGraph!==null){this.internalSceneGraph.scene.add(this.currentViewpoint.getCamera())}this.render({updateInfinitePlane:true})},getViewpoints:function(){return this.viewpoints},setTrackingViewpoint:function(Z){this.trackingViewpoint=Z},getTrackingViewpoint:function(){return this.trackingViewpoint},attachScene:function(aa){if(aa===null){return}if(aa.passcode!=="I solemnly swear that I am up to no good."){Q.DEPRECATED_SceneGraph(new Error())}aa.parentSceneGraph=this.internalSceneGraph;var Z=this._sceneGraph;this._sceneGraph=null;if(Z){this.removeNode(Z)}this.addNode(aa._private_root);this._sceneGraph=aa},addNode:function(Z,aa){if(Z instanceof l){throw new Error("addNode with SceneGraph")}else{this.internalSceneGraph&&this.internalSceneGraph.addUserNode(Z,this._sceneGraph!==null)}this.render({updateInfinitePlane:!!aa})},removeNode:function(Z,aa){if(this.internalSceneGraph){this.internalSceneGraph.removeUserNode(Z,this._sceneGraph!==null);this.render({updateInfinitePlane:!!aa})}},getNodes:function(){if(this.internalSceneGraph){return this.internalSceneGraph.getUserNodes(this._sceneGraph!==null)}return null},getRootNode:function(){if(this.internalSceneGraph){return this.internalSceneGraph.getUserRoot(this._sceneGraph!==null)}return null},setClippingPlanes:function(Z){this.renderer.resetGSSOCache();var ab=this.getRenderer();if(ab===null){return false}if(Z&&!ab.clipPlanes.length){return false}var aa=ab.clipPlanesEnabled;ab.clipPlanesEnabled=Z;if(aa!==Z){if(this.internalSceneGraph!==null){this.render()}}return true},getClippingPlanes:function(){var Z=this.getRenderer();if(Z===null){return null}return Z.clipPlanes},addClippingPlane:function(Z,aa){this.renderer.resetGSSOCache();this._addClippingPlane(Z);this.setSectionCappingMaterial(Z,aa);return true},setSectionCappingMaterial:function(Z,aa){this.renderer.resetGSSOCache();var ac=this.getRenderer();var ab;if(!Z.clippingContext){Z.clippingContext={}}if(!Z.clippingContext[ac.id]){Z.clippingContext[ac.id]={useCount:0}}ab=Z.clippingContext[ac.id];if(!aa&&aa!==0){ab.sectionCappingMaterial=new M.MeshPhongMaterial({color:new M.Color(0)});ab.sectionCappingMaterial.clipPlaneUseModelMaterial=true}else{if(aa instanceof M.Material){ab.sectionCappingMaterial=aa.clone()}else{ab.sectionCappingMaterial=new M.MeshBasicMaterial({color:new M.Color(aa)})}}this.renderer.resetClippingScene()},removeClippingPlane:function(Z){this.renderer.resetGSSOCache();this._removeClippingPlane(Z)},setClippingPlaneUpVector:function(Z,aa){Z.upVector=aa.clone();Z.upVector.normalize()},setSectionCapping:function(Z){this.renderer.resetGSSOCache();if(Z&&this.getRenderPriority()){console.warn("Section capping is not compatible with render priority mode");return false}this.renderer.sectionCappingEnabled=Z?true:false;this.render();return true},getSectionCapping:function(){return this.renderer.sectionCappingEnabled},_updateShadowMaps:function(){if(!(this.internalSceneGraph!==null&&typeof this.internalSceneGraph!==undefined)){return}var Z=this.internalSceneGraph.root3js;if(Z!==null&&typeof Z!==undefined){for(var aa=0;aa<Z.parent.__lights.length;aa++){Z.parent.__lights[aa].updateShadowMap=true}}},getVisibleSpace:function(){return this.visibleSpace},swapVisibleSpace:function(){this.renderer.resetGSSOCache();this.visibleSpace=(this.visibleSpace+1)%2;this.renderer.visibleSpace=this.visibleSpace;this.renderer.renderer.visibleSpace=this.visibleSpace;var ad=new M.Color(this.showBgColor);this.ambience.setBackgroundAlpha(this.showBgAlpha);if(!this.visibleSpace){ad.desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio)}this.ambience.setBackgroundColor(ad.getHex());this._setBackgroundColor();var ac,Z;if(this._svgMode&&this.svgRootNode){Z="#"+this.noShowColor.getHexString();this.svgRootNode.style.backgroundColor=this.visibleSpace?"#ffffff":Z;for(ac=0;ac<this.internalSceneGraph.svgRoot.children.length;ac++){this.internalSceneGraph.svgRoot.children[ac]._updateSVGVisibility()}}if(this.ambience.getBackground().hasGradient()){var aa=this.ambience.getBackground().getColors();var ab=[];for(ac=0;ac<aa.length;ac++){if(this.visibleSpace){ab.push(new M.Color(this.showGradientBackground[ac].getHex()))}else{ab.push(aa[ac].desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio))}}this.ambience.getBackground().setColors(ab)}if(this._displayGrid){if(this.visibleSpace){this.gridColor.copy(this.showGridColor)}else{this.gridColor.desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio)}}if(this._infinitePlane){if(this.visibleSpace){this.planeColor.copy(this.showPlaneColor)}else{this.planeColor.desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio)}}if(this.getRobot()&&this.getRobot().isTargetGone(this.visibleSpace)){this.getRobot().setConnectionState(false)}this._updateShadowMaps();this.render({updateInfinitePlane:this._infinitePlane});this._modelEvent.publish({event:"SwapVisibleSpace",data:{viewer:this,visibleSpace:this.visibleSpace}})},getMousePosition:function(aa){if(!(aa instanceof M.Vector2)){console.warn("DEPRECATED: WebGLViewer.getMousePosition() now only accepts THREEDS.Core.Vector2 2D position on the screen as argument.");if(aa.changedTouches){var ab=aa.changedTouches.length?aa.changedTouches[0]:aa;var ad=this.canvas.getBoundingClientRect();var ae=ab.pageX-ad.left;var ac=ab.pageY-ad.top;aa=new M.Vector2(ae,ac)}}var Z=window.devicePixelRatio||1;return{x:(aa.x/this.canvas.offsetWidth)*2-1,y:-(aa.y/this.canvas.offsetHeight)*2+1,xPix:aa.x*Z,yPix:aa.y*Z}},computeDistanceFromCamera:function(Z){var aa=this.renderer.computePositionGPU(this.internalSceneGraph,this.currentViewpoint,Z);return aa.distanceTo(this.currentViewpoint.camera.position)},invalidatePickingBuffer:function(){if(this.renderer.pickingGPUComposerContext){this.renderer.pickingGPUComposerContext.needsUpdate=true;this.renderer.meshesGPU={}}},setPickingPriority:function(Z){this.pickingPriorityMapping=Z},pick:function(ak,ac,Z,ah,ai,ag){var ap,aj,am,af,aq,ad={ray:null},an;var ao=ah?ah:this.pickingPriorityMapping;var al=false;if(this.infPlaneSmall&&ao){al=this.infPlaneSmall.visible;this.infPlaneSmall.visible=false}af={path:[],position:null,normal:null,tangent:null,uv:null,ray:null};this.renderer.overrideUpdate(this.internalSceneGraph,this.getCurrentSceneGraphState());switch(ac){case"mesh":ap=this.computeIntersection(ak,true,false,Z,ad,ao,ai,ag);for(an=0;an<ap.length;++an){if(ap[an].object&&ap[an].object.pickable){ap[an].path=new O();ap[an].path.setFromOccurrence(ap[an].object._occurrence)}else{ap[an].path=null}}break;case"meshCPU":ap=this.computeIntersection(ak,false,false,Z,ad,ao,ai,ag);for(an=0;an<ap.length;++an){if(ap[an].object&&ap[an].object.pickable){ap[an].path=new O();ap[an].path.setFromOccurrence(ap[an].object._occurrence)}else{ap[an].path=null}}break;case"primCPU":ap=this.computeIntersection(ak,false,true,Z,ad,ao,ai,ag);for(an=0;an<ap.length;++an){if(ap[an].primitive&&ap[an].object._occurrence){ap[an].path=new O();ap[an].path.setFromOccurrence(ap[an].object._occurrence,THREEDS.SubElement.getFromSGNode(ap[an].primitive))}else{ap[an].path=null}}break;case"primHybrid":ap=this.computeIntersection(ak,true,true,Z,ad,ao,ai,ag);for(an=0;an<ap.length;++an){var aa=ap[an].object?ap[an].object._occurrence:null;if(ap[an].primitive&&aa){var ae=(ap[an].primitive===true)?null:THREEDS.SubElement.getFromSGNode(ap[an].primitive);ap[an].path=new O();ap[an].path.setFromOccurrence(aa,ae)}else{if(ap[an].object&&ap[an].object._instancingInfos&&ap[an].object._instancingInfos.isInstanceNode3D){if(ap[an].object.pickable){ap[an].path=new O();ap[an].path.setFromOccurrence(aa)}}else{if(aa&&aa.node&&(aa.node.primitivePicking===false)){ap[an].path=new O();ap[an].path.setFromOccurrence(aa)}else{ap[an].path=null}}}}break;case"prim":ap=this.computeIntersection(ak,false,true,Z,ad,ao,ai,ag);for(an=0;an<ap.length;++an){if(ap[an].primitive&&ap[an].object._occurrence){var ae=(ap[an].primitive===true)?null:THREEDS.SubElement.getFromSGNode(ap[an].primitive);ap[an].path=new O();ap[an].path.setFromOccurrence(ap[an].object._occurrence,ae)}else{ap[an].path=null}}break;case"rep":ap=this.computeIntersection(ak,false,true,Z,ad,ao,ai,ag);for(an=0;an<ap.length;++an){if(ap[an].primitive&&ap[an].object._occurrence){var ae=(ap[an].primitive===true)?null:THREEDS.SubElement.getFromSGNode(ap[an].primitive.rep);ap[an].path=new O();ap[an].path.setFromOccurrence(ap[an].object._occurrence,ae)}else{ap[an].path=null}}break;case"repHybrid":ap=this.computeIntersection(ak,true,true,false,ad,ao,ai,ag);for(an=0;an<ap.length;++an){if(ap[an].primitive&&ap[an].object._occurrence){var ae=(ap[an].primitive===true)?null:THREEDS.SubElement.getFromSGNode(ap[an].primitive.rep);ap[an].path=new O();ap[an].path.setFromOccurrence(ap[an].object._occurrence,ae)}else{if(ap[an].object&&ap[an].object._instancingInfos&&ap[an].object._instancingInfos.isInstanceNode3D){if(ap[an].object.pickable){ap[an].path=new O();ap[an].path.setFromOccurrence(ap[an].object._occurrence)}}else{ap[an].path=null}}}break;default:break}if(ac!=="mesh"){ap=this._filterClippedIntersections(ap)}af.ray=ad.ray;if(ap.length){af.position=ap[0].point;af.normal=ap[0].normal;if(ap[0].path===null){if((this._displayGrid||this._infinitePlane)&&af.ray&&(af.ray.direction.z<0)){af.normal=new M.Vector3(0,0,1);var ab=new M.Plane(af.normal,this.offsetPlaneSmall.z);af.position=af.ray.intersectPlane(ab)}}else{af.tangent=ap[0].tangent;af.uv=ap[0].uv}}for(an=0;an<ap.length;++an){if(ap[an].path!==null){if(ap[an].instanceId!==undefined){ap[an].path.instanceId=ap[an].instanceId}af.path.push(ap[an].path)}}if(this.infPlaneSmall&&ao){this.infPlaneSmall.visible=al}return af},pickInVolume:function(ag,af,ap){if(!ag||!af){return{inside:[],partial:[],outside:[]}}var az=this.internalSceneGraph.scene;var ae=[];if(ap){ae=ae.concat(ap._getRenderableOccurrences(this,false))}else{if(az instanceof M.Mesh){ae=[az]}else{var aq=this._getUserPassManager()._getActiveRenderLists();var aj=[];for(var av=0;av<aq.length;av++){aj=aj.concat(az.getWebGLObjects(aq[av],0))}for(var av=0;av<aj.length;av++){if(aj[av]!==null){ae.push(aj[av].object)}}}}var ay=(this.renderer.renderer.pickFacesMode===1)||((this.renderer.renderer.pickFacesMode===2)&&this.renderer.renderer.renderFaces)||((this.renderer.renderer.pickFacesMode===3)&&!this.renderer.renderer.renderFaces);var ax=(this.renderer.renderer.pickLinesMode===1)||((this.renderer.renderer.pickLinesMode===2)&&this.renderer.renderer.renderLineMode)||((this.renderer.renderer.pickLinesMode===3)&&!this.renderer.renderer.renderLineMode);var am=(this.renderer.renderer.pickPointsMode===1)||this.renderer.renderer.renderPoints;var au=new M.Sphere();if(ag instanceof M.Box3){var ah=ag;var at=ah.getPoints(af);var ao=[[0,2,1],[4,0,5],[6,4,7],[2,6,3],[5,1,7],[4,6,0]];var an=[];var al=new M.Vector3();var ak=new M.Vector3();for(var av=0;av<ao.length;av++){var ad=ao[av];al.copy(at[ad[1]]).sub(at[ad[0]]);ak.copy(at[ad[2]]).sub(at[ad[0]]);al.cross(ak).normalize();an.push(new M.Plane().setFromNormalAndCoplanarPoint(al,at[ad[0]]))}au=new M.Frustum(an[0],an[1],an[2],an[3],an[4],an[5])}else{if(ag instanceof M.Sphere){au=ag.clone();au.applyMatrix4(af)}else{return{inside:[],partial:[],outside:[]}}}var ai=[{path:[]},{path:[]},{path:[]}];var aw=[];var aA=[];var aa=[];var ab=[aw,aA,aa];for(var av=0;av<ae.length;av++){var ac=true;var Z=ae[av];if(Z.visibilityFree){ac=Z.visible}else{ac=this.visibleSpace?Z.visible:!Z.visible}if(!ac){continue}if((Z.pickable!==undefined)&&!Z.pickable){continue}Z._intersectVolume(au,ay,am,ax,aw,aA,aa)}for(var ar=0;ar<ab.length;ar++){var aB=ab[ar];for(var av=0;av<aB.length;++av){if(aB[av].object&&aB[av].object.pickable){aB[av].path=new O();aB[av].path.setFromOccurrence(aB[av].object._occurrence)}else{aB[av].path=null}}}for(var ar=0;ar<ab.length;ar++){var aB=ab[ar];for(var av=0;av<aB.length;++av){if(aB[av].path!==null){if(aB[av].instanceId!==undefined){aB[av].path.instanceId=aB[av].instanceId}ai[ar].path.push(aB[av].path)}}}return{inside:ai[0],outside:ai[1],partial:ai[2]}},computeIntersection:function(bj,bd,bb,aT,bo,a0,aA,ae){var a8=this.trapSelection||aA;var a4,a5,ab,au,bn,ba,al,a1,aZ,ao,ag,ar,bp,aL,ax,aw,an,bg,br,ay=[];a5=new M.Projector();ao=bd!==undefined?bd:false;al=bb!==undefined?bb:false;aL=aT!==undefined?aT:false;if(this.debugPickHybrid){aL=true}bg=(((this.picking.trapSelection&&a8)||false)&&(bj.pt!==undefined)&&(bj.pt.xPix!==bj.xPix||bj.pt.yPix!==bj.yPix));if((this.currentViewpoint===null)||(this.internalSceneGraph===null)){return ay}var am=window.devicePixelRatio||1;a4=new M.Vector2(bj.xPix/am,bj.yPix/am);ab=this.currentViewpoint.create3DRayFrom2DPoint(a4);if((bo!==undefined)&&(bo.ray!==undefined)){bo.ray=ab}if(!bg&&bj.event){var at=bj.event.getView();var bf=at.renderable;if(!bf){while(at!==this.canvas&&(at.parentElement||at.parentNode)&&!bf){at=at.parentElement||at.parentNode;bf=at.renderable}}if(bf&&bf.drawInHLRender){var a7,aJ;if(bf instanceof M.CSS3DNode){var aO=new M.Matrix4().multiplyMatrices(bf.matrixWorld,bf.scaleCSS);var av=bj.event.getCurrentPosition(at);a7=new M.Vector3(av.x,av.y,0);a7.applyMatrix4(aO);var bh=aO.elements;aJ=new M.Vector3(bh[8],bh[9],bh[10])}else{var aB=bf.position.clone();var a2=this.currentViewpoint.camera.getLookAt();var aY=new M.Plane().setFromNormalAndCoplanarPoint(this.currentViewpoint.camera.getLookAt(),aB);var bs=bf.element.getBoundingClientRect();var Z=this.getMousePosition(new M.Vector2(bj.xPix,bj.yPix));Z=new M.Vector3(Z.x,Z.y,1);a5.unprojectVector(Z,this.currentViewpoint.camera);var aq=new M.Ray(this.currentViewpoint.camera.position,Z.clone().sub(this.currentViewpoint.camera.position).normalize());a7=aq.intersectPlane(aY);aJ=aY.normal}ay[0]={object:bf,primitive:!!(bf&&bf.primitive),point:a7,normal:aJ};return ay}}if(bg){if(bj.x===bj.pt.x||bj.y===bj.pt.y){return ay}aw=new M.Vector3(bj.pt.x,bj.pt.y,1);var aU,ac,a3,aj,aD,az;var bi=this.currentViewpoint.camera;var ad=bi.position;var bk=bi.getLookAt();aD=new M.Plane().setFromNormalAndCoplanarPoint(bk,ad.clone().add(bk.clone().multiplyScalar(bi.near)));az=new M.Plane().setFromNormalAndCoplanarPoint(bk.clone().multiplyScalar(-1),ad.clone().add(bk.clone().multiplyScalar(bi.far)));if(this.currentViewpoint.getProjectionType()===j.PERSPECTIVE){var aR=new M.Vector3(bj.x,bj.y,1);a5.unprojectVector(aR,bi);aR.sub(ad).normalize();var aQ=new M.Vector3(bj.pt.x,bj.y,1);a5.unprojectVector(aQ,bi);aQ.sub(ad).normalize();var aN=new M.Vector3(bj.pt.x,bj.pt.y,1);a5.unprojectVector(aN,bi);aN.sub(ad).normalize();var aK=new M.Vector3(bj.x,bj.pt.y,1);a5.unprojectVector(aK,bi);aK.sub(ad).normalize();var aI=new M.Vector3();aI.copy(aR);a3=new M.Plane().setFromNormalAndCoplanarPoint(aR.cross(aQ).normalize(),ad);ac=new M.Plane().setFromNormalAndCoplanarPoint(aQ.cross(aN).normalize(),ad);aj=new M.Plane().setFromNormalAndCoplanarPoint(aN.cross(aK).normalize(),ad);aU=new M.Plane().setFromNormalAndCoplanarPoint(aK.cross(aI).normalize(),ad)}else{var aE=bi.up.clone();var aS=new M.Vector3(1,0,0).applyQuaternion(bi.quaternion);var ah=new M.Vector3(bj.x,bj.y,1);a5.unprojectVector(ah,bi);var be=new M.Vector3(bj.pt.x,bj.pt.y,1);a5.unprojectVector(be,bi);a3=new M.Plane().setFromNormalAndCoplanarPoint(aE.clone().negate(),ah);ac=new M.Plane().setFromNormalAndCoplanarPoint(aS.clone().negate(),be);aj=new M.Plane().setFromNormalAndCoplanarPoint(aE,be);aU=new M.Plane().setFromNormalAndCoplanarPoint(aS,ah)}ax=new M.Frustum(aU,ac,a3,aj,aD,az)}var a9=(this.renderer.renderer.pickFacesMode===1)||((this.renderer.renderer.pickFacesMode===2)&&this.renderer.renderer.renderFaceMode)||((this.renderer.renderer.pickFacesMode===3)&&!this.renderer.renderer.renderFaceMode);var aH=(this.renderer.renderer.pickLinesMode===1)||((this.renderer.renderer.pickLinesMode===2)&&this.renderer.renderer.renderLineMode)||((this.renderer.renderer.pickLinesMode===3)&&!this.renderer.renderer.renderLineMode);var bl=(this.renderer.renderer.pickPointsMode===1)||this.renderer.renderer.renderPoints;var af=this.renderer.renderer.getPickingRenderPointMode();var bc;if(ao){this.currentViewpoint._updateRobotCamera(this.internalSceneGraph);if(this.renderer.smallTargetPicking){ay=this.renderer.computeIntersectionGPUSmallTarget(this.internalSceneGraph,this.currentViewpoint,bj,aL,bg,a9,(aH===true)?M.ShowAllRenderLineMode:aH,bl,af,a0,ao&&al);if(this.currentViewpoint.camera.fullWidth){this.lockRenderIteration();this.internalSceneGraph.onViewpointChange();this.unlockRenderIteration()}}else{ay=this.renderer.computeIntersectionGPU(this.internalSceneGraph,this.currentViewpoint,bj,aL,bg,a9,(aH===true)?M.ShowAllRenderLineMode:aH,bl,af,a0,ao&&al)}if(ay.length&&al&&!(ay[0].object&&ay[0].object._instancingInfos&&ay[0].object._instancingInfos.isInstanceNode3D)){var aW=[];for(var aG=0;aG<ay.length;++aG){if(ay[aG].object instanceof M.Mesh&&ay[aG].object.pickable&&(!ay[aG].object._occurrence||!ay[aG].object._occurrence.node||ay[aG].object._occurrence.node.primitivePicking!==false)){bc=this._getUserPassManager()._getActiveRenderLists();if(bg){aW=aW.concat(ab.intersectMeshInstancesZones3D(ay[aG].object,this.currentViewpoint.camera,new M.Vector3(bj.x,bj.y,1),aw,ax,bb,a9,aH,bl,this.renderer.deviceWidth,this.renderer.deviceHeight,bc,true,this.visibleSpace))}else{aW=aW.concat(ab.intersectMeshInstances(ay[aG],this.currentViewpoint.camera,new M.Vector3(bj.x,bj.y,1),a9,aH,bl,this.renderer.deviceWidth,this.renderer.deviceHeight,this.picking.tolerance,this.debugPickHybrid,bc,this.visibleSpace))}}}if(aW.length){ay=aW}}}else{bc=this._getUserPassManager()._getActiveRenderLists();if(bg){ay=ay.concat(ab.intersectMeshInstancesZones3D(this.internalSceneGraph.scene,this.currentViewpoint.camera,new M.Vector3(bj.x,bj.y,1),aw,ax,bb,(a9===true)?S.facesMask:a9,(aH===true)?S.linesMask:aH,(bl===true)?S.pointsMask:bl,this.renderer.deviceWidth,this.renderer.deviceHeight,bc,!a8.forwardSelect,this.visibleSpace))}else{ay=ab.intersectMeshInstances({object:this.internalSceneGraph.scene},this.currentViewpoint.camera,new M.Vector3(bj.x,bj.y,1),a9,aH,bl,this.renderer.deviceWidth,this.renderer.deviceHeight,this.picking.tolerance,undefined,bc,this.visibleSpace)}if(a0){var bm=[];for(var aF=0;aF<a0.length;aF++){bm[a0[aF].id]=a0[aF].priority}var aM=function(bu,bt){var bx=0;var bv=0;if(bu.object.pickingPriorityID){var by=bu.object.pickingPriorityID.points;if(!bu.primitive||(bu.primitive.group.glType>=4)){by=bu.object.pickingPriorityID.faces}else{if(bu.primitive.group.glType>=1){by=bu.object.pickingPriorityID.edges}}if(by&&bm[by]){bx=bm[by]}}if(bt.object.pickingPriorityID){var bw=bt.object.pickingPriorityID.points;if(!bt.primitive||(bt.primitive.group.glType>=4)){bw=bt.object.pickingPriorityID.faces}else{if(bt.primitive.group.glType>=1){bw=bt.object.pickingPriorityID.edges}}if(bw&&bm[bw]){bv=bm[bw]}}if(bx>bv){return -1}else{if(bx<bv){return 1}}return bu.distance-bt.distance};ay.sort(aM)}}if(this.debugPicking&&(ay.length>0)){bn=new M.MeshPhongMaterial({color:16729156,opacity:1,transparent:false,force:true});ba=new M.MeshPhongMaterial({color:4474111,opacity:1,transparent:false,force:true});var aC=P.createSphereNode({radius:1,sag:32,material:bn});a1=aC._occurrences[0].renderable;a1.frustumCulled=false;a1.pickable=false;a1.drawInHLRender=false;a1.setMatrix(new M.Matrix4().setPosition(ay[0].point));console.log(" x "+ay[0].point.x+" y "+ay[0].point.y+" z "+ay[0].point.z);aZ=new M.Mesh(a1.geometry,ba);aZ.frustumCulled=false;aZ.pickable=false;aZ.drawInHLRender=false;aZ.setMatrix(new M.Matrix4().setPosition(this.currentViewpoint.camera.position));this.debugPickingNode.add(aZ);var a6=ay[0].primitive;if(a6&&a6.boundingSphere){var aP=new M.MeshPhongMaterial({color:4521796,opacity:1,transparent:false,force:true});var ak=new M.Mesh(a1.geometry,aP);ak.frustumCulled=false;ak.pickable=false;ak.drawInHLRender=false;var ai=new M.Sphere(new M.Vector3(a6.boundingSphere.center[0],a6.boundingSphere.center[1],a6.boundingSphere.center[2]),a6.boundingSphere.radius);ai.applyMatrix4(ay[0].object.matrix);var bq=new M.Matrix4().setPosition(ai.center);bq.scale(new M.Vector3(ai.radius,ai.radius,ai.radius));ak.setMatrix(bq);this.debugPickingNode.add(ak)}var aV=new M.MeshBasicMaterial({color:16729156,opacity:1,force:true});var aX=P.createLineNode({points:[new M.Vector3(ab.origin.x-10000*ab.direction.x,ab.origin.y-10000*ab.direction.y,ab.origin.z-10000*ab.direction.z),ab.origin,new M.Vector3(ab.origin.x+10000*ab.direction.x,ab.origin.y+10000*ab.direction.y,ab.origin.z+10000*ab.direction.z)],material:aV});ar=aX._occurrences[0].renderable;ar.frustumCulled=false;ar.drawInHLRender=false;this.debugPickingNode.add(ar)}for(var aG=0;aG<ay.length;aG++){var ap=ay[aG];if(ap.object&&ap.primitive){var aa=ap.object.getSelectionGroup(ap.primitive);if(aa){ap.primitive=aa}}}return ay},_updateSVGVisu:function(){if(this._svgMode&&this.svgRoot&&this._2DMode){var af=this.currentViewpoint.camera;var ae=this.SCREEN_HEIGHT/af.visualizedHeight;var ag=ae;var al=0;var ak=0;var aj=(1-ag)*al;var ah=(1-ag)*ak;var an="matrix("+ag+" 0 0 "+ag+" "+aj+" "+ah+") ";var Z=0.5*this.SCREEN_WIDTH-af.position.x*ae;var am=0.5*this.SCREEN_HEIGHT+af.position.y*ae;var ad=Z+al*ae;var ab=am-ak*ae;var ac=ad-al;var aa=ab-ak;var ai="translate ("+ac+" "+aa+") ";this.svgRoot.setAttribute("transform",ai+an)}},_updateOffsetPlane:function(ac,aa,ab,ae){if(ab){if(this.ambience.isAutoGroundOffset()){if(this._forceSceneMinValue!==null){af=this._forceSceneMinValue}else{var af=(this.internalSceneGraph===null)?0:this.internalSceneGraph.getSceneMin(ae)}if(af!==null){this.ambience.updateScene(new M.Vector3(ac.center.x,ac.center.y,af))}}}this.offsetPlaneBackground.copy(this.ambience.getGroundPosition());if(this.ambience.isAutoGroundOffset()){if(!this.ambience.isFiniteMode()){var Z=aa.getLookAt();if(this.planeV2){this.offsetPlaneBackground.x=ac.center.x;this.offsetPlaneBackground.y=ac.center.y}else{var ad=(Math.abs(Z.z)>0.0001)?1/Z.z:0;this.offsetPlaneBackground.x=0.5*(ac.center.x+aa.position.x-(aa.position.z-this.offsetPlaneBackground.z)*Z.x*ad);this.offsetPlaneBackground.y=0.5*(ac.center.y+aa.position.y-(aa.position.z-this.offsetPlaneBackground.z)*Z.y*ad)}}}this.offsetPlaneBackground.z+=this.ambience.getOffset();this.offsetPlaneSmall.z=this.offsetPlaneBackground.z;return},_getPlaneSize:function(ad,ac,ab,aa){var Z=0;if(this.ambience.isAutoGroundOffset()){if(this.planeV2){Z=20*ad.radius}else{Z=Math.max(20*(this.offsetPlaneBackground.distanceTo(ad.center)+ad.radius),5*this.offsetPlaneBackground.distanceTo(ac.position))}}else{if(this.planeV2&&this.planeGrid){Z=this.planeGrid.size}else{Z=this.gridUnit/this.gridStep}}return Z},_castRayFunc:function(ai,Z,ag,ak){var av=ak?ak:{};var ab=ag==="mesh";var ac=av.intersectFaces===null||av.intersectFaces===undefined?true:av.intersectFaces;var af=av.intersectEdges;var aw=av.intersectPoints;var aq=av.edgeTolerance?av.edgeTolerance:0.1;var ax=av.pointTolerance?av.pointTolerance:0.1;var aj=Z;var at=0;var ar=0;var ah=0;var ay=null;var aa=[];for(at=0,ah=aj.length;at<ah;at++){if(aj[at]===null){continue}ay=aj[at].object?aj[at].object:aj[at];var ae=ay.worldCenter;var an=ay.worldRadius;var ad=ai.distanceToPoint(ae);if(ad<=an){var au,ap,am;if(ac){if((ay.geometry._type===2)||(ay.geometry.length>=0)){au=ai._castRayIntoBufferGeom(ay,ab)}else{var ao=new M.Raycaster(this.origin,this.direction,0,Infinity);au=ao.intersectObject(ay,false)}for(ar=0;ar<au.length;ar++){var al=new O();if(au[ar].primitive){al.setFromOccurrence(au[ar].object._occurrence,THREEDS.SubElement.getFromSGNode(au[ar].primitive))}else{al.setFromOccurrence(au[ar].object._occurrence);au[ar].distance=ai.direction.dot(new M.Vector3().subVectors(ae,ai.origin))}au[ar].pathElement=al}aa=aa.concat(au)}if(af&&(!ab||(ab&&!au))){ap=ai._castRayIntoBufferGeomEdge(ay,aq,ab);for(ar=0;ar<ap.length;ar++){var al=new O();if(ap[ar].primitive){al.setFromOccurrence(ap[ar].object._occurrence,THREEDS.SubElement.getFromSGNode(ap[ar].primitive))}else{al.setFromOccurrence(ap[ar].object._occurrence);ap[ar].distance=ai.direction.dot(new M.Vector3().subVectors(ae,ai.origin))}ap[ar].pathElement=al}aa=aa.concat(ap)}if(aw&&(!ab||(ab&&!ap))){am=ai._castRayIntoBufferGeomPoint(ay,ax,ab);for(ar=0;ar<am.length;ar++){var al=new O();if(am[ar].primitive){al.setFromOccurrence(am[ar].object._occurrence,THREEDS.SubElement.getFromSGNode(am[ar].primitive))}else{al.setFromOccurrence(am[ar].object._occurrence);am[ar].distance=ai.direction.dot(new M.Vector3().subVectors(ae,ai.origin))}am[ar].pathElement=al}aa=aa.concat(am)}}}aa.sort(function(aA,az){return aA.distance-az.distance});return aa},castRay:function(ac,ae,ah,af){var aa=0;var ab=0;var ag=["main","noz","afterHighlightNoZ"];var Z=[];if(!ae){var ad=this.internalSceneGraph.scene;for(ab=0;ab<ag.length;ab++){Z=Z.concat(ad.getWebGLObjects(ag[ab],0))}}else{for(aa=0;aa<ae._occurrences.length;aa++){Z=Z.concat(ae._occurrences[aa]._getRenderableOccurrences())}}return this._castRayFunc(ac,Z,ah,af)},castRayOnOccurrence:function(ac,ag,ah,ae){var ab=0;var af=["main","noz","afterHighlightNoZ"];var Z=[];if(!ag){var ad=this.internalSceneGraph.scene;for(ab=0;ab<af.length;ab++){Z=Z.concat(ad.getWebGLObjects(af[ab],0))}}else{Z=ag._getRenderableOccurrences(this,false);var aa=ag._getUniqueOccurrence(this);if(aa===null){console.log("castRayIntoOccurrences ERROR: the path element is either invalid or doesn't define a unique occurrence.")}else{aa.node._tryOverridesUpdate(this)}}return this._castRayFunc(ac,Z,ah,ae)},displayFaces:function(Z){this.renderer.resetGSSOCache();this._DEPRECATED_setRenderFooMode(new Error());this._setInternalRenderFaceMode(Z?M.ShowAllFaces:M.HideAllModelFaces)},displayLines:function(Z){this.renderer.resetGSSOCache();this._DEPRECATED_setRenderFooMode(new Error());this._setInternalRenderLineMode(Z?M.ShowAllRenderLineMode:M.HideAllRenderLineMode)},displayHiddenEdges:function(Z){this.renderer.resetGSSOCache();this.renderer.renderer.renderHiddenEdges=Z},setRenderLineMode:function(Z){this.renderer.resetGSSOCache();this._DEPRECATED_setRenderFooMode(new Error());this._setInternalRenderLineMode(Z)},addRenderModeLock:function(aa,Z){this.lockedRenderMode.set(aa,Z)},removeRenderModeLock:function(Z){if(this.lockedRenderMode.has(Z)){this.lockedRenderMode["delete"](Z)}},clearRenderModeLock:function(){this.lockedRenderMode.clear()},applyRenderModeLock:function(){var Z=this;this.lockedRenderMode.forEach(function(aa,ab,ac){Z._setRenderMode(ab,aa)})},getAxisFilter:function(){return this.axisFilterStatus},setAxisFilter:function(Z){this.axisFilterStatus=Z;var ab=this.getBagNode?this.getBagNode():this.getRootNode?this.getRootNode():null;if(ab){var aa=ab.getChildrenByName("AxisSystems");if(aa&&aa.length>0){aa.forEach(function(ad){ad.setVisibility(Z);ad.setVisibilityFree(!Z)})}var ac=ab.getChildrenByName("RefPlanes");if(ac&&ac.length>0){ac.forEach(function(ad){ad.setVisibility(Z);ad.setVisibilityFree(!Z)})}}this.addRenderModeLock("InfiniteFace",Z);this.addRenderModeLock("AxisSystem",Z);this.applyRenderModeLock();this.render();this._modelEvent.publish({event:"AxisFilterMode",data:{viewer:this,state:this.axisFilterStatus}});this._modelEvent.publish({event:"RefPlaneFilterMode",data:{viewer:this,state:this.axisFilterStatus}})},onAxisFilterChange:function(Z){return this._modelEvent.subscribe({event:"AxisFilterMode",},Z)},getLinesFilter:function(){return this.linesFilterStatus},setLinesFilter:function(Z){this.linesFilterStatus=Z;this.addRenderModeLock("WireEdge",Z);this.applyRenderModeLock();this.render();this._modelEvent.publish({event:"LinesFilterMode",data:{viewer:this,state:this.linesFilterStatus}})},onLinesFilterChange:function(Z){return this._modelEvent.subscribe({event:"LinesFilterMode",},Z)},getPointsFilter:function(){return this.pointsFilterStatus},setPointsFilter:function(Z){this.pointsFilterStatus=Z;this.addRenderModeLock("@Point",Z);this.addRenderModeLock("SurfacicPoint",false);this.applyRenderModeLock();this.render();this._modelEvent.publish({event:"PointsFilterMode",data:{viewer:this,state:this.pointsFilterStatus}})},onPointsFilterChange:function(Z){return this._modelEvent.subscribe({event:"PointsFilterMode",},Z)},_setRenderMode:function(aa,Z){this.renderer.resetGSSOCache();var ab=new S();ab._setFromMasks(this.renderer.renderer.renderPointMode,this._getInternalRenderLineMode(),this._getInternalRenderFaceMode());ab.setRenderMode(aa,Z);this.renderer.renderer.renderPointMode=ab._mask&S.pointsMask;this._setInternalRenderFaceMode(ab._mask&S.facesMask);this._setInternalRenderLineMode(ab._mask&S.linesMask)},setRenderMode:function(aa,Z){this._setRenderMode(aa,Z);this.applyRenderModeLock()},setRenderStyle:function(Z){this._renderStyle=Z.clone();var aa=Z._renderMode;this.renderer.renderer.renderPointMode=aa._mask&S.pointsMask;this.renderer.renderer.outlineWidth=aa._outlineWidth;this._setInternalRenderFaceMode(aa._mask&S.facesMask);this._setInternalRenderLineMode(aa._mask&S.linesMask);this.applyRenderModeLock();this.internalSceneGraph.root.forceUpdate()},setRenderFaceMode:function(Z){this.renderer.resetGSSOCache();this._DEPRECATED_setRenderFooMode(new Error());this._setInternalRenderFaceMode(Z)},displayPoints:function(Z){this.renderer.resetGSSOCache();this.renderer.renderer.renderPoints=Z},displaySurfacicPoints:function(Z){this.renderer.resetGSSOCache();this.setRenderMode("SurfacicPoint",Z)},_setGradientBackgroundShader:function(){var af;if(this.sphereEnv!==null){var aa=this.ambience.getBackground().getColors();switch(aa){case 2:af=M.GradientBackgroundShader2;break;case 3:af=M.GradientBackgroundShader3;break;case 4:af=M.GradientBackgroundShader4;break;default:this.removeEnvMap();return}var ae={fragmentShader:af.fragmentShader,vertexShader:af.vertexShader,uniforms:af.uniforms},ad=new M.ShaderMaterial(ae);ad.force=true;ad.side=M.DoubleSide;ad.forceSide=true;ad.depthTest=false;ad.uniforms.colors.value=[];var Z=ad.uniforms.colors.value;for(var ac=0;ac<aa.length;ac++){var ab=aa[ac];Z.push(ab.r);Z.push(ab.g);Z.push(ab.b)}this.sphereEnv.material=ad}},setGradientBackground:function(Z){this.renderer.resetGSSOCache();this.showGradientBackground=[];if(!Z||((Z.length<2)||(Z.length>4))){this.removeEnvMap();return}var ab=[];for(var ac=0;ac<Z.length;ac++){var aa=new M.Color(Z[ac]);if(!this.visibleSpace){aa.desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio)}this.showGradientBackground.push(new M.Color(Z[ac]));ab.push(aa)}this.ambience.getBackground().setColors(ab)},_setBackgroundColor:function(){if(this._svgMode&&this._2DMode&&!d.getWebGLMode()){this.renderer.setBackgroundColor(0,0)}else{this.renderer.setBackgroundColor(this.ambience.getBackgroundColor().getHex(),this.ambience.getBackgroundAlpha())}this._modelEvent.publish({event:"VisuBackgroundColor",data:this.ambience.getBackgroundColor().getHex()})},setBackgroundColor:function(aa,ab){this.__tempBackgroundColorODT=aa;this.renderer.resetGSSOCache();this.ambience.setBackgroundAlpha((ab!==undefined)?ab:1);this.showBgColor=new M.Color(aa).getHex();this.showBgAlpha=this.ambience.getBackgroundAlpha();if(!this.visibleSpace){var Z=new M.Color(aa);Z.desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio);this.ambience.setBackgroundColor(Z.getHex())}else{this.ambience.setBackgroundColor(aa)}this._setBackgroundColor();this.render()},setPlaneColor:function(Z){this.renderer.resetGSSOCache();this.planeColor.set(Z);this.showPlaneColor.set(Z);if(!this.visibleSpace){this.planeColor.desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio)}this.render()},setGridColor:function(Z){this.renderer.resetGSSOCache();this.gridColor.set(Z);this.showGridColor.set(Z);if(!this.visibleSpace){this.gridColor.desaturate(this.saturationRatio).alphaBlend(this.noShowColor,this.blendingRatio)}this.render()},setSecondaryLightColor:function(aa){this.renderer.resetGSSOCache();var Z;if(typeof(aa)==="number"||typeof(aa)==="string"){Z=new M.Color(aa)}else{if(aa){Z=aa}}if(this.directionalLight2!==null){this.directionalLight2.color.copyGammaToLinear(Z)}this.render()},setShadow:function(aa,ad,af){var Z=this.directionalLight;if(Z!==null){Z.LiSPSM=ad;if(Z.shadowCascade){for(var ac=0;ac<Z.shadowCascadeArray.length;ac++){Z.shadowCascadeArray[ac].LiSPSM=ad}}}var ae=af?[af]:["static","dynamic"];for(var ac=0;ac<ae.length;ac++){var ab=ae[ac];if(!this._qmSetShadow||this._qmSetShadow(aa,ab)){this._effectSettings.InterObjectShadows[ab]=aa}}},_setShadow:function(Z){if(this.mobile){return}if(this.useShadowMap!==this._effectSettings.InterObjectShadows[Z]){this.renderer.resetGSSOCache();this.useShadowMap=this._effectSettings.InterObjectShadows[Z];this.renderer&&this.renderer.recompileAllShaders()}},setOIT:function(Z,ad){var ac=ad?[ad]:["static","dynamic"];for(var ab=0;ab<ac.length;ab++){var aa=ac[ab];if(!this._qmSetOIT||this._qmSetOIT(Z,aa)){this._effectSettings.Transparency[aa]=Z?"WeightedAverage":"AlphaBlending"}}},_setOIT:function(aa){var Z=(this._effectSettings.Transparency[aa]==="WeightedAverage");if(Z&&this.getRenderPriority()){console.warn("Warning: OIT is not compatible with render priority");return}if(this.useOIT!==Z&&!this.mobile&&this.renderer&&!this._svgMode){this.renderer.resetGSSOCache();this.renderer.setEffect("OIT",Z);this.useOIT=this.renderer.useOIT;this.renderer.recompileAllShaders()}},enableZPrePass:function(Z,ad){var ac=ad?[ad]:["static","dynamic"];for(var ab=0;ab<ac.length;ab++){var aa=ac[ab];if(!this._qmEnableZPrePass||this._qmEnableZPrePass(Z,aa)){this._effectSettings.ZPrePass[aa]=Z}}this.render()},_enableZPrePass:function(aa){var Z=(this._effectSettings.ZPrePass[aa]);this.renderer._enableZPrePass(Z)},setShadowFilter:function(ab,ad){var ac=ad?[ad]:["static","dynamic"];for(var aa=0;aa<ac.length;aa++){var Z=ac[aa];this._qmSetShadowFilter&&this._qmSetShadowFilter(ab,Z);this._effectSettings.ShadowFilter[Z]=ab}},_setShadowFilter:function(Z){if(this._effectSettings.ShadowFilter[Z]===this.shadowFilter){return}this.shadowFilter=this._effectSettings.ShadowFilter[Z];switch(this.shadowFilter){case"PCF":this.renderer.renderer.shadowMapType=M.PCFShadowMap;break;case"PCFInterpol":this.renderer.renderer.shadowMapType=M.PCFInterpolShadowMap;break;case"PCFPoisson":this.renderer.renderer.shadowMapType=M.PCFPoissonShadowMap;break;case"PCFOptimized":this.renderer.renderer.shadowMapType=M.PCFOptimizedShadowMap;break;case"ESM":this.renderer.renderer.shadowMapType=M.ESMShadowMap;if(!this.renderer.renderer.esmEffect){this.renderer.renderer.esmEffect=new v(this.renderer.renderer,this.renderer.renderTargetPool)}break;default:this.renderer.renderer.shadowMapType=M.BasicShadowMap;break}this.internalSceneGraph.scene.recompileShaders();this._updateShadowMaps()},setShadowQuality:function(Z,ad){var ac=ad?[ad]:["static","dynamic"];for(var ab=0;ab<ac.length;ab++){var aa=ac[ab];this._qmSetShadowQuality&&this._qmSetShadowQuality(Z,aa);this._effectSettings.ShadowQuality[aa]=Z}},_setShadowQuality:function(Z){if(this._effectSettings.ShadowQuality[Z]===this.shadowQuality){return}this.shadowQuality=this._effectSettings.ShadowQuality[Z];if(this.shadowQuality==="Medium"){this.renderer.renderer.shadowMapQuality=M.MediumQuality}else{if(this.shadowQuality==="High"){this.renderer.renderer.shadowMapQuality=M.HighQuality}else{this.renderer.renderer.shadowMapQuality=M.LowQuality}}this.internalSceneGraph.scene.recompileShaders();this._updateShadowMaps()},getShadowFilter:function(){return this.shadowFilter},getShadowQuality:function(){return this.shadowQuality},setShadowCascade:function(ac,ae,Z){this.renderer.resetGSSOCache();var ab=this.directionalLight;var ag=ae?ae:1024;var af=false;if(ab!==null){if(this.getRenderer()){this.getRenderer().shadowMapCascade=ac}if((this.shadowMapWidth!==ag)||(this.shadowMapHeight!==ag)){af=true;this.shadowMapWidth=ag;this.shadowMapHeight=ag;if(!ac){ab.shadowMap=null;ab.shadowMapWidth=ag;ab.shadowMapHeight=ag}}ab.shadowCascade=ac;ab.shadowCascadeCount=Z?Z:3;ab.shadowCascadeWidth=[];ab.shadowCascadeHeight=[];ab.shadowCascadeBias=[];ab.shadowCascadeNearZ=[];ab.shadowCascadeFarZ=[];for(var ad=0;ad<ab.shadowCascadeCount;ad++){ab.shadowCascadeWidth[ad]=ag;ab.shadowCascadeHeight[ad]=ag;ab.shadowCascadeBias[ad]=-0.005}ab.shadowCascadeOffset.set(0,0,-10);if(af&&ab.shadowCascadeArray){for(var ad=0;ad<ab.shadowCascadeArray.length;ad++){var aa=ab.shadowCascadeArray[ad];aa.shadowMap=null;aa.shadowMapWidth=ag;aa.shadowMapHeight=ag;aa.shadowBias=-0.005}}this.renderer&&this.renderer.recompileAllShaders()}},setGroundShadow:function(Z,ad){var ac=ad?[ad]:["static","dynamic"];for(var ab=0;ab<ac.length;ab++){var aa=ac[ab];if(!this._qmSetGroundShadow||this._qmSetGroundShadow(Z,aa)){this._effectSettings.GroundShadows[aa]=Z}}},_setGroundShadow:function(Z){if(this.mobile){return}if(this.useGroundShadow===this._effectSettings.GroundShadows[Z]){return}this.useGroundShadow=this._effectSettings.GroundShadows[Z];this.renderer.resetGSSOCache();if(this.dirLightGroundShadow.groundMaterial){if(!this.useGroundShadow){delete this.dirLightGroundShadow.groundMaterial.defines.GROUND_SHADOW}else{this.dirLightGroundShadow.groundMaterial.defines.GROUND_SHADOW=true}this.dirLightGroundShadow.groundMaterial.needsUpdate=true}},setGroundShadowAutomaticUpdate:function(Z){this.dirLightGroundShadow.blockUpdate=!Z;if(Z){this.dirLightGroundShadow.updateShadowMap=true}},__setGroundShadow:function(){if(!this.blurShadowEffect){this.blurShadowEffect=new V(this.renderer.renderer,this.renderer.renderTargetPool);this.dirLightGroundShadow.blurShadowEffect=this.blurShadowEffect}var Z=this.dirLightGroundShadow.groundMaterial;if(!Z){return}if(!Z.uniforms.groundShadow.value){Z.defines.GROUND_SHADOW=true;Z.needsUpdate=true}},setGrid:function(Z,aa){this.renderer.resetGSSOCache();this.displayGrid=Z;this._updateGridDisplay();if(aa!==undefined){this.displayGridFromBelow=aa;if(this.planeV2){this.planeGrid.displayGridFromBelow=aa?1:0}}this.render()},_updateGridDisplay:function(){var Z=!this._2DMode&&this.displayGrid;if(this._displayGrid!==Z){this._displayGrid=Z;if(this.planeV2){this.planeGrid.displayGrid=Z?1:0}h.publish({event:"/WUX/AFR/CMD/VisuGrid/"+(Z?"BEGIN":"END")})}},getGridUnit:function(){if(this.planeV2&&this.planeGrid){return this.planeGrid.gridUnit}return this.gridUnit},displayInfinitePlane:function(Z,aa){this.renderer.resetGSSOCache();this.infinitePlane=Z;this.planeAttenuation=(aa!==undefined)?aa:false;this._updateInfinitePlaneDisplay()},_updateInfinitePlaneDisplay:function(){this._infinitePlane=!this._2DMode&&this.infinitePlane;if(this.planeV2){this.planeGrid.displayPlane=this._infinitePlane?1:0}if(!this._infinitePlane){!this.planeV2&&this._removeInfinitePlane(this.infPlane)}else{this.render({updateInfinitePlane:true});this.useShadowPlane=true}},setShadowPlane:function(Z){this.renderer.resetGSSOCache();this.useShadowPlane=Z;this._updateShadowPlaneDisplay()},_updateShadowPlaneDisplay:function(aa){var Z=!this._2DMode&&this.useShadowPlane;if(!Z){!this._infinitePlane&&this._removeInfinitePlane(this.infPlaneSmall)}else{this.render({updateInfinitePlane:true})}},setAutomaticPlaneUpdate:function(Z){this.ambience.setAutoGroundOffset(Z)},setPlanePositionAndScale:function(aa,Z){this.offsetPlaneBackground.copy(aa);this.offsetPlaneSmall.z=aa.z;this.ambience.updateScene(aa);this.gridUnit=Z},setGridNbSteps:function(Z){this.renderer.resetGSSOCache();this.gridNbSteps=Math.min(Math.max(Z,1),10);if(this.planeV2){this.planeGrid.setGridNbSteps(this.gridNbSteps)}else{if(!this.bigGrid){return}this._createBigGridGeometry()}},setGroundOptions:function(Z){this.renderer.resetGSSOCache();if(Z.groundCenter!==undefined){this.offsetPlaneBackground.copy(Z.groundCenter);this.offsetPlaneSmall.z=Z.groundCenter.z;this.ambience.updateScene(Z.groundCenter)}if((Z.groundSize!==undefined)&&this.planeV2){this.planeGrid.size=Z.groundSize}if(Z.groundShadow!==undefined){this.setGroundShadow(!!Z.groundShadow)}if(Z.displayPlane!==undefined){this.displayInfinitePlane(!!Z.displayPlane,Z.planeAttenuation)}if(Z.displayGrid!==undefined){this.setGrid(!!Z.displayGrid,Z.displayGridFromBelow)}else{if(Z.displayGridFromBelow!==undefined){this.setGrid(this.displayGrid,Z.displayGridFromBelow)}}if(Z.gridNbSteps!==undefined){this.setGridNbSteps(Z.gridNbSteps)}if(Z.gridLabels!==undefined){if(this.planeV2&&this.planeGrid){this.planeGrid.setLabels(Z.gridLabels)}}if(Z.gridLabelColor!==undefined){if(this.planeV2&&this.planeGrid){this.planeGrid.setLabelColor(Z.gridLabelColor)}}if(Z.gridLabelCallback!==undefined){if(this.planeV2&&this.planeGrid){this.planeGrid.setLabelCallback(Z.gridLabelCallback)}}if(Z.gridDisplayLabelCallback!==undefined){if(this.planeV2&&this.planeGrid){this.planeGrid.setDisplayLabelCallback(Z.gridDisplayLabelCallback)}}if(Z.planeMirror!==undefined){this.setMirror(!!Z.planeMirror,Z.blurryMirror)}if(Z.planeColor!==undefined){this.setPlaneColor(Z.planeColor)}if(this.planeV2&&this.planeGrid){if(Z.planeOpacity!==undefined){this.planeGrid.planeOpacity=Z.planeOpacity}if(Z.planeTexture!==undefined){this.planeGrid.planeTexture=Z.planeTexture}if(Z.planeTextureScale!==undefined){this.planeGrid.planeTextureScale=Z.planeTextureScale}if(Z.planeFalloff!==undefined){this.planeGrid.planeFalloff=Z.planeFalloff}if(Z.gridFalloff!==undefined){this.planeGrid.gridFalloff=Z.gridFalloff}if(Z.planeBorder!==undefined){this.planeGrid.planeBorder=Z.planeBorder}if(Z.planeBorderColor!==undefined){this.planeGrid.edgeColor.set(Z.planeBorderColor)}}if(Z.gridColor!==undefined){this.setGridColor(Z.gridColor)}},getGroundOptions:function(){return{groundCenter:this.offsetPlaneBackground,groundSize:this.planeGrid?this.planeGrid.size:undefined,groundShadow:this.useGroundShadow,displayPlane:this.infinitePlane,displayGrid:this.displayGrid,displayGridFromBelow:this.displayGridFromBelow,gridNbSteps:this.gridNbSteps,gridLabels:this.planeGrid?this.planeGrid.displayLabels:false,planeMirror:this.useMirror,blurryMirror:this.blurryMirror,planeColor:this.planeColor.getHexString(),gridColor:this.gridColor.getHexString(),gridFalloff:this.planeGrid?this.planeGrid.gridFalloff:undefined,planeFalloff:this.planeGrid?this.planeGrid.planeFalloff:undefined,planeBorder:this.planeGrid?this.planeGrid.planeBorder:false,planeBorderColor:this.planeGrid?this.planeGrid.edgeColor.getHexString():undefined}},_getGroundOptions:function(){return{groundCenter:this.offsetPlaneBackground,groundSize:this.planeGrid?this.planeGrid.size:undefined,groundShadow:this.useGroundShadow,displayPlane:this.infinitePlane,displayGrid:this.displayGrid,displayGridFromBelow:this.displayGridFromBelow,gridNbSteps:this.gridNbSteps,gridLabels:this.planeGrid?this.planeGrid.displayLabels:null,gridLabelCallback:this.planeGrid?this.planeGrid.labelCB:null,gridDisplayLabelCallback:this.planeGrid?this.planeGrid.displayLabelCB:null,planeMirror:this.useMirror,blurryMirror:this.blurryMirror,planeColor:"#"+this.planeColor.getHexString(),planeOpacity:this.planeGrid?this.planeGrid.planeOpacity:1,planeTexture:this.planeGrid?this.planeGrid.planeTexture:null,planeTextureScale:this.planeGrid?this.planeGrid.planeTextureScale:1,gridColor:"#"+this.gridColor.getHexString(),gridFalloff:this.planeGrid?this.planeGrid.gridFalloff:undefined,planeFalloff:this.planeGrid?this.planeGrid.planeFalloff:undefined,planeBorder:this.planeGrid?this.planeGrid.planeBorder:false,planeBorderColor:this.planeGrid?"#"+this.planeGrid.edgeColor.getHexString():undefined}},setMirror:function(Z,ac,ag,ae,ab){ae=(ae!==undefined)?ae:0.3;ab=(ab!==undefined)?ab:0.85;ac=(ac!==undefined)?ac:this.blurryMirror;this._setMirrorReflectivity(ae);this.blurryMirror=ac;this.blurryMirror&&this.ambience.setGroundGlossiness(ab);var af=ag?[ag]:["static","dynamic"];for(var ad=0;ad<af.length;ad++){var aa=af[ad];if(!this._qmSetMirror||this._qmSetMirror(Z,aa)){this._effectSettings.GroundReflection[aa]=Z}}},_setMirrorReflectivity:function(Z){if(this.renderer&&this.renderer.mirrorBlendPass){this.renderer.mirrorBlendPass.uniforms.reflectivity.value=Z}},_setMirror:function(Z){if(this.mobile){return}if(this.useMirror!==this._effectSettings.GroundReflection[Z]){this.renderer.resetGSSOCache();this.useMirror=this._effectSettings.GroundReflection[Z]}},setVignetting:function(Z){if(this.useVignetting!==Z){this.renderer.setEffect("Vignetting",Z);this.useVignetting=Z;this.render()}},setHighlight:function(Z){if(this.displayHighlight!==Z){this.displayHighlight=Z;this.setPicking({activated:Z,displayHL:Z});this.renderer.setEffect("Highlight",Z);this.render()}},setRenderIteration:function(Z){this.isRenderIteration=Z},lockRenderIteration:function(){this._lockRenderIteration=true},unlockRenderIteration:function(){this._lockRenderIteration=false},setAntiAliasing:function(ab,ad){var ac=ad?[ad]:["static","dynamic"];for(var aa=0;aa<ac.length;aa++){var Z=ac[aa];if(ab==="SMAA"||ab==="MLAA"||ab==="FXAA"||ab==="FSAA"||ab==="MSAA"||ab==="SSAA"){this._effectSettings.AntiAliasing[Z]=((Z==="dynamic")&&(ab==="MSAA"))?"SMAA":ab}else{if(ab==="NoAA"||ab===false){this._effectSettings.AntiAliasing[Z]="NoAA"}else{if(ab===true){this._effectSettings.AntiAliasing[Z]="SMAA"}else{if(ab==="MSMAA"){console.warn("MSMAA is deprecated");if(Z==="dynamic"){this._effectSettings.AntiAliasing[Z]="SMAA"}else{this._effectSettings.AntiAliasing[Z]="MSAA"}}}}}this._qmSetAntiAliasing&&this._qmSetAntiAliasing(this._effectSettings.AntiAliasing[Z],Z)}},_setAntiAliasing:function(Z){if(this.antiAliasing!==this._effectSettings.AntiAliasing[Z]){this.renderer.setEffect(this.antiAliasing,false);this.antiAliasing=this._effectSettings.AntiAliasing[Z];this.renderer.setEffect(this.antiAliasing,true)}},setPixelCulling:function(ad,ac){var ab=ac?[ac]:["static","dynamic"];for(var aa=0;aa<ab.length;aa++){var Z=ab[aa];this._qmSetPixelCulling&&this._qmSetPixelCulling(ad,Z);this._effectSettings.PixelCulling[Z]=ad}},_setPixelCulling:function(Z){this.currentViewpoint&&this.currentViewpoint._setPixelCulling(this._effectSettings.PixelCulling[Z])},setSSAO:function(Z,ad){var ac=ad?[ad]:["static","dynamic"];for(var ab=0;ab<ac.length;ab++){var aa=ac[ab];if(!this._qmSetSSAO||this._qmSetSSAO(Z,aa)){this._effectSettings.SSAO[aa]=Z}}},_setSSAO:function(aa){var Z=(this._effectSettings.AntiAliasing[aa]==="MSAA");this.useSSAO=this._effectSettings.SSAO[aa];this.renderer.setEffect("SSAO",this.useSSAO&&!this.useSSAOIterative);this.renderer.setEffect("SSAOIterative",this.useSSAO&&this.useSSAOIterative&&Z)},setIterativeSSAO:function(Z){this.useSSAOIterative=Z},setDOF:function(Z,ad){var ac=ad?[ad]:["static","dynamic"];for(var ab=0;ab<ac.length;ab++){var aa=ac[ab];if(!this._qmSetDOF||this._qmSetDOF(Z,aa)){this._effectSettings.DepthOfField[aa]=Z;if(Z&&!this.getEffect("DOF")){this.renderer.setEffect("DOF",true);this.renderer.setEffect("DOF",false)}}}},setIterativeDOF:function(Z){this.useDOFIterative=Z},_setDOF:function(ab){if(this.useDOF!==this._effectSettings.DepthOfField[ab]){this.useDOF=this._effectSettings.DepthOfField[ab];this.renderer.setEffect("DOF",this.useDOF)}if(ab==="static"){var aa=(this._effectSettings.AntiAliasing[ab]==="MSAA");var Z=this.getEffect("DOF");Z&&Z.setIterative(this.useDOFIterative&&aa)}},setBloom:function(Z,ad){var ac=ad?[ad]:["static","dynamic"];for(var ab=0;ab<ac.length;ab++){var aa=ac[ab];if(!this._qmSetBloom||this._qmSetBloom(Z,aa)){this._effectSettings.Bloom[aa]=Z}}},_setBloom:function(Z){if(this.useBloom!==this._effectSettings.Bloom[Z]){this.useBloom=this._effectSettings.Bloom[Z];this.renderer.setEffect("Bloom",this.useBloom)}},setScanIntensity:function(Z){if(this.internalSceneGraph&&this.internalSceneGraph.selectionHL&&this.internalSceneGraph.selectionHL.colorHighlight){this.internalSceneGraph.selectionHL.colorHighlight.intensity=Z}},setPreHighlightColor:function(aa,Z){var ad,ac,ab=this.getEffect("PreHighlight");if(ab){if(aa instanceof M.Color){ad=new M.Vector4(aa.r,aa.g,aa.b,1)}if(Z instanceof M.Color){ac=new M.Vector4(Z.r,Z.g,Z.b,1)}ab.setColor(ad,ac)}},getEffect:function(Z){var aa=null;switch(Z){case"ToneMapping":case"Bloom":aa=this.renderer.ToneMappingEffect;break;case"DOF":aa=this.renderer.BokehDOFEffect;break;case"SSLR":aa=this.renderer.SSLREffect;break;case"SSAO":aa=this.renderer.SSAOEffect;break;case"SSAOIterative":aa=this.renderer.SSAOIterativeEffect;break;case"PreHighlight":aa=this.renderer.PreHighlightEffect;break;case"Highlight":aa=this.renderer.HighlightEffect;break;default:break}return aa},setFlare:function(Z){if(this.useFlare!==Z){this.renderer.setEffect("Flare",Z);this.useFlare=Z;this.render()}},setMagnifier:function(Z){if(!Z.viewer){Z.viewer=this}if(this.magnifier===null){this.magnifier=new n(Z)}else{this.magnifier.setOption(Z)}if(!this.pPicking.activated){this.setPrePicking({activated:true,displayHL:false,gpu:false,computeNormalDepth:true,})}},setFillXSOMode:function(Z){this._fillXSOMode=Z},setPicking:function(aa,ac){if(typeof(aa)==="boolean"){console.log("boolean is DEPRECATED in setPicking() method.\n Use object instead.")}if(aa.activated!==undefined){this.picking.activated=aa.activated}var ab=function(ad){if(window.enableNewTrapSelection){console.log("WebGLViewer: new trap selection mode is ON!");if(ad){if(!this.trapSelectionManipulator){this.trapSelectionManipulator=new G(this);this.trapSelectionManipulator._linkToViewer()}this.trapSelectionManipulator.enable();this.trapSelectionManipulator.setAdvanced(ad==="advanced")}else{if(this.trapSelectionManipulator){this.trapSelectionManipulator.disable()}}}else{if(!this.trapSelection){this.trapSelection=new C(this)}this.trapSelection.set(ad)}};if(aa.contextPick!==undefined){this.picking.contextPick=aa.contextPick}if(aa.trapSelection!==undefined){this.picking.trapSelection=aa.trapSelection;ab.call(this,aa.trapSelection)}if(aa.trapSelectionMesh!==undefined){this.picking.trapSelectionMesh=aa.trapSelectionMesh;this.picking.trapSelection=aa.trapSelectionMesh;ab.call(this,aa.trapSelectionMesh)}if(aa.displayHL!==undefined){this.picking.displayHL=aa.displayHL}if(aa.gpu!==undefined){this.picking.gpu=aa.gpu}if(aa.computeNormalDepth!==undefined){this.picking.computeNormalDepth=aa.computeNormalDepth}if(aa.primitive!==undefined){this.picking.primitive=aa.primitive}if(aa.pickingTolerance!==undefined){this.renderer.gpuPickingTolerance=aa.pickingTolerance;this.picking.tolerance=aa.pickingTolerance}if(this.renderer){this.renderer.setEffect("Highlight",this.picking.activated&&this.picking.displayHL)}var Z=true;if(ac!==undefined){Z=ac}this.setDefaultPicking(Z)},setPrePicking:function(aa,ab){if(aa.activated!==undefined){this.pPicking.activated=aa.activated}if(aa.trapSelection!==undefined){this.pPicking.trapSelection=aa.trapSelection}if(aa.displayHL!==undefined){this.pPicking.displayHL=aa.displayHL}if(aa.gpu!==undefined){this.pPicking.gpu=aa.gpu}if(aa.computeNormalDepth!==undefined){this.pPicking.computeNormalDepth=aa.computeNormalDepth}if(aa.primitive!==undefined){this.pPicking.primitive=aa.primitive}if(aa.disableWhileMoving!==undefined){this.pPicking.disableWhileMoving=aa.disableWhileMoving}if(this.renderer){this.renderer.setEffect("PreHighlight",this.pPicking.activated&&this.pPicking.displayHL)}var Z=true;if(ab!==undefined){Z=ab}this.setDefaultPicking(Z)},setPickingGPU:function(Z){if(this.picking.gpu!==Z){this.picking.gpu=Z}},setSmallRenderTargetPicking:function(Z){if(this.renderer.smallTargetPicking!==Z){this.renderer.smallTargetPicking=Z}},setIntensityCorrection:function(Z){if(M.intensityCorrection!==Z){M.intensityCorrection=Z;if(Z){if(this.directionalLight){this.directionalLight.intensity*=this.directionalLight.intensity}if(this.directionalLight2){this.directionalLight2.intensity*=this.directionalLight2.intensity}if(this.directionalLight3){this.directionalLight3.intensity*=this.directionalLight3.intensity}}else{if(this.directionalLight){this.directionalLight.intensity=Math.sqrt(this.directionalLight.intensity)}if(this.directionalLight2){this.directionalLight2.intensity=Math.sqrt(this.directionalLight2.intensity)}if(this.directionalLight3){this.directionalLight3.intensity=Math.sqrt(this.directionalLight3.intensity)}}}},activateNoMeshInRAM:function(Z){console.warn("DEPRECATED: noMeshInRAM should be activated on the modelLoader")},setManipulators:function(Z){if(!this.manipulatorManager){return false}if(Z.activated!==undefined){this.manipulatorManager.setActivate(Z.activated)}if(Z.preActivate!==undefined){this.manipulatorManager.setPreActivate(Z.preActivate)}},getManipulators:function(){if(!this.manipulatorManager){return false}return this.manipulatorManager.getActivate()},setOverrideCursors:function(Z){this.overrideCursors=Z},getCursor:function(){return this.canvas.style.cursor},setCursor:function(ad,Z,aa){if(!this.overrideCursors){return}var ag=this;var ae=["auto","-webkit-grabbing","pointer"];var ab="auto";if(ae.indexOf(ad)!==-1){ab=ad}else{if(ad!=="Auto"){if(aa){ab=ad}else{var af=J.getWebappsAssetUrl("Visualization","")+"icons/";ab="url('"+af+"WebViewer"+ad+".png'), url('"+af+"WebViewer"+ad+".cur'), auto"}}}if(this._changeCursorDelay){clearTimeout(this._changeCursorDelay);this._changeCursorDelay=null}var ac=function(ah){ag.canvas.style.cursor=ah};if(Z>0){this._changeCursorDelay=setTimeout(function(){ac(ab)},Z)}else{ac(ab)}},setTemporaryCursor:function(ab){var Z=this._temporaryCursorData;if(!Z){var aa=this.getCursor()||null;Z={oldCursor:aa};this._temporaryCursorData=Z;this.setCursor(ab)}},unsetTemporaryCursor:function(){var Z=this._temporaryCursorData;if(Z){var aa=Z.oldCursor||"auto";this.setCursor(aa,0,true);this._temporaryCursorData=null}},setForceMultiSelection:function(Z){this.forceMultiSel=Z},setForcePickingFaces:function(Z){if(this.renderer.renderer){this.renderer.renderer.pickFacesMode=Z?1:2}},setForcePickingLines:function(Z){if(this.renderer.renderer){this.renderer.renderer.pickLinesMode=Z?1:2}},setForcePickingPoints:function(Z){if(this.renderer.renderer){this.renderer.renderer.pickPointsMode=Z?1:2}},setFacePickingMode:function(Z){if(Z!==this.renderer.renderer.pickFacesMode){this.renderer.renderer.pickFacesMode=Z;this.invalidatePickingBuffer()}},setLinePickingMode:function(Z){if(Z!==this.renderer.renderer.pickLinesMode){this.renderer.renderer.pickLinesMode=Z;this.invalidatePickingBuffer()}},setPointPickingMode:function(Z){if(Z!==this.renderer.renderer.pickPointsMode){this.renderer.renderer.pickPointsMode=Z;this.invalidatePickingBuffer()}},setDebugPostProcessing:function(Z){if(this.debugPostProcessing!==Z){this.renderer.setEffect("DebugPass",Z);this.debugPostProcessing=Z;this.render()}},showPerfo:function(ac,ab,aa,Z,ad){if(ac&&!this._glFPSCounter){var ae=this;require(["DS/VisuTools/FPSCounter"],function(af){if(ad){af.setAutoRefresh(false)}ae._glFPSCounter=af;ae._glFPSCounter.setActivated(ae,true,aa);window.webVisuPerfo.setEnabled(ab?true:false);if(Z){Z()}})}else{if(this._glFPSCounter){this._glFPSCounter.setActivated(this,ac,aa);window.webVisuPerfo.setEnabled(ab?true:false)}}},showInfos:function(aa,Z){if(aa&&!this._glInfoCounter){var ab=this;require(["DS/VisuTools/InfoCounter"],function(ac){ab._glInfoCounter=new ac(ab,Z)})}else{if(this._glInfoCounter){this._glInfoCounter.activate(aa)}}},showNodeCounter:function(aa,Z){if(aa&&!this._glNodeCounter){var ab=this;require(["DS/VisuTools/NodeCounter"],function(ac){ab._glNodeCounter=new ac(ab,Z)})}else{if(this._glNodeCounter){this._glNodeCounter.activate(aa)}}},setDebugFPS:function(Z,ab){this.debugFPS=Z;this.debugFPSInfos.fpsLastTime=performance.now();this.debugFPSInfos.fpsWindow=ab||40;this.debugFPSInfos.fpsIndex=0;this.debugFPSInfos.fpsCumul=30*this.debugFPSInfos.fpsWindow;this.debugFPSInfos.fpsValue=30;this.debugFPSInfos.fpsArray=[];for(var aa=0;aa<this.debugFPSInfos.fpsWindow;aa++){this.debugFPSInfos.fpsArray[aa]=30}if(Z){if(!this.debugFPSInfos.fpsCounter){this.debugFPSInfos.fpsCounter=new UWA.Element("div",{html:"FPS",styles:{fontFamily:"arial, sans-serif",fontSize:"20px",position:"absolute",top:"20px",right:"10px",textAlign:"left",verticalAlign:"middle",backgroundColor:"#333",color:"white"}});this.div.appendChild(this.debugFPSInfos.fpsCounter)}else{this.debugFPSInfos.fpsCounter.show()}}else{this.debugFPSInfos.fpsCounter&&this.debugFPSInfos.fpsCounter.hide()}},setDebugShadowMaps:function(Z){if(this.debugShadowMaps!==Z){this.renderer.setEffect("DebugShadowMaps",Z);this.debugShadowMaps=Z;this.render()}},setDebugEvents:function(Z){this.debugEvents=Z;B.setDebugEvents(Z)},getDisplayFaces:function(){return this.renderer.renderer.renderFaces},getDisplayLines:function(){return this.renderer.renderer.renderLineMode!==M.HideAllRenderLineMode},getDisplayPoints:function(){return this.renderer.renderer.renderPoints},getShadow:function(){return this.useShadowMap},getOIT:function(){return this.useOIT},getGrid:function(){return this.displayGrid},getInfinitePlane:function(){return this.infinitePlane},getMirror:function(){return this.useMirror},createInfinitePlane:function(ac,af,ai,ag){var ae,ad,ah,aa,ab=(this.internalSceneGraph===null)?this.temporaryEmptyScene:this.internalSceneGraph.scene;if(ac!==null){ac.visible=true;ac.visibilityFree=true;ac.position.set(ag.x-0.5*ai,ag.y-0.5*ai,ag.z);ac.scale.set(ai,ai,1);if((af===1)&&ac.material){ac.material.uniforms.diffuse.value.copyGammaToLinear(this.planeColor);ac.material.uniforms.border.value.copy(this.ambience.getBackgroundColor());ac.material.uniforms.attenuation.value=this.planeAttenuation?1:0}ac.updateMatrix();return}if(af===1){ad=this.mobile?M.InfinitePlaneShaderSimple:M.InfinitePlaneShader;ah={defines:{},fragmentShader:(!this.mobile&&this.triLights)?ad.fragmentShaderFirstDirOnly:ad.fragmentShader,vertexShader:ad.vertexShader,uniforms:ad.uniforms};aa=new M.ShaderMaterial(ah);aa.lights=!this.mobile;aa.useBlending=true;aa.depthTest=false;aa.depthWrite=false;aa.side=M.DoubleSide;aa.force=true;aa.uniforms.ambient.value.copyGammaToLinear(new M.Color(328965));aa.uniforms.diffuse.value.copyGammaToLinear(this.planeColor);aa.uniforms.border.value.copy(this.ambience.getBackgroundColor());aa.uniforms.attenuation.value=this.planeAttenuation?1:0;var Z=P.createRectangleNode({width:1,height:1,fill:true,noEdge:true,material:aa});this.infPlane=Z._occurrences[0].renderable;ac=this.infPlane;ac.receiveShadow=false;ac.renderDepth=1;this.sceneBackground.add(ac)}else{if(af===0){ad=M.SmallPlaneShader;ah={defines:{},fragmentShader:ad.fragmentShader,vertexShader:ad.vertexShader,uniforms:ad.uniforms};aa=new M.ShaderMaterial(ah);aa.lights=true;aa.useBlending=true;aa.blending=M.MultiplyBlending;aa.depthWrite=false;aa.side=M.DoubleSide;aa.force=true;aa.polygonOffset=true;aa.polygonOffsetFactor=2;aa.polygonOffsetUnits=1;aa.enableClipPlanes=false;aa.updateDeferredMaterials();aa._deferredMaterials[M.MaterialToUse.pickingMaterial].depthWrite=false;this.dirLightGroundShadow.groundMaterial=aa;var Z=P.createRectangleNode({width:1,height:1,fill:true,noEdge:true,material:aa});this.infPlaneSmall=Z._occurrences[0].renderable;ac=this.infPlaneSmall;ac.receiveShadow=true;ac.castShadow=false;ac.renderDepth=-Number.MAX_VALUE;ab.add(ac)}}ac.pickable=false;ac.frustumCulled=false;ac.visibilityFree=true;ac.position.set(ag.x-0.5*ai,ag.y-0.5*ai,ag.z);ac.scale.set(ai,ai,1);ac.updateMatrix()},_removeInfinitePlane:function(Z){if((Z!==null)&&Z.visible){Z.visible=false;this.render()}},createGrid:function(ag,aq,af,an,ac){an=Math.pow(Math.max(0,an),0.4);var az=this.mobile;var au,aC,ax,aG,aE,ar,aB,al,ab,aF,ae=function(aL){var aK=Math.tan(0.125*Math.PI);aK*=aL/ag;return Math.ceil(100*aK)},ad=function(aN){var aM=0.25*aN;var aO=0.0002;var aL=0;while(aO<aM){var aK=aL%3;switch(aK){case 0:aO*=2;break;case 1:aO*=2.5;break;case 2:aO*=2;break}aL++}return aO};au=ae(af);aC=this.ambience.isAutoGroundOffset()?ad(ag*au):ag;if(this.grid!==null){this.grid.visibilityFree=true;this.grid.material.uniforms.diffuse.value.copyGammaToLinear(this.gridColor)}if(this.bigGrid!==null){this.bigGrid.visibilityFree=true;this.bigGrid.material.uniforms.diffuse.value.copyGammaToLinear(this.gridColor)}this.gridSize=aC;this.gridUnit=aC*this.gridStep;var am=new M.Vector3(0,0,aq.z);am.x=(this.gridNbSteps*this.gridUnit)*Math.floor(aq.x/(this.gridNbSteps*this.gridUnit));am.y=(this.gridNbSteps*this.gridUnit)*Math.floor(aq.y/(this.gridNbSteps*this.gridUnit));if(this.grid!==null){this.grid.scale.set(aC,aC,1);if(az){this.grid.position.set(am.x-0.5*aC,am.y-0.5*aC,am.z)}else{this.grid.position.set(am.x,am.y,am.z)}this.grid.visibilityFree=true;this.grid.updateMatrix();this.grid.material.uniforms.gridSize.value=ag;this.grid.material.uniforms.attenuation.value=an;this.grid.visible=true;this.grid._distanceToCameraForLargeScale=af/this.grid.worldRadius;this.grid._computeLargeScaleStatus();if(this.bigGrid!==null){this.bigGrid.scale.set(aC,aC,1);this.bigGrid.position.set(am.x,am.y,am.z);this.bigGrid.visibilityFree=true;this.bigGrid.updateMatrix();this.bigGrid.material.uniforms.gridSize.value=ag;this.bigGrid.material.uniforms.attenuation.value=an;this.bigGrid.visible=true;this.bigGrid._distanceToCameraForLargeScale=af/this.bigGrid.worldRadius;this.bigGrid._computeLargeScaleStatus()}return true}aG=az?M.TexturedGridShader:M.GridShader;aE={fragmentShader:aG.fragmentShader,vertexShader:aG.vertexShader,uniforms:M.UniformsUtils.clone(aG.uniforms)};var ap;ar=new M.ShaderMaterial(aE);if(az){var aH=J.getWebappsAssetUrl("Visualization","");ap=new M.ImageUtils.loadTexture(aH+"grid512.png",undefined,null,null,M.ImageUtils.crossOriginPolicy);ap.wrapS=M.RepeatWrapping;ap.wrapT=M.RepeatWrapping;ap.anisotropy=8;ar.map=ap;ar.uniforms.map.value=ap;ar.uniforms.repeatBumpMap.value=new M.Vector2(0.2/this.gridStep,0.2/this.gridStep)}else{ar.lights=true}ar.useBlending=true;ar.depthTest=false;ar.force=true;ar.uniforms.gridSize.value=ag;ar.uniforms.attenuation.value=an;if(az){var aJ=P.createRectangleNode({width:1,height:1,fill:true,noEdge:true,material:ar});this.grid=aJ._occurrences[0].renderable;this.grid.frustumCulled=false}else{var ay=new q.PrimitiveGroup();var ah=2/this.gridStep;var aa=6*ah;var Z=8*ah;var av=new q.Buffer({component:q.VertexComponentEnum.POSITION,data:new Float32Array(3*aa)});var at=new Uint16Array(Z);var aD=new q.Buffer({indexBuffer:true,data:at});ay.addBuffer(0,av);ay.addBuffer(1,aD);var ao=0,ai=0;var aj=av.data;var aA=aD.data;for(aF=0;aF<ah;aF++){aj[ao++]=aF*this.gridStep-1;aj[ao++]=-1;aj[ao++]=0;aj[ao++]=aF*this.gridStep-1;aj[ao++]=0;aj[ao++]=0;aj[ao++]=aF*this.gridStep-1;aj[ao++]=1;aj[ao++]=0;aj[ao++]=-1;aj[ao++]=aF*this.gridStep-1;aj[ao++]=0;aj[ao++]=0;aj[ao++]=aF*this.gridStep-1;aj[ao++]=0;aj[ao++]=1;aj[ao++]=aF*this.gridStep-1;aj[ao++]=0}for(aF=0;aF<4*ah;aF++){aA[ai++]=3*aF;aA[ai++]=3*aF+1;aA[ai++]=3*aF+1;aA[ai++]=3*aF+2}var ak=new q.Primitive({nbIndices:Z,connectivity:q.ConnectivityTypeEnum.LINES,fillGAS:new q.FillAttributes(new q.Color(0.2,0.2,0.2,1))});var aI=new q.VertexComponent({nbVertices:aa,bufferId:0,indices:new q.IndexArray({bufferId:1,offset:0})});ak.addVertexComponent(aI);ay.addPrimitive(ak);var aw=P.createMeshNode(ay,ar);this.grid=aw._occurrences[0].renderable;this.grid.frustumCulled=false}this.grid.pickable=false;this.grid.receiveShadow=true;this.grid.renderDepth=0;this.grid.visibilityFree=true;this.sceneBackground.add(this.grid);if(az){}else{this._createBigGridGeometry();this.bigGrid.scale.set(aC,aC,1);this.bigGrid.position.set(am.x,am.y,am.z);this.bigGrid.updateMatrix();this.bigGrid.material.uniforms.gridSize.value=ag;this.bigGrid.material.uniforms.attenuation.value=an;this.bigGrid.material.uniforms.diffuse.value.copyGammaToLinear(this.gridColor);this.bigGrid._distanceToCameraForLargeScale=af/this.bigGrid.worldRadius;this.bigGrid._computeLargeScaleStatus()}this.grid.scale.set(aC,aC,1);if(az){this.grid.position.set(am.x-0.5*aC,am.y-0.5*aC,am.z)}else{this.grid.position.set(am.x,am.y,am.z)}this.grid.updateMatrix();this.grid.material.uniforms.diffuse.value.copyGammaToLinear(this.gridColor);this.grid._distanceToCameraForLargeScale=af/this.grid.worldRadius;this.grid._computeLargeScaleStatus();return true},_createBigGridGeometry:function(){if(this.bigGrid){this.sceneBackground.remove(this.bigGrid)}var Z=M.BigGridShader;var ah={fragmentShader:Z.fragmentShader,vertexShader:Z.vertexShader,uniforms:M.UniformsUtils.clone(Z.uniforms)};var ap=new M.ShaderMaterial(ah);ap.useBlending=true;ap.lights=true;ap.side=M.DoubleSide;ap.depthTest=false;ap.force=true;var aw=this.gridNbSteps*this.gridStep;var ab=0.02*this.gridStep;var ai=new q.PrimitiveGroup();var ax=2/this.gridStep;var ad=12*ax;var ac=24*ax;var ar=new q.Buffer({component:q.VertexComponentEnum.POSITION,data:new Float32Array(3*ad)});var am=new q.Buffer({component:q.VertexComponentEnum.NORMAL,data:new Float32Array(3)});var aa=new q.Buffer({indexBuffer:true,data:new Uint16Array(ac)});var ao=new q.Buffer({indexBuffer:true,data:new Uint16Array(ac)});ai.addBuffer(0,ar);ai.addBuffer(1,am);ai.addBuffer(2,aa);ai.addBuffer(3,ao);var az=0,aj=0,al=0;var ak=ar.data;var af=aa.data;var au=am.data;var ag=ao.data;au[0]=0;au[1]=0;au[2]=1;for(var ay=0;ay<ax;ay++){ak[az++]=ay*aw-1-ab;ak[az++]=-1;ak[az++]=0;ak[az++]=ay*aw-1-ab;ak[az++]=0;ak[az++]=0;ak[az++]=ay*aw-1-ab;ak[az++]=1;ak[az++]=0;ak[az++]=ay*aw-1+ab;ak[az++]=1;ak[az++]=0;ak[az++]=ay*aw-1+ab;ak[az++]=0;ak[az++]=0;ak[az++]=ay*aw-1+ab;ak[az++]=-1;ak[az++]=0;ak[az++]=-1;ak[az++]=ay*aw-1-ab;ak[az++]=0;ak[az++]=0;ak[az++]=ay*aw-1-ab;ak[az++]=0;ak[az++]=1;ak[az++]=ay*aw-1-ab;ak[az++]=0;ak[az++]=1;ak[az++]=ay*aw-1+ab;ak[az++]=0;ak[az++]=0;ak[az++]=ay*aw-1+ab;ak[az++]=0;ak[az++]=-1;ak[az++]=ay*aw-1+ab;ak[az++]=0}for(var ay=0;ay<24*ax;ay++){ag[al++]=0}var ae=0;for(var ay=0;ay<ax;ay++){af[aj++]=ae;af[aj++]=ae+4;af[aj++]=ae+1;af[aj++]=ae;af[aj++]=ae+5;af[aj++]=ae+4;af[aj++]=ae+1;af[aj++]=ae+3;af[aj++]=ae+2;af[aj++]=ae+1;af[aj++]=ae+4;af[aj++]=ae+3;ae+=6;af[aj++]=ae;af[aj++]=ae+1;af[aj++]=ae+4;af[aj++]=ae;af[aj++]=ae+4;af[aj++]=ae+5;af[aj++]=ae+1;af[aj++]=ae+2;af[aj++]=ae+3;af[aj++]=ae+1;af[aj++]=ae+3;af[aj++]=ae+4;ae+=6}var at=new q.Primitive({nbIndices:ac,connectivity:q.ConnectivityTypeEnum.TRIANGLES,fillGAS:new q.FillAttributes(new q.Color(0.2,0.2,0.2,1))});var an=new q.VertexComponent({nbVertices:ad,bufferId:0,indices:new q.IndexArray({bufferId:2,offset:0})});var av=new q.VertexComponent({nbVertices:1,bufferId:1,indices:new q.IndexArray({bufferId:3,offset:0})});at.addVertexComponent(an);at.addVertexComponent(av);ai.addPrimitive(at);var aq=P.createMeshNode(ai,ap);this.bigGrid=aq._occurrences[0].renderable;this.bigGrid.frustumCulled=false;this.bigGrid.visibilityFree=true;this.bigGrid.pickable=false;this.bigGrid.receiveShadow=true;this.bigGrid.renderDepth=0;this.sceneBackground.add(this.bigGrid)},_removeGrid:function(){var Z=false;if(this.grid!==null){this.grid.visible=false;Z=true}if(this.bigGrid!==null){this.bigGrid.visible=false;Z=true}return Z},setAmbientLight:function(Z){if(typeof(Z)==="number"||typeof(Z)==="string"){this.ambientLight.color=new M.Color(Z)}else{if(Z){this.ambientLight.color=Z}}},setDirectionalLight:function(af,ae,ab,Z){this.renderer.resetGSSOCache();this.autoUpdateLights=false;this.dirLightLatitude=af;var aa=this.directionalLight,ad=(this.internalSceneGraph===null)?100:this.internalSceneGraph.getBoundingSphere().radius,ac=(this.internalSceneGraph===null)?new M.Vector3(0,0,0):this.internalSceneGraph.getBoundingSphere().center;this.dirLightVector.set(Math.sin(Math.PI*af)*Math.cos(2*Math.PI*ae),Math.sin(Math.PI*af)*Math.sin(2*Math.PI*ae),Math.cos(Math.PI*af));if(this.useDefaultLights){aa.position=new M.Vector3().copy(this.dirLightVector).multiplyScalar(2*ad).add(ac);aa.lookAt(ac);aa.target.position=ac;aa.target.updateMatrixWorld();if(typeof(ab)==="number"||typeof(ab)==="string"){aa.color=new M.Color(ab)}else{if(ab){aa.color=ab}}aa.intensity=Z;aa.updateShadowMap=true}this.renderer.resetClippingScene();this.render()},setLightParameters:function(ae){var ac=[this.directionalLight,this.directionalLight2,this.directionalLight3];var ad=[this.dirLightVector,this.dirLight2Vector,this.dirLight3Vector];var ab=ae.lightIndex?ae.lightIndex:0;var aa=ac[ab];var Z=ad[ab];if(!aa){return false}this.autoUpdateLights=false;if(ae.color){aa.color=new M.Color(ae.color)}if(ae.intensity!==undefined){aa.intensity=ae.intensity}if(ae.direction){Z.copy(ae.direction);if(ab===0){aa.updateShadowMap=true}}if(ae.directionType){this.dirLightType[ab]=(ae.directionType==="camera");if(ab===0){aa.updateShadowMap=true}}this.render();return true},setAutoUpdateLights:function(Z){this.renderer.resetGSSOCache();this.autoUpdateLights=Z},setLightOnViewpoint:function(Z){this.renderer.resetGSSOCache();this.dirLightType[0]=Z},setToneMapping:function(ab){var Z=this.renderer.ToneMappingEffect;if(!Z){return}var aa=true;if(ab.gamma!==undefined){Z.setGamma(ab.gamma);aa=(ab.gamma===2)}if(ab.enable!==undefined){if(ab.enable){Z.setToneMapping(aa?1:2)}else{Z.setToneMapping(0)}}},setV6Ambience:function(){var Z=(window.__karma__&&!this.ODTMode)?"V6":"None";this.setVisuEnv(Z)},getVisuEnv:function(){return this.visuEnv},setVisuEnv:function(ah){this.renderer.resetGSSOCache();this.setGradientBackground();var Z="SMAA";var af=true;var ak=null;if(r&&r.effects){ak=r.effects}switch(ah){case"None":if(this.ODTMode&&ak&&!ak.force){this.setGrid(false);this.displayInfinitePlane(false);this.setShadowPlane(false);this.setBackgroundColor(14414586);this.setSSAO(false);this.setShadow(false);this.setMirror(false,false);af=false;break}var am=false;var ai=false;var aa=false;var ab=false;var ag=false;var ac=new M.Color();var an=new M.Color();var al=new M.Color();if(ak){var ae=ak.BackgroundColor;if(ak.AntiAliasing==="false"){Z="NoAA"}am=(ak.Plane!=="false");ai=(ak.Grid!=="false");aa=(ak.Mirror!=="false");ab=(ak.Shadow!=="false");ag=(ak.SSAO!=="false");if(ae){ac.r=(ae.red!==undefined)?ae.red:1;ac.g=(ae.green!==undefined)?ae.green:1;ac.b=(ae.blue!==undefined)?ae.blue:1}}this.setGrid(ai);this.displayInfinitePlane(am);this.setShadowPlane(am);var ad=Math.min(Math.max(0,0.2126*ac.r+0.7152*ac.g+0.0722*ac.b),1);var aj=ad>=0.5?0:1;an.r=0.4*aj+0.6*ac.r;an.g=0.4*aj+0.6*ac.g;an.b=0.4*aj+0.6*ac.b;al.r=0.05*aj+0.95*ac.r;al.g=0.05*aj+0.95*ac.g;al.b=0.05*aj+0.95*ac.b;this.setBackgroundColor(ac.getHex());this.setPlaneColor(al.getHex());this.setGridColor(an.getHex());this.setSSAO(ag);this.setShadow(ab);this.setMirror(aa,true);break;case"V6":this.setGrid(true);this.displayInfinitePlane(true,false);this.setBackgroundColor(15527148);this.setPlaneColor(16514043);this.setGridColor(13421772);this.setSSAO(true);this.setShadow(true);this.setMirror(true,true);break;case"CleanSpace":this.setGrid(false);this.displayInfinitePlane(true,false);this.setBackgroundColor(15527148);this.setPlaneColor(16514043);this.setSSAO(true);this.setShadow(false);this.setMirror(false,false);break;case"DarkBlue":this.setGrid(true);this.displayInfinitePlane(false);this.setBackgroundColor(3958400);this.setGradientBackground([6728399,3958400,1848912]);this.setGridColor(8362924);this.setSSAO(false);this.setShadow(false);this.setMirror(false,false);break;case"DarkGrey":this.setGrid(true);this.displayInfinitePlane(true,false);this.setBackgroundColor(3881787);this.setPlaneColor(2960685);this.setGridColor(7303023);this.setSSAO(false);this.setShadow(false);this.setMirror(false,false);break;case"Shiny":this.setGrid(false);this.displayInfinitePlane(true,true);this.setBackgroundColor(1118481);this.setGradientBackground([6710886,2105376,0]);this.setPlaneColor(6710886);this.setSSAO(true);this.setShadow(true);this.setMirror(true,true);break;case"Studio":this.setGrid(false);this.displayInfinitePlane(false);this.setBackgroundColor(15527148);this.setGradientBackground([7497556,15131615,9668981]);this.setPlaneColor(16119027);this.setSSAO(true);this.setShadow(false);this.setMirror(true,true);break;default:return}this.visuEnv=ah;this.ODTMode&&this.setAntiAliasing(Z);this.setTriLights(af);if(!this.triLights){this.setSecondaryLightColor(15527148);this.setDirectionalLight(0.34,0.16,16777215,0.95)}else{this.dirLightLatitude=0.34}},setTriLights:function(ac){if(ac===this.triLights){return}this.triLights=ac;var ad=this.directionalLight;var ab=this.directionalLight2;var aa=this.directionalLight3;if(ac){if(ad){ad.intensity=M.intensityCorrection?0.49:0.7;ad.shadowDarkness=0.3}if(ab){ab.intensity=M.intensityCorrection?0.49:0.7;ab.color=new M.Color(16777215)}if(!aa){if(M.intensityCorrection){this.directionalLight3=new M.DirectionalLight(16777215,0.49)}else{this.directionalLight3=new M.DirectionalLight(16777215,0.7)}aa=this.directionalLight3}aa.position.set(40,-40,40);aa.target=new M.Object3D();this.internalSceneGraph&&this.internalSceneGraph.scene.add(aa)}else{if(ad){ad.intensity=M.intensityCorrection?0.81:0.9;ad.shadowDarkness=0.65}if(ab){ab.intensity=1;ab.color=new M.Color(3827071)}if(aa){this.internalSceneGraph&&this.internalSceneGraph.scene.remove(aa)}}if(this.infPlane&&this.infPlane.material){var ae=this.mobile?M.InfinitePlaneShaderSimple:M.InfinitePlaneShader;var Z=(!this.mobile&&ac)?ae.fragmentShaderFirstDirOnly:ae.fragmentShader;this.infPlane.material.fragmentShader=Z;this.infPlane.material.needsUpdate=true}},setLightProbe:function(Z){if(Z===null){if(this.probeLight!==null){this.internalSceneGraph.scene.remove(this.probeLight);this.renderer.recompileAllShaders()}return}M.ImageUtils.computeSphericalHarmonics(Z);if(this.probeLight===null){this.probeLight=new M.ProbeLight(Z)}else{this.probeLight.envMap=Z}this.internalSceneGraph.scene.add(this.probeLight);this.renderer.recompileAllShaders()},showEnvMap:function(aa){this.renderer.resetGSSOCache();var Z=this.ambience.getBackground();if(Z.isActivated()===aa){return}if(aa){if(Z.withImage()||Z.hasGradient()){Z.setActivated(aa)}}else{Z.setActivated(aa)}},setEnvMap:function(ad,aa,ag){this.renderer.resetGSSOCache();if(aa===2){console.warn("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation.");var af=this;var ae=0;var ac=(ad.length===2)?ad[0]:null;var ab=(ad.length===2)?ad[1]:null;if(!ac){ac=M.ImageUtils.loadHDRTexture(ad+".hdr",new M.LatLongReflectionMapping())}ac.minFilter=M.NearestFilter;ac.magFilter=M.NearestFilter;ac.wrapS=M.RepeatWrapping;ac.wrapT=M.RepeatWrapping;if(!ab){ab=M.ImageUtils.loadHDRTexture(ad+"_rmips.hdr",new M.LatLongReflectionMapping())}ab.minFilter=M.NearestFilter;ab.magFilter=M.NearestFilter;ab.wrapS=M.RepeatWrapping;ab.wrapT=M.RepeatWrapping;var Z=function(){ae++;if(ae===2){af.internalSceneGraph.scene.envMipMap[0]=ac;af.internalSceneGraph.scene.envMipMap[1]=ab;if(af.internalSceneGraph.scene.envMipMapID){af.renderer.renderer.ambianceGenerators.decreaseUseCount(af.internalSceneGraph.scene.envMipMapID);af.internalSceneGraph.scene.envMipMapID=null}af.render();ag&&ag()}};ac&&ac.onLoadCallbacks.push(Z);ab&&ab.onLoadCallbacks.push(Z);return ac}if(ad===null){console.warn("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation.");return}if(!ad.length&&!(ad instanceof M.Texture)){this._setEnvMap(ad);return}console.warn("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation.");if(ad.length===2){this.ambience.setBackGroundMap({texture:ad[0]});this.ambience.setRoughnessMap({texture:ad[1]})}else{this.ambience.setBackGroundMap({texture:ad})}},_setSphereEnv:function(Z){if(Z){this.sphereEnv=Z;this.sceneBackground.add(Z)}},_setPhysicalGround:function(Z){if(Z){this.ground=Z;this.sceneBackground.add(Z)}},_setEnvMap:function(ab){var ae=this;var af=null;var ai=null;var aa=null;var ah=undefined;var ad=undefined;var Z=0;var ac=0;var ak=function(){ac++;if(ac===Z){ab.doneCallback&&ab.doneCallback()}};if(ab.roughnessMap instanceof M.Texture){Z++;this.ambience.setRoughnessMap({texture:ab.roughnessMap,doneCallback:ak});ad=true}else{if(ab.roughnessMap===null){ad=null}}var ag=false;if(ab.IBLMap){if(ab.IBLMap instanceof M.Texture){Z++;this.ambience.setIblMap({texture:ab.IBLMap,doneCallback:ak})}else{if(ab.IBLMap!==""){var aj=(o.getExtension(ab.IBLMap)==="dds");Z++;if(aj){this.ambience.setReflectionMap({url:ab.IBLMap,doneCallback:ak})}else{this.ambience.setIblMap({url:ab.IBLMap+".hdr",mapping:new M.LatLongReflectionMapping(),hdr:true,doneCallback:ak})}if(!ad&&!aj){Z++;this.ambience.setRoughnessMap({url:ab.IBLMap+"_rmips.hdr",doneCallback:ak})}}}}else{if(ab.IBLMap===null){ah=null;ad=null}}if(ab.envMap){if(ab.envMap instanceof M.Texture){Z++;this.ambience.setBackGroundMap({texture:ab.envMap,doneCallback:ak})}else{if(ab.envMap!==""){var aj=(o.getExtension(ab.envMap)==="dds");if(aj){if(!ag){Z++;this.ambience.setBackGroundMap({url:ab.envMap,hdr:true,mapping:new M.LatLongEnvMapping(),doneCallback:ak})}}else{Z++;this.ambience.setBackGroundMap({url:ab.envMap+".hdr",hdr:true,mapping:new M.LatLongEnvMapping(),doneCallback:ak})}}}}},setEnvMapBlur:function(Z){this.envMapBlur=Z;this.ambience.setEnvMapBlur(Z)},setEnvMapOffset:function(Z){},setEnvMapExposure:function(Z){this.envMapExposure=Z;this.ambience.setExposure(Z);if(this.sphereEnv&&this.sphereEnv.material&&this.sphereEnv.material.uniforms.envMapExposure){this.sphereEnv.material.uniforms.envMapExposure.value=Z}if(this.internalSceneGraph.scene.envMipMap[0]){this.internalSceneGraph.scene.envMipMap[0].envMapExposure=Z}},addReflectionProbe:function(ag,ac,Z,ah,af){var ad=this;var ae=M.ImageUtils.loadHDRTexture(ag+".hdr",new M.LatLongReflectionMapping(),af);ae.onLoadCallbacks.push(function(){ad.render()});ae.minFilter=M.NearestFilter;ae.magFilter=M.NearestFilter;ae.wrapS=M.RepeatWrapping;ae.wrapT=M.RepeatWrapping;var ab=M.ImageUtils.loadHDRTexture(ag+"_rmips.hdr",new M.LatLongReflectionMapping());ab.onLoadCallbacks.push(function(){ad.render()});ab.minFilter=M.NearestFilter;ab.magFilter=M.NearestFilter;ab.wrapS=M.RepeatWrapping;ab.wrapT=M.RepeatWrapping;var aa={map0:ae,map1:ab,position:ac,geomProxy:new M.Box3(Z,ah)};this.internalSceneGraph.scene.reflectionProbes.push(aa)},removeReflectionProbes:function(){this.internalSceneGraph.scene.reflectionProbes=[]},setEnvMapAmbient:function(Z){if(this.sphereEnv&&this.sphereEnv.material){this.sphereEnv.material.uniforms.ambient.value.copyGammaToLinear(Z)}},createEnvMap:function(ac,ah){if((this.envMap===null)&&!this.ambience.getBackground().getColors().length){return}var ad,Z,ae,ai,af=ah?ah.camera.position:this.currentViewpoint.camera.position;if(this.ambience!==null){this.ambience.updateSphere(ac,af);return}if(this.sphereEnv!==null){this.sphereEnv.scale.set(ac,ac,ac);this.sphereEnv.position.set(af.x,af.y,af.z);this.sphereEnv.updateMatrix();this.sphereEnv.visible=true;this.sphereEnv.visibilityFree=true;return}if(this.envMap===null){switch(this.gradientBackground.length){case 2:Z=M.GradientBackgroundShader2;break;case 3:Z=M.GradientBackgroundShader3;break;case 4:Z=M.GradientBackgroundShader4;break;default:return}}else{Z=M.CubeMapShader;var ak=null;if(this.envMap.mapping instanceof M.LightProbeEnvMapping){Z=M.LightProbeMapShader}else{if((this.envMap.mapping instanceof M.LatLongEnvMapping)||(this.envMap.mapping instanceof M.LatLongReflectionMapping)){Z=M.LatLongMapShader;this.envMap.wrapS=M.RepeatWrapping;this.envMap.wrapT=M.RepeatWrapping;if(this.envMap2){this.envMap2.wrapS=M.RepeatWrapping;this.envMap2.wrapT=M.RepeatWrapping}}else{if(!(this.envMap.mapping instanceof M.CubeEnvMapping)){var al;var aj;var ag=this.envMap.image.width/this.envMap.image.height;var aa=this.SCREEN_WIDTH/this.SCREEN_HEIGHT;var ar=0;var aq=0;if(this.envMap.mapping instanceof M.SimpleEnvMapping){al=this.SCREEN_WIDTH;aj=this.SCREEN_HEIGHT}else{if(this.envMap.mapping instanceof M.SimpleEnvMappingPreserveRatio){if(ag>aa){aj=this.SCREEN_HEIGHT;al=aj*ag}else{al=this.SCREEN_WIDTH;aj=al/ag}}else{if(this.envMap.mapping instanceof M.SimpleEnvMappingFit){if(ag>aa){al=this.SCREEN_WIDTH;aj=this.SCREEN_WIDTH/ag;aq=0.5*(this.SCREEN_HEIGHT-aj)}else{al=this.SCREEN_HEIGHT*ag;aj=this.SCREEN_HEIGHT;ar=0.5*(this.SCREEN_WIDTH-al)}}}}Z=M.SimpleMapShader;ak=M.UniformsUtils.clone(M.SimpleMapShader.uniforms);ak.offset.value.set((this.devicePixelRatio*ar),(this.devicePixelRatio*aq));ak.invSize.value.set(1/(this.devicePixelRatio*al),1/(this.devicePixelRatio*aj))}}}}if(Z.defines&&(Z.defines.sRGB!==undefined)){Z.defines.sRGB=!!this.envMap.sRGB}if(Z.defines&&(Z.defines.HDR!==undefined)){Z.defines.HDR=!!this.envMap.hdr}ae={fragmentShader:Z.fragmentShader,vertexShader:Z.vertexShader,uniforms:ak?ak:Z.uniforms,defines:Z.defines};if(Z.defines&&this.envMap2){Z.defines.ENVMAP2=true}ai=new M.ShaderMaterial(ae);ai.side=M.DoubleSide;ai.forceSide=true;ai.force=true;ai.depthTest=false;if(this.envMap&&this.envMap.hdr&&this.envMap.image){if(this.envMap.image.width){ai.uniforms.envMapHDRSize.value.x=parseInt(this.envMap.image.width);ai.uniforms.envMapHDRSize.value.y=parseInt(this.envMap.image.height)}else{var an=this;this.envMap.onLoadCallbacks.push(function(){ai.uniforms.envMapHDRSize.value.x=parseInt(an.envMap.image.width);ai.uniforms.envMapHDRSize.value.y=parseInt(an.envMap.image.height)})}}if(this.envMap===null){ai.uniforms.colors.value=[];var ap=ai.uniforms.colors.value;for(var ao=0;ao<this.gradientBackground.length;ao++){var am=this.gradientBackground[ao];ap.push(am.r);ap.push(am.g);ap.push(am.b)}}else{ai.uniforms.tEnvMap.value=this.envMap;if(this.envMap2){ai.uniforms.tEnvMap2.value=this.envMap2;ai.uniforms.blurCoef.value=this.envMapBlur}if(ai.uniforms.envMapExposure){ai.uniforms.envMapExposure.value=this.envMapExposure}if((this.envMap.mapping instanceof M.LatLongEnvMapping)||(this.envMap.mapping instanceof M.LatLongReflectionMapping)){ai.uniforms.offsetPhi.value=this.envMapOffset}}var ab=P.createSphereNode({radius:1,sag:64,material:ai});this.sphereEnv=ab._occurrences[0].renderable;this.sphereEnv.frustumCulled=false;this.sphereEnv.renderDepth=2;this.sphereEnv.scale.set(ac,ac,ac);this.sphereEnv.position.set(af.x,af.y,af.z);this.sphereEnv.updateMatrix();this.sphereEnv.visible=true;this.sphereEnv.visibilityFree=true;this.sceneBackground.add(this.sphereEnv)},removeEnvMap:function(){var Z=false;if(this.ambience.getBackground().isActivated()){Z=true;this.ambience.getBackground().setActivated(false)}if(this.sphereEnv!==null){this.sphereEnv.visible=false}return Z},updateBackgroundLights:function(){var ae=(this.internalSceneGraph===null)?this.temporaryEmptyScene:this.internalSceneGraph.scene;var aa=ae.__lights;var af=[];for(var ad=0;ad<aa.length;ad++){var ac=aa[ad];var ag=-1;if(ac.isVirtual){continue}for(var ab=0;ab<this.lights.length;ab++){if(this.lights[ab].fgLight===ac){ag=ab;break}}if(ag===-1){var Z=ac.clone();Z.castShadow=false;this.sceneBackground.add(Z);af.push({fgLight:ac,bgLight:Z})}else{var ai=this.lights[ag].bgLight;ac.clone(ai);ai.castShadow=false}}for(var ad=0;ad<af.length;ad++){var ah=af[ad];this.lights.push(ah)}},getSceneBoundingSphere:function(ab,aa){if(ab==="show"){console.warn("DEPRECATED: use visibleSpace instead of show");ab="visibleSpace"}if(ab==="noShow"){console.warn("DEPRECATED: use invisibleSpace instead of noShow");ab="invisibleSpace"}if(!this.internalSceneGraph){return aa?null:new M.Sphere()}var Z=this.internalSceneGraph.root;Z._tryOverridesUpdate(this);return this.internalSceneGraph.getBoundingSphere(ab,aa)},getSceneBoundingBox:function(aa){if(aa==="show"){console.warn("DEPRECATED: use visibleSpace instead of show");aa="visibleSpace"}if(aa==="noShow"){console.warn("DEPRECATED: use invisibleSpace instead of noShow");aa="invisibleSpace"}if(!this.internalSceneGraph){return new M.Box3()}var Z=this.internalSceneGraph.root;Z._tryOverridesUpdate(this);return Z._occurrences[0].getBoundingBox(aa)},computeSceneAccurateBoundingBox:function(ab,aa){if(!this.internalSceneGraph){return new M.Box3()}var Z=this.internalSceneGraph.root;Z._tryOverridesUpdate(this);return Z._occurrences[0].computeAccurateBoundingBox(ab,aa,0,0,[])},_updateNearFar:function(){var ao=this.trackingViewpoint?this.trackingViewpoint:this.currentViewpoint;var au=ao.camera;if(!au){return false}var ax=au.near;var an=au.far;var am=(this.internalSceneGraph===null)?new M.Sphere(new M.Vector3(0,0,0),100):this.getSceneBoundingSphere(this.visibleSpace?"visibleSpace":"invisibleSpace");if(!am){return false}var ai=0;if(am.pixelRadius>0){var ap=au.getWorldSizeFromPixelSize(1,am.center,this.div.clientHeight);if(typeof au.fullWidth!=="undefined"&&au.fullWidth>0){var aj=Math.max(au.width*1/au.fullWidth,au.height*1/au.fullHeight);ap*=aj}ai=ap*am.pixelRadius}this._updateOffsetPlane(am,au,false);var av=this._getPlaneSize(am,au,this.gridUnit,this.gridStep);if(av!==this.planeSize){this.planeSize=av}var ae=new M.Vector3().subVectors(am.center,au.position);var ak=new M.Vector3().subVectors(this.offsetPlaneBackground,au.position);var ac=au.getLookAt();var al=ae.dot(ac);var ag=ak.dot(ac);var ay=al;var aw=Math.PI*Math.max(0.1,0.5-this.dirLightLatitude);var ab=Math.sin(aw)+(Math.cos(aw)+1)/Math.tan(aw);var Z=(this._infinitePlane||this._displayGrid);if(Z){this.cameraBackgroundFar=Math.max(ag+this.planeSize,al+am.radius);if(this._nearFarBigScale){var at=new M.Sphere().copy(am);at.center.z-=am.radius;var aa=new M.Sphere();am.mergeWithSphere(at,aa);ae.subVectors(aa.center,au.position);ay=ae.dot(ac)}else{ae.z-=am.radius;ay=ae.dot(ac)}}this.cameraBackgroundNear=ag-this.planeSize;if(this._nearFarBigScale){this.cameraBackgroundNear=Math.max(this.cameraBackgroundNear,0.001)}if(this.ambience.getBackground().isActivated()&&!this._2DMode){if(this.ambience.isFiniteMode()){var aq=this.ambience.getRadiusEnvMap();var ah=ab*aq;this.cameraBackgroundFar=ay+ah;var ad=Math.max(ay-ah,0.001*this.cameraBackgroundFar);if(ad>this.cameraBackgroundNear){this.cameraBackgroundNear=ad}if(this.internalSceneGraph.scene.useFiniteEnvMap==false){this.internalSceneGraph.scene.useFiniteEnvMap=true;this.renderer&&this.renderer.recompileAllShaders()}this.internalSceneGraph.scene.parallaxCorrectionParameters.sphereCenter=this.ambience.getCenter();this.internalSceneGraph.scene.parallaxCorrectionParameters.sphereRadius=this.ambience.getRadius();this.internalSceneGraph.scene.parallaxCorrectionParameters.projectionCenter=this.ambience.getProjectionCenter()}else{if(this.internalSceneGraph.scene.useFiniteEnvMap==true){this.internalSceneGraph.scene.useFiniteEnvMap=false;this.renderer&&this.renderer.recompileAllShaders()}this.cameraBackgroundFar=Math.max(ag+this.planeSize,al+am.radius)}}var ar;if(this._nearFarBigScale){ar=ab*(Z?aa.radius+ai:am.radius+ai)}else{ar=ab*(am.radius+ai)}au.far=ay+ar;au.near=Math.max(ay-ar,0.001*au.far);if(this._nearFarBigScale){var af=ao.control.distanceToTarget;var az=Math.max(0,ay-ar);if(af>50){au.near=Math.min(Math.max(af/50,az),au.near)}else{au.near=Math.min(Math.max(0.1,az),au.near)}}if(au.isOrtho){au.near=ay-ar}else{if(au.far<0){au.near=5;au.far=50}}return(ax!==au.near||an!==au.far)},isShadowMap:function(){var ab=(this.internalSceneGraph===null)?this.temporaryEmptyScene:this.internalSceneGraph.scene;var Z=ab.__lights;for(var aa=0;aa<Z.length;aa++){if(Z[aa].isVirtual){continue}if(Z[aa].castShadow||Z[aa].castGroundShadow){return true}}return false},dispose:function(){disposedViewers.push(this.id);this.canvas.removeEventListener("webglcontextlost",this.onWebGLContextLost);this.canvas.removeEventListener("webglcontextrestored",this.onWebGLContextRestore);this.disposed=true;this.setDefaultPicking(false);if(this.infPlane){this.infPlane.dispose()}if(this.infPlaneSmall){this.infPlaneSmall.dispose()}if(this.grid){this.grid.dispose()}if(this.bigGrid){this.bigGrid.dispose()}if(this.internalSceneGraph){this.internalSceneGraph.dispose();this.internalSceneGraph=null}this.sceneBackground.dispose();this.sceneBackground=null;if(this.manipulatorManager){this.manipulatorManager._detachEvents();this.manipulatorManager=null}this.renderer.renderer.ambianceGenerators.dispose(this);for(var Z=0;Z<this.viewpoints.length;Z++){this.viewpoints[Z].setDefaultController(false);this.viewpoints[Z]._setNode(null)}this.materialManager.cleanAll();this.materialManager=null;this._userPassManager._dispose();if(this.renderer){this.renderer.dispose()}this.renderer=null;B.disconnectFrom(this.canvas);B._dispose();window.debugWebGLV6Viewer=null;if(this.div){if(this.canvas&&(this.div===this.canvas.parentNode)){this.div.removeChild(this.canvas)}if(this.divCssElement&&(this.div===this.divCssElement.parentNode)){this.div.removeChild(this.divCssElement)}if(this.divTrap&&(this.div===this.divTrap.parentNode)){this.div.removeChild(this.divTrap)}if(this.svgRootNode&&(this.div===this.svgRootNode.parentNode)){this.div.removeChild(this.svgRootNode)}}if(this.canvas.webGLV6Viewer){delete this.canvas.webGLV6Viewer}this.canvas=null;this.infPlane=null;this.infPlaneSmall=null;this.grid=null;this.bigGrid=null;this.sceneBackground=null;this.cameraBackground=null;this.ambientLight=null;this.directionalLight=null;this.directionalLight2=null;this.directionalLight3=null;this.dirLightGroundShadow=null;this.probeLight=null;this.lights=[];this.currentViewpoint=null;this.viewpoints=[];this.trackingViewpoint=null;this.materialManager=null;this.cameraReflected=null;this.renderer=null;this.debugPickingNode=null;this.debugNormalNode=null;this.temporaryEmptyScene=null;this._modelEvent.destroy();this.trapSelectionManipulator=null;this.clearThis()},setRenderFrameCB:function(Z,aa){this.renderFrameCB=Z;this.beginRenderFrameCB=aa},getCurrentSceneGraphState:function(){return this.sceneGraphState},getSceneGraphOverrideSetManager:function(){return this._sceneGraphOverrideSetManager},hasSceneGraphOverrideSet:function(){if(this.sceneGraphState||(this._sceneGraphOverrideSetManager&&this._sceneGraphOverrideSetManager.hasSceneGraphOverrideSet())){return true}else{return false}},getUserPassManager:function(){return this._getUserPassManager()},clearScene:function(aa,Z){this.empty(aa,Z)},empty:function(aa,Z){this.internalSceneGraph&&this.internalSceneGraph.clearScene(aa,Z,this._sceneGraph?"deprecated":undefined);if(aa){this.render({updateInfinitePlane:Z,needReframe:Z})}this.divCss2DElement.empty()},isEmpty:function(){if(this._sceneGraph){return this._sceneGraph._private_root.children.length===0}else{if(this.internalSceneGraph){return this.internalSceneGraph.userRoot.children.length===0}}},setDisableBackFaceCulling:function(Z){this.renderer.setDisableBackFaceCulling(Z)},setCameraSystem:function(Z){if(Z!==this.cameraSystem){this.cameraSystem=Z;this.renderer.clearCameraSystemData();this.cameraSystemUpdated=true}if(!Z){this.renderer.renderer.removeSplitScreenMode()}},set2DMode:function(Z){this._2DMode=Z;this._setBackgroundColor();this._updateGridDisplay();this._updateInfinitePlaneDisplay();this._updateShadowPlaneDisplay();if(this.currentViewpoint){this.currentViewpoint._set2DMode(Z)}this._updateSVGVisu()},get2DMode:function(Z){return this._2DMode},getCameraSystem:function(){return this.cameraSystem},_updateShaders:function(){this.internalSceneGraph&&this.internalSceneGraph.updateShaders()},_addRobot:function(aa,Z){Z.addRobotNode(aa)},addDebugPoint:function(Z,ac){var ad=P.createSphereNode({radius:3,material:new M.MeshBasicMaterial({color:ac,force:true,enableClipPlanes:false})});ad.setNoZ(true);var ab=P.createFixedSizeNode();ab.addChild(ad);this.internalSceneGraph.addDebugNode(ab);ab.setPickable(q.NODRAWHL);var ae=this;function aa(ag){var af=new M.Matrix4();if(ag instanceof Array){ag={x:ag[0],y:ag[1],z:ag[2]}}af.setPosition(ag);ab.setMatrix(af)}aa(Z);return{setPosition:function(af){aa(af)},remove:function(){ae.internalSceneGraph.removeDebugNode(ab)},add:function(){ae.internalSceneGraph.addDebugNode(ab)}}},restoreVisualizationMode:function(ak){var ae=0,ag=M.ShowAllFaces,ac=M.ShowAllRenderLineMode,ai=0;if(ak){if(ak.materialMode!==undefined&&ak.materialMode!==null){ae=ak.materialMode}if(ak.renderFaceMode!==undefined&&ak.renderFaceMode!==null){ag=ak.renderFaceMode}if(ak.renderLineMode!==undefined&&ak.renderLineMode!==null){ac=ak.renderLineMode}if(ak.displayHiddenEdges!==undefined&&ak.displayHiddenEdges!==null){ai=ak.displayHiddenEdges}}if(localStorage.getItem("materialMode")&&(localStorage.getItem("materialMode")==="BACKGROUND"||localStorage.getItem("materialMode")==="ZONLY")){var al=new g();al.setFaceMode(localStorage.getItem("materialMode"));this.setRenderStyle(al)}else{var aa=localStorage.getItem("materialMode")?parseInt(localStorage.getItem("materialMode"),10):ae;this.setMaterialMode(aa)}var ad=localStorage.getItem("renderFaceMode")?parseInt(localStorage.getItem("renderFaceMode"),10):ag;var Z=localStorage.getItem("renderLineMode")?parseInt(localStorage.getItem("renderLineMode"),10):ac;this._setInternalRenderFaceMode(ad);this._setInternalRenderLineMode(Z);var af=localStorage.getItem("displayHiddenEdges")?parseInt(localStorage.getItem("displayHiddenEdges"),10):ai;this.displayHiddenEdges(af);var ab=localStorage.getItem("axisState");if(ab){this.setAxisFilter(ab==="true")}var aj=localStorage.getItem("linesState");if(aj){this.setLinesFilter(aj==="true")}var ah=localStorage.getItem("pointsState");if(ah){this.setPointsFilter(ah==="true")}},restoreProjectionMode:function(){if(this.currentViewpoint&&localStorage.getItem("projectionMode")&&!this._2DMode){this.currentViewpoint.setProjectionType(parseInt(localStorage.getItem("projectionMode"),10))}},restoreAmbiance:function(){if(localStorage.getItem("visuEnv")){this.setVisuEnv(localStorage.getItem("visuEnv"))}else{this.setV6Ambience()}},setRobotAndRefAxisSystemEnabled:function(Z){this.internalSceneGraph.setRobotAndRefAxisSystemEnabled(Z)},getRobotAndRefAxisSystemEnabled:function(){var Z=this.getRobot();return Z&&Z._isEnabled()},setRenderPriority:function(Z){this.renderer.resetGSSOCache();if(Z&&this.getSectionCapping()){console.warn("Render priority mode is not compatible with section capping");return false}if(Z){this.setOIT(false)}if(!this._renderPriorityManager){this._renderPriorityManager=new k(this)}this._renderPriorityManager.setEnabled(Z);return true},getRenderPriority:function(){return(this._renderPriorityManager&&this._renderPriorityManager.enabled)?true:false},setRenderPriorityDefaultOpacity:function(Z){var aa=this.getRenderer();aa.renderPriorityDefaultOpacity=Z},_forceSceneMin:function(Z){this._forceSceneMinValue=Z},_addClippingPlane:function(Z){var aa=this.getRenderer();if(!Z.clippingContext){Z.clippingContext={}}if(!Z.clippingContext[aa.id]){Z.clippingContext[aa.id]={useCount:0}}if(aa===null){return false}if(!Z.upVector){Z.upVector=new M.Vector3(0,0,1)}Z.clippingContext[aa.id].useCount++;if(aa.clipPlanes.indexOf(Z)<0){aa.clipPlanes.push(Z);Z.clippingContext[aa.id].clippingPlaneAdded=true;if(!Z.clippingContext[aa.id].sectionCappingMaterial){this.setSectionCappingMaterial(Z,null)}else{this.renderer.resetClippingScene()}if(aa.clipPlanes.length===1){this.renderer.shadowPass.plugin.updateShaders();if(this.internalSceneGraph!==null){this.internalSceneGraph.updateShaders()}}if(this.directionalLight){this.directionalLight.updateShadowMap=true}}},_removeClippingPlane:function(aa){if(!aa||!aa.clippingContext){return}var ad=this.getRenderer();var ac=aa.clippingContext[ad.id];ac.useCount--;if(ac.useCount<=0){for(var ab=0;ab<ad.clipPlanes.length;ab++){var Z=ad.clipPlanes[ab];if(Z===aa){delete ac.clippingMeshIndex;delete ac.clippingPlaneAdded;this.renderer.resetClippingScene();ad.clipPlanes.splice(ab,1);if(!ad.clipPlanes.length){ad.clipPlanesEnabled=false}if(ad.clipPlanes.length===0){this.renderer.shadowPass.plugin.updateShaders();if(this.internalSceneGraph!==null){this.internalSceneGraph.updateShaders()}}if(this.directionalLight){this.directionalLight.updateShadowMap=true}return}}}},_addManipulator:function(Z,aa){this._manipulators[aa]=Z},_removeManipulator:function(Z){delete this._manipulators[Z]},_filterClippedIntersections:function(ac){var ab=[];var ae=this.getRenderer();var Z;if(ae.clipPlanesEnabled){Z=new m(ae.clipPlanes)}var ad;var aa=0,af,ag;for(aa=0;aa<ac.length;aa++){af=ac[aa];ad=af.object&&(Z||af.object._occurrence.clippingContext);if(!ad||!af.point||ad.isPointVisible(af.point)){ab.push(af)}}return ab},_getUserPassManager:function(){return this._userPassManager},_setInternalRenderFaceMode:function(Z){this.renderer.renderer.renderFaceMode=Z},_getInternalRenderFaceMode:function(){return this.renderer.renderer.renderFaceMode},_setInternalRenderLineMode:function(Z){this.renderer.renderer.renderLineMode=Z},_getInternalRenderLineMode:function(){return this.renderer.renderer.renderLineMode},_DEPRECATED_setRenderFooMode:function(Z){if(x<30){console.warn("[WebGLViewer] Deprecated setRenderLineMode/setRenderFaceMode method.\nUse setRenderMode() instead\n"+Z.stack)}}});Object.defineProperty(E.prototype,"backgroundColor",{get:function(){return(this.__tempBackgroundColorODT)}});Object.defineProperty(E.prototype,"sceneGraph",{get:function(){Q.DEPRECATED_SceneGraph(new Error(),true);return this.getRootNode()}});return UWA.namespace("THREEDS/WebGLViewer",E)});define("DS/Visualization/CGRReader",["DS/VisuLoaders/CGRReader"],function(a){return a});define("Visualization/CGRReader",["DS/Visualization/CGRReader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/CGRReader");return b});define("DS/Visualization/OBJReader",["DS/VisuLoaders/OBJReader"],function(a){return a});define("Visualization/OBJReader",["DS/Visualization/OBJReader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/OBJReader");return b});define("DS/Visualization/Measurable",["UWA/Class","DS/Visualization/ThreeJS_R57"],function(c,k){var e=6,j=7,h=7,b=4,q=6,o=7,m=8,l=[0,8,8,2,2],n=[0,2,2,1,2],g=new Uint8Array(4),a=new DataView(g.buffer,0,4),p=new Uint8Array(8),f=new DataView(p.buffer,0,8);var d=c.extend({init:function(s){this.sgNode=s;this.size=0;if(s.decoration){if(s.decoration instanceof Array){this.string=s.decoration;this.size=this.string[0]}else{if(s&&s.group&&s.group.geometry){if(s.group.geometry.decorations&&s.group.geometry.decorations.length){var r=s.group.geometry.decorations;var u=s.decoration-1;this.size=r[u]+1;this.string=new Array(this.size);for(var t=0;t<this.size;t++){this.string[t]=r[u++]}}else{this.string=[]}}}}else{this.string=[]}this.type=d.TYPEUNKNOWN;this.version=0;this.conversion=true},getType:function(){if(this.size>0){this.readHeader()}else{this.type=d.TYPEUNKNOWN}return this.type},readHeader:function(){var s=0;if(this.size>=l[3]){if(this.string[1]==0){if(this.size>=l[1]){var r=this.readInt(1,2);this.version=r[0];this.type=r[1];return}}else{if(this.string[1]=="2".charCodeAt(0)){this.version=2}else{if(this.string[1]=="3".charCodeAt(0)){this.version=3}else{if(this.string[1]=="4".charCodeAt(0)){this.version=4}}}s=this.string[2]}switch(s){case 49:this.type=d.TYPEUNKNOWN;break;case 50:this.type=d.TYPEPLANE;break;case 51:this.type=d.TYPECYLINDER;break;case 52:this.type=d.TYPECONE;break;case 53:this.type=d.TYPESPHERE;break;case 54:this.type=d.TYPELINE;break;case 55:this.type=d.TYPECIRCLE;break;case 56:this.type=d.TYPETORUS;break;default:break}}},getPlane:function(){if(this.type==d.TYPEPLANE){return this.readPlane()}return null},getCone:function(){if(this.type==d.TYPECONE){return this.readCone()}return null},getSphere:function(){if(this.type==d.TYPESPHERE){return this.readSphere()}return null},getCircle:function(){if(this.type==d.TYPECIRCLE){return this.readCircle()}return null},getCylinder:function(){if(this.type==d.TYPECYLINDER){return this.readCylinder()}return null},getLine:function(){if(this.type==d.TYPELINE){return this.readLine()}return null},getTorus:function(){if(this.type==d.TYPETORUS){return this.readTorus()}return null},readTorus:function(){var r=[0,0,0];var v=[0,0,1];var J=0;var F=0;var D=[];if(this.version==3){D=this.readFloat(l[this.version]+1,m);var I=D[0];var H=D[1];var G=D[2];var u=D[3];var t=D[4];var K=D[5];var E=D[6];var w=1-u*u-t*t;var s=(w>=0)?Math.sqrt(w):0;if(K<0){s=-s;K=-K}r=[I,H,G];v=[u,t,s];J=E;F=K}else{if(this.version==1||this.version==2||this.version==4){D=this.readDouble(l[this.version]+1,m);r=[D[0],D[1],D[2]];v=[D[3],D[4],D[5]];J=D[7];F=D[6]}}return{center:r,axis:v,maxRadius:F,minRadius:J}},readCone:function(){var r=[0,0,0];var v=[0,0,1];var I=0;var E=[];if(this.version==3){E=this.readFloat(l[this.version]+1,h);var H=E[0];var G=E[1];var F=E[2];var u=E[3];var t=E[4];var w=E[5];var D=1-u*u-t*t;var s=(D>=0)?Math.sqrt(D):0;if(w<0){s=-s;w=-w}var r=[H,G,F];var v=[u,t,s];var I=w}else{if(this.version==1||this.version==2||this.version==4){E=this.readDouble(l[this.version]+1,h);r=[E[0],E[1],E[2]];v=[E[3],E[4],E[5]];I=E[6]}}return{center:r,axis:v,semiAngle:I}},readCircle:function(){var r=[0,0,0];var t=[0,0,1];var y=0;var u=[];if(this.version==3){u=this.readFloat(l[this.version]+1,o);r=[u[0],u[1],u[2]];y=u[3];var s=this.sgNode.start;var A=this.sgNode.group.geometry;var x=A.vertexIndexArray[s];var B=[A.vertexPositionArray[x*3],A.vertexPositionArray[x*3+1],A.vertexPositionArray[x*3+2]];var x=A.vertexIndexArray[s+1];var z=[A.vertexPositionArray[x*3],A.vertexPositionArray[x*3+1],A.vertexPositionArray[x*3+2]];var w=new k.Vector3(B[0],B[1],B[2]);var v=new k.Vector3(z[0],z[1],z[2]);var C=new k.Vector3(r[0],r[1],r[2]);v.sub(w);C.sub(w);v.cross(C);v.normalize();t=[v.x,v.y,v.z]}else{if(this.version==1||this.version==2||this.version==4){u=this.readDouble(l[this.version]+1,o);r=[u[0],u[1],u[2]];t=[u[3],u[4],u[5]];y=u[6]}}return{center:r,axis:t,radius:y}},readCylinder:function(){var r=[0,0,0];var v=[0,0,1];var E=0;var D=[];if(this.version==3){D=this.readFloat(l[this.version]+1,j);var H=D[0];var G=D[1];var F=D[2];var u=D[3];var t=D[4];E=D[5];var w=1-u*u-t*t;var s=(w>=0)?Math.sqrt(w):0;if(E<0){s=-s;E=-E}r=[H,G,F];v=[u,t,s]}else{if(this.version==1||this.version==2||this.version==4){D=this.readDouble(l[this.version]+1,j);r=[D[0],D[1],D[2]];v=[D[3],D[4],D[5]];E=D[6]}}return{center:r,axis:v,radius:E}},readSphere:function(){var t=[0,0,0];var s=0;var u=[];if(this.version==3){u=this.readFloat(l[this.version]+1,b);var r=u[0];var w=u[1];var v=u[2];s=u[3];t=[r,w,v]}else{if(this.version==1||this.version==2||this.version==4){u=this.readDouble(l[this.version]+1,b);t=[u[0],u[1],u[2]];s=u[3]}}return{center:t,radius:s}},readLine:function(){var s=[0,0,0];var t=[1,0,0];var r=[];if(this.version==3){var w=this.sgNode.start;var u=this.sgNode.group.geometry;var v=u.vertexIndexArray[w];s=[u.vertexPositionArray[v*3],u.vertexPositionArray[v*3+1],u.vertexPositionArray[v*3+2]];var v=u.vertexIndexArray[w+1];t=[u.vertexPositionArray[v*3],u.vertexPositionArray[v*3+1],u.vertexPositionArray[v*3+2]]}else{if(this.version==1||this.version==2||this.version==4){r=this.readDouble(l[this.version]+1,q);s=[r[0],r[1],r[2]];t=[r[3],r[4],r[5]]}}return{startPosition:s,endPosition:t}},readPlane:function(){var r=[0,0,0];var t=[1,0,0];var s=[];if(this.version==3){var w=this.sgNode.start;var u=this.sgNode.group.geometry;var v=u.vertexIndexArray[w];r=[u.vertexPositionArray[v*3],u.vertexPositionArray[v*3+1],u.vertexPositionArray[v*3+2]];t=[u.vertexNormalArray[v*3],u.vertexNormalArray[v*3+1],u.vertexNormalArray[v*3+2]]}else{if(this.version==1||this.version==2||this.version==4){s=this.readDouble(l[this.version]+1,e);r=[s[0],s[1],s[2]];t=[s[3],s[4],s[5]]}}return{normal:t,position:r}},readFloat:function(u,t){var r=new Array(t);for(var s=0;s<t;s++){g[3]=this.string[u+s*4];g[2]=this.string[u+s*4+1];g[1]=this.string[u+s*4+2];g[0]=this.string[u+s*4+3];r[s]=a.getFloat32(0,this.conversion)}return r},readInt:function(u,s){var r=new Array(s);for(var t=0;t<s;t++){g[3]=this.string[u+t*4];g[2]=this.string[u+t*4+1];g[1]=this.string[u+t*4+2];g[0]=this.string[u+t*4+3];r[t]=a.getUint32(0,this.conversion)}return r},readDouble:function(u,t){var r=new Array(t);for(var s=0;s<t;s++){p[7]=this.string[u+s*8];p[6]=this.string[u+s*8+1];p[5]=this.string[u+s*8+2];p[4]=this.string[u+s*8+3];p[3]=this.string[u+s*8+4];p[2]=this.string[u+s*8+5];p[1]=this.string[u+s*8+6];p[0]=this.string[u+s*8+7];r[s]=f.getFloat64(0,this.conversion)}return r}});d.TYPEUNKNOWN=1;d.TYPEPLANE=2;d.TYPECYLINDER=3;d.TYPECONE=4;d.TYPESPHERE=5;d.TYPELINE=7;d.TYPECIRCLE=8;d.TYPETORUS=9;return UWA.namespace("THREEDS/Measurable",d)});define("Visualization/Measurable",["DS/Visualization/Measurable","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/Measurable");return b});(function(){var a=window.location.protocol!=="file:"?"text!Visualization/assets/svgmode.json":null;define("DS/Visualization/GetSVGMode",[a],function(c){var b=c&&JSON.parse(c);return{getWebGLMode:function(){return((b&&b.svgMode==="svg")||window.v6ViewerSVGBrowserMode)?false:true}}})})();define("DS/Visualization/SceneGraphConverter",["DS/VisuLoaders/SceneGraphConverter"],function(a){return a});define("Visualization/SceneGraphConverter",["DS/Visualization/SceneGraphConverter","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/SceneGraphConverter");return b});define("DS/Visualization/OccurrenceRenderingOverride",["UWA/Class","DS/Visualization/ThreeJS_R57"],function(b,d){var a;var e=function(g,h){this.id=a.getNewId();if(h instanceof e){this.materialOverride=h.materialOverride}else{this.materialOverride=h}this.opacity=g.opacity;this.renderPriorityActivated=false};e.prototype.getOpacity=function(){return this.materialOverride?this.materialOverride.getOpacity():null};e.prototype.getColor=function(){return this.materialOverride?this.materialOverride.getColor():null};e.prototype.getFullMaterial=function(){return this.materialOverride?this.materialOverride.getFullMaterial():null};e.prototype.clone=function(){var g=new e({opacity:this.opacity},this.materialOverride);return g};e.prototype.getRenderPriorityOpacity=function(){return this.opacity===null?null:this.opacity};e.prototype.hasTransparency=function(){var g=this.getOpacity();return g!==null&&g<1};var c=0;var f=b.extend({init:function(){this.id=c++;this.clipPlanes=[];this.clippingSettings=null;this.clipPolyLine=null;this.materialOverride=null;this.sectionCappingMaterials=null;this.readOnly=false;this.sectionLinesProperties=null;window.sealWebVisuObjects&&Object.seal(this)},clone:function(){var g=new f();g.clipPlanes=this.clipPlanes;g.clippingSettings=this.clippingSettings;g.clipPolyLine=this.clipPolyLine;g.sectionLinesProperties=this.sectionLinesProperties;if(this.materialOverride instanceof e){g.materialOverride=this.materialOverride.clone()}else{g.materialOverride=this.materialOverride}return g},getFullMaterial:function(){return this.materialOverride&&this.materialOverride.getFullMaterial()},setReadOnly:function(){this.readOnly=true},setRenderPriority:function(g){if(g&&g.opacity!==null){this.materialOverride=new e(g,this.materialOverride)}},getOverrideColor:function(h){if(!this.materialOverride){return null}if(h&&!h.overridable){return h.overridable}var g=this.getFullMaterial();if(g&&!g.overridable){return g.color}var j=this.materialOverride.getColor();if(j!==0&&j){return new d.Color(j)}return null}});f.setOverrideLink2Class=function(g){a=g};return f});define("Visualization/OccurrenceRenderingOverride",["DS/Visualization/OccurrenceRenderingOverride","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/OccurrenceRenderingOverride");return b});define("DS/Visualization/ParticlesLoader",["DS/VisuLoaders/ParticlesLoader"],function(a){return a});define("Visualization/ParticlesLoader",["DS/Visualization/ParticlesLoader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/ParticlesLoader");return b});define("DS/Visualization/FixedSizeArrayPool",function(a){var a=function(){this.bySizePools={};this.pool5=this.bySizePools[5]={list:[],nextAvailable:0,lastCount:0};this.timerClean=undefined};a.prototype.makeArraysReusable=function(){var d;for(d in this.bySizePools){var e=this.bySizePools[d];var f=parseInt(d);for(var c=e.nextAvailable;c<e.lastCount;++c){for(var b=0;b<f;++b){e.list[c][b]=undefined}}e.lastCount=e.nextAvailable}for(d in this.bySizePools){this.bySizePools[d].nextAvailable=0}};a.prototype.get2=function(d,c){var f=this.bySizePools[2];if(!f){f={list:[],nextAvailable:0,lastCount:0};this.bySizePools[2]=f}var g,e;if(f.list.length>f.nextAvailable){g=f.list[f.nextAvailable++];g[0]=d;g[1]=c}else{g={0:d,1:c,next:null};f.list.push(g);f.nextAvailable++}return g};a.prototype.get5=function(g,f,n,m,l){var j=this.pool5;var k,h;if(j.list.length>j.nextAvailable){k=j.list[j.nextAvailable++];k[0]=g;k[1]=f;k[2]=n;k[3]=m;k[4]=l}else{k={0:g,1:f,2:n,3:m,4:l,next:null};j.list.push(k);j.nextAvailable++}return k};return a});define("Visualization/FixedSizeArrayPool",["DS/Visualization/FixedSizeArrayPool","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/FixedSizeArrayPool");return b});define("DS/Visualization/SectionBuilder",["UWA/Class","DS/Mesh/Mesh"],function(b,e){var d=function(j,k){var h=j.length;var l=k;while(l<h){j[l]=j[l+1];l++}j.length--};var a=function(j,k,n){var h=j.length;var o=k;var m;var l=n;do{m=j[o];j[o]=l;l=m;o++}while(o<=h)};var g=function(j,n,m){var l=n[0];var k=n[1];var h=m[0];var o=m[1];if(j[3*l]<j[3*h]){return -1}else{if(j[3*l]>j[3*h]){return 1}else{if(j[3*l+1]<j[3*h+1]){return -1}else{if(j[3*l+1]>j[3*h+1]){return 1}else{if(j[3*l+2]<j[3*h+2]){return -1}else{if(j[3*l+2]>j[3*h+2]){return 1}else{if(j[3*k]<j[3*o]){return -1}else{if(j[3*k]>j[3*o]){return 1}else{if(j[3*k+1]<j[3*o+1]){return -1}else{if(j[3*k+1]>j[3*o+1]){return 1}else{if(j[3*k+2]<j[3*o+2]){return -1}else{if(j[3*k+2]>j[3*o+2]){return 1}else{return 0}}}}}}}}}}}}};var f=function(j){var h=1;while(h<j){h*=2}return h};var c=b.extend({init:function(k,j,h){this.lineWidth=h||1;this.wide=this.lineWidth>1?true:false;this._renderable=k;this.resetBuffers();this.renderer=j;this.sectionLineGeometry=null},resetBuffers:function(){this.indexArray=null;this.currentsArray=null;this.edgeLastIndexArray=null;this._Id=0;this._edgeId=0;this.halfEdges=[];this.halfEdgesStructure=null;this._positionArray=null},allocateArrays:function(j){if(this.wide){this.indexArray=new Uint32Array(3*j*2);var h=6*j;this.currentsArray=new Float32Array(h*2);this.edgeLastIndexArray=new Float32Array(6*j*2)}else{this.indexArray=new Uint32Array(j*2);var h=6*j;this.currentsArray=new Float32Array(h);this.edgeLastIndexArray=new Float32Array(6*j)}},addEdgeIndices:function(l,k,j){var r=this.indexArray;var s=this.currentsArray;var q=this.edgeLastIndexArray;var h=this._edgeId;if(this.wide){var p=h*4;var o=h*4+1;var n=h*4+2;var m=h*4+3;r[h*6]=p;r[h*6+1]=n;r[h*6+2]=m;r[h*6+3]=p;r[h*6+4]=m;r[h*6+5]=o;s[2*6*h]=l;s[2*6*h+1]=k;s[2*6*h+2]=j;s[2*6*h+3]=l;s[2*6*h+3+1]=k;s[2*6*h+3+2]=j;s[2*6*h+6]=k;s[2*6*h+6+1]=j;s[2*6*h+6+2]=l;s[2*6*h+9]=k;s[2*6*h+9+1]=j;s[2*6*h+9+2]=l;q[2*6*h]=+1;q[2*6*h+1]=+1;q[2*6*h+2]=0;q[2*6*h+3]=+1;q[2*6*h+3+1]=-1;q[2*6*h+3+2]=0;q[2*6*h+6]=-1;q[2*6*h+6+1]=+1;q[2*6*h+6+2]=0;q[2*6*h+9]=-1;q[2*6*h+9+1]=-1;q[2*6*h+9+2]=0}else{r[h*2]=h*2;r[h*2+1]=h*2+1;s[6*h]=l;s[6*h+1]=k;s[6*h+2]=j;s[6*h+3]=k;s[6*h+4]=j;s[6*h+5]=l;q[6*h]=+1;q[6*h+1]=0;q[6*h+2]=0;q[6*h+3]=-1;q[6*h+4]=0;q[6*h+5]=0}this._edgeId++},processTriangleIndices:function(k,j,h,l){this.addEdgeIndices(k,j,h);this.addEdgeIndices(j,h,k);this.addEdgeIndices(h,k,j)},computeSectionLineGeometry:function(G){var L=THREEDS.Core;var l,D;var z,x,u;var v=this._renderable;var s=[];var y=0;var E=0;if(!v.layer){s=v.geometry;var q=v.geometry.length;for(var F=0;F<q;F++){var w=v.geometry[F];y+=w.drawingGroups.length;for(var K=0;K<w.drawingGroups.length;K++){var I=w.drawingGroups[K];E+=(I._geomType===L.GeomTypeEnum.FACE)?I.count:0}}}else{var t={};for(var F=0;F<v.layer.layers.length;F++){var I=v.layer.layers[F].drawableGroup;var J=v.layer.layers[F].drawableInterval;if(J.layerNum<1){continue}t[I.geometry.id]=I.geometry;E+=(I._geomType===L.GeomTypeEnum.FACE)?J.count:0}for(var F in t){s.push(t[F])}}if(E===0){return null}this.allocateArrays(E);var r;var n=0;var m=0;var p=[];var M=[];for(var F=0;F<s.length;F++){p[F]=n;M[F]=m;n+=s[F].vertexIndexArray.length;m+=s[F].vertexPositionArray.length}if(s.length===1){l=s[0].vertexIndexArray;D=s[0].vertexPositionArray}else{l=new Uint32Array(n);D=new Float32Array(m);var C=0;var H=0;for(var F=0;F<s.length;F++){var h=s[F];for(var B=0;B<h.vertexIndexArray.length;B++){l[C]=(M[F]/3)+h.vertexIndexArray[B];C++}for(var B=0;B<h.vertexPositionArray.length;B++){D[H]=h.vertexPositionArray[B];H++}}}this.halfEdgesStructure={};r=l.length;this.maxIndices=r;this._positionArray=D;if(!v.layer){var q=s.length;for(var F=0;F<q;F++){var w=s[F];for(var K=0;K<w.drawingGroups.length;K++){var I=w.drawingGroups[K];if(I._geomType===L.GeomTypeEnum.FACE){for(var A=p[F]+I.start;A<p[F]+I.start+I.count;A+=3){z=l[A];x=l[A+1];u=l[A+2];if(!(z===x||x===u||z===u)){this.processTriangleIndices(z,x,u,r)}}}}}}else{for(var F=0;F<v.layer.layers.length;F++){var I=v.layer.layers[F].drawableGroup;var J=v.layer.layers[F].drawableInterval;if(J.layerNum<1){continue}if(I._geomType===L.GeomTypeEnum.FACE){var o=s.indexOf(I.geometry);for(var A=p[o]+J.start;A<p[o]+J.start+J.count;A+=3){z=l[A];x=l[A+1];u=l[A+2];if(!(z===x||x===u||z===u)){this.processTriangleIndices(z,x,u,r)}}}}}this.sectionLineGeometry=this.createNewGeometry();this.resetBuffers()},createNewGeometry:function(p){var G=THREEDS.Core;var n=this.indexArray.length;var x;var D=["uniform sampler2D outlinePositionMaps[NB_OUTLINE_MAPS];","uniform int currentClipPlane;",].join("\n");var o=["float getDist(vec4 pos) {","  vec4 clipPlaneEquation = clipPlaneEquations[currentClipPlane];","  float dist = dot( pos.xyz, clipPlaneEquation.xyz ) + clipPlaneEquation.w;","  return dist;","}","vec4 getIntersection( vec4 M, vec4 N) {","  vec4 clipPlaneEquation = clipPlaneEquations[currentClipPlane];","  vec3 direction = vec3(N.x - M.x, N.y - M.y, N.z - M.z);","  vec4 result;","  float t;","  float denominator = dot(direction, clipPlaneEquation.xyz);","  if(denominator == 0.0) {","    return M;","  } else {","    t = -(dot(M.xyz, clipPlaneEquation.xyz) + clipPlaneEquation.w) / denominator;","    result = vec4(t*direction+M.xyz, 1.0);","    return result;","  }","}","float far;","float near;"].join("\n");var k=["vec4 mvPosition = mvCurrInter;","  gl_Position = projectionMatrix * mvCurrInter;","if(hide) {","  gl_Position.z = 10000000.0 * far;","}"].join("\n");var A=["float i1 = position.x;","float i2 = position.y;","float i3 = position.z;","float ori = uv.x;","float maxMapTotalSize = MAX_OUTLINE_MAP_SIZE*MAX_OUTLINE_MAP_SIZE;","int texId_1 = int(floor(i1/maxMapTotalSize));","int texId_2 = int(floor(i2/maxMapTotalSize));","int texId_3 = int(floor(i3/maxMapTotalSize));","float dx_1, dx_2, dx_3;","float dy_1, dy_2, dy_3;","float x_1, x_2, x_3;","float y_1, y_2, y_3;","float idInTexture_1 = i1 - float(texId_1)*maxMapTotalSize;","float idInTexture_2 = i2 - float(texId_2)*maxMapTotalSize;","float idInTexture_3 = i3 - float(texId_3)*maxMapTotalSize;","if (texId_1 == NB_OUTLINE_MAPS - 1) {","dx_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_1 = floor(idInTexture_1/LAST_OUTLINE_MAP_SIZE_X);","x_1 = idInTexture_1 - y_1*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_1 = floor(idInTexture_1/MAX_OUTLINE_MAP_SIZE);","x_1 = idInTexture_1 - y_1*MAX_OUTLINE_MAP_SIZE;","}","if (texId_2 == NB_OUTLINE_MAPS - 1) {","dx_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_2 = floor(idInTexture_2/LAST_OUTLINE_MAP_SIZE_X);","x_2 = idInTexture_2 - y_2*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_2 = floor(idInTexture_2/MAX_OUTLINE_MAP_SIZE);","x_2 = idInTexture_2 - y_2*MAX_OUTLINE_MAP_SIZE;","}","if (texId_3 == NB_OUTLINE_MAPS - 1) {","dx_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_3 = floor(idInTexture_3/LAST_OUTLINE_MAP_SIZE_X);","x_3 = idInTexture_3 - y_3*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_3 = floor(idInTexture_3/MAX_OUTLINE_MAP_SIZE);","x_3 = idInTexture_3 - y_3*MAX_OUTLINE_MAP_SIZE;","}","vec3 P = texture2D( outlinePositionMaps[texId_1], vec2( dx_1 * ( x_1 + 0.5 ), dy_1 * ( y_1 + 0.5 ) ) ).xyz;","vec3 M = texture2D( outlinePositionMaps[texId_2], vec2( dx_2 * ( x_2 + 0.5 ), dy_2 * ( y_2 + 0.5 ) ) ).xyz;","vec3 N = texture2D( outlinePositionMaps[texId_3], vec2( dx_3 * ( x_3 + 0.5 ), dy_3 * ( y_3 + 0.5 ) ) ).xyz;","float m22 = projectionMatrix[2][2];","float m32 = projectionMatrix[3][2];","bool isPersp = projectionMatrix[2][3] == -1.0;","if (isPersp) {","near = m32 / (m22 - 1.0);","far = ((m22 - 1.0)*near)/(m22 + 1.0);","} else {","near = (m32+1.0)/m22;","far = near - 2.0/m22;","}",].join("\n");if(this.wide){x=new G.ShaderMaterialDS({uniforms:G.UniformsUtils.merge([{outlinePositionMaps:{type:"tv",value:null},currentClipPlane:{type:"i",value:0},sectionLineHalfWidth:{type:"f",value:0.5*this.lineWidth},pixelSize:{type:"v2",value:new G.Vector2()},color:{type:"c",value:new G.Color(0)}},G.UniformsLib.clipPlanes,]),vertexShaderPars:[G.ShaderChunk.clip_pars_vertex,D,"uniform vec2 pixelSize;","uniform float sectionLineHalfWidth;","varying vec2 screenCurr;","varying vec2 screenOpp;",o,"float linearizeNDC(in float iNonLinearNDC) {","	float z01 = 0.5*iNonLinearNDC + 0.5;","	float res = 2.0*near/(far + near - z01*(far - near));","	res = res *2.0 - 1.0;","	return res;","}",].join("\n"),vertexShaderBody:[A,G._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvP","vec4(P,1.0)"),G._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvM","vec4(M,1.0)"),G._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvN","vec4(N,1.0)"),"vec4 mvCurrInter = mvP;","vec4 mvOtherInter = mvM;","bool hide = true;","if (ori > 0.0 && getDist(mvP) > 0.0 && getDist(mvM) < 0.0) {","  mvCurrInter = getIntersection(mvP, mvM);","  if(getDist(mvN) > 0.0) {","    mvOtherInter = getIntersection(mvM, mvN);","  } else {","    mvOtherInter = getIntersection(mvN, mvP);","  }","  hide = false;","}","if (ori < 0.0 && getDist(mvP) < 0.0 && getDist(mvN) > 0.0) {","  if(getDist(mvM) < 0.0) {","    mvCurrInter = getIntersection(mvM, mvN);","  } else {","    mvCurrInter = getIntersection(mvM, mvP);","  }","  mvOtherInter = getIntersection(mvN, mvP);","  hide = false;","}","vec4 mvpCurr = projectionMatrix*vec4(mvCurrInter.xyz,1.0);","vec4 mvpOpp = projectionMatrix*vec4(mvOtherInter.xyz,1.0);","screenCurr = (mvpCurr.xy / mvpCurr.w + 1.0) / pixelSize;","screenOpp = (mvpOpp.xy / mvpOpp.w + 1.0) / pixelSize;","vec4 mvPosition = mvCurrInter;","vec3 ndcCurr = mvpCurr.xyz/mvpCurr.w;","vec3 ndcOpp = mvpOpp.xyz/mvpOpp.w;","float sideExtrusion = uv.y*ori;","float offset = sign(sideExtrusion) * sectionLineHalfWidth;","vec2 line = normalize(screenOpp - screenCurr);","vec2 lineNormal = vec2(-line.y, line.x);","vec2 ptAlongLine = screenCurr - sectionLineHalfWidth*line;","vec2 ndcPtAlongLine = ptAlongLine*pixelSize - 1.0;","float ndcD = length(ndcCurr.xy - ndcPtAlongLine);","float lengthCurrOpp = length(ndcCurr.xy - ndcOpp.xy);","float ndcZDelta = ndcD*abs(ndcCurr.z-ndcOpp.z)/lengthCurrOpp;","float ndcZDeltaLin = ndcD*abs(linearizeNDC(ndcCurr.z)-linearizeNDC(ndcOpp.z))/lengthCurrOpp;","vec2 px_pos;","if (ndcZDeltaLin > 0.7*ndcD) {","px_pos = screenCurr + offset*lineNormal;","ndcZDelta = 0.0;","} else {","px_pos = screenCurr + offset*lineNormal - sectionLineHalfWidth*line;","}","ndcZDelta *= sign(ndcCurr.z - ndcOpp.z);","float ndcFinalZ = mvpCurr.z/mvpCurr.w + ndcZDelta;","vec3 ndcPos = vec3((px_pos*pixelSize - 1.0), ndcFinalZ);","if (ori < 0.0) {","vec2 tmp = screenCurr;","screenCurr = screenOpp;","screenOpp = tmp;","}","vec4 clipSpacePos = vec4(ndcPos*mvpCurr.w, mvpCurr.w);","gl_Position = clipSpacePos;","if(hide) {","  gl_Position.z = 10000000.0 * far;","}",G.ShaderChunk.clip_vertex].join("\n"),fragmentShaderPars:["varying vec2 screenCurr;","varying vec2 screenOpp;","uniform float sectionLineHalfWidth;","uniform vec3 color;",G.ShaderChunk.clip_pars_fragment].join("\n"),fragmentShaderBody:[G.ShaderChunk.clip_fragment,"gl_FragColor = vec4(color, 1.0);","vec2 fCoord = gl_FragCoord.xy;","vec2 currOpp = screenOpp - screenCurr;","vec2 currFcoord = fCoord - screenCurr;","vec2 oppFcoord = fCoord - screenOpp;","bool toDiscard = false;","if (dot(currOpp, currFcoord ) < 0.0) {","if (length(currFcoord) > sectionLineHalfWidth) toDiscard = true;","} else if (dot(-currOpp, oppFcoord ) < 0.0) {","if (length(oppFcoord) > sectionLineHalfWidth) toDiscard = true;","} ","if (toDiscard) discard;"].join("\n")})}else{x=new G.ShaderMaterialDS({uniforms:G.UniformsUtils.merge([{outlinePositionMaps:{type:"tv",value:null},currentClipPlane:{type:"i",value:0},color:{type:"c",value:new G.Color(0)}},G.UniformsLib.clipPlanes,]),vertexShaderPars:[G.ShaderChunk.clip_pars_vertex,D,o,].join("\n"),vertexShaderBody:[A,G._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvP","vec4(P,1.0)"),G._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvM","vec4(M,1.0)"),G._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvN","vec4(N,1.0)"),"vec4 mvCurrInter = mvP;","bool hide = true;","if (ori > 0.0 && getDist(mvP) > 0.0 && getDist(mvM) < 0.0) {","  mvCurrInter = getIntersection(mvP, mvM);","  hide = false;","}","if (ori < 0.0 && getDist(mvP) < 0.0 && getDist(mvN) > 0.0) {","  if(getDist(mvM) < 0.0) {","    mvCurrInter = getIntersection(mvM, mvN);","  } else {","    mvCurrInter = getIntersection(mvM, mvP);","  }","  hide = false;","}",k,G.ShaderChunk.clip_vertex].join("\n"),fragmentShaderPars:["uniform vec3 color;",G.ShaderChunk.clip_pars_fragment].join("\n"),fragmentShaderBody:[G.ShaderChunk.clip_fragment,"gl_FragColor = vec4(color, 1.0);"].join("\n")})}if(this.wide){x.refreshUniforms=function(I,t,H){x.uniforms.pixelSize.value.x=2/I.domElement.width;x.uniforms.pixelSize.value.y=2/I.domElement.height}}x.force=true;x.enableClipPlanes=true;x.side=G.DoubleSide;x.polygonOffset=true;var E=new e.DrawingGroup(x,x,this.wide?4:1,0,n);var B=new G.BufferGeometryDS();B.drawingGroups=[];E.geometry=B;B.drawingGroups.push(E);B.vertexPositionArray=this.currentsArray;B.vertexUvArray=this.edgeLastIndexArray;B.vertexIndexArray=this.indexArray;B.boundingSphere=this._renderable.boundingSphere;B.boundingBox=this._renderable.boundingBox;var j=[];var C=debugWebGLV6Viewer.renderer.renderer.context;var F=C.getParameter(C.MAX_TEXTURE_SIZE);var u=F*F;var l=this._positionArray.length/3;var q=Math.ceil(l/u);var h=(l-Math.floor(l/u)*u);var r=Math.sqrt(h);var w=f(r);var v=f(h/w);var z=((q-1)*u+w*v)*3;var s=new Float32Array(z);s.set(this._positionArray);for(var y=0;y<q-1;y++){var m=new G.DataTexture(s.subarray(y*u*3,(y+1)*u*3),F,F,G.RGBFormat,G.FloatType);m.minFilter=G.NearestFilter;m.magFilter=G.NearestFilter;m.generateMipmaps=false;m.flipY=false;m.needsUpdate=true;j.push(m)}var m=new G.DataTexture(s.subarray((q-1)*u*3,z),w,v,G.RGBFormat,G.FloatType);m.minFilter=G.NearestFilter;m.magFilter=G.NearestFilter;m.generateMipmaps=false;m.flipY=false;m.needsUpdate=true;j.push(m);x.uniforms.outlinePositionMaps.value=j;x.defines={NB_OUTLINE_MAPS:q,MAX_OUTLINE_MAP_SIZE:F.toFixed(1),LAST_OUTLINE_MAP_SIZE_X:w.toFixed(1),LAST_OUTLINE_MAP_SIZE_Y:v.toFixed(1)};return B}});return c});define("DS/Visualization/OccurrencePath",["UWA/Class"],function(a){var b=a.extend({init:function(c){this.path=[];this.setFromArray(c)},getSize:function(){return this.path.length},getNodeName:function(c){if((c<0)||(c>=this.path.length)){return null}return this.path[c]},add:function(c){this.path.push(c)},setFromArray:function(c){var d;if((c!==undefined)&&(c instanceof Array)){for(d=0;d<c.length;d++){if(c[d]!==""){this.path.push(c[d])}}}},isEqual:function(c){var d;if(this.path.length!==c.path.length){return false}for(d=0;d<c.path.length;d++){if(this.path[d]!==c.path[d]){return false}}return true},isIncludedIn:function(c){var g=false,f,e,d;for(e=0;e<this.path.length;e++){f=this.path[e];g=false;for(d=0;d<c.path.length;d++){if(f===c.path[d]){g=true;break}}if(!g){return false}}return true}});return UWA.namespace("THREEDS/OccurrencePath",b)});define("Visualization/OccurrencePath",["DS/Visualization/OccurrencePath","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/OccurrencePath");return b});define("DS/Visualization/ThreeDXLoader",["DS/VisuLoaders/ThreeDXLoader"],function(a){return a});define("DS/Visualization/ThreeJS_R57",["DS/Mesh/ThreeJS_Base","DS/Visualization/FixedSizeArrayPool","DS/Visualization/SessionNodesWithSectionProfile","DS/Visualization/OutlineBuilder","DS/Visualization/SectionBuilder","UWA/Data"],function(s,d,k,c,r,f){var a={};a.FrontSide=0;a.BackSide=1;a.DoubleSide=2;a.BoundaryPointRenderPointMask=s.GeomTypeEnum.BOUNDARY_POINT;a.SharpPointRenderPointMask=s.GeomTypeEnum.SHARP_POINT;a.SmoothPointRenderPointMask=s.GeomTypeEnum.SMOOTH_POINT;a.SurfacicPointRenderPointMask=s.GeomTypeEnum.SURFACIC_POINT;a.FreePointRenderPointMask=s.GeomTypeEnum.FREE_POINT;a.AllPointsRenderPointMask=a.BoundaryPointRenderPointMask|a.SharpPointRenderPointMask|a.SmoothPointRenderPointMask|a.SurfacicPointRenderPointMask|a.FreePointRenderPointMask;a.AllPointsButSurfacicPointsRenderPointMask=a.BoundaryPointRenderPointMask|a.SharpPointRenderPointMask|a.SmoothPointRenderPointMask|a.FreePointRenderPointMask;a.vertexComponentBits={POSITION:1,NORMAL:2,UV:4,UV2:8,COLOR:16,TANGENT:32,BINORMAL:64,PREVIOUSPOS:128,NEXTPOS:256,SIDEEXTR:512,LINEDIST:1024,SKININDEX:2048,SKINWEIGHT:4096};s.Constants=a;s.FrontSide=0;s.BackSide=1;s.DoubleSide=2;s.disableJHGDev=true;self.console=self.console||{info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}};self.Int32Array=self.Int32Array||Array;self.Float32Array=self.Float32Array||Array;String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")};String.prototype.hashCode=function(){var w=0,u,v;if(this.length===0){return w}for(u=0;u<this.length;u++){v=this.charCodeAt(u);w=((w<<5)-w)+v;w|=0}return w};(function(){var v=0;var w=["ms","moz","webkit","o"];for(var u=0;u<w.length&&!window.requestAnimationFrame;++u){window.requestAnimationFrame=window[w[u]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[w[u]+"CancelAnimationFrame"]||window[w[u]+"CancelRequestAnimationFrame"]}if(window.requestAnimationFrame===undefined){window.requestAnimationFrame=function(A){var x=Date.now(),y=Math.max(0,16-(x-v));var z=window.setTimeout(function(){A(x+y,false)},y);v=x+y;return z}}window.cancelAnimationFrame=window.cancelAnimationFrame||function(x){window.clearTimeout(x)}}());s.__renderTargetID=0;s.CullFaceNone=0;s.CullFaceBack=1;s.CullFaceFront=2;s.CullFaceFrontBack=3;s.FrontFaceDirectionCW=0;s.FrontFaceDirectionCCW=1;s.BasicShadowMap=0;s.PCFShadowMap=1;s.PCFSoftShadowMap=2;s.PCFInterpolShadowMap=3;s.PCFPoissonShadowMap=4;s.PCFOptimizedShadowMap=5;s.ESMShadowMap=6;s.ESMImprovedShadowMap=7;s.LowQuality=0;s.MediumQuality=1;s.HighQuality=2;s.NoShading=0;s.FlatShading=1;s.SmoothShading=2;s.FrontToBack=0;s.BackToFront=1;s.NoColors=0;s.FaceColors=1;s.VertexColors=2;s.VertexColorsRGBA=s.VertexColors;s.VertexColorsRGB=3;s.VertexColorsA=4;s.NoBlending=0;s.NormalBlending=1;s.AdditiveBlending=2;s.SubtractiveBlending=3;s.MultiplyBlending=4;s.CustomBlending=5;s.NormalDepthBlending=6;s.AlphaBlending=7;s.AddEquation=100;s.SubtractEquation=101;s.ReverseSubtractEquation=102;s.MinEquation=103;s.MaxEquation=104;s.ZeroFactor=200;s.OneFactor=201;s.SrcColorFactor=202;s.OneMinusSrcColorFactor=203;s.SrcAlphaFactor=204;s.OneMinusSrcAlphaFactor=205;s.DstAlphaFactor=206;s.OneMinusDstAlphaFactor=207;s.DstColorFactor=208;s.OneMinusDstColorFactor=209;s.SrcAlphaSaturateFactor=210;s.MultiplyOperation=0;s.MixOperation=1;s.AddOperation=2;s.UVMapping=function(){};s.CubeReflectionMapping=function(){};s.CubeRefractionMapping=function(){};s.SphericalReflectionMapping=function(){};s.SphericalRefractionMapping=function(){};s.LatLongReflectionMapping=function(){};s.LatLongRefractionMapping=function(){};s.SimpleEnvMapping=function(){};s.SimpleEnvMappingPreserveRatio=function(){};s.SimpleEnvMappingFit=function(){};s.SimpleEnvMappingFitWidth=function(){};s.SimpleEnvMappingFitHeight=function(){};s.SimpleEnvMappingCustom=function(){};s.CubeEnvMapping=function(){};s.LightProbeEnvMapping=function(){};s.LatLongEnvMapping=function(){};s.RepeatWrapping=1000;s.ClampToEdgeWrapping=1001;s.MirroredRepeatWrapping=1002;s.NearestFilter=1003;s.NearestMipMapNearestFilter=1004;s.NearestMipMapLinearFilter=1005;s.LinearFilter=1006;s.LinearMipMapNearestFilter=1007;s.LinearMipMapLinearFilter=1008;s.UnsignedByteType=1009;s.ByteType=1010;s.ShortType=1011;s.UnsignedShortType=1012;s.IntType=1013;s.UnsignedIntType=1014;s.FloatType=1015;s.UnsignedShort4444Type=1016;s.UnsignedShort5551Type=1017;s.UnsignedShort565Type=1018;s.AlphaFormat=1019;s.RGBFormat=1020;s.RGBAFormat=1021;s.LuminanceFormat=1022;s.LuminanceAlphaFormat=1023;s.RGB_S3TC_DXT1_Format=2001;s.RGBA_S3TC_DXT1_Format=2002;s.RGBA_S3TC_DXT3_Format=2003;s.RGBA_S3TC_DXT5_Format=2004;s.SmoothEdgeRenderLineModeMask=s.GeomTypeEnum.SMOOTH_EDGE;s.SharpEdgeRenderLineModeMask=s.GeomTypeEnum.SHARP_EDGE;s.WireEdgeRenderLineModeMask=s.GeomTypeEnum.WIRE_EDGE;s.BoundaryEdgeRenderLineModeMask=s.GeomTypeEnum.BOUNDARY_EDGE;s.HideAllRenderLineMode=0;s.OutlineMask=s.GeomTypeEnum._OUTLINE;s.SectionLineMask=s.GeomTypeEnum._SECTION_LINE;s.HideWireEdgesRenderLineMode=s.SmoothEdgeRenderLineModeMask|s.SharpEdgeRenderLineModeMask|s.BoundaryEdgeRenderLineModeMask;s.HideSmoothEdgesRenderLineMode=s.SharpEdgeRenderLineModeMask|s.WireEdgeRenderLineModeMask|s.BoundaryEdgeRenderLineModeMask;s.HideInternalEdgesRenderLineMode=s.WireEdgeRenderLineModeMask|s.BoundaryEdgeRenderLineModeMask;s.ShowAllRenderLineMode=s.SmoothEdgeRenderLineModeMask|s.SharpEdgeRenderLineModeMask|s.WireEdgeRenderLineModeMask|s.BoundaryEdgeRenderLineModeMask;s.ShowOutlinesAndEdgesRenderLineMode=s.OutlineMask|s.ShowAllRenderLineMode;s.ShowOutlinesHideEdgesRenderLineMode=s.OutlineMask|s.HideAllRenderLineMode;s.HideAllModelFaces=0;s.ShowAllFaces=s.GeomTypeEnum.FACE|s.GeomTypeEnum.INFINITE_FACE|s.GeomTypeEnum.AXIS_SYSTEM;s.BoundaryPointRenderPointMask=s.GeomTypeEnum.BOUNDARY_POINT;s.SharpPointRenderPointMask=s.GeomTypeEnum.SHARP_POINT;s.SmoothPointRenderPointMask=s.GeomTypeEnum.SMOOTH_POINT;s.SurfacicPointRenderPointMask=s.GeomTypeEnum.SURFACIC_POINT;s.FreePointRenderPointMask=s.GeomTypeEnum.FREE_POINT;s.AllPointsRenderPointMask=s.BoundaryPointRenderPointMask|s.SharpPointRenderPointMask|s.SmoothPointRenderPointMask|s.SurfacicPointRenderPointMask|s.FreePointRenderPointMask;s.AllPointsButSurfacicPointsRenderPointMask=s.BoundaryPointRenderPointMask|s.SharpPointRenderPointMask|s.SmoothPointRenderPointMask|s.FreePointRenderPointMask;s.loadingModels=false;s.IdentityMatrix=new s.Matrix4();var h=[];h.push(new s.Vector2(-0.770613,-0.239161));h.push(new s.Vector2(0.654029,-0.712337));h.push(new s.Vector2(-0.307109,0.184156));h.push(new s.Vector2(0.511665,0.311578));h.push(new s.Vector2(0.950228,-0.256954));h.push(new s.Vector2(-0.00583136,-0.537149));h.push(new s.Vector2(-0.692077,0.433278));h.push(new s.Vector2(-0.357517,0.88078));h.push(new s.Vector2(0.278742,0.859941));h.push(new s.Vector2(-0.631555,-0.471973));h.push(new s.Vector2(-0.480475,-0.732053));h.push(new s.Vector2(-0.486058,0.576291));h.push(new s.Vector2(0.190138,-0.625394));h.push(new s.Vector2(-0.176393,-0.166675));h.push(new s.Vector2(0.0663065,-0.333703));h.push(new s.Vector2(0.348117,-0.812683));h.push(new s.Vector2(0.0817859,0.0594559));h.push(new s.Vector2(0.375191,-0.0632498));h.push(new s.Vector2(0.770788,-0.0723965));h.push(new s.Vector2(0.800971,0.431381));h.push(new s.Vector2(-0.100114,0.320657));h.push(new s.Vector2(0.285262,0.61499));h.push(new s.Vector2(-0.579148,0.219349));h.push(new s.Vector2(-0.684372,-0.0462647));h.push(new s.Vector2(-0.313914,-0.939188));h.push(new s.Vector2(-0.414696,0.367707));h.push(new s.Vector2(0.698927,0.219188));h.push(new s.Vector2(0.971183,0.130313));h.push(new s.Vector2(0.0822042,0.526062));h.push(new s.Vector2(-0.214193,0.522263));h.push(new s.Vector2(-0.0751906,0.901432));h.push(new s.Vector2(0.488676,-0.253098));h.push(new s.Vector2(-0.580828,0.778049));h.push(new s.Vector2(0.816108,-0.536974));h.push(new s.Vector2(0.51456,0.543311));h.push(new s.Vector2(-0.213744,-0.428735));h.push(new s.Vector2(0.293803,-0.405018));h.push(new s.Vector2(0.169169,0.259656));h.push(new s.Vector2(0.445091,-0.594255));h.push(new s.Vector2(-0.453123,-0.1009));h.push(new s.Vector2(-0.420509,-0.388243));h.push(new s.Vector2(0.576791,0.0184982));h.push(new s.Vector2(0.610535,0.759891));h.push(new s.Vector2(0.692311,-0.348235));h.push(new s.Vector2(0.0912182,0.752741));h.push(new s.Vector2(-0.840539,0.203544));h.push(new s.Vector2(0.0673295,-0.961926));h.push(new s.Vector2(-0.951943,0.0129663));h.push(new s.Vector2(-0.14793,-0.811125));s._AmbianceGenerators={viewers:[],loading:false,manager:null,needsUpdate:false,cb:null,errorCount:0,init:function(u){if(this.loading||this.manager){return}if(!this.available(u)){return}if(this.manager===null){this.loading=true;var v=this;require(["DS/Visualization/AmbianceGenerator"],function(w){v.loading=false;v.manager=new w(v.cb)})}},available:function(v){var u=s.supportedExtensions.vertexTextureUnits>8&&s.supportedExtensions.fragmentTextureUnits>8&&!!s.supportedExtensions.textureFloat;if(!u){if(v===0&&this.errorCount<10){console.warn("Warning: device does not support automatic mip map generation for hdrs, please set one yourself")}else{if(v===1&&this.errorCount<11){console.warn("Warning: device does not support fabrics under ibl")}}this.errorCount++}return u},getAmbiance:function(u,v,w,x){if(!this.manager){return null}return this.manager.getAmbiance(u,v,w,x)},update:function(v,u){if(!this.manager){return}this.needsUpdate=false;this.manager.update(v,u)},decreaseUseCount:function(u){if(!this.manager){return}this.manager.decreaseUseCount(u)},setCallBack:function(u){this.cb=u;if(this.manager){this.manager._setCB(u)}},dispose:function(v){if(!this.manager){return}var u=this.viewers.indexOf(v);if(u>-1){this.viewers.splice(u,1)}if(this.viewers.length===0){this.manager.dispose();this.manager=null}}};s.MemoryInfo=function(){this.reset()};s.MemoryInfo.prototype.reset=function(){this.programs=0;this.geometries=0;this.textures=0;this.sharedbuffers=0};s.MemoryInfo.prototype.copyTo=function(u){u.programs=this.programs;u.geometries=this.geometries;u.textures=this.textures;u.sharedbuffers=this.sharedbuffers};s.RenderInfo=function(){this.reset()};s.RenderInfo.prototype.reset=function(){this.calls=0;this.vertices=0;this.faces=0;this.lines=0;this.points=0;this.meshes=0;this.culledMeshes=0;this.culledGeometries=0;this.culledDGTriangles=0;this.culledDGLines=0;this.nbDGs=0;this.nbReps=0;this.nbTriangles=0;this.nbDGsSSBProcessed=0};s.RenderInfo.prototype.copyTo=function(u){u.calls=this.calls;u.vertices=this.vertices;u.faces=this.faces;u.lines=this.lines;u.points=this.points;u.meshes=this.meshes;u.culledMeshes=this.culledMeshes;u.culledGeometries=this.culledGeometries;u.culledDGTriangles=this.culledDGTriangles;u.culledDGLines=this.culledDGLines;u.nbDGs=this.nbDGs;u.nbReps=this.nbReps;u.nbTriangles=this.nbTriangles;u.nbDGsSSBProcessed=this.nbDGsSSBProcessed};s.ObjectUniformLocations=function(){this.modelMatrix=null;this.modelViewMatrix=null;this.modelViewInvTranspMatrix=null;this.modelInvTranspMatrix=null;this.shadowMatrix=null;this.normalMatrix=null;this.quantizedVector=null;this.offsetVector=null;this.use_normal_matrix=null;this.fixedSizeRatio=null;this.fixedSizeCenterRatio=null};s.ProgramObject=function(){this.program=null;this.id=0;this.uniformLocations=null;this.objectUniformLocations=null;this.attributes={position:-1,normal:-1,uv:-1,uv2:-1,tangent:-1,binormal:-1,color:-1,skinIndex:-1,skinWeight:-1,lineDistance:-1,previousPos:-1,followingPos:-1,sideExtrusion:-1,};this.uvOrBinOrTan=false;this.instanceAttributes={};this.flattenedUniformArrays={};this._clipPlanesVersion=-1;this._lightsKey=0};s.glStates={currentFramebuffer:undefined,currentWidth:0,currentHeight:0};s.MaterialToUse={originalMaterial:0,normalMaterial:1,depthMaterial:2,normalDepthMaterial:3,shadowMapDepthMaterial:4,highlightMaterial:5,outlineHighlightMaterial:6,preHighlightMaterial:7,pickingMaterial:8,pickingMaterialInstancing:9,oitAccumMaterial:10,oitRevealMaterial:11,ZOnlyMaterial:12,gasLookMaterial:13,totalMaterial:14};s.ShaderIDs={none:-1,basic:0,phong:1,lambert:2,line:3,particle_basic:4,physicalDS:5,line2D:6,normal:7};s.ShaderIDsToName=["basic","phong","lambert","line","particle_basic","physicalDS","line2D","normal"];s.MaterialHasPriority=[false,true,true,true,true,true,true,true,true,true,false,false,false,false];s.Line3=function(v,u){this.start=(v!==undefined)?v:new s.Vector3();this.end=(u!==undefined)?u:new s.Vector3()};s.Line3.prototype={constructor:s.Line3,set:function(v,u){this.start.copy(v);this.end.copy(u);return this},copy:function(u){this.start.copy(u.start);this.end.copy(u.end);return this},center:function(v){var u=v||new s.Vector3();return u.addVectors(this.start,this.end).multiplyScalar(0.5)},delta:function(v){var u=v||new s.Vector3();return u.subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(w,v){var u=v||new s.Vector3();return this.delta(u).multiplyScalar(w).add(this.start)},closestPointToPointParameter:function(){var v=new s.Vector3();var u=new s.Vector3();return function(w,A){v.subVectors(w,this.start);u.subVectors(this.end,this.start);var z=u.dot(u);var y=u.dot(v);var x=y/z;if(A){x=s.Math.clamp(x,0,1)}return x}}(),closestPointToPoint:function(v,y,x){var w=this.closestPointToPointParameter(v,y);var u=x||new s.Vector3();return this.delta(u).multiplyScalar(w).add(this.start)},applyMatrix4:function(u){this.start.applyMatrix4(u);this.end.applyMatrix4(u);return this},equals:function(u){return u.start.equals(this.start)&&u.end.equals(this.end)},clone:function(){return new s.Line3().copy(this)}};s.Box2=function(v,u){this.min=(v!==undefined)?v:new s.Vector2(Infinity,Infinity);this.max=(u!==undefined)?u:new s.Vector2(-Infinity,-Infinity)};s.Box2.prototype={constructor:s.Box2,set:function(v,u){this.min.copy(v);this.max.copy(u);return this},setFromPoints:function(x){if(x.length>0){var u=x[0];this.min.copy(u);this.max.copy(u);for(var w=1,v=x.length;w<v;w++){u=x[w];if(u.x<this.min.x){this.min.x=u.x}else{if(u.x>this.max.x){this.max.x=u.x}}if(u.y<this.min.y){this.min.y=u.y}else{if(u.y>this.max.y){this.max.y=u.y}}}}else{this.makeEmpty()}return this},setFromCenterAndSize:function(){var u=new s.Vector2();return function(v,x){var w=u.copy(x).multiplyScalar(0.5);this.min.copy(v).sub(w);this.max.copy(v).add(w);return this}}(),copy:function(u){this.min.copy(u.min);this.max.copy(u.max);return this},makeEmpty:function(){this.min.x=this.min.y=Infinity;this.max.x=this.max.y=-Infinity;return this},empty:function(){return(this.max.x<this.min.x)||(this.max.y<this.min.y)},singlePoint:function(){return(this.max.x<=this.min.x)&&(this.max.y<=this.min.y)},center:function(v){var u=v||new s.Vector2();return u.addVectors(this.min,this.max).multiplyScalar(0.5)},size:function(v){var u=v||new s.Vector2();return u.subVectors(this.max,this.min)},expandByPoint:function(u){this.min.min(u);this.max.max(u);return this},expandByVector:function(u){this.min.sub(u);this.max.add(u);return this},expandByScalar:function(u){this.min.addScalar(-u);this.max.addScalar(u);return this},containsPoint:function(u){if(u.x<this.min.x||u.x>this.max.x||u.y<this.min.y||u.y>this.max.y){return false}return true},containsBox:function(u){if((this.min.x<=u.min.x)&&(u.max.x<=this.max.x)&&(this.min.y<=u.min.y)&&(u.max.y<=this.max.y)){return true}return false},getParameter:function(u){return new s.Vector2((u.x-this.min.x)/(this.max.x-this.min.x),(u.y-this.min.y)/(this.max.y-this.min.y))},isIntersectionBox:function(u){if(u.max.x<this.min.x||u.min.x>this.max.x||u.max.y<this.min.y||u.min.y>this.max.y){return false}return true},clampPoint:function(v,w){var u=w||new s.Vector2();return u.copy(v).clamp(this.min,this.max)},distanceToPoint:function(){var u=new s.Vector2();return function(v){var w=u.copy(v).clamp(this.min,this.max);return w.sub(v).length()}}(),intersect:function(u){this.min.max(u.min);this.max.min(u.max);return this},union:function(u){this.min.min(u.min);this.max.max(u.max);return this},translate:function(u){this.min.add(u);this.max.add(u);return this},equals:function(u){return u.min.equals(this.min)&&u.max.equals(this.max)},clone:function(){return new s.Box2().copy(this)}};s.Box3=function(v,u){this.min=(v!==undefined)?v:new s.Vector3(Infinity,Infinity,Infinity);this.max=(u!==undefined)?u:new s.Vector3(-Infinity,-Infinity,-Infinity)};s.Box3.prototype={constructor:s.Box3,set:function(v,u){this.min.copy(v);this.max.copy(u);return this},setFromPoints:function(x){if(x.length>0){var u=x[0];this.min.copy(u);this.max.copy(u);for(var w=1,v=x.length;w<v;w++){u=x[w];if(u.x<this.min.x){this.min.x=u.x}else{if(u.x>this.max.x){this.max.x=u.x}}if(u.y<this.min.y){this.min.y=u.y}else{if(u.y>this.max.y){this.max.y=u.y}}if(u.z<this.min.z){this.min.z=u.z}else{if(u.z>this.max.z){this.max.z=u.z}}}}else{this.makeEmpty()}return this},setFromCenterAndSize:function(){var u=new s.Vector3();return function(v,x){var w=u.copy(x).multiplyScalar(0.5);this.min.copy(v).sub(w);this.max.copy(v).add(w);return this}}(),createJSON:function(){return[this.min.x,this.min.y,this.min.z,this.max.x,this.max.y,this.max.z]},setFromJSON:function(u){this.min.set(u[0],u[1],u[2]);this.max.set(u[3],u[4],u[5])},copy:function(u){this.min.copy(u.min);this.max.copy(u.max);return this},makeEmpty:function(){this.min.x=this.min.y=this.min.z=Infinity;this.max.x=this.max.y=this.max.z=-Infinity;return this},empty:function(){return(this.max.x<this.min.x)||(this.max.y<this.min.y)||(this.max.z<this.min.z)},singlePoint:function(){return(this.max.x<=this.min.x)&&(this.max.y<=this.min.y)&&(this.max.z<=this.min.z)},center:function(v){var u=v||new s.Vector3();return u.addVectors(this.min,this.max).multiplyScalar(0.5)},size:function(v){var u=v||new s.Vector3();return u.subVectors(this.max,this.min)},expandByPoint:function(u){this.min.min(u);this.max.max(u);return this},expandByVector:function(u){this.min.sub(u);this.max.add(u);return this},expandByScalar:function(u){this.min.addScalar(-u);this.max.addScalar(u);return this},containsPoint:function(u){if(u.x<this.min.x||u.x>this.max.x||u.y<this.min.y||u.y>this.max.y||u.z<this.min.z||u.z>this.max.z){return false}return true},containsBox:function(u){if((this.min.x<=u.min.x)&&(u.max.x<=this.max.x)&&(this.min.y<=u.min.y)&&(u.max.y<=this.max.y)&&(this.min.z<=u.min.z)&&(u.max.z<=this.max.z)){return true}return false},getParameter:function(u){return new s.Vector3((u.x-this.min.x)/(this.max.x-this.min.x),(u.y-this.min.y)/(this.max.y-this.min.y),(u.z-this.min.z)/(this.max.z-this.min.z))},isIntersectionBox:function(u){if(u.max.x<this.min.x||u.min.x>this.max.x||u.max.y<this.min.y||u.min.y>this.max.y||u.max.z<this.min.z||u.min.z>this.max.z){return false}return true},clampPoint:function(v,w){var u=w||new s.Vector3();return u.copy(v).clamp(this.min,this.max)},distanceToPoint:function(){var u=new s.Vector3();return function(v){var w=u.copy(v).clamp(this.min,this.max);return w.sub(v).length()}}(),getBoundingSphere:function(){var u=new s.Vector3();return function(w){var v=w||new s.Sphere();v.center=this.center();v.radius=this.size(u).length()*0.5;return v}}(),intersect:function(u){this.min.max(u.min);this.max.min(u.max);return this},union:function(u){this.min.min(u.min);this.max.max(u.max);return this},applyMatrix4:function(){var u=[new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3()];return function(v){u[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(v);u[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(v);u[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(v);u[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(v);u[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(v);u[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(v);u[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(v);u[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(v);this.makeEmpty();this.setFromPoints(u);return this}}(),getPoints:function(){var u=[new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3()];return function(v){u[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(v);u[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(v);u[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(v);u[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(v);u[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(v);u[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(v);u[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(v);u[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(v);return u}}(),translate:function(u){this.min.add(u);this.max.add(u);return this},equals:function(u){return u.min.equals(this.min)&&u.max.equals(this.max)},clone:function(){return new s.Box3().copy(this)},mergeWithBox:function(u){this.expandByPoint(u.min);this.expandByPoint(u.max)},isNaN:function(){if(this.min.isNaN()||this.max.isNaN()){return true}else{return false}},fromDGBoundingBoxArray:function(z){var B=this;var u=z.length;if(u>1){var v=function(D){var F=z[0];for(var E=1;E<u;E++){var C=z[E];if(F.fastBBox.min[D]>C.fastBBox.min[D]){F=C}}return F};var A=function(D){var F=z[0];for(var E=1;E<u;E++){var C=z[E];if(F.fastBBox.max[D]<C.fastBBox.max[D]){F=C}}return F};var x=function(C){var D=v(C);while(B.min[C]>=D.fastBBox.min[C]){D.flagMinAttr(C);B.min[C]=Math.min(D.getMinAttr(C),B.min[C]);D=v(C)}};x("x");x("y");x("z");var y=function(C){var D=A(C);while(B.max[C]<=D.fastBBox.max[C]){D.flagMaxAttr(C);B.max[C]=Math.max(D.getMaxAttr(C),B.max[C]);D=A(C)}};y("x");y("y");y("z")}else{if(u>0){var w=z[0];this.union(w.getRealBBox())}}return this}};s.DGBoundingBoxArray=function(u){this.fastBBox=u.fastBBox.clone();this._realBBox=u.fastBBox.singlePoint()?u.fastBBox.clone():null;this.matrix=u.matrix.clone();this.renderable=u.renderable;this.obj=[]};s.DGBoundingBoxArray.prototype.computeFunction=function(){var v=new s.Box3();for(var u=0;u<this.obj.length;u++){var x=this.obj[u];var w=x.computeOrientedBoundingBox(this.matrix);v.union(w)}this._realBBox=v};s.DGBoundingBoxArray.prototype.getRealBBox=function(){if(this._realBBox===null){this.computeFunction()}return this._realBBox};s.DGBoundingBoxArray.prototype.getMinAttr=function(u){if(this._realBBox===null){this.computeFunction()}return this._realBBox.min[u]};s.DGBoundingBoxArray.prototype.getMaxAttr=function(u){if(this._realBBox===null){this.computeFunction()}return this._realBBox.max[u]};s.DGBoundingBoxArray.prototype.flagMaxAttr=function(u){this.fastBBox.max[u]=-Infinity};s.DGBoundingBoxArray.prototype.flagMinAttr=function(u){this.fastBBox.min[u]=Infinity};s.DGBoundingBoxArray.prototype.addDG=function(u){this.obj.push(u)};s.DGBoundingBoxArray.prototype.setDGs=function(u){this.obj=u};s.DGBoundingBoxArray.prototype.empty=function(){return this.obj.length===0};s.Ray=function(u,v){this.origin=(u!==undefined)?u:new s.Vector3();this.direction=(v!==undefined)?v:new s.Vector3()};s.Ray.prototype={constructor:s.Ray,set:function(u,v){this.origin.copy(u);this.direction.copy(v);return this},copy:function(u){this.origin.copy(u.origin);this.direction.copy(u.direction);return this},at:function(w,v){var u=v||new s.Vector3();return u.copy(this.direction).multiplyScalar(w).add(this.origin)},recast:function(){var u=new s.Vector3();return function(v){this.origin.copy(this.at(v,u));return this}}(),closestPointToPoint:function(v,w){var u=w||new s.Vector3();u.subVectors(v,this.origin);var x=u.dot(this.direction);return u.copy(this.direction).multiplyScalar(x).add(this.origin)},distanceToPoint:function(){var u=new s.Vector3();return function(v){var w=u.subVectors(v,this.origin).dot(this.direction);u.copy(this.direction).multiplyScalar(w).add(this.origin);return u.distanceTo(v)}}(),distanceSqToSegment:function(){var w=new s.Vector3();var v=new s.Vector3();var x=new s.Vector3();return function u(K,G,H,A){w.copy(K).add(G).multiplyScalar(0.5);v.copy(G).sub(K).normalize();x.copy(this.origin).sub(w);var C=K.distanceTo(G)*0.5;var y=-this.direction.dot(v);var I=x.dot(this.direction);var F=-x.dot(v);var E=x.lengthSq();var D=Math.abs(1-y*y);var M,J,z,L;if(D>0){M=y*F-I;J=y*I-F;L=C*D;if(M>=0){if(J>=-L){if(J<=L){var B=1/D;M*=B;J*=B;z=M*(M+y*J+2*I)+J*(y*M+J+2*F)+E}else{J=C;M=Math.max(0,-(y*J+I));z=-M*M+J*(J+2*F)+E}}else{J=-C;M=Math.max(0,-(y*J+I));z=-M*M+J*(J+2*F)+E}}else{if(J<=-L){M=Math.max(0,-(-y*C+I));J=(M>0)?-C:Math.min(Math.max(-C,-F),C);z=-M*M+J*(J+2*F)+E}else{if(J<=L){M=0;J=Math.min(Math.max(-C,-F),C);z=J*(J+2*F)+E}else{M=Math.max(0,-(y*C+I));J=(M>0)?C:Math.min(Math.max(-C,-F),C);z=-M*M+J*(J+2*F)+E}}}}else{J=(y>0)?-C:C;M=Math.max(0,-(y*J+I));z=-M*M+J*(J+2*F)+E}if(H){H.copy(this.direction).multiplyScalar(M).add(this.origin)}if(A){A.copy(v).multiplyScalar(J).add(w)}return z}}(),isIntersectionSphere:function(u){return(this.distanceToPoint(u.center)<=u.radius)},isIntersectionPlane:function(u){var v=u.normal.dot(this.direction);if(v!=0){return true}if(u.distanceToPoint(this.origin)==0){return true}return false},distanceToPlane:function(u){var w=u.normal.dot(this.direction);if(w==0){if(u.distanceToPoint(this.origin)==0){return 0}return undefined}var v=-(this.origin.dot(u.normal)+u.constant)/w;return v},intersectPlane:function(u,w){var v=this.distanceToPlane(u);if(v===undefined){return undefined}return this.at(v,w)},intersectBox:function(z,F){var w,A,C,u,B,E;var y=1/this.direction.x,x=1/this.direction.y,v=1/this.direction.z;var D=this.origin;if(y>=0){w=(z.min.x-D.x)*y;A=(z.max.x-D.x)*y}else{w=(z.max.x-D.x)*y;A=(z.min.x-D.x)*y}if(x>=0){C=(z.min.y-D.y)*x;u=(z.max.y-D.y)*x}else{C=(z.max.y-D.y)*x;u=(z.min.y-D.y)*x}if((w>u)||(C>A)){return null}if(C>w||w!==w){w=C}if(u<A||A!==A){A=u}if(v>=0){B=(z.min.z-D.z)*v;E=(z.max.z-D.z)*v}else{B=(z.max.z-D.z)*v;E=(z.min.z-D.z)*v}if((w>E)||(B>A)){return null}if(B>w||w!==w){w=B}if(E<A||A!==A){A=E}if(A<0){return null}return this.at(w>=0?w:A,F)},applyMatrix4:function(u){this.direction.add(this.origin).applyMatrix4(u);this.origin.applyMatrix4(u);this.direction.sub(this.origin);this.direction.normalize();return this},equals:function(u){return u.origin.equals(this.origin)&&u.direction.equals(this.direction)},clone:function(){return new s.Ray().copy(this)}};s.Sphere=function(v,u){this.center=(v!==undefined)?v:new s.Vector3();this.radius=(u!==undefined)?u:0;this.pixelRadius=0};s.Sphere.prototype={constructor:s.Sphere,set:function(v,u){this.center.copy(v);this.radius=u;return this},createJSON:function(){var u=[this.center.x,this.center.y,this.center.z,this.radius];return u},setFromJSON:function(u){this.center.set(u[0],u[1],u[2]);this.radius=u[3]},setFromCenterAndPoints:function(u,z){var v=0;for(var y=0,w=z.length;y<w;y++){var x=u.distanceToSquared(z[y]);v=Math.max(v,x)}this.center=u;this.radius=Math.sqrt(v);return this},copy:function(u){this.center.copy(u.center);this.radius=u.radius;this.pixelRadius=u.pixelRadius;return this},empty:function(){return(this.radius<=0)},containsPoint:function(u){return(u.distanceToSquared(this.center)<=(this.radius*this.radius)+0.000001)},distanceToPoint:function(u){return(u.distanceTo(this.center)-this.radius)},containsSphere:function(u){return this.center.distanceTo(u.center)<=this.radius-u.radius},intersectsSphere:function(u){var v=this.radius+u.radius;return u.center.distanceToSquared(this.center)<=(v*v)},intersectsLine:function(v){var A=v[1].clone().sub(v[0]);var y=this.center.clone().sub(v[0]);var w=A.dot(y);var z=A.dot(A);var x=v[0].clone().add(A.clone().multiplyScalar(w/z));if(!this.containsPoint(x)){return false}var u=x.sub(v[0]).dot(A);if(u>=0&&u<=z){return true}return false},intersectsTriangle:function(u){return this.intersectsLine([u[0],u[1]])||this.intersectsLine([u[1],u[2]])||this.intersectsLine([u[2],u[0]])},clampPoint:function(v,x){var w=this.center.distanceToSquared(v);var u=x||new s.Vector3();u.copy(v);if(w>(this.radius*this.radius)){u.sub(this.center).normalize();u.multiplyScalar(this.radius).add(this.center)}return u},getBoundingBox:function(u){var v=u||new s.Box3();v.set(this.center,this.center);v.expandByScalar(this.radius);return v},applyMatrix4:function(u){if(u){this.center.applyMatrix4(u);this.radius=this.radius*u.getMaxScaleOnAxis()}return this},translate:function(u){this.center.add(u);return this},equals:function(u){return u.center.equals(this.center)&&(u.radius===this.radius)},clone:function(){return new s.Sphere().copy(this)},mergeWithSphere:function(v,A){var u,z;if(this.radius<v.radius){u=this;z=v}else{u=v;z=this}var x;var B=z.center.distanceTo(u.center),w;var y=Math.max(v.pixelRadius,A.pixelRadius);if(B+u.radius<=z.radius){A.copy(z)}else{x=0.5*(u.radius+z.radius+B);w=(x-z.radius)/B;A.radius=x;A.center.x=w*u.center.x+(1-w)*z.center.x;A.center.y=w*u.center.y+(1-w)*z.center.y;A.center.z=w*u.center.z+(1-w)*z.center.z}A.pixelRadius=y},isNaN:function(){if(!isFinite(this.radius)||this.center.isNaN()){return true}else{return false}},_updateRatio:function(u){if(u===0){return}this.pixelRadius+=this.center.length()*u;this.set(new s.Vector3(),this.radius+this.center.length());this.radius*=u;this.pixelRadius=Math.max(this.pixelRadius,this.radius);this.radius=0},};s.Frustum=function(z,y,x,w,v,u){this.planes=[(z!==undefined)?z:new s.Plane(),(y!==undefined)?y:new s.Plane(),(x!==undefined)?x:new s.Plane(),(w!==undefined)?w:new s.Plane(),(v!==undefined)?v:new s.Plane(),(u!==undefined)?u:new s.Plane()]};s.Frustum.prototype={constructor:s.Frustum,set:function(A,z,y,x,w,v){var u=this.planes;u[0].copy(A);u[1].copy(z);u[2].copy(y);u[3].copy(x);u[4].copy(w);u[5].copy(v);return this},copy:function(w){var u=this.planes;for(var v=0;v<6;v++){u[v].copy(w.planes[v])}return this},setFromMatrix:function(H){var B=this.planes;var M=H.elements;var F=M[0],D=M[1],C=M[2],A=M[3];var z=M[4],y=M[5],x=M[6],w=M[7];var v=M[8],u=M[9],L=M[10],K=M[11];var J=M[12],I=M[13],G=M[14],E=M[15];B[0].setComponents(A-F,w-z,K-v,E-J).normalize();B[1].setComponents(A+F,w+z,K+v,E+J).normalize();B[2].setComponents(A+D,w+y,K+u,E+I).normalize();B[3].setComponents(A-D,w-y,K-u,E-I).normalize();B[4].setComponents(A-C,w-x,K-L,E-G).normalize();B[5].setComponents(A+C,w+x,K+L,E+G).normalize();return this},intersectsObject:function(){var u=new s.Vector3();return function(y){var w=y._getMMMatrix();var x=this.planes;var v=-y.geometry.boundingSphere.radius*w.getMaxScaleOnAxis();u.getPositionFromMatrix(w);for(var z=0;z<6;z++){var A=x[z].distanceToPoint(u);if(A<v){return false}}return true}}(),intersectsSphere:function(w){var x=this.planes;var u=w.center;var v=-w.radius;for(var y=0;y<6;y++){var z=x[y].distanceToPoint(u);if(z<v){return false}}return true},containsSphere:function(u){var v=this.planes;for(var w=0;w<6;w++){if(v[w].distanceToPoint(u.center)-u.radius<0){return false}}return true},containsPoint:function(u){var v=this.planes;for(var w=0;w<6;w++){if(v[w].distanceToPoint(u)<0){return false}}return true},clone:function(){return new s.Frustum().copy(this)},computeOutcode:function(u){var v=0;if(u.dot(this.planes[0].normal)+this.planes[0].constant<0){v|=1}if(u.dot(this.planes[1].normal)+this.planes[1].constant<0){v|=2}if(u.dot(this.planes[2].normal)+this.planes[2].constant<0){v|=4}if(u.dot(this.planes[3].normal)+this.planes[3].constant<0){v|=8}if(u.dot(this.planes[4].normal)+this.planes[4].constant<0){v|=16}if(u.dot(this.planes[5].normal)+this.planes[5].constant<0){v|=32}return v},intersectsLine:function(v){var w=[],A=[new s.Vector3(),new s.Vector3()];A[0].copy(v[0]);A[1].copy(v[1]);w[0]=this.computeOutcode(A[0]);w[1]=this.computeOutcode(A[1]);for(var y=0;y<4;y++){if(w[0]===0||w[1]===0){return true}if((w[0]&w[1])!==0){break}var z=new s.Vector3(A[0].x-A[1].x,A[0].y-A[1].y,A[0].z-A[1].z);var x=0;var u=null;if(w[0]&1){u=this.planes[0]}else{if(w[0]&2){u=this.planes[1]}else{if(w[0]&4){u=this.planes[2]}else{if(w[0]&8){u=this.planes[3]}else{if(w[0]&16){u=this.planes[4]}else{if(w[0]&32){u=this.planes[5]}}}}}}if(u){x=-(A[0].dot(u.normal)+u.constant)/z.dot(u.normal)}A[0].add(z.multiplyScalar(x));w[0]=this.computeOutcode(A[0])}return false},intersectsTriangle:function(u){return this.intersectsLine([u[0],u[1]])||this.intersectsLine([u[1],u[2]])||this.intersectsLine([u[2],u[0]])}};s.Plane=function(v,u){this.normal=(v!==undefined)?v:new s.Vector3(1,0,0);this.constant=(u!==undefined)?u:0};s.Plane.prototype={constructor:s.Plane,set:function(v,u){this.normal.copy(v);this.constant=u;return this},setComponents:function(u,B,A,v){this.normal.set(u,B,A);this.constant=v;return this},setFromNormalAndCoplanarPoint:function(v,u){this.normal.copy(v);this.constant=-u.dot(this.normal);return this},setFromCoplanarPoints:function(){var v=new s.Vector3();var u=new s.Vector3();return function(x,w,z){var y=v.subVectors(z,w).cross(u.subVectors(x,w)).normalize();this.setFromNormalAndCoplanarPoint(y,x);return this}}(),copy:function(u){this.normal.copy(u.normal);this.constant=u.constant;return this},normalize:function(){var u=1/this.normal.length();this.normal.multiplyScalar(u);this.constant*=u;return this},negate:function(){this.constant*=-1;this.normal.negate();return this},distanceToPoint:function(u){return this.normal.dot(u)+this.constant},distanceToSphere:function(u){return this.distanceToPoint(u.center)-u.radius},projectPoint:function(u,v){return this.orthoPoint(u,v).sub(u).negate()},orthoPoint:function(v,x){var w=this.distanceToPoint(v);var u=x||new s.Vector3();return u.copy(this.normal).multiplyScalar(w)},isIntersectionLine:function(u){var w=this.distanceToPoint(u.start);var v=this.distanceToPoint(u.end);return(w<0&&v>0)||(v<0&&w>0)},intersectLine:function(){var u=new s.Vector3();return function(w,y){var v=y||new s.Vector3();var z=w.delta(u);var A=this.normal.dot(z);if(A==0){if(this.distanceToPoint(w.start)==0){return v.copy(w.start)}return undefined}var x=-(w.start.dot(this.normal)+this.constant)/A;if(x<0||x>1){return undefined}return v.copy(z).multiplyScalar(x).add(w.start)}}(),coplanarPoint:function(v){var u=v||new s.Vector3();return u.copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var v=new s.Vector3();var u=new s.Vector3();return function(x,y){y=y||new s.Matrix3().getInverse(x).transpose();var z=v.copy(this.normal).applyMatrix3(y);var w=this.coplanarPoint(u);w.applyMatrix4(x);this.setFromNormalAndCoplanarPoint(z,w);return this}}(),translate:function(u){this.constant=this.constant-u.dot(this.normal);return this},equals:function(u){return u.normal.equals(this.normal)&&(u.constant==this.constant)},clone:function(){return new s.Plane().copy(this)}};s.Math={clamp:function(v,w,u){return(v<w)?w:((v>u)?u:v)},clampBottom:function(u,v){return u<v?v:u},mapLinear:function(v,w,u,z,y){return z+(v-w)*(y-z)/(u-w)},smoothstep:function(v,w,u){if(v<=w){return 0}if(v>=u){return 1}v=(v-w)/(u-w);return v*v*(3-2*v)},smootherstep:function(v,w,u){if(v<=w){return 0}if(v>=u){return 1}v=(v-w)/(u-w);return v*v*v*(v*(v*6-15)+10)},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(u,v){return u+Math.floor(Math.random()*(v-u+1))},randFloat:function(u,v){return u+Math.random()*(v-u)},randFloatSpread:function(u){return u*(0.5-Math.random())},sign:function(u){return(u<0)?-1:((u>0)?1:0)},degToRad:function(){var u=Math.PI/180;return function(v){return v*u}}(),radToDeg:function(){var u=180/Math.PI;return function(v){return v*u}}()};s.Spline=function(G){this.points=G;var A=[],C={x:0,y:0,z:0},F,u,x,w,v,E,D,B,z;this.initFromArray=function(H){this.points=[];for(var I=0;I<H.length;I++){this.points[I]={x:H[I][0],y:H[I][1],z:H[I][2]}}};this.getPoint=function(H){F=(this.points.length-1)*H;u=Math.floor(F);x=F-u;A[0]=u===0?u:u-1;A[1]=u;A[2]=u>this.points.length-2?this.points.length-1:u+1;A[3]=u>this.points.length-3?this.points.length-1:u+2;E=this.points[A[0]];D=this.points[A[1]];B=this.points[A[2]];z=this.points[A[3]];w=x*x;v=x*w;C.x=y(E.x,D.x,B.x,z.x,x,w,v);C.y=y(E.y,D.y,B.y,z.y,x,w,v);C.z=y(E.z,D.z,B.z,z.z,x,w,v);return C};this.getControlPointsArray=function(){var I,K,H=this.points.length,J=[];for(I=0;I<H;I++){K=this.points[I];J[I]=[K.x,K.y,K.z]}return J};this.getLength=function(J){var L,N,O,M,R=0,H=0,K=0,Q=new s.Vector3(),I=new s.Vector3(),P=[],S=0;P[0]=0;if(!J){J=100}O=this.points.length*J;Q.copy(this.points[0]);for(L=1;L<O;L++){N=L/O;M=this.getPoint(N);I.copy(M);S+=I.distanceTo(Q);Q.copy(M);R=(this.points.length-1)*N;H=Math.floor(R);if(H!=K){P[H]=S;K=H}}P[P.length]=S;return{chunks:P,total:S}};this.reparametrizeByArcLength=function(J){var N,M,Q,R,K,I,S,P,O,T=[],H=new s.Vector3(),L=this.getLength();T.push(H.copy(this.points[0]).clone());for(N=1;N<this.points.length;N++){S=L.chunks[N]-L.chunks[N-1];P=Math.ceil(J*S/L.total);R=(N-1)/(this.points.length-1);K=N/(this.points.length-1);for(M=1;M<P-1;M++){Q=R+M*(1/P)*(K-R);O=this.getPoint(Q);T.push(H.copy(O).clone())}T.push(H.copy(this.points[N]).clone())}this.points=T};function y(O,N,L,K,P,I,H){var M=(L-O)*0.5,J=(K-N)*0.5;return(2*(N-L)+M+J)*H+(-3*(N-L)-2*M-J)*I+M*P+N}};s.Triangle=function(v,u,w){this.a=(v!==undefined)?v:new s.Vector3();this.b=(u!==undefined)?u:new s.Vector3();this.c=(w!==undefined)?w:new s.Vector3()};s.Triangle.normal=function(){var u=new s.Vector3();return function(y,w,A,z){var v=z||new s.Vector3();v.subVectors(A,w);u.subVectors(y,w);v.cross(u);var x=v.lengthSq();if(x>0){return v.multiplyScalar(1/Math.sqrt(x))}return v.set(0,0,0)}}();s.Triangle.barycoordFromPoint=function(){var u=new s.Vector3();var w=new s.Vector3();var v=new s.Vector3();return function(H,G,E,B,L){u.subVectors(B,G);w.subVectors(E,G);v.subVectors(H,G);var F=u.dot(u);var D=u.dot(w);var C=u.dot(v);var z=w.dot(w);var x=w.dot(v);var A=(F*z-D*D);var K=L||new s.Vector3();if(A==0){return K.set(-2,-1,-1)}var y=1/A;var J=(z*C-D*x)*y;var I=(F*x-D*C)*y;return K.set(1-J-I,I,J)}}();s.Triangle.containsPoint=function(){var u=new s.Vector3();return function(x,y,w,z){var v=s.Triangle.barycoordFromPoint(x,y,w,z,u);return(v.x>=0)&&(v.y>=0)&&((v.x+v.y)<=1)}}();s.Triangle.prototype={constructor:s.Triangle,set:function(v,u,w){this.a.copy(v);this.b.copy(u);this.c.copy(w);return this},setFromPointsAndIndices:function(v,x,w,u){this.a.copy(v[x]);this.b.copy(v[w]);this.c.copy(v[u]);return this},copy:function(u){this.a.copy(u.a);this.b.copy(u.b);this.c.copy(u.c);return this},area:function(){var u=new s.Vector3();var v=new s.Vector3();return function(){u.subVectors(this.c,this.b);v.subVectors(this.a,this.b);return u.cross(v).length()*0.5}}(),midpoint:function(v){var u=v||new s.Vector3();return u.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(u){return s.Triangle.normal(this.a,this.b,this.c,u)},plane:function(v){var u=v||new s.Plane();return u.setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(u,v){return s.Triangle.barycoordFromPoint(u,this.a,this.b,this.c,v)},containsPoint:function(u){return s.Triangle.containsPoint(u,this.a,this.b,this.c)},equals:function(u){return u.a.equals(this.a)&&u.b.equals(this.b)&&u.c.equals(this.c)},clone:function(){return new s.Triangle().copy(this)}};s.Vertex=function(u){console.warn("THREE.Vertex has been DEPRECATED. Use THREE.Vector3 instead.");return u};s.UV=function(x,w){console.warn("THREE.UV has been DEPRECATED. Use THREE.Vector2 instead.");return new s.Vector2(x,w)};s.Clock=function(u){this.autoStart=(u!==undefined)?u:true;this.startTime=0;this.oldTime=0;this.elapsedTime=0;this.running=false};s.extend(s.Clock.prototype,{start:function(){this.startTime=window.performance!==undefined&&window.performance.now!==undefined?window.performance.now():Date.now();this.oldTime=this.startTime;this.running=true},stop:function(){this.getElapsedTime();this.running=false},getElapsedTime:function(){this.getDelta();return this.elapsedTime},getDelta:function(){var v=0;if(this.autoStart&&!this.running){this.start()}if(this.running){var u=window.performance!==undefined&&window.performance.now!==undefined?window.performance.now():Date.now();v=0.001*(u-this.oldTime);this.oldTime=u;this.elapsedTime+=v}return v}});s.EventDispatcher=function(){var u={};this.addEventListener=function(v,w){if(u[v]===undefined){u[v]=[]}if(u[v].indexOf(w)===-1){u[v].push(w)}};this.removeEventListener=function(w,x){var v=u[w].indexOf(x);if(v!==-1){u[w][v]=null}};this.dispatchEvent=function(z){var v=u[z.type];if(v!==undefined){z.target=this;var y=false;for(var x=0,w=v.length;x<w;x++){if(v[x]){v[x].call(this,z)}else{y=true}}if(y){var A=[];for(var x=0,w=v.length;x<w;x++){v[x]&&A.push(v[x])}u[z.type]=A}}}};(function(z){z.Raycaster=function(F,H,G,E){this.ray=new z.Ray(F,H);if(this.ray.direction.lengthSq()>0){this.ray.direction.normalize()}this.near=G||0;this.far=E||Infinity};var v=new z.Sphere();var w=new z.Ray();var A=new z.Plane();var C=new z.Vector3();var y=new z.Vector3();var B=new z.Matrix4();var u=function(F,E){return F.distance-E.distance};var x=function(Y,P,F){if(Y instanceof z.Particle){y.getPositionFromMatrix(Y.matrixWorld);var J=P.ray.distanceToPoint(y);if(J>Y.scale.x){return F}F.push({distance:J,point:Y.position,face:null,object:Y})}else{if(Y instanceof z.Mesh){var I=Y._getMMMatrix();y.getPositionFromMatrix(I);v.set(y,Y.geometry.boundingSphere.radius*I.getMaxScaleOnAxis());if(!P.ray.isIntersectionSphere(v)){return F}var K=Y.geometry;var L=K.vertices;var H=Y.material instanceof z.MeshFaceMaterial;var Q=H===true?Y.material.materials:null;var G=Y.material.side;var X,V,U,T;var R=P.precision;Y.matrixRotationWorld.extractRotation(I);B.getInverse(I);w.copy(P.ray).applyMatrix4(B);for(var S=0,N=K.faces.length;S<N;S++){var M=K.faces[S];var O=H===true?Q[M.materialIndex]:Y.material;if(O===undefined){continue}A.setFromNormalAndCoplanarPoint(M.normal,L[M.a]);var W=w.distanceToPlane(A);if(Math.abs(W)<R){continue}if(W<0){continue}G=O.side;if(G!==a.DoubleSide){var E=w.direction.dot(A.normal);if(!(G===a.FrontSide?E<0:E>0)){continue}}if(W<P.near||W>P.far){continue}C=w.at(W,C);if(M instanceof z.Face3){X=L[M.a];V=L[M.b];U=L[M.c];if(!z.Triangle.containsPoint(C,X,V,U)){continue}}else{if(M instanceof z.Face4){X=L[M.a];V=L[M.b];U=L[M.c];T=L[M.d];if((!z.Triangle.containsPoint(C,X,V,T))&&(!z.Triangle.containsPoint(C,V,U,T))){continue}}else{throw Error("face type not supported")}}F.push({distance:W,point:P.ray.at(W),face:M,faceIndex:S,object:Y})}}}};var D=function(G,F,I){var J=G.getDescendants();for(var H=0,E=J.length;H<E;H++){x(J[H],F,I)}};z.Raycaster.prototype.precision=0.0001;z.Raycaster.prototype.set=function(E,F){this.ray.set(E,F);if(this.ray.direction.length()>0){this.ray.direction.normalize()}};z.Raycaster.prototype.intersectObject=function(F,E){var G=[];if(E===true){D(F,this,G)}x(F,this,G);G.sort(u);return G};z.Raycaster.prototype.intersectObjects=function(I,F){var H=[];for(var G=0,E=I.length;G<E;G++){x(I[G],this,H);if(F===true){D(I[G],this,H)}}H.sort(u);return H}}(s));s.Object3D=function(){this.id=s.Object3DIdCount++;this.name="";this.parent=undefined;this.children=[];this.up=new s.Vector3(0,1,0);this.position=new s.Vector3();this.rotation=new s.Vector3();this.eulerOrder=s.Object3D.defaultEulerOrder;this.scale=new s.Vector3(1,1,1);this.worldCenter=new s.Vector3();this.worldRadius=0;this.isLargeScale=true;this._ratioData=null;this._distanceToCameraForLargeScale=0.1;this._programID=0;this.renderDepth=null;this.rotationAutoUpdate=true;this.matrix=new s.Matrix4();this.matrixWorld=new s.Matrix4();this.matrixRotationWorld=new s.Matrix4();this.modelViewInvTranspMatrix=null;this.modelInvTranspMatrix=null;this.matrixAutoUpdate=true;this.matrixWorldNeedsUpdate=true;this.quaternion=new s.Quaternion();this.useQuaternion=false;this.visible=true;this.visibilityFree=false;this.castShadow=false;this.receiveShadow=false;this.frustumCulled=true;this.userData={};this.__webglActive=null;this.__webglInit=false;this._modelViewMatrix=null;this._normalMatrix=null;this.isUniformlyScaled=true};s.TestDoubleAsFloat=new Float32Array(3);s.Object3D.prototype={constructor:s.Object3D,applyMatrix:function(){var u=new s.Matrix4();return function(v){this.matrix.multiplyMatrices(v,this.matrix);this.position.getPositionFromMatrix(this.matrix);this.scale.getScaleFromMatrix(this.matrix);this.isUniformlyScaled=Math.abs(this.scale.x-this.scale.y)<0.0001&&Math.abs(this.scale.z-this.scale.y)<0.0001?true:false;this._updateWorldCenterAndRadius();u.extractRotation(this.matrix);if(this.useQuaternion===true){this.quaternion.setFromRotationMatrix(u)}else{this.rotation.setEulerFromRotationMatrix(u,this.eulerOrder)}}}(),_computeLargeScaleStatus:function(){this.isLargeScale=false;var y=this._getMMMatrix().elements;var v=new s.Vector3(y[12],y[13],y[14]);s.TestDoubleAsFloat[0]=y[12];s.TestDoubleAsFloat[1]=y[13];s.TestDoubleAsFloat[2]=y[14];var A=new s.Vector3(s.TestDoubleAsFloat[0],s.TestDoubleAsFloat[1],s.TestDoubleAsFloat[2]);var z=this._distanceToCameraForLargeScale;var x=z*this.worldRadius;var w=0.005;if(Math.abs(A.x-v.x)>w*Math.abs(A.y+A.z+x)){this.isLargeScale=true;return}if(Math.abs(A.y-v.y)>w*Math.abs(A.x+A.z+x)){this.isLargeScale=true;return}if(Math.abs(A.z-v.z)>w*Math.abs(A.x+A.y+x)){this.isLargeScale=true;return}var u=0.00009;if(x<u*Math.abs(A.y+A.z)){this.isLargeScale=true;return}if(x<u*Math.abs(A.x+A.z)){this.isLargeScale=true;return}if(x<u*Math.abs(A.x+A.y)){this.isLargeScale=true;return}},_getMMMatrix:function(){if(this._ratioData&&this._ratioData.ratio>0&&this.matrixWorld){var y=this._ratioData.vptData();if(y){var u=new s.Vector3();u.getPositionFromMatrix(this.matrixWorld);var z=1/this.matrixWorld.getMaxScaleOnAxis();var x=y[this._ratioData.cameraName?this._ratioData.cameraName:"camera"];if(x.fullWidth){z*=x.height/x.fullHeight}var A=z*x.getWorldSizeFromPixelSize(1,u,y.viewer.div.clientHeight);var w=new s.Matrix4();if(this._ratioData.center){var B=new s.Vector3().copy(this._ratioData.center);B.multiplyScalar(A);var v=new s.Vector3().copy(B);v.applyMatrix4(this.matrixWorld);A=this._ratioData.ratio*z*x.getWorldSizeFromPixelSize(1,v,y.viewer.div.clientHeight);w.makeScale(A,A,A);w.setPosition(B)}else{A*=this._ratioData.ratio;w.makeScale(A,A,A)}var C=new s.Matrix4();C.multiplyMatrices(this.matrixWorld,w);return C}}return this.matrixWorld},_updateWorldCenterAndRadius:function(){var w=this.matrixWorld;var v=this.geometry&&this.geometry.boundingSphere;if(v){this.worldCenter.copy(v.center);this.worldRadius=v.radius;if(this._ratioData&&this._ratioData.ratio>0){if(this._ratioData.center){this.worldRadius+=this._ratioData.center.length()/this._ratioData.ratio}this.worldRadius+=this.worldCenter.length();this.worldRadius*=this._ratioData.ratio;this.worldCenter.set(0,0,0)}else{this.worldRadius*=w.getMaxScaleOnAxis()}}else{this.worldCenter.set(0,0,0);this.worldRadius=0}this.worldCenter.applyMatrix4(w);this.isLargeScale=true;if(this.isLargeScale){this._programID=this._programID|s.ProgramIDs.LARGE_SCALE}else{this._programID=this._programID&~s.ProgramIDs.LARGE_SCALE}if(this._ratioData&&this._ratioData.ratio>0){this._programID=this._programID|s.ProgramIDs.FIXED_SIZE}else{if(this._ratioData){this._programID=this._programID&~s.ProgramIDs.FIXED_SIZE}}if(this._ratioData&&this._ratioData.center){this._programID=this._programID|s.ProgramIDs.FIXED_SIZE_CENTER}else{if(this._ratioData){this._programID=this._programID&~s.ProgramIDs.FIXED_SIZE_CENTER}}if(!this.geometry){return}var y=null;var u=0;if(this.geometry.length>=0){y=this.geometry[0];u=this.geometry.length}else{if(this.geometry._type===2){y=this.geometry;u=1}}for(var x=0;x<u;x++){var z=this.geomWorldBE[x];if(y.boundingSphere){if(!z){this.geomWorldBE[x]={radius:0,center:new s.Vector3()};z=this.geomWorldBE[x]}if(y.boundingSphere){z.center.copy(y.boundingSphere.center);z.radius=y.boundingSphere.radius;if(this._ratioData&&this._ratioData.ratio>0){if(this._ratioData.center){z.radius+=this._ratioData.center.length()/this._ratioData.ratio}z.radius+=z.center.length();z.radius*=this._ratioData.ratio;z.center.set(0,0,0)}else{z.radius*=w.getMaxScaleOnAxis()}}else{z.radius=0;z.center.set(0,0,0)}z.center.applyMatrix4(w)}y=this.geometry[x+1]}},translate:function(){var u=new s.Vector3();return function(w,v){u.copy(v);if(this.useQuaternion===true){u.applyQuaternion(this.quaternion)}else{u.applyEuler(this.rotation,this.eulerOrder)}u.multiplyScalar(w);this.position.add(u);return this}}(),translateX:function(){var u=new s.Vector3(1,0,0);return function(v){return this.translate(v,u)}}(),translateY:function(){var u=new s.Vector3(0,1,0);return function(v){return this.translate(v,u)}}(),translateZ:function(){var u=new s.Vector3(0,0,1);return function(v){return this.translate(v,u)}}(),localToWorld:function(u){return u.applyMatrix4(this._getMMMatrix())},worldToLocal:function(){var u=new s.Matrix4();return function(v){return v.applyMatrix4(u.getInverse(this._getMMMatrix()))}}(),lookAt:function(){var u=new s.Matrix4();return function(v){u.lookAt(v,this.position,this.up);if(this.useQuaternion===true){this.quaternion.setFromRotationMatrix(u)}else{this.rotation.setEulerFromRotationMatrix(u,this.eulerOrder)}}}(),add:function(u,v){if(u===this){console.warn("THREE.Object3D.add: An object can't be added as a child of itself.");return}if(u instanceof s.Object3D){if(u.parent!==undefined){u.parent.remove(u)}u.parent=this;this.children.push(u);var w=this;while(w.parent!==undefined){w=w.parent}if(w!==undefined&&w instanceof s.Scene){w.__addObject(u,v)}}},remove:function(v){var u=this.children.indexOf(v);if(u!==-1){v.parent=undefined;this.children.splice(u,1);var w=this;while(w.parent!==undefined){w=w.parent}if(w!==undefined&&w instanceof s.Scene){w.__removeObject(v)}}},traverse:function(w){w(this);for(var v=0,u=this.children.length;v<u;v++){this.children[v].traverse(w)}},traverseObject3DWithCondition:function(w){if(w(this)){for(var v=0,u=this.children.length;v<u;v++){this.children[v].traverseObject3DWithCondition(w)}}},getChildByName:function(w,v){for(var x=0,u=this.children.length;x<u;x++){var y=this.children[x];if(y.name===w){return y}if(v===true){y=y.getChildByName(w,v);if(y!==undefined){return y}}}return undefined},getDescendants:function(w){if(w===undefined){w=[]}Array.prototype.push.apply(w,this.children);for(var v=0,u=this.children.length;v<u;v++){this.children[v].getDescendants(w)}return w},updateMatrix:function(){this.matrix.setPosition(this.position);if(this.useQuaternion===false){this.matrix.setRotationFromEuler(this.rotation,this.eulerOrder)}else{this.matrix.setRotationFromQuaternion(this.quaternion)}if(this.scale.x!==1||this.scale.y!==1||this.scale.z!==1){this.matrix.scale(this.scale)}this.isUniformlyScaled=Math.abs(this.scale.x-this.scale.y)<0.0001&&Math.abs(this.scale.z-this.scale.y)<0.0001?true:false;this._updateWorldCenterAndRadius();if(this.modelInvTranspMatrix!==null){this.modelInvTranspMatrix.getInverse(this.matrixWorld).transpose()}this.matrixWorldNeedsUpdate=true},updateMatrixWorld:function(w){if(!this.isRoot3ds){if(this.matrixAutoUpdate===true){this.updateMatrix()}if(this.matrixWorldNeedsUpdate===true||w===true){if(this.parent===undefined){this.matrixWorld.copy(this.matrix)}else{this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)}this._updateWorldCenterAndRadius();if(this.modelInvTranspMatrix!==null){this.modelInvTranspMatrix.getInverse(this.matrixWorld).transpose()}this.matrixWorldNeedsUpdate=false;w=true}for(var v=0,u=this.children.length;v<u;v++){this.children[v].updateMatrixWorld(w)}}},clone:function(u){if(u===undefined){u=new s.Object3D()}u.name=this.name;u.up.copy(this.up);u.position.copy(this.position);if(u.rotation instanceof s.Vector3){u.rotation.copy(this.rotation)}u.eulerOrder=this.eulerOrder;u.scale.copy(this.scale);u.renderDepth=this.renderDepth;u.rotationAutoUpdate=this.rotationAutoUpdate;u.matrix.copy(this.matrix);u.matrixWorld.copy(this.matrixWorld);u.matrixRotationWorld.copy(this.matrixRotationWorld);u.matrixAutoUpdate=this.matrixAutoUpdate;u.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate;u.quaternion.copy(this.quaternion);u.useQuaternion=this.useQuaternion;u.visible=this.visible;u.visibilityFree=this.visibilityFree;u.castShadow=this.castShadow;u.receiveShadow=this.receiveShadow;u._programID=this._programID;u.frustumCulled=this.frustumCulled;for(var v=0;v<this.children.length;v++){var w=this.children[v];u.add(w.clone())}return u},getWebGLObjects:function(){return null}};s.Object3D.defaultEulerOrder="XYZ",s.Object3DIdCount=0;s.Projector=function(){var ag,S,Y=[],E=0,O,w,y=[],v=0,D,Z,X=[],C=0,H,K=[],P=0,B,ad,af=[],N=0,aa,G,M=[],W=0,U={objects:[],sprites:[],lights:[],elements:[]},V=new s.Vector3(),T=new s.Vector4(),J=new s.Box3(new s.Vector3(-1,-1,-1),new s.Vector3(1,1,1)),ah=new s.Box3(),ac=new Array(3),ab=new Array(4),u=new s.Matrix4(),z=new s.Matrix4(),Q,R=new s.Matrix4(),I=new s.Matrix3(),F=new s.Matrix3(),x=new s.Vector3(),ae=new s.Frustum(),L=new s.Vector4(),A=new s.Vector4();this.projectVector=function(ai,aj){aj.matrixWorldInverse.getInverse(aj.matrixWorld);z.multiplyMatrices(aj.projectionMatrix,aj.matrixWorldInverse);return ai.applyProjection(z)};this.unprojectVector=function(ai,aj){aj.projectionMatrixInverse.getInverse(aj.projectionMatrix);z.multiplyMatrices(aj.matrixWorld,aj.projectionMatrixInverse);return ai.applyProjection(z)};this.pickingRay=function(aj,ak){aj.z=-1;var ai=new s.Vector3(aj.x,aj.y,1);this.unprojectVector(aj,ak);this.unprojectVector(ai,ak);ai.sub(aj).normalize();return new s.Raycaster(aj,ai)}};s.Face3=function(w,v,z,y,x,u){this.a=w;this.b=v;this.c=z;this.normal=y instanceof s.Vector3?y:new s.Vector3();this.vertexNormals=y instanceof Array?y:[];this.color=x instanceof s.Color?x:new s.Color();this.vertexColors=x instanceof Array?x:[];this.vertexTangents=[];this.materialIndex=u!==undefined?u:0;this.centroid=new s.Vector3()};s.Face3.prototype={constructor:s.Face3,clone:function(){var w=new s.Face3(this.a,this.b,this.c);w.normal.copy(this.normal);w.color.copy(this.color);w.centroid.copy(this.centroid);w.materialIndex=this.materialIndex;var v,u;for(v=0,u=this.vertexNormals.length;v<u;v++){w.vertexNormals[v]=this.vertexNormals[v].clone()}for(v=0,u=this.vertexColors.length;v<u;v++){w.vertexColors[v]=this.vertexColors[v].clone()}for(v=0,u=this.vertexTangents.length;v<u;v++){w.vertexTangents[v]=this.vertexTangents[v].clone()}return w}};s.Face4=function(w,v,A,z,y,x,u){this.a=w;this.b=v;this.c=A;this.d=z;this.normal=y instanceof s.Vector3?y:new s.Vector3();this.vertexNormals=y instanceof Array?y:[];this.color=x instanceof s.Color?x:new s.Color();this.vertexColors=x instanceof Array?x:[];this.vertexTangents=[];this.materialIndex=u!==undefined?u:0;this.centroid=new s.Vector3()};s.Face4.prototype={constructor:s.Face4,clone:function(){var w=new s.Face4(this.a,this.b,this.c,this.d);w.normal.copy(this.normal);w.color.copy(this.color);w.centroid.copy(this.centroid);w.materialIndex=this.materialIndex;var v,u;for(v=0,u=this.vertexNormals.length;v<u;v++){w.vertexNormals[v]=this.vertexNormals[v].clone()}for(v=0,u=this.vertexColors.length;v<u;v++){w.vertexColors[v]=this.vertexColors[v].clone()}for(v=0,u=this.vertexTangents.length;v<u;v++){w.vertexTangents[v]=this.vertexTangents[v].clone()}return w}};s.Geometry=function(){s.EventDispatcher.call(this);this.id=s.GeometryIdCount++;this.name="";this._type=0;this.vertices=[];this.colors=[];this.normals=[];this.faces=[];this.faceUvs=[[]];this.faceVertexUvs=[[]];this.morphTargets=[];this.morphColors=[];this.morphNormals=[];this.skinWeights=[];this.skinIndices=[];this.lineDistances=[];this.boundingBox=null;this.boundingSphere=null;this.hasTangents=false;this.dynamic=true;this.verticesNeedUpdate=false;this.elementsNeedUpdate=false;this.uvsNeedUpdate=false;this.normalsNeedUpdate=false;this.tangentsNeedUpdate=false;this.colorsNeedUpdate=false;this.lineDistancesNeedUpdate=false;this.buffersNeedUpdate=false};s.Geometry.prototype={constructor:s.Geometry,applyMatrix:function(v){var B=new s.Matrix3().getInverse(v).transpose();for(var y=0,u=this.vertices.length;y<u;y++){var A=this.vertices[y];A.applyMatrix4(v)}for(var y=0,u=this.faces.length;y<u;y++){var z=this.faces[y];z.normal.applyMatrix3(B).normalize();for(var w=0,x=z.vertexNormals.length;w<x;w++){z.vertexNormals[w].applyMatrix3(B).normalize()}z.centroid.applyMatrix4(v)}},computeCentroids:function(){var w,v,u;for(w=0,v=this.faces.length;w<v;w++){u=this.faces[w];u.centroid.set(0,0,0);if(u instanceof s.Face3){u.centroid.add(this.vertices[u.a]);u.centroid.add(this.vertices[u.b]);u.centroid.add(this.vertices[u.c]);u.centroid.divideScalar(3)}else{if(u instanceof s.Face4){u.centroid.add(this.vertices[u.a]);u.centroid.add(this.vertices[u.b]);u.centroid.add(this.vertices[u.c]);u.centroid.add(this.vertices[u.d]);u.centroid.divideScalar(4)}}}},computeFaceNormals:function(){var u=new s.Vector3(),B=new s.Vector3();for(var A=0,z=this.faces.length;A<z;A++){var y=this.faces[A];var x=this.vertices[y.a];var w=this.vertices[y.b];var v=this.vertices[y.c];u.subVectors(v,w);B.subVectors(x,w);u.cross(B);u.normalize();y.normal.copy(u)}},computeVertexNormals:function(A){var G,y,B,F,E,D;if(this.__tmpVertices===undefined){this.__tmpVertices=new Array(this.vertices.length);D=this.__tmpVertices;for(G=0,y=this.vertices.length;G<y;G++){D[G]=new s.Vector3()}for(B=0,F=this.faces.length;B<F;B++){E=this.faces[B];if(E instanceof s.Face3){E.vertexNormals=[new s.Vector3(),new s.Vector3(),new s.Vector3()]}else{if(E instanceof s.Face4){E.vertexNormals=[new s.Vector3(),new s.Vector3(),new s.Vector3(),new s.Vector3()]}}}}else{D=this.__tmpVertices;for(G=0,y=this.vertices.length;G<y;G++){D[G].set(0,0,0)}}if(A){var x,w,u,K;var z=new s.Vector3(),J=new s.Vector3(),I=new s.Vector3(),H=new s.Vector3(),C=new s.Vector3();for(B=0,F=this.faces.length;B<F;B++){E=this.faces[B];if(E instanceof s.Face3){x=this.vertices[E.a];w=this.vertices[E.b];u=this.vertices[E.c];z.subVectors(u,w);J.subVectors(x,w);z.cross(J);D[E.a].add(z);D[E.b].add(z);D[E.c].add(z)}else{if(E instanceof s.Face4){x=this.vertices[E.a];w=this.vertices[E.b];u=this.vertices[E.c];K=this.vertices[E.d];I.subVectors(K,w);J.subVectors(x,w);I.cross(J);D[E.a].add(I);D[E.b].add(I);D[E.d].add(I);H.subVectors(K,u);C.subVectors(w,u);H.cross(C);D[E.b].add(H);D[E.c].add(H);D[E.d].add(H)}}}}else{for(B=0,F=this.faces.length;B<F;B++){E=this.faces[B];if(E instanceof s.Face3){D[E.a].add(E.normal);D[E.b].add(E.normal);D[E.c].add(E.normal)}else{if(E instanceof s.Face4){D[E.a].add(E.normal);D[E.b].add(E.normal);D[E.c].add(E.normal);D[E.d].add(E.normal)}}}}for(G=0,y=this.vertices.length;G<y;G++){D[G].normalize()}for(B=0,F=this.faces.length;B<F;B++){E=this.faces[B];if(E instanceof s.Face3){E.vertexNormals[0].copy(D[E.a]);E.vertexNormals[1].copy(D[E.b]);E.vertexNormals[2].copy(D[E.c])}else{if(E instanceof s.Face4){E.vertexNormals[0].copy(D[E.a]);E.vertexNormals[1].copy(D[E.b]);E.vertexNormals[2].copy(D[E.c]);E.vertexNormals[3].copy(D[E.d])}}}},computeTangents:function(){var aa,G,Q,E,Z,I,O,B,H,W,T,S,A,z,y,D,C,ah,ag,M,L,ad,ac,K,J,U,R,x,af=[],ae=[],u=new s.Vector3(),F=new s.Vector3(),X=new s.Vector3(),ab=new s.Vector3(),Y=new s.Vector3(),P;for(Q=0,E=this.vertices.length;Q<E;Q++){af[Q]=new s.Vector3();ae[Q]=new s.Vector3()}function N(al,w,v,am,ak,aj,ai){W=al.vertices[w];T=al.vertices[v];S=al.vertices[am];A=H[ak];z=H[aj];y=H[ai];D=T.x-W.x;C=S.x-W.x;ah=T.y-W.y;ag=S.y-W.y;M=T.z-W.z;L=S.z-W.z;ad=z.x-A.x;ac=y.x-A.x;K=z.y-A.y;J=y.y-A.y;U=1/(ad*J-ac*K);u.set((J*D-K*C)*U,(J*ah-K*ag)*U,(J*M-K*L)*U);F.set((ad*C-ac*D)*U,(ad*ag-ac*ah)*U,(ad*L-ac*M)*U);af[w].add(u);af[v].add(u);af[am].add(u);ae[w].add(F);ae[v].add(F);ae[am].add(F)}for(aa=0,G=this.faces.length;aa<G;aa++){B=this.faces[aa];H=this.faceVertexUvs[0][aa];if(B instanceof s.Face3){N(this,B.a,B.b,B.c,0,1,2)}else{if(B instanceof s.Face4){N(this,B.a,B.b,B.d,0,1,3);N(this,B.b,B.c,B.d,1,2,3)}}}var V=["a","b","c","d"];for(aa=0,G=this.faces.length;aa<G;aa++){B=this.faces[aa];for(Z=0;Z<B.vertexNormals.length;Z++){Y.copy(B.vertexNormals[Z]);O=B[V[Z]];R=af[O];X.copy(R);X.sub(Y.multiplyScalar(Y.dot(R))).normalize();ab.crossVectors(B.vertexNormals[Z],R);x=ab.dot(ae[O]);P=(x<0)?-1:1;B.vertexTangents[Z]=new s.Vector4(X.x,X.y,X.z,P)}}this.hasTangents=true},computeBoundingBox:function(){if(this.boundingBox===null){this.boundingBox=new s.Box3()}this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){if(this.boundingSphere===null){this.boundingSphere=new s.Sphere()}this.boundingSphere.setFromCenterAndPoints(this.boundingSphere.center,this.vertices)},mergeVertices:function(){var x={};var w=[],O=[];var B,P;var D=4;var M=Math.pow(10,D);var K,A,z;var y,I,J,L,C;this.__tmpVertices=undefined;for(K=0,A=this.vertices.length;K<A;K++){B=this.vertices[K];P=[Math.round(B.x*M),Math.round(B.y*M),Math.round(B.z*M)].join("_");if(x[P]===undefined){x[P]=K;w.push(this.vertices[K]);O[K]=w.length-1}else{O[K]=O[x[P]]}}var F=[];for(K=0,A=this.faces.length;K<A;K++){z=this.faces[K];if(z instanceof s.Face3){z.a=O[z.a];z.b=O[z.b];z.c=O[z.c];y=[z.a,z.b,z.c];var H=-1;for(var G=0;G<3;G++){if(y[G]==y[(G+1)%3]){H=G;F.push(K);break}}}else{if(z instanceof s.Face4){z.a=O[z.a];z.b=O[z.b];z.c=O[z.c];z.d=O[z.d];y=[z.a,z.b,z.c,z.d];var H=-1;for(var G=0;G<4;G++){if(y[G]==y[(G+1)%4]){if(H>=0){F.push(K)}H=G}}if(H>=0){y.splice(H,1);var N=new s.Face3(y[0],y[1],y[2],z.normal,z.color,z.materialIndex);for(J=0,L=this.faceVertexUvs.length;J<L;J++){C=this.faceVertexUvs[J][K];if(C){C.splice(H,1)}}if(z.vertexNormals&&z.vertexNormals.length>0){N.vertexNormals=z.vertexNormals;N.vertexNormals.splice(H,1)}if(z.vertexColors&&z.vertexColors.length>0){N.vertexColors=z.vertexColors;N.vertexColors.splice(H,1)}this.faces[K]=N}}}}for(K=F.length-1;K>=0;K--){this.faces.splice(K,1);for(J=0,L=this.faceVertexUvs.length;J<L;J++){this.faceVertexUvs[J].splice(K,1)}}var E=this.vertices.length-w.length;this.vertices=w;return E},clone:function(){var C=new s.Geometry();var B=this.vertices;for(var A=0,D=B.length;A<D;A++){C.vertices.push(B[A].clone())}var w=this.faces;for(var A=0,D=w.length;A<D;A++){C.faces.push(w[A].clone())}var y=this.faceVertexUvs[0];for(var A=0,D=y.length;A<D;A++){var v=y[A],u=[];for(var x=0,z=v.length;x<z;x++){u.push(new s.Vector2(v[x].x,v[x].y))}C.faceVertexUvs[0].push(u)}return C},dispose:function(){this.dispatchEvent({type:"dispose"})}};s.GeometryIdCount=0;s.BufferGeometry=function(){s.EventDispatcher.call(this);this.id=s.GeometryIdCount++;this._type=1;this.attributes={};this.dynamic=false;this.offsets=[];this.boundingBox=null;this.boundingSphere=null;this.hasTangents=false;this.morphTargets=[]};s.BufferGeometry.prototype={constructor:s.BufferGeometry,applyMatrix:function(v){var u;var w;if(this.attributes.position){u=this.attributes.position.array}if(this.attributes.normal){w=this.attributes.normal.array}if(u!==undefined){v.multiplyVector3Array(u);this.verticesNeedUpdate=true}if(w!==undefined){var x=new s.Matrix3();x.getInverse(v).transpose();x.multiplyVector3Array(w);this.normalizeNormals();this.normalsNeedUpdate=true}},computeBoundingBox:function(){if(this.boundingBox===null){this.boundingBox=new s.Box3()}var v=this.attributes.position.array;if(v){var C=this.boundingBox;var u,D,B;if(v.length>=3){C.min.x=C.max.x=v[0];C.min.y=C.max.y=v[1];C.min.z=C.max.z=v[2]}for(var A=3,w=v.length;A<w;A+=3){u=v[A];D=v[A+1];B=v[A+2];if(u<C.min.x){C.min.x=u}else{if(u>C.max.x){C.max.x=u}}if(D<C.min.y){C.min.y=D}else{if(D>C.max.y){C.max.y=D}}if(B<C.min.z){C.min.z=B}else{if(B>C.max.z){C.max.z=B}}}}if(v===undefined||v.length===0){this.boundingBox.min.set(0,0,0);this.boundingBox.max.set(0,0,0)}},computeBoundingSphere:function(){if(this.boundingSphere===null){this.boundingSphere=new s.Sphere()}var w=this.attributes.position.array;if(w){var B,v=0;var u,E,D;for(var C=0,A=w.length;C<A;C+=3){u=w[C];E=w[C+1];D=w[C+2];B=u*u+E*E+D*D;if(B>v){v=B}}this.boundingSphere.radius=Math.sqrt(v)}},computeVertexNormals:function(){if(this.attributes.position){var O,F;var L,Q;var S=this.attributes.position.array.length;if(this.attributes.normal===undefined){this.attributes.normal={itemSize:3,array:new Float32Array(S),numItems:S}}else{for(O=0,F=this.attributes.normal.array.length;O<F;O++){this.attributes.normal.array[O]=0}}var C=this.attributes.position.array;var H=this.attributes.normal.array;var R,P,N,G,E,D,M=new s.Vector3(),K=new s.Vector3(),J=new s.Vector3(),I=new s.Vector3(),T=new s.Vector3();if(this.attributes.index){var w=this.attributes.index.array;var v=this.offsets;for(L=0,Q=v.length;L<Q;++L){var u=v[L].start;var B=v[L].count;var A=v[L].index;for(O=u,F=u+B;O<F;O+=3){R=A+w[O];P=A+w[O+1];N=A+w[O+2];G=C[R*3];E=C[R*3+1];D=C[R*3+2];M.set(G,E,D);G=C[P*3];E=C[P*3+1];D=C[P*3+2];K.set(G,E,D);G=C[N*3];E=C[N*3+1];D=C[N*3+2];J.set(G,E,D);I.subVectors(J,K);T.subVectors(M,K);I.cross(T);H[R*3]+=I.x;H[R*3+1]+=I.y;H[R*3+2]+=I.z;H[P*3]+=I.x;H[P*3+1]+=I.y;H[P*3+2]+=I.z;H[N*3]+=I.x;H[N*3+1]+=I.y;H[N*3+2]+=I.z}}}else{for(O=0,F=C.length;O<F;O+=9){G=C[O];E=C[O+1];D=C[O+2];M.set(G,E,D);G=C[O+3];E=C[O+4];D=C[O+5];K.set(G,E,D);G=C[O+6];E=C[O+7];D=C[O+8];J.set(G,E,D);I.subVectors(J,K);T.subVectors(M,K);I.cross(T);H[O]=I.x;H[O+1]=I.y;H[O+2]=I.z;H[O+3]=I.x;H[O+4]=I.y;H[O+5]=I.z;H[O+6]=I.x;H[O+7]=I.y;H[O+8]=I.z}}this.normalizeNormals();this.normalsNeedUpdate=true}},normalizeNormals:function(){var A=this.attributes.normal.array;var u,D,B,C;for(var w=0,v=A.length;w<v;w+=3){u=A[w];D=A[w+1];B=A[w+2];C=1/Math.sqrt(u*u+D*D+B*B);A[w]*=C;A[w+1]*=C;A[w+2]*=C}},computeTangents:function(){if(this.attributes.index===undefined||this.attributes.position===undefined||this.attributes.normal===undefined||this.attributes.uv===undefined){console.warn("Missing required attributes (index, position, normal or uv) in BufferGeometry.computeTangents()");return}var A=this.attributes.index.array;var I=this.attributes.position.array;var M=this.attributes.normal.array;var ae=this.attributes.uv.array;var L=I.length/3;if(this.attributes.tangent===undefined){var N=4*L;this.attributes.tangent={itemSize:4,array:new Float32Array(N),numItems:N}}var U=this.attributes.tangent.array;var az=[],ay=[];for(var ar=0;ar<L;ar++){az[ar]=new s.Vector3();ay[ar]=new s.Vector3()}var E,ap,T,D,ao,S,C,am,Q,B,al,z,aj,y,ah,K,J,aB,aA,ac,ab,ax,aw,aa,Z,ai;var F=new s.Vector3(),W=new s.Vector3();function ad(aC,w,aD){E=I[aC*3];ap=I[aC*3+1];T=I[aC*3+2];D=I[w*3];ao=I[w*3+1];S=I[w*3+2];C=I[aD*3];am=I[aD*3+1];Q=I[aD*3+2];B=ae[aC*2];al=ae[aC*2+1];z=ae[w*2];aj=ae[w*2+1];y=ae[aD*2];ah=ae[aD*2+1];K=D-E;J=C-E;aB=ao-ap;aA=am-ap;ac=S-T;ab=Q-T;ax=z-B;aw=y-B;aa=aj-al;Z=ah-al;ai=1/(ax*Z-aw*aa);F.set((Z*K-aa*J)*ai,(Z*aB-aa*aA)*ai,(Z*ac-aa*ab)*ai);W.set((ax*J-aw*K)*ai,(ax*aA-aw*aB)*ai,(ax*ab-aw*ac)*ai);az[aC].add(F);az[w].add(F);az[aD].add(F);ay[aC].add(W);ay[w].add(W);ay[aD].add(W)}var au,X;var at,H;var x,v,u;var P=this.offsets;for(at=0,H=P.length;at<H;++at){var R=P[at].start;var ak=P[at].count;var Y=P[at].index;for(au=R,X=R+ak;au<X;au+=3){x=Y+A[au];v=Y+A[au+1];u=Y+A[au+2];ad(x,v,u)}}var an=new s.Vector3(),av=new s.Vector3();var aq=new s.Vector3(),V=new s.Vector3();var af,ag,G;function O(w){aq.x=M[w*3];aq.y=M[w*3+1];aq.z=M[w*3+2];V.copy(aq);ag=az[w];an.copy(ag);an.sub(aq.multiplyScalar(aq.dot(ag))).normalize();av.crossVectors(V,ag);G=av.dot(ay[w]);af=(G<0)?-1:1;U[w*4]=an.x;U[w*4+1]=an.y;U[w*4+2]=an.z;U[w*4+3]=af}for(at=0,H=P.length;at<H;++at){var R=P[at].start;var ak=P[at].count;var Y=P[at].index;for(au=R,X=R+ak;au<X;au+=3){x=Y+A[au];v=Y+A[au+1];u=Y+A[au+2];O(x);O(v);O(u)}}this.hasTangents=true;this.tangentsNeedUpdate=true},dispose:function(){this.dispatchEvent({type:"dispose"})}};s.ImmediateRenderObject=function(){s.Object3D.call(this);this.render=function(u){}};s.ImmediateRenderObject.prototype=Object.create(s.Object3D.prototype);s.Camera=function(){s.Object3D.call(this);this.matrixWorldInverse=new s.Matrix4();this.projectionMatrix=new s.Matrix4();this.projectionMatrixInverse=new s.Matrix4();this.realProjectionMatrixInverse=new s.Matrix4();this.pixelCulling=4.5;this.isOrtho=false;this._hasChanged=true;this.externalProjectionMatrix=false;this.fixedSizeCameraConstant=1;this.pixelCullingCst=0;this._viewpoint=null;this.aspect=1};s.Camera.prototype=Object.create(s.Object3D.prototype);s.Camera.prototype.lookAt=function(){var u=new s.Matrix4();return function(v){u.lookAt(this.position,v,this.up);if(this.useQuaternion===true){this.quaternion.setFromRotationMatrix(u)}else{this.rotation.setEulerFromRotationMatrix(u,this.eulerOrder)}}}();s.Camera.prototype.setViewOffsetInternal=function(B,w,v,C,z,u,A){this.fullWidth=B;this.fullHeight=w;this.x=v;this.y=C;this.width=z;if(A&&this.height){this.visualizedHeight=this.height}else{this.visualizedHeight=0}if(A){this.pickingRatioW=A.ratioW;this.pickingRatioH=A.ratioH}else{this.pickingRatioW=null;this.pickingRatioH=null}this.height=u;this._hasChanged=true;this.realProjectionMatrixInverse=this.projectionMatrixInverse.clone();this.updateProjectionMatrix()};s.Camera.prototype.setViewOffset=function(A,w,v,B,z,u){console.warn("deprecated ! use viewpoint.setViewOffset instead");this.setViewOffsetInternal(A,w,v,B,z,u)};s.OrthographicCamera=function(z,w,y,v,x,u){s.Camera.call(this);this.left=z;this.right=w;this.top=y;this.bottom=v;this.near=(x!==undefined)?x:0.1;this.far=(u!==undefined)?u:2000;this.fov=45;this.isOrtho=true;this.updateProjectionMatrix();this.visualizedHeight=400};s.OrthographicCamera.prototype=Object.create(s.Camera.prototype);s.OrthographicCamera.prototype.getCameraConstant=function(u,v){return u*(this.top-this.bottom)/(v||1)};s.OrthographicCamera.prototype.getWorldSizeFromPixelSize=function(v,u,w){return v*(this.top-this.bottom)/(w||1)};s.OrthographicCamera.prototype.performPixelAndFrustumCulling=function(B,y,x){var v=x.worldCenter;var u=x.worldRadius;x.renderPointsOnly=false;var w=this.pixelCulling;if(w>0){var A=w;if(!x._ratioData||x._ratioData.ratio===0){A=this.pixelCullingCst}if(u<A){if(x.hasPoint===false){return false}else{x.renderPointsOnly=true}}}var z=u;if(x._ratioData&&x._ratioData.ratio>0){z*=this.fixedSizeCameraConstant}return B.performFrustumCulling(z,v)};s.OrthographicCamera.prototype.updateProjectionMatrix=function(y,w){var x=Math.abs(this.right-this.left);var v=Math.abs(this.top-this.bottom);var u=y?y:0;var z=w?w:0;if(this.fullWidth){this.aspect=this.fullWidth/this.fullHeight;this.projectionMatrix.makeOrthographic(this.left+((this.x+u*this.width)/this.fullWidth)*x,this.left+((this.x+(1+u)*this.width)/this.fullWidth)*x,this.top-((this.y+z*this.height)/this.fullHeight)*v,this.top-((this.y+(1+z)*this.height)/this.fullHeight)*v,this.near,this.far)}else{this.projectionMatrix.makeOrthographic(this.left+u*x,this.right+u*x,this.top+z*v,this.bottom+z*v,this.near,this.far)}this.projectionMatrixInverse.getInverse(this.projectionMatrix)};s.PerspectiveCamera=function(w,v,x,u){s.Camera.call(this);this.fov=w!==undefined?w:50;this.aspect=v!==undefined?v:1;this.near=x!==undefined?x:0.1;this.far=u!==undefined?u:2000;this.updateProjectionMatrix()};s.PerspectiveCamera.prototype=Object.create(s.Camera.prototype);s.PerspectiveCamera.prototype.setLens=function(v,u){if(u===undefined){u=24}this.fov=2*s.Math.radToDeg(Math.atan(u/(v*2)));this.updateProjectionMatrix()};s.PerspectiveCamera.prototype.getCameraConstant=function(v,w){var u=2*Math.tan(0.5*this.fov*Math.PI/180)*v/(w||1);return u};s.PerspectiveCamera.prototype.getWorldSizeFromPixelSize=function(w,v,x){var y=this.matrixWorldInverse.elements;var z=Math.abs(y[2]*v.x+y[6]*v.y+y[10]*v.z+y[14]);var u=2*z*Math.tan(0.5*this.fov*Math.PI/180)*w/(x||1);return u};s.PerspectiveCamera.prototype.performPixelAndFrustumCulling=function(B,w,v){var u=v.worldCenter;var x=v.worldRadius;v.renderPointsOnly=false;var D=this.pixelCulling;var y=this.matrixWorldInverse.elements;if(D>0){var z=D;if(!v._ratioData||v._ratioData.ratio===0){var A=Math.abs(y[2]*u.x+y[6]*u.y+y[10]*u.z+y[14]);z=this.pixelCullingCst*A}if(x<z){if(v.hasPoint===false){return false}else{v.renderPointsOnly=true}}}var C=x;if(v._ratioData&&v._ratioData.ratio>0){var A=Math.abs(y[2]*u.x+y[6]*u.y+y[10]*u.z+y[14]);var w=this.fixedSizeCameraConstant*A;C*=w}return B.performFrustumCulling(C,u)};s.PerspectiveCamera.prototype.performPixelAndFrustumCullingOnGeometry=function(E,y,w,D){if((D._type!==2)||!w.frustumCulled){return true}var x=(D===w.geometry)?D:w.geometry.indexOf(D);var u=w.geomWorldBE[x];if(!u){return true}var v=u.center;var z=u.radius;var G=this.pixelCulling;var A=this.matrixWorldInverse.elements;if(G>0){var B=G;if(!w._ratioData||w._ratioData.ratio===0){var C=Math.abs(A[2]*v.x+A[6]*v.y+A[10]*v.z+A[14]);B=this.pixelCullingCst*C}if(z<B){return false}}var F=z;if(w._ratioData&&w._ratioData.ratio>0){var C=Math.abs(A[2]*v.x+A[6]*v.y+A[10]*v.z+A[14]);var y=this.fixedSizeCameraConstant*C;F*=y}return E.performFrustumCulling(F,v)};s.PerspectiveCamera.prototype.performPixelCullingOnDG=function(C,N,I,L,z,B){var A=N.geometry.indexOf(I);var w=N.geomWorldBE[A];if(!w){return B}var x=w.center;var E=this.pixelCulling;if(E>0){var F=0;var J=L.cullingData.length-1;var M=this.matrixWorldInverse.elements;while(J-F>1){var K=Math.floor(0.5*(F+J));var u=L.cullingData[K];var H=u.start;if(u.start<z){F=K}if(u.start>z+B){return B}var y=u.radius;var D=E;if(!N._ratioData||N._ratioData.ratio===0){var G=Math.abs(M[2]*x.x+M[6]*x.y+M[10]*x.z+M[14])-y;D=this.pixelCullingCst*G}else{y*=N._ratioData.ratio/N.matrixWorld.getMaxScaleOnAxis()}if(y<D){J=K}else{F=K}}var v=J;if(F!==J){var u=L.cullingData[F];var y=u.radius;var D=E;if(!N._ratioData||N._ratioData.ratio===0){var G=Math.abs(M[2]*x.x+M[6]*x.y+M[10]*x.z+M[14])-y;D=this.pixelCullingCst*G}else{y*=N._ratioData.ratio/N.matrixWorld.getMaxScaleOnAxis()}if(y<D){v=F}}if(v<L.cullingData.length-1){var u=L.cullingData[v];return u.start-z}}return B};s.PerspectiveCamera.prototype.updateProjectionMatrix=function(E,B){if(this.externalProjectionMatrix){return}if(this.fullWidth){var u=this.fullWidth/this.fullHeight;var A=Math.tan(s.Math.degToRad(this.fov*0.5))*this.near;var v=-A;var x=u*v;var C=u*A;var w=Math.abs(C-x);var D=Math.abs(A-v);var z=E?E:0;var y=B?B:0;this.projectionMatrix.makeFrustum(x+((this.x+z*this.width)/this.fullWidth)*w,x+((this.x+(1+z)*this.width)/this.fullWidth)*w,A-((this.y+(1+y)*this.height)/this.fullHeight)*D,A-((this.y+y*this.height)/this.fullHeight)*D,this.near,this.far)}else{this.projectionMatrix.makePerspective(this.fov,this.aspect,this.near,this.far,E,B)}this.projectionMatrixInverse.getInverse(this.projectionMatrix)};s.Light=function(u){s.Object3D.call(this);this.onlyShadow=false;u=u instanceof s.Color?u:new s.Color(u);this.color=u;this._vptPosition=null};s.Light.prototype=Object.create(s.Object3D.prototype);s.Light.prototype.clone=function(u){if(u===undefined){u=new s.Light()}s.Object3D.prototype.clone.call(this,u);u.color.copy(this.color);u._vptPosition=this._vptPosition;return u};s.Light.prototype.allocateShadows=function(v,u){return 0};s.Light.prototype.setup=function(x,u,v,w){};s.Light.prototype.allocate=function(u){};s.AmbientLight=function(u){s.Light.call(this,u)};s.AmbientLight.prototype=Object.create(s.Light.prototype);s.AmbientLight.prototype.clone=function(u){if(u===undefined){u=new s.AmbientLight()}s.Light.prototype.clone.call(this,u);return u};s.AmbientLight.prototype.setup=function(y,v,w,x){if(!this.visible){return}var u=this.color;if(x.gammaInput){y.ambient.r+=u.r*u.r;y.ambient.g+=u.g*u.g;y.ambient.b+=u.b*u.b}else{y.ambient.r+=u.r;y.ambient.g+=u.g;y.ambient.b+=u.b}};s.SphereLight=function(w,v,u){s.Light.call(this,w);this.intensity=(v!==undefined)?v:1;this.radius=(u!==undefined)?u:1};s.SphereLight.prototype=Object.create(s.Light.prototype);s.SphereLight.prototype.clone=function(u){if(u===undefined){u=new s.SphereLight()}s.Light.prototype.clone.call(this,u);u.intensity=this.intensity;u.radius=this.radius;return u};s.SphereLight.prototype.setup=function(z,w,x,y){z.sphere.sphereCount+=1;if(!this.visible){return}var v=z.sphere.sphereLength*3;if(y.gammaInput){w(z.sphere.sphereColors,v,this.color,this.intensity*this.intensity)}else{x(z.sphere.sphereColors,v,this.color,this.intensity)}var u=new s.Vector3();u.getPositionFromMatrix(this.matrixWorld);z.sphere.spherePositions[v]=u.x;z.sphere.spherePositions[v+1]=u.y;z.sphere.spherePositions[v+2]=u.z;z.sphere.sphereData[v]=this.radius;z.sphere.sphereData[v+1]=0;z.sphere.sphereData[v+2]=0;z.sphere.sphereLength+=1};s.SphereLight.prototype.allocate=function(u){u.sphereLights++};s.DiskLight=function(w,v,u){s.Light.call(this,w);this.intensity=(v!==undefined)?v:1;this.radius=(u!==undefined)?u:1};s.DiskLight.prototype=Object.create(s.Light.prototype);s.DiskLight.prototype.clone=function(u){if(u===undefined){u=new s.DiskLight()}s.Light.prototype.clone.call(this,u);u.intensity=this.intensity;u.radius=this.radius;return u};s.DiskLight.prototype.setup=function(A,x,y,z){A.disk.diskCount+=1;if(!this.visible){return}var w=A.disk.diskLength*3;if(z.gammaInput){x(A.disk.diskColors,w,this.color,this.intensity*this.intensity)}else{y(A.disk.diskColors,w,this.color,this.intensity)}var v=new s.Vector3();v.getPositionFromMatrix(this.matrixWorld);A.disk.diskPositions[w]=v.x;A.disk.diskPositions[w+1]=v.y;A.disk.diskPositions[w+2]=v.z;var u=new s.Vector4();u.getColumnFromMatrix(2,this.matrixWorld);u.w=0;A.disk.diskNormals[w]=u.x;A.disk.diskNormals[w+1]=u.y;A.disk.diskNormals[w+2]=u.z;A.disk.diskData[w]=this.radius;A.disk.diskData[w+1]=0;A.disk.diskData[w+2]=0;A.disk.diskLength+=1};s.DiskLight.prototype.allocate=function(u){u.diskLights++};s.TubeLight=function(w,v,u,x){s.Light.call(this,w);this.intensity=(v!==undefined)?v:1;this.radius=(u!==undefined)?u:1;this.width=(x!==undefined)?x:1};s.TubeLight.prototype=Object.create(s.Light.prototype);s.TubeLight.prototype.clone=function(u){if(u===undefined){u=new s.TubeLight()}s.Light.prototype.clone.call(this,u);u.intensity=this.intensity;u.radius=this.radius;u.width=this.width;return u};s.TubeLight.prototype.setup=function(A,w,x,z){A.tube.tubeCount+=1;if(!this.visible){return}var y=A.tube.tubeLength*3;if(z.gammaInput){w(A.tube.tubeColors,y,this.color,this.intensity*this.intensity)}else{x(A.tube.tubeColors,y,this.color,this.intensity)}var v=new s.Vector3();v.getPositionFromMatrix(this.matrixWorld);A.tube.tubePositions[y]=v.x;A.tube.tubePositions[y+1]=v.y;A.tube.tubePositions[y+2]=v.z;var u=new s.Vector4();u.getColumnFromMatrix(0,this.matrixWorld);u.w=0;A.tube.tubeRights[y]=u.x;A.tube.tubeRights[y+1]=u.y;A.tube.tubeRights[y+2]=u.z;A.tube.tubeData[y]=this.radius;A.tube.tubeData[y+1]=this.width;A.tube.tubeData[y+2]=0;A.tube.tubeLength+=1};s.TubeLight.prototype.allocate=function(u){u.tubeLights++};s.AreaLight=function(w,v,x,u){s.Light.call(this,w);this.intensity=(v!==undefined)?v:1;this.height=(u!==undefined)?u:1;this.width=(x!==undefined)?x:1};s.AreaLight.prototype=Object.create(s.Light.prototype);s.AreaLight.prototype.clone=function(u){if(u===undefined){u=new s.AreaLight()}s.Light.prototype.clone.call(this,u);u.intensity=this.intensity;u.width=this.width;u.height=this.height;return u};s.AreaLight.prototype.setup=function(B,y,z,A){B.area.areaCount+=1;if(!this.visible){return}var w=B.area.areaLength*3;if(A.gammaInput){y(B.area.areaColors,w,this.color,this.intensity)}else{z(B.area.areaColors,w,this.color,this.intensity)}var x=B.camera.matrixWorldInverse;var v=new s.Vector3();v.getPositionFromMatrix(this.matrixWorld);B.area.areaPositions[w]=v.x;B.area.areaPositions[w+1]=v.y;B.area.areaPositions[w+2]=v.z;var u=new s.Vector4();u.getColumnFromMatrix(2,this.matrixWorld);u.w=0;B.area.areaNormals[w]=u.x;B.area.areaNormals[w+1]=u.y;B.area.areaNormals[w+2]=u.z;u.getColumnFromMatrix(0,this.matrixWorld);u.w=0;B.area.areaRights[w]=u.x;B.area.areaRights[w+1]=u.y;B.area.areaRights[w+2]=u.z;u.getColumnFromMatrix(1,this.matrixWorld);u.w=0;B.area.areaUps[w]=u.x;B.area.areaUps[w+1]=u.y;B.area.areaUps[w+2]=u.z;B.area.areaData[w]=this.width;B.area.areaData[w+1]=this.height;B.area.areaData[w+2]=0;B.area.areaLength+=1};s.AreaLight.prototype.allocate=function(u){u.areaLights++};s.DirectionalLight=function(v,u){s.Light.call(this,v);this.position.set(0,1,0);this.target=new s.Object3D();this.intensity=(u!==undefined)?u:1;this.castShadow=false;this.onlyShadow=false;this.castGroundShadow=false;this.shadowCameraNear=50;this.shadowCameraFar=5000;this.shadowCameraLeft=-500;this.shadowCameraRight=500;this.shadowCameraTop=500;this.shadowCameraBottom=-500;this.shadowCameraVisible=false;this.shadowCameraHelperToUpdate=true;this.shadowBias=0;this.shadowDarkness=0.5;this.shadowMapWidth=512;this.shadowMapHeight=512;this.shadowCascade=false;this.shadowCascadeOffset=new s.Vector3(0,0,-1000);this.shadowCascadeCount=2;this.shadowCascadeBias=[0,0,0];this.shadowCascadeWidth=[512,512,512];this.shadowCascadeHeight=[512,512,512];this.shadowCascadeNearZ=[-1,0.99,0.998];this.shadowCascadeFarZ=[0.99,0.998,1];this.shadowCascadeArray=[];this.updateShadowMap=true;this.blockUpdate=false;this.shadowMap=null;this.shadowMapSize=null;this.shadowCamera=null;this.shadowMatrix=null;this.LiSPSM=false};s.DirectionalLight.prototype=Object.create(s.Light.prototype);s.DirectionalLight.prototype.clone=function(u){if(u===undefined){u=new s.DirectionalLight()}s.Light.prototype.clone.call(this,u);if(this.target!==null){this.target.clone(u.target)}else{u.target=null}u.intensity=this.intensity;u.castShadow=this.castShadow;u.onlyShadow=this.onlyShadow;return u};s.DirectionalLight.prototype.allocateShadows=function(v,u){if(!this.shadowCascade&&(!this.isVirtual||v.shadowMapCascade)){u.tex2d++;u.dirLight++}return 0};s.DirectionalLight.prototype.setup=function(A,w,x,y){A.directional.dirCount+=1;if(!this.visible){return}var z=new s.Vector3(),v=new s.Vector3();if(!this.target){z.set(0,0,1);z.applyMatrix4(new s.Matrix4().extractRotation(this.matrixWorld))}else{if(this._occurrence&&this._occurrence.node._attachedToVpt){z.copy(this._vptPosition)}else{z.getPositionFromMatrix(this.matrixWorld)}z.sub(this.target.position);if(z.x===0&&z.y===0&&z.z===0){z.set(0,0,1);z.applyMatrix4(new s.Matrix4().extractRotation(this.matrixWorld))}}z.normalize();if(z.x===0&&z.y===0&&z.z===0){return}var u=A.directional.dirLength*3;A.directional.dirPositions[u]=z.x;A.directional.dirPositions[u+1]=z.y;A.directional.dirPositions[u+2]=z.z;A.directional.dirFars[A.directional.dirLength]=this.shadowCamera?this.shadowCamera.far:0;A.directional.dirNears[A.directional.dirLength]=this.shadowCamera?this.shadowCamera.near:0;if(y.gammaInput){if(s.intensityCorrection){w(A.directional.dirColors,u,this.color,this.intensity)}else{w(A.directional.dirColors,u,this.color,this.intensity*this.intensity)}}else{x(A.directional.dirColors,u,this.color,this.intensity)}A.directional.dirLength+=1};s.DirectionalLight.prototype.allocate=function(u){u.dirLights++};s.HemisphereLight=function(v,w,u){s.Light.call(this,v);this.position.set(0,100,0);w=w instanceof s.Color?w:new s.Color("rgb(0,0,0)");this.groundColor=w;this.intensity=(u!==undefined)?u:1};s.HemisphereLight.prototype=Object.create(s.Light.prototype);s.HemisphereLight.prototype.clone=function(){var u=new s.HemisphereLight();s.Light.prototype.clone.call(this,u);u.groundColor.copy(this.groundColor);u.intensity=this.intensity;return u};s.HemisphereLight.prototype.setup=function(B,v,x,y){B.hemi.hemiCount+=1;if(!this.visible){return}var A=new s.Vector3();A.set(0,0,1);A.applyMatrix4(new s.Matrix4().extractRotation(this.matrixWorld));A.normalize();if(A.x===0&&A.y===0&&A.z===0){return}var u=B.hemi.hemiLength*3;B.hemi.hemiPositions[u]=A.x;B.hemi.hemiPositions[u+1]=A.y;B.hemi.hemiPositions[u+2]=A.z;var w=this.color;var z=this.groundColor;if(y.gammaInput){v(B.hemi.hemiSkyColors,u,w,this.intensity);v(B.hemi.hemiGroundColors,u,z,this.intensity)}else{x(B.hemi.hemiSkyColors,u,w,this.intensity);x(B.hemi.hemiGroundColors,u,z,this.intensity)}B.hemi.hemiLength+=1};s.HemisphereLight.prototype.allocate=function(u){u.hemiLights++};s.PointLight=function(v,u,w){s.Light.call(this,v);this.intensity=(u!==undefined)?u:1;this.distance=(w!==undefined)?w:0;this.isPhysicallyAttenuated=false;this.attenuationScale=1;this.shadowCameraNear=50;this.shadowCameraFar=5000;this.shadowCameraFov=90;this.shadowCameraVisible=false;this.shadowCameraHelperToUpdate=true;this.shadowBias=0;this.shadowDarkness=0.5;this.shadowMapWidth=512;this.shadowMapHeight=512;this.updateShadowMap=true;this.shadowMap=null;this.shadowMapSize=null;this.shadowCameras=null;this.shadowMatrix=null};s.PointLight.prototype=Object.create(s.Light.prototype);s.PointLight.prototype.clone=function(u){if(u===undefined){u=new s.PointLight()}s.Light.prototype.clone.call(this,u);u.intensity=this.intensity;u.distance=this.distance;u.isPhysicallyAttenuated=this.isPhysicallyAttenuated;u.attenuationScale=this.attenuationScale;u.castShadow=this.castShadow;u.onlyShadow=this.onlyShadow;return u};s.PointLight.prototype.allocateShadows=function(v,u){u.texCube++};s.PointLight.prototype.setup=function(z,w,x,y){z.point.pointCount+=1;if(!this.visible){return}var v=z.point.pointLength*3;if(y.gammaInput){if(s.intensityCorrection){w(z.point.pointColors,v,this.color,this.intensity)}else{w(z.point.pointColors,v,this.color,this.intensity*this.intensity)}}else{x(z.point.pointColors,v,this.color,this.intensity)}var u=new s.Vector3();if(this._occurrence&&this._occurrence.node._attachedToVpt){u.copy(this._vptPosition)}else{u.getPositionFromMatrix(this.matrixWorld)}z.point.pointPositions[v]=u.x;z.point.pointPositions[v+1]=u.y;z.point.pointPositions[v+2]=u.z;z.point.pointPhysicalAttenuations[z.point.pointLength]=this.isPhysicallyAttenuated;z.point.pointDistances[z.point.pointLength]=this.isPhysicallyAttenuated?this.attenuationScale:this.distance;z.point.pointLength+=1};s.PointLight.prototype.setupShadowPositions=function(v){if(!this.visible){return}var u=new s.Vector3();if(this._occurrence&&this._occurrence.node._attachedToVpt){u.copy(this._vptPosition)}else{u.getPositionFromMatrix(this.matrixWorld)}v.push(u.x);v.push(u.y);v.push(u.z)};s.PointLight.prototype.allocate=function(u){u.pointLights++};s.SpotLight=function(w,u,y,v,x){s.Light.call(this,w);this.position.set(0,1,0);this.target=new s.Object3D();this.intensity=(u!==undefined)?u:1;this.distance=(y!==undefined)?y:0;this.angle=(v!==undefined)?v:Math.PI/2;this.innerAngle=(x!==undefined)?x:this.angle-0.001;this.exponent=1;this.isPhysicallyAttenuated=false;this.attenuationScale=1;this.castShadow=false;this.onlyShadow=false;this.shadowCameraNear=50;this.shadowCameraFar=5000;this.shadowCameraFov=50;this.shadowCameraVisible=false;this.shadowCameraHelperToUpdate=true;this.shadowBias=0;this.shadowDarkness=0.5;this.shadowMapWidth=512;this.shadowMapHeight=512;this.updateShadowMap=true;this.shadowMap=null;this.shadowMapSize=null;this.shadowCamera=null;this.shadowMatrix=null};s.SpotLight.prototype=Object.create(s.Light.prototype);s.SpotLight.prototype.clone=function(u){if(u===undefined){u=new s.SpotLight()}s.Light.prototype.clone.call(this,u);if(this.target!==null){this.target.clone(u.target)}else{u.target=null}u.intensity=this.intensity;u.localDirection=this.localDirection;u.distance=this.distance;u.angle=this.angle;u.innerAngle=this.innerAngle;u.exponent=this.exponent;u.castShadow=this.castShadow;u.onlyShadow=this.onlyShadow;u.isPhysicallyAttenuated=this.isPhysicallyAttenuated;u.attenuationScale=this.attenuationScale;return u};s.SpotLight.prototype.allocateShadows=function(v,u){u.tex2d++;u.spotLight++};s.SpotLight.prototype.setup=function(B,x,y,z){B.spot.spotCount+=1;if(!this.visible){return}var w=B.spot.spotLength*3;if(z.gammaInput){if(s.intensityCorrection){x(B.spot.spotColors,w,this.color,this.intensity)}else{x(B.spot.spotColors,w,this.color,this.intensity*this.intensity)}}else{y(B.spot.spotColors,w,this.color,this.intensity)}var v=new s.Vector3();if(this._occurrence&&this._occurrence.node._attachedToVpt){v.copy(this._vptPosition)}else{v.getPositionFromMatrix(this.matrixWorld)}var A=new s.Vector3();B.spot.spotPositions[w]=v.x;B.spot.spotPositions[w+1]=v.y;B.spot.spotPositions[w+2]=v.z;var u=B.spot.spotLength;B.spot.spotPhysicalAttenuations[u]=this.isPhysicallyAttenuated;B.spot.spotDistances[u]=this.isPhysicallyAttenuated?this.attenuationScale:this.distance;if(!this.target){A.set(0,0,1);A.applyMatrix4(new s.Matrix4().extractRotation(this.matrixWorld))}else{A.copy(v);A.sub(this.target.position);if(A.x===0&&A.y===0&&A.z===0){A.set(0,0,1);A.applyMatrix4(new s.Matrix4().extractRotation(this.matrixWorld))}}A.normalize();B.spot.spotDirections[w]=A.x;B.spot.spotDirections[w+1]=A.y;B.spot.spotDirections[w+2]=A.z;B.spot.spotAnglesCos[u]=Math.cos(this.angle);B.spot.spotInnerAnglesCos[u]=Math.cos(this.innerAngle);B.spot.spotLength+=1};s.SpotLight.prototype.allocate=function(u){u.spotLights++};s.IESLight=function(v,u,x,w){s.Light.call(this,v);this.intensity=(u!==undefined)?u:1;this.distance=(x!==undefined)?x:0;this.iesTexture=w};s.IESLight.prototype=Object.create(s.Light.prototype);s.IESLight.prototype.clone=function(u){if(u===undefined){u=new s.IESLight()}s.Light.prototype.clone.call(this,u);u.intensity=this.intensity;u.distance=this.distance;u.iesTexture=this.iesTexture;return u};s.IESLight.prototype.setup=function(A,w,x,y){A.ies.iesCount+=1;if(!this.visible){return}var v=A.ies.iesLength*3;if(y.gammaInput){w(A.ies.iesColors,v,this.color,this.intensity)}else{x(A.ies.iesColors,v,this.color,this.intensity)}var u=new s.Vector3();if(this._occurrence&&this._occurrence.node._attachedToVpt){u.copy(this._vptPosition)}else{u.getPositionFromMatrix(this.matrixWorld)}A.ies.iesPositions[v]=u.x;A.ies.iesPositions[v+1]=u.y;A.ies.iesPositions[v+2]=u.z;A.ies.iesDistances[A.ies.iesLength]=this.distance;A.ies.iesLightTexture[A.ies.iesCount-1]=this.iesTexture;var z=new s.Matrix4();A.ies.matrixWorldInv[A.ies.iesCount-1]=z.getInverse(this.matrixWorld);A.ies.iesLength+=1};s.IESLight.prototype.allocate=function(u){u.iesLights++};s.ProbeLight=function(v,u){s.Light.call(this,16777215);this.envMap=(v!==undefined)?v:null;this.intensity=(u!==undefined)?u:1;this.shScale=0.333};s.ProbeLight.prototype=Object.create(s.Light.prototype);s.ProbeLight.prototype.clone=function(u){if(u===undefined){u=new s.ProbeLight()}s.Light.prototype.clone.call(this,u);u.envMap=this.envMap;u.intensity=this.intensity;u.shScale=this.shScale;return u};s.ProbeLight.prototype.setup=function(x,u,v,w){if(!this.visible){return}if(!this.envMap){return}x.probe.shFactorsR=this.envMap.shFactorsR;x.probe.shFactorsG=this.envMap.shFactorsG;x.probe.shFactorsB=this.envMap.shFactorsB;x.probe.shScale=this.shScale};s.ProbeLight.prototype.allocate=function(u){u.probeLight=true};s.ImageLoader=function(){s.EventDispatcher.call(this);this.crossOrigin=null};s.ImageLoader.prototype={constructor:s.ImageLoader,load:function(u,w){var v=this;if(w===undefined){w=new Image()}w.addEventListener("load",function(){v.dispatchEvent({type:"load",content:w})},false);w.addEventListener("error",function(){v.dispatchEvent({type:"error",message:"Couldn't load URL ["+u+"]"})},false);if(v.crossOrigin){w.crossOrigin=v.crossOrigin}w.src=u}};s.SkinningTransformations=function(){this.useEulerAngles=false;this.skinningMap=null;this.skinningMapWidth=0;this.skinningMapWidth=0};s.SkinningTransformations.prototype.setSkinningMatrices=function(x,u){if(!this.skinningMapWidth||!this.skinningMapHeight){var w;if(u>256){w=64}else{if(u>64){w=32}else{if(u>16){w=16}else{w=8}}}this.skinningMapWidth=w;this.skinningMapHeight=w}this.useEulerAngles=false;if(!this.skinningMap){var v=new Float32Array(this.skinningMapWidth*this.skinningMapHeight*3);v.set(x,0);this.skinningMap=new s.DataTexture(v,this.skinningMapWidth,this.skinningMapHeight,s.RGBFormat,s.FloatType);this.skinningMap.minFilter=s.NearestFilter;this.skinningMap.magFilter=s.NearestFilter;this.skinningMap.generateMipmaps=false;this.skinningMap.flipY=false}else{this.skinningMap.image.data.set(x,0)}this.skinningMap.needsUpdate=true};s.SkinningTransformations.prototype.setSkinningEulerAngles=function(v,u){if(!this.skinningMapWidth||!this.skinningMapHeight){var w;if(u>512){w=64}else{if(u>128){w=32}else{if(u>32){w=16}else{w=8}}}this.skinningMapWidth=w;this.skinningMapHeight=w}this.useEulerAngles=true;if(!this.skinningMap){var x=new Float32Array(this.skinningMapWidth*this.skinningMapHeight*3);x.set(v,0);this.skinningMap=new s.DataTexture(x,this.skinningMapWidth,this.skinningMapHeight,s.RGBFormat,s.FloatType);this.skinningMap.minFilter=s.NearestFilter;this.skinningMap.magFilter=s.NearestFilter;this.skinningMap.generateMipmaps=false;this.skinningMap.flipY=false}else{this.skinningMap.image.data.set(v,0)}this.skinningMap.needsUpdate=true};s.SkinningTransformationsInstancing=function(){this.useEulerAngles=false;this.skinningInstancingMaps=null;this.skinningInstancingMapsInfo=null};s.SkinningTransformationsInstancing.prototype.setInstancingSkinningMatrices=function(v,F,G){this.useEulerAngles=false;var z;if(!this.skinningInstancingMapsInfo||this.nbBones!==F){var y=function(N){var M=1;while(M<N){M*=2}return M};var I=debugWebGLV6Viewer.renderer.renderer.context;var K=I.getParameter(I.MAX_TEXTURE_SIZE);var B=K*K;var w=F*G*4;var x=Math.ceil(w/B);var u=(w-Math.floor(w/B)*B);var A=Math.sqrt(u);var E=y(A);var D=y(u/E);var H=((x-1)*B+E*D)*3;z={nbBones:F,maxTextureSize:K,nbTextures:x,lastTextureSizeX:E,lastTextureSizeY:D};this.skinningInstancingMapsInfo=z}else{z=this.skinningInstancingMapsInfo}var L;if(!this.skinningInstancingMaps){this.skinningInstancingMaps=new Array(z.nbTextures);L=new Float32Array(H);L.set(v,0)}for(var J=0;J<z.nbTextures-1;J++){if(!this.skinningInstancingMaps[J]){var C=new s.DataTexture(L.subarray(J*z.maxTextureTotalSize*3,(J+1)*z.maxTextureTotalSize*3),z.maxTextureSize,z.maxTextureSize,s.RGBFormat,s.FloatType);C.minFilter=s.NearestFilter;C.magFilter=s.NearestFilter;C.generateMipmaps=false;C.flipY=false;this.skinningInstancingMaps[J]=C}else{this.skinningInstancingMaps[J].image.data.set(v.subarray(J*z.maxTextureTotalSize*3,(J+1)*z.maxTextureTotalSize*3),0)}this.skinningInstancingMaps[J].needsUpdate=true}if(!this.skinningInstancingMaps[z.nbTextures-1]){var C=new s.DataTexture(L.subarray((z.nbTextures-1)*z.maxTextureTotalSize*3,L.length),z.lastTextureSizeX,z.lastTextureSizeY,s.RGBFormat,s.FloatType);C.minFilter=s.NearestFilter;C.magFilter=s.NearestFilter;C.generateMipmaps=false;C.flipY=false;this.skinningInstancingMaps[z.nbTextures-1]=C}else{this.skinningInstancingMaps[z.nbTextures-1].image.data.set(v.subarray((z.nbTextures-1)*z.maxTextureTotalSize*3,v.length),0)}this.skinningInstancingMaps[z.nbTextures-1].needsUpdate=true};s.SkinningTransformationsInstancing.prototype.setInstancingSkinningEulerAngles=function(w,G,H){this.useEulerAngles=true;var A;if(!this.skinningInstancingMapsInfo||this.nbBones!==G){var z=function(N){var M=1;while(M<N){M*=2}return M};var J=debugWebGLV6Viewer.renderer.renderer.context;var L=J.getParameter(J.MAX_TEXTURE_SIZE);var C=L*L;var v=G*H*2;var y=Math.ceil(v/C);var u=(v-Math.floor(v/C)*C);var B=Math.sqrt(u);var F=z(B);var E=z(u/F);var I=((y-1)*C+F*E)*3;A={nbBones:G,maxTextureSize:L,nbTextures:y,lastTextureSizeX:F,lastTextureSizeY:E};this.skinningInstancingMapsInfo=A}else{A=this.skinningInstancingMapsInfo}var x;if(!this.skinningInstancingMaps){this.skinningInstancingMaps=new Array(A.nbTextures);x=new Float32Array(I);x.set(w,0)}for(var K=0;K<A.nbTextures-1;K++){if(!this.skinningInstancingMaps[K]){var D=new s.DataTexture(x.subarray(K*A.maxTextureTotalSize*3,(K+1)*A.maxTextureTotalSize*3),A.maxTextureSize,A.maxTextureSize,s.RGBFormat,s.FloatType);D.minFilter=s.NearestFilter;D.magFilter=s.NearestFilter;D.generateMipmaps=false;D.flipY=false;this.skinningInstancingMaps[K]=D}else{this.skinningInstancingMaps[K].image.data.set(w.subarray(K*A.maxTextureTotalSize*3,(K+1)*A.maxTextureTotalSize*3),0)}this.skinningInstancingMaps[K].needsUpdate=true}if(!this.skinningInstancingMaps[A.nbTextures-1]){var D=new s.DataTexture(x.subarray((A.nbTextures-1)*A.maxTextureTotalSize*3,x.length),A.lastTextureSizeX,A.lastTextureSizeY,s.RGBFormat,s.FloatType);D.minFilter=s.NearestFilter;D.magFilter=s.NearestFilter;D.generateMipmaps=false;D.flipY=false;this.skinningInstancingMaps[A.nbTextures-1]=D}else{this.skinningInstancingMaps[A.nbTextures-1].image.data.set(w.subarray((A.nbTextures-1)*A.maxTextureTotalSize*3,w.length),0)}this.skinningInstancingMaps[A.nbTextures-1].needsUpdate=true};var t=[/(\W+)modelViewMatrix(\W+)/,/(\W+)viewMatrix(\W+)/,/(\W+)projectionMatrix(\W+)/];var g=["modelViewMatrix","viewMatrix","projectionMatrix"];var p=["vGetWorldViewMatrix()","vGetViewMatrix()","vGetProjectionMatrix()"];var q=function(u){var y=g.length;var x="";for(var w=0;w<y;w++){var v=u.search(t[w]);if(v>=0){if(!x){x=['BAD PDSFX USAGE!!!: DO NOT USE THE "'+g[w]+'" token in your overridden function!',"This is henceforth an internal PRIVATE variable. Use the following appropriate PDSFX getter function: "+p[w],"Please take time to correct your PDSFX materials by using the getters/setters provided by the API."].join("\n")}console.warn(x)}}};s._PDSFXData=function(){this.PDSFX=false;this.PDSFX_OverridableFunctions_VS="";this.PDSFX_OverridableFunctions_FS="";this.pdsfxUniformsCode={common:"",vertex:"",fragment:"",};this.pdsfxUniforms=null;this._pdsfxUniformsList=null;this.pdsfxVaryingsCode="";this.pdsfxGlobalVariablesCode_VS="";this.pdsfxGlobalVariablesCode_FS="";this.pdsfxAttributesCode="";this.PDSFX_hasAlbedo=false;this.PDSFX_hasEmissive=false;this.PDSFX_hasSpecular=false;this.PDSFX_hasPsColor=false;this.PDSFX_hasTransparency=false;this.pdsfxUseMap=false};s._PDSFXData.prototype.clone=function(){var u=new s._PDSFXData();u.PDSFX=true;u.PDSFX_OverridableFunctions_VS=this.PDSFX_OverridableFunctions_VS;u.PDSFX_OverridableFunctions_FS=this.PDSFX_OverridableFunctions_FS;if(this.pdsfxUniformsCode){u.pdsfxUniformsCode=this.pdsfxUniformsCode}if(this.pdsfxUniforms){u.pdsfxUniforms=s.UniformsUtils.clone(this.pdsfxUniforms)}if(this.pdsfxVaryingsCode){u.pdsfxVaryingsCode=this.pdsfxVaryingsCode}if(this.pdsfxGlobalVariablesCode_VS){u.pdsfxGlobalVariablesCode_VS=this.pdsfxGlobalVariablesCode_VS}if(this.pdsfxGlobalVariablesCode_FS){u.pdsfxGlobalVariablesCode_FS=this.pdsfxGlobalVariablesCode_FS}if(this.pdsfxAttributesCode){u.pdsfxAttributesCode=this.pdsfxAttributesCode}if(this.PDSFX_hasAlbedo){u.PDSFX_hasAlbedo=true}if(this.PDSFX_hasEmissive){u.PDSFX_hasEmissive=true}if(this.PDSFX_hasSpecular){u.PDSFX_hasSpecular=true}if(this.PDSFX_hasPsColor){u.PDSFX_hasPsColor=true}if(this.PDSFX_hasTransparency){u.PDSFX_hasTransparency=true}if(this.pdsfxUseMap){u.pdsfxUseMap=true}return u};s.WebGLProgramManager=function(u){this.material=u;this.programs=new Map()};s.WebGLProgramManager.prototype.dispose=function(u){this.update(u,null)};s.WebGLProgramManager.prototype.update=function(u,v,y){if(v){if(this.programs.has(y)){var w=this.programs.get(y);this.programs["delete"](y);u(this.material,w.program,false)}}else{var x=this;this.programs.forEach(function(A,z,B){u(x.material,A.program,false)});this.programs.clear()}};s.WebGLProgramManager.prototype.addProgram=function(v,u,w){this.programs.set(w,u)};s.WebGLProgramManager.prototype.getProgram=function(u,w){var v=this.programs.get(w);return v?v:null};s.WebGLProgramManager.prototype.getProgramID=function(v){var w=v?v._programID:1;var u=this.material._programID;return w|u};s.Material=function(){s.EventDispatcher.call(this);this.isPhysicalMaterial=false;this.id=s.MaterialIdCount++;this.name="";this._useCount=0;this._source=s.AssetSource.MANUAL;this.side=a.FrontSide;this.forceSide=false;this.opacity=1;this.transparent=false;this.blending=s.NormalBlending;this.blendSrc=s.SrcAlphaFactor;this.blendDst=s.OneMinusSrcAlphaFactor;this.blendEquation=s.AddEquation;this.depthTest=true;this.depthWrite=true;this.polygonOffset=false;this.polygonOffsetFactor=0;this.polygonOffsetUnits=0;this.polite=false;this.politeMaterial=null;this.alphaTest=0;this.overdraw=false;this.visible=true;this.enableClipPlanes=true;this.clipPlaneIndex=0;this.clipPlaneUseModelMaterial=null;this.mappingType=-1;this.mappingNormTransformation=new s.Matrix3();this.mappingObjTransformation=new s.Matrix4();this.mappingUVTransformation=new s.Matrix3();this.mappingUseFragment=false;this.needsUpdate=true;this.shaderVersion=0;this.overridable=true;this.force=false;this.iterative=false;this.context=null;this.shaderID=s.ShaderIDs.none;this.skinning=false;this.backMaterial=null;this.isBackMaterial=false;this.isAccumMat=false;this.isRevealMat=false;this.isOITable=false;this.updateSSS=false;this.useBlending=false;this.previousOccurrenceRenderingOverride=null;this._programID=0;this.uniforms=null;this.vertexShader=null;this.fragmentShader=null;this.program=null;this.programManager=new s.WebGLProgramManager(this);this.attributes=null;this._picking=false;this._definePickingInstancing=false;this.isInstancingMaterial=false;this.enableReceiveShadowOnCapping=false;this._renderedClipPlane=null;this.line=null;this.point=null;this.setSkinningTransformations({useEulerAngles:false,skinningMap:null,skinningMapWidth:0,skinningMapHeight:0});this.setSkinningTransformationsInstancing({useEulerAngles:false,skinningInstancingMaps:null,skinningInstancingMapsInfo:null});this.skinning=false;this._PDSFXData=null;this.isWideLine=false;this.isDashedLine=false;this.is2DLine=false;this.isCPUPattern=false;this.refreshUniforms=function(w,u,v){};this._withLightMap={}};Object.defineProperty(s.Material.prototype,"PDSFX_OverridableFunctions_FS",{get:function(){return this._PDSFXData?this._PDSFXData.PDSFX_OverridableFunctions_FS:null},});Object.defineProperty(s.Material.prototype,"pdsfxUniforms",{get:function(){console.warn("Do not access the 'pdsfxUniforms' property! Use one of these API functions instead: THREE.Material.getPDSFXUniform, THREE.Material.setPDSFXUniforms, or THREE.Material.updatePDSFXUniform.");return this._PDSFXData?this._PDSFXData.pdsfxUniforms:null},});Object.defineProperty(s.Material.prototype,"PDSFX",{get:function(){return this._PDSFXData?this._PDSFXData.PDSFX:false},});s.Material.prototype.setPDSFXUniforms=function(A){if(this._PDSFXData&&this._PDSFXData.PDSFX){var u=false;var z=0;var y=this._PDSFXData.pdsfxUniformsCode;var x=null;for(var w in A){x=s.ToGLSLTypes[A[w].type];if(!x){continue}if(x.isTexture){this._PDSFXData.pdsfxUseMap=true}u=x.isArray;var B=x.isInt?(A[w].stage===s.FragmentStage?"fragment":"vertex"):"common";if(u){if(A[w].length>0){z=A[w].length;y[B]+="uniform "+x.t+" "+w+"["+z+"];\n"}}else{y[B]+="uniform "+x.t+" "+w+";\n"}}this._PDSFXData.pdsfxUniforms=A}};s.Material.prototype.updatePDSFXUniform=function(v,u){if(this._PDSFXData&&this._PDSFXData.PDSFX){if(this._PDSFXData.pdsfxUniforms[v]!==undefined){this._PDSFXData.pdsfxUniforms[v].value=u}}};s.Material.prototype.getPDSFXUniform=function(u){if(this._PDSFXData&&this._PDSFXData.PDSFX){if(this._PDSFXData.pdsfxUniforms[u]!==undefined){return{name:u,value:this._PDSFXData.pdsfxUniforms[u].value}}else{return null}}};s.Material.prototype.setBackMaterial=function(u){if(this.isBackMaterial){console.warn("You can't set a back material on a back material");return}this.backMaterial=u;if(this.backMaterial!==null){this.backMaterial.polygonOffset=true;this.backMaterial.polygonOffsetFactor=-10;this.backMaterial.polygonOffsetUnits=-10;this.backMaterial.isCPUPattern=this.isCPUPattern;this.backMaterial.isBackMaterial=true;if(this.targetPrimitiveType!==this.backMaterial.targetPrimitiveType||(this.is2DLine&&!this.backMaterial.is2DLine)){console.warn("The back material you are using is not compatible with the main material: primitive types don't match");this.backMaterial=null}else{this.needsUpdate=true}}this.updateDeferredMaterials()};s.Material.prototype.setPDSFXVaryings=function(A){if(this._PDSFXData&&this._PDSFXData.PDSFX){var z=0;var u=false;var y="";var x=null;for(var w in A){x=s.ToGLSLTypes[A[w].type];if(!x){continue}if(!x.canBeVarying){console.warn("setPDSFXVaryings - The type "+A[w].type+" cannot be used for a varying.")}u=x.isArray;if(u&&A[w].length>0){z=A[w].length;y+="varying "+x.t+" "+w+"["+z+"];\n"}else{y+="varying "+x.t+" "+w+";\n"}}this._PDSFXData.pdsfxVaryingsCode=y}};s.Material.prototype.setPDSFXGlobalShaderCode=function(u,v){if(this._PDSFXData&&this._PDSFXData.PDSFX){this._PDSFXData.pdsfxGlobalVariablesCode_VS=u;this._PDSFXData.pdsfxGlobalVariablesCode_FS=v}};s.Material.prototype.setPDSFXPolygonOffset=function(v){if(this._PDSFXData&&this._PDSFXData.PDSFX){this.polygonOffset=true;var u=s.PDSFXPolygonOffsetParams[v];if(u){this.polygonOffsetFactor=u[0];this.polygonOffsetUnits=u[1]}}};s.Material.prototype.setMappingOperator=function(v,x,u,w){this.mappingType=v;if(w!==undefined){this.mappingUseFragment=w}if(x instanceof s.Matrix4){this.mappingObjTransformation=x;this.mappingNormTransformation=new s.Matrix3().getInverse(x).transpose()}if(u instanceof s.Matrix3){this.mappingUVTransformation=u}this.needsUpdate=true};s.Material.prototype.setSkinningTransformations=function(u){this.skinning=true;this.useEulerAngles=u.useEulerAngles;this.skinningMap=u.skinningMap;this.skinningMapWidth=u.skinningMapWidth;this.skinningMapHeight=u.skinningMapHeight};s.Material.prototype.setSkinningTransformationsInstancing=function(u){this.skinning=true;this.useEulerAngles=u.useEulerAngles;this.skinningInstancingMaps=u.skinningInstancingMaps;this.skinningInstancingMapsInfo=u.skinningInstancingMapsInfo};s.Material.prototype.areTexturesLoaded=function(){if(this.map&&this.map.loadEndStatus==="loading"){return false}if(this.lightMap&&this.lightMap.loadEndStatus==="loading"){return false}if(this.bumpMap&&this.bumpMap.loadEndStatus==="loading"){return false}if(this.normalMap&&this.normalMap.loadEndStatus==="loading"){return false}if(this.specularMap&&this.specularMap.loadEndStatus==="loading"){return false}if(this.envMap&&this.envMap.loadEndStatus==="loading"){return false}if(this.coatingBumpMap&&this.coatingBumpMap.loadEndStatus==="loading"){return false}if(this.sssLUT&&this.sssLUT.loadEndStatus==="loading"){return false}if(this.sssIBLLUT&&this.sssIBLLUT.loadEndStatus==="loading"){return false}if(this.translucencyLUT&&this.translucencyLUT.loadEndStatus==="loading"){return false}if(this.uniforms&&this.uniforms.tEnvMap&&this.uniforms.tEnvMap.value&&this.uniforms.tEnvMap.value.loadEndStatus==="loading"){return false}return true};s.Material.prototype._setupOIT=function(u){if(!this.isOITable){return}switch(u){case s.MaterialToUse.oitAccumMaterial:this._programID=this._programID|s.ProgramIDs.OIT_ACCUM;this.isAccumMat=true;break;case s.MaterialToUse.oitRevealMaterial:this._programID=this._programID|s.ProgramIDs.OIT_REVEAL;this.isRevealMat=true;break;default:if(!this.isRevealMat&&!this.isAccumMat){return}if(this.isRevealMat){this._programID=this._programID&~s.ProgramIDs.OIT_REVEAL}if(this.isAccumMat){this._programID=this._programID&~s.ProgramIDs.OIT_ACCUM}this.isRevealMat=false;this.isAccumMat=false;break}};s.Material.prototype.getOpacity=function(){return this.opacity};s.Material.prototype.setValues=function(u){if(u===undefined){return}for(var v in u){var x=u[v];if(x===undefined){console.warn("THREE.Material: '"+v+"' parameter is undefined.");continue}if(v in this){var w=this[v];if(w instanceof s.Color&&x instanceof s.Color){w.copy(x)}else{if(w instanceof s.Color){w.set(x)}else{if(w instanceof s.Vector3&&x instanceof s.Vector3){w.copy(x)}else{if(w instanceof s.Vector2&&x instanceof s.Vector2){w.copy(x)}else{if(w instanceof Float32Array&&x instanceof Float32Array){this[v]=new Float32Array(x)}else{this[v]=x}}}}}}}if(this.backMaterial!==null){this.backMaterial.polygonOffset=true;this.backMaterial.polygonOffsetFactor=-10;this.backMaterial.polygonOffsetUnits=-10;this.backMaterial.isCPUPattern=this.isCPUPattern;this.backMaterial.isBackMaterial=true;if(this.targetPrimitiveType!==this.backMaterial.targetPrimitiveType||(this.is2DLine&&!this.backMaterial.is2DLine)){console.warn("The back material you are using is not compatible with the main material: primitive types don't match");this.backMaterial=null}}if(this.alphaTest){this.transparent=true}};s.Material.prototype._setDefaultPDSFXOverridableFunctions=function(){this._PDSFXData.PDSFX_OverridableFunctions_VS={ComputeCommonValues:s.ShaderChunk.PDSFXComputeCommonValues_VS,ComputeObjectPosition:s.ShaderChunk.PDSFXComputeObjectPosition_VS,ComputeObjectNormal:s.ShaderChunk.PDSFXComputeObjectNormal_VS,ComputeObjectTexCoord0:s.ShaderChunk.PDSFXComputeObjectTexCoord0_VS,ComputeObjectTexCoord1:s.ShaderChunk.PDSFXComputeObjectTexCoord1_VS,ComputeObjectTexCoord2:s.ShaderChunk.PDSFXComputeObjectTexCoord2_VS,ComputeObjectTangent:s.ShaderChunk.PDSFXComputeObjectTangent_VS,ComputeObjectBinormal:s.ShaderChunk.PDSFXComputeObjectBinormal_VS,ProcessViewTangentSpace:s.ShaderChunk.PDSFXProcessViewTangentSpace_VS,ProcessClipSpacePosition:s.ShaderChunk.PDSFXProcessClipSpacePosition_VS,ComputePointSize:s.ShaderChunk.PDSFXComputePointSize_VS,ComputeVaryingValues:s.ShaderChunk.PDSFXComputeVaryingValues_VS};this._PDSFXData.PDSFX_OverridableFunctions_FS={ComputeCommonValues:s.ShaderChunk.PDSFXComputeCommonValues_FS,ComputeDiscard:s.ShaderChunk.PDSFXComputeDiscard_FS,ComputeAlbedo:s.ShaderChunk.PDSFXComputeAlbedo_FS,ComputeViewPosition:s.ShaderChunk.PDSFXComputeViewPosition_FS,ComputeViewNormal:s.ShaderChunk.PDSFXComputeViewNormal_FS,ComputeSpecularReflectance:s.ShaderChunk.PDSFXComputeSpecularReflectance_FS,ComputeRoughness:s.ShaderChunk.PDSFXComputeRoughness_FS,ComputeTransparency:s.ShaderChunk.PDSFXComputeTransparency_FS,ComputeEmissive:s.ShaderChunk.PDSFXComputeEmissive_FS,ComputeOpacity:s.ShaderChunk.PDSFXComputeOpacity_FS,ProcessFinalColor:s.ShaderChunk.PDSFXProcessFinalColor_FS}};s.Material.prototype._getPDSFXOverridableFunctions_VS=function(){var v=this._PDSFXData;if(!v){return""}var u=[v.PDSFX_OverridableFunctions_VS.ComputeCommonValues,v.PDSFX_OverridableFunctions_VS.ComputeObjectPosition,v.PDSFX_OverridableFunctions_VS.ComputeObjectNormal,v.PDSFX_OverridableFunctions_VS.ComputeObjectTexCoord0,v.PDSFX_OverridableFunctions_VS.ComputeObjectTexCoord1,v.PDSFX_OverridableFunctions_VS.ComputeObjectTexCoord2,v.PDSFX_OverridableFunctions_VS.ComputeObjectTangent,v.PDSFX_OverridableFunctions_VS.ComputeObjectBinormal,v.PDSFX_OverridableFunctions_VS.ProcessViewTangentSpace,v.PDSFX_OverridableFunctions_VS.ProcessClipSpacePosition,v.PDSFX_OverridableFunctions_VS.ComputePointSize,v.PDSFX_OverridableFunctions_VS.ComputeVaryingValues].join("\n");return u};s.Material.prototype._getPDSFXOverridableFunctions_FS=function(){var v=this._PDSFXData;if(!v){return""}var u=[v.PDSFX_OverridableFunctions_FS.ComputeCommonValues,v.PDSFX_OverridableFunctions_FS.ComputeDiscard,v.PDSFX_OverridableFunctions_FS.ComputeAlbedo,v.PDSFX_OverridableFunctions_FS.ComputeViewPosition,v.PDSFX_OverridableFunctions_FS.ComputeViewNormal,v.PDSFX_OverridableFunctions_FS.ComputeSpecularReflectance,v.PDSFX_OverridableFunctions_FS.ComputeRoughness,v.PDSFX_OverridableFunctions_FS.ComputeTransparency,v.PDSFX_OverridableFunctions_FS.ComputeEmissive,v.PDSFX_OverridableFunctions_FS.ComputeOpacity,v.PDSFX_OverridableFunctions_FS.ProcessFinalColor].join("\n");return u};s.Material.prototype.setPDSFXOverridableFunctions=function(u,v){if(!(this._PDSFXData&&this._PDSFXData.PDSFX)){console.warn("Not a PDSFX material: please call activatePDSFX() first.")}var w;for(w in u){q(u[w]);this._PDSFXData.PDSFX_OverridableFunctions_VS[w]=u[w]}for(w in v){q(v[w]);this._PDSFXData.PDSFX_OverridableFunctions_FS[w]=v[w]}};s.Material.prototype.clone=function(u){if(u===undefined){u=new s.Material()}u.name=this.name;u.side=this.side;u.forceSide=this.forceSide;u.opacity=this.opacity;u.transparent=this.transparent;u.blending=this.blending;u.blendSrc=this.blendSrc;u.blendDst=this.blendDst;u.blendEquation=this.blendEquation;u.depthTest=this.depthTest;u.depthWrite=this.depthWrite;u.polygonOffset=this.polygonOffset;u.polygonOffsetFactor=this.polygonOffsetFactor;u.polygonOffsetUnits=this.polygonOffsetUnits;u.polite=this.polite;u.politeMaterial=this.politeMaterial;u.alphaTest=this.alphaTest;u.overdraw=this.overdraw;u.visible=this.visible;u.force=this.force;u.enableClipPlanes=this.enableClipPlanes;u.clipPlaneIndex=this.clipPlaneIndex;u.clipPlaneUseModelMaterial=this.clipPlaneUseModelMaterial;u.overridable=this.overridable;u.shaderID=this.shaderID;u.mappingType=this.mappingType;u.mappingUseFragment=this.mappingUseFragment;u.mappingNormTransformation=this.mappingNormTransformation;u.mappingObjTransformation=this.mappingObjTransformation;u.mappingUVTransformation=this.mappingUVTransformation;u.iterative=this.iterative;if(this._picking){u._picking=this._picking}if(this._definePickingInstancing){u._definePickingInstancing=this._definePickingInstancing}if(this.isInstancingMaterial){u.isInstancingMaterial=this.isInstancingMaterial}if(this.skinning){u.skinning=this.skinning;if(this.useEulerAngles){u.useEulerAngles=this.useEulerAngles}if(this.skinningMap){u.skinningMap=this.skinningMap;u.skinningMapWidth=this.skinningMapWidth;u.skinningMapHeight=this.skinningMapHeight}if(this.skinningInstancingMapsInfo){u.skinningInstancingMapsInfo=this.skinningInstancingMapsInfo}if(this.skinningInstancingMaps){u.skinningInstancingMaps=this.skinningInstancingMaps}}if(this._PDSFXData&&this._PDSFXData.PDSFX){u._PDSFXData=this._PDSFXData.clone();if(this.refreshPDSFXUniforms){u.refreshPDSFXUniforms=this.refreshPDSFXUniforms}}u.isAccumMat=this.isAccumMat;u.isRevealMat=this.isRevealMat;u.isOITable=this.isOITable;u.backMaterial=this.backMaterial;u.isBackMaterial=this.isBackMaterial;u.updateSSS=this.updateSSS;u.previousOccurrenceRenderingOverride=this.previousOccurrenceRenderingOverride;u.useBlending=this.useBlending;u._programID=this._programID;u.uniforms=this.uniforms;u.vertexShader=this.vertexShader;u.fragmentShader=this.fragmentShader;u.program=this.program;u.attributes=Object.assign(this.attributes?this.attributes:{},u.attributes);u.enableReceiveShadowOnCapping=this.enableReceiveShadowOnCapping;u._renderedClipPlane=this._renderedClipPlane;u.line=this.line;u.point=this.point;u.isWideLine=this.isWideLine;u.isDashedLine=this.isDashedLine;u.is2DLine=this.is2DLine;u.isCPUPattern=this.isCPUPattern;u.refreshUniforms=this.refreshUniforms;return u};s.Material.prototype.dispose=function(){this.dispatchEvent({type:"dispose"})};s.MaterialIdCount=0;s.LineDSMaterial=function(v){s.Material.call(this);this.color=new s.Color(16777215);this.dashSize=0;this.gapSize=0;this.dashPattern=new Float32Array(2);this.dashType="None";this.patternOffset=0;this.linejoin="miter";this.lineWidth=1;this.pixelSize=new s.Vector2(0.001,0.001);this.side=a.DoubleSide;this.vertexColors=s.NoColors;this.fog=true;this.setValues(v);if(this.dashType!=="None"){this.dashSize=this.gapSize=-1;switch(this.dashType){case 1:this.dashType="Solid";case"Solid":this.dashPattern[0]=-1;break;case 2:this.dashType="Dotted";case"Dotted":this.dashPattern=new Float32Array(2);this.dashPattern[0]=3;this.dashPattern[1]=3;break;case 3:this.dashType="Dashed";case"Dashed":this.dashPattern=new Float32Array(2);this.dashPattern[0]=5;this.dashPattern[1]=1;break;case 4:this.dashType="Dot-Dashed";case"Dot-Dashed":this.dashPattern=new Float32Array(4);this.dashPattern[0]=5;this.dashPattern[1]=3;this.dashPattern[2]=2;this.dashPattern[3]=3;break;case 5:this.dashType="Phantom";case"Phantom":this.dashPattern=new Float32Array(6);this.dashPattern[0]=2;this.dashPattern[1]=2;this.dashPattern[2]=2;this.dashPattern[3]=2;this.dashPattern[4]=6;this.dashPattern[5]=2;break;case 6:this.dashType="Small-Dotted";case"Small-Dotted":this.dashPattern=new Float32Array(2);this.dashPattern[0]=1;this.dashPattern[1]=1;break;case 7:this.dashType="JIS Axis";case"JIS Axis":this.dashPattern=new Float32Array(4);this.dashPattern[0]=14;this.dashPattern[1]=2;this.dashPattern[2]=4;this.dashPattern[3]=2;break;default:this.dashType="None";break}}if((this.dashSize>0&&this.gapSize>0)||this.dashPattern[0]>0.000001){this.isDashedLine=true;if(this.dashSize>0&&this.gapSize>0){console.warn("DEPRECATED: Usage of dashSize and gapSize is deprecated, use dashPattern instead.");this.dashPattern[0]=this.dashSize;this.dashPattern[1]=this.gapSize;this.dashSize=-1;this.gapSize=-1}if(this.dashPattern[0]>0.000001){for(var u=1;u<this.dashPattern.length;u++){this.dashPattern[u]+=this.dashPattern[u-1]}}}if(this.isDashedLine&&this.dashType==="None"){this.dashType="Custom"}};s.LineDSMaterial.prototype=Object.create(s.Material.prototype);s.LineDSMaterial.prototype.clone=function(u){if(u===undefined){u=new s.LineDSMaterial()}s.Material.prototype.clone.call(this,u);u.color.copy(this.color);u.scale=this.scale;u.dashPattern=new Float32Array(this.dashPattern);u.dashType=this.dashType;u.patternOffset=this.patternOffset;u.lineWidth=this.lineWidth;u.linecap=this.linecap;u.linejoin=this.linejoin;u.pixelSize=this.pixelSize;u.side=this.side;u.vertexColors=this.vertexColors;u.fog=this.fog;return u};s.LineDSMaterial.prototype.setPatternOffset=function(u){this.patternOffset=u;if(this.isDashedLine){this.updateDeferredMaterials()}};s.LineDSMaterial.prototype.setScale=function(u){this.scale=u;if(this.isDashedLine){this.updateDeferredMaterials()}};s.LineDSMaterial.prototype.setDashPatternArray=function(u){this.dashPattern=new Float32Array(u);this.dashType="Custom";for(var v=1;v<this.dashPattern.length;v++){this.dashPattern[v]+=this.dashPattern[v-1]}this.isDashedLine=this.dashPattern[0]>0;this.needsUpdate=true;this.updateDeferredMaterials()};s.LineDSMaterial.prototype.setDashPatternType=function(u){this.dashType=u;switch(this.dashType){case 1:this.dashType="Solid";case"Solid":this.dashPattern[0]=-1;break;case 2:this.dashType="Dotted";case"Dotted":this.dashPattern=new Float32Array(2);this.dashPattern[0]=2;this.dashPattern[1]=2;break;case 3:this.dashType="Dashed";case"Dashed":this.dashPattern=new Float32Array(2);this.dashPattern[0]=4;this.dashPattern[1]=2;break;case 4:this.dashType="Dot-Dashed";case"Dot-Dashed":this.dashPattern=new Float32Array(4);this.dashPattern[0]=4;this.dashPattern[1]=2;this.dashPattern[2]=2;this.dashPattern[3]=2;break;case 5:this.dashType="Phantom";case"Phantom":this.dashPattern=new Float32Array(6);this.dashPattern[0]=2;this.dashPattern[1]=2;this.dashPattern[2]=2;this.dashPattern[3]=2;this.dashPattern[4]=6;this.dashPattern[5]=2;break;case 6:this.dashType="Small-Dotted";case"Small-Dotted":this.dashPattern=new Float32Array(2);this.dashPattern[0]=1;this.dashPattern[1]=1;break;case 7:this.dashType="JIS Axis";case"JIS Axis":this.dashPattern=new Float32Array(4);this.dashPattern[0]=14;this.dashPattern[1]=2;this.dashPattern[2]=4;this.dashPattern[3]=2;break;default:this.dashType="None";this.dashPattern=new Float32Array(2);this.dashPattern[0]=0;this.dashPattern[1]=0;break}for(var v=1;v<this.dashPattern.length;v++){this.dashPattern[v]+=this.dashPattern[v-1]}this.isDashedLine=this.dashPattern[0]>0;this.needsUpdate=true;this.updateDeferredMaterials()};s.LineDSMaterial.prototype.activatePDSFX=function(){this._PDSFXData=new s._PDSFXData();this._PDSFXData.PDSFX=true;this._setDefaultPDSFXOverridableFunctions();this._PDSFXData.PDSFX_hasAlbedo=true};s.LineDSMaterial.prototype.loadUniforms=function(v,x,u,w){v.loadUniformsLines(x,this,u,w);v.loadUniformsSkinning(x,this,u)};s.LineDSMaterial.prototype.targetPrimitiveType="LINES";s.LineBasicMaterial=function(u){this.polygonBorderMode=false;this.scale=6.66666;this.linecap="square";s.LineDSMaterial.call(this,u);this.isWideLine=this.lineWidth>1||this.isCPUPattern;if(this.backMaterial){this.backMaterial.isWideLine=this.backMaterial.lineWidth>1||this.isCPUPattern}if(this.polygonBorderMode){this.polygonOffset=this.polygonOffset?this.polygonOffset:this.lineWidth>1;this.polygonOffsetFactor=this.polygonOffsetFactor?this.polygonOffsetFactor:-1;this.polygonOffsetUnits=this.polygonOffsetUnits?this.polygonOffsetUnits:-1}this.shaderID=s.ShaderIDs.line};s.LineBasicMaterial.prototype=Object.create(s.LineDSMaterial.prototype);s.LineBasicMaterial.prototype.clone=function(){var u=new s.LineBasicMaterial();s.LineDSMaterial.prototype.clone.call(this,u);u.polygonBorderMode=this.polygonBorderMode;return u};s.LineBasicMaterial.prototype.setLineWidth=function(v){if(v<1){v=1}var u=Math.round(v);if(Math.abs(this.lineWidth-u)>0.000001){this.needsUpdate=true;this.lineWidth=u;if(this.polygonBorderMode){this.polygonOffset=this.polygonOffset?this.polygonOffset:this.lineWidth>1;this.polygonOffsetFactor=this.polygonOffsetFactor?this.polygonOffsetFactor:-1;this.polygonOffsetUnits=this.polygonOffsetUnits?this.polygonOffsetUnits:-1}this.isWideLine=this.lineWidth>1||this.isCPUPattern;this.updateDeferredMaterials()}};s.LineBasicMaterial.prototype.setBackMaterial=function(u){s.Material.prototype.setBackMaterial.call(this,u);if(this.backMaterial){this.backMaterial.isWideLine=this.backMaterial.lineWidth>1||this.isCPUPattern}this.updateDeferredMaterials()};s.LineBasicMaterial.prototype.setCPUPattern=function(u){if(this.isCPUPattern!==u){this.isCPUPattern=u;this.needsUpdate=true;this.isWideLine=this.lineWidth>1||this.isCPUPattern;if(this.backMaterial!==null){this.backMaterial.isCPUPattern=this.isCPUPattern;this.backMaterial.isWideLine=this.backMaterial.lineWidth>1||this.isCPUPattern;this.backMaterial.needsUpdate=true;this.backMaterial.updateDeferredMaterials()}this.updateDeferredMaterials()}};s.LineBasicShaderLibs={dashedParsVertex:["#ifdef USE_DASHEDLINE","   attribute vec2 lineDistance;","   varying vec2 vLineDistance;","   #ifdef USE_WIDELINE","       varying vec2 vPointNext;","       varying vec2 vPointPrec;","       varying float vLineDistanceAlt;","       varying vec2 vLineDistanceLeft;","       varying vec2 vLineDistanceRight;","       varying float resetSecondDist;","       varying vec2 vConstantNext;","       varying vec2 vConstantCurr;","       varying vec2 vConstantPrec;","   #endif","#endif"].join("\n"),wideParsVertex:["#ifdef USE_WIDELINE","   uniform float halfWidth;","   attribute vec3 previousPos;","   attribute vec3 followingPos;","   attribute float sideExtrusion;","       float getSegmentDepthValue(in vec3 dir, in vec3 posToComp) {","           return min(1e18,(dot(posToComp,dir) * cNormalize(dir)).z);","       }","       float getFinalZ(in bool clipped, in bvec2 precNext, in vec3 pmvPosition, in vec3 pmvPositionPrec, in vec3 pmvPositionSuiv, in vec2 pos, in float oldW, in vec3 mvPosition, in float worldSizeToPixel) {","			vec3 computedPosition = vec3(pos.x, pos.y,pmvPosition.z);","			float finalZ = pmvPosition.z;","       #ifndef USE_POLYGON_BORDER_MODE","           if (!clipped) {","				return finalZ;","           }","			if (precNext.x) {","				finalZ = getSegmentDepthValue(pmvPosition.xyz - pmvPositionPrec.xyz,computedPosition.xyz - pmvPosition.xyz) + pmvPosition.z;","			} else if (precNext.y) {","				finalZ = getSegmentDepthValue(pmvPositionSuiv.xyz - pmvPosition.xyz,computedPosition.xyz - pmvPosition.xyz) + pmvPosition.z;","			}","			return finalZ;","       #else","           vec3 precDir, nextDir;","           if (precNext.y) {","               nextDir = pmvPositionSuiv.xyz - pmvPosition.xyz;","           }","           if (precNext.x) {","               precDir = pmvPosition.xyz - pmvPositionPrec.xyz;","           }","           if (precNext.x && precNext.y && length(cross(nextDir,precDir)) > 1e-6) {","               vec4 equationP = getPlanEquation(nextDir,precDir,pmvPosition.xyz);","               float lambda = -(dot(equationP.xyz,computedPosition.xyz) + equationP.w);","               finalZ = - (equationP.x * computedPosition.x + equationP.y * computedPosition.y + equationP.w)/equationP.z;","               vec3 mvComputedPos = getViewSpaceConvertedPosition(pos, vec2(finalZ,1.0),oldW);","               vec3 positionToComputed = mvComputedPos.xyz - mvPosition;","               if (abs(positionToComputed.z) > 10.0*halfWidth / worldSizeToPixel) {","                   mvComputedPos.z = mvPosition.z + 10.0*halfWidth / worldSizeToPixel * sign(positionToComputed.z);","               }","               vec4 mvpComputedPos = projectionMatrix * vec4(mvComputedPos,1.0);","               mvpComputedPos /= abs(mvpComputedPos.w);","               finalZ = mvpComputedPos.z;","           } else if (precNext.x) {","               finalZ = getSegmentDepthValue(precDir,computedPosition.xyz - pmvPosition.xyz) + pmvPosition.z;","           } else if (precNext.y) {","               finalZ = getSegmentDepthValue(nextDir,computedPosition.xyz - pmvPosition.xyz) + pmvPosition.z;","           }","           return finalZ;","       #endif","       }","#endif"].join("\n"),roundCapParsVertex:["#ifdef USE_ROUNDCAP","   varying vec2 infos;","   varying vec2 centerLeft;","   varying vec2 centerCap;","   varying vec2 centerRight;","#endif"].join("\n"),roundJoinParsVertex:["#ifdef USE_ROUNDJOIN","   varying vec4 centerJoin;","   varying vec4 centerRightJoin;","   varying vec4 centerLeftJoin;","#endif",].join("\n"),polygonBorderModeParsVertex:["   #ifdef USE_POLYGON_BORDER_MODE","       vec4 getPlanEquation(in vec3 v1, in vec3 v2, in vec3 randomPosition) {","           vec3 normal = cross(v1,v2);","           normal = cNormalize(normal);","           float d;","           d = -dot(normal,randomPosition);","           return vec4(normal,d);","       }","","       vec3 getViewSpaceConvertedPosition(in vec2 pos, in vec2 zw, in float w){","           vec4 res = vec4(pos,zw);","           res *= w;","           res.y *= pixelSize.y/pixelSize.x;","           mat4 inverseProjection = mat4(projectionMatrix);","           if (! isNull(projectionMatrix[3][3]) ) {","               inverseProjection[0][0] = 1.0 / projectionMatrix[0][0];","               inverseProjection[1][1] = 1.0 / projectionMatrix[1][1];","               inverseProjection[2][2] = 1.0 / projectionMatrix[2][2];","               inverseProjection[3][2] = -projectionMatrix[3][2] / projectionMatrix[2][2];","               inverseProjection[3][3] = 1.0;","           } else {","               inverseProjection[0][0] = 1.0 / projectionMatrix[0][0];","               inverseProjection[1][1] = 1.0 / projectionMatrix[1][1];","               inverseProjection[2][2] = 0.0;","               inverseProjection[2][3] = 1.0 / projectionMatrix[3][2];","               inverseProjection[3][2] = 1.0 / projectionMatrix[2][3];","               inverseProjection[3][3] = -projectionMatrix[2][2] / (projectionMatrix[3][2] * projectionMatrix[2][3]);","           }","           res = inverseProjection * res;","           return res.xyz/res.w;","       }","   #endif"].join("\n"),wideParsFragment:["#ifdef USE_WIDELINE","   uniform float halfWidth;","#endif",].join("\n"),dashedParsFragment:["#ifdef USE_DASHEDLINE","   uniform float dashSize;","   uniform float scale;","   uniform float totalSize;","   uniform float patternOffset;","   #ifdef PATTERN_LENGTH","       uniform float dashPattern[PATTERN_LENGTH];","   #endif","   varying vec2 vLineDistance;","   #ifdef USE_WIDELINE","       varying vec2 vPointNext;","       varying vec2 vPointPrec;","       varying float vLineDistanceAlt;","       varying vec2 vLineDistanceLeft;","       varying vec2 vLineDistanceRight;","       varying float resetSecondDist;","       varying vec2 vConstantNext;","       varying vec2 vConstantCurr;","       varying vec2 vConstantPrec;","   #endif","   float getDistance(in vec2 next, in vec2 prev) {","       float res = 0.0;","       vec2 direction = next-prev;","       float l = length(direction);","       res = dot(gl_FragCoord.xy  - prev, direction)/(l*l);","       return res * (vLineDistance.y - vLineDistance.x);","   }","   float getDistance(in vec2 next, in vec2 prev, in vec2 origin, in float ratio) {","       float res = 0.0;","       vec2 direction = next-prev;","       float l = length(direction);","       res = dot(gl_FragCoord.xy - origin, direction)/(l*l);","       return res* ratio;","   }","   #ifdef PATTERN_LENGTH","       vec3 getPatternInfo(in float dist) {","           int index = 0;","           float prec = 0.0, cur = 0.0;","           for (int i = 0; i < PATTERN_LENGTH; i++) {","               cur = max(scale,1e-6)*dashPattern[i];","               if (cur > dist) {","                   break;","               }","               prec = cur;","               index++;","           }","           return vec3(float(index),prec,cur);","       }","       float getPatternAlpha(in float dist) {","           float mDist = mod( dist, max(scale,1e-6)*totalSize );","           vec3 patternInfo = getPatternInfo(mDist);","           if (abs(mod(patternInfo.x,2.0)) < 0.5) {","               return 0.0;","           }","               return 1.0;","       }","   #endif","#endif",].join("\n"),roundCapParsFragment:["#ifdef USE_ROUNDCAP","   varying vec2 infos;","   varying vec2 centerLeft;","   varying vec2 centerCap;","   varying vec2 centerRight;","   bool doLeftCap(in bool leftSide) {","       bool leftCap = leftSide && infos.x < 0.0;","       if (!leftCap) {","           return false;","       }","       float distanceL = length(gl_FragCoord.xy - centerLeft)/halfWidth;","       if (distanceL > 1.0) {","           discard;","       }","       return true;","   }","   bool doRightCap(in bool rightSide) {","       bool rightCap = rightSide  && infos.x > length(centerRight - centerCap);","       if (!rightCap) {","           return false;","       }","       float distanceR = length(gl_FragCoord.xy - centerRight) / halfWidth;","       if (distanceR > 1.0) {","            discard;","       }","		return true;","   }","   void doRoundCap() {","       bool centerSide = abs(length(fwidth(centerCap))) < 1e-2;","       bool capToCap = abs(fwidth(infos.y)) < 1e-2 && infos.y > 0.0;","       bool leftSide = abs(length(fwidth(centerLeft))) < 1e-2 ;","       bool rightSide = abs(length(fwidth(centerRight))) < 1e-2 ;","       bool toTreat = ! (leftSide && rightSide && centerSide) || capToCap;","       if (!toTreat) {","           return;","       }","       bool leftCap = doLeftCap(leftSide);","       bool rightCap = doRightCap(rightSide && centerSide);","   }","#endif",].join("\n"),roundJoinParsFragment:["#ifdef USE_ROUNDJOIN","   varying vec4 centerJoin;","   varying vec4 centerRightJoin;","   varying vec4 centerLeftJoin;","   void doCentralJoin() {","       float distanceJoin = 0.0;","       float varJoinC = 0.0;","       if (dot(gl_FragCoord.xy - centerJoin.xy, centerJoin.zw) <= 0.0) {","           return;","       }","       distanceJoin = length(gl_FragCoord.xy - centerJoin.xy) / halfWidth;","       if (distanceJoin > 1.0) {","           discard;","       }","   }","   void doSideJoins() {","       bool rightJoin = abs(length(fwidth(centerRightJoin))) < 1e-2 && dot(gl_FragCoord.xy - centerRightJoin.xy, centerRightJoin.zw) > 0.0;","       bool leftJoin =  abs(length(fwidth(centerLeftJoin))) < 1e-2 && dot(gl_FragCoord.xy - centerLeftJoin.xy, centerLeftJoin.zw) > 0.0;","       float distanceRight = 0.0;","       float distanceLeft = 0.0;","       float varJoinR = 0.0;","       float varJoinL = 0.0;","       if (rightJoin) {","           distanceRight = length(gl_FragCoord.xy - centerRightJoin.xy) / halfWidth;","           if (distanceRight > 1.0) {","               discard;","           }","       }","       if (leftJoin) {","           distanceLeft = length(gl_FragCoord.xy - centerLeftJoin.xy) / halfWidth;","           if (distanceLeft > 1.0) {","               discard;","           }","       }","   }","   void doRoundJoins() {","       bool isOnJoin = abs(length(fwidth(centerJoin))) < 1e-2;","       if (isOnJoin) {","           doCentralJoin();","           return;","       }","       doSideJoins();","    }","#endif",].join("\n"),dashedLineInWide:["   #ifdef USE_DASHEDLINE","       vLineDistanceAlt = vLineDistance.x;","		vec4 mvpPositionPrec = projectionMatrix * mvPositionPrec; ","       vec4 mvpPosition = projectionMatrix * mvPosition;","       vec4 mvpPositionSuiv = projectionMatrix * mvPositionSuiv;","       vConstantNext = (mvpPositionSuiv.xy / mvpPositionSuiv.w + 1.0)/ pixelSize;","       vConstantPrec = (mvpPositionPrec.xy / mvpPositionPrec.w + 1.0) / pixelSize;","       vConstantCurr = (mvpPosition.xy / mvpPosition.w + 1.0) / pixelSize;","	#ifdef CPU_PATTERN","       vLineDistance.x = lineDistance.x ;","       vLineDistance.y = lineDistance.y ;","	#endif","       float worldSizeToPixelPrec = computeWorldSizeToPixel(mvpPositionPrec);","       float worldSizeToPixelNext = computeWorldSizeToPixel(mvpPositionSuiv);","       resetSecondDist = 0.0;","       if (!parity){","           vLineDistanceAlt = vLineDistance.y;","           vPointPrec = (mvpPositionPrec.xy / mvpPositionPrec.w + 1.0) / pixelSize;","           vPointNext = (mvpPosition.xy / mvpPosition.w + 1.0) / pixelSize;","	#ifdef CPU_PATTERN","           vLineDistanceLeft.x = lineDistance.x;","           vLineDistanceLeft.y = lineDistance.y;","           vLineDistanceRight.x = lineDistance.y;","           vLineDistanceRight.y = (lineDistance.y + length(vConstantNext.xy - vConstantCurr.xy));","	#else","           vLineDistance.x = lineDistance.x * modelMatrixScaleX * worldSizeToPixelPrec;","           vLineDistance.y = lineDistance.y * modelMatrixScaleX * worldSizeToPixelCurr;","           vLineDistanceLeft.x = lineDistance.x * modelMatrixScaleX * worldSizeToPixelPrec;","           vLineDistanceLeft.y = lineDistance.y * modelMatrixScaleX * worldSizeToPixelCurr;","           vLineDistanceRight.x = lineDistance.y * modelMatrixScaleX * worldSizeToPixelCurr;","           vLineDistanceRight.y = (lineDistance.y + length(followingPos.xyz - position.xyz)) * modelMatrixScaleX * worldSizeToPixelNext;","	#endif","       } else {","           vLineDistanceAlt = vLineDistance.x;","           vPointPrec = (mvpPosition.xy / mvpPosition.w  + 1.0)/ pixelSize;","           vPointNext = (mvpPositionSuiv.xy / mvpPositionSuiv.w + 1.0)/ pixelSize;","	#ifdef CPU_PATTERN","           vLineDistanceLeft.x = (lineDistance.x - length(vConstantCurr.xy - vConstantPrec.xy));","           vLineDistanceLeft.y = lineDistance.x;","           vLineDistanceRight.x = lineDistance.x;","           vLineDistanceRight.y = lineDistance.y;","	#else","           vLineDistance.x = lineDistance.x * modelMatrixScaleX* worldSizeToPixelCurr;","           vLineDistance.y = lineDistance.y * modelMatrixScaleX* worldSizeToPixelNext;","           vLineDistanceLeft.x = (lineDistance.x - length(position.xyz - previousPos.xyz)) * modelMatrixScaleX * worldSizeToPixelPrec;","           vLineDistanceLeft.y = lineDistance.x * modelMatrixScaleX * worldSizeToPixelCurr;","           vLineDistanceRight.x = lineDistance.x * modelMatrixScaleX * worldSizeToPixelCurr;","           vLineDistanceRight.y = lineDistance.y * modelMatrixScaleX * worldSizeToPixelNext;","	#endif","           if (isNull(lineDistance.x - lineDistance.y)) {","			#ifdef CPU_PATTERN","               vLineDistanceRight.y += length(vConstantNext.xy -  vConstantCurr.xy );","			#else","               vLineDistanceRight.y += length(followingPos.xyz -  position.xyz )* modelMatrixScaleX * worldSizeToPixelNext;","			#endif","               resetSecondDist = 1.0;","           }","       }","   #endif",].join("\n"),roundCapVertex:["#ifdef USE_ROUNDCAP","       vec2 following = (mvpPositionSuivR.xy / mvpPositionSuivR.w + 1.0)/ pixelSize;","       vec2 previous = (mvpPositionPrecR.xy / mvpPositionPrecR.w + 1.0) / pixelSize;","       vec2 current = (mvpPositionR.xy / mvpPositionR.w + 1.0) / pixelSize;","       vec2 computedCurrent = (auxVec.xy + 1.0) / pixelSize;","   if (!bPrecCurr) {","       centerLeft = current.xy;","       centerCap = current.xy;","       centerRight = following.xy;","       infos.x = -halfWidth;","       infos.y = 1.0;","   } else if (!bCurrNext) {","       centerLeft = previous.xy;","       centerCap = previous.xy;","       centerRight = current.xy;","       infos.x = length(current.xy-previous.xy) + halfWidth;","       infos.y = 1.0;","   } else {","       infos.y = 0.0;","       centerLeft = previous.xy;","       centerCap = current.xy;","       centerRight = following.xy;","       if (parity) {","           infos.x = dot(computedCurrent.xy - current.xy,  cNormalize(following.xy - current.xy));","       } else {","           infos.x = length(current.xy - previous.xy) + dot(computedCurrent.xy - current.xy, cNormalize(current.xy - previous.xy));","       }","   }","#endif",].join("\n"),roundJoinVertex:["#ifdef USE_ROUNDJOIN","   vec2 followingJoin = (mvpPositionSuivR.xy / mvpPositionSuivR.w + 1.0)/ pixelSize;","   vec2 previousJoin = (mvpPositionPrecR.xy / mvpPositionPrecR.w + 1.0) / pixelSize;","   vec2 currentJoin = (mvpPositionR.xy / mvpPositionR.w + 1.0) / pixelSize;","   centerLeftJoin = vec4(0.0);","   centerRightJoin = vec4(0.0);","   centerJoin = vec4(0.0);","   if (!bPrecCurr) {","       centerLeftJoin.xy = followingJoin.xy;","       centerJoin.xy = currentJoin.xy;","       centerRightJoin.xy = followingJoin.xy;","       centerRightJoin.zw = dirCurrNext;","   } else if (!bCurrNext) {","       centerLeftJoin.xy = previousJoin.xy;","       centerJoin.xy = currentJoin.xy;","       centerRightJoin.xy = previousJoin.xy;","       centerLeftJoin.zw = -dirPrecCurr;","   } else {","       if (parity) {","           centerLeftJoin.xy = currentJoin.xy;","           centerJoin.xy = currentJoin.xy;","           centerRightJoin.xy = followingJoin.xy;","           centerLeftJoin.zw = -dirCurrNext;","           centerRightJoin.zw = dirCurrNext;","           centerJoin.zw = -dir;","       } else {","           centerLeftJoin.xy = previousJoin.xy;","           centerJoin.xy = currentJoin.xy;","           centerRightJoin.xy = currentJoin.xy;","           centerLeftJoin.zw = -dirPrecCurr;","           centerRightJoin.zw = dirPrecCurr;","           centerJoin.zw = -dir;","       }","   }","#endif",].join("\n"),wideLineExtrusion:["   if (bPrecCurr){","       dirPrecCurr = pmvPosition.xy - pmvPositionPrec.xy;","       dirPrecCurr = cNormalize(dirPrecCurr);","       posPrecCurr = pmvPosition.xy + offset * orientation * vec2(-dirPrecCurr.y, dirPrecCurr.x);","   } else if (bCurrNext) {","       dirPrecCurr = pmvPosition.xy - pmvPositionSuiv.xy;","       dirPrecCurr = cNormalize(dirPrecCurr);","       posPrecCurr = pmvPosition.xy + offset * dirPrecCurr.xy;","   }","","   if (bCurrNext){","       dirCurrNext = pmvPositionSuiv.xy - pmvPosition.xy;","       dirCurrNext = cNormalize(dirCurrNext);","       posCurrNext = pmvPosition.xy + offset * orientation * vec2(-dirCurrNext.y, dirCurrNext.x);","   } else if (bPrecCurr) {","       dirCurrNext = pmvPosition.xy - pmvPositionPrec.xy;","       dirCurrNext = cNormalize(dirCurrNext);","       posCurrNext = pmvPosition.xy + offset * dirCurrNext.xy;","   }","","   vec2 dir = cNormalize(dirCurrNext.xy - dirPrecCurr.xy);","   bool col = false;","   if ( bPrecCurr && bCurrNext){","       if (isNull(length(dir))){","           dir = vec2(-dirCurrNext.y, dirCurrNext.x);","           col = true;","       }","       bool realCol = length(cNormalize(followingPos.xyz - position.xyz) - cNormalize(position.xyz - previousPos.xyz)) < 1e-2;","       float sinAlpha = dir.y * dirPrecCurr.x - dir.x * dirPrecCurr.y;","       float alpha = asin(abs(sinAlpha));","       float distPoints = min(distance(pmvPosition.xy, pmvPositionPrec.xy), distance(pmvPosition.xy, pmvPositionSuiv.xy)) + offset;","       float dist = offset/ sinAlpha;","       if (sign(sinAlpha) == -orientation) {","           if ( alpha < radians(45.0)) {","           #if defined(USE_ROUNDJOIN)","               if (parity){","                   pos = pmvPosition.xy - sign(sinAlpha) * offset * vec2(-dirCurrNext.y,dirCurrNext.x);","                   pos -= offset * dirCurrNext;","               } else {","                   pos = pmvPosition.xy - sign(sinAlpha) *offset * vec2(-dirPrecCurr.y,dirPrecCurr.x);","                   pos += offset * dirPrecCurr;","               }","           #else","               if (parity){","                   pos = posCurrNext - offset * dirCurrNext;","               } else {","                   pos = posPrecCurr + offset * dirPrecCurr;","               }","           #endif","           } else {","               pos = pmvPosition.xy - dir *abs(dist);","           }","           if (col && !realCol) {","               if (parity){","                   pos += dist * dirCurrNext*orientation;","               } else {","                   pos -= dist * dirPrecCurr *orientation;","               }","           }","       } else {","           if (max(distPoints, offset) < abs(dist)){","               dist = max(distPoints - offset, offset)*sign(sinAlpha);","               if (alpha < radians(22.5)){","                   if (parity){","                       pos = posCurrNext + dist * dirCurrNext*orientation;","                   } else {","                       pos = posPrecCurr - dist * dirPrecCurr *orientation;","                   }","                   if (col && !realCol) {","                       if (parity){","                           pos += dist * dirCurrNext*orientation;","                       } else {","                           pos -= dist * dirPrecCurr *orientation;","                       }","                   }","               } else {","                   pos = pmvPosition.xy + dir * max(distPoints, offset);","                   if (col && !realCol) {","                       if (parity){","                           pos += dist * dirCurrNext*orientation;","                       } else {","                           pos -= dist * dirPrecCurr *orientation;","                       }","                   }","               }","           } else {","               pos = pmvPosition.xy + dir *abs(dist);","               if (col && !realCol) {","                   if (parity){","                       pos += dist * dirCurrNext*orientation;","                   } else {","                       pos -= dist * dirPrecCurr *orientation;","                   }","               }","           }","       }","   } else if(bPrecCurr || bCurrNext) {","       #if defined(USE_BUTTCAP)","           pos = pmvPosition.xy + offset * vec2(-dirCurrNext.y, dirCurrNext.x)*orientation;","		#else","			pos = (posCurrNext - pmvPosition.xy)  + posPrecCurr;","		#endif","   } else {","       pos = pmvPosition.xy + offset;","   }",].join("\n"),wideLineClip:["       bool clipped = false;","       vec3 testClip = vec3(sign(pmvPositionPrec.w + pmvPositionPrec.z), sign(pmvPosition.w + pmvPosition.z), sign(pmvPositionSuiv.w + pmvPositionSuiv.z));","       if (bPrecCurr && testClip.x * testClip.y < 0.0 ){","           float a = (pmvPositionPrec.w + pmvPositionPrec.z)/((pmvPositionPrec.w + pmvPositionPrec.z) - (pmvPosition.w + pmvPosition.z));","           if (testClip.x < 0.0) {","               pmvPositionPrec = (1.0 - a) * pmvPositionPrec + a * pmvPosition;","               clipped = true;","           } else if (mod(sideExtrusion,2.0) == 1.0) {","              pmvPosition = (1.0 - a) * pmvPositionPrec + a * pmvPosition;","               pmvPositionSuiv = pmvPosition;","               bCurrNext = false;","               clipped = true;","           }","       }","       if (bCurrNext && testClip.y * testClip.z < 0.0 ){","           float a = (pmvPosition.w + pmvPosition.z)/((pmvPosition.w + pmvPosition.z) - (pmvPositionSuiv.w + pmvPositionSuiv.z));","           if (testClip.z < 0.0) {","               pmvPositionSuiv = (1.0 - a) * pmvPosition + a * pmvPositionSuiv;","               clipped = true;","           } else if (mod(sideExtrusion,2.0) == 0.0){","               pmvPosition = (1.0 - a) * pmvPosition + a * pmvPositionSuiv;","               pmvPositionPrec = pmvPosition;","               bPrecCurr = false;","               clipped = true;","           }","       }","#if defined(USE_ROUNDCAP) || defined(USE_ROUNDJOIN)","       vec4 mvpPositionPrecR = pmvPositionPrec; ","       vec4 mvpPositionR = pmvPosition;","       vec4 mvpPositionSuivR = pmvPositionSuiv;","#endif",].join("\n"),},s.MeshBasicMaterial=function(u){s.Material.call(this);this.color=new s.Color(16777215);this.map=null;this.lightMap=null;this.specularMap=null;this.shaderID=s.ShaderIDs.basic;this.envMap=null;this.combine=s.MultiplyOperation;this.reflectivity=1;this.refractionRatio=0.98;this.fog=true;this.shading=s.SmoothShading;this.wireframe=false;this.wireframeLinewidth=1;this.wireframeLinecap="round";this.wireframeLinejoin="round";this.vertexColors=s.NoColors;this.skinning=false;this.morphTargets=false;this.numSupportedMorpTargets=0;this.canvasNodeTextureSaveParams=null;this.setValues(u)};s.MeshBasicMaterial.prototype=Object.create(s.Material.prototype);s.MeshBasicMaterial.prototype.clone=function(){var u=new s.MeshBasicMaterial();s.Material.prototype.clone.call(this,u);u.color.copy(this.color);u.map=this.map;u.lightMap=this.lightMap;u.specularMap=this.specularMap;u.envMap=this.envMap;u.combine=this.combine;u.reflectivity=this.reflectivity;u.refractionRatio=this.refractionRatio;u.fog=this.fog;u.shading=this.shading;u.wireframe=this.wireframe;u.wireframeLinewidth=this.wireframeLinewidth;u.wireframeLinecap=this.wireframeLinecap;u.wireframeLinejoin=this.wireframeLinejoin;u.vertexColors=this.vertexColors;u.skinning=this.skinning;u.morphTargets=this.morphTargets;u.numSupportedMorpTargets=this.numSupportedMorpTargets;u.canvasNodeTextureSize=this.canvasNodeTextureSize;u.canvasNodeTextureSaveParams=this.canvasNodeTextureSaveParams;return u};s.MeshBasicMaterial.prototype.activatePDSFX=function(){this._PDSFXData=new s._PDSFXData();this._PDSFXData.PDSFX=true;this._setDefaultPDSFXOverridableFunctions();this._PDSFXData.PDSFX_hasAlbedo=true};s.MeshBasicMaterial.prototype.loadUniforms=function(v,x,u,w){v.loadUniformsCommon(x,this,u,w);v.loadUniformsSkinning(x,this,u)};s.MeshLambertMaterial=function(u){s.Material.call(this);this.color=new s.Color(16777215);this.ambient=new s.Color(16777215);this.emissive=new s.Color(0);this.wrapAround=false;this.wrapRGB=new s.Vector3(1,1,1);this.map=null;this.lightMap=null;this.specularMap=null;this.shaderID=s.ShaderIDs.lambert;this.envMap=null;this.combine=s.MultiplyOperation;this.reflectivity=1;this.refractionRatio=0.98;this.fog=true;this.shading=s.SmoothShading;this.wireframe=false;this.wireframeLinewidth=1;this.wireframeLinecap="round";this.wireframeLinejoin="round";this.vertexColors=s.NoColors;this.skinning=false;this.morphTargets=false;this.morphNormals=false;this.lights=true;this.numSupportedMorphTargets=0;this.numSupportedMorphNormals=0;this.setValues(u)};s.MeshLambertMaterial.prototype=Object.create(s.Material.prototype);s.MeshLambertMaterial.prototype.clone=function(){var u=new s.MeshLambertMaterial();s.Material.prototype.clone.call(this,u);u.color.copy(this.color);u.ambient.copy(this.ambient);u.emissive.copy(this.emissive);u.wrapAround=this.wrapAround;u.wrapRGB.copy(this.wrapRGB);u.map=this.map;u.lightMap=this.lightMap;u.specularMap=this.specularMap;u.envMap=this.envMap;u.combine=this.combine;u.reflectivity=this.reflectivity;u.refractionRatio=this.refractionRatio;u.fog=this.fog;u.shading=this.shading;u.wireframe=this.wireframe;u.wireframeLinewidth=this.wireframeLinewidth;u.wireframeLinecap=this.wireframeLinecap;u.wireframeLinejoin=this.wireframeLinejoin;u.vertexColors=this.vertexColors;u.skinning=this.skinning;u.morphTargets=this.morphTargets;u.morphNormals=this.morphNormals;u.numSupportedMorphTargets=this.numSupportedMorphTargets;u.numSupportedMorphNormals=this.numSupportedMorphNormals;return u};s.MeshLambertMaterial.prototype.activatePDSFX=function(){this._PDSFXData=new s._PDSFXData();this._PDSFXData.PDSFX=true;this._setDefaultPDSFXOverridableFunctions()};s.MeshLambertMaterial.prototype.loadUniforms=function(w,y,u,x){var v;if(u.ambient){if(w.gammaInput){if(this.NRECompatibility){v=new s.Color().copyGammaToLinearNRECompatible(this.ambient)}else{v=new s.Color().copyGammaToLinear(this.ambient)}}else{v=this.ambient}y.uniform3f(u.ambient,v.r,v.g,v.b)}if(u.emissive){if(w.gammaInput){if(this.NRECompatibility){v=new s.Color().copyGammaToLinearNRECompatible(this.emissive)}else{v=new s.Color().copyGammaToLinear(this.emissive)}}else{v=this.emissive}y.uniform3f(u.emissive,v.r,v.g,v.b)}if(u.wrapRGB&&this.wrapAround){y.uniform3f(u.wrapRGB,this.wrapRGB.x,this.wrapRGB.y,this.wrapRGB.z)}w.loadUniformsCommon(y,this,u,x);w.loadUniformsSkinning(y,this,u)};s.MeshPhongMaterial=function(u){s.Material.call(this);this.color=new s.Color(16777215);this.ambient=new s.Color(16777215);this.emissive=new s.Color(0);this.specular=new s.Color(1118481);this.shininess=30;this.shininessInSpecMap=false;this.metal=false;this.perPixel=true;this.wrapAround=false;this.wrapRGB=new s.Vector3(1,1,1);this.map=null;this.shaderID=s.ShaderIDs.phong;this.lightMap=null;this.bumpMap=null;this.bumpScale=1;this.normalMap=null;this.normalScale=new s.Vector2(1,1);this.specularMap=null;this.envMap=null;this.combine=s.MultiplyOperation;this.reflectivity=1;this.refractionRatio=0.98;this.refractionRatioMap=null;this.reflectionCoef=0;this.fog=true;this.shading=s.SmoothShading;this.wireframe=false;this.wireframeLinewidth=1;this.wireframeLinecap="round";this.wireframeLinejoin="round";this.vertexColors=s.NoColors;this.skinning=false;this.morphTargets=false;this.morphNormals=false;this.textureBlending=0;this.needsCameraPosition=true;this.lights=true;this.numSupportedMorphTargets=0;this.numSupportedMorphNormals=0;this.setValues(u)};s.MeshPhongMaterial.prototype=Object.create(s.Material.prototype);s.MeshPhongMaterial.prototype.clone=function(){var u=new s.MeshPhongMaterial();s.Material.prototype.clone.call(this,u);u.color.copy(this.color);u.ambient.copy(this.ambient);u.emissive.copy(this.emissive);u.specular.copy(this.specular);u.shininess=this.shininess;u.shininessInSpecMap=this.shininessInSpecMap;u.reflectionCoef=this.reflectionCoef;u.metal=this.metal;u.perPixel=this.perPixel;u.wrapAround=this.wrapAround;u.wrapRGB.copy(this.wrapRGB);u.map=this.map;u.lightMap=this.lightMap;u.bumpMap=this.bumpMap;u.bumpScale=this.bumpScale;u.normalMap=this.normalMap;u.normalScale.copy(this.normalScale);u.specularMap=this.specularMap;u.envMap=this.envMap;u.combine=this.combine;u.reflectivity=this.reflectivity;u.refractionRatio=this.refractionRatio;u.refractionRatioMap=this.refractionRatioMap;u.fog=this.fog;u.shading=this.shading;u.wireframe=this.wireframe;u.wireframeLinewidth=this.wireframeLinewidth;u.wireframeLinecap=this.wireframeLinecap;u.wireframeLinejoin=this.wireframeLinejoin;u.vertexColors=this.vertexColors;u.skinning=this.skinning;u.morphTargets=this.morphTargets;u.morphNormals=this.morphNormals;u.textureBlending=this.textureBlending;u.numSupportedMorphTargets=this.numSupportedMorphTargets;u.numSupportedMorphNormals=this.numSupportedMorphNormals;return u};s.MeshPhongMaterial.prototype.activatePDSFX=function(){this._PDSFXData=new s._PDSFXData();this._PDSFXData.PDSFX=true;this._setDefaultPDSFXOverridableFunctions();this._PDSFXData.PDSFX_hasAlbedo=true;this._PDSFXData.PDSFX_hasEmissive=true;this._PDSFXData.PDSFX_hasSpecular=true};s.MeshPhongMaterial.prototype.loadUniforms=function(w,y,u,x){var v;if(u.ambient){if(w.gammaInput){if(this.NRECompatibility){v=new s.Color().copyGammaToLinearNRECompatible(this.ambient)}else{v=new s.Color().copyGammaToLinear(this.ambient)}}else{v=this.ambient}y.uniform3f(u.ambient,v.r,v.g,v.b)}if(u.emissive){if(w.gammaInput){if(this.NRECompatibility){v=new s.Color().copyGammaToLinearNRECompatible(this.emissive)}else{v=new s.Color().copyGammaToLinear(this.emissive)}}else{v=this.emissive}y.uniform3f(u.emissive,v.r,v.g,v.b)}if(u.specular){if(w.gammaInput){if(this.NRECompatibility){v=new s.Color().copyGammaToLinearNRECompatible(this.specular)}else{v=new s.Color().copyGammaToLinear(this.specular)}}else{v=this.specular}y.uniform3f(u.specular,v.r,v.g,v.b)}if(u.shininess){y.uniform1f(u.shininess,Math.max(this.shininess,0.000001))}if(u.shininessInSpecMap){y.uniform1i(u.shininessInSpecMap,this.shininessInSpecMap)}if(u.wrapRGB&&this.wrapAround){y.uniform3f(u.wrapRGB,this.wrapRGB.x,this.wrapRGB.y,this.wrapRGB.z)}w.loadUniformsCommon(y,this,u,x);w.loadUniformsBump(y,this,u);w.loadUniformsNormalMap(y,this,u);w.loadUniformsSkinning(y,this,u)};s.MeshFaceMaterial=function(u){this.materials=u instanceof Array?u:[]};s.MeshFaceMaterial.prototype.clone=function(){return new s.MeshFaceMaterial(this.materials.slice(0))};s.ParticleBasicMaterial=function(u){s.Material.call(this);this.color=new s.Color(16777215);this.map=null;this.size=1;this.sizeAttenuation=true;this.shaderID=s.ShaderIDs.particle_basic;this.vertexColors=s.NoColors;this.fog=true;this.setValues(u)};s.ParticleBasicMaterial.prototype=Object.create(s.Material.prototype);s.ParticleBasicMaterial.prototype.clone=function(){var u=new s.ParticleBasicMaterial();s.Material.prototype.clone.call(this,u);u.color.copy(this.color);u.map=this.map;u.size=this.size;u.sizeAttenuation=this.sizeAttenuation;u.vertexColors=this.vertexColors;u.fog=this.fog;return u};s.ParticleBasicMaterial.prototype.activatePDSFX=function(){this._PDSFXData=new s._PDSFXData();this._PDSFXData.PDSFX=true;this._setDefaultPDSFXOverridableFunctions();this._PDSFXData.PDSFX_hasPsColor=true};s.ParticleBasicMaterial.prototype.loadUniforms=function(v,x,u,w){v.loadUniformsParticle(x,this,u,w)};s.ParticleBasicMaterial.prototype.targetPrimitiveType="POINTS";s.ParticleCanvasMaterial=function(u){s.Material.call(this);this.color=new s.Color(16777215);this.program=function(w,v){};this.setValues(u)};s.ParticleCanvasMaterial.prototype=Object.create(s.Material.prototype);s.ParticleCanvasMaterial.prototype.clone=function(){var u=new s.ParticleCanvasMaterial();s.Material.prototype.clone.call(this,u);u.color.copy(this.color);u.program=this.program;return u};s.ShaderMaterial=function(u){s.Material.call(this);this.shaderVersion=-1;this.fragmentShader="void main() {}";this.vertexShader="void main() {}";this.uniforms={};this.defines={};this.attributes=null;this.shading=s.SmoothShading;this.wireframe=false;this.wireframeLinewidth=1;this.fog=false;this.lights=false;this.vertexColors=s.NoColors;this.skinning=false;this.needsCameraPosition=true;this.morphTargets=false;this.morphNormals=false;this.enableClipPlanes=false;this.physical=false;this.enableOIT=true;if(u){if(u.lineWidth){this.lineWidth=1}if(u.pixelSize){this.pixelSize=new s.Vector2()}if(u.linejoin){this.linejoin=""}if(u.linecap){this.linecap=""}if(u.miterLimit){this.miterLimit=4;this.is2DLine=true}if(u.scale){this.scale=1}if(u.isDashedLine){this.isDashedLine=true;this.patternOffset=0;this.dashPattern=new Float32Array(2)}}this._shadowPass=false;this.uniformsList=null;this.numSupportedMorphTargets=0;this.numSupportedMorphNormals=0;this.map=null;this.setValues(u);if(this.lineWidth){this.isWideLine=(this.lineWidth>1&&!this.is2DLine)||this.isCPUPattern}};s.ShaderMaterial.prototype=Object.create(s.Material.prototype);s.ShaderMaterial.prototype.clone=function(v){var u=(v!==undefined)?v:new s.ShaderMaterial();s.Material.prototype.clone.call(this,u);u.fragmentShader=this.fragmentShader;u.vertexShader=this.vertexShader;u.uniforms=s.UniformsUtils.clone(this.uniforms);u.attributes=this.attributes;u.defines=this.defines;u.shading=this.shading;u.wireframe=this.wireframe;u.wireframeLinewidth=this.wireframeLinewidth;u.fog=this.fog;u.lights=this.lights;u.vertexColors=this.vertexColors;u.skinning=this.skinning;u.morphTargets=this.morphTargets;u.morphNormals=this.morphNormals;u.physical=this.physical;u.enableOIT=this.enableOIT;u._shadowPass=this._shadowPass;u.uniformsList=this.uniformsList;u.numSupportedMorphTargets=this.numSupportedMorphTargets;u.numSupportedMorphNormals=this.numSupportedMorphNormals;u.map=this.map;return u};s.ShaderMaterial.prototype.activatePDSFX=function(){this._PDSFXData=new s._PDSFXData();this._PDSFXData.PDSFX=true;this._setDefaultPDSFXOverridableFunctions()};s.Texture=function(x,v,z,y,C,w,B,A,u){s.EventDispatcher.call(this);this.id=s.TextureIdCount++;this.name="";this._useCount=0;this._source=s.AssetSource.MANUAL;this.hdr=false;this.hasDiffuse=false;this.sRGB=true;this.image=x;this.mipmaps=[];this.mapping=v!==undefined?v:new s.UVMapping();this.wrapS=z!==undefined?z:s.ClampToEdgeWrapping;this.wrapT=y!==undefined?y:s.ClampToEdgeWrapping;this.magFilter=C!==undefined?C:s.LinearFilter;this.minFilter=w!==undefined?w:s.LinearMipMapLinearFilter;this.anisotropy=u!==undefined?u:1;this.format=B!==undefined?B:s.RGBAFormat;this.type=A!==undefined?A:s.UnsignedByteType;this.offset=new s.Vector2(0,0);this.repeat=new s.Vector2(1,1);this.generateMipmaps=true;this.premultiplyAlpha=false;this.flipY=true;this.unpackAlignment=4;this.needsUpdate=false;this.onUpdate=null;this.onLoadCallbacks=[]};s.Texture.prototype={constructor:s.Texture,clone:function(u){if(u===undefined){u=new s.Texture()}u.hdr=this.hdr;u.sRGB=this.sRGB;u.image=this.image;u.mipmaps=this.mipmaps.slice(0);u.mapping=this.mapping;u.wrapS=this.wrapS;u.wrapT=this.wrapT;u.magFilter=this.magFilter;u.minFilter=this.minFilter;u.anisotropy=this.anisotropy;u.format=this.format;u.type=this.type;u.offset.copy(this.offset);u.repeat.copy(this.repeat);u.generateMipmaps=this.generateMipmaps;u.premultiplyAlpha=this.premultiplyAlpha;u.flipY=this.flipY;u.unpackAlignment=this.unpackAlignment;u.needsUpdate=true;return u},dispose:function(){this.dispatchEvent({type:"dispose"});this.needsUpdate=true}};s.TextureIdCount=0;s.CompressedTexture=function(y,x,E,C,B,v,A,z,D,w,u){s.Texture.call(this,null,v,A,z,D,w,C,B,u);this.image={width:x,height:E};this.mipmaps=y;this.generateMipmaps=false};s.CompressedTexture.prototype=Object.create(s.Texture.prototype);s.CompressedTexture.prototype.clone=function(){var u=new s.CompressedTexture();s.Texture.prototype.clone.call(this,u);return u};s.DataTexture=function(z,x,E,C,B,v,A,y,D,w,u){s.Texture.call(this,null,v,A,y,D,w,C,B,u);this.image={data:z,width:x,height:E}};s.DataTexture.prototype=Object.create(s.Texture.prototype);s.DataTexture.prototype.clone=function(){var u=new s.DataTexture();s.Texture.prototype.clone.call(this,u);return u};s.TextureLODPool=function(){this.totalSize=0;this.textures=[]};s.TextureLODPool.prototype.removeUnusedTextures=function(){var x=[];for(var u=0;u<this.textures.length;u++){var w=this.textures[u];if(w.textureLOD.usedTexture===w.lod){x.push(w);continue}var y=w.textureLOD.textures[w.lod];var v=w.textureLOD.textures[w.textureLOD.usedTexture];if(!v||(v.loadEndStatus==="complete")){y.dispose();w.textureLOD.textures[w.lod]=null;this.totalSize-=w.size}else{x.push(w)}}this.textures=x};s.TextureLODPool.prototype.add=function(u){this.totalSize+=u.size;this.textures.push(u)};s.Particle=function(u){s.Object3D.call(this);this.material=u};s.Particle.prototype=Object.create(s.Object3D.prototype);s.Particle.prototype.clone=function(u){if(u===undefined){u=new s.Particle(this.material)}s.Object3D.prototype.clone.call(this,u);return u};s.ParticleSystem=function(v,u){s.Object3D.call(this);this.geometry=v;this.material=(u!==undefined)?u:new s.ParticleBasicMaterial({color:Math.random()*16777215});this.sortParticles=false;if(this.geometry){if(this.geometry.boundingSphere===null){this.geometry.computeBoundingSphere()}}this.frustumCulled=false;console.log("THREE.ParticleSystem is deprecated. Please use SceneGraphFactory.createMeshNode instead.")};s.ParticleSystem.prototype=Object.create(s.Object3D.prototype);s.ParticleSystem.prototype.clone=function(u){if(u===undefined){u=new s.ParticleSystem(this.geometry,this.material)}u.sortParticles=this.sortParticles;s.Object3D.prototype.clone.call(this,u);return u};s.Line=function(w,v,u){s.Object3D.call(this);this.geometry=w;this.material=(v!==undefined)?v:new s.LineBasicMaterial({color:Math.random()*16777215});this.type=(u!==undefined)?u:s.LineStrip;if(this.geometry){if(!this.geometry.boundingSphere){this.geometry.computeBoundingSphere()}}};s.LineStrip=0;s.LinePieces=1;s.Line.prototype=Object.create(s.Object3D.prototype);s.Line.prototype.clone=function(u){if(u===undefined){u=new s.Line(this.geometry,this.material,this.type)}s.Object3D.prototype.clone.call(this,u);return u};s.Mesh=function(v,u){s.Object3D.call(this);this.geometry=[];if(v){if(v.length){this.geometry=v.slice()}else{if(v.length===undefined){this.geometry=v}}this.geometry.boundingSphere=v.boundingSphere;this.geometry.boundingBox=v.boundingBox}if(s.disableJHGDev){this.material=(u!==undefined)?u:new s.MeshBasicMaterial({color:Math.random()*16777215,wireframe:false})}else{this.material=(u!==undefined)?u:null}this.matApp=null;this.gas=null;if(this.geometry&&(this.geometry.boundingSphere===null)){this.geometry.computeBoundingSphere()}if(!this.geometry.boundingSphere){this.geometry.boundingSphere=new s.Sphere()}if(!this.geometry.boundingBox){this.geometry.boundingBox=new s.Box3()}this.beforeRenderCB=null};s.Mesh.prototype=Object.create(s.Object3D.prototype);s.Mesh.prototype.getMorphTargetIndexByName=function(u){if(this.morphTargetDictionary[u]!==undefined){return this.morphTargetDictionary[u]}console.log("THREE.Mesh.getMorphTargetIndexByName: morph target "+u+" does not exist. Returning 0.");return 0};s.Mesh.prototype.clone=function(u){if(u===undefined){u=new s.Mesh(this.geometry,this.material)}if(this.matApp){u.matApp=this.matApp}s.Object3D.prototype.clone.call(this,u);return u};s.Mesh.prototype.getOwningScene=function(){var u=this;while(u.parent!==undefined){u=u.parent}if(u!==undefined&&u instanceof s.Scene){return u}return null};s.CSS3DNode=function(u){s.Object3D.call(this);this.element=u?u:document.createElement("div");this.element.renderable=this;this.element.style.position="absolute";this.geometry=new s.Geometry();this.geometry.boundingSphere=new s.Sphere()};s.CSS3DNode.prototype=Object.create(s.Object3D.prototype);s.Bone=function(u){s.Object3D.call(this)};s.SkinnedMesh=function(y,x,w){s.Mesh.call(this,y,x,true);this.useVertexTexture=w!==undefined?w:true;this.identityMatrix=new s.Matrix4();this.bones=[];this.boneMatrices=[];var z,A,B,v,u,C;window.sealWebVisuObjects&&Object.seal(this)};s.SkinnedMesh.prototype=Object.create(s.Mesh.prototype);s.Sprite=function(u){s.Object3D.call(this)};s.Sprite.prototype=Object.create(s.Object3D.prototype);s.WebGLObjectManager=function(){this.objects=[];this.idMap=new Map();this.nullCount=0;this.lastCleanFrame=0};s.WebGLObjectManager.prototype._clean=function(){if(this.nullCount>1000){this.idMap.clear();this.objects=this.objects.filter(function(v){return v!==null});this.nullCount=0;for(var u=0;u<this.objects.length;u++){if(this.idMap.has(this.objects[u].object)){this.idMap.get(this.objects[u].object).push(u)}else{this.idMap.set(this.objects[u].object,[u])}}}};s.WebGLObjectManager.prototype.getObjects=function(u){this._tryClean(u);return this.objects};s.WebGLObjectManager.prototype._tryClean=function(v){if(this.lastCleanFrame===0&&v){this.lastCleanFrame=v;return}if(this.nullCount>0&&(!v||(v-this.lastCleanFrame>60))){this.idMap.clear();if(this.nullCount===this.objects.length){this.objects=[]}else{this.objects=this.objects.filter(function(w){return w!==null});for(var u=0;u<this.objects.length;u++){if(this.idMap.has(this.objects[u].object)){this.idMap.get(this.objects[u].object).push(u)}else{this.idMap.set(this.objects[u].object,[u])}}}this.lastCleanFrame=v;this.nullCount=0}};s.WebGLObjectManager.prototype.add=function(u){if(u!==null){if(this.idMap.has(u.object)){this.idMap.get(u.object).push(this.objects.length)}else{this.idMap.set(u.object,[this.objects.length])}this.objects.push(u)}};s.WebGLObjectManager.prototype.remove=function(u){if(u===null){return}if(this.idMap.has(u)){var w=this.idMap.get(u);for(var v=0;v<w.length;v++){this.objects[w[v]]=null;this.nullCount++}this.idMap["delete"](u)}this._clean()};s.WebGLObjectManager.prototype.clear=function(){this.objects=[];this.nullCount=0;this.lastCleanFrame=0;this.idMap.clear()};s.Scene=function(){s.Object3D.call(this);this.fog=null;this.overrideMaterial=null;this.matrixAutoUpdate=false;this.envMipMap=[];this.envMipMapID=null;this.ambienceMatrix=new s.Matrix4();this.reflectionProbes=[];this.useFiniteEnvMap=false;this.parallaxCorrectionParameters={sphereCenter:[],sphereRadius:1,projectionCenter:[]};this.__objects=new Set();this.__lights=[];this.__objectsAdded=new Map();this.__objectsRemoved=new Set();this.__objectsUpdated=new Map()};s.Scene.prototype=Object.create(s.Object3D.prototype);s.Scene.prototype.constructor=s.Scene;s.Scene.prototype._lightSort=function(v,u){var x=v instanceof s.DirectionalLight?6:0;var w=u instanceof s.DirectionalLight?6:0;x+=v instanceof s.SpotLight?4:0;w+=u instanceof s.SpotLight?4:0;x+=v instanceof s.PointLight?2:0;w+=u instanceof s.PointLight?2:0;x=v.onlyShadow?0:x;w=u.onlyShadow?0:w;x+=v.castShadow?1:0;w+=u.castShadow?1:0;x+=v.shadowCascade?2:0;w+=u.shadowCascade?2:0;return w-x};s.Scene.prototype.__addObject=function(u,v){if(u instanceof s.Light){if(this.__lights.indexOf(u)===-1){this.__lights.push(u);this.__lights.sort(this._lightSort)}if(u.target&&u.target.parent===undefined){this.add(u.target)}}else{if(u instanceof s.LensFlare){if(!this.__webglFlares){this.__webglFlares=[]}this.__webglFlares.push(u)}else{if(!(u instanceof s.Camera||u instanceof s.Bone)){this.__objects.add(u);this.__objectsAdded.set(u,v);this.__objectsRemoved["delete"](u)}}}for(var w=0;w<u.children.length;w++){this.__addObject(u.children[w])}};s.Scene.prototype.dispose=function(){var w=this.children.length;var v;for(v=0;v<this.__lights.length;v++){var u=this.__lights[v];if(u.shadowMap&&u.shadowMap.dispose){u.shadowMap.dispose()}}for(v=0;v<w;v++){this.remove(this.children[0])}this.__objects.clear();this.__lights=[];this.__objectsAdded.clear();this.__objectsRemoved.clear();this.__objectsUpdated.clear();this.__webglObjects={main:new s.WebGLObjectManager()};this.__webglObjectsAll=new s.WebGLObjectManager();this.__webglObjectsToDraw=[];this.__webglObjectsImmediate=[];this.__webglSprites=[]};s.Scene.prototype.updateObjectPasses=function(u,v){if(!(u instanceof s.Light||u instanceof s.LensFlare||u instanceof s.Camera||u instanceof s.Bone)){this.__objectsUpdated.set(u,v||null)}};s.Scene.prototype.__removeObject=function(u){if(u instanceof s.Light){var v=this.__lights.indexOf(u);if(v!==-1){this.__lights.splice(v,1)}}else{if(u instanceof s.LensFlare){var v=this.__webglFlares.indexOf(u);if(v!==-1){this.__webglFlares.splice(v,1)}}else{if(!(u instanceof s.Camera)){if(this.__objects["delete"](u)){this.__objectsRemoved.add(u);this.__objectsAdded["delete"](u)}}}}for(var w=0;w<u.children.length;w++){this.__removeObject(u.children[w])}};s.Scene.prototype.getWebGLObjects=function(w,v){var u=this.__webglObjects[w?w:"main"];if(u){return u.getObjects(v)}return[]};s.Scene.prototype.getNbWebGLObjects=function(u){return this.getWebGLObjects(u,0).length};s.Scene.prototype.getAllWebGLObjects=function(u){return this.__webglObjectsAll.getObjects(u)};s.Scene.prototype.computeLightsKey=function(){var x=this.__lights;var w={dirLights:0,pointLights:0,spotLights:0,hemiLights:0,sphereLights:0,areaLights:0,iesLights:0,probeLight:false};var z={dirLight:0,spotLight:0,tex2d:0,texCube:0};var A=x.length;for(var v=0;v<A;v++){var u=x[v];if(u.onlyShadow){continue}u.allocate(w);if(!u.castShadow){continue}u.allocateShadows(null,z)}var y=w.iesLights;y=16*y+w.pointLights;y=16*y+w.spotLights;y=16*y+w.dirLights;y=16*y+z.texCube;y=16*y+z.spotLight;y=16*y+z.dirLight;return y};s.StateSortingResult=function(){this._displayLists=[];this._pickingPriorityMapping=null};s.StateSortingResult.prototype.init=function(){var v=new s.DisplayList({name:"SOLID",priority:1024,zSort:s.FrontToBack,side:a.FrontSide,polygonOffset:true});var C=new s.DisplayList({name:"SURFACE",priority:512,zSort:s.FrontToBack,side:a.DoubleSide,polygonOffset:true});var y=new s.DisplayList({name:"EDGE",priority:256,zSort:s.FrontToBack,side:a.DoubleSide,polygonOffset:false});var u=new s.DisplayList({name:"BACK",priority:192,zSort:s.FrontToBack,side:a.DoubleSide,polygonOffset:true,depthWrite:false,depthFunc:"GREATER"});var A=new s.DisplayList({name:"POINT",priority:128,zSort:s.FrontToBack,side:a.DoubleSide,polygonOffset:false});var w=new s.DisplayList({name:"TRANSPAR1D",priority:96,zSort:s.BackToFront,side:a.DoubleSide,polygonOffset:true,depthWrite:false});w.hasTranspar=true;var x=new s.DisplayList({name:"TRANSPAR",priority:64,zSort:s.BackToFront,side:a.DoubleSide,polygonOffset:true,depthWrite:false});x.hasTranspar=true;var z=new s.DisplayList({name:"NOZ",priority:32,zSort:s.FrontToBack,side:a.DoubleSide,polygonOffset:true,clearDepth:true});var B=new s.DisplayList({name:"NOZTRANSPAR",priority:16,zSort:s.BackToFront,side:a.DoubleSide,polygonOffset:true});this.addDisplayList(v);this.addDisplayList(C);this.addDisplayList(y);this.addDisplayList(u);this.addDisplayList(A);this.addDisplayList(x);this.addDisplayList(w);this.addDisplayList(z);this.addDisplayList(B)};s.StateSortingResult.prototype.addDisplayList=function(u){var w,x=false;if(this._displayLists.length&&(u.priority!==undefined)){for(w=0;w<this._displayLists.length&&!x;w++){var v=this._displayLists[w].priority;if(u.priority>v){this.insertDisplayList(u,w);x=true}}}if(!x){this._displayLists.push(u)}for(w=0;w<this._displayLists.length;w++){this._displayLists[w].index=w}return u};s.StateSortingResult.prototype.insertDisplayList=function(v,u){this._displayLists.splice(u,0,v)};s.StateSortingResult.prototype.getDisplayListByName=function(u){for(var v=0;v<this._displayLists.length;v++){if(this._displayLists[v].name===u){return this._displayLists[v]}}return null};s.Fog=function(w,v,u){this.name="";this.color=new s.Color(w);this.near=(v!==undefined)?v:1;this.far=(u!==undefined)?u:1000};s.Fog.prototype.clone=function(){return new s.Fog(this.color.getHex(),this.near,this.far)};s.FogExp2=function(v,u){this.name="";this.color=new s.Color(v);this.density=(u!==undefined)?u:0.00025};s.FogExp2.prototype.clone=function(){return new s.FogExp2(this.color.getHex(),this.density)};s.RenderableObject=function(){this.object=null;this.z=null};s.RenderableParticle=function(){this.object=null;this.x=null;this.y=null;this.z=null;this.rotation=null;this.scale=new s.Vector2();this.material=null};s.RenderableLine=function(){this.z=null;this.v1=new s.RenderableVertex();this.v2=new s.RenderableVertex();this.material=null};s.VertexStage=0;s.FragmentStage=1;s.ToGLSLTypes={f:{t:"float",isArray:false,isTexture:false,canBeVarying:true,isInt:false},v2:{t:"vec2",isArray:false,isTexture:false,canBeVarying:true,isInt:false},v3:{t:"vec3",isArray:false,isTexture:false,canBeVarying:true,isInt:false},c:{t:"vec3",isArray:false,isTexture:false,canBeVarying:true,isInt:false},v4:{t:"vec4",isArray:false,isTexture:false,canBeVarying:true,isInt:false},m3:{t:"mat3",isArray:false,isTexture:false,canBeVarying:true,isInt:false},m4:{t:"mat4",isArray:false,isTexture:false,canBeVarying:true,isInt:false},i:{t:"int",isArray:false,isTexture:false,canBeVarying:false,isInt:true},b:{t:"bool",isArray:false,isTexture:false,canBeVarying:false,isInt:false},fv1:{t:"float",isArray:true,isTexture:false,canBeVarying:true,isInt:false},iv1:{t:"int",isArray:true,isTexture:false,canBeVarying:false,isInt:true},v2v:{t:"vec2",isArray:true,isTexture:false,canBeVarying:true,isInt:false},v3v:{t:"vec3",isArray:true,isTexture:false,canBeVarying:true,isInt:false},v4v:{t:"vec4",isArray:true,isTexture:false,canBeVarying:true,isInt:false},m4v:{t:"mat4",isArray:true,isTexture:false,canBeVarying:true,isInt:false},t2:{t:"sampler2D",isArray:false,isTexture:true,canBeVarying:false,isInt:false},tc:{t:"samplerCube",isArray:false,isTexture:true,canBeVarying:false,isInt:false},t2v:{t:"sampler2D",isArray:true,isTexture:true,canBeVarying:false,isInt:false},tcv:{t:"samplerCube",isArray:true,isTexture:true,canBeVarying:false,isInt:false}};s.PDSFXPolygonOffsetParams={Backward2:[4,4],Backward1:[2,2.3],Backward0:[1,1],Neutral:[0,0],Frontward0:[-0.9,-1],Frontward1:[-2,-2]};s._DefaultShaderChunk={model_view_transformation_vertex:["#if defined(FIXED_SIZE)","setSimpleNodeData();","#endif","auxPosMV = position;","#ifdef FIXED_SIZE","auxPosMV *= simpleNodeData.fixedSizeScale;","#ifdef FIXED_SIZE_CENTER","auxPosMV += simpleNodeData.fixedSizeScaleCenter * fixedSizeCenterRatio.xyz;","#endif","#endif","vec4 mvPosition = modelViewMatrix * vec4(auxPosMV, 1.0);",].join("\n"),model_view_projection_transformation_vertex:["#if defined(FIXED_SIZE)","setSimpleNodeData();","#endif","auxPosMVP = position;","#ifdef FIXED_SIZE","auxPosMVP *= simpleNodeData.fixedSizeScale;","#ifdef FIXED_SIZE_CENTER","auxPosMVP += simpleNodeData.fixedSizeScaleCenter * fixedSizeCenterRatio.xyz;","#endif","#endif","gl_Position = projectionMatrix * (modelViewMatrix * vec4( auxPosMVP, 1.0 ));",].join("\n"),model_view_normal_vertex:["vec3 mvNormal;","if (use_normal_matrix)","mvNormal = normalMatrix * normal;","else {","mvNormal = vec3(modelViewMatrix * vec4(normal, 0.0));","}","mvNormal = normalize( mvNormal );"].join("\n"),getModelViewTransformationChunk:function(w,u){var v=["#if defined(FIXED_SIZE)","setSimpleNodeData();","#endif","auxPosMVPFunc = "+u+";","#ifdef FIXED_SIZE","auxPosMVPFunc.xyz *= simpleNodeData.fixedSizeScale;","#ifdef FIXED_SIZE_CENTER","auxPosMVPFunc.xyz += auxPosMVPFunc.w * simpleNodeData.fixedSizeScaleCenter * fixedSizeCenterRatio.xyz;","#endif","#endif",w+" = modelViewMatrix * auxPosMVPFunc;",].join("\n");return v},getModelViewUnitVectorTransformationChunk:function(v,u){var w=[v+" = vec3(modelViewMatrix * vec4("+u+", 0.0));",].join("\n");return w}};s.ShaderChunk={decompress_normals_pars:["vec2 unpack_2unorm12_in_2floats(in float iEncodedNormal) {","vec2 res;","res.x = floor(iEncodedNormal/4096.0)/4095.0;","res.y = mod(iEncodedNormal, 4096.0)/4095.0;","return res;","}","float signNotZero(in float k) {","return k >= 0.0 ? 1.0 : -1.0;","}","vec2 signNotZero(in vec2 v) {","return vec2( signNotZero(v.x), signNotZero(v.y) );","}","vec3 decodeNormal(in vec2 iEncodedNormal) {","float x = iEncodedNormal.x*2.0 - 1.0;","float y = iEncodedNormal.y*2.0 - 1.0;","vec3 v = vec3(x, y, 1.0 - abs(x) - abs(y));","if (v.z <= 0.0) {","vec2 sgn = signNotZero(v.xy);","v.xy = - abs(v.yx)*sgn + sgn;","}","return normalize(v);","}",].join("\n"),decompress_vertices_pars:["vec3 unpack_3unorm16_in_2floats(in vec2 iEncodedPosition) {","vec3 res;","res.x = floor(iEncodedPosition.x/256.0);","res.y = mod(iEncodedPosition.x, 256.0) *256.0 + mod(iEncodedPosition.y, 256.0);","res.z = floor(iEncodedPosition.y/256.0);","return res;","}","vec3 decodePosition(in vec2 iEncodedPosition) {","vec3 res = unpack_3unorm16_in_2floats(iEncodedPosition);","return quantizedVector * (res + offsetVector);","}",].join("\n"),PDSFX_common_pars:["/**** PDSFX Common Getters ****/","","float _DSsize_;","","mat4 vGetWorldViewMatrix() {","return modelViewMatrix;","}","","uniform mat4 modelViewInvTranspMatrix;","mat4 vGetWorldViewInvTranspMatrix() {","return modelViewInvTranspMatrix;","}","","mat4 vGetViewMatrix() {","return viewMatrix;","}","","mat4 vGetProjectionMatrix() {","return projectionMatrix;","}","","mat4 vGetViewProjectionMatrix() {","return projectionMatrix * viewMatrix;","}","","uniform mat4 viewInvMatrix;","mat4 vGetViewInvMatrix() {","return viewInvMatrix;","}","","uniform mat4 projectionInvMatrix;","mat4 vGetProjectionInvMatrix() {","return projectionInvMatrix;","}","","mat4 vGetViewProjectionInvMatrix() {","return viewInvMatrix * projectionInvMatrix;","}","","uniform mat4 viewInvTranspMatrix;","mat4 vGetViewInvTranspMatrix() {","return viewInvTranspMatrix;","}","","mat3 _DSmappingUVTransformation;","mat4 vGetTextureMatrix() {","#if defined( NEEDS_UVTOUSE )","#if defined (USE_MAPPING_OPERATOR_FRAGMENT) && defined (MAPPING_OPERATOR)","mat4 matrix;","matrix[0] = vec4(_DSmappingUVTransformation[0], 0.0);","matrix[1] = vec4(_DSmappingUVTransformation[1], 0.0);","matrix[2] = vec4(_DSmappingUVTransformation[2], 0.0);","return matrix;","#endif","#endif","return mat4(0.0);","}","","vec3 vGetWorldEyePos() {","return cameraPosition;","}","","vec3 vGetLowlightColor() {","return vec3(0.0);","}","","float vGetDefaultPointSize() {","#ifdef PARTICLE","return _DSsize_;","#else","return 1.0;","#endif","}","","uniform vec3 nearFarLogFactor;","vec3 vGetNearFarLogFactor() {","return nearFarLogFactor;","}","","uniform vec2 viewportSize;","ivec2 vGetViewportSize() {","return ivec2(viewportSize);","}","","mat3 vGet3x3WorldMatrix() {","return mat3(modelMatrix);","}","","uniform mat4 modelInvTranspMatrix;","mat3 vGet3x3WorldInvTranspMatrix() {","return mat3(modelInvTranspMatrix);","}",""].join("\n"),PDSFX_attribute_getters_vertex:["","float _DSscale_;","#ifdef USE_SIZEATTENUATION","vec3 mvPosForAttenuation;","#endif","","int vGetInstanceID() {","#ifdef IS_MULTI_INSTANCED","	return int(instanceId/5.0 - 1.0);","#else","	return 0;","#endif","}","","vec3 vGetAttribPosition() {","return _DSposition;","}","","vec3 vGetAttribNormal() {","return _DSnormal;","}","","vec3 vGetAttribColor() {","#ifdef USE_COLOR","return color.xyz;","#else","return vec3(0.0);","#endif","}","","vec4 vGetAttribTexCoord0() {","return vec4(_DSuv, 0.0, 0.0);","}","","vec4 vGetAttribTexCoord1() {","return vec4(_DSuv2, 0.0, 0.0);","}","","vec4 vGetAttribTexCoord2() {","return vec4(0.0);","}","","vec3 vGetAttribTangent() {","return _DStangent;","}","","vec3 vGetAttribBinormal() {","return _DSbinormal;","}","",].join("\n"),PDSFX_varying_getters_fragment:["#ifdef PDSFX","","vec4 vGetFragCoord() {","return gl_FragCoord;","}","","void vSetFragDepth(in float iDepth) {","#ifdef FRAG_DEPTH_EXT","gl_FragDepthEXT = iDepth;","#endif","}","","bool vIsFrontFacing() {","return gl_FrontFacing;","}","","vec2 vGetPointCoord() {","return gl_PointCoord;","}","","vec3 vGetViewPosition() {","return _DSviewPosition;","}","","vec3 vGetViewNormal() {","return _DSviewNormal;","}","","vec3 vGetViewTangent() {","return _DSviewTangent;","}","","vec3 vGetViewBinormal() {","return _DSviewBinormal;","}","","vec2 _uvToUse;","vec4 vGetTexCoord0() {","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","return vec4(_uvToUse, 0.0, 0.0);","#else","return vec4(0.0);","#endif","}","","vec4 vGetTexCoord1() {","#ifdef USE_LIGHTMAP","return vec4(vUv2, 0.0, 0.0);","#endif","return vec4(0.0);","}","","vec4 vGetTexCoord2() {","return vec4(0.0);","}","","vec4 vGetClipSpacePosition() {","return _DSclipPosition;","}","vec3 _DSalbedo_;","vec3 _DSemissive_;","vec3 _DSspecular_;","float _DStransparency_;","float _DSroughness_;","float _DSopacity_;","#endif","",].join("\n"),PDSFX_varyings_pars:["","#ifdef PDSFX","varying vec3 _DSviewPosition;","varying vec3 _DSviewNormal;","varying vec3 _DSviewTangent;","varying vec3 _DSviewBinormal;","varying vec4 _DSclipPosition;","#endif",""].join("\n"),PDSFX_start_vertex:["","#ifdef COMPRESSED_VERTICES","position = decodePosition(_DSposition);","#endif","#ifdef COMPRESSED_NORMALS","vec2 enc = unpack_2unorm12_in_2floats(_DSnormal);","normal = decodeNormal(enc);","#endif","#ifdef PDSFX","ComputeCommonValues();","position = ComputeObjectPosition();","normal = ComputeObjectNormal();","uv = ComputeObjectTexCoord0().xy;","#ifdef USE_LIGHTMAP","uv2 = ComputeObjectTexCoord1().xy;","#endif","#if defined(USE_TANGENT) || defined(USE_TANGENT_BINORMAL)","tangent = ComputeObjectTangent();","#ifdef USE_TANGENT_BINORMAL","binormal = ComputeObjectBinormal();","#endif","#endif","TangentSpace _viewTangentSpace;","vec3 _MVNormal;","#if defined( NEEDS_UVTOUSE )","#if defined (USE_MAPPING_OPERATOR_FRAGMENT) && defined (MAPPING_OPERATOR)","_DSmappingUVTransformation = mappingUVTransformation;","#endif","#endif","#endif",""].join("\n"),PDSFX_start_particle_vertex:["#ifdef PDSFX","_DSsize_ = size;","_DSscale_ = scale;","#endif"].join("\n"),PDSFX_point_size_vertex:["#ifdef PDSFX","gl_PointSize = ComputePointSize();","#else","#ifdef USE_SIZEATTENUATION","gl_PointSize = size * ( scale / length( mvPosition.xyz ) );","#else","gl_PointSize = size;","#endif","#endif",].join("\n"),PDSFX_end_vertex:["","#ifdef PDSFX","ProcessClipSpacePosition(gl_Position);","ComputeVaryingValues();","_DSclipPosition = gl_Position;","_DSviewPosition = _viewTangentSpace.Position;","_DSviewNormal = _viewTangentSpace.Normal;","_DSviewTangent = _viewTangentSpace.Tangent;","_DSviewBinormal = _viewTangentSpace.Binormal;","#endif","#ifdef PICKING_INSTANCING","if (instanceId > 16777215.0) vInstancePickingColor = vec3(0.0);","else {","vInstancePickingColor.r = floor(instanceId / 65536.0);","vInstancePickingColor.g = floor((instanceId - vInstancePickingColor.r * 65536.0) / 256.0);","vInstancePickingColor.b = floor(instanceId - vInstancePickingColor.r * 65536.0 - vInstancePickingColor.g * 256.0);","vInstancePickingColor /= 255.0;","}","#endif",""].join("\n"),PDSFX_albedo_pars_fragment:["#ifdef PDSFX","uniform vec3 _DSalbedo;","vec3 diffuse;","#else","uniform vec3 diffuse;","#endif"].join("\n"),PDSFX_opacity_pars_fragment:["#ifdef PDSFX","uniform float _DSopacity;","float opacity;","#else","uniform float opacity;","#endif"].join("\n"),PDSFX_transparency_pars_fragment:["#ifdef PDSFX","uniform float _DStransparency;","float transparency;","#else","uniform float transparency;","#endif"].join("\n"),PDSFX_emissive_pars_fragment:["#ifdef PDSFX","uniform vec3 _DSemissive;","vec3 emissive;","#else","uniform vec3 emissive;","#endif"].join("\n"),PDSFX_specular_pars_fragment:["#ifdef PDSFX","uniform vec3 _DSspecular;","vec3 specular;","#else","uniform vec3 specular;","#endif"].join("\n"),PDSFX_map_fragment:["#ifdef PDSFX_USE_MAP","_uvToUse = vUv;","#endif",].join("\n"),PDSFX_albedo_fragment:["_DSalbedo_ = _DSalbedo;","diffuse = ComputeAlbedo();"].join("\n"),PDSFX_opacity_fragment:["_DSopacity_ = _DSopacity;","opacity = ComputeOpacity();"].join("\n"),PDSFX_emissive_fragment:["_DSemissive_ = _DSemissive;","emissive = ComputeEmissive();"].join("\n"),PDSFX_specular_fragment:["_DSspecular_ = _DSspecular;","specular = ComputeSpecularReflectance();"].join("\n"),PDSFX_discard_fragment:["bool isDiscarded = ComputeDiscard();","if (isDiscarded) discard;"].join("\n"),PDSFX_transparency_fragment:["_DStransparency_ = _DStransparency;","transparency = ComputeTransparency();"].join("\n"),PDSFX_viewNormal_fragment:["vec3 _DSvNormal = ComputeViewNormal();",].join("\n"),PDSFX_end_fragment:["#ifdef PDSFX","ProcessFinalColor(gl_FragColor);","#endif","#ifdef PICKING_INSTANCING","gl_FragColor = vec4(vInstancePickingColor, 1.0);","#endif"].join("\n"),PDSFXComputeCommonValues_VS:["void ComputeCommonValues() {","}"].join("\n"),PDSFXComputeObjectPosition_VS:["vec3 ComputeObjectPosition() {","	return _DSposition;","}"].join("\n"),PDSFXComputeObjectNormal_VS:["vec3 ComputeObjectNormal() {","	return _DSnormal;","}"].join("\n"),PDSFXComputeObjectTexCoord0_VS:["vec4 ComputeObjectTexCoord0() {","	return vec4(_DSuv, 0.0, 0.0);","}"].join("\n"),PDSFXComputeObjectTexCoord1_VS:["vec4 ComputeObjectTexCoord1() {","	return vec4(_DSuv2, 0.0, 0.0);","}"].join("\n"),PDSFXComputeObjectTexCoord2_VS:["vec4 ComputeObjectTexCoord2() {","	return vec4(0.0);","}"].join("\n"),PDSFXComputeObjectTangent_VS:["vec3 ComputeObjectTangent() {","	return _DStangent;","}"].join("\n"),PDSFXComputeObjectBinormal_VS:["vec3 ComputeObjectBinormal() {","	return _DSbinormal;","}"].join("\n"),PDSFXProcessViewTangentSpace_VS:["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","}"].join("\n"),PDSFXProcessClipSpacePosition_VS:["void ProcessClipSpacePosition(inout vec4 ioPosition) {","}"].join("\n"),PDSFXComputePointSize_VS:["float ComputePointSize() {","#ifdef USE_SIZEATTENUATION","return _DSsize_ * ( _DSscale_ / length( mvPosForAttenuation.xyz ) );","#else","return _DSsize_;","#endif","}"].join("\n"),PDSFXComputeVaryingValues_VS:["void ComputeVaryingValues() {","}"].join("\n"),PDSFXComputeCommonValues_FS:["void ComputeCommonValues() {","}"].join("\n"),PDSFXComputeDiscard_FS:["bool ComputeDiscard() {","	return false;","}"].join("\n"),PDSFXComputeAlbedo_FS:["vec3 ComputeAlbedo() {","	return _DSalbedo_;","}"].join("\n"),PDSFXComputeViewPosition_FS:["vec3 ComputeViewPosition() {","	return _DSviewPosition;","}"].join("\n"),PDSFXComputeViewNormal_FS:["vec3 ComputeViewNormal() {","	return normalize(_DSviewNormal);","}"].join("\n"),PDSFXComputeSpecularReflectance_FS:["vec3 ComputeSpecularReflectance() {","	return _DSspecular_;","}"].join("\n"),PDSFXComputeRoughness_FS:["float ComputeRoughness() {","	return _DSroughness_;","}"].join("\n"),PDSFXComputeTransparency_FS:["float ComputeTransparency() {","	return _DStransparency_;","}"].join("\n"),PDSFXComputeEmissive_FS:["vec3 ComputeEmissive() {","	return _DSemissive_;","}"].join("\n"),PDSFXComputeOpacity_FS:["float ComputeOpacity() {","	return _DSopacity_;","}"].join("\n"),PDSFXProcessFinalColor_FS:["void ProcessFinalColor(inout vec4 ioFinalColor) {","}"].join("\n"),fog_pars_fragment:["#ifdef USE_FOG","uniform vec3 fogColor;","#ifdef FOG_EXP2","uniform float fogDensity;","#else","uniform float fogNear;","uniform float fogFar;","#endif","#endif"].join("\n"),fog_fragment:["#ifdef USE_FOG","float depth = gl_FragCoord.z / gl_FragCoord.w;","#ifdef FOG_EXP2","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","#else","float fogFactor = smoothstep( fogNear, fogFar, depth );","#endif","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","#endif"].join("\n"),envmap_pars_fragment:["#if defined( USE_MAP_HDR ) || defined( USE_ENVMAP_HDR )","uniform vec2 mapHDRSize;","uniform vec2 envMapHDRSize;","vec4 texture2DFromRGBE(sampler2D textureSampler, vec2 uv) {","vec4 texelRGBE = texture2D(textureSampler, uv);","float exponent = pow(2.0, 255.0 * texelRGBE.w - 128.0);","return vec4((255.0 / 256.0) * texelRGBE.xyz * exponent, 1.0);","}","vec4 texture2DBilinearFromRGBE(sampler2D textureSampler, vec2 uv, vec2 textureSize, vec2 texelSize) {","vec4 tl = texture2DFromRGBE(textureSampler, uv);","vec4 tr = texture2DFromRGBE(textureSampler, uv + vec2(texelSize.x, 0.0));","vec4 bl = texture2DFromRGBE(textureSampler, uv + vec2(0.0, texelSize.y));","vec4 br = texture2DFromRGBE(textureSampler, uv + vec2(texelSize.x, texelSize.y));","vec2 f = fract(uv.xy * textureSize.xy);","vec4 tA = mix(tl, tr, f.x);","vec4 tB = mix(bl, br, f.x);","return mix(tA, tB, f.y);","}","#endif","#ifdef USE_ENVMAP","const float PI = 3.1415926535898;","const float INV_PI = 0.31830988618;","uniform float reflectivity;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","uniform sampler2D envMap;","uniform mat4 ambienceMatrix;","uniform float envMapExposure;","#else","uniform samplerCube envMap;","#endif","uniform int combine;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHYSICALDS )","uniform bool useRefract;","uniform float refractionRatio;","#if defined( USE_REFRACTIONRATIOMAP )","uniform sampler2D refractionRatioMap;","#endif","#else","varying vec3 vReflect;","#endif","#endif"].join("\n"),envmap_fragment:["#ifdef USE_ENVMAP","vec3 reflectVec;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","vec3 worldNormal = normalize( vec3( vec4( normal, 0.0 ) * viewMatrix ) );","if ( useRefract ) {","#if defined( USE_REFRACTIONRATIOMAP )","reflectVec = refract( cameraToVertex, worldNormal, texture2D(refractionRatioMap, uvToUse).r );","#else","reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );","#endif","} else { ","reflectVec = reflect( cameraToVertex, worldNormal );","}","#else","reflectVec = vReflect;","#endif","vec3 flipReflectVec;","#ifdef DOUBLE_SIDED","float flipNormal = 1.0;","flipReflectVec = flipNormal * reflectVec;","#else","flipReflectVec = reflectVec;","#endif","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_LIGHTPROBEMAP","flipReflectVec = vec3(flipReflectVec.y, flipReflectVec.z, flipReflectVec.x);","flipReflectVec = (ambienceMatrix*vec4(flipReflectVec,0.0)).xyz;","float probeR = INV_PI * acos( flipReflectVec.z ) / length(flipReflectVec.xy);","#ifdef USE_ENVMAP_HDR","vec2 texelSizeEnvMap = vec2(1.0 / envMapHDRSize);","vec4 cubeColor = texture2DBilinearFromRGBE( envMap, 0.5 * (probeR * flipReflectVec.xy + 1.0), envMapHDRSize, texelSizeEnvMap );","#else","vec4 cubeColor = texture2D( envMap, 0.5 * (probeR * flipReflectVec.xy + 1.0) );","#endif","#else","flipReflectVec = (ambienceMatrix*vec4(flipReflectVec,0.0)).xyz;","float phi = atan(flipReflectVec.y, flipReflectVec.x);","float theta = acos(flipReflectVec.z);","#ifdef USE_ENVMAP_HDR","vec2 texelSizeEnvMap = vec2(1.0 / envMapHDRSize);","vec4 cubeColor = envMapExposure * texture2DBilinearFromRGBE( envMap, vec2(0.5 + 0.5 * INV_PI * phi, 1.0 - INV_PI * theta), envMapHDRSize, texelSizeEnvMap );","#else","vec4 cubeColor = envMapExposure * texture2D( envMap, vec2(0.5 + 0.5 * INV_PI * phi, 1.0 - INV_PI * theta) );","#endif","#endif","#else","#if defined(CUBEMAP_ZUP)","vec4 cubeColor = textureCube( envMap, vec3(-flipReflectVec.x, flipReflectVec.zy) );","#else","vec4 cubeColor = textureCube( envMap, flipReflectVec );","#endif","#endif","if ( combine == 1 ) {","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );","} else if ( combine == 2 ) {","gl_FragColor.xyz += cubeColor.xyz * specularStrength * reflectivity;","} else {","gl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );","}","#endif"].join("\n"),envmap_pars_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP ) && ! defined( PHYSICALDS )","varying vec3 vReflect;","uniform float refractionRatio;","uniform bool useRefract;","#if defined( USE_REFRACTIONRATIOMAP )","uniform sampler2D refractionRatioMap;","#endif","#endif"].join("\n"),lines_pars_vertex:["   uniform vec2 pixelSize;","   bool isNull(float x) {","       return abs(x) < 1e-6;","   }","   float computeWorldSizeToPixel(in vec4 pos) {","      return abs(projectionMatrix[0][0]/pos.w)/pixelSize.x;","   }","   vec2 cNormalize(in vec2 v) {","       float len = length(v);","       if (!isNull(len)) {","           return v/len;","       }","       return vec2(0.0);","   }","   vec3 cNormalize(in vec3 v) {","       float len = length(v);","       if (!isNull(len)) {","           return v/len;","       }","       return vec3(0.0);","   }","   vec4 cNormalize(in vec4 v) {","       float len = length(v);","       if (!isNull(len)) {","           return v/len;","       }","       return vec4(0.0);","   }",s.LineBasicShaderLibs.dashedParsVertex,s.LineBasicShaderLibs.polygonBorderModeParsVertex,s.LineBasicShaderLibs.wideParsVertex,s.LineBasicShaderLibs.roundCapParsVertex,s.LineBasicShaderLibs.roundJoinParsVertex].join("\n"),lines_vertex:["#if defined(USE_DASHEDLINE) || defined(USE_WIDELINE)","	float worldSizeToPixelCurr = computeWorldSizeToPixel(gl_Position);","#endif","#ifdef USE_DASHEDLINE","	#ifndef CPU_PATTERN","		float modelMatrixScaleX = length(modelViewMatrix[0]);","#ifdef FIXED_SIZE","modelMatrixScaleX *= simpleNodeData.fixedSizeScale;","#endif","		vLineDistance = worldSizeToPixelCurr * modelMatrixScaleX * lineDistance;","	#else","		vLineDistance = lineDistance;","	#endif","#endif","#ifdef USE_WIDELINE",s._DefaultShaderChunk.getModelViewTransformationChunk("mvPosition","vec4(position, 1.0)"),s._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPositionPrec","vec4(previousPos.xyz, 1.0)"),s._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPositionSuiv","vec4(followingPos.xyz, 1.0)"),"   vec4 pmvPosition = projectionMatrix * mvPosition;","   vec4 pmvPositionPrec = projectionMatrix * mvPositionPrec;","   vec4 pmvPositionSuiv = projectionMatrix * mvPositionSuiv;","","   vec3 eps = vec3(1e-6);","   bool bPrecCurr = !all(lessThan(abs(position.xyz - previousPos.xyz), eps));","   bool bCurrNext = !all(lessThan(abs(followingPos.xyz - position.xyz), eps));","",s.LineBasicShaderLibs.wideLineClip,"   pmvPosition.y *= pixelSize.x/pixelSize.y;","   pmvPositionPrec.y *= pixelSize.x/pixelSize.y;","   pmvPositionSuiv.y *= pixelSize.x/pixelSize.y;","   float oldW = abs(pmvPosition.w);","   pmvPosition /= abs(pmvPosition.w);","   pmvPositionPrec /= abs(pmvPositionPrec.w);","   pmvPositionSuiv /= abs(pmvPositionSuiv.w);","","   float offset = halfWidth  * pixelSize.x ;","   vec2 pos, posPrecCurr, posCurrNext;","   vec2 dirPrecCurr, dirCurrNext;","   float orientation = sign(sideExtrusion);","   bool parity = mod(sideExtrusion,2.0) < 0.5;","","   if (isNull(length(pmvPosition.xy - pmvPositionPrec.xy))) {","       bPrecCurr = false;","   }","   if (isNull(length(pmvPositionSuiv.xy - pmvPosition.xy))) {","       bCurrNext = false;","   }",s.LineBasicShaderLibs.wideLineExtrusion,"#if defined(USE_DASHEDLINE) || defined(USE_ROUNDCAP) || defined(USE_ROUNDJOIN)","       vec3 auxVec = vec3(pos.x, pos.y * pixelSize.y/pixelSize.x,0.0);","#endif",s.LineBasicShaderLibs.dashedLineInWide,s.LineBasicShaderLibs.roundCapVertex,s.LineBasicShaderLibs.roundJoinVertex,"   float finalZ = getFinalZ(clipped,bvec2(bPrecCurr && !col,bCurrNext), pmvPosition.xyz, pmvPositionPrec.xyz, pmvPositionSuiv.xyz, pos, oldW, mvPosition.xyz,worldSizeToPixelCurr);","   gl_Position = vec4(pos.x, pos.y * pixelSize.y/pixelSize.x,finalZ, pmvPosition.w);","#endif"].join("\n"),lines_pars_fragment:["#ifdef PDSFX","uniform vec3 _DSalbedo;","vec3 diffuse;","#else","uniform vec3 diffuse;","#endif","#ifdef PDSFX","uniform float _DSopacity;","float opacity;","#else","uniform float opacity;","#endif",s.LineBasicShaderLibs.wideParsFragment,s.LineBasicShaderLibs.dashedParsFragment,s.LineBasicShaderLibs.roundCapParsFragment,s.LineBasicShaderLibs.roundJoinParsFragment,].join("\n"),lines_fragment:["#ifdef USE_DASHEDLINE","       float dist = vLineDistance.x;","       float dist2 = 0.0;","   #ifdef USE_WIDELINE","       bool isConnection = length(fwidth(vConstantCurr)) < 1e-2;","       bool resetDist2 = fwidth(resetSecondDist) > 1e-2;","		if (!isConnection){","           dist += getDistance(vPointNext,vPointPrec);","		} else  {","           dist = vLineDistanceAlt + getDistance(vConstantCurr,vConstantPrec, vConstantCurr, vLineDistanceLeft.y - vLineDistanceLeft.x);","           dist2 = getDistance(vConstantNext,vConstantCurr, vConstantCurr, vLineDistanceRight.y - vLineDistanceRight.x);","			dist2 += resetDist2 ? 0.0 : vLineDistanceAlt;","		}","   #endif","   #ifdef PATTERN_LENGTH","       #ifndef USE_WIDELINE","           float halfWidth = 0.0;","       #endif","       float patternAlpha = getPatternAlpha(dist+halfWidth + patternOffset);","       if (abs(dist2) > 1e-6) {","           patternAlpha = min(patternAlpha, getPatternAlpha(dist2+halfWidth + patternOffset));","       }","       if (patternAlpha > 0.5) {","           discard;","       }","   #endif","#endif","#ifdef USE_ROUNDCAP","   doRoundCap();","#endif","#ifdef USE_ROUNDJOIN","   doRoundJoins();","#endif",].join("\n"),worldpos_vertex:["#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined( PHYSICALDS ) || defined ( USE_SHADOWMAP )","#ifdef USE_SKINNING","vec4 worldPosition = modelMatrix * skinned;","#endif","#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( morphed, 1.0 );","#endif","#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","#endif","#endif"].join("\n"),envmap_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP ) && ! defined( PHYSICALDS )","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","worldNormal = normalize( worldNormal );","vec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );","if ( useRefract ) {","#if defined( USE_REFRACTIONRATIOMAP )","vReflect = refract( cameraToVertex, worldNormal, texture2D(refractionRatioMap, uvToUse).r );","#else","vReflect = refract( cameraToVertex, worldNormal, refractionRatio );","#endif","} else {","vReflect = reflect( cameraToVertex, worldNormal );","}","#endif"].join("\n"),map_particle_pars_fragment:["#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_particle_fragment:["#ifdef USE_MAP","gl_FragColor = gl_FragColor * texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );","#endif"].join("\n"),map_pars_vertex:["#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","varying vec2 vUv;","uniform vec2 offsetBumpMap;","uniform vec2 repeatBumpMap;","#if defined (MAPPING_OPERATOR)","#if defined (USE_MAPPING_OPERATOR_VERTEX)","uniform mat3 mappingNormTransformation;","uniform mat4 mappingObjTransformation;","uniform mat3 mappingUVTransformation;","#else","varying vec3 localPosition;","varying vec3 localNormal;","#endif","#endif","#endif"].join("\n"),map_pars_vertex_physical:["#ifdef USE_UV_SLOT_1","varying vec2 vUv;","#endif","#ifdef USE_UV_SLOT_2","varying vec2 vUv2;","#endif","#if defined (MAPPING_OPERATOR)","#if defined (USE_MAPPING_OPERATOR_VERTEX)","uniform mat3 mappingNormTransformation;","uniform mat4 mappingObjTransformation;","uniform mat3 mappingUVTransformation;","vec2 applyMappingOperator(vec2 inUV) {","vec2 outUV = inUV;","vec3 localpos = (mappingObjTransformation * vec4(position, 1.0)).xyz; ","vec3 localnorm = mappingNormTransformation * normal; ","#if MAPPING_OPERATOR==1","outUV = localpos.xy;","#elif MAPPING_OPERATOR==2","float radius3d = max(0.000001,length(localpos.xyz));","float z_by_radius3d = localpos.z / radius3d;","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float phiMapping   = asin(z_by_radius3d );","float u=thetaMapping*radius3d;","float v=phiMapping*radius3d;","outUV = vec2(u, v);","#elif MAPPING_OPERATOR==3","float radius3d = max(0.000001,length(localpos.xyz));","float z_by_radius3d = localpos.z / radius3d;","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float phiMapping   = asin(z_by_radius3d );","float u=thetaMapping/3.14159;","float v=phiMapping/3.14159;","outUV = vec2(u, v);","#elif MAPPING_OPERATOR==4","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","if(maxima_normal == absolute_normal.x){","outUV = vec2(sign(localnorm.x) * localpos.y, localpos.z );","}","else if(maxima_normal == absolute_normal.y){","outUV = vec2(-sign(localnorm.y) * localpos.x, localpos.z );","}","else{","outUV = vec2(sign(localnorm.z) * localpos.x, localpos.y);","}","#elif MAPPING_OPERATOR==5","float radius2d = length(localpos.xy);","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","if(maxima_normal == absolute_normal.z){","outUV = vec2(sign(localnorm.z) * localpos.x, localpos.y); ","}else{","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0){","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","outUV = vec2(u , localpos.z);","}","#elif MAPPING_OPERATOR==6","float radius2d = length(localpos.xy);","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","outUV = vec2(u, localpos.z);","#elif MAPPING_OPERATOR==7","float radius2d = length(localpos.xy);","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping/3.14159;","outUV = vec2(u, localpos.z/(radius2d*3.14159));","#endif","return (mappingUVTransformation * vec3(outUV, 1.0)).xy;","}","#else","varying vec3 localPosition;","varying vec3 localNormal;","#endif","#endif",].join("\n"),map_pars_fragment:["#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","varying vec2 vUv;","#if defined (USE_MAPPING_OPERATOR_FRAGMENT) && defined (MAPPING_OPERATOR)","varying vec3 localPosition;","varying vec3 localNormal;","uniform mat3 mappingNormTransformation;","uniform mat4 mappingObjTransformation;","uniform mat3 mappingUVTransformation;","#endif","#endif","#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_pars_fragment_physical:["#ifdef USE_UV_SLOT_1","varying vec2 vUv;","vec2 uvToUse;","#endif","#ifdef USE_UV_SLOT_2","varying vec2 vUv2;","vec2 uv2ToUse;","#endif","#if defined (USE_MAPPING_OPERATOR_FRAGMENT) && defined (MAPPING_OPERATOR)","varying vec3 localPosition;","varying vec3 localNormal;","uniform mat3 mappingNormTransformation;","uniform mat4 mappingObjTransformation;","uniform mat3 mappingUVTransformation;","vec2 applyMappingOperator(vec2 inUV) {","vec2 outUV = inUV;","vec3 localpos = (mappingObjTransformation * vec4(localPosition, 1.0)).xyz; ","vec3 localnorm = mappingNormTransformation * localNormal; ","#if MAPPING_OPERATOR==1","outUV = localpos.xy;","#elif MAPPING_OPERATOR==2","float radius3d = max(0.000001,length(localpos.xyz));","float z_by_radius3d = localpos.z / radius3d;","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float phiMapping   = asin(z_by_radius3d );","float u=thetaMapping*radius3d;","float v=phiMapping*radius3d;","outUV = vec2(u, v);","#elif MAPPING_OPERATOR==3","float radius3d = max(0.000001,length(localpos.xyz));","float z_by_radius3d = localpos.z / radius3d;","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float phiMapping   = asin(z_by_radius3d );","float u=thetaMapping/3.14159;","float v=phiMapping/3.14159;","outUV = vec2(u, v);","#elif MAPPING_OPERATOR==4","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","if(maxima_normal == absolute_normal.x){","outUV = vec2(sign(localnorm.x) * localpos.y, localpos.z );","}","else if(maxima_normal == absolute_normal.y){","outUV = vec2(-sign(localnorm.y) * localpos.x, localpos.z );","}","else{","outUV = vec2(sign(localnorm.z) * localpos.x, localpos.y);","}","#elif MAPPING_OPERATOR==5","float radius2d = length(localpos.xy);","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","if(maxima_normal == absolute_normal.z){","outUV = vec2(sign(localnorm.z) * localpos.x, localpos.y); ","}else{","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0){","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","outUV = vec2(u , localpos.z);","}","#elif MAPPING_OPERATOR==6","float radius2d = length(localpos.xy);","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","outUV = vec2(u, localpos.z);","#elif MAPPING_OPERATOR==7","float radius2d = length(localpos.xy);","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping/3.14159;","outUV = vec2(u, localpos.z/(radius2d*3.14159));","#endif","return (mappingUVTransformation * vec3(outUV, 1.0)).xy;","}","#endif","#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_vertex_physical:["#ifdef USE_UV_SLOT_1","vUv = uv;","#if defined (MAPPING_OPERATOR) && defined(USE_MAPPING_OPERATOR_VERTEX)","vUv = applyMappingOperator(uv);","#endif","#endif","#ifdef USE_UV_SLOT_2","vUv2 = uv2;","#if defined (MAPPING_OPERATOR) && defined(USE_MAPPING_OPERATOR_VERTEX)","vUv2 = applyMappingOperator(uv2);","#endif","#endif","#if defined(MAPPING_OPERATOR) && !defined(USE_MAPPING_OPERATOR_VERTEX)","localPosition = position;","localNormal = normal;","#endif"].join("\n"),map_vertex:["#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","vUv = uv * repeatBumpMap + offsetBumpMap;","#if defined (MAPPING_OPERATOR)","#if defined (USE_MAPPING_OPERATOR_VERTEX)","vec3 localpos = (mappingObjTransformation * vec4(position, 1.0)).xyz; ","vec3 localnorm = mappingNormTransformation * normal; ","#if MAPPING_OPERATOR==1","vUv = localpos.xy;","#elif MAPPING_OPERATOR==2","float radius3d = max(0.000001,length(localpos.xyz));","float z_by_radius3d = localpos.z / radius3d;","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float phiMapping   = asin(z_by_radius3d );","float u=thetaMapping*radius3d;","float v=phiMapping*radius3d;","vUv = vec2(u, v);","#elif MAPPING_OPERATOR==3","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","if(maxima_normal == absolute_normal.x){","vUv = vec2(sign(localnorm.x) * localpos.y, localpos.z );","}","else if(maxima_normal == absolute_normal.y){","vUv = vec2(sign(localnorm.y) * localpos.x, localpos.z );","}","else{","vUv = vec2(sign(localnorm.z) * localpos.x, localpos.y);","}","#elif MAPPING_OPERATOR==4","float radius2d = length(localpos.xy);","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","if(maxima_normal == absolute_normal.z){","vUv = vec2(localpos.x, localpos.y); ","}else{","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0){","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","vUv = vec2(u , localpos.z);","}","#elif MAPPING_OPERATOR==5","float radius2d = length(localpos.xy);","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","vUv = vec2(u, localpos.z);","#endif","vUv = (mappingUVTransformation * vec3(vUv, 1.0)).xy;","#else","localPosition=position;","localNormal=normal;","#endif","#endif","#endif"].join("\n"),uvmapping_fragment:["#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","#if defined (USE_MAPPING_OPERATOR_FRAGMENT) && defined (MAPPING_OPERATOR)","vec3 localpos = (mappingObjTransformation * vec4(localPosition, 1.0)).xyz; ","vec3 localnorm = mappingNormTransformation * localNormal; ","#if MAPPING_OPERATOR==0","uvToUse = vUv;","#elif MAPPING_OPERATOR==1","uvToUse = localpos.xy;","#elif MAPPING_OPERATOR==2","float radius3d = max(0.000001,length(localpos.xyz));","float z_by_radius3d = localpos.z / radius3d;","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float phiMapping   = asin(z_by_radius3d );","float u=thetaMapping*radius3d;","float v=phiMapping*radius3d;","uvToUse = vec2(u, v);","#elif MAPPING_OPERATOR==3","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","if(maxima_normal == absolute_normal.x){","uvToUse = vec2(sign(localnorm.x) * localpos.y, localpos.z );","}","else if(maxima_normal == absolute_normal.y){","uvToUse = vec2(sign(localnorm.y) * localpos.x, localpos.z );","}","else{","uvToUse = vec2(sign(localnorm.z) * localpos.x, localpos.y );","}","#elif MAPPING_OPERATOR==4","float radius2d = length(localpos.xy);","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","uvToUse = vec2(localpos.x, localpos.y); ","if(maxima_normal == absolute_normal.z){","uvToUse = vec2(localpos.x, localpos.y); ","}else{","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0){","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","uvToUse = vec2(u , localpos.z);","}","#elif MAPPING_OPERATOR==5","float radius2d = length(localpos.xy);","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","uvToUse = vec2(u, localpos.z);","#endif","uvToUse = (mappingUVTransformation * vec3(uvToUse, 1.0)).xy;","#endif","#ifdef PDSFX","_uvToUse = uvToUse;","#endif","#endif"].join("\n"),uvmapping_fragment_physical:["#ifdef USE_UV_SLOT_1","uvToUse = vUv;","#if defined (MAPPING_OPERATOR) && defined(USE_MAPPING_OPERATOR_FRAGMENT)","uvToUse = applyMappingOperator(vUv);","#endif","#endif","#ifdef USE_UV_SLOT_2","uv2ToUse = vUv2;","#if defined (MAPPING_OPERATOR) && defined(USE_MAPPING_OPERATOR_FRAGMENT)","uv2ToUse = applyMappingOperator(vUv2);","#endif","#endif"].join("\n"),map_fragment:["#ifdef USE_MAP","#ifdef USE_MAP_HDR","vec2 texelSizeMap = vec2(1.0 / mapHDRSize);","vec4 texelColor = texture2DBilinearFromRGBE( map, uvToUse/*vUv*/, mapHDRSize, texelSizeMap );","#else","vec4 texelColor = texture2D( map, uvToUse/*vUv*/ );","#ifdef GAMMA_INPUT","texelColor.xyz *= texelColor.xyz;","#endif","#endif","gl_FragColor = gl_FragColor * texelColor;","#endif"].join("\n"),lightmap_pars_fragment:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","uniform sampler2D lightMap;","#endif"].join("\n"),lightmap_pars_vertex:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","#endif"].join("\n"),lightmap_fragment:["#ifdef USE_LIGHTMAP","gl_FragColor = gl_FragColor * texture2D( lightMap, vUv2 );","#endif"].join("\n"),lightmap_vertex:["#ifdef USE_LIGHTMAP","vUv2 = uv2;","#endif"].join("\n"),bumpmap_pars_fragment:["#ifdef USE_BUMPMAP","uniform sampler2D bumpMap;","uniform float bumpScale;","vec2 dHdxy_fwd() {","vec2 dSTdx = dFdx( vUv );","vec2 dSTdy = dFdy( vUv );","float Hll = bumpScale * texture2D( bumpMap, vUv ).x;","float dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;","float dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;","return vec2( dBx, dBy );","}","vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {","vec3 vSigmaX = dFdx( surf_pos );","vec3 vSigmaY = dFdy( surf_pos );","vec3 vN = surf_norm;","vec3 R1 = cross( vSigmaY, vN );","vec3 R2 = cross( vN, vSigmaX );","float fDet = dot( vSigmaX, R1 );","vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );","return normalize( abs( fDet ) * surf_norm - vGrad );","}","#endif"].join("\n"),normalmap_pars_fragment:["#ifdef USE_NORMALMAP","const float horizonFade = 1.3;","uniform sampler2D normalMap;","uniform vec2 normalScale;","vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {","vec3 q0 = dFdx( eye_pos.xyz );","vec3 q1 = dFdy( eye_pos.xyz );","vec2 st0 = dFdx( uvToUse.st );","vec2 st1 = dFdy( uvToUse.st );","float alphaT = step(0.00001, abs(st0.y) + abs(st1.y));","float alphaB = step(0.00001, abs(st0.x) + abs(st1.x));","float alphaBT = 1.0 - max(alphaB, alphaT);","st0.y = alphaT * st0.y - (1.0 - alphaT)*(alphaB * st1.x);","st1.y = alphaT * st1.y + (1.0 - alphaT)*(alphaB * st0.x) + alphaBT;","st0.x = alphaB * st0.x - (1.0 - alphaB)*(alphaT * st1.y) + alphaBT;","st1.x = alphaB * st1.x + (1.0 - alphaB)*(alphaT * st0.y);","vec3 S = normalize(  q0 * st1.t - q1 * st0.t );","vec3 T = normalize( -q0 * st1.s + q1 * st0.s );","vec3 N = normalize( surf_norm );","vec3 mapN = texture2D( normalMap, uvToUse/*vUv*/ ).xyz * 2.0 - 1.0;","mapN.xy = normalScale * mapN.xy;","#ifdef NORMALFLIPY","mapN.y = - mapN.y;","#endif","mat3 tsn = mat3( S, T, N );","return normalize( tsn * mapN );","}","vec3 perturbNormal3Arb( vec3 surf_norm, vec3 surf_tgt, vec3 surf_binorm, vec2 normalUV ) {","vec3 N = normalize(surf_norm);","vec3 T = normalize(surf_tgt);","T = normalize(T - dot(T, N) * N);","vec3 B = normalize(surf_binorm);","vec3 mapN = texture2D( normalMap, normalUV ).xyz * 2.0 - 1.0;","#ifdef NORMALFLIPY","mapN.y = - mapN.y;","#endif","mapN.xy = normalScale * mapN.xy;","mat3 tbn = mat3(T, B, N);","return normalize(tbn * mapN);","}","#endif"].join("\n"),specularmap_pars_fragment:["#ifdef USE_SPECULARMAP","uniform sampler2D specularMap;","#endif"].join("\n"),specularmap_fragment:["float specularStrength;","#ifdef USE_SPECULARMAP","#ifdef NRE_COMPATIBILITY","#if (SPECULARMAP_UV_SLOT == 2)","vec2 specularUV = (specularUvTransform * vec3(uv2ToUse, 1.0)).xy;","#else","vec2 specularUV=(specularUvTransform * vec3( uvToUse, 1.0)).xy ;","#endif","#else","vec2 specularUV=uvToUse;","#endif","vec4 texelSpecular = texture2D( specularMap, specularUV );","specularStrength = texelSpecular.r;","#ifdef PHONG","if (shininessInSpecMap) {","shininessValue = texelSpecular.a;","}","#endif","#else","specularStrength = 1.0;","#endif"].join("\n"),lights_lambert_pars_vertex:["uniform vec3 ambient;","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 ambientLightColor;","#if defined( USE_SH_ENVMAP )","uniform mat4 shFactorsR;","uniform mat4 shFactorsG;","uniform mat4 shFactorsB;","uniform float shScale;","#endif","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","uniform float directionalLightFar[ MAX_DIR_LIGHTS ];","uniform float directionalLightNear[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightInnerAngleCos[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif"].join("\n"),lights_lambert_vertex:["vLightFront = vec3( 0.0 );","#ifdef DOUBLE_SIDED","vLightBack = vec3( 0.0 );","#endif","transformedNormal = normalize( transformedNormal );","#if MAX_DIR_LIGHTS > 0","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, dirVector );","vec3 directionalLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 directionalLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","directionalLightWeighting = mix( directionalLightWeighting, directionalLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","directionalLightWeightingBack = mix( directionalLightWeightingBack, directionalLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += directionalLightColor[ i ] * directionalLightWeighting;","#ifdef DOUBLE_SIDED","vLightBack += directionalLightColor[ i ] * directionalLightWeightingBack;","#endif","}","#endif","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 pointLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 pointLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","pointLightWeighting = mix( pointLightWeighting, pointLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","pointLightWeightingBack = mix( pointLightWeightingBack, pointLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += pointLightColor[ i ] * pointLightWeighting * lDistance;","#ifdef DOUBLE_SIDED","vLightBack += pointLightColor[ i ] * pointLightWeightingBack * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - worldPosition.xyz ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = 1.0 - smoothstep( spotLightInnerAngleCos[ i ],spotLightAngleCos[ i ],spotEffect );","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 spotLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 spotLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","spotLightWeighting = mix( spotLightWeighting, spotLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","spotLightWeightingBack = mix( spotLightWeightingBack, spotLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += spotLightColor[ i ] * spotLightWeighting * lDistance * spotEffect;","#ifdef DOUBLE_SIDED","vLightBack += spotLightColor[ i ] * spotLightWeightingBack * lDistance * spotEffect;","#endif","}","}","#endif","#if MAX_HEMI_LIGHTS > 0","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","float hemiDiffuseWeightBack = -0.5 * dotProduct + 0.5;","vLightFront += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","#ifdef DOUBLE_SIDED","vLightBack += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeightBack );","#endif","}","#endif","#if defined( USE_SH_ENVMAP )","vec3 worldNormalSH = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","worldNormalSH = normalize( worldNormalSH );","vec4 normal4 = vec4(worldNormalSH, 1.0);","vec3 shDiffuse;","shDiffuse.r = dot(normal4,(shFactorsR * normal4));","shDiffuse.g = dot(normal4,(shFactorsG * normal4));","shDiffuse.b = dot(normal4,(shFactorsB * normal4));","vLightFront += shScale * shDiffuse;","#endif","vLightFront = vLightFront * diffuse + ambient * ambientLightColor + emissive;","#ifdef DOUBLE_SIDED","vLightBack = vLightBack * diffuse + ambient * ambientLightColor + emissive;","#endif"].join("\n"),lights_phong_pars_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( ENV_MAP ) || defined(USE_SHADOWMAP_CUBE)","varying vec3 vWorldPosition;","#endif","#ifdef USE_SH_ENVMAP","varying vec3 vWorldNormal;","#endif"].join("\n"),lights_phong_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","vPointLight[ i ] = vec4( lVector, lDistance );","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","vSpotLight[ i ] = vec4( lVector, lDistance );","}","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( ENV_MAP ) || defined(USE_SHADOWMAP_CUBE)","vWorldPosition = worldPosition.xyz;","#endif","#ifdef USE_SH_ENVMAP","vWorldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","vWorldNormal = normalize( vWorldNormal );","#endif"].join("\n"),lights_phong_pars_fragment:["uniform vec3 ambientLightColor;","#if defined( USE_SH_ENVMAP )","uniform mat4 shFactorsR;","uniform mat4 shFactorsG;","uniform mat4 shFactorsB;","uniform float shScale;","varying vec3 vWorldNormal;","#endif","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","uniform float directionalLightFar[ MAX_DIR_LIGHTS ];","uniform float directionalLightNear[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#else","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightInnerAngleCos[ MAX_SPOT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#else","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined(USE_SHADOWMAP_CUBE)","varying vec3 vWorldPosition;","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","#ifndef PDSFX","varying vec3 vViewPosition;","#else","vec3 vViewPosition;","#endif","varying vec3 vNormal;"].join("\n"),lights_phong_fragment:["#ifdef PDSFX","vec3 normal = _DSvNormal;","#else","vec3 normal = normalize( vNormal );","#endif","vec3 viewPosition = normalize( vViewPosition );","#ifdef DOUBLE_SIDED","normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","#ifdef USE_NORMALMAP","normal = perturbNormal2Arb( -vViewPosition, normal );","#elif defined( USE_BUMPMAP )","normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","#endif","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse  = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vPointLight[ i ].xyz );","float lDistance = vPointLight[ i ].w;","#endif","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dotProduct, 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dotProduct, 0.0 );","#endif","pointDiffuse  += diffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;","vec3 pointHalfVector = normalize( lVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularStrength * max( pow( pointDotNormalHalf, shininessValue ), 0.0 );","pointSpecular += specular * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance;","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse  = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vSpotLight[ i ].xyz );","float lDistance = vSpotLight[ i ].w;","#endif","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = 1.0 - smoothstep( spotLightInnerAngleCos[ i ],spotLightAngleCos[ i ],spotEffect );","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dotProduct, 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dotProduct, 0.0 );","#endif","spotDiffuse += diffuse * spotLightColor[ i ] * spotDiffuseWeight * lDistance * spotEffect;","vec3 spotHalfVector = normalize( lVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularStrength * max( pow( spotDotNormalHalf, shininessValue ), 0.0 );","spotSpecular += specular * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * spotEffect;","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, dirVector );","#ifdef WRAP_AROUND","float dirDiffuseWeightFull = max( dotProduct, 0.0 );","float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dotProduct, 0.0 );","#endif","dirDiffuse  += diffuse * directionalLightColor[ i ] * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininessValue ), 0.0 );","dirSpecular += specular * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight;","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += diffuse * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularStrength * max( pow( hemiDotNormalHalfSky, shininessValue ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularStrength * max( pow( hemiDotNormalHalfGround, shininessValue ), 0.0 );","hemiSpecular += specular * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#if defined( USE_SH_ENVMAP )","vec4 normal4 = vec4(vWorldNormal, 1.0);","#ifdef DOUBLE_SIDED","normal4.xyz = normal4.xyz * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","vec3 shDiffuse;","shDiffuse.r = dot(normal4,(shFactorsR * normal4));","shDiffuse.g = dot(normal4,(shFactorsG * normal4));","shDiffuse.b = dot(normal4,(shFactorsB * normal4));","totalDiffuse += shScale * diffuse * shDiffuse;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient + totalSpecular );","#else","#ifdef TEXTURE_BLENDING","vec4 texture = vec4( 1.0 );","#ifdef USE_MAP","texture = texelColor;","#endif","#if TEXTURE_BLENDING == 3","#if TEXTURE_FORMAT == 1021","gl_FragColor.a = texture.a;","#endif","#else","#if TEXTURE_BLENDING == 1","gl_FragColor.xyz = texture.xyz * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif","#if TEXTURE_BLENDING == 0","gl_FragColor.xyz = ((1.0-texture.a) * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular) + (texture.a * texture.xyz);","#endif","#if TEXTURE_BLENDING == 2","gl_FragColor.xyz = ((1.0-texture.xyz) * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular) + texture.xyz;","#endif","#endif","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif","#endif"].join("\n"),lights_phong_firstdironly_fragment:["vec3 normal = normalize( vNormal );","vec3 viewPosition = normalize( vViewPosition );","#ifdef DOUBLE_SIDED","normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","#ifdef USE_NORMALMAP","normal = perturbNormal2Arb( -vViewPosition, normal );","#elif defined( USE_BUMPMAP )","normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ 0 ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, dirVector );","#ifdef WRAP_AROUND","float dirDiffuseWeightFull = max( dotProduct, 0.0 );","float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dotProduct, 0.0 );","#endif","dirDiffuse  += diffuse * 3.0 * directionalLightColor[ 0 ] * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininess ), 0.0 );","dirSpecular += specular * directionalLightColor[ 0 ] * dirSpecularWeight * dirDiffuseWeight;","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if defined( USE_SH_ENVMAP )","vec4 normal4 = vec4(vWorldNormal, 1.0);","#ifdef DOUBLE_SIDED","normal4.xyz = normal4.xyz * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","vec3 shDiffuse;","shDiffuse.r = dot(normal4,(shFactorsR * normal4));","shDiffuse.g = dot(normal4,(shFactorsG * normal4));","shDiffuse.b = dot(normal4,(shFactorsB * normal4));","totalDiffuse += shScale * diffuse * shDiffuse;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient + totalSpecular );","#else","#ifdef TEXTURE_BLENDING","vec4 texture = vec4( 1.0 );","#ifdef USE_MAP","texture = texelColor;","#endif","#if TEXTURE_BLENDING == 3","#if TEXTURE_FORMAT == 1021","gl_FragColor.a = texture.a;","#endif","#else","#if TEXTURE_BLENDING == 1","gl_FragColor.xyz = texture.xyz * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif","#if TEXTURE_BLENDING == 0","gl_FragColor.xyz = ((1.0-texture.a) * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular) + (texture.a * texture.xyz);","#endif","#if TEXTURE_BLENDING == 2","gl_FragColor.xyz = ((1.0-texture.xyz) * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular) + texture.xyz;","#endif","#endif","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif","#endif"].join("\n"),color_pars_fragment:["#ifdef USE_COLOR","varying vec4 vColor;","#endif"].join("\n"),color_fragment:["#ifdef USE_COLOR","#ifdef USE_COLOR_RGB","gl_FragColor.xyz *= vColor.xyz;","#elif defined( USE_COLOR_A )","gl_FragColor.w *= vColor.w;","#else","gl_FragColor *= vColor;","#endif","#endif"].join("\n"),color_pars_vertex:["#ifdef USE_COLOR","varying vec4 vColor;","#endif"].join("\n"),color_vertex:["#ifdef USE_COLOR","#ifdef GAMMA_INPUT","vColor = color * color;","#else","vColor = color;","#endif","#endif"].join("\n"),skinning_pars_vertex:["#ifdef USE_SKINNING","#ifdef USE_SKINNING_ANGLES","mat4 getMatrixFromEulerAngles(const in vec3 angles, const in vec3 offset) {","float cosx = cos(angles.y);","float cosy = cos(angles.z);","float cosz = cos(angles.x);","float sinx = sin(angles.y);","float siny = sin(angles.z);","float sinz = sin(angles.x);","float a11, a12, a13, a21, a22, a23, a31, a32, a33;","float cosycosz = cosy*cosz;","float sinxsiny = sinx*siny;","a11 = cosycosz - sinxsiny*sinz;","a12 = -cosx*sinz;","a13 = cosz*siny + cosy*sinx*sinz;","a21 = cosz*sinxsiny + cosy*sinz;","a22 = cosx*cosz;","a23 = siny*sinz - cosycosz*sinx;","a31 = -cosx*siny;","a32 = sinx;","a33 = cosx*cosy;","mat4 bone = mat4(","vec4(a11, a21, a31, 0.0),","vec4(a12, a22, a32, 0.0),","vec4(a13, a23, a33, 0.0),","vec4(offset, 1.0));","return bone;","}","#endif","#ifdef IS_MULTI_INSTANCED","uniform sampler2D skinningInstancingMaps[NB_INSTANCING_SKIN_MAPS];","mat4 getBoneMatrix( const in float i ) {","if (i >= 0.0) {","float real_instanceId = instanceId/5.0 -1.0;","#ifdef USE_SKINNING_ANGLES","float matId = real_instanceId * NB_BONES * 2.0 + 2.0 * i;","#else","float matId = real_instanceId * NB_BONES * 4.0 + 4.0 * i;","#endif","int texId = int(floor(matId/(MAX_MAP_SIZE*MAX_MAP_SIZE)));","float dx, dy;","float x, y;","float xyInTex = matId - float(texId) * (MAX_MAP_SIZE*MAX_MAP_SIZE);","if (texId == NB_INSTANCING_SKIN_MAPS - 1) {","dx = 1.0 / LAST_INSTANCING_SKIN_MAP_SIZE_X;","dy = 1.0 / LAST_INSTANCING_SKIN_MAP_SIZE_Y;","y = floor(xyInTex/LAST_INSTANCING_SKIN_MAP_SIZE_X);","x = xyInTex - y*LAST_INSTANCING_SKIN_MAP_SIZE_X;","} else {","dx = 1.0 / MAX_MAP_SIZE;","dy = 1.0 / MAX_MAP_SIZE;","y = floor(xyInTex/MAX_MAP_SIZE);","x = xyInTex - y*MAX_MAP_SIZE;","}","vec3 v0, v1, v2, v3;","for (int j = 0; j < NB_INSTANCING_SKIN_MAPS; j++) {","if (texId == j) {","v0 = texture2D( skinningInstancingMaps[j], vec2( dx * ( x + 0.5 ), dy * ( y + 0.5 ) ) ).xyz;","v1 = texture2D( skinningInstancingMaps[j], vec2( dx * ( x + 1.5 ), dy * ( y + 0.5 ) ) ).xyz;","#ifndef USE_SKINNING_ANGLES","v2 = texture2D( skinningInstancingMaps[j], vec2( dx * ( x + 2.5 ), dy * ( y + 0.5 ) ) ).xyz;","v3 = texture2D( skinningInstancingMaps[j], vec2( dx * ( x + 3.5 ), dy * ( y + 0.5 ) ) ).xyz;","#endif","break;","}","}","#ifdef USE_SKINNING_ANGLES","vec3 offset = v0;","vec3 angles = v1;","mat4 bone = getMatrixFromEulerAngles(angles, offset);","#else","mat4 bone = mat4(vec4(v0, 0.0), vec4(v1, 0.0), vec4(v2, 0.0), vec4(v3, 1.0));","#endif","return bone;","} else ","return mat4(1.0);","}","#else","uniform sampler2D skinningMap;","mat4 getBoneMatrix( const in float i ) {","if (i >= 0.0) {","#ifdef USE_SKINNING_ANGLES","float j = i * 2.0;","#else","float j = i * 4.0;","#endif","float x = mod( j, N_BONE_PIXEL_X );","float y = floor( j / N_BONE_PIXEL_X );","const float dx = 1.0 / N_BONE_PIXEL_X;","const float dy = 1.0 / N_BONE_PIXEL_Y;","y = dy * ( y + 0.5 );","vec3 v0 = texture2D( skinningMap, vec2( dx * ( x + 0.5 ), y ) ).xyz;","vec3 v1 = texture2D( skinningMap, vec2( dx * ( x + 1.5 ), y ) ).xyz;","#ifndef USE_SKINNING_ANGLES","vec3 v2 = texture2D( skinningMap, vec2( dx * ( x + 2.5 ), y ) ).xyz;","vec3 v3 = texture2D( skinningMap, vec2( dx * ( x + 3.5 ), y ) ).xyz;","#endif","#ifdef USE_SKINNING_ANGLES","vec3 offset = v0;","vec3 angles = v1;","mat4 bone = getMatrixFromEulerAngles(angles, offset);","#else","mat4 bone = mat4(vec4(v0, 0.0), vec4(v1, 0.0), vec4(v2, 0.0), vec4(v3, 1.0));","#endif","return bone;","} else ","return mat4(1.0);","}","#endif","#endif"].join("\n"),skinbase_vertex:["#ifdef USE_SKINNING","mat4 boneMatX = getBoneMatrix( skinIndex.x );","mat4 boneMatY = getBoneMatrix( skinIndex.y );","mat4 boneMatZ = getBoneMatrix( skinIndex.z );","mat4 boneMatW = getBoneMatrix( skinIndex.w );","mat4 skinMatrix = skinWeight.x * boneMatX;","skinMatrix 	+= skinWeight.y * boneMatY;","skinMatrix 	+= skinWeight.z * boneMatZ;","skinMatrix 	+= skinWeight.w * boneMatW;","#endif"].join("\n"),skinning_vertex:["#ifdef USE_SKINNING","#ifdef USE_MORPHTARGETS","vec4 skinVertex = vec4( morphed, 1.0 );","#else","vec4 skinVertex = vec4( position, 1.0 );","#endif","vec4 skinned  = skinMatrix * skinVertex;","#endif"].join("\n"),morphtarget_pars_vertex:["#ifdef USE_MORPHTARGETS","#ifndef USE_MORPHNORMALS","uniform float morphTargetInfluences[ 8 ];","#else","uniform float morphTargetInfluences[ 4 ];","#endif","#endif"].join("\n"),morphtarget_vertex:["#ifdef USE_MORPHTARGETS","vec3 morphed = vec3( 0.0 );","morphed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];","morphed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];","morphed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];","morphed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];","#ifndef USE_MORPHNORMALS","morphed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];","morphed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];","morphed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];","morphed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];","#endif","morphed += position;","#endif"].join("\n"),displacement_vertex:["#ifdef USE_DISPLACEMENTMAP","vec3 dv = texture2D( displacementMap, uv ).xyz;","float df = displacementScale * dv.x + displacementBias;","#ifdef USE_SKINNING","vec3 displacedPosition = skinned.xyz + normalize( skinnedNormal.xyz ) * df;","#else","vec3 displacedPosition = position + normalize( normal ) * df;","#endif","#endif"].join("\n"),default_vertex:["vec4 mvPosition;","#ifdef USE_SKINNING",s._DefaultShaderChunk.getModelViewTransformationChunk("mvPosition","skinned"),"#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHTARGETS ) && !defined( USE_DISPLACEMENTMAP )",s._DefaultShaderChunk.getModelViewTransformationChunk("mvPosition","vec4( morphed, 1.0 )"),"#endif","#if defined(USE_DISPLACEMENTMAP)",s._DefaultShaderChunk.getModelViewTransformationChunk("mvPosition","vec4( displacedPosition, 1.0 )"),"#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHTARGETS ) && ! defined( USE_DISPLACEMENTMAP )",s._DefaultShaderChunk.getModelViewTransformationChunk("mvPosition","vec4( position, 1.0 )"),"#endif","#ifdef PDSFX","_viewTangentSpace.Position = mvPosition.xyz;","ProcessViewTangentSpace(_viewTangentSpace);","mvPosition.xyz = _viewTangentSpace.Position;","#ifdef USE_SIZEATTENUATION","mvPosForAttenuation = mvPosition.xyz;","#endif","#if defined(USE_TANGENT) || defined(USE_TANGENT_BINORMAL)","vTangent = _viewTangentSpace.Tangent;","#ifdef USE_TANGENT_BINORMAL","vBinormal = _viewTangentSpace.Binormal;","#endif","#endif","#endif","gl_Position = projectionMatrix * mvPosition;",].join("\n"),clip_pars_vertex:["#ifdef USE_CLIPPINGPLANES","#if MAX_CLIP_PLANES > 0","uniform lowp int nbClipPlanes;","uniform vec4 clipPlaneEquations[ MAX_CLIP_PLANES ];","varying float clipDist[ MAX_CLIP_PLANES ];","#endif","#endif","#ifdef USE_CLIPPINGPOLYGON","varying vec2 extrusionPlaneUV;","uniform vec3 extrusionPlaneU;","uniform vec3 extrusionPlaneV;","#endif",""].join("\n"),clip_vertex:["#ifdef USE_CLIPPINGPLANES","if(nbClipPlanes > 0) {","clipDist[ 0 ] = dot( mvPosition.xyz, clipPlaneEquations[ 0 ].xyz ) + clipPlaneEquations[ 0 ].w;","clipDist[ 1 ] = dot( mvPosition.xyz, clipPlaneEquations[ 1 ].xyz ) + clipPlaneEquations[ 1 ].w;","clipDist[ 2 ] = dot( mvPosition.xyz, clipPlaneEquations[ 2 ].xyz ) + clipPlaneEquations[ 2 ].w;","clipDist[ 3 ] = dot( mvPosition.xyz, clipPlaneEquations[ 3 ].xyz ) + clipPlaneEquations[ 3 ].w;","clipDist[ 4 ] = dot( mvPosition.xyz, clipPlaneEquations[ 4 ].xyz ) + clipPlaneEquations[ 4 ].w;","clipDist[ 5 ] = dot( mvPosition.xyz, clipPlaneEquations[ 5 ].xyz ) + clipPlaneEquations[ 5 ].w;","}","#endif","#ifdef USE_CLIPPINGPOLYGON","vec3 positionWorld = (modelMatrix*vec4(position.xyz, 1)).xyz;","extrusionPlaneUV = vec2(dot(positionWorld, extrusionPlaneU), dot(positionWorld, extrusionPlaneV));","#endif",""].join("\n"),clip_pars_fragment:["#ifdef USE_CLIPPINGPLANES","#if MAX_CLIP_PLANES > 0","uniform lowp int nbClipPlanes;","varying float clipDist[ MAX_CLIP_PLANES ];","uniform int clipPlaneActive[ MAX_CLIP_PLANES ];","uniform lowp float clipFrontOpacity;","uniform lowp float clipBackOpacity;","#endif","#endif","#ifdef USE_CLIPPINGPOLYGON","uniform sampler2D polygonPoints;","uniform int polygonSize;","varying vec2 extrusionPlaneUV;","vec4 makeColor( const in float r, const in float g, const in float b) { "," return vec4(r,g,b,1.0); }","vec2 getPolygonPoint(const in int index) {","    return texture2D(polygonPoints, vec2((float(index)+0.5)*1.0/float(polygonSize),0.5)).rg;","}","","bool isPointInsidePolygon(const in vec2 point) {","    vec2 previousPoint, currentPoint;","    int i;","    previousPoint = getPolygonPoint(polygonSize-1);","    bool result = false;","    for(int i=0; i < MAX_POLYGON_SIZE;i++) {","        if(i < polygonSize) {","            currentPoint = getPolygonPoint(i);","            if ( ((currentPoint.y>point.y) != (previousPoint.y>point.y)) &&","                 (point.x < (previousPoint.x-currentPoint.x) * (point.y-currentPoint.y) / (previousPoint.y-currentPoint.y) + currentPoint.x) ) {","                result = !result;","            }","            previousPoint = currentPoint;","        }","    }","    return result;","}","#endif",""].join("\n"),clip_fragment:["#ifdef USE_CLIPPINGPLANES","float clipOpacity = -1.0;","if(nbClipPlanes > 0) {","if (0 < nbClipPlanes && clipDist[ 0 ] < 0.0 && clipPlaneActive[ 0 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 0 < nbClipPlanes && clipPlaneActive[ 0 ] > 0) { clipOpacity = clipFrontOpacity; }","if (1 < nbClipPlanes && clipDist[ 1 ] < 0.0 && clipPlaneActive[ 1 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 1 < nbClipPlanes && clipPlaneActive[ 1 ] > 0) { clipOpacity = clipFrontOpacity; }","if (2 < nbClipPlanes && clipDist[ 2 ] < 0.0 && clipPlaneActive[ 2 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 2 < nbClipPlanes && clipPlaneActive[ 2 ] > 0) { clipOpacity = clipFrontOpacity; }","if (3 < nbClipPlanes && clipDist[ 3 ] < 0.0 && clipPlaneActive[ 3 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 3 < nbClipPlanes && clipPlaneActive[ 3 ] > 0) { clipOpacity = clipFrontOpacity; }","if (4 < nbClipPlanes && clipDist[ 4 ] < 0.0 && clipPlaneActive[ 4 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 4 < nbClipPlanes && clipPlaneActive[ 4 ] > 0) { clipOpacity = clipFrontOpacity; }","if (5 < nbClipPlanes && clipDist[ 5 ] < 0.0 && clipPlaneActive[ 5 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 5 < nbClipPlanes && clipPlaneActive[ 5 ] > 0) { clipOpacity = clipFrontOpacity; }","if(clipOpacity == 0.0) discard;","}","#endif","#ifdef USE_CLIPPINGPOLYGON","if(polygonSize > 0) {","  if(!isPointInsidePolygon(extrusionPlaneUV)) {","    discard;","  }","}","#endif",""].join("\n"),iterative_pars_fragment:["#if defined(USE_ITERATION)","uniform int renderIteration;","float random(vec3 scale, float seed) {","  return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","float HaltonSequence(int n, int base) {","float val = 0.0;","float invBase = 1.0 / float(base);","float invBi = invBase;","for (int i = 0; i < 32; i++) {","if (n == 0) break;","float d_i = mod(float(n), float(base));","val += float(d_i) * invBi;","n /= base;","invBi *= invBase;","}","return val;","}","float HaltonSequenceShift(int n, int base, float shift) {","float val = 0.0;","float invBase = 1.0 / float(base);","float invBi = invBase;","for (int i = 0; i < 32; i++) {","if (n == 0) break;","float d_i = mod(float(n), float(base));","val += float(d_i) * invBi;","n /= base;","invBi *= invBase;","}","return fract(val + shift);","}","vec2 LowDiscrepancy2D(int index) {","vec2 res;","res.x = HaltonSequence(index, 2);","res.y = HaltonSequence(index, 5);","return res;","}","vec2 LowDiscrepancy2DShift(int index, vec2 shift) {","vec2 res;","res.x = HaltonSequenceShift(index, 2, shift.x);","res.y = HaltonSequenceShift(index, 5, shift.y);","return res;","}","float Random1D(float seed) {","return random(vec3(12.9898, 78.233, 151.7182), seed);","}","vec2 Random2D(float seed) {","vec2 res;","res.x = random(vec3(12.9898, 78.233, 151.7182), seed);","res.y = random(vec3(63.7264, 10.873, 623.6736), seed);","return res;","}","#endif"].join("\n"),stochastic_transparency_fragment:["#if defined(USE_ITERATION)","float classicAlpha = gl_FragColor.a;","if (classicAlpha < 1.0) {","gl_FragColor.a = 1.0;","float stoch_random = Random1D(float(renderIteration) + vViewPosition.x + vViewPosition.y + vViewPosition.z);","if(stoch_random > classicAlpha) {","discard;","}","}","#endif"].join("\n"),morphnormal_vertex:["#ifdef USE_MORPHNORMALS","vec3 morphedNormal = vec3( 0.0 );","morphedNormal +=  ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];","morphedNormal +=  ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];","morphedNormal +=  ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];","morphedNormal +=  ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];","morphedNormal += normal;","#endif"].join("\n"),skinnormal_vertex:["#ifdef USE_SKINNING","#ifdef USE_MORPHNORMALS","vec4 skinnedNormal = skinMatrix * vec4( morphedNormal, 0.0 );","#else","vec4 skinnedNormal = skinMatrix * vec4( normal, 0.0 );","#endif","#endif"].join("\n"),defaultnormal_vertex:["vec3 objectNormal;","#ifdef USE_SKINNING","objectNormal = skinnedNormal.xyz;","#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHNORMALS )","objectNormal = morphedNormal;","#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHNORMALS )","objectNormal = normal;","#endif","#ifdef FLIP_SIDED","objectNormal = -objectNormal;","#endif","vec3 transformedNormal;","if (use_normal_matrix)","transformedNormal = normalMatrix * objectNormal;","else {",s._DefaultShaderChunk.getModelViewUnitVectorTransformationChunk("transformedNormal","objectNormal"),"}","transformedNormal = normalize(transformedNormal);","#ifdef PDSFX","_viewTangentSpace.Normal = transformedNormal;","#endif",].join("\n"),shadowmap_pars_fragment:["#if defined (USE_SHADOWMAP) || defined(USE_SHADOWMAP_CUBE)","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","float randomValue(vec3 scale, float seed) {","return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","#endif","#ifdef USE_SHADOWMAP","uniform sampler2D shadowMap[ MAX_SHADOWS ];","uniform vec2 shadowMapSize[ MAX_SHADOWS ];","uniform float shadowDarkness[ MAX_SHADOWS ];","uniform float shadowBias[ MAX_SHADOWS ];","#if defined(SHADOWMAP_TYPE_PCF_POISSON) ||defined(SHADOWMAP_TYPE_PCF_INTERPOL)","#if defined(SHADOWMAP_QUALITY_MEDIUM)","uniform vec2 poissonDisk[25];","const int poissonCount = 25;","const float poissonInvSamples = 0.04;","#elif defined(SHADOWMAP_QUALITY_HIGH)","uniform vec2 poissonDisk[49];","const int poissonCount = 49;","const float poissonInvSamples = 0.020408;","#else","uniform vec2 poissonDisk[9];","const int poissonCount = 9;","const float poissonInvSamples = 0.111111;","#endif","#endif","varying vec4 vShadowCoord[ MAX_SHADOWS ];","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","float compESM(sampler2D shadowMap, vec2 coord, float depthFrag) {","float result = texture2D(shadowMap, coord).x * exp(-80.0 * depthFrag);","result *= result * result;","return result;","}","float texture2DESMToPCFCompare(sampler2D shadowMap, vec2 coord, float depthFrag) {","float depthShadowMap = log(texture2D(shadowMap, coord).x) / 80.0;","return step(depthShadowMap, depthFrag);","}","float texture2DShadowESMLerp(sampler2D shadowMap, vec2 shadowMapSize, vec2 shadowPixelSize, vec2 coord, float depthFrag) {","vec2 fractCoord = fract(coord * shadowMapSize + 0.5);","vec2 centroidUV = (coord * shadowMapSize - fractCoord) * shadowPixelSize;","float lb = clamp(compESM(shadowMap, centroidUV, depthFrag), 0.0, 1.0);","float lt = clamp(compESM(shadowMap, centroidUV + vec2(0.0, shadowPixelSize.y), depthFrag), 0.0, 1.0);","float rb = clamp(compESM(shadowMap, centroidUV + vec2(shadowPixelSize.x, 0.0), depthFrag), 0.0, 1.0);","float rt = clamp(compESM(shadowMap, centroidUV + shadowPixelSize, depthFrag), 0.0, 1.0);","float a = mix(lb, lt, fractCoord.y);","float b = mix(rb, rt, fractCoord.y);","return 1.0 - mix(a, b, fractCoord.x);","}","#endif","float texture2DCompare(sampler2D shadowMap, vec2 coord, float depthFrag) {","float depthShadowMap = unpackDepth(texture2D(shadowMap, coord));","return step(depthShadowMap, depthFrag);","}","float texture2DShadowLerp(sampler2D shadowMap, vec2 shadowMapSize, vec2 shadowPixelSize, vec2 coord, float depthFrag) {","vec2 fractCoord = fract(coord * shadowMapSize + 0.5);","vec2 centroidUV = (coord * shadowMapSize - fractCoord) * shadowPixelSize;","float lb = texture2DCompare(shadowMap, centroidUV, depthFrag);","float lt = texture2DCompare(shadowMap, centroidUV + vec2(0.0, shadowPixelSize.y), depthFrag);","float rb = texture2DCompare(shadowMap, centroidUV + vec2(shadowPixelSize.x, 0.0), depthFrag);","float rt = texture2DCompare(shadowMap, centroidUV + shadowPixelSize, depthFrag);","float a = mix(lb, lt, fractCoord.y);","float b = mix(rb, rt, fractCoord.y);","return mix(a, b, fractCoord.x);","}","#if defined( SHADOWMAP_TYPE_PCF )","float getExposurePCF(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize) {","float shadow = 0.0;","#if defined( SHADOWMAP_QUALITY_LOW )","const float shadowDelta = 1.0 / 9.0;","const int fetchCount = 3;","#elif defined( SHADOWMAP_QUALITY_MEDIUM )","const float shadowDelta = 1.0 / 25.0;","const int fetchCount = 5;","#elif defined( SHADOWMAP_QUALITY_HIGH )","const float shadowDelta = 1.0 / 49.0;","const int fetchCount = 7;","#endif","float xPixelOffset = 1.0 / shadowMapSize.x;","float yPixelOffset = 1.0 / shadowMapSize.y;","float dx0 = -1.25 * float((fetchCount-1)/2) *xPixelOffset;","float dy0 = -1.25 * float((fetchCount-1)/2) *yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","float fDepth;","vec2 delta = vec2(dx0,dy0);","for  (int i = 0; i < fetchCount; i ++) {","for  (int j = 0; j < fetchCount; j ++) {","shadow += shadowDelta * texture2DCompare(shadowMap,shadowCoord.xy + delta,shadowCoord.z);","delta.y +=dy1;","}","delta.y =dy0;","delta.x +=dx1;","}","return shadow;","}","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","float getExposurePCFSoft(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize){","float shadow = 0.0;","float xPixelOffset = 1.0 / shadowMapSize.x;","float yPixelOffset = 1.0 / shadowMapSize.y;","float dx0 = -1.0 * xPixelOffset;","float dy0 = -1.0 * yPixelOffset;","float dx1 = 1.0 * xPixelOffset;","float dy1 = 1.0 * yPixelOffset;","mat3 shadowKernel;","vec2 delta = vec2(dx0,dy0);","for  (int i = 0; i < 3; i ++) {","for  (int j = 0; j < 3; j ++) {","shadowKernel[i][j]= 0.25 * texture2DCompare(shadowMap,shadowCoord.xy + delta,shadowCoord.z);","delta.y +=dy1;","}","delta.y =dy0;","delta.x +=dx1;","}","vec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * shadowMapSize.xy );","shadowKernel[0] = mix( shadowKernel[1], shadowKernel[0], fractionalCoord.x );","shadowKernel[1] = mix( shadowKernel[2], shadowKernel[1], fractionalCoord.x );","vec4 shadowValues;","shadowValues.x = mix( shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y );","shadowValues.y = mix( shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y );","shadowValues.z = mix( shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y );","shadowValues.w = mix( shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y );","shadow = dot( shadowValues, vec4( 1.0 ) );","return shadow;","}","#elif defined( SHADOWMAP_TYPE_PCF_INTERPOL )","float getExposurePCFInterpol(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize){","float shadow = 0.0;","const float dimFilter = 4.0;","const float sizeFilter = dimFilter * dimFilter;","const float shadowDelta = 1.0 / sizeFilter;","vec2 shadowPixelSize = 1.0 / shadowMapSize;","for (float xFilter = -0.5 * dimFilter + 0.5; xFilter <= 0.5 * dimFilter; xFilter += 1.0) {","for (float yFilter = -0.5 * dimFilter + 0.5; yFilter <= 0.5 * dimFilter; yFilter += 1.0) {","shadow += texture2DShadowLerp(shadowMap, shadowMapSize, shadowPixelSize, shadowCoord.xy + shadowPixelSize * vec2(xFilter, yFilter), shadowCoord.z);","}","}","shadow *= shadowDelta;","return shadow;","}","#elif defined( SHADOWMAP_TYPE_PCF_POISSON )","float getExposurePCFPoisson(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize) {","float shadow = 0.0;","float xPixelOffset = 1.0/ shadowMapSize.x;","float yPixelOffset = 1.0 / shadowMapSize.y;","float randAngle = randomValue(shadowCoord.xyz,fract(shadowCoord.x*shadowCoord.y)) * 2.0 * 3.14159265359;","for  (int i = 0; i < poissonCount; i ++) {","vec2 p = poissonDisk[i];","float posX = (cos(randAngle)*p.x-sin(randAngle)*p.y)*xPixelOffset;","float posY = (sin(randAngle)*p.x+cos(randAngle)*p.y)*yPixelOffset;","shadow += texture2DCompare(shadowMap,shadowCoord.xy + vec2(posX,posY),shadowCoord.z);","}","shadow *= poissonInvSamples;","return shadow;","}","#elif defined( SHADOWMAP_TYPE_PCF_OPTI )","float getExposurePCFOpti(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize) {","float shadow = 0.0;","vec2 fractCoord = fract(shadowCoord.xy * shadowMapSize + 0.5);","vec2 pixelOffset = vec2(1.0) / shadowMapSize;","vec2 base_uv = (shadowCoord.xy * shadowMapSize - fractCoord) * pixelOffset;","#if defined(SHADOWMAP_QUALITY_LOW)","float uw0 = (3.0 - 2.0 * fractCoord.x);","float uw1 = (1.0 + 2.0 * fractCoord.x);","float u0 = ((2.0 - fractCoord.x) / uw0 - 1.0) * pixelOffset.x;","float u1 = (fractCoord.x / uw1 + 1.0) * pixelOffset.x;","float vw0 = (3.0 - 2.0 * fractCoord.y);","float vw1 = (1.0 + 2.0 * fractCoord.y);","float v0 = ((2.0 - fractCoord.y) / vw0 - 1.0) * pixelOffset.y;","float v1 = (fractCoord.y / vw1 + 1.0) * pixelOffset.y;","shadow += uw0 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v0), shadowCoord.z);","shadow += uw1 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v0), shadowCoord.z);","shadow += uw0 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v1), shadowCoord.z);","shadow += uw1 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v1), shadowCoord.z);","shadow *= 0.0625;","#elif defined(SHADOWMAP_QUALITY_MEDIUM)","float uw0 = (4.0 - 3.0 * fractCoord.x);","float uw1 = 7.0;","float uw2 = (1.0 + 3.0 * fractCoord.x);","float u0 = ((3.0 - 2.0 * fractCoord.x) / uw0 - 2.0) * pixelOffset.x;","float u1 = ((3.0 + fractCoord.x) / uw1) * pixelOffset.x;","float u2 = (fractCoord.x / uw2 + 2.0) * pixelOffset.x;","float vw0 = (4.0 - 3.0 * fractCoord.y);","float vw1 = 7.0;","float vw2 = (1.0 + 3.0 * fractCoord.y);","float v0 = ((3.0 - 2.0 * fractCoord.y) / vw0 - 2.0) * pixelOffset.y;","float v1 = ((3.0 + fractCoord.y) / vw1) * pixelOffset.y;","float v2 = (fractCoord.y / vw2 + 2.0) * pixelOffset.y;","shadow += uw0 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v0), shadowCoord.z);","shadow += uw1 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v0), shadowCoord.z);","shadow += uw2 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v0), shadowCoord.z);","shadow += uw0 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v1), shadowCoord.z);","shadow += uw1 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v1), shadowCoord.z);","shadow += uw2 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v1), shadowCoord.z);","shadow += uw0 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v2), shadowCoord.z);","shadow += uw1 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v2), shadowCoord.z);","shadow += uw2 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v2), shadowCoord.z);","shadow *= 0.0069444;","#elif defined(SHADOWMAP_QUALITY_HIGH)","float uw0 = (5.0 * fractCoord.x - 6.0);","float uw1 = (11.0 * fractCoord.x - 28.0);","float uw2 = -(11.0 * fractCoord.x + 17.0);","float uw3 = -(5.0 * fractCoord.x + 1.0);","float u0 = ((4.0 * fractCoord.x - 5.0) / uw0 - 3.0) * pixelOffset.x;","float u1 = ((4.0 * fractCoord.x - 16.0) / uw1 - 1.0) * pixelOffset.x;","float u2 = (-(7.0 * fractCoord.x + 5.0) / uw2 + 1.0) * pixelOffset.x;","float u3 = (-fractCoord.x / uw3 + 3.0) * pixelOffset.x;","float vw0 = (5.0 *fractCoord.y - 6.0);","float vw1 = (11.0 *fractCoord.y - 28.0);","float vw2 = -(11.0 *fractCoord.y + 17.0);","float vw3 = -(5.0 *fractCoord.y + 1.0);","float v0 = ((4.0 *fractCoord.y - 5.0) / vw0 - 3.0) * pixelOffset.y;","float v1 = ((4.0 *fractCoord.y - 16.0) / vw1 - 1.0) * pixelOffset.y;","float v2 = (-(7.0 *fractCoord.y + 5.0) / vw2 + 1.0) * pixelOffset.y;","float v3 = (-fractCoord.y / vw3 + 3.0) * pixelOffset.y;","shadow += uw0 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v0), shadowCoord.z) ;","shadow += uw1 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v0), shadowCoord.z);","shadow += uw2 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v0), shadowCoord.z);","shadow += uw3 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u3,v0), shadowCoord.z);","shadow += uw0 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v1), shadowCoord.z);","shadow += uw1 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v1), shadowCoord.z);","shadow += uw2 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v1), shadowCoord.z);","shadow += uw3 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u3,v1), shadowCoord.z);","shadow += uw0 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v2), shadowCoord.z);","shadow += uw1 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v2), shadowCoord.z);","shadow += uw2 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v2), shadowCoord.z);","shadow += uw3 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u3,v2), shadowCoord.z);","shadow += uw0 * vw3 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v3), shadowCoord.z);","shadow += uw1 * vw3 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v3), shadowCoord.z);","shadow += uw2 * vw3 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v3), shadowCoord.z);","shadow += uw3 * vw3 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u3,v3), shadowCoord.z);","shadow *= 0.0003698225;","#endif","return shadow;","}","#elif defined( SHADOWMAP_TYPE_ESM )","float getExposureESM(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize) {","float shadow = 0.0;","float depthFragOffset = shadowCoord.z;","shadow = compESM(shadowMap, shadowCoord.xy, depthFragOffset);","float zMaxNeighbor = 0.0;","vec2 pixelOffset = 1.0 / shadowMapSize.xy;","vec2 coordDetect = shadowCoord.xy + vec2(-pixelOffset.x, pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","coordDetect = shadowCoord.xy + vec2(pixelOffset.x, pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","coordDetect = shadowCoord.xy + vec2(-pixelOffset.x, -pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","coordDetect = shadowCoord.xy + vec2(pixelOffset.x, -pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","coordDetect = shadowCoord.xy + vec2(pixelOffset.x, 0.0);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","coordDetect = shadowCoord.xy + vec2(0.0, pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","coordDetect = shadowCoord.xy + vec2(-pixelOffset.x, 0.0);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","coordDetect = shadowCoord.xy + vec2(0.0, -pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, texture2D(shadowMap, coordDetect).x);","zMaxNeighbor = log(zMaxNeighbor) * 0.0125;","if(zMaxNeighbor < 0.9999999 && (shadowCoord.z + 0.015) < zMaxNeighbor) {","shadow = 0.0;","vec2 fractCoord = fract(shadowCoord.xy * shadowMapSize + 0.5);","vec2 base_uv = (shadowCoord.xy * shadowMapSize - fractCoord) * pixelOffset;","float uw0 = (4.0 - 3.0 * fractCoord.x);","float uw1 = 7.0;","float uw2 = (1.0 + 3.0 * fractCoord.x);","float u0 = ((3.0 - 2.0 * fractCoord.x) / uw0 - 2.0) * pixelOffset.x;","float u1 = ((3.0 + fractCoord.x) / uw1) * pixelOffset.x;","float u2 = (fractCoord.x / uw2 + 2.0) * pixelOffset.x;","float vw0 = (4.0 - 3.0 * fractCoord.y);","float vw1 = 7.0;","float vw2 = (1.0 + 3.0 * fractCoord.y);","float v0 = ((3.0 - 2.0 * fractCoord.y) / vw0 - 2.0) * pixelOffset.y;","float v1 = ((3.0 + fractCoord.y) / vw1) * pixelOffset.y;","float v2 = (fractCoord.y / vw2 + 2.0) * pixelOffset.y;","shadow += uw0 * vw0 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0, v0), depthFragOffset);","shadow += uw1 * vw0 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1, v0), depthFragOffset);","shadow += uw2 * vw0 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2, v0), depthFragOffset);","shadow += uw0 * vw1 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0, v1), depthFragOffset);","shadow += uw1 * vw1 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1, v1), depthFragOffset);","shadow += uw2 * vw1 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2, v1), depthFragOffset);","shadow += uw0 * vw2 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0, v2), depthFragOffset);","shadow += uw1 * vw2 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1, v2), depthFragOffset);","shadow += uw2 * vw2 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2, v2), depthFragOffset);","shadow *= 0.0069444;","shadow = clamp(shadow * 2.0, 0.0, 1.0);","} else {","shadow *= shadow * shadow;","shadow = 1.0 - clamp(shadow, 0.0, 1.0);","}","return shadow;","}","#elif defined( SHADOWMAP_TYPE_ESM_IMPROVED )","float getExposureESMImproved(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize) {","float shadow = 0.0;","float depthFragOffset = shadowCoord.z;","vec2 uv = shadowCoord.xy * shadowMapSize;","vec2 pixelOffset = 1.0 / shadowMapSize.xy;","vec2 base_uv = floor(uv + 0.5);","vec2 fractCoord = uv + 0.5 - base_uv;","base_uv = (base_uv - 0.5) * pixelOffset;","float uw0 = (3.0 - 2.0 * fractCoord.x);","float uw1 = (1.0 + 2.0 * fractCoord.x);","float u0 = ((2.0 - fractCoord.x) / uw0 - 1.0) * pixelOffset.x;","float u1 = (fractCoord.x / uw1 + 1.0 ) * pixelOffset.x;","float vw0 = (3.0 - 2.0 * fractCoord.y);","float vw1 = (1.0 + 2.0 * fractCoord.y);","float v0 = ((2.0 - fractCoord.y) / vw0 - 1.0) * pixelOffset.y;","float v1 = (fractCoord.y / vw1 + 1.0) * pixelOffset.y;","shadow += uw0 * vw0 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0, v0), depthFragOffset);","shadow += uw1 * vw0 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1, v0), depthFragOffset);","shadow += uw0 * vw1 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0, v1), depthFragOffset);","shadow += uw1 * vw1 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1, v1), depthFragOffset);","shadow *= 0.0625;","shadow = clamp(shadow * 1.5, 0.0, 1.0);","return shadow;","}","#endif","float getExposure(vec4 vShadowCoord,sampler2D shadowMap,float shadowBias,vec2 shadowMapSize) {","vec3 shadowCoord = vShadowCoord.xyz / vShadowCoord.w;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );","float exposureResult = 0.0;","bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","bool frustumTest = all( frustumTestVec );","if ( frustumTest ) {","shadowCoord.z += shadowBias;","#if defined( SHADOWMAP_TYPE_PCF )","exposureResult = getExposurePCF(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","exposureResult = getExposurePCFSoft(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_PCF_INTERPOL )","exposureResult = getExposurePCFInterpol(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_PCF_POISSON )","exposureResult = getExposurePCFPoisson(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_PCF_OPTI )","exposureResult = getExposurePCFOpti(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_ESM )","exposureResult = getExposureESM(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_ESM_IMPROVED )","exposureResult = getExposureESMImproved(shadowMap,shadowCoord,shadowMapSize);","#else","exposureResult = texture2DCompare(shadowMap,shadowCoord.xy,shadowCoord.z);","#endif","}","return max(1.0-exposureResult,0.0);","}","#ifdef SHADOWMAP_CASCADE","float getExposureCascaded(vec4 vShadowCoord[MAX_SHADOWS_DIR+MAX_SHADOWS_SPOT],sampler2D shadowMap[MAX_SHADOWS_DIR+MAX_SHADOWS_SPOT],float shadowBias[MAX_SHADOWS_DIR+MAX_SHADOWS_SPOT],vec2 shadowMapSize[MAX_SHADOWS_DIR+MAX_SHADOWS_SPOT]) {","float exposure = 1.0;","int inFrustumCount = 0;","#ifdef SHADOWMAP_DEBUG","vec3 frustumColors[3];","frustumColors[0] = vec3( 1.0, 0.5, 0.0 );","frustumColors[1] = vec3( 0.0, 1.0, 0.8 );","frustumColors[2] = vec3( 0.0, 0.5, 1.0 );","#endif","for( int i = 0; i < MAX_SHADOWS_DIR; i ++ ) {","vec3 shadowCoord = vShadowCoord[i].xyz / vShadowCoord[i].w;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );","bvec2 inFrustumAndZVec = bvec2(inFrustum, shadowCoord.z <= 1.0);","bool inFrustumAndZ = all(inFrustumAndZVec);","inFrustumCount += int( inFrustumAndZ );","bvec2 frustumTestVec = bvec2( inFrustumAndZ, inFrustumCount == 1 );","bool frustumTest = all( frustumTestVec );","if ( frustumTest ) {","exposure = getExposure(vShadowCoord[i],shadowMap[i],shadowBias[i],shadowMapSize[i]);","#ifdef SHADOWMAP_DEBUG","#ifdef SHADOWMAP_CASCADE","if ( frustumTest ) gl_FragColor.xyz *= frustumColors[ i ];","#else","if ( inFrustum ) gl_FragColor.xyz *= frustumColors[ i ];","#endif","#endif","}","}","return exposure;","}","#endif","#endif","#ifdef USE_SHADOWMAP_CUBE","uniform samplerCube shadowMapCube[ MAX_SHADOWS_CUBE ];","uniform float shadowDarknessCube[ MAX_SHADOWS_CUBE ];","uniform float shadowBiasCube[ MAX_SHADOWS_CUBE ];","uniform float shadowNearCube[ MAX_SHADOWS_CUBE ];","uniform float shadowFarCube[ MAX_SHADOWS_CUBE ];","uniform float shadowMapSizeCube[ MAX_SHADOWS_CUBE ];","uniform vec3 shadowPointPosition[ MAX_SHADOWS_CUBE ];","float textureCubeCompare(samplerCube shadowMap, vec3 coord, float depthFrag) {","float depthShadowMap = unpackDepth(textureCube(shadowMap, coord));","return step(depthShadowMap, depthFrag);","}","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","float compESMCube(samplerCube shadowMap, vec3 coord, float depthFrag) {","float result = textureCube(shadowMap, coord).x * exp(-80.0 * depthFrag);","result *= result * result * result * result;","result = clamp(result,0.0,1.0);","return 1.0-result;","}","#endif","#if defined (SHADOWMAP_TYPE_PCF_OPTI) || defined (SHADOWMAP_TYPE_PCF_POISSON) || defined (SHADOWMAP_TYPE_PCF)","float getExposureCubePCF(vec3 normPointVector,float shadowMapSize,samplerCube shadowMapCube,float depth) {","vec3 rndseed = vec3(12.9898,78.233,45.5432);","vec3 randomDir = vec3( dot(normPointVector,rndseed) , dot(normPointVector.yzx,rndseed) , dot(normPointVector.zxy,rndseed) );","randomDir = fract(sin(randomDir) * 43758.5453);","float pixelSize = 2.0 / shadowMapSize;","vec3 xvec = normalize(cross(normPointVector,randomDir))* pixelSize *1.1;","vec3 yvec = normalize(cross(normPointVector,xvec))* pixelSize *1.1;","float inShadow = 0.0;","inShadow += textureCubeCompare(shadowMapCube,normPointVector+xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+xvec-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-xvec-yvec,depth);","#if defined(SHADOWMAP_QUALITY_HIGH) || defined(SHADOWMAP_QUALITY_MEDIUM)","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*xvec-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*xvec-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*yvec+xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*yvec-xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*yvec+xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*yvec-xvec,depth);","#endif","#if defined(SHADOWMAP_QUALITY_HIGH)","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*xvec-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*xvec-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*yvec+xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*yvec-xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*yvec+xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*yvec-xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*xvec+2.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*xvec-2.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*xvec-2.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*xvec+2.0*yvec,depth);","#endif","#if defined(SHADOWMAP_QUALITY_LOW)","inShadow = inShadow/ 8.0;","#elif defined(SHADOWMAP_QUALITY_MEDIUM)","inShadow = inShadow/ 20.0;","#else","inShadow = inShadow/ 36.0;","#endif","return inShadow;","}","#endif","float getExposure(vec3 pointPosition,samplerCube shadowMap,float shadowBias,float shadowMapSize,float shadowNear, float shadowFar) {","vec4 lPosition =  vec4( pointPosition, 1.0 );","vec3 pointVector = vWorldPosition.xyz-lPosition.xyz;","float exposureResult = 0.0;","vec3 absVector = abs(pointVector);","float localZComp = max(absVector.x,max(absVector.y,absVector.z));","float normZComp = (shadowFar+shadowNear)/(shadowFar-shadowNear)-(2.0*shadowFar*shadowNear)/(shadowFar-shadowNear)/localZComp;","normZComp = (normZComp + 1.0) * 0.5;","float depthCube = normZComp +shadowBias;","vec3 normPointVector = normalize( pointVector );","#if defined (SHADOWMAP_TYPE_PCF_OPTI) || defined (SHADOWMAP_TYPE_PCF_POISSON) || defined (SHADOWMAP_TYPE_PCF)","exposureResult = getExposureCubePCF(normPointVector,shadowMapSize,shadowMap,depthCube);","#elif defined (SHADOWMAP_TYPE_ESM)","exposureResult = compESMCube(shadowMap, normPointVector, depthCube);","exposureResult = clamp (shadow,0.0,1.0);","#else","exposureResult = textureCubeCompare(shadowMap,normPointVector,depthCube);","#endif","return 1.0-exposureResult;","}","#endif",].join("\n"),shadowmap_fragment:["float shadowExposure = 1.0;","#if defined(USE_SHADOWMAP) || defined(USE_SHADOWMAP_CUBE)","#ifdef USE_SHADOWMAP","float currentExposure = 1.0;","#ifdef SHADOWMAP_CASCADE","currentExposure  = getExposureCascaded(vShadowCoord,shadowMap,shadowBias,shadowMapSize);","#else","currentExposure = getExposure(vShadowCoord[ 0 ],shadowMap[ 0 ],shadowBias[ 0 ],shadowMapSize[ 0 ]);","#endif","if (currentExposure < 1.0) {","shadowExposure *=1.0 - (shadowDarkness[ 0 ] * (1.0-currentExposure));","}","#ifdef SHADOWMAP_CASCADE","if (MAX_SHADOWS>MAX_SHADOWS_DIR){","for( int i = MAX_SHADOWS_DIR; i < MAX_SHADOWS; i ++ ) {","float currentExposure = 1.0;","currentExposure = getExposure(vShadowCoord[ i ],shadowMap[ i ],shadowBias[ i ],shadowMapSize[ i ]);","if (currentExposure < 1.0) {","shadowExposure *=1.0 - (shadowDarkness[ i ] * (1.0-currentExposure));","}","}","}","#else","if (MAX_SHADOWS>1){","for( int i = 1; i < MAX_SHADOWS; i ++ ) {","float currentExposure = 1.0;","currentExposure = getExposure(vShadowCoord[ i ],shadowMap[ i ],shadowBias[ i ],shadowMapSize[ i ]);","if (currentExposure < 1.0) {","shadowExposure *=1.0 - (shadowDarkness[ i ] * (1.0-currentExposure));","}","}","}","#endif","#endif","#ifdef USE_SHADOWMAP_CUBE","for ( int i = 0; i < MAX_SHADOWS_CUBE; i ++ ) {","float currentExposure = getExposure(shadowPointPosition[ i ],shadowMapCube[ i ],shadowBiasCube[ i ],shadowMapSizeCube[ i ],shadowNearCube[ i ],shadowFarCube[ i ]);","if (currentExposure < 1.0) {","shadowExposure *= 1.0 - (shadowDarknessCube[ i ] * (1.0-currentExposure));","}","}","#endif","#endif","gl_FragColor.xyz *= shadowExposure;",].join("\n"),shadowmap_pars_vertex:["#ifdef USE_SHADOWMAP","varying vec4 vShadowCoord[ MAX_SHADOWS ];","uniform mat4 shadowMatrix[ MAX_SHADOWS ];","#endif"].join("\n"),shadowmap_vertex:["#ifdef USE_SHADOWMAP","#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined( PHYSICALDS ) || defined ( USE_SHADOWMAP )","#ifdef USE_SKINNING","vec4 oldPosition = skinned;","#endif","#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 oldPosition = vec4( morphed, 1.0 );","#endif","#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 oldPosition = vec4( position, 1.0 );","#endif","#endif","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[i]*oldPosition;","}","#endif"].join("\n"),alphatest_fragment:["#if defined(ALPHATEST)","if ( gl_FragColor.a < ALPHATEST ) discard;","#endif"].join("\n"),linear_to_gamma_fragment:["#ifdef GAMMA_OUTPUT","gl_FragColor.xyz = sqrt( gl_FragColor.xyz );","#endif"].join("\n"),oit_pars_vertex:["#ifdef ACCUM_SHADER","   varying float depthOITValue;","#endif"].join("\n"),oit_vertex:["#ifdef ACCUM_SHADER",s._DefaultShaderChunk.getModelViewTransformationChunk("vec4 aux","vec4(position.xyz, 1.0)"),"   depthOITValue = aux.z;","   float normalizeValue;","       float m22 = projectionMatrix[2][2];","       float m32 = projectionMatrix[3][2];","       float near = m32 / (m22 - 1.0);","       float far = ((m22 - 1.0)*near)/(m22 + 1.0);","       normalizeValue = far + near;","   depthOITValue /= 0.5*normalizeValue;","#endif"].join("\n"),oit_pars_fragment:["#ifdef ACCUM_SHADER","   varying float depthOITValue;","   float getOITWeight() {","       float distanceTerm = clamp(0.3/ (1e-3 + pow(depthOITValue,4.0)),1e-3,3e3);","       float alphaTerm = gl_FragColor.a ;","       return alphaTerm*distanceTerm;","   }","#endif"].join("\n"),oit_fragment:["#ifdef USE_OIT","   #if defined(ACCUM_SHADER) || defined(REVEAL_SHADER)","       if (gl_FragColor.a > 1.0 - 1e-2) {","           discard;","       }","   #else","       if (gl_FragColor.a < 1.0 - 1e-2){","           discard;","       }","   #endif","   #if defined(ACCUM_SHADER)","       gl_FragColor = vec4(gl_FragColor.rgb, 1.0)* getOITWeight()* gl_FragColor.a;","   #elif defined(REVEAL_SHADER)","       gl_FragColor.r = gl_FragColor.a;","   #endif","#endif"].join("\n"),utils_paint_fct:["float mi_metallic_paint_o(vec3 X0000002,vec3 X0000003,vec3 X0000004,float X0000005)","{","float X0000006 = 0.0;","vec3 X0000007 = X0000002 - X0000003;","float X0000008 = dot(X0000007, X0000004);","X0000008 *= (X0000008 / (dot(X0000007, X0000007)));","if (X0000008 > 0.0)","{","X0000006 = (exp((((log(X0000008)) * 0.5) * X0000005)));","}","return X0000006;","}","float mi_metallic_paint_o1(float X0000009,float X0000010,float X0000011)","{","float X0000012;","float X0000013;","if (X0000011 <= X0000009)","{","X0000013 = 0.0;","}","else","{","if (X0000011 >= X0000010)","{","X0000013 = 1.0;","}","else","{","X0000012 = ((X0000011 - X0000009) / (X0000010 - X0000009));","X0000013 = ((X0000012 * X0000012) * (3.0 - (2.0 * X0000012)));","}","}","return X0000013;","}"].join("\n"),utils_car_paint_fct:["bool Carpaint_mi_bump(vec4 msl_Carpaint_mi_bump_flakes_1_flake_color_param,vec4 msl_Carpaint_mi_bump_flakes_1_result,vec3 msl_Carpaint_mi_bump_flakes_1_normal_result)","{","float X0000006 = 0.0;","vec3 X0000007 = X0000002 - X0000003;","float X0000008 = dot(X0000007, X0000004);","X0000008 *= (X0000008 / (dot(X0000007, X0000007)));","if (X0000008 > 0.0)","{","X0000006 = (exp((((log(X0000008)) * 0.5) * X0000005)));","}","return X0000006;","}","float mi_metallic_paint_o1(float X0000009,float X0000010,float X0000011)","{","float X0000012;","float X0000013;","if (X0000011 <= X0000009)","{","X0000013 = 0.0;","}","else","{","if (X0000011 >= X0000010)","{","X0000013 = 1.0;","}","else","{","X0000012 = ((X0000011 - X0000009) / (X0000010 - X0000009));","X0000013 = ((X0000012 * X0000012) * (3.0 - (2.0 * X0000012)));","}","}","return X0000013;","}"].join("\n"),utils_fct:["float computeFresnel(vec3 Wi, vec3 Wo, float ior)","{","float rs = pow((ior - 1.0)/(ior + 1.0),2.0);","vec3 h = normalize(Wi+Wo);","float c = dot(Wi,h);","float fresnel = clamp(rs + (1.0 - rs)*pow(1.0 - c,5.0),0.0,1.0);","return fresnel;","}","float getLuminosity(vec3 color)","{","return 0.299*color.x + 0.587*color.y + 0.114*color.z;","}"].join("\n"),basic_pars:["varying vec3 vViewPosition;","varying vec3 vNormal;"].join("\n"),paint_fragment:["vec4 result;","float X0000014 = 3.1415926535897932384626433832795;","float X0000015 = irradiance_weight / X0000014;","bool X0000016;","if (flake_weight > 0.0)","{","	X0000016 = true;","}","else","{","	X0000016 = false;","}","vec4 X0000017;","vec3 X0000018;","vec3 X0000019;","vec3 X0000020;","float X0000021;","float X0000022;","float X0000023;","float global_weight_v = global_weight;","float spec_sec_weight_v = spec_sec_weight;","float spec_weight_v = spec_weight;","float diffuse_bias_v = diffuse_bias;","if (global_weight <= 0.0)","{","global_weight_v = 1.0;","}","if (spec_exp <= 0.0)","{","spec_weight_v = 0.0;","}","if (spec_sec_exp <= 0.0)","{","spec_sec_weight_v = 0.0;","}","if (diffuse_bias < 0.0)","{","diffuse_bias_v = 0.0;","}","X0000019 = mPosition.xyz;","X0000020 = mPosition.xyz;","X0000020 -= X0000019;","X0000021 = (((X0000020.x * X0000020.x) + (X0000020.y * X0000020.y)) + (X0000020.z * X0000020.z));","X0000020 = (normalize(X0000020));","if (edge_color_bias > 0.0)","{","X0000022 = (abs((dot((normal), (viewPosition)))));","X0000022 = (pow(X0000022, edge_color_bias));","X0000023 = (1.0 - X0000022);","X0000017 = ((base_color * X0000022) + (edge_color * X0000023));","}","result = (ambient * X0000017);"].join("\n"),car_paint_fragment:["vec4 result = vec4(0.0,0.0,0.0,0.0);","vec3 msl_local_flake_normal = vec3(0.0,0.0,0.0);","vec4 msl_local_flake_color = vec4(0.0,0.0,0.0,0.0);","float X0000014 = 3.1415926535897932384626433832795;","float X0000015 = irradiance_weight / X0000014;","bool X0000016;","if (flake_weight > 0.0)","{","	X0000016 = true;","}","else","{","	X0000016 = false;","}","vec4 X0000017;","vec3 X0000018;","vec3 X0000019;","vec3 X0000020;","float X0000021;","float X0000022;","float X0000023;","float global_weight_v = global_weight;","float spec_sec_weight_v = spec_sec_weight;","float spec_weight_v = spec_weight;","float diffuse_bias_v = diffuse_bias;","if (global_weight <= 0.0)","{","global_weight_v = 1.0;","}","if (spec_exp <= 0.0)","{","spec_weight_v = 0.0;","}","if (spec_sec_exp <= 0.0)","{","spec_sec_weight_v = 0.0;","}","if (diffuse_bias < 0.0)","{","diffuse_bias_v = 0.0;","}","X0000019 = mPosition.xyz;","X0000020 = mPosition.xyz;","X0000020 -= X0000019;","X0000021 = (((X0000020.x * X0000020.x) + (X0000020.y * X0000020.y)) + (X0000020.z * X0000020.z));","X0000020 = (normalize(X0000020));","if (edge_color_bias > 0.0)","{","X0000022 = (abs((dot((normal), (viewPosition)))));","X0000022 = (pow(X0000022, edge_color_bias));","X0000023 = (1.0 - X0000022);","X0000017 = ((base_color * X0000022) + (edge_color * X0000023));","}","result = (ambient * X0000017);"].join("\n"),tangent_Binormal_pars:["#if defined(USE_TANGENT) || defined(USE_TANGENT_BINORMAL)","varying vec3 vTangent;","#ifdef USE_TANGENT_BINORMAL","varying vec3 vBinormal;","#endif","#endif",].join("\n"),basic_vertex:[s._DefaultShaderChunk.model_view_transformation_vertex,s._DefaultShaderChunk.model_view_normal_vertex,"vNormal = mvNormal;","vViewPosition = normalize(-mvPosition.xyz);","gl_Position = projectionMatrix * mvPosition;"].join("\n"),tangent_Binormal_vertex:["#if defined(USE_TANGENT) || defined(USE_TANGENT_BINORMAL)","#ifdef USE_SKINNING","vec3 objectTangent = vec3(skinMatrix * vec4( tangent, 0.0 ));","#else","vec3 objectTangent = tangent;","#endif","vec3 mvTangent;","if (use_normal_matrix)","mvTangent = normalMatrix * objectTangent;","else {",s._DefaultShaderChunk.getModelViewUnitVectorTransformationChunk("mvTangent","objectTangent"),"}","vTangent = normalize( mvTangent );","#ifdef PDSFX","_viewTangentSpace.Tangent = vTangent;","#endif","#ifdef USE_TANGENT_BINORMAL","#ifdef USE_SKINNING","vec3 objectBinormal = vec3(skinMatrix * vec4( binormal, 0.0 ));","#else","vec3 objectBinormal = binormal;","#endif","vec3 mvBinormal;","if (use_normal_matrix)","mvBinormal = normalMatrix * objectBinormal;","else {",s._DefaultShaderChunk.getModelViewUnitVectorTransformationChunk("mvBinormal","objectBinormal"),"}","vBinormal = normalize( mvBinormal );","#ifdef PDSFX","_viewTangentSpace.Binormal = vTangent;","#endif","#endif","#endif",].join("\n"),mpm_pars:["varying vec3 objectPosition;","varying vec3 objectNormal;","varying vec4 screenPosition;","varying vec2 uv_2;","varying vec3 worldPosition;","varying vec3 worldNormal;","varying vec3 worldTangent;","varying vec3 worldBinormal;","varying vec3 vViewPosition;","varying vec3 vNormal;"].join("\n"),mpm_vertex:["objectPosition = position;","objectNormal = normal;","uv_2 = uv;","vec4 worldPos = modelMatrix * vec4( position, 1.0 );","worldPosition = worldPos.xyz;","worldNormal = normalize(mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * normal);","worldTangent = normalize(mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * tangent);","worldBinormal = normalize(mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * binormal);",s._DefaultShaderChunk.getModelViewTransformationChunk("screenPosition","vec4(position.xyz, 1.0)"),s._DefaultShaderChunk.model_view_transformation_vertex,s._DefaultShaderChunk.model_view_normal_vertex,"vViewPosition = normalize(-mvPosition.xyz);","gl_Position = projectionMatrix * mvPosition;"].join("\n"),mpm_fragment:["const vec3 BASIC_3DS_AXIS_X = vec3( 1.0, 0.0, 0.0 );","const vec3 BASIC_3DS_AXIS_Y = vec3( 0.0, 1.0, 0.0 );","const vec3 BASIC_3DS_AXIS_Z = vec3( 0.0, 0.0, 1.0 );","surface_t surface;","surface.local_position = objectPosition;","surface.position       = worldPosition;","surface.uv             = uv_2;","surface.local_normal     = normalize( objectNormal );","surface.normal     = worldNormal;","surface.normal *= sign( dot( worldNormal, cameraPosition - worldPosition ));","surface.tangent        = normalize( worldTangent );","surface.binormal       = normalize( worldBinormal );","surface.basis[0]       = BASIC_3DS_AXIS_X;","surface.basis[1]       = BASIC_3DS_AXIS_Y;","surface.basis[2]       = BASIC_3DS_AXIS_Z;","camera_t camera;","camera.position   = cameraPosition.xyz;","camera.direction  = normalize( camera.position - surface.position );","mapping_t mapping = compute_information(","mapping_type,","vec2( mapping_scale_u , mapping_scale_v),","vec2( mapping_ratio_u , mapping_ratio_v),","vec2( mapping_offset_u , mapping_offset_v),","vec2( mapping_repeat_u , mapping_repeat_v),","vec2( mapping_flip_u , mapping_flip_v),","mapping_rotation_z,","compute_3dtransformation( ","mapping_world_to_object_position_1st_column,","mapping_world_to_object_position_2nd_column,","mapping_world_to_object_position_3rd_column,","mapping_world_to_object_position_4th_column","),","mapping_world_inverse",");","compute_mapping( mapping, surface );","float displacement = compute_value_greyscale_uniform( surface, default_sp_displacement );","surface.uv -= displacement * compute_parallax( camera, default_slot_height, default_sp_height, Height2D, surface );","float bump         = compute_value_greyscale_uniform( surface, default_sp_bump );","vec2  gradient     = bump * ( compute_value_color( default_slot_normal, surface, default_sp_normal, Normal2D ).xy - vec2( 0.5 ) );","		volume_t volume;","		volume.ior                     = compute_value_greyscale_uniform( surface, default_vp_ior );","		volume.abbe_number             = compute_value_greyscale_uniform( surface, default_vp_abbe_number );","		volume.transparency.color      = compute_value_color_uniform( surface, default_vp_color );","		volume.transparency.absorption = compute_value_greyscale_uniform( surface, default_vp_absorption );","		layer_t layer;","		layer.diffuse.weight           = compute_value_greyscale_uniform( surface, default_generic_brdf_diffuse_weight );","		layer.diffuse.color            = compute_value_color( default_slot_diffuse_color, surface, default_generic_brdf_diffuse_color, Diffuse2D );","		layer.diffuse.glossiness       = compute_value_greyscale_uniform( surface, default_generic_brdf_diffuse_glossiness );","		layer.specular.weight          = compute_value_greyscale_uniform( surface, default_generic_brdf_specular_weight );","		layer.specular.color           = compute_value_color( default_slot_specular_color, surface, default_generic_brdf_specular_color, Specular2D );","		layer.specular.glossiness      = compute_value_greyscale( default_slot_specular_glossiness, surface, default_generic_brdf_specular_glossiness, SpecularGlossiness2D );","		layer.transparency.weight      = compute_value_greyscale( default_slot_transparency, surface, default_generic_btdf_transparency_weight, Transparency2D );","		layer.transparency.color       = layer.diffuse.color;","		layer.transparency.glossiness  = compute_value_greyscale( default_slot_clarity, surface, default_generic_btdf_transparency_glossiness, Clarity2D );","		surface.ambient_occlusion      = compute_value_greyscale( default_slot_ambient_occlusion, surface, default_sp_ambient_occlusion, AmbientOcclusion2D );","		surface.opacity                = compute_value_greyscale( default_slot_opacity          , surface, default_sp_opacity          , Opacity2D );","		surface.normal                 = normalize( surface.normal + gradient.x * surface.tangent + gradient.y * surface.binormal ); /// @NOTE Last to not interfere with texture fetch","		layer.anisotropy               = mix( 0.0, 100.0, compute_value_greyscale_uniform( surface, default_generic_brdf_specular_anisotropy ) );","		float anisotropy_rotation      = PIx2 * compute_value_greyscale( default_slot_specular_anisotropy_direction, surface, default_generic_brdf_specular_anisotropy_rotation, SpecularAnisotropyDirection2D );","		surface.tangent                = cos( anisotropy_rotation ) * surface.tangent + sin( anisotropy_rotation ) * surface.binormal;","		surface.binormal               = cross( surface.normal, surface.tangent );","		camera.reflected               = reflect( - camera.direction, surface.normal );","		float ior                      = compute_value_greyscale_uniform( surface, default_generic_brdf_ior );","		layer.fresnel                  = fresnel( camera.direction, camera.reflected, ior ) * luminosity( layer.specular.weight * layer.specular.color ); /// @NOTE fresnel is computed without taking into accout light or environment illumination","		//contribution_t contribution_environment = environment.compute( camera, surface, layer );","		vec3 normal_openGL    = vec3( surface.normal.x, surface.normal.z, surface.normal.y );","		vec3 reflected_openGL = vec3( camera.reflected.x, camera.reflected.z, camera.reflected.y );","		const float deriv_weight     = 0.5;","		const float glossiness_scale = 100.0;","		const float dd_limit         = 0.002;","		float  glossiness = mix( glossiness_scale, 0.0, pow( layer.specular.glossiness, 2.0 ) );","		vec3 derivative_x        = deriv_weight * dFdx( reflected_openGL );","		vec3 derivative_y        = deriv_weight * dFdy( reflected_openGL );","		vec3 glossiness_mipmap_x = glossiness * clamp( dFdx( normal_openGL ), -vec3( dd_limit ), vec3( dd_limit ) );","		vec3 glossiness_mipmap_y = glossiness * clamp( dFdy( normal_openGL ), -vec3( dd_limit ), vec3( dd_limit ) );","		vec4 contribution_environment_specular = textureCube( IBLSpecular, reflected_openGL, length(glossiness_mipmap_x + derivative_x + glossiness_mipmap_y + derivative_y ));","		if( layer.anisotropy > 0.0 )","		{","			float deriv_anisotropy = min( 0.025 * ( 1.0 - layer.specular.glossiness ) * layer.anisotropy, 0.2 );","			contribution_environment_specular *= 2.0;","			contribution_environment_specular += textureCube( IBLSpecular, normalize( reflected_openGL + deriv_anisotropy * surface.tangent ), length(glossiness_mipmap_x + derivative_x + glossiness_mipmap_y + derivative_y ));","			contribution_environment_specular += textureCube( IBLSpecular, normalize( reflected_openGL - deriv_anisotropy * surface.tangent ), length(glossiness_mipmap_x + derivative_x + glossiness_mipmap_y + derivative_y ));","			contribution_environment_specular *= 0.25;","		}","		vec4 contribution_environment_diffuse = textureCube( IBLDiffuse, normal_openGL );","		contribution_environment.ambient  = contribution_environment.ambient;","		contribution_environment.diffuse  = ( average( contribution_environment_diffuse  ) > 0.0 ? contribution_environment_diffuse  : vec4( 1.0 ) ) * contribution_environment.diffuse;","		contribution_environment.specular = ( average( contribution_environment_specular ) > 0.0 ? contribution_environment_specular : vec4( 1.0 ) ) * contribution_environment.specular;","		float contribution = 1.0;","		float contribution_diffuse;","		float contribution_specular;","		light_t light;","		light.specular = vec4(1.0);","		light.ambient = vec4(0.0);","		contribution_t contribution_light;","		vec4 GlobalAmbientColor = vec4(0.1);","		contribution_light.ambient += GlobalAmbientColor;","		for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","			light.direction = directionalLightDirection[ i ];","			light.diffuse = vec4(directionalLightColor[ i ], 1.0);","			compute_diffuse( camera, surface, light, layer, contribution_diffuse );","			compute_specular( camera, surface, light, layer, contribution_specular );","			contribution_light.ambient  += contribution * light.ambient;","			contribution_light.diffuse  += contribution * light.diffuse * contribution_diffuse;","			contribution_light.specular += contribution * light.specular * contribution_specular;","		}","		illumination_t edf;","		edf.weight         = compute_value_greyscale_uniform( surface, default_generic_edf_diffuse_weight );","		edf.color          = compute_value_color( default_slot_emissive_color, surface, default_generic_edf_diffuse_color, Emissive2D );","		edf.glossiness     = float( 0.0 ); //unsupported","		float  contribution_emission;","		compute_edf( camera, surface, edf, contribution_emission );","		vec4  layer_emission      = contribution_emission * edf.color * clamp( edf.weight, 0.0, 1.0 );","		vec4  layer_reflection    = blend( thin_walled, surface, volume, layer, contribution_light, contribution_environment );","		float opaqueness          = opacity( surface, layer, volume );","		vec4 result = vec4( vec3( layer_emission + layer_reflection ), opaqueness );",].join("\n"),basic_fragment:["float Pi = 3.14159265358979323846264;","vec3 normal = normalize( vNormal );","vec3 viewPosition = normalize( vViewPosition );","normal *= sign( dot( normal, -viewPosition ) );"].join("\n"),tangent_Binormal_fragment:["#if defined(USE_TANGENT) || defined(USE_TANGENT_BINORMAL)","#ifdef PDSFX","vec3 tangent = normalize( _DSviewTangent );","#else","vec3 tangent = normalize( vTangent );","#endif","#ifdef USE_TANGENT_BINORMAL","#ifdef PDSFX","vec3 binormal = normalize( _DSviewBinormal );","#else","vec3 binormal = normalize( vBinormal );","#endif","#else","#ifdef PDSFX","vec3 binormal = cross(_DSvNormal,tangent);","#else","vec3 binormal = cross(normalize(vNormal),tangent);","#endif","#endif","#elif defined (USE_NORMALMAP) || defined(USE_ANISOTROPY) || defined(CLEAR_COAT_BUMPMAP)","vec3 q0 = dFdx( -vViewPosition.xyz );","vec3 q1 = dFdy( -vViewPosition.xyz );","#if defined( NEEDS_UVTOUSE )","vec2 st0 = dFdx( uvToUse/*vUv*/.st );","vec2 st1 = dFdy( uvToUse/*vUv*/.st );","#else","vec2 st0 = vec2(0.0);","vec2 st1 = vec2(0.0);","#endif","float alphaT = step(0.00001, abs(st0.y) + abs(st1.y));","float alphaB = step(0.00001, abs(st0.x) + abs(st1.x));","float alphaBT = 1.0 - max(alphaB, alphaT);","st0.y = alphaT * st0.y - (1.0 - alphaT)*(alphaB * st1.x);","st1.y = alphaT * st1.y + (1.0 - alphaT)*(alphaB * st0.x) + alphaBT;","st0.x = alphaB * st0.x - (1.0 - alphaB)*(alphaT * st1.y) + alphaBT;","st1.x = alphaB * st1.x + (1.0 - alphaB)*(alphaT * st0.y);","vec3 tangent = normalize(  q0 * st1.t - q1 * st0.t );","vec3 binormal = normalize( -q0 * st1.s + q1 * st0.s );","vec3 x = cross(vNormal,tangent);","tangent = normalize(cross(x,vNormal));","x = cross(binormal,vNormal);","binormal = normalize(cross(vNormal,x));","#endif",].join("\n"),illumination_lights_paint_fragment:["vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 direction_fragment_to_light = normalize(- lDirection.xyz );","float dot_nl = dot(direction_fragment_to_light, normal);","vec4 X0000030 = vec4(directionalLightColor[i],1.0) / 3.14159265358979323846;","X0000025 = (vec4(0.0, 0.0, 0.0, 1.0));","if (dot_nl < 0.0)","{","X0000027 = 0.0;","}","else","{","X0000027 = dot_nl;","}","X0000029 = ((pow(X0000027, diffuse_bias_v)) * diffuse_weight);","if (lit_color_bias > 0.0)","{","X0000022 = (pow(X0000027, lit_color_bias));","X0000022 *= (abs((dot((normal), (viewPosition)))));","X0000023 = (1.0 - X0000022);","X0000028 = ((X0000017 * X0000023) + (lit_color * X0000022));","}","else","{","X0000028 = X0000017;","}","X0000025 += ((X0000029 * X0000028) * X0000030);","X0000022 = (pow(X0000027, 0.5));","X0000026 = direction_fragment_to_light;","if (spec_weight_v > 0.0)","{","X0000029 = mi_metallic_paint_o(direction_fragment_to_light, viewPosition, normal, spec_exp);","if (X0000029 > 0.0)","{","if (spec_glazing)","{","X0000029 = mi_metallic_paint_o1(0.5, 0.8, X0000029);","}","X0000029 *= (spec_weight_v * X0000022);","X0000025 += ((X0000029 * spec) * X0000030);","}","}","if (spec_sec_weight_v > 0.0)","{","X0000029 = ((mi_metallic_paint_o(direction_fragment_to_light, viewPosition, normal, spec_sec_exp) * spec_sec_weight_v) * X0000022);","if (X0000029 > 0.0)","{","X0000025 += ((X0000029 * spec_sec) * X0000030);","}","}","result += X0000025;"].join("\n"),illumination_lights_fragment:["vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 direction_fragment_to_light = normalize(- lDirection.xyz );","vec3  direction_fragment_to_camera = -viewPosition;","vec3  reflected_light              = reflect( normalize(lDirection.xyz), normal );","float angle_normal_light           = 0.5 * dot( normal, direction_fragment_to_light  ) + 0.5;","float diffuse_lobe                 = pow( angle_normal_light, diffuse_power );","float diffuse_lobe_normalization   = ( diffuse_power + Pi ) / ( Pi * ( 4.0 - pow( 2.0, -0.5 * diffuse_power  ) ) ) + 0.64;","float diffuse_contribution         = diffuse_lobe * diffuse_lobe_normalization;"].join("\n"),illumination_specular_fragment:["float angle_reflect_light_camera   = 0.5 * dot( reflected_light     , direction_fragment_to_camera ) + 0.5;","float specular_lobe               = pow( angle_reflect_light_camera, specular_power );","float specular_lobe_normalization = ( specular_power + Pi ) / ( Pi * ( 4.0 - pow( 2.0, -0.5 * specular_power ) ) ) + 0.645;","float specular_contribution       = specular_lobe * specular_lobe_normalization;","dirDiffuse  +=  mix( vec3(0.0), directionalLightColor[i], diffuse_contribution );","dirSpecular +=  mix( vec3(0.0), vec3( 1.0 ), specular_contribution );","dirAmbient  +=  mix( vec3(0.0), vec3( 0.0 ), ambient_contribution );"].join("\n"),illumination_specular_anisotropic_fragment:["float specular_contribution = 0.0;","if(anisotropy == 1.0)","{","float angle_reflect_light_camera   = 0.5 * dot( reflected_light     , direction_fragment_to_camera ) + 0.5;","float specular_lobe               = pow( angle_reflect_light_camera, specular_power );","float specular_lobe_normalization = ( specular_power + Pi ) / ( Pi * ( 4.0 - pow( 2.0, -0.5 * specular_power ) ) ) + 0.645;","specular_contribution       = specular_lobe * specular_lobe_normalization;","}","else","{","#ifdef USE_TANGENT_BINORMAL","vec3 N = normal;","vec3 X = cos(anisotropy_rotation)*tangent + sin(anisotropy_rotation)*binormal;","vec3 Y = cross(N,X);","vec3 L = lDirection.xyz;","vec3 C = viewPosition;","vec3 H = normalize(L+C);","float aX = mix(pow(anisotropy,0.1),1.0,refl_gloss);","float aY = mix(pow(1.0/anisotropy,0.1),1.0,refl_gloss);","specular_contribution = (pow(dot(H,X)/aX,2.0) + pow(dot(H,Y)/aY,2.0))/(1.0+dot(H,N));","specular_contribution = exp(-2.0*specular_power*specular_contribution);","specular_contribution *= (specular_power+Pi)/(Pi*(4.0-pow(2.0,-0.5*specular_power))) + 0.645;","#else","float angle_reflect_light_camera   = 0.5 * dot( reflected_light     , direction_fragment_to_camera ) + 0.5;","float specular_lobe               = pow( angle_reflect_light_camera, specular_power );","float specular_lobe_normalization = ( specular_power + Pi ) / ( Pi * ( 4.0 - pow( 2.0, -0.5 * specular_power ) ) ) + 0.645;","specular_contribution       = specular_lobe * specular_lobe_normalization;","#endif","}","dirDiffuse  +=  mix( vec3(0.0), directionalLightColor[i], diffuse_contribution );","dirSpecular +=  mix( vec3(0.0), vec3( 1.0 ), specular_contribution );","dirAmbient  +=  mix( vec3(0.0), vec3( 0.0 ), ambient_contribution );"].join("\n"),fresnel_fragment:["vec3 ref = reflect(viewPosition, normal);","float fresnel = computeFresnel(-viewPosition, ref, refr_ior);","fresnel = mix( fresnel, 1.0, 0.1 * ( refr_ior - 1.0 ) );"].join("\n"),environment_fragment:["dirAmbient += vec3(0.34);","//compute_reflected","vec3 reflected_DS= vReflect;","const mat3 DS_to_OpenGL = mat3(","	0.0, 1.0, 0.0,","	0.0, 0.0,-1.0,","	1.0, 0.0, 0.0",");","vec3 reflected_OpenGL = reflected_DS * DS_to_OpenGL;","vec4 texture_environment_lookup = textureCube(ReflectionCUBEMap,-reflected_OpenGL);","vec3 environment_lookup          = texture_environment_lookup.rgb;"].join("\n"),environment_blur_fragment:["dirAmbient += vec3(0.34);","//compute_reflected","vec3 reflected_DS= vReflect;","const mat3 DS_to_OpenGL = mat3(","	0.0, 1.0, 0.0,","	0.0, 0.0,-1.0,","	1.0, 0.0, 0.0",");","vec3 reflected_OpenGL = reflected_DS * DS_to_OpenGL;","float ddWeight = mix(0.75,0.0,pow(refl_gloss,2.0));","vec3 reflecteddx = ddWeight*dFdx(reflected_OpenGL);","vec3 reflecteddy = ddWeight*dFdy(reflected_OpenGL);","float anisotropyRefl = 1.0/mix(0.3,1.0,pow(refl_gloss,4.0));","float anisotropydd = length(0.5*(reflecteddx+reflecteddy));","float anisotropyWeight = mix(20.0*anisotropydd,0.0,pow(refl_gloss,5.0));","float bias = anisotropydd * anisotropyRefl;","vec4 texture_environment_lookup = textureCube(ReflectionCUBEMap,-reflected_OpenGL,bias );","#ifdef USE_TANGENT_BINORMAL","if(refl_gloss<1.0) {","texture_environment_lookup  += textureCube( ReflectionCUBEMap, normalize(-reflected_OpenGL-anisotropyWeight*tangent),bias );","texture_environment_lookup  += textureCube( ReflectionCUBEMap, normalize(-reflected_OpenGL+anisotropyWeight*tangent),bias );","texture_environment_lookup  += textureCube( ReflectionCUBEMap, normalize(-reflected_OpenGL-anisotropyWeight*binormal),bias  );","texture_environment_lookup  += textureCube( ReflectionCUBEMap, normalize(-reflected_OpenGL+anisotropyWeight*binormal),bias  );","texture_environment_lookup *= 0.2;","}","#endif","vec3 environment_lookup          = texture_environment_lookup.rgb;"].join("\n"),envMaps_pars:["varying vec3 vReflect;"].join("\n"),envMaps_vertex:["vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vec3 objectNormal = normal;","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","worldNormal = normalize( worldNormal );","vec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );","vReflect = reflect( cameraToVertex, worldNormal );"].join("\n"),struct_mpm:["struct surface_t {","vec2 uv;","mat3 basis;","vec3 local_position;","vec3 local_normal;","vec3 position;","vec3 normal;","vec3 tangent;","vec3 binormal;","float height;","float opacity;","float ambient_occlusion;","};","struct camera_t {","vec3 position;","vec3 direction;","vec3 reflected;","};","struct mapping_t {","int type;","vec2 scale;","vec2 offset;","vec2 flip;","vec2 repeat;","mat2 transformation;","mat4 material_local_transformation;","mat4 material_local_transformation_inv;","};","struct volume_transparency_t","{","vec4           color;","float          absorption;","};","struct volume_translucency_t","{","vec4           scattering;","float          absorption;","};","struct volume_t","{","float                 ior;","float                 abbe_number;","volume_transparency_t transparency;","volume_translucency_t translucency;","};","struct illumination_t","{","float weight;","vec4  color;","float glossiness;","};","struct layer_t","{","float          fresnel;","illumination_t diffuse;","illumination_t specular;","float          anisotropy;","illumination_t transparency;","};","struct contribution_t","{","vec4 diffuse;","vec4 specular;","vec4 ambient;","};","struct light_t","{","vec3 position;","vec3 direction;","vec4 ambient;","vec4 diffuse;","vec4 specular;","};",].join("\n"),mapping_mpm:["#define PLANAR_MAPPING               0","#define SPHERICAL_MAPPING            1","#define FINITE_CYLINDRICAL_MAPPING   2","#define CUBICAL_MAPPING              3","#define AUTO_MAPPING                 4","#define ADAPTIVE_MAPPING             5","#define NO_MAPPING                   6","#define HEMI_SPHERICAL_MAPPING       7","#define INFINITE_CYLINDRICAL_MAPPING 8","mat4 compute_3dtransformation_from_column( const in vec4 first, const in vec4 second, const in vec4 third, const in vec4 fourth)","{","return mat4 ( first[0], second[0], third[0], fourth[0],","				first[1], second[1], third[1], fourth[1],","				first[2], second[2], third[2], fourth[2],","				first[3], second[3], third[3], fourth[3]);","}","mat4 compute_3dtransformation_from_row( const in vec4 first, const in vec4 second, const in vec4 third, const in vec4 fourth)","{","return mat4 ( first [0], first [1], first [2], first [3],","				second[0], second[1], second[2], second[3],","				third [0], third [1], third [2], third [3],","				fourth[0], fourth[1], fourth[2], fourth[3]);","}","#define TRANSFORMATION3D_FROM_ROW_VECTOR    1","#define TRANSFORMATION3D_FROM_COLUMN_VECTOR 2","#define TRANSFORMATION3D_STRATEGY   TRANSFORMATION3D_FROM_ROW_VECTOR","mat4 compute_3dtransformation( const in vec4 first, const in vec4 second, const in vec4 third, const in vec4 fourth)","{","#ifdef TRANSFORMATION3D_STRATEGY","	#if TRANSFORMATION3D_STRATEGY == TRANSFORMATION3D_FROM_COLUMN_VECTOR","		return compute_3dtransformation_from_column( first, second, third, fourth );","	#elif TRANSFORMATION3D_STRATEGY == TRANSFORMATION3D_FROM_ROW_VECTOR","		return compute_3dtransformation_from_row( first, second, third, fourth );","	#endif","#endif","return compute_3dtransformation_from_column( first, second, third, fourth );","}","vec3 compute_object_space_position_transformation( const in mapping_t mapping, const in vec3 position)","{","vec3 transformed = (vec4( position, 1.0 ) * mapping.material_local_transformation).xyz;","return transformed;","}","vec3 compute_vector_transformation( const in mapping_t mapping, const in vec3 vector)","{","mat3 vector_transformation = mat3( mapping.material_local_transformation_inv);","vec3 transformed = vector_transformation * vector;","return transformed;","}","mapping_t compute_information(  const in int type,","const in vec2  scale,","const in vec2  ratio,","const in vec2  offset,","const in vec2  repeat,","const in vec2  flip,","const in float angle,","const in mat4  transformation,","const in mat4  inverse_transformation )","{","float cosinus = cos( angle ), sinus = sin( angle );","mapping_t mapping;","mapping.type           = type;","mapping.scale          = vec2( 1.0 ) / ( scale * ratio );","mapping.offset         = ( -1.0 * offset * mapping.scale ) + vec2( 0.5 );","mapping.repeat         = repeat;","mapping.flip           = mix( vec2( 1.0 ), vec2( -1.0 ), flip );","mapping.transformation = mat2(","	mapping.scale.x * mapping.flip.x * cosinus, mapping.scale.x * mapping.flip.y * -sinus,","	mapping.scale.y * mapping.flip.x * sinus  , mapping.scale.y * mapping.flip.y *  cosinus",");","mapping.material_local_transformation = transformation;","mapping.material_local_transformation_inv = inverse_transformation;","return mapping;","}","void compute_transformation( const in mapping_t mapping, inout surface_t surface )","{","surface.uv  = mapping.transformation * surface.uv ;","surface.uv += mapping.offset;","surface.uv  = mix( clamp( surface.uv, vec2( 0.0 ), vec2( 1.0 ) ), surface.uv, vec2( mapping.repeat ) );","}","void compute_transformation_uv( const in mapping_t mapping, inout surface_t surface )","{","surface.uv  = mix( clamp( surface.uv, vec2( 0.0 ), vec2( 1.0 ) ), surface.uv, vec2( mapping.repeat ) );","}","void compute_mapping_spherical( const in mapping_t mapping, inout surface_t surface )","{","float radius3d      = length( surface.local_position.xyz );","float z_by_radius3d = surface.local_position.z / radius3d;","float rho   = radius3d;","float theta = atan( surface.local_position.y, surface.local_position.x ); //azimuth [-PI/2,+PI/2]","float phi   = asin( z_by_radius3d );                      //polar   [-PI,+PI]","vec3 X = surface.basis[0];","vec3 Y = surface.basis[1];","vec3 Z = surface.basis[2];","float cos_theta = cos( theta ), sin_theta = sin( theta ),","cos_phi   = cos( phi   ), sin_phi   = z_by_radius3d;","surface.uv       = vec2( theta, phi ) * vec2( radius3d );","surface.normal   = surface.normal;","surface.tangent  = vec3( - sin_theta * X + cos_theta * Y );","surface.binormal = vec3( - cos_theta * sin_phi * X - sin_theta * sin_phi * Y + cos_phi * Z );","}","void compute_mapping_planar( in mapping_t mapping,  inout surface_t surface )","{","vec3 X = surface.basis[0];","vec3 Y = surface.basis[1];","vec3 Z = surface.basis[2];","surface.uv       = vec2( surface.local_position.xy );","surface.normal   = surface.normal; /* Z */;","surface.tangent  = vec3( Y );","surface.binormal = vec3( X );","}","void compute_mapping_cubical( const in mapping_t mapping, inout surface_t surface )","{","vec3 X = surface.basis[0];","vec3 Y = surface.basis[1];","vec3 Z = surface.basis[2];","float absolute_normal_x = abs( surface.local_normal.x );","float absolute_normal_y = abs( surface.local_normal.y );","float absolute_normal_z = abs( surface.local_normal.z );","float maxima_normal     = max( absolute_normal_x, max( absolute_normal_y, absolute_normal_z ) );","if( maxima_normal == absolute_normal_x )","{","float multiplier = ( surface.local_normal.x > 0.0 ? 1.0 : -1.0 );","surface.uv       = vec2( multiplier * surface.local_position.y, surface.local_position.z );","surface.normal   = surface.normal;","surface.tangent  = vec3( multiplier *  Y );","surface.binormal = vec3( Z );","} ","else if( maxima_normal == absolute_normal_y )","{","float multiplier = ( surface.local_normal.y > 0.0 ? 1.0 : -1.0 );","surface.uv       = vec2( multiplier * surface.local_position.x, surface.local_position.z );","surface.normal   = surface.normal;","surface.tangent  = vec3( multiplier *  X );","surface.binormal = vec3( Z );","}","else /* if( maxima == absolute_z ) */","{","float multiplier = ( surface.local_normal.z > 0.0 ? 1.0 : -1.0 );","surface.uv       = vec2( multiplier * surface.local_position.x, surface.local_position.y );","surface.normal   = surface.normal;","surface.tangent  = vec3( multiplier *  X );","surface.binormal = vec3( Y );","}","}","void compute_mapping_cylindrical_infinite( const in mapping_t mapping, inout surface_t surface )","{","float radius2d      = length( surface.local_position.xy );","float radius3d      = length( surface.local_position.xyz );","float z_by_radius3d = surface.local_position.z / radius3d;","float theta = atan( surface.local_position.y, surface.local_position.x ); //azimuth [-PI/2,+PI/2]","float phi   = asin( z_by_radius3d );                      //polar   [-PI,+PI]","vec3 X = surface.basis[0];","vec3 Y = surface.basis[1];","vec3 Z = surface.basis[2];","float cos_theta = cos( theta ), sin_theta = sin( theta ),","cos_phi   = cos( phi   );","surface.uv       = vec2( theta, surface.local_position.z ) * vec2( radius2d, 1.0 );","surface.normal   = surface.normal; /* vec3( cos_theta * cos_phi * X + sin_theta * cos_phi * Y ) */","surface.tangent  = vec3( - sin_theta * X + cos_theta * Y );","surface.binormal = vec3( Z );","}","void compute_mapping_cylindrical_finite( const in mapping_t mapping, inout surface_t surface )","{","vec3 X = surface.basis[0];","vec3 Y = surface.basis[1];","vec3 Z = surface.basis[2];","float absolute_normal_x = abs( surface.local_normal.x );","float absolute_normal_y = abs( surface.local_normal.y );","float absolute_normal_z = abs( surface.local_normal.z );","float maxima_normal     = max( absolute_normal_x, max( absolute_normal_y, absolute_normal_z ) );","if( maxima_normal == absolute_normal_z )","{","surface.uv       = vec2(( surface.local_normal.z > 0.0 ? 1.0 : -1.0 ) * surface.local_position.x, surface.local_position.y );","surface.normal   = surface.normal;","surface.tangent  = vec3( Y );","surface.binormal = vec3( ( surface.local_normal.z > 0.0 ? 1.0 : -1.0 ) * X );","}","else","{","float radius2d      = length( surface.local_position.xy );","float radius3d      = length( surface.local_position.xyz );","float z_by_radius3d = surface.local_position.z / radius3d;","float theta = atan( surface.local_position.y, surface.local_position.x ); //azimuth [-PI/2,+PI/2]","float phi   = asin( z_by_radius3d );                      //polar   [-PI,+PI]","float cos_theta = cos( theta ), sin_theta = sin( theta ),","  cos_phi   = cos( phi   );","surface.uv       = vec2( theta, surface.local_position.z ) * vec2( radius2d, 1.0 );","surface.normal   = surface.normal; /* vec3( cos_theta * cos_phi * X + sin_theta * cos_phi * Y ) */","surface.tangent  = vec3( - sin_theta * X + cos_theta * Y );","surface.binormal = vec3( Z );","}","}","void compute_mapping( in mapping_t mapping, inout surface_t surface )","{","surface.basis[0] = compute_vector_transformation( mapping, surface.basis[0] );","surface.basis[1] = compute_vector_transformation( mapping, surface.basis[1] );","surface.basis[2] = compute_vector_transformation( mapping, surface.basis[2] );","if( mapping.type == NO_MAPPING )","{","	compute_transformation_uv( mapping, surface );","}","else","{","if     ( mapping.type == SPHERICAL_MAPPING            ) { compute_mapping_spherical( mapping, surface ); }","else if( mapping.type == PLANAR_MAPPING               ) { compute_mapping_planar( mapping, surface ); }","else if( mapping.type == CUBICAL_MAPPING              ) { compute_mapping_cubical( mapping, surface ); }","else if( mapping.type == FINITE_CYLINDRICAL_MAPPING   ) { compute_mapping_cylindrical_finite( mapping, surface ); }","else if( mapping.type == INFINITE_CYLINDRICAL_MAPPING ) { compute_mapping_cylindrical_infinite( mapping, surface ); }","compute_transformation( mapping, surface );","}","}"].join("\n"),blending_mpm:["		vec4 blend( ","			const in float          thin_walled, ","			const in surface_t      surface, ","			const in volume_t       volume, ","			const in layer_t        layer, ","			const in contribution_t light,","			const in contribution_t environment )","		{","			vec4 transparency_mix = layer.transparency.color;","			vec4 diffuse_mix      = layer.diffuse.weight  * layer.diffuse.color * surface.ambient_occlusion;","			vec4 specular_mix     = layer.specular.weight * layer.specular.color;","			const float tonemapping_tweaking_ambient = float( 0.1 );","			/// @NOTE blend with base color on first layer only","			vec4 transparency = mix( volume.transparency.color, vec4( 1.0 ), thin_walled ) * transparency_mix; /// @NOTE transparency contribution shading not supported","			vec4 diffuse      = ( ( light.ambient + environment.ambient ) * tonemapping_tweaking_ambient + ( light.diffuse + environment.diffuse ) ) * diffuse_mix;","			vec4 specular     = ( light.specular + environment.specular ) * specular_mix;","			vec4 core_color   = mix( diffuse, transparency, layer.transparency.weight );","			vec4 reflection   = mix( core_color, specular, layer.fresnel );","			return reflection;","		}",].join("\n"),opacity_mpm:["		float opacity( ","			const in surface_t      surface, ","			const in layer_t        layer, ","			const in volume_t       volume )","		{","			float cutout       = surface.opacity;","			float transparency = luminosity( layer.transparency.weight * layer.transparency.color * volume.transparency.color ) * clamp( 1.0 - layer.fresnel, 0.0, 1.0 );","			return clamp( 1.0 - transparency, 0.0, cutout );","		}",].join("\n"),edf_mpm:["void compute_edf( const in camera_t camera, const in surface_t surface, const in illumination_t edf, out float contribution )","{","const float power = float( 0.1 );","contribution  = 0.5 * dot( camera.direction, surface.normal ) + 0.5;","contribution  = pow( contribution, power );","}",].join("\n"),brdf_mpm:["		void compute_diffuse( const in camera_t camera, const in surface_t surface, const in light_t light, const in layer_t layer, out float contribution )","		{","			float power   = mix( 0.5, 5.0, layer.diffuse.glossiness );","			contribution  = 0.5 * dot( light.direction, surface.normal ) + 0.5;","			contribution  = pow( contribution, power );","			contribution *= ( power + PI ) / ( PI * ( 4.0 - pow( 2.0 , -0.5 * power ) ) ) + 0.64;","		}","		void compute_specular( const in camera_t camera, const in surface_t surface, const in light_t light, const in layer_t layer, out float contribution )","		{","			float power = max( 0.75 * layer.specular.glossiness + 0.25, 0.5 );","			vec3  halff = normalize( light.direction + camera.direction );","			float anisotropy_intensity   = ( layer.anisotropy > 0.0 ) ? mix( 100.0 * layer.anisotropy, 1.0, pow( layer.specular.glossiness, 0.01 ) ) : 1.0;","			vec2  anisotropy_attenuation = vec2( exp( -6.0 * ( power - 0.5 ) ) );","			float dotNL = 0.5 * ( dot( surface.normal, light.direction ) + 1.0 );","			float dotNR = 0.5 * ( dot( surface.normal, camera.reflected ) + 1.0 );","			contribution = exp( -2.0 * ( pow( dot( halff, surface.tangent ) / ( anisotropy_attenuation.x / anisotropy_intensity ), 2.0 ) + pow( dot( halff, surface.binormal ) / anisotropy_attenuation.y, 2.0 ) ) / ( 1.0 + dot( halff, surface.normal ) ) );","			contribution*= dotNL / (  inversesqrt( dotNL * dotNR ) * ( PIx4 * anisotropy_attenuation.x * anisotropy_attenuation.y ) );","		}",].join("\n"),color_mpm:["#define VALUE_NONE    0","#define VALUE_UNIFORM 1","#define VALUE_SPATIAL 2","float compute_value_greyscale_uniform( const in surface_t surface, const in float value )","{","return value;","}","float compute_value_greyscale_spatial( const in surface_t surface, const in sampler2D texture )","{","vec4 texture_fetch = texture2D( texture, surface.uv );","return average( texture_fetch.rgb );","}","float compute_value_greyscale_angular( const in camera_t camera, const in surface_t surface, const in float angle0, const in float angle90 )","{","float angle = max( 0.0, dot( camera.direction, surface.normal ) );","return mix( angle90, angle0, angle );","}","float compute_value_greyscale( const in int type, const in surface_t surface, const in float value, const in sampler2D texture )","{","if     ( type == VALUE_UNIFORM ) { return compute_value_greyscale_uniform( surface, value ); }","else if( type == VALUE_SPATIAL ) { return compute_value_greyscale_spatial( surface, texture ); }","else                             { return 0.0; }","}","vec4 compute_value_color_uniform( const in surface_t surface, const in vec3 value )","{","return vec4( value, 1.0 );","}","vec4 compute_value_color_uniform( const in surface_t surface, const in vec4 value )","{","return value;","}","vec4 compute_value_color_spatial( const in surface_t surface, const in sampler2D texture )","{","return texture2D( texture, surface.uv );","}","vec4 compute_value_color_angular( const in camera_t camera, const in surface_t surface, const in vec3 color0, const in vec3 color90 )","{","float angle = max( 0.0, dot( camera.direction, surface.normal ) );","return vec4( mix( color90, color0, angle ), 1.0 );","}","vec4 compute_value_color_angular( const in camera_t camera, const in surface_t surface, const in vec4 color0, const in vec4 color90 )","{","float angle = max( 0.0, dot( camera.direction, surface.normal ) );","return mix( color90, color0, angle );","}","vec4 compute_value_color_angular( const in camera_t camera, const in surface_t surface, const in sampler2D color0, const in sampler2D color90 )","{","vec4 texture_fetch0  = texture2D( color0, surface.uv );","vec4 texture_fetch90 = texture2D( color90, surface.uv );","float angle = max( 0.0, dot( camera.direction, surface.normal ) );","return mix( texture_fetch90, texture_fetch0, angle );","}","vec4 compute_value_color( const in int type, const in surface_t surface, const in vec3 value, const in sampler2D texture )","{","if     ( type == VALUE_UNIFORM ) { return compute_value_color_uniform( surface, value ); }","else if( type == VALUE_SPATIAL ) { return compute_value_color_spatial( surface, texture ); }","else                             { return vec4(0.0); }","}","vec4 compute_value_color( const in int type, const in surface_t surface, const in vec4 value, const in sampler2D texture )","{","if     ( type == VALUE_UNIFORM ) { return compute_value_color_uniform( surface, value ); }","else if( type == VALUE_SPATIAL ) { return compute_value_color_spatial( surface, texture ); }","else                             { return vec4(0.0); }","}","vec4 compute_value_color_angular( const in int type, const in camera_t camera, const in surface_t surface, const in vec3 color0, const in sampler2D texture0, const in vec3 color90, const in sampler2D texture90 )","{","if     ( type == VALUE_UNIFORM ) { return compute_value_color_angular( camera, surface, color0, color90 ); }","else if( type == VALUE_SPATIAL ) { return compute_value_color_angular( camera, surface, texture0, texture90 ); }","else                             { return vec4(0.0); }","}","vec4 compute_value_color_angular( const in int type, const in camera_t camera, const in surface_t surface, const in vec4 color0, const in sampler2D texture0, const in vec4 color90, const in sampler2D texture90 )","{","if     ( type == VALUE_UNIFORM ) { return compute_value_color_angular( camera, surface, color0, color90 ); }","else if( type == VALUE_SPATIAL ) { return compute_value_color_angular( camera, surface, texture0, texture90 ); }","else                             { return vec4(0.0); }","}",].join("\n"),functions_mpm:["		float sign_with_zero( const in float scalar )","		{","			return scalar > 0.0 ? 1.0 : -1.0;","		}","		float sum( const in vec2 scalar )","		{","			return scalar.x + scalar.y;","		}","		float sum( const in vec3 scalar )","		{","			return scalar.x + scalar.y + scalar.z;","		}","		float sum( const in vec4 scalar )","		{","			return scalar.x + scalar.y + scalar.z + scalar.w;","		}","		float luminosity( const in vec3 color)","		{","			const vec3 coefficient = vec3( 0.299, 0.587, 0.114 );","			return sum( coefficient * color.rgb );","		}","		float luminosity( const in vec4 color)","		{","			const vec3 coefficient = vec3( 0.299, 0.587, 0.114 );","			return sum( coefficient * color.rgb );","		}","		float average( const in vec2 color )","		{","			return sum( color ) / 2.0;","		}","		float average( const in vec3 color )","		{","			return sum( color ) / 3.0;","		}","		float average( const in vec4 color )","		{","			return sum( color.rgb ) / 3.0;","		}","		float fresnel( const in vec3 Wi, const in vec3 Wo, const in float ior)","		{","			float rs = pow((ior - 1.0)/(ior + 1.0),2.0);","			vec3 h = normalize(Wi+Wo);","			float c = dot(Wi,h);","			float fresnel = clamp(rs + (1.0 - rs)*pow(1.0 - c,5.0),0.0,1.0);","			return fresnel;","		}",].join("\n"),constants_mpm:["const float Epsilon = 1e-3;","const float PI      = 3.14159265359;","const float PI_2    = 1.57079632679;","const float PIx2    = 6.28318530718;","const float PIx4    = 12.5663706144;",].join("\n"),parallax_mpm:["vec2 compute_parallax( ","const in camera_t camera, ","const in int height_type, const in float height_uniform, const in sampler2D height_spatial, ","inout surface_t surface ",")","{","const float heightMapRange = 0.15;","float nMinSamples = 12.0;","float nMaxSamples = 150.0;","vec3     vViewWS         = normalize(camera.position - surface.position);","mat3 mWorldToTangent = mat3(surface.tangent, surface.binormal, surface.normal );","vec3     vViewTS         = mWorldToTangent * vViewWS ;","vec2 vParallaxDirection = normalize(vViewTS.xy);","float fLength = length( vViewTS );","float fParallaxLength = sqrt( fLength * fLength - vViewTS.z * vViewTS.z ) / vViewTS.z; ","vec2 vParallaxOffsetTS = vParallaxDirection * fParallaxLength;","vParallaxOffsetTS *= heightMapRange;","float parallax_falloff = clamp(dot(vViewWS,surface.normal),0.0,1.0);","const int nNumSteps = 12;","float fCurrHeight = 0.0;","float fStepSize   = 1.0 / float(nNumSteps);","float fPrevHeight = 1.0;","float fNextHeight = 0.0;","int    nStepIndex = 0;","bool   bCondition = true;","vec2 vTexOffsetPerStep = fStepSize * vParallaxOffsetTS;","float  fCurrentBound     = 1.0;","float  fParallaxAmount   = 0.0;","vec2 pt1;","vec2 pt2;","vec2 texOffset2;","surface_t computed_surface = surface;","for( int nStepIndex = 0; nStepIndex < nNumSteps; nStepIndex ++ ) {","computed_surface.uv -= vTexOffsetPerStep;","float current_height = compute_value_greyscale( height_type, computed_surface, height_uniform, height_spatial );","fCurrHeight = clamp( current_height, Epsilon, 1.0);","fCurrHeight *= 0.9;","fCurrentBound -= fStepSize;","if ( fCurrHeight > fCurrentBound ) ","{     ","pt1 = vec2( fCurrentBound, fCurrHeight );","pt2 = vec2( fCurrentBound + fStepSize, fPrevHeight );","texOffset2 = computed_surface.uv - vTexOffsetPerStep;","break;","}","else","{","fPrevHeight = fCurrHeight;","}","}","float fDelta1 = pt1.x - pt1.y;","float fDelta2 = pt2.x - pt2.y;","fParallaxAmount = (pt1.x * fDelta2 - pt2.x * fDelta1 ) / ( fDelta2 - fDelta1 );","vec2 parallax_offset = vParallaxOffsetTS * (1.0 - fParallaxAmount );","return parallax_offset;","}",].join("\n")};s.UniformsUtils={merge:function(w){var x,z,y,v={};for(x=0;x<w.length;x++){y=this.clone(w[x]);for(z in y){v[z]=y[z]}}return v},mergeNoClone:function(w){var x,z,y,v={};for(x=0;x<w.length;x++){y=w[x];for(z in y){v[z]=y[z]}}return v},clone:function(v){var y,z,A,x,w={};for(y in v){w[y]={};for(z in v[y]){x=v[y][z];if(x instanceof s.Color||x instanceof s.Vector2||x instanceof s.Vector3||x instanceof s.Vector4||x instanceof s.Matrix4){w[y][z]=x.clone()}else{if(x instanceof Array){w[y][z]=x.slice()}else{w[y][z]=x}}}}return w}};s.UniformsLib={common:{diffuse:{type:"c",value:new s.Color(16777215)},opacity:{type:"f",value:1},map:{type:"t",value:null},mapHDRSize:{type:"v2",value:new s.Vector4(2048,1024)},offsetBumpMap:{type:"v2",value:new s.Vector4(0,0)},repeatBumpMap:{type:"v2",value:new s.Vector4(1,1)},lightMap:{type:"t",value:null},specularMap:{type:"t",value:null},envMap:{type:"t",value:null},envMapExposure:{type:"f",value:1},envMapHDRSize:{type:"v2",value:new s.Vector4(2048,1024)},ambienceMatrix:{type:"m4",value:new s.Matrix4()},flipEnvMap:{type:"f",value:1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:0.98},refractionRatioMap:{type:"t",value:null},combine:{type:"i",value:0},morphTargetInfluences:{type:"f",value:0},renderIteration:{type:"i",value:0},mappingNormTransformation:{type:"m3",value:new s.Matrix3()},mappingObjTransformation:{type:"m4",value:new s.Matrix4()},mappingUVTransformation:{type:"m3",value:new s.Matrix3()}},bump:{bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1}},normalmap:{normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new s.Vector2(1,1)}},fog:{fogDensity:{type:"f",value:0.00025},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2000},fogColor:{type:"c",value:new s.Color(16777215)}},lights:{ambientLightColor:{type:"fv",value:[],sceneUniform:true},shFactorsR:{type:"m4",value:new s.Matrix4(),sceneUniform:true},shFactorsG:{type:"m4",value:new s.Matrix4(),sceneUniform:true},shFactorsB:{type:"m4",value:new s.Matrix4(),sceneUniform:true},shScale:{type:"f",value:0.333,sceneUniform:true},directionalLightDirection:{type:"fv",value:[],sceneUniform:true},directionalLightColor:{type:"fv",value:[],sceneUniform:true},directionalLightFar:{type:"fv1",value:[],sceneUniform:true},directionalLightNear:{type:"fv1",value:[],sceneUniform:true},hemisphereLightDirection:{type:"fv",value:[],sceneUniform:true},hemisphereLightSkyColor:{type:"fv",value:[],sceneUniform:true},hemisphereLightGroundColor:{type:"fv",value:[],sceneUniform:true},pointLightColor:{type:"fv",value:[],sceneUniform:true},pointLightPosition:{type:"fv",value:[],sceneUniform:true},pointLightPhysicalAttenuation:{type:"iv",value:[],sceneUniform:true},pointLightDistance:{type:"fv1",value:[],sceneUniform:true},spotLightColor:{type:"fv",value:[],sceneUniform:true},spotLightPosition:{type:"fv",value:[],sceneUniform:true},spotLightDirection:{type:"fv",value:[],sceneUniform:true},spotLightPhysicalAttenuation:{type:"iv",value:[],sceneUniform:true},spotLightDistance:{type:"fv1",value:[],sceneUniform:true},spotLightAngleCos:{type:"fv1",value:[],sceneUniform:true},spotLightInnerAngleCos:{type:"fv1",value:[],sceneUniform:true},iesLightColor:{type:"fv",value:[],sceneUniform:true},iesLightPosition:{type:"fv",value:[],sceneUniform:true},iesLightDistance:{type:"fv1",value:[],sceneUniform:true},iesLightTexture:{type:"tv",value:[],sceneUniform:true},matrixWorldInv:{type:"m4v",value:[],sceneUniform:true},sphereLightColor:{type:"fv",value:[],sceneUniform:true},sphereLightPosition:{type:"fv",value:[],sceneUniform:true},sphereLightData:{type:"fv",value:[],sceneUniform:true},diskLightColor:{type:"fv",value:[],sceneUniform:true},diskLightPosition:{type:"fv",value:[],sceneUniform:true},diskLightData:{type:"fv",value:[],sceneUniform:true},diskLightNormal:{type:"fv",value:[],sceneUniform:true},tubeLightColor:{type:"fv",value:[],sceneUniform:true},tubeLightPosition:{type:"fv",value:[],sceneUniform:true},tubeLightData:{type:"fv",value:[],sceneUniform:true},tubeLightRight:{type:"fv",value:[],sceneUniform:true},areaLightColor:{type:"fv",value:[],sceneUniform:true},areaLightPosition:{type:"fv",value:[],sceneUniform:true},areaLightNormal:{type:"fv",value:[],sceneUniform:true},areaLightRight:{type:"fv",value:[],sceneUniform:true},areaLightUp:{type:"fv",value:[],sceneUniform:true},areaLightData:{type:"fv",value:[],sceneUniform:true},precomputedAreaGGX1texture:{type:"t",value:null,sceneUniform:true},precomputedAreaGGX2texture:{type:"t",value:null,sceneUniform:true},precomputedAreaSheentexture:{type:"t",value:null,sceneUniform:true}},clipPlanes:{nbClipPlanes:{type:"i",value:0,clipPlanesUniform:true},clipPlaneEquations:{type:"fv4",value:[],clipPlanesUniform:true,loadOnlyIfUniformNotZero:"nbClipPlanes"},clipPlaneActive:{type:"iv1",value:[],clipPlanesUniform:true,loadOnlyIfUniformNotZero:"nbClipPlanes"},clipFrontOpacity:{type:"f",value:1,clipPlanesUniform:true,loadOnlyIfUniformNotZero:"nbClipPlanes"},clipBackOpacity:{type:"f",value:0,clipPlanesUniform:true,loadOnlyIfUniformNotZero:"nbClipPlanes"},polygonSize:{type:"i",value:0,clipPlanesUniform:true},polygonPoints:{type:"t",value:null,clipPlanesUniform:true,loadOnlyIfUniformNotZero:"polygonSize"},extrusionPlaneU:{type:"v3",value:new s.Vector3(0,0,1),clipPlanesUniform:true,loadOnlyIfUniformNotZero:"polygonSize"},extrusionPlaneV:{type:"v3",value:new s.Vector3(1,0,0),clipPlanesUniform:true,loadOnlyIfUniformNotZero:"polygonSize"}},particle:{psColor:{type:"c",value:new s.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null},fogDensity:{type:"f",value:0.00025},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2000},fogColor:{type:"c",value:new s.Color(16777215)}},shadowmap:{shadowMap:{type:"tv",value:[],sceneUniform:true},shadowMapSize:{type:"v2v",value:[],sceneUniform:true},shadowBias:{type:"fv1",value:[],sceneUniform:true},shadowDarkness:{type:"fv1",value:[],sceneUniform:true},shadowMapCube:{type:"tcv",value:[],sceneUniform:true},shadowPointPosition:{type:"v3v",value:[],sceneUniform:true},shadowNearCube:{type:"fv1",value:[],sceneUniform:true},shadowFarCube:{type:"fv1",value:[],sceneUniform:true},shadowMapSizeCube:{type:"fv1",value:[],sceneUniform:true},shadowBiasCube:{type:"fv1",value:[],sceneUniform:true},shadowDarknessCube:{type:"fv1",value:[],sceneUniform:true},shadowMatrix:{type:"m4v",value:[],sceneUniform:true},poissonDisk:{type:"v2v",value:[],sceneUniform:true}},lines:{scale:{type:"f",value:1},totalSize:{type:"f",value:0},halfWidth:{type:"f",value:0.5},pixelSize:{type:"v2",value:new s.Vector2(0.01,0.01)},dashPattern:{type:"fv1",value:new Float32Array(2)},patternOffset:{type:"f",value:0}},skinning:{skinningMap:{type:"t",value:null},skinningInstancingMaps:{type:"tv",value:[]}}};s.ShaderLib={basic:{uniforms:s.UniformsUtils.merge([s.UniformsLib.common,s.UniformsLib.fog,s.UniformsLib.shadowmap,s.UniformsLib.clipPlanes,s.UniformsLib.skinning]),vertexShader:[s.ShaderChunk.clip_pars_vertex,s.ShaderChunk.map_pars_vertex,s.ShaderChunk.lightmap_pars_vertex,s.ShaderChunk.envmap_pars_vertex,s.ShaderChunk.color_pars_vertex,s.ShaderChunk.morphtarget_pars_vertex,s.ShaderChunk.skinning_pars_vertex,s.ShaderChunk.shadowmap_pars_vertex,s.ShaderChunk.oit_pars_vertex,"void main() {",s.ShaderChunk.PDSFX_start_vertex,s.ShaderChunk.map_vertex,s.ShaderChunk.lightmap_vertex,s.ShaderChunk.color_vertex,s.ShaderChunk.skinbase_vertex,"#if defined(USE_ENVMAP) || defined(PDSFX)",s.ShaderChunk.morphnormal_vertex,s.ShaderChunk.skinnormal_vertex,s.ShaderChunk.defaultnormal_vertex,"#endif",s.ShaderChunk.morphtarget_vertex,s.ShaderChunk.skinning_vertex,s.ShaderChunk.default_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif",s.ShaderChunk.clip_vertex,s.ShaderChunk.worldpos_vertex,s.ShaderChunk.envmap_vertex,s.ShaderChunk.shadowmap_vertex,s.ShaderChunk.oit_vertex,s.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[s.ShaderChunk.PDSFX_albedo_pars_fragment,s.ShaderChunk.PDSFX_opacity_pars_fragment,"#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","vec2 uvToUse;","#endif",s.ShaderChunk.clip_pars_fragment,s.ShaderChunk.color_pars_fragment,s.ShaderChunk.map_pars_fragment,s.ShaderChunk.lightmap_pars_fragment,s.ShaderChunk.envmap_pars_fragment,s.ShaderChunk.fog_pars_fragment,s.ShaderChunk.shadowmap_pars_fragment,s.ShaderChunk.specularmap_pars_fragment,s.ShaderChunk.oit_pars_fragment,"void main() {","#ifdef PDSFX",s.ShaderChunk.PDSFX_map_fragment,"ComputeCommonValues();",s.ShaderChunk.PDSFX_discard_fragment,s.ShaderChunk.PDSFX_albedo_fragment,s.ShaderChunk.PDSFX_opacity_fragment,"#endif","gl_FragColor = vec4( diffuse, opacity );","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","uvToUse=vUv;","#endif",s.ShaderChunk.clip_fragment,s.ShaderChunk.uvmapping_fragment,s.ShaderChunk.map_fragment,s.ShaderChunk.alphatest_fragment,s.ShaderChunk.specularmap_fragment,s.ShaderChunk.lightmap_fragment,s.ShaderChunk.color_fragment,s.ShaderChunk.envmap_fragment,s.ShaderChunk.shadowmap_fragment,s.ShaderChunk.linear_to_gamma_fragment,s.ShaderChunk.fog_fragment,s.ShaderChunk.oit_fragment,s.ShaderChunk.PDSFX_end_fragment,"}"].join("\n")},lambert:{uniforms:s.UniformsUtils.merge([s.UniformsLib.common,s.UniformsLib.fog,s.UniformsLib.lights,s.UniformsLib.shadowmap,s.UniformsLib.clipPlanes,{ambient:{type:"c",value:new s.Color(16777215)},emissive:{type:"c",value:new s.Color(0)},wrapRGB:{type:"v3",value:new s.Vector3(1,1,1)}},s.UniformsLib.skinning]),vertexShader:["#define LAMBERT","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",s.ShaderChunk.clip_pars_vertex,s.ShaderChunk.map_pars_vertex,s.ShaderChunk.lightmap_pars_vertex,s.ShaderChunk.envmap_pars_vertex,s.ShaderChunk.lights_lambert_pars_vertex,s.ShaderChunk.color_pars_vertex,s.ShaderChunk.morphtarget_pars_vertex,s.ShaderChunk.skinning_pars_vertex,s.ShaderChunk.shadowmap_pars_vertex,s.ShaderChunk.oit_pars_vertex,"void main() {",s.ShaderChunk.PDSFX_start_vertex,s.ShaderChunk.map_vertex,s.ShaderChunk.lightmap_vertex,s.ShaderChunk.color_vertex,s.ShaderChunk.morphnormal_vertex,s.ShaderChunk.skinbase_vertex,s.ShaderChunk.skinnormal_vertex,s.ShaderChunk.defaultnormal_vertex,s.ShaderChunk.morphtarget_vertex,s.ShaderChunk.skinning_vertex,s.ShaderChunk.default_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif",s.ShaderChunk.clip_vertex,s.ShaderChunk.worldpos_vertex,s.ShaderChunk.envmap_vertex,s.ShaderChunk.lights_lambert_vertex,s.ShaderChunk.shadowmap_vertex,s.ShaderChunk.oit_vertex,s.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif","#if defined( NEEDS_UVTOUSE )","vec2 uvToUse;","#endif",s.ShaderChunk.clip_pars_fragment,s.ShaderChunk.iterative_pars_fragment,s.ShaderChunk.color_pars_fragment,s.ShaderChunk.map_pars_fragment,s.ShaderChunk.lightmap_pars_fragment,s.ShaderChunk.envmap_pars_fragment,s.ShaderChunk.fog_pars_fragment,s.ShaderChunk.shadowmap_pars_fragment,s.ShaderChunk.specularmap_pars_fragment,s.ShaderChunk.oit_pars_fragment,"void main() {","#ifdef PDSFX","ComputeCommonValues();","#endif","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","uvToUse=vUv;","#endif",s.ShaderChunk.clip_fragment,s.ShaderChunk.uvmapping_fragment,s.ShaderChunk.map_fragment,s.ShaderChunk.alphatest_fragment,s.ShaderChunk.specularmap_fragment,"#ifdef DOUBLE_SIDED","if ( gl_FrontFacing )","gl_FragColor.xyz *= vLightFront;","else","gl_FragColor.xyz *= vLightBack;","#else","gl_FragColor.xyz *= vLightFront;","#endif",s.ShaderChunk.lightmap_fragment,s.ShaderChunk.color_fragment,s.ShaderChunk.stochastic_transparency_fragment,s.ShaderChunk.envmap_fragment,s.ShaderChunk.shadowmap_fragment,s.ShaderChunk.linear_to_gamma_fragment,s.ShaderChunk.fog_fragment,s.ShaderChunk.oit_fragment,s.ShaderChunk.PDSFX_end_fragment,"}"].join("\n")},phong:{uniforms:s.UniformsUtils.merge([s.UniformsLib.common,s.UniformsLib.bump,s.UniformsLib.normalmap,s.UniformsLib.fog,s.UniformsLib.lights,s.UniformsLib.shadowmap,s.UniformsLib.clipPlanes,{ambient:{type:"c",value:new s.Color(16777215)},emissive:{type:"c",value:new s.Color(0)},specular:{type:"c",value:new s.Color(1118481)},shininess:{type:"f",value:30},shininessInSpecMap:{type:"i",value:0},wrapRGB:{type:"v3",value:new s.Vector3(1,1,1)}},s.UniformsLib.skinning]),vertexShader:["#define PHONG","#ifndef PDSFX","varying vec3 vViewPosition;","#endif","varying vec3 vNormal;",s.ShaderChunk.clip_pars_vertex,s.ShaderChunk.map_pars_vertex,s.ShaderChunk.lightmap_pars_vertex,s.ShaderChunk.envmap_pars_vertex,s.ShaderChunk.lights_phong_pars_vertex,s.ShaderChunk.color_pars_vertex,s.ShaderChunk.morphtarget_pars_vertex,s.ShaderChunk.skinning_pars_vertex,s.ShaderChunk.shadowmap_pars_vertex,s.ShaderChunk.oit_pars_vertex,"void main() {",s.ShaderChunk.PDSFX_start_vertex,s.ShaderChunk.map_vertex,s.ShaderChunk.lightmap_vertex,s.ShaderChunk.color_vertex,s.ShaderChunk.morphnormal_vertex,s.ShaderChunk.skinbase_vertex,s.ShaderChunk.skinnormal_vertex,s.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",s.ShaderChunk.morphtarget_vertex,s.ShaderChunk.skinning_vertex,s.ShaderChunk.default_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif",s.ShaderChunk.clip_vertex,"#ifndef PDSFX","vViewPosition = -mvPosition.xyz;","#endif",s.ShaderChunk.worldpos_vertex,s.ShaderChunk.envmap_vertex,s.ShaderChunk.lights_phong_vertex,s.ShaderChunk.shadowmap_vertex,s.ShaderChunk.oit_vertex,s.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:["#define PHONG",s.ShaderChunk.PDSFX_albedo_pars_fragment,s.ShaderChunk.PDSFX_opacity_pars_fragment,"uniform vec3 ambient;",s.ShaderChunk.PDSFX_emissive_pars_fragment,s.ShaderChunk.PDSFX_specular_pars_fragment,"uniform float shininess;","uniform bool shininessInSpecMap;","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","vec2 uvToUse;","#endif",s.ShaderChunk.clip_pars_fragment,s.ShaderChunk.iterative_pars_fragment,s.ShaderChunk.color_pars_fragment,s.ShaderChunk.map_pars_fragment,s.ShaderChunk.lightmap_pars_fragment,s.ShaderChunk.envmap_pars_fragment,s.ShaderChunk.fog_pars_fragment,s.ShaderChunk.lights_phong_pars_fragment,s.ShaderChunk.shadowmap_pars_fragment,s.ShaderChunk.bumpmap_pars_fragment,s.ShaderChunk.normalmap_pars_fragment,s.ShaderChunk.specularmap_pars_fragment,s.ShaderChunk.oit_pars_fragment,"void main() {","#ifdef PDSFX",s.ShaderChunk.PDSFX_map_fragment,"ComputeCommonValues();",s.ShaderChunk.PDSFX_discard_fragment,s.ShaderChunk.PDSFX_albedo_fragment,s.ShaderChunk.PDSFX_opacity_fragment,s.ShaderChunk.PDSFX_emissive_fragment,s.ShaderChunk.PDSFX_specular_fragment,s.ShaderChunk.PDSFX_viewNormal_fragment,"vViewPosition = -ComputeViewPosition();","#endif","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","uvToUse=vUv;","#endif",s.ShaderChunk.clip_fragment,s.ShaderChunk.uvmapping_fragment,s.ShaderChunk.map_fragment,s.ShaderChunk.alphatest_fragment,"float shininessValue = shininess;",s.ShaderChunk.specularmap_fragment,s.ShaderChunk.lights_phong_fragment,s.ShaderChunk.lightmap_fragment,s.ShaderChunk.color_fragment,s.ShaderChunk.stochastic_transparency_fragment,s.ShaderChunk.envmap_fragment,s.ShaderChunk.shadowmap_fragment,s.ShaderChunk.linear_to_gamma_fragment,s.ShaderChunk.fog_fragment,s.ShaderChunk.oit_fragment,s.ShaderChunk.PDSFX_end_fragment,"}"].join("\n")},particle_basic:{uniforms:s.UniformsUtils.merge([s.UniformsLib.particle,s.UniformsLib.shadowmap,s.UniformsLib.clipPlanes]),vertexShader:["uniform float size;","uniform float scale;",s.ShaderChunk.clip_pars_vertex,s.ShaderChunk.color_pars_vertex,s.ShaderChunk.shadowmap_pars_vertex,"void main() {",s.ShaderChunk.PDSFX_start_particle_vertex,s.ShaderChunk.PDSFX_start_vertex,s.ShaderChunk.color_vertex,"vec4 mvPosition = viewMatrix * (modelMatrix * vec4(position.xyz, 1.0));","#ifdef PDSFX","_viewTangentSpace.Position = mvPosition.xyz;","ProcessViewTangentSpace(_viewTangentSpace);","mvPosition.xyz = _viewTangentSpace.Position;","#ifdef USE_SIZEATTENUATION","mvPosForAttenuation = mvPosition.xyz;","#endif","#endif",s.ShaderChunk.PDSFX_point_size_vertex,"gl_Position = projectionMatrix * mvPosition;",s.ShaderChunk.worldpos_vertex,s.ShaderChunk.shadowmap_vertex,s.ShaderChunk.clip_vertex,s.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:["#ifdef PDSFX","uniform vec3 _DSalbedo;","vec3 psColor;","#else","uniform vec3 psColor;","#endif",s.ShaderChunk.PDSFX_opacity_pars_fragment,"uniform float size;",s.ShaderChunk.clip_pars_fragment,s.ShaderChunk.color_pars_fragment,s.ShaderChunk.map_particle_pars_fragment,s.ShaderChunk.fog_pars_fragment,s.ShaderChunk.shadowmap_pars_fragment,"void main() {","#ifdef PDSFX","_DSsize_ = size;",s.ShaderChunk.PDSFX_map_fragment,"ComputeCommonValues();",s.ShaderChunk.PDSFX_discard_fragment,"_DSalbedo_ = _DSalbedo;","psColor = ComputeAlbedo();",s.ShaderChunk.PDSFX_opacity_fragment,"#endif","gl_FragColor = vec4( psColor, opacity );",s.ShaderChunk.clip_fragment,s.ShaderChunk.map_particle_fragment,s.ShaderChunk.alphatest_fragment,s.ShaderChunk.color_fragment,s.ShaderChunk.shadowmap_fragment,s.ShaderChunk.fog_fragment,s.ShaderChunk.PDSFX_end_fragment,"}"].join("\n")},line:{uniforms:s.UniformsUtils.merge([s.UniformsLib.common,s.UniformsLib.fog,s.UniformsLib.clipPlanes,s.UniformsLib.lines,s.UniformsLib.skinning]),vertexShader:[s.ShaderChunk.clip_pars_vertex,s.ShaderChunk.map_pars_vertex,s.ShaderChunk.envmap_pars_vertex,s.ShaderChunk.color_pars_vertex,s.ShaderChunk.morphtarget_pars_vertex,s.ShaderChunk.skinning_pars_vertex,s.ShaderChunk.lines_pars_vertex,s.ShaderChunk.oit_pars_vertex,"void main() {",s.ShaderChunk.PDSFX_start_vertex,s.ShaderChunk.map_vertex,s.ShaderChunk.color_vertex,s.ShaderChunk.skinbase_vertex,"#ifdef USE_ENVMAP",s.ShaderChunk.morphnormal_vertex,s.ShaderChunk.skinnormal_vertex,s.ShaderChunk.defaultnormal_vertex,"#endif",s.ShaderChunk.morphtarget_vertex,s.ShaderChunk.skinning_vertex,s.ShaderChunk.default_vertex,"#if defined(PDSFX) && defined(USE_ENVMAP)","transformedNormal = _viewTangentSpace.Normal;","#endif",s.ShaderChunk.clip_vertex,s.ShaderChunk.worldpos_vertex,s.ShaderChunk.envmap_vertex,s.ShaderChunk.lines_vertex,s.ShaderChunk.oit_vertex,s.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:["#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","vec2 uvToUse;","#endif",s.ShaderChunk.lines_pars_fragment,s.ShaderChunk.clip_pars_fragment,s.ShaderChunk.color_pars_fragment,s.ShaderChunk.map_pars_fragment,s.ShaderChunk.envmap_pars_fragment,s.ShaderChunk.fog_pars_fragment,s.ShaderChunk.specularmap_pars_fragment,s.ShaderChunk.oit_pars_fragment,"void main() {","#ifdef PDSFX",s.ShaderChunk.PDSFX_map_fragment,"ComputeCommonValues();",s.ShaderChunk.PDSFX_discard_fragment,s.ShaderChunk.PDSFX_albedo_fragment,s.ShaderChunk.PDSFX_opacity_fragment,"#endif","gl_FragColor = vec4( diffuse, opacity );",s.ShaderChunk.lines_fragment,"#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","uvToUse=vUv;","#endif",s.ShaderChunk.clip_fragment,s.ShaderChunk.uvmapping_fragment,s.ShaderChunk.map_fragment,s.ShaderChunk.alphatest_fragment,s.ShaderChunk.specularmap_fragment,s.ShaderChunk.color_fragment,s.ShaderChunk.envmap_fragment,s.ShaderChunk.linear_to_gamma_fragment,s.ShaderChunk.fog_fragment,s.ShaderChunk.oit_fragment,s.ShaderChunk.PDSFX_end_fragment,"}"].join("\n")},normalmap:{uniforms:s.UniformsUtils.merge([s.UniformsLib.fog,s.UniformsLib.lights,s.UniformsLib.shadowmap,{enableAO:{type:"i",value:0},enableDiffuse:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},enableDisplacement:{type:"i",value:0},tDisplacement:{type:"t",value:null},tDiffuse:{type:"t",value:null},tCube:{type:"t",value:null},tNormal:{type:"t",value:null},tSpecular:{type:"t",value:null},tAO:{type:"t",value:null},uNormalScale:{type:"v2",value:new s.Vector2(1,1)},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},uDiffuseColor:{type:"c",value:new s.Color(16777215)},uSpecularColor:{type:"c",value:new s.Color(1118481)},uAmbientColor:{type:"c",value:new s.Color(16777215)},uShininess:{type:"f",value:30},uOpacity:{type:"f",value:1},useRefract:{type:"i",value:0},uRefractionRatio:{type:"f",value:0.98},uReflectivity:{type:"f",value:0.5},uOffset:{type:"v2",value:new s.Vector2(0,0)},uRepeat:{type:"v2",value:new s.Vector2(1,1)},wrapRGB:{type:"v3",value:new s.Vector3(1,1,1)}}]),fragmentShader:["uniform vec3 uAmbientColor;","uniform vec3 uDiffuseColor;","uniform vec3 uSpecularColor;","uniform float uShininess;","uniform float uOpacity;","uniform bool enableDiffuse;","uniform bool enableSpecular;","uniform bool enableAO;","uniform bool enableReflection;","uniform sampler2D tDiffuse;","uniform sampler2D tNormal;","uniform sampler2D tSpecular;","uniform sampler2D tAO;","uniform samplerCube tCube;","uniform vec2 uNormalScale;","uniform bool useRefract;","uniform float uRefractionRatio;","uniform float uReflectivity;","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","vec2 uvToUse;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","uniform float directionalLightFar[ MAX_DIR_LIGHTS ];","uniform float directionalLightNear[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightInnerAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","varying vec3 vWorldPosition;","varying vec3 vViewPosition;",s.ShaderChunk.shadowmap_pars_fragment,s.ShaderChunk.fog_pars_fragment,"void main() {","gl_FragColor = vec4( vec3( 1.0 ), uOpacity );","uvToUse=vUv;","vec3 specularTex = vec3( 1.0 );","vec3 normalTex = texture2D( tNormal, uvToUse/*vUv*/).xyz * 2.0 - 1.0;","normalTex.xy *= uNormalScale;","normalTex = normalize( normalTex );","if( enableDiffuse ) {","#ifdef GAMMA_INPUT","vec4 texelColor = texture2D( tDiffuse, uvToUse/*vUv*/ );","texelColor.xyz *= texelColor.xyz;","gl_FragColor = gl_FragColor * texelColor;","#else","gl_FragColor = gl_FragColor * texture2D( tDiffuse, uvToUse/*vUv*/ );","#endif","}","if( enableAO ) {","#ifdef GAMMA_INPUT","vec4 aoColor = texture2D( tAO, uvToUse/*vUv*/ );","aoColor.xyz *= aoColor.xyz;","gl_FragColor.xyz = gl_FragColor.xyz * aoColor.xyz;","#else","gl_FragColor.xyz = gl_FragColor.xyz * texture2D( tAO, uvToUse/*vUv*/ ).xyz;","#endif","}","if( enableSpecular )","specularTex = texture2D( tSpecular, uvToUse/*vUv*/ ).xyz;","mat3 tsb = mat3( normalize( vTangent ), normalize( vBinormal ), normalize( vNormal ) );","vec3 finalNormal = tsb * normalTex;","#ifdef FLIP_SIDED","finalNormal = -finalNormal;","#endif","vec3 normal = normalize( finalNormal );","vec3 viewPosition = normalize( vViewPosition );","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","{","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ 0 ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_CASCADE","shadowExposure = getExposureCascaded(vShadowCoord,shadowMap,shadowBias,shadowMapSize);","#else","if(0<MAX_SHADOWS_DIR){","shadowExposure = getExposure(vShadowCoord[ 0 ],shadowMap[ 0 ],shadowBias[ 0 ],shadowMapSize[ 0 ]);","}","#endif","#endif","#ifdef WRAP_AROUND","float directionalLightWeightingFull = max( dot( normal, dirVector ), 0.0 );","float directionalLightWeightingHalf = max( 0.5 * dot( normal, dirVector ) + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( directionalLightWeightingFull ), vec3( directionalLightWeightingHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );","#endif","dirDiffuse += directionalLightColor[ 0 ] * uDiffuseColor * dirDiffuseWeight * shadowExposure;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, uShininess ), 0.0 );","dirSpecular += directionalLightColor[ 0 ] * uSpecularColor * dirSpecularWeight * dirDiffuseWeight * shadowExposure;","}","if(MAX_DIR_LIGHTS>1){","for( int i = 1; i < MAX_DIR_LIGHTS; i++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_CASCADE","#else","if(i<MAX_SHADOWS_DIR){","shadowExposure = getExposure(vShadowCoord[ i ],shadowMap[ i ],shadowBias[ i ],shadowMapSize[ i ]);","}","#endif","#endif","#ifdef WRAP_AROUND","float directionalLightWeightingFull = max( dot( normal, dirVector ), 0.0 );","float directionalLightWeightingHalf = max( 0.5 * dot( normal, dirVector ) + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( directionalLightWeightingFull ), vec3( directionalLightWeightingHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );","#endif","dirDiffuse += directionalLightColor[ i ] * uDiffuseColor * dirDiffuseWeight * shadowExposure;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, uShininess ), 0.0 );","dirSpecular += directionalLightColor[ i ] * uSpecularColor * dirSpecularWeight * dirDiffuseWeight * shadowExposure;","}","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 spotVector = lPosition.xyz + vViewPosition.xyz;","float spotDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","spotDistance = 1.0 - min( ( length( spotVector ) / spotLightDistance[ i ] ), 1.0 );","spotVector = normalize( spotVector );","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP","if((i + MAX_SHADOWS_DIR)<MAX_SHADOWS){","shadowExposure = getExposure(vShadowCoord[ i + MAX_SHADOWS_DIR ],shadowMap[ i + MAX_SHADOWS_DIR ],shadowBias[ i + MAX_SHADOWS_DIR ],shadowMapSize[ i + MAX_SHADOWS_DIR ]);","}","#endif","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = 1.0 - smoothstep( spotLightInnerAngleCos[ i ],spotLightAngleCos[ i ],spotEffect );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dot( normal, spotVector ), 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dot( normal, spotVector ) + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dot( normal, spotVector ), 0.0 );","#endif","spotDiffuse += spotDistance * spotLightColor[ i ] * uDiffuseColor * spotDiffuseWeight * spotEffect * shadowExposure;","vec3 spotHalfVector = normalize( spotVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularTex.r * max( pow( spotDotNormalHalf, uShininess ), 0.0 );","spotSpecular += spotDistance * spotLightColor[ i ] * uSpecularColor * spotSpecularWeight * spotDiffuseWeight * spotEffect * shadowExposure;","}","}","#endif","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 pointVector = lPosition.xyz + vViewPosition.xyz;","float pointDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","pointDistance = 1.0 - min( ( length( pointVector ) / pointLightDistance[ i ] ), 1.0 );","pointVector = normalize( pointVector );","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP_CUBE","if (i<MAX_SHADOWS_CUBE){","shadowExposure = getExposure(shadowPointPosition[ i ],shadowMapCube[ i ],shadowBiasCube[ i ],shadowMapSizeCube[ i ],shadowNearCube[ i ],shadowFarCube[ i ]);","}","#endif","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dot( normal, pointVector ), 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dot( normal, pointVector ) + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );","#endif","pointDiffuse += pointDistance * pointLightColor[ i ] * uDiffuseColor * pointDiffuseWeight * shadowExposure;","vec3 pointHalfVector = normalize( pointVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularTex.r * max( pow( pointDotNormalHalf, uShininess ), 0.0 );","pointSpecular += pointDistance * pointLightColor[ i ] * uSpecularColor * pointSpecularWeight * pointDiffuseWeight * shadowExposure;","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += uDiffuseColor * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularTex.r * max( pow( hemiDotNormalHalfSky, uShininess ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularTex.r * max( pow( hemiDotNormalHalfGround, uShininess ), 0.0 );","hemiSpecular += uSpecularColor * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor + totalSpecular );","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor ) + totalSpecular;","#endif","if ( enableReflection ) {","vec3 vReflect;","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","if ( useRefract ) {","vReflect = refract( cameraToVertex, normal, uRefractionRatio );","} else {","vReflect = reflect( cameraToVertex, normal );","}","vec4 cubeColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );","#ifdef GAMMA_INPUT","cubeColor.xyz *= cubeColor.xyz;","#endif","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularTex.r * uReflectivity );","}",s.ShaderChunk.linear_to_gamma_fragment,s.ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["attribute vec4 tangent;","uniform vec2 uOffset;","uniform vec2 uRepeat;","uniform bool enableDisplacement;","#ifdef VERTEX_TEXTURES","uniform sampler2D tDisplacement;","uniform float uDisplacementScale;","uniform float uDisplacementBias;","#endif","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vWorldPosition;","varying vec3 vViewPosition;",s.ShaderChunk.skinning_pars_vertex,s.ShaderChunk.shadowmap_pars_vertex,"void main() {",s.ShaderChunk.skinbase_vertex,s.ShaderChunk.skinnormal_vertex,"#ifdef USE_SKINNING",s._DefaultShaderChunk.model_view_normal_vertex,"vec4 skinnedTangent = skinMatrix * vec4( tangent.xyz, 0.0 );","vec3 mvTangent;","if (use_normal_matrix)","mvTangent = normalMatrix * skinnedTangent.xyz;","else {",s._DefaultShaderChunk.getModelViewUnitVectorTransformationChunk("mvTangent","skinnedTangent.xyz"),"}","vTangent = normalize( mvTangent );","#else","if (use_normal_matrix) {","vNormal = normalMatrix * normal;","vTangent = normalMatrix * tangent.xyz;","} else {",s._DefaultShaderChunk.getModelViewUnitVectorTransformationChunk("vNormal","normal"),s._DefaultShaderChunk.getModelViewUnitVectorTransformationChunk("vTangent","tangent.xyz"),"}","vNormal = normalize(vNormal);","vTangent = normalize(vTangent);","#endif","vBinormal = normalize( cross( vNormal, vTangent ) * tangent.w );","vUv = uv * uRepeat + uOffset;","vec3 displacedPosition;","#ifdef VERTEX_TEXTURES","if ( enableDisplacement ) {","vec3 dv = texture2D( tDisplacement, uv ).xyz;","float df = uDisplacementScale * dv.x + uDisplacementBias;","displacedPosition = position + normalize( normal ) * df;","} else {","#ifdef USE_SKINNING","vec4 skinVertex = vec4( position, 1.0 );","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","}","#else","#ifdef USE_SKINNING","vec4 skinVertex = vec4( position, 1.0 );","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","#endif",s._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPosition","vec4( displacedPosition, 1.0 )"),"vec4 worldPosition = modelMatrix * vec4( displacedPosition, 1.0 );","gl_Position = projectionMatrix * mvPosition;","vWorldPosition = worldPosition.xyz;","vViewPosition = -mvPosition.xyz;","#ifdef USE_SHADOWMAP","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[ i ] * vec4( displacedPosition, 1.0 );","}","#endif","}"].join("\n")},cube:{uniforms:{tCube:{type:"t",value:null},tFlip:{type:"f",value:-1}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;",s._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform samplerCube tCube;","uniform float tFlip;","varying vec3 vWorldPosition;","void main() {","gl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );","}"].join("\n")},depthRGBA:{uniforms:s.UniformsUtils.merge([s.UniformsLib.clipPlanes,s.UniformsLib.skinning,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new s.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new s.Vector4(1,1)}}]),vertexShaderPars:["#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif"].join("\n"),vertexShaderBody:["#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif"].join("\n"),fragmentShaderPars:["vec4 pack_depth( const in float depth ) {","const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","const vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","vec4 res = mod( depth * bit_shift * vec4(255.0), vec4(256.0) ) / vec4(255.0);","res -= res.xxyz * bit_mask;","return res;","}","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif"].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vUvMap ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","gl_FragData[ 0 ] = pack_depth( gl_FragCoord.z );"].join("\n"),vertexShader:[s.ShaderChunk.clip_pars_vertex,s.ShaderChunk.morphtarget_pars_vertex,s.ShaderChunk.skinning_pars_vertex,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","void main() {",s.ShaderChunk.PDSFX_start_vertex,s.ShaderChunk.skinbase_vertex,s.ShaderChunk.morphtarget_vertex,s.ShaderChunk.skinning_vertex,s.ShaderChunk.default_vertex,s.ShaderChunk.clip_vertex,"#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif",s.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:[s.ShaderChunk.clip_pars_fragment,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","vec4 pack_depth( const in float depth ) {","const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","const vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","vec4 res = mod( depth * bit_shift * vec4(255.0), vec4(256.0) ) / vec4(255.0);","res -= res.xxyz * bit_mask;","return res;","}","void main() {","#ifdef PDSFX","ComputeCommonValues();",s.ShaderChunk.PDSFX_discard_fragment,"#endif",s.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vUvMap ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","gl_FragData[ 0 ].x = exp(80.0*gl_FragCoord.z);","gl_FragData[ 0 ].w = 1.0;","#else","gl_FragData[ 0 ] = pack_depth( gl_FragCoord.z );","#endif","}"].join("\n")}};function j(v,u){return u.sortKey-v.sortKey}function m(v,u){var x=v[2];var w=u[2];if(w===undefined){return -1}if(x===undefined){return 1}if(x.z!==w.z){if(w.z===undefined){return -1}if(x.z===undefined){return 1}return w.z-x.z}else{return w.id-x.id}}function b(v,u){if(v.z!==u.z){if(u.z===undefined){return -1}if(v.z===undefined){return 1}return u.z-v.z}else{return u.id-v.id}}function o(v,u){if(v.z!==u.z){if(u.z===undefined){return 1}if(v.z===undefined){return -1}return v.z-u.z}else{return v.id-u.id}}function l(v,u){return u[0]-v[0]}var e=0;var n=-1;s.WebGLRenderer=function(bj){this.currentFrameIndex=0;this.renderIteration=0;var cw=0;this._VRCompatible=false;this.resetGSSOCacheFrame=0;this.forcePolygonOffset=s.PolygonOffsetForceStatus.DEFAULT;bj=bj||{};var bu=bj.canvas!==undefined?bj.canvas:document.createElement("canvas"),aF=bj.divCSS!==undefined?bj.divCSS:document.createElement("div"),D=bj.precision!==undefined?bj.precision:"highp",ci=bj.alpha!==undefined?bj.alpha:true,by=bj.premultipliedAlpha!==undefined?bj.premultipliedAlpha:true,cA=bj.antialias!==undefined?bj.antialias:false,z=bj.stencil!==undefined?bj.stencil:true,aE=bj.preserveDrawingBuffer!==undefined?bj.preserveDrawingBuffer:false,b7=bj.clearColor!==undefined?new s.Color(bj.clearColor):new s.Color(0),aC=bj.clearAlpha!==undefined?bj.clearAlpha:0;this._sortRenderListByBuffer=bj.sortRenderListByBuffer!==undefined?bj.sortRenderListByBuffer:false;var Q,b6;var aD,T;this.domElement=bu;this.currentPass=null;this.id=e++;this.useRenderPriorityOpacity=false;this.renderPriorityDefaultOpacity=1;this.context=null;this.devicePixelRatio=bj.devicePixelRatio!==undefined?bj.devicePixelRatio:window.devicePixelRatio!==undefined?window.devicePixelRatio:1;this.splitScreenMode=null;this.autoClear=true;this.autoClearColor=true;this.autoClearDepth=true;this.autoClearStencil=true;this.visibleSpace=bj.visibleSpace!==undefined?bj.visibleSpace:1;this.sortObjects=true;this.autoUpdateObjects=true;this.autoUpdateScene=true;this.gammaInput=false;this.gammaOutput=false;this.lensFlareEnabled=true;this.shadowMapEnabled=false;this.shadowMapAutoUpdate=true;this.shadowMapType=s.PCFShadowMap;this.shadowMapQuality="Low";this.shadowMapCullFace=s.CullFaceFront;this.shadowMapDebug=false;this.shadowMapCascade=false;this.clipPlanesEnabled=false;this.clipPlanes=[];this.disableBackFaceClipPlanes=0;this.maxMorphTargets=8;this.maxMorphNormals=4;this.autoScaleCubemaps=true;this.disableDepthWrite=false;this.disableDepthTest=false;this.disableColorWrite=false;this.enableStencilWrite=false;this.disableBackFaceCulling=false;this.renderLineMode=null;this.renderFaceMode=s.ShowAllFaces;this.renderVolumesOnly=false;this.materialMode=true;this.gasLookMode=false;this.enableRenderPluginsPre=true;this.enableRenderPluginsPost=true;this.renderPluginsPre=[];this.renderPluginsPost=[];this.prevNormalDepthBuffer=null;this.prevColorBuffer=null;this.ambianceGenerators=null;this.sssGenerator=null;this.dBuffer=null;this.requestDBuffer=false;this.info={memory:new s.MemoryInfo(),render:new s.RenderInfo()};this.float32MatrixTemp=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.float32MatrixTemp.setDoubles=function(cC){var cD=this;cD[0]=cC[0];cD[1]=cC[1];cD[2]=cC[2];cD[4]=cC[4];cD[5]=cC[5];cD[6]=cC[6];cD[8]=cC[8];cD[9]=cC[9];cD[10]=cC[10];cD[12]=cC[12];cD[13]=cC[13];cD[14]=cC[14];return this};this._createDummyTexture=function(){var cC=new Uint8Array(2*2*4);for(var cE=0;cE<2*2;cE++){cC[4*cE]=0;cC[4*cE+1]=0;cC[4*cE+2]=0;cC[4*cE+3]=255}var cD=new s.DataTexture(cC,2,2,s.RGBAFormat,s.UnsignedByteType,new s.LatLongReflectionMapping(),s.ClampToEdgeWrapping,s.ClampToEdgeWrapping,s.LinearFilter,s.LinearFilter);cD.generateMipmaps=false;cD.needsUpdate=true;return cD};this._dummyTexture=this._createDummyTexture();this._clipPlanesState={uniforms:{nbClipPlanes:{type:"i",value:0,clipPlanesUniform:true},clipPlaneEquations:{type:"fv4",value:[],clipPlanesUniform:true},clipPlaneActive:{type:"iv1",value:[],clipPlanesUniform:true},clipFrontOpacity:{type:"f",value:1,clipPlanesUniform:true},clipBackOpacity:{type:"f",value:0,clipPlanesUniform:true},polygonSize:{type:"i",value:0,clipPlanesUniform:true},polygonPoints:{type:"t",value:null,clipPlanesUniform:true},extrusionPlaneU:{type:"v3",value:new s.Vector3(0,0,1),clipPlanesUniform:true},extrusionPlaneV:{type:"v3",value:new s.Vector3(1,0,0),clipPlanesUniform:true}},version:-1,disabled:false,update:function(cN,cH,cD,cL,cM,cI){if(cD||cN!==cH||(this.disabled&&cL.enableClipPlanes)){var cE=cN&&cN.clipPlanes;var cQ=bk.clipPlanesEnabled?bk.clipPlanes:[];var cG;if(cE){cQ=cE}var cF=[],cC,cJ;for(cG=0;cG<cQ.length&&cF.length<6;cG++){cC=cQ[cG];cJ=cC&&cC.clippingContext&&cC.clippingContext[bk.id];if(cJ&&cJ.clippingPlaneAdded){cF.push(cC)}}var cG;var cP=-1;if(cN&&cN.clippingSettings&&cN.clippingSettings.frontOpacity===0){cP=1}for(cG=0;cG<cF.length;cG++){var cK=bk.clipPlanesEnabled||cE;var cO;if(cM instanceof s.OrthographicCamera){cO=-cF[cG].normal.dot(cM.getLookAt())}else{cO=cF[cG].distanceToPoint(cM.position)}cF[cG].enabled=cK&&((bk.disableBackFaceClipPlanes==0)||cP*cO>0)}M(null,cF,cM);R(this.uniforms,S,cL&&cL.clipPlaneIndex,cN,cI);an(this.uniforms,cN?cN.clipPolyLine:null);this.disabled=false;this.version++}else{if(!this.disabled&&!cL.enableClipPlanes){this.disabled=true;R(this.uniforms,{length:0,eqs:[],states:[]},0)}}}};this.getPickingRenderPointMode=function(){var cC=0;switch(this.pickPointsMode){case 1:cC=s.AllPointsRenderPointMask;break;case 2:cC=this.renderPointMode;break;case 3:cC=(~this.renderPointMode)&255;break;default:}return cC};this.__glResources__={renderTarget:{},geometry:[],geometryNullCount:0,texture:[],textureLODPool:new s.TextureLODPool(),removeGeometryList:function(cF){var cE=new Set();cF.forEach(function(cI,cH,cJ){cE.add(cI.id)});var cC=0;for(var cD=0;cD<this.geometry.length;cD++){var cG=this.geometry[cD];if(cG&&cE.has(cG.object.id)){cC++;cE["delete"](cG.object.id);this.geometry[cD]=null;this.geometryNullCount++;if(cC===cF.size){break}}}this.tryClean()},tryClean:function(){if(this.geometryNullCount>=100){this.geometry=this.geometry.filter(function(cC){return cC!==null});this.geometryNullCount=0}}};this.restoreGLContext=function(){console.log("restore context");b4();cj=[];a7=0;w._currentProgram=null;var cN=bk.info.memory.programs;bk.info.memory.programs=0;bk.info.memory.sharedbuffers=0;bk.info.memory.geometries=0;var cD=this.__glResources__.geometry;console.log("restore "+cD.length+" geometries");var cC=[];for(var cJ=0;cJ<cD.length;cJ++){if(!cD[cJ]){continue}var cO=cD[cJ].object.geometry;if(!cO){continue}if(cO.length){for(var cG=0;cG<cO.length;cG++){cO[cG].vertexBuffer=null}}else{cD[cJ].object.__webglInit=false;cO.__webglVertexBuffer=null;if(cO.geometryGroups){for(var cL in cO.geometryGroups){var cF=cO.geometryGroups[cL];cF.__webglVertexBuffer=null}}}var cI=bk.initObject(cD[cJ].object);if(cI){cC.push(cD[cJ])}}this.initSharedBuffersDS(cC,true);bk.info.memory.textures=0;var cP=this.__glResources__.texture;console.log("restore "+cP.length+" textures");for(var cJ=0;cJ<cP.length;cJ++){var cM=cP[cJ];cM.needsUpdate=true;cM.__webglInit=false;if(cM.image.__webglTextureCube){cM.image.__webglTextureCube=null}else{if(cM.__webglTexture){cM.__webglTexture=null}}}var cH=this.__glResources__.renderTarget;var cK=0;for(var cJ in cH){var cE=cH[cJ];if(cE){cE.__webglFramebuffer=null;cE.__webglRenderbuffer=null;cE.__webglTexture=null;cK++}}console.log("restore "+cK+" render targets")};var bk=this,cj=[],a7=0,bA=-1,bz=-1,ac=null,bB=null,bg=null,aL=null,bI=null,aK=null,aA=0,bP=0,aJ=-1,W=1,bQ=-1,bX=-1,E=-1,b1=1,aR=-1,cq=-1,a0=-1,u=-1,cd=-1,ct=-1,be=null,cp=null,bL=null,bZ=1,bD=0,bC=0,cs=0,bq=0,A=false,b8=new s.Frustum(),bw=new s.Matrix4(),ad=new s.Matrix4(),aB=new s.Vector3(),az=new s.Vector4(),bh=new s.Vector3(),cB=true,ao=0,b3={ambient:[0,0,0],shFactors:[null,null,null],directional:{length:0,colors:[],positions:[],nears:[],fars:[]},point:{length:0,colors:[],positions:[],physicalAttenuations:[],distances:[]},spot:{length:0,colors:[],positions:[],physicalAttenuations:[],distances:[],directions:[],anglesCos:[],innerAnglesCos:[]},hemi:{length:0,skyColors:[],groundColors:[],positions:[]},sphere:{length:0,colors:[],positions:[],data:[]},area:{length:0,colors:[],positions:[],normals:[],rights:[],ups:[],data:[]},disk:{length:0,colors:[],positions:[],normals:[],data:[]},tube:{length:0,colors:[],positions:[],rights:[],data:[]},ies:{length:0,colors:[],positions:[],distances:[],iesLightTexture:[],matrixWorldInv:[]}};var S={length:0,eqs:[],states:[]};var w;var G;var ai;var cg;var Z;var bO;var L;var bb;var J;var I;var b0;var bM;var at;this.fixedSizeArrayPool=new d();b4(bj.context,bj.debugContext);bN();this.dispose=function(){var cC;for(cC=0;cC<this.renderPluginsPre.length;cC++){this.renderPluginsPre[cC].dispose&&this.renderPluginsPre[cC].dispose()}for(cC=0;cC<this.renderPluginsPost.length;cC++){this.renderPluginsPost[cC].dispose&&this.renderPluginsPost[cC].dispose()}if(this.ambianceGenerators){this.ambianceGenerators=null}if(this.sssGenerator&&this.sssGenerator.ready){this.sssGenerator.dispose();this.sssGenerator=null}this.renderPluginsPre=[];this.renderPluginsPost=[];this.fixedSizeArrayPool=null;this.getContext=null;bk=null;w=null;cj=null;aF=null;bu=null;this.__glResources__=null;this.context=null;bg=null;bB=null};this.setPickingPriorityMapping=function(cJ,cF){if(!cJ){cF._pickingPriorityMapping=null;return}var cG=function(cM,cL){if(cM.priority<cL.priority){return -1}if(cM.priority>cL.priority){return 1}return 0};cJ.sort(cG);var cH={};var cI=null;var cC=0;for(var cD=0;cD<cJ.length;cD++){var cK=cJ[cD];if(cK.priority>0){if(!cI||(cI.priority!==cK.priority)){cC++;var cE=cF.getDisplayListByName("PICKING_H"+cC);if(!cE){cE=cF.addDisplayList(new s.DisplayList({name:"PICKING_H"+cC,priority:-cC,zSort:s.FrontToBack,side:a.FrontSide,polygonOffset:false,pickingPriority:true}))}}cH[cK.id]=cE}else{if(cK.priority===0){cH[cK.id]=null}}cI=cK}cI=null;cC=0;for(var cD=cJ.length-1;cD>=0;cD--){var cK=cJ[cD];if(cK.priority<0){if(!cI||(cI.priority!==cK.priority)){cC--;var cE=cF.getDisplayListByName("PICKING_L"+(-cC));if(!cE){cE=cF.addDisplayList(new s.DisplayList({name:"PICKING_L"+(-cC),priority:2048+(-cC),zSort:s.FrontToBack,side:a.FrontSide,polygonOffset:false,pickingPriority:true}));this.resetGSSOCache()}}cH[cK.id]=cE}cI=cK}cF._pickingPriorityMapping=cH};this.setCurrentPass=function(cC){this.currentPass=cC};this._stateSortingResult=new s.StateSortingResult();this._stateSortingResult.init();this.context=w;var cl=w.getParameter(w.MAX_TEXTURE_IMAGE_UNITS);var v=w.getParameter(w.MAX_VERTEX_TEXTURE_IMAGE_UNITS);var aa=w.getParameter(w.MAX_TEXTURE_SIZE);var aV=w.getParameter(w.MAX_CUBE_MAP_TEXTURE_SIZE);var ch=L?w.getParameter(L.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0;var br=(v>0);var aG=br&&G;var ce=bb?w.getParameter(w.COMPRESSED_TEXTURE_FORMATS):[];var cb=w.getShaderPrecisionFormat(w.VERTEX_SHADER,w.HIGH_FLOAT);var cr=w.getShaderPrecisionFormat(w.VERTEX_SHADER,w.MEDIUM_FLOAT);var co=w.getShaderPrecisionFormat(w.VERTEX_SHADER,w.LOW_FLOAT);var aU=w.getShaderPrecisionFormat(w.FRAGMENT_SHADER,w.HIGH_FLOAT);var ck=w.getShaderPrecisionFormat(w.FRAGMENT_SHADER,w.MEDIUM_FLOAT);var a5=w.getShaderPrecisionFormat(w.FRAGMENT_SHADER,w.LOW_FLOAT);var F=w.getShaderPrecisionFormat(w.VERTEX_SHADER,w.HIGH_INT);var bc=w.getShaderPrecisionFormat(w.VERTEX_SHADER,w.MEDIUM_INT);var aq=w.getShaderPrecisionFormat(w.VERTEX_SHADER,w.LOW_INT);var ca=w.getShaderPrecisionFormat(w.FRAGMENT_SHADER,w.HIGH_INT);var V=w.getShaderPrecisionFormat(w.FRAGMENT_SHADER,w.MEDIUM_INT);var bW=w.getShaderPrecisionFormat(w.FRAGMENT_SHADER,w.LOW_INT);var cu=cb.precision>0&&aU.precision>0;var bV=cr.precision>0&&ck.precision>0;if(D==="highp"&&!cu){if(bV){D="mediump";console.warn("WebGLRenderer: highp not supported, using mediump")}else{D="lowp";console.warn("WebGLRenderer: highp and mediump not supported, using lowp")}}if(D==="mediump"&&!bV){D="lowp";console.warn("WebGLRenderer: mediump not supported, using lowp")}this.getContext=function(){return w};this.supportsVertexTextures=function(){return br};this.supportsFloatTextures=function(){return(G&&J)};this.supportsFloatLinearTextures=function(){return Z};this.supportsStandardDerivatives=function(){return bO};this.supportsCompressedTextureS3TC=function(){return bb};this.supportsMinMaxBlending=function(){return at};this.supportsElementIndexUint=function(){return b0};this.getMaxAnisotropy=function(){return ch};this.getPrecision=function(){return D};this.setGLSize=function(cI,cD,cE,cF){var cC=window.devicePixelRatio||1;bu.width=Math.floor(cI*cC);bu.height=Math.floor(cD*cC);if(this._VRCompatible){bu.style.width="100%";bu.style.height="100%"}else{bu.style.width=cI+"px";bu.style.height=cD+"px"}this.setViewport(0,0,Math.floor(cE*cC),Math.floor(cF*cC));Q=cI;b6=cD;aD=Q/2;T=b6/2;aF.style.width=cI+"px";aF.style.height=cD+"px";for(var cH=0;cH<aF.childNodes.length;cH++){var cG=aF.childNodes[cH];cG.style.width=cI+"px";cG.style.height=cD+"px"}};this.setViewport=function(cE,cJ,cH,cD){var cG=bD,cF=bC,cC=cs,cI=bq;bD=cE!==undefined?cE:0;bC=cJ!==undefined?cJ:0;cs=cH!==undefined?cH:bu.width;bq=cD!==undefined?cD:bu.height;if(bD!==cG||bC!==cF||cs!==cC||bq!==cI){w.viewport(bD,bC,cs,bq)}s.glStates.currentWidth=cs;s.glStates.currentHeight=bq};this.removeSplitScreenMode=function(){if(this.splitScreenMode){this.activateSplitScreenMode(false);this.splitScreenMode=null}};this.setSplitScreenMode=function(cC,cD){this.splitScreenMode={x:cC,y:cD,active:false};this.activateSplitScreenMode(true)};this.activateSplitScreenMode=function(cC){if(this.splitScreenMode){if(cC!==this.splitScreenMode.active){if(cC){this.setScissor(this.splitScreenMode.x,this.splitScreenMode.y,cs,bq);this.enableScissorTest(true);this.setViewport(this.splitScreenMode.x,this.splitScreenMode.y,cs,bq)}else{this.enableScissorTest(false);this.setViewport(0,0,cs,bq)}this.splitScreenMode.active=cC?true:false}}};this.getViewportSize=function(){return{width:cs,height:bq}};this.getViewport=function(){return{width:cs,height:bq,x:bD,y:bC}};this.setScissor=function(cD,cF,cE,cC){w.scissor(cD,cF,cE,cC)};this.enableScissorTest=function(cC){A=cC;cC?w.enable(w.SCISSOR_TEST):w.disable(w.SCISSOR_TEST)};this.getScissorTest=function(){return A};this.setClearColorHex=function(cC,cD){b7.setHex(cC);aC=cD;w.clearColor(b7.r,b7.g,b7.b,aC)};this.setClearColor=function(cC,cD){b7.copy(cC);aC=cD;w.clearColor(b7.r,b7.g,b7.b,aC)};this.getClearColor=function(){return b7};this.getClearAlpha=function(){return aC};this.clear=function(cD,cG,cE){var cF=0;if(cD===undefined||cD){cF|=w.COLOR_BUFFER_BIT}if(cG===undefined||cG){cF|=w.DEPTH_BUFFER_BIT}var cC=false;if(cE===undefined||cE){cC=true;cF|=w.STENCIL_BUFFER_BIT;this.setStencilWrite(true)}w.clear(cF);if(cC&&!this.enableStencilWrite){this.setStencilWrite(false)}};this.clearTarget=function(cE,cC,cF,cD){this.setRenderTarget(cE);this.clear(cC,cF,cD)};this.setPreviousNormalDepthBuffer=function(cC){this.prevNormalDepthBuffer=cC};this.setPreviousColorBuffer=function(cC){this.prevColorBuffer=cC};this.addPostPlugin=function(cC){cC.init(this);this.renderPluginsPost.push(cC)};this.addPrePlugin=function(cC){cC.init(this);this.renderPluginsPre.push(cC)};this.updateShadowMap=function(cD,cC){w._currentProgram=null;w._oldBlending=-1;u=-1;cd=-1;ac=-1;bB=-1;bA=-1;bz=-1;aL=null;bI=null;aK=null;cB=true;bX=-1;E=-1;this.shadowMapPlugin.update(cD,cC)};function ae(cC){cC.__webglVertexBuffer=w.createBuffer();cC.__webglColorBuffer=w.createBuffer();bk.info.memory.geometries++}function aM(cC){cC.__webglVertexBuffer=w.createBuffer();cC.__webglColorBuffer=w.createBuffer();cC.__webglLineDistanceBuffer=w.createBuffer();bk.info.memory.geometries++}function ba(cD){cD.__webglVertexBuffer=w.createBuffer();cD.__webglNormalBuffer=w.createBuffer();cD.__webglTangentBuffer=w.createBuffer();cD.__webglColorBuffer=w.createBuffer();cD.__webglUVBuffer=w.createBuffer();cD.__webglUV2Buffer=w.createBuffer();cD.__webglSkinIndicesBuffer=w.createBuffer();cD.__webglSkinWeightsBuffer=w.createBuffer();cD.__webglFaceBuffer=w.createBuffer();cD.__webglLineBuffer=w.createBuffer();var cC,cE;if(cD.numMorphTargets){cD.__webglMorphTargetsBuffers=[];for(cC=0,cE=cD.numMorphTargets;cC<cE;cC++){cD.__webglMorphTargetsBuffers.push(w.createBuffer())}}if(cD.numMorphNormals){cD.__webglMorphNormalsBuffers=[];for(cC=0,cE=cD.numMorphNormals;cC<cE;cC++){cD.__webglMorphNormalsBuffers.push(w.createBuffer())}}bk.info.memory.geometries++}var bt=function(cC){return Math.abs(cC)<0.000001?0:cC};var U=function(cC){var cD=cC.elements;return"matrix3d("+bt(cD[0])+","+bt(-cD[1])+","+bt(cD[2])+","+bt(cD[3])+","+bt(cD[4])+","+bt(-cD[5])+","+bt(cD[6])+","+bt(cD[7])+","+bt(cD[8])+","+bt(-cD[9])+","+bt(cD[10])+","+bt(cD[11])+","+bt(cD[12])+","+bt(-cD[13])+","+bt(cD[14])+","+bt(cD[15])+")"};var aO=function(cC){var cD=cC.elements;return"translate3d(-50%,-50%,0) matrix3d("+bt(cD[0])+","+bt(cD[1])+","+bt(cD[2])+","+bt(cD[3])+","+bt(-cD[4])+","+bt(-cD[5])+","+bt(-cD[6])+","+bt(-cD[7])+","+bt(cD[8])+","+bt(cD[9])+","+bt(cD[10])+","+bt(cD[11])+","+bt(cD[12])+","+bt(cD[13])+","+bt(cD[14])+","+bt(cD[15])+")"};var bv=function(cC){var cD=cC.target;cD.removeEventListener("dispose",bv);cv(cD);bk.info.memory.geometries--};var aZ=function(cC){var cD=cC.target;cD.removeEventListener("dispose",aZ);cD.deallocate(w,bk.info)};var aP=function(cD){var cC=cD.target;cC.removeEventListener("dispose",aP);ah(cC);if(cC.textures){cC.usedTexture=-1}bk.info.memory.textures--};var ax=function(cD){var cE=cD.target;cE.removeEventListener("dispose",ax);a8(cE);bk.info.memory.textures--;var cC=bk.__glResources__.renderTarget;if(cC[cE.uniqueID]){delete (cC[cE.uniqueID])}};var bU=function(cE){var cD=cE.target;cD.removeEventListener("dispose",bU);var cC=cD.program!==null?cD.program.program:null;av(cD,cC,true)};var cv=function(cE){cE.__webglInit=undefined;if(cE.__webglVertexBuffer!==undefined){w.deleteBuffer(cE.__webglVertexBuffer)}if(cE.__webglNormalBuffer!==undefined){w.deleteBuffer(cE.__webglNormalBuffer)}if(cE.__webglTangentBuffer!==undefined){w.deleteBuffer(cE.__webglTangentBuffer)}if(cE.__webglColorBuffer!==undefined){w.deleteBuffer(cE.__webglColorBuffer)}if(cE.__webglUVBuffer!==undefined){w.deleteBuffer(cE.__webglUVBuffer)}if(cE.__webglUV2Buffer!==undefined){w.deleteBuffer(cE.__webglUV2Buffer)}if(cE.__webglTangentBuffer!==undefined){w.deleteBuffer(cE.__webglTangentBuffer)}if(cE.__webglBinormalBuffer!==undefined){w.deleteBuffer(cE.__webglBinormalBuffer)}if(cE.__webglSkinIndicesBuffer!==undefined){w.deleteBuffer(cE.__webglSkinIndicesBuffer)}if(cE.__webglSkinWeightsBuffer!==undefined){w.deleteBuffer(cE.__webglSkinWeightsBuffer)}if(cE.__webglFaceBuffer!==undefined){w.deleteBuffer(cE.__webglFaceBuffer)}if(cE.__webglLineBuffer!==undefined){w.deleteBuffer(cE.__webglLineBuffer)}if(cE.__webglLineDistanceBuffer!==undefined){w.deleteBuffer(cE.__webglLineDistanceBuffer)}if(cE.geometryGroups!==undefined){for(var cD in cE.geometryGroups){var cC=cE.geometryGroups[cD];ay(cC)}}};var ah=function(cD){var cC=bk.__glResources__.texture.indexOf(cD);if(cC>=0){bk.__glResources__.texture.splice(cC,1)}if(cD.image&&cD.image.__webglTextureCube){w.deleteTexture(cD.image.__webglTextureCube)}else{if(!cD.__webglInit){return}cD.__webglInit=false;w.deleteTexture(cD.__webglTexture)}};var a8=function(cD){if(!cD||!cD.__webglTexture){return}w.deleteTexture(cD.__webglTexture);if(cD instanceof s.WebGLRenderTargetCube){for(var cC=0;cC<6;cC++){w.deleteFramebuffer(cD.__webglFramebuffer[cC]);w.deleteRenderbuffer(cD.__webglRenderbuffer[cC])}}else{w.deleteFramebuffer(cD.__webglFramebuffer);w.deleteRenderbuffer(cD.__webglRenderbuffer)}};var av=function(cI,cE,cJ){if(cE===null){return}if(cJ){cI.programManager.dispose(av);if(cI.isPhysicalMaterial&&bk.ambianceGenerators){bk.ambianceGenerators.decreaseUseCount(cI.id)}if(cI.isPhysicalMaterial&&bk.sssGenerator&&cI.sssLUT){bk.sssGenerator.decreaseUseCount(cI.sssLUT.id)}if(cI._deferredMaterialsInit){s.cleanDeferredCache(cI.id);cI._deferredMaterialsInit=false;cI._deferredMaterials=[];for(var cF=0;cF<s.MaterialToUse.totalMaterial;cF++){cI._deferredMaterials[cF]=null}cI._deferredMaterials[s.MaterialToUse.originalMaterial]=cI;if(cI.backMaterial){cI._deferredMaterials[s.MaterialToUse.pickingMaterial]&&cI._deferredMaterials[s.MaterialToUse.pickingMaterial].dispose()}cI.needsUpdate=true}return}cI.program=null;var cF,cD,cH;var cG=false;for(cF=0,cD=cj.length;cF<cD;cF++){cH=cj[cF];if(cH.program!==null&&cH.program.program===cE){cH.usedTimes--;if(cH.usedTimes===0){cG=true}break}}if(cG===true){var cC=[];for(cF=0,cD=cj.length;cF<cD;cF++){cH=cj[cF];if(cH.program!==null&&cH.program.program!==cE){cC.push(cH)}}cj=cC;w.deleteProgram(cE);bk.info.memory.programs--}};function ay(cD){w.deleteBuffer(cD.__webglVertexBuffer);w.deleteBuffer(cD.__webglNormalBuffer);w.deleteBuffer(cD.__webglTangentBuffer);w.deleteBuffer(cD.__webglColorBuffer);w.deleteBuffer(cD.__webglUVBuffer);w.deleteBuffer(cD.__webglUV2Buffer);w.deleteBuffer(cD.__webglSkinIndicesBuffer);w.deleteBuffer(cD.__webglSkinWeightsBuffer);w.deleteBuffer(cD.__webglFaceBuffer);w.deleteBuffer(cD.__webglLineBuffer);var cC,cE;if(cD.numMorphTargets){for(cC=0,cE=cD.numMorphTargets;cC<cE;cC++){w.deleteBuffer(cD.__webglMorphTargetsBuffers[cC])}}if(cD.numMorphNormals){for(cC=0,cE=cD.numMorphNormals;cC<cE;cC++){w.deleteBuffer(cD.__webglMorphNormalsBuffers[cC])}}bk.info.memory.geometries--}function cm(cE,cC){var cD=cE.vertices.length;cE.__vertexArray=new Float32Array(cD*3);cE.__colorArray=new Float32Array(cD*3);cE.__sortArray=[];cE.__webglParticleCount=cD}function aj(cE,cC){var cD=cE.vertices.length;cE.__vertexArray=new Float32Array(cD*3);cE.__colorArray=new Float32Array(cD*3);cE.__lineDistanceArray=new Float32Array(cD*1);cE.__webglLineCount=cD}function aT(cG,cF){var cM=cF.geometry,cP=cG.faces3,cO=cG.faces4,cC=cP.length*3+cO.length*4,cI=cP.length*1+cO.length*2,cN=cP.length*3+cO.length*4,cJ=ak(cF,cG),cK=b9(cJ),cE=bn(cJ),cL=cn(cJ);cG.__vertexArray=new Float32Array(cC*3);if(cE){cG.__normalArray=new Float32Array(cC*3)}if(cM.hasTangents){cG.__tangentArray=new Float32Array(cC*4)}if(cL){cG.__colorArray=new Float32Array(cC*3)}if(cK){if(cM.faceUvs.length>0||cM.faceVertexUvs.length>0){cG.__uvArray=new Float32Array(cC*2)}if(cM.faceUvs.length>1||cM.faceVertexUvs.length>1){cG.__uv2Array=new Float32Array(cC*2)}}if(cF.geometry.skinWeights.length&&cF.geometry.skinIndices.length){cG.__skinIndexArray=new Float32Array(cC*4);cG.__skinWeightArray=new Float32Array(cC*4)}cG.__faceArray=new Uint16Array(cI*3);cG.__lineArray=new Uint16Array(cN*2);var cD,cH;if(cG.numMorphTargets){cG.__morphTargetsArrays=[];for(cD=0,cH=cG.numMorphTargets;cD<cH;cD++){cG.__morphTargetsArrays.push(new Float32Array(cC*3))}}if(cG.numMorphNormals){cG.__morphNormalsArrays=[];for(cD=0,cH=cG.numMorphNormals;cD<cH;cD++){cG.__morphNormalsArrays.push(new Float32Array(cC*3))}}cG.__webglFaceCount=cI*3;cG.__webglLineCount=cN*2;cG.__inittedArrays=true}function ak(cD,cC){return cD.material instanceof s.MeshFaceMaterial?cD.material.materials[cC.materialIndex]:cD.material}function cf(cC){return cC&&cC.shading!==undefined&&cC.shading===s.SmoothShading}function bn(cC){if((cC instanceof s.MeshBasicMaterial&&!cC.envMap)){return false}if(cf(cC)){return s.SmoothShading}else{return s.FlatShading}}function cn(cC){if(cC.vertexColors){return cC.vertexColors}return false}function b9(cC){if(cC.map||cC.lightMap||cC.bumpMap||cC.normalMap||cC.specularMap||cC instanceof s.ShaderMaterial){return true}return false}function ab(cF){var cC,cE,cD;for(cC in cF.attributes){if(cC==="index"){cD=w.ELEMENT_ARRAY_BUFFER}else{cD=w.ARRAY_BUFFER}cE=cF.attributes[cC];cE.buffer=w.createBuffer();w.bindBuffer(cD,cE.buffer);w.bufferData(cD,cE.array,w.STATIC_DRAW)}}s.bufferIDCount=0;s.vertexComponentBits={POSITION:1,NORMAL:2,UV:4,UV2:8,COLOR:16,TANGENT:32,BINORMAL:64,PREVIOUSPOS:128,NEXTPOS:256,SIDEEXTR:512,LINEDIST:1024,SKININDEX:2048,SKINWEIGHT:4096};this.sharingIntermediaryArray=null;this.sharingIntermediaryIndexArray=null;this.newMaterialInheritance=false;this.initSharedBuffersDS=function(de,c3){if(de.length==0){return}var c2=s.vertexComponentBits;var cN=2097152;var c5=Number.MAX_SAFE_INTEGER;var cF=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;if(cF){var db=parseFloat(navigator.userAgent.substr(navigator.userAgent.length-4));if(db>=60){c5=250}}var cK=!!navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform);var cL=navigator.userAgent.toLowerCase().indexOf("edge")>-1;var dd=cK&&!cL;var cO=[];var c8={};var cC={};var cH=[];for(var da=de.length-1;da>=0;da--){var cP=de[da].object.geometry;var cV=de[da];de.splice(da,1);if(cP._type===2){cP=[cP]}for(var c9=0;c9<cP.length;c9++){var cM=cP[c9];if(!cM){continue}if(cM.vertexBuffer&&cM.vertexBuffer.isShared){continue}if(cC[cM.id]){cH.push(cV);continue}if(!cM.vertexIndexArray){console.warn("no geometry available, are you trying to reattach a mesh while noMeshInRAM has been activated?");continue}cC[cM.id]=true;var dc=(cM.vertexPositionArray?c2.POSITION:0)+(cM.vertexNormalArray?c2.NORMAL:0)+(cM.vertexUvArray?c2.UV:0)+(cM.vertexUv2Array?c2.UV2:0)+(cM.vertexColorArray?c2.COLOR:0)+(cM.vertexTangentArray?c2.TANGENT:0)+(cM.vertexBinormalArray?c2.BINORMAL:0)+(cM.vertexPreviousPositionArray?c2.PREVIOUSPOS:0)+(cM.vertexNextPositionArray?c2.NEXTPOS:0)+(cM.vertexSideExtrusionArray?c2.SIDEEXTR:0)+(cM.vertexLineDistancesArray?c2.LINEDIST:0)+(cM.vertexSkinIndexArray?c2.SKININDEX:0)+(cM.vertexSkinWeightArray?c2.SKINWEIGHT:0);var cE=c8[dc];if(!cE){cE={webglObjects:[],geoms:[],type:dc,dgCount:0,verticeCount:0,indexCount:0,initialize:c3};c8[dc]=cE;cO.push(cE)}cE.geoms.push(cM);cE.verticeCount+=cM.compressedVertices?cM.vertexPositionArray.length/2:cM.vertexPositionArray.length/3;cE.indexCount+=cM.vertexIndexArray.length;cE.dgCount+=cM.drawingGroups.length;cE.webglObjects.push(cV);if(cE.verticeCount>cN||cE.dgCount>c5){cE.initialize=true;c8[dc]=null}}}for(var c1=0;c1<cO.length;c1++){var cE=cO[c1];if(cE.initialize){var cR=cE.geoms.length>0&&cE.geoms[0].compressedNormals;var cJ=cE.geoms.length>0&&cE.geoms[0].compressedVertices;var cZ=new s.InterleavedBuffer(cE.type,w,s.bufferIDCount++,c2,cR,cJ);cZ.numItems=cE.verticeCount;cZ.indexNumItems=cE.indexCount;cZ.nbGeometries=cE.geoms.length;cZ.geometries=cE.geoms;cZ.isShared=true;bk.info.memory.sharedbuffers++;var cU=cZ.itemSize*cE.verticeCount;var cG=null;var c0=null;w.bindBuffer(w.ARRAY_BUFFER,cZ.buffer);if(!dd){if(this.sharingIntermediaryArray&&this.sharingIntermediaryArray.length>=cU){cG=this.sharingIntermediaryArray}else{cG=new Float32Array(cZ.itemSize*cE.verticeCount);this.sharingIntermediaryArray=cG}if(this.sharingIntermediaryIndexArray&&this.sharingIntermediaryIndexArray.length>=cZ.indexNumItems){c0=this.sharingIntermediaryIndexArray}else{if(s.supportedExtensions.elementIndexUint){c0=new Uint32Array(cZ.indexNumItems)}else{c0=new Uint16Array(cZ.indexNumItems)}this.sharingIntermediaryIndexArray=c0}}else{w.bufferData(w.ARRAY_BUFFER,cU*4,w.STATIC_DRAW)}var c7=0;var cY=new Uint32Array(cE.geoms.length);for(var c4=0;c4<cE.geoms.length;c4++){var cM=cE.geoms[c4];if(cM.vertexBuffer){cM.deallocate(w,bk.info)}cM.vertexBuffer=cZ;cM.itemSize=1;cM.numItems=cM.vertexIndexArray.length;cM.use32bitIndexBuffer=s.supportedExtensions.elementIndexUint&&(!dd||cZ.numItems>65535);if(cM.use32bitIndexBuffer){cM.numBytesIndex=4;cM.glFormatTypeIndex=w.UNSIGNED_INT}cM._setAttributesSizeAndOffset();var cS=cJ?cM.vertexPositionArray.length/2:cM.vertexPositionArray.length/3;cM.verticeCount=cS;var cW=c7;cY[c4]=c7;if(dd){cG=new Float32Array(cZ.itemSize*cS);var c7=0}for(var da=0;da<cS;++da){if(cM.compressedVertices){cG[c7++]=cM.vertexPositionArray[2*da];cG[c7++]=cM.vertexPositionArray[2*da+1]}else{cG[c7++]=cM.vertexPositionArray[3*da];cG[c7++]=cM.vertexPositionArray[3*da+1];cG[c7++]=cM.vertexPositionArray[3*da+2]}if(cM.vertexNormalArray){if(cM.compressedNormals){cG[c7++]=cM.vertexNormalArray[da]}else{cG[c7++]=cM.vertexNormalArray[3*da];cG[c7++]=cM.vertexNormalArray[3*da+1];cG[c7++]=cM.vertexNormalArray[3*da+2]}}if(cM.vertexUvArray){cG[c7++]=cM.vertexUvArray[3*da];cG[c7++]=cM.vertexUvArray[3*da+1]}if(cM.vertexUv2Array){cG[c7++]=cM.vertexUv2Array[3*da];cG[c7++]=cM.vertexUv2Array[3*da+1]}if(cM.vertexColorArray){cG[c7++]=cM.vertexColorArray[4*da];cG[c7++]=cM.vertexColorArray[4*da+1];cG[c7++]=cM.vertexColorArray[4*da+2];cG[c7++]=cM.vertexColorArray[4*da+3]}if(cM.vertexTangentArray){cG[c7++]=cM.vertexTangentArray[3*da];cG[c7++]=cM.vertexTangentArray[3*da+1];cG[c7++]=cM.vertexTangentArray[3*da+2]}if(cM.vertexBinormalArray){cG[c7++]=cM.vertexBinormalArray[3*da];cG[c7++]=cM.vertexBinormalArray[3*da+1];cG[c7++]=cM.vertexBinormalArray[3*da+2]}if(cM.vertexPreviousPositionArray){cG[c7++]=cM.vertexPreviousPositionArray[3*da];cG[c7++]=cM.vertexPreviousPositionArray[3*da+1];cG[c7++]=cM.vertexPreviousPositionArray[3*da+2]}if(cM.vertexNextPositionArray){cG[c7++]=cM.vertexNextPositionArray[3*da];cG[c7++]=cM.vertexNextPositionArray[3*da+1];cG[c7++]=cM.vertexNextPositionArray[3*da+2]}if(cM.vertexSideExtrusionArray){cG[c7++]=cM.vertexSideExtrusionArray[da]}if(cM.vertexLineDistancesArray){cG[c7++]=cM.vertexLineDistancesArray[2*da];cG[c7++]=cM.vertexLineDistancesArray[2*da+1]}if(cM.vertexSkinIndexArray){cG[c7++]=cM.vertexSkinIndexArray[4*da];cG[c7++]=cM.vertexSkinIndexArray[4*da+1];cG[c7++]=cM.vertexSkinIndexArray[4*da+2];cG[c7++]=cM.vertexSkinIndexArray[4*da+3]}if(cM.vertexSkinWeightArray){cG[c7++]=cM.vertexSkinWeightArray[4*da];cG[c7++]=cM.vertexSkinWeightArray[4*da+1];cG[c7++]=cM.vertexSkinWeightArray[4*da+2];cG[c7++]=cM.vertexSkinWeightArray[4*da+3]}}if(dd){c7+=cW;w.bufferSubData(w.ARRAY_BUFFER,cW*4,cG)}if(cM.noMeshInRAM){cM.vertexPositionArray=null;if(cM.vertexNormalArray){cM.vertexNormalArray=null}if(cM.vertexUvArray){cM.vertexUvArray=null}if(cM.vertexUv2Array){cM.vertexUv2Array=null}if(cM.vertexColorArray){cM.vertexColorArray=null}if(cM.vertexTangentArray){cM.vertexTangentArray=null}if(cM.vertexBinormalArray){cM.vertexBinormalArray=null}if(cM.vertexPreviousPositionArray){cM.vertexPreviousPositionArray=null}if(cM.vertexNextPositionArray){cM.vertexNextPositionArray=null}if(cM.vertexSideExtrusionArray){cM.vertexSideExtrusionArray=null}if(cM.vertexLineDistancesArray){cM.vertexLineDistancesArray=null}if(cM.vertexSkinIndexArray){cM.vertexSkinIndexArray=null}if(cM.vertexSkinWeightArray){cM.vertexSkinWeightArray=null}}bk.info.memory.geometries++}if(!dd){w.bufferData(w.ARRAY_BUFFER,cG.subarray(0,cU),w.STATIC_DRAW)}w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,cZ.indexBuffer);if(dd){if(cM.use32bitIndexBuffer){w.bufferData(w.ELEMENT_ARRAY_BUFFER,cZ.indexNumItems*4,w.STATIC_DRAW)}else{w.bufferData(w.ELEMENT_ARRAY_BUFFER,cZ.indexNumItems*2,w.STATIC_DRAW)}}var cI=0;for(var c4=0;c4<cE.geoms.length;c4++){var cM=cE.geoms[c4];cM.indexOffset=cI;var cX=cI;var c6=cM.vertexIndexArray.length;var cT=cY[c4]/cZ.itemSize;if(dd){if(cM.use32bitIndexBuffer){c0=new Uint32Array(c6)}else{c0=new Uint16Array(c6)}cI=0}for(var da=0;da<c6;++da){c0[cI++]=cT+cM.vertexIndexArray[da]}if(cM.noMeshInRAM){cM.vertexIndexArray=null}if(dd){cI+=cX;w.bufferSubData(w.ELEMENT_ARRAY_BUFFER,cX*cM.numBytesIndex,c0)}}if(!dd){w.bufferData(w.ELEMENT_ARRAY_BUFFER,c0.subarray(0,cZ.indexNumItems),w.STATIC_DRAW)}for(var cD=0;cD<cE.webglObjects.length;cD++){cE.webglObjects[cD].sortKey=cZ.id}}else{for(var cD=0;cD<cE.webglObjects.length;cD++){var cQ=cE.webglObjects[cD];de.push(cQ)}}}for(var da=0;da<cH.length;da++){var cP=cH[da].object.geometry;if(cP._type===2){cP=[cP]}if(cP[0].vertexBuffer&&cP[0].vertexBuffer.isShared){cH[da].sortKey=cP[0].vertexBuffer.id}else{de.push(cH[da])}}if(c3){this.sharingIntermediaryArray=null;this.sharingIntermediaryIndexArray=null}};this.initDirectBuffersDS=function(cL,cF){var cC=s.vertexComponentBits;if(cL.vertexPositionArray&&!cL.vertexBuffer){var cM=cL.compressedVertices?cL.vertexPositionArray.length/2:cL.vertexPositionArray.length/3;cL.verticeCount=cM;var cJ;var cK=(cL.vertexPositionArray?cC.POSITION:0)+(cL.vertexNormalArray?cC.NORMAL:0)+(cL.vertexUvArray?cC.UV:0)+(cL.vertexUv2Array?cC.UV2:0)+(cL.vertexColorArray?cC.COLOR:0)+(cL.vertexTangentArray?cC.TANGENT:0)+(cL.vertexBinormalArray?cC.BINORMAL:0)+(cL.vertexPreviousPositionArray?cC.PREVIOUSPOS:0)+(cL.vertexNextPositionArray?cC.NEXTPOS:0)+(cL.vertexSideExtrusionArray?cC.SIDEEXTR:0)+(cL.vertexLineDistancesArray?cC.LINEDIST:0)+(cL.vertexSkinIndexArray?cC.SKININDEX:0)+(cL.vertexSkinWeightArray?cC.SKINWEIGHT:0);cJ=new s.InterleavedBuffer(cK,w,s.bufferIDCount++,cC,cL.compressedNormals,cL.compressedVertices);cJ.nbGeometries=1;var cO=cJ.numItems;if(cL.vertexPositionArray!==null){cL.vertexBuffer=cJ;w.bindBuffer(w.ARRAY_BUFFER,cL.vertexBuffer.buffer);cL._setAttributesSizeAndOffset();var cI=new Float32Array(cJ.itemSize*cM);var cG=0;for(var cH=0;cH<cM;++cH){if(cL.compressedVertices){cI[cG++]=cL.vertexPositionArray[2*cH];cI[cG++]=cL.vertexPositionArray[2*cH+1]}else{cI[cG++]=cL.vertexPositionArray[3*cH];cI[cG++]=cL.vertexPositionArray[3*cH+1];cI[cG++]=cL.vertexPositionArray[3*cH+2]}if(cL.vertexNormalArray){if(cL.compressedNormals){cI[cG++]=cL.vertexNormalArray[cH]}else{cI[cG++]=cL.vertexNormalArray[3*cH];cI[cG++]=cL.vertexNormalArray[3*cH+1];cI[cG++]=cL.vertexNormalArray[3*cH+2]}}if(cL.vertexUvArray){cI[cG++]=cL.vertexUvArray[3*cH];cI[cG++]=cL.vertexUvArray[3*cH+1]}if(cL.vertexUv2Array){cI[cG++]=cL.vertexUv2Array[3*cH];cI[cG++]=cL.vertexUv2Array[3*cH+1]}if(cL.vertexColorArray){cI[cG++]=cL.vertexColorArray[4*cH];cI[cG++]=cL.vertexColorArray[4*cH+1];cI[cG++]=cL.vertexColorArray[4*cH+2];cI[cG++]=cL.vertexColorArray[4*cH+3]}if(cL.vertexTangentArray){cI[cG++]=cL.vertexTangentArray[3*cH];cI[cG++]=cL.vertexTangentArray[3*cH+1];cI[cG++]=cL.vertexTangentArray[3*cH+2]}if(cL.vertexBinormalArray){cI[cG++]=cL.vertexBinormalArray[3*cH];cI[cG++]=cL.vertexBinormalArray[3*cH+1];cI[cG++]=cL.vertexBinormalArray[3*cH+2]}if(cL.vertexPreviousPositionArray){cI[cG++]=cL.vertexPreviousPositionArray[3*cH];cI[cG++]=cL.vertexPreviousPositionArray[3*cH+1];cI[cG++]=cL.vertexPreviousPositionArray[3*cH+2]}if(cL.vertexNextPositionArray){cI[cG++]=cL.vertexNextPositionArray[3*cH];cI[cG++]=cL.vertexNextPositionArray[3*cH+1];cI[cG++]=cL.vertexNextPositionArray[3*cH+2]}if(cL.vertexSideExtrusionArray){cI[cG++]=cL.vertexSideExtrusionArray[cH]}if(cL.vertexLineDistancesArray){cI[cG++]=cL.vertexLineDistancesArray[2*cH];cI[cG++]=cL.vertexLineDistancesArray[2*cH+1]}if(cL.vertexSkinIndexArray){cI[cG++]=cL.vertexSkinIndexArray[4*cH];cI[cG++]=cL.vertexSkinIndexArray[4*cH+1];cI[cG++]=cL.vertexSkinIndexArray[4*cH+2];cI[cG++]=cL.vertexSkinIndexArray[4*cH+3]}if(cL.vertexSkinWeightArray){cI[cG++]=cL.vertexSkinWeightArray[4*cH];cI[cG++]=cL.vertexSkinWeightArray[4*cH+1];cI[cG++]=cL.vertexSkinWeightArray[4*cH+2];cI[cG++]=cL.vertexSkinWeightArray[4*cH+3]}}if(cL.editable){cL.vertexBuffer.interleavedData=cI;w.bufferData(w.ARRAY_BUFFER,cI,w.DYNAMIC_DRAW)}else{w.bufferData(w.ARRAY_BUFFER,cI,w.STATIC_DRAW)}cJ.numItems+=cM;bk.info.memory.geometries++}if(cL.vertexIndexArray!==null){w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,cJ.indexBuffer);var cD=0;w.bufferData(w.ELEMENT_ARRAY_BUFFER,cL.vertexIndexArray,w.STATIC_DRAW);cL.use32bitIndexBuffer=cL.vertexIndexArray instanceof Uint32Array;if(cL.use32bitIndexBuffer){cL.numBytesIndex=4;cL.glFormatTypeIndex=w.UNSIGNED_INT}else{cL.numBytesIndex=2;cL.glFormatTypeIndex=w.UNSIGNED_SHORT}cJ.indexBuffer.itemSize=1;cL.indexOffset=cJ.indexNumItems;cJ.indexNumItems+=cL.vertexIndexArray.length;cL.itemSize=1;cL.numItems=cL.vertexIndexArray.length}cJ.geometries.push(cL);if(cL.noMeshInRAM&&!cL.sharedBuffers&&!cL.editable){if(cL.vertexPositionArray){cL.vertexPositionArray=null}if(cL.vertexIndexArray){cL.vertexIndexArray=null}if(cL.vertexNormalArray){cL.vertexNormalArray=null}if(cL.vertexUvArray){cL.vertexUvArray=null}if(cL.vertexUv2Array){cL.vertexUv2Array=null}if(cL.vertexColorArray){cL.vertexColorArray=null}if(cL.vertexTangentArray){cL.vertexTangentArray=null}if(cL.vertexBinormalArray){cL.vertexBinormalArray=null}if(cL.vertexPreviousPositionArray){cL.vertexPreviousPositionArray=null}if(cL.vertexNextPositionArray){cL.vertexNextPositionArray=null}if(cL.vertexSideExtrusionArray){cL.vertexSideExtrusionArray=null}if(cL.vertexLineDistancesArray){cL.vertexLineDistancesArray=null}if(cL.vertexSkinIndexArray){cL.vertexSkinIndexArray=null}if(cL.vertexSkinWeightArray){cL.vertexSkinWeightArray=null}}}if(cF&&cF._instancingInfos&&cF._instancingInfos.instanceAttribArrays){var cN=cF._instancingInfos.instanceAttribArrays;for(var cE in cN){if(cE!=="id"&&cN[cE].array!==null&&cN[cE].buffer===null){cN[cE].buffer=w.createBuffer();w.bindBuffer(w.ARRAY_BUFFER,cN[cE].buffer);if(cN[cE].isDynamic){w.bufferData(w.ARRAY_BUFFER,cN[cE].array,w.DYNAMIC_DRAW)}else{w.bufferData(w.ARRAY_BUFFER,cN[cE].array,w.STATIC_DRAW)}cN[cE].buffer.itemSize=cF._instancingInfos.instanceAttribArrays[cE].itemSize;cN[cE].buffer.numItems=cF._instancingInfos.nbInstances}}}};function bx(cK,cC){var cM=cK[cC];var cD=cK.vertexLayout[cC];var cI=cK.vertexBuffer.interleavedData;var cN=cK.vertexBuffer.itemSize;var cG=cN*cD.start;var cJ=(cD.isUVs);var cL=cJ?3:cD.itemSize;var cE=cL*cD.start;for(var cH=0;cH<cD.count;++cH){cG+=cD.offset/4;for(var cF=0;cF<cD.itemSize;cF++){cI[cG+cF]=cM[cE++]}if(cJ){cE++}cG+=cN-cD.offset/4}cD.needsUpdate=false;cD.start=-1;cD.count=-1}function aX(cH){var cC=cH.vertexBuffer;var cG=cC.interleavedData;var cE=cC.itemSize;var cI=4*cE*cC.start;var cD=cE*cC.count;var cF=new Float32Array(cG.buffer,cI,cD);w.bindBuffer(w.ARRAY_BUFFER,cC.buffer);w.bufferSubData(w.ARRAY_BUFFER,cI,cF);cC.needsUpdate=false;cC.start=null;cC.count=null}function bf(cH){var cC=cH.vertexIndexArray;var cE=cH.vertexLayout.vertexIndexArray;var cF=cH.use32bitIndexBuffer?4:2;var cI=cF*cE.start;var cD=cE.count;var cG=new Uint16Array(cC.buffer,cI,cD);w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,cH.vertexBuffer.indexBuffer);w.bufferSubData(w.ELEMENT_ARRAY_BUFFER,cI,cG);cE.needsUpdate=false;cE.start=-1;cE.count=-1}function bG(cD,cP,c2){var cN,c0,cY,cF,cI,cV,cG=cD.vertices,cZ=cG.length,cK=cD.colors,cJ=cK.length,cO=cD.__vertexArray,cC=cD.__colorArray,cE=cD.__sortArray,cT=cD.verticesNeedUpdate,cH=cD.elementsNeedUpdate,cQ=cD.colorsNeedUpdate,cS=cD.__webglCustomAttributesList,cW,cL,c1,cR,cM,cU,cX;if(c2.sortParticles){ad.copy(bw);ad.multiply(c2.matrixWorld);for(cN=0;cN<cZ;cN++){cY=cG[cN];aB.copy(cY);aB.applyProjection(ad);cE[cN]=[aB.z,cN]}cE.sort(l);for(cN=0;cN<cZ;cN++){cY=cG[cE[cN][1]];cF=cN*3;cO[cF]=cY.x;cO[cF+1]=cY.y;cO[cF+2]=cY.z}for(c0=0;c0<cJ;c0++){cF=c0*3;cV=cK[cE[c0][1]];cC[cF]=cV.r;cC[cF+1]=cV.g;cC[cF+2]=cV.b}}else{if(cT){for(cN=0;cN<cZ;cN++){cY=cG[cN];cF=cN*3;cO[cF]=cY.x;cO[cF+1]=cY.y;cO[cF+2]=cY.z}}if(cQ){for(c0=0;c0<cJ;c0++){cV=cK[c0];cF=c0*3;cC[cF]=cV.r;cC[cF+1]=cV.g;cC[cF+2]=cV.b}}}if(cT||c2.sortParticles){w.bindBuffer(w.ARRAY_BUFFER,cD.__webglVertexBuffer);w.bufferData(w.ARRAY_BUFFER,cO,cP)}if(cQ||c2.sortParticles){w.bindBuffer(w.ARRAY_BUFFER,cD.__webglColorBuffer);w.bufferData(w.ARRAY_BUFFER,cC,cP)}}function b2(cF,cQ){var cN,c3,c1,cL,c0,cG,cW,cH=cF.vertices,cJ=cF.colors,cP=cF.lineDistances,c2=cH.length,cI=cJ.length,cX=cP.length,cO=cF.__vertexArray,cE=cF.__colorArray,cC=cF.__lineDistanceArray,cU=cF.verticesNeedUpdate,cR=cF.colorsNeedUpdate,cD=cF.lineDistancesNeedUpdate,cT=cF.__webglCustomAttributesList,cY,cK,c4,cS,cM,cV,cZ;if(cU){for(cN=0;cN<c2;cN++){c0=cH[cN];cG=cN*3;cO[cG]=c0.x;cO[cG+1]=c0.y;cO[cG+2]=c0.z}w.bindBuffer(w.ARRAY_BUFFER,cF.__webglVertexBuffer);w.bufferData(w.ARRAY_BUFFER,cO,cQ)}if(cR){for(c3=0;c3<cI;c3++){cW=cJ[c3];cG=c3*3;cE[cG]=cW.r;cE[cG+1]=cW.g;cE[cG+2]=cW.b}w.bindBuffer(w.ARRAY_BUFFER,cF.__webglColorBuffer);w.bufferData(w.ARRAY_BUFFER,cE,cQ)}if(cD){for(c1=0;c1<cX;c1++){cC[c1]=cP[c1]}w.bindBuffer(w.ARRAY_BUFFER,cF.__webglLineDistanceBuffer);w.bufferData(w.ARRAY_BUFFER,cC,cQ)}}function H(dW,d2,ev,cQ,et){if(!dW.__inittedArrays){return}var ds=bn(et),cN=cn(et),dV=b9(et),dg=(ds===s.SmoothShading);var dy,ee,ek,cD,cU,cI,dD,cV,dr,cE,dq,eq,dM,dL,dK,dJ,er,ep,en,el,ej,eg,ef,ed,dT,dS,dQ,dP,d9,d8,d5,d4,cM,cL,cK,cJ,dm,dk,dj,di,c5,cZ,cX,cW,du,dZ,dx,dp,c9,dO,dU,da,dh,dt,dR,dz,dN,dC,c7=0,cS=0,dY=0,eo=0,dv=0,df=0,cT=0,dI=0,cR=0,dw=0,cC=0,cO=0,cY=0,dl,cH=dW.__vertexArray,de=dW.__uvArray,cP=dW.__uv2Array,d3=dW.__normalArray,d7=dW.__tangentArray,dF=dW.__colorArray,d1=dW.__skinIndexArray,ei=dW.__skinWeightArray,eh=dW.__morphTargetsArrays,db=dW.__morphNormalsArrays,dd=dW.__webglCustomAttributesList,cG,em=dW.__faceArray,dB=dW.__lineArray,dX=d2.geometry,c8=dX.verticesNeedUpdate,dA=dX.elementsNeedUpdate,dG=dX.uvsNeedUpdate,cF=dX.normalsNeedUpdate,es=dX.tangentsNeedUpdate,d6=dX.colorsNeedUpdate,ew=dX.morphTargetsNeedUpdate,dH=dX.vertices,c6=dW.faces3,c0=dW.faces4,ea=dX.faces,dE=dX.faceVertexUvs[0],dc=dX.faceVertexUvs[1],eb=dX.colors,dn=dX.skinIndices,ec=dX.skinWeights,eu=dX.morphTargets,d0=dX.morphNormals;if(c8){for(dy=0,ee=c6.length;dy<ee;dy++){cD=ea[c6[dy]];dM=dH[cD.a];dL=dH[cD.b];dK=dH[cD.c];cH[cS]=dM.x;cH[cS+1]=dM.y;cH[cS+2]=dM.z;cH[cS+3]=dL.x;cH[cS+4]=dL.y;cH[cS+5]=dL.z;cH[cS+6]=dK.x;cH[cS+7]=dK.y;cH[cS+8]=dK.z;cS+=9}for(dy=0,ee=c0.length;dy<ee;dy++){cD=ea[c0[dy]];dM=dH[cD.a];dL=dH[cD.b];dK=dH[cD.c];dJ=dH[cD.d];cH[cS]=dM.x;cH[cS+1]=dM.y;cH[cS+2]=dM.z;cH[cS+3]=dL.x;cH[cS+4]=dL.y;cH[cS+5]=dL.z;cH[cS+6]=dK.x;cH[cS+7]=dK.y;cH[cS+8]=dK.z;cH[cS+9]=dJ.x;cH[cS+10]=dJ.y;cH[cS+11]=dJ.z;cS+=12}w.bindBuffer(w.ARRAY_BUFFER,dW.__webglVertexBuffer);w.bufferData(w.ARRAY_BUFFER,cH,ev)}if(d6&&cN){for(dy=0,ee=c6.length;dy<ee;dy++){cD=ea[c6[dy]];cV=cD.vertexColors;dr=cD.color;if(cV.length===3&&cN===s.VertexColors){dT=cV[0];dS=cV[1];dQ=cV[2]}else{dT=dr;dS=dr;dQ=dr}dF[cR]=dT.r;dF[cR+1]=dT.g;dF[cR+2]=dT.b;dF[cR+3]=dS.r;dF[cR+4]=dS.g;dF[cR+5]=dS.b;dF[cR+6]=dQ.r;dF[cR+7]=dQ.g;dF[cR+8]=dQ.b;cR+=9}for(dy=0,ee=c0.length;dy<ee;dy++){cD=ea[c0[dy]];cV=cD.vertexColors;dr=cD.color;if(cV.length===4&&cN===s.VertexColors){dT=cV[0];dS=cV[1];dQ=cV[2];dP=cV[3]}else{dT=dr;dS=dr;dQ=dr;dP=dr}dF[cR]=dT.r;dF[cR+1]=dT.g;dF[cR+2]=dT.b;dF[cR+3]=dS.r;dF[cR+4]=dS.g;dF[cR+5]=dS.b;dF[cR+6]=dQ.r;dF[cR+7]=dQ.g;dF[cR+8]=dQ.b;dF[cR+9]=dP.r;dF[cR+10]=dP.g;dF[cR+11]=dP.b;cR+=12}if(cR>0){w.bindBuffer(w.ARRAY_BUFFER,dW.__webglColorBuffer);w.bufferData(w.ARRAY_BUFFER,dF,ev)}}if(es&&dX.hasTangents){for(dy=0,ee=c6.length;dy<ee;dy++){cD=ea[c6[dy]];cE=cD.vertexTangents;er=cE[0];ep=cE[1];en=cE[2];d7[cT]=er.x;d7[cT+1]=er.y;d7[cT+2]=er.z;d7[cT+3]=er.w;d7[cT+4]=ep.x;d7[cT+5]=ep.y;d7[cT+6]=ep.z;d7[cT+7]=ep.w;d7[cT+8]=en.x;d7[cT+9]=en.y;d7[cT+10]=en.z;d7[cT+11]=en.w;cT+=12}for(dy=0,ee=c0.length;dy<ee;dy++){cD=ea[c0[dy]];cE=cD.vertexTangents;er=cE[0];ep=cE[1];en=cE[2];el=cE[3];d7[cT]=er.x;d7[cT+1]=er.y;d7[cT+2]=er.z;d7[cT+3]=er.w;d7[cT+4]=ep.x;d7[cT+5]=ep.y;d7[cT+6]=ep.z;d7[cT+7]=ep.w;d7[cT+8]=en.x;d7[cT+9]=en.y;d7[cT+10]=en.z;d7[cT+11]=en.w;d7[cT+12]=el.x;d7[cT+13]=el.y;d7[cT+14]=el.z;d7[cT+15]=el.w;cT+=16}w.bindBuffer(w.ARRAY_BUFFER,dW.__webglTangentBuffer);w.bufferData(w.ARRAY_BUFFER,d7,ev)}if(cF&&ds){for(dy=0,ee=c6.length;dy<ee;dy++){cD=ea[c6[dy]];cU=cD.vertexNormals;cI=cD.normal;if(cU.length===3&&dg){for(dx=0;dx<3;dx++){c9=cU[dx];d3[df]=c9.x;d3[df+1]=c9.y;d3[df+2]=c9.z;df+=3}}else{for(dx=0;dx<3;dx++){d3[df]=cI.x;d3[df+1]=cI.y;d3[df+2]=cI.z;df+=3}}}for(dy=0,ee=c0.length;dy<ee;dy++){cD=ea[c0[dy]];cU=cD.vertexNormals;cI=cD.normal;if(cU.length===4&&dg){for(dx=0;dx<4;dx++){c9=cU[dx];d3[df]=c9.x;d3[df+1]=c9.y;d3[df+2]=c9.z;df+=3}}else{for(dx=0;dx<4;dx++){d3[df]=cI.x;d3[df+1]=cI.y;d3[df+2]=cI.z;df+=3}}}w.bindBuffer(w.ARRAY_BUFFER,dW.__webglNormalBuffer);w.bufferData(w.ARRAY_BUFFER,d3,ev)}if(dG&&dE&&dV){for(dy=0,ee=c6.length;dy<ee;dy++){ek=c6[dy];dq=dE[ek];if(dq===undefined){continue}for(dx=0;dx<3;dx++){dO=dq[dx];de[dY]=dO.x;de[dY+1]=dO.y;dY+=2}}for(dy=0,ee=c0.length;dy<ee;dy++){ek=c0[dy];dq=dE[ek];if(dq===undefined){continue}for(dx=0;dx<4;dx++){dO=dq[dx];de[dY]=dO.x;de[dY+1]=dO.y;dY+=2}}if(dY>0){w.bindBuffer(w.ARRAY_BUFFER,dW.__webglUVBuffer);w.bufferData(w.ARRAY_BUFFER,de,ev)}}if(dA){for(dy=0,ee=c6.length;dy<ee;dy++){em[dv]=c7;em[dv+1]=c7+1;em[dv+2]=c7+2;dv+=3;dB[dI]=c7;dB[dI+1]=c7+1;dB[dI+2]=c7;dB[dI+3]=c7+2;dB[dI+4]=c7+1;dB[dI+5]=c7+2;dI+=6;c7+=3}for(dy=0,ee=c0.length;dy<ee;dy++){em[dv]=c7;em[dv+1]=c7+1;em[dv+2]=c7+3;em[dv+3]=c7+1;em[dv+4]=c7+2;em[dv+5]=c7+3;dv+=6;dB[dI]=c7;dB[dI+1]=c7+1;dB[dI+2]=c7;dB[dI+3]=c7+3;dB[dI+4]=c7+1;dB[dI+5]=c7+2;dB[dI+6]=c7+2;dB[dI+7]=c7+3;dI+=8;c7+=4}w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,dW.__webglFaceBuffer);w.bufferData(w.ELEMENT_ARRAY_BUFFER,em,ev);w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,dW.__webglLineBuffer);w.bufferData(w.ELEMENT_ARRAY_BUFFER,dB,ev)}if(cQ){delete dW.__inittedArrays;delete dW.__colorArray;delete dW.__normalArray;delete dW.__tangentArray;delete dW.__uvArray;delete dW.__uv2Array;delete dW.__binormalArray;delete dW.__faceArray;delete dW.__vertexArray;delete dW.__lineArray;delete dW.__skinIndexArray;delete dW.__skinWeightArray}}function a3(cE,cD,cC){}this.renderBufferImmediate=function(cR,cF,cH){if(cR.hasPositions&&!cR.__webglVertexBuffer){cR.__webglVertexBuffer=w.createBuffer()}if(cR.hasNormals&&!cR.__webglNormalBuffer){cR.__webglNormalBuffer=w.createBuffer()}if(cR.hasUvs&&!cR.__webglUvBuffer){cR.__webglUvBuffer=w.createBuffer()}if(cR.hasColors&&!cR.__webglColorBuffer){cR.__webglColorBuffer=w.createBuffer()}if(cR.hasPositions){w.bindBuffer(w.ARRAY_BUFFER,cR.__webglVertexBuffer);w.bufferData(w.ARRAY_BUFFER,cR.positionArray,w.DYNAMIC_DRAW);w.enableVertexAttribArray(cF.attributes.position);w.vertexAttribPointer(cF.attributes.position,3,w.FLOAT,false,0,0)}if(cR.hasNormals){w.bindBuffer(w.ARRAY_BUFFER,cR.__webglNormalBuffer);if(cH.shading===s.FlatShading){var cP,cO,cM,cE,cK,cT,cD,cJ,cS,cC,cI,cQ,cN,cL,cG=cR.count*3;for(cL=0;cL<cG;cL+=9){cN=cR.normalArray;cE=cN[cL];cD=cN[cL+1];cC=cN[cL+2];cK=cN[cL+3];cJ=cN[cL+4];cI=cN[cL+5];cT=cN[cL+6];cS=cN[cL+7];cQ=cN[cL+8];cP=(cE+cK+cT)/3;cO=(cD+cJ+cS)/3;cM=(cC+cI+cQ)/3;cN[cL]=cP;cN[cL+1]=cO;cN[cL+2]=cM;cN[cL+3]=cP;cN[cL+4]=cO;cN[cL+5]=cM;cN[cL+6]=cP;cN[cL+7]=cO;cN[cL+8]=cM}}w.bufferData(w.ARRAY_BUFFER,cR.normalArray,w.DYNAMIC_DRAW);w.enableVertexAttribArray(cF.attributes.normal);w.vertexAttribPointer(cF.attributes.normal,3,w.FLOAT,false,0,0)}if(cR.hasUvs&&cH.map){w.bindBuffer(w.ARRAY_BUFFER,cR.__webglUvBuffer);w.bufferData(w.ARRAY_BUFFER,cR.uvArray,w.DYNAMIC_DRAW);w.enableVertexAttribArray(cF.attributes.uv);w.vertexAttribPointer(cF.attributes.uv,2,w.FLOAT,false,0,0)}if(cR.hasColors&&cH.vertexColors!==s.NoColors){w.bindBuffer(w.ARRAY_BUFFER,cR.__webglColorBuffer);w.bufferData(w.ARRAY_BUFFER,cR.colorArray,w.DYNAMIC_DRAW);w.enableVertexAttribArray(cF.attributes.color);w.vertexAttribPointer(cF.attributes.color,3,w.FLOAT,false,0,0)}w.drawArrays(w.TRIANGLES,0,cR.count);cR.count=0};this.renderBufferDirect=function(cV,c0,cC,cN,cF,c2){if(cN.visible===false){return}var cJ,cX,cU,cW,cZ,cO,cH;var cM,cP,cQ,cD;var cL=false;cJ=bm(cV,c0,cC,cN,c2,undefined,cF,cN.programManager.getProgramID(c2));cX=cJ.attributes;cH=cF.attributes;var cR=false,cT=cN.wireframe?1:0,cY=(cF.id*16777215)+(cJ.id*2)+cT;if(cY!==ac){ac=cY;cR=true}if(cR){cc()}if(c2 instanceof s.Mesh){var cI=cH.index;if(cI){var cG=cF.offsets;if(cG.length>1){cR=true}for(var cS=0,cK=cG.length;cS<cK;cS++){var cE=cG[cS].index;if(cR){for(cP in cH){if(cP==="index"){continue}cQ=cX[cP];cM=cH[cP];cD=cM.itemSize;if(cQ>=0){w.bindBuffer(w.ARRAY_BUFFER,cM.buffer);aQ(cQ);w.vertexAttribPointer(cQ,cD,w.FLOAT,false,0,cE*cD*4)}}w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,cI.buffer)}w.drawElements(w.TRIANGLES,cG[cS].count,w.UNSIGNED_SHORT,cG[cS].start*2);bk.info.render.calls++;bk.info.render.vertices+=cG[cS].count;bk.info.render.faces+=cG[cS].count/3;cL=true}}else{if(cR){for(cP in cH){if(cP==="index"){continue}cQ=cX[cP];cM=cH[cP];cD=cM.itemSize;if(cQ>=0){w.bindBuffer(w.ARRAY_BUFFER,cM.buffer);aQ(cQ);w.vertexAttribPointer(cQ,cD,w.FLOAT,false,0,0)}}}var c1=cF.attributes.position;w.drawArrays(w.TRIANGLES,0,c1.numItems/3);cL=true;bk.info.render.calls++;bk.info.render.vertices+=c1.numItems/3;bk.info.render.faces+=c1.numItems/3/3}}else{if(c2 instanceof s.ParticleSystem){if(cR){for(cP in cH){cQ=cX[cP];cM=cH[cP];cD=cM.itemSize;if(cQ>=0){w.bindBuffer(w.ARRAY_BUFFER,cM.buffer);aQ(cQ);w.vertexAttribPointer(cQ,cD,w.FLOAT,false,0,0)}}var c1=cH.position;w.drawArrays(w.POINTS,0,c1.numItems/3);cL=true;bk.info.render.calls++;bk.info.render.points+=c1.numItems/3}}else{if(c2 instanceof s.Line){if(cR){for(cP in cH){cQ=cX[cP];cM=cH[cP];cD=cM.itemSize;if(cQ>=0){w.bindBuffer(w.ARRAY_BUFFER,cM.buffer);aQ(cQ);w.vertexAttribPointer(cQ,cD,w.FLOAT,false,0,0)}}bd(cN.lineWidth);var c1=cH.position;w.drawArrays(w.LINE_STRIP,0,c1.numItems/3);cL=true;bk.info.render.calls++;bk.info.render.points+=c1.numItems}}}}return cL};var b5;this.loadingTextureMaterial=new s.MeshPhongMaterial({color:14540253});this.getRenderMode=function(cC){var cH=s.RenderMode;if(!b5){b5=new cH()}var cE=this.renderLineMode!==null?this.renderLineMode:s.ShowAllRenderLineMode;var cF=this.renderPointMode||0;var cK=this.renderFaceMode;var cJ=b5;var cI=cC&&cC._occurrence;var cG=this.outlineWidth;if(cI){var cD=cI.renderMode;if(cD){if(cD._useRenderLineMask){cE=cD._mask}if(cD._useRenderPointMask){cF=cD._mask}if(cD._useRenderFaceMask){cK=cD._mask}cG=cD._outlineWidth}}cJ._setFromMasks(cF,cE,cK);cJ.setOutlineWidth(cG);return cJ};this.getMaterialMode=function(cC){if(cC&&cC._occurrence&&cC._occurrence.faceMode!==null){return cC._occurrence.faceMode===s.RenderStyle.FaceModes.MATERIAL}else{if(cC.materialMode<2){return !!cC.materialMode}}return this.materialMode};this.getRenderLineMode=function(cD){var cE;var cC=cD&&cD._occurrence&&cD._occurrence.renderMode;if(cC&&cC._useRenderLineMask){cE=cC.getRenderLineMode()}else{if(this.renderLineMode!==null){cE=this.renderLineMode}else{cE=s.ShowAllRenderLineMode}}return cE};this.recompileAllShaders=function(){w.WebVisuShaderVersion++};this.setupPickingMaterial=function(cG,cJ,cE){var cH=cE.pickingID.getHex();var cC=0;if((cJ==w.LINES)||(cG&&cG.lineWidth)){var cF=4194304;cC=cH|cF}else{if(cJ==w.TRIANGLES){var cI=8388608;cC=cH|cI}else{if(cJ==w.POINTS){cC=cH}}}var cD=new s.Color(cC);if(cG.uniforms&&cG.uniforms.pickingColor){cG.uniforms.pickingColor.value=cD}else{cG.color=cD}};this.renderInterval=function(cR,cH,db,c0,c9,cE,cJ,cL,cV,c4,c1,cK,cN,c3){if(cL.glType===w.TRIANGLES){bk.info.render.nbTriangles+=c4/3}bk.info.render.nbDGs++;bk.info.render.nbReps+=cL.cullingData?cL.cullingData.length:1;var cX=0;if(cL.cullingData&&!cR.isOrtho){var cQ=(cL.glType===w.TRIANGLES)?c4/3:c4/2;cQ/=cL.cullingData.length;if(cQ>this.ratioSSB){var c7=cR.performPixelCullingOnDG(c3,c0,cJ,cL,cV,c4);bk.info.render.nbDGsSSBProcessed++;if(cL.glType===w.TRIANGLES){bk.info.render.culledDGTriangles+=(c4-c7)/3}else{if(cL.glType===w.LINES){bk.info.render.culledDGLines+=(c4-c7)/2}}cX=1-c7/(c4+1);if(!this.colorizeSSB){c4=c7}if(c4===0){return false}}}var cC=null;var cZ=null;var cS=null;var cT=cL.glType;var c8=(cT===w.TRIANGLES)||(cT===w.TRIANGLE_STRIP);if((cT===w.POINTS)&&!this.renderPoints){return false}if(c8&&!this.renderFaces){return false}var cG=c0._instancingInfos?c0._instancingInfos.instanceAttribArrays:null;var c6=c0._instancingInfos&&cG!==null;var dd=cJ.vertexBuffer;var c5=false;if(cJ.needsUpdate){cJ.needsUpdate=false;cJ.deallocate(w,bk.info);c5=true}if(c8&&!c9.polygonOffset){cx(this.forcePolygonOffset===s.PolygonOffsetForceStatus.DEFAULT?c0.renderLineMode!==0:this.forcePolygonOffset===s.PolygonOffsetForceStatus.ENABLED,1,1)}var cM=w._currentProgram;var cI=c9.programManager.getProgramID(c0);if(cN||cI!==W){c9.previousOccurrenceRenderingOverride=null;bm(cR,cH,db,c9,c0,cK,cJ,cI)}else{var c2=c9.program.objectUniformLocations;this.loadObjectUniforms(c2,c0,cJ,c9,cR,cH)}if(c9._picking){this.setupPickingMaterial(c9,cT,c0);var c2=c9.program.uniformLocations;if(c9.uniforms&&c9.uniforms.pickingColor){w.uniform3f(c2.pickingColor,c9.uniforms.pickingColor.value.r,c9.uniforms.pickingColor.value.g,c9.uniforms.pickingColor.value.b)}else{w.uniform3f(c2.diffuse,c9.color.r,c9.color.g,c9.color.b)}}if(this.colorizeSSB&&cX&&!c9._picking){var c2=c9.program.uniformLocations;c2.diffuse&&w.uniform3f(c2.diffuse,cX,0,0)}if(c9.map&&c9.map.lods){c9.map.chooseTexture(cR,c0)}cC=c9.program;cZ=cC.attributes;cS=cC.instanceAttributes;var dc=false;if(cC.uvOrBinOrTan){if(!cJ.vertexBuffer||!(s.vertexComponentBits.UV&cJ.vertexBuffer.vbType)){if(!cJ.compressedNormals){if(!cJ.vertexIndexArray){console.warn("computeUVs unavailable, make sure noMeshInRAM is inactive")}else{cJ.computeUVs();cJ.deallocate(w,bk.info);c5=true}}}}if(!cJ.vertexBuffer){if(cJ.vertexUvArray&&cJ.vertexNormalArray&&(((cZ.binormal>=0)&&!cJ.vertexBinormalArray)||((cZ.tangent>=0)&&!cJ.vertexTangentArray))){cJ.computeTangents();cJ.deallocate(w,bk.info);c5=true}}else{if((a.vertexComponentBits.UV&cJ.vertexBuffer.vbType)&&(a.vertexComponentBits.NORMAL&cJ.vertexBuffer.vbType)&&(((cZ.binormal>=0)&&!(a.vertexComponentBits.BINORMAL&cJ.vertexBuffer.vbType))||((cZ.tangent>=0)&&!(a.vertexComponentBits.TANGENT&cJ.vertexBuffer.vbType)))){if(!cJ.vertexIndexArray){console.warn("computeTangents unavailable, make sure noMeshInRAM is inactive")}else{cJ.computeTangents();cJ.deallocate(w,bk.info);c5=true}}}if(!dd){c5=true}if(c6){if(bQ!==cG.id){bQ=cG.id;dc=true}for(var cD in cG){if(cD!=="id"){if(!cG[cD].buffer){c5=true;break}else{if(cG[cD].isDynamic){w.bindBuffer(w.ARRAY_BUFFER,cG[cD].buffer);w.bufferData(w.ARRAY_BUFFER,cG[cD].array,w.DYNAMIC_DRAW);cG[cD].isDynamic=false}}}}}if(c5){this.initDirectBuffersDS(cJ,c0);dd=cJ.vertexBuffer}if(!dd){return false}if(dd&&dd.needsUpdate){var cP=cJ.vertexLayout;if(cJ.vertexPositionArray&&cP.vertexPositionArray.needsUpdate){bx(cJ,"vertexPositionArray")}if(cJ.vertexNormalArray&&cP.vertexNormalArray.needsUpdate){bx(cJ,"vertexNormalArray")}if(cJ.vertexUvArray&&cP.vertexUvArray.needsUpdate){bx(cJ,"vertexUvArray")}if(cJ.vertexUv2Array&&cP.vertexUv2Array.needsUpdate){bx(cJ,"vertexUv2Array")}if(cJ.vertexColorArray&&cP.vertexColorArray.needsUpdate){bx(cJ,"vertexColorArray")}if(cJ.vertexTangentArray&&cP.vertexTangentArray.needsUpdate){bx(cJ,"vertexTangentArray")}if(cJ.vertexBinormalArray&&cP.vertexBinormalArray.needsUpdate){bx(cJ,"vertexBinormalArray")}if(cJ.vertexPreviousPositionArray&&cP.vertexPreviousPositionArray.needsUpdate){bx(cJ,"vertexPreviousPositionArray")}if(cJ.vertexNextPositionArray&&cP.vertexNextPositionArray.needsUpdate){bx(cJ,"vertexNextPositionArray")}if(cJ.vertexSideExtrusionArray&&cP.vertexSideExtrusionArray.needsUpdate){bx(cJ,"vertexSideExtrusionArray")}if(cJ.vertexLineDistancesArray&&cP.vertexLineDistancesArray.needsUpdate){bx(cJ,"vertexLineDistancesArray")}aX(cJ);if(cJ.vertexIndexArray&&cP.vertexIndexArray.needsUpdate){bf(cJ)}}if(dd!==bB){bB=dd;dc=true}if(dc){var cO=dd.itemSize*4;w.bindBuffer(w.ARRAY_BUFFER,dd.buffer);w.vertexAttribPointer(cZ.position,cJ.compressedVertices?2:3,w.FLOAT,false,cO,0);if(cZ.normal>=0&&(a.vertexComponentBits.NORMAL&dd.vbType)){w.vertexAttribPointer(cZ.normal,cJ.compressedNormals?1:3,w.FLOAT,false,cO,dd.normalOffset)}if(cZ.uv>=0&&(a.vertexComponentBits.UV&dd.vbType)){w.vertexAttribPointer(cZ.uv,2,w.FLOAT,false,cO,dd.uvOffset)}if(cZ.uv2>=0&&(a.vertexComponentBits.UV2&dd.vbType)){w.vertexAttribPointer(cZ.uv2,2,w.FLOAT,false,cO,dd.uv2Offset)}if(cZ.binormal>=0&&(a.vertexComponentBits.BINORMAL&dd.vbType)){w.vertexAttribPointer(cZ.binormal,3,w.FLOAT,false,cO,dd.binormalOffset)}if(cZ.tangent>=0&&(a.vertexComponentBits.TANGENT&dd.vbType)){w.vertexAttribPointer(cZ.tangent,3,w.FLOAT,false,cO,dd.tangentOffset)}if(cZ.color>=0&&(a.vertexComponentBits.COLOR&dd.vbType)){w.vertexAttribPointer(cZ.color,4,w.FLOAT,false,cO,dd.colorOffset)}if(cZ.lineDistance>=0&&(a.vertexComponentBits.LINEDIST&dd.vbType)){w.vertexAttribPointer(cZ.lineDistance,2,w.FLOAT,false,cO,dd.lineDistancesOffset)}if(cZ.previousPos>=0&&(a.vertexComponentBits.PREVIOUSPOS&dd.vbType)){w.vertexAttribPointer(cZ.previousPos,3,w.FLOAT,false,cO,dd.previousPositionOffset)}if(cZ.followingPos>=0&&(a.vertexComponentBits.NEXTPOS&dd.vbType)){w.vertexAttribPointer(cZ.followingPos,3,w.FLOAT,false,cO,dd.nextPositionOffset)}if(cZ.sideExtrusion>=0&&(a.vertexComponentBits.SIDEEXTR&dd.vbType)){w.vertexAttribPointer(cZ.sideExtrusion,1,w.FLOAT,false,cO,dd.sideExtrusionOffset)}if(cZ.skinIndex>=0&&(a.vertexComponentBits.SKININDEX&dd.vbType)){w.vertexAttribPointer(cZ.skinIndex,4,w.FLOAT,false,cO,dd.skinIndexOffset)}if(cZ.skinIndex>=0&&(a.vertexComponentBits.SKINWEIGHT&dd.vbType)){w.vertexAttribPointer(cZ.skinWeight,4,w.FLOAT,false,cO,dd.skinWeightOffset)}if(c6){for(var cU in cG){if(cU!=="id"){w.bindBuffer(w.ARRAY_BUFFER,cG[cU].buffer);if(cS[cU]>=0&&cG[cU].array){if(cG[cU].isMat4){w.vertexAttribPointer(cS[cU],cG[cU].itemSize,w.FLOAT,false,64,0);w.vertexAttribPointer(cS[cU]+1,cG[cU].itemSize,w.FLOAT,false,64,16);w.vertexAttribPointer(cS[cU]+2,cG[cU].itemSize,w.FLOAT,false,64,32);w.vertexAttribPointer(cS[cU]+3,cG[cU].itemSize,w.FLOAT,false,64,48)}else{w.vertexAttribPointer(cS[cU],cG[cU].itemSize,w.FLOAT,false,0,0)}}}}}w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,dd.indexBuffer)}if(cM!=w._currentProgram){var cY={};cY[cZ.position]=true;if(cZ.normal>=0&&(a.vertexComponentBits.NORMAL&dd.vbType)){cY[cZ.normal]=true}if(cZ.uv>=0&&(a.vertexComponentBits.UV&dd.vbType)){cY[cZ.uv]=true}if(cZ.uv2>=0&&(a.vertexComponentBits.UV2&dd.vbType)){cY[cZ.uv2]=true}if(cZ.tangent>=0&&(a.vertexComponentBits.TANGENT&dd.vbType)){cY[cZ.tangent]=true}if(cZ.binormal>=0&&(a.vertexComponentBits.BINORMAL&dd.vbType)){cY[cZ.binormal]=true}if(cZ.color>=0&&(a.vertexComponentBits.COLOR&dd.vbType)){cY[cZ.color]=true}if(cZ.lineDistance>=0){cY[cZ.lineDistance]=true}if(cZ.previousPos>=0){cY[cZ.previousPos]=true}if(cZ.followingPos>=0){cY[cZ.followingPos]=true}if(cZ.sideExtrusion>=0){cY[cZ.sideExtrusion]=true}if(cZ.skinIndex>=0&&(a.vertexComponentBits.SKININDEX&dd.vbType)){cY[cZ.skinIndex]=true}if(cZ.skinWeight>=0&&(a.vertexComponentBits.SKINWEIGHT&dd.vbType)){cY[cZ.skinWeight]=true}if(c6){for(var cU in cG){if(cU!=="id"){if(cS[cU]>=0){if(cG[cU].isMat4){cY[cS[cU]]=true;cY[cS[cU]+1]=true;cY[cS[cU]+2]=true;cY[cS[cU]+3]=true}else{cY[cS[cU]]=true}}}}}al(cY)}var cF=cJ.numBytesIndex;var da=cJ.glFormatTypeIndex;if(c6){for(var cU in cG){if(cU!=="id"){if(cS[cU]>=0&&cG[cU].array){if(cG[cU].isMat4){I.vertexAttribDivisorANGLE(cS[cU],1);I.vertexAttribDivisorANGLE(cS[cU]+1,1);I.vertexAttribDivisorANGLE(cS[cU]+2,1);I.vertexAttribDivisorANGLE(cS[cU]+3,1)}else{I.vertexAttribDivisorANGLE(cS[cU],1)}}}}if(c9.wireframe&&c8){I.drawElementsInstancedANGLE(w.LINE_STRIP,c4,da,cV*cF,c0._instancingInfos.nbInstances)}else{I.drawElementsInstancedANGLE(cT,c4,da,cV*cF,c0._instancingInfos.nbInstances)}for(var cW in cG){if(cW!=="id"&&cS[cW]>=0){if(cG[cW].isMat4){I.vertexAttribDivisorANGLE(cS[cW],0);I.vertexAttribDivisorANGLE(cS[cW]+1,0);I.vertexAttribDivisorANGLE(cS[cW]+2,0);I.vertexAttribDivisorANGLE(cS[cW]+3,0)}else{I.vertexAttribDivisorANGLE(cS[cW],0)}}}}else{if(c9.wireframe&&c8){w.drawElements(w.LINE_STRIP,c4,da,cV*cF)}else{if((cT===w.POINTS)&&cJ.vertexPositionArray&&cJ.vertexPositionArray.nonindexedPoints){w.drawArrays(cT,cJ.vertexIndexArray[cV],c4)}else{if(cL.nonIndexed){w.drawArrays(cT,cV,c4)}else{w.drawElements(cT,c4,da,(cJ.indexOffset+cV)*cF)}}}}bk.info.render.calls++;bk.info.render.vertices+=c4;if(cT===w.TRIANGLES){bk.info.render.faces+=c4/3}else{if(cT===w.LINES){bk.info.render.lines+=c4/2}}return true};this.renderSectionLines=function(cJ,cG,cC,cF,cK,cQ,cO,cN,cD,cI,cL,cE,cP){if(!cK.uniforms.currentClipPlane){return}var cH;var cM=0;for(cM=0;cM<S.length;cM++){cH=cK.program;cK.uniforms.currentClipPlane.value=cM;if(cH&&cH.program===w._currentProgram){w.uniform1i(cH.uniformLocations.currentClipPlane,cK.uniforms.currentClipPlane.value)}cK.clipPlaneIndex=cM+1;this._clipPlanesState.update(cL,null,true,cK,cJ,true);this.renderInterval.apply(this,arguments)}cK.clipPlaneIndex=0;this._clipPlanesState.update(cL,null,true,cK,cJ,false)};this.renderBuffer=function(cN,cR,cD,cH,cK,cS,cT){if(cH.visible===false){return false}var cE,cF,cC,cO,cQ,cI,cM,cG;cE=bm(cN,cR,cD,cH,cS,cT,null,cH.programManager.getProgramID(cS));cF=cE.attributes;if(cH._picking){if(cH.uniforms&&cH.uniforms.pickingColor){w.uniform3f(cH.program.uniformLocations.pickingColor,cH.uniforms.pickingColor.value.r,cH.uniforms.pickingColor.value.g,cH.uniforms.pickingColor.value.b)}else{w.uniform3f(cH.program.uniformLocations.diffuse,cH.color.r,cH.color.g,cH.color.b)}}var cJ=false,cL=cH.wireframe?1:0,cP=(cK.id*16777215)+(cE.id*2)+cL;if(cP!==ac){ac=cP;cJ=true}if(cJ){cc()}if(!cH.morphTargets&&cF.position>=0){if(cJ){w.bindBuffer(w.ARRAY_BUFFER,cK.__webglVertexBuffer);aQ(cF.position);w.vertexAttribPointer(cF.position,3,w.FLOAT,false,0,0)}}else{if(cS.morphTargetBase){X(cH,cK,cS)}}if(cJ){if(cK.__webglCustomAttributesList){for(cM=0,cG=cK.__webglCustomAttributesList.length;cM<cG;cM++){cI=cK.__webglCustomAttributesList[cM];if(cF[cI.buffer.belongsToAttribute]>=0){w.bindBuffer(w.ARRAY_BUFFER,cI.buffer);aQ(cF[cI.buffer.belongsToAttribute]);w.vertexAttribPointer(cF[cI.buffer.belongsToAttribute],cI.size,w.FLOAT,false,0,0)}}}if(cF.color>=0&&cK.__colorArray){w.bindBuffer(w.ARRAY_BUFFER,cK.__webglColorBuffer);aQ(cF.color);w.vertexAttribPointer(cF.color,3,w.FLOAT,false,0,0)}if(cF.normal>=0&&cK.__normalArray){w.bindBuffer(w.ARRAY_BUFFER,cK.__webglNormalBuffer);aQ(cF.normal);w.vertexAttribPointer(cF.normal,3,w.FLOAT,false,0,0)}if(cF.tangent>=0&&cK.__tangentArray){w.bindBuffer(w.ARRAY_BUFFER,cK.__webglTangentBuffer);aQ(cF.tangent);w.vertexAttribPointer(cF.tangent,4,w.FLOAT,false,0,0)}if(cF.uv>=0&&cK.__uvArray){w.bindBuffer(w.ARRAY_BUFFER,cK.__webglUVBuffer);aQ(cF.uv);w.vertexAttribPointer(cF.uv,2,w.FLOAT,false,0,0)}if(cF.uv2>=0&&cK.__uv2Array){w.bindBuffer(w.ARRAY_BUFFER,cK.__webglUV2Buffer);aQ(cF.uv2);w.vertexAttribPointer(cF.uv2,2,w.FLOAT,false,0,0)}if(cH.skinning&&cF.skinIndex>=0&&cF.skinWeight>=0){w.bindBuffer(w.ARRAY_BUFFER,cK.__webglSkinIndicesBuffer);aQ(cF.skinIndex);w.vertexAttribPointer(cF.skinIndex,4,w.FLOAT,false,0,0);w.bindBuffer(w.ARRAY_BUFFER,cK.__webglSkinWeightsBuffer);aQ(cF.skinWeight);w.vertexAttribPointer(cF.skinWeight,4,w.FLOAT,false,0,0)}if(cF.lineDistance>=0){w.bindBuffer(w.ARRAY_BUFFER,cK.__webglLineDistanceBuffer);aQ(cF.lineDistance);w.vertexAttribPointer(cF.lineDistance,2,w.FLOAT,false,0,0)}}if(cS instanceof s.Mesh){if(cH.wireframe){bd(cH.wireframeLinewidth);if(cJ){w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,cK.__webglLineBuffer)}w.drawElements(w.LINES,cK.__webglLineCount,w.UNSIGNED_SHORT,0)}else{if(cJ){w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,cK.__webglFaceBuffer)}w.drawElements(w.TRIANGLES,cK.__webglFaceCount,w.UNSIGNED_SHORT,0)}bk.info.render.calls++;bk.info.render.vertices+=cK.__webglFaceCount;bk.info.render.faces+=cK.__webglFaceCount/3}else{if(cS instanceof s.Line){cO=(cS.type===s.LineStrip)?w.LINE_STRIP:w.LINES;bd(cH.lineWidth);w.drawArrays(cO,0,cK.__webglLineCount);bk.info.render.calls++}else{if(cS instanceof s.ParticleSystem){w.drawArrays(w.POINTS,0,cK.__webglParticleCount);bk.info.render.calls++;bk.info.render.points+=cK.__webglParticleCount}}}return true};function aQ(cC){if(!w._enabledAttributes[cC]){w.enableVertexAttribArray(cC);w._enabledAttributes[cC]=true}}function cc(){for(var cC in w._enabledAttributes){if(w._enabledAttributes[cC]){w.disableVertexAttribArray(cC);w._enabledAttributes[cC]=false}}}function al(cD){for(var cC in cD){if(!w._enabledAttributes[cC]){w.enableVertexAttribArray(cC);w._enabledAttributes[cC]=true}}for(var cC in w._enabledAttributes){if(w._enabledAttributes[cC]&&!cD[cC]){w.disableVertexAttribArray(cC);w._enabledAttributes[cC]=false}}}function X(cE,cC,cD){}var Y=s.MaterialToUse.shadowMapDepthMaterial;var cz=s.MaterialToUse.normalDepthMaterial;this.addDGToDL=function(cW,cH,cS,cT,cK,cI,cU,cF,cJ,cM,cR,cQ){var cC=cK,cN=cI;var cL=cW.occurrenceRenderingOverride&&cW.occurrenceRenderingOverride.getFullMaterial();var cP;if(cC.overridable&&cL&&(this.materialToUse===s.MaterialToUse.originalMaterial||this._oitMaterial)){if(cS.glType===w.POINTS){cP=cL.targetPrimitiveType==="POINTS"}else{if(cS.glType===w.LINES||cS.glType===w.POINTS){cP=cL.targetPrimitiveType==="LINES"}else{cP=!cL.targetPrimitiveType}}if(cP){if(this._oitMaterial){!cL._deferredMaterialsInit&&cL.updateDeferredMaterials();cL=cL._deferredMaterials[this.materialToUse]}cC=cL;cI=cL}}if(this.materialToUse===cz||this.materialToUse===Y){if(cS.glType<=w.LINE_STRIP){return}if(cN){if(cW.occurrenceRenderingOverride){var cD=cW.occurrenceRenderingOverride.materialOverride;var cG=null;if(cD){cG=cD.getOpacity()}if(cG!==null){if(cG<1){return}}else{if(cL&&(cL.getOpacity()<1)){return}}}else{if(cN.getOpacity()<1){return}}}}var cV=cC.polite||(this.renderHiddenEdges&&(cS&&cS._geomType&&(cS._geomType===s.GeomTypeEnum.SHARP_EDGE||cS._geomType===s.GeomTypeEnum.SMOOTH_EDGE||cS._geomType===s.GeomTypeEnum.BOUNDARY_EDGE||cS._geomType===s.GeomTypeEnum.EDGE)))?2:1;for(var cO=0;cO<cV;cO++){if(cO){if(!cC.politeMaterial){cC.politeMaterial=cC.clone();if(this.materialToUse!==s.MaterialToUse.highlightMaterial){cC.politeMaterial.transparent=true;cC.politeMaterial.opacity=0.3;cC.politeMaterial.depthTest=false;cC.politeMaterial.depthWrite=false}}cC=cC.politeMaterial}var cE=cJ(cW,cS,cC);if(cE){if(cE.zSort===s.BackToFront&&!cC._picking&&!(this.currentPass&&this.currentPass.isOITPass)){cU.push([cE,cC,cW,cH,cS,cT]);if(cR){cW._gsso_cache.push({dl:cE.index,args:[cE,cC,cW,cH,cS,cT],renderLineMode:cW.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame})}}else{cE.addDrawable(cC,cW,cH,cS,cT,cF,cw,this.fixedSizeArrayPool,this.renderVolumesOnly,cM,cQ,this.domElement,this.currentFrameIndex,this.materialToUse);if(cR){cW._gsso_cache.push({dl:cE.index,args:[cC,cW,cH,cS,cT,cF&&cF.clone(),-1,this.fixedSizeArrayPool,this.renderVolumesOnly,cM,cQ,this.domElement,this.materialToUse],renderLineMode:cW.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame})}}}}};this.resetGSSOCache=function(){this.resetGSSOCacheFrame++};var au={};(function(){var cE=["EDGE","WIRE_EDGE","BOUNDARY_EDGE","SHARP_EDGE","SMOOTH_EDGE","HIDDEN_SEAM_EDGE","BOUNDARY_POINT","SHARP_POINT","SMOOTH_POINT","HIDDEN_SEAM_POINT","SURFACIC_POINT","FREE_POINT","INFINITE_FACE","FACE","UNKNOWN","AXIS_SYSTEM"];var cD={EDGE:1,WIRE_EDGE:1,BOUNDARY_EDGE:1,SHARP_EDGE:1,SMOOTH_EDGE:1,HIDDEN_SEAM_EDGE:1,BOUNDARY_POINT:0,SHARP_POINT:0,SMOOTH_POINT:0,HIDDEN_SEAM_POINT:0,SURFACIC_POINT:0,FREE_POINT:0,INFINITE_FACE:2,FACE:2,UNKNOWN:2,AXIS_SYSTEM:2};var cF,cC;for(cF=0;cF<cE.length;cF++){cC=cE[cF];au[s.GeomTypeEnum[cC]]=cD[cC]}})();this.getStateSortedObjects=function(d5,c6,cD,dJ,d6,dK,dn){cw++;var c4=this;for(var dx=0;dx<cD._displayLists.length;dx++){cD._displayLists[dx].init()}var dM=cD.getDisplayListByName("EDGE");var cM=cD.getDisplayListByName("POINT");var dk=cD.getDisplayListByName("SOLID");var c7=cD.getDisplayListByName("SURFACE");var de=cD.getDisplayListByName("BACK");var cE=cD.getDisplayListByName("NOZ");var ed=cD.getDisplayListByName("TRANSPAR");var dG=cD.getDisplayListByName("TRANSPAR1D");var dc=cD.getDisplayListByName("NOZTRANSPAR");var cF=[cM,dM,c7,c7,cE,dk];var dZ=[dG,dG,ed,ed,dc,ed];var cU=(this.materialToUse===s.MaterialToUse.pickingMaterial);var dU=s.GeomTypeEnum.FACE;var c2=w.POINTS;var dr=w.LINES;var dP=w.LINE_STRIP;var dB=function(eo,eu,es){if(es.isBackMaterial){return de}if(es.uniforms&&es.uniforms.outlinePositionMaps){return dM}var el;var eq=2;if(cU&&cD._pickingPriorityMapping&&eo.pickingPriorityID){var ek=eo.pickingPriorityID.points;if(eu.glType>=4){ek=eo.pickingPriorityID.faces}else{if(eu.glType>=1){ek=eo.pickingPriorityID.edges}}if(ek){el=cD._pickingPriorityMapping[ek]}if(el){return el}}if(eu){if(!eu._geomType){switch(eu.glType){case 0:eq=0;break;case 1:eq=1;break;default:eq=2}}else{eq=au[eu._geomType]}if((eq===2)&&eu.gas&&(eu.gas.side===0)){eq=5}}else{if(eo instanceof s.Line){eq=1}}var em=es;var dl=es.overridable&&eo.occurrenceRenderingOverride&&eo.occurrenceRenderingOverride.materialOverride;var et=null,er,ep;if(dl){if(!dl.internalMaterialOverride||es!==dl.internalMaterialOverride.material){ep=dl.getOpacity();if(ep!==null){et=ep<1?true:false}}}if(c4.useRenderPriorityOpacity){var en=c4.computeRenderPriorityOpacity(1,dl);if(en<1){et=true}}if(et||(et===null&&!es.iterative&&(em.getOpacity()<1)||em.transparent)){el=dZ[eq]}else{el=cF[eq]}return el};var ea=function(dl){if(!dl.geometry.length){return false}var dg=dl.geometry[0];var ek=dg.drawingGroups;if(!ek||!ek.length){return false}return ek[0].gas&&ek[0].gas.isGAS};var dy=[];var cZ=d5.length;var dt=this.materialToUse===s.MaterialToUse.originalMaterial;var cG=this.materialToUse===s.MaterialToUse.depthMaterial;var d1=this.materialToUse===s.MaterialToUse.normalDepthMaterial;var da=this.materialToUse===s.MaterialToUse.normalMaterial;var d2=this.materialToUse===s.MaterialToUse.ZOnlyMaterial;var c9=dt||d2;var dm=(this.materialToUse===s.MaterialToUse.pickingMaterial)||(this.materialToUse===s.MaterialToUse.pickingMaterialInstancing);var dD=this._oitMaterial=this.materialToUse===s.MaterialToUse.oitAccumMaterial||this.materialToUse===s.MaterialToUse.oitRevealMaterial;var c1=(dm||cG||da);var d9=s.MaterialToUse.gasLookMaterial;var dQ=this.materialToUse;var c3=false;var cQ=this.resetGSSOCacheFrame;var dS=d6&&!d6.isOrtho;for(var cH=0;cH<cZ;++cH){var dI=d5[cH];if(!dI||!dI.render){continue}var dY=dI.object,dT=dI.buffer,cT=dY._gsso_cache;dY.z=dI.z;var cL=cT?cT.length:0;if(dJ&&cL>0&&cT[0].resetFrameIndex>=cQ){var eb,db,dL,cJ;dY.renderLineMode=cT[0].renderLineMode;for(eb=0;eb<cT.length;eb++){db=cD._displayLists[cT[eb].dl];dL=cT[eb].args;cJ=(dL.length===6);if(cJ){dL[0]=db;dy.push(dL)}else{dL[6]=cw;db.addDrawable(dL[0],dL[1],dL[2],dL[3],dL[4],dL[5],dL[6],dL[7],dL[8],dL[9],dL[10],dL[11],this.currentFrameIndex,dL[12])}}continue}if(dJ){dY._gsso_cache=[]}var ee=dY.material;var c8=dY.renderPointsOnly;if(!dt&&(dY instanceof s.Line)){continue}if(c1&&!dY.drawInHLRender){continue}if(d1&&!dY.enableNormalDepth){continue}var eh=null;var df=null;var dC=null;var d7=ee;var ec=this.newMaterialInheritance||ea(dY);if(!ec&&ee){if(!ee._deferredMaterialsInit){ee.updateDeferredMaterials()}if(dD&&!ee._deferredMaterials[dQ]){continue}if(ee.line&&!ee.line._deferredMaterialsInit){ee.line.updateDeferredMaterials()}if(ee.point&&!ee.point._deferredMaterialsInit){ee.point.updateDeferredMaterials()}dC=ee._deferredMaterials[this.materialToUse]}if(dC===undefined){dC=ee}var dO=dY.material;var cI=dY.matApp;var cP=dY.gas;var di=dY.layer;var cV=this.getRenderMode(dY);dY.renderLineMode=cV.getRenderLineMode();var cC=this.getMaterialMode(dY);if((dY.geometry._type===2)||(dY.geometry.length>=0)){if(dY.fromLoadedModel&&cV&&(cV._mask&s.OutlineMask)&&c9){if(!dY.geometry[0].vertexIndexArray){console.warn("OutlineBuilding unavailable, make sure noMeshInRAM is inactive")}else{var dN=dY.outlinesGeometry!==null?dY.outlinesGeometry.geometry:null;if(dN){if(dY.layer&&!dY.layer.upToDate){dN.dispose();dN=null;dY.outlinesGeometry=null;dY.layer.upToDate=true}else{if(dY.outlinesGeometry.outlineWidth!==cV._outlineWidth){if(dY.outlinesGeometry.outlineWidth===1||cV._outlineWidth===1){dN=c.convertOutlineGeometry(dN,dY.outlinesGeometry.outlineWidth,cV._outlineWidth,cw);dY.outlinesGeometry.geometry=dN}else{c.convertWideWidth(dN,cV._outlineWidth,cw)}dY.outlinesGeometry.outlineWidth=cV._outlineWidth}}}if(dN===null){var dR=new c(dY,cV._outlineWidth,cw);dN=dR.computeOutlineGeometry();if(dN!==null){dN.addEventListener("dispose",aZ);dY.outlinesGeometry={geometry:dN,outlineWidth:cV._outlineWidth};c3=true}}if(dN!==null){var ei=dN.drawingGroups[0];this.addDGToDL(dY,dN,ei,ei,ei.material,ei.material,dy,cV&&cV.renderLineMode,dB,aZ,dJ,d6)}}}var ef=null;if(cV&&(cV._gssoMask&s.SectionLineMask)){if(!dY.geometry[0].vertexIndexArray){console.warn("SectionLineBuilding unavailable, make sure noMeshInRAM is inactive")}else{var cY=dY.sectionLinesBuilder&&dY.sectionLinesBuilder.sectionLineGeometry;var dh=null,dF,cN;if(dY.occurrenceRenderingOverride&&dY.occurrenceRenderingOverride.sectionLinesProperties){dh=dY.occurrenceRenderingOverride.sectionLinesProperties;dF=dh.color;cN=dh.width}else{dF=null;cN=1}if(cY&&((dY.layer&&!dY.layer.upToDate)||dY.sectionLinesBuilder.lineWidth!==cN)){dY.sectionLinesBuilder=null;cY.dispose();cY=null;if(dY.layer){dY.layer.upToDate=true}}if(!cY&&!dY.sectionLinesBuilder){var cO=new r(dY,this,cN);cO.computeSectionLineGeometry();cY=cO.sectionLineGeometry;if(cY){cY.addEventListener("dispose",aZ)}dY.sectionLinesBuilder=cO}if(cY){var d8=cY.drawingGroups[0];if(dF!=null){d8.material.uniforms.color.value.set(dF)}else{ef=d8.material}this.addDGToDL(dY,cY,d8,d8,d8.material,d8.material,dy,cV&&cV.renderLineMode,dB,aZ,dJ,d6)}}}if((di!==null)&&(di!==undefined)&&(!this.cuttingScene||ec)){var dA=di.layers.length;var dz=null;for(var dv=0;dv<dA;dv++){var ej=di.layers[dv];if(ej.drawableInterval.layerNum<=0){continue}var eg=ej.geometry;var c5=ej.drawableGroup;if(ec){var ds=c5.glType;if(c8&&(ds!=c2)){continue}var dH=ej.drawableInterval.material;var dj=ej.drawableInterval.gas;if(!dH){dH=c5.material}if(!dj){dj=c5.gas}var dX=null;var d4=null;if(cC){var dq=cI&&cI._getMaterialFromGLType(ds,c5._geomType);if(dH){if(dH.isMatApp){cK=dH.solveInheritance(cI);dX=(cK===cI)?dq:dH._getMaterialFromGLType(ds,c5._geomType)}if(!dX&&!dH.isMatApp){cK=dq?cI:null;dX=dq?dq:dH}}if(!dX){cK=cI;dX=dq}}if(!cC||!dX){if(dO&&dO.force){dX=dO}else{var dV;if(cP){dV=cP.getMaterial(dj,ds,c5._geomType)}else{dV=dj.isGAS?dj.getMaterial(null,ds,c5._geomType):dj}if(dV){dX=dV}}}if(dX&&!dX._deferredMaterialsInit){if(typeof(dX.updateDeferredMaterials)===typeof(Function)){dX.updateDeferredMaterials()}}if(this.cuttingScene){if(dz!==null){dX=dz}else{dz=dX}}d4=dX._deferredMaterials[dQ];if(dD&&!d4){continue}if(dX.backMaterial){var dp=dX.backMaterial._deferredMaterials[dQ];dp&&this.addDGToDL(dY,eg,c5,ej.drawableInterval,dp,dX,dy,cV,dB,aZ,dJ,d6)}this.addDGToDL(dY,eg,c5,ej.drawableInterval,d4,dX,dy,cV,dB,aZ,dJ,d6)}else{if(c8&&(c5.glType!=c2)){continue}var dH=ej.drawableInterval.material;eh=dC;df=d7;if(!c5.gas._deferredMaterialsInit){c5.gas.updateDeferredMaterials()}if(c5.material&&!c5.material._deferredMaterialsInit){if(typeof(c5.material.updateDeferredMaterials)===typeof(Function)){c5.material.updateDeferredMaterials()}}if(dH!==null){if(!dH._deferredMaterialsInit){dH.updateDeferredMaterials()}eh=dH._deferredMaterials[dQ];df=dH}else{if(!ee.force||(ee.force==="forceGeomTypeFACE")){if(cC&&c5.material&&typeof(c5.material.updateDeferredMaterials)===typeof(Function)){eh=c5.material._deferredMaterials[dQ];df=c5.material}else{if(cC&&dt&&(c5._geomType===dU)){if(!c5.gas._deferredMaterials[d9]){c5.gas.updateGasLookMaterial()}if(this.gasLookMode){eh=c5.gas._deferredMaterials[d9]}else{eh=c5.gas._deferredMaterials[dQ]}}else{eh=c5.gas._deferredMaterials[dQ]}df=c5.gas}if(ee.force&&(c5._geomType===dU)){eh=dC}}}if(dD&&!eh){continue}if(eh.backMaterial){this.addDGToDL(dY,eg,c5,ej.drawableInterval,eh.backMaterial,df,dy,cV,dB,aZ,dJ,d6)}if(((c5.glType==dr)||(c5.glType==dP))&&(eh.line)){eh=eh.line}if((c5.glType==c2)&&(eh.point)){eh=eh.point}this.addDGToDL(dY,eg,c5,ej.drawableInterval,eh,df,dy,cV,dB,aZ,dJ,d6)}}}else{var dW=null;var c0=0;if(dY.geometry.length>=0){dW=dY.geometry[0];c0=dY.geometry.length}else{if(dY.geometry._type===2){dW=dY.geometry;c0=1}}if(ec){var dd=dW;var d3=null;var dw;if(this.cuttingScene||ef){for(dw=0;dw<c0;dw++){var dE=dW.drawingGroups;var cS=0;var du=dE.length;for(var dx=0;dx<du;dx++){var c5=dE[dx];if(c5._geomType===dU&&!c8){if(c5.count>cS){if(cC&&c5.material&&typeof(c5.material.updateDeferredMaterials)===typeof(Function)){d3=c5.material._deferredMaterials[dQ]}else{if(!c5.gas.isGAS){d3=c5.gas._deferredMaterials[dQ]}}cS=c5.count}}}dW=dY.geometry[dw+1]}if(ef&&!this.cuttingScene&&d3&&d3.color){ef.uniforms.color.value.copy(d3.color);d3=null}}dW=dd;for(dw=0;dw<c0;dw++){var dE=dW.drawingGroups;var du=dE.length;for(var dx=0;dx<du;dx++){var c5=dE[dx];var ds=c5.glType;if(c8&&(ds!=c2)){continue}var cK=null;var dX=null;var d4=null;if(d3&&c5._geomType===dU){dX=d3}else{if(cC){var dq=cI&&cI._getMaterialFromGLType(ds,c5._geomType);if(c5.material){if(c5.material.isMatApp){cK=c5.material.solveInheritance(cI);dX=(cK===cI)?dq:c5.material._getMaterialFromGLType(ds,c5._geomType)}if(!dX&&!c5.material.isMatApp){cK=dq?cI:null;dX=dq?dq:c5.material}}if(!dX){cK=cI;dX=dq}}}if(!cC||!dX){if(dO&&dO.force){dX=dO}else{var dV;if(cP){dV=cP.getMaterial(c5.gas,ds,c5._geomType)}else{dV=c5.gas.isGAS?c5.gas.getMaterial(null,ds,c5._geomType):c5.gas}if(dV){dX=dV}}}if(dX&&!dX._deferredMaterialsInit){if(typeof(dX.updateDeferredMaterials)===typeof(Function)){dX.updateDeferredMaterials()}}d4=dX._deferredMaterials[dQ];if(dD&&!d4){continue}if(dX.backMaterial){var dp=dX.backMaterial._deferredMaterials[dQ];dp&&this.addDGToDL(dY,dW,c5,c5,dp,dX,dy,cV,dB,aZ,dJ,d6)}this.addDGToDL(dY,dW,c5,c5,d4,dX,dy,cV,dB,aZ,dJ,d6)}dW=dY.geometry[dw+1]}}else{if((ee&&ee.force&&ee.force!=="forceGeomTypeFACE")&&(cC||!dY.fromLoadedModel)){for(var dw=0;dw<c0;dw++){var c5=dW.drawingGroups;var du=c5.length;for(var dx=0;dx<du;dx++){if(c8&&(c5[dx].glType!=c2)){continue}eh=dC;df=d7;if(dD&&!eh){continue}if(eh.backMaterial){this.addDGToDL(dY,dW,c5[dx],c5[dx],eh.backMaterial,df,dy,cV,dB,aZ,dJ,d6)}if((c5[dx].glType===dr)||(c5[dx].glType===dP)){if(df.line&&df.line._deferredMaterials[dQ]){eh=df.line._deferredMaterials[dQ]}else{if(eh.line){eh=eh.line}}}else{if(c5[dx].glType===c2){if(df.point&&df.point._deferredMaterials[dQ]){eh=df.point._deferredMaterials[dQ]}else{if(eh.point){eh=eh.point}}}else{if(dt&&dW.lightMap){if(!df._withLightMap[dW.lightMap.id]){eh=df.clone();eh.lightMap=dW.lightMap;eh.lightMapLinear=dW.lightMap.hdr;eh.needsUpdate=true;df._withLightMap[dW.lightMap.id]=eh}else{eh=df._withLightMap[dW.lightMap.id]}}}}this.addDGToDL(dY,dW,c5[dx],c5[dx],eh,df,dy,cV,dB,aZ,dJ,d6)}dW=dY.geometry[dw+1]}}else{var d3=null;var dw;var dd=dW;for(dw=0;dw<c0;dw++){var dE=dW.drawingGroups;var cS=0;var du=dE.length;for(var dx=0;dx<du;dx++){var c5=dE[dx];if(c8&&(c5.glType!=c2)){continue}if(!c5.gas._deferredMaterialsInit){c5.gas.updateDeferredMaterials({gasLook:true})}if(c5.material&&!c5.material._deferredMaterialsInit){if(typeof(c5.material.updateDeferredMaterials)===typeof(Function)){c5.material.updateDeferredMaterials()}}}dW=dY.geometry[dw+1]}dW=dd;if(this.cuttingScene||ef){for(dw=0;dw<c0;dw++){var dE=dW.drawingGroups;var cS=0;var du=dE.length;for(var dx=0;dx<du;dx++){var c5=dE[dx];if(c5._geomType===dU&&!c8){if(c5.count>cS){if(cC&&c5.material&&typeof(c5.material.updateDeferredMaterials)===typeof(Function)){d3=c5.material._deferredMaterials[dQ]}else{d3=c5.gas._deferredMaterials[dQ]}cS=c5.count}}}dW=dY.geometry[dw+1]}if(ef&&!this.cuttingScene&&d3&&d3.color){ef.uniforms.color.value.copy(d3.color);d3=null}}if(!this.cuttingScene){if(ee&&ee.force==="forceGeomTypeFACE"){d3=dC}}dW=dd;for(dw=0;dw<c0;dw++){var dE=dW.drawingGroups;var du=dE.length;for(var dx=0;dx<du;dx++){var c5=dE[dx];var ds=c5.glType;if(c8&&(ds!=c2)){continue}var cW;if(cC&&c5.material&&typeof(c5.material.updateDeferredMaterials)===typeof(Function)){cW=c5.material._deferredMaterials[dQ];df=c5.material}else{if(cC&&dt&&(c5._geomType===dU)){if(!c5.gas._deferredMaterials[d9]){c5.gas.updateGasLookMaterial()}if(this.gasLookMode){cW=c5.gas._deferredMaterials[d9]}else{cW=c5.gas._deferredMaterials[dQ]}}else{cW=c5.gas._deferredMaterials[dQ]}df=c5.gas}if(d3&&c5._geomType===dU){eh=d3}else{eh=cW}if(dD&&!eh){continue}if(eh.backMaterial){this.addDGToDL(dY,dW,c5,c5,eh.backMaterial,df,dy,cV,dB,aZ,dJ,d6)}if(((ds==dr)||(ds==dP))&&(eh.line)){eh=eh.line}if((ds==c2)&&(eh.point)){eh=eh.point}this.addDGToDL(dY,dW,c5,c5,eh,df,dy,cV,dB,aZ,dJ,d6)}dW=dY.geometry[dw+1]}}}}}else{if(ec&&dO){if(!dO._deferredMaterialsInit){if(typeof(dO.updateDeferredMaterials)===typeof(Function)){dO.updateDeferredMaterials()}}if(dO.backMaterial){this.addDGToDL(dY,dT,null,null,dO.backMaterial._deferredMaterials[dQ],dO,dy,null,dB,aZ,dJ,d6)}this.addDGToDL(dY,dT,null,null,dO._deferredMaterials[dQ],dO,dy,null,dB,aZ,dJ,d6)}else{if(dC.backMaterial){this.addDGToDL(dY,dT,null,null,dC.backMaterial._deferredMaterials[dQ],d7,dy,null,dB,aZ,dJ,d6)}this.addDGToDL(dY,dT,null,null,dC,d7,dy,null,dB,aZ,dJ,d6)}}}if(c3){c.TexturesManager.finalize()}dy.sort(m);for(var dx=dy.length-1;dx>=0;dx--){var cR=dy[dx];var dY=cR[2];var cV=this.getRenderMode(dY);cR[0].addDrawable(cR[1],dY,cR[3],cR[4],cR[5],cV,cw,this.fixedSizeArrayPool,this.renderVolumesOnly,aZ,d6,this.domElement,this.currentFrameIndex,this.materialToUse)}for(dx=0;dx<cD._displayLists.length;dx++){cD._displayLists[dx].finalize()}if(c6){for(var dx=0;dx<cD._displayLists.length;dx++){var cX=cD._displayLists[dx];if((cX.name==="TRANSPAR")||(cX.name==="NOZTRANSPAR")){continue}var d0=cX._materialList.length;cX._materialList.length=cX.usefulListLength;cX._materialList.sort(function(el,ek){var dl=el.material;var dg=ek.material;if(!dl.program){return -1}else{if(!dg.program){return 1}else{if(dg.program!==dl.program){return dl.program.id-dg.program.id}else{return el.occurrenceRenderingOverrideId-ek.occurrenceRenderingOverrideId}}}});cX._materialList.length=d0}}};this.renderCuttingElements=function(cE,cQ,cT,cC,cM){function cL(cV){if(cV&&(cV instanceof s.MeshBasicMaterial||cV instanceof s.MeshPhongMaterial||cV instanceof s.MeshLambertMaterial)&&!cV.map){return true}return false}if(this.cuttingScene){var cO=bk.getContext();var cU;var cF="NOTEQUAL";cO.stencilFunc(cO[cF],100,255);cO.colorMask(true,true,true,true);cO.stencilMask(0);cO.enable(cO.CULL_FACE);this.setDepthWrite(true);var cH=this.disableBackFaceClipPlanes;this.disableBackFaceClipPlanes=0;var cJ=cM&&cM.clipPlanes;var cS=this.cuttingScene.getWebGLObjects("main",this.currentFrameIndex);if(cM&&cM.clippingSettings&&cM.clippingSettings.frontOpacity===0){cO.cullFace(cO.FRONT)}if(cJ){var cD=[];var cP,cN,cR;for(cP=0;cP<cJ.length;cP++){cR=cJ[cP].clippingContext&&cJ[cP].clippingContext[this.id];if(cR&&cR.clippingMeshIndex>0){cD.push(cS[cR.clippingMeshIndex-1])}}cS=cD}var cG=0;var cN;var cK;for(cG=cS.length-1;cG>=0;cG-=1){if(cS[cG]===null){continue}cK=null;cU=null;if(cM&&cM.sectionCappingMaterials){cK=cM.sectionCappingMaterials.defaultMaterial;for(cN=0;cN<cM.sectionCappingMaterials.length;cN++){if(cM.sectionCappingMaterials[cN].clippingPlane===cS[cG].object.clippingPlane){cK=cM.sectionCappingMaterials[cN].material;break}}if(cK){cK.clipPlaneIndex=cG+1;cS[cG].object.geometry.normalsNeedUpdate=true}}bT(cS[cG].object,cQ);if(cE&&cE.enableReceiveShadowOnCapping){cS[cG].object.receiveShadow=true}if(this.shadowMapEnabled){aN(cT,cS[cG].object,this)}cS[cG].render=true;if(this.materialToUse===s.MaterialToUse.normalDepthMaterial||(!cK&&cS[cG].object.material.clipPlaneUseModelMaterial)){if(this.materialToUse===s.MaterialToUse.normalDepthMaterial||cL(cE)){cK=cE;cU=cM&&this.materialToUse!==s.MaterialToUse.normalDepthMaterial&&cM.materialOverride}else{if(!this.backupCuttingMaterial){this.backupCuttingMaterial=new s.MeshPhongMaterial({color:"black"})}cK=this.backupCuttingMaterial}cK.clipPlaneIndex=cG+1}else{cK=cK||cS[cG].object.material;if(cK){cK.clipPlaneIndex=cG+1}if(cK instanceof s.HatchingMeshMaterial){var cI;if(cK.autoSpaceColor){if(cL(cE)){cI=cM&&cM.getOverrideColor(cE);cK.spaceColor=cI||cE.color}else{cI=cM&&cM.getOverrideColor();cK.spaceColor=cI||new s.Color(16777215)}}if(cK.autoStripesColor){if(cL(cE)){cK.stripesColor=cI||cE.color}else{cK.stripesColor=cI||new s.Color(0)}}}}this._clipPlanesState.update(cM,null,true,cK,cQ,true);am(cS[cG].object,cK);cK._renderedClipPlane=cS[cG].object.clippingPlane;cx(true,1,1);this.renderObjects([cS[cG]],false,"",cQ,cT,cC,true,cK,cU);cK._renderedClipPlane=null;if(this.materialToUse===s.MaterialToUse.normalDepthMaterial||cS[cG].object.material.clipPlaneUseModelMaterial){cK.clipPlaneIndex=0}}if(cM&&cM.clippingSettings&&cM.clippingSettings.frontOpacity===0){cO.cullFace(cO.BACK)}this.setDepthWrite(false);cO.disable(cO.CULL_FACE);cO.stencilFunc(cO.ALWAYS,100,255);cO.colorMask(false,false,false,false);cO.stencilMask(255);this.clear(false,false,true);this.disableBackFaceClipPlanes=cH;this._clipPlanesState.update(null,null,true,cE,cQ);return true}return false};this.renderAssets=function(){if(this.ambianceGenerators!==null&&this.ambianceGenerators.needsUpdate){this.ambianceGenerators.update(this.currentFrameIndex,this)}};this.updateCSSNodes=function(cS,cQ){var cV=cS.getWebGLObjects("css2d",this.currentFrameIndex);var cJ=cS.getWebGLObjects("css3d",this.currentFrameIndex);var cC,cT;cQ.matrixWorldInverse.getInverse(cQ.matrixWorld);if(cJ.length&&cQ._viewpoint){var cK=0.5/Math.tan(s.Math.degToRad(cQ.fov*0.5))*b6;var cP=cQ._viewpoint.divCameraCSSElement;aF.style.WebkitPerspective=cK+"px";aF.style.MozPerspective=cK+"px";aF.style.oPerspective=cK+"px";aF.style.perspective=cK+"px";var cR="translate3d(0,0,"+cK+"px)"+U(cQ.matrixWorldInverse)+" translate3d("+aD+"px,"+T+"px, 0)";cP.style.WebkitTransform=cR;cP.style.MozTransform=cR;cP.style.oTransform=cR;cP.style.transform=cR}var cN=null;var cO;for(cO=0;cO<cV.length;cO++){cC=cV[cO];if(cC===null){continue}cT=cC.object;cC.render=false;cT.render=false;var cH=true;if(cT.visibilityFree){cH=cT.visible}else{cH=this.visibleSpace?cT.visible:!cT.visible}if(cH){if(this.renderIteration>0){continue}var cF=new s.Vector3();cF.copy(cT.position);var cU=false;if(this.clipPlanesEnabled){for(var cM=0;cM<this.clipPlanes.length;cM++){var cG=this.clipPlanes[cM];var cE=cG.normal.x*cT.position.x+cG.normal.y*cT.position.y+cG.normal.z*cT.position.z+cG.constant;if(cE<0){cU=true;break}}}if((cQ.isOrtho||cQ.getLookAt().dot(cQ.position.clone().sub(cF))<0)&&!cU){var cI=new s.Projector();cI.projectVector(cF,cQ);cT.element.style.display="block";cT.element.style.left=(cT.offset.x+(cF.x+1)/2*this.domElement.width)/(window.devicePixelRatio||1)+"px";cT.element.style.top=(cT.offset.y+(-cF.y+1)/2*this.domElement.height)/(window.devicePixelRatio||1)+"px";if(!cN){cN=[]}cN.push({domElement:cT.element,z:cF.z,alwaysOnTopIndex:cT._occurrence?cT._occurrence.node._alwaysOnTopIndex:null})}else{cT.element.style.display="none"}}}for(cO=0;cO<cJ.length;cO++){cC=cJ[cO];if(cC===null){continue}cT=cC.object;cC.render=false;cT.render=false;var cH=true;if(cT.visibilityFree){cH=cT.visible}else{cH=this.visibleSpace?cT.visible:!cT.visible}if(cH){if(this.renderIteration>0){continue}if(cQ._viewpoint){var cL=new s.Matrix4().multiplyMatrices(cT.matrixWorld,cT.scaleCSS);var cR=aO(cL);var cD=cT.element;cD.style.WebkitTransform=cR;cD.style.MozTransform=cR;cD.style.oTransform=cR;cD.style.transform=cR;cD.style.pointerEvents="auto";if(cD.parentNode!==cP){cP.appendChild(cD)}}}}if(cN){cN.sort(function(cX,cW){var cZ=cX.alwaysOnTopIndex!==null,cY=cW.alwaysOnTopIndex!==null;if(cZ||cY){if(!cZ){return -1}else{if(!cY){return 1}else{if(cX.alwaysOnTopIndex!==cW.alwaysOnTopIndex){return cX.alwaysOnTopIndex-cW.alwaysOnTopIndex}}}}return cW.z-cX.z});for(cO=0;cO<cN.length;cO++){cN[cO].domElement.style.zIndex=20+cO}}};function aN(cF,cE){if(!cE.geometry.length||!cE.currentShadowMatrices||cw!==cE.currentShadowMatrices._sortCount){if(!cE.receiveShadow){return}cE.currentShadowMatrices=[];cE.currentShadowMatrices._sortCount=cw;for(var cG=0;cG<cF.length;cG++){var cD=cF[cG];if(!cD.castShadow){continue}if(cD instanceof s.SpotLight||(cD instanceof s.DirectionalLight&&!cD.shadowCascade&&(!cD.isVirtual||bk.shadowMapCascade))){var cC=new s.Matrix4();cC.copy(cD.shadowMatrix);cC.multiply(cE.matrixWorld);cE.currentShadowMatrices.push(cC)}}}}function bT(cC,cD){if(!cC.isUniformlyScaled){cC._normalMatrix.getInverse(new s.Matrix4().multiplyMatrices(cD.matrixWorldInverse,cC.matrixWorld));cC._normalMatrix.transpose()}cC._modelViewMatrix._multiplyDoubleMatricesMV(cD.matrixWorldInverse,cC.matrixWorld);if(cC.modelViewInvTranspMatrix){cC.modelViewInvTranspMatrix.multiplyDoubleMatricesAndInverse(cD.matrixWorldInverse,cC.matrixWorld).transpose()}}this.computeCulling=function(cF,cE,cD,cC){};this.render=function(c5,cW,dg,cN,cY,dJ,cS,dj){this._clipPlanesState.update(null,null,true,null,cW);ac=null;if(cW instanceof s.Camera===false){console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");return}var dA,de,cP,dp,ds,c8,cI=c5.__lights,dz=c5.fog;cI.sort(c5._lightSort);bA=-1;bz=-1;aL=null;bI=null;aK=null;cB=true;ao=c5.computeLightsKey();if(this.autoUpdateScene){c5.updateMatrixWorld()}if(this.cuttingScene){this.cuttingScene.updateMatrixWorld()}if(cW.parent===undefined){cW.updateMatrixWorld()}cW.matrixWorldInverse.getInverse(cW.matrixWorld);if(!cW.orientation){cW.orientation=(cW.matrixWorld.determinant()>0)?1:-1}bw.multiplyMatrices(cW.projectionMatrix,cW.matrixWorldInverse);b8.setFromMatrix(bw);if(this.autoUpdateObjects){this.initWebGLObjects(c5)}if(this.cuttingScene){this.initWebGLObjects(this.cuttingScene)}if(this.enableRenderPluginsPre){K(this.renderPluginsPre,c5,cW)}bk.info.render.reset();this.setRenderTarget(dg);if(this.autoClear||cN){this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil)}if(this.disableColorWrite){w.colorMask(false,false,false,false)}this.setStencilWrite(this.enableStencilWrite);var cJ=this.currentPass?this.currentPass.idString:null;var dd=(this.materialToUse===s.MaterialToUse.pickingMaterial);var dm=(this.materialToUse===s.MaterialToUse.pickingMaterial||this.materialToUse===s.MaterialToUse.normalMaterial||this.materialToUse===s.MaterialToUse.depthMaterial);if(cS){var ds=c5.getWebGLObjects(cJ,this.currentFrameIndex);window.webVisuPerfo.startPerfo("cull");var dt=cW.getCameraConstant(1,s.glStates.currentHeight);if(cW.fullWidth){dt*=cW.height/cW.fullHeight;if(!cW.useRealSize){cW.fixedSizeCameraConstant=this.devicePixelRatio*dt}else{if(cW.useRealSize&&cW.visualizedHeight){cW.fixedSizeCameraConstant=this.devicePixelRatio*cW.getCameraConstant(1,cW.fullHeight)}}}else{cW.fixedSizeCameraConstant=this.devicePixelRatio*dt}cW.pixelCullingCst=cW.pixelCulling*dt;var dE=cW.matrixWorldInverse.elements;var dA,cP,dp;var c4=ds.length,c6=0;var dD=this.shadowMapEnabled;var df=this.sortObjects;for(dA=0;dA<c4;dA++){cP=ds[dA];if(cP===null){continue}dp=cP.object;cP.render=false;dp.render=false;var di=true;if(dp.visibilityFree){di=dp.visible}else{di=this.visibleSpace?dp.visible:!dp.visible}if(di){if(!(dp.frustumCulled)||cW.performPixelAndFrustumCulling(b8,dt,dp)){if(dp.beforeRenderCB&&!dm){dp.beforeRenderCB(dp,{viewpoint:cW._viewpoint,camera:cW})}c5.__webglObjectsToDraw[c6]=cP;c6++;bT(dp,cW);if(dD){aN(cI,dp)}cP.render=true;dp.render=true;if(df){if(dp.renderDepth!==null){cP.sortKey=dp.renderDepth;cP.z=dp.renderDepth}else{var du=dp.worldRadius;var da=dp.worldCenter;var cG=dE[2]*da.x+dE[6]*da.y+dE[10]*da.z+dE[14];cP.z=cG+du}}}else{this.info.render.culledMeshes++}}}window.webVisuPerfo.endPerfo("cull");c5.__webglObjectsToDraw.length=c6;var dv=c5.__webglObjectsToDraw;window.webVisuPerfo.startPerfo("sort");if(this._sortRenderListByBuffer){dv.sort(j)}else{dv.sort(b)}window.webVisuPerfo.endPerfo("sort");var dw=!c5.isBackground;window.webVisuPerfo.startPerfo("gsso");this.getStateSortedObjects(dv,dw,dJ,dj,cW,dt,b8);window.webVisuPerfo.endPerfo("gsso")}this.setBlending(s.NoBlending);var cF=false;dJ._displayLists[5].active=!cY;window.webVisuPerfo.startPerfo("draw");var c3=null;var cD=this.materialToUse===s.MaterialToUse.originalMaterial||this.materialToUse===s.MaterialToUse.oitAccumMaterial||this.materialToUse===s.MaterialToUse.oitRevealMaterial;var dy=this.materialToUse===s.MaterialToUse.highlightMaterial;var cE=this.materialToUse===s.MaterialToUse.outlineHighlightMaterial;var dr=this.useOIT&&this.currentPass.isOITPass&&cD;var dH=w.TRIANGLES;for(var dx=0;dx<dJ._displayLists.length;dx++){var cM=dJ._displayLists[dx];var cL=cM.usefulListLength;if(!cM.active||cL===0){continue}if(cM.depthFunc){w.depthFunc(w[cM.depthFunc])}if(dd){if((dx>0)&&(cM.pickingPriority||cF)){w.clear(w.DEPTH_BUFFER_BIT)}cF=!!cM.pickingPriority}if(cM.useStencil){if((cM.name!=="NOZ")||(cM.name==="NOZ"&&this.materialToUse===s.MaterialToUse.originalMaterial)){w.enable(w.STENCIL_TEST);w.stencilFunc(w.ALWAYS,1,255);w.stencilOp(w.KEEP,w.KEEP,w.REPLACE);w.stencilMask(255)}}var cK=cM._materialList;var c2=cM.depthWrite;if(cM.hasTranspar&&!this.currentPass.isOITPass){c2=false}for(var cU=0;cU<cL;cU++){bB=null;ac=null;var dC=cK[cU];var cO=cD&&dC.material.overridable&&dC.occurrenceRenderingOverride&&dC.occurrenceRenderingOverride.materialOverride?dC.occurrenceRenderingOverride.materialOverride:null;if(!this.clipPlanesEnabled&&this.cuttingScene&&(!dC.occurrenceRenderingOverride||!dC.occurrenceRenderingOverride.clipPlanes)){continue}var dG=dC.material;if(!cS){(!dG._deferredMaterialsInit)&&dG.updateDeferredMaterials();dG=dG._deferredMaterials[this.materialToUse];if(!dG){continue}}if(dr!==dG.isOITable){if(dr){dG._programID=dG._programID|s.ProgramIDs.OIT}else{dG._programID=dG._programID&~s.ProgramIDs.OIT}}dG.isOITable=dr;dG._setupOIT(this.materialToUse);if(cO&&cO.internalMaterialOverride&&cO.internalMaterialOverride.material===dG){cO=null}var dc=cM._displayRangeLists[dC.id];var dq=dG;if(!dG.areTexturesLoaded()){if(dG.transparent){dG._setupOIT(0);continue}else{dq=this.loadingTextureMaterial}}var cX=dc.first;if(!cX){dG._setupOIT(0);continue}if(dG.isPhysicalMaterial){if(c5.envMipMap.length>0){if(c5.envMipMap[0].hdr&&(c5.envMipMap[1]===null||c5.envMipMapID)){var dh="s"+c5.envMipMap[0].id;var cR="generator";cR+="-"+dh;cR+="-GGX";if(this.ambianceGenerators.manager){var c1=this.ambianceGenerators.getAmbiance(cR,true,{hdr:c5.envMipMap[0],brdf:"GGX"},dh);this.ambianceGenerators.needsUpdate=this.ambianceGenerators.needsUpdate||!c1.complete;c1=c1.ambiance;c5.envMipMap[1]=c1;if(c5.envMipMapID&&c5.envMipMapID!==dh){this.ambianceGenerators.decreaseUseCount(c5.envMipMapID)}}else{this.ambianceGenerators.init(0)}c5.envMipMapID=dh}}var c9=dG.overrideIBL!==null&&dG.overrideIBL.hdr!==null;var cH=c9&&dG.overrideIBL.hdr.loadEndStatus==="complete";var c7=c9&&dG.overrideIBL.hdr.loadEndStatus==="useCurrent"&&c5.envMipMap.length>0;c9=cH||c7;if((c5.envMipMap.length>0&&c5.envMipMap[1])||c9){if(c9){var dk=dG.overrideIBL;var cQ=c7?c5.envMipMap[0]:dk.hdr;var cR="generator";cR+="-"+dk.name;cR+="-"+cQ.id;cR+="-"+dk.brdf;var c1=null;if(dk.mips!==null){c1=dk.mips}else{if(this.ambianceGenerators.manager){c1=this.ambianceGenerators.getAmbiance(cR,!dk.direct,{hdr:cQ,brdf:dk.brdf},dG.id);this.ambianceGenerators.needsUpdate=this.ambianceGenerators.needsUpdate||!c1.complete;c1=c1.ambiance}else{this.ambianceGenerators.init(0)}}if(c1!==null){if(dG.envMipMap){dG.needsUpdate=!(c1.hasDiffuse===dG.envMipMap[1].hasDiffuse)}else{dG.needsUpdate=true}dG.envMap=cQ;dG.envMipMap=[cQ,c1]}}else{if(!dG.envMap){dG.needsUpdate=true}dG.envMipMap=c5.envMipMap;dG.envMap=c5.envMipMap[0]}dG.ambienceMatrix=c5.ambienceMatrix}else{if(!c5.reflectionProbes.length){if(dG.envMap){dG.needsUpdate=true}dG.envMipMap=null;dG.envMap=null}}if(dG.sheen>0||dG.sheenMap){var db=dG._sheenData.overrideIBL!==null&&dG._sheenData.overrideIBL.hdr!==null;var dB=db&&dG._sheenData.overrideIBL.hdr.loadEndStatus==="complete";var c0=db&&dG._sheenData.overrideIBL.hdr.loadEndStatus==="useCurrent"&&c5.envMipMap.length>0;db=dB||c0;if(db){var dk=dG._sheenData.overrideIBL;var cQ=c0?c5.envMipMap[0]:dk.hdr;var cR="generator";cR+="-"+dk.name;cR+="-"+cQ.id;cR+="-"+dk.brdf;var c1=null;if(this.ambianceGenerators.manager){var c1=this.ambianceGenerators.getAmbiance(cR,!dk.direct,{hdr:cQ,brdf:dk.brdf},dG.id);this.ambianceGenerators.needsUpdate=this.ambianceGenerators.needsUpdate||!c1.complete;c1=c1.ambiance}else{this.ambianceGenerators.init(1)}if(dG._sheenData.envMipMap===null&&c1!==null){dG.needsUpdate=true}dG._sheenData.envMipMap=c1}}else{if(dG._sheenData&&dG._sheenData.envMipMap){dG.needsUpdate=true;dG._sheenData.envMipMap=null}}if(dG.updateSSS){if(this.sssGenerator===null){this.sssGenerator={ready:false};var dF=this;require(["DS/Visualization/SubsurfaceGenerator"],function(dl){dF.sssGenerator=new dl()})}dG._updateSubsurfaceScattering(this.sssGenerator)}if(c5.reflectionProbes.length){dG.envMap=c5.reflectionProbes[0].map0;dG.reflectionProbes=c5.reflectionProbes}else{if(dG.reflectionProbes){dG.needsUpdate=true}dG.reflectionProbes=null}if(c5.useFiniteEnvMap){dG.useFiniteEnvMap=c5.useFiniteEnvMap;dG.parallaxCorrectionParameters=c5.parallaxCorrectionParameters}else{dG.useFiniteEnvMap=false}if(dG.sslr&&this.prevColorBuffer&&this.prevNormalDepthBuffer){dG.__prevColorTexture=this.prevColorBuffer.renderResults.main;dG.__prevNormalDepthTexture=this.prevNormalDepthBuffer.renderResults.main}}if(dG.physical){if(c5.envMipMap.length>0){dG.envMipMap=c5.envMipMap;dG.envMap=c5.envMipMap[0];dG.ambienceMatrix=c5.ambienceMatrix}if(c5.reflectionProbes.length){dG.envMap=c5.reflectionProbes[0].map0;dG.reflectionProbes=c5.reflectionProbes}if(c5.useFiniteEnvMap){dG.useFiniteEnvMap=c5.useFiniteEnvMap;dG.parallaxCorrectionParameters=c5.parallaxCorrectionParameters}if(dG.sslr&&this.prevColorBuffer&&this.prevNormalDepthBuffer){dG.__prevColorTexture=this.prevColorBuffer.renderResults.main;dG.__prevNormalDepthTexture=this.prevNormalDepthBuffer.renderResults.main}}if(dG.isRevealMat){bk.setBlending(s.CustomBlending,dG.blendEquation,s.ZeroFactor,s.OneMinusSrcColorFactor)}else{if(dG.isAccumMat){bk.setBlending(s.CustomBlending,dG.blendEquation,s.OneFactor,s.OneFactor)}else{if(dG.useBlending||(!dG.iterative&&(dG.transparent||dG.getOpacity()<1))){bk.setBlending(dG.blending,dG.blendEquation,dG.blendSrc,dG.blendDst)}else{var cZ=false;if(cO&&cO.hasTransparency()){cZ=true}else{if(this.useRenderPriorityOpacity){var dn=this.computeRenderPriorityOpacity(1,cO);if(dn<1){cZ=true}}}if(cZ){bk.setBlending(s.NormalBlending,s.AddEquation,s.SrcAlphaFactor,s.OneMinusSrcAlphaFactor)}else{bk.setBlending(s.NoBlending)}}}}if(cX[2]&&!cX[2].glType&&cX[2]._geomType===s.GeomTypeEnum.SURFACIC_POINT){bk.setDepthTest(true)}else{bk.setDepthTest(dG.depthTest&&!bk.disableDepthTest)}var dI=c2;if(!c2){if(!this.currentPass.isRobotPass&&cM.hasTranspar&&(!!dq.opacityMap||!!dq.map||(dq.getOpacity()===1&&cO===null)||(cO&&cO.getOpacity()===1))){c2=true}if(this.currentPass.isRobotPass&&dd){c2=true}}bk.setDepthWrite(dG.depthWrite&&c2&&!bk.disableDepthWrite);c2=dI;if(dy||cE){if(dy){if(c5.colorHighlight&&dG.uniforms.iScanEffectIntensity){dG.uniforms.iScanEffectIntensity.value=c5.colorHighlight.intensity}if(c5.colorHighlight&&dG.uniforms.colorHighlight){dG.uniforms.colorHighlight.value.x=c5.colorHighlight.color.r;dG.uniforms.colorHighlight.value.y=c5.colorHighlight.color.g;dG.uniforms.colorHighlight.value.z=c5.colorHighlight.color.b;dG.uniforms.colorHighlight.value.w=c5.colorHighlight.intensity}}if(cE){if(c5.colorHighlight&&dG.uniforms.colorHighlight){dG.uniforms.colorHighlight.value.x=c5.colorHighlight.outlineColor.r;dG.uniforms.colorHighlight.value.y=c5.colorHighlight.outlineColor.g;dG.uniforms.colorHighlight.value.z=c5.colorHighlight.outlineColor.b}}dG.polygonOffset=c5.colorHighlight.polygonOffsetParameters.activated;dG.polygonOffsetFactor=c5.colorHighlight.polygonOffsetParameters.factor;dG.polygonOffsetUnits=c5.colorHighlight.polygonOffsetParameters.unit}if(this.forcePolygonOffset===s.PolygonOffsetForceStatus.DEFAULT){cx(dG.polygonOffset,dG.polygonOffsetFactor,dG.polygonOffsetUnits)}bk._clipPlanesState.update(dC.occurrenceRenderingOverride,c3,false,dq,cW,bk.cuttingScene?true:false);c3=dC.occurrenceRenderingOverride;var dp,cC=false,cT;if(!dq.visible){dG._setupOIT(0);continue}if((dq.overridable&&cO&&cO.getOpacity()===0)||(!cO&&dq.getOpacity()===0)){dG._setupOIT(0);continue}if(this.useRenderPriorityOpacity){var dn=this.computeRenderPriorityOpacity(1,cO);if(dn===0){dG._setupOIT(0);continue}}var cV=true;for(dp=cX;dp;dp=dp.next){cT=dp[2];if(cT&&cT.gas&&!dG.forceSide){this.setMaterialFaces(cT.gas,dp[0],cW,(cT.glType===dH))}else{this.setMaterialFaces(dG,dp[0],cW)}if(dp[1]._type===2){if(cO&&cT&&(cT._geomType===s.GeomTypeEnum.BOUNDARY_EDGE||cT._geomType===s.GeomTypeEnum.SMOOTH_EDGE||cT._geomType===s.GeomTypeEnum.SHARP_EDGE)){cO.disableColorOverride=true}if(dp[0]&&dp[0].sectionLinesBuilder!==null&&dp[0].sectionLinesBuilder.sectionLineGeometry&&dp[1]===dp[0].sectionLinesBuilder.sectionLineGeometry){this.renderSectionLines(cW,cI,dz,dp[0],dq,null,dp[1],cT,dp[3],dp[4],dC.occurrenceRenderingOverride,cO,cV)}else{cC=this.renderInterval(cW,cI,dz,dp[0],dq,null,dp[1],cT,dp[3],dp[4],dC.occurrenceRenderingOverride,cO,cV,dt)}if(cO){cO.disableColorOverride=false}if(cC){cV=false}}else{if(dp[1]._type===1){cC=this.renderBufferDirect(cW,cI,dz,dG,dp[1],dp[0])}else{cC=this.renderBuffer(cW,cI,dz,dG,dp[1],dp[0])}}}if(cC){if(this.renderCuttingElements(dG,cW,cI,dz,dC.occurrenceRenderingOverride)){c3=null}}dG._setupOIT(0)}if(cM.depthFunc){if(this.currentPass.depthFunc){w.depthFunc(w[this.currentPass.depthFunc])}else{w.depthFunc(w.LEQUAL)}}if(cM.useStencil){if((cM.name!=="NOZ")||(cM.name==="NOZ"&&this.materialToUse===s.MaterialToUse.originalMaterial)){w.disable(w.STENCIL_TEST)}}}window.webVisuPerfo.endPerfo("draw");if(this.enableRenderPluginsPost){K(this.renderPluginsPost,c5,cW)}if(dg&&dg.generateMipmaps&&dg.minFilter!==s.NearestFilter&&dg.minFilter!==s.LinearFilter){bs(dg)}if(this.disableColorWrite){w.colorMask(true,true,true,true)}this.setDepthTest(true);this.setDepthWrite(true)};this.doRenderPlugins=function(cC,cG,cE,cF){this.initWebGLObjects(cG);var cD=0;for(cD=0;cD<cC.length;cD++){if(!cC[cD].noRenderTarget){this.setRenderTarget(cF)}}K(cC,cG,cE)};function K(cC,cG,cF){if(!cC.length){return}for(var cE=0,cD=cC.length;cE<cD;cE++){w._currentProgram=null;bg=null;w._oldBlending=-1;u=-1;cd=-1;bX=-1;E=-1;ac=-1;bB=-1,bA=-1;bz=-1;aL=null;bI=null;aK=null;cB=true;cC[cE].render(cG,cF,s.glStates.currentWidth,s.glStates.currentHeight);w._currentProgram=null;bg=null;w._oldBlending=-1;u=-1;cd=-1;bX=-1;E=-1;ac=-1;bB=-1,bA=-1;bz=-1;aL=null;bI=null;aK=null;cB=true}}this.renderObjects=function(cI,cG,cH,cP,cU,cC,cT,cK,cW){var cD,cV,cM,cJ,cF,cE,cR;if(cG){cF=cI.length-1;cE=-1;cR=-1}else{cF=0;cE=cI.length;cR=1}for(var cO=cF;cO!==cE;cO+=cR){cD=cI[cO];if(cD!==null&&cD.render){cV=cD.object;cM=cD.buffer;if(cK){cJ=cK}else{cJ=cD.object.material[this.materialToUse];if(cJ===undefined){cJ=cD.object.material}if(!cJ){continue}if(cT||cJ.useBlending){bk.setBlending(cJ.blending,cJ.blendEquation,cJ.blendSrc,cJ.blendDst)}else{bk.setBlending(s.NoBlending)}bk.setDepthTest(cJ.depthTest&&!bk.disableDepthTest);bk.setDepthWrite(cJ.depthWrite&&!bk.disableDepthWrite);if(bk.forcePolygonOffset===s.PolygonOffsetForceStatus.DEFAULT){cx(cJ.polygonOffset,cJ.polygonOffsetFactor,cJ.polygonOffsetUnits)}}bk.setMaterialFaces(cJ);if(cM._type===1){bk.renderBufferDirect(cP,cU,cC,cJ,cM,cV)}else{if((cM._type===2)||(cM.length>=0)){var cQ=cV.geometry.length||1;var cL=cV.geometry.length?cV.geometry[0]:cV.geometry;for(var cO=0;cO<cQ;cO++){var cS=cL.drawingGroups;for(var cN=0;cN<cS.length;cN++){bk.renderInterval(cP,cU,cC,cV,cJ,null,cL,cS[cN],cS[cN].start,cS[cN].count,null,cW,true)}if(cQ===1){break}cL=cV.geometry[cO+1]}}else{bk.renderBuffer(cP,cU,cC,cJ,cM,cV,cW)}}}}};this.renderImmediateObject=function(cG,cE,cH,cF,cD){var cC=bm(cG,cE,cH,cF,cD,null,cF.programManager.getProgramID(cD));ac=-1;bk.setMaterialFaces(cF);if(cD.immediateRenderCallback){cD.immediateRenderCallback(cC,w,b8)}else{cD.render(function(cI){bk.renderBufferImmediate(cI,cC,cF)})}};function bo(cE){var cC=cE.object,cD=cC.material;if(cD.transparent){cE.transparent=cD;cE.opaque=null}else{cE.opaque=cD;cE.transparent=null}}function a4(cK,cH){var cF,cM,cJ,cN,cI,cD,cG={};var cL=cK.morphTargets.length;var cC=cK.morphNormals.length;var cO=cH instanceof s.MeshFaceMaterial;cK.geometryGroups={};for(cF=0,cM=cK.faces.length;cF<cM;cF++){cJ=cK.faces[cF];cN=cO?cJ.materialIndex:0;if(cG[cN]===undefined){cG[cN]={hash:cN,counter:0}}cD=cG[cN].hash+"_"+cG[cN].counter;if(cK.geometryGroups[cD]===undefined){cK.geometryGroups[cD]={faces3:[],faces4:[],materialIndex:cN,vertices:0,numMorphTargets:cL,numMorphNormals:cC}}cI=cJ instanceof s.Face3?3:4;if(cK.geometryGroups[cD].vertices+cI>65535){cG[cN].counter+=1;cD=cG[cN].hash+"_"+cG[cN].counter;if(cK.geometryGroups[cD]===undefined){cK.geometryGroups[cD]={faces3:[],faces4:[],materialIndex:cN,vertices:0,numMorphTargets:cL,numMorphNormals:cC}}}if(cJ instanceof s.Face3){cK.geometryGroups[cD].faces3.push(cF)}else{cK.geometryGroups[cD].faces4.push(cF)}cK.geometryGroups[cD].vertices+=cI}cK.geometryGroupsList=[];for(var cE in cK.geometryGroups){cK.geometryGroups[cE].id=s.GeometryIdCount++;cK.geometryGroupsList.push(cK.geometryGroups[cE])}}this.initWebGLObjects=function(cC){if(cC.initWebGLObjectFrameIndex!==this.currentFrameIndex){cC.initWebGLObjectFrameIndex=this.currentFrameIndex;if(!cC.__webglObjects){cC.__webglObjects={main:new s.WebGLObjectManager()};cC.__webglObjectsAll=new s.WebGLObjectManager();cC.__webglObjectsToDraw=[];cC.__webglObjectsSharedToInit=[];cC.__webglObjectsImmediate=[];cC.__webglSprites=[];if(!cC.__webglFlares){cC.__webglFlares=[]}}if(cC.__objectsAdded.size){cC.__objectsAdded.forEach(function(cE,cD,cF){aY({object:cD,passes:cE},cC)});cC.__objectsAdded.clear()}if(cC.__objectsUpdated.size){cC.__objectsUpdated.forEach(function(cE,cD,cF){ap(cD,cC);aY({object:cD,passes:cE},cC,true)});cC.__objectsUpdated.clear()}if(cC.__objectsRemoved.size){bk.__glResources__.removeGeometryList(cC.__objectsRemoved);cC.__objectsRemoved.forEach(function(cE,cD,cF){ap(cE,cC)});cC.__objectsRemoved.clear()}this.initSharedBuffersDS(cC.__webglObjectsSharedToInit,s.loadingModels==false);cC.traverseObject3DWithCondition(function(cD){if(cD.isRoot3ds){return false}else{am(cD);return true}})}};this.initObject=function(cD){var cH=false;var cI;if(cD.geometry&&((cD.geometry._type===2)||(cD.geometry.length>=0))){cD._modelViewMatrix=new s._Float32Matrix4();cD._normalMatrix=new s.Matrix3();cJ=cD.geometry;if(cJ._type===2){cJ.addEventListener("dispose",aZ)}else{if(cJ.length){for(var cF=0;cF<cJ.length;cF++){cJ[cF].addEventListener("dispose",aZ)}}}if(cJ._type===2){if(!cJ.sharedBuffers){this.initDirectBuffersDS(cJ,cD)}else{cH=true}}else{if(cJ.length>=0){if(cJ.length>0&&!cJ[0].sharedBuffers){for(var cF=0;cF<cJ.length;cF++){this.initDirectBuffersDS(cJ[cF],cD)}}else{cH=true}}}}else{if(!cD.__webglInit){cD.__webglInit=true;cD._modelViewMatrix=new s._Float32Matrix4();cD._normalMatrix=new s.Matrix3();if(cD.geometry!==undefined&&cD.geometry.__webglInit===undefined){cD.geometry.__webglInit=true;cD.geometry.addEventListener("dispose",bv)}var cJ=cD.geometry;if(cJ===undefined){}else{if(cJ._type===1){ab(cJ)}else{if(cD instanceof s.Mesh){cG=cD.material;if(cJ.geometryGroups===undefined){a4(cJ,cG)}for(cI in cJ.geometryGroups){var cC=cJ.geometryGroups[cI];if(!cC.__webglVertexBuffer){ba(cC);aT(cC,cD);cJ.verticesNeedUpdate=true;cJ.morphTargetsNeedUpdate=true;cJ.elementsNeedUpdate=true;cJ.uvsNeedUpdate=true;cJ.normalsNeedUpdate=true;cJ.tangentsNeedUpdate=true;cJ.colorsNeedUpdate=true}}}else{if(cD instanceof s.Line){if(!cJ.__webglVertexBuffer){aM(cJ);aj(cJ,cD);cJ.verticesNeedUpdate=true;cJ.colorsNeedUpdate=true;cJ.lineDistancesNeedUpdate=true}}else{if(cD instanceof s.ParticleSystem){if(!cJ.__webglVertexBuffer){ae(cJ);cm(cJ,cD);cJ.verticesNeedUpdate=true;cJ.colorsNeedUpdate=true}var cG=ak(cD,cJ);var cE=cG.attributes&&C(cG);if(cJ.verticesNeedUpdate||cJ.colorsNeedUpdate||cD.sortParticles||cE){bG(cJ,w.DYNAMIC_DRAW,cD)}cJ.verticesNeedUpdate=false;cJ.colorsNeedUpdate=false;cG.attributes&&a1(cG)}}}}}}}cD._updateWorldCenterAndRadius();return cH};function aY(cO,cI,cP){var cF=cO.object;var cN=cO.passes;var cJ,cM,cK,cE;var cD=bk.initObject(cF);var cH=false;if(cF.__webglActive===cI){cH=true}else{if((cF.__webglActive instanceof Array)&&cF.__webglActive.indexOf(cI)>=0){cH=true}}if(!cH){var cC=true;if(cF instanceof s.Mesh){cM=cF.geometry;if(cM._type===1){ag(cI.__webglObjects,cM,cF,cN,cI.__webglObjectsAll)}else{if((cM._type===2)||(cM.length>=0)){ag(cI.__webglObjects,cM,cF,cN,cI.__webglObjectsAll)}else{if(cM._type===0){for(cJ in cM.geometryGroups){cE=cM.geometryGroups[cJ];ag(cI.__webglObjects,cE,cF,cN,cI.__webglObjectsAll)}}}}}else{if(cF instanceof s.Line||cF instanceof s.ParticleSystem){cM=cF.geometry;ag(cI.__webglObjects,cM,cF,cN,cI.__webglObjectsAll)}else{if(cF instanceof s.ImmediateRenderObject||cF.immediateRenderCallback){a9(cI.__webglObjectsImmediate,cF,cN)}else{if(cF instanceof s.Sprite){cI.__webglSprites.push(cF);cC=false}else{if(cF instanceof s.CSS2DNode){ag(cI.__webglObjects,null,cF,["css2d"],cI.__webglObjectsAll)}else{if(cF instanceof s.CSS3DNode){ag(cI.__webglObjects,null,cF,["css3d"],cI.__webglObjectsAll)}}}}}}if(!cF.__webglActive){cF.__webglActive=cI}else{if(cF.__webglActive instanceof Array){cF.__webglActive.push(cI)}else{cF.__webglActive=[cF.__webglActive,cI]}}if(cC){var cG=cI.__webglObjectsAll.objects[cI.__webglObjectsAll.objects.length-1];if(!cP){bk.__glResources__.geometry.push(cG)}if(cD){cI.__webglObjectsSharedToInit.push(cG)}else{if(cF.geometry){var cL=cF.geometry.length?cF.geometry[0].vertexBuffer:cF.geometry.vertexBuffer;cG.sortKey=cL?cL.id:0}}}else{if(!cP){bk.__glResources__.geometry.push({object:cF})}}}}var af=["main"];function ag(cF,cD,cE,cI,cC){if(!cI){cI=af}var cG,cH,cJ={buffer:cD,object:cE,opaque:null,transparent:null,render:true,z:0,sortKey:0};for(cG=0;cG<cI.length;cG++){cH=cI[cG];if(!cF[cH]){cF[cH]=new s.WebGLObjectManager()}cF[cH].add(cJ)}cC.add(cJ)}function a9(cD,cC){cD.push({buffer:null,object:cC,opaque:null,transparent:null,render:true,z:0,sortKey:0})}function am(cF,cD){var cJ=cF.geometry,cC,cH,cI;if(!cJ){return}if(cJ._type===1){a3(cJ,w.DYNAMIC_DRAW,!cJ.dynamic)}else{if((cJ._type===2)||(cJ.length>=0)){}else{if(cF instanceof s.Mesh){for(var cG=0,cE=cJ.geometryGroupsList.length;cG<cE;cG++){cC=cJ.geometryGroupsList[cG];cI=cD||ak(cF,cC);if(cJ.buffersNeedUpdate){aT(cC,cF)}cH=cI.attributes&&C(cI);if(cJ.verticesNeedUpdate||cJ.morphTargetsNeedUpdate||cJ.elementsNeedUpdate||cJ.uvsNeedUpdate||cJ.normalsNeedUpdate||cJ.colorsNeedUpdate||cJ.tangentsNeedUpdate||cH){H(cC,cF,w.DYNAMIC_DRAW,!cJ.dynamic,cI)}}cJ.verticesNeedUpdate=false;cJ.morphTargetsNeedUpdate=false;cJ.elementsNeedUpdate=false;cJ.uvsNeedUpdate=false;cJ.normalsNeedUpdate=false;cJ.colorsNeedUpdate=false;cJ.tangentsNeedUpdate=false;cJ.buffersNeedUpdate=false;cI.attributes&&a1(cI)}else{if(cF instanceof s.Line){cI=ak(cF,cJ);cH=cI.attributes&&C(cI);if(cJ.verticesNeedUpdate||cJ.colorsNeedUpdate||cJ.lineDistancesNeedUpdate||cH){b2(cJ,w.DYNAMIC_DRAW)}cJ.verticesNeedUpdate=false;cJ.colorsNeedUpdate=false;cJ.lineDistancesNeedUpdate=false;cI.attributes&&a1(cI)}else{if(cF instanceof s.ParticleSystem){cI=ak(cF,cJ);cH=cI.attributes&&C(cI);if(cJ.verticesNeedUpdate||cJ.colorsNeedUpdate||cF.sortParticles||cH){bG(cJ,w.DYNAMIC_DRAW,cF)}cJ.verticesNeedUpdate=false;cJ.colorsNeedUpdate=false;cI.attributes&&a1(cI)}}}}}}function C(cD){for(var cC in cD.attributes){if(cD.attributes[cC].needsUpdate){return true}}return false}function a1(cD){for(var cC in cD.attributes){cD.attributes[cC].needsUpdate=false}}function ap(cE,cF){if(cE instanceof s.Mesh||cE instanceof s.ParticleSystem||cE instanceof s.Line||cE instanceof s.CSS2DNode){bi(cF.__webglObjects,cE,cF.__webglObjectsAll)}else{if(cE instanceof s.Sprite){a6(cF.__webglSprites,cE)}else{if(cE instanceof s.ImmediateRenderObject||cE.immediateRenderCallback){cy(cF.__webglObjectsImmediate,cE)}}}var cC=cE.__webglActive,cD;if(cC){if(cC instanceof Array){cD=cC.indexOf(cF);if(cD<=0){cC.splice(cD,1);if(cC.length===1){cE.__webglActive=cC[0]}}}else{cE.__webglActive=false}}}function bi(cE,cD,cC){var cF;for(cF in cE){cE[cF].remove(cD)}cC.remove(cD)}function cy(cD,cC){for(var cE=cD.length-1;cE>=0;cE--){if(cD[cE].object===cC){cD.splice(cE,1)}}}function a6(cD,cC){for(var cE=cD.length-1;cE>=0;cE--){if(cD[cE]===cC){cD.splice(cE,1)}}}this.initMaterial=function(cP,c0,cC,c2,c3){cP.addEventListener("dispose",bU);var cO,cZ,cK,cW,cL,cU,c1,cQ,cJ,cY,cG,cE,cR;var cH=cP.shaderID;if(cH!==s.ShaderIDs.none){aW(cP,s.ShaderLib[s.ShaderIDsToName[cH]])}cU=bR(c0);cQ=aH(c0);cJ=cQ.dirLight;cY=cQ.spotLight;cG=cQ.tex2d;cE=cQ.texCube;c1=1024;cR=6;var cF=0;if(!!cP.envMap){var cN=cP.envMap.mapping;if(cN instanceof s.SphericalReflectionMapping){cF=1}else{if(cN instanceof s.LatLongReflectionMapping){cF=2}}}var cI=!!cP.map||!!cP.lightMap||!!cP.emissionColorMap||!!cP.bumpMap||!!cP.normalMap||!!cP.specularMap||!!cP.transparencyMap||!!cP.metalnessMap||!!cP.specularContribMap||!!cP.displacementMap||!!cP.clearCoatRoughnessMap||!!cP.coatingGlossinessMap||!!cP.anisotropyMap||!!cP.anisotropyAngleMap||!!cP.opacityMap||!!cP.roughnessMap||cP.glossinessMap||!!cP.clearCoatNormalMap||!!cP.clearCoatMap||!!cP.flakesColorMap||!!cP.flakesCoverageMap||!!cP.flakesRoughnessMap||cP.flakesSizeMap;var cV=true;var cT=false;if(cP.uvSlots){cV=(cP.uvSlots.diffuseMap===1)||(cP.uvSlots.specularMap===1)||(cP.uvSlots.roughnessMap===1)||(cP.uvSlots.normalMap===1)||(cP.uvSlots.lightMap===1);cT=(cP.uvSlots.diffuseMap===2)||(cP.uvSlots.specularMap===2)||(cP.uvSlots.roughnessMap===2)||(cP.uvSlots.normalMap===2)||(cP.uvSlots.lightMap===2)}cL={maxDirLights:cU.directional,maxPointLights:cU.point,maxSpotLights:cU.spot,maxHemiLights:cU.hemi,probeLight:cU.probe,maxSphereLights:cU.sphere,maxTubeLights:cU.tube,maxDiskLights:cU.disk,maxAreaLights:cU.area,maxIESLights:cU.ies,lightMap:!!cP.lightMap,lightMapMode:cP.lightMapMode,lightMapLinear:cP.lightMapLinear,useLighting:cP.useLighting,maxDirShadows:cJ,maxSpotShadows:cY,maxShadows:cG,maxShadowsCube:cE,shadowMapEnabled:this.shadowMapEnabled&&(cG>0)&&c2.receiveShadow,shadowMapCubeEnabled:this.shadowMapEnabled&&(cE>0)&&c2.receiveShadow,shadowMapType:this.shadowMapType,shadowMapQuality:this.shadowMapQuality,shadowMapDebug:this.shadowMapDebug,shadowMapCascade:this.shadowMapCascade,morphTargets:cP.morphTargets,morphNormals:cP.morphNormals,maxMorphTargets:this.maxMorphTargets,maxMorphNormals:this.maxMorphNormals,fixedSize:c2&&c2._ratioData&&c2._ratioData.ratio>0,fixedSizeCenter:c2&&c2._ratioData&&c2._ratioData.ratio>0&&c2._ratioData.center,skinning:cP.skinning,useEulerAngles:cP.useEulerAngles,maxBones:c1,skinningMapWidth:cP&&cP.skinningMapWidth,skinningMapHeight:cP&&cP.skinningMapHeight,skinningInstancingMapsInfo:cP.skinningInstancingMapsInfo,useUV:cI,useUV1:cV,useUV2:cT,diffuseMapUVSlot:cP.uvSlots?cP.uvSlots.diffuseMap:1,specularMapUVSlot:cP.uvSlots?cP.uvSlots.specularMap:1,roughnessMapUVSlot:cP.uvSlots?cP.uvSlots.roughnessMap:1,normalMapUVSlot:cP.uvSlots?cP.uvSlots.normalMap:1,lightMapUVSlot:cP.uvSlots?cP.uvSlots.lightMap:2,mappingType:cP.mappingType,mappingUseFragment:cP.mappingUseFragment,mappingNormTransformation:cP.mappingNormTransformation,mappingObjTransformation:cP.mappingObjTransformation,mappingUVTransformation:cP.mappingUVTransformation,textureBlending:cP.textureBlending,textureFormat:cP.map,needTangent:cP.needTangent,needTangentBinormal:cP.needTangentBinormal||cP.anisotropy>0||!!cP.anisotropyMap,sphereMap:cP.sphereMap,maxClipPlanes:cR,clipPlanesEnabled:this.clipPlanes.length>0&&cP.enableClipPlanes,alphaTest:cP.alphaTest,metal:cP.metal,perPixel:cP.perPixel,wrapAround:cP.wrapAround,doubleSided:cP.side===a.DoubleSide,flipSided:cP.side===a.BackSide,vertexColors:cP.vertexColors,sizeAttenuation:cP.sizeAttenuation,isMultiInstanced:c2&&c2._instancingInfos&&c2._instancingInfos.isInstanceNode3D,instancingMeshSelectionMode:c2&&c2._instancingInfos&&c2._instancingInfos.instancingSelectionMode==="mesh",_definePickingInstancing:cP._definePickingInstancing,fog:cC,useFog:cP.fog,fogExp:cC instanceof s.FogExp2,refractionRatioMap:!!cP.refractionRatioMap,normalMap:!!cP.normalMap,normalMapFlipY:!!cP.normalMapFlipY,normalUvTransform:cP.normalUvTransform,bumpMap:!!cP.bumpMap,specgloss:!!cP.ior&&Math.abs(cP.ior-1e+25)<1,map:!!cP.map,mapHDR:!!cP.map&&cP.map.hdr,diffuseMulCoef:!!cP.diffuseMulCoef,diffuseAddCoef:!!cP.diffuseAddCoef,useAlphaFromDiffuseMap:!!cP.useAlphaFromDiffuseMap,specularMap:!!cP.specularMap,specularMulCoef:!!cP.specularMulCoef,specularAddCoef:!!cP.specularAddCoef,specularMapLinear:!!cP.specularMapLinear,metalnessMap:!!cP.metalnessMap,metalnessMulCoef:!!cP.metalnessMulCoef&&cP.metalnessMulCoef!==1,metalnessAddCoef:!!cP.metalnessAddCoef&&cP.metalnessAddCoef!==0,metalnessMapLinear:!!cP.metalnessMapLinear,specularContribMap:!!cP.specularContribMap,specularContribMulCoef:!!cP.specularContribMulCoef&&cP.specularContribMulCoef!==1,specularContribAddCoef:!!cP.specularContribAddCoef&&cP.specularContribAddCoef!==0,emissionColorMap:!!cP.emissionColorMap,emissionColorMulCoef:!!cP.emissionColorMulCoef,emissionColorAddCoef:!!cP.emissionColorAddCoef,emissionNormalized:cP.emissionNormalized,emissionColorMapLinear:!!cP.emissionColorMapLinear,transparencyMap:!!cP.transparencyMap,transparencyMulCoef:!!cP.transparencyMulCoef&&cP.transparencyMulCoef!==1,transparencyAddCoef:!!cP.transparencyAddCoef&&cP.transparencyAddCoef!==0,opacityMap:!!cP.opacityMap,opacityMulCoef:!!cP.opacityMulCoef&&cP.opacityMulCoef!==1,opacityAddCoef:!!cP.opacityAddCoef&&cP.opacityAddCoef!==0,roughnessMap:!!cP.roughnessMap,glossinessMap:!!cP.glossinessMap,glossinessMulCoef:!!cP.glossinessMulCoef&&cP.glossinessMulCoef!==1,glossinessAddCoef:!!cP.glossinessAddCoef&&cP.glossinessAddCoef!==0,roughnessMulCoef:!!cP.roughnessMulCoef&&cP.roughnessMulCoef!==1,roughnessAddCoef:!!cP.roughnessAddCoef&&cP.roughnessAddCoef!==0,roughnessMapLinear:!!cP.roughnessMapLinear,anisotropy:cP.anisotropy>0||!!cP.anisotropyMap,anisotropyMap:!!cP.anisotropyMap,anisotropyMulCoef:!!cP.anisotropyMulCoef&&cP.anisotropyMulCoef!==1,anisotropyAddCoef:!!cP.anisotropyAddCoef&&cP.anisotropyAddCoef!==0,anisotropyAngleMap:!!cP.anisotropyAngleMap,anisotropyAngleMulCoef:!!cP.anisotropyAngleMulCoef&&cP.anisotropyAngleMulCoef!==1,anisotropyAngleAddCoef:!!cP.anisotropyAngleAddCoef&&cP.anisotropyAngleAddCoef!==0,displacementMap:!!cP.displacementMap,reflectionProbes:cP.reflectionProbes,useFiniteEnvMap:cP.useFiniteEnvMap,sheen:cP.sheen||cP.sheenMap,sheenMap:!!cP.sheenMap,sheenMulCoef:!!cP.sheenMulCoef&&cP.sheenMulCoef!==1,sheenAddCoef:!!cP.sheenAddCoef&&cP.sheenAddCoef!==0,sheenMode:cP.sheenMode,old_flakes:typeof cP.flakes!=="undefined",flakes:(typeof cP.flakesCoverageMap!=="undefined"&&(cP.flakesCoverage>0||!!cP.flakesCoverageMap))||cP.flakes,flakesMode:cP.flakesMode,flakesSizeMap:!!cP.flakesSizeMap,flakesSizeMulCoef:!!cP.flakesSizeMulCoef&&cP.flakesSizeMulCoef!==1,flakesSizeAddCoef:!!cP.flakesSizeAddCoef&&cP.flakesSizeAddCoef!==0,flakesCoverageMap:!!cP.flakesCoverageMap,flakesCoverageMulCoef:!!cP.flakesCoverageMulCoef&&cP.flakesCoverageMulCoef!==1,flakesCoverageAddCoef:!!cP.flakesCoverageAddCoef&&cP.flakesCoverageAddCoef!==0,flakesRoughnessMap:!!cP.flakesRoughnessMap,flakesRoughnessMulCoef:!!cP.flakesRoughnessMulCoef&&cP.flakesRoughnessMulCoef!==1,flakesRoughnessAddCoef:!!cP.flakesRoughnessAddCoef&&cP.flakesRoughnessAddCoef!==0,flakesColorMap:!!cP.flakesColorMap,flakesColorMulCoef:!!cP.flakesColorMulCoef,flakesColorAddCoef:!!cP.flakesColorAddCoef,clearCoat:cP.clearCoat>0||!!cP.clearCoatMap,clearCoatMap:!!cP.clearCoatMap,clearCoatMulCoef:!!cP.clearCoatMulCoef&&cP.clearCoatMulCoef!==1,clearCoatAddCoef:!!cP.clearCoatAddCoef&&cP.clearCoatAddCoef!==0,clearCoatRoughnessMap:!!cP.clearCoatRoughnessMap,clearCoatRoughnessMulCoef:!!cP.clearCoatRoughnessMulCoef&&cP.clearCoatRoughnessMulCoef!==1,clearCoatRoughnessAddCoef:!!cP.clearCoatRoughnessAddCoef&&cP.clearCoatRoughnessAddCoef!==0,coatingGlossinessMap:!!cP.coatingGlossinessMap,coatingGlossinessMulCoef:!!cP.coatingGlossinessMulCoef&&cP.coatingGlossinessMulCoef!==1,coatingGlossinessAddCoef:!!cP.coatingGlossinessAddCoef&&cP.coatingGlossinessAddCoef!==0,clearCoatRoughnessMapLinear:!!cP.clearCoatRoughnessMapLinear,clearCoatNormalMap:!!cP.clearCoatNormalMap,clearCoatNormalMapFlipY:cP.clearCoatNormalMapFlipY,orangePeel:cP.orangePeel&&!(!!cP.clearCoatNormalMap),subsurface:cP._subsurface&&!cP.thinWalled,sssLUT:!!cP._sssLUT,sssIBLLUT:!!cP._sssIBLLUT,translucencyLUT:!!cP._translucencyLUT,envMap:!!cP.envMap,envMapSheen:!!cP.envMap&&cP._sheenData&&cP._sheenData.envMipMap!==null,envMapDiffuse:cP.envMipMap&&cP.envMipMap[1]&&cP.envMipMap[1].hasDiffuse,envMapHDR:cP.envMap&&cP.envMap.hdr,envMapping:cF,iterative:!!cP.iterative,sslr:!!cP.sslr,thinWalled:cP.thinWalled,dashedLine:cP.isDashedLine,cpuPattern:cP.isCPUPattern,patternSize:cP.isDashedLine&&!!cP.dashPattern?cP.dashPattern.length:0,wideLine:cP.isWideLine||cP.is2DLine,linejoin:cP.linejoin,linecap:cP.linecap,polygonBorderMode:cP.polygonBorderMode,_gasLook:cP._gasLook>0,NRECompatibility:!!cP.NRECompatibility,isAccumMat:cP.isAccumMat,isRevealMat:cP.isRevealMat,useOIT:cP.isOITable,compressedVertices:c2&&c2.compressedVertices,compressedNormals:c2&&c2.compressedNormals,largeScale:(c2&&c2.isLargeScale)?true:false};if(cP._PDSFXData&&cP._PDSFXData.PDSFX){var cS=cP._PDSFXData;cL.PDSFX=true;cL.PDSFX_OverridableFunctions_VS=cP._getPDSFXOverridableFunctions_VS();cL.PDSFX_OverridableFunctions_FS=cP._getPDSFXOverridableFunctions_FS();cL.PDSFX_hasAlbedo=cS.PDSFX_hasAlbedo;cL.PDSFX_hasEmissive=cS.PDSFX_hasEmissive;cL.PDSFX_hasSpecular=cS.PDSFX_hasSpecular;cL.PDSFX_hasPsColor=cS.PDSFX_hasPsColor;cL.PDSFX_hasTransparency=cS.PDSFX_hasTransparency;cL.pdsfxVaryingsCode=cS.pdsfxVaryingsCode?cS.pdsfxVaryingsCode:"";cL.pdsfxUniformsCode=cS.pdsfxUniformsCode?cS.pdsfxUniformsCode:null;if(cS.pdsfxUniforms){cL.pdsfxUniforms=cS.pdsfxUniforms}cL.pdsfxGlobalVariablesCode_VS=cS.pdsfxGlobalVariablesCode_VS?cS.pdsfxGlobalVariablesCode_VS:"";cL.pdsfxGlobalVariablesCode_FS=cS.pdsfxGlobalVariablesCode_FS?cS.pdsfxGlobalVariablesCode_FS:"";cL.pdsfxAttributesCode=cS.pdsfxAttributesCode?cS.pdsfxAttributesCode:"";cL.pdsfxUseMap=cS.pdsfxUseMap?cS.pdsfxUseMap:"";if(cL.pdsfxUseMap){cL.useUV=true;cL.useUV1=true;cL.useUV2=true}}cP.enableReceiveShadowOnCapping=cL.shadowMapEnabled;cP.program=B(cH,cP.fragmentShader,cP.vertexShader,cP.uniforms,cP.attributes,cP.defines,cL);cP.programManager.addProgram(c2,cP.program,c3);var cM=cP.program.attributes;if(!cP.loadUniforms){cP.uniformsList=[];var cX;for(cO in cP.uniforms){var cD=cP.program.uniformLocations[cO];if(cD){cX=cP.uniforms[cO];if(!cX.sceneUniform&&!cX.clipPlanesUniform){cP.uniformsList.push([cO,cX])}}}}if(cP._PDSFXData&&cP._PDSFXData.PDSFX){if(cP._PDSFXData.pdsfxUniforms){cP._PDSFXData._pdsfxUniformsList=[];var cX;for(cO in cP._PDSFXData.pdsfxUniforms){var cD=cP.program.uniformLocations[cO];if(cD){cX=cP._PDSFXData.pdsfxUniforms[cO];cP._PDSFXData._pdsfxUniformsList.push([cO,cX])}}}}};function aW(cD,cC){cD.uniforms=cC.uniforms;cD.vertexShader=cC.vertexShader;cD.fragmentShader=cC.fragmentShader}function bm(cM,cI,cC,cN,cH,cE,cQ,cG){bP=0;aJ=-1;if(cN._rendererId!==bk.context.contextId){cN._rendererId=bk.context.contextId;cN.program=null;cN.shaderVersion=bk.context.WebVisuShaderVersion;cN.needsUpdate=true}if(cN.shaderVersion!==-1&&cN.shaderVersion!==bk.context.WebVisuShaderVersion){cN.needsUpdate=true;cN.shaderVersion=bk.context.WebVisuShaderVersion}if(cN.lights&&cN.program&&(cN.program._lightsKey!==ao)){cN.needsUpdate=true}if(!cN.needsUpdate){cN.program=cN.programManager.getProgram(cH,cG);if(cN.program===null){bk.initMaterial(cN,cI,cC,cH,cG)}}if(cN.needsUpdate){cN.programManager.update(av,null,cG);bk.initMaterial(cN,cI,cC,cH,cG);cN.needsUpdate=false}var cF=cN._PDSFXData&&cN._PDSFXData.PDSFX;var cL=false;var cP=false;var cJ=cN.program,cD=cJ.uniformLocations,cO=cN.uniforms;var cK=cJ.program;var cR=cE?cE.id:-1;if(cN.id!==bA||cR!==bz){bA=cN.id;bz=cR;cL=true}if(cK!==w._currentProgram){w.useProgram(cK);w._currentProgram=cK;cP=true;cL=true}if(cP||cM!==bg){w.uniformMatrix4fv(cD.projectionMatrix,false,cM.projectionMatrix.elements);cD.viewMatrix&&w.uniformMatrix4fv(cD.viewMatrix,false,cM.matrixWorldInverse.elements);if(cF){cD.projectionInvMatrix&&w.uniformMatrix4fv(cD.projectionInvMatrix,false,cM.projectionMatrixInverse.elements);cD.viewInvMatrix&&w.uniformMatrix4fv(cD.viewInvMatrix,false,cM.matrixWorld.elements);if(cD.viewInvTranspMatrix){cD.viewInvTranspMatrix&&w.uniformMatrix4fv(cD.viewInvTranspMatrix,false,cM.matrixWorld.transpose().elements);cM.matrixWorld.transpose()}cD.nearFarLogFactor&&w.uniform3f(cD.nearFarLogFactor,cM.near,cM.far,1/Math.log(cM.far/cM.near));cD.viewportSize&&w.uniform2f(cD.viewportSize,cs,bq)}if(cM!==bg){bg=cM}}if(cL){cN.refreshUniforms(bk,cH,cE);if(cN.physical){cO.renderIteration.value=bk.renderIteration;bk.refreshUniformsPhysicalDSRoughnessMaps(cO,cN,0.2)}else{if(cN instanceof s.ShaderMaterial&&(cN.isWideLine||cN.is2DLine||cN.isDashedLine)){bk.refreshUniformsLine(cO,cN,cE)}}if(cN.loadUniforms){cN.loadUniforms(bk,w,cJ.uniformLocations,cE)}else{if(cN.skinning){bS(cO,cN,cE)}aw(cD,cN.uniformsList)}if(cF){if(cN._PDSFXData._pdsfxUniformsList){if(cN.refreshPDSFXUniforms){cN.refreshPDSFXUniforms()}aw(cD,cN._PDSFXData._pdsfxUniformsList)}}if(cP){if(cN.needsCameraPosition||cN.envMap||cF){if(cD.cameraPosition){aB.getPositionFromMatrix(cM.matrixWorld);w.uniform3f(cD.cameraPosition,aB.x,aB.y,aB.z)}}if(cD.cameraConstant){w.uniform1f(cD.cameraConstant,cM.fixedSizeCameraConstant)}if(cN.lights){if(cB){y(cI,cM);cB=false}bk.loadUniformsLights(w,cJ.uniformLocations,b3,cJ)}if(cC&&cN.fog){bk.loadUniformsFog(w,cJ.uniformLocations,cC)}if(cH.receiveShadow&&!cN._shadowPass){bk.loadUniformsShadow(w,cJ,cI)}}}if(cP||cJ._clipPlanesVersion!==bk._clipPlanesState.version){if(cN.enableClipPlanes){bk.loadClippingUniforms(w,cJ.uniformLocations)}cJ._clipPlanesVersion=bk._clipPlanesState.version}aL=null;bI=null;aK=null;var cS=cJ.objectUniformLocations;bk.loadObjectUniforms(cS,cH,cQ,cN,cM,cI);W=cG;return cJ}function bS(cC,cE,cF){if(cE.skinning){if(cE.skinningMap){cC.skinningMap.value=cE.skinningMap;cC.skinningMap.value.needsUpdate=true}if(cE.skinningInstancingMaps){cC.skinningInstancingMaps.value=cE.skinningInstancingMaps;for(var cD=0;cD<cE.skinningInstancingMaps.length;cD++){cC.skinningInstancingMaps.value[cD].needsUpdate=true}}}}function R(cD,cE,cH,cF,cC){if(cD.nbClipPlanes){cD.nbClipPlanes.value=cE.length;cD.clipPlaneEquations.value=cE.eqs;cD.clipPlaneActive.value=cE.states.slice(0);var cG=cF&&cF.clippingSettings;if(!cG||cC){cD.clipFrontOpacity.value=1;cD.clipBackOpacity.value=0}else{cD.clipFrontOpacity.value=cG.frontOpacity<0.5?0:1;cD.clipBackOpacity.value=cG.backOpacity<0.5?0:1}if(cH){cD.clipPlaneActive.value[cH-1]=0}}}function an(cC,cD){if(cC.polygonPoints){cC.polygonPoints.value=cD?cD.clippingPolygonTexture:null;cC.polygonSize.value=cD?cD.polyLineSize:0;if(cD&&cD.planeU){cC.extrusionPlaneU.value=cD.planeU}if(cD&&cD.planeV){cC.extrusionPlaneV.value=cD.planeV}}}this.loadObjectUniforms=function(cF,cD,cE,cH,cG,cC){if(cF.quantizedVector){w.uniform3f(cF.quantizedVector,cE.quantizedVector.x,cE.quantizedVector.y,cE.quantizedVector.z)}if(cF.offsetVector){w.uniform3f(cF.offsetVector,cE.offsetVector.x,cE.offsetVector.y,cE.offsetVector.z)}if(aL!==cD.matrixWorld){if(cF.fixedSizeCenterRatio){w.uniform4f(cF.fixedSizeCenterRatio,cD._ratioData.center.x,cD._ratioData.center.y,cD._ratioData.center.z,cD._ratioData.ratio)}else{if(cF.fixedSizeRatio){w.uniform1f(cF.fixedSizeRatio,cD._ratioData.ratio)}}if(cF.modelViewMatrix){w.uniformMatrix4fv(cF.modelViewMatrix,false,cD._modelViewMatrix.elements)}if(cF.modelMatrix){w.uniformMatrix4fv(cF.modelMatrix,false,this.float32MatrixTemp.setDoubles(cD.matrixWorld.elements))}if(cH._PDSFXData&&cH._PDSFXData.PDSFX){if(cF.modelInvTranspMatrix){if(!cD.modelInvTranspMatrix){cD.modelInvTranspMatrix=new s.Matrix4().getInverse(cD.matrixWorld).transpose()}w.uniformMatrix4fv(cF.modelInvTranspMatrix,false,cD.modelInvTranspMatrix.elements)}if(cF.modelViewInvTranspMatrix){if(!cD.modelViewInvTranspMatrix){cD.modelViewInvTranspMatrix=new s._Float32Matrix4().multiplyDoubleMatricesAndInverse(cG.matrixWorldInverse,cD.matrixWorld).transpose()}w.uniformMatrix4fv(cF.modelViewInvTranspMatrix,false,cD.modelViewInvTranspMatrix.elements)}}if(aJ!==cD.isUniformlyScaled){aJ=cD.isUniformlyScaled;cF.use_normal_matrix&&w.uniform1i(cF.use_normal_matrix,!cD.isUniformlyScaled)}if(!cD.isUniformlyScaled){cF.normalMatrix&&w.uniformMatrix3fv(cF.normalMatrix,false,cD._normalMatrix.elements)}if(cD.receiveShadow&&!cH._shadowPass){bk.loadUniformsShadowMatrices(w,cH.program,cC,cD)}aL=cD.matrixWorld}};function a2(){var cC=bP;if(cC>=cl){console.warn("WebGLRenderer: trying to use "+cC+" texture units while this GPU supports only "+cl)}bP+=1;return cC}this.loadMatrix3=function(cE,cC,cD){if(cD){cE.uniformMatrix3fv(cC,false,cD.elements)}};this.loadMatrix4=function(cE,cC,cD){if(cD){cE.uniformMatrix4fv(cC,false,cD.elements)}};this.loadMatrix4Array=function(cJ,cE,cC,cF,cH){var cI=cE.flattenedUniformArrays;if(cI[cF]===undefined){cI[cF]=new Float32Array(16*cH.length)}var cD;for(var cG=0,cD=cH.length;cG<cD;cG++){if(cH[cG]){cH[cG].flattenToArrayOffset(cI[cF],cG*16)}}cJ.uniformMatrix4fv(cC,false,cI[cF])};this.loadVector2Array=function(cG,cF,cK,cH,cJ){var cE=cF.flattenedUniformArrays;if(cE[cH]===undefined){cE[cH]=new Float32Array(2*cJ.length)}var cI,cC;for(var cD=0,cI=cJ.length;cD<cI;cD++){cC=cD*2;cE[cH][cC]=cJ[cD].x;cE[cH][cC+1]=cJ[cD].y}cG.uniform2fv(cK,cE[cH])};this.loadTexture=function(cG,cC,cF){var cE=cF;var cD=a2();cG.uniform1i(cC,cD);if(cE){if(cE.image instanceof Array&&cE.image.length===6){bY(cE,cD)}else{if(cE instanceof s.WebGLRenderTargetCube){bK(cE,cD)}else{this.setTexture(cE,cD)}}}};this.loadTextureArray=function(cF,cE,cK,cH,cJ){var cD,cI,cG,cL;var cC=cE.flattenedUniformArrays;if(cC[cH]===undefined){cC[cH]=[]}for(cD=0,cI=cJ.length;cD<cI;cD++){cC[cH][cD]=a2()}w.uniform1iv(cK,cC[cH]);for(cD=0,cI=cJ.length;cD<cI;cD++){cG=cJ[cD];cL=cC[cH][cD];if(cG){this.setTexture(cG,cL)}}};this.loadTextureCubeArray=function(cF,cE,cK,cH,cJ){var cD,cI,cG,cL;var cC=cE.flattenedUniformArrays;if(cC[cH]===undefined){cC[cH]=[]}for(cD=0,cI=cJ.length;cD<cI;cD++){cC[cH][cD]=a2()}w.uniform1iv(cK,cC[cH]);for(cD=0,cI=cJ.length;cD<cI;cD++){cG=cJ[cD];cL=cC[cH][cD];if(cG){bK(cG,cL)}}};this.loadUniformsCommon=function(cI,cJ,cF,cG){if(cF.diffuse){var cE=cJ.color;if(cG&&cG.getColor()){cE=new s.Color(cG.getColor())}if(this.gammaInput){if(cJ.NRECompatibility){cE=new s.Color().copyGammaToLinearNRECompatible(cE)}else{cE=new s.Color().copyGammaToLinear(cE)}}cI.uniform3f(cF.diffuse,cE.r,cE.g,cE.b)}if(cF.opacity){var cK=cJ.opacity;if(cG&&cG.getOpacity()!==null){cK=cG.getOpacity()}if(this.useRenderPriorityOpacity){cK=this.computeRenderPriorityOpacity(cK,cG)}cI.uniform1f(cF.opacity,cK)}if(cF.envMapExposure){cI.uniform1f(cF.envMapExposure,cJ.envMapExposure||cJ.envMapExposure==0?cJ.envMapExposure:1)}if(cF.ambienceMatrix){this.loadMatrix4(cI,cF.ambienceMatrix,cJ.ambienceMatrix?cJ.ambienceMatrix:new s.Matrix4())}if(cF.flipEnvMap){cI.uniform1f(cF.flipEnvMap,cJ.flipEnvMap||cJ.flipEnvMap==0?cJ.flipEnvMap:1)}if(cF.reflectivity){cI.uniform1f(cF.reflectivity,cJ.reflectivity||cJ.reflectivity==0?cJ.reflectivity:1)}if(cF.refractionRatio){cI.uniform1f(cF.refractionRatio,cJ.refractionRatio||cJ.refractionRatio==0?cJ.refractionRatio:0.98)}if(cF.morphTargetInfluences){cI.uniform1f(cF.morphTargetInfluences,cJ.morphTargetInfluences?cJ.morphTargetInfluences:0)}if(cF.combine){cI.uniform1i(cF.combine,cJ.combine?cJ.combine:0)}if(cF.renderIteration){cI.uniform1i(cF.renderIteration,this.renderIteration?this.renderIteration:0)}var cC;if(cJ.map){cC=cJ.map}else{if(cJ.specularMap){cC=cJ.specularMap}else{if(cJ.normalMap){cC=cJ.normalMap}else{if(cJ.bumpMap){cC=cJ.bumpMap}}}}if(cC!==undefined){var cH=cC.offset;var cD=cC.repeat;if(cF.offsetBumpMap){cI.uniform2f(cF.offsetBumpMap,cH.x,cH.y)}if(cF.repeatBumpMap){cI.uniform2f(cF.repeatBumpMap,cD.x,cD.y)}}else{if(cF.offsetBumpMap){cI.uniform2f(cF.offsetBumpMap,0,0)}if(cF.repeatBumpMap){cI.uniform2f(cF.repeatBumpMap,1,1)}}if(cF.map){this.loadTexture(cI,cF.map,cJ.map)}if(cF.lightMap){this.loadTexture(cI,cF.lightMap,cJ.lightMap)}if(cF.specularMap){this.loadTexture(cI,cF.specularMap,cJ.specularMap)}if(cF.envMap){this.loadTexture(cI,cF.envMap,cJ.envMap)}if(cF.refractionRatioMap){this.loadTexture(cI,cF.refractionRatioMap,cJ.refractionRatioMap)}if(cJ.mappingType>-1){if(cF.mappingNormTransformation){this.loadMatrix3(cI,cF.mappingNormTransformation,cJ.mappingNormTransformation?cJ.mappingNormTransformation:new s.Matrix3())}if(cF.mappingUVTransformation){this.loadMatrix3(cI,cF.mappingUVTransformation,cJ.mappingUVTransformation?cJ.mappingUVTransformation:new s.Matrix3())}if(cF.mappingObjTransformation){this.loadMatrix4(cI,cF.mappingObjTransformation,cJ.mappingObjTransformation?cJ.mappingObjTransformation:new s.Matrix4())}}if(cJ.map&&cJ.map.hdr&&cJ.map.image){if(cF.mapHDRSize){cI.uniform2f(cF.mapHDRSize,parseInt(cJ.map.image.width),parseInt(cJ.map.image.height))}}else{if(cF.mapHDRSize){cI.uniform2f(cF.mapHDRSize,2048,1024)}}if(cJ.envMap&&cJ.envMap.hdr&&cJ.envMap.image){if(cF.envMapHDRSize){cI.uniform2f(cF.envMapHDRSize,parseInt(cJ.envMap.image.width),parseInt(cJ.envMap.image.height))}if(cF.useRefract){cI.uniform1i(cF.useRefract,cJ.envMap&&cJ.envMap.mapping instanceof s.CubeRefractionMapping)}}else{if(cF.envMapHDRSize){cI.uniform2f(cF.envMapHDRSize,2048,1024)}if(cF.useRefract){cI.uniform1i(cF.useRefract,0)}}};this.loadUniformsBump=function(cE,cD,cC){if(cD.bumpMap){if(cC.bumpScale){cE.uniform1f(cC.bumpScale,cD.bumpScale?cD.bumpScale:1)}if(cC.bumpMap){this.loadTexture(cE,cC.bumpMap,cD.bumpMap)}}};this.loadUniformsNormalMap=function(cE,cD,cC){if(cD.normalMap){if(cC.normalScale){if(cD.normalScale){cE.uniform2f(cC.normalScale,cD.normalScale.x,cD.normalScale.y)}else{cE.uniform2f(cC.normalScale,1,1)}}if(cC.normalMap){this.loadTexture(cE,cC.normalMap,cD.normalMap)}}};this.loadUniformsLines=function(cH,cE,cC,cG){if(cC.diffuse){var cD=cE.color;if(cG&&!cG.disableColorOverride&&cG.getColor()){cD=new s.Color(cG.getColor())}if(this.gammaInput){if(cE.NRECompatibility){cD=new s.Color().copyGammaToLinearNRECompatible(cD)}else{cD=new s.Color().copyGammaToLinear(cD)}}cH.uniform3f(cC.diffuse,cD.r,cD.g,cD.b)}if(cC.opacity){var cF=cE.opacity;if(cG&&cG.getOpacity()!==null){cF=cG.getOpacity()}if(this.useRenderPriorityOpacity){cF=this.computeRenderPriorityOpacity(cF,cG)}cH.uniform1f(cC.opacity,cF)}if(cC.pixelSize){cH.uniform2f(cC.pixelSize,cE.pixelSize.x,cE.pixelSize.y)}if(cE.isDashedLine){if(cC.scale){cH.uniform1f(cC.scale,cE.scale?cE.scale:0.15)}if(cC.dashPattern){cH.uniform1fv(cC.dashPattern,cE.dashPattern)}if(cC.totalSize){cH.uniform1f(cC.totalSize,cE.dashPattern[cE.dashPattern.length-1])}if(cC.patternOffset){cH.uniform1f(cC.patternOffset,cE.patternOffset)}}if(cE.isWideLine||cE.is2DLine){if(cC.halfWidth){cH.uniform1f(cC.halfWidth,cE.lineWidth?cE.lineWidth/2:0.5)}}if(cE.is2DLine){if(cC.miterLimit){cH.uniform1f(cC.miterLimit,cE.miterLimit?cE.miterLimit:4)}}};this.loadUniformsSkinning=function(cE,cD,cC){if(cD.skinning){if(cC.skinningMap){this.loadTexture(cE,cC.skinningMap,cD.skinningMap)}if(cC.skinningInstancingMaps){this.loadTextureArray(cE,cD.program,cC.skinningInstancingMaps,"skinningInstancingMaps",cD.skinningInstancingMaps)}}};this.loadUniformsParticle=function(cH,cE,cC,cG){if(cC.psColor){var cD=cE.color;if(cG&&!cG.disableColorOverride&&cG.getColor()){cD=new s.Color(cG.getColor())}cH.uniform3f(cC.psColor,cD.r,cD.g,cD.b)}if(cC.opacity){var cF=cE.opacity;if(cG&&cG.getOpacity()!==null){cF=cG.getOpacity()}if(this.useRenderPriorityOpacity){cF=this.computeRenderPriorityOpacity(cF,cG)}cH.uniform1f(cC.opacity,cF)}if(cC.scale){cH.uniform1f(cC.scale,this.domElement.height/2)}if(cC.size){cH.uniform1f(cC.size,cE.size?cE.size:1)}if(cC.map){this.loadTexture(cH,cC.map,cE.map)}};this.loadUniformsLights=function(cG,cF,cE,cD){if(cF.ambientLightColor&&cE.ambient.length>0){cG.uniform3fv(cF.ambientLightColor,cE.ambient)}if(cE.shFactors[0]!==null){if(cF.shFactorsR){this.loadMatrix4(cG,cF.shFactorsR,cE.shFactors[0]?cE.shFactors[0]:new s.Matrix4())}if(cF.shFactorsG){this.loadMatrix4(cG,cF.shFactorsG,cE.shFactors[1]?cE.shFactors[1]:new s.Matrix4())}if(cF.shFactorsB){this.loadMatrix4(cG,cF.shFactorsB,cE.shFactors[2]?cE.shFactors[2]:new s.Matrix4())}if(cF.shScale){cG.uniform1f(cF.shScale,cE.shScale?cE.shScale:0.333)}}if(cF.directionalLightColor&&cE.directional.colors.length>0){cG.uniform3fv(cF.directionalLightColor,cE.directional.colors)}if(cF.directionalLightDirection&&cE.directional.positions.length>0){cG.uniform3fv(cF.directionalLightDirection,cE.directional.positions)}if(cF.directionalLightNear&&cE.directional.nears.length>0){cG.uniform1fv(cF.directionalLightNear,cE.directional.nears)}if(cF.directionalLightFar&&cE.directional.fars.length>0){cG.uniform1fv(cF.directionalLightFar,cE.directional.fars)}if(cF.pointLightColor&&cE.point.colors.length>0){cG.uniform3fv(cF.pointLightColor,cE.point.colors)}if(cF.pointLightPosition&&cE.point.positions.length>0){cG.uniform3fv(cF.pointLightPosition,cE.point.positions)}if(cF.pointLightPhysicalAttenuation&&cE.point.physicalAttenuations.length>0){cG.uniform1iv(cF.pointLightPhysicalAttenuation,cE.point.physicalAttenuations)}if(cF.pointLightDistance&&cE.point.distances.length>0){cG.uniform1fv(cF.pointLightDistance,cE.point.distances)}if(cF.spotLightColor&&cE.spot.colors.length>0){cG.uniform3fv(cF.spotLightColor,cE.spot.colors)}if(cF.spotLightPosition&&cE.spot.positions.length>0){cG.uniform3fv(cF.spotLightPosition,cE.spot.positions)}if(cF.spotLightDirection&&cE.spot.directions.length>0){cG.uniform3fv(cF.spotLightDirection,cE.spot.directions)}if(cF.spotLightPhysicalAttenuation&&cE.spot.physicalAttenuations.length>0){cG.uniform1iv(cF.spotLightPhysicalAttenuation,cE.spot.physicalAttenuations)}if(cF.spotLightDistance&&cE.spot.distances.length>0){cG.uniform1fv(cF.spotLightDistance,cE.spot.distances)}if(cF.spotLightAngleCos&&cE.spot.anglesCos.length>0){cG.uniform1fv(cF.spotLightAngleCos,cE.spot.anglesCos)}if(cF.spotLightInnerAngleCos&&cE.spot.innerAnglesCos.length>0){cG.uniform1fv(cF.spotLightInnerAngleCos,cE.spot.innerAnglesCos)}if(cF.iesLightColor&&cE.ies.colors.length>0){cG.uniform3fv(cF.iesLightColor,cE.ies.colors)}if(cF.iesLightPosition&&cE.ies.positions.length>0){cG.uniform3fv(cF.iesLightPosition,cE.ies.positions)}if(cF.iesLightDistance&&cE.ies.distances.length>0){cG.uniform1fv(cF.iesLightDistance,cE.ies.distances)}if(cF.iesLightTexture&&cE.ies.iesLightTexture.length>0){this.loadTextureArray(cG,cD,cF.iesLightTexture,"iesLightTexture",cE.ies.iesLightTexture)}if(cF.matrixWorldInv){this.loadMatrix4Array(cG,cD,cF.matrixWorldInv,"matrixWorldInv",cE.ies.matrixWorldInv)}if(cF.hemisphereLightSkyColor&&cE.hemi.skyColors.length>0){cG.uniform3fv(cF.hemisphereLightSkyColor,cE.hemi.skyColors)}if(cF.hemisphereLightGroundColor&&cE.hemi.groundColors.length>0){cG.uniform3fv(cF.hemisphereLightGroundColor,cE.hemi.groundColors)}if(cF.hemisphereLightDirection&&cE.hemi.positions.length>0){cG.uniform3fv(cF.hemisphereLightDirection,cE.hemi.positions)}if(cF.sphereLightColor&&cE.sphere.colors.length>0){cG.uniform3fv(cF.sphereLightColor,cE.sphere.colors)}if(cF.sphereLightPosition&&cE.sphere.positions.length>0){cG.uniform3fv(cF.sphereLightPosition,cE.sphere.positions)}if(cF.sphereLightData&&cE.sphere.data.length>0){cG.uniform3fv(cF.sphereLightData,cE.sphere.data)}if(cF.diskLightColor&&cE.disk.colors.length>0){cG.uniform3fv(cF.diskLightColor,cE.disk.colors)}if(cF.diskLightNormal&&cE.disk.normals.length>0){cG.uniform3fv(cF.diskLightNormal,cE.disk.normals)}if(cF.diskLightPosition&&cE.disk.positions.length>0){cG.uniform3fv(cF.diskLightPosition,cE.disk.positions)}if(cF.diskLightData&&cE.disk.data.length>0){cG.uniform3fv(cF.diskLightData,cE.disk.data)}if(cF.tubeLightColor&&cE.tube.colors.length>0){cG.uniform3fv(cF.tubeLightColor,cE.tube.colors)}if(cF.tubeLightRight&&cE.tube.rights.length>0){cG.uniform3fv(cF.tubeLightRight,cE.tube.rights)}if(cF.tubeLightPosition&&cE.tube.positions.length>0){cG.uniform3fv(cF.tubeLightPosition,cE.tube.positions)}if(cF.tubeLightData&&cE.tube.data.length>0){cG.uniform3fv(cF.tubeLightData,cE.tube.data)}if(cF.areaLightColor&&cE.area.colors.length>0){cG.uniform3fv(cF.areaLightColor,cE.area.colors)}if(cF.areaLightPosition&&cE.area.positions.length>0){cG.uniform3fv(cF.areaLightPosition,cE.area.positions)}if(cF.areaLightNormal&&cE.area.normals.length>0){cG.uniform3fv(cF.areaLightNormal,cE.area.normals)}if(cF.areaLightRight&&cE.area.rights.length>0){cG.uniform3fv(cF.areaLightRight,cE.area.rights)}if(cF.areaLightUp&&cE.area.ups.length>0){cG.uniform3fv(cF.areaLightUp,cE.area.ups)}if(cF.areaLightData&&cE.area.data.length>0){cG.uniform3fv(cF.areaLightData,cE.area.data)}var cC=cE.area.colors.length>0||cE.tube.colors.length>0||cE.disk.colors.length>0||cE.sphere.colors.length>0;if(cC){if(cF.precomputedAreaGGX1texture){if(this.precomputedAreaGGX1texture&&this.precomputedAreaGGX1texture.onRequest){this.precomputedAreaGGX1texture.onRequest();this.precomputedAreaGGX1texture.onRequest=null}this.loadTexture(cG,cF.precomputedAreaGGX1texture,this.precomputedAreaGGX1texture)}if(cF.precomputedAreaGGX2texture){if(this.precomputedAreaGGX2texture&&this.precomputedAreaGGX2texture.onRequest){this.precomputedAreaGGX2texture.onRequest();this.precomputedAreaGGX2texture.onRequest=null}this.loadTexture(cG,cF.precomputedAreaGGX2texture,this.precomputedAreaGGX2texture)}if(cF.precomputedAreaSheentexture){if(this.precomputedAreaSheentexture&&this.precomputedAreaSheentexture.onRequest){this.precomputedAreaSheentexture.onRequest();this.precomputedAreaSheentexture.onRequest=null}this.loadTexture(cG,cF.precomputedAreaSheentexture,this.precomputedAreaSheentexture)}}};this.loadUniformsFog=function(cE,cC,cD){if(cC.fogColor){cE.uniform3f(cC.fogColor,cD.color.r,cD.color.g,cD.color.b)}if(cD instanceof s.Fog){if(cC.fogNear){cE.uniform1f(cC.fogNear,cD.near?cD.near:1)}if(cC.fogFar){cE.uniform1f(cC.fogFar,cD.far?cD.far:2000)}}else{if(cD instanceof s.FogExp2){if(cC.fogDensity){cE.uniform1f(cC.fogDensity,cD.density?cD.density:0.00025)}}}};this.loadUniformsShadow=function(cT,cJ,cV){var cP=cJ.uniformLocations;if(cP.shadowMatrix){var cS=0;var cE=[];var cC=[];var cN=[];var cD=[];if(this.shadowMapType===s.PCFPoissonShadowMap){this.loadVector2Array(cT,cJ,cP.poissonDisk,"poissonDisk",h)}for(var cU=0,cL=cV.length;cU<cL;cU++){var cG=cV[cU];if(cG instanceof s.SpotLight||(cG instanceof s.DirectionalLight&&!cG.shadowCascade&&(!cG.isVirtual||this.shadowMapCascade))){if(!cG.castShadow){continue}cE[cS]=cG.shadowMap;cC[cS]=cG.shadowMapSize;cN[cS]=cG.shadowDarkness;cD[cS]=cG.shadowBias;cS++}}if(cP.shadowMap){this.loadTextureArray(cT,cJ,cP.shadowMap,"",cE)}if(cP.shadowMapSize){this.loadVector2Array(cT,cJ,cP.shadowMapSize,"shadowMapSize",cC)}if(cP.shadowDarkness){cT.uniform1fv(cP.shadowDarkness,cN)}if(cP.shadowBias){cT.uniform1fv(cP.shadowBias,cD)}}if(cP.shadowMapCube){var cQ=0;var cF=[];var cK=[];var cH=[];var cM=[];var cO=[];var cI=[];var cR=[];for(var cU=0,cL=cV.length;cU<cL;cU++){var cG=cV[cU];if(cG instanceof s.PointLight){if(!cG.castShadow){continue}cF[cQ]=cG.shadowMap;cK[cQ]=cG.shadowDarkness;cH[cQ]=cG.shadowBias;cO[cQ]=cG.shadowCameraNear;cI[cQ]=cG.shadowCameraFar;cR[cQ]=cG.shadowMapWidth;cG.setupShadowPositions(cM);cQ++}}this.loadTextureCubeArray(cT,cJ,cP.shadowMapCube,"shadowMapCube",cF);if(cP.shadowDarknessCube){cT.uniform1fv(cP.shadowDarknessCube,cK)}if(cP.shadowFarCube){cT.uniform1fv(cP.shadowFarCube,cI)}if(cP.shadowNearCube){cT.uniform1fv(cP.shadowNearCube,cO)}if(cP.shadowBiasCube){cT.uniform1fv(cP.shadowBiasCube,cH)}if(cP.shadowPointPosition){cT.uniform3fv(cP.shadowPointPosition,cM)}if(cP.shadowMapSizeCube){cT.uniform1fv(cP.shadowMapSizeCube,cR)}}};this.loadUniformsShadowMatrices=function(cK,cJ,cG,cE){var cC=cJ.objectUniformLocations;if(cC.shadowMatrix){var cH=0;var cD=[];for(var cI=0,cL=cG.length;cI<cL;cI++){var cF=cG[cI];if(!cF.castShadow){continue}if(cF instanceof s.SpotLight||(cF instanceof s.DirectionalLight&&!cF.shadowCascade&&(!cF.isVirtual||this.shadowMapCascade))){cD[cH]=cE.currentShadowMatrices[cH];cH++}}if(cC.shadowMatrix){this.loadMatrix4Array(cK,cJ,cC.shadowMatrix,"shadowMatrix",cD)}}};this.loadClippingUniforms=function(cE,cC){var cD=this._clipPlanesState.uniforms;if(cC.nbClipPlanes){cE.uniform1i(cC.nbClipPlanes,cD.nbClipPlanes.value)}if(cD.nbClipPlanes.value!==0){if(cC.clipPlaneEquations&&cD.clipPlaneEquations.value.length>0){cE.uniform4fv(cC.clipPlaneEquations,cD.clipPlaneEquations.value)}if(cC.clipPlaneActive&&cD.clipPlaneActive.value.length>0){cE.uniform1iv(cC.clipPlaneActive,cD.clipPlaneActive.value)}if(cC.clipFrontOpacity){cE.uniform1f(cC.clipFrontOpacity,cD.clipFrontOpacity.value)}if(cC.clipBackOpacity){cE.uniform1f(cC.clipBackOpacity,cD.clipBackOpacity.value)}}if(cC.polygonSize){cE.uniform1i(cC.polygonSize,cD.polygonSize.value)}if(cD.polygonSize.value!==0){if(cC.polygonPoints){this.loadTexture(cE,cC.polygonPoints,cD.polygonPoints.value)}if(cC.extrusionPlaneU){cE.uniform3f(cC.extrusionPlaneU,cD.extrusionPlaneU.value.x,cD.extrusionPlaneU.value.y,cD.extrusionPlaneU.value.z)}if(cC.extrusionPlaneV){cE.uniform3f(cC.extrusionPlaneV,cD.extrusionPlaneV.value.x,cD.extrusionPlaneV.value.y,cD.extrusionPlaneV.value.z)}}};function aw(cK,cP){var cJ,cQ,cG,cH,cM,cI;for(var cF=0,cI=cP.length;cF<cI;cF++){var cD=cP[cF][0];var cE=cP[cF][1];var cO=cK[cD];var cC=cP[cF][2];if(cC&&!cC.value){continue}var cL=cE.type;var cN=cE.value;switch(cL){case"b":case"i":w.uniform1i(cO,cN);break;case"f":w.uniform1f(cO,cN);break;case"v2":w.uniform2f(cO,cN.x,cN.y);break;case"v3":w.uniform3f(cO,cN.x,cN.y,cN.z);break;case"v4":w.uniform4f(cO,cN.x,cN.y,cN.z,cN.w);break;case"c":w.uniform3f(cO,cN.r,cN.g,cN.b);break;case"iv1":if(cN.length>0){w.uniform1iv(cO,cN)}break;case"iv":if(cN.length>0){w.uniform3iv(cO,cN)}break;case"fv1":if(cN.length>0){w.uniform1fv(cO,cN)}break;case"fv2":if(cN.length>0){w.uniform2fv(cO,cN)}break;case"fv":if(cN.length>0){w.uniform3fv(cO,cN)}break;case"fv4":if(cN.length>0){w.uniform4fv(cO,cN)}break;case"v2v":if(cE._array===undefined){cE._array=new Float32Array(2*cN.length)}for(cH=0,cM=cN.length;cH<cM;cH++){cG=cH*2;cE._array[cG]=cN[cH].x;cE._array[cG+1]=cN[cH].y}w.uniform2fv(cO,cE._array);break;case"v3v":if(cE._array===undefined){cE._array=new Float32Array(3*cN.length)}for(cH=0,cM=cN.length;cH<cM;cH++){cG=cH*3;cE._array[cG]=cN[cH].x;cE._array[cG+1]=cN[cH].y;cE._array[cG+2]=cN[cH].z}w.uniform3fv(cO,cE._array);break;case"v4v":if(cE._array===undefined){cE._array=new Float32Array(4*cN.length)}for(cH=0,cM=cN.length;cH<cM;cH++){cG=cH*4;cE._array[cG]=cN[cH].x;cE._array[cG+1]=cN[cH].y;cE._array[cG+2]=cN[cH].z;cE._array[cG+3]=cN[cH].w}w.uniform4fv(cO,cE._array);break;case"m3":if(cN){w.uniformMatrix3fv(cO,false,cN.elements)}break;case"m4":if(cN){w.uniformMatrix4fv(cO,false,cN.elements)}break;case"m4v":if(cE._array===undefined){cE._array=new Float32Array(16*cN.length)}for(cH=0,cM=cN.length;cH<cM;cH++){if(cN[cH]){cN[cH].flattenToArrayOffset(cE._array,cH*16)}}w.uniformMatrix4fv(cO,false,cE._array);break;case"t":case"t2":case"tc":cJ=cN;cQ=a2();w.uniform1i(cO,cQ);if(!cJ){cJ=bk._dummyTexture}if(cJ.image instanceof Array&&cJ.image.length===6){bY(cJ,cQ)}else{if(cJ instanceof s.WebGLRenderTargetCube){bK(cJ,cQ)}else{bk.setTexture(cJ,cQ)}}break;case"tv":case"t2v":case"tcv":if(cE._array===undefined){cE._array=[]}for(cH=0,cM=cE.value.length;cH<cM;cH++){cE._array[cH]=a2()}w.uniform1iv(cO,cE._array);for(cH=0,cM=cE.value.length;cH<cM;cH++){cJ=cE.value[cH];cQ=cE._array[cH];if(!cJ){cJ=bk._dummyTexture}bk.setTexture(cJ,cQ)}break}}}function bE(cF,cE,cC,cD){cF[cE]=cC.r*cC.r*cD;cF[cE+1]=cC.g*cC.g*cD;cF[cE+2]=cC.b*cC.b*cD}function bF(cF,cE,cD,cC){cF[cE]=cD.r*cC;cF[cE+1]=cD.g*cC;cF[cE+2]=cD.b*cC}function y(cE,cF){var cG=b3;var cH={ambient:{r:0,g:0,b:0},directional:{dirCount:0,dirLength:0,dirColors:b3.directional.colors,dirPositions:b3.directional.positions,dirNears:b3.directional.nears,dirFars:b3.directional.fars},point:{pointCount:0,pointLength:0,pointColors:b3.point.colors,pointPositions:b3.point.positions,pointPhysicalAttenuations:b3.point.physicalAttenuations,pointDistances:b3.point.distances},spot:{spotCount:0,spotLength:0,spotColors:b3.spot.colors,spotPositions:b3.spot.positions,spotPhysicalAttenuations:b3.spot.physicalAttenuations,spotDistances:b3.spot.distances,spotDirections:b3.spot.directions,spotAnglesCos:b3.spot.anglesCos,spotInnerAnglesCos:b3.spot.innerAnglesCos,},ies:{iesCount:0,iesLength:0,iesColors:b3.ies.colors,iesPositions:b3.ies.positions,iesDistances:b3.ies.distances,iesLightTexture:b3.ies.iesLightTexture,matrixWorldInv:b3.ies.matrixWorldInv},hemi:{hemiCount:0,hemiLength:0,hemiSkyColors:b3.hemi.skyColors,hemiGroundColors:b3.hemi.groundColors,hemiPositions:b3.hemi.positions},probe:{shFactorsR:null,shFactorsG:null,shFactorsB:null,shScale:0},area:{areaCount:0,areaLength:0,areaColors:b3.area.colors,areaPositions:b3.area.positions,areaNormals:b3.area.normals,areaRights:b3.area.rights,areaUps:b3.area.ups,areaData:b3.area.data},sphere:{sphereCount:0,sphereLength:0,sphereColors:b3.sphere.colors,spherePositions:b3.sphere.positions,sphereData:b3.sphere.data},disk:{diskCount:0,diskLength:0,diskColors:b3.disk.colors,diskNormals:b3.disk.normals,diskPositions:b3.disk.positions,diskData:b3.disk.data},tube:{tubeCount:0,tubeLength:0,tubeColors:b3.tube.colors,tubeRights:b3.tube.rights,tubePositions:b3.tube.positions,tubeData:b3.tube.data},camera:cF};for(cC=0,cI=cE.length;cC<cI;cC++){var cD=cE[cC];if(cD.onlyShadow){continue}cD.setup(cH,bE,bF,bk)}var cC,cI;for(cC=cH.directional.dirLength*3,cI=Math.max(cH.directional.dirColors.length,cH.directional.dirCount*3);cC<cI;cC++){cH.directional.dirColors[cC]=0}b3.directional.length=cH.directional.dirLength;for(cC=cH.point.pointLength*3,cI=Math.max(cH.point.pointColors.length,cH.point.pointCount*3);cC<cI;cC++){cH.point.pointColors[cC]=0}b3.point.length=cH.point.pointLength;for(cC=cH.spot.spotLength*3,cI=Math.max(cH.spot.spotColors.length,cH.spot.spotCount*3);cC<cI;cC++){cH.spot.spotColors[cC]=0}b3.spot.length=cH.spot.spotLength;for(cC=cH.hemi.hemiLength*3,cI=Math.max(cH.hemi.hemiSkyColors.length,cH.hemi.hemiCount*3);cC<cI;cC++){cH.hemi.hemiSkyColors[cC]=0}for(cC=cH.hemi.hemiLength*3,cI=Math.max(cH.hemi.hemiGroundColors.length,cH.hemi.hemiCount*3);cC<cI;cC++){cH.hemi.hemiGroundColors[cC]=0}b3.hemi.length=cH.hemi.hemiLength;for(cC=cH.ies.iesLength*3,cI=Math.max(cH.ies.iesColors.length,cH.ies.iesCount*3);cC<cI;cC++){cH.ies.iesColors[cC]=0}b3.ies.length=cH.ies.iesLength;b3.ambient[0]=cH.ambient.r;b3.ambient[1]=cH.ambient.g;b3.ambient[2]=cH.ambient.b;b3.shFactors[0]=cH.probe.shFactorsR;b3.shFactors[1]=cH.probe.shFactorsG;b3.shFactors[2]=cH.probe.shFactorsB;b3.shScale=cH.probe.shScale}function M(cH,cG,cK){var cF,cD,cJ,cL=0,cE=0;for(cF=0,cD=cG.length;cF<cD;cF++){cJ=cG[cF];cE=4*cL;var cC=new s.Matrix4().copy(cK.matrixWorld);cC.transpose();var cI=new s.Plane().copy(cJ);cI.applyMatrix4(cK.matrixWorldInverse);S.eqs[cE]=cI.normal.x;S.eqs[cE+1]=cI.normal.y;S.eqs[cE+2]=cI.normal.z;S.eqs[cE+3]=cI.constant;S.states[cF]=cJ.enabled?1:0;cL++}S.length=cL}this.setDisableColorWrite=function(cC){this.disableColorWrite=cC},this.setDisableDepthWrite=function(cC){this.disableDepthWrite=cC},this.setDisableDepthTest=function(cC){this.disableDepthTest=cC},this.setEnableStencilWrite=function(cC){this.enableStencilWrite=cC},this.setDisableBackFaceCulling=function(cC){this.disableBackFaceCulling=cC},this.setFaceCulling=function(cD,cC){b1=0;E=undefined;bX=undefined;if(cD===s.CullFaceNone){w.disable(w.CULL_FACE);bX=true}else{if(cC===s.FrontFaceDirectionCW){w.frontFace(w.CW)}else{w.frontFace(w.CCW)}if(cD===s.CullFaceBack){w.cullFace(w.BACK)}else{if(cD===s.CullFaceFront){w.cullFace(w.FRONT)}else{w.cullFace(w.FRONT_AND_BACK)}}w.enable(w.CULL_FACE);bX=false}};this.setMaterialFaces=function(cJ,cG,cI,cE){var cF=cE&&(cG._bodyDim===3);var cH=(cJ.side===a.BackSide);var cC=(!cF&&!cH&&(cJ.side!==a.FrontSide))||this.disableBackFaceCulling;var cD=(cG!==undefined)?cG.orientation:1;if(cI!==undefined){cD*=cI.orientation}if(bX!==cC){if(cC){w.disable(w.CULL_FACE)}else{w.enable(w.CULL_FACE)}bX=cC}if((E!==cH)||(b1!==cD)){if(cH){if(cD>=0){w.frontFace(w.CW)}else{w.frontFace(w.CCW)}}else{if(cD>=0){w.frontFace(w.CCW)}else{w.frontFace(w.CW)}}b1=cD;E=cH}};this.setMaterialFacesDebug=function(cH,cE,cG){var cC=cH.side===a.DoubleSide;var cF=cH.side===a.BackSide;var cD=(cE!==undefined)?cE.orientation:1;if(cG!==undefined){cD*=cG.orientation}if(cE instanceof s.Mesh){cD=-cD}if(bX!==cC){if(cC){w.disable(w.CULL_FACE)}else{w.enable(w.CULL_FACE)}bX=cC}if((E!==cF)||(b1!==cD)){if(cF){if(cD>=0){w.frontFace(w.CW)}else{w.frontFace(w.CCW)}}else{if(cD>=0){w.frontFace(w.CCW)}else{w.frontFace(w.CW)}}b1=cD;E=cF}};this.setDepthTest=function(cC){if(u!==cC){if(cC){w.enable(w.DEPTH_TEST)}else{w.disable(w.DEPTH_TEST)}u=cC}};this.setDepthWrite=function(cC){if(cd!==cC){w.depthMask(cC);cd=cC}};this.setStencilWrite=function(cC){if(cC!==ct){if(cC){w.stencilMask(255)}else{w.stencilMask(0)}ct=cC}};function bd(cC){if(cC!=undefined&&cC!==bZ){w.lineWidth(cC);bZ=cC}}function cx(cE,cD,cC){if(be!==cE){if(cE){w.enable(w.POLYGON_OFFSET_FILL)}else{w.disable(w.POLYGON_OFFSET_FILL)}be=cE}if(cE&&(cp!==cD||bL!==cC)){w.polygonOffset(cD,cC);cp=cD;bL=cC}}this.setBlending=function(cD,cC,cE,cF){if(cD!==w._oldBlending){if(cD===s.NoBlending){w.disable(w.BLEND)}else{if(cD===s.AdditiveBlending){w.enable(w.BLEND);w.blendEquation(w.FUNC_ADD);w.blendFunc(w.SRC_ALPHA,w.ONE)}else{if(cD===s.SubtractiveBlending){w.enable(w.BLEND);w.blendEquation(w.FUNC_ADD);w.blendFunc(w.ZERO,w.ONE_MINUS_SRC_COLOR)}else{if(cD===s.MultiplyBlending){w.enable(w.BLEND);w.blendEquation(w.FUNC_ADD);w.blendFunc(w.ZERO,w.SRC_COLOR)}else{if(cD===s.CustomBlending){w.enable(w.BLEND)}else{if(cD===s.NormalDepthBlending){w.enable(w.BLEND);w.blendEquationSeparate(w.FUNC_ADD,w.FUNC_ADD);w.blendFuncSeparate(w.ZERO,w.ONE,w.ONE,w.ZERO)}else{if(cD===s.AlphaBlending){w.enable(w.BLEND);w.blendEquation(w.FUNC_ADD);w.blendFunc(w.SRC_ALPHA,w.ONE_MINUS_SRC_ALPHA)}else{w.enable(w.BLEND);w.blendEquationSeparate(w.FUNC_ADD,w.FUNC_ADD);w.blendFuncSeparate(w.SRC_ALPHA,w.ONE_MINUS_SRC_ALPHA,w.ONE,w.ONE_MINUS_SRC_ALPHA)}}}}}}}w._oldBlending=cD}if(cD===s.CustomBlending){if(cC!==aR){w.blendEquation(bp(cC));aR=cC}if(cE!==cq||cF!==a0){w.blendFunc(bp(cE),bp(cF));cq=cE;a0=cF}}else{aR=null;cq=null;a0=null}};function ar(cD){var cE,cC,cG=[];for(var cF in cD){cE=cD[cF];if(cE===false){continue}cC="#define "+cF+" "+cE;cG.push(cC)}return cG.join("\n")}function B(cP,cC,cJ,c8,cS,c4,cQ){var c1,c6,c7,cR,cD;var cW=[];if(cP>=0){cW.push(s.ShaderIDsToName[cP])}else{cW.push(cC);cW.push(cJ)}for(c7 in c4){cW.push(c7);cW.push(c4[c7])}for(c1 in cQ){cW.push(c1);cW.push(cQ[c1])}cD=cW.join();var cE="SHADOWMAP_TYPE_BASIC";if(cQ.shadowMapType===s.PCFShadowMap){cE="SHADOWMAP_TYPE_PCF"}else{if(cQ.shadowMapType===s.PCFSoftShadowMap){cE="SHADOWMAP_TYPE_PCF_SOFT"}else{if(cQ.shadowMapType===s.PCFInterpolShadowMap){cE="SHADOWMAP_TYPE_PCF_INTERPOL"}else{if(cQ.shadowMapType===s.PCFPoissonShadowMap){cE="SHADOWMAP_TYPE_PCF_POISSON"}else{if(cQ.shadowMapType===s.PCFOptimizedShadowMap){cE="SHADOWMAP_TYPE_PCF_OPTI"}else{if(cQ.shadowMapType===s.ESMShadowMap){cE="SHADOWMAP_TYPE_ESM"}else{if(cQ.shadowMapType===s.ESMImprovedShadowMap){cE="SHADOWMAP_TYPE_ESM_IMPROVED"}}}}}}}var c0="SHADOWMAP_QUALITY_LOW";if(cQ.shadowMapQuality===s.MediumQuality){c0="SHADOWMAP_QUALITY_MEDIUM"}else{if(cQ.shadowMapQuality===s.HighQuality){c0="SHADOWMAP_QUALITY_HIGH"}}var cI=ar(c4);var cX=cQ.map||cQ.bumpMap||cQ.normalMap||cQ.specularMap||cQ.specularContribMap||cQ.emissionColorMap||cQ.transparencyMap||cQ.opacityMap||cQ.metalnessMap||cQ.roughnessMap||cQ.glossinessMap||cQ.anisotropyMap||cQ.anisotropyAngleMap||cQ.clearCoatNormalMap||cQ.clearCoatRoughnessMap||cQ.coatingGlossinessMap||cQ.sheenMap||cQ.clearCoatMap;var cH=["precision "+D+" float;",cI,cP===s.ShaderIDs.particle_basic?"#define PARTICLE":"",br?"#define VERTEX_TEXTURES":"",J?"#define RENDER_TO_FLOAT_TEXTURE":"",bk.gammaInput?"#define GAMMA_INPUT":"",bk.gammaOutput?"#define GAMMA_OUTPUT":"","#define MAX_DIR_LIGHTS "+cQ.maxDirLights,"#define MAX_POINT_LIGHTS "+cQ.maxPointLights,"#define MAX_SPOT_LIGHTS "+cQ.maxSpotLights,"#define MAX_HEMI_LIGHTS "+cQ.maxHemiLights,cQ.probeLight?"#define USE_SH_ENVMAP":"","#define MAX_SPHERE_LIGHTS "+cQ.maxSphereLights,"#define MAX_TUBE_LIGHTS "+cQ.maxTubeLights,"#define MAX_DISK_LIGHTS "+cQ.maxDiskLights,"#define MAX_AREA_LIGHTS "+cQ.maxAreaLights,"#define MAX_IES_LIGHTS "+cQ.maxIESLights,cQ.lightMap?"#define USE_LIGHTMAP":"","#define MAX_SHADOWS "+cQ.maxShadows,"#define MAX_SHADOWS_DIR "+cQ.maxDirShadows,"#define MAX_SHADOWS_SPOT "+cQ.maxSpotShadows,"#define MAX_SHADOWS_CUBE "+cQ.maxShadowsCube,cQ.shadowMapEnabled?"#define USE_SHADOWMAP":"",(cQ.shadowMapEnabled||cQ.shadowMapCubeEnabled)?"#define "+cE:"",(cQ.shadowMapEnabled||cQ.shadowMapCubeEnabled)?"#define "+c0:"",cQ.shadowMapCubeEnabled?"#define USE_SHADOWMAP_CUBE":"",cQ.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",cQ.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",cQ.morphTargets?"#define USE_MORPHTARGETS":"",cQ.morphNormals?"#define USE_MORPHNORMALS":"",cQ.fixedSize?"#define FIXED_SIZE":"",cQ.fixedSizeCenter?"#define FIXED_SIZE_CENTER":"",cQ.skinning?"#define USE_SKINNING":"",cQ.useEulerAngles?"#define USE_SKINNING_ANGLES":"",cQ.skinningMapWidth&&!cQ.isMultiInstanced?"#define N_BONE_PIXEL_X "+cQ.skinningMapWidth.toFixed(1):"",cQ.skinningMapHeight&&!cQ.isMultiInstanced?"#define N_BONE_PIXEL_Y "+cQ.skinningMapHeight.toFixed(1):"",cQ.skinningInstancingMapsInfo&&cQ.isMultiInstanced?"#define NB_INSTANCING_SKIN_MAPS "+cQ.skinningInstancingMapsInfo.nbTextures+"\n#define NB_BONES "+cQ.skinningInstancingMapsInfo.nbBones.toFixed(1)+"\n#define MAX_MAP_SIZE "+cQ.skinningInstancingMapsInfo.maxTextureSize.toFixed(1)+"\n#define LAST_INSTANCING_SKIN_MAP_SIZE_X "+cQ.skinningInstancingMapsInfo.lastTextureSizeX.toFixed(1)+"\n#define LAST_INSTANCING_SKIN_MAP_SIZE_Y "+cQ.skinningInstancingMapsInfo.lastTextureSizeY.toFixed(1)+"\n":"","#define MAX_BONES "+cQ.maxBones,cX?"#define NEEDS_UVTOUSE":"",(cQ.useUV&&cQ.useUV1)?"#define USE_UV_SLOT_1":"",(cQ.useUV&&cQ.useUV2)?"#define USE_UV_SLOT_2":"",(cQ.mappingUseFragment==false)?"#define USE_MAPPING_OPERATOR_VERTEX":"",(cQ.mappingType>-1)?"#define MAPPING_OPERATOR "+cQ.mappingType:"",cQ.needTangent?"#define USE_TANGENT":"",cQ.needTangentBinormal?"#define USE_TANGENT_BINORMAL":"","#define MAX_CLIP_PLANES "+cQ.maxClipPlanes,cQ.clipPlanesEnabled?"#define USE_CLIPPINGPLANES":"","#define MAX_POLYGON_SIZE "+k.maxPolyLineSize,k.maxPolyLineSize>0?"#define USE_CLIPPINGPOLYGON":"",cQ.perPixel?"#define PHONG_PER_PIXEL":"",cQ.wrapAround?"#define WRAP_AROUND":"",cQ.doubleSided||true?"#define DOUBLE_SIDED":"",cQ.flipSided?"#define FLIP_SIDED":"",cQ.sizeAttenuation?"#define USE_SIZEATTENUATION":"",cQ.vertexColors?"#define USE_COLOR":"",cQ.isMultiInstanced?"#define IS_MULTI_INSTANCED":"",cQ._definePickingInstancing?"#define PICKING_INSTANCING":"",cQ.specgloss?"#define SPECGLOSS":"",cQ.map?"#define USE_MAP":"",cQ.envMap?"#define USE_ENVMAP":"",(cQ.envMapping===1)?"#define USE_LIGHTPROBEMAP":"",(cQ.envMapping===2)?"#define USE_LATLONGMAP":"",cQ.reflectionProbes?"#define USE_REFLECTION_PROBE":"",cQ.useFiniteEnvMap?"#define USE_FINITE_ENVMAP":"",cQ.bumpMap?"#define USE_BUMPMAP":"",cQ.normalMap?"#define USE_NORMALMAP":"",cQ.refractionRatioMap?"#define USE_REFRACTIONRATIOMAP":"",cQ.specularMap?"#define USE_SPECULARMAP":"",cQ.roughnessMap?"#define USE_ROUGHNESSMAP":"",cQ.glossinessMap?"#define USE_GLOSSINESSMAP":"",cQ.anisotropy?"#define USE_ANISOTROPY":"",cQ.anisotropyMap?"#define USE_ANISOTROPYMAP":"",cQ.anisotropyAngleMap?"#define USE_ANISOTROPYANGLEMAP":"",cQ.anisotropy?"#define USE_TANGENT_BINORMAL":"",cQ.displacementMap?"#define USE_DISPLACEMENTMAP":"",cQ.flakes?"#define USE_FLAKES":"",cQ.orangePeel?"#define USE_ORANGE_PEEL":"",cQ.subsurface?"#define USE_SUBSURFACE":"",cQ.iterative?"#define USE_ITERATION":"",cQ.sslr?"#define USE_SSLR":"",cQ.dashedLine?"#define USE_DASHEDLINE":"",cQ.cpuPattern?"#define CPU_PATTERN":"",cQ.patternSize?"#define PATTERN_LENGTH "+cQ.patternSize:"",cQ.wideLine?"#define USE_WIDELINE":"",cQ.wideLine&&cQ.polygonBorderMode?"#define USE_POLYGON_BORDER_MODE":"",cQ.wideLine&&cQ.linejoin?"#define USE_"+cQ.linejoin.toUpperCase()+"JOIN":"",cQ.wideLine&&cQ.linecap?"#define USE_"+cQ.linecap.toUpperCase()+"CAP":"",cQ.NRECompatibility?"#define NRE_COMPATIBILITY":"",cQ.isAccumMat?"#define ACCUM_SHADER":"",cQ.PDSFX?"#define PDSFX":"",cQ.compressedVertices?"#define COMPRESSED_VERTICES":"",cQ.compressedNormals?"#define COMPRESSED_NORMALS":"",cQ.pdsfxUseMap?"#define PDSFX_USE_MAP":"","","#ifdef PICKING_INSTANCING","varying vec3 vInstancePickingColor;","#endif","","uniform mat4 modelViewMatrix;","uniform mat4 modelMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform bool use_normal_matrix;","uniform mat3 normalMatrix; //Only sent if object is non-uniformly scaled!","uniform vec3 cameraPosition;","#ifdef FIXED_SIZE","#ifdef FIXED_SIZE_CENTER","uniform vec4 fixedSizeCenterRatio;","#else","uniform float fixedSizeRatio;","#endif","uniform float cameraConstant;","vec2 getScale() {","vec3 xAxis = vec3(modelViewMatrix[0][0],modelViewMatrix[1][0],modelViewMatrix[2][0]);","vec3 yAxis = vec3(modelViewMatrix[0][1],modelViewMatrix[1][1],modelViewMatrix[2][1]);","vec3 zAxis = vec3(modelViewMatrix[0][2],modelViewMatrix[1][2],modelViewMatrix[2][2]);","float radius = max(length(xAxis),max(length(yAxis),length(zAxis)));","float screenRadius = 1.0;","if (projectionMatrix[3][3] > 0.5) {","screenRadius = radius;","} else {","float constant = abs(modelViewMatrix[3][2]);","screenRadius = radius / constant;","}","#ifdef FIXED_SIZE_CENTER","float scaleFactorCenter = 1.0 / screenRadius * cameraConstant;","if (projectionMatrix[3][3] > 0.5) {","screenRadius = radius;","} else {","vec4 aux = modelViewMatrix * vec4(scaleFactorCenter*fixedSizeCenterRatio.xyz, 1.0);","float constant2 = abs(aux.z);","screenRadius = radius / constant2;","}","float scaleFactor = fixedSizeCenterRatio.w / screenRadius * cameraConstant;","#else","float scaleFactor = fixedSizeRatio / screenRadius * cameraConstant;","float scaleFactorCenter = scaleFactor;","#endif","return vec2(scaleFactor, scaleFactorCenter);","}","#endif","#if defined(FIXED_SIZE)","struct SimpleNodeData {","float fixedSizeScale;","float fixedSizeScaleCenter;","};","SimpleNodeData simpleNodeData;","bool simpleSizeDataSet = false;","void setSimpleNodeData() {","if (simpleSizeDataSet) return;","#ifdef FIXED_SIZE","vec2 fixedSizeData = getScale();","simpleNodeData.fixedSizeScale = fixedSizeData.x;","simpleNodeData.fixedSizeScaleCenter = fixedSizeData.y;","#endif","simpleSizeDataSet = true;","}","#endif","vec3 auxPosMV;","vec3 auxPosMVP;","vec4 auxPosMVPFunc;","#ifdef PDSFX","attribute vec3 _DSposition;","attribute vec3 _DSnormal;","attribute vec2 _DSuv;","attribute vec2 _DSuv2;","attribute vec3 _DStangent;","attribute vec3 _DSbinormal;","vec3 position;","vec3 normal;","vec2 uv;","vec2 uv2;","vec3 tangent;","vec3 binormal;","#else","#ifdef COMPRESSED_VERTICES","vec3 position;","attribute vec2 _DSposition;","uniform vec3 offsetVector;","uniform vec3 quantizedVector;",s.ShaderChunk.decompress_vertices_pars,"#else","attribute vec3 position;","#endif","#ifdef COMPRESSED_NORMALS","vec3 normal;","attribute float _DSnormal;",s.ShaderChunk.decompress_normals_pars,"#else","attribute vec3 normal;","#endif","attribute vec2 uv;","attribute vec2 uv2;","attribute vec3 tangent;","attribute vec3 binormal;","#endif","#ifdef USE_COLOR","attribute vec4 color;","#endif","#ifdef IS_MULTI_INSTANCED","attribute float instanceId;","#endif","#ifdef USE_MORPHTARGETS","attribute vec3 morphTarget0;","attribute vec3 morphTarget1;","attribute vec3 morphTarget2;","attribute vec3 morphTarget3;","#ifdef USE_MORPHNORMALS","attribute vec3 morphNormal0;","attribute vec3 morphNormal1;","attribute vec3 morphNormal2;","attribute vec3 morphNormal3;","#else","attribute vec3 morphTarget4;","attribute vec3 morphTarget5;","attribute vec3 morphTarget6;","attribute vec3 morphTarget7;","#endif","#endif","#ifdef USE_SKINNING","attribute vec4 skinIndex;","attribute vec4 skinWeight;","#endif","#ifdef USE_DISPLACEMENTMAP","uniform sampler2D displacementMap;","uniform float displacementBias;","uniform float displacementScale;","#endif",""].join("\n");if(cQ.PDSFX){var cG=["#ifdef PDSFX",cQ.pdsfxAttributesCode,cQ.pdsfxVaryingsCode,cQ.pdsfxUniformsCode.common,cQ.pdsfxUniformsCode.vertex,s.ShaderChunk.PDSFX_common_pars,s.ShaderChunk.PDSFX_varyings_pars,s.ShaderChunk.PDSFX_attribute_getters_vertex,cQ.pdsfxGlobalVariablesCode_VS,"struct TangentSpace","{","	vec3 Position;","	vec3 Normal;","	vec3 Tangent;","	vec3 Binormal;","};",cQ.PDSFX_OverridableFunctions_VS,"#endif",""].join("\n");cH+=cG}var c2=(cQ.bumpMap||cQ.normalMap||cQ.anisotropy||cQ.flakes||cQ.PDSFX||cQ.dashedLine||cQ.wideLine||cQ.subsurface);var cN=[bM?"#extension GL_EXT_frag_depth : enable":"","#extension  GL_OES_standard_derivatives : enable",bM?"#define FRAG_DEPTH_EXT":"",J?"#define RENDER_TO_FLOAT_TEXTURE":"","#define DEPTH_PRECISION "+s.supportedExtensions.depthBits,"precision "+D+" float;",bk.gammaInput?"#define GAMMA_INPUT":"",bk.gammaOutput?"#define GAMMA_OUTPUT":"",cP===s.ShaderIDs.particle_basic?"#define PARTICLE":"",cQ.alphaTest?"#define ALPHATEST "+cQ.alphaTest:"",cI,"#define MAX_DIR_LIGHTS "+cQ.maxDirLights,"#define MAX_POINT_LIGHTS "+cQ.maxPointLights,"#define MAX_SPOT_LIGHTS "+cQ.maxSpotLights,"#define MAX_IES_LIGHTS "+cQ.maxIESLights,"#define MAX_HEMI_LIGHTS "+cQ.maxHemiLights,"#define MAX_SPHERE_LIGHTS "+cQ.maxSphereLights,"#define MAX_TUBE_LIGHTS "+cQ.maxTubeLights,"#define MAX_DISK_LIGHTS "+cQ.maxDiskLights,"#define MAX_AREA_LIGHTS "+cQ.maxAreaLights,cQ.probeLight?"#define USE_SH_ENVMAP":"",cQ.useLighting?"#define USE_LIGHTING":"",cQ.lightMap?"#define USE_LIGHTMAP":"",(cQ.lightMapMode===1)?"#define LIGHTMAP_IRRADIANCE_MODE":"",cQ.lightMapLinear?"#define USE_LIGHTMAP_LINEAR":"","#define MAX_SHADOWS "+cQ.maxShadows,"#define MAX_SHADOWS_DIR "+cQ.maxDirShadows,"#define MAX_SHADOWS_SPOT "+cQ.maxSpotShadows,"#define MAX_SHADOWS_CUBE "+cQ.maxShadowsCube,cQ.shadowMapEnabled?"#define USE_SHADOWMAP":"",(cQ.shadowMapEnabled||cQ.shadowMapCubeEnabled)?"#define "+cE:"",(cQ.shadowMapEnabled||cQ.shadowMapCubeEnabled)?"#define "+c0:"",cQ.shadowMapCubeEnabled?"#define USE_SHADOWMAP_CUBE":"",cQ.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",cQ.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",(cQ.useFog&&cQ.fog)?"#define USE_FOG":"",(cQ.useFog&&cQ.fogExp)?"#define FOG_EXP2":"",cX?"#define NEEDS_UVTOUSE":"",(cQ.useUV&&cQ.useUV1)?"#define USE_UV_SLOT_1":"",(cQ.useUV&&cQ.useUV2)?"#define USE_UV_SLOT_2":"","#define DIFFUSEMAP_UV_SLOT "+((cQ.diffuseMapUVSlot===2)?"2":"1"),"#define SPECULARMAP_UV_SLOT "+((cQ.specularMapUVSlot===2)?"2":"1"),"#define ROUGHNESSMAP_UV_SLOT "+((cQ.roughnessMapUVSlot===2)?"2":"1"),"#define NORMALMAP_UV_SLOT "+((cQ.normalMapUVSlot===2)?"2":"1"),"#define LIGHTMAP_UV_SLOT "+((cQ.lightMapUVSlot===2)?"2":"1"),(cQ.mappingUseFragment==true)?"#define USE_MAPPING_OPERATOR_FRAGMENT":"",(cQ.mappingType>-1)?"#define MAPPING_OPERATOR "+cQ.mappingType:"",cQ.textureBlending?"#define TEXTURE_BLENDING "+cQ.textureBlending:"",cQ.needTangent?"#define USE_TANGENT":"",cQ.needTangentBinormal?"#define USE_TANGENT_BINORMAL":"",cQ.map?"#define TEXTURE_FORMAT "+cQ.textureFormat.format:"","#define MAX_CLIP_PLANES "+cQ.maxClipPlanes,cQ.clipPlanesEnabled?"#define USE_CLIPPINGPLANES":"","#define MAX_POLYGON_SIZE "+k.maxPolyLineSize,k.maxPolyLineSize>0?"#define USE_CLIPPINGPOLYGON":"",cQ.refractionRatioMap?"#define USE_REFRACTIONRATIOMAP":"",cQ.bumpMap?"#define USE_BUMPMAP":"",cQ.normalMap?"#define USE_NORMALMAP":"",cQ.normalMapFlipY?"#define NORMALFLIPY":"",cQ.specgloss?"#define SPECGLOSS":"",cQ.map?"#define USE_MAP":"",cQ.mapHDR?"#define USE_MAP_HDR":"",(cQ.diffuseMulCoef&&cQ.diffuseAddCoef)?"#define USE_DIFFUSE_COEFFICIENTS":"",cQ.useAlphaFromDiffuseMap?"#define USE_ALPHA_FROM_MAP":"",cQ.specularMap?"#define USE_SPECULARMAP":"",(cQ.specularMulCoef&&cQ.specularAddCoef)?"#define USE_SPECULAR_COEFFICIENTS":"",cQ.specularMapLinear?"#define USE_SPECULARMAP_LINEAR":"",cQ.metalnessMap?"#define USE_METALNESSMAP":"",(cQ.metalnessMulCoef||cQ.metalnessAddCoef)?"#define USE_METALNESS_COEFFICIENTS":"",cQ.metalnessMapLinear?"#define USE_METALNESSMAP_LINEAR":"",cQ.specularContribMap?"#define USE_SPECULARCONTRIBMAP":"",(cQ.specularContribMulCoef||cQ.specularContribAddCoef)?"#define USE_SPECULARCONTRIB_COEFFICIENTS":"",cQ.emissionColorMap?"#define USE_EMISSIONCOLORMAP":"",cQ.emissionMapLinear?"#define USE_EMISSIONCOLORMAP_LINEAR":"",(cQ.emissionColorMulCoef&&cQ.emissionColorAddCoef)?"#define USE_EMISSIONCOLOR_COEFFICIENTS":"",cQ.emissionNormalized?"#define USE_NORMALIZED_EMISSION":"",cQ.transparencyMap?"#define USE_TRANSPARENCYMAP":"",(cQ.transparencyMulCoef||cQ.transparencyAddCoef)?"#define USE_TRANSPARENCY_COEFFICIENTS":"",cQ.opacityMap?"#define USE_OPACITYMAP":"",(cQ.opacityMulCoef||cQ.opacityAddCoef)?"#define USE_OPACITY_COEFFICIENTS":"",cQ.roughnessMap?"#define USE_ROUGHNESSMAP":"",cQ.glossinessMap?"#define USE_GLOSSINESSMAP":"",(cQ.roughnessMulCoef||cQ.roughnessAddCoef)?"#define USE_ROUGHNESS_COEFFICIENTS":"",(cQ.glossinessMulCoef||cQ.glossinessAddCoef)?"#define USE_GLOSSINESS_COEFFICIENTS":"",cQ.roughnessMapLinear?"#define USE_ROUGHNESSMAP_LINEAR":"",cQ.anisotropy?"#define USE_ANISOTROPY":"",cQ.anisotropyMap?"#define USE_ANISOTROPYMAP":"",(cQ.anisotropyMulCoef||cQ.anisotropyAddCoef)?"#define USE_ANISOTROPY_COEFFICIENTS":"",cQ.anisotropyAngleMap?"#define USE_ANISOTROPYANGLEMAP":"",(cQ.anisotropyAngleMulCoef||cQ.anisotropyAngleAddCoef)?"#define USE_ANISOTROPYANGLE_COEFFICIENTS":"",cQ.reflectionProbes?"#define USE_REFLECTION_PROBE":"",cQ.sheen?"#define USE_SHEEN":"",cQ.sheenMap?"#define USE_SHEEN_MAP":"",(cQ.sheenMulCoef||cQ.sheenAddCoef)?"#define USE_SHEEN_COEFFICIENTS":"",cQ.sheenMode&&cQ.sheen?"#define "+cQ.sheenMode:"",cQ.old_flakes?"#define OLD_FLAKES":"",cQ.flakes?"#define USE_FLAKES":"",(cQ.flakesMode<2)?"#define ADVANCED_FLAKES_BLENDING":"",(cQ.flakesMode<2)?"#define ADVANCED_PRESENCE_NOISE":"",(cQ.flakesMode<1)?"#define FLAKES_NORMAL_PERTURBATION":"",(cQ.flakesMode<1)?"#define PEARL_FLAKES_ACTIVATED":"",cQ.flakesCoverageMap?"#define USE_FLAKESCOVERAGE_MAP":"",(cQ.flakesCoverageMulCoef||cQ.flakesCoverageAddCoef)?"#define USE_FLAKESCOVERAGE_COEFFICIENTS":"",cQ.flakesRoughnessMap?"#define USE_FLAKESROUGHNESS_MAP":"",(cQ.flakesRoughnessMulCoef||cQ.flakesRoughnessAddCoef)?"#define USE_FLAKESROUGHNESS_COEFFICIENTS":"",cQ.flakesColorMap?"#define USE_FLAKESCOLOR_MAP":"",(cQ.flakesColorMulCoef||cQ.flakesColorAddCoef)?"#define USE_FLAKESCOLOR_COEFFICIENTS":"",cQ.flakesSizeMap?"#define USE_FLAKESSIZE_MAP":"",(cQ.flakesSizeMulCoef||cQ.flakesSizeAddCoef)?"#define USE_FLAKESSIZE_COEFFICIENTS":"",cQ.clearCoat?"#define CLEAR_COAT":"",cQ.clearCoatMap?"#define CLEAR_COAT_MAP":"",(cQ.clearCoatMulCoef||cQ.clearCoatAddCoef)?"#define USE_CC_COEFFICIENTS":"",cQ.clearCoatNormalMap?"#define CLEAR_COAT_NORMALMAP":"",cQ.clearCoatNormalMapFlipY?"#define CLEAR_COAT_NORMALMAPFLIPY":"",cQ.clearCoatRoughnessMap?"#define USE_CC_ROUGHNESSMAP":"",cQ.coatingGlossinessMap?"#define USE_CC_GLOSSINESSMAP":"",cQ.clearCoatRoughnessMapLinear?"#define USE_CC_ROUGHNESSMAPMAP_LINEAR":"",(cQ.coatingGlossinessMulCoef||cQ.coatingGlossinessAddCoef)?"#define USE_CC_GLOSSINESS_COEFFICIENTS":"",(cQ.clearCoatRoughnessMulCoef||cQ.clearCoatRoughnessAddCoef)?"#define USE_CC_ROUGHNESS_COEFFICIENTS":"",cQ.orangePeel?"#define USE_ORANGE_PEEL":"",cQ.subsurface?"#define USE_SUBSURFACE":"",cQ.sssLUT?"#define USE_SSSLUT":"",cQ.sssIBLLUT?"#define USE_SSSIBLLUT":"",cQ.subsurface?"#define USE_TRANSLUCENCY":"",cQ.translucencyLUT?"#define USE_TRANSLUCENCYLUT":"",cQ.envMap?"#define USE_ENVMAP":"",cQ.envMapSheen?"#define USE_ENVMAP_SHEEN":"",cQ.envMapDiffuse?"#define USE_ENVMAP_DIFFUSE":"",cQ.envMapHDR?"#define USE_ENVMAP_HDR":"",(cQ.envMapping===1)?"#define USE_LIGHTPROBEMAP":"",(cQ.envMapping===2)?"#define USE_LATLONGMAP":"",cQ.useFiniteEnvMap?"#define USE_FINITE_ENVMAP":"",cQ.sslr?"#define USE_SSLR":"",cQ.iterative?"#define USE_ITERATION":"",cQ.thinWalled?"#define THIN_WALLED":"",cQ.NRECompatibility?"#define NRE_COMPATIBILITY":"",cQ._gasLook?"#define GAS_LOOK":"",cQ.isMultiInstanced?"#define IS_MULTI_INSTANCED":"",cQ.instancingMeshSelectionMode?"#define INSTANCING_MESH_SELECTION":"",cQ._definePickingInstancing?"#define PICKING_INSTANCING":"",cQ.dashedLine?"#define USE_DASHEDLINE":"",cQ.cpuPattern?"#define CPU_PATTERN":"",cQ.patternSize?"#define PATTERN_LENGTH "+cQ.patternSize:"",cQ.wideLine?"#define USE_WIDELINE":"",cQ.wideLine&&cQ.polygonBorderMode?"#define USE_POLYGON_BORDER_MODE":"",cQ.wideLine&&cQ.linejoin?"#define USE_"+cQ.linejoin.toUpperCase()+"JOIN":"",cQ.wideLine&&cQ.linecap?"#define USE_"+cQ.linecap.toUpperCase()+"CAP":"",cQ.isAccumMat?"#define ACCUM_SHADER":"",cQ.isRevealMat?"#define REVEAL_SHADER":"",cQ.useOIT?"#define USE_OIT":"",cQ.metal?"#define METAL":"",cQ.perPixel?"#define PHONG_PER_PIXEL":"",cQ.wrapAround?"#define WRAP_AROUND":"",cQ.doubleSided||true?"#define DOUBLE_SIDED":"",cQ.flipSided?"#define FLIP_SIDED":"",cQ.vertexColors?"#define USE_COLOR":"",(cQ.vertexColors===3)?"#define USE_COLOR_RGB":"",(cQ.vertexColors===4)?"#define USE_COLOR_A":"",cQ.PDSFX?"#define PDSFX":"",cQ.pdsfxUseMap?"#define PDSFX_USE_MAP":"","","#ifdef PICKING_INSTANCING","varying vec3 vInstancePickingColor;","#endif","","uniform mat4 modelViewMatrix;","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform mat4 modelMatrix;","uniform mat4 projectionMatrix;",""].join("\n");if(cQ.PDSFX){var cF=["#ifdef PDSFX",cQ.pdsfxVaryingsCode,cQ.pdsfxUniformsCode.common,cQ.pdsfxUniformsCode.fragment,s.ShaderChunk.PDSFX_common_pars,s.ShaderChunk.PDSFX_varyings_pars,s.ShaderChunk.PDSFX_varying_getters_fragment,cQ.pdsfxGlobalVariablesCode_FS,cQ.PDSFX_OverridableFunctions_FS,"#endif",""].join("\n");cN+=cF}for(c1=0,c6=cj.length;c1<c6;c1++){var cM=cj[c1];if(cM.code===cD&&cM.prefix_vertex===cH&&cM.prefix_fragment===cN){cM.usedTimes++;return cM.program}}var da=new s.ProgramObject();cR=w.createProgram();da.program=cR;da._lightsKey=ao;var cU="";cU=cJ;var c5="";c5=cC;var c3=x("fragment",cN+c5);var cL=x("vertex",cH+cU);w.attachShader(cR,cL);w.attachShader(cR,c3);w.linkProgram(cR);if(!w.getProgramParameter(cR,w.LINK_STATUS)){console.error("Could not initialise shader\nVALIDATE_STATUS: "+w.getProgramParameter(cR,w.VALIDATE_STATUS)+", gl error ["+w.getProgramInfoLog(cR)+"]");console.log(cN+c5)}w.deleteShader(c3);w.deleteShader(cL);var cV,c9;da.objectUniformLocations=new s.ObjectUniformLocations();var cO=da.objectUniformLocations;cO.modelMatrix=w.getUniformLocation(cR,"modelMatrix");cO.modelInvTranspMatrix=w.getUniformLocation(cR,"modelInvTranspMatrix");cO.modelViewMatrix=w.getUniformLocation(cR,"modelViewMatrix");cO.modelViewInvTranspMatrix=w.getUniformLocation(cR,"modelViewInvTranspMatrix");cO.use_normal_matrix=w.getUniformLocation(cR,"use_normal_matrix");cO.normalMatrix=w.getUniformLocation(cR,"normalMatrix");cO.shadowMatrix=w.getUniformLocation(cR,"shadowMatrix");cO.quantizedVector=w.getUniformLocation(cR,"quantizedVector");cO.offsetVector=w.getUniformLocation(cR,"offsetVector");cO.fixedSizeRatio=w.getUniformLocation(cR,"fixedSizeRatio");cO.fixedSizeCenterRatio=w.getUniformLocation(cR,"fixedSizeCenterRatio");da.uniformLocations={};var cY=da.uniformLocations;cY.viewMatrix=w.getUniformLocation(cR,"viewMatrix");cY.projectionMatrix=w.getUniformLocation(cR,"projectionMatrix");cY.cameraPosition=w.getUniformLocation(cR,"cameraPosition");cY.cameraConstant=w.getUniformLocation(cR,"cameraConstant");for(cV in c8){if(c8[cV]._array){c8[cV]._array=undefined}cY[cV]=w.getUniformLocation(cR,cV)}if(cQ.PDSFX){cY.viewInvMatrix=w.getUniformLocation(cR,"viewInvMatrix");cY.projectionInvMatrix=w.getUniformLocation(cR,"projectionInvMatrix");cY.viewInvTranspMatrix=w.getUniformLocation(cR,"viewInvTranspMatrix");cY.nearFarLogFactor=w.getUniformLocation(cR,"nearFarLogFactor");cY.viewportSize=w.getUniformLocation(cR,"viewportSize");if(cQ.PDSFX_hasAlbedo){cY.diffuse=w.getUniformLocation(cR,"_DSalbedo")}if(cQ.PDSFX_hasEmissive){cY.emissive=w.getUniformLocation(cR,"_DSemissive")}if(cQ.PDSFX_hasSpecular){cY.specular=w.getUniformLocation(cR,"_DSspecular")}if(cQ.PDSFX_hasPsColor){cY.psColor=w.getUniformLocation(cR,"_DSalbedo")}if(cQ.PDSFX_hasTransparency){cY.transparency=w.getUniformLocation(cR,"_DStransparency")}cY.opacity=w.getUniformLocation(cR,"_DSopacity");if(cQ.pdsfxUniforms){for(var cZ in cQ.pdsfxUniforms){cY[cZ]=w.getUniformLocation(cR,cZ)}}}var cT=da.attributes;if(cQ.PDSFX){cT.position=w.getAttribLocation(cR,"_DSposition");cT.normal=w.getAttribLocation(cR,"_DSnormal");cT.uv=w.getAttribLocation(cR,"_DSuv");cT.uv2=w.getAttribLocation(cR,"_DSuv2");cT.tangent=w.getAttribLocation(cR,"_DStangent");cT.binormal=w.getAttribLocation(cR,"_DSbinormal")}else{if(cQ.compressedVertices){cT.position=w.getAttribLocation(cR,"_DSposition")}else{cT.position=w.getAttribLocation(cR,"position")}if(cQ.compressedNormals){cT.normal=w.getAttribLocation(cR,"_DSnormal")}else{cT.normal=w.getAttribLocation(cR,"normal")}cT.uv=w.getAttribLocation(cR,"uv");cT.uv2=w.getAttribLocation(cR,"uv2");cT.tangent=w.getAttribLocation(cR,"tangent");cT.binormal=w.getAttribLocation(cR,"binormal")}cT.color=w.getAttribLocation(cR,"color");cT.skinIndex=w.getAttribLocation(cR,"skinIndex");cT.skinWeight=w.getAttribLocation(cR,"skinWeight");cT.lineDistance=w.getAttribLocation(cR,"lineDistance");cT.previousPos=w.getAttribLocation(cR,"previousPos");cT.followingPos=w.getAttribLocation(cR,"followingPos");cT.sideExtrusion=w.getAttribLocation(cR,"sideExtrusion");da.uvOrBinOrTan=cT.uv>=0||cT.binormal>=0||cT.tangent>=0;var cK=da.instanceAttributes;for(c9 in cS){cK[c9]=w.getAttribLocation(cR,c9)}da.id=a7++;cj.push({program:da,code:cD,usedTimes:1,prefix_vertex:cH,prefix_fragment:cN});bk.info.memory.programs=cj.length;return da}function aI(cD){var cF=cD.split("\n");for(var cE=0,cC=cF.length;cE<cC;cE++){cF[cE]=(cE+1)+": "+cF[cE]}return cF.join("\n")}function x(cD,cC){var cE;if(cD==="fragment"){cE=w.createShader(w.FRAGMENT_SHADER)}else{if(cD==="vertex"){cE=w.createShader(w.VERTEX_SHADER)}}w.shaderSource(cE,cC);w.compileShader(cE);if(!w.getShaderParameter(cE,w.COMPILE_STATUS)){console.error(w.getShaderInfoLog(cE));console.error(aI(cC));return null}return cE}function bH(cC){return(cC&(cC-1))===0}function aS(cC,cD,cE){if(cE){w.texParameteri(cC,w.TEXTURE_WRAP_S,bp(cD.wrapS));w.texParameteri(cC,w.TEXTURE_WRAP_T,bp(cD.wrapT));w.texParameteri(cC,w.TEXTURE_MAG_FILTER,bp(cD.magFilter));w.texParameteri(cC,w.TEXTURE_MIN_FILTER,bp(cD.minFilter))}else{w.texParameteri(cC,w.TEXTURE_WRAP_S,w.CLAMP_TO_EDGE);w.texParameteri(cC,w.TEXTURE_WRAP_T,w.CLAMP_TO_EDGE);w.texParameteri(cC,w.TEXTURE_MAG_FILTER,bl(cD.magFilter));w.texParameteri(cC,w.TEXTURE_MIN_FILTER,bl(cD.minFilter))}if(L&&cD.type!==s.FloatType){if(cD.anisotropy>1||cD.__oldAnisotropy){w.texParameterf(cC,L.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(cD.anisotropy,ch));cD.__oldAnisotropy=cD.anisotropy}}}this.setTexture=function(cL,cN){if(cL.lods&&cL.lods.length){var cI=cL.usedTexture;if(cI===-1){cL.lastUsedTexture=-1}else{var cJ=cL.textures[cI];if(cJ&&(cJ.loadEndStatus==="complete")){if(!cJ.__webglInit){this.__glResources__.textureLODPool.add({textureLOD:cL,lod:cI,size:cJ.image?4*cJ.image.width*cJ.image.height:0})}cL.lastUsedTexture=cI;cL=cJ}else{if(cL.lastUsedTexture!==-1){cL=cL.textures[cL.lastUsedTexture]}}}this.__glResources__.textureLODPool.removeUnusedTextures()}if(cL.needsUpdate){if(!cL.__webglInit){cL.__webglInit=true;cL.addEventListener("dispose",aP);cL.__webglTexture=w.createTexture();bk.info.memory.textures++;this.__glResources__.texture.push(cL)}w.activeTexture(w.TEXTURE0+cN);w.bindTexture(w.TEXTURE_2D,cL.__webglTexture);w.pixelStorei(w.UNPACK_FLIP_Y_WEBGL,cL.flipY);w.pixelStorei(w.UNPACK_PREMULTIPLY_ALPHA_WEBGL,cL.premultiplyAlpha);w.pixelStorei(w.UNPACK_ALIGNMENT,cL.unpackAlignment);var cG=cL.image,cK=bH(cG.width)&&bH(cG.height),cC=bp(cL.format),cE=bp(cL.type);aS(w.TEXTURE_2D,cL,cK);var cD,cF=cL.mipmaps;if(cL instanceof s.DataTexture){if(cF.length>0&&cK){for(var cH=0,cM=cF.length;cH<cM;cH++){cD=cF[cH];w.texImage2D(w.TEXTURE_2D,cH,cC,cD.width,cD.height,0,cC,cE,cD.data)}cL.generateMipmaps=false}else{if(cG.data){w.texImage2D(w.TEXTURE_2D,0,cC,cG.width,cG.height,0,cC,cE,cG.data)}}}else{if(cL instanceof s.CompressedTexture){for(var cH=0,cM=cF.length;cH<cM;cH++){cD=cF[cH];if(cL.format==s.RGB_S3TC_DXT1_Format||cL.format==s.RGBA_S3TC_DXT1_Format||cL.format==s.RGBA_S3TC_DXT3_Format||cL.format==s.RGBA_S3TC_DXT5_Format){w.compressedTexImage2D(w.TEXTURE_2D,cH,cC,cD.width,cD.height,0,cD.data)}else{w.texImage2D(w.TEXTURE_2D,cH,cC,cD.width,cD.height,0,cC,cE,cD.data)}}}else{if(cF.length>0&&cK){for(var cH=0,cM=cF.length;cH<cM;cH++){cD=cF[cH];w.texImage2D(w.TEXTURE_2D,cH,cC,cC,cE,cD)}cL.generateMipmaps=false}else{w.texImage2D(w.TEXTURE_2D,0,cC,cC,cE,cL.image)}}}if(cL.generateMipmaps&&cK){w.generateMipmap(w.TEXTURE_2D)}cL.needsUpdate=false;if(cL.onUpdate){cL.onUpdate()}}else{if(!cL.__webglTexture){this.setTexture(this._dummyTexture,cN);return}w.activeTexture(w.TEXTURE0+cN);w.bindTexture(w.TEXTURE_2D,cL.__webglTexture)}};function P(cH,cI){if(cH.width<=cI&&cH.height<=cI){return cH}var cG=Math.max(cH.width,cH.height);var cF=Math.floor(cH.width*cI/cG);var cD=Math.floor(cH.height*cI/cG);var cE=document.createElement("canvas");cE.width=cF;cE.height=cD;var cC=cE.getContext("2d");cC.drawImage(cH,0,0,cH.width,cH.height,0,0,cF,cD);return cE}function bY(cN,cO){if(cN.image.length===6){if(cN.needsUpdate){if(!cN.image.__webglTextureCube){cN.image.__webglTextureCube=w.createTexture();bk.info.memory.textures++;bk.__glResources__.texture.push(cN)}w.activeTexture(w.TEXTURE0+cO);w.bindTexture(w.TEXTURE_CUBE_MAP,cN.image.__webglTextureCube);w.pixelStorei(w.UNPACK_FLIP_Y_WEBGL,cN.flipY);var cF=cN instanceof s.CompressedTexture;var cC=[];for(var cL=0;cL<6;cL++){if(bk.autoScaleCubemaps&&!cF){cC[cL]=P(cN.image[cL],aV)}else{cC[cL]=cN.image[cL]}}var cI=cC[0],cM=bH(cI.width)&&bH(cI.height),cD=bp(cN.format),cG=bp(cN.type);aS(w.TEXTURE_CUBE_MAP,cN,cM);for(var cL=0;cL<6;cL++){if(cF){var cE,cH=cC[cL].mipmaps;for(var cJ=0,cK=cH.length;cJ<cK;cJ++){cE=cH[cJ];if((cN.format===s.AlphaFormat)||(cN.format===s.RGBFormat)||(cN.format===s.RGBAFormat)||(cN.format===s.LuminanceFormat)||(cN.format===s.LuminanceAlphaFormat)){w.texImage2D(w.TEXTURE_CUBE_MAP_POSITIVE_X+cL,cJ,cD,cE.width,cE.height,0,cD,cG,cE.data)}else{w.compressedTexImage2D(w.TEXTURE_CUBE_MAP_POSITIVE_X+cL,cJ,cD,cE.width,cE.height,0,cE.data)}}}else{w.texImage2D(w.TEXTURE_CUBE_MAP_POSITIVE_X+cL,0,cD,cD,cG,cC[cL])}}if(cN.generateMipmaps&&cM){w.generateMipmap(w.TEXTURE_CUBE_MAP)}cN.needsUpdate=false;if(cN.onUpdate){cN.onUpdate()}}else{w.activeTexture(w.TEXTURE0+cO);w.bindTexture(w.TEXTURE_CUBE_MAP,cN.image.__webglTextureCube)}}}function bK(cC,cD){w.activeTexture(w.TEXTURE0+cD);w.bindTexture(w.TEXTURE_CUBE_MAP,cC.__webglTexture)}function bJ(cE,cD,cC){w.bindFramebuffer(w.FRAMEBUFFER,cE);if(cD){w.framebufferTexture2D(w.FRAMEBUFFER,w.COLOR_ATTACHMENT0,cC,cD.__webglTexture,0)}}function O(cC,cD){w.bindRenderbuffer(w.RENDERBUFFER,cC);if(cD.depthBuffer&&!cD.stencilBuffer){w.renderbufferStorage(w.RENDERBUFFER,w.DEPTH_COMPONENT16,cD.width,cD.height);w.framebufferRenderbuffer(w.FRAMEBUFFER,w.DEPTH_ATTACHMENT,w.RENDERBUFFER,cC)}else{if(cD.depthBuffer&&cD.stencilBuffer){w.renderbufferStorage(w.RENDERBUFFER,w.DEPTH_STENCIL,cD.width,cD.height);w.framebufferRenderbuffer(w.FRAMEBUFFER,w.DEPTH_STENCIL_ATTACHMENT,w.RENDERBUFFER,cC)}else{w.renderbufferStorage(w.RENDERBUFFER,w.RGBA4,cD.width,cD.height)}}}this.setRenderTarget=function(cG){var cI=(cG instanceof s.WebGLRenderTargetCube);if(cG&&!cG.__webglFramebuffer){if(cG.depthBuffer===undefined){cG.depthBuffer=true}if(cG.stencilBuffer===undefined){cG.stencilBuffer=true}cG.addEventListener("dispose",ax);cG.__webglTexture=w.createTexture();bk.info.memory.textures++;this.__glResources__.renderTarget[cG.uniqueID]=cG;var cJ=bH(cG.width)&&bH(cG.height),cC=bp(cG.format),cE=bp(cG.type);if(cI){cG.__webglFramebuffer=[];cG.__webglRenderbuffer=[];w.bindTexture(w.TEXTURE_CUBE_MAP,cG.__webglTexture);aS(w.TEXTURE_CUBE_MAP,cG,cJ);for(var cF=0;cF<6;cF++){cG.__webglFramebuffer[cF]=w.createFramebuffer();cG.__webglRenderbuffer[cF]=w.createRenderbuffer();w.texImage2D(w.TEXTURE_CUBE_MAP_POSITIVE_X+cF,0,cC,cG.width,cG.height,0,cC,cE,null);bJ(cG.__webglFramebuffer[cF],cG,w.TEXTURE_CUBE_MAP_POSITIVE_X+cF);O(cG.__webglRenderbuffer[cF],cG)}if(cJ){w.generateMipmap(w.TEXTURE_CUBE_MAP)}}else{cG.__webglFramebuffer=w.createFramebuffer();if(cG.shareDepthFrom){cG.__webglRenderbuffer=cG.shareDepthFrom.__webglRenderbuffer}else{cG.__webglRenderbuffer=w.createRenderbuffer()}w.bindTexture(w.TEXTURE_2D,cG.__webglTexture);aS(w.TEXTURE_2D,cG,cJ);w.texImage2D(w.TEXTURE_2D,0,cC,cG.width,cG.height,0,cC,cE,null);bJ(cG.__webglFramebuffer,cG,w.TEXTURE_2D);if(cG.shareDepthFrom){if(cG.depthBuffer&&!cG.stencilBuffer){w.framebufferRenderbuffer(w.FRAMEBUFFER,w.DEPTH_ATTACHMENT,w.RENDERBUFFER,cG.__webglRenderbuffer)}else{if(cG.depthBuffer&&cG.stencilBuffer){w.framebufferRenderbuffer(w.FRAMEBUFFER,w.DEPTH_STENCIL_ATTACHMENT,w.RENDERBUFFER,cG.__webglRenderbuffer)}}}else{O(cG.__webglRenderbuffer,cG)}if(cJ){w.generateMipmap(w.TEXTURE_2D)}}if(cI){w.bindTexture(w.TEXTURE_CUBE_MAP,null)}else{w.bindTexture(w.TEXTURE_2D,null)}w.bindRenderbuffer(w.RENDERBUFFER,null);w.bindFramebuffer(w.FRAMEBUFFER,null)}else{if(cG&&(cG.minFilter!==cG.originalMinFilter||cG.magFilter!==cG.originalMagFilter)){var cJ=bH(cG.width)&&bH(cG.height);if(cI){w.bindTexture(w.TEXTURE_CUBE_MAP,cG.__webglTexture);aS(w.TEXTURE_CUBE_MAP,cG,cJ);w.bindTexture(w.TEXTURE_CUBE_MAP,null)}else{w.bindTexture(w.TEXTURE_2D,cG.__webglTexture);aS(w.TEXTURE_2D,cG,cJ);w.bindTexture(w.TEXTURE_2D,null)}cG.originalMinFilter=cG.minFilter;cG.originalMagFilter=cG.magFilter}}var cL,cD,cM,cK,cH;if(cG){if(cI){cL=cG.__webglFramebuffer[cG.activeCubeFace]}else{cL=cG.__webglFramebuffer}if(bk.RTTmatchViewport){cD=cs;cM=bq;cK=bD;cH=bC}else{cD=cG.width;cM=cG.height;cK=0;cH=0}}else{cL=null;cD=cs;cM=bq;cK=bD;cH=bC}if(cL!==s.glStates.currentFramebuffer){w.bindFramebuffer(w.FRAMEBUFFER,cL);s.glStates.currentFramebuffer=cL}if(s.glStates.currentWidth!==cD||s.glStates.currentHeight!==cM){w.viewport(cK,cH,cD,cM);s.glStates.currentWidth=cD;s.glStates.currentHeight=cM}};function bs(cC){if(cC instanceof s.WebGLRenderTargetCube){w.bindTexture(w.TEXTURE_CUBE_MAP,cC.__webglTexture);w.generateMipmap(w.TEXTURE_CUBE_MAP);w.bindTexture(w.TEXTURE_CUBE_MAP,null)}else{w.bindTexture(w.TEXTURE_2D,cC.__webglTexture);w.generateMipmap(w.TEXTURE_2D);w.bindTexture(w.TEXTURE_2D,null)}}function bl(cC){if(cC===s.NearestFilter||cC===s.NearestMipMapNearestFilter||cC===s.NearestMipMapLinearFilter){return w.NEAREST}return w.LINEAR}function bp(cC){if(cC===s.RepeatWrapping){return w.REPEAT}if(cC===s.ClampToEdgeWrapping){return w.CLAMP_TO_EDGE}if(cC===s.MirroredRepeatWrapping){return w.MIRRORED_REPEAT}if(cC===s.NearestFilter){return w.NEAREST}if(cC===s.NearestMipMapNearestFilter){return w.NEAREST_MIPMAP_NEAREST}if(cC===s.NearestMipMapLinearFilter){return w.NEAREST_MIPMAP_LINEAR}if(cC===s.LinearFilter){return w.LINEAR}if(cC===s.LinearMipMapNearestFilter){return w.LINEAR_MIPMAP_NEAREST}if(cC===s.LinearMipMapLinearFilter){return w.LINEAR_MIPMAP_LINEAR}if(cC===s.UnsignedByteType){return w.UNSIGNED_BYTE}if(cC===s.UnsignedShort4444Type){return w.UNSIGNED_SHORT_4_4_4_4}if(cC===s.UnsignedShort5551Type){return w.UNSIGNED_SHORT_5_5_5_1}if(cC===s.UnsignedShort565Type){return w.UNSIGNED_SHORT_5_6_5}if(cC===s.ByteType){return w.BYTE}if(cC===s.ShortType){return w.SHORT}if(cC===s.UnsignedShortType){return w.UNSIGNED_SHORT}if(cC===s.IntType){return w.INT}if(cC===s.UnsignedIntType){return w.UNSIGNED_INT}if(cC===s.FloatType){return w.FLOAT}if(cC===s.AlphaFormat){return w.ALPHA}if(cC===s.RGBFormat){return w.RGB}if(cC===s.RGBAFormat){return w.RGBA}if(cC===s.LuminanceFormat){return w.LUMINANCE}if(cC===s.LuminanceAlphaFormat){return w.LUMINANCE_ALPHA}if(cC===s.AddEquation){return w.FUNC_ADD}if(cC===s.SubtractEquation){return w.FUNC_SUBTRACT}if(cC===s.ReverseSubtractEquation){return w.FUNC_REVERSE_SUBTRACT}if(cC===s.ZeroFactor){return w.ZERO}if(cC===s.OneFactor){return w.ONE}if(cC===s.SrcColorFactor){return w.SRC_COLOR}if(cC===s.OneMinusSrcColorFactor){return w.ONE_MINUS_SRC_COLOR}if(cC===s.SrcAlphaFactor){return w.SRC_ALPHA}if(cC===s.OneMinusSrcAlphaFactor){return w.ONE_MINUS_SRC_ALPHA}if(cC===s.DstAlphaFactor){return w.DST_ALPHA}if(cC===s.OneMinusDstAlphaFactor){return w.ONE_MINUS_DST_ALPHA}if(cC===s.DstColorFactor){return w.DST_COLOR}if(cC===s.OneMinusDstColorFactor){return w.ONE_MINUS_DST_COLOR}if(cC===s.SrcAlphaSaturateFactor){return w.SRC_ALPHA_SATURATE}if(bb!==undefined){if(cC===s.RGB_S3TC_DXT1_Format){return bb.COMPRESSED_RGB_S3TC_DXT1_EXT}if(cC===s.RGBA_S3TC_DXT1_Format){return bb.COMPRESSED_RGBA_S3TC_DXT1_EXT}if(cC===s.RGBA_S3TC_DXT3_Format){return bb.COMPRESSED_RGBA_S3TC_DXT3_EXT}if(cC===s.RGBA_S3TC_DXT5_Format){return bb.COMPRESSED_RGBA_S3TC_DXT5_EXT}}if(at!==undefined){if(cC===s.MinEquation){return at.MIN_EXT}if(cC===s.MaxEquation){return at.MAX_EXT}}return 0}function bR(cF){var cE,cG,cD;var cC={dirLights:0,pointLights:0,spotLights:0,hemiLights:0,sphereLights:0,areaLights:0,iesLights:0,tubeLights:0,diskLights:0,probeLight:false};for(cE=0,cG=cF.length;cE<cG;cE++){cD=cF[cE];if(cD.onlyShadow){continue}cD.allocate(cC)}return{probe:cC.probeLight,directional:cC.dirLights,point:cC.pointLights,spot:cC.spotLights,hemi:cC.hemiLights,sphere:cC.sphereLights,area:cC.areaLights,ies:cC.iesLights,tube:cC.tubeLights,disk:cC.diskLights}}function aH(cE){var cD,cG,cC,cF={dirLight:0,spotLight:0,tex2d:0,texCube:0};for(cD=0,cG=cE.length;cD<cG;cD++){cC=cE[cD];if(!cC.castShadow){continue}cC.allocateShadows(bk,cF)}return cF}function N(cD){var cF,cG,cC,cE=0;for(cF=0,cG=cD.length;cF<cG;cF++){cC=cD[cF];cE++}return cE}function b4(cE,cD){function cC(cN,cO,cM){window.WebVisuTestsWebGLError=true;throw"##WEBGLERROR## "+WebGLDebugUtils.glEnumToString(cN)+" was caused by call to: "+cO}try{if(cE){w=cE}else{if(!(w=bu.getContext("experimental-webgl",{alpha:ci,premultipliedAlpha:by,antialias:cA,stencil:z,preserveDrawingBuffer:aE}))){throw"Error creating WebGL context."}}}catch(cJ){console.error(cJ)}if(!cE&&cD){w=WebGLDebugUtils.makeDebugContext(w,cC)}if(!w._enabledAttributes){w._enabledAttributes={}}if(!w.hasOwnProperty("contextId")){n++;w.contextId=n}if(!w.hasOwnProperty("WebVisuShaderVersion")){w.WebVisuShaderVersion=0}if(!w._currentProgram){w._currentProgram=null}if(!w._oldBlending){w.oldBlending=-1}if(s.enableWebGLStats){s.webGLStats={reset:function(){this.useProgram_nb=0;this.bindBuffer_nb=0;this.drawElements_nb=0},dump:function(){console.log({useProgram_nb:this.useProgram_nb,bindBuffer_nb:this.bindBuffer_nb,drawElements_nb:this.drawElements_nb})},useProgram_nb:0,bindBuffer_nb:0,drawElements_nb:0};w.useProgram_save=w.useProgram;w.useProgram=function(){s.webGLStats.useProgram_nb++;w.useProgram_save.apply(w,arguments)};w.bindBuffer_save=w.bindBuffer;w.bindBuffer=function(){s.webGLStats.bindBuffer_nb++;w.bindBuffer_save.apply(w,arguments)};w.drawElements_save=w.drawElements;w.drawElements=function(){s.webGLStats.drawElements_nb++;w.drawElements_save.apply(w,arguments)}}var cH=w.getSupportedExtensions();function cG(cM){if(cH.indexOf(cM)>=0){return w.getExtension(cM)}return null}cg=cG("WEBGL_color_buffer_float");ai=cG("OES_texture_half_float");G=cG("OES_texture_float");Z=cG("OES_texture_float_linear");bO=cG("OES_standard_derivatives");L=cG("EXT_texture_filter_anisotropic")||cG("MOZ_EXT_texture_filter_anisotropic")||cG("WEBKIT_EXT_texture_filter_anisotropic");bb=cG("WEBGL_compressed_texture_s3tc")||cG("MOZ_WEBGL_compressed_texture_s3tc")||cG("WEBKIT_WEBGL_compressed_texture_s3tc");I=cG("ANGLE_instanced_arrays");b0=cG("OES_element_index_uint");bM=cG("EXT_frag_depth");at=cG("EXT_blend_minmax");if(G){var cI=w.createTexture();var cK=w.createFramebuffer();var cL=w.createRenderbuffer();w.bindTexture(w.TEXTURE_2D,cI);w.texParameteri(w.TEXTURE_2D,w.TEXTURE_WRAP_S,w.CLAMP_TO_EDGE);w.texParameteri(w.TEXTURE_2D,w.TEXTURE_WRAP_T,w.CLAMP_TO_EDGE);w.texParameteri(w.TEXTURE_2D,w.TEXTURE_MAG_FILTER,w.LINEAR);w.texParameteri(w.TEXTURE_2D,w.TEXTURE_MIN_FILTER,w.LINEAR);w.texImage2D(w.TEXTURE_2D,0,w.RGBA,100,100,0,w.RGBA,w.FLOAT,null);w.bindFramebuffer(w.FRAMEBUFFER,cK);w.framebufferTexture2D(w.FRAMEBUFFER,w.COLOR_ATTACHMENT0,w.TEXTURE_2D,cI,0);w.bindRenderbuffer(w.RENDERBUFFER,cL);w.renderbufferStorage(w.RENDERBUFFER,w.DEPTH_COMPONENT16,100,100);w.framebufferRenderbuffer(w.FRAMEBUFFER,w.DEPTH_ATTACHMENT,w.RENDERBUFFER,cL);var cF=w.checkFramebufferStatus(w.FRAMEBUFFER);J=true;if(cF!=w.FRAMEBUFFER_COMPLETE){J=false}w.bindFramebuffer(w.FRAMEBUFFER,null);w.bindTexture(w.TEXTURE_2D,null);w.bindRenderbuffer(w.RENDERBUFFER,null);w.deleteTexture(cI);w.deleteFramebuffer(cK);w.deleteRenderbuffer(cL)}s.supportedExtensions={colorBufferFloat:cg,textureHalfFloat:ai,textureFloat:G,textureFloatLinear:Z,standardDerivatives:bO,textureFilterAnisotropic:L,compressedTexturesS3TC:bb,instancedArrays:I,elementIndexUint:b0,renderToFloatTexture:J,fragDepth:bM,minMaxBlending:at,fragmentTextureUnits:w.getParameter(w.MAX_TEXTURE_IMAGE_UNITS),vertexTextureUnits:w.getParameter(w.MAX_VERTEX_TEXTURE_IMAGE_UNITS),depthBits:Math.pow(2,-w.getParameter(w.DEPTH_BITS))};if(!G){console.log("THREE.WebGLRenderer: Float textures not supported.")}if(!bO){console.log("THREE.WebGLRenderer: Standard derivatives not supported.")}if(!L){console.log("THREE.WebGLRenderer: Anisotropic texture filtering not supported.")}if(!bb){console.log("THREE.WebGLRenderer: S3TC compressed textures not supported.")}if(!I){console.log("THREE.WebGLRenderer: angle instanced arrays not supported.")}if(!b0){console.log("THREE.WebGLRenderer: UInt Element Index not supported.")}if(!bM){console.log("THREE.WebGLRenderer: Fragment Depth Writing not supported.")}if(!at){console.log("THREE.WebGLRenderer: min/max blending not supported.")}if(w.getShaderPrecisionFormat===undefined){w.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}}}function bN(){w.lineWidth(1);w.clearColor(0,0,0,1);w.clearDepth(1);w.clearStencil(0);w.enable(w.DEPTH_TEST);w.depthFunc(w.LEQUAL);w.frontFace(w.CCW);w.cullFace(w.BACK);w.enable(w.CULL_FACE);w.enable(w.BLEND);w.blendEquation(w.FUNC_ADD);w.blendFunc(w.SRC_ALPHA,w.ONE_MINUS_SRC_ALPHA);w._oldBlending=s.AlphaBlending;w.clearColor(b7.r,b7.g,b7.b,aC)}this._gpuPickingTolerance=0;this._smallTargetPicking=0;this.useOIT=false;this._oitMaterial=false;this.precomputedTexture1=null;this.precomputedTexture2=null;this.precomputedTexture3=null;this.precomputedAreaGGX1texture=null;this.precomputedAreaGGX2texture=null;this.precomputedAreaSheentexture=null;this.materialToUse=-1;this.shadowMapSoft=false;this.gpuAntiAliasing=false;this.forceMaterialDoubleSide=true;this.cuttingScene=null;this.backupCuttingMaterial=null;this.cameraSystem_cameraIndex=-1};s.WebGLRenderTargetProperties=function(w,u,v){this.width=w;this.height=u;this.options=v};s.WebGLRenderTarget=function(w,u,v){s.EventDispatcher.call(this);this.uniqueID=s.__renderTargetID++;this.width=w;this.height=u;if(v){this.originalMagFilter=v.magFilter;this.originalMinFilter=v.minFilter}this.reset(v)};s.WebGLRenderTarget.prototype.clone=function(){var u=new s.WebGLRenderTarget(this.width,this.height);u.wrapS=this.wrapS;u.wrapT=this.wrapT;u.magFilter=this.magFilter;u.minFilter=this.minFilter;u.anisotropy=this.anisotropy;u.offset.copy(this.offset);u.repeat.copy(this.repeat);u.format=this.format;u.type=this.type;u.depthBuffer=this.depthBuffer;u.stencilBuffer=this.stencilBuffer;u.generateMipmaps=this.generateMipmaps;u.mapping=this.mapping;u.shareDepthFrom=this.shareDepthFrom;if(this.originalMagFilter){u.originalMagFilter=this.originalMagFilter}if(this.originalMinFilter){u.originalMinFilter=this.originalMinFilter}return u};s.WebGLRenderTarget.prototype.reset=function(u){u=u||{};this.wrapS=u.wrapS!==undefined?u.wrapS:s.ClampToEdgeWrapping;this.wrapT=u.wrapT!==undefined?u.wrapT:s.ClampToEdgeWrapping;this.magFilter=u.magFilter!==undefined?u.magFilter:s.LinearFilter;this.minFilter=u.minFilter!==undefined?u.minFilter:s.LinearMipMapLinearFilter;this.anisotropy=u.anisotropy!==undefined?u.anisotropy:1;this.offset=new s.Vector2(0,0);this.repeat=new s.Vector2(1,1);this.format=u.format!==undefined?u.format:s.RGBAFormat;this.type=u.type!==undefined?u.type:s.UnsignedByteType;this.depthBuffer=u.depthBuffer!==undefined?u.depthBuffer:true;this.stencilBuffer=u.stencilBuffer!==undefined?u.stencilBuffer:true;this.generateMipmaps=true;this.mapping=new s.UVMapping();this.shareDepthFrom=null;this.useCount=0};s.WebGLRenderTarget.prototype.dispose=function(){this.dispatchEvent({type:"dispose"})};s.WebGLRenderTargetCube=function(w,u,v){s.WebGLRenderTarget.call(this,w,u,v);this.activeCubeFace=0};s.WebGLRenderTargetCube.prototype=Object.create(s.WebGLRenderTarget.prototype);s.GeometryUtils={center:function(w){w.computeBoundingBox();var v=w.boundingBox;var u=new s.Vector3();u.addVectors(v.min,v.max);u.multiplyScalar(-0.5);w.applyMatrix(new s.Matrix4().makeTranslation(u.x,u.y,u.z));w.computeBoundingBox();return u}};s.ImageUtils={nbTexturesBeingLoaded:0,crossOrigin:"anonymous",loadTexture:function(w,u,E,C,B,I){function y(K){var J=Math.log(K)/Math.LN2;return Math.floor(J)===J}function v(K){var J=Math.log(K)/Math.LN2;return Math.pow(2,Math.round(J))}var x=document.createElement("canvas");var D=new s.Texture(x,u);D.loadEndStatus="loading";var H=((new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent)!=null));var A=!w.startsWith("data:");if(H&&A&&((B===undefined)||(B===false))){var G={headers:new Object(),method:"GET",authentication:"ajax",timeout:3600000,async:true,type:"blob",onComplete:function(K){var L=URL.createObjectURL(K);var M=new Image();var J=new s.ImageLoader();J.addEventListener("load",function(Q){s.ImageUtils.nbTexturesBeingLoaded--;D.needsUpdate=true;D.loadEndStatus="complete";var P,N;if(I&&(!y(M.width)||!y(M.height))){P=v(M.width);N=v(M.height);D.image.width=P;D.image.height=N;D.image.getContext("2d").drawImage(M,0,0,P,N)}else{D.image=M}if(E){E(D)}var O;for(O=0;O<D.onLoadCallbacks.length;O++){D.onLoadCallbacks[O](D)}});J.addEventListener("error",function(N){s.ImageUtils.nbTexturesBeingLoaded--;if(C){C(N.message)}D.loadEndStatus="error"});J.load(L,M)},onFailure:function(J){s.ImageUtils.nbTexturesBeingLoaded--;if(C){C(event.message)}D.loadEndStatus="error"},onTimeout:function(){s.ImageUtils.nbTexturesBeingLoaded--;if(C){C(event.message)}D.loadEndStatus="error"}};UWA.Data.request(w,G)}else{var z=new Image();if(B!==null){z.crossOrigin=B?"use-credentials":"anonymous"}var F=new s.ImageLoader();F.addEventListener("load",function(M){s.ImageUtils.nbTexturesBeingLoaded--;D.needsUpdate=true;D.loadEndStatus="complete";var L,J;if(I&&(!y(z.width)||!y(z.height))){L=v(z.width);J=v(z.height);D.image.width=L;D.image.height=J;D.image.getContext("2d").drawImage(z,0,0,L,J)}else{D.image=z}if(E){E(D)}var K;for(K=0;K<D.onLoadCallbacks.length;K++){D.onLoadCallbacks[K](D)}});F.addEventListener("error",function(J){s.ImageUtils.nbTexturesBeingLoaded--;if(C){C(J.message)}D.loadEndStatus="error"});if(z.crossOrigin){F.crossOrigin=z.crossOrigin}F.load(w,z)}s.ImageUtils.nbTexturesBeingLoaded++;D.sourceFile=w;return D},loadTexture2:function(w,v,x,y,u){console.warn("loadTexture2 is deprecated, use loadTexture with forcePowerOfTwo parameter activated");return s.ImageUtils.loadTexture(w,v,x,y,u,true)},loadTGATexture:function(w,v,y,B,u,x){var A=new s.DataTexture(new Uint8Array(16),2,2,s.RGBAFormat,s.UnsignedByteType);A.mapping=v;var z=new XMLHttpRequest();z.onload=function(){s.ImageUtils.nbTexturesBeingLoaded--;var F=new Uint8Array(z.response);var I=12;var G=F[I]+256*F[I+1];I+=2;var E=F[I]+256*F[I+1];I+=4;A.image.data=new Uint8Array(4*G*E);var H=A.image.data;A.image.width=G;A.image.height=E;for(var J=0;J<E;J++){for(var D=0;D<G;D++){var C=J*G+D;H[4*C]=F[I+4*C+2];H[4*C+1]=F[I+4*C+1];H[4*C+2]=F[I+4*C];H[4*C+3]=F[I+4*C+3]}}A.loadEndStatus="complete";A.generateMipmaps=false;A.needsUpdate=true;if(y){y(A)}};z.onerror=function(){B();s.ImageUtils.nbTexturesBeingLoaded--;A.loadEndStatus="error"};if(x){A.loadEndStatus="pause";A.onRequest=function(){A.loadEndStatus="loading";s.ImageUtils.nbTexturesBeingLoaded++;z.open("GET",w,true);z.responseType="arraybuffer";z.withCredentials=!!u;z.send(null)}}else{A.loadEndStatus="loading";s.ImageUtils.nbTexturesBeingLoaded++;z.open("GET",w,true);z.responseType="arraybuffer";z.withCredentials=!!u;z.send(null)}return A},loadHDRTexture:function(v,u,A,y,w,B,C){var z=new s.DataTexture();z.loadEndStatus="loading";z.hdr=true;z.sRGB=false;z.mapping=u;z.needsSH=false;z.shFactorsR=null;z.shFactorsG=null;z.shFactorsB=null;var x=new XMLHttpRequest();x.onload=function(){s.ImageUtils.nbTexturesBeingLoaded--;var D=x.response;var F=s.ImageUtils.parseRadianceHDR(D,u,w,B,C);z.format=F.format;z.type=F.type;z.image.data=F.data;z.image.width=F.width;z.image.height=F.height;z.loadEndStatus="complete";if(z.needsSH){s.ImageUtils.computeSphericalHarmonics(z)}z.generateMipmaps=true;z.needsUpdate=true;if(A){A(z)}for(var E=0;E<z.onLoadCallbacks.length;E++){z.onLoadCallbacks[E](z)}};x.onerror=function(){z.loadEndStatus="error";y();s.ImageUtils.nbTexturesBeingLoaded--};x.open("GET",v,true);x.responseType="arraybuffer";x.send(null);s.ImageUtils.nbTexturesBeingLoaded++;return z},_compressHDR:function(F){var G=function(N){var M=new Uint8Array(2*N.length);for(var L=0;L<N.length;L++){M[L]=N[L]}return M};var z=F.offset;var D=z;var J=new Uint8Array(F.buffer.length);for(var B=0;B<z;B++){J[B]=F.buffer[B]}var K=new Uint8Array(4+5*F.width);for(var A=0;A<F.height;A++){var x=0;K[x++]=2;K[x++]=2;K[x++]=F.width>>8;K[x++]=F.width&255;for(var H=0;H<4;H++){var I=[];var B=0;while(B<F.width){var w=0;var E=F.buffer[z+4*(A*F.width+B)+H];var v=E;while(B<F.width&&v===E&&w<127){w++;B++;E=v;v=F.buffer[z+4*(A*F.width+B)+H]}if(w>3){if(I.length){K[x++]=I.length;for(var y=0;y<I.length;y++){K[x++]=I[y]}I=[]}K[x++]=128+w;K[x++]=E}else{if(I.length+w>127){K[x++]=I.length;for(var y=0;y<I.length;y++){K[x++]=I[y]}I=[]}I.push(E);if(w>1){I.push(E)}if(w>2){I.push(E)}}}if(I.length){K[x++]=I.length;for(var y=0;y<I.length;y++){K[x++]=I[y]}}}if(D+x>=J.length){J=G(J)}for(var u=0;u<x;u++){J[D++]=K[u]}}var C=new Uint8Array(D);for(var B=0;B<D;B++){C[B]=J[B]}F.buffer=C},streamHDRFormat:function(G,v,u){var K=function(O,N,M){for(var L=0;L<N.length;L++){O[M++]=N.charCodeAt(L)}return M};var w="#?RADIANCE";var E="# Made with Dassault Systemes HDR map javascript generator";var y="FORMAT=32-bit_rle_rgbe";var x="-Y "+u+" +X "+v;var I=w.length+1+E.length+1+y.length+2+x.length+1;var D=new Uint8Array(I+v*u*4);var B=0;B=K(D,w,B);D[B++]=10;B=K(D,E,B);D[B++]=10;B=K(D,y,B);D[B++]=10;D[B++]=10;B=K(D,x,B);D[B++]=10;var F=u-1;for(var A=0;A<u;A++){var J=v-1;for(var C=0;C<v;C++){for(var z=0;z<4;z++){D[B+4*(v*A+C)+z]=G[4*(v*F+J)+z]}J--}F--}var H={buffer:D,offset:B,width:v,height:u};this._compressHDR(H);return new Blob([H.buffer],{type:"application/octet-binary"})},generateBlankHDRTexture:function(x,y){var w=new s.DataTexture();w.hdr=true;w.sRGB=false;w.mapping=new s.LatLongReflectionMapping();w.needsSH=false;w.shFactorsR=null;w.shFactorsG=null;w.shFactorsB=null;w.format=s.RGBAFormat;w.type=s.UnsignedByteType;w.image.width=x;w.image.height=y;w.loadEndStatus="complete";w.generateMipmaps=true;w.needsUpdate=true;var u=new Uint8Array(4*x*y);for(var v=0;v<x*y;v++){u[4*v]=255;u[4*v+1]=255;u[4*v+2]=255;u[4*v+3]=127}w.image.data=u;return w},computeSphericalHarmonics:function(K){var F=K.mapping;var T=K.image.data;var O=K.image.width;var N=K.image.height;var Q,P;if(T===undefined){K.needsSH=true;return}if(K.shFactorsR!==null){return}var B=[];for(Q=0;Q<3;Q++){B[Q]=[];for(P=0;P<9;P++){B[Q][P]=0}}var L=function(u){if(Math.abs(u)<0.0001){return 1}else{return(Math.sin(u)/u)}};var S=function(V,U,W,ac,aa,Y){var v=4*(O*U+V);var ab=Math.pow(2,T[v+3]-128);var u;for(u=0;u<3;u++){var Z=(1/256)*T[v+u]*ab;var X;X=0.282095;B[u][0]+=Z*X*W;X=0.488603;B[u][1]+=Z*(X*aa)*W;B[u][2]+=Z*(X*Y)*W;B[u][3]+=Z*(X*ac)*W;X=1.092548;B[u][4]+=Z*(X*ac*aa)*W;B[u][5]+=Z*(X*aa*Y)*W;B[u][7]+=Z*(X*ac*Y)*W;X=0.315392;B[u][6]+=Z*(X*(3*Y*Y-1))*W;X=0.546274;B[u][8]+=Z*(X*(ac*ac-aa*aa))*W}return B};var J=function(){var z;var V,U,y,x,u;V=0.429043;U=0.511664;y=0.743125;x=0.886227;u=0.247708;var v=[];v[0]=new s.Matrix4();v[1]=new s.Matrix4();v[2]=new s.Matrix4();for(z=0;z<3;z++){v[z].elements[0]=V*B[z][8];v[z].elements[1]=V*B[z][4];v[z].elements[2]=V*B[z][7];v[z].elements[3]=U*B[z][3];v[z].elements[4]=V*B[z][4];v[z].elements[5]=-V*B[z][8];v[z].elements[6]=V*B[z][5];v[z].elements[7]=U*B[z][1];v[z].elements[8]=V*B[z][7];v[z].elements[9]=V*B[z][5];v[z].elements[10]=y*B[z][6];v[z].elements[11]=U*B[z][2];v[z].elements[12]=U*B[z][3];v[z].elements[13]=U*B[z][1];v[z].elements[14]=U*B[z][2];v[z].elements[15]=x*B[z][0]-u*B[z][6]}return v};if(K.mapping instanceof s.LatLongReflectionMapping){for(P=0;P<N;P++){for(Q=0;Q<O;Q++){var I,H,C,w,G,E,D,R;I=Q/O;H=P/N;w=Math.PI*(2*I-1);C=Math.PI*H;G=Math.sin(C)*Math.cos(w);E=Math.sin(C)*Math.sin(w);D=Math.cos(C);R=2*(Math.PI/O)*(Math.PI/N)*Math.sin(C);S(Q,P,R,G,E,D)}}}else{for(Q=0;Q<O;Q++){for(P=0;P<O;P++){var I,H,M,C,w,G,E,D,R;H=(O/2-Q)/(O/2);I=(P-O/2)/(O/2);M=Math.sqrt(I*I+H*H);if(M>1){continue}C=Math.PI*M;w=Math.atan2(H,I);G=Math.sin(C)*Math.cos(w);E=Math.sin(C)*Math.sin(w);D=Math.cos(C);R=(2*Math.PI/O)*(2*Math.PI/O)*L(C);S(Q,P,R,G,E,D)}}}var A=J();if(A!==null){K.shFactorsR=A[0];K.shFactorsG=A[1];K.shFactorsB=A[2]}},loadTextureCube:function(y,v,A,x){var B=[];B.loadCount=0;var z=new s.Texture();z.loadEndStatus="loading";z.image=B;if(v!==undefined){z.mapping=v}z.flipY=false;for(var w=0,C=y.length;w<C;++w){var u=new Image();B[w]=u;u.onload=function(){B.loadCount+=1;s.ImageUtils.nbTexturesBeingLoaded--;if(B.loadCount===6){if(z.loadEndStatus!=="error"){z.loadEndStatus="complete"}z.needsUpdate=true;if(A){A(z)}}};u.onerror=function(){B.loadCount+=1;s.ImageUtils.nbTexturesBeingLoaded--;z.loadEndStatus="error";if(x){x()}};u.crossOrigin=this.crossOrigin;s.ImageUtils.nbTexturesBeingLoaded++;u.src=y[w]}return z},parseRadianceHDR:function(K,D,v,A,B){var w={data:null,width:0,height:0,format:v?s.RGBFormat:s.RGBAFormat,type:v?s.FloatType:s.UnsignedByteType};var O={offset:0,data:new Uint8Array(K)};var N,M;var Q="";for(N=0;N<10;N++){Q+=String.fromCharCode(O.data[O.offset++])}if(Q!=="#?RADIANCE"){return w}var P=0,x;while(true){x=P;P=O.data[O.offset++];if(P==10&&x==10){break}}var G="";while(true){P=O.data[O.offset++];if(P==10){break}G+=String.fromCharCode(P)}var H=new RegExp(/[-,+][X,Y]\s+([0-9]+)\s+[-,+][X,Y]\s+([0-9]+)/i);var I=H.exec(G);if(I===null){return w}w.height=RegExp.$1;w.width=RegExp.$2;if(v){w.data=new Float32Array(w.width*w.height*3)}else{w.data=new Uint8Array(w.width*w.height*4)}var L=new Uint8Array(4*w.width);var z=A?(w.height-1)*(v?3:4)*w.width:0;var F=function(y,T){var S=T*0.00390625;return S*y};var E=function(T,S,U,V){if(B){V+=3*(S-1)}while(S-->0){var y=Math.pow(2,T[4*S+3]-128);U[V++]=F(y,T[4*S]);U[V++]=F(y,T[4*S+1]);U[V++]=F(y,T[4*S+2]);if(B){V-=6}}};var R=function(S,y,T,U){while(y-->0){T[U++]=S[4*y];T[U++]=S[4*y+1];T[U++]=S[4*y+2];T[U++]=S[4*y+3]}};var u=function(X,y,S){var U,T;if(y<8||y>32767){return J(X,0,y,S)}U=S.data[S.offset];if(U!==2){return J(X,0,y,S)}S.offset++;X[1]=S.data[S.offset++];X[2]=S.data[S.offset++];U=S.data[S.offset++];if(X[1]!=2||(X[2]&128)){X[0]=2;X[3]=U;return J(X,1,y-1,S)}for(U=0;U<4;U++){for(T=0;T<y;){var V=S.data[S.offset++];if(V>128){V=V&127;var W=S.data[S.offset++];while(V--){X[4*T+U]=W;T++}}else{while(V--){X[4*T+U]=S.data[S.offset++];T++}}}}return !(S.data.length===S.offset)};var J=function(W,U,y,S){var T,V=0;while(y>0){W[4*U]=S.data[S.offset++];W[4*U+1]=S.data[S.offset++];W[4*U+2]=S.data[S.offset++];W[4*U+3]=S.data[S.offset++];if(W[4*U]===1&&W[4*U+1]===1&&W[4*U+2]===1){for(T=(W[4*U+3]<<V);T>0;T--){W[4*U]=W[4*(U-1)];W[4*U+1]=W[4*(U-1)+1];W[4*U+2]=W[4*(U-1)+2];W[4*U+3]=W[4*(U-1)+3];U++;y--}V+=8}else{U++;y--;V=0}}return true};for(var C=w.height-1;C>=0;C--){u(L,w.width,O);if(v){E(L,w.width,w.data,z);if(A){z-=3*w.width}else{z+=3*w.width}}else{R(L,w.width,w.data,z);z+=4*w.width}}return w},streamDDS:function(C){function A(M){return M.charCodeAt(0)+(M.charCodeAt(1)<<8)+(M.charCodeAt(2)<<16)+(M.charCodeAt(3)<<24)}var I=542327876;var J=128;var D=4;var K=1;var x=64;var w=A("DXT1");var v=A("DXT3");var u=A("DXT5");var z=0;for(var H=0;H<C.mipmaps.length;H++){z+=C.mipmaps[H].data.length}var B=new ArrayBuffer(J+z);var G=new Int32Array(B,0,J/4);G[0]=I;G[1]=J-4;G[2]=659463;G[3]=C.image.height;G[4]=C.image.width;G[5]=65536;G[7]=C.mipmaps.length;G[19]=32;G[20]=D;switch(C.format){case s.RGB_S3TC_DXT1_Format:G[21]=w;break;case s.RGB_S3TC_DXT3_Format:G[21]=v;break;case s.RGB_S3TC_DXT5_Format:G[21]=u;break;case s.RGBAFormat:G[20]|=K;case s.RGBFormat:G[20]|=x;G[23]=255;G[24]=65280;G[25]=16711680;G[26]=4278190080;break;default:console.error("ImageUtils.streamDDS(): Unsupported FourCC code: ");return}G[27]=4198408;var L=new Uint8Array(B,J,z);var y=0;for(var H=0;H<C.mipmaps.length;H++){var E=C.mipmaps[H].data;for(var F=0;F<E.length;F++){L[y+F]=E[F]}y+=E.length}return B}};s.SceneUtils={createMultiMaterialObject:function(y,v){var x=new s.Object3D();for(var w=0,u=v.length;w<u;w++){x.add(new s.Mesh(y,v[w]))}return x},detach:function(w,u,v){w.applyMatrix(u.matrixWorld);u.remove(w);v.add(w)},attach:function(x,w,u){var v=new s.Matrix4();v.getInverse(u.matrixWorld);x.applyMatrix(v);w.remove(x);u.add(x)}};s.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},loadFace:function(x){var u=x.familyName.toLowerCase();var v=this;v.faces[u]=v.faces[u]||{};v.faces[u][x.cssFontWeight]=v.faces[u][x.cssFontWeight]||{};v.faces[u][x.cssFontWeight][x.cssFontStyle]=x;var w=v.faces[u][x.cssFontWeight][x.cssFontStyle]=x;return x},drawText:function(G){var u=[],y=[];var C,w,E=this.getFace(),A=this.size/E.resolution,B=0,F=String(G).split(""),x=F.length;var z=[];for(C=0;C<x;C++){var H=new s.Path();var D=this.extractGlyphPoints(F[C],E,A,B,H);B+=D.offset;z.push(D.path)}var v=B/2;return{paths:z,offset:v}},extractGlyphPoints:function(T,D,X,A,L){var Y=[];var O,M,w,z,N,v,V,S,F,E,C,B,K,R,I,Q,H,P,u,G=D.glyphs[T]||D.glyphs["?"];if(!G){return}if(G.o){z=G._cachedOutline||(G._cachedOutline=G.o.split(" "));v=z.length;V=X;S=X;for(O=0;O<v;){N=z[O++];switch(N){case"m":F=z[O++]*V+A;E=z[O++]*S;L.moveTo(F,E);break;case"l":F=z[O++]*V+A;E=z[O++]*S;L.lineTo(F,E);break;case"q":C=z[O++]*V+A;B=z[O++]*S;I=z[O++]*V+A;Q=z[O++]*S;L.quadraticCurveTo(I,Q,C,B);u=Y[Y.length-1];if(u){K=u.x;R=u.y;for(M=1,w=this.divisions;M<=w;M++){var J=M/w;var W=s.Shape.Utils.b2(J,K,I,C);var U=s.Shape.Utils.b2(J,R,Q,B)}}break;case"b":C=z[O++]*V+A;B=z[O++]*S;I=z[O++]*V+A;Q=z[O++]*-S;H=z[O++]*V+A;P=z[O++]*-S;L.bezierCurveTo(C,B,I,Q,H,P);u=Y[Y.length-1];if(u){K=u.x;R=u.y;for(M=1,w=this.divisions;M<=w;M++){var J=M/w;var W=s.Shape.Utils.b3(J,K,I,H,C);var U=s.Shape.Utils.b3(J,R,Q,P,B)}}break}}}return{offset:G.ha*X,path:L}}};s.FontUtils.generateShapes=function(C,D){D=D||{};var F=D.size!==undefined?D.size:100;var B=D.curveSegments!==undefined?D.curveSegments:4;var x=D.font!==undefined?D.font:"helvetiker";var A=D.weight!==undefined?D.weight:"normal";var u=D.style!==undefined?D.style:"normal";s.FontUtils.size=F;s.FontUtils.divisions=B;s.FontUtils.face=x;s.FontUtils.weight=A;s.FontUtils.style=u;var z=s.FontUtils.drawText(C);var E=z.paths;var w=[];for(var v=0,y=E.length;v<y;v++){Array.prototype.push.apply(w,E[v].toShapes())}return w};(function(w){var v=1e-10;var y=function(A,K){var z=A.length;if(z<3){return null}var O=[],I=[],D=[];var L,J,H;if(x(A)>0){for(J=0;J<z;J++){I[J]=J}}else{for(J=0;J<z;J++){I[J]=(z-1)-J}}var C=z;var B=2*C;for(J=C-1;C>2;){if((B--)<=0){console.log("Warning, unable to triangulate polygon!");if(K){return D}return O}L=J;if(C<=L){L=0}J=L+1;if(C<=J){J=0}H=J+1;if(C<=H){H=0}if(u(A,L,J,H,C,I)){var G,F,E,N,M;G=I[L];F=I[J];E=I[H];O.push([A[G],A[F],A[E]]);D.push([I[L],I[J],I[H]]);for(N=J,M=J+1;M<C;N++,M++){I[N]=I[M]}C--;B=2*C}}if(K){return D}return O};var x=function(A){var D=A.length;var z=0;for(var C=D-1,B=0;B<D;C=B++){z+=A[C].x*A[B].y-A[B].x*A[C].y}return z*0.5};var u=function(V,P,O,L,U,ac){var T;var M,J,aa,Y;var C,A,S,R;M=V[ac[P]].x;J=V[ac[P]].y;aa=V[ac[O]].x;Y=V[ac[O]].y;C=V[ac[L]].x;A=V[ac[L]].y;if(v>(((aa-M)*(A-J))-((Y-J)*(C-M)))){return false}var B,z,N,K,ab,Z;var F,E,X,W,H,G;var D,I,Q;B=C-aa;z=A-Y;N=M-C;K=J-A;ab=aa-M;Z=Y-J;for(T=0;T<U;T++){if((T===P)||(T===O)||(T===L)){continue}S=V[ac[T]].x;R=V[ac[T]].y;F=S-M;E=R-J;X=S-aa;W=R-Y;H=S-C;G=R-A;Q=B*W-z*X;D=ab*E-Z*F;I=N*G-K*H;if((Q>=0)&&(I>=0)&&(D>=0)){return false}}return true};w.Triangulate=y;w.Triangulate.area=x;return w})(s.FontUtils);self._typeface_js={faces:s.FontUtils.faces,loadFace:s.FontUtils.loadFace};s.LineCurve=function(v,u){this.v1=v;this.v2=u};s.LineCurve.prototype=Object.create(s.Curve.prototype);s.LineCurve.prototype.getPoint=function(v){var u=this.v2.clone().sub(this.v1);u.multiplyScalar(v).add(this.v1);return u};s.LineCurve.prototype.getPointAt=function(v){return this.getPoint(v)};s.LineCurve.prototype.getTangent=function(u){var v=this.v2.clone().sub(this.v1);return v.normalize()};s.QuadraticBezierCurve=function(u,w,v){this.v0=u;this.v1=w;this.v2=v};s.QuadraticBezierCurve.prototype=Object.create(s.Curve.prototype);s.QuadraticBezierCurve.prototype.getPoint=function(w){var v,u;v=s.Shape.Utils.b2(w,this.v0.x,this.v1.x,this.v2.x);u=s.Shape.Utils.b2(w,this.v0.y,this.v1.y,this.v2.y);return new s.Vector2(v,u)};s.QuadraticBezierCurve.prototype.getTangent=function(w){var v,u;v=s.Curve.Utils.tangentQuadraticBezier(w,this.v0.x,this.v1.x,this.v2.x);u=s.Curve.Utils.tangentQuadraticBezier(w,this.v0.y,this.v1.y,this.v2.y);var x=new s.Vector2(v,u);x.normalize();return x};s.CubicBezierCurve=function(u,x,w,v){this.v0=u;this.v1=x;this.v2=w;this.v3=v};s.CubicBezierCurve.prototype=Object.create(s.Curve.prototype);s.CubicBezierCurve.prototype.getPoint=function(w){var v,u;v=s.Shape.Utils.b3(w,this.v0.x,this.v1.x,this.v2.x,this.v3.x);u=s.Shape.Utils.b3(w,this.v0.y,this.v1.y,this.v2.y,this.v3.y);return new s.Vector2(v,u)};s.CubicBezierCurve.prototype.getTangent=function(w){var v,u;v=s.Curve.Utils.tangentCubicBezier(w,this.v0.x,this.v1.x,this.v2.x,this.v3.x);u=s.Curve.Utils.tangentCubicBezier(w,this.v0.y,this.v1.y,this.v2.y,this.v3.y);var x=new s.Vector2(v,u);x.normalize();return x};s.SplineCurve=function(u){this.points=(u==undefined)?[]:u};s.SplineCurve.prototype=Object.create(s.Curve.prototype);s.SplineCurve.prototype.getPoint=function(x){var w=new s.Vector2();var B=[];var y=this.points,u,A,z;u=(y.length-1)*x;A=Math.floor(u);z=u-A;B[0]=A==0?A:A-1;B[1]=A;B[2]=A>y.length-2?y.length-1:A+1;B[3]=A>y.length-3?y.length-1:A+2;w.x=s.Curve.Utils.interpolate(y[B[0]].x,y[B[1]].x,y[B[2]].x,y[B[3]].x,z);w.y=s.Curve.Utils.interpolate(y[B[0]].y,y[B[1]].y,y[B[2]].y,y[B[3]].y,z);return w};s.EllipseCurve=function(z,y,A,u,x,w,v){this.aX=z;this.aY=y;this.xRadius=A;this.yRadius=u;this.aStartAngle=x;this.aEndAngle=w;this.aClockwise=v};s.EllipseCurve.prototype=Object.create(s.Curve.prototype);s.EllipseCurve.prototype.getPoint=function(w){var y=this.aEndAngle-this.aStartAngle;if(!this.aClockwise){w=1-w}var x=this.aStartAngle+w*y;var v=this.aX+this.xRadius*Math.cos(x);var u=this.aY+this.yRadius*Math.sin(x);return new s.Vector2(v,u)};s.Curve.Utils={tangentQuadraticBezier:function(u,x,w,v){return 2*(1-u)*(w-x)+2*u*(v-w)},tangentCubicBezier:function(u,y,x,w,v){return -3*y*(1-u)*(1-u)+3*x*(1-u)*(1-u)-6*u*x*(1-u)+6*u*w*(1-u)-3*u*u*w+3*u*u*v},tangentSpline:function(C,B,A,z,x){var y=6*C*C-6*C;var v=3*C*C-4*C+1;var w=-6*C*C+6*C;var u=3*C*C-2*C;return y+v+w+u},interpolate:function(B,A,y,x,C){var z=(y-B)*0.5;var w=(x-A)*0.5;var v=C*C;var u=C*v;return(2*A-2*y+z+w)*u+(-3*A+3*y-2*z-w)*v+z*C+A}};s.Curve.create=function(u,v){u.prototype=Object.create(s.Curve.prototype);u.prototype.getPoint=v;return u};s.LineCurve3=s.Curve.create(function(v,u){this.v1=v;this.v2=u},function(u){var v=new s.Vector3();v.subVectors(this.v2,this.v1);v.multiplyScalar(u);v.add(this.v1);return v});s.QuadraticBezierCurve3=s.Curve.create(function(u,w,v){this.v0=u;this.v1=w;this.v2=v},function(w){var v,u,x;v=s.Shape.Utils.b2(w,this.v0.x,this.v1.x,this.v2.x);u=s.Shape.Utils.b2(w,this.v0.y,this.v1.y,this.v2.y);x=s.Shape.Utils.b2(w,this.v0.z,this.v1.z,this.v2.z);return new s.Vector3(v,u,x)});s.CubicBezierCurve3=s.Curve.create(function(u,x,w,v){this.v0=u;this.v1=x;this.v2=w;this.v3=v},function(w){var v,u,x;v=s.Shape.Utils.b3(w,this.v0.x,this.v1.x,this.v2.x,this.v3.x);u=s.Shape.Utils.b3(w,this.v0.y,this.v1.y,this.v2.y,this.v3.y);x=s.Shape.Utils.b3(w,this.v0.z,this.v1.z,this.v2.z,this.v3.z);return new s.Vector3(v,u,x)});s.SplineCurve3=s.Curve.create(function(u){this.points=(u==undefined)?[]:u},function(F){var D=new s.Vector3();var x=[];var C=this.points,A,u,w;A=(C.length-1)*F;u=Math.floor(A);w=A-u;x[0]=u==0?u:u-1;x[1]=u;x[2]=u>C.length-2?C.length-1:u+1;x[3]=u>C.length-3?C.length-1:u+2;var E=C[x[0]],B=C[x[1]],z=C[x[2]],y=C[x[3]];D.x=s.Curve.Utils.interpolate(E.x,B.x,z.x,y.x,w);D.y=s.Curve.Utils.interpolate(E.y,B.y,z.y,y.y,w);D.z=s.Curve.Utils.interpolate(E.z,B.z,z.z,y.z,w);return D});s.ClosedSplineCurve3=s.Curve.create(function(u){this.points=(u==undefined)?[]:u},function(x){var w=new s.Vector3();var B=[];var y=this.points,u,A,z;u=(y.length-0)*x;A=Math.floor(u);z=u-A;A+=A>0?0:(Math.floor(Math.abs(A)/y.length)+1)*y.length;B[0]=(A-1)%y.length;B[1]=(A)%y.length;B[2]=(A+1)%y.length;B[3]=(A+2)%y.length;w.x=s.Curve.Utils.interpolate(y[B[0]].x,y[B[1]].x,y[B[2]].x,y[B[3]].x,z);w.y=s.Curve.Utils.interpolate(y[B[0]].y,y[B[1]].y,y[B[2]].y,y[B[3]].y,z);w.z=s.Curve.Utils.interpolate(y[B[0]].z,y[B[1]].z,y[B[2]].z,y[B[3]].z,z);return w});s.CurvePath=function(){this.curves=[];this.bends=[];this.autoClose=false};s.CurvePath.prototype=Object.create(s.Curve.prototype);s.CurvePath.prototype.add=function(u){this.curves.push(u)};s.CurvePath.prototype.checkConnection=function(){};s.CurvePath.prototype.closePath=function(){var v=this.curves[0].getPoint(0);var u=this.curves[this.curves.length-1].getPoint(1);if(!v.equals(u)){this.curves.push(new s.LineCurve(u,v))}};s.CurvePath.prototype.getPoint=function(x){var B=x*this.getLength();var A=this.getCurveLengths();var w=0,y,z;while(w<A.length){if(A[w]>=B){y=A[w]-B;z=this.curves[w];var v=1-y/z.getLength();return z.getPointAt(v);break}w++}return null};s.CurvePath.prototype.getLength=function(){var u=this.getCurveLengths();return u[u.length-1]};s.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length){return this.cacheLengths}var x=[],w=0;var v,u=this.curves.length;for(v=0;v<u;v++){w+=this.curves[v].getLength();x.push(w)}this.cacheLengths=x;return x};s.CurvePath.prototype.getBoundingBox=function(){var F=this.getPoints();var v,u,G;var z,y,x;v=u=Number.NEGATIVE_INFINITY;z=y=Number.POSITIVE_INFINITY;var w,A,E,B;var D=F[0] instanceof s.Vector3;B=D?new s.Vector3():new s.Vector2();for(A=0,E=F.length;A<E;A++){w=F[A];if(w.x>v){v=w.x}else{if(w.x<z){z=w.x}}if(w.y>u){u=w.y}else{if(w.y<y){y=w.y}}if(D){if(w.z>G){G=w.z}else{if(w.z<x){x=w.z}}}B.add(w)}var C={minX:z,minY:y,maxX:v,maxY:u,centroid:B.divideScalar(E)};if(D){C.maxZ=G;C.minZ=x}return C};s.CurvePath.prototype.createPointsGeometry=function(u){var v=this.getPoints(u,true);return this.createGeometry(v)};s.CurvePath.prototype.createSpacedPointsGeometry=function(u){var v=this.getSpacedPoints(u,true);return this.createGeometry(v)};s.CurvePath.prototype.createGeometry=function(v){var w=new s.Geometry();for(var u=0;u<v.length;u++){w.vertices.push(new s.Vector3(v[u].x,v[u].y,v[u].z||0))}return w};s.CurvePath.prototype.addWrapPath=function(u){this.bends.push(u)};s.CurvePath.prototype.getTransformedPoints=function(w,y){var v=this.getPoints(w);var x,u;if(!y){y=this.bends}for(x=0,u=y.length;x<u;x++){v=this.getWrapPoints(v,y[x])}return v};s.CurvePath.prototype.getTransformedSpacedPoints=function(w,y){var v=this.getSpacedPoints(w);var x,u;if(!y){y=this.bends}for(x=0,u=y.length;x<u;x++){v=this.getWrapPoints(v,y[x])}return v};s.CurvePath.prototype.getWrapPoints=function(z,E){var u=this.getBoundingBox();var x,A,v,C,B,D;for(x=0,A=z.length;x<A;x++){v=z[x];C=v.x;B=v.y;D=C/u.maxX;D=E.getUtoTmapping(D,C);var w=E.getPoint(D);var y=E.getNormalVector(D).multiplyScalar(B);v.x=w.x+y.x;v.y=w.y+y.y}return z};s.Path=function(u){s.CurvePath.call(this);this.actions=[];if(u){this.fromPoints(u)}};s.Path.prototype=Object.create(s.CurvePath.prototype);s.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"quadraticCurveTo",BEZIER_CURVE_TO:"bezierCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc",ELLIPSE:"ellipse"};s.Path.prototype.fromPoints=function(w){this.moveTo(w[0].x,w[0].y);for(var u=1,x=w.length;u<x;u++){this.lineTo(w[u].x,w[u].y)}};s.Path.prototype.moveTo=function(u,w){var v=Array.prototype.slice.call(arguments);this.actions.push({action:s.PathActions.MOVE_TO,args:v})};s.Path.prototype.lineTo=function(u,C){var v=Array.prototype.slice.call(arguments);var A=this.actions[this.actions.length-1].args;var w=A[A.length-2];var z=A[A.length-1];var B=new s.LineCurve(new s.Vector2(w,z),new s.Vector2(u,C));this.curves.push(B);this.actions.push({action:s.PathActions.LINE_TO,args:v})};s.Path.prototype.quadraticCurveTo=function(y,v,A,z){var B=Array.prototype.slice.call(arguments);var u=this.actions[this.actions.length-1].args;var w=u[u.length-2];var C=u[u.length-1];var x=new s.QuadraticBezierCurve(new s.Vector2(w,C),new s.Vector2(y,v),new s.Vector2(A,z));this.curves.push(x);this.actions.push({action:s.PathActions.QUADRATIC_CURVE_TO,args:B})};s.Path.prototype.bezierCurveTo=function(y,w,E,D,A,z){var B=Array.prototype.slice.call(arguments);var u=this.actions[this.actions.length-1].args;var v=u[u.length-2];var C=u[u.length-1];var x=new s.CubicBezierCurve(new s.Vector2(v,C),new s.Vector2(y,w),new s.Vector2(E,D),new s.Vector2(A,z));this.curves.push(x);this.actions.push({action:s.PathActions.BEZIER_CURVE_TO,args:B})};s.Path.prototype.splineThru=function(A){var u=Array.prototype.slice.call(arguments);var x=this.actions[this.actions.length-1].args;var v=x[x.length-2];var w=x[x.length-1];var z=[new s.Vector2(v,w)];Array.prototype.push.apply(z,A);var y=new s.SplineCurve(z);this.curves.push(y);this.actions.push({action:s.PathActions.CSPLINE_THRU,args:u})};s.Path.prototype.arc=function(B,z,A,x,u,v){var w=this.actions[this.actions.length-1].args;var y=w[w.length-2];var C=w[w.length-1];this.absarc(B+y,z+C,A,x,u,v)};s.Path.prototype.absarc=function(y,x,z,w,v,u){this.absellipse(y,x,z,z,w,v,u)};s.Path.prototype.ellipse=function(A,z,C,B,x,u,v){var w=this.actions[this.actions.length-1].args;var y=w[w.length-2];var D=w[w.length-1];this.absellipse(A+y,z+D,C,B,x,u,v)};s.Path.prototype.absellipse=function(z,y,D,A,w,u,v){var B=Array.prototype.slice.call(arguments);var x=new s.EllipseCurve(z,y,D,A,w,u,v);this.curves.push(x);var C=x.getPoint(v?1:0);B.push(C.x);B.push(C.y);this.actions.push({action:s.PathActions.ELLIPSE,args:B})};s.Path.prototype.getSpacedPoints=function(v,x){if(!v){v=40}var w=[];for(var u=0;u<v;u++){w.push(this.getPoint(u/v))}return w};s.Path.prototype.getPoints=function(ae,ac){if(this.useSpacedPoints){console.log("tata");return this.getSpacedPoints(ae,ac)}ae=ae||12;var Q=[];var Z,K,I,w,U;var R,O,ad,L,af,M,u,N,v,Y,T,X,W;for(Z=0,K=this.actions.length;Z<K;Z++){I=this.actions[Z];w=I.action;U=I.args;switch(w){case s.PathActions.MOVE_TO:Q.push(new s.Vector2(U[0],U[1]));break;case s.PathActions.LINE_TO:Q.push(new s.Vector2(U[0],U[1]));break;case s.PathActions.QUADRATIC_CURVE_TO:R=U[2];O=U[3];af=U[0];M=U[1];if(Q.length>0){v=Q[Q.length-1];u=v.x;N=v.y}else{v=this.actions[Z-1].args;u=v[v.length-2];N=v[v.length-1]}for(Y=1;Y<=ae;Y++){T=Y/ae;X=s.Shape.Utils.b2(T,u,af,R);W=s.Shape.Utils.b2(T,N,M,O);Q.push(new s.Vector2(X,W))}break;case s.PathActions.BEZIER_CURVE_TO:R=U[4];O=U[5];af=U[0];M=U[1];ad=U[2];L=U[3];if(Q.length>0){v=Q[Q.length-1];u=v.x;N=v.y}else{v=this.actions[Z-1].args;u=v[v.length-2];N=v[v.length-1]}for(Y=1;Y<=ae;Y++){T=Y/ae;X=s.Shape.Utils.b3(T,u,af,ad,R);W=s.Shape.Utils.b3(T,N,M,L,O);Q.push(new s.Vector2(X,W))}break;case s.PathActions.CSPLINE_THRU:v=this.actions[Z-1].args;var C=new s.Vector2(v[v.length-2],v[v.length-1]);var z=[C];var V=ae*U[0].length;z=z.concat(U[0]);var ab=new s.SplineCurve(z);for(Y=1;Y<=V;Y++){Q.push(ab.getPointAt(Y/V))}break;case s.PathActions.ARC:var F=U[0],E=U[1],G=U[2],aa=U[3],S=U[4],B=!!U[5];var P=S-aa;var D;var x=ae*2;for(Y=1;Y<=x;Y++){T=Y/x;if(!B){T=1-T}D=aa+T*P;X=F+G*Math.cos(D);W=E+G*Math.sin(D);Q.push(new s.Vector2(X,W))}break;case s.PathActions.ELLIPSE:var F=U[0],E=U[1],H=U[2],J=U[3],aa=U[4],S=U[5],B=!!U[6];var P=S-aa;var D;var x=ae*2;for(Y=1;Y<=x;Y++){T=Y/x;if(!B){T=1-T}D=aa+T*P;X=F+H*Math.cos(D);W=E+J*Math.sin(D);Q.push(new s.Vector2(X,W))}break}}var y=Q[Q.length-1];var A=1e-10;if(Math.abs(y.x-Q[0].x)<A&&Math.abs(y.y-Q[0].y)<A){Q.splice(Q.length-1,1)}if(ac){Q.push(Q[0])}return Q};s.Path.prototype.toShapes=function(){var w,z,C,v,x;var y=[],B=new s.Path();for(w=0,z=this.actions.length;w<z;w++){C=this.actions[w];x=C.args;v=C.action;if(v==s.PathActions.MOVE_TO){if(B.actions.length!=0){y.push(B);B=new s.Path()}}B[v].apply(B,x)}if(B.actions.length!=0){y.push(B)}if(y.length==0){return[]}var E,D,u=[];var A=!s.Shape.Utils.isClockWise(y[0].getPoints());if(y.length==1){E=y[0];D=new s.Shape();D.actions=E.actions;D.curves=E.curves;u.push(D);return u}if(A){D=new s.Shape();for(w=0,z=y.length;w<z;w++){E=y[w];if(s.Shape.Utils.isClockWise(E.getPoints())){D.actions=E.actions;D.curves=E.curves;u.push(D);D=new s.Shape()}else{D.holes.push(E)}}}else{for(w=0,z=y.length;w<z;w++){E=y[w];if(s.Shape.Utils.isClockWise(E.getPoints())){if(D){u.push(D)}D=new s.Shape();D.actions=E.actions;D.curves=E.curves}else{D.holes.push(E)}}u.push(D)}return u};s.Shape=function(){s.Path.apply(this,arguments);this.holes=[]};s.Shape.prototype=Object.create(s.Path.prototype);s.Shape.prototype.extrude=function(v){var u=new s.ExtrudeGeometry(this,v);return u};s.Shape.prototype.makeGeometry=function(u){var v=new s.ShapeGeometry(this,u);return v};s.Shape.prototype.getPointsHoles=function(w){var v,u=this.holes.length,x=[];for(v=0;v<u;v++){x[v]=this.holes[v].getTransformedPoints(w,this.bends)}return x};s.Shape.prototype.getSpacedPointsHoles=function(w){var v,u=this.holes.length,x=[];for(v=0;v<u;v++){x[v]=this.holes[v].getTransformedSpacedPoints(w,this.bends)}return x};s.Shape.prototype.extractAllPoints=function(u){return{shape:this.getTransformedPoints(u),holes:this.getPointsHoles(u)}};s.Shape.prototype.extractPoints=function(u){if(this.useSpacedPoints){return this.extractAllSpacedPoints(u)}return this.extractAllPoints(u)};s.Shape.prototype.extractAllSpacedPoints=function(u){return{shape:this.getTransformedSpacedPoints(u),holes:this.getSpacedPointsHoles(u)}};s.Shape.Utils={removeHoles:function(T,E){var C=T.concat();var R=C.concat();var O,w,K,ac,Q,L,S,A,aa,J,I,H,ad,U,G,F,af,ae,v,u,Z=[];for(aa=0;aa<E.length;aa++){I=E[aa];Array.prototype.push.apply(R,I);H=Number.POSITIVE_INFINITY;for(J=0;J<I.length;J++){G=I[J];var x=[];for(U=0;U<C.length;U++){F=C[U];ad=G.distanceToSquared(F);x.push(ad);if(ad<H){H=ad;Q=J;L=U}}}O=(L-1)>=0?L-1:C.length-1;K=(Q-1)>=0?Q-1:I.length-1;var y=[I[Q],C[L],C[O]];var Y=s.FontUtils.Triangulate.area(y);var P=[I[Q],I[K],C[L]];var X=s.FontUtils.Triangulate.area(P);var D=1;var V=-1;var M=L,W=Q;L+=D;Q+=V;if(L<0){L+=C.length}L%=C.length;if(Q<0){Q+=I.length}Q%=I.length;O=(L-1)>=0?L-1:C.length-1;K=(Q-1)>=0?Q-1:I.length-1;y=[I[Q],C[L],C[O]];var ab=s.FontUtils.Triangulate.area(y);P=[I[Q],I[K],C[L]];var N=s.FontUtils.Triangulate.area(P);if((Y+X)>(ab+N)){L=M;Q=W;if(L<0){L+=C.length}L%=C.length;if(Q<0){Q+=I.length}Q%=I.length;O=(L-1)>=0?L-1:C.length-1;K=(Q-1)>=0?Q-1:I.length-1}else{}af=C.slice(0,L);ae=C.slice(L);v=I.slice(Q);u=I.slice(0,Q);var B=[I[Q],C[L],C[O]];var z=[I[Q],I[K],C[L]];Z.push(B);Z.push(z);C=af.concat(v).concat(u).concat(ae)}return{shape:C,isolatedPts:Z,allpoints:R}},triangulateShape:function(x,w){var A=s.Shape.Utils.removeHoles(x,w);var D=A.shape,u=A.allpoints,G=A.isolatedPts;var v=s.FontUtils.Triangulate(D,false);var y,F,C,E,H,B,z={},I={};for(y=0,F=u.length;y<F;y++){H=u[y].x+":"+u[y].y;if(z[H]!==undefined){console.log("Duplicate point",H)}z[H]=y}for(y=0,F=v.length;y<F;y++){E=v[y];for(C=0;C<3;C++){H=E[C].x+":"+E[C].y;B=z[H];if(B!==undefined){E[C]=B}}}for(y=0,F=G.length;y<F;y++){E=G[y];for(C=0;C<3;C++){H=E[C].x+":"+E[C].y;B=z[H];if(B!==undefined){E[C]=B}}}return v.concat(G)},isClockWise:function(u){return s.FontUtils.Triangulate.area(u)<0},b2p0:function(v,w){var u=1-v;return u*u*w},b2p1:function(u,v){return 2*(1-u)*u*v},b2p2:function(u,v){return u*u*v},b2:function(u,x,w,v){return this.b2p0(u,x)+this.b2p1(u,w)+this.b2p2(u,v)},b3p0:function(v,w){var u=1-v;return u*u*u*w},b3p1:function(v,w){var u=1-v;return 3*u*u*v*w},b3p2:function(v,w){var u=1-v;return 3*u*v*v*w},b3p3:function(u,v){return u*u*u*v},b3:function(u,y,x,w,v){return this.b3p0(u,y)+this.b3p1(u,x)+this.b3p2(u,w)+this.b3p3(u,v)}};s.CircleGeometry=function(D,A,x,v){s.Geometry.call(this);D=D||50;x=x!==undefined?x:0;v=v!==undefined?v:Math.PI*2;A=A!==undefined?Math.max(3,A):8;var z,y=[],u=new s.Vector3(),G=new s.Vector2(0.5,0.5);this.vertices.push(u);y.push(G);for(z=0;z<=A;z++){var C=new s.Vector3();var B=x+z/A*v;C.x=D*Math.cos(B);C.y=D*Math.sin(B);this.vertices.push(C);y.push(new s.Vector2((C.x/D+1)/2,-(C.y/D+1)/2+1))}var w=new s.Vector3(0,0,-1);for(z=1;z<=A;z++){var H=z;var F=z+1;var E=0;this.faces.push(new s.Face3(H,F,E,[w,w,w]));this.faceVertexUvs[0].push([y[z],y[z+1],G])}this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new s.Sphere(new s.Vector3(),D)};s.CircleGeometry.prototype=Object.create(s.Geometry.prototype);s.CubeGeometry=function(u,C,y,v,B,x){s.Geometry.call(this);var E=this;this.width=u;this.height=C;this.depth=y;this.widthSegments=v||1;this.heightSegments=B||1;this.depthSegments=x||1;var D=this.width/2;var A=this.height/2;var w=this.depth/2;z("z","y",-1,-1,this.depth,this.height,D,0);z("z","y",1,-1,this.depth,this.height,-D,1);z("x","z",1,1,this.width,this.depth,A,2);z("x","z",1,-1,this.width,this.depth,-A,3);z("x","y",1,-1,this.width,this.height,w,4);z("x","y",-1,-1,this.width,this.height,-w,5);function z(S,R,F,M,U,T,af,O){var Q,K,J,W=E.widthSegments,V=E.heightSegments,L=U/2,I=T/2,N=E.vertices.length;if((S==="x"&&R==="y")||(S==="y"&&R==="x")){Q="z"}else{if((S==="x"&&R==="z")||(S==="z"&&R==="x")){Q="y";V=E.depthSegments}else{if((S==="z"&&R==="y")||(S==="y"&&R==="z")){Q="x";W=E.depthSegments}}}var X=W+1,H=V+1,ae=U/W,Z=T/V,ad=new s.Vector3();ad[Q]=af>0?1:-1;for(J=0;J<H;J++){for(K=0;K<X;K++){var G=new s.Vector3();G[S]=(K*ae-L)*F;G[R]=(J*Z-I)*M;G[Q]=af;E.vertices.push(G)}}for(J=0;J<V;J++){for(K=0;K<W;K++){var ac=K+X*J;var ab=K+X*(J+1);var aa=(K+1)+X*(J+1);var Y=(K+1)+X*J;var P=new s.Face4(ac+N,ab+N,aa+N,Y+N);P.normal.copy(ad);P.vertexNormals.push(ad.clone(),ad.clone(),ad.clone(),ad.clone());P.materialIndex=O;E.faces.push(P);E.faceVertexUvs[0].push([new s.Vector2(K/W,1-J/V),new s.Vector2(K/W,1-(J+1)/V),new s.Vector2((K+1)/W,1-(J+1)/V),new s.Vector2((K+1)/W,1-J/V)])}}}this.computeCentroids();this.mergeVertices()};s.CubeGeometry.prototype=Object.create(s.Geometry.prototype);s.CylinderGeometry=function(H,af,T,W,Q,ac){s.Geometry.call(this);H=H!==undefined?H:20;af=af!==undefined?af:20;T=T!==undefined?T:100;var V=T/2;var U=W||8;var S=Q||1;var M,L,D=[],N=[];for(L=0;L<=S;L++){var R=[];var ae=[];var O=L/S;var C=O*(af-H)+H;for(M=0;M<=U;M++){var P=M/U;var aa=new s.Vector3();aa.x=C*Math.sin(P*Math.PI*2);aa.y=-O*T+V;aa.z=C*Math.cos(P*Math.PI*2);this.vertices.push(aa);R.push(this.vertices.length-1);ae.push(new s.Vector2(P,1-O))}D.push(R);N.push(ae)}var Y=(af-H)/T;var J,G;for(M=0;M<U;M++){if(H!==0){J=this.vertices[D[0][M]].clone();G=this.vertices[D[0][M+1]].clone()}else{J=this.vertices[D[1][M]].clone();G=this.vertices[D[1][M+1]].clone()}J.setY(Math.sqrt(J.x*J.x+J.z*J.z)*Y).normalize();G.setY(Math.sqrt(G.x*G.x+G.z*G.z)*Y).normalize();for(L=0;L<S;L++){var B=D[L][M];var A=D[L+1][M];var z=D[L+1][M+1];var w=D[L][M+1];var K=J.clone();var I=J.clone();var F=G.clone();var E=G.clone();var ad=N[L][M].clone();var ab=N[L+1][M].clone();var Z=N[L+1][M+1].clone();var X=N[L][M+1].clone();this.faces.push(new s.Face4(B,A,z,w,[K,I,F,E]));this.faceVertexUvs[0].push([ad,ab,Z,X])}}if(!ac&&H>0){this.vertices.push(new s.Vector3(0,V,0));for(M=0;M<U;M++){var B=D[0][M];var A=D[0][M+1];var z=this.vertices.length-1;var K=new s.Vector3(0,1,0);var I=new s.Vector3(0,1,0);var F=new s.Vector3(0,1,0);var ad=N[0][M].clone();var ab=N[0][M+1].clone();var Z=new s.Vector2(ab.u,0);this.faces.push(new s.Face3(B,A,z,[K,I,F]));this.faceVertexUvs[0].push([ad,ab,Z])}}if(!ac&&af>0){this.vertices.push(new s.Vector3(0,-V,0));for(M=0;M<U;M++){var B=D[L][M+1];var A=D[L][M];var z=this.vertices.length-1;var K=new s.Vector3(0,-1,0);var I=new s.Vector3(0,-1,0);var F=new s.Vector3(0,-1,0);var ad=N[L][M+1].clone();var ab=N[L][M].clone();var Z=new s.Vector2(ab.u,1);this.faces.push(new s.Face3(B,A,z,[K,I,F]));this.faceVertexUvs[0].push([ad,ab,Z])}}this.computeCentroids();this.computeFaceNormals()};s.CylinderGeometry.prototype=Object.create(s.Geometry.prototype);s.ExtrudeGeometry=function(u,v){if(typeof(u)==="undefined"){u=[];return}s.Geometry.call(this);u=u instanceof Array?u:[u];this.shapebb=u[u.length-1].getBoundingBox();this.addShapeList(u,v);this.computeCentroids();this.computeFaceNormals()};s.ExtrudeGeometry.prototype=Object.create(s.Geometry.prototype);s.ExtrudeGeometry.prototype.addShapeList=function(v,x){var u=v.length;for(var y=0;y<u;y++){var w=v[y];this.addShape(w,x)}};s.ExtrudeGeometry.prototype.addShape=function(R,aa){var B=aa.amount!==undefined?aa.amount:100;var A=aa.bevelThickness!==undefined?aa.bevelThickness:6;var ab=aa.bevelSize!==undefined?aa.bevelSize:A-2;var O=aa.bevelSegments!==undefined?aa.bevelSegments:3;var u=aa.bevelEnabled!==undefined?aa.bevelEnabled:true;var Z=aa.curveSegments!==undefined?aa.curveSegments:12;var ak=aa.steps!==undefined?aa.steps:1;var I=aa.extrudePath;var af,J=false;var ay=aa.material;var F=aa.extrudeMaterial;var Q=aa.UVGenerator!==undefined?aa.UVGenerator:s.ExtrudeGeometry.WorldUVGenerator;var aj=this.shapebb;var L,an,ar,aG;if(I){af=I.getSpacedPoints(ak);J=true;u=false;L=aa.frames!==undefined?aa.frames:new s.TubeGeometry.FrenetFrames(I,ak,false);an=new s.Vector3();ar=new s.Vector3();aG=new s.Vector3()}if(!u){O=0;A=0;ab=0}var aJ,aE,aF;var al=this;var X=[];var ah=this.vertices.length;var P=R.extractPoints(Z);var x=P.shape;var V=P.holes;var au=!s.Shape.Utils.isClockWise(x);if(au){x=x.reverse();for(aE=0,aF=V.length;aE<aF;aE++){aJ=V[aE];if(s.Shape.Utils.isClockWise(aJ)){V[aE]=aJ.reverse()}}au=false}var H=s.Shape.Utils.triangulateShape(x,V);var ax=x;for(aE=0,aF=V.length;aE<aF;aE++){aJ=V[aE];x=x.concat(aJ)}function ac(aK,z,v){if(!z){console.log("die")}return z.clone().multiplyScalar(v).add(aK)}var aI,av,aq,am,K,aw=x.length,G,E=H.length,ai,w=ax.length;var ag=180/Math.PI;function T(aK,z,v){return M(aK,z,v)}function N(aL,aK,z){var aO=Math.atan2(aK.y-aL.y,aK.x-aL.x);var aN=Math.atan2(z.y-aL.y,z.x-aL.x);if(aO>aN){aN+=Math.PI*2}var aM=(aO+aN)/2;var aQ=-Math.cos(aM);var aP=-Math.sin(aM);var v=new s.Vector2(aQ,aP);return v}function M(aP,aO,aN){var aU=s.ExtrudeGeometry.__v1,aR=s.ExtrudeGeometry.__v2,aT=s.ExtrudeGeometry.__v3,aQ=s.ExtrudeGeometry.__v4,aL=s.ExtrudeGeometry.__v5,aK=s.ExtrudeGeometry.__v6,aW,aV,aM,aS,aX,z;aU.set(aP.x-aO.x,aP.y-aO.y);aR.set(aP.x-aN.x,aP.y-aN.y);aW=aU.normalize();aV=aR.normalize();aT.set(-aW.y,aW.x);aQ.set(aV.y,-aV.x);aL.copy(aP).add(aT);aK.copy(aP).add(aQ);if(aL.equals(aK)){return aQ.clone()}aL.copy(aO).add(aT);aK.copy(aN).add(aQ);aM=aW.dot(aQ);aS=aK.sub(aL).dot(aQ);if(aM===0){console.log("Either infinite or no solutions!");if(aS===0){console.log("Its finite solutions.")}else{console.log("Too bad, no solutions.")}}aX=aS/aM;if(aX<0){return N(aP,aO,aN)}z=aW.multiplyScalar(aX).add(aL);return z.sub(aP).clone()}var aB=[];for(var aD=0,ae=ax.length,aA=ae-1,az=aD+1;aD<ae;aD++,aA++,az++){if(aA===ae){aA=0}if(az===ae){az=0}var W=ax[aD];var U=ax[aA];var S=ax[az];aB[aD]=T(ax[aD],ax[aA],ax[az])}var ad=[],ap,y=aB.concat();for(aE=0,aF=V.length;aE<aF;aE++){aJ=V[aE];ap=[];for(aD=0,ae=aJ.length,aA=ae-1,az=aD+1;aD<ae;aD++,aA++,az++){if(aA===ae){aA=0}if(az===ae){az=0}ap[aD]=T(aJ[aD],aJ[aA],aJ[az])}ad.push(ap);y=y.concat(ap)}for(aI=0;aI<O;aI++){aq=aI/O;am=A*(1-aq);av=ab*(Math.sin(aq*Math.PI/2));for(aD=0,ae=ax.length;aD<ae;aD++){K=ac(ax[aD],aB[aD],av);ao(K.x,K.y,-am)}for(aE=0,aF=V.length;aE<aF;aE++){aJ=V[aE];ap=ad[aE];for(aD=0,ae=aJ.length;aD<ae;aD++){K=ac(aJ[aD],ap[aD],av);ao(K.x,K.y,-am)}}}av=ab;for(aD=0;aD<aw;aD++){K=u?ac(x[aD],y[aD],av):x[aD];if(!J){ao(K.x,K.y,0)}else{ar.copy(L.normals[0]).multiplyScalar(K.x);an.copy(L.binormals[0]).multiplyScalar(K.y);aG.copy(af[0]).add(ar).add(an);ao(aG.x,aG.y,aG.z)}}var at;for(at=1;at<=ak;at++){for(aD=0;aD<aw;aD++){K=u?ac(x[aD],y[aD],av):x[aD];if(!J){ao(K.x,K.y,B/ak*at)}else{ar.copy(L.normals[at]).multiplyScalar(K.x);an.copy(L.binormals[at]).multiplyScalar(K.y);aG.copy(af[at]).add(ar).add(an);ao(aG.x,aG.y,aG.z)}}}for(aI=O-1;aI>=0;aI--){aq=aI/O;am=A*(1-aq);av=ab*Math.sin(aq*Math.PI/2);for(aD=0,ae=ax.length;aD<ae;aD++){K=ac(ax[aD],aB[aD],av);ao(K.x,K.y,B+am)}for(aE=0,aF=V.length;aE<aF;aE++){aJ=V[aE];ap=ad[aE];for(aD=0,ae=aJ.length;aD<ae;aD++){K=ac(aJ[aD],ap[aD],av);if(!J){ao(K.x,K.y,B+am)}else{ao(K.x,K.y+af[ak-1].y,af[ak-1].x+am)}}}}Y();aH();function Y(){if(u){var v=0;var z=aw*v;for(aD=0;aD<E;aD++){G=H[aD];D(G[2]+z,G[1]+z,G[0]+z,true)}v=ak+O*2;z=aw*v;for(aD=0;aD<E;aD++){G=H[aD];D(G[0]+z,G[1]+z,G[2]+z,false)}}else{for(aD=0;aD<E;aD++){G=H[aD];D(G[2],G[1],G[0],true)}for(aD=0;aD<E;aD++){G=H[aD];D(G[0]+aw*ak,G[1]+aw*ak,G[2]+aw*ak,false)}}}function aH(){var v=0;aC(ax,v);v+=ax.length;for(aE=0,aF=V.length;aE<aF;aE++){aJ=V[aE];aC(aJ,v);v+=aJ.length}}function aC(aO,v){var aM,aL;aD=aO.length;while(--aD>=0){aM=aD;aL=aD-1;if(aL<0){aL=aO.length-1}var aT=0,z=ak+O*2;for(aT=0;aT<z;aT++){var aN=aw*aT;var aK=aw*(aT+1);var aS=v+aM+aN,aR=v+aL+aN,aQ=v+aL+aK,aP=v+aM+aK;C(aS,aR,aQ,aP,aO,aT,z,aM,aL)}}}function ao(v,aL,aK){al.vertices.push(new s.Vector3(v,aL,aK))}function D(z,v,aM,aL){z+=ah;v+=ah;aM+=ah;al.faces.push(new s.Face3(z,v,aM,null,null,ay));var aK=aL?Q.generateBottomUV(al,R,aa,z,v,aM):Q.generateTopUV(al,R,aa,z,v,aM);al.faceVertexUvs[0].push(aK)}function C(aQ,aP,aN,aM,v,aK,aR,aO,aL){aQ+=ah;aP+=ah;aN+=ah;aM+=ah;al.faces.push(new s.Face4(aQ,aP,aN,aM,null,null,F));var z=Q.generateSideWallUV(al,R,v,aa,aQ,aP,aN,aM,aK,aR,aO,aL);al.faceVertexUvs[0].push(z)}};s.ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(A,B,x,E,D,C){var u=A.vertices[E].x,F=A.vertices[E].y,z=A.vertices[D].x,y=A.vertices[D].y,w=A.vertices[C].x,v=A.vertices[C].y;return[new s.Vector2(u,F),new s.Vector2(z,y),new s.Vector2(w,v)]},generateBottomUV:function(z,w,u,y,x,v){return this.generateTopUV(z,w,u,y,x,v)},generateSideWallUV:function(z,G,v,N,R,Q,P,O,u,H,M,L){var E=z.vertices[R].x,C=z.vertices[R].y,A=z.vertices[R].z,K=z.vertices[Q].x,J=z.vertices[Q].y,I=z.vertices[Q].z,y=z.vertices[P].x,x=z.vertices[P].y,w=z.vertices[P].z,F=z.vertices[O].x,D=z.vertices[O].y,B=z.vertices[O].z;if(Math.abs(C-J)<0.01){return[new s.Vector2(E,1-A),new s.Vector2(K,1-I),new s.Vector2(y,1-w),new s.Vector2(F,1-B)]}else{return[new s.Vector2(C,1-A),new s.Vector2(J,1-I),new s.Vector2(x,1-w),new s.Vector2(D,1-B)]}}};s.ExtrudeGeometry.__v1=new s.Vector2();s.ExtrudeGeometry.__v2=new s.Vector2();s.ExtrudeGeometry.__v3=new s.Vector2();s.ExtrudeGeometry.__v4=new s.Vector2();s.ExtrudeGeometry.__v5=new s.Vector2();s.ExtrudeGeometry.__v6=new s.Vector2();s.ShapeGeometry=function(u,v){s.Geometry.call(this);if(u instanceof Array===false){u=[u]}this.shapebb=u[u.length-1].getBoundingBox();this.addShapeList(u,v);this.computeCentroids();this.computeFaceNormals()};s.ShapeGeometry.prototype=Object.create(s.Geometry.prototype);s.ShapeGeometry.prototype.addShapeList=function(v,w){for(var x=0,u=v.length;x<u;x++){this.addShape(v[x],w)}return this};s.ShapeGeometry.prototype.addShape=function(v,y){if(y===undefined){y={}}var u=y.curveSegments!==undefined?y.curveSegments:12;var F=y.material;var O=y.UVGenerator===undefined?s.ExtrudeGeometry.WorldUVGenerator:y.UVGenerator;var G=this.shapebb;var M,L,H,J;var E=this.vertices.length;var P=v.extractPoints(u);var z=P.shape;var B=P.holes;var D=!s.Shape.Utils.isClockWise(z);if(D){z=z.reverse();for(M=0,L=B.length;M<L;M++){H=B[M];if(s.Shape.Utils.isClockWise(H)){B[M]=H.reverse()}}D=false}var w=s.Shape.Utils.triangulateShape(z,B);var K=z;for(M=0,L=B.length;M<L;M++){H=B[M];z=z.concat(H)}var N,A=z.length;var C,T=w.length;var x,I=K.length;for(M=0;M<A;M++){N=z[M];this.vertices.push(new s.Vector3(N.x,N.y,0))}for(M=0;M<T;M++){C=w[M];var S=C[0]+E;var R=C[1]+E;var Q=C[2]+E;this.faces.push(new s.Face3(S,R,Q,null,null,F));this.faceVertexUvs[0].push(O.generateBottomUV(this,v,y,S,R,Q))}};s.PlaneGeometry=function(H,G,u,F){s.Geometry.call(this);this.width=H;this.height=G;this.widthSegments=u||1;this.heightSegments=F||1;var z,v;var A=H/2;var w=G/2;var J=this.widthSegments;var I=this.heightSegments;var K=J+1;var E=I+1;var R=this.width/J;var M=this.height/I;var Q=new s.Vector3(0,0,1);for(v=0;v<E;v++){for(z=0;z<K;z++){var D=z*R-A;var C=v*M-w;this.vertices.push(new s.Vector3(D,-C,0))}}for(v=0;v<I;v++){for(z=0;z<J;z++){var P=z+K*v;var O=z+K*(v+1);var N=(z+1)+K*(v+1);var L=(z+1)+K*v;var B=new s.Face4(P,O,N,L);B.normal.copy(Q);B.vertexNormals.push(Q.clone(),Q.clone(),Q.clone(),Q.clone());this.faces.push(B);this.faceVertexUvs[0].push([new s.Vector2(z/J,1-v/I),new s.Vector2(z/J,1-(v+1)/I),new s.Vector2((z+1)/J,1-(v+1)/I),new s.Vector2((z+1)/J,1-v/I)])}}this.computeCentroids()};s.PlaneGeometry.prototype=Object.create(s.Geometry.prototype);s.SphereGeometry=function(D,C,P,R,T,E,S){s.Geometry.call(this);this.radius=D||50;this.widthSegments=Math.max(3,Math.floor(C)||8);this.heightSegments=Math.max(2,Math.floor(P)||6);R=R!==undefined?R:0;T=T!==undefined?T:Math.PI*2;E=E!==undefined?E:0;S=S!==undefined?S:Math.PI;var L,K,F=[],M=[];for(K=0;K<=this.heightSegments;K++){var Q=[];var Z=[];for(L=0;L<=this.widthSegments;L++){var O=L/this.widthSegments;var N=K/this.heightSegments;var W=new s.Vector3();W.x=-this.radius*Math.cos(R+O*T)*Math.sin(E+N*S);W.y=this.radius*Math.cos(E+N*S);W.z=this.radius*Math.sin(R+O*T)*Math.sin(E+N*S);this.vertices.push(W);Q.push(this.vertices.length-1);Z.push(new s.Vector2(O,1-N))}F.push(Q);M.push(Z)}for(K=0;K<this.heightSegments;K++){for(L=0;L<this.widthSegments;L++){var B=F[K][L+1];var A=F[K][L];var z=F[K+1][L];var w=F[K+1][L+1];var J=this.vertices[B].clone().normalize();var I=this.vertices[A].clone().normalize();var H=this.vertices[z].clone().normalize();var G=this.vertices[w].clone().normalize();var Y=M[K][L+1].clone();var X=M[K][L].clone();var V=M[K+1][L].clone();var U=M[K+1][L+1].clone();if(Math.abs(this.vertices[B].y)===this.radius){this.faces.push(new s.Face3(B,z,w,[J,H,G]));this.faceVertexUvs[0].push([Y,V,U])}else{if(Math.abs(this.vertices[z].y)===this.radius){this.faces.push(new s.Face3(B,A,z,[J,I,H]));this.faceVertexUvs[0].push([Y,X,V])}else{this.faces.push(new s.Face4(B,A,z,w,[J,I,H,G]));this.faceVertexUvs[0].push([Y,X,V,U])}}}}this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new s.Sphere(new s.Vector3(),D)};s.SphereGeometry.prototype=Object.create(s.Geometry.prototype);s.TextGeometry=function(v,u){var w=s.FontUtils.generateShapes(v,u);u.amount=u.height!==undefined?u.height:50;if(u.bevelThickness===undefined){u.bevelThickness=10}if(u.bevelSize===undefined){u.bevelSize=8}if(u.bevelEnabled===undefined){u.bevelEnabled=false}s.ExtrudeGeometry.call(this,w,u)};s.TextGeometry.prototype=Object.create(s.ExtrudeGeometry.prototype);s.CameraHelper=function(y){s.Line.call(this);var A=this;this.geometry=new s.Geometry();this.material=new s.LineBasicMaterial({color:16777215,vertexColors:s.FaceColors});this.type=s.LinePieces;this.matrixWorld=y.matrixWorld;this.matrixAutoUpdate=false;this.frustumCulled=false;this.pointMap={};var x=16755200;var C=16711680;var v=43775;var z=16777215;var w=3355443;B("n1","n2",x);B("n2","n4",x);B("n4","n3",x);B("n3","n1",x);B("f1","f2",x);B("f2","f4",x);B("f4","f3",x);B("f3","f1",x);B("n1","f1",x);B("n2","f2",x);B("n3","f3",x);B("n4","f4",x);B("p","n1",C);B("p","n2",C);B("p","n3",C);B("p","n4",C);B("u1","u2",v);B("u2","u3",v);B("u3","u1",v);B("c","t",z);B("p","c",w);B("cn1","cn2",w);B("cn3","cn4",w);B("cf1","cf2",w);B("cf3","cf4",w);this.camera=y;function B(E,D,F){u(E,F);u(D,F)}function u(E,D){A.geometry.vertices.push(new s.Vector3());A.geometry.colors.push(new s.Color(D));if(A.pointMap[E]===undefined){A.pointMap[E]=[]}A.pointMap[E].push(A.geometry.vertices.length-1)}this.update(y)};s.CameraHelper.prototype=Object.create(s.Line.prototype);s.CameraHelper.prototype.update=function(){var y=this;var u=1,x=1;s.CameraHelper.__c.projectionMatrix.copy(this.camera.projectionMatrix);v("c",0,0,-1);v("t",0,0,1);v("n1",-u,-x,-1);v("n2",u,-x,-1);v("n3",-u,x,-1);v("n4",u,x,-1);v("f1",-u,-x,1);v("f2",u,-x,1);v("f3",-u,x,1);v("f4",u,x,1);v("u1",u*0.7,x*1.1,-1);v("u2",-u*0.7,x*1.1,-1);v("u3",0,x*2,-1);v("cf1",-u,0,1);v("cf2",u,0,1);v("cf3",0,-x,1);v("cf4",0,x,1);v("cn1",-u,0,-1);v("cn2",u,0,-1);v("cn3",0,-x,-1);v("cn4",0,x,-1);function v(A,w,F,E){s.CameraHelper.__v.set(w,F,E);s.CameraHelper.__projector.unprojectVector(s.CameraHelper.__v,s.CameraHelper.__c);var D=y.pointMap[A];if(D!==undefined){for(var C=0,B=D.length;C<B;C++){y.geometry.vertices[D[C]].copy(s.CameraHelper.__v)}}}this.geometry.verticesNeedUpdate=true};s.CameraHelper.__projector=new s.Projector();s.CameraHelper.__v=new s.Vector3();s.CameraHelper.__c=new s.Camera();s.LensFlare=function(x,v,y,w,u){s.Object3D.call(this);this.lensFlares=[];this.positionScreen=new s.Vector3();this.customUpdateCallback=undefined;if(x!==undefined){this.add(x,v,y,w,u)}};s.LensFlare.prototype=Object.create(s.Object3D.prototype);s.LensFlare.prototype.add=function(y,w,z,x,u,v){if(w===undefined){w=-1}if(z===undefined){z=0}if(v===undefined){v=1}if(u===undefined){u=new s.Color(16777215)}if(x===undefined){x=s.NormalBlending}z=Math.min(z,Math.max(0,z));this.lensFlares.push({texture:y,size:w,distance:z,x:0,y:0,z:0,scale:1,rotation:1,opacity:v,color:u,blending:x})};s.LensFlare.prototype.updateLensFlares=function(){var x,w=this.lensFlares.length;var v;var u=-this.positionScreen.x*2;var y=-this.positionScreen.y*2;for(x=0;x<w;x++){v=this.lensFlares[x];v.x=this.positionScreen.x+u*v.distance;v.y=this.positionScreen.y+y*v.distance;v.wantedRotation=v.x*Math.PI*0.25;v.rotation+=(v.wantedRotation-v.rotation)*0.25}};s.ShadowMapPlugin=function(){var B,K,G,M,v,y,J=new s.Frustum(),x=new s.Matrix4(),I=new s.Vector3(),L=new s.Vector3(),C=new s.Vector3();this.noRenderTarget=true;this.msaaOffset=[];for(var F=0;F<128;F++){var z=s.RandomLib.LowDiscrepancy2D(F);this.msaaOffset.push({x:z.x-0.5,y:z.y-0.5})}this.init=function(Q){B=Q.context;K=Q;var O=s.ShaderLib.depthRGBA;var P=s.UniformsUtils.clone(O.uniforms);G=new s.ShaderMaterial({fragmentShader:O.fragmentShader,vertexShader:O.vertexShader,uniforms:P});M=new s.ShaderMaterial({fragmentShader:O.fragmentShader,vertexShader:O.vertexShader,uniforms:P,morphTargets:true});v=new s.ShaderMaterial({fragmentShader:O.fragmentShader,vertexShader:O.vertexShader,uniforms:P,skinning:true});y=new s.ShaderMaterial({fragmentShader:O.fragmentShader,vertexShader:O.vertexShader,uniforms:P,morphTargets:true,skinning:true});G.side=a.DoubleSide;G._shadowPass=true;G.enableClipPlanes=true;M._shadowPass=true;v.side=a.DoubleSide;v._shadowPass=true;y._shadowPass=true};this.dispose=function(){};this.render=function(R,Q,P,O){if(!(K.shadowMapEnabled&&K.shadowMapAutoUpdate)){return}this.update(R,Q,P,O)};this.updateShaders=function(){G.needsUpdate=true;M.needsUpdate=true;v.needsUpdate=true;y.needsUpdate=true};this.update=function(ag,aZ,ax,ad){var aw,aj,au,Y,ao,S,aV,R,aM,aI,a7,a2,aS,aG,aX,Q=[],at=0,Z=null;B.disable(B.BLEND);B.enable(B.CULL_FACE);B.frontFace(B.CCW);if(K.shadowMapCullFace===s.CullFaceFront){B.cullFace(B.FRONT)}else{B.cullFace(B.BACK)}K.setDepthTest(true);var O=K.getScissorTest();K.enableScissorTest(false);var a1=null;var aW=null;if(!ag.boundingBox){for(var aq=0;aq<ag.children.length;aq++){var aL=ag.children[aq];if(aL.boundingSphere){aW=aL.boundingSphere}if(aL.boundingBox){a1=aL.boundingBox;break}}if(!a1&&aW){a1=aW.getBoundingBox()}}else{a1=ag.boundingBox}if(!a1){return}var av=new s.Matrix4();av.multiplyMatrices(aZ.projectionMatrix,aZ.matrixWorldInverse);J.setFromMatrix(av);var az=J.getCorners();var aB=new s.CGPoly();aB.setFromFrustumPoints(az);var af=a1.getPlanes();var a8=aB.clipByPlanes(af);ag.__lights.sort(ag._lightSort);for(aw=0,aj=ag.__lights.length;aw<aj;aw++){aG=ag.__lights[aw];if(!aG.castShadow&&!aG.castGroundShadow){continue}if(aG.isVirtual){continue}if((aG instanceof s.DirectionalLight)&&aG.shadowCascade){for(ao=aG.shadowCascadeCount;ao<aG.shadowCascadeArray.length;ao++){var W=aG.shadowCascadeArray[ao];if(W){if(W.cameraHelper){W.cameraHelper.visible=false}if(W.convexHullHelper){W.convexHullHelper.visible=false}}}for(ao=0;ao<aG.shadowCascadeCount;ao++){var W;if(!aG.shadowCascadeArray[ao]){W=E(aG,ao);W.originalCamera=aZ;aG.shadowCascadeArray[ao]=W;ag.add(W)}else{W=aG.shadowCascadeArray[ao]}N(aG,ao);Q[at]=W;at++}}else{Q[at]=aG;at++}}K.setBlending(s.NoBlending);var ay=K.materialToUse;K.materialToUse=s.MaterialToUse.shadowMapDepthMaterial;for(aw=0,aj=Q.length;aw<aj;aw++){aG=Q[aw];var ae=!aG.shadowMap;var U=(K.shadowMapType===s.ESMShadowMap||K.shadowMapType===s.ESMImprovedShadowMap);if(aG.shadowMap){ae=(U&&(aG.shadowMap.type===s.UnsignedByteType))||(!U&&(aG.shadowMap.type===s.FloatType))}if(ae){if(aG.shadowMap){aG.shadowMap.dispose()}var aE=s.LinearFilter;if(K.shadowMapType===s.PCFSoftShadowMap){aE=s.NearestFilter}var aT={minFilter:aE,magFilter:aE,type:U?s.FloatType:s.UnsignedByteType,format:s.RGBAFormat};if(aG instanceof s.PointLight){if(U){aG.tempRT=new s.WebGLRenderTarget(aG.shadowMapWidth,aG.shadowMapHeight,aT)}aG.shadowMap=new s.WebGLRenderTargetCube(aG.shadowMapWidth,aG.shadowMapHeight,aT)}else{aG.shadowMap=new s.WebGLRenderTarget(aG.shadowMapWidth,aG.shadowMapHeight,aT)}aG.shadowMapSize=new s.Vector2(aG.shadowMapWidth,aG.shadowMapHeight);aG.shadowMatrix=new s.Matrix4()}if(aG instanceof s.SpotLight){if(!aG.shadowCamera){aG.shadowCamera=new s.PerspectiveCamera(aG.shadowCameraFov,aG.shadowMapWidth/aG.shadowMapHeight,aG.shadowCameraNear,aG.shadowCameraFar);ag.add(aG.shadowCamera);if(K.autoUpdateScene){ag.updateMatrixWorld()}}}else{if(aG instanceof s.DirectionalLight){if(!aG.shadowCamera){aG.shadowCamera=new s.OrthographicCamera(aG.shadowCameraLeft,aG.shadowCameraRight,aG.shadowCameraTop,aG.shadowCameraBottom,aG.shadowCameraNear,aG.shadowCameraFar);ag.add(aG.shadowCamera);if(K.autoUpdateScene){ag.updateMatrixWorld()}}}else{if(aG instanceof s.PointLight){if(!aG.shadowCameras){aG.shadowCameras=[];for(var aw=0;aw<6;aw++){aG.shadowCameras.push(new s.PerspectiveCamera(aG.shadowCameraFov,aG.shadowMapWidth/aG.shadowMapHeight,aG.shadowCameraNear,aG.shadowCameraFar));ag.add(aG.shadowCameras[aw])}if(K.autoUpdateScene){ag.updateMatrixWorld()}}}else{console.error("Unsupported light type for shadow");continue}}}var a5=aG.updateShadowMap;var am=[];if(aG instanceof s.SpotLight||aG instanceof s.DirectionalLight){am=[aG.shadowCamera]}else{if(aG instanceof s.PointLight){am=aG.shadowCameras}}for(var aY=0;aY<am.length;aY++){R=am[aY];if(aG instanceof s.PointLight){aG.shadowMap.activeCubeFace=aY;aG.updateShadowMap=a5}if(K.renderIteration){R=am[aY].clone();var a3=Math.abs(am[aY].right-am[aY].left);var ar=Math.abs(am[aY].top-am[aY].bottom);R.left=am[aY].left+this.msaaOffset[K.renderIteration].x*a3/aG.shadowMapWidth;R.right=am[aY].right+this.msaaOffset[K.renderIteration].x*a3/aG.shadowMapWidth;R.bottom=am[aY].bottom+this.msaaOffset[K.renderIteration].y*ar/aG.shadowMapHeight;R.top=am[aY].top+this.msaaOffset[K.renderIteration].y*ar/aG.shadowMapHeight;R.updateProjectionMatrix()}if(aG.shadowCameraVisible&&!aG.cameraHelper){aG.cameraHelper=new s.CameraHelper(am[aY]);am[aY].add(aG.cameraHelper)}if(K.renderIteration<=1){if(aG.isVirtual){if(!aG.originalLight.updateShadowMap){continue}}else{if(!aG.updateShadowMap){continue}}}if(aG.castGroundShadow&&!aG.updateShadowMap){continue}if(!aG.isVirtual){aG.updateShadowMap=false}S=aG.shadowMap;aV=aG.shadowMatrix;var bb=aZ.matrixWorld.elements;var a0=aG.matrixWorld.elements;var aD=new s.Vector3(-bb[8],-bb[9],-bb[10]);var ai=new s.Vector3(a0[8],a0[9],a0[10]);if(aG.LiSPSM){var aA=new s.Vector3();aA.crossVectors(ai,aD);var ap=new s.Vector3();ap.crossVectors(aA,ai);ap.normalize();var al=new s.Vector3();var aP=new s.Vector3();var ah=new s.Vector3();ah.crossVectors(ai,ap);ah.normalize();aP.crossVectors(ah,ai);aP.normalize();al.copy(ai);al.normalize();R.position.getPositionFromMatrix(aZ.matrixWorld);R.up.copy(aP);C.copy(R.position);C.add(al);R.lookAt(C)}else{R.position.copy(aG.position);if(aG.target){R.lookAt(aG.target.position)}else{if(aG instanceof s.PointLight){var aU;var aC;switch(aY){case 0:aU=new s.Vector3().set(1,0,0);aC=new s.Vector3().set(0,0,-1);break;case 1:aU=new s.Vector3().set(-1,0,0);aC=new s.Vector3().set(0,0,1);break;case 2:aU=new s.Vector3().set(0,1,0);aC=new s.Vector3().set(1,0,0);break;case 3:aU=new s.Vector3().set(0,-1,0);aC=new s.Vector3().set(1,0,0);break;case 4:aU=new s.Vector3().set(0,0,1);aC=new s.Vector3().set(1,0,0);break;case 5:aU=new s.Vector3().set(0,0,-1);aC=new s.Vector3().set(-1,0,0);break}var ap=new s.Vector3();ap.crossVectors(aC,aU);ap.normalize();R.up.copy(ap);R.lookAt(new s.Vector3().copy(aG.position).add(aU))}else{var aU=new s.Vector3().set(0,0,-1);aU.applyMatrix4(new s.Matrix4().extractRotation(aG.matrixWorld));R.lookAt(new s.Vector3().copy(aG.position).add(aU))}}}R.updateMatrix();R.matrixWorld.copy(R.matrix);R.matrixWorldInverse.getInverse(R.matrixWorld);R.matrixWorldNeedsUpdate=false;R.matrixAutoUpdate=false;var aa=a8.clone();var an={near:aZ.near,far:aZ.far};if(aG.isVirtual){an=w(aZ,aa);var aQ=aG.originalLight.shadowCascadeCount;var aO=aG.originalLight.shadowCascadeSubNear&&aG.originalLight.shadowCascadeSubNear[aw];var a6=aG.originalLight.shadowCascadeSubFar&&aG.originalLight.shadowCascadeSubFar[aw];if(aO===undefined){aO=-Math.exp((1-aG.virtualLightIndex/aQ)*Math.log(an.near)+(aG.virtualLightIndex/aQ)*Math.log(an.far))}if(a6===undefined){a6=-Math.exp((1-(1+aG.virtualLightIndex)/aQ)*Math.log(an.near)+((1+aG.virtualLightIndex)/aQ)*Math.log(an.far))}an.near=aO;an.far=a6;aa=u(aZ,aG,aa,an.near,an.far);aa=H(aG,a1,aa,R)}else{aa=H(aG,a1,aa,R)}if(aG.isVirtual||aG.LiSPSM){A(aZ,aG,aa,an.near,an.far,ag)}if(aG.shadowCameraVisible){aa.applyMatrix4(R.matrixWorld);if(!aG.convexHullHelper){aG.convexHullHelper=new s.CGPolyHelper(aa);ag.add(aG.convexHullHelper)}else{if(aG.shadowCameraHelperToUpdate){var aH=new s.Color(255);var aR=[new s.Color(16711680),new s.Color(65280),new s.Color(255)];if(aG.isVirtual){if(aG.virtualLightIndex<3){aH=aR[aG.virtualLightIndex]}else{aH=new s.Color().setRGB(0,0,0.1*aG.virtualLightIndex)}}aG.convexHullHelper.update(aa,aH)}}}if(aG.convexHullHelper){aG.convexHullHelper.visible=aG.shadowCameraVisible}if(aG.cameraHelper){aG.cameraHelper.visible=aG.shadowCameraVisible}if(aG.shadowCameraVisible){if(aG.shadowCameraHelperToUpdate){aG.cameraHelper.update();aG.cameraHelper.matrixWorld=am[aY].matrixWorld;aG.cameraHelper.toUpdate=true}else{if(aG.cameraHelper.toUpdate){aG.cameraHelper.matrixWorld=new s.Matrix4().copy(am[aY].matrixWorld);aG.cameraHelper.matrixWorldNeedsUpdate=false;aG.cameraHelper.toUpdate=false}}}aV.set(0.5,0,0,0.5,0,0.5,0,0.5,0,0,0.5,0.5,0,0,0,1);aV.multiply(R.projectionMatrix);aV.multiply(R.matrixWorldInverse);x.multiplyMatrices(R.projectionMatrix,R.matrixWorldInverse);J.setFromMatrix(x);if(U&&aG instanceof s.PointLight){K.setRenderTarget(aG.tempRT)}else{K.setRenderTarget(S)}if(U){B.clearColor(Math.exp(80),1,1,1)}else{B.clearColor(1,1,1,1)}K.clear();aX=ag.getAllWebGLObjects();K._clipPlanesState.update(null,null,true,null,R);for(au=0,Y=aX.length;au<Y;au++){a2=aX[au];aS=a2.object;a2.render=false;aS.render=false;if(aS.visibilityFree){if(!aS.visible){continue}}else{if(K.visibleSpace?!aS.visible:aS.visible){continue}}if(aS.castShadow){if(!(aS instanceof s.Mesh||aS instanceof s.ParticleSystem)||!(aS.frustumCulled)||J.intersectsObject(aS)){aS._modelViewMatrix._multiplyDoubleMatricesMV(R.matrixWorldInverse,aS.matrixWorld);a2.render=true;aS.render=true}}}var P=K._stateSortingResult;K.getStateSortedObjects(aX,true,P,false,R);var V=null;for(var ab=0;ab<P._displayLists.length;ab++){var X=P._displayLists[ab];var aF=X._materialList;var ak=X.usefulListLength;for(var a9=0;a9<ak;a9++){var aK=aF[a9];var aJ=aK.material;var T=X._displayRangeLists[aK.id];var ba=T.first;K._clipPlanesState.update(aK.occurrenceRenderingOverride,V,false,aJ,R);V=aK.occurrenceRenderingOverride;if(!aJ.visible){continue}if(aJ.getOpacity()===0){continue}var aN=true;if(!ba){continue}var aS;for(aS=ba;aS;aS=aS.next){K.setMaterialFaces(aJ,aS[0],R);if(aS[1]._type===2){K.renderInterval(R,ag.__lights,Z,aS[0],aJ,null,aS[1],aS[2],aS[3],aS[4],aK.occurrenceRenderingOverride,undefined,aN);aN=false}else{if(aS[1]._type===1){K.renderBufferDirect(R,ag.__lights,Z,aJ,aS[1],aS[0])}else{K.renderBuffer(R,ag.__lights,Z,aJ,aS[1],aS[0])}}}}}aX=ag.__webglObjectsImmediate;for(au=0,Y=aX.length;au<Y;au++){a2=aX[au];aS=a2.object;if(aS.visibilityFree){if(!aS.visible){continue}}else{if(K.visibleSpace?!aS.visible:aS.visible){continue}}if(aS.castShadow){aS._modelViewMatrix._multiplyDoubleMatricesMV(R.matrixWorldInverse,aS.matrixWorld);K.renderImmediateObject(R,ag.__lights,Z,G,aS)}}if(aG.castGroundShadow||U){K.materialToUse=s.MaterialToUse.originalMaterial;var a4=K.getClearColor(),ac=K.getClearAlpha();B.clearColor(a4.r,a4.g,a4.b,ac);if(K.shadowMapCullFace===s.CullFaceFront){B.cullFace(B.BACK)}if(!aG.castGroundShadow&&U){B.enable(B.BLEND);K.esmEffect.setSize(aG.shadowMap.width,aG.shadowMap.height);if(aG instanceof s.PointLight){K.esmEffect.setInput(aG.tempRT)}else{K.esmEffect.setInput(aG.shadowMap)}K.esmEffect.passBlurV.setForceRenderTarget(aG.shadowMap);K.esmEffect.execute()}else{if(aG.castGroundShadow){aG.blurShadowEffect.setSize(512,512);aG.blurShadowEffect.setInput(aG.shadowMap);aG.blurShadowEffect.execute();aG.groundMaterial.uniforms.groundShadow.value=aG.blurShadowEffect.getResult()}}if(aw<Q.length-1||aY<am.length-1){K.materialToUse=s.MaterialToUse.shadowMapDepthMaterial;B.disable(B.BLEND);B.enable(B.CULL_FACE);B.frontFace(B.CCW);if(K.shadowMapCullFace===s.CullFaceFront){B.cullFace(B.FRONT)}else{B.cullFace(B.BACK)}}}}}var a4=K.getClearColor(),ac=K.getClearAlpha();B.clearColor(a4.r,a4.g,a4.b,ac);B.enable(B.BLEND);if(K.shadowMapCullFace===s.CullFaceFront){B.cullFace(B.BACK)}K.enableScissorTest(O);K.materialToUse=ay};function E(P,Q){var O=new s.DirectionalLight();O.originalLight=P;O.target=P.target;O.isVirtual=true;O.LiSPSM=P.LiSPSM;O.onlyShadow=true;O.castShadow=true;O.shadowCameraNear=P.shadowCameraNear;O.shadowCameraFar=P.shadowCameraFar;O.shadowCameraLeft=P.shadowCameraLeft;O.shadowCameraRight=P.shadowCameraRight;O.shadowCameraBottom=P.shadowCameraBottom;O.shadowCameraTop=P.shadowCameraTop;O.shadowCameraVisible=P.shadowCameraVisible;O.shadowDarkness=P.shadowDarkness;O.shadowBias=P.shadowCascadeBias[Q];O.shadowMapWidth=P.shadowCascadeWidth[Q];O.shadowMapHeight=P.shadowCascadeHeight[Q];return O}function N(P,Q){var O=P.shadowCascadeArray[Q];O.virtualLightIndex=Q;O.position.copy(P.position);if(P.target){O.target.position=P.target.position;O.lookAt(O.target.position)}O.shadowCameraVisible=P.shadowCameraVisible;O.shadowDarkness=P.shadowDarkness;O.shadowBias=P.shadowCascadeBias[Q]}function w(S,V){var R=V.getPoints();var U=R.length;var Q=Infinity;var O=-Infinity;var T=new s.Vector4();for(var P=0;P<R.length;P++){T.copy(R[P]);T.applyMatrix4(S.matrixWorldInverse);if(-T.z<Q){Q=-T.z}if(-T.z>O){O=-T.z}}Q=Math.max(S.near,Q);return{near:Q,far:O}}function u(W,Q,Z,T,S){var U=Q.matrixWorld.elements;var P=W.matrixWorld.elements;var aa=new s.Vector3(P[8],P[9],P[10]);var X=new s.Vector3(-P[8],-P[9],-P[10]);var O=new s.Vector3(U[8],U[9],U[10]);var Y=new s.Vector3().copy(aa).multiplyScalar(T).add(W.position);var ab=new s.Vector3().copy(aa).multiplyScalar(S).add(W.position);var R=new s.Plane(aa,-aa.dot(Y));var V=new s.Plane(X,-X.dot(ab));return Z.clipByPlanes([R,V])}function H(T,Y,X,R){var U=X.getPoints();var W=U.length;var V=new s.CGPoly();V.setFromBox(Y);V.applyMatrix4(R.matrixWorldInverse);var P=[];for(var S=0;S<W;S++){var aa=U[S].clone();aa.applyMatrix4(R.matrixWorldInverse);P.push(aa)}var O=new s.Box3().setFromPoints(P);var Z=O.getPlanes();var Q=V.clipByPlanes([Z[0],Z[1],Z[2],Z[3],Z[4]]);return Q}function A(ai,U,Z,aj,P,al){if(U instanceof s.PointLight){var ar=U.shadowCameras}else{var ar=[U.shadowCamera]}for(var ah=0;ah<ar.length;ah++){var W=U.matrixWorld.elements;var V=ai.matrixWorld.elements;var ae=new s.Vector3(V[8],V[9],V[10]);var ab=new s.Vector3(W[8],W[9],W[10]);var Q=Z.getPoints();var ad=Q.length;var Y=new s.Box3().setFromPoints(Q);if(U.LiSPSM){var ao=ae.dot(ab);var ag=Math.sqrt(1-ao*ao);var R=(aj+Math.sqrt(aj*P))/ag;var ak=Math.abs(Y.max.y-Y.min.y);var O=R+ak;var T=new s.Vector3(0,Y.min.y-R,0.5*(Y.min.z+Y.max.z));for(var af=0;af<ad;af++){var ac=Q[af];ac.sub(T)}var X=0;var S=0;for(var af=0;af<ad;af++){var ac=Q[af];var an=Math.abs(R*ac.x/ac.y);if(!X||(an>X)){X=an}var aa=Math.abs(R*ac.z/ac.y);if(!S||(aa>S)){S=aa}}T.applyMatrix4(ar[ah].matrixWorld);ar[ah].position.copy(T);ar[ah].matrix.elements[12]=ar[ah].position.x;ar[ah].matrix.elements[13]=ar[ah].position.y;ar[ah].matrix.elements[14]=ar[ah].position.z;ar[ah].matrixWorld.elements[12]=ar[ah].position.x;ar[ah].matrixWorld.elements[13]=ar[ah].position.y;ar[ah].matrixWorld.elements[14]=ar[ah].position.z;ar[ah].matrixWorldInverse.getInverse(ar[ah].matrixWorld);var aq=(O+R)/(O-R);var ap=-2*O*R/(O-R);var am=R/X;var ak=-R/S;ar[ah].projectionMatrix.set(am,0,0,0,0,aq,0,ap,0,0,ak,0,0,1,0,0)}else{ar[ah].left=Y.min.x;ar[ah].right=Y.max.x;ar[ah].top=Y.max.y;ar[ah].bottom=Y.min.y;ar[ah].near=-Y.max.z;ar[ah].far=-Y.min.z;ar[ah].updateProjectionMatrix()}}}function D(O){return O.material instanceof s.MeshFaceMaterial?O.material.materials[0]:O.material}};s.ShadowMapPlugin.__projector=new s.Projector();s.ShaderFlares={lensFlareVertexTexture:{vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","vUV = uv;","vec2 pos = position;","if( renderType == 2 ) {","vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) ) +","texture2D( occlusionMap, vec2( 0.5, 0.1 ) ) +","texture2D( occlusionMap, vec2( 0.9, 0.1 ) ) +","texture2D( occlusionMap, vec2( 0.9, 0.5 ) ) +","texture2D( occlusionMap, vec2( 0.9, 0.9 ) ) +","texture2D( occlusionMap, vec2( 0.5, 0.9 ) ) +","texture2D( occlusionMap, vec2( 0.1, 0.9 ) ) +","texture2D( occlusionMap, vec2( 0.1, 0.5 ) ) +","texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","vVisibility = (       visibility.r / 9.0 ) *","( 1.0 - visibility.g / 9.0 ) *","(       visibility.b / 9.0 ) *","( 1.0 - visibility.a / 9.0 );","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform lowp int renderType;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","if( renderType == 0 ) {","gl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );","} else if( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * vVisibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")},lensFlare:{vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uv;","vec2 pos = position;","if( renderType == 2 ) {","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision mediump float;","uniform lowp int renderType;","uniform sampler2D map;","uniform sampler2D occlusionMap;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","void main() {","if( renderType == 0 ) {","gl_FragColor = vec4( texture2D( map, vUV ).rgb, 0.0 );","} else if( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","float visibility = texture2D( occlusionMap, vec2( 0.5, 0.1 ) ).a +","texture2D( occlusionMap, vec2( 0.9, 0.5 ) ).a +","texture2D( occlusionMap, vec2( 0.5, 0.9 ) ).a +","texture2D( occlusionMap, vec2( 0.1, 0.5 ) ).a;","visibility = ( 1.0 - visibility / 4.0 );","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * visibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")}};return s});define("Visualization/ThreeJS_R57",["DS/Visualization/ThreeJS_R57","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/ThreeJS_R57");return b});define("DS/Visualization/SectionCappingPassCreator",["UWA/Class"],function(b){var a=b.extend({init:function(){},setupViewer:function(c){}});return a});define("Visualization/SectionCappingPassCreator",["DS/Visualization/SectionCappingPassCreator","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/SectionCappingPassCreator");return b});define("DS/Visualization/OutlineBuilder",["UWA/Class","DS/Mesh/Mesh"],function(a,b){var h=function(l){var k=1;while(k<l){k*=2}return k};var d={};d.VS_pars=["uniform sampler2D outlinePositionMaps[NB_OUTLINE_MAPS];","float far;","float near;","bool isPersp;","varying vec4 cP;","bool isOutlinePerspective(vec3 viewCurrent, vec3 viewOpposite, vec3 viewFirstSide, vec3 viewSecondSide, vec3 mv_firstNormal, vec3 mv_secondNormal) {","vec3 viewRayCurrent = normalize(viewCurrent);","vec3 viewRayOpposite = normalize(viewOpposite);","vec3 viewRayFirst = normalize(viewFirstSide);","vec3 viewRaySecond = normalize(viewSecondSide);","float dot_curr_first = dot(viewRayCurrent,mv_firstNormal);","float dot_opp_first = dot(viewRayOpposite,mv_firstNormal);","float dot_first_first = dot(viewRayFirst,mv_firstNormal);","float dot_curr_second = dot(viewRayCurrent,mv_secondNormal);","float dot_opp_second = dot(viewRayOpposite,mv_secondNormal);","float dot_second_second = dot(viewRaySecond,mv_secondNormal);","if (dot_curr_first*dot_opp_first > 0.0","&& dot_curr_first*dot_first_first > 0.0","&& dot_curr_second*dot_opp_second > 0.0","&& dot_curr_second*dot_second_second > 0.0)","{","if (dot_first_first*dot_second_second < 0.0) return true;","}","return false;","} ","bool isOutlineOrthographic(in vec3 mv_firstNormal, in vec3 mv_secondNormal) {","return mv_firstNormal.z*mv_secondNormal.z < 0.0;","}",].join("\n");d.FS_pars=["uniform sampler2D depthBuffer;","uniform vec2 depthMapSize;","varying vec4 cP;","#ifdef RENDER_TO_FLOAT_TEXTURE","vec4 getNormalDepth(in vec2 coord) {","vec4 res = texture2D( depthBuffer, coord );","vec3 normal = vec3(0.0, 0.0, 1.0);","if (dot(res.xy, res.xy) > 0.000001) {","   normal.z = 2.0 * dot(res.xy, res.xy) - 1.0;","   normal.xy = normalize(res.xy) * sqrt(1.0 - normal.z * normal.z);","}","float depth = res.w;","if (depth < 0.01) depth = 1.0;","return vec4(normal,depth);","}","float getPolygonOffset(in vec2 coord,in vec3 vN, in float depth) {","mat4 P = projectionMatrix;","bool isPersp = P[2][3] == -1.0;","float constFactor = 0.5;","float slopeFactor = isPersp ? 1.0 : 0.1;","vec2 sr = vec2(2.0)/depthMapSize;","vec2 vC = (gl_FragCoord.xy - 0.5) / depthMapSize;","vC = 2.0*vC - 1.0;","float K = dot(vec3(P[1][1] * (vC.x + P[2][0]), P[0][0] * (vC.y + P[2][1]), -P[0][0] * P[1][1]), vN);","vec2 offset = vec2(P[1][1] * vN.x*sr.x, P[0][0] * vN.y*sr.y);","float factor = (-depth - 0.5 * (P[2][2] - 1.0)) / K;","float dFdxOfZ = abs(offset.x * factor);","float dFdyOfZ = abs(offset.y * factor);","float slope = clamp(max(dFdxOfZ, dFdyOfZ), 1e-6, 0.001);","float constantDepthOffset = 9.53674316e-7;","return (slope * slopeFactor) + (constantDepthOffset * constFactor);","}","float getOffsetedDepth(in vec2 coord) {","vec4 nDepth = getNormalDepth(coord);","float offset = getPolygonOffset(coord,nDepth.xyz,nDepth.w);","return nDepth.w + offset;","}","float depthSampleTest(in vec2 coord, in float delta, in float depth) {","float fDepth = getOffsetedDepth(coord);","if ( fDepth < depth ) return delta;","return 0.0;","}","#else","float getDepth(in vec2 coord) {","vec4 rgba_depth = texture2D( depthBuffer, coord );","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth > 1e-6 ? depth + 2.0* DEPTH_PRECISION : 1.0;","}","float depthSampleTest(in vec2 coord, in float delta, in float depth) {","float fDepth = getDepth(coord);","if ( fDepth < depth ) return delta;","return 0.0;","}","#endif","void correctZFighting() {","vec2 coord = 0.5 + 0.5*cP.xy/cP.w;","float depth = 0.5 + 0.5 * cP.z / cP.w;","float delta = 1.0/9.0;","float test = 0.0;","float dx0 =  -0.5/depthMapSize.x;","float dy0 = -0.5/depthMapSize.y;","float dx1 = -dx0;","float dy1 = -dy0;","test += depthSampleTest(coord,delta, depth);","test += depthSampleTest(coord + vec2(dx0,dy0),delta, depth);","test += depthSampleTest(coord.xy + vec2( 0.0, dy0 ),delta, depth);","test += depthSampleTest(coord.xy + vec2( dx1, dy0 ),delta, depth);","test += depthSampleTest(coord.xy + vec2( dx0, 0.0 ),delta, depth);","test += depthSampleTest(coord.xy + vec2( dx1, 0.0 ),delta, depth);","test += depthSampleTest(coord.xy + vec2( dx0, dy1 ),delta, depth);","test += depthSampleTest(coord.xy + vec2( 0.0, dy1 ),delta, depth);","test += depthSampleTest(coord.xy + vec2( dx1, dy1 ),delta, depth);","if (test > 0.8) {","discard;","}","}"].join("\n");d.isOutlineChunk_VS=["float texSharingOffset = normal.z;","float i1 = position.x+texSharingOffset;","float i2 = position.y+texSharingOffset;","float i3 = position.z+texSharingOffset;","float i4 = normal.x+texSharingOffset;","float maxMapTotalSize = MAX_OUTLINE_MAP_SIZE*MAX_OUTLINE_MAP_SIZE;","int texId_1 = int(floor(i1/maxMapTotalSize));","int texId_2 = int(floor(i2/maxMapTotalSize));","int texId_3 = int(floor(i3/maxMapTotalSize));","int texId_4 = int(floor(i4/maxMapTotalSize));","float dx_1, dx_2, dx_3, dx_4;","float dy_1, dy_2, dy_3, dy_4;","float x_1, x_2, x_3, x_4;","float y_1, y_2, y_3, y_4;","float idInTexture_1 = i1 - float(texId_1)*maxMapTotalSize;","float idInTexture_2 = i2 - float(texId_2)*maxMapTotalSize;","float idInTexture_3 = i3 - float(texId_3)*maxMapTotalSize;","float idInTexture_4 = i4 - float(texId_4)*maxMapTotalSize;","if (texId_1 == NB_OUTLINE_MAPS - 1) {","dx_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_1 = floor(idInTexture_1/LAST_OUTLINE_MAP_SIZE_X);","x_1 = idInTexture_1 - y_1*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_1 = floor(idInTexture_1/MAX_OUTLINE_MAP_SIZE);","x_1 = idInTexture_1 - y_1*MAX_OUTLINE_MAP_SIZE;","}","if (texId_2 == NB_OUTLINE_MAPS - 1) {","dx_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_2 = floor(idInTexture_2/LAST_OUTLINE_MAP_SIZE_X);","x_2 = idInTexture_2 - y_2*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_2 = floor(idInTexture_2/MAX_OUTLINE_MAP_SIZE);","x_2 = idInTexture_2 - y_2*MAX_OUTLINE_MAP_SIZE;","}","if (texId_3 == NB_OUTLINE_MAPS - 1) {","dx_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_3 = floor(idInTexture_3/LAST_OUTLINE_MAP_SIZE_X);","x_3 = idInTexture_3 - y_3*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_3 = floor(idInTexture_3/MAX_OUTLINE_MAP_SIZE);","x_3 = idInTexture_3 - y_3*MAX_OUTLINE_MAP_SIZE;","}","if (texId_4 == NB_OUTLINE_MAPS - 1) {","dx_4 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_4 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_4 = floor(idInTexture_4/LAST_OUTLINE_MAP_SIZE_X);","x_4 = idInTexture_4 - y_4*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_4 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_4 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_4 = floor(idInTexture_4/MAX_OUTLINE_MAP_SIZE);","x_4 = idInTexture_4 - y_4*MAX_OUTLINE_MAP_SIZE;","}","vec3 current = texture2D( outlinePositionMaps[texId_1], vec2( dx_1 * ( x_1 + 0.5 ), dy_1 * ( y_1 + 0.5 ) ) ).xyz;","vec3 opposite = texture2D( outlinePositionMaps[texId_2], vec2( dx_2 * ( x_2 + 0.5 ), dy_2 * ( y_2 + 0.5 ) ) ).xyz;","vec3 firstSide = texture2D( outlinePositionMaps[texId_3], vec2( dx_3 * ( x_3 + 0.5 ), dy_3 * ( y_3 + 0.5 ) ) ).xyz;","vec3 secondSide = texture2D( outlinePositionMaps[texId_4], vec2( dx_4 * ( x_4 + 0.5 ), dy_4 * ( y_4 + 0.5 ) ) ).xyz;","vec3 viewCurrent = vec3(modelViewMatrix*vec4(current, 1.0));","vec3 viewOpposite = vec3(modelViewMatrix*vec4(opposite, 1.0));","vec3 viewFirst = vec3(modelViewMatrix*vec4(firstSide, 1.0));","vec3 viewSecond = vec3(modelViewMatrix*vec4(secondSide, 1.0));","float m22 = projectionMatrix[2][2];","float m32 = projectionMatrix[3][2];","isPersp = projectionMatrix[2][3] == -1.0;","if (isPersp) {","near = m32 / (m22 - 1.0);","far = ((m22 - 1.0)*near)/(m22 + 1.0);","} else {","near = (m32+1.0)/m22;","far = near - 2.0/m22;","}","vec4 mvPosition = vec4(viewCurrent, 1.0);","vec3 mvNormal = vec3(0.0,0.0,0.0);","vec3 mv_firstNormal = normalize(vec3(modelViewMatrix*vec4(normalize(cross(opposite-current, firstSide-current)),0.0)));","vec3 mv_secondNormal = normalize(vec3(modelViewMatrix*vec4(normalize(cross(secondSide-current,opposite-current)), 0.0)));","bool isOutline=false;","if (isPersp) {","isOutline = isOutlinePerspective(viewCurrent, viewOpposite, viewFirst, viewSecond, mv_firstNormal, mv_secondNormal);","if (!isOutline) mvPosition.xyz*=(1000000000.0*far);","} else {","isOutline = isOutlineOrthographic(mv_firstNormal, mv_secondNormal);","if (!isOutline) mvPosition.z = 1000000000.0*far;","}"].join("\n");d.SimpleOutlinesShader={vertexShaderPars:[d.VS_pars].join("\n"),vertexShaderBody:[d.isOutlineChunk_VS,"gl_Position = projectionMatrix*mvPosition;","   cP = gl_Position;"].join("\n"),fragmentShaderPars:d.FS_pars,fragmentShaderBody:["gl_FragColor = vec4(0.0,0.0,0.0,1.0);","correctZFighting();",].join("\n"),force:true};d.WideOutlinesShader={vertexShaderPars:["uniform float outlineHalfWidth;","uniform vec2 pixelSize;","varying vec2 screenCurr;","varying vec2 screenOpp;",d.VS_pars,].join("\n"),vertexShaderBody:[d.isOutlineChunk_VS,"if (isOutline) {","float sideExtrusion = normal.y;","bool isOpposite = mod(abs(sideExtrusion), 2.0) == 0.0;","vec4 mvpCurr = projectionMatrix*vec4(viewCurrent,1.0);","vec4 mvpOpp = projectionMatrix*vec4(viewOpposite,1.0);","vec2 testClip = vec2(sign(mvpCurr.w + mvpCurr.z), sign(mvpOpp.w + mvpOpp.z));","if ( testClip.x * testClip.y < 0.0 ){","           float a = (mvpCurr.w + mvpCurr.z)/((mvpCurr.w + mvpCurr.z) - (mvpOpp.w + mvpOpp.z));","           if (testClip.y < 0.0) {","               mvpOpp = (1.0 - a) * mvpCurr + a * mvpOpp;","           } else {","               mvpCurr = (1.0 - a) * mvpCurr + a * mvpOpp;","           }","       }","screenCurr = (mvpCurr.xy / mvpCurr.w + 1.0) / pixelSize;","screenOpp = (mvpOpp.xy / mvpOpp.w + 1.0) / pixelSize;","vec3 ndcCurr = mvpCurr.xyz/mvpCurr.w;","vec3 ndcOpp = mvpOpp.xyz/mvpOpp.w;","float offset = sign(sideExtrusion) * outlineHalfWidth;","vec2 line = normalize(screenOpp - screenCurr);","vec2 lineNormal = vec2(-line.y, line.x);","vec2 px_pos;","px_pos = screenCurr + offset*lineNormal - outlineHalfWidth*line;","vec3 ndcPos = vec3((px_pos*pixelSize - 1.0), mvpCurr.z/mvpCurr.w);","if (isOpposite) {","vec2 tmp = screenCurr;","screenCurr = screenOpp;","screenOpp = tmp;","}","vec4 clipSpacePos = vec4(ndcPos*mvpCurr.w, mvpCurr.w);","gl_Position = clipSpacePos;","cP = mvpCurr;","} else {","gl_Position = projectionMatrix*mvPosition;","}"].join("\n"),fragmentShaderPars:["uniform float outlineHalfWidth;","uniform vec2 pixelSize;","varying vec2 screenCurr;","varying vec2 screenOpp;",d.FS_pars].join("\n"),fragmentShaderBody:["gl_FragColor = vec4(0.0,0.0,0.0,1.0);","correctZFighting();","vec2 fCoord = gl_FragCoord.xy;","vec2 currOpp = screenOpp - screenCurr;","vec2 currFcoord = fCoord - screenCurr;","vec2 oppFcoord = fCoord - screenOpp;","bool toDiscard = false;","if (dot(currOpp, currFcoord ) < 0.0) {","if (length(currFcoord) > outlineHalfWidth) toDiscard = true;","} else if (dot(-currOpp, oppFcoord ) < 0.0) {","if (length(oppFcoord) > outlineHalfWidth) toDiscard = true;","} ","if (toDiscard) discard;",].join("\n"),force:true,forceSide:true};var f=[];var g=a.extend({init:function(k){this._renderable=k;this.indexArray=null;this.firstIndicesArray=null;this.lastIndexArray=null;this._Id=0;this._edgeId=0;this.width=1},createNewGeometry:function(){var m=THREEDS.Core;var l=this.createMaterial();var n=this.createDg(l);var k=new m.BufferGeometryDS();k.drawingGroups=[];n.geometry=k;k.drawingGroups.push(n);k.vertexPositionArray=this.firstIndicesArray;k.vertexNormalArray=this.lastIndexArray;k.vertexIndexArray=this.indexArray;k.boundingSphere=this._renderable.boundingSphere;k.boundingBox=this._renderable.boundingBox;j.TexturesManager.addGeometriesOfRenderable(this._renderable);return k}});var c=g.extend({init:function(k){this._parent(k);this.width=1},initArrays:function(){this.indexArray=[];this.firstIndicesArray=[];this.lastIndexArray=[]},createFinalArrays:function(){this.indexArray=new Uint32Array(this.indexArray);this.firstIndicesArray=new Float32Array(this.firstIndicesArray);this.lastIndexArray=new Float32Array(this.lastIndexArray)},addFullEdgeIndices:function(p,o,n,m){var l=this.indexArray;var r=this.firstIndicesArray;var q=this.lastIndexArray;var k=this._edgeId;r[6*k]=p;r[6*k+1]=o;r[6*k+2]=n;r[6*k+3]=o;r[6*k+4]=p;r[6*k+5]=m;q[6*k]=m;q[6*k+1]=0;q[6*k+2]=0;q[6*k+3]=n;q[6*k+4]=0;q[6*k+5]=0;this._edgeId++},createMaterial:function(){return j.TexturesManager.createSimpleMaterial()},createDg:function(l){var k=this.firstIndicesArray.length/3;var m=new b.DrawingGroup(l,l,1,0,k);m.nonIndexed=true;return m}});var e=g.extend({init:function(l,k){this._parent(l);this.width=k;this.curr_Id=0},initArrays:function(){this.indexArray=[];this.firstIndicesArray=[];this.lastIndexArray=[]},createFinalArrays:function(){this.indexArray=new Uint32Array(this.indexArray);this.firstIndicesArray=new Float32Array(this.firstIndicesArray);this.lastIndexArray=new Float32Array(this.lastIndexArray)},addFullEdgeIndices:function(p,o,n,m){var l=this.indexArray;var r=this.firstIndicesArray;var q=this.lastIndexArray;l[this._Id++]=this.curr_Id;l[this._Id++]=this.curr_Id+1;l[this._Id++]=this.curr_Id+2;l[this._Id++]=this.curr_Id+2;l[this._Id++]=this.curr_Id+1;l[this._Id++]=this.curr_Id+3;this.curr_Id+=4;var k=this._edgeId;r[12*k]=p;r[12*k+1]=o;r[12*k+2]=n;r[12*k+3]=o;r[12*k+4]=p;r[12*k+5]=m;r[12*k+6]=p;r[12*k+7]=o;r[12*k+8]=n;r[12*k+9]=o;r[12*k+10]=p;r[12*k+11]=m;q[12*k]=m;q[12*k+1]=-1;q[12*k+2]=0;q[12*k+3]=n;q[12*k+4]=+2;q[12*k+5]=0;q[12*k+6]=m;q[12*k+7]=+1;q[12*k+8]=0;q[12*k+9]=n;q[12*k+10]=-2;q[12*k+11]=0;this._edgeId++},createMaterial:function(){return j.TexturesManager.createWideMaterial(0.5*this.width)},createDg:function(l){var k=this.indexArray.length;var m=new b.DrawingGroup(l,l,4,0,k);return m}});var j=a.extend({init:function(m,k,l){this._renderable=m;if(k===1){this._oGeometry=new c(m)}else{this._oGeometry=new e(m,k)}if(j.TexturesManager.sortCount!==l){j.TexturesManager.clean();j.TexturesManager.sortCount=l}},computeOutlineGeometry:function(){var S=THREEDS.Core;var I=0;var G=0;var C=0;var D=this._renderable;var s=[];if(!D.layer){s=D.geometry}else{var B={};for(var K=0;K<D.layer.layers.length;K++){var O=D.layer.layers[K].drawableGroup;var R=D.layer.layers[K].drawableInterval;if(R.layerNum<1){continue}B[O.geometry.id]=O.geometry}for(var K in B){s.push(B[K])}s.sort(function(U,k){return U.id-k.id})}this._oGeometry.initArrays();var l=0;var m=0;var o=[];var T=[];for(var K=0;K<s.length;K++){o[K]=l;T[K]=m;l+=s[K].vertexIndexArray.length;m+=s[K].vertexPositionArray.length}var v=f;var H=0;var y=function(U,k,X,W){var Z=s[U].vertexPositionArray;var Y=s[k].vertexPositionArray;var V=0;if(Z[3*X]<Y[3*W]){V=-1}else{if(Z[3*X]>Y[3*W]){V=1}else{if(Z[3*X+1]<Y[3*W+1]){V=-1}else{if(Z[3*X+1]>Y[3*W+1]){V=1}else{if(Z[3*X+2]<Y[3*W+2]){V=-1}else{if(Z[3*X+2]>Y[3*W+2]){V=1}}}}}}return V};var r=function(Z,Y,X,U){var V=y(U,U,Z,Y)>0;if(V){var W=Z;Z=Y;Y=W}var k={i1:Z,i2:Y,i3:X,geomId:U};return k};var q=null;if(!D.layer){var p=s.length;for(var K=0;K<p;K++){var F=s[K];q=F.vertexIndexArray;for(var Q=0;Q<F.drawingGroups.length;Q++){var O=F.drawingGroups[Q];if(O._geomType===S.GeomTypeEnum.FACE){for(var J=O.start;J<O.start+O.count;J+=3){I=q[J];G=q[J+1];C=q[J+2];if(!(I===G||G===C||I===C)){var x=r(I,G,C,K);v[H++]=x;var w=r(G,C,I,K);v[H++]=w;var u=r(C,I,G,K);v[H++]=u}}}}}}else{for(var K=0;K<D.layer.layers.length;K++){var O=D.layer.layers[K].drawableGroup;var R=D.layer.layers[K].drawableInterval;if(R.layerNum<1){continue}if(O._geomType===S.GeomTypeEnum.FACE){var n=s.indexOf(O.geometry);q=O.geometry.vertexIndexArray;for(var J=R.start;J<R.start+R.count;J+=3){I=q[J];G=q[J+1];C=q[J+2];if(!(I===G||G===C||I===C)){var x=r(I,G,C,n);v[H++]=x;var w=r(G,C,I,n);v[H++]=w;var u=r(C,I,G,n);v[H++]=u}}}}}var t=function(W,U){var V=s[W.geomId].vertexPositionArray;var k=s[U.geomId].vertexPositionArray;if(V[3*W.i1]<k[3*U.i1]){return -1}else{if(V[3*W.i1]>k[3*U.i1]){return 1}else{if(V[3*W.i1+1]<k[3*U.i1+1]){return -1}else{if(V[3*W.i1+1]>k[3*U.i1+1]){return 1}else{if(V[3*W.i1+2]<k[3*U.i1+2]){return -1}else{if(V[3*W.i1+2]>k[3*U.i1+2]){return 1}else{if(V[3*W.i2]<k[3*U.i2]){return -1}else{if(V[3*W.i2]>k[3*U.i2]){return 1}else{if(V[3*W.i2+1]<k[3*U.i2+1]){return -1}else{if(V[3*W.i2+1]>k[3*U.i2+1]){return 1}else{if(V[3*W.i2+2]<k[3*U.i2+2]){return -1}else{if(V[3*W.i2+2]>k[3*U.i2+2]){return 1}else{if(W.i1===U.i1){if(W.i2===U.i2){return 0}else{return U.i2-W.i2}}else{return U.i1-W.i1}}}}}}}}}}}}}};if(H===0){return null}v.length=H;var z=v.length;v.sort(t);var K=0;var E=0;var A=0;var M=0;var L=0;var P=null;var N=null;while(K<z-1){P=v[K];N=v[K+1];M=P.geomId;L=N.geomId;E=T[M]/3;if(y(M,L,P.i1,N.i1)===0&&y(M,L,P.i2,N.i2)===0){A=T[L]/3;this._oGeometry.addFullEdgeIndices(E+P.i1,E+P.i2,E+P.i3,A+N.i3);K+=2}else{this._oGeometry.addFullEdgeIndices(E+P.i1,E+P.i2,E+P.i3,E+P.i3);K++}}this._oGeometry.createFinalArrays();return this._oGeometry.createNewGeometry()}});j.halfEdgesArray=[];j.convertOutlineGeometry=function(s,k,z,F){if(j.ConversionMaterialsManager.sortCount!==F){j.ConversionMaterialsManager.clean();j.ConversionMaterialsManager.sortCount=F}var L=THREEDS.Core;var K=null;var p=null;var C=null;var w=0;var H=0;var x=s.vertexPositionArray;var t=s.vertexNormalArray;var I=s.vertexPositionArray.length;var n=0;var m=s.drawingGroups[0].material;var G=0;var D=0;var B=0;var y=0;var v=0;var o=0;var u=0;var l=0;var q=null;var r=0;if(k<z){r=4;n=I/3;G=n/2;w=I*2;H=n*3;K=new Float32Array(w);p=new Float32Array(w);C=new Uint32Array(H);for(var E=0;E<G;E++){C[u++]=l;C[u++]=l+1;C[u++]=l+2;C[u++]=l+2;C[u++]=l+1;C[u++]=l+3;l+=4;D=x[6*E];B=x[6*E+1];y=x[6*E+2];v=t[6*E];o=t[6*E+2];K[12*E]=D;K[12*E+1]=B;K[12*E+2]=y;K[12*E+3]=B;K[12*E+4]=D;K[12*E+5]=v;K[12*E+6]=D;K[12*E+7]=B;K[12*E+8]=y;K[12*E+9]=B;K[12*E+10]=D;K[12*E+11]=v;p[12*E]=v;p[12*E+1]=-1;p[12*E+2]=o;p[12*E+3]=y;p[12*E+4]=+2;p[12*E+5]=o;p[12*E+6]=v;p[12*E+7]=+1;p[12*E+8]=o;p[12*E+9]=y;p[12*E+10]=-2;p[12*E+11]=o}q=j.ConversionMaterialsManager.createWideMaterialFromOther(m,0.5*z)}else{n=s.vertexIndexArray.length;r=1;G=n/6;w=I/2;H=n/3;K=new Float32Array(w);p=new Float32Array(w);for(var E=0;E<G;E++){D=x[12*E];B=x[12*E+1];y=x[12*E+2];v=t[12*E];o=t[12*E+2];K[6*E]=D;K[6*E+1]=B;K[6*E+2]=y;K[6*E+3]=B;K[6*E+4]=D;K[6*E+5]=v;p[6*E]=v;p[6*E+1]=0;p[6*E+2]=o;p[6*E+3]=y;p[6*E+4]=0;p[6*E+5]=o}q=j.ConversionMaterialsManager.createSimpleMaterialFromWide(m)}var J=new b.DrawingGroup(q,q,r,0,H);J.nonIndexed=r===1;var A=new L.BufferGeometryDS();A.drawingGroups=[];J.geometry=A;A.drawingGroups.push(J);A.vertexPositionArray=K;A.vertexNormalArray=p;A.vertexIndexArray=C;A.boundingSphere=s.boundingSphere;A.boundingBox=s.boundingBox;s.dispose();s=null;return A};j.convertWideWidth=function(m,l,o){if(j.ConversionMaterialsManager.sortCount!==o){j.ConversionMaterialsManager.clean();j.ConversionMaterialsManager.sortCount=o}var n=m.drawingGroups[0].material;var k=j.ConversionMaterialsManager.createWideMaterialFromOther(n,0.5*l);m.drawingGroups[0].material=k};j.TexturesManager={sortCount:-1,nbVertices:0,newSimpleMaterial:function(l,k){var n=THREEDS.Core;var m=new n.ShaderMaterialDS(d.SimpleOutlinesShader);m.vertexShaderPars=[n.ShaderChunk.clip_pars_vertex,m.vertexShaderPars].join("\n");m.vertexShaderBody=[m.vertexShaderBody,n.ShaderChunk.clip_vertex].join("\n");m.fragmentShaderPars=[n.ShaderChunk.clip_pars_fragment,m.fragmentShaderPars].join("\n");m.fragmentShaderBody=[n.ShaderChunk.clip_fragment,m.fragmentShaderBody].join("\n");m.update();m.uniforms=n.UniformsUtils.clone(n.UniformsLib.clipPlanes);m.uniforms.outlinePositionMaps={type:"tv",value:k};m.depthTest=false;m.uniforms.depthBuffer={type:"t",value:null};m.uniforms.depthMapSize={type:"v2",value:new n.Vector2(0.01,0.01)};if(l){m.defines={NB_OUTLINE_MAPS:l.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:l.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:l.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:l.LAST_OUTLINE_MAP_SIZE_Y}}else{m.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0}}m.refreshUniforms=function(q,o,p){q.requestDBuffer=true;if(!q.dBuffer){return}this.uniforms.depthBuffer.value=q.dBuffer;this.uniforms.depthMapSize.value=new n.Vector2(q.dBuffer.width,q.dBuffer.height)};m.enableClipPlanes=true;return m},newWideMaterial:function(l,k,o){var n=THREEDS.Core;var m=new n.ShaderMaterialDS(d.WideOutlinesShader);m.vertexShaderPars=[n.ShaderChunk.clip_pars_vertex,m.vertexShaderPars].join("\n");m.vertexShaderBody=[m.vertexShaderBody,n.ShaderChunk.clip_vertex].join("\n");m.fragmentShaderPars=[n.ShaderChunk.clip_pars_fragment,m.fragmentShaderPars].join("\n");m.fragmentShaderBody=[n.ShaderChunk.clip_fragment,m.fragmentShaderBody].join("\n");m.update();m.uniforms=n.UniformsUtils.clone(n.UniformsLib.clipPlanes);m.uniforms.outlinePositionMaps={type:"tv",value:k};m.depthTest=false;m.uniforms.depthBuffer={type:"t",value:null};m.uniforms.depthMapSize={type:"v2",value:new n.Vector2(0.01,0.01)};if(l){m.defines={NB_OUTLINE_MAPS:l.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:l.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:l.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:l.LAST_OUTLINE_MAP_SIZE_Y}}else{m.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0}}m.side=n.DoubleSide;m.uniforms.outlineHalfWidth={type:"f",value:o};m.uniforms.pixelSize={type:"v2",value:new n.Vector2()};m.refreshUniforms=function(r,p,q){m.uniforms.pixelSize.value.x=2/r.domElement.width;m.uniforms.pixelSize.value.y=2/r.domElement.height;r.requestDBuffer=true;if(!r.dBuffer){return}this.uniforms.depthBuffer.value=r.dBuffer;this.uniforms.depthMapSize.value=new n.Vector2(r.dBuffer.width,r.dBuffer.height)};m.enableClipPlanes=true;return m},addGeometriesOfRenderable:function(p){this.isClean=false;var n=p.geometry.length;var q=null;var m=0;if(!p.layer){for(var o=0;o<n;o++){q=p.geometry[o];this.geometriesAssociated.push({renderable:p,geom:q,renderableOffset:this.nbVertices});m+=q.vertexPositionArray.length/3}}else{var s={};var l=[];for(var o=0;o<p.layer.layers.length;o++){var r=p.layer.layers[o].drawableGroup;var k=p.layer.layers[o].drawableInterval;if(k.layerNum<1){continue}s[r.geometry.id]=r.geometry}for(var o in s){l.push(s[o])}for(var o=0;o<l.length;o++){this.geometriesAssociated.push({renderable:p,geom:l[o],renderableOffset:this.nbVertices});m+=l[o].vertexPositionArray.length/3}}this.nbVertices+=m;this._updateTextureDefines()},_updateTextureDefines:function(){var n=this.nbVertices;this.textureDefines.NB_OUTLINE_MAPS=Math.ceil(n/this.maxTextureTotalSize);var o=(n-Math.floor(n/this.maxTextureTotalSize)*this.maxTextureTotalSize);var l=Math.sqrt(o);var m=h(l);var k=h(o/m);this.textureDefines.LAST_OUTLINE_MAP_SIZE_X=m;this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y=k},geometriesAssociated:[],textureDefines:{NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:-1,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0},maxTextureTotalSize:-1,isClean:true,simpleOutlineMaterial:null,wideOutlineMaterials:null,createSimpleMaterial:function(){if(this.simpleOutlineMaterial!==null){return this.simpleOutlineMaterial}var k=this.newSimpleMaterial(null,null);this.simpleOutlineMaterial=k;return k},createWideMaterial:function(l){if(this.wideOutlineMaterials===null){this.wideOutlineMaterials={}}if(this.wideOutlineMaterials[l]){return this.wideOutlineMaterials[l]}var k=this.newWideMaterial(null,null,l);this.wideOutlineMaterials[l]=k;return k},finalize:function(){var H=THREEDS.Core;var r=this.textureDefines.NB_OUTLINE_MAPS;var u=this.maxTextureTotalSize;var x=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X;var v=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y;var z=((r-1)*u+x*v)*3;var s=new Float32Array(z);var p=0;var n=this.geometriesAssociated;var q=n.length;var C=null;var C=null;var B=null;var w=0;var G=null;for(var D=0;D<q;D++){C=n[D].geom;w=n[D].renderableOffset;B=n[D].renderable;s.set(C.vertexPositionArray,p);G=B.outlinesGeometry.geometry;var l=G.vertexNormalArray.length/3;for(var A=0;A<l;A++){G.vertexNormalArray[3*A+2]=w}p+=C.vertexPositionArray.length}var k=[];for(var y=0;y<r-1;y++){var m=new H.DataTexture(s.subarray(y*u*3,(y+1)*u*3),maxTextureSize,maxTextureSize,H.RGBFormat,H.FloatType);m.minFilter=H.NearestFilter;m.magFilter=H.NearestFilter;m.generateMipmaps=false;m.flipY=false;m.needsUpdate=true;k.push(m)}var m=new H.DataTexture(s.subarray((r-1)*u*3,z),x,v,H.RGBFormat,H.FloatType);m.minFilter=H.NearestFilter;m.magFilter=H.NearestFilter;m.generateMipmaps=false;m.flipY=false;m.needsUpdate=true;k.push(m);if(this.simpleOutlineMaterial!==null){this.simpleOutlineMaterial.uniforms.outlinePositionMaps.value=k;this.simpleOutlineMaterial.defines.NB_OUTLINE_MAPS=this.textureDefines.NB_OUTLINE_MAPS;this.simpleOutlineMaterial.defines.MAX_OUTLINE_MAP_SIZE=this.textureDefines.MAX_OUTLINE_MAP_SIZE.toFixed(1);this.simpleOutlineMaterial.defines.LAST_OUTLINE_MAP_SIZE_X=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X.toFixed(1);this.simpleOutlineMaterial.defines.LAST_OUTLINE_MAP_SIZE_Y=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y.toFixed(1)}if(this.wideOutlineMaterials!==null){var E=null;for(var F in this.wideOutlineMaterials){E=this.wideOutlineMaterials[F];E.uniforms.outlinePositionMaps.value=k;E.defines.NB_OUTLINE_MAPS=this.textureDefines.NB_OUTLINE_MAPS;E.defines.MAX_OUTLINE_MAP_SIZE=this.textureDefines.MAX_OUTLINE_MAP_SIZE.toFixed(1);E.defines.LAST_OUTLINE_MAP_SIZE_X=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X.toFixed(1);E.defines.LAST_OUTLINE_MAP_SIZE_Y=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y.toFixed(1)}}},clean:function(){this.isClean=true;this.simpleOutlineMaterial=null;this.wideOutlineMaterials=null;this.nbVertices=0;if(this.textureDefines.MAX_OUTLINE_MAP_SIZE<0){var l=debugWebGLV6Viewer.renderer.renderer.context;var k=l.getParameter(l.MAX_TEXTURE_SIZE);this.textureDefines.MAX_OUTLINE_MAP_SIZE=k;this.maxTextureTotalSize=k*k}this.textureDefines.NB_OUTLINE_MAPS=0;this.textureDefines.LAST_OUTLINE_MAP_SIZE_X=0;this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y=0;this.geometriesAssociated.length=0}};j.ConversionMaterialsManager={sortCount:-1,simpleOutlineMaterials:null,wideOutlineMaterials:null,createSimpleMaterialFromWide:function(n){if(this.simpleOutlineMaterials===null){this.simpleOutlineMaterials={}}var k=n.uniforms.outlinePositionMaps.value;if(this.simpleOutlineMaterials[k[0].id]){return this.simpleOutlineMaterials[k[0].id]}var l=n.defines;var m=j.TexturesManager.newSimpleMaterial(l,k);this.simpleOutlineMaterials[k[0].id]=m;return m},createWideMaterialFromOther:function(n,o){if(this.wideOutlineMaterials===null){this.wideOutlineMaterials={}}var k=n.uniforms.outlinePositionMaps.value;if(!this.wideOutlineMaterials[o]){this.wideOutlineMaterials[o]={}}if(this.wideOutlineMaterials[o][k[0].id]){return this.wideOutlineMaterials[o][k[0].id]}var l=n.defines;var m=j.TexturesManager.newWideMaterial(l,k,o);this.wideOutlineMaterials[o][k[0].id]=m;return m},clean:function(){this.simpleOutlineMaterials=null;this.wideOutlineMaterials=null}};return j});define("Visualization/OutlineBuilder",["DS/Visualization/OutlineBuilder","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/OutlineBuilder");return b});define("DS/Visualization/SessionNodesWithSectionProfile",[],function(){var b=function(){this.nodes=[];this.maxPolyLineSize=0};b.prototype.addNode=function(c){var d=this.nodes[c.id];if(!d){d={polyLineSize:null};this.nodes[c.id]=d}this.updateNode(c)};b.prototype.removeNode=function(c){var d=this.nodes[c.id];if(d){delete this.nodes[c.id];this._updateMax()}};b.prototype.updateNode=function(c){var d=this.nodes[c.id];if(d){if(c.clipPolyLine){d.polyLineSize=c.clipPolyLine.polyLineSize}else{delete this.nodes[c.id]}this._updateMax()}};b.prototype._updateMax=function(){var d;var c=0;for(d in this.nodes){if(this.nodes[d].polyLineSize>c){c=this.nodes[d].polyLineSize}}this.maxPolyLineSize=c};var a=new b();return a});define("DS/Visualization/ProxyAbstraction",["UWA/Class","DS/WAFData/WAFData"],function(b,a){var c=function(){this.useNoProxy=function(d){this.proxyUsage=0;this.server=null;this.sport=null;this.withCredentials=d};this.useProxyDefinedBy=function(e,d){this.proxyUsage=1;this.server=e;this.sport=d};this.useUWAProxy=function(d){this.proxyUsage=2;this.server=null;this.sport=null;this.proxymode=d.proxymode;this.requestsOptions=d.requestsOptions};this.rewriteUrlUsingProxyDef=function(f,g,e){var d=f.indexOf("/");var j=f.indexOf("/",d+2);var h=f.slice(0,d)+"//"+g+":"+e+f.slice(j,f.length);return h};this.executeGetHttpRequest=function(e,j,l,k,g,d){var h=function(p,o){return function(q){if(p){p({url:o,type:"LOAD",responseCode:q})}}}(g,e);if(this.proxyUsage===2){var n=this.requestsOptions||{};n.headers=n.headers||new Object();if(d){n.headers.Accept=d}if(n.data){n.data.GET=n.data.GET||l}n.method=n.method||"GET";n.timeout=3600000;n.async=true;n.onComplete=k;n.onFailure=function(o){var r=o.message.split('"');var q=null;for(var p=0;p<(r.length-1);p++){if(r[p].search("return ResponseCode with value")!=-1){q=parseInt(r[p+1])}}if(q){h(q)}},n.onTimeout=function(o){h(408)},n.type=j;if(n.proxymode){n.authentication=n.proxymode}var f=a.handleRequest(e,n)}else{if(this.proxyUsage===1){e=this.rewriteUrlUsingProxyDef(e,this.server,this.sport)}var m=new XMLHttpRequest();m.open("GET",e,true);m.onload=function(p){var o=m.status;if((o===200)||((o===0)&&(this.response&&this.response.byteLength>0))){k(this.response)}else{h(o)}};m.onerror=function(o){h(m.status)};m.ontimeout=function(o){h(408)};m.timeout=3600000;m.setRequestHeader("X-Requested-With","XMLHttpRequest");if(this.withCredentials){m.withCredentials=true}if(j==="arraybuffer"){m.responseType=j}if(j==="blob"){m.responseType=j}m.send(l)}}};return c});define("DS/Visualization/StreamVisuLoader",["DS/VisuLoaders/StreamVisuLoader"],function(a){return a});define("Visualization/StreamVisuLoader",["DS/Visualization/StreamVisuLoader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/StreamVisuLoader");return b});define("DS/Visualization/OccurrenceInterfaceFactory",["UWA/Class"],function(a){var b=a.extend({init:function(c,d){this._occurrenceExplorer=c;this.viewer=d},getOccurrenceItf:function(c){var d=c._getUniqueOccurrence(this.viewer);if(d){return this._occurrenceExplorer.getOccurrenceInterface(d)}else{return null}},getOccurrenceItfMulti:function(e){var f=e._getOccurrences(this.viewer);var c=[];var d;for(d=0;d<f.length;d++){c.push(this._occurrenceExplorer.getOccurrenceInterface(f[d]))}return c},getUserRootOccurrenceItf:function(){var c=this.viewer.internalSceneGraph.userRoot._occurrences[0];return this._occurrenceExplorer.getOccurrenceInterface(c)}});return b});define("DS/Visualization/RenderPriorityManager",["UWA/Class","DS/Plugins/RenderPass","DS/Plugins/ClearPass"],function(b,a,d){var c=b.extend({init:function(e){this.viewer=e;this.enabled=false;this.passes=this._createPasses(e)},setEnabled:function(e){e=e?true:false;if(this.enabled!==e){this.enabled=e;this._enablePasses(this.enabled);this.viewer.internalSceneGraph.root._forceUpdate()}},_enablePasses:function(e){if(this.passes){var g=this.viewer;if(e){var f;for(f=0;f<this.passes.length;f++){g.renderer.mainComposer.addPass(this.passes[f])}}else{g.renderer.mainComposer.removePasses(this.passes)}}},_createPasses:function(l){var j=[];var e=new d("renderPriorityClear");e.defaults.clear=false;e.setClearStencil(true);e.clearStencilValue=0;e.idString="renderPriority";j.push(e);var f=4;var h,k,g;for(h=0;h<=f;h++){k=new a(null,null,null,null,null,null,"renderPriorityStencilP"+h);k.idString="p"+h;k.stencilRef=h;k.enableStencilTest=true;k.setStencilFunc("GEQUAL");k.setStencilOps("REPLACE","REPLACE");k.setEnableStencilWrite(true);j.push(k);if(h!==f){g=new a(null,null,null,null,null,null,"renderPriorityDrawP"+h);g.idString="p"+h;g.stencilRef=h;g.enableStencilTest=true;g.setStencilFunc("LESS");g.setStencilOps("KEEP","KEEP");g.useRenderPriorityOpacity=true;g.setEnableStencilWrite(false);j.push(g)}}return j}});return c});define("DS/Visualization/AmbianceGenerator",["DS/CoreEvents/Events","UWA/Class","DS/Effects/ConvertLatLongToDualParaboloid","DS/Effects/GenerateMipMaps","DS/Effects/ComputeMipMapRoughness","DS/Visualization/ThreeJS_R57"],function(d,b,c,g,a,k){var j=b.extend({init:function(l,n){this.viewers=k._AmbianceGenerators.viewers;this.nbSamples=n;this.onDoneCallBack=null;k.EventDispatcher.call(this);this.finished=false;var m=this;this.addEventListener("done",function(o){if(o.isDone){m.viewers.forEach(function(p){p.render()})}if(o.isDone){console.log("INFO: Finished computing ambiance")}if(m.onDoneCallBack&&o.isDone){m.onDoneCallBack()}});this.renderer=l.renderer.renderer;this.convertEffect=new c(this.renderer,l.renderer.renderTargetPool);this.mipMapEffect=new g(this.renderer,l.renderer.renderTargetPool);this.computeEffect=null;this.frameIndex=0;this.init=false},dispose:function(){this.convertEffect.dispose();this.convertEffect=null;this.mipMapEffect.dispose();this.mipMapEffect=null;this.computeEffect.dispose();this.computeEffect=null;this.init=false},_setNbSamples:function(){console.warn("A virtual function has been called")},setValues:function(m,o){if(m){var n=m.composerContext&&m.composerContext.width;var l=m.composerContext&&m.composerContext.height;if(m instanceof k.Texture){n=m.image.width;l=m.image.height}this.convertEffect.setSize(n,l);this.mipMapEffect.setSize(n,l);this.computeEffect.setSize(n,l);this.convertEffect.setEnvMap(m);this.mipMapEffect.setInput(this.convertEffect.composers[1]);this.computeEffect.setInput(this.mipMapEffect.composers[this.mipMapEffect.nbIterations]);this._setNbSamples();this.computeEffect.setMode(o);this.init=true}},_execute:function(){if(this.init){this.convertEffect.execute();this.mipMapEffect.execute();this.computeEffect.execute();this.computeEffect.encodeRGBE()}},_getResult:function(){if(!this.init){return{}}var m=this.isDone();var l=this.computeEffect.saveComposer.composerContext.getResult(undefined,m);if(l){l.hdr=true;l.hasDiffuse=this.computeEffect.modeValue===0;l.mapping=new k.LatLongReflectionMapping()}return l},setCallBack:function(l){this.onDoneCallBack=l},isDone:function(){return this.finished},});var h=j.extend({init:function(l,m){this._parent(l,m);this.computeEffect=new a.ComputeMipMapRoughnessFIS(this.renderer,l.renderer.renderTargetPool)},execute:function(){var l=Date.now();this._execute();this.finished=true;this.dispatchEvent({type:"done",time:l,isDone:this.isDone()});return this._getResult()},_setNbSamples:function(){this.computeEffect.setNbSamples(this.nbSamples)}});var f=j.extend({init:function(l,m){this._parent(l,m);this.computeEffect=new a.ComputeMipMapRoughnessIterative(this.renderer,l.renderer.renderTargetPool)},_isExecuteReady:function(m){var l=true;this.viewers.forEach(function(n){l=l&&(n.renderIteration>0&&(m-n.timeIter0>n.delayBeforeIteration))});return l},execute:function(){var m=Date.now();var l=this.computeEffect.iter===0||this._isExecuteReady(m);if(l){this._execute();this.finished=this.computeEffect.iter>=this.computeEffect.nbIterations;this.dispatchEvent({type:"done",time:m,iteration:this.computeEffect.iter,isDone:this.isDone()})}return this._getResult()},_setNbSamples:function(){this.computeEffect.setNbSamples(this.nbSamples)}});var e=b.extend({init:function(l){this.generators=new Map();this.generated=new Map();this.toCompute=[];this.viewers=k._AmbianceGenerators.viewers;this.cb=l},_getViewer:function(){return this.viewers[0]},_getGenerator:function(l,m){if(m){l+="-iterative"}if(!this.generators.has(l)){var o=this._getViewer();var n=m?new f(o,o.ODTMode?256:2048):new h(o,o.ODTMode?256:1024);if(this.cb){n.setCallBack(this.cb)}this.generators.set(l,n)}return this.generators.get(l)},_getAmbiance:function(l,m){if(m){l+="-iterative"}return this.generated.get(l)},_updateAmbiance:function(o,n,p,l,m){if(p){n+="-iterative"}this.generated.set(n,{ambiance:o,complete:l,usedBy:m})},_disposeGenerator:function(l,m){if(m){l+="-iterative"}if(this.generators.has(l)){var n=this.generators.get(l);this.generators["delete"](l);n.dispose()}},_setCB:function(l){this.cb=l;this.generators.forEach(function(n,m,o){n.setCallBack(l)})},getAmbiance:function(l,o,p,q){var n=l;if(o){l+="-iterative"}if(!this.generated.has(l)){this.generated.set(l,{ambiance:null,complete:false,usedBy:new Set()});this.toCompute.push({name:n,iterative:o,hdr:p.hdr,brdf:p.brdf})}var m=this.generated.get(l);m.usedBy.add(q);return m},decreaseUseCount:function(l){this.generated.forEach(function(n,m,o){n.usedBy["delete"](l);if((n.usedBy.size<1)&&(n.ambiance)){n.ambiance.dispose();o["delete"](m)}})},dispose:function(){this.generated.forEach(function(m,l,n){if(m.ambiance){m.ambiance.dispose()}});this.generated.clear();this.generators.forEach(function(m,l,n){m.dispose()});this.generators.clear()},update:function(l,s){var p=this.toCompute;var t=0;for(var o=0;o<p.length;o++){var n=p[o];var q=this._getAmbiance(n.name,n.iterative);if(!q||q.complete){this._disposeGenerator(n.name,n.iterative);t++;continue}var r=this._getGenerator(n.name,n.iterative);if(!r.init){r.setValues(n.hdr,n.brdf)}if(r.renderer===s&&r.frameIndex<l&&!r.isDone()){var m=r.execute();this._updateAmbiance(m,n.name,n.iterative,r.isDone(),q.usedBy);r.frameIndex=l;if(r.isDone()){this._disposeGenerator(n.name,n.iterative);t++}}}if(t===p.length){this.toCompute=[];this.generators.clear()}this.viewers.forEach(function(u){u.forceRender=true})},});return e});define("DS/Visualization/DAEReader",["DS/VisuLoaders/DAEReader"],function(a){return a});define("Visualization/DAEReader",["DS/Visualization/DAEReader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/DAEReader");return b});define("DS/Visualization/ThreeJS_DS",["UWA/Class","DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh","DS/Shaders/DeferredShaders","DS/Shaders/AdvancedHighlightShader","DS/Shaders/AdvancedPreHighlightShader","DS/Shaders/AdvancedHighlightShaderSinglePass"],function(a,j,d,b,g,k,f){j.mobileVersion=false;if(!window.webVisuPerfo){window.webVisuPerfo={startPerfo:function(){},endPerfo:function(){}}}var h=j.Constants;j.Matrix4.prototype.equals=function(l,n){var q=this.elements;var p=l.elements;if(n===undefined){for(var o=0;o<16;o++){if(q[o]!==p[o]){return false}}}else{for(var o=0;o<16;o++){if(Math.abs(q[o]-p[o])>n){return false}}}return true};j.Matrix4.prototype.setRotation=function(l){var m=this.elements;m[0]=l[0];m[4]=l[1];m[8]=l[2];m[1]=l[3];m[5]=l[4];m[9]=l[5];m[2]=l[6];m[6]=l[7];m[10]=l[8];return this};j.Quaternion.prototype.toEuler=function(){var l=new j.Vector3();l.x=Math.atan2(2*(this.w*this.x+this.y*this.z),1-2*(this.x*this.x+this.y*this.y));l.y=Math.asin(2*(this.w*this.y-this.z*this.x));l.z=Math.atan2(2*(this.w*this.z+this.x*this.y),1-2*(this.y*this.y+this.z*this.z));return l};j.BoundingSphere=function(m,l,n){j.Sphere.call(this,m,l);this.state=0;n&&this.setState(n)};j.BoundingSphere.prototype=Object.create(j.Sphere.prototype);j.BoundingSphere.prototype.states=["EMPTY","NORMAL","INFINITE"];j.BoundingSphere.prototype.setState=function(l){this.state=this.states.indexOf(l)};j.BoundingSphere.prototype.getState=function(){return this.states[this.state]};j.Box3.prototype.getPlanes=function(){var o=new j.Vector3();var n=new j.Vector3();var l=null;var m=[];o.set(this.min.x,this.max.y,this.min.z);n.set(this.min.x,this.min.y,this.max.z);l=new j.Plane();l.setFromCoplanarPoints(this.min,n,o);m.push(l);o.set(this.max.x,this.min.y,this.min.z);l=new j.Plane();l.setFromCoplanarPoints(this.min,o,n);m.push(l);n.set(this.min.x,this.max.y,this.min.z);l=new j.Plane();l.setFromCoplanarPoints(this.min,n,o);m.push(l);o.set(this.max.x,this.max.y,this.min.z);n.set(this.max.x,this.min.y,this.max.z);l=new j.Plane();l.setFromCoplanarPoints(this.max,n,o);m.push(l);n.set(this.min.x,this.max.y,this.max.z);l=new j.Plane();l.setFromCoplanarPoints(this.max,o,n);m.push(l);o.set(this.max.x,this.min.y,this.max.z);l=new j.Plane();l.setFromCoplanarPoints(this.max,n,o);m.push(l);return m};j.Frustum.__v2=new j.Vector3();j.Frustum.prototype.intersectsObject=function(n,s,q){var l,p=this.planes,u=n._getMMMatrix(),t=n.geometry.boundingSphere,r=-t.radius*u.getMaxScaleOnAxis(),m=j.Frustum.__v2;if(t!==null){m.copy(t.center)}else{m.set(0,0,0)}m.applyMatrix4(u);for(var o=0;o<6;o++){l=p[o].distanceToPoint(m);if(l<=r){return false}}return true};j.Frustum.prototype.performFrustumCulling=function(l,o){var p=this.planes;var s=0;var n=-l;var m=null;var r=null;for(var q=0;q<6;q++){m=p[q];r=m.normal;s=r.x*o.x+r.y*o.y+r.z*o.z+m.constant;if(s<=n){return false}}return true};j.Frustum.prototype.performFrustumCullingNoNearFar=function(l,o){var p=this.planes;var s=0;var n=-l;var m=null;var r=null;for(var q=0;q<4;q++){m=p[q];r=m.normal;s=r.x*o.x+r.y*o.y+r.z*o.z+m.constant;if(s<=n){return false}}return true};j.Frustum.prototype.getCorners=function(){var m=[];var n=new j.Matrix4();var l=new j.Matrix4();var p=this;function o(t,s,r){var w=p.planes[t];var v=p.planes[s];var u=p.planes[r];n.set(w.normal.x,w.normal.y,w.normal.z,0,v.normal.x,v.normal.y,v.normal.z,0,u.normal.x,u.normal.y,u.normal.z,0,0,0,0,1);l.getInverse(n);var q=new j.Vector4().set(-w.constant,-v.constant,-u.constant,1);q.applyMatrix4(l);return q}m[0]=o(1,2,5);m[1]=o(0,2,5);m[2]=o(0,3,5);m[3]=o(1,3,5);m[4]=o(1,2,4);m[5]=o(0,2,4);m[6]=o(0,3,4);m[7]=o(1,3,4);return m};j.CGPolygon=function(){this.corner=[]};j.CGPolygon.prototype={constructor:j.CGPolygon,clone:function(n){var l=n?n:new j.CGPolygon();l.empty();for(var m=0;m<this.corner.length;m++){l.addPoint(this.corner[m])}return l},empty:function(){this.corner=[]},applyMatrix4:function(l){for(var m=0;m<this.corner.length;m++){this.corner[m].applyMatrix4(l)}return this},addPoint:function(l){this.corner.push(new j.Vector3().copy(l));return this},addPoints:function(l){this.corner=l;return this},addPointAtIndex:function(m,l){this.corner[m]=new j.Vector3();this.corner[m].copy(l);return this},clipByPlane:function(r,q){var s=new j.CGPolygon();var m=this.corner.length;if(m<3){return s}var t=[];for(var p=0;p<m;p++){t[p]=(r.distanceToPoint(this.corner[p])>0)}for(var p=0;p<m;p++){var o=(p+1)%m;if(t[p]&&t[o]){continue}if(t[p]){var n=new j.Vector3();var l=new j.Line3(this.corner[p],this.corner[o]);if(r.intersectLine(l,n)!==undefined){q.addPoint(n);s.addPoint(n)}q.addPoint(this.corner[o]);continue}if(t[o]){var n=new j.Vector3();var l=new j.Line3(this.corner[p],this.corner[o]);if(r.intersectLine(l,n)!==undefined){q.addPoint(n);s.addPoint(n)}continue}q.addPoint(this.corner[o])}if(s.corner.length&&(s.corner.length!==2)){this.clone(q);s.empty()}return s}};j.CGPoly=function(){this.polygon=[];return this};j.CGPoly.prototype={constructor:j.CGPoly,addPolygon:function(l){this.polygon.push(l)},removePolygon:function(l){if(l>=this.polygon.length||l<0){console.log("CGPoly: trying to remove a polygon which does not exist !");return}this.polygon.splice(l,1)},empty:function(){this.polygon=[]},clone:function(n){var l=n?n:new j.CGPoly();l.empty();for(var m=0;m<this.polygon.length;m++){l.addPolygon(this.polygon[m].clone())}return l},applyMatrix4:function(l){for(var m=0;m<this.polygon.length;m++){this.polygon[m].applyMatrix4(l)}return this},setFromBox:function(m){var l=new j.CGPolygon();l.addPoint(new j.Vector3().copy(m.min));l.addPoint(new j.Vector3(m.min.x,m.min.y,m.max.z));l.addPoint(new j.Vector3(m.min.x,m.max.y,m.max.z));l.addPoint(new j.Vector3(m.min.x,m.max.y,m.min.z));this.addPolygon(l);l=new j.CGPolygon();l.addPoint(new j.Vector3().copy(m.min));l.addPoint(new j.Vector3(m.min.x,m.max.y,m.min.z));l.addPoint(new j.Vector3(m.max.x,m.max.y,m.min.z));l.addPoint(new j.Vector3(m.max.x,m.min.y,m.min.z));this.addPolygon(l);l=new j.CGPolygon();l.addPoint(new j.Vector3().copy(m.min));l.addPoint(new j.Vector3(m.max.x,m.min.y,m.min.z));l.addPoint(new j.Vector3(m.max.x,m.min.y,m.max.z));l.addPoint(new j.Vector3(m.min.x,m.min.y,m.max.z));this.addPolygon(l);var l=new j.CGPolygon();l.addPoint(new j.Vector3().copy(m.max));l.addPoint(new j.Vector3(m.max.x,m.min.y,m.max.z));l.addPoint(new j.Vector3(m.max.x,m.min.y,m.min.z));l.addPoint(new j.Vector3(m.max.x,m.max.y,m.min.z));this.addPolygon(l);var l=new j.CGPolygon();l.addPoint(new j.Vector3().copy(m.max));l.addPoint(new j.Vector3(m.max.x,m.max.y,m.min.z));l.addPoint(new j.Vector3(m.min.x,m.max.y,m.min.z));l.addPoint(new j.Vector3(m.min.x,m.max.y,m.max.z));this.addPolygon(l);var l=new j.CGPolygon();l.addPoint(new j.Vector3().copy(m.max));l.addPoint(new j.Vector3(m.min.x,m.max.y,m.max.z));l.addPoint(new j.Vector3(m.min.x,m.min.y,m.max.z));l.addPoint(new j.Vector3(m.max.x,m.min.y,m.max.z));this.addPolygon(l)},setFromFrustumPoints:function(n){var m=new j.CGPolygon();for(var l=0;l<4;l++){m.addPoint(new j.Vector3().copy(n[l]))}this.addPolygon(m);m=new j.CGPolygon();for(var l=4;l<8;l++){m.addPointAtIndex(l-4,new j.Vector3().copy(n[11-l]))}this.addPolygon(m);m=new j.CGPolygon();m.addPoint(n[0]);m.addPoint(n[3]);m.addPoint(n[7]);m.addPoint(n[4]);this.addPolygon(m);m=new j.CGPolygon();m.addPoint(n[1]);m.addPoint(n[5]);m.addPoint(n[6]);m.addPoint(n[2]);this.addPolygon(m);m=new j.CGPolygon();m.addPoint(n[4]);m.addPoint(n[5]);m.addPoint(n[1]);m.addPoint(n[0]);this.addPolygon(m);m=new j.CGPolygon();m.addPoint(n[6]);m.addPoint(n[7]);m.addPoint(n[3]);m.addPoint(n[2]);this.addPolygon(m)},clipByPlane:function(v){var s,q;var n=new j.CGPoly();var r=new j.CGPoly();for(s=0;s<this.polygon.length;s++){var m=new j.CGPolygon();var A=this.polygon[s].clipByPlane(v,m);if(m.corner.length){n.addPolygon(m);if(A.corner.length&&(A.corner.length===2)){r.addPolygon(A)}else{if(A.corner.length>0){console.log("plane / polygon intersection is not a segment : "+A.corner.length+" points")}}}}if(r.polygon.length>=3){var t=new j.CGPolygon();var y=r.polygon[r.polygon.length-1];t.addPoint(y.corner[0]);t.addPoint(y.corner[1]);r.removePolygon(r.polygon.length-1);while(r.polygon.length>0){var l=t.corner[t.corner.length-1];var B=0.0001;var w=Infinity;var p=-1;var o=-1;for(s=0;s<r.polygon.length;s++){var u=r.polygon[s];if(u.corner.length===2){for(q=0;q<u.corner.length;q++){var z=u.corner[q];var x=z.distanceToSquared(l);if(x<B){break}if(x<w){w=x;p=s;o=q}}if(q<u.corner.length){t.addPoint(u.corner[(q+1)%2]);break}}else{console.log("convex hull clipping : intersection segment has length > 2")}}if(s<r.polygon.length){r.removePolygon(s)}else{if(p>=0){t.addPoint(r.polygon[p].corner[(o+1)%2]);r.removePolygon(p)}else{console.log("failed to build the intersection polygon btw polyhedra and plane");break}}}t.corner.splice(t.corner.length-1,1);n.addPolygon(t)}return n},clipByPlanes:function(l){if(!l.length){return null}var n=this.clipByPlane(l[0]);for(var m=1;m<l.length;m++){n=n.clipByPlane(l[m])}return n},clipByBox:function(n){var l=n.getPlanes();var o=this.clipByPlane(l[0]);for(var m=1;m<6;m++){o=o.clipByPlane(l[m])}return o},getPoints:function(){var n,m,l,o=[];for(m=0;m<this.polygon.length;m++){n=this.polygon[m];for(l=0;l<n.corner.length;l++){o.push(n.corner[l])}}return o}};j.CGPolyHelper=function(n){j.Line.call(this);var m=this;this.frustumCulled=false;this.geometry=new j.Geometry();this.material=new j.LineBasicMaterial({color:16777215,vertexColors:j.FaceColors});this.type=j.LinePieces;this.matrixWorld=new j.Matrix4();this.matrixAutoUpdate=false;for(var l=0;l<1000;l++){this.geometry.vertices.push(new j.Vector3());this.geometry.colors.push(new j.Color(16711680))}this.update(n,new j.Color(16711680))};j.CGPolyHelper.prototype=Object.create(j.Line.prototype);j.CGPolyHelper.prototype.update=function(l,m){var p=0;var o;for(o=0;o<l.polygon.length;o++){var r=l.polygon[o];var t=r.corner.length;for(var n=0;n<t;n++){var s=r.corner[n];this.geometry.vertices[p].copy(s);this.geometry.colors[p].copy(m);p++;s=r.corner[(n+1)%t];this.geometry.vertices[p].copy(s);this.geometry.colors[p].copy(m);p++}}var q=(p>0)?this.geometry.vertices[p-1]:new j.Vector3();for(o=p;o<1000;o++){this.geometry.vertices[o].copy(q);this.geometry.colors[o].copy(m)}this.geometry.verticesNeedUpdate=true;this.geometry.colorsNeedUpdate=true};j.Camera.prototype.clone=function(l){if(l===undefined){l=new j.Camera()}j.Object3D.prototype.cloneSimple.call(this,l);l.matrixWorldInverse.copy(this.matrixWorldInverse);l.projectionMatrix.copy(this.projectionMatrix);l.projectionMatrixInverse.copy(this.projectionMatrixInverse);l._viewpoint=this._viewpoint;l.pixelCulling=this.pixelCulling;return l};j.OrthographicCamera.prototype.clone=function(l){if(l===undefined){l=new j.OrthographicCamera()}j.Camera.prototype.clone.call(this,l);if(this.fullWidth){l.fullWidth=this.fullWidth;l.fullHeight=this.fullHeight;l.x=this.x;l.y=this.y;l.width=this.width;l.height=this.height}else{if(l.fullWidth){delete (l.fullWidth)}if(l.fullHeight){delete (l.fullHeight)}}l.left=this.left;l.right=this.right;l.top=this.top;l.bottom=this.bottom;l.near=this.near;l.far=this.far;if(this.visualizedHeight){l.visualizedHeight=this.visualizedHeight}l.updateProjectionMatrix();return l};j.OrthographicCamera.prototype.setVisualizedHeight=function(n,m,l){this.fov=l?l:(this.fov?this.fov:45);this.visualizedHeight=n?2*n*Math.tan(Math.PI*this.fov/(180*2)):(this.visualizedHeight?this.visualizedHeight:400);this.aspect=m?m:(this.aspect?this.aspect:1);this.top=this.visualizedHeight/2;this.bottom=-this.top;this.left=this.aspect*this.bottom;this.right=-this.left;this.updateProjectionMatrix()};j.PerspectiveCamera.prototype.clone=function(l){if(l===undefined){l=new j.PerspectiveCamera()}j.Camera.prototype.clone.call(this,l);l.fov=this.fov;l.aspect=this.aspect;l.near=this.near;l.far=this.far;l.externalProjectionMatrix=this.externalProjectionMatrix;if(this.fullWidth){l.fullWidth=this.fullWidth;l.fullHeight=this.fullHeight;l.x=this.x;l.y=this.y;l.width=this.width;l.height=this.height}else{if(l.fullWidth){delete (l.fullWidth)}if(l.fullHeight){delete (l.fullHeight)}}l.updateProjectionMatrix();return l};j.Material_backup=j.Material;j.DeferredMaterial=function(l){this.material=l;this.usedBy=new Set()};j.DeferredMaterial.prototype.get=function(l){this.usedBy.add(l.id);return this.material};j.cleanDeferredCache=function(n){var l=[j.DefaultNormalDepthMaterials,j.DefaultShadowDepthMaterials,j.DefaultPickingMaterials,j.DefaultHighlightMaterials,j.DefaultMaterials];for(var m=0;m<l.length;m++){l[m].forEach(function(r,q,s){r.usedBy["delete"](n);if(r.usedBy.size<1){if(r.material.dispose){r.material.dispose()}else{var p,o;for(p in r.material){o=r.material[p];if(o&&o.dispose){o.dispose()}}}s["delete"](q)}})}};j.Material=function(){j.Material_backup.call(this);this._rendererId=-1;this._deferredMaterialsInit=false;this._deferredMaterials=[];for(var l=0;l<j.MaterialToUse.totalMaterial;l++){this._deferredMaterials[l]=null}this._deferredMaterials[j.MaterialToUse.originalMaterial]=this};j.Material.prototype=j.Material_backup.prototype;j.Material.prototype.updateGenericDeferredMaterials=function(o){var r=this._deferredMaterials[j.MaterialToUse.normalMaterial];r.force=true;r.wireframe=this.wireframe;r.vertexColors=this.vertexColors;r.attributes=Object.assign(r.attributes?r.attributes:{},this.attributes);this.copySkinningParameters(r);this.copyPDSFXParameters(r);var n=this._deferredMaterials[j.MaterialToUse.depthMaterial];n.force=true;n.wireframe=this.wireframe;n.vertexColors=this.vertexColors;n.attributes=Object.assign(n.attributes?n.attributes:{},this.attributes);this.copySkinningParameters(n);this.copyPDSFXParameters(n);var l=this._deferredMaterials[j.MaterialToUse.normalDepthMaterial];if(this.reflectionCoef&&this.reflectionCoef>0){l.uniforms.reflectionCoef={type:"f",value:this.reflectionCoef}}l.force=true;l.wireframe=this.wireframe;l.vertexColors=this.vertexColors;l.attributes=Object.assign(l.attributes?l.attributes:{},this.attributes);this.copySkinningParameters(l);this.copyPDSFXParameters(l);var w=this._deferredMaterials[j.MaterialToUse.shadowMapDepthMaterial];w.force=true;w._shadowPass=true;w.wireframe=this.wireframe;w.vertexColors=this.vertexColors;w.attributes=Object.assign(w.attributes?w.attributes:{},this.attributes);this.copySkinningParameters(w);this.copyPDSFXParameters(w);var t=this._deferredMaterials[j.MaterialToUse.highlightMaterial];if(j.mobileVersion){t.useBlending=true;t.blending=j.CustomBlending2;t.depthTest=false;t.depthWrite=false}t.attributes=Object.assign(t.attributes?t.attributes:{},this.attributes);if(t.line){t.line.attributes=Object.assign(t.line.attributes?t.line.attributes:{},this.attributes)}if(t.point){t.point.attributes=Object.assign(t.point.attributes?t.point.attributes:{},this.attributes)}this.copySkinningParameters(t);this.copyPDSFXParameters(t);if(!j.mobileVersion){var m=this._deferredMaterials[j.MaterialToUse.outlineHighlightMaterial];m.attributes=Object.assign(m.attributes?m.attributes:{},this.attributes);if(m.line){m.line.attributes=Object.assign(m.line.attributes?m.line.attributes:{},this.attributes)}if(m.point){m.point.attributes=Object.assign(m.point.attributes?m.point.attributes:{},this.attributes)}this.copySkinningParameters(m);this.copyPDSFXParameters(m)}var u=this._deferredMaterials[j.MaterialToUse.preHighlightMaterial];u.attributes=Object.assign(u.attributes?u.attributes:{},this.attributes);if(u.line){u.line.attributes=Object.assign(u.line.attributes?u.line.attributes:{},this.attributes)}if(u.point){u.point.attributes=Object.assign(u.point.attributes?u.point.attributes:{},this.attributes)}this.copySkinningParameters(u);this.copyPDSFXParameters(u);var v=this._deferredMaterials[j.MaterialToUse.pickingMaterial];var p=this._deferredMaterials[j.MaterialToUse.pickingMaterialInstancing];if(this.isInstancingMaterial&&p){p.attributes=Object.assign(p.attributes?p.attributes:{},this.attributes);p.force=true;p.transparent=this.transparent;this.copySkinningParameters(p);this.copyPDSFXParametersPicking(p)}v.attributes=Object.assign(v.attributes?v.attributes:{},this.attributes);v.force=true;v._picking=true;this.copySkinningParameters(v);this.copyPDSFXParametersPicking(v);if(this.backMaterial&&!this.backMaterial._deferredMaterialsInit){this.backMaterial.updateDeferredMaterials();this._deferredMaterials[j.MaterialToUse.pickingMaterial]=this._deferredMaterials[j.MaterialToUse.pickingMaterial].clone();this._deferredMaterials[j.MaterialToUse.pickingMaterial].backMaterial=this.backMaterial._deferredMaterials[j.MaterialToUse.pickingMaterial]}var s=this instanceof j.ParticleBasicMaterial;if(!s){this._deferredMaterials[j.MaterialToUse.oitAccumMaterial]=this;this._deferredMaterials[j.MaterialToUse.oitRevealMaterial]=this}this._deferredMaterials[j.MaterialToUse.ZOnlyMaterial]=this.getZOnlyMaterial();if(o&&o.gasLook){this.updateGasLookMaterial()}for(var q=0;q<j.MaterialToUse.totalMaterial;q++){var x=this._deferredMaterials[q];if(x!==null){x.isBackMaterial=this.isBackMaterial}}this._deferredMaterialsInit=true};j.Material.prototype.updateDeferredMaterials=function(p){this._deferredMaterials[j.MaterialToUse.normalMaterial]=this.getNormalMaterial();this._deferredMaterials[j.MaterialToUse.depthMaterial]=this.getDepthMaterial();this._deferredMaterials[j.MaterialToUse.normalDepthMaterial]=this.getNormalDepthMaterial();this._deferredMaterials[j.MaterialToUse.shadowMapDepthMaterial]=this.getShadowDepthMaterial();this._deferredMaterials[j.MaterialToUse.highlightMaterial]=j.mobileVersion?this.getHighlightMaterial("HighlightMobile"):this.getHighlightMaterial("Highlight");if(!j.mobileVersion){var o=this.getHighlightMaterial("OutlineHighlight");this._deferredMaterials[j.MaterialToUse.outlineHighlightMaterial]=o}this._deferredMaterials[j.MaterialToUse.preHighlightMaterial]=this.getHighlightMaterial("PreHighlight");var l=this.getPickingMaterial();var n=l.pickingMaterial;var m=l.pickingMaterialInstancing;this._deferredMaterials[j.MaterialToUse.pickingMaterialInstancing]=m;this._deferredMaterials[j.MaterialToUse.pickingMaterial]=n;this.updateGenericDeferredMaterials(p)};j.Material.prototype.updateGasLookMaterial=function(){if((this instanceof j.MeshPhongMaterial)||(this instanceof j.MeshLambertMaterial)){this._deferredMaterials[j.MaterialToUse.gasLookMaterial]=this.getGasLookMaterial()}};j.Material.prototype.copySkinningParameters=function(l){if(this.skinning){l.skinning=this.skinning;if(this.useEulerAngles){l.useEulerAngles=this.useEulerAngles}if(this.skinningMap){l.skinningMap=this.skinningMap;l.skinningMapWidth=this.skinningMapWidth;l.skinningMapHeight=this.skinningMapHeight}if(this.skinningInstancingMapsInfo){l.skinningInstancingMapsInfo=this.skinningInstancingMapsInfo}if(this.skinningInstancingMaps){l.skinningInstancingMaps=this.skinningInstancingMaps}}};j.Material.prototype.copyPDSFXParameters=function(l){if(this._PDSFXData&&this._PDSFXData.PDSFX){l.activatePDSFX();l.setPDSFXOverridableFunctions(this._PDSFXData.PDSFX_OverridableFunctions_VS,this._PDSFXData.PDSFX_OverridableFunctions_FS);if(this._PDSFXData.pdsfxVaryingsCode){l._PDSFXData.pdsfxVaryingsCode=this._PDSFXData.pdsfxVaryingsCode}if(this._PDSFXData.pdsfxUniformsCode){l._PDSFXData.pdsfxUniformsCode=this._PDSFXData.pdsfxUniformsCode}if(this._PDSFXData.pdsfxUniforms){l._PDSFXData.pdsfxUniforms=this._PDSFXData.pdsfxUniforms}if(this._PDSFXData.pdsfxGlobalVariablesCode_VS){l._PDSFXData.pdsfxGlobalVariablesCode_VS=this._PDSFXData.pdsfxGlobalVariablesCode_VS}if(this._PDSFXData.pdsfxGlobalVariablesCode_FS){l._PDSFXData.pdsfxGlobalVariablesCode_FS=this._PDSFXData.pdsfxGlobalVariablesCode_FS}if(this._PDSFXData.pdsfxAttributesCode){l._PDSFXData.pdsfxAttributesCode=this._PDSFXData.pdsfxAttributesCode}if(this._PDSFXData.pdsfxUseMap){l._PDSFXData.pdsfxUseMap=true}if(l.line&&!(l.line._PDSFXData&&l.line._PDSFXData.PDSFX)){this.copyPDSFXParameters(l.line)}if(l.point&&!(l.point._PDSFXData&&l.point._PDSFXData.PDSFX)){this.copyPDSFXParameters(l.point)}}};j.Material.prototype.copyPDSFXParametersPicking=function(m){if(this._PDSFXData&&this._PDSFXData.PDSFX){m.activatePDSFX();var l={ComputeCommonValues:this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeCommonValues,ComputeDiscard:this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeDiscard};m.setPDSFXOverridableFunctions(this._PDSFXData.PDSFX_OverridableFunctions_VS,l);if(this._PDSFXData.pdsfxVaryingsCode){m._PDSFXData.pdsfxVaryingsCode=this._PDSFXData.pdsfxVaryingsCode}if(this._PDSFXData.pdsfxUniformsCode){m._PDSFXData.pdsfxUniformsCode=this._PDSFXData.pdsfxUniformsCode}if(this._PDSFXData.pdsfxUniforms){m._PDSFXData.pdsfxUniforms=this._PDSFXData.pdsfxUniforms}if(this._PDSFXData.pdsfxGlobalVariablesCode_VS){m._PDSFXData.pdsfxGlobalVariablesCode_VS=this._PDSFXData.pdsfxGlobalVariablesCode_VS}if(this._PDSFXData.pdsfxGlobalVariablesCode_FS){m._PDSFXData.pdsfxGlobalVariablesCode_FS=this._PDSFXData.pdsfxGlobalVariablesCode_FS}if(this._PDSFXData.pdsfxAttributesCode){m._PDSFXData.pdsfxAttributesCode=this._PDSFXData.pdsfxAttributesCode}if(this._PDSFXData.pdsfxUseMap){m._PDSFXData.pdsfxUseMap=true}}};j.Material.prototype.getBaseId=function(){var l="id";l+=this.skinning;l+=this.useEulerAngles;l+=this.skinningMap!==null&&this.skinningMap!==undefined;if(this.skinningMap){l+=this.skinningMap.id}else{if(this.skinningInstancingMaps&&this.skinningInstancingMaps.length>0){l+=this.skinningInstancingMaps[0].id}else{l+=-1}}if(this._PDSFXData&&this._PDSFXData.PDSFX){l+=this._getPDSFXOverridableFunctions_FS();l+=this._getPDSFXOverridableFunctions_VS();if(this._PDSFXData.pdsfxUniforms!==null){l+=this.id}}return l};j.DefaultNormalDepthMaterials=new Map();j.Material.prototype.getNormalDepthMaterialCommons=function(o){var s=this.getBaseId();s+="T"+o+"GTFaceS"+this.side+"CP"+this.enableClipPlanes+"SD"+this.shading;s+="M";s+=(this.map?this.map.id:this.map);s+="AT"+this.alphaTest;s+="BM";s+=(this.bumpMap?this.bumpMap.id:this.bumpMap);s+="MT"+this.morphTargets;s+="MN"+this.morphNormals;s+="BM"+this.isBackMaterial;if(o==="Depth"){if(this.line){var n=this.line;s+="Line"+n.getBaseId();s+="TDepthGTEdgeS"+n.side+"CP"+n.enableClipPlanes+"TR"+(n.transparent||n.getOpacity()<1)+"LW"+n.lineWidth;s+="PBM"+n.polygonBorderMode;s+="BM"+n.isBackMaterial;s+="LC"+n.linecap+"LJ"+n.linejoin}if(this.point){var m=this.point;s+="Point"+m.getBaseId();s+="T"+o+"GTParticleS"+m.side+"CP"+m.enableClipPlanes+"SD"+m.shading;s+="M";s+=(m.map?m.map.id:m.map);s+="AT"+0.01;s+="SA"+m.sizeAttenuation;s+="BM"+m.isBackMaterial}}s="id"+s.hashCode();if(j.DefaultNormalDepthMaterials.has(s)){return{id:s,materialParams:null,material:j.DefaultNormalDepthMaterials.get(s).get(this)}}var q=o;var p=b[q];var l=j.UniformsUtils.clone(p.uniforms);var r={uniforms:l,vertexShader:p.vertexShader,fragmentShader:p.fragmentShader,side:this.side,enableClipPlanes:this.enableClipPlanes};return{id:s,materialParams:r,material:null}};j.Material.prototype.getNormalMaterial=function(){var p=this.getNormalDepthMaterialCommons("Normal");if(p.material!==null){return p.material}var o=p.materialParams;if(this.bumpMap||(this.map&&this.alphaTest)){var n={};if(this.map&&this.alphaTest){n.USE_MAP_ALPHATEST=true;n.ALPHATEST=this.alphaTest;o.uniforms.map.value=this.map;o.uniforms.offsetAlphaMap.value=this.map.offset;o.uniforms.repeatAlphaMap.value=this.map.repeat}if(this.bumpMap){n.USE_BUMPMAP=true;o.uniforms.bumpMap.value=this.bumpMap;o.uniforms.bumpScale.value=this.bumpScale;o.uniforms.offsetBumpMap.value=this.bumpMap.offset;o.uniforms.repeatBumpMap.value=this.bumpMap.repeat}o.defines=n;if(this.shading){o.shading=this.shading}if(this.morphTargets){o.morphTargets=this.morphTargets}if(this.morphNormals){o.morphNormals=this.morphNormals}o.blending=j.NoBlending}var m=new j.ShaderMaterial(o);if(!(this.bumpMap||(this.map&&this.alphaTest))){m.line=this.line?this.line.getInvisibleMaterial():this.getInvisibleMaterial();m.point=this.point?this.point.getInvisibleMaterial():this.getInvisibleMaterial()}var l=new j.DeferredMaterial(m);j.DefaultNormalDepthMaterials.set(p.id,l);return l.get(this)};j.Material.prototype.getNormalDepthMaterial=function(){var p=this.getNormalDepthMaterialCommons("NormalDepth");if(p.material!==null){return p.material}var o=p.materialParams;if(this.bumpMap||(this.map&&this.alphaTest)){var n={};if(this.map&&this.alphaTest){n.USE_MAP_ALPHATEST=true;n.ALPHATEST=this.alphaTest;o.uniforms.map.value=this.map;o.uniforms.offsetAlphaMap.value=this.map.offset;o.uniforms.repeatAlphaMap.value=this.map.repeat}if(this.bumpMap){n.USE_BUMPMAP=true;o.uniforms.bumpMap.value=this.bumpMap;o.uniforms.bumpScale.value=this.bumpScale;o.uniforms.offsetBumpMap.value=this.bumpMap.offset;o.uniforms.repeatBumpMap.value=this.bumpMap.repeat}o.defines=n;if(this.shading){o.shading=this.shading}if(this.morphTargets){o.morphTargets=this.morphTargets}if(this.morphNormals){o.morphNormals=this.morphNormals}o.blending=j.NoBlending}var m=new j.ShaderMaterial(o);if(!(this.bumpMap||(this.map&&this.alphaTest))){m.line=this.line?this.line.getInvisibleMaterial():this.getInvisibleMaterial();m.point=this.point?this.point.getInvisibleMaterial():this.getInvisibleMaterial()}var l=new j.DeferredMaterial(m);j.DefaultNormalDepthMaterials.set(p.id,l);return l.get(this)};j.Material.prototype.getDepthMaterial=function(){var p=this.getNormalDepthMaterialCommons("Depth");if(p.material!==null){return p.material}var o=p.materialParams;if(this.map&&this.alphaTest){var n={};n.USE_MAP_ALPHATEST=true;n.ALPHATEST=this.alphaTest;o.defines=n;o.uniforms.map.value=this.map;o.uniforms.offsetAlphaMap.value=this.map.offset;o.uniforms.repeatAlphaMap.value=this.map.repeat;if(this.shading){o.shading=this.shading}if(this.morphTargets){o.morphTargets=this.morphTargets}if(this.morphNormals){o.morphNormals=this.morphNormals}o.blending=j.NoBlending}var m=new j.ShaderMaterial(o);if(!(this.map&&this.alphaTest)){m.line=this.line?this.line.getDepthMaterial():m;m.point=this.point?this.point.getDepthMaterial():m}var l=new j.DeferredMaterial(m);j.DefaultNormalDepthMaterials.set(p.id,l);return l.get(this)};j.LineBasicMaterial.prototype.getDepthMaterial=function(){var r=this.getBaseId();r+="TDepthGTEdgeS"+this.side+"CP"+this.enableClipPlanes+"TR"+(this.transparent||this.getOpacity()<1)+"LW"+this.lineWidth;r+="PBM"+this.polygonBorderMode;r+="BM"+this.isBackMaterial;r+="LC"+this.linecap+"LJ"+this.linejoin;r="id"+r.hashCode();if(j.DefaultNormalDepthMaterials.has(r)){return j.DefaultNormalDepthMaterials.get(r).get(this)}var p="DepthEdge";var o=b[p];var l=j.UniformsUtils.clone(o.uniforms);var q={uniforms:l,fragmentShader:o.fragmentShader,vertexShader:o.vertexShader,side:j.DoubleSide,lineWidth:this.lineWidth,pixelSize:this.pixelSize,enableClipPlanes:this.enableClipPlanes,linejoin:this.linejoin,linecap:this.linecap,force:true};var n=new j.ShaderMaterial(q);var m=new j.DeferredMaterial(n);j.DefaultNormalDepthMaterials.set(r,m);return m.get(this)};j.ParticleBasicMaterial.prototype.getNormalDepthMaterialCommons=function(m){var q=this.getBaseId();q+="T"+m+"GTParticleS"+this.side+"CP"+this.enableClipPlanes+"SD"+this.shading;q+="SZ"+this.size;q+="M";q+=(this.map?this.map.id:this.map);q+="AT"+0.01;q+="SA"+this.sizeAttenuation;q+="BM"+this.isBackMaterial;q="id"+q.hashCode();if(j.DefaultNormalDepthMaterials.has(q)){return{id:q,materialParams:null,material:j.DefaultNormalDepthMaterials.get(q).get(this)}}var o=m+"Particle";var n=b[o];var l=j.UniformsUtils.clone(n.uniforms);l.size.value=this.size;var p={uniforms:l,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,side:this.side,enableClipPlanes:this.enableClipPlanes};if(this.shading){p.shading=this.shading}return{id:q,materialParams:p,material:null}};j.ParticleBasicMaterial.prototype.getDepthMaterial=function(){var p=this.getNormalDepthMaterialCommons("Depth");if(p.material!==null){return p.material}var o=p.materialParams;var n={USE_MAP_ALPHATEST:true,ALPHATEST:0.01};if(this.sizeAttenuation){n={USE_MAP_ALPHATEST:true,ALPHATEST:0.01,USE_SIZEATTENUATION:this.sizeAttenuation}}o.defines=n;if(this.map){if(this.shading){o.shading=this.shading}o.uniforms.map.value=this.map;o.uniforms.offsetAlphaMap.value=this.map.offset;o.uniforms.repeatAlphaMap.value=this.map.repeat}var m=new j.ShaderMaterial(o);var l=new j.DeferredMaterial(m);j.DefaultNormalDepthMaterials.set(p.id,l);return l.get(this)};j.ParticleBasicMaterial.prototype.getNormalDepthMaterial=function(){var p=this.getNormalDepthMaterialCommons("NormalDepth");if(p.material!==null){return p.material}var o=p.materialParams;var n={USE_MAP_ALPHATEST:true,ALPHATEST:0.01};if(this.sizeAttenuation){n={USE_MAP_ALPHATEST:true,ALPHATEST:0.01,USE_SIZEATTENUATION:this.sizeAttenuation}}o.defines=n;if(this.map){if(this.shading){o.shading=this.shading}o.uniforms.map.value=this.map;o.uniforms.offsetAlphaMap.value=this.map.offset;o.uniforms.repeatAlphaMap.value=this.map.repeat}var m=new j.ShaderMaterial(o);var l=new j.DeferredMaterial(m);j.DefaultNormalDepthMaterials.set(p.id,l);return l.get(this)};j.ParticleBasicMaterial.prototype.getNormalMaterial=function(){var p=this.getNormalDepthMaterialCommons("Normal");if(p.material!==null){return p.material}var o=p.materialParams;if(this.bumpMap||(this.map&&this.alphaTest)){var n={};if(this.map&&this.alphaTest){n.USE_MAP_ALPHATEST=true;n.ALPHATEST=this.alphaTest;o.uniforms.map.value=this.map;o.uniforms.offsetAlphaMap.value=this.map.offset;o.uniforms.repeatAlphaMap.value=this.map.repeat}if(this.bumpMap){n.USE_BUMPMAP=true;o.uniforms.bumpMap.value=this.bumpMap;o.uniforms.bumpScale.value=this.bumpScale;o.uniforms.offsetBumpMap.value=this.bumpMap.offset;o.uniforms.repeatBumpMap.value=this.bumpMap.repeat}o.defines=n;if(this.shading){o.shading=this.shading}if(this.morphTargets){o.morphTargets=this.morphTargets}if(this.morphNormals){o.morphNormals=this.morphNormals}o.blending=j.NoBlending}var m=new j.ShaderMaterial(o);var l=new j.DeferredMaterial(m);j.DefaultNormalDepthMaterials.set(p.id,l);return l.get(this)};j.DefaultShadowDepthMaterials=new Map();j.Material.prototype.getShadowDepthMaterial=function(){var q=this.getBaseId();q+="S"+this.side+"CP"+this.enableClipPlanes+"SD"+this.shading;q+="M";q+=(this.map?this.map.id:this.map);q+="AT"+this.alphaTest;q+="BM"+this.isBackMaterial;q="id"+q.hashCode();if(j.DefaultShadowDepthMaterials.has(q)){return j.DefaultShadowDepthMaterials.get(q).get(this)}var p;var m=j.ShaderLib.depthRGBA;var l=j.UniformsUtils.clone(m.uniforms);if(this.map&&this.alphaTest){var o={};o.USE_MAP_ALPHATEST=true;o.ALPHATEST=this.alphaTest;l.map.value=this.map;l.offsetAlphaMap.value=this.map.offset;l.repeatAlphaMap.value=this.map.repeat;p=new j.ShaderMaterial({uniforms:l,vertexShader:m.vertexShader,fragmentShader:m.fragmentShader,defines:o,blending:j.NoBlending,side:j.DoubleSide,enableClipPlanes:this.enableClipPlanes});if(this.shading){p.shading=this.shading}p.force=true;p.wireframe=this.wireframe;p.vertexColors=this.vertexColors}else{p=new j.ShaderMaterial({uniforms:l,vertexShader:m.vertexShader,fragmentShader:m.fragmentShader,side:j.DoubleSide,enableClipPlanes:this.enableClipPlanes})}p.attributes=Object.assign(p.attributes?p.attributes:{},this.attributes);p._shadowPass=true;var n=new j.DeferredMaterial(p);j.DefaultShadowDepthMaterials.set(q,n);return n.get(this)};j.DefaultPickingMaterials=new Map();j.Material.prototype.getPickingMaterial=function(){var s=this.getBaseId();s+="GTFaceS"+this.side+"CP"+this.enableClipPlanes+"TR"+(this.transparent||this.getOpacity()<1);s+="SD"+this.shading;s+="M";s+=this.map?this.map.id:this.map;s+="AT"+this.alphaTest;s+="BM"+this.isBackMaterial;s="id"+s.hashCode();if(j.DefaultPickingMaterials.has(s)){return j.DefaultPickingMaterials.get(s).get(this)}var r=null;var n=null;if(this.map&&this.alphaTest){var m=b.PickingFragment;var l=j.UniformsUtils.clone(m.uniforms);var q={};q.USE_MAP_ALPHATEST=true;q.ALPHATEST=this.alphaTest;l.map.value=this.map;l.offsetAlphaMap.value=this.map.offset;l.repeatAlphaMap.value=this.map.repeat;r=new j.ShaderMaterial({uniforms:l,vertexShader:m.vertexShader,fragmentShader:m.fragmentShader,defines:q,blending:j.NoBlending,transparent:this.transparent||this.getOpacity()<1,side:this.side,enableClipPlanes:this.enableClipPlanes});if(this.shading){r.shading=this.shading}r.uniforms.pickingColor={type:"c",value:new j.Color()};if(this.isInstancingMaterial){n=new j.ShaderMaterial({uniforms:l,vertexShader:b.PickingFragmentInstancing.vertexShader,fragmentShader:b.PickingFragmentInstancing.fragmentShader,defines:q,blending:j.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,transparent:this.transparent||this.getOpacity()<1});if(this.shading){n.shading=this.shading}}}else{r=new j.MeshBasicMaterial({color:new j.Color(),side:this.side,enableClipPlanes:this.enableClipPlanes,transparent:this.transparent||this.getOpacity()<1});if(this.isInstancingMaterial){n=r.clone();n._definePickingInstancing=true;n.isInstancingMaterial=true}}var p={pickingMaterial:r,pickingMaterialInstancing:n};var o=new j.DeferredMaterial(p);j.DefaultPickingMaterials.set(s,o);return o.get(this)};j.LineBasicMaterial.prototype.getPickingMaterial=function(){var q=this.getBaseId();q+="GTEdgeS"+this.side+"CP"+this.enableClipPlanes+"TR"+(this.transparent||this.getOpacity()<1)+"LW"+this.lineWidth;q+="PBM"+this.polygonBorderMode;q+="BM"+this.isBackMaterial;q+="LC"+this.linecap+"LJ"+this.linejoin;q="id"+q.hashCode();if(j.DefaultPickingMaterials.has(q)){return j.DefaultPickingMaterials.get(q).get(this)}var m={color:new j.Color(),side:this.side,lineWidth:this.lineWidth,enableClipPlanes:this.enableClipPlanes,linejoin:this.linejoin,linecap:this.linecap,pixelSize:this.pixelSize,transparent:this.transparent||this.getOpacity()<1,polygonBorderMode:this.polygonBorderMode};var p=new j.LineBasicMaterial(m);var l=null;if(this.isInstancingMaterial){l=p.clone();l._definePickingInstancing=true;l.isInstancingMaterial=true}var o={pickingMaterial:p,pickingMaterialInstancing:l};var n=new j.DeferredMaterial(o);j.DefaultPickingMaterials.set(q,n);return n.get(this)};j.ShaderMaterial.prototype.getPickingMaterial=function(){var l=j.UniformsUtils.mergeNoClone([this.uniforms]);var m=this.clone();m.fragmentShader=b.PickingFragment.fragmentShader;m.uniforms=l;m.uniforms.pickingColor={type:"c",value:new j.Color()};m.vertexColors=this.vertexColors;return{pickingMaterial:m,pickingMaterialInstancing:null}};j.ParticleBasicMaterial.prototype.getPickingMaterial=function(){var r=this.getBaseId();r+="TParticleSZ"+this.size;r+="CP"+this.enableClipPlanes;r+="TR"+(this.transparent||this.getOpacity()<1);r+="SA"+this.sizeAttenuation;r+="M";r+="BM"+this.isBackMaterial;r+=this.map?this.map.id:this.map;r="id"+r.hashCode();if(j.DefaultPickingMaterials.has(r)){return j.DefaultPickingMaterials.get(r).get(this)}var p={USE_MAP_ALPHATEST:true,ALPHATEST:0.01};if(this.sizeAttenuation){p.USE_SIZEATTENUATION=this.sizeAttenuation}var l=j.UniformsUtils.clone(b.PickingPointFragment.uniforms);if(this.map){l.map.value=this.map;l.offsetAlphaMap.value=this.map.offset;l.repeatAlphaMap.value=this.map.repeat}l.size.value=this.size;var q=new j.ShaderMaterial({uniforms:l,defines:p,fragmentShader:b.PickingPointFragment.fragmentShader,vertexShader:b.PickingPointFragment.vertexShader});q.side=j.DoubleSide;q.enableClipPlanes=this.enableClipPlanes;q.transparent=this.transparent||this.getOpacity()<1;q.uniforms.pickingColor={type:"c",value:new j.Color()};var m=null;if(this.isInstancingMaterial){m=new j.ShaderMaterial({uniforms:l,defines:p,vertexShader:b.PickingPointFragmentInstancing.vertexShader,fragmentShader:b.PickingPointFragmentInstancing.fragmentShader});m.side=j.DoubleSide;m.enableClipPlanes=this.enableClipPlanes;m.transparent=this.transparent}var o={pickingMaterial:q,pickingMaterialInstancing:m};var n=new j.DeferredMaterial(o);j.DefaultPickingMaterials.set(r,n);return n.get(this)};j.DefaultHighlightMaterials=new Map();j.Material.prototype.getHighlightInfo=function(l){var n;var m="Highlight";switch(l){case"Highlight":n=g;m="Highlight";break;case"PreHighlight":n=k;m="Highlight";break;case"HighlightMobile":n=f;m="Highlight";break;case"OutlineHighlight":n=g;m="OutlineHighlight";break;case"OutlinePreHighlight":n=k;m="OutlineHighlight";break;default:break}return{shaderLib:n,shaderName:m}};j.ParticleBasicMaterial.prototype.getHighlightMaterial=function(q){var l=this.getBaseId();l+="T"+q+"GTParticleSZ"+this.size;l+="AT"+0.01;l+="SA"+this.sizeAttenuation;l+="M";l+=this.map?this.map.id:this.map;l+="BM"+this.isBackMaterial;l="id"+l.hashCode();if(j.DefaultHighlightMaterials.has(l)){return j.DefaultHighlightMaterials.get(l).get(this)}var r={USE_MAP_ALPHATEST:true,ALPHATEST:0.01};if(this.sizeAttenuation){r={USE_MAP_ALPHATEST:true,ALPHATEST:0.01,USE_SIZEATTENUATION:this.sizeAttenuation}}var s=this.getHighlightInfo(q);var p=s.shaderLib;var n=s.shaderName;n+="Point";var t=j.UniformsUtils.clone(p[n].uniforms);if(this.map){t.map.value=this.map;t.offsetAlphaMap.value=this.map.offset;t.repeatAlphaMap.value=this.map.repeat}t.size.value=this.size;var o=new j.ShaderMaterial({uniforms:t,defines:r,fragmentShader:p[n].fragmentShader,vertexShader:p[n].vertexShader});o.side=j.DoubleSide;o.enableClipPlanes=this.enableClipPlanes;var m=new j.DeferredMaterial(o);j.DefaultHighlightMaterials.set(l,m);return m.get(this)};j.Material.prototype.getHighlightMaterial=function(s){var l=this.getBaseId();l+="T"+s;l+="GTFace";l+="CP"+this.enableClipPlanes;l+="M";l+=this.map?this.map.id:this.map;l+="AT"+this.alphaTest;l+="BM"+this.isBackMaterial;if(this.line){var w=this.line;l+="Line"+w.getBaseId();l+="T"+s+"GTEdgeCP"+w.enableClipPlanes+"LW"+w.lineWidth;l+="LC"+w.linecap+"LJ"+w.linejoin;if(w.isDashedLine){l+="SC"+w.scale;l+="PO"+(w.patternOffset%w.dashPattern[w.dashPattern.length-1]);l+="CPU"+w.isCPUPattern;for(var n=0;n<w.dashPattern.length;n++){var u=w.dashPattern[n];l+=n+"P"+u}}l+="BM"+w.isBackMaterial}if(this.point){var v=this.point;l+="Point"+v.getBaseId();l+="T"+s+"GTParticleSZ"+v.size;l+="AT"+0.01;l+="SA"+v.sizeAttenuation;l+="M";l+=v.map?v.map.id:v.map;l+="BM"+v.isBackMaterial}l="id"+l.hashCode();if(j.DefaultHighlightMaterials.has(l)){return j.DefaultHighlightMaterials.get(l).get(this)}var t=this.getHighlightInfo(s);var r=t.shaderLib;var q=t.shaderName;q+="Face";var p;var o={uniforms:j.UniformsUtils.clone(r[q].uniforms),fragmentShader:r[q].fragmentShader,vertexShader:r[q].vertexShader,side:j.DoubleSide,enableClipPlanes:this.enableClipPlanes,};if(this.map&&this.alphaTest){o.defines={USE_MAP_ALPHATEST:true,ALPHATEST:this.alphaTest};o.uniforms.map.value=this.map;o.uniforms.offsetAlphaMap.value=this.map.offset;o.uniforms.repeatAlphaMap.value=this.map.repeat;p=new j.ShaderMaterial(o)}else{o.force=true;p=new j.ShaderMaterial(o)}p.line=this.line?this.line.getHighlightMaterial(j.mobileVersion?"HighlightMobile":"Highlight"):null;p.point=this.point?this.point.getHighlightMaterial(j.mobileVersion?"HighlightMobile":"Highlight"):null;var m=new j.DeferredMaterial(p);j.DefaultHighlightMaterials.set(l,m);return m.get(this)};j.LineBasicMaterial.prototype.getHighlightMaterial=function(s){var l=this.getBaseId();l+="T"+s+"GTEdgeCP"+this.enableClipPlanes+"LW"+this.lineWidth;l+="LC"+this.linecap+"LJ"+this.linejoin;if(this.isDashedLine){l+="SC"+this.scale;l+="PO"+(this.patternOffset%this.dashPattern[this.dashPattern.length-1]);l+="CPU"+this.isCPUPattern;for(var n=0;n<this.dashPattern.length;n++){var u=this.dashPattern[n];l+=n+"P"+u}}l+="BM"+this.isBackMaterial;l="id"+l.hashCode();if(j.DefaultHighlightMaterials.has(l)){return j.DefaultHighlightMaterials.get(l).get(this)}var t=this.getHighlightInfo(s);var r=t.shaderLib;var q=t.shaderName;q+="Edge";var o={uniforms:j.UniformsUtils.clone(r[q].uniforms),fragmentShader:r[q].fragmentShader,vertexShader:r[q].vertexShader,side:j.DoubleSide,lineWidth:this.lineWidth,pixelSize:this.pixelSize,isCPUPattern:this.isCPUPattern,patternOffset:this.patternOffset,enableClipPlanes:this.enableClipPlanes,linejoin:this.linejoin,linecap:this.linecap,scale:this.scale,force:true};if(this.isDashedLine){o.isDashedLine=true;o.dashPattern=new Float32Array(this.dashPattern)}var p=new j.ShaderMaterial(o);var m=new j.DeferredMaterial(p);j.DefaultHighlightMaterials.set(l,m);return m.get(this)};j.DefaultMaterials=new Map();j.Material.prototype.getZOnlyMaterial=function(){var n="ZOnly";n="id"+n.hashCode();if(j.DefaultMaterials.has(n)){return j.DefaultMaterials.get(n).get(this)}var m=new j.MeshBasicMaterial({force:true});m.blending=j.CustomBlending;m.useBlending=true;m.blendDst=j.OneFactor;m.blendSrc=j.ZeroFactor;var l=new j.DeferredMaterial(m);j.DefaultMaterials.set(n,l);return l.get(this)};j.ParticleBasicMaterial.prototype.getZOnlyMaterial=function(){return this};j.LineDSMaterial.prototype.getZOnlyMaterial=function(){return this};j.Material.prototype.getInvisibleMaterial=function(){var n=this.getBaseId();n+="TInvisible";n="id"+n.hashCode();if(j.DefaultMaterials.has(n)){return j.DefaultMaterials.get(n).get(this)}var m=new j.ShaderMaterial();m.visible=false;m.force=true;var l=new j.DeferredMaterial(m);j.DefaultMaterials.set(n,l);return l.get(this)};j.Material.prototype.getGasLookMaterial=function(n){var o=this.getBaseId();o+="TGASLook";o+="Col"+this.color.getHex();o+="S"+this.side;o+="CP"+this.enableClipPlanes;o+="O"+this.getOpacity();o="id"+o.hashCode();if(j.DefaultMaterials.has(o)){return j.DefaultMaterials.get(o).get(this)}var m=new j.PhysicalMaterial({NRECompatibility:true,_gasLook:1,color:this.color,opacity:this.getOpacity(),roughness:0.3,metalness:0,specularContrib:1,specular:new j.Color().setRGB(1,1,1),side:this.side,enableClipPlanes:this.enableClipPlanes});var l=new j.DeferredMaterial(m);j.DefaultMaterials.set(o,l);return l.get(this)};j.ShaderMaterialDS=function(l){this.vertexShaderPars="";this.fragmentShaderPars="";this.vertexShaderBody="";this.fragmentShaderBody="";this.originalMaterialRef=null;this.needTangentBinormal=false;j.ShaderMaterial.call(this,l);this.shaderVersion=0;if(this.enableOIT){this.vertexShaderPars=[this.vertexShaderPars,j.ShaderChunk.oit_pars_vertex].join("\n");this.vertexShaderBody=[this.vertexShaderBody,j.ShaderChunk.oit_vertex].join("\n");this.fragmentShaderPars=[this.fragmentShaderPars,j.ShaderChunk.oit_pars_fragment].join("\n");this.fragmentShaderBody=[this.fragmentShaderBody,j.ShaderChunk.oit_fragment].join("\n")}this.update()};j.ShaderMaterialDS.prototype=Object.create(j.ShaderMaterial.prototype);j.ShaderMaterialDS.prototype.clone=function(){var l=new j.ShaderMaterialDS();j.ShaderMaterial.prototype.clone.call(this,l);l.vertexShaderPars=this.vertexShaderPars;l.fragmentShaderPars=this.fragmentShaderPars;l.vertexShaderBody=this.vertexShaderBody;l.fragmentShaderBody=this.fragmentShaderBody;l.originalMaterialRef=this;l.needTangentBinormal=this.needTangentBinormal;return l};j.ShaderMaterialDS.prototype.setShaders=function(l,o,n,m){this.vertexShaderPars=l;this.fragmentShaderPars=n;this.vertexShaderBody=o;this.fragmentShaderBody=m;this.update()};j.ShaderMaterialDS.prototype.update=function(){var l="";l=[l,this.vertexShaderPars,""].join("\n");l+="void main() { \n";l+=this.vertexShaderBody;l+="\n";l+="}";this.vertexShader=l;var m="";m+="#if defined( NEEDS_UVTOUSE )\n";m+="vec2 uvToUse; \n";m+="#endif \n";m=[m,this.fragmentShaderPars,""].join("\n");m+="void main() { \n";m+="#if defined( NEEDS_UVTOUSE )\n";m+="uvToUse=vUv; \n";m+="#endif \n";m+=this.fragmentShaderBody;m+="\n";m+="}";this.fragmentShader=m;this.needsUpdate=true};j.ShaderMaterialDS.prototype.updateDeferredMaterials=function(n){if(this.originalMaterialRef&&this.originalMaterialRef._deferredMaterialsInit){this._deferredMaterials[0]=this;for(var o=1;o<this.originalMaterialRef._deferredMaterials.length;o++){if(this.originalMaterialRef._deferredMaterials[o] instanceof j.ShaderMaterialDS){this._deferredMaterials[o]=this.originalMaterialRef._deferredMaterials[o].clone();if(this.originalMaterialRef._deferredMaterials[o].line){this._deferredMaterials[o].line=this.originalMaterialRef._deferredMaterials[o].line.clone()}if(this.originalMaterialRef._deferredMaterials[o].point){this._deferredMaterials[o].point=this.originalMaterialRef._deferredMaterials[o].point.clone()}for(var N in this._deferredMaterials[o].uniforms){if(N in this.uniforms){this._deferredMaterials[o].uniforms[N]=this.uniforms[N]}}}}this._deferredMaterialsInit=true;return}var V=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(b.Normal.uniforms)]);var I=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(b.Depth.uniforms)]);var T=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(b.NormalDepth.uniforms)]);var R=j.ShaderLib.depthRGBA;var w=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(R.uniforms)]);var m=j.mobileVersion?f:g;var L=m.HighlightFace;var G=m.HighlightEdge;var l=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(L.uniforms)]);var J=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(G.uniforms)]);var t=k.HighlightFace;var q=k.HighlightEdge;var B=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(L.uniforms)]);var s=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(G.uniforms)]);var F=b.PickingFragment;var A=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(F.uniforms)]);var K=this.defines?this.defines:{};if(this.map&&this.alphaTest){K.USE_MAP_ALPHATEST=true;K.ALPHATEST=this.alphaTest;V.map.value=this.map;I.map.value=this.map;T.map.value=this.map;w.map.value=this.map;l.map.value=this.map;B.map.value=this.map;A.map.value=this.map;var M=this.map.offset;var H=this.map.repeat;V.offsetAlphaMap.value=M;V.repeatAlphaMap.value=H;I.offsetAlphaMap.value=M;I.repeatAlphaMap.value=H;T.offsetAlphaMap.value=M;T.repeatAlphaMap.value=H;w.offsetAlphaMap.value=M;w.repeatAlphaMap.value=H;l.offsetAlphaMap.value=M;l.repeatAlphaMap.value=H;B.offsetAlphaMap.value=M;B.repeatAlphaMap.value=H;A.offsetAlphaMap.value=M;A.repeatAlphaMap.value=H}var D=new j.ShaderMaterialDS({uniforms:V,vertexShaderPars:[this.vertexShaderPars,b.Normal.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,b.Normal.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,b.Normal.fragmentShaderPars].join("\n"):b.Normal.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,b.Normal.fragmentShaderBody].join("\n"):b.Normal.fragmentShaderBody,shading:this.shading,defines:K,blending:j.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:false});this._deferredMaterials[j.MaterialToUse.normalMaterial]=D;var v=new j.ShaderMaterialDS({uniforms:I,vertexShaderPars:[this.vertexShaderPars,b.Depth.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,b.Depth.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,b.Depth.fragmentShaderPars].join("\n"):b.Depth.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,b.Depth.fragmentShaderBody].join("\n"):b.Depth.fragmentShaderBody,defines:K,blending:j.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:false});this._deferredMaterials[j.MaterialToUse.depthMaterial]=v;var C=new j.ShaderMaterialDS({uniforms:T,vertexShaderPars:[this.vertexShaderPars,b.NormalDepth.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,b.NormalDepth.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,b.NormalDepth.fragmentShaderPars].join("\n"):b.NormalDepth.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,b.NormalDepth.fragmentShaderBody].join("\n"):b.NormalDepth.fragmentShaderBody,shading:this.shading,defines:K,blending:j.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:false});this._deferredMaterials[j.MaterialToUse.normalDepthMaterial]=C;var O=new j.ShaderMaterialDS({uniforms:w,vertexShaderPars:[this.vertexShaderPars,R.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,R.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,R.fragmentShaderPars].join("\n"):R.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,R.fragmentShaderBody].join("\n"):R.fragmentShaderBody,shading:this.shading,defines:K,blending:j.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:false});this._deferredMaterials[j.MaterialToUse.shadowMapDepthMaterial]=O;this.copySkinningParameters(this._deferredMaterials[j.MaterialToUse.shadowMapDepthMaterial]);this.copyPDSFXParameters(this._deferredMaterials[j.MaterialToUse.shadowMapDepthMaterial]);var Q=new j.ShaderMaterialDS({uniforms:l,defines:K,vertexShaderPars:[this.vertexShaderPars,L.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,L.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,L.fragmentShaderPars].join("\n"):L.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,L.fragmentShaderBody].join("\n"):L.fragmentShaderBody,blending:j.NoBlending,enableOIT:false});Q.side=j.DoubleSide;Q.enableClipPlanes=this.enableClipPlanes;Q.vertexColors=this.vertexColors;Q.line=new j.ShaderMaterialDS({uniforms:J,vertexShaderPars:[this.vertexShaderPars,G.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,G.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,G.fragmentShaderPars].join("\n"):G.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,G.fragmentShaderBody].join("\n"):G.fragmentShaderBody,blending:j.NoBlending,enableOIT:false});Q.line.enableClipPlanes=this.enableClipPlanes;Q.line.vertexColors=this.vertexColors;this._deferredMaterials[j.MaterialToUse.highlightMaterial]=Q;var S=new j.ShaderMaterialDS({uniforms:B,defines:K,vertexShaderPars:[this.vertexShaderPars,t.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,t.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,t.fragmentShaderPars].join("\n"):t.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,t.fragmentShaderBody].join("\n"):t.fragmentShaderBody,blending:j.NoBlending,enableOIT:false});S.side=j.DoubleSide;S.enableClipPlanes=this.enableClipPlanes;S.vertexColors=this.vertexColors;S.line=new j.ShaderMaterialDS({uniforms:s,vertexShaderPars:[this.vertexShaderPars,q.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,q.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,q.fragmentShaderPars].join("\n"):q.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,q.fragmentShaderBody].join("\n"):q.fragmentShaderBody,blending:j.NoBlending,enableOIT:false});S.line.enableClipPlanes=this.enableClipPlanes;S.line.vertexColors=this.vertexColors;this._deferredMaterials[j.MaterialToUse.preHighlightMaterial]=S;if(!j.mobileVersion){var r=g;var y=r.OutlineHighlightFace;var x=r.OutlineHighlightEdge;var P=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(L.uniforms)]);var z=j.UniformsUtils.mergeNoClone([this.uniforms,j.UniformsUtils.clone(G.uniforms)]);if(this.map&&this.alphaTest){P.map.value=this.map;P.offsetAlphaMap.value=this.map.offset;P.repeatAlphaMap.value=this.map.repeat}var U=new j.ShaderMaterialDS({uniforms:P,defines:K,vertexShaderPars:[this.vertexShaderPars,y.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,y.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,y.fragmentShaderPars].join("\n"):y.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,y.fragmentShaderBody].join("\n"):y.fragmentShaderBody,blending:j.NoBlending,enableOIT:false});U.side=j.DoubleSide;U.enableClipPlanes=this.enableClipPlanes;U.vertexColors=this.vertexColors;U.line=new j.ShaderMaterialDS({uniforms:z,vertexShaderPars:[this.vertexShaderPars,x.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,x.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,x.fragmentShaderPars].join("\n"):x.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,x.fragmentShaderBody].join("\n"):x.fragmentShaderBody,blending:j.NoBlending,enableOIT:false});U.line.enableClipPlanes=this.enableClipPlanes;U.line.vertexColors=this.vertexColors;this._deferredMaterials[j.MaterialToUse.outlineHighlightMaterial]=U}var p=new j.ShaderMaterialDS({uniforms:A,vertexShaderPars:[this.vertexShaderPars,F.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,F.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,F.fragmentShaderPars].join("\n"):F.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,F.fragmentShaderBody].join("\n"):F.fragmentShaderBody,shading:this.shading,defines:K,blending:j.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:false});p.uniforms.pickingColor={type:"c",value:new j.Color()};p.wireframe=this.wireframe;p.vertexColors=this.vertexColors;if(this.isInstancingMaterial){var E=new j.ShaderMaterialDS({uniforms:A,vertexShaderPars:[this.vertexShaderPars,F.vertexShaderPars,"varying vec3 vInstancePickingColor;"].join("\n"),vertexShaderBody:[this.vertexShaderBody,F.vertexShaderBody,b.Chunks.picking_instancing_vertex].join("\n"),fragmentShaderPars:this.enableClipPlanes?[j.ShaderChunk.clip_pars_fragment,F.fragmentShaderPars,"varying vec3 vInstancePickingColor;"].join("\n"):[F.fragmentShaderPars,"varying vec3 vInstancePickingColor;"].join("\n"),fragmentShaderBody:this.enableClipPlanes?[j.ShaderChunk.clip_fragment,F.fragmentShaderBody,b.Chunks.picking_instancing_fragment].join("\n"):[F.fragmentShaderBody,b.Chunks.picking_instancing_fragment].join("\n"),shading:this.shading,defines:K,blending:j.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:false});E.wireframe=this.wireframe;E.vertexColors=this.vertexColors;this._deferredMaterials[j.MaterialToUse.pickingMaterialInstancing]=E}else{this._deferredMaterials[j.MaterialToUse.pickingMaterialInstancing]=null}this._deferredMaterials[j.MaterialToUse.pickingMaterial]=p;this._deferredMaterials[j.MaterialToUse.pickingMaterial].refreshUniforms=this.refreshUniforms;this._deferredMaterials[j.MaterialToUse.normalMaterial].refreshUniforms=this.refreshUniforms;this._deferredMaterials[j.MaterialToUse.depthMaterial].refreshUniforms=this.refreshUniforms;if(this._deferredMaterials[j.MaterialToUse.pickingMaterialInstancing]!==null){this._deferredMaterials[j.MaterialToUse.pickingMaterialInstancing].refreshUniforms=this.refreshUniforms}this.updateGenericDeferredMaterials(n)};j.IBLOverrider=function(l){this.hdr=l.hdr||{loadEndStatus:"useCurrent"};this.brdf=l.brdf||"GGX";this.direct=l.direct||false;this.name=l.name||"";this.mips=l.mips||null};j.IBLOverrider.prototype.clone=function(){return new j.IBLOverrider({hdr:this.hdr,brdf:this.brdf,direct:this.direct,name:this.name,mips:this.mips})};j.SubsurfaceScatteringPresets={None:-1,Apple:0,Chicken1:1,Chicken2:2,Cream:3,Ketchup:4,Marble:5,Potato:6,Skimmilk:7,Skin1:8,Skin2:9,Wholemilk:10};j._SubsurfaceScatteringPresets={setValues:function(l){if(l.subsurfacePreset===j.SubsurfaceScatteringPresets.None){this._subsurface=false;return}l.updateSSS=true;l._subsurface=true;var m=this.presetValues[l.subsurfacePreset];l._absorptionCoeffs=m.absorptionCoeffs.slice(0);l._scatteringCoeffs=m.scatteringCoeffs.slice(0)},presetValues:[{absorptionCoeffs:[0.003,0.0034,0.046],scatteringCoeffs:[2.29,2.39,1.97]},{absorptionCoeffs:[0.015,0.077,0.19],scatteringCoeffs:[0.15,0.21,0.38]},{absorptionCoeffs:[0.018,0.088,0.2],scatteringCoeffs:[0.19,0.25,0.32]},{absorptionCoeffs:[0.0002,0.0028,0.0163],scatteringCoeffs:[7.38,5.47,3.15]},{absorptionCoeffs:[0.061,0.97,1.45],scatteringCoeffs:[0.18,0.07,0.03]},{absorptionCoeffs:[0.0021,0.0041,0.0071],scatteringCoeffs:[2.19,2.62,3]},{absorptionCoeffs:[0.0024,0.009,0.12],scatteringCoeffs:[0.68,0.7,0.55]},{absorptionCoeffs:[0.0014,0.0025,0.0142],scatteringCoeffs:[0.7,1.22,1.9]},{absorptionCoeffs:[0.032,0.17,0.48],scatteringCoeffs:[0.74,0.88,1.01]},{absorptionCoeffs:[0.013,0.07,0.145],scatteringCoeffs:[1.09,1.59,1.79]},{absorptionCoeffs:[0.0011,0.0024,0.014],scatteringCoeffs:[2.55,3.21,3.77]}]};j.SheenMode={NO_SHEEN:"NONE",VELVET:"USE_VELVET",SATIN:"USE_SATIN"};j.SheenData=function(l){this.envMipMap=l.envMipMap||null;this.overrideIBL=l.overrideIBL||null};j.SheenData.prototype.clone=function(){return new j.SheenData({envMipMap:this.envMipMap,overrideIBL:this.overrideIBL!==null?this.overrideIBL.clone():null,})};j.PhysicalMaterial=function(l){j.Material.call(this);this.isPhysicalMaterial=true;this.lights=true;this.shaderID=j.ShaderIDs.physicalDS;this.needsCameraPosition=true;this.__prevColorTexture=null;this.__prevNormalDepthTexture=null;this.thinWalled=true;this.color=new j.Color(16777215);this.map=null;this.diffuseUvTransform=new j.Matrix3();this.diffuseMulCoef=null;this.diffuseAddCoef=null;this.diffuseMapLinear=true;this.specular=new j.Color(16777215);this.specularMap=null;this.specularUvTransform=new j.Matrix3();this.specularMulCoef=null;this.specularAddCoef=null;this.specularMapLinear=true;this.metalness=0;this.metalnessMap=null;this.metalnessUvTransform=new j.Matrix3();this.metalnessMulCoef=1;this.metalnessAddCoef=0;this.metalnessMapLinear=true;this.specularContrib=1;this.specularContribMap=null;this.specularContribUvTransform=new j.Matrix3();this.specularContribMulCoef=1;this.specularContribAddCoef=0;this.emissionColor=new j.Color(16777215);this.emissionColorMapLinear=true;this.emissionColorMap=null;this.emissionColorAddCoef=null;this.emissionColorMulCoef=null;this.emissionColorUvTransform=new j.Matrix3();this.emissionValue=0;this.emissionNormalized=false;this.transparency=0;this.transparencyMap=null;this.transparencyUvTransform=new j.Matrix3();this.transparencyMulCoef=1;this.transparencyAddCoef=0;this.opacity=1;this.useAlphaFromDiffuseMap=true;this.opacityMap=null;this.opacityUvTransform=new j.Matrix3();this.opacityMulCoef=1;this.opacityAddCoef=0;this.ior=1.4;this.roughness=0;this.roughnessMap=null;this.glossinessMap=null;this.glossinessMulCoef=1;this.glossinessAddCoef=0;this.roughnessUvTransform=new j.Matrix3();this.roughnessMulCoef=1;this.roughnessAddCoef=0;this.roughnessMapLinear=true;this.anisotropy=0;this.anisotropyMap=null;this.anisotropyUvTransform=new j.Matrix3();this.anisotropyMulCoef=1;this.anisotropyAddCoef=0;this.anisotropyAngle=0;this.anisotropyAngleMap=null;this.anisotropyAngleUvTransform=new j.Matrix3();this.anisotropyAngleMulCoef=1;this.anisotropyAngleAddCoef=0;this.displacementMap=null;this.displacementScale=0;this.displacementBias=0;this.reflectionProbes=null;this._sheenData=null;this.sheen=0;this.sheenMap=null;this.sheenMulCoef=1;this.sheenAddCoef=0;this.sheenUvTransform=new j.Matrix3();this.sheenMode=j.SheenMode.NO_SHEEN;this.clearCoat=0;this.clearCoatMap=null;this.clearCoatAddCoef=0;this.clearCoatMulCoef=1;this.clearCoatUvTransform=new j.Matrix3();this.clearCoatRoughnessMap=null;this.clearCoatRoughnessUvTransform=new j.Matrix3();this.clearCoatRoughnessMulCoef=1;this.clearCoatRoughnessAddCoef=0;this.clearCoatRoughnessMapLinear=true;this.coatingGlossinessMap=null;this.coatingGlossinessMulCoef=1;this.coatingGlossinessAddCoef=0;this.clearCoatRoughness=0;this.clearCoatNormalMap=null;this.clearCoatNormalMapFlipY=false;this.clearCoatNormalUvTransform=new j.Matrix3();this.clearCoatNormalScaleMulCoef=1;this.clearCoatNormalScaleAddCoef=0;this.clearCoatNormalScale=1;this.orangePeel=false;this.orangePeelScale=0;this.envMipMap=null;this.envMap=null;this.overrideIBL=null;this.attenuationColor=new j.Color(16777215);this.attenuationDistance=1000000;this.subsurfaceColor=new j.Color(0);this.translucencyScale=1;this.subsurfacePreset=j.SubsurfaceScatteringPresets.None;this.bumpMap=null;this.bumpScale=1;this.bumpScaleMulCoef=1;this.bumpScaleAddCoef=0;this.normalMap=null;this.normalScale=new j.Vector2(1,1);this.normalUvTransform=new j.Matrix3();this.normalScaleMulCoef=1;this.normalScaleAddCoef=0;this.normalMapFlipY=false;this.lightMap=null;this.lightMapMode=0;this.lightMapLinear=true;this.useLighting=true;this.perPixel=true;if(typeof l!=="undefined"&&(typeof l.flakes!=="undefined"||typeof l.flakesDensity!=="undefined"||typeof l.flakesScale!=="undefined"||typeof l.flakesBump!=="undefined"||typeof l.pearlFlakesBump!=="undefined"||typeof l.pearlFlakesColor!=="undefined")){this.flakes=false;this.flakesMode=j.mobileVersion?1:0;this.flakesColor=new j.Color(0);this.flakesBump=0;this.flakesDensity=0;this.flakesScale=0;this.flakesRoughness=0;this.flakesColorMulCoef=new j.Vector3(1,1,1);this.flakesColorAddCoef=new j.Vector3(0,0,0);this.pearlFlakesColor=new j.Color(0);this.pearlFlakesBump=0;this.pearlFlakesDensity=0;this.pearlFlakesColorMulCoef=new j.Vector3(1,1,1);this.pearlFlakesColorAddCoef=new j.Vector3(0,0,0)}else{this.flakesCoverage=0;this.flakesCoverageUvTransform=new j.Matrix3();this.flakesCoverageMap=null;this.flakesCoverageAddCoef=0;this.flakesCoverageMulCoef=1;this.flakesSize=0;this.flakesSizeUvTransform=new j.Matrix3();this.flakesSizeMap=null;this.flakesSizeAddCoef=0;this.flakesSizeMulCoef=1;this.flakesRoughness=0;this.flakesRoughnessUvTransform=new j.Matrix3();this.flakesRoughnessMap=null;this.flakesRoughnessMapLinear=true;this.flakesRoughnessAddCoef=0;this.flakesRoughnessMulCoef=1;this.flakesColor=new j.Color(16777215);this.flakesColorUvTransform=new j.Matrix3();this.flakesColorMap=null;this.flakesColorMapLinear=true;this.flakesColorAddCoef=null;this.flakesColorMulCoef=null}this._gasLook=0;this.needTangent=false;this.needTangentBinormal=false;this.NRECompatibility=true;this.sslr=false;this.uvSlots={diffuseMap:1,specularMap:1,roughnessMap:1,normalMap:1,lightMap:2};this.setValues(l);if(l&&l.hasOwnProperty("glossiness")&&this.metalness==0){this.roughness=1-l.glossiness;this.roughnessMap=null;this.ior=1e+25;this.thinWalled=true;this.metalness=0;this.metalnessMap=null}if(this.glossinessMap){this.roughnessMap=null;this.ior=1e+25;this.thinWalled=true;this.metalness=0;this.metalnessMap=null;this.roughnessMapLinear=l.hasOwnProperty("glossinessMapLinear")?l.glossinessMapLinear:true;this.roughnessUvTransform=l.hasOwnProperty("glossinessUvTransform")?l.glossinessUvTransform:this.roughnessUvTransform}if(l&&l.hasOwnProperty("emissive")){this.emissionColor.copy(l.emissive);this.emissionColorMap=l.hasOwnProperty("emissiveMap")?l.emissiveMap:this.emissionColorMap;this.emissionColorAddCoef=l.hasOwnProperty("emissiveAddCoef")?l.emissiveAddCoef.clone():this.emissionColorAddCoef;this.emissionColorMulCoef=l.hasOwnProperty("emissiveMulCoef")?l.emissiveMulCoef.clone():this.emissionColorMulCoef;this.emissionColorUvTransform=l.hasOwnProperty("emissiveUvTransform")?l.emissiveUvTransform.clone():this.emissionColorUvTransform;this.emissionValue=1;this.emissionNormalized=false;this.emissionColorMapLinear=l.hasOwnProperty("emissiveMapLinear")?l.emissiveMapLinear:true}if(l&&l.hasOwnProperty("coating")){this.clearCoat=l.coating;this.clearCoatRoughness=l.hasOwnProperty("coatingGlossiness")?1-l.coatingGlossiness:0}if(this.coatingGlossinessMap){this.clearCoatRoughnessMap=null;this.clearCoatRoughnessAddCoef=0;this.clearCoatRoughnessMulCoef=1;this.clearCoatRoughnessMapLinear=l.hasOwnProperty("coatingGlossinessMapLinear")?l.coatingGlossinessMapLinear:true;this.clearCoatRoughnessUvTransform=l.hasOwnProperty("coatingGlossinessUvTransform")?l.coatingGlossinessUvTransform:this.clearCoatRoughnessUvTransform}this._subsurface=false;this._sssLUT=null;this._sssIBLLUT=null;this._translucencyLUT=null;this._scatteringCoeffs=null;this._absorptionCoeffs=null;this.setSheen({sheen:this.sheen,sheenMode:this.sheenMode});this.ambienceMatrix=new j.Matrix4();this.useFiniteEnvMap=false;this.parallaxCorrectionParameters=null;if(this.subsurfacePreset>j.SubsurfaceScatteringPresets.None){j._SubsurfaceScatteringPresets.setValues(this)}else{this.setSubsurfaceScatteringParams(l)}};j.PhysicalMaterial.prototype=Object.create(j.Material.prototype);j.PhysicalMaterial.prototype.getOpacity=function(){return 1-Math.max(1-this.opacity,Math.min(this.transparency,0.99))};j.PhysicalMaterial.prototype.clone=function(){var l;if(typeof this.flakes==="undefined"){l=new j.PhysicalMaterial()}else{l=new j.PhysicalMaterial({flakes:this.flakes})}j.Material.prototype.clone.call(this,l);l.__prevColorTexture=this.__prevColorTexture;l.__prevNormalDepthTexture=this.__prevNormalDepthTexture;l.useLighting=this.useLighting;l.perPixel=this.perPixel;l.thinWalled=this.thinWalled;l.color.copy(this.color);l.map=this.map;l.diffuseUvTransform=this.diffuseUvTransform;l.diffuseMulCoef=this.diffuseMulCoef;l.diffuseAddCoef=this.diffuseAddCoef;l.diffuseMapLinear=this.diffuseMapLinear;l.specular.copy(this.specular);l.specularMap=this.specularMap;l.specularUvTransform=this.specularUvTransform;l.specularMulCoef=this.specularMulCoef;l.specularAddCoef=this.specularAddCoef;l.specularMapLinear=this.specularMapLinear;l.metalness=this.metalness;l.metalnessMap=this.metalnessMap;l.metalnessUvTransform=this.metalnessUvTransform;l.metalnessMulCoef=this.metalnessMulCoef;l.metalnessAddCoef=this.metalnessAddCoef;l.metalnessMapLinear=this.metalnessMapLinear;l.specularContrib=this.specularContrib;l.specularContribMap=this.specularContribMap;l.specularContribUvTransform=this.specularContribUvTransform;l.specularContribMulCoef=this.specularContribMulCoef;l.specularContribAddCoef=this.specularContribAddCoef;l.emissionColor.copy(this.emissionColor);l.emissionColorMap=this.emissionColorMap;l.emissionColorAddCoef=this.emissionColorAddCoef;l.emissionColorMulCoef=this.emissionColorMulCoef;l.emissionColorUvTransform=this.emissionColorUvTransform;l.emissionValue=this.emissionValue;l.emissionNormalized=this.emissionNormalized;l.emissionColorMapLinear=this.emissionColorMapLinear;l.transparency=this.transparency;l.transparencyMap=this.transparencyMap;l.transparencyUvTransform=this.transparencyUvTransform;l.transparencyMulCoef=this.transparencyMulCoef;l.transparencyAddCoef=this.transparencyAddCoef;l.opacity=this.opacity;l.useAlphaFromDiffuseMap=this.useAlphaFromDiffuseMap;l.opacityMap=this.opacityMap;l.opacityUvTransform=this.opacityUvTransform;l.opacityMulCoef=this.opacityMulCoef;l.opacityAddCoef=this.opacityAddCoef;l.ior=this.ior;l.roughness=this.roughness;l.roughnessMap=this.roughnessMap;l.glossinessMap=this.glossinessMap;l.glossinessMulCoef=this.glossinessMulCoef;l.glossinessAddCoef=this.glossinessAddCoef;l.roughnessUvTransform=this.roughnessUvTransform;l.roughnessMulCoef=this.roughnessMulCoef;l.roughnessAddCoef=this.roughnessAddCoef;l.roughnessMapLinear=this.roughnessMapLinear;l.anisotropy=this.anisotropy;l.anisotropyMap=this.anisotropyMap;l.anisotropyUvTransform=this.anisotropyUvTransform;l.anisotropyMulCoef=this.anisotropyMulCoef;l.anisotropyAddCoef=this.anisotropyAddCoef;l.anisotropyAngle=this.anisotropyAngle;l.anisotropyAngleMap=this.anisotropyAngleMap;l.anisotropyAngleUvTransform=this.anisotropyAngleUvTransform;l.anisotropyAngleMulCoef=this.anisotropyAngleMulCoef;l.anisotropyAngleAddCoef=this.anisotropyAngleAddCoef;l.displacementMap=this.displacementMap;l.displacementScale=this.displacementScale;l.displacementBias=this.displacementBias;l.reflectionProbes=this.reflectionProbes;l.sheen=this.sheen;l.sheenMap=this.sheenMap;l.sheenMulCoef=this.sheenMulCoef;l.sheenAddCoef=this.sheenAddCoef;l.sheenUvTransform=this.sheenUvTransform;l.sheenMode=this.sheenMode;l._sheenData=this._sheenData!==null?this._sheenData.clone():null;l.clearCoat=this.clearCoat;l.clearCoatMap=this.clearCoatMap;l.clearCoatAddCoef=this.clearCoatAddCoef;l.clearCoatMulCoef=this.clearCoatMulCoef;l.clearCoatUvTransform=this.clearCoatUvTransform;l.clearCoatRoughnessMap=this.clearCoatRoughnessMap;l.clearCoatRoughnessUvTransform=this.clearCoatRoughnessUvTransform;l.clearCoatRoughnessMulCoef=this.clearCoatRoughnessMulCoef;l.clearCoatRoughnessAddCoef=this.clearCoatRoughnessAddCoef;l.clearCoatRoughnessMapLinear=this.clearCoatRoughnessMapLinear;l.coatingGlossinessMap=this.coatingGlossinessMap;l.coatingGlossinessMulCoef=this.coatingGlossinessMulCoef;l.coatingGlossinessAddCoef=this.coatingGlossinessAddCoef;l.clearCoatRoughness=this.clearCoatRoughness;l.clearCoatNormalMap=this.clearCoatNormalMap;l.clearCoatNormalMapFlipY=this.clearCoatNormalMapFlipY;l.clearCoatNormalUvTransform=this.clearCoatNormalUvTransform;l.clearCoatNormalScaleMulCoef=this.clearCoatNormalScaleMulCoef;l.clearCoatNormalScaleAddCoef=this.clearCoatNormalScaleAddCoef;l.clearCoatNormalScale=this.clearCoatNormalScale;l.orangePeel=this.orangePeel;l.orangePeelScale=this.orangePeelScale;l.envMipMap=this.envMipMap;l.envMap=this.envMap;l.overrideIBL=this.overrideIBL!==null?this.overrideIBL.clone():null;l._subsurface=this._subsurface;l._sssLUT=this._sssLUT;l._sssIBLLUT=this._sssIBLLUT;l._translucencyLUT=this._translucencyLUT;l.translucencyScale=this.translucencyScale;l._scatteringCoeffs=this._scatteringCoeffs?this._scatteringCoeffs.slice(0):null;l._absorptionCoeffs=this._absorptionCoeffs?this._absorptionCoeffs.slice(0):null;l.attenuationColor.copy(this.attenuationColor);l.attenuationDistance=this.attenuationDistance;l.subsurfaceColor.copy(this.subsurfaceColor);l.subsurfacePreset=this.subsurfacePreset;l.updateSSS=this.updateSSS;l.bumpMap=this.bumpMap;l.bumpScale=this.bumpScale;l.bumpScaleMulCoef=this.bumpScaleMulCoef;l.bumpScaleAddCoef=this.bumpScaleAddCoef;l.normalMap=this.normalMap;l.normalScale.copy(this.normalScale);l.normalScaleMulCoef=this.normalScaleMulCoef;l.normalScaleAddCoef=this.normalScaleAddCoef;l.normalMapFlipY=this.normalMapFlipY;l.normalUvTransform=this.normalUvTransform;l.lightMap=this.lightMap;l.lightMapMode=this.lightMapMode;l.lightMapLinear=this.lightMapLinear;if(typeof this.flakes!=="undefined"){l.flakes=this.flakes;l.flakesMode=j.mobileVersion?Math.max(1,this.flakesMode):this.flakesMode;l.flakesColor.copy(this.flakesColor);l.flakesBump=this.flakesBump;l.flakesDensity=this.flakesDensity;l.flakesScale=this.flakesScale;l.flakesRoughness=this.flakesRoughness;l.flakesColorMulCoef=this.flakesColorMulCoef;l.flakesColorAddCoef=this.flakesColorAddCoef;l.pearlFlakesColor.copy(this.pearlFlakesColor);l.pearlFlakesBump=this.pearlFlakesBump;l.pearlFlakesDensity=this.pearlFlakesDensity;l.pearlFlakesColorMulCoef=this.pearlFlakesColorMulCoef;l.pearlFlakesColorAddCoef=this.pearlFlakesColorAddCoef}else{l.flakesSize=this.flakesSize;l.flakesSizeUvTransform=this.flakesSizeUvTransform;l.flakesSizeMap=this.flakesSizeMap;l.flakesSizeAddCoef=this.flakesSizeAddCoef;l.flakesSizeMulCoef=this.flakesSizeMulCoef;l.flakesCoverage=this.flakesCoverage;l.flakesCoverageUvTransform=this.flakesCoverageUvTransform;l.flakesCoverageMap=this.flakesCoverageMap;l.flakesCoverageAddCoef=this.flakesCoverageAddCoef;l.flakesCoverageMulCoef=this.flakesCoverageMulCoef;l.flakesRoughness=this.flakesRoughness;l.flakesRoughnessUvTransform=this.flakesRoughnessUvTransform;l.flakesRoughnessMap=this.flakesRoughnessMap;l.flakesRoughnessAddCoef=this.flakesRoughnessAddCoef;l.flakesRoughnessMulCoef=this.flakesRoughnessMulCoef;l.flakesRoughnessMapLinear=this.flakesRoughnessMapLinear;l.flakesColor.copy(this.flakesColor);l.flakesColorUvTransform=this.flakesColorUvTransform;l.flakesColorMap=this.flakesColorMap;l.flakesColorAddCoef=this.flakesColorAddCoef;l.flakesColorMulCoef=this.flakesColorMulCoef;l.flakesColorMapLinear=this.flakesColorMapLinear}l._gasLook=this._gasLook;l.needTangent=this.needTangent;l.needTangentBinormal=this.needTangentBinormal;l.NRECompatibility=this.NRECompatibility;l.sslr=this.sslr;l.uvSlots={diffuseMap:this.uvSlots.diffuseMap,specularMap:this.uvSlots.specularMap,roughnessMap:this.uvSlots.roughnessMap,normalMap:this.uvSlots.normalMap,lightMap:this.uvSlots.lightMap};l.ambienceMatrix=this.ambienceMatrix;l.parallaxCorrectionParameters=this.parallaxCorrectionParameters;l.useFiniteEnvMap=this.useFiniteEnvMap;return l};j.PhysicalMaterial.prototype.setOverrideIBL=function(l){this.overrideIBL=new j.IBLOverrider(l);if(this._sheenData!==null){this._sheenData.overrideIBL.hdr=this.overrideIBL.hdr}this.needsUpdate=true};j.PhysicalMaterial.prototype.setSubsurfaceScatteringPreset=function(l){this.subsurfacePreset=l;j._SubsurfaceScatteringPresets.setValues(this)};j.PhysicalMaterial.prototype.setSubsurfaceScatteringParams=function(r){if(r){this.attenuationColor=r.attenuationColor?r.attenuationColor.clone():this.attenuationColor;this.attenuationDistance=r.attenuationDistance?r.attenuationDistance:this.attenuationDistance;this.subsurfaceColor=r.subsurfaceColor?r.subsurfaceColor.clone():this.subsurfaceColor;this._subsurface=this.subsurfaceColor.getHex()>0;if(this._subsurface){var m=this.attenuationColor;var q=this.attenuationDistance;var n=this.subsurfaceColor;var s=new j.Color(0);s.r=-Math.log(m.r)/q;s.b=-Math.log(m.b)/q;s.g=-Math.log(m.g)/q;var o=new j.Color(0);o.r=1-Math.pow(4.09712+4.20863*n.r-Math.sqrt(9.59217+41.6808*n.r+17.7126*n.r*n.r),2);o.b=1-Math.pow(4.09712+4.20863*n.b-Math.sqrt(9.59217+41.6808*n.b+17.7126*n.b*n.b),2);o.g=1-Math.pow(4.09712+4.20863*n.g-Math.sqrt(9.59217+41.6808*n.g+17.7126*n.g*n.g),2);var l=new j.Color(0);l.r=s.r*(1-o.r);l.g=s.g*(1-o.g);l.b=s.b*(1-o.b);this._absorptionCoeffs=l.toArray();var p=new j.Color(0);p.r=s.r*o.r;p.g=s.g*o.g;p.b=s.b*o.b;this._scatteringCoeffs=p.toArray();this.subsurfacePreset=j.SubsurfaceScatteringPresets.None;this.updateSSS=true}}};j.PhysicalMaterial.prototype._updateSubsurfaceScattering=function(l){if(l===null||!l.ready){return}if(this.updateSSS&&!this.thinWalled){this.needsUpdate=this._sssLUT===null;var m={absorptionCoeffs:this._absorptionCoeffs,scatteringCoeffs:this._scatteringCoeffs,eta:this.ior};if(this._sssLUT!==null){l.decreaseUseCount(this._sssLUT.id)}var n=l.compute(m);this._sssLUT=n.sssLUT;this._sssIBLLUT=n.sssIBLLUT;this._translucencyLUT=n.translucencyLUT;this.updateSSS=false}};j.PhysicalMaterial.prototype.activatePDSFX=function(){this._PDSFXData=new j._PDSFXData();this._PDSFXData.PDSFX=true;this._setDefaultPDSFXOverridableFunctions();this._PDSFXData.PDSFX_hasAlbedo=true;this._PDSFXData.PDSFX_hasEmissive=true;this._PDSFXData.PDSFX_hasTransparency=true;this._PDSFXData.PDSFX_hasSpecular=true};j.PhysicalMaterial.prototype.setSheen=function(o){this.sheenMode=o.sheenMode||this.sheenMode;this.sheenMap=o.sheenMap||this.sheenMap;var n=Math.max(0,Math.min(0.99,o.sheen));var m=this.sheen;this.sheen=n;if((this.sheen>0||this.sheenMap!==null)&&this.sheenMode===j.SheenMode.NO_SHEEN){this.sheenMode=j.SheenMode.VELVET}if(this.sheenMode!==j.SheenMode.NO_SHEEN){if(this._sheenData===null){var l=null;if(this.overrideIBL!==null){l=this.overrideIBL.clone();l.mips=null}else{l=new j.IBLOverrider({})}switch(this.sheenMode){case j.SheenMode.VELVET:l.brdf="ASHIKMIN";break;case j.SheenMode.SATIN:l.brdf="BECKMANN";break;default:}this._sheenData=new j.SheenData({overrideIBL:l})}else{switch(this.sheenMode){case j.SheenMode.VELVET:this._sheenData.overrideIBL.brdf="ASHIKMIN";break;case j.SheenMode.SATIN:this._sheenData.overrideIBL.brdf="BECKMANN";break;default:}if(this.overrideIBL!==null){this._sheenData.overrideIBL.hdr=this.overrideIBL.hdr}}}this.needsUpdate=(this.sheen>0&&m===0||this.sheen===0&&m>0||this.sheenMap!==null)};j.PhysicalMaterial.prototype.loadUniformsFlakes=function(n,p,l,o){if(typeof this.flakes!=="undefined"){if(this.flakes){var m;if(l.flakesColor){if(n.gammaInput){if(this.NRECompatibility){m=new j.Color().copyGammaToLinearNRECompatible(this.flakesColor)}else{m=new j.Color().copyGammaToLinear(this.flakesColor)}}else{m=this.flakesColor}p.uniform3f(l.flakesColor,m.r,m.g,m.b)}if(l.pearlFlakesColor){if(n.gammaInput){if(this.NRECompatibility){m=new j.Color().copyGammaToLinearNRECompatible(this.pearlFlakesColor)}else{m=new j.Color().copyGammaToLinear(this.pearlFlakesColor)}}else{m=this.pearlFlakesColor}p.uniform3f(l.pearlFlakesColor,m.r,m.g,m.b)}if(l.flakesBump){p.uniform1f(l.flakesBump,this.flakesBump)}if(l.flakesDensity){p.uniform1f(l.flakesDensity,this.flakesDensity)}if(l.flakesScale){p.uniform1f(l.flakesScale,this.flakesScale)}if(l.flakesRoughness){p.uniform1f(l.flakesRoughness,this.flakesRoughness)}if(l.pearlFlakesDensity){p.uniform1f(l.pearlFlakesDensity,this.pearlFlakesDensity)}if(l.pearlFlakesBump){p.uniform1f(l.pearlFlakesBump,this.pearlFlakesBump)}if(this.flakesColorMulCoef&&l.flakesColorMulCoef){p.uniform3f(l.flakesColorMulCoef,this.flakesColorMulCoef.x,this.flakesColorMulCoef.y,this.flakesColorMulCoef.z)}if(this.flakesColorAddCoef&&l.flakesColorAddCoef){p.uniform3f(l.flakesColorAddCoef,this.flakesColorAddCoef.x,this.flakesColorAddCoef.y,this.flakesColorAddCoef.z)}if(this.pearlFlakesColorMulCoef&&l.pearlFlakesColorMulCoef){p.uniform3f(l.pearlFlakesColorMulCoef,this.pearlFlakesColorMulCoef.x,this.pearlFlakesColorMulCoef.y,this.pearlFlakesColorMulCoef.z)}if(this.pearlFlakesColorAddCoef&&l.pearlFlakesColorAddCoef){p.uniform3f(l.pearlFlakesColorAddCoef,this.pearlFlakesColorAddCoef.x,this.pearlFlakesColorAddCoef.y,this.pearlFlakesColorAddCoef.z)}}}else{if(this.flakesCoverage>0||this.flakesCoverageMap){var m;if(l.flakesColor){if(n.gammaInput){if(this.NRECompatibility){m=new j.Color().copyGammaToLinearNRECompatible(this.flakesColor)}else{m=new j.Color().copyGammaToLinear(this.flakesColor)}}else{m=this.flakesColor}p.uniform3f(l.flakesColor,m.r,m.g,m.b)}if(l.flakesColorMulCoef){p.uniform3f(l.flakesColorMulCoef,this.flakesColorMulCoef.x,this.flakesColorMulCoef.y,this.flakesColorMulCoef.z)}if(l.flakesColorAddCoef){p.uniform3f(l.flakesColorAddCoef,this.flakesColorAddCoef.x,this.flakesColorAddCoef.y,this.flakesColorAddCoef.z)}if(l.flakesCoverage){p.uniform1f(l.flakesCoverage,this.flakesCoverage)}if(this.flakesCoverageMap){n.loadTexture(p,l.flakesCoverageMap,this.flakesCoverageMap)}if(l.flakesCoverageMulCoef){p.uniform1f(l.flakesCoverageMulCoef,this.flakesCoverageMulCoef)}if(l.flakesCoverageAddCoef){p.uniform1f(l.flakesCoverageAddCoef,this.flakesCoverageAddCoef)}if(l.flakesSize){p.uniform1f(l.flakesSize,this.flakesSize)}if(this.flakesSizeMap){n.loadTexture(p,l.flakesSizeMap,this.flakesSizeMap)}if(l.flakesSizeMulCoef){p.uniform1f(l.flakesSizeMulCoef,this.flakesSizeMulCoef)}if(l.flakesSizeAddCoef){p.uniform1f(l.flakesSizeAddCoef,this.flakesSizeAddCoef)}if(l.flakesRoughness){p.uniform1f(l.flakesRoughness,this.flakesRoughness)}if(this.flakesRoughnessMap){n.loadTexture(p,l.flakesRoughnessMap,this.flakesRoughnessMap)}if(l.flakesRoughnessMulCoef){p.uniform1f(l.flakesRoughnessMulCoef,this.flakesRoughnessMulCoef)}if(l.flakesRoughnessAddCoef){p.uniform1f(l.flakesRoughnessAddCoef,this.flakesRoughnessAddCoef)}if(this.NRECompatibility){if(l.flakesRoughnessUvTransform){n.loadMatrix3(p,l.flakesRoughnessUvTransform,this.flakesRoughnessUvTransform?this.flakesRoughnessUvTransform:new j.Matrix3())}if(l.flakesSizeUvTransform){n.loadMatrix3(p,l.flakesSizeUvTransform,this.flakesSizeUvTransform?this.flakesSizeUvTransform:new j.Matrix3())}if(l.flakesCoverageUvTransform){n.loadMatrix3(p,l.flakesCoverageUvTransform,this.flakesCoverageUvTransform?this.flakesCoverageUvTransform:new j.Matrix3())}if(l.flakesColorUvTransform){n.loadMatrix3(p,l.flakesColorUvTransform,this.flakesColorUvTransform?this.flakesColorUvTransform:new j.Matrix3())}}}}};j.PhysicalMaterial.prototype.loadUniformsCoating=function(m,o,l,n){if(this.clearCoat>0){if(l.clearCoat){o.uniform1f(l.clearCoat,this.clearCoat)}if(l.clearCoatMap){m.loadTexture(o,l.clearCoatMap,this.clearCoatMap)}if(l.clearCoatMulCoef){o.uniform1f(l.clearCoatMulCoef,this.clearCoatMulCoef)}if(l.clearCoatAddCoef){o.uniform1f(l.clearCoatAddCoef,this.clearCoatAddCoef)}if(l.clearCoatRoughness){o.uniform1f(l.clearCoatRoughness,this.clearCoatRoughness)}if(l.clearCoatRoughnessMap){m.loadTexture(o,l.clearCoatRoughnessMap,this.clearCoatRoughnessMap)}if(l.clearCoatRoughnessMulCoef){o.uniform1f(l.clearCoatRoughnessMulCoef,this.clearCoatRoughnessMulCoef)}if(l.clearCoatRoughnessAddCoef){o.uniform1f(l.clearCoatRoughnessAddCoef,this.clearCoatRoughnessAddCoef)}if(l.coatingGlossinessMap){m.loadTexture(o,l.coatingGlossinessMap,this.coatingGlossinessMap)}if(l.coatingGlossinessMulCoef){o.uniform1f(l.coatingGlossinessMulCoef,this.coatingGlossinessMulCoef)}if(l.coatingGlossinessAddCoef){o.uniform1f(l.coatingGlossinessAddCoef,this.coatingGlossinessAddCoef)}if(l.clearCoatNormalMap){m.loadTexture(o,l.clearCoatNormalMap,this.clearCoatNormalMap)}if(l.clearCoatNormalScale){o.uniform1f(l.clearCoatNormalScale,this.clearCoatNormalScaleMulCoef*this.clearCoatNormalScale+this.clearCoatNormalScaleAddCoef)}if(l.orangePeelScale){if(l.orangePeelScale){o.uniform1f(l.orangePeelScale,this.orangePeelScale)}}if(this.NRECompatibility){if(l.clearCoatRoughnessUvTransform){m.loadMatrix3(o,l.clearCoatRoughnessUvTransform,this.clearCoatRoughnessUvTransform?this.clearCoatRoughnessUvTransform:new j.Matrix3())}if(l.clearCoatNormalUvTransform){m.loadMatrix3(o,l.clearCoatNormalUvTransform,this.clearCoatNormalUvTransform?this.clearCoatNormalUvTransform:new j.Matrix3())}}}};j.PhysicalMaterial.prototype.loadUniformsSSS=function(m,o,l,n){if(this._subsurface&&!this.thinWalled){if(l.sssLUT){m.loadTexture(o,l.sssLUT,this._sssLUT)}if(l.sssIBLLUT){m.loadTexture(o,l.sssIBLLUT,this._sssIBLLUT)}if(l.translucencyScale){o.uniform1f(l.translucencyScale,this.translucencyScale)}if(l.translucencyLUT){m.loadTexture(o,l.translucencyLUT,this._translucencyLUT)}}};j.PhysicalMaterial.prototype.loadUniformsSheen=function(m,o,l,n){if(this.sheen>0||this.sheenMap){if(l.sheen){o.uniform1f(l.sheen,this.sheen)}if(l.sheenMap){m.loadTexture(o,l.sheenMap,this.sheenMap)}if(l.sheenMulCoef){o.uniform1f(l.sheenMulCoef,this.sheenMulCoef)}if(l.sheenAddCoef){o.uniform1f(l.sheenAddCoef,this.sheenAddCoef)}if(this.NRECompatibility){if(l.sheenUvTransform){m.loadMatrix3(o,l.sheenUvTransform,this.sheenUvTransform?this.sheenUvTransform:new j.Matrix3())}}if(this._sheenData!==null&&this._sheenData.envMipMap!==null&&l.envMapSheen){m.loadTexture(o,l.envMapSheen,this._sheenData.envMipMap)}}};j.PhysicalMaterial.prototype.loadUniforms=function(q,p,r,m){q.loadUniformsCommon(p,this,r,m);q.loadUniformsNormalMap(p,this,r);q.loadUniformsSkinning(p,this,r);if(this.sslr){if(r.screenSize){p.uniform2f(r.screenSize,q.domElement.width,q.domElement.height)}if(r.invScreenSize){p.uniform2f(r.invScreenSize,1/q.domElement.width,1/q.domElement.height)}if(r.prevColorTexture){q.loadTexture(p,r.prevColorTexture,this.__prevColorTexture)}if(r.prevNormalDepthTexture){q.loadTexture(p,r.prevNormalDepthTexture,this.__prevNormalDepthTexture)}}if(r.normalScale){var o=this.normalScale.clone();o.multiplyScalar(this.normalScaleMulCoef);o.addScalar(this.normalScaleAddCoef);p.uniform2f(r.normalScale,o.x,o.y)}if(this.bumpMap){if(r.bumpScale){p.uniform1f(r.bumpScale,this.bumpScale*this.bumpScaleMulCoef+this.bumpScaleAddCoef)}if(r.bumpMap){q.loadTexture(p,r.bumpMap,this.bumpMap)}}if(r.diffuseAddCoef){p.uniform3f(r.diffuseAddCoef,this.diffuseAddCoef.x,this.diffuseAddCoef.y,this.diffuseAddCoef.z)}if(r.diffuseMulCoef){p.uniform3f(r.diffuseMulCoef,this.diffuseMulCoef.x,this.diffuseMulCoef.y,this.diffuseMulCoef.z)}if(r.specular){var l;var s=this.specular;if(q.gammaInput){if(this.NRECompatibility){l=new j.Color().copyGammaToLinearNRECompatible(s)}else{l=new j.Color().copyGammaToLinear(s)}}else{l=s}p.uniform3f(r.specular,l.r,l.g,l.b)}if(r.specularAddCoef){p.uniform3f(r.specularAddCoef,this.specularAddCoef.x,this.specularAddCoef.y,this.specularAddCoef.z)}if(r.specularMulCoef){p.uniform3f(r.specularMulCoef,this.specularMulCoef.x,this.specularMulCoef.y,this.specularMulCoef.z)}if(r.metalness){p.uniform1f(r.metalness,this.metalness)}if(this.metalnessMap){q.loadTexture(p,r.metalnessMap,this.metalnessMap)}if(r.metalnessMulCoef){p.uniform1f(r.metalnessMulCoef,this.metalnessMulCoef)}if(r.metalnessAddCoef){p.uniform1f(r.metalnessAddCoef,this.metalnessAddCoef)}if(r.specularContrib){p.uniform1f(r.specularContrib,this.specularContrib)}if(this.specularContribMap){q.loadTexture(p,r.specularContribMap,this.specularContribMap)}if(r.specularContribMulCoef){p.uniform1f(r.specularContribMulCoef,this.specularContribMulCoef)}if(r.specularContribAddCoef){p.uniform1f(r.specularContribAddCoef,this.specularContribAddCoef)}if(r.emissionColor){var l=this.emissionColor;if(q.gammaInput){if(this.NRECompatibility){l=new j.Color().copyGammaToLinearNRECompatible(this.emissionColor)}else{l=new j.Color().copyGammaToLinear(this.emissionColor)}}p.uniform3f(r.emissionColor,l.r,l.g,l.b)}if(this.emissionColorMap){q.loadTexture(p,r.emissionColorMap,this.emissionColorMap)}if(r.emissionColorAddCoef){p.uniform3f(r.emissionColorAddCoef,this.emissionColorAddCoef.x,this.emissionColorAddCoef.y,this.emissionColorAddCoef.z)}if(r.emissionColorMulCoef){p.uniform3f(r.emissionColorMulCoef,this.emissionColorMulCoef.x,this.emissionColorMulCoef.y,this.emissionColorMulCoef.z)}if(r.emissionValue){p.uniform1f(r.emissionValue,this.emissionValue)}if(r.transparency){p.uniform1f(r.transparency,this.transparency)}if(this.transparencyMap){q.loadTexture(p,r.transparencyMap,this.transparencyMap)}if(r.transparencyMulCoef){p.uniform1f(r.transparencyMulCoef,this.transparencyMulCoef)}if(r.transparencyAddCoef){p.uniform1f(r.transparencyAddCoef,this.transparencyAddCoef)}if(this.opacityMap){q.loadTexture(p,r.opacityMap,this.opacityMap)}if(r.opacityMulCoef){p.uniform1f(r.opacityMulCoef,this.opacityMulCoef)}if(r.opacityAddCoef){p.uniform1f(r.opacityAddCoef,this.opacityAddCoef)}if(r.ior){p.uniform1f(r.ior,this.ior)}if(r.roughness){p.uniform1f(r.roughness,this.roughness)}if(this.roughnessMap){q.loadTexture(p,r.roughnessMap,this.roughnessMap)}if(r.roughnessMulCoef){p.uniform1f(r.roughnessMulCoef,this.roughnessMulCoef)}if(r.roughnessAddCoef){p.uniform1f(r.roughnessAddCoef,this.roughnessAddCoef)}if(this.glossinessMap){q.loadTexture(p,r.glossinessMap,this.glossinessMap)}if(r.glossinessMulCoef){p.uniform1f(r.glossinessMulCoef,this.glossinessMulCoef)}if(r.glossinessAddCoef){p.uniform1f(r.glossinessAddCoef,this.glossinessAddCoef)}if(r.anisotropy){p.uniform1f(r.anisotropy,this.anisotropy)}if(r.anisotropyMap){q.loadTexture(p,r.anisotropyMap,this.anisotropyMap)}if(r.anisotropyMulCoef){p.uniform1f(r.anisotropyMulCoef,this.anisotropyMulCoef)}if(r.anisotropyAddCoef){p.uniform1f(r.anisotropyAddCoef,this.anisotropyAddCoef)}if(r.anisotropyAngle){p.uniform1f(r.anisotropyAngle,this.anisotropyAngle)}if(r.anisotropyAngleMap){q.loadTexture(p,r.anisotropyAngleMap,this.anisotropyAngleMap)}if(r.anisotropyAngleMulCoef){p.uniform1f(r.anisotropyAngleMulCoef,this.anisotropyAngleMulCoef)}if(r.anisotropyAngleAddCoef){p.uniform1f(r.anisotropyAngleAddCoef,this.anisotropyAngleAddCoef)}if(r.displacementMap){q.loadTexture(p,r.displacementMap,this.displacementMap)}if(r.displacementBias){p.uniform1f(r.displacementBias,this.displacementBias)}if(r.displacementScale){p.uniform1f(r.displacementScale,this.displacementScale)}if(this.useFiniteEnvMap){if(r.sphereCenter){p.uniform3f(r.sphereCenter,this.parallaxCorrectionParameters.sphereCenter.x,this.parallaxCorrectionParameters.sphereCenter.y,this.parallaxCorrectionParameters.sphereCenter.z)}if(r.projectionCenter){p.uniform3f(r.projectionCenter,this.parallaxCorrectionParameters.projectionCenter.x,this.parallaxCorrectionParameters.projectionCenter.y,this.parallaxCorrectionParameters.projectionCenter.z)}if(r.sphereRadius){p.uniform1f(r.sphereRadius,this.parallaxCorrectionParameters.sphereRadius)}}if(this.reflectionProbes&&this.reflectionProbes.length){if(r.reflectionProbe){q.loadTexture(p,r.reflectionProbe,this.reflectionProbes[0].map0)}if(r.reflectionProbeMips){q.loadTexture(p,r.reflectionProbeMips,this.reflectionProbes[0].map1)}if(r.reflectionProbePos){p.uniform3f(r.reflectionProbePos,this.reflectionProbes[0].position.x,this.reflectionProbes[0].position.y,this.reflectionProbes[0].position.z)}if(r.reflectionProbeProxyMin){p.uniform3f(r.reflectionProbeProxyMin,this.reflectionProbes[0].geomProxy.min.x,this.reflectionProbes[0].geomProxy.min.y,this.reflectionProbes[0].geomProxy.min.z)}if(r.reflectionProbeProxyMax){p.uniform3f(r.reflectionProbeProxyMax,this.reflectionProbes[0].geomProxy.max.x,this.reflectionProbes[0].geomProxy.max.y,this.reflectionProbes[0].geomProxy.max.z)}}this.loadUniformsFlakes(q,p,r,m);this.loadUniformsCoating(q,p,r,m);this.loadUniformsSheen(q,p,r,m);if(r.precomputedTexture1){var n=q.precomputedTexture1;if(n&&n.onRequest){n.onRequest();n.onRequest=null}q.loadTexture(p,r.precomputedTexture1,n)}if(r.precomputedTexture2){var n=q.precomputedTexture2;if(n&&n.onRequest){n.onRequest();n.onRequest=null}q.loadTexture(p,r.precomputedTexture2,n)}if(r.precomputedTexture3){var n=q.precomputedTexture3;if(n&&n.onRequest){n.onRequest();n.onRequest=null}q.loadTexture(p,r.precomputedTexture3,n)}if(this.envMipMap&&this.envMipMap[0]){if(r.envMap){q.loadTexture(p,r.envMap,this.envMipMap[0])}if(r.envMap2){q.loadTexture(p,r.envMap2,this.envMipMap[1])}if(this.envMipMap[0]&&this.envMipMap[0].hdr&&this.envMipMap[0].image){if(r.envMapHDRSize){p.uniform2f(r.envMapHDRSize,parseInt(this.envMipMap[0].image.width),parseInt(this.envMipMap[0].image.height))}}var t=this.envMipMap[0].envMapExposure;if(r.envMapExposure){p.uniform1f(r.envMapExposure,(t||(t===0))?t:1)}if(r.ambienceMatrix){p.uniformMatrix4fv(r.ambienceMatrix,false,this.ambienceMatrix.elements)}}this.loadUniformsSSS(q,p,r,m);if(this.NRECompatibility){if(r.normalUvTransform){q.loadMatrix3(p,r.normalUvTransform,this.normalUvTransform?this.normalUvTransform:new j.Matrix3())}if(r.diffuseUvTransform){q.loadMatrix3(p,r.diffuseUvTransform,this.diffuseUvTransform?this.diffuseUvTransform:new j.Matrix3())}if(r.specularUvTransform){q.loadMatrix3(p,r.specularUvTransform,this.specularUvTransform?this.specularUvTransform:new j.Matrix3())}if(r.metalnessUvTransform){q.loadMatrix3(p,r.metalnessUvTransform,this.metalnessUvTransform?this.metalnessUvTransform:new j.Matrix3())}if(r.emissionColorUvTransform){q.loadMatrix3(p,r.emissionColorUvTransform,this.emissionColorUvTransform?this.emissionColorUvTransform:new j.Matrix3())}if(r.specularContribUvTransform){q.loadMatrix3(p,r.specularContribUvTransform,this.specularContribUvTransform?this.specularContribUvTransform:new j.Matrix3())}if(r.transparencyUvTransform){q.loadMatrix3(p,r.transparencyUvTransform,this.transparencyUvTransform?this.transparencyUvTransform:new j.Matrix3())}if(r.opacityUvTransform){q.loadMatrix3(p,r.opacityUvTransform,this.opacityUvTransform?this.opacityUvTransform:new j.Matrix3())}if(r.roughnessUvTransform){q.loadMatrix3(p,r.roughnessUvTransform,this.roughnessUvTransform?this.roughnessUvTransform:new j.Matrix3())}if(r.anisotropyUvTransform){q.loadMatrix3(p,r.anisotropyUvTransform,this.anisotropyUvTransform?this.anisotropyUvTransform:new j.Matrix3())}if(r.anisotropyAngleUvTransform){q.loadMatrix3(p,r.anisotropyAngleUvTransform,this.anisotropyAngleUvTransform?this.anisotropyAngleUvTransform:new j.Matrix3())}}};j.ShaderChunk.lights_physicalDS_pars_vertex=["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform int pointLightPhysicalAttenuation[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform int spotLightPhysicalAttenuation[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#if MAX_IES_LIGHTS > 0","uniform vec3 iesLightPosition[ MAX_IES_LIGHTS ];","uniform float iesLightDistance[ MAX_IES_LIGHTS ];","varying vec4 viesLight[ MAX_IES_LIGHTS ];","uniform sampler2D iesLightTexture[ MAX_IES_LIGHTS ];","uniform mat4 matrixWorldInv[MAX_IES_LIGHTS];","#endif","#endif","#if MAX_TUBE_LIGHTS > 0 || MAX_AREA_LIGHTS > 0 || MAX_DISK_LIGHTS > 0 || MAX_SPHERE_LIGHTS > 0","#define HAS_AREA_LIGHTS","#endif","varying vec3 vWorldPosition;","varying vec3 vWorldNormal;",].join("\n");j.ShaderChunk.lights_physicalDS_vertex=["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","vPointLight[ i ] = vec4( lVector, lDistance );","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","vSpotLight[ i ] = vec4( lVector, lDistance );","}","#endif","#if MAX_IES_LIGHTS > 0","for( int i = 0; i < MAX_IES_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( iesLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( iesLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / iesLightDistance[ i ] ), 1.0 );","viesLight[ i ] = vec4( lVector, lDistance );","}","#endif","#endif","vWorldPosition = worldPosition.xyz;","vWorldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","vWorldNormal = normalize( vWorldNormal );",].join("\n");j.ShaderChunk.madCoefficients_pars_fragment=["#ifdef USE_DIFFUSE_COEFFICIENTS","uniform vec3 diffuseMulCoef;","uniform vec3 diffuseAddCoef;","#endif","#ifdef USE_SPECULAR_COEFFICIENTS","uniform vec3 specularMulCoef;","uniform vec3 specularAddCoef;","#endif","#ifdef USE_METALNESS_COEFFICIENTS","uniform float metalnessMulCoef;","uniform float metalnessAddCoef;","#endif","#ifdef USE_SPECULARCONTRIB_COEFFICIENTS","uniform float specularContribMulCoef;","uniform float specularContribAddCoef;","#endif","#ifdef USE_EMISSIONCOLOR_COEFFICIENTS","uniform vec3 emissionColorMulCoef;","uniform vec3 emissionColorAddCoef;","#endif","#ifdef USE_TRANSPARENCY_COEFFICIENTS","uniform float transparencyMulCoef;","uniform float transparencyAddCoef;","#endif","#ifdef USE_OPACITY_COEFFICIENTS","uniform float opacityMulCoef;","uniform float opacityAddCoef;","#endif","#ifdef USE_ROUGHNESS_COEFFICIENTS","uniform float roughnessMulCoef;","uniform float roughnessAddCoef;","#endif","#ifdef USE_GLOSSINESS_COEFFICIENTS","uniform float glossinessMulCoef;","uniform float glossinessAddCoef;","#endif","#ifdef USE_ANISOTROPY_COEFFICIENTS","uniform float anisotropyMulCoef;","uniform float anisotropyAddCoef;","#endif","#ifdef USE_ANISOTROPYANGLE_COEFFICIENTS","uniform float anisotropyAngleMulCoef;","uniform float anisotropyAngleAddCoef;","#endif","#ifdef USE_CC_COEFFICIENTS","uniform float clearCoatMulCoef;","uniform float clearCoatAddCoef;","#endif","#ifdef USE_CC_ROUGHNESS_COEFFICIENTS","uniform float clearCoatRoughnessMulCoef;","uniform float clearCoatRoughnessAddCoef;","#endif","#ifdef USE_CC_GLOSSINESS_COEFFICIENTS","uniform float coatingGlossinessMulCoef;","uniform float coatingGlossinessAddCoef;","#endif","#ifdef USE_SHEEN_COEFFICIENTS","uniform float sheenMulCoef;","uniform float sheenAddCoef;","#endif","#ifndef OLD_FLAKES","#ifdef USE_FLAKESCOLOR_COEFFICIENTS","uniform vec3 flakesColorMulCoef;","uniform vec3 flakesColorAddCoef;","#endif","#endif","#ifdef USE_FLAKESSIZE_COEFFICIENTS","uniform float flakesSizeMulCoef;","uniform float flakesSizeAddCoef;","#endif","#ifdef USE_FLAKESCOVERAGE_COEFFICIENTS","uniform float flakesCoverageMulCoef;","uniform float flakesCoverageAddCoef;","#endif","#ifdef USE_FLAKESROUGHNESS_COEFFICIENTS","uniform float flakesRoughnessMulCoef;","uniform float flakesRoughnessAddCoef;","#endif",].join("\n");j.ShaderChunk.lights_uniform_fragment=["#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","uniform float directionalLightNear[ MAX_DIR_LIGHTS ];","uniform float directionalLightFar[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform int pointLightPhysicalAttenuation[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#else","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#endif","#if MAX_IES_LIGHTS > 0","uniform vec3 iesLightColor[ MAX_IES_LIGHTS ];","uniform sampler2D iesLightTexture[ MAX_IES_LIGHTS ];","uniform mat4 matrixWorldInv[MAX_IES_LIGHTS];","#ifdef PHONG_PER_PIXEL","uniform vec3 iesLightPosition[ MAX_IES_LIGHTS ];","uniform float iesLightDistance[ MAX_IES_LIGHTS ];","#else","varying vec4 viesLight[ MAX_IES_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightInnerAngleCos[ MAX_SPOT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform int spotLightPhysicalAttenuation[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#else","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPHERE_LIGHTS > 0","uniform vec3 sphereLightColor[ MAX_SPHERE_LIGHTS ];","uniform vec3 sphereLightPosition[ MAX_SPHERE_LIGHTS ];","uniform vec3 sphereLightData[ MAX_SPHERE_LIGHTS ];","#endif","#if MAX_DISK_LIGHTS > 0","uniform vec3 diskLightColor[ MAX_DISK_LIGHTS ];","uniform vec3 diskLightPosition[ MAX_DISK_LIGHTS ];","uniform vec3 diskLightNormal[ MAX_DISK_LIGHTS ];","uniform vec3 diskLightData[ MAX_DISK_LIGHTS ];","#endif","#if MAX_AREA_LIGHTS > 0","uniform vec3 areaLightColor[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightPosition[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightNormal[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightRight[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightUp[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightData[ MAX_AREA_LIGHTS ];","#endif","#if MAX_TUBE_LIGHTS > 0","uniform vec3 tubeLightColor[ MAX_TUBE_LIGHTS ];","uniform vec3 tubeLightPosition[ MAX_TUBE_LIGHTS ];","uniform vec3 tubeLightRight[ MAX_TUBE_LIGHTS ];","uniform vec3 tubeLightData[ MAX_TUBE_LIGHTS ];","#endif","#if MAX_TUBE_LIGHTS > 0 || MAX_AREA_LIGHTS > 0 || MAX_DISK_LIGHTS > 0 || MAX_SPHERE_LIGHTS > 0","#define HAS_AREA_LIGHTS","#endif","#ifdef HAS_AREA_LIGHTS","uniform sampler2D precomputedAreaGGX1texture;","uniform sampler2D precomputedAreaGGX2texture;","#ifdef USE_SHEEN","uniform sampler2D precomputedAreaSheentexture;","#endif","#endif","#ifdef USE_LIGHTMAP","uniform sampler2D lightMap;","#endif","uniform vec3 ambientLightColor;"].join("\n");j.ShaderChunk.physicalDS_uniforms_pars_fragment=[j.ShaderChunk.PDSFX_albedo_pars_fragment,"#ifdef USE_MAP","uniform mat3 diffuseUvTransform;","#endif",j.ShaderChunk.PDSFX_specular_pars_fragment,"#ifdef USE_SPECULARMAP","uniform mat3 specularUvTransform;","#endif","uniform vec3 emissionColor;","uniform float emissionValue;","#ifdef USE_EMISSIONCOLORMAP","uniform sampler2D emissionColorMap;","uniform mat3 emissionColorUvTransform;","#endif",j.ShaderChunk.PDSFX_transparency_pars_fragment,"#ifdef USE_TRANSPARENCYMAP","uniform sampler2D transparencyMap;","uniform mat3 transparencyUvTransform;","#endif",j.ShaderChunk.PDSFX_opacity_pars_fragment,"#ifdef USE_OPACITYMAP","uniform sampler2D opacityMap;","uniform mat3 opacityUvTransform;","#endif","uniform float metalness;","#ifdef USE_METALNESSMAP","uniform sampler2D metalnessMap;","uniform mat3 metalnessUvTransform;","#endif","uniform float specularContrib;","#ifdef USE_SPECULARCONTRIBMAP","uniform sampler2D specularContribMap;","uniform mat3 specularContribUvTransform;","#endif","uniform float ior;","uniform float roughness;","#ifdef USE_ROUGHNESSMAP","uniform sampler2D roughnessMap;","#endif","#ifdef USE_GLOSSINESSMAP","uniform sampler2D glossinessMap;","#endif","#if defined(USE_ROUGHNESSMAP) || defined(USE_GLOSSINESSMAP)","uniform mat3 roughnessUvTransform;","#endif","#ifdef USE_ANISOTROPY","uniform float anisotropy;","uniform float anisotropyAngle;","#ifdef USE_ANISOTROPYMAP","uniform sampler2D anisotropyMap;","uniform mat3 anisotropyUvTransform;","#endif","#ifdef USE_ANISOTROPYANGLEMAP","uniform sampler2D anisotropyAngleMap;","uniform mat3 anisotropyAngleUvTransform;","#endif","#endif","#ifdef USE_SHEEN","uniform float sheen;","#ifdef USE_SHEEN_MAP","uniform sampler2D sheenMap;","uniform mat3 sheenUvTransform;","#endif","#ifdef USE_ENVMAP_SHEEN","uniform sampler2D envMapSheen;","#endif","#endif","#ifdef CLEAR_COAT","uniform float clearCoat;","#ifdef CLEAR_COAT_MAP","uniform sampler2D clearCoatMap;","uniform mat3 clearCoatUvTransform;","#endif","#ifdef CLEAR_COAT_NORMALMAP","uniform sampler2D clearCoatNormalMap;","uniform mat3 clearCoatNormalUvTransform;","#endif","uniform float clearCoatNormalScale;","uniform float clearCoatRoughness;","#ifdef USE_CC_ROUGHNESSMAP","uniform sampler2D clearCoatRoughnessMap;","#endif","#ifdef USE_CC_GLOSSINESSMAP","uniform sampler2D coatingGlossinessMap;","#endif","#if defined(USE_CC_ROUGHNESSMAP) || defined(USE_CC_GLOSSINESSMAP)","uniform mat3 clearCoatRoughnessUvTransform;","#endif","#ifdef USE_ORANGE_PEEL","uniform float orangePeelScale;","#endif","#endif","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","uniform vec3 flakesColor;","uniform float flakesDensity;","uniform float flakesBump;","uniform vec3 flakesColorMulCoef;","uniform vec3 flakesColorAddCoef;","uniform vec3 pearlFlakesColor;","uniform float pearlFlakesDensity;","uniform float pearlFlakesBump;","uniform vec3 pearlFlakesColorMulCoef;","uniform vec3 pearlFlakesColorAddCoef;","uniform float flakesRoughness;","uniform float flakesScale;","#else","uniform vec3 flakesColor;","#ifdef USE_FLAKESCOLOR_MAP","uniform sampler2D flakesColorMap;","uniform mat3 flakesColorUvTransform;","#endif","uniform float flakesCoverage;","#ifdef USE_FLAKESCOVERAGE_MAP","uniform sampler2D flakesCoverageMap;","uniform mat3 flakesCoverageUvTransform;","#endif","uniform float flakesRoughness;","#ifdef USE_FLAKESROUGHNESS_MAP","uniform sampler2D flakesRoughnessMap;","uniform mat3 flakesRoughnessUvTransform;","#endif","uniform float flakesSize;","#ifdef USE_FLAKESSIZE_MAP","uniform sampler2D flakesSizeMap;","uniform mat3 flakesSizeUvTransform;","#endif","#endif","#endif","#ifdef USE_SUBSURFACE","#ifdef USE_SSSLUT","uniform sampler2D sssLUT;","#endif","#ifdef USE_SSSIBLLUT","uniform sampler2D sssIBLLUT;","#endif","#endif","#if defined(USE_TRANSLUCENCY) && defined(USE_SHADOWMAP)","uniform float translucencyScale;","#ifdef USE_TRANSLUCENCYLUT","uniform sampler2D translucencyLUT;","#endif","#endif","#ifdef USE_NORMALMAP","uniform mat3 normalUvTransform;","#endif",].join("\n");j.ShaderChunk.iteration_aniso_pars_fragment=["#if defined(USE_ANISOTROPY)","vec3 ImportanceSampleGGXAniso(vec2 Xi, float roughness, vec3 T, vec3 B, vec3 N, float iAnisotropy) {","vec3 H;","float m = roughness * roughness;","float a_x = m;","float a_y = mix(0.0, m, 1.0 - iAnisotropy);","a_x = max(a_x, kEpsilon);","a_y = max(a_y, kEpsilon);","float coef = sqrt(Xi.y / (1.0 - Xi.y));","H = coef * (a_x * cos(2.0 * PI * Xi.x) * T + a_y * sin(2.0 * PI * Xi.x) * B) + N;","return normalize(H);","}","void SpecularTransmisIBLAniso(inout vec3 specularColor, inout vec3 transmissiveColor, float roughness, vec3 T, vec3 B, vec3 N, vec3 V, float NoV, vec3 specColorF0, vec3 specColorF90, vec2 textureSize, vec2 texelSize, float iAnisotropy, float iAnisotropyAngle) {","vec3 spec = vec3(0.0);","vec3 trans = vec3(0.0);","vec3 Taniso = cos(2.0 * PI * iAnisotropyAngle) * T + sin(2.0 * PI * iAnisotropyAngle) * B;","vec3 Baniso = cross(N, Taniso);","const int nbSamples = 8;","for (int i = 0; i < nbSamples; i++) {","int renderI = i + renderIteration;","int n = (renderI*512)/1024;","int m = int(mod(float(renderI * 512),1024.0));","vec2 E = Hammersley2D(n+m,1024);","vec3 H = ImportanceSampleGGXAniso(E, roughness, Taniso, Baniso, N, iAnisotropy);","vec3 L = 2.0 * dot(V, H) * H - V;","float NoL = clamp(dot(N, L), 0.0, 1.0);","float NoH = clamp(dot(N, H), 0.0, 1.0);","float VoH = clamp(dot(V, H), 0.0, 1.0);","if (NoL > 0.0) {","vec3 worldL = normalize( vec3( vec4( L, 0.0 ) * viewMatrix ) );","#ifdef USE_REFLECTION_PROBE","worldL = correctParallax(vWorldPosition, worldL);","#endif","#ifdef USE_FINITE_ENVMAP","worldL = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, worldL, vWorldPosition);","#endif","vec2 dirUV = getEnvMapUV(worldL);","vec3 worldLt = normalize( vec3( vec4( L - 2.0 * NoL * N, 0.0 ) * viewMatrix ) );","vec2 dirUVt = getEnvMapUV(worldLt);","#ifdef USE_REFLECTION_PROBE","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUV, textureSize, texelSize).xyz;","vec3 colorIBLt = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUVt, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(reflectionProbe, dirUV).xyz;","vec3 colorIBLt = envMapExposure * texture2D(reflectionProbe, dirUVt).xyz;","#endif","#else","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUV, textureSize, texelSize).xyz;","vec3 colorIBLt = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUVt, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(envmap, dirUV).xyz;","vec3 colorIBLt = envMapExposure * texture2D(envmap, dirUVt).xyz;","#endif","#endif","#ifdef USE_SSLR","    vec4 reflectColor = vec4(0.0);","    if (renderIteration > 0) {","        reflectColor = RayMarch(-vViewPosition, L);","        reflectColor *= reflectColor;","    }","    colorIBL = mix(colorIBL, reflectColor.xyz, reflectColor.w);","#endif","float GVis = 0.25 * GeometricSchlick(roughness, NoV, NoL)/max(NoL*NoV,1e-3);","float NoLPDF = 4.0 * NoL * VoH / max(NoH,1e-3);","vec3 F = FresnelSchlick(specColorF0, specColorF90, VoH);","spec += NoLPDF * colorIBL * F * GVis ;","float GVisTrans;","#ifdef THIN_WALLED","GVisTrans =  GVis ;","#else","GVisTrans = (ior*ior)* GeometricSchlick(roughness, NoV, NoL);","float LoH = clamp(dot(L, H), 0.0, 1.0);","GVisTrans *= abs(LoH*VoH)/max(abs(NoL * NoV),1e-6);","GVisTrans /= max(ior*LoH + pow2(ior*VoH),1e-6);","#endif","trans += colorIBLt * GVisTrans*NoLPDF*(1.0 - F);","}","}","specularColor = spec/float(nbSamples);","transmissiveColor = trans/float(nbSamples);","}","void SpecularIBLAniso(inout vec3 specularColor, float roughness, vec3 T, vec3 B, vec3 N, vec3 V, float NoV, vec3 specColorF0, vec3 specColorF90, vec2 textureSize, vec2 texelSize, float iAnisotropy, float iAnisotropyAngle) {","vec3 spec = vec3(0.0);","vec3 trans = vec3(0.0);","vec3 Taniso = cos(2.0 * PI * iAnisotropyAngle) * T + sin(2.0 * PI * iAnisotropyAngle) * B;","vec3 Baniso = cross(N, Taniso);","const int nbSamples = 8;","for (int i = 0; i < nbSamples; i++) {","int renderI = i + renderIteration;","int n = (renderI*512)/1024;","int m = int(mod(float(renderI * 512),1024.0));","vec2 E = Hammersley2D(n+m,1024);","vec3 H = ImportanceSampleGGXAniso(E, roughness, Taniso, Baniso, N, iAnisotropy);","vec3 L = 2.0 * dot(V, H) * H - V;","float NoL = clamp(dot(N, L), 0.0, 1.0);","float NoH = clamp(dot(N, H), 0.0, 1.0);","float VoH = clamp(dot(V, H), 0.0, 1.0);","if (NoL > 0.0) {","vec3 worldL = normalize( vec3( vec4( L, 0.0 ) * viewMatrix ) );","#ifdef USE_REFLECTION_PROBE","worldL = correctParallax(vWorldPosition, worldL);","#endif","#ifdef USE_FINITE_ENVMAP","worldL = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, worldL, vWorldPosition);","#endif","vec2 dirUV = getEnvMapUV(worldL);","#ifdef USE_REFLECTION_PROBE","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUV, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(reflectionProbe, dirUV).xyz;","#endif","#else","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUV, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(envMap, dirUV).xyz;","#endif","#endif","#ifdef USE_SSLR","    vec4 reflectColor = vec4(0.0);","    if (renderIteration > 0) {","        reflectColor = RayMarch(-vViewPosition, L);","        reflectColor *= reflectColor;","    }","    colorIBL = mix(colorIBL, reflectColor.xyz, reflectColor.w);","#endif","float GVis = 0.25 * GeometricSchlick(roughness, NoV, NoL)/max(NoL*NoV,1e-3);","float NoLPDF = 4.0 * NoL * VoH / max(NoH,1e-3);","vec3 F = FresnelSchlick(specColorF0, specColorF90, VoH);","spec += NoLPDF * colorIBL * F * GVis ;","}","}","specularColor = spec/float(nbSamples);","}","#endif",].join("\n");j.ShaderChunk.iteration_sheen_pars_fragment=["#ifdef USE_SHEEN","vec2 vLogComplex(in float value) {","float real = log(abs(value));","float im = atan(0.0,value);","return vec2(real,im);","}","vec2 invComplex(in vec2 value) {","return vec2(value.x,-value.y)/(value.x * value.x + value.y * value.y);","}","vec3 ImportanceSampleAshikmin(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * PI * Xi.x;","float a = roughness * roughness;","float a2 = a * a;","float interiorTerm = 4.0*a2*exp(1.0/a2)/(4.0*a2*Xi.y + Xi.y - 1.0);","vec2 exteriorTerm = a2*vLogComplex(interiorTerm);","vec2 value = invComplex(exteriorTerm);","float val = min(length(value),1.0);","float SinTheta = sqrt(val);","float CosTheta = sqrt(1.0 - val);","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return H;","}","vec3 ImportanceSampleBeckmann(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * PI * Xi.x;","float a = roughness * roughness;","float a2 = a * a;","float loga = 8.0*a2*log(1.0-Xi.y);","float value = loga / (loga - 1.0);","float SinTheta = sqrt(value);","float CosTheta = sqrt(1.0 - value);","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return H;","}","void SheenIBL(inout vec4 specularColor, float roughness, vec3 N, vec3 V, float NoV, vec2 textureSize, vec2 texelSize) {","const int nbSamples = 1;","vec3 spec = vec3(0.0);","for (int i = 0; i < nbSamples; i++) {","int renderI = i + renderIteration;","int n = (renderI*512)/1024;","int m = int(mod(float(renderI * 512),1024.0));","vec2 E = Hammersley2D(n+m,1024);","#ifdef USE_VELVET","vec3 perturbedZ = ImportanceSampleAshikmin(E, roughness);","#else","vec3 perturbedZ = ImportanceSampleBeckmann(E, roughness);","#endif","vec3 H = TangentToWorld(perturbedZ, N);","vec3 L = 2.0 * dot(V, H) * H - V;","float NoL = clamp(dot(N, L), 0.0, 1.0);","float NoH = clamp(dot(N, H), 0.0, 1.0);","float VoH = clamp(dot(V, H), 0.0, 1.0);","if (NoL > 0.0) {","vec3 worldL = normalize( vec3( vec4( L, 0.0 ) * viewMatrix ) );","#ifdef USE_REFLECTION_PROBE","worldL = correctParallax(vWorldPosition, worldL);","#endif","#ifdef USE_FINITE_ENVMAP","worldL = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, worldL, vWorldPosition);","#endif","vec2 dirUV = getEnvMapUV(worldL);","#ifdef USE_REFLECTION_PROBE","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUV, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(reflectionProbe, dirUV).xyz;","#endif","#else","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUV, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(envMap, dirUV).xyz;","#endif","#endif","float GVis = SheenVisGeometricSchlick(NoV, NoL);","float NoLPDF = 4.0 * NoL * VoH / max(NoH,1e-6);","spec += NoLPDF * colorIBL * GVis;","}","}","specularColor.xyz = spec/float(nbSamples);","}","#ifdef USE_ANISOTROPY","void SheenIBLAniso(inout vec4 specularColor, float roughness, in vec3 T, in vec3 B, vec3 N, vec3 V, float NoV, vec2 textureSize, vec2 texelSize, in float anisotropyValue, in float anisotropyAngleValue) {","const int nbSamples = 8;","vec3 spec = vec3(0.0);","for (int i = 0; i < nbSamples; i++) {","int renderI = i + renderIteration;","int n = (renderI*512)/1024;","int m = int(mod(float(renderI * 512),1024.0));","vec2 E = Hammersley2D(n+m,1024);","float r = ComputeAnisotropicRoughness(T,B,N,H,roughness, anisotropyValue, anisotropyAngleValue);","#ifdef USE_VELVET","vec3 perturbedZ = ImportanceSampleAshikmin(E, r);","#else","vec3 perturbedZ = ImportanceSampleBeckmann(E, r);","#endif","vec3 H = TangentToWorld(perturbedZ, N);","vec3 L = 2.0 * dot(V, H) * H - V;","float NoL = clamp(dot(N, L), 0.0, 1.0);","float NoH = clamp(dot(N, H), 0.0, 1.0);","float VoH = clamp(dot(V, H), 0.0, 1.0);","if (NoL > 0.0) {","vec3 worldL = normalize( vec3( vec4( L, 0.0 ) * viewMatrix ) );","#ifdef USE_REFLECTION_PROBE","worldL = correctParallax(vWorldPosition, worldL);","#endif","vec2 dirUV = getEnvMapUV(worldL);","#ifdef USE_REFLECTION_PROBE","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUV, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUV, textureSize, texelSize).xyz;","#endif","float GVis = SheenVisGeometricSchlick(NoV, NoL);","float NoLPDF = 4.0 * NoL * VoH / max(NoH,1e-6);","spec += NoLPDF * colorIBL * GVis;","}","}","specularColor.xyz = spec/float(nbSamples);","}","#endif","#endif",].join("\n");j.ShaderChunk.iteration_pars_fragment=["#if defined(USE_ITERATION) && defined(USE_ENVMAP)","void SpecularTransmisIBL(inout vec3 specularColor, inout vec3 transmissiveColor, float roughness, vec3 N, vec3 V, float NoV, vec3 specColorF0, vec3 specColorF90, vec2 textureSize, vec2 texelSize) {","const int nbSamples = 1;","vec3 spec = vec3(0.0);","vec3 trans = vec3(0.0);","for (int i = 0; i < nbSamples; i++) {","int renderI = i + renderIteration + 1;","int n = (renderI*512)/1024;","int m = int(mod(float(renderI * 512),1024.0));","vec2 E = Hammersley2D(n+m,1024);","vec3 perturbedZ = ImportanceSampleGGX(E, roughness);","vec3 H = TangentToWorld(perturbedZ, N);","vec3 L = 2.0 * dot(V, H) * H - V;","float NoL = clamp(dot(N, L), 0.0, 1.0);","float NoH = clamp(dot(N, H), 0.0, 1.0);","float VoH = clamp(dot(V, H), 0.0, 1.0);","if (NoL > 0.0) {","vec3 worldL = normalize( vec3( vec4( L, 0.0 ) * viewMatrix ) );","#ifdef USE_REFLECTION_PROBE","worldL = correctParallax(vWorldPosition, worldL);","#endif","#ifdef USE_FINITE_ENVMAP","worldL = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, worldL, vWorldPosition);","#endif","vec2 dirUV = getEnvMapUV(worldL);","vec3 worldLt = normalize( vec3( vec4( L - 2.0 * NoL * N, 0.0 ) * viewMatrix ) );","vec2 dirUVt = getEnvMapUV(worldLt);","#ifdef USE_REFLECTION_PROBE","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUV, textureSize, texelSize).xyz;","vec3 colorIBLt = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUVt, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(reflectionProbe, dirUV).xyz;","vec3 colorIBLt = envMapExposure * texture2D(reflectionProbe, dirUVt).xyz;","#endif","#else","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUV, textureSize, texelSize).xyz;","vec3 colorIBLt = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUVt, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(envMap, dirUV).xyz;","vec3 colorIBLt = envMapExposure * texture2D(envMap, dirUVt).xyz;","#endif","#endif","#ifdef USE_SSLR","    vec4 reflectColor = vec4(0.0);","    if (renderIteration > 0) {","        reflectColor = RayMarch(-vViewPosition, L);","        reflectColor.xyz *= reflectColor.xyz;","    }","    colorIBL = mix(colorIBL, reflectColor.xyz, reflectColor.w);","#endif","float GVis = 0.25 * GeometricSchlick(roughness, NoV, NoL)/max(NoL*NoV,1e-3);","float NoLPDF = 4.0 * NoL * VoH / max(NoH,1e-3);","vec3 F = FresnelSchlick(specColorF0, specColorF90, VoH);","spec += NoLPDF * colorIBL * F*GVis ;","float GVisTrans;","#ifdef THIN_WALLED","GVisTrans =  GVis ;","#else","GVisTrans = (ior*ior)* GeometricSchlick(roughness, NoV, NoL);","float LoH = clamp(dot(L, H), 0.0, 1.0);","GVisTrans *= abs(LoH*VoH)/max(abs(NoL * NoV),1e-3);","GVisTrans /= max(ior*LoH + pow2(ior*VoH),1e-3);","#endif","trans += colorIBLt * GVisTrans*NoLPDF*(1.0 - F);","}","}","specularColor = spec/float(nbSamples);","transmissiveColor = trans/float(nbSamples);","}","void SpecularIBL(inout vec3 specularColor, float roughness, vec3 N, vec3 V, float NoV, vec3 specColorF0, vec3 specColorF90, vec2 textureSize, vec2 texelSize) {","const int nbSamples = 1;","vec3 spec = vec3(0.0);","for (int i = 0; i < nbSamples; i++) {","int renderI = i + renderIteration + 1;","int n = (renderI*512)/1024;","int m = int(mod(float(renderI * 512),1024.0));","vec2 E = Hammersley2D(n+m,1024);","vec3 perturbedZ = ImportanceSampleGGX(E, roughness);","vec3 H = TangentToWorld(perturbedZ, N);","vec3 L = 2.0 * dot(V, H) * H - V;","float NoL = clamp(dot(N, L), 0.0, 1.0);","float NoH = clamp(dot(N, H), 0.0, 1.0);","float VoH = clamp(dot(V, H), 0.0, 1.0);","if (NoL > 0.0) {","vec3 worldL = normalize( vec3( vec4( L, 0.0 ) * viewMatrix ) );","#ifdef USE_REFLECTION_PROBE","worldL = correctParallax(vWorldPosition, worldL);","#endif","#ifdef USE_FINITE_ENVMAP","worldL = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, worldL, vWorldPosition);","#endif","vec2 dirUV = getEnvMapUV(worldL);","#ifdef USE_REFLECTION_PROBE","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(reflectionProbe, dirUV, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(reflectionProbe, dirUV).xyz;","#endif","#else","#ifdef USE_ENVMAP_HDR","vec3 colorIBL = envMapExposure * texture2DBilinearFromRGBE(envMap, dirUV, textureSize, texelSize).xyz;","#else","vec3 colorIBL = envMapExposure * texture2D(envMap, dirUV).xyz;","#endif","#endif","#ifdef USE_SSLR","    vec4 reflectColor = vec4(0.0);","    if (renderIteration > 0) {","        reflectColor = RayMarch(-vViewPosition, L);","        reflectColor.xyz *= reflectColor.xyz;","    }","    colorIBL = mix(colorIBL, reflectColor.xyz, reflectColor.w);","#endif","float GVis = 0.25 * GeometricSchlick(roughness, NoV, NoL)/max(NoL*NoV,1e-6);","float NoLPDF = 4.0 * NoL * VoH / max(NoH,1e-6);","vec3 F = FresnelSchlick(specColorF0, specColorF90, VoH);","spec += NoLPDF * colorIBL * F * GVis ;","}","}","specularColor = spec/float(nbSamples);","}",j.ShaderChunk.iteration_aniso_pars_fragment,j.ShaderChunk.iteration_sheen_pars_fragment,"#endif"].join("\n");j.ShaderChunk.brdf_pars_fragment=["vec3 FresnelSchlick(vec3 specularColor, float ctheta) {","float Fc = pow(1.0 - ctheta, 5.0);","return Fc + (1.0 - Fc) * specularColor;","}","vec3 FresnelSchlick(in vec3 iF0, in vec3 iF90, in float ctheta) {","float power = pow5(1.0 - ctheta);","return  mix(iF0, iF90, power);","}","vec2 FresnelSchlick(in float ctheta) {","float power = pow5(1. - ctheta);","return vec2((1.0-power),power);","}","float GeometricSchlick(float roughness, float NoV, float NoL) {","float a = roughness * roughness;","float a2 = a * a;","float G1 = sqrt(1.0-a2+a2/max(NoL*NoL,1e-6));","float G2 = sqrt(1.0-a2+a2/max(NoV*NoV,1e-6));","return 2.0 / (G1+G2);","}","float DistributionGGX(float roughness, float NoH) {","float alpha = roughness * roughness;","float alpha2 = alpha * alpha;","float NoH2 = NoH * NoH;","float d = (alpha2 - 1.0) * NoH2 + 1.0;","return alpha2 / (PI * d * d);","}","#ifdef USE_ANISOTROPY","float AnisotropicGeometricSchlick(float roughnessX, in float roughnessY, float NoV, float NoL, in float iAnisotropyAngle) {","float ax = roughnessX * roughnessX;","float ay = roughnessY * roughnessY;","float a2 = pow2(cos(iAnisotropyAngle)*ax) + pow2(sin(iAnisotropyAngle)*ay);","float G1 = sqrt(1.0-a2+a2/max(NoL*NoL,1e-6));","float G2 = sqrt(1.0-a2+a2/max(NoV*NoV,1e-6));","return 2.0 / (G1+G2);","}","float AnisotropicDistributionGGX(vec3 T, vec3 B, vec3 N, vec3 H, float NoH, in float iRoughnessX, in float iRoughnessY, float iAnisotropyAngle) {","vec3 rot_X = cos(2.0 * PI * iAnisotropyAngle) * T + sin(2.0 * PI * iAnisotropyAngle) * B;","vec3 rot_Y = cross(N, rot_X);","float dot_t_h = dot(rot_X, H);","float dot_b_h = dot(rot_Y, H);","float alpha_T = iRoughnessX;","float alpha_B = iRoughnessY;","alpha_T = max(pow2(alpha_T), 1e-3);","alpha_B = max(pow2(alpha_B), 1e-3);","float a = dot_t_h / alpha_T;","float b = dot_b_h / alpha_B;","float D = a * a + b * b + NoH * NoH;","D = PI * alpha_T * alpha_B * D * D;","D = 1.0 / max(D, kEpsilon);","return D;","}","float ComputeAnisotropicRoughness(in vec3 T, in vec3 B, in vec3 N,in vec3 H, in float iRoughness, in float anisotropy, in float anisotropyAngle) {","vec3  rot_X = cos(anisotropyAngle *2. * PI) * T + sin(anisotropyAngle * 2.* PI) * B;","vec3  rot_Y = cross(N, rot_X);","float dot_t_h = dot(rot_X, H); // sin(theta) cos(phi)","float dot_b_h = dot(rot_Y, H); // sin(theta) sin(phi)","float alpha_T = iRoughness;","float alpha_B = iRoughness * (1.0 - anisotropy) ;","alpha_T = max(pow2(alpha_T), kEpsilon);","alpha_B = max(pow2(alpha_B), kEpsilon);","float tmp =  sign(dot_b_h) * sign(dot_t_h);","dot_t_h = max(abs(dot_t_h),0.05) * tmp;","dot_b_h = max(abs(dot_b_h),0.05);","float phi = atan(dot_t_h,dot_b_h);","float a = pow2(cos(phi) / alpha_T);","float b = pow2(sin(phi) / alpha_B);","float a2 = 1.0/ (a+b);","float roughness = saturate(sqrt(sqrt(a2)));","return clamp(roughness, 0.025, 0.975) ;","}","#endif",].join("\n");j.ShaderChunk.emission_pars_fragment=["vec3 doEmission(in float NoV, in vec3 color, in float value) {","vec3 res = vec3(0.0);","#ifndef USE_NORMALIZED_EMISSION","res = color * value;","#else","vec3 aux = vec3(0.2126729,0.7151522,0.0721750);","res = color/max(dot(color,aux),1e-6) * value;","#endif","return res/3.14159;","}",].join("\n");j.ShaderChunk.sheen_pars_fragment=["#ifdef USE_SHEEN","float SheenVisGeometricSchlick(in float NoV, in float NoL) {","float div = 4.0 * max(NoL + NoV - NoL*NoV, 1e-6);","return 1.0 / div;","}","#ifdef USE_ANISOTROPY","float SheenAnisotropicDistribution(in float NoH, in float sheenValue, in vec3 T, in vec3 B, in vec3 N, in vec3 H, in float anisotropyValue, in float anisotropyAngleValue) {","float cosine2 = max(NoH * NoH,kEpsilon);","float sine2 = max(1.0-cosine2,kEpsilon);","float D = 1.0;","float normalisationTerm = 0.31830988618379;","#if defined(USE_VELVET)","float r = ComputeAnisotropicRoughness(T,B,N,H,sqrt(sheenValue), anisotropyValue, anisotropyAngleValue);","float a2 = pow2(r*r);","normalisationTerm *= 1.0/(4.0*a2+1.0);","float sine4 = max(pow2(sine2),kEpsilon);","float cotan2 = cosine2/sine2;","float value = -cotan2 / a2;","D = 1.0+4.0 * exp(value)/ sine4;","#endif // (defined(USE_VELVET) || defined(USE_SILKVELVET))","#if defined(USE_SATIN)","float r = ComputeAnisotropicRoughness(T,B,N,H,0.3, anisotropyValue, anisotropyAngleValue);","float a2 = pow2(r*r);","normalisationTerm *= 1.0/(8.0*a2);","float cosine4 = max(pow2(cosine2),kEpsilon);","float tan2 = sine2/cosine2;","float value = -tan2/( a2*8.0);","D = exp(value) / cosine4 ;","#endif // (defined(USE_SATIN)","return D * normalisationTerm;","}","vec3 sheenModelAniso(in vec3 diffuse, in vec3 diffuseColor, in vec3 sr0Color, in vec3 sr90Color, in vec3 N, in vec3 V, in vec3 L, in float sheenValue, in vec3 T, in vec3 B, in float iAniso, in float iAnisoAngle) {","vec3 H = normalize(L+V);","float NoH = saturate(dot(N,H));","float NoL = saturate(dot(N,L));","float NoV = saturate(dot(N,V));","float fresnel = 1.0 - vMax(max(FresnelSchlick(sr0Color,sr90Color,NoL),FresnelSchlick(sr0Color,sr90Color,NoV)));","vec3 sheenColor = diffuseColor * SheenAnisotropicDistribution(NoH,sheenValue,T,B,N,H, iAniso, iAnisoAngle) * SheenVisGeometricSchlick(NoL,NoV) * fresnel;","return mix(diffuse,sheenColor, 1.0 - pow5(1.0-sheenValue));","}","#else","float SheenDistribution(in float NoH, in float sheenValue) {","float cosine2 = max(NoH * NoH,kEpsilon);","float sine2 = max(1.0-cosine2,kEpsilon);","float D = 1.0;","float normalisationTerm = 0.31830988618379;","#if defined(USE_VELVET)","float a2 = sheenValue * sheenValue;","normalisationTerm *= 1.0/(4.0*a2+1.0);","float sine4 = max(pow2(sine2),kEpsilon);","float cotan2 = cosine2/sine2;","float value = -cotan2 / a2;","D = 1.0+4.0 * exp(value)/ sine4;","#endif // (defined(USE_VELVET) || defined(USE_SILKVELVET))","#if defined(USE_SATIN)","float a2 = 0.0081;","normalisationTerm *= 1.0/(8.0*a2);","float cosine4 = max(pow2(cosine2),kEpsilon);","float tan2 = sine2/cosine2;","float value = -tan2/( a2*8.0);","D = exp(value) / cosine4 ;","#endif // (defined(USE_SATIN)","return D * normalisationTerm;","}","vec3 sheenModel(in vec3 diffuse, in vec3 diffuseColor, in vec3 sr0Color, in vec3 sr90Color, in vec3 N, in vec3 V, in vec3 L,in float sheenValue) {","vec3 H = normalize(L+V);","float NoH = saturate(dot(N,H));","float NoL = saturate(dot(N,L));","float NoV = saturate(dot(N,V));","float fresnel = 1.0 - vMax(max(FresnelSchlick(sr0Color,sr90Color,NoL),FresnelSchlick(sr0Color,sr90Color,NoV)));","vec3 sheenColor = diffuseColor * SheenDistribution(NoH,sheenValue) * SheenVisGeometricSchlick(NoL,NoV) * fresnel;","return mix(diffuse,sheenColor, 1.0 - pow5(1.0-sheenValue));","}","#endif","#endif",].join("\n");j.ShaderChunk.old_flakes_pars_fragment=["#ifdef USE_FLAKES","#define FREQUENCY 0.6","struct flakes {","float roughness;","vec3 F0;","vec3 worldNormal;","vec3 normal;","};","flakes metal;","flakes metalFlakes;","flakes pearlFlakes;","vec3 flakesModel(inout vec3 diffuse, inout vec3 specular, in vec3 V, in vec3 L) {","vec3 H = normalize(L+V);","vec3 total = vec3(0.0);","float NoH = saturate(dot(metalFlakes.normal,H));","float NoV = saturate(dot(metalFlakes.normal,V));","float NoL = saturate(dot(metalFlakes.normal,L));","float VoH = saturate(dot(V,H));","float distrib = DistributionGGX( metalFlakes.roughness, NoH);","float geomVis = 0.25*GeometricSchlick( metalFlakes.roughness, NoV, NoL) / max(abs(NoL * NoV),1e-3);","vec3 fresnel = FresnelSchlick(metalFlakes.F0, vec3(0.0), VoH);","total += distrib * fresnel * geomVis;","NoH = saturate(dot(metal.normal,H));","NoV = saturate(dot(metal.normal,V));","NoL = saturate(dot(metal.normal,L));","distrib = DistributionGGX( metal.roughness, NoH);","geomVis = 0.25*GeometricSchlick( metal.roughness, NoV, NoL) / max(abs(NoL * NoV),1e-3);","fresnel = FresnelSchlick(metal.F0, vec3(0.0), VoH);","float fresnelEnergy = 1.0 - vMax(max(FresnelSchlick(metal.F0, vec3(0.0), NoL),FresnelSchlick(metal.F0, vec3(0.0), NoV)));","diffuse *= fresnelEnergy;","specular *= fresnelEnergy;","total *= fresnelEnergy;","total += distrib * fresnel * geomVis;","#ifdef PEARL_FLAKES_ACTIVATED","NoH = saturate(dot(pearlFlakes.normal,H));","NoV = saturate(dot(pearlFlakes.normal,V));","NoL = saturate(dot(pearlFlakes.normal,L));","distrib = DistributionGGX( pearlFlakes.roughness, NoH);","geomVis = 0.25*GeometricSchlick( pearlFlakes.roughness, NoV, NoL) / max(abs(NoL * NoV),1e-3);","fresnel = FresnelSchlick(pearlFlakes.F0, vec3(0.0), VoH);","fresnelEnergy = 1.0 - vMax(max(FresnelSchlick(pearlFlakes.F0, vec3(0.0), NoL),FresnelSchlick(pearlFlakes.F0, vec3(0.0), NoV)));","diffuse *= fresnelEnergy;","specular *= fresnelEnergy;","total *= fresnelEnergy;","total += distrib * fresnel * geomVis;","#endif","return total;","}","void flakesVisibility(in vec3 currentWorldNormal, out float flakesLODLevel, out float metallicFlakesBlending, out float flakesMask, in float scaling) {","mat3 mat = transposeMatrix(mat3(modelMatrix));","vec3 worldScaling = 1.0/vec3(length(mat[0]),length(mat[1]),length(mat[2]));","vec3 V = cameraPosition - vWorldPosition; ","float dist = length(worldScaling * V);","V = normalize(V);","float NdotV = dot(currentWorldNormal, V); ","float locality = (NdotV > 0.0) ? 1.0 : 0.0;","if (locality == 0.0) {","flakesLODLevel = 0.0;","metallicFlakesBlending = 0.0;","flakesMask = 0.0;","return;","}","float normDist = saturate(scaling * dist * 0.00125);","float shortDist = 1.0 - normDist;","flakesLODLevel = scaling * dist;","#ifdef ADVANCED_FLAKES_BLENDING","metallicFlakesBlending = normDist * (0.5 * flakesDensity + 0.25);","#else","metallicFlakesBlending = normDist * 0.5 ;","#endif","flakesMask = shortDist;","}","void computeMetallicFlakes(out float metallicFlakesPresence, out vec3 metallicFlakesBaseColor,","in float presenceNoise, in float presenceNoise2, in float noisePositive, in float noiseNegative,","in vec3 T, in vec3 B) {","if (length(flakesColorMulCoef) < kEpsilon) {","return;","}","metallicFlakesPresence = pow5(presenceNoise);","float aux = pow5(presenceNoise2);","metallicFlakesPresence += mix( - aux, aux, flakesDensity);","metallicFlakesPresence *= 5.0;","metallicFlakesPresence = saturate(metallicFlakesPresence);","metallicFlakesBaseColor = mix(2.0 * flakesColor, vec3(0.0), affine(noiseNegative, 0.5, 1.0));","float theta = metallicFlakesPresence * noisePositive* PI * 0.125;","float phi =  metallicFlakesPresence * noiseNegative * PI * 0.125;","metalFlakes.worldNormal = Rotate3D(metalFlakes.worldNormal, theta, B);","metalFlakes.worldNormal = Rotate3D(metalFlakes.worldNormal, phi, T);","}","void computePearlFlakes(out float pearlFlakesPresence, out vec3 pearlFlakesBaseColor, ","in float presenceNoise, in float presenceNoise2, in float noisePositive, in float noiseNegative,","in vec3 T, in vec3 B) {","if (length(pearlFlakesColorMulCoef) < kEpsilon) {","return;","}","pearlFlakesPresence = pow3(pow6(presenceNoise2));","float aux = pow3(pow6(presenceNoise));","pearlFlakesPresence += mix( - aux, aux, pearlFlakesDensity);","pearlFlakesPresence *= 6.0;","pearlFlakesPresence = saturate(pearlFlakesPresence);","pearlFlakesBaseColor = mix(2.0 * pearlFlakesColor, vec3(0.0), affine(noisePositive, 0.5, 1.0));","float theta = pearlFlakesPresence * noisePositive * PI * 0.25;","float phi =  pearlFlakesPresence * noiseNegative * PI * 0.25;","pearlFlakes.worldNormal = Rotate3D(pearlFlakes.worldNormal, theta, B);","pearlFlakes.worldNormal = Rotate3D(pearlFlakes.worldNormal, phi, T);","}","void blendMetalFlakes(in vec3 currentWorldNormal, in float flakesMask, in float metallicFlakesBlending, in float metallicFlakesPresence, in vec3 metallicFlakesBaseColor) {","if (length(flakesColorMulCoef) < kEpsilon) {","return;","}","float metallicFlakesStrength = flakesMask * metallicFlakesPresence;","#ifdef FLAKES_NORMAL_PERTURBATION","float metalPerturbateNormal = 0.1 * flakesBump;","#else","float metalPerturbateNormal = 0.0;","#endif","metalFlakes.roughness = 1.0 - mix(0.75,0.55,flakesRoughness);","metal.roughness = metalFlakes.roughness + metalPerturbateNormal;","metal.F0 = flakesColorMulCoef * metallicFlakesBlending * flakesColor;","metalFlakes.F0 = flakesColorMulCoef * metallicFlakesBaseColor * metallicFlakesStrength;","metalPerturbateNormal *= 10.0 * flakesMask;","metalFlakes.worldNormal = normalize(currentWorldNormal + metalPerturbateNormal * metalFlakes.worldNormal);","}","void blendPearlFlakes(in vec3 currentWorldNormal, in float flakesMask, in float pearlFlakesPresence, in vec3 pearlFlakesBaseColor) {","if (length(pearlFlakesColorMulCoef) < kEpsilon) {","return;","}","float pearlFlakesStrength = flakesMask * pearlFlakesPresence;","#ifdef FLAKES_NORMAL_PERTURBATION","float pearlPerturbateNormal = 0.05 * pearlFlakesBump;","#else","float pearlPerturbateNormal = 0.0;","#endif","pearlFlakes.roughness = 0.25;","pearlFlakes.F0 = pearlFlakesColorMulCoef * pearlFlakesBaseColor * pearlFlakesStrength;","pearlPerturbateNormal *= 10.0 * sqrt(flakesMask);","pearlFlakes.worldNormal = normalize(currentWorldNormal + pearlPerturbateNormal * pearlFlakes.worldNormal);","}","void doFlakes(in vec3 currentWorldNormal) { ","float flakesMask = 0.0;","float flakesLODLevel = 0.0;","float scaling = mix(0.0, 0.9, atan(3.14*flakesScale)*2.0/3.14);","vec3 T = getGeomT(currentWorldNormal);","vec3 B = getGeomB(currentWorldNormal, T);","float metallicFlakesBlending = 0.0;","float metallicFlakesPresence = 0.0;","vec3 metallicFlakesBaseColor = vec3(0.0);","metal.roughness = 0.0;","metal.F0 = vec3(0.0);","metal.worldNormal = currentWorldNormal;","metalFlakes.roughness = 0.0;","metalFlakes.F0 = vec3(0.0);","metalFlakes.worldNormal = currentWorldNormal;","float pearlFlakesPresence = 0.0;","vec3 pearlFlakesBaseColor = vec3(0.0);","#ifdef PEARL_FLAKES_ACTIVATED","pearlFlakes.roughness = 0.0;","pearlFlakes.F0 = vec3(0.0);","pearlFlakes.worldNormal = currentWorldNormal;","#endif","flakesVisibility(currentWorldNormal, flakesLODLevel, metallicFlakesBlending, flakesMask, scaling);","if (length(pearlFlakesColorMulCoef) < kEpsilon && length(flakesColorMulCoef) < kEpsilon) {","return;","}","if (flakesMask < kEpsilon) {","blendMetalFlakes(currentWorldNormal, flakesMask, metallicFlakesBlending, metallicFlakesPresence, metallicFlakesBaseColor);","#ifdef PEARL_FLAKES_ACTIVATED","blendPearlFlakes(currentWorldNormal, flakesMask, pearlFlakesPresence, pearlFlakesBaseColor);","#endif","return;","}","vec3 tex = scaling * vObjectSpacePosition;","tex.y = -abs(tex.y);","tex.x = -abs(tex.x);","#ifdef FLAKES_NORMAL_PERTURBATION","float noisePositive = arrayFBMMixer(0.85 * tex, flakesLODLevel, FREQUENCY,1.0,2.0);","float noiseNegative = arrayFBMMixer(0.85 * tex.yxz, flakesLODLevel, FREQUENCY,1.0,2.0);","#else","float noisePositive = 0.0;","float noiseNegative = 0.0;","#endif","float presenceNoise = affine(arrayFBMMixer(tex, flakesLODLevel, FREQUENCY,1.0,3.0), 0.5, 1.0 );","#ifdef ADVANCED_PRESENCE_NOISE","float presenceNoise2 = affine(arrayFBMMixer(tex.yxz, flakesLODLevel, FREQUENCY,1.0,3.0), 0.5, 1.0);","#else","float presenceNoise2 = 0.0;","#endif","computeMetallicFlakes(metallicFlakesPresence, metallicFlakesBaseColor, presenceNoise, presenceNoise2, noisePositive, noiseNegative, T, B);","#ifdef PEARL_FLAKES_ACTIVATED","computePearlFlakes(pearlFlakesPresence,pearlFlakesBaseColor,presenceNoise, presenceNoise2, noisePositive,noiseNegative,T,B);","#endif","blendMetalFlakes(currentWorldNormal, flakesMask, metallicFlakesBlending, metallicFlakesPresence, metallicFlakesBaseColor);","#ifdef PEARL_FLAKES_ACTIVATED","blendPearlFlakes(currentWorldNormal, flakesMask, pearlFlakesPresence, pearlFlakesBaseColor);","#endif","}","#endif"].join("\n");j.ShaderChunk.flakes_pars_fragment=["#ifdef USE_FLAKES","#define MAX_GRID_SIZE 10","#define HALF_MAXF_GRID_SIZE 5.0","#define CONE_ANGLE 0.9925536979","#define CONE_SOLID_ANGLE 0.04678649594","#define BLEND_MIN 1.0","#define BLEND_MAX 32.0","struct flData {","float flakesArea;","vec2 footprintPos;","vec2 footprintDx;","vec2 footprintDy;","float blendDist;","float footprintArea;","float expectedFlakes;","float invDet;","float seedRes;","};","flData flakesData;","vec2 triplanarMapping(in vec3 p, in vec3 n, in float scale) {","vec2 uv;","if (abs(n.x) >= abs(n.y) && abs(n.x) >= abs(n.z)) {","uv = vec2(-p.z,-p.y);","} else if (abs(n.y) >= abs(n.z)) {","uv = vec2( p.x, p.z);","} else {","uv = vec2( p.x,-p.y);","}","return uv * scale;","}","void initFlakesData(in vec3 p, in vec3 N, in float flakesSize, in float flakesCoverage) {","mat3 mat = transposeMatrix(mat3(modelMatrix));","float scale = vMax(vec3(length(mat[0]),length(mat[1]),length(mat[2])));","flakesData.flakesArea = flakesCoverage / pow2(flakesSize);","vec3 x =  dFdx(p);","vec3 y =  dFdy(p);","flakesData.footprintPos = triplanarMapping(p,N,scale);","flakesData.footprintDx = triplanarMapping(x ,N,scale);","flakesData.footprintDy = triplanarMapping(y,N,scale);","flakesData.footprintArea = flakesData.footprintDx.x * flakesData.footprintDy.y - flakesData.footprintDx.y * flakesData.footprintDy.x;","flakesData.expectedFlakes = abs(flakesData.footprintArea) * flakesData.flakesArea;","flakesData.blendDist = smoothstep(BLEND_MIN, BLEND_MAX, flakesData.expectedFlakes);","flakesData.invDet = 1.0 / flakesData.footprintArea;","flakesData.seedRes = max(4.0, vRound(0.5*sqrt(flakesData.flakesArea)));","}","vec4 parallelogramBBox(in vec2 pos,in vec2 dx,in vec2 dy) {","vec2 corner1 = pos;","vec2 corner2 = pos + dx;","vec2 corner3 = pos + dy;","vec2 corner4 = pos + dx + dy;","vec2 minBBox = vec2(vMin(vec4(corner1.x,corner2.x,corner3.x,corner4.x)), vMin(vec4(corner1.y,corner2.y,corner3.y,corner4.y)));","vec2 maxBBox = vec2(vMax(vec4(corner1.x,corner2.x,corner3.x,corner4.x)), vMax(vec4(corner1.y,corner2.y,corner3.y,corner4.y)));","return vec4(minBBox, maxBBox);","}","bool inFootPrint(in vec2 p) {","if (abs(flakesData.footprintArea) < 1e-10) {","return false;","} else {","vec2 pp = p - flakesData.footprintPos;","vec2 uv = flakesData.invDet * vec2(dot(vec2(-pp.y,pp.x),flakesData.footprintDy), dot(vec2(pp.y,-pp.x),flakesData.footprintDx));","return 0.0 <= uv.x && uv.x <= 1.0 && 0.0 <= uv.y && uv.y <= 1.0;","}","}","vec2 rnGenerator(inout int seed) {","int rn = modI(1140671485 * seed + 12820163,16777216);","seed = modI(1140671485 * rn + 12820163,16777216);","return vec2(float(rn) /16777216.0 ,float(seed) / 16777216.0);","}","vec2 generateFlakesPosition(inout int seed) {","return rnGenerator(seed);","}","vec3 generateFlakesReflection(inout int seed, in vec3 V, in float roughness, in vec3 N) {","vec2 uvs = rnGenerator(seed);","vec3 H = TangentToWorldGeom(ImportanceSampleGGX(uvs.xy,roughness), N);","return 2.0 * dot(V,H) * H - V;","}","void generateFlakes(inout int seed, in vec3 V, in vec3 N, in float roughness, out vec2 pos, out vec3 refl) {","pos = generateFlakesPosition(seed);","refl = generateFlakesReflection(seed, V,roughness,N);","}","void reorientParallelogram(in vec2 pos, in vec2 dx, in vec2 dy, out vec2 nPos, out vec2 nDx, out vec2 nDy) {","nPos = vec2(pos);","if ((dy.x * dx.y - dy.y * dx.x) > 0.0) {","nDx = vec2(dy); ","nDy = vec2(dx); ","} else {","nDx = vec2(dx);","nDy = vec2(dy);","}","if (nDy.y < 0.0) {","nPos = nPos + nDy;","vec2 aux = vec2(nDy);","nDy = nDx;","nDx = - aux;","}","if (nDy.y < 0.0) {","nPos = nPos + nDy;","vec2 aux = vec2(nDy);","nDy = nDx;","nDx = - aux;","}","if (nDx.y < 0.0) {","nPos = nPos + nDx;","vec2 aux = vec2(nDx);","nDx = nDy;","nDy = - aux;","}","if (nDx.y < 0.0) {","nPos = nPos + nDx;","vec2 aux = vec2(nDx);","nDx = nDy;","nDy = - aux;","}","}","vec2 rasterizedParallelogramProcess(in vec2 pos, in vec2 dx, in vec2 dy, in vec2 bbMin, in vec2 bbMax, in vec3 V, in vec3 L, in vec3 N, in float roughness) {","int contributing = 0;","int flakesInFootPrint = 0;","float deltaDDx = dx.x / abs(dx.y);","float deltaDDy = dy.x / abs(dy.y);","vec2 sum = dx + dy;","float minX = max(min(pos.x, min(pos.x + dy.x, pos.x + sum.x)),bbMin.x);","float maxX = max(min(pos.x, min(pos.x + dx.x, pos.x + sum.x)),bbMax.x);","float minY = floor(max(bbMin.y, pos.y));","float maxY = ceil(min(bbMax.y, pos.y + sum.y));","float dyLeftBound =  pos.x +				(minY - pos.y			+ (dy.x < 0.0 ? 1.0 : 0.0)) * deltaDDy;","float dxLeftBound =  pos.x + dy.x +		(minY - pos.y - dy.y	+ (dx.x < 0.0 ? 1.0 : 0.0)) * deltaDDx;","float dyRightBound = pos.x + dx.x +		(minY - pos.y - dx.y	+ (dy.x > 0.0 ? 1.0 : 0.0)) * deltaDDy;","float dxRightBound = pos.x +				(minY - pos.y			+ (dx.x > 0.0 ? 1.0 : 0.0)) * deltaDDx;","int i = 0;","int maxI = -1;","int j = int(minY);","int jEnd = int(maxY);","float nodeSize = 1.0 / flakesData.seedRes;","for (int k = 0; k < 150; k++) {","if (i >= maxI) {","float boundaryLeft = max(minX, max(dyLeftBound, dxLeftBound));","i = int(floor(boundaryLeft));","float boundaryRight = min(maxX, min(dyRightBound, dxRightBound));","maxI = int(ceil(boundaryRight));","dyLeftBound += deltaDDy;","dxLeftBound += deltaDDx;","dyRightBound += deltaDDy;","dxRightBound += deltaDDx;","}","float iWrapped = float(i);","float jWrapped = float(j);","int seed = int(length(vec2(iWrapped,jWrapped)* 16892.0));","for (int k = 0; k < 4; k++) {","vec2 fPos;","vec3 fRefl;","generateFlakes(seed,V,N,roughness,fPos,fRefl);","vec2 flakeUV = nodeSize * (vec2(iWrapped, jWrapped) + fPos);","if (inFootPrint(flakeUV)) {","flakesInFootPrint++;","if (dot(fRefl,L) > CONE_ANGLE) {","contributing++;","}","}","}","i++;","if (i >= maxI) {","j++;","}","if (j >= jEnd) {","break;","}","}","return vec2(float(contributing), float(flakesInFootPrint));","}","vec2 contributingFlakes(in vec3 V, in vec3 L, in vec3 N, in float roughness) {","vec4 bbox = parallelogramBBox(flakesData.footprintPos, flakesData.footprintDx, flakesData.footprintDy);","vec2 gridMin = floor(flakesData.seedRes * bbox.xy);","vec2 gridMax = ceil(flakesData.seedRes * bbox.zw);","vec2 footPrintCenter = flakesData.seedRes * (flakesData.footprintPos + 0.5 * (flakesData.footprintDx + flakesData.footprintDy));","gridMin = clamp(gridMin, footPrintCenter - HALF_MAXF_GRID_SIZE, footPrintCenter + HALF_MAXF_GRID_SIZE);","gridMax = clamp(gridMax, footPrintCenter - HALF_MAXF_GRID_SIZE, footPrintCenter + HALF_MAXF_GRID_SIZE);","vec2 pos = flakesData.footprintPos * flakesData.seedRes;","vec2 dx = flakesData.footprintDx * flakesData.seedRes;","vec2 dy = flakesData.footprintDy * flakesData.seedRes;","vec2 nPos;","vec2 nDx;","vec2 nDy;","reorientParallelogram(pos, dx, dy, nPos, nDx, nDy);","return rasterizedParallelogramProcess(nPos, nDx, nDy, gridMin, gridMax, V, L, N, roughness);","}","float stochasticFlakesBRDF(in vec3 V, in vec3 L, in vec3 N, in float roughness, in float VoH, in float NoL, in float NoV) {","vec2 c = contributingFlakes(V,L,N,roughness);","float refFlakesCount = max(flakesData.expectedFlakes, c.y);","float d = c.x / (refFlakesCount * CONE_SOLID_ANGLE);","float g = GeometricSchlick(roughness, NoL,NoV );","return VoH * g * d / max(NoL*NoV,1e-6);","}","vec3 flakesLightEquation(inout vec3 diffuse, inout vec3 specular, in vec3 V, in vec3 L, in vec3 N, in float roughness, in vec3 color, in float coverage) {","vec3 H = normalize(V+L);","float VoH = dot(V,H);","float NoL = saturate(dot(N,L));","float NoV = saturate(dot(N,V));","float NoH = saturate(dot(N,H));","float res = flakesData.blendDist * SpecularBRDF(roughness,NoV,NoL,NoH);","if (flakesData.blendDist < 1.0 - 1e-3) {","res += (1.0 - flakesData.blendDist) * stochasticFlakesBRDF(V,L,N,roughness,VoH,NoL,NoV);","}","diffuse *= (1.0 - coverage);","specular *= (1.0 - coverage);","return coverage * color * res;","}","#endif",].join("\n");j.ShaderChunk.coating_pars_fragment=["#ifdef CLEAR_COAT","#define COATINGF0 vec3(0.04)","#define COATINGF90 vec3(1.0)","vec3 clearCoatModel(inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L, in float r, in float clStrength) {","vec3 H = normalize(L+V);","float NoH = saturate(dot(N,H));","float NoV = saturate(dot(N,V));","float NoL = saturate(dot(N,L));","float VoH = saturate(dot(V,H));","float distrib = DistributionGGX( r, NoH);","float geomVis = 0.25*GeometricSchlick( r, NoV, NoL) / max(abs(NoL * NoV),1e-3);","vec3 fresnel = clStrength * FresnelSchlick(COATINGF0, COATINGF90, VoH);","float fresnelEnergy = clStrength * vMax(max(FresnelSchlick(COATINGF0, COATINGF90, NoL),FresnelSchlick(COATINGF0, COATINGF90, NoV)));","diffuse *= 1.0 - fresnelEnergy;","specular *= 1.0 - fresnelEnergy;","return distrib * fresnel * geomVis;","}","#ifdef CLEAR_COAT_NORMALMAP","vec3 perturbNormal3ArbCoat( vec3 surf_norm, vec3 surf_tgt, vec3 surf_binorm, vec2 uv ) {","vec3 N = normalize(surf_norm);","vec3 T = normalize(surf_tgt);","T = normalize(T - dot(T, N) * N);","vec3 B = normalize(surf_binorm);","vec3 mapN = texture2D( clearCoatNormalMap, uv ).xyz * 2.0 - 1.0;","#ifdef CLEAR_COAT_NORMALMAPFLIPY","mapN.y = - mapN.y;","#endif","mapN.xy = clearCoatNormalScale * mapN.xy;","mat3 tbn = mat3(T, B, N);","return normalize(tbn * mapN);","}","#endif","#ifdef USE_ORANGE_PEEL","void orangePeelVisibility(in vec3 currentWorldNormal, out float peelMask, in float scaling) {","mat3 mat = transposeMatrix(mat3(modelMatrix));","vec3 worldScaling = 1.0/vec3(length(mat[0]),length(mat[1]),length(mat[2]));","vec3 V = cameraPosition - vWorldPosition;","float dist = length(worldScaling * V);","V = normalize(V);","float NdotV = dot(currentWorldNormal, V);","float locality = (NdotV > 0.0) ? 1.0 : 0.0;","if (locality == 0.0) {","peelMask = 0.0;","return;","}","float normDist = saturate(scaling * dist * 0.00125);","float shortDist = saturate(1.0 - normDist);","peelMask = shortDist;","}","void doOrangePeel(inout vec3 orangePeelWorldNormal) {","float peelMask = 0.0;","float peelScaling = 0.01/max(orangePeelScale,1e-3);","orangePeelVisibility(orangePeelWorldNormal, peelMask,peelScaling);","if (clearCoatNormalScale < kEpsilon || peelMask < kEpsilon) {","return;","}","vec3 tex = peelScaling * vObjectSpacePosition;","tex.y = -abs(tex.y);","tex.x = -abs(tex.x);","float noise = FBM(tex);","vec3 peelNormal = vec3(noise);","orangePeelWorldNormal = normalize(orangePeelWorldNormal + 0.05 *clearCoatNormalScale *peelMask* peelNormal);","}","#endif","#endif"].join("\n");j.ShaderChunk.sss_pars_fragment=["#ifdef USE_SUBSURFACE","#define MINR 2.0","#define MAXR 16.0","#define MAXC 1.0/MINR","#define MINC 1.0/MAXR","vec3 getSkinSSSLUT(in float NdotL, in float curvature) {","float curva = toTexCoord(1.0/curvature,MINR,MAXR); ","float oneMinusCurva = 1.0 - curva;","vec3 curve0;","{","vec3 rangeMin = vec3(0.0, 0.3, 0.3);","vec3 rangeMax = vec3(1.0, 0.7, 0.7);","vec3 offset = vec3(0.0, 0.06, 0.06);","vec3 t = saturate( fma(vec3(NdotL), 1.0 / (rangeMax - rangeMin), (offset + rangeMin) / (rangeMin - rangeMax)  ) );","vec3 lowerLine = (t * t) * vec3(0.65, 0.5, 0.9);","lowerLine.r += 0.045;","lowerLine.b *= t.b;","vec3 m = vec3(1.75, 2.0, 1.97);","vec3 upperLine = fma(vec3(NdotL), m, vec3(0.99, 0.99, 0.99) -m );","upperLine = saturate(upperLine);","vec3 lerpMin = vec3(0.0, 0.35, 0.35);","vec3 lerpMax = vec3(1.0, 0.7 , 0.6 );","vec3 lerpT = saturate( fma(vec3(NdotL), 1.0/(lerpMax-lerpMin), lerpMin/ (lerpMin - lerpMax) ));","curve0 = mix(lowerLine, upperLine, lerpT * lerpT);","}","vec3 curve1;","{","vec3 m = vec3(1.95, 2.0, 2.0);","vec3 upperLine = fma( vec3(NdotL), m, vec3(0.99, 0.99, 1.0) - m);","curve1 = saturate(upperLine);","}","float oneMinusCurva2 = oneMinusCurva * oneMinusCurva;","vec3 brdf = mix(curve0, curve1, fma(oneMinusCurva2, -1.0 * oneMinusCurva2, 1.0));","return saturate(brdf);","}","vec3 getScattering(in float NoL, in float c) {","mat3 mat = transposeMatrix(mat3(modelMatrix));","vec3 worldScaling = 1.0/vec3(length(mat[0]),length(mat[1]),length(mat[2]));","float cNoL = affine(NoL,0.5,1.0);","#ifdef USE_SSSLUT","float cC = toTexCoord(c,MINC,MAXC);","vec2 coord = vec2(cNoL,1.0-cC);","return texture2D(sssLUT,coord).rgb;","#else","return getSkinSSSLUT(cNoL,c);","#endif","}","vec3 SssLUTSampling(in float c) {","#ifdef USE_SSSIBLLUT","float cC = toTexCoord(ceil(c),MINC,MAXC);","vec2 coord = vec2(0.5,cC);","return texture2D(sssIBLLUT,coord).rgb;","#else","float fNumSamples = 32.0;","vec3 res = vec3(0.0);","for (float i = 0.0; i <= 32.0; i++) {","float theta = i * PI/ fNumSamples;","float NoL = cos(theta);","res += getScattering(NoL, c) * sin(theta);","}","float aux = 2.0*pow2(PI)/(fNumSamples+1.0) * zeroSphericalHarmonics();","return res * aux;","#endif","}","#endif // USE_SUBSURFACE","#if defined(USE_TRANSLUCENCY) && defined(USE_SHADOWMAP)","#define TRANSLUCENCY","#endif","#ifdef TRANSLUCENCY","#define MAX_Depth 16.0","#define MIN_Depth 0.5","vec3 translucencyValue(in float s) {","#ifdef USE_TRANSLUCENCYLUT","vec2 coord = vec2(toTexCoord(s,MIN_Depth,MAX_Depth),0.5);","return texture2D(translucencyLUT, coord).rgb;","#else // translucencyLUTEnabled - // to use when there is no texture","float coord = clamp(s,MIN_Depth,MAX_Depth);","vec3 res = vec3(0.0);","float s2 = -pow2(coord);","res += vec3(0.233,0.455,0.649) * exp(s2 / 0.0064);","res += vec3(0.1,0.336,0.344) * exp(s2 / 0.0484);","res += vec3(0.118,0.198,0.0) * exp(s2 / 0.187);","res += vec3(0.113,0.007,0.007) * exp(s2 / 0.567);","res += vec3(0.358,0.004,0.0) * exp(s2 / 1.99);","res += vec3(0.078,0.0,0.0) * exp(s2 / 7.41);","return res;","#endif // translucencyLUTEnabled","}","#define TRANS_PERFMODE 2","#if TRANS_PERFMODE == 0","#define TRANS_SAMPLE 64","#define TRANS_POISSON_DISK(i)  poisson64[i]","vec2 poisson64[64];","void initDisk() {","poisson64[0] = vec2(-0.934812, 0.366741);","poisson64[1] = vec2(-0.918943, -0.0941496);","poisson64[2] = vec2(-0.873226, 0.62389);","poisson64[3] = vec2(-0.8352, 0.937803);","poisson64[4] = vec2(-0.822138, -0.281655);","poisson64[5] = vec2(-0.812983, 0.10416);","poisson64[6] = vec2(-0.786126, -0.767632);","poisson64[7] = vec2(-0.739494, -0.535813);","poisson64[8] = vec2(-0.681692, 0.284707);","poisson64[9] = vec2(-0.61742, -0.234535);","poisson64[10] = vec2(-0.601184, 0.562426);","poisson64[11] = vec2(-0.607105, 0.847591);","poisson64[12] = vec2(-0.581835, -0.00485244);","poisson64[13] = vec2(-0.554247, -0.771111);","poisson64[14] = vec2(-0.483383, -0.976928);","poisson64[15] = vec2(-0.476669, -0.395672);","poisson64[16] = vec2(-0.439802, 0.362407);","poisson64[17] = vec2(-0.409772, -0.175695);","poisson64[18] = vec2(-0.367534, 0.102451);","poisson64[19] = vec2(-0.35313, 0.58153);","poisson64[20] = vec2(-0.341594, -0.737541);","poisson64[21] = vec2(-0.275979, 0.981567);","poisson64[22] = vec2(-0.230811, 0.305094);","poisson64[23] = vec2(-0.221656, 0.751152);","poisson64[24] = vec2(-0.214393, -0.0592364);","poisson64[25] = vec2(-0.204932, -0.483566);","poisson64[26] = vec2(-0.183569, -0.266274);","poisson64[27] = vec2(-0.123936, -0.754448);","poisson64[28] = vec2(-0.0859096, 0.118625);","poisson64[29] = vec2(-0.0610675, 0.460555);","poisson64[30] = vec2(-0.0234687, -0.962523);","poisson64[31] = vec2(-0.00485244, -0.373394);","poisson64[32] = vec2(0.0213324, 0.760247);","poisson64[33] = vec2(0.0359813, -0.0834071);","poisson64[34] = vec2(0.0877407, -0.730766);","poisson64[35] = vec2(0.14597, 0.281045);","poisson64[36] = vec2(0.18186, -0.529649);","poisson64[37] = vec2(0.188208, -0.289529);","poisson64[38] = vec2(0.212928, 0.063509);","poisson64[39] = vec2(0.23661, 0.566027);","poisson64[40] = vec2(0.266579, 0.867061);","poisson64[41] = vec2(0.320597, -0.883358);","poisson64[42] = vec2(0.353557, 0.322733);","poisson64[43] = vec2(0.404157, -0.651479);","poisson64[44] = vec2(0.410443, -0.413068);","poisson64[45] = vec2(0.413556, 0.123325);","poisson64[46] = vec2(0.46556, -0.176183);","poisson64[47] = vec2(0.49266, 0.55388);","poisson64[48] = vec2(0.506333, 0.876888);","poisson64[49] = vec2(0.535875, -0.885556);","poisson64[50] = vec2(0.615894, 0.0703452);","poisson64[51] = vec2(0.637135, -0.637623);","poisson64[52] = vec2(0.677236, -0.174291);","poisson64[53] = vec2(0.67626, 0.7116);","poisson64[54] = vec2(0.686331, -0.389935);","poisson64[55] = vec2(0.691031, 0.330729);","poisson64[56] = vec2(0.715629, 0.999939);","poisson64[57] = vec2(0.8493, -0.0485549);","poisson64[58] = vec2(0.863582, -0.85229);","poisson64[59] = vec2(0.890622, 0.850581);","poisson64[60] = vec2(0.898068, 0.633778);","poisson64[61] = vec2(0.92053, -0.355693);","poisson64[62] = vec2(0.933348, -0.62981);","poisson64[63] = vec2(0.95294, 0.156896);","}","#elif TRANS_PERFMODE == 1","#define TRANS_SAMPLE 32","#define TRANS_POISSON_DISK(i)  poisson32[i]","vec2 poisson32[TRANS_SAMPLE];","void initDisk() {","poisson32[0] = vec2(-0.975402, -0.0711386);","poisson32[1] = vec2(-0.920347, -0.41142);","poisson32[2] = vec2(-0.883908, 0.217872);","poisson32[3] = vec2(-0.884518, 0.568041);","poisson32[4] = vec2(-0.811945, 0.90521);","poisson32[5] = vec2(-0.792474, -0.779962);","poisson32[6] = vec2(-0.614856, 0.386578);","poisson32[7] = vec2(-0.580859, -0.208777);","poisson32[8] = vec2(-0.53795, 0.716666);","poisson32[9] = vec2(-0.515427, 0.0899991);","poisson32[10] = vec2(-0.454634, -0.707938);","poisson32[11] = vec2(-0.420942, 0.991272);","poisson32[12] = vec2(-0.261147, 0.588488);","poisson32[13] = vec2(-0.211219, 0.114841);","poisson32[14] = vec2(-0.146336, -0.259194);","poisson32[15] = vec2(-0.139439, -0.888668);","poisson32[16] = vec2(0.0116886, 0.326395);","poisson32[17] = vec2(0.0380566, 0.625477);","poisson32[18] = vec2(0.0625935, -0.50853);","poisson32[19] = vec2(0.125584, 0.0469069);","poisson32[20] = vec2(0.169469, -0.997253);","poisson32[21] = vec2(0.320597, 0.291055);","poisson32[22] = vec2(0.359172, -0.633717);","poisson32[23] = vec2(0.435713, -0.250832);","poisson32[24] = vec2(0.507797, -0.916562);","poisson32[25] = vec2(0.545763, 0.730216);","poisson32[26] = vec2(0.56859, 0.11655);","poisson32[27] = vec2(0.743156, -0.505173);","poisson32[28] = vec2(0.736442, -0.189734);","poisson32[29] = vec2(0.843562, 0.357036);","poisson32[30] = vec2(0.865413, 0.763726);","poisson32[31] = vec2(0.872005, -0.927);","}","#else","#define TRANS_SAMPLE 25","#define TRANS_POISSON_DISK(i)  poisson25[i]","vec2 poisson25[TRANS_SAMPLE];","void initDisk() {","poisson25[0] = vec2(-0.978698, -0.0884121);","poisson25[1] = vec2(-0.841121, 0.521165);","poisson25[2] = vec2(-0.71746, -0.50322);","poisson25[3] = vec2(-0.702933, 0.903134);","poisson25[4] = vec2(-0.663198, 0.15482);","poisson25[5] = vec2(-0.495102, -0.232887);","poisson25[6] = vec2(-0.364238, -0.961791);","poisson25[7] = vec2(-0.345866, -0.564379);","poisson25[8] = vec2(-0.325663, 0.64037);","poisson25[9] = vec2(-0.182714, 0.321329);","poisson25[10] = vec2(-0.142613, -0.0227363);","poisson25[11] = vec2(-0.0564287, -0.36729);","poisson25[12] = vec2(-0.0185858, 0.918882);","poisson25[13] = vec2(0.0381787, -0.728996);","poisson25[14] = vec2(0.16599, 0.093112);","poisson25[15] = vec2(0.253639, 0.719535);","poisson25[16] = vec2(0.369549, -0.655019);","poisson25[17] = vec2(0.423627, 0.429975);","poisson25[18] = vec2(0.530747, -0.364971);","poisson25[19] = vec2(0.566027, -0.940489);","poisson25[20] = vec2(0.639332, 0.0284127);","poisson25[21] = vec2(0.652089, 0.669668);","poisson25[22] = vec2(0.773797, 0.345012);","poisson25[23] = vec2(0.968871, 0.840449);","poisson25[24] = vec2(0.991882, -0.657338);","}","#endif // TRANS_PERFMODE","vec3 getShadowCoord(in int lightID) {","for (int i = 0; i < MAX_SHADOWS; i++) {","if (i == lightID) {","return vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;","}","}","}","vec2 getLightNearFar(in int lightID) {","for (int i = 0; i < MAX_SHADOWS; i++) {","if (i == lightID) {","return vec2(directionalLightNear[i], directionalLightFar[i]);","}","}","}","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","#define ONEOVER80 0.0125","#endif","float getDepthValue(in int lightID, in vec2 coord) {","for (int i = 0; i < MAX_SHADOWS; i++) {","if (i == lightID) {","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","gl_FragData[ 0 ].x = exp(80.0*gl_FragCoord.z);","return ONEOVER80*log(texture2D(shadowMap[i], coord).x);","#else","return unpackDepth(texture2D(shadowMap[i], coord) );","#endif","}","}","}","vec2 getMultiplier(in int lightID) {","for (int i = 0; i < MAX_SHADOWS; i++) {","if (i == lightID) {","return saturate(vec2(1.5 / shadowMapSize[i]));","}","}","}","float _clipToEye(in float iNearPlane, in float iFarPlane, in float iZClipSpace)","{","return (2.0 * iNearPlane * iFarPlane) / (iFarPlane + iNearPlane - iZClipSpace * (iFarPlane - iNearPlane));","}","float _clipToEyeOrtho(in float iNearPlane, in float iFarPlane, in float iZClipSpace)","{","return 0.5 * ((iFarPlane - iNearPlane) * iZClipSpace + iFarPlane + iNearPlane);","}","float clipToEye(in float z, in int iLayer)","{","vec2 lightInfo = getLightNearFar(iLayer);","return _clipToEyeOrtho(lightInfo.x, lightInfo.y, z);","}","vec3 multiSampleTranslucency(in int lightID) {","mat3 mat = transposeMatrix(mat3(modelMatrix));","vec3 worldScaling = 1.0/vec3(length(mat[0]),length(mat[1]),length(mat[2]));","vec3 depthMapCoord = getShadowCoord(lightID);","vec2 currentCoord;","float currentDepth = clipToEye(2.0*depthMapCoord.z-1.0,lightID);","vec3 res = vec3(0.0);","vec2 multiplier = getMultiplier(lightID);","for (int i = 0; i < TRANS_SAMPLE; i++) {","vec2 offset =  multiplier* TRANS_POISSON_DISK(i);","currentCoord.xy = saturate(depthMapCoord.xy + offset);","float depth = 2.0*getDepthValue(lightID,currentCoord.xy)-1.0;","float s = max( currentDepth - clipToEye(depth,lightID),0.0);","res += translucencyValue(worldScaling[0] * translucencyScale*s);","}","return res/float(TRANS_SAMPLE);","}","vec3 translucencyBRDF(in vec3 N, in vec3 L, in int iLightIndex, in vec3 V, in vec3 diffuseColor,  in vec3 sr0Color, in vec3 sr90Color) {","vec3 Lt = L - 2.0 * dot(L,N) * N;","float mcdirNoL = saturate(dot(N, Lt)+0.3);","vec3 attenuation = multiSampleTranslucency(iLightIndex);","vec3 Ht = normalize(Lt+V);","vec3 fTrans = FresnelSchlick(sr0Color,sr90Color,saturate(dot(Ht,V)));","return mcdirNoL * attenuation * diffuseColor * (1.0 - fTrans) * INV_PI;","}","#endif // Translucency",].join("\n");j.ShaderChunk.lights_rendering_equation_fragment=["vec3 DiffuseLambertBRDF(vec3 diffuseColor) {","return (diffuseColor * INV_PI);","}","#ifdef USE_ANISOTROPY","float TransmissionAnisoBRDF(in float roughnessX, in float roughnessY, in float NoV, in float NoL, in float NoH, in float VoH, in float LoH, in vec3 iNormal, in vec3 H, in vec3 iTangent, in vec3 iBinormal, in float iAnisotropyAngle) {","float ior2 = ior * ior;","float coeff = abs(LoH * VoH) / max(abs(NoL*NoV),1e-3);","coeff *= ior2;","coeff /= ior * LoH + ior2 *VoH*VoH;","float distrib = AnisotropicDistributionGGX(iTangent, iBinormal, iNormal, H, NoH, roughnessX, roughnessY, iAnisotropyAngle);","float geomVis = GeometricSchlick( roughnessX, NoV, NoL);","return coeff*distrib*geomVis;","}","float SpecularAnisoBRDF(in float roughnessX, in float roughnessY, in float NoV, in float NoL, in float NoH, in vec3 iNormal, in vec3 H, in vec3 iTangent, in vec3 iBinormal, in float iAnisotropyAngle) {","float distrib = AnisotropicDistributionGGX(iTangent, iBinormal, iNormal, H, NoH, roughnessX, roughnessY, iAnisotropyAngle);","float geomVis = 0.25 * GeometricSchlick( roughnessX, NoV, NoL)/ max(NoL * NoV,1e-3);","return distrib*geomVis;","}","void coreModelAniso(inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L, in vec3 T, in vec3 B, in float iAnisotropy, in float iAnisotropyAngle, in float r,in vec3 diffuseColor, in vec3 sr0Color, in vec3 sr90Color) {","float NoL = saturate(dot(N,L));","float NoV = saturate(dot(N,V));","vec3 H = normalize(L+V);","float NoH = saturate(dot(N,H));","float VoH = saturate(dot(V,H));","float rX = r;","float rY = r * (1.0 - iAnisotropy);","diffuse = DiffuseLambertBRDF(diffuseColor) * (1.0 - vMax(max(FresnelSchlick(sr0Color,sr90Color,NoV), FresnelSchlick(sr0Color,sr90Color,NoL))));","specular = SpecularAnisoBRDF(rX, rY, NoV, NoL, NoH,N,H,T,B, iAnisotropyAngle)*FresnelSchlick(sr0Color, sr90Color, VoH);","}","#else","float SpecularBRDF(in float roughness, in float NoV, in float NoL, in float NoH) {","float distrib = DistributionGGX( roughness, NoH);","float geomVis = 0.25*GeometricSchlick( roughness, NoV, NoL)/max(NoL*NoV,1e-3);","return distrib*geomVis;","}","float TransmissionBRDF(in float roughness, in float NoV, in float NoL, in float NoH, in float VoH, in float LoH) {","float ior2 = ior * ior;","float coeff = abs(LoH * VoH) / max(abs(NoL*NoV),1e-3);","coeff *= ior2;","coeff /= ior * LoH + ior2 *VoH*VoH;","float distrib = DistributionGGX( roughness, NoH);","float geomVis = GeometricSchlick( roughness, NoV, NoL);","return coeff*distrib*geomVis;","}","void coreModel(inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L, in float r,in vec3 diffuseColor, in vec3 sr0Color, in vec3 sr90Color) {","float NoL = saturate(dot(N,L));","float NoV = saturate(dot(N,V));","vec3 H = normalize(L+V);","float NoH = saturate(dot(N,H));","float VoH = saturate(dot(V,H));","diffuse = DiffuseLambertBRDF(diffuseColor) * (1.0 - vMax(max(FresnelSchlick(sr0Color,sr90Color,NoV), FresnelSchlick(sr0Color,sr90Color,NoL))));","specular = SpecularBRDF(r, NoV, NoL, NoH) *FresnelSchlick(sr0Color, sr90Color, VoH);","}","#endif",j.ShaderChunk.sheen_pars_fragment,"#ifdef OLD_FLAKES",j.ShaderChunk.old_flakes_pars_fragment,"#else",j.ShaderChunk.flakes_pars_fragment,"#endif",j.ShaderChunk.coating_pars_fragment,j.ShaderChunk.sss_pars_fragment,].join("\n");j.ShaderChunk.light_model_pars_fragment=["void _doCommonLightingModel(inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L) {","#ifdef USE_ANISOTROPY","coreModelAniso(diffuse,specular, N,V,L, materialData.tangent, materialData.binormal, materialData.anisotropy, materialData.anisotropyAngle,materialData.roughness,materialData.diffuseColor,materialData.sr0Color,materialData.sr90Color);","#ifdef USE_SHEEN","diffuse = sheenModelAniso(diffuse,materialData.diffuseColor,materialData.sr0Color,materialData.sr90Color, N, V, L,materialData.sheen, materialData.tangent, materialData.binormal, materialData.anisotropy, materialData.anisotropyAngle);","#endif","#else","coreModel(diffuse,specular, N,V,L,materialData.roughness,materialData.diffuseColor,materialData.sr0Color,materialData.sr90Color);","#ifdef USE_SHEEN","diffuse = sheenModel(diffuse,materialData.diffuseColor,materialData.sr0Color,materialData.sr90Color, N, V, L, materialData.sheen);","#endif","#endif","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","specular += flakesModel(diffuse,specular, V,L);","#else","specular += flakesLightEquation(diffuse,specular,V,L,N,materialData.flakesRoughness,materialData.flakesColor, materialData.flakesCoverage);","#endif","#endif","#ifdef CLEAR_COAT","specular += clearCoatModel(diffuse,specular, materialData.clearCoatNormal, V, L,materialData.clearCoatR, materialData.clearCoat);","#endif","}","void doLightingModel(in vec3 E, inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L) {","_doCommonLightingModel(diffuse,specular,N,V,L);","vec3 ENoL = E * saturate(dot(N, L));","#ifdef USE_SUBSURFACE","float sssNoL = dot(N, L);","diffuse *= E * getScattering(sssNoL, materialData.curvature);","#else","diffuse *= ENoL;","#endif","specular *= ENoL;","}","void doAreaLightingModel(in vec3 E, inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L) {","_doCommonLightingModel(diffuse,specular,N,V,L);","specular *= E;","diffuse *= E;","}",].join("\n");j.ShaderChunk.lights_utility_pars_fragment=["#ifdef HAS_AREA_LIGHTS","struct areaLightingData","{","mat3 Minv;","vec2 fresnel;","#ifdef CLEAR_COAT","mat3 MinvCC;","vec2 fresnelCC;","#endif","#ifdef USE_SHEEN","mat3 MinvSheen;","#endif","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","mat3 MinvMetal;","vec2 fresnelMetal;","mat3 MinvMetalFlakes;","vec2 fresnelMetalFlakes;","#ifdef PEARL_FLAKES_ACTIVATED","mat3 MinvPearlFlakes;","vec2 fresnelPearlFlakes;","#endif","#else","mat3 MinvMetal;","vec2 fresnelMetal;","#endif","#endif","};","areaLightingData areaData;","#define LUT_SIZE 64.0","#define LUT_SCALE (LUT_SIZE - 1.0)/LUT_SIZE","#define LUT_BIAS 0.5/LUT_SIZE","#ifdef USE_SHEEN","void setAreaSheenData(in float roughness, in float NoV, out mat3 Minv) {","vec2 uvAr = vec2(roughness, 1.0 - sqrt(1.0 - NoV)) * LUT_SCALE + LUT_BIAS;","vec4 t1 = texture2D(precomputedAreaSheentexture, uvAr);","Minv = mat3(","vec3(t1.x,  0, t1.y),","vec3(  0, 1.0,   0),","vec3(t1.z,  0, t1.w)",");","}","#endif","void setAreaGGXData(in float roughness, in float NoV, out vec2 fresnel, out mat3 Minv) {","vec2 uvAr = vec2(roughness, 1.0 - sqrt(1.0 - NoV)) * LUT_SCALE + LUT_BIAS;","vec4 t1 = texture2D(precomputedAreaGGX1texture, uvAr);","vec4 t2 = texture2D(precomputedAreaGGX2texture, uvAr);","Minv = mat3(","vec3(t1.x,  0, t1.y),","vec3(  0, 1.0,   0),","vec3(t1.z,  0, t1.w)",");","fresnel = vec2(t2.z,t2.y);","}","float IntegrateEdge(in vec3 v1, in vec3 v2)","{","float x = dot(v1, v2);","float y = abs(x);","float a = 0.8543985 + (0.4965155 + 0.0145206*y)*y;","float b = 3.4175940 + (4.1616724 + y)*y;","float v = a / b;","float theta_sintheta = (x > 0.0) ? v : 0.5*inversesqrt(1.0 - x*x) - v;","return (cross(v1, v2)*theta_sintheta).z;","}","void ClipQuad(inout vec3 L[5], out int n)","{","int config = 0;","if (L[0].z > 0.0) config += 1;","if (L[1].z > 0.0) config += 2;","if (L[2].z > 0.0) config += 4;","if (L[3].z > 0.0) config += 8;","n = 0;","if (config == 0)","{","}","else if (config == 1)","{","n = 3;","L[1] = -L[1].z * L[0] + L[0].z * L[1];","L[2] = -L[3].z * L[0] + L[0].z * L[3];","}","else if (config == 2)","{","n = 3;","L[0] = -L[0].z * L[1] + L[1].z * L[0];","L[2] = -L[2].z * L[1] + L[1].z * L[2];","}","else if (config == 3)","{","n = 4;","L[2] = -L[2].z * L[1] + L[1].z * L[2];","L[3] = -L[3].z * L[0] + L[0].z * L[3];","}","else if (config == 4)","{","n = 3;","L[0] = -L[3].z * L[2] + L[2].z * L[3];","L[1] = -L[1].z * L[2] + L[2].z * L[1];","}","else if (config == 5)","{","n = 0;","}","else if (config == 6)","{","n = 4;","L[0] = -L[0].z * L[1] + L[1].z * L[0];","L[3] = -L[3].z * L[2] + L[2].z * L[3];","}","else if (config == 7)","{","n = 5;","L[4] = -L[3].z * L[0] + L[0].z * L[3];","L[3] = -L[3].z * L[2] + L[2].z * L[3];","}","else if (config == 8)","{","n = 3;","L[0] = -L[0].z * L[3] + L[3].z * L[0];","L[1] = -L[2].z * L[3] + L[3].z * L[2];","L[2] =  L[3];","}","else if (config == 9)","{","n = 4;","L[1] = -L[1].z * L[0] + L[0].z * L[1];","L[2] = -L[2].z * L[3] + L[3].z * L[2];","}","else if (config == 10)","{","n = 0;","}","else if (config == 11)","{","n = 5;","L[4] = L[3];","L[3] = -L[2].z * L[3] + L[3].z * L[2];","L[2] = -L[2].z * L[1] + L[1].z * L[2];","}","else if (config == 12)","{","n = 4;","L[1] = -L[1].z * L[2] + L[2].z * L[1];","L[0] = -L[0].z * L[3] + L[3].z * L[0];","}","else if (config == 13) ","{","n = 5;","L[4] = L[3];","L[3] = L[2];","L[2] = -L[1].z * L[2] + L[2].z * L[1];","L[1] = -L[1].z * L[0] + L[0].z * L[1];","}","else if (config == 14)","{","n = 5;","L[4] = -L[0].z * L[3] + L[3].z * L[0];","L[0] = -L[0].z * L[1] + L[1].z * L[0];","}","else if (config == 15)","{","n = 4;","}","if (n == 3)","L[3] = L[0];","if (n == 4)","L[4] = L[0];","}","float areaRectangleLight(in vec3 N, in vec3 V, in vec3 P,in mat3 Minv, in vec3 p0, in vec3 p1, in vec3 p2, in vec3 p3) {","vec3 T = normalize(V-N*dot(V,N));","vec3 B = cross(N,T);","mat3 M = Minv*transposeMatrix(mat3(T,B,N));","float res = 0.0;","vec3 L[5];","L[0] = M * (p0 - P);","L[1] = M * (p1 - P);","L[2] = M * (p2 - P);","L[3] = M * (p3 - P);","int config = 0;","ClipQuad(L,config);","if (config == 0) {","return 0.0;","}","L[0] = normalize(L[0]);","L[1] = normalize(L[1]);","L[2] = normalize(L[2]);","L[3] = normalize(L[3]);","L[4] = normalize(L[4]);","res += IntegrateEdge(L[0], L[1]);","res += IntegrateEdge(L[1], L[2]);","res += IntegrateEdge(L[2], L[3]);","if (config >= 4)","res += IntegrateEdge(L[3], L[4]);","if (config == 5)","res += IntegrateEdge(L[4], L[0]);","return max(0.0,res);","}","vec3 SolveCubic(vec4 Coefficient) {","Coefficient.xyz /= Coefficient.w;","Coefficient.yz /= 3.0;","float A = Coefficient.w;","float B = Coefficient.z;","float C = Coefficient.y;","float D = Coefficient.x;","vec3 Delta = vec3(","-Coefficient.z*Coefficient.z + Coefficient.y,","-Coefficient.y*Coefficient.z + Coefficient.x,","dot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)",");","float Discriminant = dot(vec2(4.0*Delta.x, -Delta.y), Delta.zy);","vec3 RootsA, RootsD;","vec2 xlc, xsc;","{","float A_a = 1.0;","float C_a = Delta.x;","float D_a = -2.0*B*Delta.x + Delta.y;","float Theta = atan(sqrt(Discriminant), -D_a)/3.0;","float x_1a = 2.0*sqrt(-C_a)*cos(Theta);","float x_3a = 2.0*sqrt(-C_a)*cos(Theta + (2.0/3.0)*3.14159265);","float xl;","if ((x_1a + x_3a) > 2.0*B)","xl = x_1a;","else","xl = x_3a;","xlc = vec2(xl - B, A);","}","{","float A_d = D;","float C_d = Delta.z;","float D_d = -D*Delta.y + 2.0*C*Delta.z;","float Theta = atan(D*sqrt(Discriminant), -D_d)/3.0;","float x_1d = 2.0*sqrt(-C_d)*cos(Theta);","float x_3d = 2.0*sqrt(-C_d)*cos(Theta + (2.0/3.0)*3.14159265);","float xs;","if (x_1d + x_3d < 2.0*C)","xs = x_1d;","else","xs = x_3d;","xsc = vec2(-D, xs + C);","}","float E =  xlc.y*xsc.y;","float F = -xlc.x*xsc.y - xlc.y*xsc.x;","float G =  xlc.x*xsc.x;","vec2 xmc = vec2(C*F - B*G, -B*F + C*E);","vec3 Root = vec3(xsc.x/xsc.y, xmc.x/xmc.y, xlc.x/xlc.y);","if (Root.x < Root.y && Root.x < Root.z)","Root.xyz = Root.yxz;","else if (Root.z < Root.x && Root.z < Root.y)","Root.xyz = Root.xzy;","return Root;","}","float areaDiskLight(vec3 N, vec3 V, vec3 P, mat3 Minv, vec3 p0, vec3 p1, vec3 p2) {","vec3 T = normalize(V-N*dot(V,N));","vec3 B = cross(N,T);","mat3 R = transposeMatrix(mat3(T, B, N));","vec3 L[3];","L[0] = R * (p0 - P);","L[1] = R * (p1 - P);","L[2] = R * (p2 - P);","vec3 c  = Minv *(0.5 * (L[0] + L[2]));","vec3 v1 = Minv *(0.5 * (L[1] - L[2]));","vec3 v2 = Minv *(0.5 * (L[1] - L[0]));","if(dot(cross(v1, v2), c) < 0.0)","return 0.0;","float a, b;","float d11 = dot(v1, v1);","float d22 = dot(v2, v2);","float d12 = dot(v1, v2);","if (abs(d12)/sqrt(d11*d22) > 0.005) {","float tr = d11 + d22;","float det = -d12*d12 + d11*d22;","det = sqrt(det);","float u = 0.5*sqrt(tr - 2.0*det);","float v = 0.5*sqrt(tr + 2.0*det);","float e_max = pow2(u + v);","float e_min = pow2(u - v);","vec3 v1_, v2_;","if (d11 > d22) {","v1_ = d12*v1 + (e_max - d11)*v2;","v2_ = d12*v1 + (e_min - d11)*v2;","}","else {","v1_ = d12*v2 + (e_max - d22)*v1;","v2_ = d12*v2 + (e_min - d22)*v1;","}","a = 1.0 / e_max;","b = 1.0 / e_min;","v1 = normalize(v1_);","v2 = normalize(v2_);","}","else {","a = 1.0 / dot(v1, v1);","b = 1.0 / dot(v2, v2);","v1 *= sqrt(a);","v2 *= sqrt(b);","}","vec3 v3 = normalize(cross(v1, v2));","if (dot(c, v3) < 0.0)","v3 *= -1.0;","float L_  = dot(v3, c);","float x0 = dot(v1, c) / L_;","float y0 = dot(v2, c) / L_;","float E1 = inversesqrt(a);","float E2 = inversesqrt(b);","a *= L_*L_;","b *= L_*L_;","float c0 = a*b;","float c1 = a*b*(1.0 + x0*x0 + y0*y0) - a - b;","float c2 = 1.0 - a*(1.0 + x0*x0) - b*(1.0 + y0*y0);","float c3 = 1.0;","vec3 roots = SolveCubic(vec4(c0, c1, c2, c3));","float e1 = roots.x;","float e2 = roots.y;","float e3 = roots.z;","vec3 avgDir = vec3(a*x0/(a - e2), b*y0/(b - e2), 1.0);","mat3 rotate = mat3(v1, v2, v3);","avgDir = rotate*avgDir;","avgDir = normalize(avgDir);","float L1 = sqrt(-e2/e3);","float L2 = sqrt(-e2/e1);","float formFactor = L1*L2*inversesqrt((1.0 + L1*L1)*(1.0 + L2*L2));","vec2 uv = vec2(avgDir.z*0.5 + 0.5, 1.0-formFactor);","uv = uv*LUT_SCALE + LUT_BIAS;","float scale = texture2D(precomputedAreaGGX2texture, uv).w;","float res = formFactor*scale*scale;","return res;","}","void areaRectangleLightModel(out vec3 specular, out vec3 diffuse, in vec3 N,in vec3 V, in vec3 P, in vec3 p0,in vec3 p1,in vec3 p2,in vec3 p3) {","specular = materialData.sr0Color * areaData.fresnel.x + materialData.sr90Color * areaData.fresnel.y;","specular *= areaRectangleLight(N,V,P,areaData.Minv, p0,p1,p2,p3);","diffuse = materialData.diffuseColor * areaRectangleLight(N,V,P,mat3(1.0),p0,p1,p2,p3);","#ifdef USE_SHEEN","vec3 sheen = materialData.diffuseColor * areaRectangleLight(N,V,P,areaData.MinvSheen,p0,p1,p2,p3);","diffuse = mix(diffuse,sheen, 1.0 - pow5(1.0-materialData.sheen));","#endif","diffuse *= 1.0 - vMax(FresnelSchlick(materialData.sr0Color,materialData.sr90Color,saturate(dot(N,V))));","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","vec3 flakesVal = metalFlakes.F0 * areaData.fresnelMetalFlakes.x;","flakesVal *= areaRectangleLight(N,V,P,areaData.MinvMetalFlakes, p0,p1,p2,p3);","specular += flakesVal;","flakesVal = metal.F0 * areaData.fresnelMetal.x;","flakesVal *= areaRectangleLight(N,V,P,areaData.MinvMetal, p0,p1,p2,p3);","float energyFlakes = 1.0 - vMax(FresnelSchlick(metal.F0, vec3(0.0), saturate(dot(metal.normal,V))));","specular *= energyFlakes;","diffuse *= energyFlakes;","specular += flakesVal;","#ifdef PEARL_FLAKES_ACTIVATED","flakesVal = pearlFlakes.F0 * areaData.fresnelPearlFlakes.x;","flakesVal *= areaRectangleLight(N,V,P,areaData.MinvPearlFlakes, p0,p1,p2,p3);","energyFlakes = 1.0 - vMax(FresnelSchlick(pearlFlakes.F0, vec3(0.0), saturate(dot(pearlFlakes.normal,V))));","specular *= energyFlakes;","diffuse *= energyFlakes;","specular += flakesVal;","#endif","#else","vec3 flakesVal = vec3(areaDiskLight(N,V,P,areaData.MinvMetal, p0,p1,p2));","if (flakesData.blendDist < 1.0 - 1e-3) {","vec3 color = flakesVal;","flakesVal *= flakesData.blendDist;","vec3 flakesL = normalize(mix(reflect(-V,N), N, materialData.flakesRoughness));","vec3 flakesH = normalize(flakesL + V);","float VoH = dot(V,flakesH);","float NoL = saturate(dot(N,flakesL));","float NoV = saturate(dot(N,V));","flakesVal += (1.0 - flakesData.blendDist) * color.xyz * stochasticFlakesBRDF(V,flakesL,N,materialData.flakesRoughness,VoH,NoL,NoV);","}","specular *= 1.0 - materialData.flakesCoverage;","diffuse *= 1.0 - materialData.flakesCoverage;","specular += materialData.flakesColor * materialData.flakesCoverage * flakesVal;","#endif","#endif","#ifdef CLEAR_COAT","float fresnelEnergy = 1.0 - materialData.clearCoat * vMax(FresnelSchlick(COATINGF0, COATINGF90, saturate(dot(materialData.clearCoatNormal,V))));","vec3 coat = COATINGF0 * areaData.fresnelCC.x + COATINGF90 * areaData.fresnelCC.y;","coat *= areaRectangleLight(N,V,P,areaData.MinvCC, p0,p1,p2,p3);","diffuse *= fresnelEnergy;","specular *= fresnelEnergy;","specular += coat;","#endif","}","void areaDiskLightModel(out vec3 specular, out vec3 diffuse, in vec3 N,in vec3 V, in vec3 P, in vec3 p0,in vec3 p1,in vec3 p2) {","specular = materialData.sr0Color * areaData.fresnel.x + materialData.sr90Color * areaData.fresnel.y;","specular *= areaDiskLight(N,V,P,areaData.Minv, p0,p1,p2);","diffuse = materialData.diffuseColor * areaDiskLight(N,V,P,mat3(1.0),p0,p1,p2);","#ifdef USE_SHEEN","vec3 sheen = materialData.diffuseColor * areaDiskLight(N,V,P,areaData.MinvSheen,p0,p1,p2);","diffuse = mix(diffuse,sheen, 1.0 - pow5(1.0-materialData.sheen));","#endif","diffuse *= 1.0 - vMax(FresnelSchlick(materialData.sr0Color,materialData.sr90Color,saturate(dot(N,V))));","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","vec3 flakesVal = metalFlakes.F0 * areaData.fresnelMetalFlakes.x;","flakesVal *= areaDiskLight(N,V,P,areaData.MinvMetalFlakes, p0,p1,p2);","specular += flakesVal;","flakesVal = metal.F0 * areaData.fresnelMetal.x;","flakesVal *= areaDiskLight(N,V,P,areaData.MinvMetal, p0,p1,p2);","float energyFlakes = 1.0 - vMax(FresnelSchlick(metal.F0, vec3(0.0), saturate(dot(metal.normal,V))));","specular *= energyFlakes;","diffuse *= energyFlakes;","specular += flakesVal;","#ifdef PEARL_FLAKES_ACTIVATED","flakesVal = pearlFlakes.F0 * areaData.fresnelPearlFlakes.x;","flakesVal *= areaDiskLight(N,V,P,areaData.MinvPearlFlakes, p0,p1,p2);","energyFlakes = 1.0 - vMax(FresnelSchlick(pearlFlakes.F0, vec3(0.0), saturate(dot(pearlFlakes.normal,V))));","specular *= energyFlakes;","diffuse *= energyFlakes;","specular += flakesVal;","#endif","#else","vec3 flakesVal = vec3(areaDiskLight(N,V,P,areaData.MinvMetal, p0,p1,p2));","if (flakesData.blendDist < 1.0 - 1e-3) {","vec3 color = flakesVal;","flakesVal *= flakesData.blendDist;","vec3 flakesL = normalize(mix(reflect(-V,N), N, materialData.flakesRoughness));","vec3 flakesH = normalize(flakesL + V);","float VoH = dot(V,flakesH);","float NoL = saturate(dot(N,flakesL));","float NoV = saturate(dot(N,V));","flakesVal += (1.0 - flakesData.blendDist) * color.xyz * stochasticFlakesBRDF(V,flakesL,N,materialData.flakesRoughness,VoH,NoL,NoV);","}","specular *= 1.0 - materialData.flakesCoverage;","diffuse *= 1.0 - materialData.flakesCoverage;","specular += materialData.flakesColor * materialData.flakesCoverage * flakesVal;","#endif","#endif","#ifdef CLEAR_COAT","float fresnelEnergy = 1.0 - materialData.clearCoat * vMax(FresnelSchlick(COATINGF0, COATINGF90, saturate(dot(materialData.clearCoatNormal,V))));","vec3 coat = COATINGF0 * areaData.fresnelCC.x + COATINGF90 * areaData.fresnelCC.y;","coat *= areaDiskLight(N,V,P,areaData.MinvCC, p0,p1,p2);","diffuse *= fresnelEnergy;","specular *= fresnelEnergy;","specular += coat;","#endif","}","void getSphereLightPoints(in vec3 lP, in float r, in float radius, out vec3 p0, out vec3 p1, out vec3 p2, in vec3 lN, in vec3 N, in vec3 P) {","vec3 toUse = normalize(mix(lN.xyz, -N.xyz, r));","vec3 offsetP = lP + radius * max(dot(vNormalize(P - lP), toUse),0.0) * toUse;","float coeff = radius * mix(1.0, 2.0, r);","vec3 right = getGeomT(toUse.xyz);","vec3 up = getGeomB(toUse.xyz, right);","p0 = offsetP.xyz + right * coeff - up * coeff;","p1 = offsetP.xyz - right * coeff - up * coeff;","p2 = offsetP.xyz - right * coeff + up * coeff;","}","void areaSphereLightModel(out vec3 specular, out vec3 diffuse, in vec3 N,in vec3 V, in vec3 P, in vec3 lP, in vec3 lN, in float r) {","vec3 p0Spec, p1Spec, p2Spec, p0Diff, p1Diff, p2Diff;","#ifdef USE_SHEEN","vec3 p0Sheen, p1Sheen, p2Sheen;","#endif","#ifdef CLEAR_COAT","vec3 p0CC, p1CC, p2CC;","#endif","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","vec3 p0Metal, p1Metal, p2Metal;","vec3 p0MetalFlakes, p1MetalFlakes, p2MetalFlakes;","#ifdef PEARL_FLAKES_ACTIVATED","vec3 p0PearlFlakes, p1PearlFlakes, p2PearlFlakes;","#endif","#else","vec3 p0Metal, p1Metal, p2Metal;","#endif","#endif","{","getSphereLightPoints(lP, materialData.roughness,r, p0Spec, p1Spec, p2Spec, lN, N, P);","#ifdef USE_SHEEN","#ifdef USE_VELVET","float s = sqrt(materialData.sheen);","#else","float s = 0.3;","#endif","getSphereLightPoints(lP, s,r, p0Sheen, p1Sheen, p2Sheen, lN, N, P);","#endif","#ifdef CLEAR_COAT","getSphereLightPoints(lP, materialData.clearCoatR,r, p0CC, p1CC, p2CC, lN, materialData.clearCoatNormal, P);","#endif","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","getSphereLightPoints(lP, metal.roughness,r, p0Metal, p1Metal, p2Metal, lN, metal.normal, P);","getSphereLightPoints(lP, metalFlakes.roughness,r, p0MetalFlakes, p1MetalFlakes, p2MetalFlakes, lN, metalFlakes.normal, P);","#ifdef PEARL_FLAKES_ACTIVATED","getSphereLightPoints(lP, pearlFlakes.roughness,r, p0PearlFlakes, p1PearlFlakes, p2PearlFlakes, lN, pearlFlakes.normal, P);","#endif","#else","getSphereLightPoints(lP, materialData.flakesRoughness,r, p0Metal, p1Metal, p2Metal, lN, metal.normal, P);","#endif","#endif","getSphereLightPoints(lP, 1.0,r, p0Diff, p1Diff, p2Diff, lN, N, P);","}","specular = materialData.sr0Color * areaData.fresnel.x + materialData.sr90Color * areaData.fresnel.y;","specular *= areaDiskLight(N,V,P,areaData.Minv, p0Spec,p1Spec,p2Spec);","diffuse = materialData.diffuseColor * areaDiskLight(N,V,P,mat3(1.0),p0Diff,p1Diff,p2Diff);","#ifdef USE_SHEEN","vec3 sheen = materialData.diffuseColor * areaDiskLight(N,V,P,areaData.MinvSheen,p0Sheen,p1Sheen,p2Sheen);","diffuse = mix(diffuse,sheen, 1.0 - pow5(1.0-materialData.sheen));","#endif","diffuse *= 1.0 - vMax(FresnelSchlick(materialData.sr0Color,materialData.sr90Color,saturate(dot(N,V))));","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","vec3 flakesVal = metalFlakes.F0 * areaData.fresnelMetalFlakes.x;","flakesVal *= areaDiskLight(N,V,P,areaData.MinvMetalFlakes, p0MetalFlakes,p1MetalFlakes,p2MetalFlakes);","specular += flakesVal;","flakesVal = metal.F0 * areaData.fresnelMetal.x;","flakesVal *= areaDiskLight(N,V,P,areaData.MinvMetal, p0Metal,p1Metal,p2Metal);","float energyFlakes = 1.0 - vMax(FresnelSchlick(metal.F0, vec3(0.0), saturate(dot(metal.normal,V))));","specular *= energyFlakes;","diffuse *= energyFlakes;","specular += flakesVal;","#ifdef PEARL_FLAKES_ACTIVATED","flakesVal = pearlFlakes.F0 * areaData.fresnelPearlFlakes.x;","flakesVal *= areaDiskLight(N,V,P,areaData.MinvPearlFlakes, p0PearlFlakes,p1PearlFlakes,p2PearlFlakes);","energyFlakes = 1.0 - vMax(FresnelSchlick(pearlFlakes.F0, vec3(0.0), saturate(dot(pearlFlakes.normal,V))));","specular *= energyFlakes;","diffuse *= energyFlakes;","specular += flakesVal;","#endif","#else","vec3 flakesVal = vec3(areaDiskLight(N,V,P,areaData.MinvMetal, p0Metal,p1Metal,p2Metal));","if (flakesData.blendDist < 1.0 - 1e-3) {","vec3 color = flakesVal;","flakesVal *= flakesData.blendDist;","vec3 flakesL = normalize(mix(reflect(-V,N), N, materialData.flakesRoughness));","vec3 flakesH = normalize(flakesL + V);","float VoH = dot(V,flakesH);","float NoL = saturate(dot(N,flakesL));","float NoV = saturate(dot(N,V));","flakesVal += (1.0 - flakesData.blendDist) * color.xyz * stochasticFlakesBRDF(V,flakesL,N,materialData.flakesRoughness,VoH,NoL,NoV);","}","specular *= 1.0 - materialData.flakesCoverage;","diffuse *= 1.0 - materialData.flakesCoverage;","specular += materialData.flakesColor * materialData.flakesCoverage * flakesVal;","#endif","#endif","#ifdef CLEAR_COAT","float fresnelEnergy = 1.0 - materialData.clearCoat * vMax(FresnelSchlick(COATINGF0, COATINGF90, saturate(dot(materialData.clearCoatNormal,V))));","vec3 coat = COATINGF0 * areaData.fresnelCC.x + COATINGF90 * areaData.fresnelCC.y;","coat *= areaDiskLight(N,V,P,areaData.MinvCC, p0CC,p1CC,p2CC);","diffuse *= fresnelEnergy;","specular *= fresnelEnergy;","specular += coat;","#endif","}","vec3 getSpecularDominantDir(in vec3 N, in vec3 R, in float r){","return normalize(mix(N, R, 1.0-r));","}","float solidAngleRect(in vec3 viewPos, in vec3 p0, in vec3 p1, in vec3 p2, in vec3 p3) {","vec3 v0 = p0 - viewPos;","vec3 v1 = p1 - viewPos;","vec3 v2 = p2 - viewPos;","vec3 v3 = p3 - viewPos;","vec3 n0 = normalize(cross(v0,v1));","vec3 n1 = normalize(cross(v1,v2));","vec3 n2 = normalize(cross(v2,v3));","vec3 n3 = normalize(cross(v3,v0));","float g0 = acos(dot(-n0,n1));","float g1 = acos(dot(-n1,n2));","float g2 = acos(dot(-n2,n3));","float g3 = acos(dot(-n3,n0));","return g0 + g1 + g2 + g3 - 2.0 * 3.14159;","}","vec3 closestOnLine(in vec3 a, in vec3 b, in vec3 c) {","vec3 ab = b - a;","float t = dot(c - a , ab) / dot(ab,ab);","return a + t * ab;","}","vec3 closestOnSegment(in vec3 a, in vec3 b, in vec3 c) {","vec3 ab = b - a;","float t = dot(c - a, ab) / dot(ab,ab);","return a + saturate(t) * ab;","}","vec3 closestPointSphere(in vec3 L, in vec3 R, in float radius) {","vec3 centerToRay = dot(L, R) * R - L;","vec3 closestPoint = L + centerToRay * saturate(radius / length(centerToRay));","return normalize(closestPoint);","}","vec3 closestPointTube(in vec3 P0, in vec3 P1,in vec3 N, in vec3 R, in vec3 P, in vec3 Lp, in float radius) {","vec3 L0 = P0 - P;","vec3 L1 = P1 - P;","vec3 Ld = L1 - L0;","float coeff = dot(R,L0)*dot(R,Ld) - dot(L0,Ld);","coeff /= dot(Ld,Ld) - pow2(dot(R,Ld));","vec3 L = L0 + saturate(coeff) * Ld;","return closestPointSphere(L,R,radius);","}","float illuminanceRectangle(in vec3 p0, in vec3 p1, in vec3 p2, in vec3 p3,in vec3 lPos, in vec3 vPos, in vec3 N) {","float angle = solidAngleRect(vPos, p0,p1,p2,p3);","float coeff = saturate(dot(normalize(lPos - vPos),N));","coeff += saturate(dot(normalize(p0 - vPos),N)) + saturate(dot(normalize(p1 - vPos),N));","coeff += saturate(dot(normalize(p2 - vPos),N)) + saturate(dot(normalize(p3 - vPos),N));","return angle * 0.2*coeff;","}","float illuminanceTube(in vec3 P0, in vec3 P1, in vec3 lPos, in vec3 vPos, in vec3 N, in vec3 lRight, in float lHWidth, in float lRadius) {","vec3 forw = normalize(closestOnLine(P0,P1,vPos) - vPos);","vec3 right = lRight;","vec3 up = cross(right, forw);","float illu = 0.0;//illuminanceRectangle(p0,p1,p2,p3,lPos,vPos,N);","vec3 sphPos = closestOnSegment(P0,P1, vPos);","vec3 sphNorm = sphPos - vPos;","vec3 sphL = normalize(sphNorm);","float sqrSphDist = dot(sphNorm, sphNorm);","float illu2 = 3.14159 * saturate(dot(sphL, N)) * ((lRadius*lRadius)/sqrSphDist);","return illu+illu2;","}","#endif",].join("\n");j.ShaderChunk.lights_physicalDS_pars_fragment=[j.ShaderChunk.physicalDS_uniforms_pars_fragment,j.ShaderChunk.lights_uniform_fragment,j.ShaderChunk.shadowmap_pars_fragment,j.ShaderChunk.brdf_pars_fragment,j.ShaderChunk.lights_rendering_equation_fragment,j.ShaderChunk.light_model_pars_fragment,j.ShaderChunk.lights_utility_pars_fragment,j.ShaderChunk.emission_pars_fragment,j.ShaderChunk.iteration_pars_fragment,"#ifdef GAS_LOOK","vec3 perturbNormalGasLook(vec3 normal, vec3 vWorldPosition) {","float bumpNorm = 0.02 * snoise(10.0 * vWorldPosition);","bumpNorm = mix(bumpNorm, 0.0, clamp(0.02 * abs(vViewPosition.z), 0.0, 1.0));","return normalize(normal + vec3(bumpNorm));","}","#endif"].join("\n");j.ShaderChunk.IBL_pars_fragment=["#if defined( USE_SH_ENVMAP )","uniform mat4 shFactorsR;","uniform mat4 shFactorsG;","uniform mat4 shFactorsB;","uniform float shScale;","#endif","#ifdef USE_ENVMAP","uniform sampler2D precomputedTexture1;","#ifdef USE_SHEEN","uniform sampler2D precomputedTexture2;","#endif","#if (defined(USE_FLAKES) && !defined(OLD_FLAKES)) || defined(USE_SHEEN)","uniform sampler2D precomputedTexture3;","#endif","uniform sampler2D envMap2;","#endif","#ifdef USE_REFLECTION_PROBE","uniform sampler2D reflectionProbe;","uniform sampler2D reflectionProbeMips;","uniform vec3 reflectionProbeProxyMin;","uniform vec3 reflectionProbeProxyMax;","uniform vec3 reflectionProbePos;","#endif","#ifdef USE_FINITE_ENVMAP","uniform vec3 sphereCenter;","uniform vec3 projectionCenter;","uniform float sphereRadius;","#endif","#if defined(USE_SSLR)","uniform sampler2D prevColorTexture;","uniform sampler2D prevNormalDepthTexture;","uniform vec2 screenSize;","uniform vec2 invScreenSize;","#endif","#if defined(USE_ENVMAP)","const float oneOverMax16int = 0.000015259021896696422;","vec2 getMips(in float roughnessValue) {","float mipValue = max(6.0 + 1.15 * log2(roughnessValue + 0.0000001), 0.0);","float mipCoef = fract(mipValue);","if (mipValue > 6.0) {","mipValue = 6.0;","mipCoef = 1.0;","}","return vec2(mipValue,mipCoef);","}","vec2 getEnvMapUV(in vec3 vector) {","vector = (ambienceMatrix*vec4(vector,0.0)).xyz;","float phi = atan(vector.y, vector.x);","float theta = acos(vector.z);","return vec2(fract(0.5 + 0.5 * INV_PI * phi), 1.0 - INV_PI * theta);","}","float unpackFrom16(vec2 pack) {","return 255.0 * oneOverMax16int * (256.0 * pack.x + pack.y);","}","vec2 getUVFromMips(float mip, vec2 uv, vec2 texelSize) {","float t10 = pow(2.0, -floor(log2(mip + 1.0)));","float t11 = 2.0 - (mip + 2.0) * t10;","float t12 = 0.5 * t10;","return vec2(t11 + 1.5 * texelSize.x + (2.0 * t12 - 3.0 * texelSize.x) * uv.x, t12 + 1.5 * texelSize.x + (t12 - 3.0 * texelSize.x) * uv.y);","}","vec4 sampleMipMapRoughness(vec2 uv, float mip, float coef, sampler2D map0, sampler2D map1, vec2 textureSize, vec2 texelSize) {","vec4 color1;","vec4 color2;","vec2 uv1;","vec2 uv2;","#ifdef USE_ENVMAP_HDR","if (mip < 1.0) {","color1 = texture2DBilinearFromRGBE(map0, uv, textureSize, texelSize);","} else {","textureSize.y *= 2.0;","texelSize.y *= 0.5;","float level1 = clamp(floor(mip) - 1.0, 0.0, 4.0);","uv1 = getUVFromMips(level1, uv, texelSize);","color1 = texture2DBilinearFromRGBE(map1, uv1, textureSize, texelSize);","}","float level2 = clamp(floor(mip), 0.0, 5.0);","uv2 = getUVFromMips(level2, uv, texelSize);","color2 = texture2DBilinearFromRGBE(map1, uv2, textureSize, texelSize);","return mix(color1, color2, coef);","#else","return texture2D(map1, uv);","#endif","}","vec4 sampleMipMapRoughnessSheen(vec2 uv, float mip, float coef, sampler2D map1, vec2 textureSize, vec2 texelSize) {","vec4 color1;","vec4 color2;","vec2 uv1;","vec2 uv2;","textureSize.y *= 2.0;","texelSize.y *= 0.5;","float level1 = clamp(floor(mip) - 1.0, 0.0, 4.0);","uv1 = getUVFromMips(level1, uv, texelSize);","color1 = texture2DBilinearFromRGBE(map1, uv1, textureSize, texelSize);","float level2 = clamp(floor(mip), 0.0, 5.0);","uv2 = getUVFromMips(level2, uv, texelSize);","color2 = texture2DBilinearFromRGBE(map1, uv2, textureSize, texelSize);","return mix(color1, color2, coef);","}","#else","const float PI = 3.14159265359;","const float INV_PI = 0.31830988618;","#endif","#ifdef USE_REFLECTION_PROBE","vec3 correctParallax(vec3 worldPos, vec3 reflectVec) {","vec3 rbmax = (reflectionProbeProxyMax - worldPos) / reflectVec;","vec3 rbmin = (reflectionProbeProxyMin - worldPos) / reflectVec;","vec3 rbminmax = max(rbmax, rbmin);","float distance = min(min(rbminmax.x, rbminmax.y), rbminmax.z);","vec3 intersectPos = worldPos + reflectVec * distance;","return normalize(intersectPos - reflectionProbePos);","}","#endif","#ifdef USE_FINITE_ENVMAP","vec3 correctParallaxFinite(vec3 center, vec3 projection, float radius, vec3 rayDir, vec3 rayOrig) {","float t = 0.0;","vec3 dist = rayOrig - center;","float B = 2.0*dot(rayDir, dist);","float C = dot(dist, dist) - radius*radius;","float disc = B*B - 4.0*C;","if (disc < 0.0) {","    t = -1.0;","}","t = (-B + sqrt(disc)) / 2.0;","vec3 hitPos = rayOrig + t*rayDir;","vec3 sn = (hitPos - projection);","return normalize(sn);","}","#endif","#if defined(USE_SSLR)","vec4 RayMarch(vec3 origin, vec3 direction) {","    vec4 outColor = vec4(0.0);","    float radius = 0.5;","    vec3 ptReflect = origin + radius * direction;","    vec2 screenUV = gl_FragCoord.xy * invScreenSize;","    float z = texture2D(prevNormalDepthTexture, screenUV).w;","    vec3 originScreenPos = vec3(screenUV, 2.0 * z - 1.0);","    vec4 offset = projectionMatrix * vec4(ptReflect, 1.0);","    offset.xyz /= offset.w;","    offset.xy = offset.xy * 0.5 + 0.5;","    vec3 endReflectScreenPos = offset.xyz;","    vec3 reflectScreenPos = endReflectScreenPos - originScreenPos;","    reflectScreenPos /= length(endReflectScreenPos.xy - originScreenPos.xy);","    vec2 stepsToBorder = vec2(screenSize * screenUV / abs(reflectScreenPos.xy));","    if (reflectScreenPos.x > 0.0) stepsToBorder.x = screenSize.x * (1.0 - screenUV.x) / abs(reflectScreenPos.x);","    if (reflectScreenPos.y > 0.0) stepsToBorder.y = screenSize.y * (1.0 - screenUV.y) / abs(reflectScreenPos.y);","    float stepsToScreenBorder = min(stepsToBorder.x, stepsToBorder.y);","    reflectScreenPos /= screenSize.x;","    float prevDepth = originScreenPos.z;","    float ray_marching_step = 16.0;","    float j = ray_marching_step;","    for (int i = 0; i < 64; ++i) {","      if (j > stepsToScreenBorder) { break; }","      vec3 sampleScreenPos = originScreenPos + j * reflectScreenPos;","      vec4 normalDepth = texture2D(prevNormalDepthTexture, sampleScreenPos.xy);","      float z = 2.0 * normalDepth.w - 1.0;","      vec3 n;","      n.z = 2.0 * dot(normalDepth.xy, normalDepth.xy) - 1.0;","      n.xy = normalize(normalDepth.xy) * sqrt(1.0 - n.z * n.z);","      float diffZ = sampleScreenPos.z - z;","      if (normalDepth.w > 0.0 && diffZ > 0.0) {","        if (ray_marching_step == 1.0) {","          if (abs(diffZ) < 10.0 * abs(sampleScreenPos.z - prevDepth)) {","            float reflectAttenuation = clamp(-dot(n, direction), 0.0, 1.0) * ((stepsToScreenBorder - j) / stepsToScreenBorder);","            outColor = texture2D(prevColorTexture, sampleScreenPos.xy);","            outColor.w = reflectAttenuation;","          }","          break;","        } else {","          ray_marching_step *= 0.5;","          j -= ray_marching_step;","        }","      } else {","        prevDepth = sampleScreenPos.z;","        j += (0.5 + 0.5 * Random1D(float(renderIteration) + j)) * ray_marching_step;","      }","    }","    return outColor;","}","#endif",].join("\n");j.ShaderChunk.IBL_fragment=["vec3 specularIBLValue = vec3(0.0);","vec3 diffuseIBLValue = vec3(0.0);","#ifdef CLEAR_COAT","vec3 clearCoatIBLValue = vec3(0.0);","#endif","#ifndef USE_ENVMAP_HDR","vec2 envMapHDRSize;","vec2 texelSizeEnvMap;","#endif","vec3 cameraToVertex;","if (projectionMatrix[3][3] > 0.5) {","cameraToVertex = normalize( vec3( vec4( 0.0,0.0,-1.0, 0.0 ) * viewMatrix ) );","} else {","cameraToVertex = normalize( vWorldPosition - cameraPosition );","}",].join("\n");j.ShaderChunk.core_IBL_fragment=["vec3 worldViewNormal = normalize( vec3( vec4( viewNormal, 0.0 ) * viewMatrix ) );","float NdotV = max(dot(normal, viewPosition), 0.0);","vec3 reflectVec = reflect( cameraToVertex, worldNormal );","#if !defined(USE_ITERATION)","vec2 mips = getMips(materialData.roughness);","vec4 cubeColor;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_REFLECTION_PROBE","reflectVec = correctParallax(vWorldPosition, reflectVec);","#endif","#ifdef USE_FINITE_ENVMAP","reflectVec = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, reflectVec, vWorldPosition);","#endif","vec2 reflectionUV = getEnvMapUV(reflectVec);","#ifdef USE_REFLECTION_PROBE","cubeColor = envMapExposure * sampleMipMapRoughness( reflectionUV, mips.x, mips.y, reflectionProbe, reflectionProbeMips, envMapHDRSize, texelSizeEnvMap );","#else","cubeColor = envMapExposure * sampleMipMapRoughness( reflectionUV, mips.x, mips.y, envMap, envMap2, envMapHDRSize, texelSizeEnvMap );","#endif","#endif","#endif","#ifdef USE_NORMALMAP","float hOcclusion = clamp(1.0 + horizonFade * dot(reflectVec, worldViewNormal), 0.0, 1.0);","hOcclusion *= hOcclusion;","#else","float hOcclusion = 1.0;","#endif","#if defined(USE_ITERATION)","#if defined(USE_ANISOTROPY)","SpecularIBLAniso(specularIBLValue,materialData.roughness, tangent, binormal, normal, viewPosition, NdotV, materialData.sr0Color, materialData.sr90Color, envMapHDRSize, texelSizeEnvMap, materialData.anisotropy, materialData.anisotropyAngle);","#else","SpecularIBL(specularIBLValue,materialData.roughness, normal, viewPosition, NdotV, materialData.sr0Color, materialData.sr90Color, envMapHDRSize, texelSizeEnvMap);","#endif","#else","vec4 preCompGGX = texture2D(precomputedTexture1, vec2(NdotV,materialData.roughness));","vec3 GFresnelVoH = materialData.sr0Color* unpackFrom16(preCompGGX.xy) + materialData.sr90Color * unpackFrom16(preCompGGX.zw);","specularIBLValue = cubeColor.xyz * GFresnelVoH;","#endif","specularIBLValue *= hOcclusion;","#ifdef USE_LIGHTMAP","#ifdef LIGHTMAP_IRRADIANCE_MODE","specularIBLValue *= clamp(aoValue, 0.0, 1.0);","#else","specularIBLValue *= aoValue;","#endif","#endif","#if defined( USE_LATLONGMAP )","vec2 normalUV = getEnvMapUV(worldNormal);","vec2 textureSizeEnvMap = vec2(envMapHDRSize.x, 2.0 * envMapHDRSize.y);","vec2 texelSizeEnvMipMap = vec2(texelSizeEnvMap.x, 0.5 * texelSizeEnvMap.y);","vec3 fresnelNoV = FresnelSchlick(materialData.sr0Color,materialData.sr90Color,NdotV);","#if defined(USE_ENVMAP_DIFFUSE) && !defined(USE_REFLECTION_PROBE)","float diffMip = 6.0;","#else","float diffMip = 5.0;","#endif","#ifdef USE_REFLECTION_PROBE","#ifdef USE_ENVMAP_HDR","vec4 texelColor = envMapExposure * texture2DBilinearFromRGBE(reflectionProbeMips, getUVFromMips(diffMip, normalUV, texelSizeEnvMipMap), textureSizeEnvMap, texelSizeEnvMipMap);","#else","vec4 texelColor = envMapExposure * texture2D(reflectionProbeMips, vec2(normalUV.x,normalUV.y));","#endif","#else","#ifdef USE_ENVMAP_HDR","vec4 texelColor = envMapExposure * texture2DBilinearFromRGBE(envMap2, getUVFromMips(diffMip, normalUV, texelSizeEnvMipMap), textureSizeEnvMap, texelSizeEnvMipMap);","#else","vec4 texelColor = envMapExposure * texture2D(envMap2, vec2(normalUV.x,normalUV.y));","#endif","#endif","#if defined(USE_SHEEN) && defined(USE_ENVMAP_SHEEN)","vec4 sheenColor = vec4(0.0);","#ifdef USE_VELVET","float sheenRough = sqrt(materialData.sheen);","#else","float sheenRough = 0.3;","#endif","#ifndef USE_ITERATION","#ifdef USE_VELVET","vec2 mipsF = getMips(1.0-sheenRough);","float GFab = unpackFrom16(texture2D(precomputedTexture2, vec2(NdotV,sheenRough)).zw);","#else","vec2 mipsF = getMips(sheenRough);","float GFab = unpackFrom16(texture2D(precomputedTexture2, vec2(NdotV,sheenRough)).xy);","#endif","sheenColor = sampleMipMapRoughnessSheen( reflectionUV, mipsF.x, mipsF.y, envMapSheen, envMapHDRSize, texelSizeEnvMap );","sheenColor *= GFab;","#else","SheenIBL(sheenColor,sheenRough,normal,viewPosition,NdotV,envMapHDRSize,texelSizeEnvMap);","#endif","texelColor.rgb = mix(texelColor.rgb,sheenColor.rgb,1.0 - pow5(1.0-materialData.sheen));","#endif","texelColor.rgb *= 1.0 - vMax(fresnelNoV);","#ifdef USE_SUBSURFACE","texelColor.rgb *= SssLUTSampling(materialData.curvature);","#endif","#ifdef USE_LIGHTMAP","#ifdef LIGHTMAP_IRRADIANCE_MODE","diffuseIBLValue = aoValue * materialData.diffuseColor;","#else","diffuseIBLValue = aoValue * materialData.diffuseColor  * texelColor.xyz;","#endif","#else","diffuseIBLValue = materialData.diffuseColor * texelColor.xyz  ;","#endif","#endif",].join("\n");j.ShaderChunk.coating_IBL_fragment=["#ifdef CLEAR_COAT","float NdotVcoating = max(dot(materialData.clearCoatNormal, viewPosition), 0.0);","vec3 reflectVeccoating = reflect( cameraToVertex, worldClearCoatNormal );","#if !defined(USE_ITERATION)","vec2 mipsC = getMips(materialData.clearCoatR);","vec4 cubeColorcoating;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_REFLECTION_PROBE","reflectVeccoating = correctParallax(vWorldPosition, reflectVeccoating);","#endif","#ifdef USE_FINITE_ENVMAP","reflectVeccoating = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, reflectVeccoating, vWorldPosition);","#endif","vec2 reflectionUVcoating = getEnvMapUV(reflectVeccoating);","#ifdef USE_REFLECTION_PROBE","cubeColorcoating = envMapExposure * sampleMipMapRoughness( reflectionUVcoating, mipsC.x, mipsC.y, reflectionProbe, reflectionProbeMips, envMapHDRSize, texelSizeEnvMap );","#else","cubeColorcoating = envMapExposure * sampleMipMapRoughness( reflectionUVcoating, mipsC.x, mipsC.y, envMap, envMap2, envMapHDRSize, texelSizeEnvMap );","#endif","#endif","#endif","#ifdef CLEAR_COAT_NORMALMAP","float chOcclusion = clamp(1.0 + 1.3 * dot(reflectVeccoating, worldViewNormal), 0.0, 1.0);","chOcclusion *= chOcclusion;","#else","float chOcclusion = 1.0;","#endif","#if defined(USE_ITERATION)","SpecularIBL(clearCoatIBLValue,materialData.clearCoatR, materialData.clearCoatNormal, viewPosition, max(dot(materialData.clearCoatNormal, viewPosition), 0.0), COATINGF0,COATINGF90, envMapHDRSize, texelSizeEnvMap);","#else","vec4 precompCoat = texture2D(precomputedTexture1, vec2(NdotVcoating,materialData.clearCoatR));","vec3 GFresnelVoHCoat = unpackFrom16(precompCoat.xy) * COATINGF0 + unpackFrom16(precompCoat.zw) * COATINGF90;","clearCoatIBLValue = cubeColorcoating.xyz * GFresnelVoHCoat;","#endif","float energyCoating = 1.0 - materialData.clearCoat* vMax(FresnelSchlick(COATINGF0,COATINGF90,NdotVcoating));","specularIBLValue.xyz *= energyCoating;","diffuseIBLValue.xyz *= energyCoating;","clearCoatIBLValue.xyz *= materialData.clearCoat * chOcclusion;","#endif"].join("\n");j.ShaderChunk.flakes_IBL_fragment=["#ifdef USE_FLAKES","float NdotVMetal = NdotV;","#if !defined(USE_ITERATION)","vec2 mipsMetal = getMips(materialData.flakesRoughness);","vec4 cubeColorMetal;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","vec2 reflectionUVMetal = reflectionUV;","#ifdef USE_REFLECTION_PROBE","cubeColorMetal = envMapExposure * sampleMipMapRoughness( reflectionUVMetal, mipsMetal.x, mipsMetal.y, reflectionProbe, reflectionProbeMips, envMapHDRSize, texelSizeEnvMap );","#else","cubeColorMetal = envMapExposure * sampleMipMapRoughness( reflectionUVMetal, mipsMetal.x, mipsMetal.y, envMap, envMap2, envMapHDRSize, texelSizeEnvMap );","#endif","#endif","#endif","vec3 metalIBLValue = vec3(0.0);","#if defined(USE_ITERATION)","SpecularIBL(metalIBLValue,materialData.flakesRoughness, normal, viewPosition, max(dot(normal, viewPosition), 0.0),ve3(1.0),vec3(1.0), envMapHDRSize, texelSizeEnvMap);","#else","float GMetal = unpackFrom16(texture2D(precomputedTexture3, vec2(NdotVMetal,materialData.flakesRoughness)).xy);","metalIBLValue = cubeColorMetal.xyz  * GMetal;","#endif","if (flakesData.blendDist < 1.0 - 1e-3) {","metalIBLValue *= flakesData.blendDist;","vec3 flakesL = normalize(mix(reflect(-viewPosition,normal), normal, materialData.flakesRoughness));","vec3 flakesH = normalize(flakesL + viewPosition);","float VoH = dot(viewPosition,flakesH);","float NoL = saturate(dot(normal,flakesL));","float NoV = saturate(dot(normal,viewPosition));","metalIBLValue += (1.0 - flakesData.blendDist) * cubeColorMetal.xyz * stochasticFlakesBRDF(viewPosition,flakesL,normal,materialData.flakesRoughness,VoH,NoL,NoV);","}","float energyMetal = 1.0 - materialData.flakesCoverage;","diffuseIBLValue *= energyMetal;","specularIBLValue *= energyMetal;","specularIBLValue += materialData.flakesCoverage * hOcclusion* materialData.flakesColor * metalIBLValue;","#endif"].join("\n");j.ShaderChunk.old_flakes_IBL_fragment=["#ifdef USE_FLAKES","float NdotVMetalFlakes = max(dot(metalFlakes.normal, viewPosition), 0.0);","vec3 reflectVecMetalFlakes = reflect( cameraToVertex, metalFlakes.worldNormal );","float NdotRMetalFlakes = max(dot(metalFlakes.worldNormal, reflectVecMetalFlakes), 0.0);","float NdotVMetal = NdotV;","#if !defined(USE_ITERATION)","vec2 mipsMetalFlakes = getMips(metalFlakes.roughness);","vec2 mipsMetal = getMips(metal.roughness);","vec4 cubeColorMetal;","vec4 cubeColorMetalFlakes;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_REFLECTION_PROBE","reflectVecMetalFlakes = correctParallax(vWorldPosition, reflectVecMetalFlakes);","#endif","#ifdef USE_FINITE_ENVMAP","reflectVecMetalFlakes = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, reflectVecMetalFlakes, vWorldPosition);","#endif","vec2 reflectionUVMetalFlakes = getEnvMapUV(reflectVecMetalFlakes);","vec2 reflectionUVMetal = reflectionUV;","#ifdef USE_REFLECTION_PROBE","cubeColorMetalFlakes = envMapExposure * sampleMipMapRoughness( reflectionUVMetalFlakes, mipsMetalFlakes.x, mipsMetalFlakes.y, reflectionProbe, reflectionProbeMips, envMapHDRSize, texelSizeEnvMap );","cubeColorMetal = envMapExposure * sampleMipMapRoughness( reflectionUVMetal, mipsMetal.x, mipsMetal.y, reflectionProbe, reflectionProbeMips, envMapHDRSize, texelSizeEnvMap );","#else","cubeColorMetalFlakes = envMapExposure * sampleMipMapRoughness( reflectionUVMetalFlakes, mipsMetalFlakes.x, mipsMetalFlakes.y, envMap, envMap2, envMapHDRSize, texelSizeEnvMap );","cubeColorMetal = envMapExposure * sampleMipMapRoughness( reflectionUVMetal, mipsMetal.x, mipsMetal.y, envMap, envMap2, envMapHDRSize, texelSizeEnvMap );","#endif","#endif","#endif","float mFhOcclusion = clamp(1.0 + 1.3 * dot(reflectVecMetalFlakes, worldViewNormal), 0.0, 1.0);","mFhOcclusion *= mFhOcclusion;","vec3 metalFlakesIBLValue = vec3(0.0);","vec3 metalIBLValue = vec3(0.0);","#if defined(USE_ITERATION)","SpecularIBL(metalFlakesIBLValue,metalFlakes.roughness, metalFlakes.normal, viewPosition, max(dot(metalFlakes.normal, viewPosition), 0.0), metalFlakes.F0,vec3(0.0), envMapHDRSize, texelSizeEnvMap);","SpecularIBL(metalIBLValue,metal.roughness, metal.normal, viewPosition, max(dot(metal.normal, viewPosition), 0.0), metal.F0,vec3(0.0), envMapHDRSize, texelSizeEnvMap);","#else","vec4 precompMetalFlakes = texture2D(precomputedTexture1, vec2(NdotVMetalFlakes,metalFlakes.roughness));","vec4 precompMetal = texture2D(precomputedTexture1, vec2(NdotVMetal,metal.roughness));","vec3 GFresnelVoHMetalFlakes = unpackFrom16(precompMetalFlakes.xy) * metalFlakes.F0 ;","metalFlakesIBLValue = cubeColorMetalFlakes.xyz * GFresnelVoHMetalFlakes;","vec3 GFresnelVoHMetal = unpackFrom16(precompMetal.xy) * metal.F0 ;","metalIBLValue = cubeColorMetal.xyz * GFresnelVoHMetal;","#endif","specularIBLValue += mFhOcclusion*metalFlakesIBLValue;","float energyMetal = 1.0 - vMax(FresnelSchlick(metal.F0,vec3(0.0),NdotVMetal));","diffuseIBLValue *= energyMetal;","specularIBLValue *= energyMetal;","specularIBLValue += hOcclusion*metalIBLValue;","#endif"].join("\n");j.ShaderChunk.old_pearlflakes_IBL_fragment=["#if defined(USE_FLAKES) && defined(PEARL_FLAKES_ACTIVATED)","float NdotVPearlFlakes = max(dot(pearlFlakes.normal, viewPosition), 0.0);","vec3 reflectVecPearlFlakes = reflect( cameraToVertex, pearlFlakes.worldNormal );","#if !defined(USE_ITERATION)","vec2 mipsPearl = getMips(pearlFlakes.roughness);","vec4 cubeColorPearlFlakes;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_REFLECTION_PROBE","reflectVecPearlFlakes = correctParallax(vWorldPosition, reflectVecPearlFlakes);","#endif","#ifdef USE_FINITE_ENVMAP","reflectVecPearlFlakes = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, reflectVecPearlFlakes, vWorldPosition);","#endif","vec2 reflectionUVPearlFlakes = getEnvMapUV(reflectVecPearlFlakes);","#ifdef USE_REFLECTION_PROBE","cubeColorPearlFlakes = envMapExposure * sampleMipMapRoughness( reflectionUVPearlFlakes, mipsPearl.x, mipsPearl.y, reflectionProbe, reflectionProbeMips, envMapHDRSize, texelSizeEnvMap );","#else","cubeColorPearlFlakes = envMapExposure * sampleMipMapRoughness( reflectionUVPearlFlakes, mipsPearl.x, mipsPearl.y, envMap, envMap2, envMapHDRSize, texelSizeEnvMap );","#endif","#endif","#endif","float pFhOcclusion = clamp(1.0 + 1.3 * dot(reflectVecPearlFlakes, worldViewNormal), 0.0, 1.0);","pFhOcclusion *= pFhOcclusion;","vec3 pearlFlakesIBLValue = vec3(0.0);","#if defined(USE_ITERATION)","SpecularIBL(pearlFlakesIBLValue,pearlFlakes.roughness, pearlFlakes.normal, viewPosition, max(dot(pearlFlakes.normal, viewPosition), 0.0), pearlFlakes.F0,vec3(0.0), envMapHDRSize, texelSizeEnvMap);","#else","vec4 precompPearlFlakes = texture2D(precomputedTexture1, vec2(NdotVPearlFlakes,pearlFlakes.roughness));","vec3 GFresnelVoHPearlFlakes = unpackFrom16(precompPearlFlakes.xy) * pearlFlakes.F0 ;","pearlFlakesIBLValue = cubeColorPearlFlakes.xyz * GFresnelVoHPearlFlakes;","#endif","float energyPearlFlakes = 1.0 - vMax(FresnelSchlick(pearlFlakes.F0,vec3(0.0),NdotVPearlFlakes));","diffuseIBLValue *= energyPearlFlakes;","specularIBLValue *= energyPearlFlakes;","specularIBLValue += pFhOcclusion*pearlFlakesIBLValue;","#endif"].join("\n");j.ShaderChunk.total_IBL_fragment=["#ifndef SPECGLOSS","specularIBLValue /= transToDivide;","#endif","gl_FragColor.xyz += specularIBLValue + diffuseIBLValue;","#ifdef CLEAR_COAT","#ifndef SPECGLOSS","clearCoatIBLValue /= transToDivide;","#endif","gl_FragColor.xyz += clearCoatIBLValue;","#endif",].join("\n");j.ShaderChunk.transparency_lights_physicalDS_fragment=["#ifdef PDSFX","float trans = _DStransparency;","#else","float trans = transparency;","#endif","#ifdef USE_TRANSPARENCYMAP","#ifdef NRE_COMPATIBILITY","vec2 transparencyUV=(transparencyUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 transparencyUV=uvToUse;","#endif","trans = texture2D(transparencyMap, transparencyUV).r;","#endif","#ifdef USE_TRANSPARENCY_COEFFICIENTS","trans = transparencyMulCoef * trans + transparencyAddCoef;","#endif","#ifdef PDSFX","_DStransparency_ = trans;","trans = ComputeTransparency();","#endif","trans *= (1.0 - metalnessValue);","#ifdef SPECGLOSS","vec3 Ft = FresnelSchlick(specularColor, vec3(1.0), NoV);","#else","vec3 Ft = FresnelSchlick(materialData.sr0Color, materialData.sr90Color, NoV);","#endif","float transToDivide = max(1.0 - trans * (1.0 - 0.3333*(Ft.x + Ft.y + Ft.z)), 1e-6);","gl_FragColor.a = transToDivide;",].join("\n");j.ShaderChunk.cutout_lights_physicalDS_fragment=["#ifdef PDSFX","float opacityValue = _DSopacity;","#else","float opacityValue = opacity;","#endif","#ifdef USE_OPACITYMAP","#ifdef NRE_COMPATIBILITY","vec2 opacityUV=(opacityUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 opacityUV=uvToUse;","#endif","opacityValue = texture2D(opacityMap, opacityUV).r;","#endif","#ifdef USE_OPACITY_COEFFICIENTS","opacityValue = opacityMulCoef * opacityValue + opacityAddCoef;","#endif","#ifdef PDSFX","_DSopacity_ = opacityValue;","opacityValue = ComputeOpacity();","#endif","gl_FragColor.a *= opacityValue;","#if defined(USE_MAP) && defined(USE_ALPHA_FROM_MAP) && defined(NRE_COMPATIBILITY)","gl_FragColor.a *= transparencyFromDiffuseMap;","#endif",].join("\n");j.ShaderChunk.normal_lights_physicalDS_fragment=["vec3 normal = viewNormal;","#ifdef USE_NORMALMAP","#ifdef NRE_COMPATIBILITY","#if (NORMALMAP_UV_SLOT == 2)","vec2 normalUv =(normalUvTransform * vec3(uv2ToUse, 1.0)).xy;","#else","vec2 normalUv =(normalUvTransform * vec3(uvToUse, 1.0)).xy;","#endif","#else","vec2 normalUv = uvToUse;","#endif","normal = perturbNormal3Arb( viewNormal, tangent, binormal, normalUv );","#elif defined( USE_BUMPMAP )","normal = perturbNormalArb( -vViewPosition, viewNormal, dHdxy_fwd() );","#endif","vec3 worldNormal = normalize( vec3( vec4( normal, 0.0 ) * viewMatrix ) );","#ifdef USE_SUBSURFACE","vec3 worldNoMapNormal = normalize( vec3( vec4( viewNormal, 0.0 ) * viewMatrix ) );","#endif",].join("\n");j.ShaderChunk.cc_lights_physicalDS_fragment=["#ifdef CLEAR_COAT","#ifdef CLEAR_COAT_MAP","#ifdef NRE_COMPATIBILITY","vec2 ccUV=(clearCoatUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 ccUV=uvToUse;","#endif","materialData.clearCoat = texture2D( clearCoatMap, ccUV ).r;","#else","materialData.clearCoat = clearCoat;","#endif","#ifdef USE_CC_COEFFICIENTS","materialData.clearCoat = clearCoatMulCoef * materialData.clearCoat + clearCoatAddCoef;","#endif","#ifdef CLEAR_COAT_NORMALMAP","#ifdef NRE_COMPATIBILITY","#if (NORMALMAP_UV_SLOT == 2)","vec2 ccnormalUv =(clearCoatNormalUvTransform * vec3(uv2ToUse, 1.0)).xy;","#else","vec2 ccnormalUv =(clearCoatNormalUvTransform * vec3(uvToUse, 1.0)).xy;","#endif","#else","vec2 ccnormalUv = uvToUse;","#endif","materialData.clearCoatNormal = perturbNormal3ArbCoat( viewNormal, tangent, binormal, ccnormalUv );","#else","materialData.clearCoatNormal = viewNormal;","#endif","vec3 worldClearCoatNormal = normalize( vec3( vec4( materialData.clearCoatNormal, 0.0 ) * viewMatrix ) );","#ifdef USE_ORANGE_PEEL","doOrangePeel(worldClearCoatNormal);","materialData.clearCoatNormal = normalize( (viewMatrix * vec4( worldClearCoatNormal, 0.0)).xyz);","#endif","#ifdef USE_CC_ROUGHNESSMAP","#ifdef NRE_COMPATIBILITY","vec2 ccroughnessUV=(clearCoatRoughnessUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 ccroughnessUV=uvToUse;","#endif","materialData.clearCoatR = texture2D( clearCoatRoughnessMap, ccroughnessUV ).r;","#if !defined( USE_CC_ROUGHNESSMAP_LINEAR )","materialData.clearCoatR *= materialData.clearCoatR;","#endif","materialData.clearCoatR = max(materialData.clearCoatR, 0.0025);","#else","materialData.clearCoatR =  max(clearCoatRoughness, 0.0025);","#endif","#ifdef USE_CC_ROUGHNESS_COEFFICIENTS","materialData.clearCoatR = clearCoatRoughnessMulCoef * materialData.clearCoatR + clearCoatRoughnessAddCoef;","#endif","#ifdef USE_CC_GLOSSINESSMAP","#ifdef NRE_COMPATIBILITY","vec2 ccglossinessUV=(clearCoatRoughnessUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 ccglossinessUV=uvToUse;","#endif","float ccGlossiness = texture2D( coatingGlossinessMap, ccglossinessUV ).r;","#if !defined( USE_CC_ROUGHNESSMAP_LINEAR )","ccGlossiness *= ccGlossiness;","#endif","#ifdef USE_CC_GLOSSINESS_COEFFICIENTS","ccGlossiness = coatingGlossinessMulCoef * ccGlossiness + coatingGlossinessAddCoef;","#endif","materialData.clearCoatR = max(1.0 - ccGlossiness, 0.0025);","#endif","#endif",].join("\n");j.ShaderChunk.flakes_lights_physicalDS_fragment=["#ifdef USE_FLAKES","#ifdef OLD_FLAKES","doFlakes(worldNormal);","metalFlakes.normal = normalize((viewMatrix* (vec4(metalFlakes.worldNormal, 0.0))).xyz);","metal.normal = normal;","#ifdef PEARL_FLAKES_ACTIVATED","pearlFlakes.normal = normalize((viewMatrix * (vec4(pearlFlakes.worldNormal, 0.0))).xyz);","#endif","#else","#ifdef USE_FLAKESCOVERAGE_MAP","#ifdef NRE_COMPATIBILITY","vec2 fdUV=(flakesCoverageUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 fdUV=uvToUse;","#endif","materialData.flakesCoverage = texture2D( flakesCoverageMap, fdUV ).r;","#else","materialData.flakesCoverage = flakesCoverage;","#endif","#ifdef USE_FLAKESCOVERAGE_COEFFICIENTS","materialData.flakesCoverage = flakesCoverageMulCoef * materialData.flakesCoverage + flakesCoverageAddCoef;","#endif","#ifdef USE_FLAKESCOLOR_MAP","#ifdef NRE_COMPATIBILITY","vec2 fcUv =(flakesColorUvTransform * vec3(uvToUse, 1.0)).xy;","#else","vec2 fcUv = uvToUse;","#endif","materialData.flakesColor = texture2D( flakesColorMap, fdUV ).xyz;","#if !defined( USE_FLAKESCOLOR_LINEAR )","#ifdef NRE_COMPATIBILITY","materialData.flakesColor.x = (materialData.flakesColor.x < 0.04045)    ? (materialData.flakesColor.x/12.92) : pow((materialData.flakesColor.x + 0.055)/1.055, 2.4);","materialData.flakesColor.y = (materialData.flakesColor.y < 0.04045)    ? (materialData.flakesColor.y/12.92) : pow((materialData.flakesColor.y + 0.055)/1.055, 2.4);","materialData.flakesColor.z = (materialData.flakesColor.z < 0.04045)    ? (materialData.flakesColor.z/12.92) : pow((materialData.flakesColor.z + 0.055)/1.055, 2.4);","#else","materialData.flakesColor.rgb *= materialData.flakesColor.rgb;","#endif","#endif","#else","materialData.flakesColor = flakesColor;","#endif","#ifdef USE_FLAKESCOLOR_COEFFICIENTS","materialData.flakesColor = flakesColorMulCoef * materialData.flakesColor + flakesColorAddCoef;","#endif","#ifdef USE_FLAKESROUGHNESS_MAP","#ifdef NRE_COMPATIBILITY","vec2 frUV=(flakesRoughnessUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 frUV=uvToUse;","#endif","materialData.flakesRoughness = texture2D( flakesRoughnessMap, frUV ).r;","#if !defined( USE_FLAKESROUGHNESS_MAP_LINEAR )","materialData.flakesRoughness *= materialData.flakesRoughness;","#endif","materialData.flakesRoughness = min(0.975,max(materialData.flakesRoughness, 0.0025));","#else","materialData.flakesRoughness = min(0.975,max(flakesRoughness, 0.0025));","#endif","#ifdef USE_FLAKESROUGHNESS_COEFFICIENTS","materialData.flakesRoughness = flakesRoughnessMulCoef * materialData.flakesRoughness + flakesRoughnessAddCoef;","#endif","#ifdef USE_FLAKESSIZE_MAP","#ifdef NRE_COMPATIBILITY","vec2 fsUV=(flakesSizeUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 fsUV=uvToUse;","#endif","materialData.flakesSize = texture2D( flakesSizeMap, fsUV ).r;","#else","materialData.flakesSize = flakesSize;","#endif","#ifdef USE_FLAKESSIZE_COEFFICIENTS","materialData.flakesSize = flakesSizeMulCoef * materialData.flakesSize + flakesSizeAddCoef;","#endif","initFlakesData(vObjectSpacePosition, normalize(vObjectNormal),materialData.flakesSize, materialData.flakesCoverage);","#endif","#endif"].join("\n");j.ShaderChunk.sheen_lights_physicalDS_fragment=["#ifdef USE_SHEEN","#ifdef USE_SHEEN_MAP","#ifdef NRE_COMPATIBILITY","vec2 sheenUV=(sheenUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 sheenUV=uvToUse;","#endif","materialData.sheen = texture2D( sheenMap, sheenUV ).r;","#else","materialData.sheen =  sheen;","#endif","#ifdef USE_SHEEN_COEFFICIENTS","materialData.sheen = sheenMulCoef * materialData.sheen + sheenAddCoef;","#endif","#endif",].join("\n");j.ShaderChunk.specular_lights_physicalDS_fragment=["#ifdef PDSFX","vec3 specularColor = _DSspecular;","#else","vec3 specularColor = specular;","#endif","#ifdef USE_SPECULARMAP","#if !defined( USE_SPECULARMAP_LINEAR )","#ifdef NRE_COMPATIBILITY","texelSpecular.x = (texelSpecular.x < 0.04045)    ? (texelSpecular.x/12.92) : pow((texelSpecular.x + 0.055)/1.055, 2.4);","texelSpecular.y = (texelSpecular.y < 0.04045)    ? (texelSpecular.y/12.92) : pow((texelSpecular.y + 0.055)/1.055, 2.4);","texelSpecular.z = (texelSpecular.z < 0.04045)    ? (texelSpecular.z/12.92) : pow((texelSpecular.z + 0.055)/1.055, 2.4);","#else","texelSpecular.rgb *= texelSpecular.rgb;","#endif","#endif","specularColor = texelSpecular.rgb;","#endif","#ifdef USE_SPECULAR_COEFFICIENTS","specularColor.xyz = specularMulCoef*specularColor.xyz + specularAddCoef;","#endif","#ifdef PDSFX","_DSspecular_ = specularColor;","specularColor = ComputeSpecularReflectance();","#endif",].join("\n");j.ShaderChunk.roughness_lights_physicalDS_fragment=["#ifdef USE_ROUGHNESSMAP","#ifdef NRE_COMPATIBILITY","#if (ROUGHNESSMAP_UV_SLOT == 2)","vec2 roughnessUV = (roughnessUvTransform * vec3(uv2ToUse, 1.0)).xy;","#else","vec2 roughnessUV=(roughnessUvTransform * vec3( uvToUse, 1.0)).xy ;","#endif","#else","vec2 roughnessUV=uvToUse;","#endif","materialData.roughness = texture2D( roughnessMap, roughnessUV ).r;","#if !defined( USE_ROUGHNESSMAP_LINEAR )","materialData.roughness *= materialData.roughness;","#endif","materialData.roughness = min(max(materialData.roughness, 0.025),0.975);","#else","materialData.roughness = min(max(roughness, 0.025),0.975);","#endif","#ifdef USE_ROUGHNESS_COEFFICIENTS","materialData.roughness = roughnessMulCoef * materialData.roughness + roughnessAddCoef;","#endif","#ifdef USE_GLOSSINESSMAP","#ifdef NRE_COMPATIBILITY","#if (ROUGHNESSMAP_UV_SLOT == 2)","vec2 glossinessUV = (roughnessUvTransform * vec3(uv2ToUse, 1.0)).xy;","#else","vec2 glossinessUV=(roughnessUvTransform * vec3( uvToUse, 1.0)).xy ;","#endif","#else","vec2 glossinessUV=uvToUse;","#endif","float glossinessTex = texture2D( glossinessMap, glossinessUV ).r;","#if !defined( USE_ROUGHNESSMAP_LINEAR )","glossinessTex *= glossinessTex;","#endif","#ifdef USE_GLOSSINESS_COEFFICIENTS","glossinessTex = glossinessMulCoef * glossinessTex + glossinessAddCoef;","#endif","materialData.roughness = min(max(1.0-glossinessTex, 0.025),0.975);","#endif","#ifdef PDSFX","_DSroughness_ = materialData.roughness;","materialData.roughness = ComputeRoughness();","#endif",].join("\n");j.ShaderChunk.emission_lights_physicalDS_fragment=["#ifdef USE_EMISSIONCOLORMAP","#ifdef NRE_COMPATIBILITY","vec2 emissionUV=(emissionColorUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 emissionUV=uvToUse;","#endif","vec3 emissionTex = texture2D( emissionColorMap, emissionUV ).rgb;","#if !defined( USE_EMISSIONCOLORMAP_LINEAR )","#ifdef NRE_COMPATIBILITY","emissionTex.x = (emissionTex.x < 0.04045)    ? (emissionTex.x/12.92) : pow((emissionTex.x + 0.055)/1.055, 2.4);","emissionTex.y = (emissionTex.y < 0.04045)    ? (emissionTex.y/12.92) : pow((emissionTex.y + 0.055)/1.055, 2.4);","emissionTex.z = (emissionTex.z < 0.04045)    ? (emissionTex.z/12.92) : pow((emissionTex.z + 0.055)/1.055, 2.4);","#else","emissionTex *= emissionTex;","#endif","#endif","vec3 emissionColorValue = emissionTex;","#else","vec3 emissionColorValue = emissionColor;","#endif","#ifdef USE_EMISSIONCOLOR_COEFFICIENTS","emissionColorValue = emissionColorMulCoef * emissionColorValue + emissionColorAddCoef;","#endif",].join("\n");j.ShaderChunk.metalness_lights_physicalDS_fragment=["#ifdef USE_METALNESSMAP","#ifdef NRE_COMPATIBILITY","vec2 metalnessUV=(metalnessUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 metalnessUV=uvToUse;","#endif","float metalnessValue = texture2D( metalnessMap, metalnessUV ).r;","#if !defined( USE_METALNESSMAP_LINEAR )","metalnessValue *= metalnessValue;","#endif","#else","float metalnessValue = metalness;","#endif","#ifdef USE_METALNESS_COEFFICIENTS","metalnessValue = metalnessMulCoef * metalnessValue + metalnessAddCoef;","#endif",].join("\n");j.ShaderChunk.specularcontrib_lights_physicalDS_fragment=["#ifdef USE_SPECULARCONTRIBMAP","#ifdef NRE_COMPATIBILITY","vec2 specCUV=(specularContribUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 specCUV=uvToUse;","#endif","float specContrib = texture2D( specularContribMap, specCUV ).r;","#else","float specContrib = specularContrib;","#endif","#ifdef USE_SPECULARCONTRIB_COEFFICIENTS","specContrib = specularContribMulCoef * specContrib + specularContribAddCoef;","#endif",].join("\n");j.ShaderChunk.anisotropy_lights_physicalDS_fragment=["#if defined( USE_ANISOTROPY )","#ifdef USE_ANISOTROPYMAP","#ifdef NRE_COMPATIBILITY","vec2 anisotropyUV=(anisotropyUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 anisotropyUV=uvToUse;","#endif","materialData.anisotropy = texture2D(anisotropyMap, anisotropyUV).r;","#else","materialData.anisotropy = anisotropy;","#endif","#ifdef USE_ANISOTROPY_COEFFICIENTS","materialData.anisotropy = anisotropyMulCoef * materialData.anisotropy + anisotropyAddCoef;","#endif","materialData.anisotropy = min(materialData.anisotropy, 0.975);","#ifdef USE_ANISOTROPYANGLEMAP","#ifdef NRE_COMPATIBILITY","vec2 anisotropyAngleUV=(anisotropyAngleUvTransform * vec3( uvToUse, 1.0)).xy ;","#else","vec2 anisotropyAngleUV=uvToUse;","#endif","materialData.anisotropyAngle = texture2D(anisotropyAngleMap, anisotropyAngleUV).r;","#else","materialData.anisotropyAngle = anisotropyAngle;","#endif","#ifdef USE_ANISOTROPYANGLE_COEFFICIENTS","materialData.anisotropyAngle = anisotropyAngleMulCoef * materialData.anisotropyAngle + anisotropyAngleAddCoef;","#endif","materialData.binormal = binormal;","materialData.tangent = tangent;","#endif",].join("\n");j.ShaderChunk.albedo_lights_physicalDS_fragment=["#ifdef PDSFX","vec3 albedo = _DSalbedo;","#else","vec3 albedo = diffuse;","#endif","#ifdef USE_MAP","#ifdef NRE_COMPATIBILITY","#if (DIFFUSEMAP_UV_SLOT == 2)","vec2 diffuseUV = (diffuseUvTransform * vec3(uv2ToUse, 1.0)).xy ;","#else","vec2 diffuseUV = (diffuseUvTransform * vec3(uvToUse, 1.0)).xy ;","#endif","#ifdef USE_ALPHA_FROM_MAP","float transparencyFromDiffuseMap = texture2D(map, diffuseUV).w;","#endif","#else","vec2 diffuseUV = uvToUse;","#endif","vec3 texelAlbedo = texture2D(map, diffuseUV).xyz;","#ifdef GAMMA_INPUT","#ifdef NRE_COMPATIBILITY","texelAlbedo.x = (texelAlbedo.x < 0.04045) ? (texelAlbedo.x/12.92) : pow((texelAlbedo.x + 0.055)/1.055, 2.4);","texelAlbedo.y = (texelAlbedo.y < 0.04045) ? (texelAlbedo.y/12.92) : pow((texelAlbedo.y + 0.055)/1.055, 2.4);","texelAlbedo.z = (texelAlbedo.z < 0.04045) ? (texelAlbedo.z/12.92) : pow((texelAlbedo.z + 0.055)/1.055, 2.4);","#else","texelAlbedo.rgb *= texelAlbedo.rgb;","#endif","#endif","albedo = texelAlbedo;","#endif","#ifdef USE_DIFFUSE_COEFFICIENTS","albedo = albedo * diffuseMulCoef + diffuseAddCoef;","#endif","#ifdef PDSFX","_DSalbedo_ = albedo;","albedo = ComputeAlbedo();","#endif",].join("\n");j.ShaderChunk.total_lights_physicalDS_fragment=["vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#if MAX_IES_LIGHTS > 0","totalDiffuse += iesDiffuse;","totalSpecular += iesSpecular;","#endif","#if MAX_SPHERE_LIGHTS > 0","totalDiffuse += sphereDiffuse;","totalSpecular += sphereSpecular;","#endif","#if MAX_DISK_LIGHTS > 0","totalDiffuse += diskDiffuse;","totalSpecular += diskSpecular;","#endif","#if MAX_TUBE_LIGHTS > 0","totalDiffuse += tubeDiffuse;","totalSpecular += tubeSpecular;","#endif","#if MAX_AREA_LIGHTS > 0","totalDiffuse += areaDiffuse;","totalSpecular += areaSpecular;","#endif","#if defined(USE_LIGHTMAP) && defined(LIGHTMAP_IRRADIANCE_MODE)","totalDiffuse = vec3(0.0);","totalSpecular *= clamp(aoValue, 0.0, 1.0);","#endif","#ifndef SPECGLOSS","totalSpecular /= transToDivide;","#endif",].join("\n");j.ShaderChunk.area_lights_physicalDS_fragment=["#if MAX_AREA_LIGHTS > 0","vec3 areaDiffuse  = vec3(0.0);","vec3 areaSpecular = vec3(0.0);","for (int i = 0; i < MAX_AREA_LIGHTS; i++) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lPosition = viewMatrix *vec4( areaLightPosition[ i ], 1.0 );","vec4 lNormal = viewMatrix *vec4( areaLightNormal[ i ], 0.0 );","float hw = 0.5*areaLightData[i].x;","float hh = 0.5*areaLightData[i].y;","vec3 up = (viewMatrix * vec4( areaLightUp[i],0.0)).xyz;","vec3 right = (viewMatrix * vec4( areaLightRight[i],0.0)).xyz;","vec3 p0 = lPosition.xyz + right * hw - up * hh;","vec3 p1 = lPosition.xyz - right * hw - up * hh;","vec3 p2 = lPosition.xyz - right * hw + up * hh;","vec3 p3 = lPosition.xyz + right * hw + up * hh;","areaRectangleLightModel(specular, diffuse, normal,viewPosition, -vViewPosition, p0,p1,p2,p3);","areaDiffuse += areaLightColor[i] * diffuse;","areaSpecular += areaLightColor[i] * specular;","}","#endif"].join("\n");j.ShaderChunk.sphere_lights_physicalDS_fragment=["#if MAX_SPHERE_LIGHTS > 0","vec3 sphereDiffuse  = vec3( 0.0 );","vec3 sphereSpecular = vec3( 0.0 );","for (int i = 0; i < MAX_SPHERE_LIGHTS; i++) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lPosition = viewMatrix * vec4( sphereLightPosition[ i ], 1.0 );","vec3 lNormal = -viewReflect.xyz;","float r = sphereLightData[i].x;","areaSphereLightModel(specular, diffuse, normal,viewPosition, -vViewPosition,lPosition.xyz, lNormal, r);","sphereDiffuse += sphereLightColor[i]*diffuse;","sphereSpecular += sphereLightColor[i]*specular;","}","#endif"].join("\n");j.ShaderChunk.disk_lights_physicalDS_fragment=["#if MAX_DISK_LIGHTS > 0","vec3 diskDiffuse  = vec3( 0.0 );","vec3 diskSpecular = vec3( 0.0 );","for (int i = 0; i < MAX_DISK_LIGHTS; i++) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lPosition = viewMatrix * vec4( diskLightPosition[ i ], 1.0 );","vec4 lNormal = viewMatrix * vec4( diskLightNormal[ i ], 0.0 );","float r = diskLightData[i].x;","vec3 right = getGeomT(lNormal.xyz);","vec3 up = getGeomB(lNormal.xyz, right);","vec3 p0 = lPosition.xyz + right * r - up * r;","vec3 p1 = lPosition.xyz - right * r - up * r;","vec3 p2 = lPosition.xyz - right * r + up * r;","areaDiskLightModel(specular, diffuse, normal,viewPosition, -vViewPosition, p0,p1,p2);","diskDiffuse += diskLightColor[i]*diffuse;","diskSpecular += diskLightColor[i]*specular;","}","#endif"].join("\n");j.ShaderChunk.tube_lights_physicalDS_fragment=["#if MAX_TUBE_LIGHTS > 0","vec3 tubeDiffuse  = vec3( 0.0 );","vec3 tubeSpecular = vec3( 0.0 );","for (int i = 0; i < MAX_TUBE_LIGHTS; i++) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lPosition = viewMatrix * vec4( tubeLightPosition[ i ], 1.0 );","float lRadius = tubeLightData[i].x;","float lWidth = tubeLightData[i].y;","vec3 lRight = (viewMatrix * vec4( tubeLightRight[i],0.0)).xyz;","vec3 P0 = lPosition.xyz - lRight * lWidth * 0.5;","vec3 P1 = lPosition.xyz + lRight * lWidth * 0.5;","vec3 E = tubeLightColor[i] * illuminanceTube(P0,P1,lPosition.xyz,-vViewPosition,normal,lRight,0.5*lWidth,lRadius);","vec3 closestPoint = closestPointTube(P0,P1,normal,viewReflect,-vViewPosition.xyz, lPosition.xyz,lRadius);","doAreaLightingModel(E, diffuse, specular, normal, viewPosition, closestPoint);","tubeDiffuse += diffuse;","tubeSpecular += specular;","}","#endif"].join("\n");j.ShaderChunk.hemi_lights_physicalDS_fragment=["#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += materialData.diffuseColor * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularStrength * max( pow( hemiDotNormalHalfSky, materialData.roughness ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularStrength * max( pow( hemiDotNormalHalfGround, materialData.roughness ), 0.0 );","hemiSpecular += specular * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","}","#endif"].join("\n");j.ShaderChunk.dir_lights_physicalDS_fragment=["#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","#ifdef TRANSLUCENCY","vec3 dirTranslucency = vec3(0.0);","initDisk();","#endif","{","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ 0 ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_CASCADE","shadowExposure = getExposureCascaded(vShadowCoord,shadowMap,shadowBias,shadowMapSize);","#else","if(0<MAX_SHADOWS_DIR){","shadowExposure = getExposure(vShadowCoord[ 0 ],shadowMap[ 0 ],shadowBias[ 0 ],shadowMapSize[ 0 ]);","}","#endif","#endif","vec3 E = directionalLightColor[ 0 ] * shadowExposure;","doLightingModel(E, diffuse, specular, normal, viewPosition, lVector);","#ifdef TRANSLUCENCY","if (0 < MAX_SHADOWS) {","dirTranslucency += E * translucencyBRDF( normal, lVector, 0, viewPosition, materialData.diffuseColor, materialData.sr0Color, materialData.sr90Color);","}","#endif","dirDiffuse += diffuse ;","dirSpecular += specular;","}","if(MAX_DIR_LIGHTS>1){","for( int i = 1; i < MAX_DIR_LIGHTS; i ++ ) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_CASCADE","#else","if(i<MAX_SHADOWS_DIR){","shadowExposure = getExposure(vShadowCoord[ i ],shadowMap[ i ],shadowBias[ i ],shadowMapSize[ i ]);","}","#endif","#endif","vec3 E = directionalLightColor[ i ] * shadowExposure;","doLightingModel(E, diffuse, specular, normal, viewPosition, lVector);","#ifdef TRANSLUCENCY","if (i < MAX_SHADOWS) {","dirTranslucency += E * translucencyBRDF( normal, lVector, i, viewPosition, materialData.diffuseColor, materialData.sr0Color, materialData.sr90Color);","}","#endif","dirDiffuse += diffuse ;","dirSpecular += specular;","}","}","#endif"].join("\n");j.ShaderChunk.point_lights_physicalDS_fragment=["#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse  = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lAttenuation = 1.0;","if (pointLightPhysicalAttenuation[ i ]> 0){","lAttenuation = 1.0 / (dot(lVector,lVector) * pointLightDistance[ i ]);","}else {","if ( pointLightDistance[ i ] > 0.0 )","lAttenuation = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","}","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vPointLight[ i ].xyz );","float lAttenuation = vPointLight[ i ].w;","#endif","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP_CUBE","if (i<MAX_SHADOWS_CUBE){","shadowExposure = getExposure(shadowPointPosition[ i ],shadowMapCube[ i ],shadowBiasCube[ i ],shadowMapSizeCube[ i ],shadowNearCube[ i ],shadowFarCube[ i ]);","}","#endif","vec3 E = pointLightColor[ i ]  * lAttenuation * shadowExposure;","doLightingModel(E, diffuse, specular, normal, viewPosition, lVector);","pointDiffuse += diffuse;","pointSpecular += specular;","}","#endif"].join("\n");j.ShaderChunk.spot_lights_physicalDS_fragment=["#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse  = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lAttenuation = 1.0;","if (spotLightPhysicalAttenuation[ i ]> 0){","lAttenuation =1.0 / (dot(lVector,lVector) * spotLightDistance[ i ]);","}else {","if ( spotLightDistance[ i ] > 0.0 )","lAttenuation = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","}","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vSpotLight[ i ].xyz );","float lAttenuation = vSpotLight[ i ].w;","#endif","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","float shadowExposure = 1.0;","#ifdef USE_SHADOWMAP","if((i + MAX_SHADOWS_DIR)<MAX_SHADOWS){","shadowExposure = getExposure(vShadowCoord[ i + MAX_SHADOWS_DIR ],shadowMap[ i + MAX_SHADOWS_DIR ],shadowBias[ i + MAX_SHADOWS_DIR ],shadowMapSize[ i + MAX_SHADOWS_DIR ]);","}","#endif","spotEffect = 1.0 - smoothstep( spotLightInnerAngleCos[ i ],spotLightAngleCos[ i ],spotEffect );","vec3 E = spotLightColor[ i ] * lAttenuation * spotEffect * shadowExposure;","doLightingModel(E, diffuse, specular, normal, viewPosition, lVector);","spotDiffuse += diffuse;","spotSpecular += specular;","}","}","#endif"].join("\n");j.ShaderChunk.ies_lights_physicalDS_fragment=["#if MAX_IES_LIGHTS > 0","vec3 iesDiffuse  = vec3( 0.0 );","vec3 iesSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_IES_LIGHTS; i ++ ) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( iesLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( iesLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / iesLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( viesLight[ i ].xyz );","float lDistance = viesLight[ i ].w;","#endif","vec3 E = iesLightColor[ i ] * lDistance * 3.14159;","vec4 coordInIESWorld = normalize(matrixWorldInv[i] * vec4(vWorldPosition,1.0));","float stepTexture = 1.0/128.0*72.0;","const float PI = 3.14159265359;","const float invTwoPi = 1.0/PI;","float phi = acos(-coordInIESWorld.z)/3.14159;","float theta = myAtan2(coordInIESWorld.x,-coordInIESWorld.y)*invTwoPi;","if(theta<0.0) theta *= -1.0;","E *= texture2D(iesLightTexture[i],vec2(phi,theta)).x;","doLightingModel(E, diffuse, specular, normal, viewPosition, lVector);","iesDiffuse  += diffuse;","iesSpecular += specular;","}","#endif"].join("\n");j.ShaderChunk.lights_physicalDS_fragment=["vec3 viewPosition;","if (projectionMatrix[3][3] > 0.5) {","viewPosition = vec3(0.0,0.0,1.0);","} else {","viewPosition = normalize( vViewPosition );","}","#ifdef PDSFX","vec3 viewNormal = _DSvNormal;","#else","vec3 viewNormal = normalize( vNormal );","#endif","#ifdef DOUBLE_SIDED","viewNormal = viewNormal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif",j.ShaderChunk.normal_lights_physicalDS_fragment,"#ifdef USE_SUBSURFACE","materialData.curvature = length(fwidth(worldNoMapNormal)) / length(fwidth(vObjectSpacePosition));","#endif",j.ShaderChunk.cc_lights_physicalDS_fragment,j.ShaderChunk.flakes_lights_physicalDS_fragment,j.ShaderChunk.specular_lights_physicalDS_fragment,j.ShaderChunk.albedo_lights_physicalDS_fragment,j.ShaderChunk.roughness_lights_physicalDS_fragment,j.ShaderChunk.emission_lights_physicalDS_fragment,j.ShaderChunk.metalness_lights_physicalDS_fragment,j.ShaderChunk.sheen_lights_physicalDS_fragment,j.ShaderChunk.specularcontrib_lights_physicalDS_fragment,"#ifdef USE_LIGHTMAP","#if (LIGHTMAP_UV_SLOT == 2)","vec3 aoValue = texture2D(lightMap, uv2ToUse).rgb;","#else","vec3 aoValue = texture2D(lightMap, uvToUse).rgb;","#endif","#ifndef USE_LIGHTMAP_LINEAR","aoValue *= aoValue;","#endif","#endif",j.ShaderChunk.anisotropy_lights_physicalDS_fragment,"#ifdef GAS_LOOK","normal = perturbNormalGasLook(normal, vWorldPosition);","#endif","float NoV = clamp(dot(normal, viewPosition), 0.0, 1.0);","materialData.ior = ior;","float F0 = (materialData.ior - 1.0)/(materialData.ior + 1.0);","F0 *= F0;","materialData.sr0Color = (1.0 - metalnessValue) * F0 * specContrib  * specularColor + metalnessValue * albedo;","materialData.sr90Color = vec3(1.0) * ((1.0-metalnessValue)*specContrib + metalnessValue);",j.ShaderChunk.transparency_lights_physicalDS_fragment,j.ShaderChunk.cutout_lights_physicalDS_fragment,"#ifdef SPECGLOSS","materialData.diffuseColor = albedo;","#else","materialData.diffuseColor = albedo * (1.0 - metalnessValue) * (1.0 - trans);","#endif","#ifdef USE_LIGHTING",j.ShaderChunk.spot_lights_physicalDS_fragment,j.ShaderChunk.ies_lights_physicalDS_fragment,j.ShaderChunk.point_lights_physicalDS_fragment,j.ShaderChunk.dir_lights_physicalDS_fragment,j.ShaderChunk.hemi_lights_physicalDS_fragment,"#ifdef HAS_AREA_LIGHTS","vec3 viewReflect = reflect(-viewPosition, normal);","setAreaGGXData(materialData.roughness, NoV,areaData.fresnel, areaData.Minv);","#ifdef CLEAR_COAT","setAreaGGXData(materialData.clearCoatR, saturate(dot(materialData.clearCoatNormal,viewPosition)),areaData.fresnelCC, areaData.MinvCC);","#endif","#ifdef USE_SHEEN","#ifdef USE_VELVET","setAreaSheenData(sqrt(materialData.sheen), NoV, areaData.MinvSheen);","#else","setAreaSheenData(0.3, NoV, areaData.MinvSheen);","#endif","#endif","#ifdef USE_FLAKES","#ifdef OLD_FLAKES","setAreaGGXData(metal.roughness, saturate(dot(metal.normal,viewPosition)),areaData.fresnelMetal, areaData.MinvMetal);","setAreaGGXData(metalFlakes.roughness, saturate(dot(metalFlakes.normal,viewPosition)),areaData.fresnelMetalFlakes, areaData.MinvMetalFlakes);","#ifdef PEARL_FLAKES_ACTIVATED","setAreaGGXData(pearlFlakes.roughness, saturate(dot(pearlFlakes.normal,viewPosition)),areaData.fresnelPearlFlakes, areaData.MinvPearlFlakes);","#endif","#else","setAreaGGXData(materialData.flakesRoughness, NoV,areaData.fresnelMetal, areaData.MinvMetal);","#endif","#endif","#endif",j.ShaderChunk.area_lights_physicalDS_fragment,j.ShaderChunk.sphere_lights_physicalDS_fragment,j.ShaderChunk.tube_lights_physicalDS_fragment,j.ShaderChunk.disk_lights_physicalDS_fragment,j.ShaderChunk.total_lights_physicalDS_fragment,"#ifdef TEXTURE_BLENDING","vec4 texture = vec4( 1.0 );","#ifdef USE_MAP","texture = texelColor;","#endif","#if TEXTURE_BLENDING == 3","#if TEXTURE_FORMAT == 1021","gl_FragColor.a = texture.a;","#endif","#else","#if TEXTURE_BLENDING == 1","gl_FragColor.xyz = texture.xyz * totalDiffuse  + totalSpecular;","#endif","#if TEXTURE_BLENDING == 0","gl_FragColor.xyz = (1.0-texture.a) * totalDiffuse + totalSpecular + texture.a * texture.xyz;","#endif","#if TEXTURE_BLENDING == 2","gl_FragColor.xyz = (1.0-texture.xyz) * totalDiffuse + totalSpecular + texture.xyz;","#endif","#endif","#else","gl_FragColor.xyz = totalDiffuse + totalSpecular;","#endif","#endif","vec3 totalEmission = doEmission(NoV, emissionColorValue, emissionValue);",].join("\n");j.ShaderChunk.position_pars_vertex=["#if defined(USE_FLAKES) || defined(USE_ORANGE_PEEL) || defined(USE_SUBSURFACE) ","varying vec3 vObjectSpacePosition;","varying vec3 vObjectNormal;","#endif"].join("\n");j.ShaderChunk.position_vertex=["#if defined(USE_FLAKES) || defined(USE_ORANGE_PEEL) || defined(USE_SUBSURFACE) ","vObjectSpacePosition = position.xyz;","vObjectNormal = objectNormal.xyz;","#endif"].join("\n");j.ShaderChunk.noise_pars_fragment=["#if defined (GAS_LOOK) || defined (USE_FLAKES) || defined (USE_ORANGE_PEEL)","vec4 mod289(vec4 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec3 mod289(vec3 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec2 mod289(vec2 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec3 permute(vec3 x) {","  return mod289(((x*34.0)+1.0)*x);","}","vec4 permute(vec4 x) {","	return mod289(((x*34.0)+1.0)*x);","}","vec4 taylorInvSqrt(vec4 r) {","	return 1.79284291400159 - 0.85373472095314 * r;","}","float snoise(vec3 v) {","const vec2  C = vec2(1.0/6.0, 1.0/3.0);","const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);","vec3 i  = floor(v + dot(v, C.yyy) );","vec3 x0 =   v - i + dot(i, C.xxx) ;","vec3 g = step(x0.yzx, x0.xyz);","vec3 l = 1.0 - g;","vec3 i1 = min( g.xyz, l.zxy );","vec3 i2 = max( g.xyz, l.zxy );","vec3 x1 = x0 - i1 + C.xxx;","vec3 x2 = x0 - i2 + C.yyy;","vec3 x3 = x0 - D.yyy;","i = mod289(i);","vec4 p = permute( permute( permute( i.z + vec4(0.0, i1.z, i2.z, 1.0 )) + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));","float n_ = 0.142857142857;","vec3  ns = n_ * D.wyz - D.xzx;","vec4 j = p - 49.0 * floor(p * ns.z * ns.z);","vec4 x_ = floor(j * ns.z);","vec4 y_ = floor(j - 7.0 * x_ );","vec4 x = x_ *ns.x + ns.yyyy;","vec4 y = y_ *ns.x + ns.yyyy;","vec4 h = 1.0 - abs(x) - abs(y);","vec4 b0 = vec4( x.xy, y.xy );","vec4 b1 = vec4( x.zw, y.zw );","vec4 s0 = floor(b0)*2.0 + 1.0;","vec4 s1 = floor(b1)*2.0 + 1.0;","vec4 sh = -step(h, vec4(0.0));","vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy;","vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww;","vec3 p0 = vec3(a0.xy,h.x);","vec3 p1 = vec3(a0.zw,h.y);","vec3 p2 = vec3(a1.xy,h.z);","vec3 p3 = vec3(a1.zw,h.w);","vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));","p0 *= norm.x;","p1 *= norm.y;","p2 *= norm.z;","p3 *= norm.w;","vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);","m = m * m;","return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) ) );","}","#endif","#if defined(USE_FLAKES) || defined(USE_ORANGE_PEEL)","#define NBOCTAVES 10","float getMean(in float LODLevel) {","float mult = 1.8;","float LOD = 3.0;","float oldLOD = 0.0;","for (int i = NBOCTAVES - 1 ; i >=0; i--) {","float pente = 1.0 / (LOD - oldLOD);","float origine = float(i) + 1.0 + oldLOD * pente;","if (LODLevel <= LOD) {","return origine - pente * LODLevel;","}","oldLOD = LOD;","LOD *= mult;","}","return 0.0;","}","float FBM(vec3 iVector)","{","vec3 vector = iVector;","float res = 0.0;","float amplitude = 1.0;","float sum = 0.0;","for (int octave = 0; octave < 1; octave++) {","if (amplitude < 10.0 * kEpsilon) {","break;","}","vector = vector * 2.0;","sum += amplitude;","res += snoise(vector) * amplitude;","amplitude *= 0.5;","}","return clamp(res/sum,-1.0,1.0);","}","float arrayFBMMixer(in vec3 iVector, in float LODLevel, in float frequency, in float low, in float up)","{","vec3 vector = iVector;","float res = 0.0;","float sum = 0.0;","float variance = 1.5;","float mean = getMean(LODLevel);","float amplitude;","int minIndex = int(max(0.0, mean - low));","int maxIndex = int(min(float(NBOCTAVES), mean + up));","frequency *= pow(1.8, float(minIndex));","int octave = minIndex;","for (int i = 0; i < 10 ; i++) {","if (octave >= maxIndex) {break;}","vec3 vec = vector * frequency;","frequency *= 1.8;","amplitude = gaussian(float(octave), mean, variance);","sum += amplitude;","res += snoise(vec) * amplitude;","octave++;","}","return clamp(res/sum,-1.0,1.0);","}","#endif"].join("\n");j.ShaderChunk.utility_pars_fragment=["#if defined(USE_FLAKES) || defined(USE_ORANGE_PEEL) || defined(USE_SUBSURFACE) ","varying vec3 vObjectSpacePosition;","varying vec3 vObjectNormal;","#endif","const float kEpsilon = 0.00001;","vec3 getGeomT(in vec3 N) {","vec3 normN = normalize(N);","float x = normN.x;","float y = normN.y;","float z = normN.z;","vec3 T = vec3(0.0);","if ( abs(z) > 0.0) {","T.y += 0.0;","T.x += 1.0;","T.z += - x / z;","return normalize(T);","}","if ( abs(y) > 0.0) {","T.x += 0.0;","T.z += 1.0;","T.y += - z / y;","return normalize(T);","}","if ( abs(x) > 0.0) {","T.z += 0.0;","T.y += 1.0;","T.x += - y / x;","return normalize(T);","}","return vec3(0.0);","}","vec3 getGeomB(in vec3 N, in vec3 T) {","N = normalize(N);","T = normalize(T);","return normalize(cross(N,T));","}","float myAtan2(float y,float x){","float absx, absy, val;","float pi = 3.14159265359;","float ret;","if (x == 0.0 && y == 0.0) return 0.0;","absy = y < 0.0 ? -y : y;","if(y < 0.0) absy = -y;","else absy = y;","absx = x < 0.0 ? -x : x;","if (absy - absx == absy) return y < 0.0 ? -pi*0.5 : pi*0.5;","if (absx - absy == absx) val = 0.0;","else val = atan(y/x);","if (x > 0.0) return val;","if (y < 0.0) return val - pi;","return val + pi;","}","#define INV_GOLDEN_RATIO 0.6180339887","vec2 Hammersley2D(int i, int N)","{","return vec2((float(i) + 0.5) / float(N), fract(float(i) * INV_GOLDEN_RATIO));","}","vec3 TangentToWorldGeom(vec3 Vec, vec3 TangentZ) {","vec3 TangentX = getGeomT(TangentZ);","vec3 TangentY = getGeomB(TangentZ, TangentX);","return TangentX * Vec.x + TangentY * Vec.y + TangentZ * Vec.z;","}","vec3 TangentToWorld(vec3 Vec, vec3 TangentZ) {","vec3 UpVector = abs(TangentZ.x) < 0.999 ? vec3(0,0,1) : vec3(1,0,0);","vec3 TangentX = normalize(cross(UpVector, TangentZ));","vec3 TangentY = cross(TangentZ, TangentX);","return TangentX * Vec.x + TangentY * Vec.y + TangentZ * Vec.z;","}","vec3 ImportanceSampleGGX(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * 3.14159265359 * Xi.x;","float a = roughness * roughness;","float a2 = a * a;","float CosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a2 - 1.0) * Xi.y));","float SinTheta = sqrt(1.0 - CosTheta * CosTheta);","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return H;","}","float modI(float a, float b) {","float m = a - floor((a+0.5)/b)*b;","return floor(m+0.5);","}","int modI(int a, int b) {","return int(modI(float(a), float(b)));","}","float vRound(float a) {","return floor(a + 0.5);","}","float vMax(in vec2 v) {","return max(v.x,v.y);","}","float vMax(in vec3 v) {","return max(vMax(v.xy),v.z);","}","float vMax(in vec4 v) {","return max(vMax(v.xy),vMax(v.zw));","}","float vMin(in vec2 v) {","return min(v.x,v.y);","}","float vMin(in vec3 v) {","return min(vMin(v.xy),v.z);","}","float vMin(in vec4 v) {","return min(vMin(v.xy),vMin(v.zw));","}","float affine(in float value, in float value0, in float value1) {","return value * (value1 - value0) + value0;","}","float toTexCoord(in float x, in float minValue, in float maxValue) {","return clamp((clamp(x, minValue, maxValue) - minValue) / (maxValue - minValue),0.0,1.0);","}","vec2 toTexCoord(in vec2 x, in vec2 minValue, in vec2 maxValue) {","return clamp((clamp(x, minValue, maxValue) - minValue) / (maxValue - minValue),0.0,1.0);","}","vec3 toTexCoord(in vec3 x, in vec3 minValue, in vec3 maxValue) {","return clamp((clamp(x, minValue, maxValue) - minValue) / (maxValue - minValue),0.0,1.0);","}","vec4 toTexCoord(in vec4 x, in vec4 minValue, in vec4 maxValue) {","return clamp((clamp(x, minValue, maxValue) - minValue) / (maxValue - minValue),0.0,1.0);","}","float zeroSphericalHarmonics() {","return sqrt(0.31830988618) / 2.0;","}","bool vIsnan( float val )","{","return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;","}","vec2 vNormalize( vec2 val )","{","if (length(val) < 1e-6) {","return vec2(0.0);","}","return normalize(val);","}","vec3 vNormalize( vec3 val )","{","if (length(val) < 1e-6) {","return vec3(0.0);","}","return normalize(val);","}","vec4 vNormalize( vec4 val )","{","if (length(val) < 1e-6) {","return vec4(0.0);","}","return normalize(val);","}","mat3 transposeMatrix(in mat3 m) {","mat3 mT;","mT[0] = vec3(m[0][0], m[1][0], m[2][0]);","mT[1] = vec3(m[0][1], m[1][1], m[2][1]);","mT[2] = vec3(m[0][2], m[1][2], m[2][2]);","return mT;","}","float gaussian(in float x, in float mean, in float variance) ","{","float value = x - mean;","value *= value;","value /= 2.0 * variance;","return exp(-value);","}","float saturate(in float iValue)","{","return clamp(iValue, 0.0, 1.0);","}","vec2 saturate(in vec2 iValue)","{","return clamp(iValue, vec2(0.0), vec2(1.0));","}","vec3 saturate(in vec3 iValue)","{","return clamp(iValue, vec3(0.0), vec3(1.0));","}","vec4 saturate(in vec4 iValue)","{","return clamp(iValue, vec4(0.0), vec4(1.0));","}","float pow2(in float iValue)","{","return iValue*iValue;","}","float pow3(in float iValue)","{","return pow2(iValue) * iValue;","}","float pow4(in float iValue)","{","float tmp = pow2(iValue);","return pow2(tmp);","}","float pow5(in float iValue)","{","float tmp = pow4(iValue);","return tmp * iValue;","}","float pow6(in float iValue)","{","float tmp = pow2(iValue);","float tmp2 = pow2(tmp);","return tmp * tmp2;","}","float fma(in float x, in float y, in float z) {","return x*y + z;","}","vec3 fma(in vec3 x, in vec3 y, in vec3 z) {","return x*y + z;","}","vec2 fma(in vec2 x, in vec2 y, in vec2 z) {","return x*y + z;","}","vec4 fma(in vec4 x, in vec4 y, in vec4 z) {","return x*y + z;","}","vec3 Rotate3D(in vec3 iVec, in float iAngle, in vec3 iAxe) {","float s = sin(iAngle);","float c = cos(iAngle);","float x = iAxe.x;","float y = iAxe.y;","float z = iAxe.z;","mat3 rot = mat3(pow2(x) * (1.0 - c) + c, x * y * (1.0 - c) - z * s, x * z * (1.0 - c) + y * s,","x * y * (1.0 - c) + z * s, pow2(y) * (1.0 - c) + c, y * z * (1.0 - c) - x * s,","x * z * (1.0 - c) - y * s, y * z * (1.0 - c) + x * s, pow2(z) * (1.0 - c) + c);","return rot * iVec;","}",].join("\n");j.ShaderChunk.postshadowmap_fragment=["#ifdef USE_LIGHTING","#ifdef TRANSLUCENCY","#ifndef SPECGLOSS","dirTranslucency /= transToDivide;","#endif","gl_FragColor.xyz += dirTranslucency;","#endif","#endif","gl_FragColor.xyz += totalEmission;",].join("\n");j.ShaderLib.physicalDS={uniforms:j.UniformsUtils.merge([j.UniformsLib.common,j.UniformsLib.bump,j.UniformsLib.normalmap,j.UniformsLib.fog,j.UniformsLib.lights,j.UniformsLib.shadowmap,j.UniformsLib.clipPlanes,j.UniformsLib.skinning,{prevColorTexture:{type:"t",value:null},prevNormalDepthTexture:{type:"t",value:null},screenSize:{type:"v2",value:new j.Vector2()},invScreenSize:{type:"v2",value:new j.Vector2()},normalUvTransform:{type:"m3",value:new j.Matrix3()},diffuseUvTransform:{type:"m3",value:new j.Matrix3()},diffuseMulCoef:{type:"v3",value:new j.Vector3()},diffuseAddCoef:{type:"v3",value:new j.Vector3()},specular:{type:"c",value:new j.Color(16777215)},specularUvTransform:{type:"m3",value:new j.Matrix3()},specularAddCoef:{type:"v3",value:new j.Vector3()},specularMulCoef:{type:"v3",value:new j.Vector3()},metalness:{type:"f",value:1},metalnessMap:{type:"t",value:null},metalnessUvTransform:{type:"m3",value:new j.Matrix3()},metalnessAddCoef:{type:"f",value:1},metalnessMulCoef:{type:"f",value:0},specularContrib:{type:"f",value:1},specularContribMap:{type:"t",value:null},specularContribUvTransform:{type:"m3",value:new j.Matrix3()},specularContribMulCoef:{type:"f",value:1},specularContribAddCoef:{type:"f",value:0},emissionColor:{type:"c",value:new j.Color(0)},emissionColorMap:{type:"t",value:null},emissionColorUvTransform:{type:"m3",value:new j.Matrix3()},emissionColorMulCoef:{type:"v3",value:new j.Vector3()},emissionColorAddCoef:{type:"v3",value:new j.Vector3()},emissionValue:{type:"f",value:0},transparency:{type:"f",value:0},transparencyMap:{type:"t",value:null},transparencyUvTransform:{type:"m3",value:new j.Matrix3()},transparencyMulCoef:{type:"f",value:1},transparencyAddCoef:{type:"f",value:0},opacity:{type:"f",value:0},opacityMap:{type:"t",value:null},opacityUvTransform:{type:"m3",value:new j.Matrix3()},opacityMulCoef:{type:"f",value:1},opacityAddCoef:{type:"f",value:0},ior:{type:"f",value:1.4},roughness:{type:"f",value:0},roughnessMap:{type:"t",value:null},glossinessMap:{type:"t",value:null},glossinessMulCoef:{type:"f",value:1},glossinessAddCoef:{type:"f",value:0},roughnessUvTransform:{type:"m3",value:new j.Matrix3()},roughnessMulCoef:{type:"f",value:1},roughnessAddCoef:{type:"f",value:0},anisotropy:{type:"f",value:0},anisotropyMap:{type:"t",value:null},anisotropyUvTransform:{type:"m3",value:new j.Matrix3()},anisotropyMulCoef:{type:"f",value:1},anisotropyAddCoef:{type:"f",value:0},anisotropyAngle:{type:"f",value:0},anisotropyAngleMap:{type:"t",value:null},anisotropyAngleUvTransform:{type:"m3",value:new j.Matrix3()},anisotropyAngleMulCoef:{type:"f",value:1},anisotropyAngleAddCoef:{type:"f",value:0},displacementMap:{type:"t",value:null},displacementBias:{type:"f",value:0},displacementScale:{type:"f",value:0},reflectionProbe:{type:"t",value:null},reflectionProbeMips:{type:"t",value:null},reflectionProbeProxyMin:{type:"v3",value:new j.Vector3()},reflectionProbeProxyMax:{type:"v3",value:new j.Vector3()},reflectionProbePos:{type:"v3",value:new j.Vector3()},envMapSheen:{type:"t",value:null},sheen:{type:"f",value:0},sheenMap:{type:"t",value:null},sheenUvTransform:{type:"m3",value:new j.Matrix3()},sheenMulCoef:{type:"f",value:1},sheenAddCoef:{type:"f",value:0},flakesColor:{type:"c",value:new j.Color(0)},flakesBump:{type:"f",value:0},flakesDensity:{type:"f",value:0},flakesScale:{type:"f",value:0},flakesRoughness:{type:"f",value:0},flakesColorMulCoef:{type:"v3",value:new j.Vector3()},flakesColorAddCoef:{type:"v3",value:new j.Vector3()},pearlFlakesColor:{type:"c",value:new j.Color(0)},pearlFlakesDensity:{type:"f",value:0},pearlFlakesBump:{type:"f",value:0},pearlFlakesColorMulCoef:{type:"v3",value:new j.Vector3()},pearlFlakesColorAddCoef:{type:"v3",value:new j.Vector3()},flakesColorMap:{type:"t",value:null},flakesColorUvTransform:{type:"m3",value:new j.Matrix3()},flakesCoverage:{type:"f",value:0},flakesCoverageUvTransform:{type:"m3",value:new j.Matrix3()},flakesCoverageyMap:{type:"t",value:null},flakesCoverageMulCoef:{type:"f",value:1},flakesCoverageAddCoef:{type:"f",value:0},flakesSize:{type:"f",value:0},flakesSizeUvTransform:{type:"m3",value:new j.Matrix3()},flakesSizeMap:{type:"t",value:null},flakesSizeMulCoef:{type:"f",value:1},flakesSizeAddCoef:{type:"f",value:0},flakesRoughnessUvTransform:{type:"m3",value:new j.Matrix3()},flakesRoughnessMap:{type:"t",value:null},flakesRoughnessMulCoef:{type:"f",value:1},flakesRoughnessAddCoef:{type:"f",value:0},sphereCenter:{type:"v3",value:new j.Vector3()},projectionCenter:{type:"v3",value:new j.Vector3()},sphereRadius:{type:"f",value:0},clearCoat:{type:"f",value:0},clearCoatMap:{type:"t",value:null},clearCoatUvTransform:{type:"m3",value:new j.Matrix3()},clearCoatMulCoef:{type:"f",value:1},clearCoatAddCoef:{type:"f",value:0},clearCoatRoughness:{type:"f",value:0},clearCoatRoughnessMap:{type:"t",value:null},clearCoatRoughnessUvTransform:{type:"m3",value:new j.Matrix3()},clearCoatRoughnessMulCoef:{type:"f",value:1},clearCoatRoughnessAddCoef:{type:"f",value:0},coatingGlossinessMap:{type:"t",value:null},coatingGlossinessMulCoef:{type:"f",value:1},coatingGlossinessAddCoef:{type:"f",value:0},clearCoatNormalMap:{type:"t",value:null},clearCoatNormalpUvTransform:{type:"m3",value:new j.Matrix3()},clearCoatNormalScale:{type:"f",value:1},orangePeelScale:{type:"f",value:0},precomputedTexture1:{type:"t",value:null},precomputedTexture2:{type:"t",value:null},precomputedTexture3:{type:"t",value:null},envMap2:{type:"t",value:null},sssLUT:{type:"t",value:null},sssIBLLUT:{type:"t",value:null},translucencyLUT:{type:"t",value:null},translucencyScale:{type:"f",value:1}}]),vertexShader:["#define PHYSICALDS","#ifndef PDSFX","varying vec3 vViewPosition;","#endif","varying vec3 vNormal;",j.ShaderChunk.clip_pars_vertex,j.ShaderChunk.map_pars_vertex_physical,j.ShaderChunk.envmap_pars_vertex,j.ShaderChunk.lights_physicalDS_pars_vertex,j.ShaderChunk.shadowmap_pars_vertex,j.ShaderChunk.tangent_Binormal_pars,j.ShaderChunk.skinning_pars_vertex,j.ShaderChunk.position_pars_vertex,j.ShaderChunk.oit_pars_vertex,"void main() {",j.ShaderChunk.PDSFX_start_vertex,j.ShaderChunk.skinbase_vertex,j.ShaderChunk.skinnormal_vertex,j.ShaderChunk.skinning_vertex,j.ShaderChunk.map_vertex_physical,j.ShaderChunk.defaultnormal_vertex,j.ShaderChunk.tangent_Binormal_vertex,"vNormal = normalize( transformedNormal );",j.ShaderChunk.displacement_vertex,j.ShaderChunk.default_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif",j.ShaderChunk.clip_vertex,"#ifndef PDSFX","vViewPosition = -mvPosition.xyz;","#endif",j.ShaderChunk.worldpos_vertex,j.ShaderChunk.envmap_vertex,j.ShaderChunk.lights_physicalDS_vertex,j.ShaderChunk.shadowmap_vertex,j.ShaderChunk.position_vertex,j.ShaderChunk.oit_vertex,j.ShaderChunk.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:["#define PHYSICALDS","struct matData","{","float roughness;","vec3 diffuseColor;","vec3 sr0Color;","vec3 sr90Color;","float ior;","#ifdef USE_ANISOTROPY","vec3 tangent;","vec3 binormal;","float anisotropy;","float anisotropyAngle;","#endif","#ifdef USE_SHEEN","float sheen;","#endif","#ifdef CLEAR_COAT","float clearCoat;","vec3 clearCoatNormal;","float clearCoatR;","#endif","#ifdef USE_SUBSURFACE","float curvature;","#endif","#if defined(USE_FLAKES) && !defined(OLD_FLAKES)","vec3 flakesColor;","float flakesSize;","float flakesCoverage;","float flakesRoughness;","#endif","};","matData materialData;","varying vec3 vWorldNormal;","varying vec3 vWorldPosition;","#ifndef PDSFX","varying vec3 vViewPosition;","#else","	vec3 vViewPosition;","#endif","varying vec3 vNormal;",j.ShaderChunk.clip_pars_fragment,j.ShaderChunk.map_pars_fragment_physical,j.ShaderChunk.madCoefficients_pars_fragment,j.ShaderChunk.envmap_pars_fragment,j.ShaderChunk.fog_pars_fragment,j.ShaderChunk.iterative_pars_fragment,j.ShaderChunk.utility_pars_fragment,j.ShaderChunk.noise_pars_fragment,j.ShaderChunk.bumpmap_pars_fragment,j.ShaderChunk.normalmap_pars_fragment,j.ShaderChunk.IBL_pars_fragment,j.ShaderChunk.lights_physicalDS_pars_fragment,j.ShaderChunk.specularmap_pars_fragment,j.ShaderChunk.tangent_Binormal_pars,j.ShaderChunk.oit_pars_fragment,"void main() {","#ifdef PDSFX",j.ShaderChunk.PDSFX_map_fragment,"ComputeCommonValues();",j.ShaderChunk.PDSFX_discard_fragment,j.ShaderChunk.PDSFX_viewNormal_fragment,"vViewPosition = -ComputeViewPosition();","#endif","gl_FragColor = vec4( vec3 ( 1.0 ), 1.0 );",j.ShaderChunk.clip_fragment,j.ShaderChunk.uvmapping_fragment_physical,j.ShaderChunk.tangent_Binormal_fragment,j.ShaderChunk.specularmap_fragment,j.ShaderChunk.lights_physicalDS_fragment,j.ShaderChunk.alphatest_fragment,j.ShaderChunk.stochastic_transparency_fragment,"#if defined( USE_MAP_HDR ) || defined( USE_ENVMAP_HDR )","vec2 texelSizeEnvMap = vec2(1.0 / envMapHDRSize);","#endif","#if defined(USE_ENVMAP) && defined(USE_LIGHTING)",j.ShaderChunk.IBL_fragment,j.ShaderChunk.core_IBL_fragment,"#ifdef OLD_FLAKES",j.ShaderChunk.old_flakes_IBL_fragment,j.ShaderChunk.old_pearlflakes_IBL_fragment,"#else",j.ShaderChunk.flakes_IBL_fragment,"#endif",j.ShaderChunk.coating_IBL_fragment,j.ShaderChunk.total_IBL_fragment,"#elif !defined(USE_LIGHTING)","#ifdef USE_LIGHTMAP","gl_FragColor.xyz = aoValue * materialData.diffuseColor;","#else","gl_FragColor.xyz = materialData.diffuseColor;","#endif","#else","vec3 ambientTerm = ambientLightColor;","#ifdef USE_SUBSURFACE","vec3 scattering = SssLUTSampling(materialData.curvature);","#else","vec3 scattering = vec3(1.0);","#endif","#ifdef USE_LIGHTMAP","#ifdef LIGHTMAP_IRRADIANCE_MODE","gl_FragColor.xyz += scattering * aoValue * materialData.diffuseColor;","#else","gl_FragColor.xyz += scattering * aoValue * materialData.diffuseColor  * ambientTerm;","#endif","#else","gl_FragColor.xyz += scattering * materialData.diffuseColor * ambientTerm;","#endif","#endif",j.ShaderChunk.postshadowmap_fragment,j.ShaderChunk.linear_to_gamma_fragment,j.ShaderChunk.fog_fragment,j.ShaderChunk.oit_fragment,j.ShaderChunk.PDSFX_end_fragment,"}"].join("\n")};j.TangentToWorld=function(){var m=new j.Vector3();var l=new j.Vector3();return function(n,o){var r=Math.abs(o.z)<0.999?m.set(0,0,1):m.set(1,0,0);l.crossVectors(r,o);var q=l.normalize();var p=m.crossVectors(o,q);q.multiplyScalar(n.x);p.multiplyScalar(n.y);q.add(p);p.copy(o);p.multiplyScalar(n.z);q.add(p);return q}}();j.RandomLib={};j.RandomLib._tmpVec2=new j.Vector2();j.RandomLib._tmpVec3=new j.Vector3();j.RandomLib._tmpBits=new Uint32Array(1);j.RandomLib.ReverseBits32=function(l){var l=j.RandomLib._tmpBits;l[0]=i;l[0]=((l[0]<<16)|(l[0]>>16))>>>0;l[0]=((l[0]&1431655765)<<1)|((l[0]&2863311530)>>>1)>>>0;l[0]=((l[0]&858993459)<<2)|((l[0]&3435973836)>>>2)>>>0;l[0]=((l[0]&252645135)<<4)|((l[0]&4042322160)>>>4)>>>0;l[0]=((l[0]&16711935)<<8)|((l[0]&4278255360)>>>8)>>>0;return l[0]*2.3283064365386963e-10};j.RandomLib.Hammersley=function(m,l,p,o){var n=j.RandomLib._tmpVec2;n.x=m/l;n.y=j.RandomLib.ReverseBits32(m);return n};j.RandomLib.LowDiscrepancy2D=function(m,l,p,o){var n=j.RandomLib._tmpVec2;n.x=j.RandomLib.HaltonSequence(m,2);n.y=j.RandomLib.HaltonSequence(m,5);return n};j.RandomLib.HaltonSequence=function(r,m){var q=0;var p=1/m;var o=p;while(r>0){var l=(r%m);q+=l*o;r=Math.floor(r/m);o*=p}return q};j.RandomLib.ImportanceSampleGGX=function(s,q){var r=j.RandomLib._tmpVec3;var l=q*q;var o=l*l;var n=2*Math.PI*s.x;var t=Math.sqrt((1-s.y)/(1+(o-1)*s.y));var p=Math.sqrt(1-t*t);r.x=p*Math.cos(n);r.y=p*Math.sin(n);r.z=t;return r};j.RandomLib.Hammersley2D=function(m,n){var l=(m+0.5)/n;var o=m*6180339887;o=o-Math.floor(o);return new j.Vector2(l,o)};j.RandomLib.ImportanceSampleAshikmin=function(x,q){var y=j.RandomLib._tmpVec3;var u=function(A){var B=Math.log(Math.abs(A));var r=Math.atan2(0,A);return new j.Vector2(B,r)};var o=function(r){var A=(r.x*r.x+r.y*r.y);return new j.Vector2(r.x/A,-r.y/A)};var t=2*Math.PI*x.x;var l=q;var m=l*l*l*l;var z=4*m*Math.exp(1/m)/(4*m*x.y+x.y-1);var s=m*u(z);var w=o(s);var n=Math.min(Math.sqrt(w.x*w.x+w.y*w.y),1);var v=Math.sqrt(n);var p=Math.sqrt(1-n);y.x=v*Math.cos(t);y.y=v*Math.sin(t);y.z=p;return y};j.RandomLib.ImportanceSampleCosine=function(p,n){var o=j.RandomLib._tmpVec3;var l=2*Math.PI*p.x;var m=Math.sqrt(p.y);var q=Math.sqrt(1-p.y);o.x=m*Math.cos(l);o.y=m*Math.sin(l);o.z=q;return o};j.RandomLib.ImportanceSampleBeckmann=function(t,o){var u=j.RandomLib._tmpVec3;var p=2*Math.PI*t.x;var l=o;var m=l*l*l*l;var v=8*m*Math.log(1-t.y);var s=v/(v-1);var q=Math.sqrt(s);var n=Math.sqrt(1-s);u.x=q*Math.cos(p);u.y=q*Math.sin(p);u.z=n;return u};j.RandomLib.computePreIntegratedGFTexture=function(w,C,t){var p=Date.now();var A=new j.Vector2();var z=new j.Vector3();var D=new j.Vector3();var l,B;switch(t){case"ASHIKMIN":l=j.RandomLib.ImportanceSampleAshikmin;B=function(J,N,L,y,x){var M=Math.min(0.25*Math.max(1/Math.max(L+N-N*L,0.000001),0),5);var K=4*L*y/x;return K*M};break;case"BECKMANN":l=j.RandomLib.ImportanceSampleBeckmann;B=function(J,N,L,y,x){var M=Math.min(0.25*Math.max(1/Math.max(L+N-N*L,0.000001),0),5);var K=4*L*y/x;return K*M};break;case"GGX":default:var o=function(y,M,L){var x=0.5*y*y;var K=M*(1-x)+x;var J=L*(1-x)+x;return L*M/(K*J)};l=j.RandomLib.ImportanceSampleGGX;B=function(J,N,L,y,x){var M=0.25*GeomGGX(J,N,L)/Math.max(L*N,0.000001);var K=4*L*y/x;return K*M}}var E=function(R,S,J,y){var O=D;O.x=Math.sqrt(1-S*S);O.y=0;O.z=S;var M=0;var K=0;for(var Q=0;Q<C;Q++){var W=j.RandomLib.LowDiscrepancy2D(Q,C,J,y);var X=l(W,R);var T=z.copy(X);T.multiplyScalar(2*O.dot(X));T.sub(O);var x=Math.max(0,Math.min(T.z,1));var N=Math.max(0,Math.min(X.z,1));var Y=Math.max(0,Math.min(O.dot(X),1));if(x>0){var U=B(R,S,x,Y,N);var P=Math.pow(1-Y,5);M+=(1-P)*U;K+=P*U}}A.x=M/C;A.y=K/C;return A};var m=256*256-1;var G=function(y){y*=m;var x=[Math.floor(y/256),Math.floor(y)];x[1]-=x[0]*256;x[0]=Math.min(x[0],255);x[1]=Math.min(x[1],255);return x};var F=function(x){return(x[0]*256+x[1])/m};var H=new Uint8Array(4*w*w);for(var r=0;r<w;r++){for(var s=0;s<w;s++){var u=r*w+s;var I=E(1-r/(w-1),s/(w-1),Math.floor(100000*Math.random()),Math.floor(100000*Math.random()));var n=G(I.x);var v=G(I.y);H[4*u]=n[0];H[4*u+1]=n[1];H[4*u+2]=v[0];H[4*u+3]=v[1]}}var q=Date.now();console.log((q-p)/1000);return new j.DataTexture(H,w,w,j.RGBAFormat,j.Uint8Type)};j.RandomLib.computePreIntegratedTexture=function(C,G){var E=new j.Vector4();var B=new j.Vector4();var D=new j.Vector3();var I=new j.Vector3();var l=j.RandomLib.ImportanceSampleAshikmin;var v=j.RandomLib.ImportanceSampleBeckmann;var m=function(O,S,Q,y,x){var R=0.25/Math.max(Q+S-S*Q,0.001);var P=4*Q*y/Math.max(x,0.001);return P*R};var z=function(Q,R,x){var T=Q*Q;var y=T*T;var S=Math.max(R*R,0.001);var O=Math.max(x*x,0.001);var P=Math.sqrt(1-y+y/S);var U=Math.sqrt(1-y+y/O);return 2/(P+U)};var o=j.RandomLib.ImportanceSampleGGX;var H=function(O,S,Q,y,x){var R=0.25*z(O,S,Q)/Math.max(Q*S,0.001);var P=4*Q*y/Math.max(x,0.001);return P*R};var F=function(ah,x,ad,ac){var O=I;O.x=Math.sqrt(1-x*x);O.y=0;O.z=x;var y=0;var ag=0;var U=0;var ai=0;var P=0;E.x=E.y=E.z=E.w=B.x=B.y=B.z=B.w=0;var X=0;var af=0;var Z=0;for(var ab=0;ab<G;ab++){var aa=j.RandomLib.LowDiscrepancy2D(ab,G,ad,ac);var T=o(aa,ah);var R=D.copy(T);R.multiplyScalar(2*O.dot(T));R.sub(O);var Q=Math.max(0,Math.min(R.z,1));var S=Math.max(0,Math.min(T.z,1));var ae=Math.max(0,Math.min(O.dot(T),1));if(Q>0.001){var Y=Math.pow(1-ae,5);var W=H(ah,x,Q,ae,S)*Q;y+=W;ag+=W*(1-Y);U+=W*Y;X+=Q}T=l(aa,ah);R=D.copy(T);R.multiplyScalar(2*O.dot(T));R.sub(O);Q=Math.max(0,Math.min(R.z,1));S=Math.max(0,Math.min(T.z,1));ae=Math.max(0,Math.min(O.dot(T),1));if(Q>0.001){ai+=m(ah,x,Q,ae,S)*Q;af+=Q}T=v(aa,ah);R=D.copy(T);R.multiplyScalar(2*O.dot(T));R.sub(O);Q=Math.max(0,Math.min(R.z,1));S=Math.max(0,Math.min(T.z,1));ae=Math.max(0,Math.min(O.dot(T),1));if(Q>0.001){P+=m(ah,x,Q,ae,S)*Q;Z+=Q}}E.x=ag/X;E.w=ai/af;E.z=P/Z;E.y=U/X;B.x=y/X};var q=256*256-1;var L=function(y){y*=q;var x=[Math.floor(y/256),Math.floor(y)];x[1]-=x[0]*256;x[0]=Math.min(x[0],255);x[1]=Math.min(x[1],255);return x};var K=function(x){return(x[0]*256+x[1])/q};var N=new Uint8Array(4*C*C);var r=new Uint8Array(4*C*C);var p=new Uint8Array(4*C*C);for(var t=0;t<C;t++){for(var u=0;u<C;u++){var w=t*C+u;F(1-t/(C-1),u/(C-1),Math.floor(100000*Math.random()),Math.floor(100000*Math.random()));var s=L(E.x);var A=L(E.y);var J=L(E.z);var M=L(E.w);var n=L(B.x);N[4*w]=s[0];N[4*w+1]=s[1];N[4*w+2]=A[0];N[4*w+3]=A[1];r[4*w]=J[0];r[4*w+1]=J[1];r[4*w+2]=M[0];r[4*w+3]=M[1];p[4*w]=n[0];p[4*w+1]=n[1];p[4*w+2]=0;p[4*w+3]=0}}return[new j.DataTexture(N,C,C,j.RGBAFormat,j.Uint8Type),new j.DataTexture(r,C,C,j.RGBAFormat,j.Uint8Type),new j.DataTexture(p,C,C,j.RGBAFormat,j.Uint8Type),]};j.RandomLib.computeHaltonSequence4D=function(n){var l=n*n;var o=new Float32Array(4*l);for(var m=0;m<l;m++){o[4*m]=j.RandomLib.HaltonSequence(m,2);o[4*m+1]=j.RandomLib.HaltonSequence(m,5);o[4*m+2]=j.RandomLib.HaltonSequence(m,7);o[4*m+3]=j.RandomLib.HaltonSequence(m,9)}return new j.DataTexture(o,n,n,j.RGBAFormat,j.FloatType)};j.RGB_S3TC_DXT1_Format=2001;j.RGBA_S3TC_DXT1_Format=2002;j.RGBA_S3TC_DXT3_Format=2003;j.RGBA_S3TC_DXT5_Format=2004;j.CompressedTexture=function(o,n,u,s,r,l,q,p,t,m){j.Texture.call(this,null,l,q,p,t,m,s,r);this.image={width:n,height:u};this.mipmaps=o};j.CompressedTexture.prototype=Object.create(j.Texture.prototype);j.CompressedTexture.prototype.clone=function(){var l=new j.CompressedTexture(this.mipmaps,this.image.width,this.image.height,this.format,this.type,this.mapping,this.wrapS,this.wrapT,this.magFilter,this.minFilter);l.offset.copy(this.offset);l.repeat.copy(this.repeat);return l};j.Texture.prototype.setAsLOD=function(l){this.lods=[];this.textures=[];this.usedTexture=-1;this.lastUsedTexture=-1;this.switchLODTextureCB=l};j.Texture.prototype.chooseTexture=function(m,l){if(this.switchLODTextureCB){this.usedTexture=this.switchLODTextureCB({camera:m,object:l,texture:this,lods:this.lods,bSphere:l.geometry.boundingSphere,bBox:l.geometry.boundingBox,matrix:l.matrixWorld})}else{this.usedTexture=-1}if(this.usedTexture===-1){return}var n=this.lods[this.usedTexture];if(!this.textures[this.usedTexture]&&n.loadCB){this.textures[this.usedTexture]=n.loadCB(this)}};j.LODTextureData=function(n,m,l){this.imageData=n;this.bufferData=m;this.loadCB=l};j.Object3D_backup=j.Object3D.prototype.constructor;j.Object3D_backup_proto=j.Object3D.prototype;j.Object3D=function(){j.Object3D_backup.call(this);this.orientation=0;this.boundingSphere=null;this.boundingBox=null;this.pickingID=this.getUniqueColor()};j.Object3D.prototype=j.Object3D_backup_proto;j.Object3D.prototype.constructor=j.Object3D;j.Object3D.prototype.cloneSimple=function(l){if(l===undefined){l=new j.Object3D()}l.name=this.name;l.up.copy(this.up);l.position.copy(this.position);if(l.rotation instanceof j.Vector3){l.rotation.copy(this.rotation)}l.eulerOrder=this.eulerOrder;l.scale.copy(this.scale);l.renderDepth=this.renderDepth;l.rotationAutoUpdate=this.rotationAutoUpdate;l.matrix.copy(this.matrix);l.matrixWorld.copy(this.matrixWorld);l.matrixRotationWorld.copy(this.matrixRotationWorld);l.matrixAutoUpdate=this.matrixAutoUpdate;l.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate;l.quaternion.copy(this.quaternion);l.useQuaternion=this.useQuaternion;l.visible=this.visible;l.visibilityFree=this.visibilityFree;l.castShadow=this.castShadow;l.receiveShadow=this.receiveShadow;l.frustumCulled=this.frustumCulled;l.isUniformlyScaled=this.isUniformlyScaled;return l};j.Object3D.prototype.getLookAt=function(){var l=this._getMMMatrix().elements;return new j.Vector3(-l[8],-l[9],-l[10])};var e=new j.Matrix4();j.Object3D.prototype.setMatrix=function(l,n){this.matrix=l;if(!l){this.scale.set(1,1,1);this.rotation.set(0,0,0);this.position.set(0,0,0)}else{this.scale.getScaleFromMatrix(this.matrix);var m=e.extractRotation(this.matrix);this.rotation.setEulerFromRotationMatrix(m,this.eulerOrder);this.position.getPositionFromMatrix(this.matrix)}this.isUniformlyScaled=Math.abs(this.scale.x-this.scale.y)<0.0001&&Math.abs(this.scale.z-this.scale.y)<0.0001?true:false;if(n===false){this.matrixWorldNeedsUpdate=false;this.matrixWorld=this.matrix||j.IdentityMatrix}else{this.matrixWorldNeedsUpdate=true}this._updateWorldCenterAndRadius();if(this.modelInvTranspMatrix!==null){this.modelInvTranspMatrix.getInverse(this.matrixWorld).transpose()}};j.Object3D.prototype.containsObject=function(l){var n=this;while(n.parent!==undefined){n=n.parent}var m=l.parent;if(m===undefined){return false}while(m.parent!==undefined){m=m.parent}return(m===n)};j.Object3D.prototype.containsMesh=function(l){if(l instanceof j.Mesh||l instanceof j.CSS2DNode){var m=this;while(m.parent!==undefined){m=m.parent}if(m!==undefined&&m instanceof j.Scene){if(m.__objects.has(l)){return true}}}return false};j.Object3D.prototype.containsLight=function(l){if(l instanceof j.Light){var m=this;while(m.parent!==undefined){m=m.parent}if(m!==undefined&&m instanceof j.Scene){if(m.__lights.indexOf(l)!==-1){return true}}}return false};j.Object3D.prototype.containsLensFlare=function(l){if(l instanceof j.LensFlare){var m=this;while(m.parent!==undefined){m=m.parent}if(m!==undefined&&m instanceof j.Scene){if(m.__webglFlares&&(m.__webglFlares.indexOf(l)!==-1)){return true}}}return false};j.Object3D.prototype.getMeshInstances=function(){var l=[];var p=this;while(p.parent!==undefined){p=p.parent}if(p!==undefined&&p instanceof j.Scene){var n=p.getWebGLObjects("main",0);if(!n){return l}for(var m=0;m<n.length;m++){var o=n[m].object;if(o instanceof j.Mesh){l.push(o)}}}return l};j.Object3D.prototype.recompileShaders=function(){var r,u,n;if(this instanceof j.Mesh){if(this.material!==null){this.material.needsUpdate=true;if(this.material.line){this.material.line.needsUpdate=true}if(this.material.point){this.material.point.needsUpdate=true}}if(this.userData&&this.userData.oldMaterial){this.userData.oldMaterial.needsUpdate=true;if(this.userData.oldMaterial.line){this.userData.oldMaterial.line.needsUpdate=true}if(this.userData.oldMaterial.point){this.userData.oldMaterial.point.needsUpdate=true}}if(this.layer&&this.layer.layers){for(u=0;u<this.layer.layers.length;u++){var o=this.layer.layers[u].drawableInterval.material;if(o){o.needsUpdate=true}}}if(this.material&&this.material._deferredMaterialsInit){var o=this.material._deferredMaterials;for(var r=0;r<o.length;r++){var v=o[r];if(v){v.needsUpdate=true}}}if(this.material&&this.material.line&&this.material.line._deferredMaterialsInit){var o=this.material.line._deferredMaterials;for(var r=0;r<o.length;r++){var v=o[r];if(v){v.needsUpdate=true}}}if(this.material&&this.material.point&&this.material.point._deferredMaterialsInit){var o=this.material.point._deferredMaterials;for(var r=0;r<o.length;r++){var v=o[r];if(v){v.needsUpdate=true}}}var t=null;var s=0;if(this.geometry.length>=0){t=this.geometry[0];s=this.geometry.length}else{if(this.geometry._type===2){t=this.geometry;s=1}}for(var p=0;p<s;p++){var m=t.drawingGroups;for(var q=0;q<m.length;q++){if(m[q].gas!==null){m[q].gas.needsUpdate=true}if(m[q].material!==null&&m[q].material instanceof j.Material){m[q].material.needsUpdate=true}if(m[q].gas._deferredMaterialsInit){var o=m[q].gas._deferredMaterials;for(var r=0;r<o.length;r++){var v=o[r];if(v){v.needsUpdate=true}}}}t=this.geometry[p+1]}return}for(r=0,n=this.children.length;r<n;r++){this.children[r].recompileShaders()}return};j.Object3D.prototype.getScene=function(){if(this instanceof j.Scene){return this}else{if(this.parent!=null){return this.parent.getScene()}else{return null}}};j.Object3D.prototype.getUniqueColor=function(){var l=Number(this.id).toString(16);if(this.id>=4194303){console.warn("max  number of pickingId values reached")}l="000000".substr(0,6-l.length)+l;l.toUpperCase();l="#"+l;return new j.Color(l)};j.CSS2DNode=function(m,l,n){j.Object3D.call(this);this.element=m?m:document.createElement("div");this.element.renderable=this;this.element.style.position="absolute";this.element.style.pointerEvents="auto";this.position=l?l:(this.position?this.position:new j.Vector3());this.pickable=true;this.geometry=new j.Geometry();this.geometry.boundingSphere=new j.Sphere();this.offset=n?n:(this.offset?this.offset:new j.Vector2())};j.CSS2DNode.prototype=Object.create(j.Object3D.prototype);j.Scene_backup=j.Scene.prototype.constructor;j.Scene_backup_proto=j.Scene.prototype;j.Scene=function(){j.Scene_backup.call(this);this.isBackground=false;this.colorHighlight=null;this.initWebGLObjectFrameIndex=-1;this.__webglObjects=null;this.__webglObjectsAll=null;this.__webglObjectsToDraw=null;this.__webglObjectsSharedToInit=null;this.__webglObjectsImmediate=null;this.__webglSprites=null;this.__webglFlares=null;this.renderResultIndices=null};j.Scene.prototype=j.Scene_backup_proto;j.Scene.prototype.constructor=j.Scene;j.DisplayList=function(l){this.name="";this.active=true;this.priority=0;this.zSort=j.FrontToBack;this.side=j.DoubleSide;this.clearDepth=false;this.clearStencil=false;this.useStencil=false;this.pickingPriority=false;this.depthTest=true;this.depthWrite=true;this.depthFunc=null;this.polygonOffset=false;this.polygonOffsetFactor=1;this.polygonOffsetUnits=1;this.setValues(l);this._materialList=[];this.usefulListLength=0;this._displayRangeLists={};this.hasTranspar=false;this.index=-1};j.DisplayList.prototype.addDrawable=function(s,J,r,E,B,l,p,w,G,t,A,H,z,n){var v=null;var m=s.id;if(J&&J.occurrenceRenderingOverride){v=J.occurrenceRenderingOverride;m=m+"#"+v.id}var C=this._displayRangeLists[m];if(!C){C=this._displayRangeLists[m]=new j.DisplayRangeList(s,v)}var I=false;if(s.isWideLine||s.is2DLine){if(!G){if(r&&!r.vertexIndexArray){console.warn("ComputeWideLine unavailable, make sure noMeshInRAM is inactive");return false}if(!s.pixelSize){s.pixelSize=new j.Vector2()}s.pixelSize.x=2/H.width;s.pixelSize.y=2/H.height;if(A.fullWidth&&A.pickingRatioW){s.pixelSize.x/=A.pickingRatioW;s.pixelSize.y/=A.pickingRatioH}var F=r.computeWideLine(E,s);if(r.wideLines){r.wideLines.addEventListener("dispose",t);if(s.isDashedLine){if(s.isCPUPattern){var y;if(!J.isLargeScale){J._modelViewMatrix._multiplyDoubleMatricesMV(A.matrixWorldInverse,J.matrixWorld);J._programID=J._programID|j.ProgramIDs.LARGE_SCALE;J.isLargeScale=true}y=J._modelViewMatrix;if(J._ratioData&&J._ratioData.ratio>0){y=new j.Matrix4().multiplyMatrices(A.matrixWorldInverse,J._getMMMatrix())}r.wideLines.computePixelWideLineDistances(y,A.projectionMatrix,H,z)}else{if(r.wideLines.cpuPatternMode||!r.wideLines.vertexLineDistancesArray){r.wideLines.computeWideLineDistances()}}}}if(B===E){B=F}else{var o=F.primitives[B.primitiveStart];var x=F.primitives[B.primitiveStart+B.primitiveCount-1];if(o&&x){B={start:o.start,count:x.start-o.start+x.count};var q=F.primitives[0];if(q.start!==F.start){B.start+=F.start}}}I=C.add(J,r.wideLines,F,B,l,p,w,G,n)}}else{if(s.isDashedLine&&!s.is2DLine){if(!s.pixelSize){s.pixelSize=new j.Vector2()}s.pixelSize.x=2/H.width;s.pixelSize.y=2/H.height;if(s.isCPUPattern){var y;if(!J.isLargeScale){J._modelViewMatrix._multiplyDoubleMatricesMV(A.matrixWorldInverse,J.matrixWorld);J._programID=J._programID|j.ProgramIDs.LARGE_SCALE;J.isLargeScale=true}y=J._modelViewMatrix;if(J._ratioData&&J._ratioData.ratio>0){y=new j.Matrix4().multiplyMatrices(A.matrixWorldInverse,J._getMMMatrix())}r.computePixelLineDistances(y,A.projectionMatrix,H,z)}else{if(r.cpuPatternMode||!r.vertexLineDistancesArray||r.vertexLayout.vertexPositionArray.needsUpdate){if(r&&!r.vertexIndexArray){console.warn("computeLineDistance unavailable, make sure noMeshInRAM is inactive");return false}r.computeLineDistances()}}}I=C.add(J,r,E,B,l,p,w,G,n)}if(I){var D=this._materialList;var u={material:s,occurrenceRenderingOverride:v,id:m,occurrenceRenderingOverrideId:(v?v.id:-1)};D[this.usefulListLength++]=u}};j.DisplayList.prototype.init=function(){this.usefulListLength=0;this._displayRangeLists={}};j.DisplayList.prototype.finalize=function(){};j.DisplayList.prototype.setValues=function(l){if(l===undefined){return}for(var m in l){var n=l[m];if(n===undefined){console.warn("THREE.DisplayList: '"+m+"' parameter is undefined.");continue}if(m in this){this[m]=n}}};j.DisplayRangeList=function(m,l){this.material=m;this.occurrenceRenderingOverride=l;this.first=null;this.last=null;this._sortCount=0};j.DisplayRangeList.prototype.add=function(r,w,x,y,z,u,s,A,p){var o=false;var m=true;if(this._sortCount<u){this._sortCount=u;this.first=null;this.last=null;o=true}var t=z?z._gssoMask:j.RenderMode.defaultMask;if(x){var q=x._geomType&&x._geomType&h.SurfacicPointRenderPointMask;m=(x._geomType&t)||!x._geomType;if(m&&q){var l=p===j.MaterialToUse.pickingMaterial||p===j.MaterialToUse.highlightMaterial||p===j.MaterialToUse.preHighlightMaterial;m=l}if(A){if(x.glType===0||x.glType===1||(x._geomType&j.RenderMode.pointsMask)||(x._geomType&j.RenderMode.linesMask)){m=false}else{if(r._bodyDim===0&&x.gas&&x.gas.side===j.DoubleSide){m=false}else{if(r&&r._bodyDim!==0&&r._bodyDim!==3){m=false}}}}if(!x.cullingData){if(m&&x.glType===1&&this.last){var v=this.last;if((v[1]===w)&&(v[2].glType===x.glType)&&(v[3]+v[4]===y.start)){v[4]+=y.count;m=false}}}}if(m){var n=null;if(x){n=s.get5(r,w,x,y.start,y.count)}else{n=s.get2(r,w)}n.next=null;if(this.first===null){this.first=this.last=n}else{this.last.next=n;this.last=n}}return o};j.Ray_backup=j.Ray;j.Ray=function(W,D){j.Ray_backup.call(this,W,D);var Z=0.0001;var m=0;var P=0;var ag=new j.Vector3();var ae=new j.Vector3();var ad=new j.Vector3();var ab=new j.Vector3();var aa=new j.Vector3();var Y=new j.Vector3();var w=new j.Vector3();var s=new j.Vector3();var r=new j.Vector3();var y=new j.Vector3();var x=new j.Vector3();var t=new j.Vector3();var H=new j.Vector3();var G=new j.Vector3();var X=new j.Vector3();var Q=new j.Vector3();var q=new j.Vector3();var l=new j.Vector3();var ac=new j.Vector3();var n=new j.Vector3();var U=new j.Vector3();var I=new j.Vector3();var K=new j.Matrix4();var ak=new j.Vector3(),ai=new j.Vector3(),af=new j.Vector3();var ah,L,J;function o(v,am,u){ak.subVectors(u,v);ah=ak.dot(am);L=ai.addVectors(v,af.copy(am).multiplyScalar(ah));J=u.distanceTo(L);return J}function A(an,am,v,u){ak.subVectors(v,an.origin);ah=ak.dot(an.direction);var ap=ai.addVectors(W,af.copy(an.direction).multiplyScalar(ah));ak.subVectors(v,am.origin);ah=ak.dot(am.direction);var ao=ai.addVectors(W,af.copy(am.direction).multiplyScalar(ah));if((ap.x<v-u)&&(ap.y>v+u)&&(ao.x>v+u)&&(ao.y<v-u)){return true}return false}var O,N,M,F,E,aj,z,T,S;function C(am,v,u,an){ak.subVectors(an,v);ai.subVectors(u,v);af.subVectors(am,v);O=ak.dot(ak);N=ak.dot(ai);M=ak.dot(af);F=ai.dot(ai);E=ai.dot(af);aj=O*F-N*N;if(aj<1e-10){return false}z=1/aj;T=(F*M-N*E)*z;S=(O*E-N*M)*z;return(T>=0)&&(S>=0)&&(T+S<1)}function V(at,ay,aw){var az=at.direction;var ax=new j.Vector3().subVectors(aw,ay);var av=new j.Vector3().subVectors(at.origin,ay);var au=az.lengthSq();var ar=az.dot(ax);var aq=ax.lengthSq();var ap=az.dot(av);var ao=ax.dot(av);var am=au*aq-ar*ar;var an=0;if(am<1e-7){an=(ar>aq)?ap/ar:ao/aq}else{an=(au*ao-ar*ap)/am}return ax.multiplyScalar(an).add(ay)}function p(an,am,v){var u=new j.Vector3();u.x=an.x+S*(am.x-an.x)+T*(v.x-an.x);u.y=an.y+S*(am.y-an.y)+T*(v.y-an.y);u.z=an.z+S*(am.z-an.z)+T*(v.z-an.z);return u}function B(an,am,au,u,aF,aG){var aH=aF;var ao=0.5;if(window.devicePixelRatio){ao*=window.devicePixelRatio}var aJ=ao*m;var aI=ao*P;t.copy(au);t.x=(t.x+1)*aJ;t.y=(t.y+1)*aI;w.copy(an);s.copy(am);w.applyMatrix4(u);s.applyMatrix4(u);y.copy(w);x.copy(s);y.applyProjection(K);x.applyProjection(K);var aC=y.z>1;var ap=x.z>1;if(aC||ap){var ay=aG._viewpoint._frustum;var v=(w.dot(ay.planes[5].normal)+ay.planes[5].constant<0);var az=(s.dot(ay.planes[5].normal)+ay.planes[5].constant<0);if(v&&az){return false}else{if(v||az){var aA=new j.Line3(w,s);var aE=ay.planes[5].intersectLine(aA);if(v){y.copy(aE);y.applyProjection(K)}else{x.copy(aE);x.applyProjection(K)}}}}y.x=(y.x+1)*aJ;y.y=(y.y+1)*aI;x.x=(x.x+1)*aJ;x.y=(x.y+1)*aI;H.subVectors(x,y);G.subVectors(t,y);var aD=G.x*H.x+G.y*H.y;if(aD<1){return false}var ax=H.x*H.x+H.y*H.y;var ar=Math.sqrt(ax);var aq=aH.length/ar;aq*=ax;if((aD<-aq)||(aD>ax+aq)){return false}var aB=aD/ax;var av=y.x+aB*H.x;var at=y.y+aB*H.y;var aw=Math.sqrt((av-t.x)*(av-t.x)+(at-t.y)*(at-t.y));if(aw>aH.norm||aw<-aH.norm){return false}return true}function R(aq,am,ao,an){var ap=Infinity;var v=0.01;w.copy(ag);s.copy(am);w.applyMatrix4(an);var u=new j.Matrix4();u.getInverse(ao);s.applyMatrix4(u);s.applyMatrix4(an);if((w.z>(s.z-v))&&(w.z<(s.z+v))){H.subVectors(w,s);ap=Math.sqrt(H.x*H.x+H.y*H.y)}return ap}function al(ar,ap,at,aq){var v=96;var am=aq/v;if(window.devicePixelRatio){v*=window.devicePixelRatio}var ao=0.5*m/v;var an=0.5*P/v;r.copy(ap);r.x*=ao;r.y*=an;w.copy(ar);w.applyMatrix4(at);y.copy(w);y.applyProjection(K);y.x*=ao;y.y*=an;H.subVectors(r,y);var u=Math.sqrt(H.x*H.x+H.y*H.y);if(u>am){return false}return true}this.computeShortestPointToLine=function(v,u){return V(this,v,u)};this.intersectMeshInstances=function(aW,ay,az,aB,aE,an,aq,aR,u,aL,aD,ap){var aS=ap!==undefined?ap:true;var aT,aY;aD=aD||["main","noz","afterHighlightNoZ"];var aF=aW.object;var a1=aW.type;if(a1!==undefined){aB=(aB&&(a1==2));aE=(aE&&(a1==1));an=(an&&(a1==0))}if(aF instanceof j.Mesh){aT=[{object:aF}]}else{aT=[];for(aY=0;aY<aD.length;aY++){aT=aT.concat(aF.getWebGLObjects(aD[aY],0))}}var aG,aQ,at=[];m=aq;P=aR;ay.matrixWorldInverse.getInverse(ay.matrixWorld);K.multiplyMatrices(ay.projectionMatrix,ay.matrixWorldInverse);var aI=u*window.devicePixelRatio;var av=1.4142135623730951;for(aY=0,aG=aT.length;aY<aG;aY++){if(aT[aY]===null){continue}aQ=aT[aY].object;var aM=true;if(aQ.visibilityFree){aM=aQ.visible}else{aM=aS?aQ.visible:!aQ.visible}if(aM){if((aQ.pickable!==undefined)&&!aQ.pickable){continue}var am=new j.Vector3();if(aQ.geometry.boundingSphere!==null){am.copy(aQ.geometry.boundingSphere.center)}var ar=aQ._getMMMatrix();am.applyMatrix4(ar);var aA=o(this.origin,this.direction,am);var aH=ar.getMaxScaleOnAxis();var aw=0;if(aR!=undefined){var aX=0;var v=0;var au=null;var ao=0;if(aQ.geometry.length>=0){au=aQ.geometry[0];ao=aQ.geometry.length}else{if(aQ.geometry._type===2){au=aQ.geometry;ao=1}}for(var ax=0;ax<ao;ax++){var aC=au.drawingGroups;for(var aV=0,aK=aC.length;aV<aK;aV++){var aO=aC[aV];if(aO.gas){var aN;if(aO.gas.isGAS&&(aO.glType===0)){aN=aO.gas.getPointSize()}else{if((aO.gas instanceof j.ParticleBasicMaterial)&&aO.gas.size){aN=aO.gas.size}}if(aN>v){v=aN}}else{if(aO.material&&(aO.material instanceof j.ParticleBasicMaterial)&&aO.material.size){if(aO.material.size>v){v=aO.material.size}}}}}aX+=v;aw=ay.getWorldSizeFromPixelSize(aX,am,P)}var aP=ay.getWorldSizeFromPixelSize(aI,am,P);if(aA<=aQ.geometry.boundingSphere.radius*aH+aw*av/2+aP*av){if(aB){var aU;if((aQ.geometry._type===2)||(aQ.geometry.length>=0)){aU=this.intersectBufferGeomOptim(ay,az,aQ);if(aU.length){if(!aU[0].point&&aW.point){aU[0].point=aW.point}if(!aU[0].normal&&aW.normal){aU[0].normal=aW.normal}}}else{var aJ=new j.Raycaster(this.origin,this.direction,ay.near,ay.far);aU=aJ.intersectObject(aQ,false);if(aU.length){if(!aU[0].point&&aW.point){aU[0].point=aW.point}if(!aU[0].normal&&aW.normal){aU[0].normal=aW.normal}}}at=at.concat(aU)}if(aE){var a0=this.intersectBufferGeomEdge(az,aQ,u,ay);if(a0.length){if(!a0[0].point&&aW.point){a0[0].point=aW.point}if(!a0[0].normal&&aW.normal){a0[0].normal=aW.normal}}at=at.concat(a0)}if(an){var aZ=this.intersectBufferGeomPoint(az,aQ,ay,aW.point,u,aL);if(aZ.length){if(!aZ[0].point&&aW.point){aZ[0].point=aW.point}if(!aZ[0].normal&&aW.normal){aZ[0].normal=aW.normal}}at=at.concat(aZ)}}}}at.sort(function(a3,a2){return a3.distance-a2.distance});if(!at.length){at.push({})}return at};this.intersectMeshInstancesZones3D=function(aG,aE,aq,au,av,aC,aF,aI,az,ao,aK,aB,at,ar){var ax,aD;var aJ=ar!==undefined?ar:true;if(aG instanceof j.Mesh){ax=[{object:aG}]}else{ax=[];for(aD=0;aD<aB.length;aD++){ax=ax.concat(aG.getWebGLObjects(aB[aD],0))}}var aw,aL,u=[];m=ao;P=aK;aE.matrixWorldInverse.getInverse(aE.matrixWorld);K.multiplyMatrices(aE.projectionMatrix,aE.matrixWorldInverse);for(aD=0,aw=ax.length;aD<aw;aD++){if(ax[aD]===null){continue}aL=ax[aD].object;var an=true;if(aL.visibilityFree){an=aL.visible}else{an=aJ?aL.visible:!aL.visible}if(an){if((aL.pickable!==undefined)&&!aL.pickable){continue}var ay=new j.Sphere();if(aL.geometry.boundingSphere!==null){ay.copy(aL.geometry.boundingSphere)}var ap=aL._getMMMatrix();ay.center.applyMatrix4(ap);if(av.intersectsSphere(ay)){var aM=[];if(!at&&!aC){aM=this.intersectBufferGeom3DInsideFrustumMesh(av,aL,aF,aI,az)}else{var am=["faces","edges","points"];for(var v=0;v<3;v++){var aH=[];if(am[v]==="faces"&&aF){if((aL.geometry._type===2)||(aL.geometry.length>=0)){aH=this.intersectBufferGeomZone3D(aE,av,aL,aC,at,aF)}else{var aA=new j.Raycaster(this.origin,this.direction,aE.near,aE.far);aH=aA.intersectObject(aL,false)}}else{if(am[v]==="edges"&&aI){aH=this.intersectBufferGeomEdge3D(av,aL,aC,at,aI)}else{if(am[v]==="points"&&az){aH=this.intersectBufferGeomPoint3D(av,aL,az)}}}if(aC){aM=aM.concat(aH)}else{if(!at&&!aH.length){break}if(!aM.length&&aH.length){aM=aM.concat(aH)}if(at&&aM.length>0){break}}}}if(aM){u=u.concat(aM)}}}}if(!u.length){u.push({})}return u};this.intersectBufferGeomOptim=function(aE,aK,aQ){var an=(aE!==null)?aE.near:0;var aL,az=[];var ay=aQ._getMMMatrix();var ax=new j.Matrix4().getInverse(ay);aQ.matrixRotationWorld.extractRotation(ay);var aq=new j.Ray().copy(this).applyMatrix4(ax);var ar=new j.Vector3();var aX,aW,aV,aM,aT,u,aU,aA,aP,aY,aN;var aB=null;var aS=0;if(aQ.geometry.length>=0){aB=aQ.geometry[0];aS=aQ.geometry.length}else{if(aQ.geometry._type===2){aB=aQ.geometry;aS=1}}if(aB&&!aB.vertexIndexArray){aL={distance:0,primitive:true,object:aQ,point:null,normal:null};az.push(aL);return az}for(aX=0;aX<aS;aX++){var aJ=aB.drawingGroups;var ao=aB.vertexIndexArray;var aO=aB.vertexUvArray?aB.vertexUvArray:null;for(aV=0,aM=aJ.length;aV<aM;aV++){aP=aJ[aV];if((aP.glType!=4)&&(aP.glType!=5)){continue}var aR=null;if(aQ.layer){aR=aQ.layer.getIntervals(aB,aP)}aA=aP.primitives.length;for(aU=0;aU<aA;aU++){var aD=aP.primitives[aU];var am=aD.boundingSphere?aD.boundingSphere:(aD.rep?aD.rep.boundingSphere:null);if(am){ar.set(am.center[0],am.center[1],am.center[2]);var aH=o(aq.origin,aq.direction,ar);if(aH>am.radius){continue}}if(aR!==null){var v=false;for(aW=aR.length-1;aW>=0;aW--){if(aR[aW].start<=aD.start){if(aR[aW].layerNum<=0){v=true}break}}if(v){continue}}u=aD.start+aD.count;for(aT=aD.start;aT<u;((aP.glType===4)?aT+=3:aT++)){l.copy(aq.origin);ac.copy(aq.direction);var av,au,at;if(aP.nonIndexed){av=aT;au=aT+1;at=aT+2}else{av=ao[aT];au=ao[aT+1];at=ao[aT+2]}aB.getVertexPosition(ag,av);aB.getVertexPosition(ae,au);aB.getVertexPosition(ad,at);aB.getVertexNormal(ab,av);aB.getVertexNormal(aa,au);aB.getVertexNormal(Y,at);av*=3;au*=3;at*=3;Q.addVectors(ag,ae);Q.add(ad);Q.multiplyScalar(0.3333333);q.addVectors(ab,aa);q.add(Y);q.multiplyScalar(0.3333333);n=Q.sub(l);aY=ac.dot(q);if(Math.abs(aY)<Z){continue}aN=q.dot(n)/aY;if(aN>=0){I.addVectors(l,ac.multiplyScalar(aN));if(C(I,ag,ae,ad)){var ap=null;if(aO){var aI=new j.Vector3(aO[av],aO[av+1],aO[av+2]);var aG=new j.Vector3(aO[au],aO[au+1],aO[au+2]);var aF=new j.Vector3(aO[at],aO[at+1],aO[at+2]);ap=p(aI,aG,aF)}var aC=I.barycentricCoordinates(ag,ae,ad);ab.multiplyScalar(aC.alpha);aa.multiplyScalar(aC.beta);Y.multiplyScalar(aC.gamma);q.addVectors(ab,aa);q.add(Y);q.multiplyScalar(aC.normalisationFactor);q.normalize();var aw=I.clone().applyMatrix4(ay);aL={distance:this.origin.distanceTo(aw),point:aw,normal:q.clone().applyMatrix4(aQ.matrixRotationWorld),tangent:null,uv:ap,primitive:aD,geometry:aB,object:aQ};az.push(aL)}}}}}aB=aQ.geometry[aX+1]}return az};this._castRayIntoBufferGeom=function(aS,am){var aQ,v=[];var aq=aS._getMMMatrix();var ax=new j.Matrix4().getInverse(aq);aS.matrixRotationWorld.extractRotation(aq);var an=new j.Ray().copy(this).applyMatrix4(ax);var aK,aJ,aE,az,aB,ap,aC,aO,av,aF,aT;var ar=null;var aL=0;if(aS.geometry.length>=0){ar=aS.geometry[0];aL=aS.geometry.length}else{if(aS.geometry._type===2){ar=aS.geometry;aL=1}}if(ar&&!ar.vertexIndexArray){aQ={distance:0,primitive:true,object:aS,point:null,normal:null};v.push(aQ);return v}for(aK=0;aK<aL;aK++){var au=ar.drawingGroups;var at=ar.vertexIndexArray;var ay=ar.vertexUvArray?ar.vertexUvArray:null;for(aE=0,az=au.length;aE<az;aE++){av=au[aE];if((av.glType!=4)&&(av.glType!=5)){continue}var aw=null;if(aS.layer){aw=aS.layer.getIntervals(ar,av)}aO=av.primitives.length;for(aC=0;aC<aO;aC++){var ao=av.primitives[aC];if(aw!==null){var aD=false;for(aJ=aw.length-1;aJ>=0;aJ--){if(aw[aJ].start<=ao.start){if(aw[aJ].layerNum<=0){aD=true}break}}if(aD){continue}}ap=ao.start+ao.count;for(aB=ao.start;aB<ap;((av.glType===4)?aB+=3:aB++)){l.copy(an.origin);ac.copy(an.direction);var aI=at[aB];var aH=at[aB+1];var aG=at[aB+2];ar.getVertexPosition(ag,aI);ar.getVertexPosition(ae,aH);ar.getVertexPosition(ad,aG);ar.getVertexNormal(ab,aI);ar.getVertexNormal(aa,aH);ar.getVertexNormal(Y,aG);aI*=3;aH*=3;aG*=3;Q.addVectors(ag,ae);Q.add(ad);Q.multiplyScalar(0.3333333);q.addVectors(ab,aa);q.add(Y);q.multiplyScalar(0.3333333);n=Q.sub(l);aF=ac.dot(q);if(Math.abs(aF)<Z){continue}aT=q.dot(n)/aF;if(aT>=0){I.addVectors(l,ac.multiplyScalar(aT));if(C(I,ag,ae,ad)){if(am){aQ={object:aS,geometry:ar};v.push(aQ);return v}var aA=null;if(ay){var aP=new j.Vector3(ay[aI],ay[aI+1],ay[aI+2]);var aN=new j.Vector3(ay[aH],ay[aH+1],ay[aH+2]);var aM=new j.Vector3(ay[aG],ay[aG+1],ay[aG+2]);aA=p(aP,aN,aM)}var aR=I.barycentricCoordinates(ag,ae,ad);ab.multiplyScalar(aR.alpha);aa.multiplyScalar(aR.beta);Y.multiplyScalar(aR.gamma);q.addVectors(ab,aa);q.add(Y);q.multiplyScalar(aR.normalisationFactor);q.normalize();var u=I.clone().applyMatrix4(aq);aQ={distance:this.origin.distanceTo(u),point:u,normal:q.clone().applyMatrix4(aS.matrixRotationWorld),tangent:null,uv:aA,primitive:ao,geometry:ar,object:aS};v.push(aQ)}}}}}ar=aS.geometry[aK+1]}return v};this.intersectBufferGeom3DInsideFrustumMesh=function(at,aJ,aH,aI,ay){var au=aH+aI+ay;var aw=false;var aG,u=[];var aD,aC,aB,av,ax,am,az,aF,aq;var an=null;var aE=0;if(aJ.geometry.length>=0){an=aJ.geometry[0];aE=aJ.geometry.length}else{if(aJ.geometry._type===2){an=aJ.geometry;aE=1}}for(aD=0;aD<aE;aD++){var ap=an.drawingGroups;var ao=an.vertexIndexArray;for(aB=0,av=ap.length;aB<av;aB++){aq=ap[aB];if(aq._geomType&&!(aq._geomType&au)){continue}var ar=null;if(aJ.layer){ar=aJ.layer.getIntervals(an,aq)}aF=aq.primitives.length;for(az=0;az<aF;az++){var v=aq.primitives[az];if(ar!==null){var aA=false;for(aC=ar.length-1;aC>=0;aC--){if(ar[aC].start<=v.start){if(ar[aC].layerNum<=0){aA=true}break}}if(aA){continue}}am=v.start+v.count;for(ax=v.start;ax<am;ax++){aw=true;an.getVertexPosition(ag,ao[ax]);w.copy(ag);w.applyMatrix4(aJ._getMMMatrix());if(!at.containsPoint(w)){return null}}}}an=aJ.geometry[aD+1]}if(aw){u.push({object:aJ})}else{return null}return u};this.intersectBufferGeomZone3D=function(aK,ay,aR,aG,av,aN){var aQ=(aK!==null)?aK.near:0;var aM,u=[];var an=aR._getMMMatrix();var aw=new j.Matrix4().getInverse(an);aR.matrixRotationWorld.extractRotation(an);var aI,aH,aF,aA,aB,am,aC,aL,at,aE,aS,ax;var ap=null;var aJ=0;if(aR.geometry.length>=0){ap=aR.geometry[0];aJ=aR.geometry.length}else{if(aR.geometry._type===2){ap=aR.geometry;aJ=1}}if(ap.noMeshInRAM||!ap.vertexIndexArray){return u}if(!aG){ax=!av}var aO=new j.Sphere();for(aI=0;aI<aJ;aI++){var ar=ap.drawingGroups;var aq=ap.vertexIndexArray;var az=ap.vertexUvArray?ap.vertexUvArray:null;for(aF=0,aA=ar.length;aF<aA;aF++){at=ar[aF];if((at.glType!=4)&&(at.glType!=5)){continue}if(at._geomType&&!(at._geomType&aN)){continue}var au=null;if(aR.layer){au=aR.layer.getIntervals(ap,at)}aL=at.primitives.length;for(aC=0;aC<aL;aC++){if(aG&&!av){ax=true}var v=at.primitives[aC],aP;if(aG&&v.boundingSphere){aP=v.boundingSphere.center;aO.center.set(aP[0],aP[1],aP[2]);aO.radius=v.boundingSphere.radius*an.getMaxScaleOnAxis();aO.center.applyMatrix4(an);if(!ay.intersectsSphere(aO)){continue}}if(au!==null){var aD=false;for(aH=au.length-1;aH>=0;aH--){if(au[aH].start<=v.start){if(au[aH].layerNum<=0){aD=true}break}}if(aD){continue}}am=v.start+v.count;for(aB=v.start;aB<am;aB++){ap.getVertexPosition(ag,aq[aB]);ap.getVertexPosition(ae,aq[aB+1]);ap.getVertexPosition(ad,aq[aB+2]);w.copy(ag);s.copy(ae);r.copy(ad);w.applyMatrix4(an);s.applyMatrix4(an);r.applyMatrix4(an);if(av){var ao=new j.Sphere();ao.setFromCenterAndPoints(new j.Vector3((w.x+s.x+r.x)/3,(w.y+s.y+r.y)/3,(w.z+s.z+r.z)/3),[w,s,r]);if(ay.intersectsSphere(ao)&&ay.intersectsTriangle([w,s,r])){if(aG){aM={primitive:v,geometry:ap,object:aR};u.push(aM)}else{ax=true}break}}else{if(!(ay.containsPoint(w)&&ay.containsPoint(s)&&ay.containsPoint(r))){ax=false;break}}if(at.glType==4){aB+=2}}if(aG&&!av&&ax){aM={primitive:v,geometry:ap,object:aR};u.push(aM)}else{if(!aG&&av&&u.length){break}}}if(!aG&&((av&&ax)||(!av&&!ax))){break}}if(!aG&&((av&&ax)||(!av&&!ax))){break}ap=aR.geometry[aI+1]}if(!aG&&ax){u.push({object:aR})}return u};this.intersectBufferGeomEdge=function(at,aP,aN,aK){var u=0.99;var aJ={norm:0,length:0};if(aP.material&&aP.material.lineWidth&&aP.material.lineWidth>1){if(aP.material.lineWidth<aN*2){aJ.length=aN+1}else{aJ.length=aP.material.lineWidth/2}}else{aJ.length=aN+1}aJ.norm=Math.sqrt(2*(aJ.length)*(aJ.length));var ar=new j.Vector3();var aM,v=[];var aq=aP._getMMMatrix();var aH,aG,aD,az,aA,ap,aB,aL,ax;var au=null;var aI=0;if(aP.geometry.length>=0){au=aP.geometry[0];aI=aP.geometry.length}else{if(aP.geometry._type===2){au=aP.geometry;aI=1}}if(au&&!au.vertexIndexArray){aM={distance:0,primitive:true,object:aP,point:null,normal:null};v.push(aM);return v}for(aH=0;aH<aI;aH++){var aw=au.drawingGroups;var av=au.vertexIndexArray;for(aD=0,az=aw.length;aD<az;aD++){ax=aw[aD];if(ax.glType!=1){continue}var ay=null;if(aP.layer){ay=aP.layer.getIntervals(au,ax)}aL=ax.primitives.length;for(aB=0;aB<aL;aB++){var an=ax.primitives[aB];var am=an.boundingSphere?an.boundingSphere:(an.rep?an.rep.boundingSphere:null);if(am){ar.set(am.center[0],am.center[1],am.center[2]);ar.applyMatrix4(aq);var ao=o(this.origin,this.direction,ar);var aO=aq.getMaxScaleOnAxis();if(ao>am.radius*aO){continue}}if(ay!==null){var aC=false;for(aG=ay.length-1;aG>=0;aG--){if(ay[aG].start<=an.start){if(ay[aG].layerNum<=0){aC=true}break}}if(aC){continue}}ap=an.start+an.count;for(aA=an.start;aA<ap;aA+=2){if(ax.nonIndexed){au.getVertexPosition(ag,aA);au.getVertexPosition(ae,aA+1)}else{au.getVertexPosition(ag,av[aA]);au.getVertexPosition(ae,av[aA+1])}if(B(ag,ae,at,aq,aJ,aK)){var aF=V(this,w,s);var aE=this.origin.distanceTo(aF);aM={distance:Math.max(0,u*aE),point:aF.clone(),normal:null,tangent:new j.Vector3().subVectors(aF,w).normalize(),primitive:an,geometry:au,object:aP};v.push(aM);break}}}}au=aP.geometry[aH+1]}return v};this.intersectBufferGeomEdge3D=function(ax,aM,aE,av,aL){var u=0.99;var aK,v=[];var ao=aM._getMMMatrix();var aH,aG,aC,ay,az,an,aA,aJ,at,aw;var ap=null;var aI=0;if(aM.geometry.length>=0){ap=aM.geometry[0];aI=aM.geometry.length}else{if(aM.geometry._type===2){ap=aM.geometry;aI=1}}if(ap.noMeshInRAM||!ap.vertexIndexArray){return v}if(!aE){aw=!av}for(aH=0;aH<aI;aH++){var ar=ap.drawingGroups;var aq=ap.vertexIndexArray;for(aC=0,ay=ar.length;aC<ay;aC++){at=ar[aC];if(at.glType!=1){continue}if(at._geomType&&!(at._geomType&aL)){continue}var au=null;if(aM.layer){au=aM.layer.getIntervals(ap,at)}aJ=at.primitives.length;for(aA=0;aA<aJ;aA++){if(aE){aw=true}var am=at.primitives[aA];if(au!==null){var aB=false;for(aG=au.length-1;aG>=0;aG--){if(au[aG].start<=am.start){if(au[aG].layerNum<=0){aB=true}break}}if(aB){continue}}an=am.start+am.count;for(az=am.start;az<an;az+=2){ap.getVertexPosition(ag,aq[az]);ap.getVertexPosition(ae,aq[az+1]);w.copy(ag);s.copy(ae);w.applyMatrix4(ao);s.applyMatrix4(ao);if(av){if(ax.intersectsLine([w,s])){if(aE){var aF=V(this,w,s);var aD=this.origin.distanceTo(aF);aK={distance:Math.max(0,u*aD),point:aF.clone(),normal:null,tangent:new j.Vector3().subVectors(aF,w).normalize(),primitive:am,geometry:ap,object:aM};v.push(aK)}else{aw=true}break}}else{if(!(ax.containsPoint(w)&&ax.containsPoint(s))){aw=false;break}}}if(aE&&!av&&aw){aK={primitive:am,geometry:ap,object:aM};v.push(aK)}else{if(!aE&&av&&v.length){break}}}if(!aE&&((av&&aw)||(!av&&!aw))){break}}if(!aE&&((av&&aw)||(!av&&!aw))){break}ap=aM.geometry[aH+1]}if(!aE&&aw){v.push({object:aM})}return v};this._castRayIntoBufferGeomEdge=function(aK,an,am){var u=0.99;var aJ,v=[];var aq=aK._getMMMatrix();var aG,aF,aC,ay,az,ap,aA,aI,av;var ar=null;var aH=0;if(aK.geometry.length>=0){ar=aK.geometry[0];aH=aK.geometry.length}else{if(aK.geometry._type===2){ar=aK.geometry;aH=1}}if(ar&&!ar.vertexIndexArray){aJ={distance:0,primitive:true,object:aK,point:null,normal:null};v.push(aJ);return v}for(aG=0;aG<aH;aG++){var au=ar.drawingGroups;var at=ar.vertexIndexArray;for(aC=0,ay=au.length;aC<ay;aC++){av=au[aC];if(av.glType!=1){continue}var aw=null;if(aK.layer){aw=aK.layer.getIntervals(ar,av)}aI=av.primitives.length;for(aA=0;aA<aI;aA++){var ao=av.primitives[aA];if(aw!==null){var aB=false;for(aF=aw.length-1;aF>=0;aF--){if(aw[aF].start<=ao.start){if(aw[aF].layerNum<=0){aB=true}break}}if(aB){continue}}ap=ao.start+ao.count;for(az=ao.start;az<ap;az+=2){ar.getVertexPosition(ag,at[az]);ar.getVertexPosition(ae,at[az+1]);w.copy(ag);s.copy(ae);w.applyMatrix4(aq);s.applyMatrix4(aq);var aE=new j.Vector3();var ax=this.distanceSqToSegment(w,s,null,aE);if(ax<an*an){if(am){aJ={object:aK,geometry:ar};v.push(aJ);return v}var aD=this.origin.distanceTo(aE);aJ={distance:Math.max(0,u*aD),point:aE.clone(),normal:null,tangent:new j.Vector3().subVectors(aE,w).normalize(),primitive:ao,geometry:ar,object:aK};v.push(aJ)}}}}ar=aK.geometry[aG+1]}return v};this.intersectBufferGeomPoint=function(ar,aT,aN,aP,aR,ao){var u=0.98;var aQ,v=[];var am=(aR+1)*Math.sqrt(2);var aM;var aq=aT._getMMMatrix();var aE=new j.Matrix4().multiplyMatrices(aN.matrixWorldInverse,aq);var aK,aJ,aH,aC,aD,ap,aF,aO,ay;var au=null;var aL=0;var ax=Infinity;var aB=ao;var aS=aP;if(!aS){aB=false}if(aT.geometry.length>=0){au=aT.geometry[0];aL=aT.geometry.length}else{if(aT.geometry._type===2){au=aT.geometry;aL=1}}if(au&&!au.vertexIndexArray){aQ={distance:0,primitive:true,object:aT,point:null,normal:null};v.push(aQ);return v}for(aK=0;aK<aL;aK++){var aw=au.drawingGroups;var av=au.vertexIndexArray;for(aH=0,aC=aw.length;aH<aC;aH++){ay=aw[aH];if(ay.glType!==0){continue}if(ay.gas){var aA;if(ay.gas.isGAS){aA=ay.gas.getPointSize()}else{if((ay.gas instanceof j.ParticleBasicMaterial)&&ay.gas.size){aA=ay.gas.size}}if(aA>(aR*2+1)){aM=aA*Math.sqrt(2)/2}else{aM=am}}else{aM=am}var az=null;if(aT.layer){az=aT.layer.getIntervals(au,ay)}aO=ay.primitives.length;for(aF=0;aF<aO;aF++){var an=ay.primitives[aF];if(az!==null){var aG=false;for(aJ=az.length-1;aJ>=0;aJ--){if(az[aJ].start<=an.start){if(az[aJ].layerNum<=0){aG=true}break}}if(aG){continue}}ap=an.start+an.count;for(aD=an.start;aD<ap;aD++){if(ay.nonIndexed){au.getVertexPosition(ag,aD)}else{au.getVertexPosition(ag,av[aD])}if(aB){var at=R(ag,aS,aq,aE);if(at<ax){ax=at;var aI=this.origin.distanceTo(w);aQ={distance:Math.max(0,u*aI),point:w.clone(),normal:null,primitive:an,geometry:au,object:aT}}}else{if(al(ag,ar,aq,aM)){var aI=this.origin.distanceTo(w);aQ={distance:Math.max(0,u*aI),point:w.clone(),normal:null,primitive:an,geometry:au,object:aT};v.push(aQ)}}}}}au=aT.geometry[aK+1]}if(aB&&aQ){v.push(aQ)}return v};this.intersectBufferGeomPoint3D=function(av,aI,ay){var u=0.98;var aH,v=[];var ao=aI._getMMMatrix();var aE,aD,aB,aw,ax,an,az,aG,at;var ap=null;var aF=0;if(aI.geometry.length>=0){ap=aI.geometry[0];aF=aI.geometry.length}else{if(aI.geometry._type===2){ap=aI.geometry;aF=1}}if(ap.noMeshInRAM||!ap.vertexIndexArray){return v}for(aE=0;aE<aF;aE++){var ar=ap.drawingGroups;var aq=ap.vertexIndexArray;for(aB=0,aw=ar.length;aB<aw;aB++){at=ar[aB];if(at.glType!==0){continue}if(at._geomType&&!(at._geomType&ay)){continue}var au=null;if(aI.layer){au=aI.layer.getIntervals(ap,at)}aG=at.primitives.length;for(az=0;az<aG;az++){var am=at.primitives[az];if(au!==null){var aA=false;for(aD=au.length-1;aD>=0;aD--){if(au[aD].start<=am.start){if(au[aD].layerNum<=0){aA=true}break}}if(aA){continue}}an=am.start+am.count;for(ax=am.start;ax<an;ax++){ap.getVertexPosition(ag,aq[ax]);w.copy(ag);w.applyMatrix4(ao);if(av.computeOutcode(w)===0){var aC=this.origin.distanceTo(w);aH={distance:Math.max(0,u*aC),point:w.clone(),normal:null,primitive:am,geometry:ap,object:aI};v.push(aH)}}}}ap=aI.geometry[aE+1]}return v};this._castRayIntoBufferGeomPoint=function(aJ,an,am){var u=0.98;var aI,v=[];var aq=aJ._getMMMatrix();var aF,aE,aC,ax,ay,ap,aA,aH,av;var ar=null;var aG=0;if(aJ.geometry.length>=0){ar=aJ.geometry[0];aG=aJ.geometry.length}else{if(aJ.geometry._type===2){ar=aJ.geometry;aG=1}}if(ar&&!ar.vertexIndexArray){aI={distance:0,primitive:true,object:aJ,point:null,normal:null};v.push(aI);return v}for(aF=0;aF<aG;aF++){var au=ar.drawingGroups;var at=ar.vertexIndexArray;for(aC=0,ax=au.length;aC<ax;aC++){av=au[aC];if(av.glType!==0){continue}var aw=null;if(aJ.layer){aw=aJ.layer.getIntervals(ar,av)}aH=av.primitives.length;for(aA=0;aA<aH;aA++){var ao=av.primitives[aA];if(aw!==null){var aB=false;for(aE=aw.length-1;aE>=0;aE--){if(aw[aE].start<=ao.start){if(aw[aE].layerNum<=0){aB=true}break}}if(aB){continue}}ap=ao.start+ao.count;for(ay=ao.start;ay<ap;ay++){ar.getVertexPosition(ag,at[ay]);w.copy(ag);w.applyMatrix4(aq);var az=this.distanceToPoint(w);if(az<an){if(am){aI={object:aJ,geometry:ar};v.push(aI);return v}var aD=this.origin.distanceTo(w);aI={distance:Math.max(0,u*aD),point:w.clone(),normal:null,primitive:ao,geometry:ar,object:aJ};v.push(aI)}}}}ar=aJ.geometry[aF+1]}return v}};j.Ray.prototype=j.Ray_backup.prototype;j.Ray.prototype.intersectPlaneInDir=function(l,n){var m=this.distanceToPlane(l);if((m===undefined)||(m<0)){return undefined}return this.at(m,n)};j.Mesh_backup=j.Mesh;j.Mesh=function(n,m,l){j.Mesh_backup.call(this,n,m);this.pickable=true;this.sceneGraph=null;this.highLight={primitives:[],nbSelected:[]};this.drawInHLRender=true;this.enableNormalDepth=true;this.visible=true;this.visibilityFree=false;this.layer=null;this.selectionGroups=null;this.outlinesGeometry=null;this.sectionLinesBuilder=null;this._bodyDim=0;this.hasPoint=false;this.renderPointsOnly=false;this._checkGeometry();this.boundingSphere=this.geometry.boundingSphere.clone();this.boundingBox=this.geometry.boundingBox.clone();this.geomWorldBE=[];this.__webglInit=false;this.__webglActive=null;this._modelViewMatrix=null;this._normalMatrix=null;this.render=true;this.z=0;this.renderLineMode=null;this._occurrence=null;this.pickingPriorityID=0;this.occurrenceRenderingOverride=null;this._centerZ=0;this.currentShadowMatrices=null;this.highlight=null;this.preHighlight=null;this._instancingInfos=null;this.clippingPlane=null;this.disableMirror=0;this._manipulators=undefined;this._3dxmlMaterial=null;this._gsso_cache=null;this.fromLoadedModel=false;this.compressedNormals=this.geometry.length&&n[0].compressedNormals;this.compressedVertices=this.geometry.length&&n[0].compressedVertices;this.materialMode=2;if(this.compressedVertices){this._programID=this._programID|j.ProgramIDs.COMPRESSED_VERTICES}if(this.compressedNormals){this._programID=this._programID|j.ProgramIDs.COMPRESSED_NORMALS}if(!l){window.sealWebVisuObjects&&Object.seal(this)}};j.Mesh.prototype=j.Mesh_backup.prototype;j.Mesh.prototype._isOutsideOrInsideVolume=function(o,p,l){var n=new j.Sphere();var m=this._getMMMatrix();if(this.boundingSphere!==null){n.copy(this.boundingSphere)}n.applyMatrix4(m);if(o.containsSphere(n)){l.push({object:this});return true}if(o.intersectsSphere(n)){return false}p.push({object:this});return true};j.Mesh.prototype._intersectVolume=function(q,m,v,w,n,s,t){if(this._isOutsideOrInsideVolume(q,s,n)){return}var r=this._getMMMatrix();var l=this.geometry;if(l._type===2){l=[l]}for(var p=0;p<l.length;p++){var u=l[p];var o=u._intersectVolume(this,q,m,v,w,r);switch(o){case 0:s.push({object:this});break;case 1:t.push({object:this});break;case 2:n.push({object:this});break;default:return}}return};Object.defineProperty(j.Mesh.prototype,"instanceAttribArrays",{get:function(){return this._instancingInfos?this._instancingInfos.instanceAttribArrays:null},set:function(l){if(this._instancingInfos){this._instancingInfos.instanceAttribArrays=l}}});Object.defineProperty(j.Mesh.prototype,"instancingSelectionMode",{get:function(){return this._instancingInfos?this._instancingInfos.instancingSelectionMode:""},set:function(l){if(this._instancingInfos){this._instancingInfos.instancingSelectionMode=l}}});Object.defineProperty(j.Mesh.prototype,"nbInstances",{get:function(){return this._instancingInfos?this._instancingInfos.nbInstances:-1},set:function(l){if(this._instancingInfos){this._instancingInfos.nbInstances=l}}});j.Mesh.prototype.copyInstancingInfos=function(l){if(this._instancingInfos){l._instancingInfos={isInstanceNode3D:this._instancingInfos.isInstanceNode3D,nbInstances:this._instancingInfos.nbInstances,instancingSelectionMode:this._instancingInfos.instancingSelectionMode,instanceAttribArrays:this._instancingInfos.instanceAttribArrays,pickedInstanceId:-1}}};j.Mesh.prototype.addRefVBO=function(){var n=null;var l=0;if(this.geometry.length>=0){n=this.geometry[0];l=this.geometry.length}else{if(this.geometry._type===2){n=this.geometry;l=1}}for(var m=0;m<l;m++){n.addRefVBO(this);n=this.geometry[m+1]}};j.Mesh.prototype.releaseVBO=function(){var n=null;var l=0;if(this.geometry.length>=0){n=this.geometry[0];l=this.geometry.length}else{if(this.geometry._type===2){n=this.geometry;l=1}}for(var m=0;m<l;m++){n.releaseVBO(this);n=this.geometry[m+1]}if(this.outlinesGeometry){this.outlinesGeometry.geometry&&this.outlinesGeometry.geometry.dispose()}};j.Mesh.prototype.dispose=function(){var n=null;var l=0;if(this.geometry.length>=0){n=this.geometry[0];l=this.geometry.length}else{if(this.geometry._type===2){n=this.geometry;l=1}}for(var m=0;m<l;m++){n.dispose();n=this.geometry[m+1]}};j.Mesh.prototype.computeTangents=function(o){var n=null;var l=0;if(this.geometry.length>=0){n=this.geometry[0];l=this.geometry.length}else{if(this.geometry._type===2){n=this.geometry;l=1}}for(var m=0;m<l;m++){n.computeTangents(o);n=this.geometry[m+1]}};j.Mesh.prototype.computeUVs=function(){var n=null;var l=0;if(this.geometry.length>=0){n=this.geometry[0];l=this.geometry.length}else{if(this.geometry._type===2){n=this.geometry;l=1}}for(var m=0;m<l;m++){n.computeUVs(this.geometry.boundingBox);n=this.geometry[m+1]}};j.Mesh.prototype.detachGeometry=function(n){if(!n){return}if(!this.layer){return}var o=this.layer.getIntervals(n,null,true);for(var m=0;m<o.length;m++){l=this.layer.layers.indexOf(o[m]);if(l!==-1){this.layer.layers.splice(l,1);this.layer.upToDate=false}}if(this.geometry&&this.geometry.length){var l=this.geometry.indexOf(n);if(l!==-1){this.geometry.splice(l,1)}}};j.Mesh.prototype.removeGeometry=function(o){if(!o){return}var l=o.meshList;for(var n=0;n<l.length;n++){var p=l[n];if(!p.layer){continue}var q=p.layer.getIntervals(o,null,true);for(var n=0;n<q.length;n++){m=p.layer.layers.indexOf(q[n]);if(m!==-1){p.layer.layers.splice(m,1);p.layer.upToDate=false}}}for(var n=0;n<l.length;n++){var p=l[n];if(p.geometry&&p.geometry.length){var m=p.geometry.indexOf(o);if(m!==-1){p.geometry.splice(m,1)}}}};j.Mesh.prototype.addGeometry=function(r,q,n){var l=false;for(var o=0;o<this.geometry.length;o++){if(this.geometry[o]===r){l=true;break}}if(l){if(!n){this._initLayersForGeometry(1,r)}else{if(!this.layer){this.initLayers(1)}for(var m=0;m<n.length;m++){var t=n[m];var p=t.drawableInterval;if((p.layerNum===1)||p.material){var s=t.drawableGroup.primitives.slice(p.primitiveStart,p.primitiveStart+p.primitiveCount);this.layer.addPrimitivesToLayer(r,t.drawableGroup,s,p.layerNum,p.material)}}}return}if(!r.boundingBox){r.computeBoundingBox()}if(!this.geometry.boundingBox){this.geometry.boundingBox=new j.Box3()}q&&this.geometry.boundingBox.expandByPoint(r.boundingBox.min);q&&this.geometry.boundingBox.expandByPoint(r.boundingBox.max);if(!r.boundingSphere){r.computeBoundingSphere()}if(!this.geometry.boundingSphere){this.geometry.boundingSphere=new j.Sphere()}q&&this.geometry.boundingSphere.clone().mergeWithSphere(r.boundingSphere,this.geometry.boundingSphere);if(this._occurrence&&this._occurrence.scene3js){r.addRefVBO(this)}if(!this.layer&&!n){this.geometry.push(r);this._checkGeometry();return}if(!this.layer){this.initLayers(1)}this.geometry.push(r);if(n){this._copyLayers(n)}else{this._initLayersForGeometry(1,r)}this._checkGeometry()};j.Mesh.prototype.getRenderablesFromGeometries=function(){if(!this.geometry||!this.geometry.length){return}var m={};for(var p=0;p<this.geometry.length;p++){var o=this.geometry[p];for(var l=0;l<o.meshList.length;l++){var q=o.meshList[l];m[q.id]=q}}var n=[];for(var p in m){n.push(m[p])}return n};j.Mesh.prototype.optimizeBuffers=function(){};j.Mesh.prototype.isMeshHiddenByLayer=function(){if((this.layer===null)||!this.layer.layers.length){return false}for(var l=0;l<this.layer.layers.length;l++){var m=this.layer.layers[l];if(m.drawableInterval.layerNum!==0){return false}}return true};j.Mesh.prototype.addHighLightPrimitive=function(l){var m=this.highLight.primitives.indexOf(l);if(m!==-1){this.highLight.nbSelected[m]++;return}this.highLight.primitives.push(l);this.highLight.nbSelected.push(1);if(this.layer===null){this.initLayers()}this.layer.addPrimitivesToLayers([l],1)};j.Mesh.prototype.addHighLightRep=function(o){var p=[];for(var n=0;n<o.primitives.length;n++){var l=o.primitives[n];var m=this.highLight.primitives.indexOf(l);if(m!==-1){this.highLight.nbSelected[m]++;continue}this.highLight.primitives.push(l);this.highLight.nbSelected.push(1);p.push(l)}if(this.layer===null){this.initLayers()}this.layer.addPrimitivesToLayers(p,1)};j.Mesh.prototype.removeHighLightPrimitive=function(l){var m=this.highLight.primitives.indexOf(l);if(m===-1){return}if(this.layer===null){return}this.highLight.nbSelected[m]--;if(this.highLight.nbSelected[m]){return}this.highLight.primitives.splice(m,1);this.highLight.nbSelected.splice(m,1);this.layer.addPrimitivesToLayers([l],0)};j.Mesh.prototype.removeHighLightRep=function(o){var p=[];for(var n=0;n<o.primitives.length;n++){var l=o.primitives[n];var m=this.highLight.primitives.indexOf(l);if(m===-1){continue}this.highLight.nbSelected[m]--;if(this.highLight.nbSelected[m]){continue}this.highLight.primitives.splice(m,1);this.highLight.nbSelected.splice(m,1);p.push(l)}if(this.layer===null){this.layer=new j.BufferLayer()}this.layer.addPrimitivesToLayers(p,0)};j.Mesh.prototype.removeHighLight=function(){this.layer=null;this.highLight.primitives=[];this.highLight.nbSelected=[]};j.Mesh.prototype.initLayers=function(o){if(this.layer!==null){return}this.layer=new j.BufferLayer();var l=1;var n=this.geometry;if(this.geometry.length>=0){n=this.geometry[0];l=this.geometry.length}for(var m=0;m<l;m++){this._initLayersForGeometry(o,n);n=this.geometry[m+1]}};j.Mesh.prototype._initLayersForGeometry=function(m,t){if(!this.layer){this.layer=new j.BufferLayer()}var o=this.layer.getIntervals(t,null,true);for(var p=0;p<o.length;p++){var r=this.layer.layers.indexOf(o[p]);if(r!==-1){this.layer.layers.splice(r,1)}}for(var n=0;n<t.drawingGroups.length;n++){var s=t.drawingGroups[n];var l=new j.DrawableInterval(m,s.start,s.count);l.primitiveStart=0;l.primitiveCount=s.primitives.length;var q=new j.LayerInterval(t,s,l);this.layer.layers.push(q)}};j.Mesh.prototype._copyLayers=function(n){if(!this.layer){this.layer=new j.BufferLayer()}for(var m=0;m<n.length;m++){var l=n[m];this.layer.layers.push(l.clone())}};j.Mesh.prototype.hasPriorityManipulators=function(){if(this._manipulators){for(var l in this._manipulators){if(this._manipulators[l].active&&this._manipulators[l].getPickingPriority()){return true}}}return false};j.Mesh.prototype.hasManipulators=function(){if(this._manipulators){for(var l in this._manipulators){if(this._manipulators[l].active){return true}}}return false};j.Mesh.prototype._checkGeometry=function(){var r,o,n,l,m,q,p;if(this.geometry.length){r=this.geometry.length;for(n=0;n<r;n++){m=this.geometry[n];if(m._type!==2){continue}q=m.drawingGroups;o=q.length;for(l=0;l<o;l++){p=q[l];if(p.glType===0){this.hasPoint=true;return true}}}}return false};j.Mesh.prototype.getNode=function(){return this._occurrence&&this._occurrence.node};j.Mesh.prototype.getSelectionGroup=function(n){if(!this.selectionGroups){return null}for(var l=0;l<this.selectionGroups.length;l++){var m=this.selectionGroups[l];if(m.contains(n)){return m}}return null};j.Mesh.prototype.removeSelectionGroup=function(n){if(!this.selectionGroups){return null}for(var l=0;l<this.selectionGroups.length;l++){var m=this.selectionGroups[l];if(m.contains(n)){this.selectionGroups.splice(l,1);break}}};j.Mesh.prototype.addSelectionGroup=function(l){if(!this.selectionGroups){this.selectionGroups=[]}this.selectionGroups.push(l)};j.InterleavedBuffer=function(l,o,q,n,p,m){this.buffer=o.createBuffer();this.indexBuffer=o.createBuffer();this.numItems=0;this.indexNumItems=0;this.interleavedData=null;this.indexData=null;this.id=q;this.geometries=[];this.isShared=false;this.nbGeometries=0;this.compressedNormals=p||false;this.compressedVertices=m||false;this.needsUpdate=false;this.start=null;this.count=null;this.vbType=l;this._setBufferOffsets(n)};j.InterleavedBuffer.prototype._setBufferOffsets=function(l){this.itemSize=0;if(l.POSITION&this.vbType){var m=this.compressedVertices?2:3;this.normalOffset=m*4;this.uvOffset=m*4;this.uv2Offset=m*4;this.colorOffset=m*4;this.tangentOffset=m*4;this.binormalOffset=m*4;this.previousPositionOffset=m*4;this.nextPositionOffset=m*4;this.sideExtrusionOffset=m*4;this.lineDistancesOffset=m*4;this.skinIndexOffset=m*4;this.skinWeightOffset=m*4;this.itemSize+=m}if(l.NORMAL&this.vbType){var m=this.compressedNormals?1:3;this.itemSize+=m;this.uvOffset+=m*4;this.uv2Offset+=m*4;this.colorOffset+=m*4;this.tangentOffset+=m*4;this.binormalOffset+=m*4;this.previousPositionOffset+=m*4;this.nextPositionOffset+=m*4;this.sideExtrusionOffset+=m*4;this.lineDistancesOffset+=m*4;this.skinIndexOffset+=m*4;this.skinWeightOffset+=m*4}if(l.UV&this.vbType){this.itemSize+=2;this.uv2Offset+=2*4;this.colorOffset+=2*4;this.tangentOffset+=2*4;this.binormalOffset+=2*4;this.previousPositionOffset+=2*4;this.nextPositionOffset+=2*4;this.sideExtrusionOffset+=2*4;this.lineDistancesOffset+=2*4;this.skinIndexOffset+=2*4;this.skinWeightOffset+=2*4}if(l.UV2&this.vbType){this.itemSize+=2;this.colorOffset+=2*4;this.tangentOffset+=2*4;this.binormalOffset+=2*4;this.previousPositionOffset+=2*4;this.nextPositionOffset+=2*4;this.sideExtrusionOffset+=2*4;this.lineDistancesOffset+=2*4;this.skinIndexOffset+=2*4;this.skinWeightOffset+=2*4}if(l.COLOR&this.vbType){this.itemSize+=4;this.tangentOffset+=4*4;this.binormalOffset+=4*4;this.previousPositionOffset+=4*4;this.nextPositionOffset+=4*4;this.sideExtrusionOffset+=4*4;this.lineDistancesOffset+=4*4;this.skinIndexOffset+=4*4;this.skinWeightOffset+=4*4}if(l.TANGENT&this.vbType){this.itemSize+=3;this.binormalOffset+=3*4;this.previousPositionOffset+=3*4;this.nextPositionOffset+=3*4;this.sideExtrusionOffset+=3*4;this.lineDistancesOffset+=3*4;this.skinIndexOffset+=3*4;this.skinWeightOffset+=3*4}if(l.BINORMAL&this.vbType){this.itemSize+=3;this.previousPositionOffset+=3*4;this.nextPositionOffset+=3*4;this.sideExtrusionOffset+=3*4;this.lineDistancesOffset+=3*4;this.skinIndexOffset+=3*4;this.skinWeightOffset+=3*4}if(l.PREVIOUSPOS&this.vbType){this.itemSize+=3;this.nextPositionOffset+=3*4;this.sideExtrusionOffset+=3*4;this.lineDistancesOffset+=3*4;this.skinIndexOffset+=3*4;this.skinWeightOffset+=3*4}if(l.NEXTPOS&this.vbType){this.itemSize+=3;this.sideExtrusionOffset+=3*4;this.lineDistancesOffset+=3*4;this.skinIndexOffset+=3*4;this.skinWeightOffset+=3*4}if(l.SIDEEXTR&this.vbType){this.itemSize+=1;this.lineDistancesOffset+=1*4;this.skinIndexOffset+=1*4;this.skinWeightOffset+=1*4}if(l.LINEDIST&this.vbType){this.itemSize+=2;this.skinIndexOffset+=2*4;this.skinWeightOffset+=2*4}if(l.SKININDEX&this.vbType){this.itemSize+=4;this.skinWeightOffset+=4*4}if(l.SKINWEIGHT&this.vbType){this.itemSize+=4}};j.LensFlare.prototype.clone=function(l){if(l===undefined){l=new j.LensFlare()}j.Object3D.prototype.clone.call(this,l);l.positionScreen.copy(this.positionScreen);l.customUpdateCallback=this.customUpdateCallback;for(var m=0;m<this.lensFlares.length;m++){var n=this.lensFlares[m];var o={texture:n.texture,size:n.size,distance:n.distance,x:0,y:0,z:0,scale:1,rotation:1,opacity:n.opacity,color:n.color.clone(),blending:n.blending};l.lensFlares.push(o)}return l};j.ShaderFlares.lensFlareDepthMap={vertexShader:["uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uv;","vec2 pos = position;","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 screenPositionFlare;","uniform sampler2D tNormalDepth;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","void main() {","float visibility = 0.0;","float depth1 = texture2D( tNormalDepth, screenPositionFlare.xy ).w;","float depth2 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2( 0.005,  0.005) ).w;","float depth3 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2( 0.005, -0.005) ).w;","float depth4 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2(-0.005,  0.005) ).w;","float depth5 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2(-0.005, -0.005) ).w;","if ((depth1 == 0.0) || (screenPositionFlare.z < depth1)) visibility += 0.2;","if ((depth2 == 0.0) || (screenPositionFlare.z < depth2)) visibility += 0.2;","if ((depth3 == 0.0) || (screenPositionFlare.z < depth3)) visibility += 0.2;","if ((depth4 == 0.0) || (screenPositionFlare.z < depth4)) visibility += 0.2;","if ((depth5 == 0.0) || (screenPositionFlare.z < depth5)) visibility += 0.2;","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * visibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}"].join("\n")};j.LensFlarePlugin=function(){var n,o,l;this._lensFlare={};this.init=function(q){n=q.context;o=q;var r=this._lensFlare;l=q.getPrecision();r.vertices=new Float32Array(8+8);r.faces=new Uint16Array(6);var p=0;r.vertices[p++]=-1;r.vertices[p++]=-1;r.vertices[p++]=0;r.vertices[p++]=0;r.vertices[p++]=1;r.vertices[p++]=-1;r.vertices[p++]=1;r.vertices[p++]=0;r.vertices[p++]=1;r.vertices[p++]=1;r.vertices[p++]=1;r.vertices[p++]=1;r.vertices[p++]=-1;r.vertices[p++]=1;r.vertices[p++]=0;r.vertices[p++]=1;p=0;r.faces[p++]=0;r.faces[p++]=1;r.faces[p++]=2;r.faces[p++]=0;r.faces[p++]=2;r.faces[p++]=3;r.vertexBuffer=n.createBuffer();r.elementBuffer=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,r.vertexBuffer);n.bufferData(n.ARRAY_BUFFER,r.vertices,n.STATIC_DRAW);n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,r.elementBuffer);n.bufferData(n.ELEMENT_ARRAY_BUFFER,r.faces,n.STATIC_DRAW);r.program=m(j.ShaderFlares.lensFlareDepthMap,l);r.attributes={};r.uniforms={};r.attributes.vertex=n.getAttribLocation(r.program,"position");r.attributes.uv=n.getAttribLocation(r.program,"uv");r.uniforms.map=n.getUniformLocation(r.program,"map");r.uniforms.tNormalDepth={location:null,value:null};r.uniforms.tNormalDepth.location=n.getUniformLocation(r.program,"tNormalDepth");r.uniforms.opacity=n.getUniformLocation(r.program,"opacity");r.uniforms.color=n.getUniformLocation(r.program,"color");r.uniforms.scale=n.getUniformLocation(r.program,"scale");r.uniforms.rotation=n.getUniformLocation(r.program,"rotation");r.uniforms.screenPosition=n.getUniformLocation(r.program,"screenPosition");r.uniforms.screenPositionFlare=n.getUniformLocation(r.program,"screenPositionFlare")};this.dispose=function(){n.deleteBuffer(this._lensFlare.vertexBuffer);n.deleteBuffer(this._lensFlare.elementBuffer);n.deleteProgram(this._lensFlare.program)};this.render=function(I,F,B,p){var x=I.__webglFlares,K=x.length;if(!K||!o.lensFlareEnabled){return}var t=this._lensFlare;var G=new j.Vector3();var s=p/B,H=B*0.5,A=p*0.5;var y=16/p,L=new j.Vector2(y*s,y);var w=new j.Vector3(1,1,0),v=new j.Vector2(1,1);var J=t.uniforms,u=t.attributes;n.useProgram(t.program);n.enableVertexAttribArray(t.attributes.vertex);n.enableVertexAttribArray(t.attributes.uv);o.setTexture(J.tNormalDepth.value,0);n.uniform1i(J.tNormalDepth.location,0);n.uniform1i(J.map,1);n.bindBuffer(n.ARRAY_BUFFER,t.vertexBuffer);n.vertexAttribPointer(u.vertex,2,n.FLOAT,false,2*8,0);n.vertexAttribPointer(u.uv,2,n.FLOAT,false,2*8,8);n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.elementBuffer);n.disable(n.CULL_FACE);n.depthMask(false);var D,C,E,r,z;for(D=0;D<K;D++){y=16/p;L.set(y*s,y);r=x[D];G.set(r.matrixWorld.elements[12],r.matrixWorld.elements[13],r.matrixWorld.elements[14]);G.applyMatrix4(F.matrixWorldInverse);if(G.z>0){continue}G.applyProjection(F.projectionMatrix);var q=0.5+0.5*G.z;w.copy(G);v.x=w.x*H+H;v.y=w.y*A+A;if(v.x>0&&v.x<B&&v.y>0&&v.y<p){n.disable(n.DEPTH_TEST);n.uniform3f(J.screenPositionFlare,0.5*(w.x+1),0.5*(w.y+1),q);r.positionScreen.copy(w);if(r.customUpdateCallback){r.customUpdateCallback(r)}else{r.updateLensFlares()}n.uniform1i(J.renderType,2);n.enable(n.BLEND);for(C=0,E=r.lensFlares.length;C<E;C++){z=r.lensFlares[C];if(z.opacity>0.001&&z.scale>0.001){w.x=z.x;w.y=z.y;w.z=z.z;y=z.size*z.scale/p;L.x=y*s;L.y=y;n.uniform3f(J.screenPosition,w.x,w.y,w.z);n.uniform2f(J.scale,L.x,L.y);n.uniform1f(J.rotation,z.rotation);n.uniform1f(J.opacity,z.opacity);n.uniform3f(J.color,z.color.r,z.color.g,z.color.b);o.setBlending(z.blending,z.blendEquation,z.blendSrc,z.blendDst);o.setTexture(z.texture,1);n.drawElements(n.TRIANGLES,6,n.UNSIGNED_SHORT,0)}}}}n.enable(n.CULL_FACE);n.enable(n.DEPTH_TEST);n.depthMask(true)};function m(s,q){var r=n.createProgram();var p=n.createShader(n.FRAGMENT_SHADER);var u=n.createShader(n.VERTEX_SHADER);var t="precision "+q+" float;\n";n.shaderSource(p,t+s.fragmentShader);n.shaderSource(u,t+s.vertexShader);n.compileShader(p);n.compileShader(u);n.attachShader(r,p);n.attachShader(r,u);n.linkProgram(r);n.deleteShader(p);n.deleteShader(u);return r}};j.WebGLRenderer_backup=j.WebGLRenderer;j.WebGLRenderer=function(m){this.renderPoints=false;this.renderPointMode=j.AllPointsButSurfacicPointsRenderPointMask;this.renderLineMode=null;this.renderFaceMode=j.ShowAllFaces;this.renderFaces=true;this.renderHiddenEdges=false;this.outlineWidth=1;this.ratioSSB=100;this.colorizeSSB=false;this.pickPointsMode=2;this.pickLinesMode=1;this.pickFacesMode=2;j.WebGLRenderer_backup.call(this,m);var n=this;var l=this.getContext()};j.WebGLRenderer.prototype.computeRenderPriorityOpacity=function(l,n){var m=n?n.getRenderPriorityOpacity():null;if(m===null||m<0){m=this.renderPriorityDefaultOpacity}return m*l};j.WebGLRenderer.prototype.refreshUniformsLine=function(l,o,p){if(l.diffuse){var m=o.color;if(p&&!p.disableColorOverride&&p.getColor()){m=new j.Color(p.getColor())}l.diffuse.value=m}if(l.opacity){var n;n=o.opacity;if(p&&p.getOpacity()!==null){n=p.getOpacity()}if(this.useRenderPriorityOpacity){n=this.computeRenderPriorityOpacity(n,p)}l.opacity.value=n}if(l.pixelSize){l.pixelSize.value={x:o.pixelSize.x,y:o.pixelSize.y}}if(o.isDashedLine){l.scale.value=o.scale;l.dashPattern.value=o.dashPattern;l.totalSize.value=o.dashPattern[o.dashPattern.length-1];l.patternOffset.value=o.patternOffset}if(o.isWideLine||o.is2DLine){l.halfWidth.value=o.lineWidth/2}if(o.is2DLine){l.miterLimit.value=o.miterLimit}};j.WebGLRenderer.prototype.refreshUniformsPhysicalDSRoughnessMaps=function(m,p,o){var n=this.precomputedTexture1;if(m.precomputedTexture1&&n){m.precomputedTexture1.value=n;if(n&&n.onRequest){n.onRequest();n.onRequest=null}}n=this.precomputedTexture2;if(m.precomputedTexture2&&n){m.precomputedTexture2.value=n;if(n&&n.onRequest){n.onRequest();n.onRequest=null}}n=this.precomputedTexture3;if(m.precomputedTexture3&&n){m.precomputedTexture3.value=n;if(n&&n.onRequest){n.onRequest();n.onRequest=null}}if(p.envMipMap&&p.envMipMap[0]){m.envMap.value=p.envMipMap[0];m.envMap2.value=p.envMipMap[1];if(m.envMap.value&&m.envMap.value.hdr&&m.envMap.value.image){m.envMapHDRSize.value.x=parseInt(m.envMap.value.image.width);m.envMapHDRSize.value.y=parseInt(m.envMap.value.image.height)}var l=p.envMipMap[0].envMapExposure;m.envMapExposure.value=(l||(l===0))?l:1;m.ambienceMatrix.value=p.ambienceMatrix?p.ambienceMatrix:new j.Matrix4();if(p.useFiniteEnvMap){m.sphereCenter.value=p.parallaxCorrectionParameters.sphereCenter;m.sphereRadius.value=p.parallaxCorrectionParameters.sphereRadius;m.projectionCenter.value=p.parallaxCorrectionParameters.projectionCenter}}if(p.reflectionProbes&&p.reflectionProbes.length){m.reflectionProbe.value=p.reflectionProbes[0].map0;m.reflectionProbeMips.value=p.reflectionProbes[0].map1;m.reflectionProbePos.value=p.reflectionProbes[0].position;m.reflectionProbeProxyMin.value=p.reflectionProbes[0].geomProxy.min;m.reflectionProbeProxyMax.value=p.reflectionProbes[0].geomProxy.max}};j.createPlaneGeometryDS=function(l,w){var r=new j.BufferGeometryDS();r.vertexIndexArray=new Uint16Array(6);r.vertexPositionArray=new Float32Array(12);r.vertexNormalArray=new Float32Array(12);r.vertexUvArray=new Float32Array(12);var t=new d.SGRep({solid:false});var u=[];var m=new d.DrawingGroup(new j.MeshPhongMaterial({side:j.DoubleSide,color:new j.Color(16777215)}),null,4,0,6,u,undefined,j.GeomTypeEnum.UNKNOWN,0);m.geometry=r;r.drawingGroups.push(m);var q=new d.SGPrimitive({start:0,count:6,cgmId:0,rep:t,group:m});u.push(q);t.primitives.push(q);var v=r.vertexIndexArray;v[0]=0;v[1]=1;v[2]=3;v[3]=1;v[4]=2;v[5]=3;var p=r.vertexPositionArray;p[0]=-0.5*l;p[1]=0.5*w;p[2]=0;p[3]=-0.5*l;p[4]=-0.5*w;p[5]=0;p[6]=0.5*l;p[7]=-0.5*w;p[8]=0;p[9]=0.5*l;p[10]=0.5*w;p[11]=0;var s=r.vertexNormalArray;for(var o=0;o<4;o++){s[3*o]=0;s[3*o+1]=0;s[3*o+2]=1}var n=r.vertexUvArray;n[0]=0;n[1]=1;n[2]=0;n[3]=0;n[4]=0;n[5]=0;n[6]=1;n[7]=0;n[8]=0;n[9]=1;n[10]=1;n[11]=0;r.computeBoundingBox();r.computeBoundingSphere();return r};j.convertParticleSystemToBufferGeometryDS=function(t){if(!t||(t._type!==0)||!t.vertices){return}var m=t.vertices.length;var q=new j.BufferGeometryDS();q.vertexPositionArray=new Float32Array(3*m);q.vertexPositionArray.nonindexedPoints=true;q.vertexIndexArray=new Uint16Array(1);q.vertexIndexArray[0]=0;var r=new d.SGRep({solid:false});var s=[];var l=new d.DrawingGroup(new j.MeshPhongMaterial({side:j.DoubleSide,color:new j.Color(16777215)}),null,0,0,m,s,undefined,j.GeomTypeEnum.UNKNOWN,0);l.geometry=q;q.drawingGroups.push(l);var p=new d.SGPrimitive({start:0,count:m,cgmId:0,rep:r,group:l});s.push(p);r.primitives.push(p);var o=q.vertexPositionArray;for(var n=0;n<m;n++){o[3*n]=t.vertices[n].x;o[3*n+1]=t.vertices[n].y;o[3*n+2]=t.vertices[n].z}q.computeBoundingBox();q.computeBoundingSphere();return q};j.BufferGeometryDS=function(){j.EventDispatcher.call(this);this.id=j.GeometryIdCount++;this._type=2;this.needsUpdate=false;this.vertexBuffer=null;this.sharedBuffers=false;this.noMeshInRAM=false;this.vertexIndexArray=null;this.vertexPositionArray=null;this.vertexNormalArray=null;this.vertexUvArray=null;this.vertexUv2Array=null;this.vertexTangentArray=null;this.vertexBinormalArray=null;this.vertexColorArray=null;this.vertexLineDistancesArray=null;this.vertexPreviousPositionArray=null;this.vertexNextPositionArray=null;this.vertexSideExtrusionArray=null;this.vertexSkinIndexArray=null;this.vertexSkinWeightArray=null;this.vertexLayout={vertexIndexArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexPositionArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexNormalArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexUvArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:true},vertexUv2Array:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:true},vertexTangentArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexBinormalArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexColorArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexLineDistancesArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexPreviousPositionArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexNextPositionArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexSideExtrusionArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexSkinIndexArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false},vertexSkinWeightArray:{itemSize:0,offset:0,start:-1,count:-1,needsUpdate:false,isUVs:false}};this.dynamic=false;this.boundingBox=null;this.boundingSphere=null;this.drawingGroups=[];this.vboRef=0;this.meshList=[];this.wideLines=null;this.cpuPatternFrame=0;this.cpuPatternMode=false;this.line=null;this.editable=false;this.use32bitIndexBuffer=false;this.numBytesIndex=2;this.glFormatTypeIndex=5123;this.indexOffset=0;this.itemSize=1;this.numItems=1;this.compressedNormals=false;this.compressedVertices=false;this.quantizedVector=null;this.offsetVector=null};j.BufferGeometryDS.prototype={constructor:j.BufferGeometryDS,attributeName:["Position","Normal","Color","Uv","Uv2","Tangent","Binormal"],getVertexPositionArray:function(){if(this.compressedVertices&&this.vertexPositionArray){var o=this.vertexPositionArray.length/2;var p=new Float32Array(3*o);for(var n=0;n<o;n++){var m=this.vertexPositionArray[2*n];var q=this.vertexPositionArray[2*n+1];var l=this.uncompressPoint(m,q);p[3*n]=l.x;p[3*n+1]=l.y;p[3*n+2]=l.z}return p}return this.vertexPositionArray},getVertexPosition:function(l,m){if(!l){l=new j.Vector3()}if(this.vertexPositionArray){if(this.compressedVertices){return l.copy(this.uncompressPoint(this.vertexPositionArray[2*m],this.vertexPositionArray[2*m+1]))}return l.copy({x:this.vertexPositionArray[3*m],y:this.vertexPositionArray[3*m+1],z:this.vertexPositionArray[3*m+2]})}return null},getVertexNormal:function(l,m){if(!l){l=new j.Vector3()}if(this.vertexNormalArray){if(this.compressedNormals){return l.copy(this.uncompressNormal(this.vertexNormalArray[m]))}return l.copy({x:this.vertexNormalArray[3*m],y:this.vertexNormalArray[3*m+1],z:this.vertexNormalArray[3*m+2]})}return null},uncompressPoint:function(l,p){var o=this.quantizedVector.x*(Math.floor(l/256)+this.offsetVector.x);var m=this.quantizedVector.z*(Math.floor(p/256)+this.offsetVector.z);var n=this.quantizedVector.y*((l%256)*256+(p%256)+this.offsetVector.y);return{x:o,y:n,z:m}},uncompressNormal:function(l){var q=function(s){var r={x:0,y:0};r.x=Math.floor(s/4096)/4095;r.y=(s%4096)/4095;return r};var n=function(s){var r=function(t){return t>=0?1:-1};return{x:r(s.x),y:r(s.y)}};var p=new j.Vector3();var o=q(l);p.x=2*o.x-1;p.y=2*o.y-1;p.z=1-Math.abs(p.x)-Math.abs(p.y);if(p.z<=0){var m=n({x:p.x,y:p.y});p.x=-Math.abs(p.y)*m.x+m.x;p.y=-Math.abs(p.x)*m.y+m.y}return p.normalize()},primitiveIterator:function(m,u,y,s,x){if(!this.vertexIndexArray){console.log("Warning: no CPU picking in noMeshInRam");return 0}var w=this.drawingGroups;for(var q=0;q<w.length;q++){var t=w[q];var p=0;switch(t.glType){case 4:case 5:if(!u){continue}p=3;break;case 1:if(!s){continue}p=2;break;case 0:if(!y){continue}p=1;break;default:continue}var o=null;if(x.layer){o=x.layer.getIntervals(geometry,t)}for(var n=0;n<t.primitives.length;n++){var r=t.primitives[n];if(o!==null){var v=false;for(var l=o.length-1;l>=0;l--){if(o[l].start<=prim.start){if(o[l].layerNum<=0){v=true}break}}if(v){continue}}if(m(p,r)){return}}}},_intersectPrimitivesVolume:function(l,v,z,r,w,x,A,m,o,n){var D=new j.Vector3();var C=new j.Vector3();var B=new j.Vector3();var p=new j.Sphere();if(!this.vertexIndexArray){console.log("Warning: no CPU picking in noMeshInRam");return 0}var u=this;var y=function(E){var F=true;var I=false;for(var G=E.start;G<E.start+E.count;G++){u.getVertexPosition(D,u.vertexIndexArray[G]);D.applyMatrix4(o);var H=v.containsPoint(D);F=F&&H;I=I||H;if(!F&&I){break}}return{insideb:F,partialb:I}};var s=function(G){var H=true;var J=false;for(var I=G.start;I<G.start+G.count;I+=2){u.getVertexPosition(D,u.vertexIndexArray[I]);D.applyMatrix4(o);u.getVertexPosition(C,u.vertexIndexArray[I+1]);C.applyMatrix4(o);var F=v.containsPoint(D);var E=v.containsPoint(C);p.setFromCenterAndPoints(new j.Vector3((D.x+C.x)/2,(D.y+C.y)/2,(D.z+C.z)/2),[D,C]);H=H&&(F&&E);J=J||F||E||(v.intersectsSphere(p)&&v.intersectsLine([D,C]));if(!H&&J){break}}return{insideb:H,partialb:J}};var q=function(G){var H=true;var K=false;for(var I=G.start;I+2<G.start+G.count;I++){u.getVertexPosition(D,u.vertexIndexArray[I]);D.applyMatrix4(o);u.getVertexPosition(C,u.vertexIndexArray[I+1]);C.applyMatrix4(o);u.getVertexPosition(B,u.vertexIndexArray[I+2]);B.applyMatrix4(o);p.setFromCenterAndPoints(new j.Vector3((D.x+C.x+B.x)/3,(D.y+C.y+B.y)/3,(D.z+C.z+B.z)/3),[D,C,B]);var F=v.containsPoint(D);var E=v.containsPoint(C);var J=v.containsPoint(B);H=H&&(F&&E&&J);K=K||F||E||J||(v.intersectsSphere(p)&&v.intersectsTriangle([D,C,B]));if(!H&&K){break}}return{insideb:H,partialb:K}};var t=function(G,F){var E;switch(G){case 1:E=y(F);break;case 2:E=s(F);break;case 3:E=q(F);break;default:console.error("Error: requiredVectors can't be equal to 0");return}var H={primitive:F,geometry:u,object:l};if(!E.insideb){if(E.partialb){m.push(H);return n}else{A.push(H)}}else{x.push(H)}return false};this.primitiveIterator(t,z,r,w,l)},_intersectVolume:function(t,n,l,r,s,o){if(!this.vertexIndexArray){console.log("Warning: no CPU picking in noMeshInRam");return 0}var m=[];var q=[];var p=[];this._intersectPrimitivesVolume(t,n,l,r,s,m,p,q,o,true);if(q.length>0||(p.length>0&&m.length>0)){return 1}return p.length>0?0:2},computeBoundingBox:function(){var m=[0,0,0];var l=[0,0,0];var r=this.vertexPositionArray;if(r){var p=r.length;if(p>=1){m=[Infinity,Infinity,Infinity];l=[-Infinity,-Infinity,-Infinity];if(this.compressedVertices){for(var q=0;q<p;q+=2){if(isNaN(r[q])){continue}var o=this.uncompressPoint(r[q],r[q+1]);if(o.x<m[0]){m[0]=o.x}if(o.y<m[1]){m[1]=o.y}if(o.z<m[2]){m[2]=o.z}if(o.x>l[0]){l[0]=o.x}if(o.y>l[1]){l[1]=o.y}if(o.z>l[2]){l[2]=o.z}}}else{for(var q=0;q<p;q+=3){if(isNaN(r[q])){continue}if(r[q]<m[0]){m[0]=r[q]}if(r[q+1]<m[1]){m[1]=r[q+1]}if(r[q+2]<m[2]){m[2]=r[q+2]}if(r[q]>l[0]){l[0]=r[q]}if(r[q+1]>l[1]){l[1]=r[q+1]}if(r[q+2]>l[2]){l[2]=r[q+2]}}}}}m=new j.Vector3(m[0],m[1],m[2]);l=new j.Vector3(l[0],l[1],l[2]);this.boundingBox=new j.Box3(m,l);return this.boundingBox},computeOrientedBoundingBox:function(z,w){if(!z){return null}var l=new j.Vector3();var r=new j.Vector3();var y=new j.Vector3();var x=this.vertexPositionArray;if(x){var o=x.length;if(o>=1){if(w){var t=true;for(var s=0;s<w.length;s++){var u=w[s];if(!u.layerNum){continue}if(!u.count){continue}if(t){t=false;var v=this.vertexIndexArray[u.start];if(this.compressedVertices){v*=2;var p=this.uncompressPoint(x[2*v],x[2*v+1]);r.set(p.x,p.y,p.z).applyMatrix4(z);y.set(p.x,p.y,p.z).applyMatrix4(z)}else{v*=3;r.set(x[v],x[v+1],x[v+2]).applyMatrix4(z);y.set(x[v],x[v+1],x[v+2]).applyMatrix4(z)}}for(var q=u.start;q<u.start+u.count;q++){var v=this.vertexIndexArray[q];if(this.compressedVertices){v*=2;var p=this.uncompressPoint(x[v],x[v+1]);l.set(p.x,p.y,p.z).applyMatrix4(z)}else{v*=3;l.set(x[v],x[v+1],x[v+2]).applyMatrix4(z)}if(l.x<r.x){r.x=l.x}if(l.y<r.y){r.y=l.y}if(l.z<r.z){r.z=l.z}if(l.x>y.x){y.x=l.x}if(l.y>y.y){y.y=l.y}if(l.z>y.z){y.z=l.z}}}}else{if(this.compressedVertices){var p=this.uncompressPoint(x[0],x[1]);r.set(p.x,p.y,p.z).applyMatrix4(z);y.set(p.x,p.y,p.z).applyMatrix4(z);for(var m=0;m<o;m+=2){var p=this.uncompressPoint(x[m],x[m+1]);l.set(p.x,p.y,p.z).applyMatrix4(z);if(l.x<r.x){r.x=l.x}if(l.y<r.y){r.y=l.y}if(l.z<r.z){r.z=l.z}if(l.x>y.x){y.x=l.x}if(l.y>y.y){y.y=l.y}if(l.z>y.z){y.z=l.z}}}else{r.set(x[0],x[1],x[2]).applyMatrix4(z);y.set(x[0],x[1],x[2]).applyMatrix4(z);for(var m=0;m<o;m+=3){l.set(x[m],x[m+1],x[m+2]).applyMatrix4(z);if(l.x<r.x){r.x=l.x}if(l.y<r.y){r.y=l.y}if(l.z<r.z){r.z=l.z}if(l.x>y.x){y.x=l.x}if(l.y>y.y){y.y=l.y}if(l.z>y.z){y.z=l.z}}}}}}return new j.Box3(r,y)},computeBoundingSphere:function(){if(!this.boundingSphere){this.boundingSphere=new j.Sphere()}var l=this.boundingBox;if(l){this.boundingSphere.radius=l.max.clone().sub(l.min).multiplyScalar(0.5).length();this.boundingSphere.center=l.max.clone().add(l.min).multiplyScalar(0.5)}},computeUVs:function(A){if(this.vertexUvArray){return}var q=this.vertexPositionArray;var o=new Float32Array(this.compressedVertices?1.5*q.length:q.length);this.vertexUvArray=o;if(!this.vertexNormalArray){return}if(!A){A=this.computeBoundingBox()}var w=[A.min.x,A.min.y,A.min.z];var r=[A.max.x-A.min.x,A.max.y-A.min.y,A.max.z-A.min.z];for(var p=0;p<o.length/3;p++){var s=3*p;var t=new j.Vector3();this.getVertexNormal(t,p);var x=Math.abs(t.x);var B=Math.abs(t.y);var n=0;if(B>x){x=B;n=1}B=Math.abs(t.z);if(B>x){x=B;n=2}var z=(n+1)%3;var y=(n+2)%3;var l;if(this.compressedVertices){var m=this.uncompressPoint(q[2*p],q[2*p+1]);l=[m.x,m.y,m.z]}else{l=[q[s],q[s+1],q[s+2]]}o[s]=(l[z]-w[z])/Math.min(r[z],r[y]);o[s+1]=(l[y]-w[y])/Math.min(r[z],r[y]);o[s+2]=0}},computeTangents:function(y){if(this.vertexBinormalArray&&this.vertexTangentArray){return}if(this.vertexTangentArray){var v=this.vertexTangentArray;var R=new j.Vector3();var r=new j.Vector3();var m=new j.Vector3();this.vertexBinormalArray=new Float32Array(v.length);for(var G=0;G<v.length;G+=3){this.getVertexNormal(R,G/3);R.normalize();r.set(this.vertexTangentArray[G],this.vertexTangentArray[G+1],this.vertexTangentArray[G+2]);r.normalize();m.crossVectors(R,r);this.vertexBinormalArray[G]=m.x;this.vertexBinormalArray[G+1]=m.y;this.vertexBinormalArray[G+2]=m.z}return}var G=0,B=0,z=0,w=0,p=new j.Vector3(),o=new j.Vector3(),n=new j.Vector3(),M=new j.Vector2(),K=new j.Vector2(),I=new j.Vector2(),E=new j.Vector2(),D=new j.Vector2(),H=new j.Vector3(),F=new j.Vector3(),O=new j.Vector3(),R=new j.Vector3(),r=new j.Vector3(),m=new j.Vector3(),x=new j.Vector3(),Q=0,P=0,N=0,u=0,t=0,s=0,A=0;var v,q;if(this.compressedVertices){v=new Float32Array(1.5*this.vertexPositionArray.length);q=new Float32Array(1.5*this.vertexPositionArray.length)}else{v=new Float32Array(this.vertexPositionArray.length);q=new Float32Array(this.vertexPositionArray.length)}if(!this.vertexTangentArray){this.vertexTangentArray=v}if(!this.vertexBinormalArray){this.vertexBinormalArray=q}for(G=0;G<v.length;G++){v[G]=0;q[G]=0}for(var C=0;C<this.drawingGroups.length;C++){var L=this.drawingGroups[C];if(L.glType!==4){continue}for(G=L.start;G<L.start+L.count;G+=3){B=this.vertexIndexArray[G];z=this.vertexIndexArray[G+1];w=this.vertexIndexArray[G+2];this.getVertexPosition(p,B);this.getVertexPosition(o,z);this.getVertexPosition(n,w);M.set(this.vertexUvArray[3*B],this.vertexUvArray[3*B+1]);K.set(this.vertexUvArray[3*z],this.vertexUvArray[3*z+1]);I.set(this.vertexUvArray[3*w],this.vertexUvArray[3*w+1]);H.subVectors(o,p);F.subVectors(n,p);E.subVectors(K,M);D.subVectors(I,M);var J=E.x*D.y-D.x*E.y;if(Math.abs(J)>1e-8){J=1/J;Q=J*(D.y*H.x-E.y*F.x);P=J*(D.y*H.y-E.y*F.y);N=J*(D.y*H.z-E.y*F.z);u=J*(E.x*F.x-D.x*H.x);t=J*(E.x*F.y-D.x*H.y);s=J*(E.x*F.z-D.x*H.z)}else{Q=1;P=0;N=0;u=0;t=1;s=0}v[3*B]+=Q;v[3*z]+=Q;v[3*w]+=Q;v[3*B+1]+=P;v[3*z+1]+=P;v[3*w+1]+=P;v[3*B+2]+=N;v[3*z+2]+=N;v[3*w+2]+=N;q[3*B]+=u;q[3*z]+=u;q[3*w]+=u;q[3*B+1]+=t;q[3*z+1]+=t;q[3*w+1]+=t;q[3*B+2]+=s;q[3*z+2]+=s;q[3*w+2]+=s}}for(G=0;G<v.length;G+=3){this.getVertexNormal(R,G/3);r.set(v[G],v[G+1],v[G+2]);m.set(q[G],q[G+1],q[G+2]);r.normalize();m.normalize();A=R.dot(r);x=new j.Vector3().copy(r);x.sub(O.copy(R).multiplyScalar(A));x.normalize();v[G]=x.x;v[G+1]=x.y;v[G+2]=x.z;q[G]=m.x;q[G+1]=m.y;q[G+2]=m.z}},computeLineDistances:function(B){this.cpuPatternMode=false;var z=0;var r=[];var o=this.vertexPositionArray;var m=this.vertexIndexArray;var q=B&&B.length===m.length;var v,t,C=new j.Vector3(),A=new j.Vector3();for(var x=0;x<this.drawingGroups.length;x++){var y=this.drawingGroups[x];var l=y.start;var p=y.count;for(var w=0;w<p;w++){z=0;var u=w+l;var n=0;if(q){n=B[u]}if(w>0){if(this.compressedVertices){v=2*m[u];t=2*m[u-1];if(v===t){continue}var s=this.uncompressPoint(o[v],o[v+1]);C.x=s.x;C.y=s.y;C.z=s.z;s=this.uncompressPoint(o[t],o[t+1]);A.x=s.x;A.y=s.y;A.z=s.z}else{v=3*m[u];t=3*m[u-1];if(v===t){continue}C.x=o[v];C.y=o[v+1];C.z=o[v+2];A.x=o[t];A.y=o[t+1];A.z=o[t+2]}z=C.distanceTo(A);if(Math.abs(z)>0.000001&&!(w%2)){r[2*m[u]]=n;r[2*m[u]+1]=n}else{r[2*m[u]]=n+z+r[2*m[u-1]];r[2*m[u]+1]=n+z+r[2*m[u-1]]}}else{r[2*m[u]]=n;r[2*m[u]+1]=n}}}this.needsUpdate=true;this.vertexLineDistancesArray=new Float32Array(r)},_computeWideLineDistances:function(){this.cpuPatternMode=false;var o=[];var x=this.line.vertexLineDistancesArray;for(var v=0;v<this.drawingGroups.length;v++){var u=this.drawingGroups[v];var n=u.lineStructure.sides;var y=u.lineStructure.primitives;var m=0;for(var s=0;s<y.length;s++){var z=y[s];for(var q=0;q<z.length;q++){var w=z[q];var l=((w.endLine||w.begLine)&&(!w.isLoopedWith&&!w.fusedWith)?2:4);for(var p=0;p<l;p++){var t=x[2*w.cur];if(n[m]%2===0){o.push(t);if(w.isLoopedWith){o.push(t)}else{if(w.fusedWith){var r=y[w.fusedWith.primIndex][0];r=x[2*r.cur];if(Math.abs(r-t)<0.000001){o.push(x[2*w.next])}else{o.push(t)}}else{o.push(x[2*w.next])}}}else{o.push(x[2*w.prev]);o.push(t)}m++}}}}this.needsUpdate=true;this.vertexLineDistancesArray=new Float32Array(o)},computeWideLineDistances:function(){this.line.computeLineDistances([]);this._computeWideLineDistances()},computePixelLineDistances:function(l,G,F,z){if(this.cpuPatternFrame>=z){return}this.cpuPatternMode=true;this.cpuPatternFrame=z;var C=0;var t=[];var r=new j.Matrix4();r.multiplyMatrices(G,l);var p=this.vertexPositionArray;var n=this.vertexIndexArray;var x,v,E=new j.Vector4(),D=new j.Vector4();var H=new j.Vector2();var o=new j.Vector2();for(var A=0;A<this.drawingGroups.length;A++){var B=this.drawingGroups[A];var m=B.start;var q=B.count;for(var y=0,s=q;y<s;y++){C=0;var w=y+m;if(y>0){if(this.compressedVertices){x=2*n[w];v=2*n[w-1];if(x===v){continue}var u=this.uncompressPoint(p[x],p[x+1]);E.x=u.x;E.y=u.y;E.z=u.z;u=this.uncompressPoint(p[v],p[v+1]);D.x=u.x;D.y=u.y;D.z=u.z}else{x=3*n[w];v=3*n[w-1];if(x===v){continue}E.x=p[x];E.y=p[x+1];E.z=p[x+2];D.x=p[v];D.y=p[v+1];D.z=p[v+2]}E.w=1;E.applyMatrix4(r);D.w=1;D.applyMatrix4(r);H.x=0.5*((E.x/E.w)+1)*F.width;H.y=0.5*((E.y/E.w)+1)*F.height;o.x=0.5*((D.x/D.w)+1)*F.width;o.y=0.5*((D.y/D.w)+1)*F.height;C=H.distanceTo(o);if(Math.abs(C)>0.000001&&!(y%2)){t[2*n[w]]=0;t[2*n[w]+1]=0}else{t[2*n[w]]=C+t[2*n[w-1]];t[2*n[w]+1]=C+t[2*n[w-1]]}}else{t[2*n[w]]=0;t[2*n[w]+1]=0}}}this.needsUpdate=true;this.vertexLineDistancesArray=new Float32Array(t)},computePixelWideLineDistances:function(m,D,C,x){if(this.cpuPatternFrame>=x){return}this.cpuPatternMode=true;this.cpuPatternFrame=x;this.line.computePixelLineDistances(m,D,C,x);var r=[];var n=this.line.vertexLineDistancesArray;for(var z=0;z<this.drawingGroups.length;z++){var A=this.drawingGroups[z];var q=A.lineStructure.primitives;var B=A.lineStructure.sides;var o=0;for(var w=0;w<q.length;w++){var s=q[w];for(var v=0;v<s.length;v++){var p=s[v];var y=((p.endLine||p.begLine)&&(!p.isLoopedWith&&!p.fusedWith)?2:4);for(var u=0;u<y;u++){var t=n[2*p.cur];if(B[o]%2===0){r.push(t);if(p.isLoopedWith){r.push(t)}else{if(p.fusedWith){var l=q[p.fusedWith.primIndex][0];l=n[2*l.cur];if(Math.abs(l-t)<0.000001){r.push(n[2*p.next])}else{r.push(t)}}else{r.push(n[2*p.next])}}}else{r.push(n[2*p.prev]);r.push(t)}o++}}}}this.needsUpdate=true;this.vertexLineDistancesArray=new Float32Array(r)},computeWideLine:function(ag,Z){if(!this.wideLines||(this.wideLines.vertexBuffer&&this.wideLines.vertexBuffer.needsUpdate)){if(this.wideLines){this.wideLines.dispose()}this.wideLines=new j.BufferGeometryDS();this.wideLines.editable=this.editable;this.wideLines.dgIds=0;this.wideLines.line=this}var M=this.wideLines.drawingGroups;var P=null;for(var ae=0;ae<M.length;ae++){if(ag.idWideLine===M[ae].idWideLine){P=M[ae];break}}if(P){return P}var P=new d.DrawingGroup();if(ag instanceof d.DrawingGroup){P=ag.clone()}else{P.gas=ag.gas;P.gasIndex=ag.gasIndex;P._geomType=ag._geomType;P.layers=ag.layers;P.material=ag.material;P.copyPrimitives(ag.primitives);P.count=ag.count}P.geometry=this.wideLines;P.glType=4;ag.idWideLine=this.wideLines.dgIds;P.idWideLine=this.wideLines.dgIds++;var K=this;var u=this.vertexPositionArray;var W=function(ai,ah){var l=0.000001;var al=u;if(K.compressedVertices){var ak=K.uncompressPoint(al[2*ai],al[2*ai+1]);var aj=K.uncompressPoint(al[2*ah],al[2*ah+1]);return Math.abs(ak.x-aj.x)<l&&Math.abs(ak.y-aj.y)<l&&Math.abs(ak.z-aj.z)<l}return Math.abs(al[3*ai]-al[3*ah])<l&&Math.abs(al[3*ai+1]-al[3*ah+1])<l&&Math.abs(al[3*ai+2]-al[3*ah+2])<l};var L=function(am){var ao=[];var an=0;for(var al=0;al<ag.primitives.length;al++){var ai=ag.primitives[al];var ah;if(!P.primitives&&!P.primitives[al]){ah=new d.Primitive();ah.cgmId=ai.cgmId;ah.decoration=ai.decoration;ah.group=P;ah.rep=ai.rep;ah.type=ai.type;ah.start=ai.start;ah.count=ai.count;P.primitives[al]=ah}else{ah=P.primitives[al]}ao.push([]);for(var aj=ai.start;aj<ai.start+ai.count;aj++){var ak=(aj-ai.start)%2;an=am[aj];var l={cur:an,prev:ak?am[aj-1]:an,next:ak?an:am[aj+1],begLine:false,endLine:false,fusedBack:false,fusedWith:null};ao[al].push(l)}}return ao};var E=L(this.vertexIndexArray);var aa=function(ao){var l=[];for(var an=0;an<ao.length;an++){l.push([]);J=ao[an];if(J.length<1){continue}for(var al=0;al<J.length;al++){var am=J[al];if(am.cur!==am.next){l[an].push(am)}else{if(al<J.length-1){var ah=al+1;var ai=J[ah];if(am.cur===ai.cur){for(var ak=al+2;ak<J.length;ak++){if(am.cur===J[ak].cur){ah=ak}else{break}}ai=J[ah];var aj={cur:am.cur,next:ai.next,prev:am.prev,begLine:false,endLine:false,fusedBack:false,fusedWith:null};al=ah;l[an].push(aj)}else{l[an].push(am)}}else{l[an].push(am)}}}}return l};E=aa(E);var B=function(l,al){for(var ai=0;ai<l.length;ai++){var ak=l[ai];if(ak.length<1){continue}for(var ah=0;ah<ak.length;ah++){var aj=ak[ah];al(aj,ak,ah)}}};var y=function(l){if(l.next===l.cur){l.endLine=true}else{if(l.prev===l.cur){l.begLine=true}}};B(E,y);var A=function(aj,ai,ah){if(aj.endLine&&ah<ai.length-1){var l=ai[ah+1];if(l.begLine&&W(aj.cur,l.cur)){aj.endLine=false;l.begLine=false}}};B(E,A);var s=function(aj,ai,ah){if(W(aj.cur,aj.next)&&!aj.endLine&&!aj.begLine){for(var ak=ah+1;ak<ai.length;ak++){var l=ai[ak];if(!W(aj.cur,l.cur)){break}l.prev=aj.prev;if(l.endLine){break}if(!W(l.next,l.cur)){aj.next=l.next;aj.endSkip=true;l.baseSkip=true}else{if(!l.colorIndex){l.colorIndex=aj.cur}}}}};B(E,s);var C=new j.Vector3();var X=function(au){if(au.length<2){return}var ar=[];for(var at=0;at<au.length;at++){var av=au[at];if(av.length<1){continue}var aw=av[av.length-1];var l=av[0];if(W(aw.cur,aw.next)){K.getVertexPosition(C,aw.cur);ar.push([C.x,C.y,C.z,at,1])}if(W(l.prev,l.cur)){K.getVertexPosition(C,l.cur);ar.push([C.x,C.y,C.z,at,0])}}var ah=function(aA,az){var aC=aA[0]-az[0];if(Math.abs(aC)<0.000001){var aB=aA[1]-az[1];if(Math.abs(aB)<0.000001){var ax=aA[2]-az[2];if(Math.abs(ax)<0.000001){var ay=aA[3]-az[3];if(ay===0){return 0}return ay>0?1:-1}else{return ax>0?1:-1}}else{return aB>0?1:-1}}else{return aC>0?1:-1}};ar.sort(ah);for(var ak=0;ak<ar.length;ak++){var am=ar[ak];if(am[4]===0){continue}for(var aj=ak+1;aj<ar.length;aj++){var ai=ar[aj];if(ai[4]===1||ai[3]===am[3]){continue}var aq=Math.abs(am[0]-ai[0]);if(aq<0.000001){var ap=Math.abs(am[1]-ai[1]);if(ap<0.000001){var an=Math.abs(am[2]-ai[2]);if(an<0.000001){var av=au[am[3]];var aw=av[av.length-1];var al=au[ai[3]];var ao=al[0];if(!ao.fusedBack){aw.next=ao.next;ao.prev=aw.prev;aw.fusedWith={primIndex:ai[3]};ao.fusedBack=true;break}}}}break}}};X(E);var N=function(al,ak,aj){var ah=ak.length;if(al.begLine){for(var am=aj+1;am<ah;am++){var ai=ak[am];if(ai.endLine){if(am-aj>1&&W(ai.cur,al.cur)){ai.isLoopedWith=true;al.prev=ai.prev;ai.next=al.next}break}}}};B(E,N);P.lineStructure.primitives=E.slice(0);var m=[];var F=[];var o=[];var ac=[];var af=0;for(var ae=0;ae<E.length;ae++){var J=E[ae];for(var ad=0;ad<J.length;ad++){var x=J[ad];var O=((x.endLine||x.begLine)&&!x.isLoopedWith&&!x.fusedWith?2:4);x.indRef=af;x.inds=[];for(var ab=0;ab<O;ab++){x.inds.push(af);ac[af]=((ab%2)===0?1:-1);if(O===4){if(ab<2){ac[af]*=1}else{ac[af]*=2}}else{if(x.begLine){ac[af]*=2}}if(this.compressedVertices){var T=this.uncompressPoint(u[2*x.cur],u[2*x.cur+1]);m[3*af]=T.x;m[3*af+1]=T.y;m[3*af+2]=T.z;T=this.uncompressPoint(u[2*x.prev],u[2*x.prev+1]);F[3*af]=T.x;F[3*af+1]=T.y;F[3*af+2]=T.z;T=this.uncompressPoint(u[2*x.next],u[2*x.next+1]);o[3*af]=T.x;o[3*af+1]=T.y;o[3*af+2]=T.z}else{for(var Y=0;Y<3;Y++){m[3*af+Y]=u[3*x.cur+Y];F[3*af+Y]=u[3*x.prev+Y];o[3*af+Y]=u[3*x.next+Y]}}af++}}}P.lineStructure.sides=ac.slice(0);var S=null;if(this.vertexColorArray){S=[];var af=0;for(var ae=0;ae<E.length;ae++){var J=E[ae];for(var ad=0;ad<J.length;ad++){var x=J[ad];var O=((x.endLine||x.begLine)&&!x.isLoopedWith&&!x.fusedWith?2:4);for(var ab=0;ab<O;ab++){var t=x.colorIndex>=0?x.colorIndex:x.cur;for(var Y=0;Y<4;Y++){S[4*af+Y]=this.vertexColorArray[4*t+Y]}af++}}}}var U=null;if(!this.vertexLineDistancesArray&&(Z.isDashedLine)){console.warn("DEPRECATED: Use createLineNode to create your lines correctly");this.computeLineDistances([])}if(!this.vertexLineDistancesArray&&(Z.politeMaterial)){this.computeLineDistances([])}if(this.vertexLineDistancesArray&&this.wideLines.vertexBuffer&&this.wideLines.vertexBuffer.needsUpdate){this.computeLineDistances([])}if(this.vertexLineDistancesArray){U=[];var af=0;for(var ae=0;ae<E.length;ae++){var J=E[ae];for(var ad=0;ad<J.length;ad++){var x=J[ad];var O=((x.endLine||x.begLine)&&(!x.isLoopedWith&&!x.fusedWith)?2:4);for(var ab=0;ab<O;ab++){var z=this.vertexLineDistancesArray[2*x.cur];if(ac[af]%2===0){U.push(z);if(x.isLoopedWith){U.push(z)}else{if(x.fusedWith){var V=E[x.fusedWith.primIndex][0];V=this.vertexLineDistancesArray[2*V.cur];if(Math.abs(V-z)<0.000001){U.push(this.vertexLineDistancesArray[2*x.next])}else{U.push(z)}}else{U.push(this.vertexLineDistancesArray[2*x.next])}}}else{U.push(this.vertexLineDistancesArray[2*x.prev]);U.push(z)}af++}}}}var p=[];var n=0;for(var ae=0;ae<E.length;ae++){var J=E[ae];if(J.length<1){continue}var I=P.primitives[ae];var w=ag.primitives[ae];var q=I.count;I.count=0;var ad=0;for(ad=0;ad<J.length;ad++){var r=J[ad];var D=r.inds;if(r.endLine||r.begLine){if(r.endLine){if(r.isLoopedWith){p.push(D[0]);p.push(D[1]);p.push(D[2]);p.push(D[3]);p.push(D[2]);p.push(D[1]);I.count+=6}continue}var H=J[ad+1].inds;p.push(D[0]);p.push(D[1]);p.push(H[0]);p.push(H[1]);p.push(H[0]);p.push(D[1]);I.count+=6}else{if(!r.baseSkip){p.push(D[0]);p.push(D[1]);p.push(D[2]);p.push(D[3]);p.push(D[2]);p.push(D[1]);I.count+=6}if(!r.endSkip){var H=J[ad+1].inds;p.push(D[2]);p.push(D[3]);p.push(H[0]);p.push(H[1]);p.push(H[0]);p.push(D[3]);I.count+=6}}}var R=J[J.length-1].fusedWith;if(R){var v=J[ad-1].inds;p.push(v[0]);p.push(v[1]);p.push(v[2]);p.push(v[3]);p.push(v[2]);p.push(v[1]);I.count+=6}I.start=n;n+=I.count}var Q={count:p.length,start:0};var G=0;if(this.wideLines.vertexPositionArray){G=this.wideLines.vertexPositionArray.length/3;m=Array.prototype.slice.call(this.wideLines.vertexPositionArray).concat(m)}if(this.wideLines.vertexPreviousPositionArray){F=Array.prototype.slice.call(this.wideLines.vertexPreviousPositionArray).concat(F)}if(this.wideLines.vertexNextPositionArray){o=Array.prototype.slice.call(this.wideLines.vertexNextPositionArray).concat(o)}if(this.wideLines.vertexSideExtrusionArray){ac=Array.prototype.slice.call(this.wideLines.vertexSideExtrusionArray).concat(ac)}if(this.wideLines.vertexColorArray){S=Array.prototype.slice.call(this.wideLines.vertexColorArray).concat(S)}if(this.wideLines.vertexLineDistancesArray){if(G-this.wideLines.vertexLineDistancesArray.length/2>0){this.wideLines._computeWideLineDistances()}U=Array.prototype.slice.call(this.wideLines.vertexLineDistancesArray).concat(U)}else{if(U!==null&&U.length>0&&G>0){this.wideLines._computeWideLineDistances();U=Array.prototype.slice.call(this.wideLines.vertexLineDistancesArray).concat(U)}}if(this.wideLines.vertexIndexArray){Q.start=this.wideLines.vertexIndexArray.length;p.forEach(function(ah,l,ai){ai[l]+=G});p=Array.prototype.slice.call(this.wideLines.vertexIndexArray).concat(p)}this.wideLines.vertexPositionArray=new Float32Array(m);this.wideLines.vertexPreviousPositionArray=new Float32Array(F);this.wideLines.vertexNextPositionArray=new Float32Array(o);this.wideLines.vertexSideExtrusionArray=new Float32Array(ac);if(S){this.wideLines.vertexColorArray=new Float32Array(S)}if(U){this.wideLines.vertexLineDistancesArray=new Float32Array(U)}if(m.length>196608&&j.supportedExtensions.elementIndexUint){this.wideLines.vertexIndexArray=new Uint32Array(p)}else{this.wideLines.vertexIndexArray=new Uint16Array(p)}P.start=Q.start;P.count=Q.count;this.wideLines.drawingGroups.push(P);return P},deallocate:function(n,m){if(this.vertexBuffer!==null){this.vertexBuffer.nbGeometries--;if(m){m.memory.geometries--}var l=this.vertexBuffer.geometries.indexOf(this);this.vertexBuffer.geometries.splice(l,1);if(this.vertexBuffer.nbGeometries==0){n.deleteBuffer(this.vertexBuffer.buffer);n.deleteBuffer(this.vertexBuffer.indexBuffer);if(m&&this.vertexBuffer.isShared===true){m.memory.sharedbuffers--}}}this.vertexBuffer=null},addRefVBO:function(m){this.vboRef++;this.meshList.push(m);var l=function(p){if(p&&p._source===j.AssetSource.MATERIAL_MANAGER){p._useCount++;for(var q in p){if(p.hasOwnProperty(q)&&p[q] instanceof j.Texture){var r=p[q];if(r._source===j.AssetSource.MATERIAL_MANAGER){r._useCount++}}}l(p.line);l(p.point)}};l(m.material);l(m.gas);for(var n=0;n<this.drawingGroups.length;n++){var o=this.drawingGroups[n];l(o.material);l(o.gas)}},releaseVBO:function(o){var m=function(q){if(q&&q._source===j.AssetSource.MATERIAL_MANAGER){q._useCount--;if(q._useCount<=0){q.dispose()}for(var r in q){if(q.hasOwnProperty(r)&&q[r] instanceof j.Texture){var s=q[r];if(s._source===j.AssetSource.MATERIAL_MANAGER){s._useCount--;if(s._useCount<=0){s.dispose()}}}}m(q.line);m(q.point)}};this.vboRef--;if(this.vboRef===0){this.dispatchEvent({type:"dispose"});if(this.wideLines){this.wideLines.dispatchEvent({type:"dispose"})}}else{var l=this.meshList.indexOf(o);if(l!==-1){this.meshList.splice(l,1);m(o.material);m(o.gas);for(var n=0;n<this.drawingGroups.length;n++){var p=this.drawingGroups[n];m(p.material);m(p.gas)}}else{console.warn("BufferGeometryDS tried to break the link with a THREE.Mesh, but it failed !")}}},dispose:function(){this.dispatchEvent({type:"dispose"})},clone:function(){var p=new j.BufferGeometryDS();p.vertexIndexArray=this.vertexIndexArray?new Uint16Array(this.vertexIndexArray):null;p.vertexPositionArray=this.vertexPositionArray?new Float32Array(this.vertexPositionArray):null;p.vertexNormalArray=this.vertexNormalArray?new Float32Array(this.vertexNormalArray):null;p.vertexUvArray=this.vertexUvArray?new Float32Array(this.vertexUvArray):null;p.vertexUv2Array=this.vertexUv2Array?new Float32Array(this.vertexUv2Array):null;p.vertexTangentArray=this.vertexTangentArray?new Float32Array(this.vertexTangentArray):null;p.vertexBinormalArray=this.vertexBinormalArray?new Float32Array(this.vertexBinormalArray):null;p.vertexColorArray=this.vertexColorArray?new Float32Array(this.vertexColorArray):null;p.vertexPreviousPositionArray=this.vertexPreviousPositionArray?new Float32Array(this.vertexPreviousPositionArray):null;p.vertexNextPositionArray=this.vertexNextPositionArray?new Float32Array(this.vertexNextPositionArray):null;p.vertexSideExtrusionArray=this.vertexSideExtrusionArray?new Float32Array(this.vertexSideExtrusionArray):null;p.vertexLineDistancesArray=this.vertexLineDistancesArray?new Float32Array(this.vertexLineDistancesArray):null;p.vertexSkinIndexArray=this.vertexSkinIndexArray?new Float32Array(this.vertexSkinIndexArray):null;p.vertexSkinWeightArray=this.vertexSkinWeightArray?new Float32Array(this.vertexSkinWeightArray):null;p.boundingBox=this.boundingBox?this.boundingBox.clone():null;p.boundingSphere=this.boundingSphere?this.boundingSphere.clone():null;p.compressedNormals=this.compressedNormals;p.compressedVertices=this.compressedVertices;p.offsetVector=this.offsetVector;p.quantizedVector=this.quantizedVector;p.drawingGroups=[];for(var o=0;o<this.drawingGroups.length;o++){var r=this.drawingGroups[o];var q=[];var l=new d.DrawingGroup(r.gas,r.material,r.glType,r.start,r.count,null,null,r._geomType,r.gasIndex);for(var n=0;n<r.primitives.length;n++){var m=r.primitives[n];var s=new d.SGPrimitive({type:m.type,cgmId:m.cgmId,parent:m.parent,rep:m.rep,group:l,start:m.start,count:m.count,solid:m.solid});q.push(s)}l.geometry=p;l.primitives=q;p.drawingGroups.push(l)}return p},merge:function(y,s,x){var z=this.attributeName.length;var A=this.vertexPositionArray.length/3;var u=this.vertexIndexArray.length;for(var p=0;p<z;p++){var v="vertex"+this.attributeName[p]+"Array";if(this[v]&&y[v]){var r=this[v];var n=r.length+y[v].length;if(n>65536){return null}this[v]=new Float32Array(n);for(var q=0;q<r.length;q++){this[v][q]=r[q]}for(var q=0;q<y[v].length;q++){this[v][r.length+q]=y[v][q]}}}if(this.vertexBuffer!==null){if(this.sharedBuffers){this.vertexBuffer.nbGeometries--;if(this.vertexBuffer.nbGeometries==0){s.deleteBuffer(this.vertexBuffer.buffer);s.deleteBuffer(this.vertexBuffer.indexBuffer);if(this.vertexBuffer.vbPool!==null){this.vertexBuffer.vbPool[this.vertexBuffer.vbType]=null}}}else{s.deleteBuffer(this.vertexBuffer.buffer);s.deleteBuffer(this.vertexBuffer.indexBuffer)}}this.vertexBuffer=null;var r=this.vertexIndexArray;var n=r.length+y.vertexIndexArray.length;this.vertexIndexArray=new Uint16Array(n);for(var q=0;q<r.length;q++){this.vertexIndexArray[q]=r[q]}for(var q=0;q<y.vertexIndexArray.length;q++){this.vertexIndexArray[r.length+q]=A+y.vertexIndexArray[q]}for(var q=0;q<y.drawingGroups.length;q++){var w=y.drawingGroups[q];w.geometry=this;w.start+=u;for(var p=0;p<w.primitives.length;p++){var m=w.primitives[p];m.start+=u}this.drawingGroups.push(w)}var l=false;for(var q=0;q<this.meshList.length;q++){var B=this.meshList[q];if(B.layer){for(var p=0;p<y.drawingGroups.length;p++){var w=y.drawingGroups[p];var o=new j.DrawableInterval(1,w.start,w.count);o.primitiveStart=0;o.primitiveCount=w.primitives.length;var t=new j.LayerInterval(this,w,o);B.layer.layers.push(t)}}}return this},_setAttributesSizeAndOffset:function(){var l=this.vertexLayout;if(this.vertexPositionArray){l.vertexPositionArray.offset=0;l.vertexPositionArray.itemSize=this.compressedVertices?2:3}if(this.vertexNormalArray){l.vertexNormalArray.offset=this.vertexBuffer.normalOffset;l.vertexNormalArray.itemSize=3}if(this.vertexUvArray){l.vertexUvArray.offset=this.vertexBuffer.uvOffset;l.vertexUvArray.itemSize=2}if(this.vertexUv2Array){l.vertexUv2Array.offset=this.vertexBuffer.uv2Offset;l.vertexUv2Array.itemSize=2}if(this.vertexColorArray){l.vertexColorArray.offset=this.vertexBuffer.colorOffset;l.vertexColorArray.itemSize=4}if(this.vertexTangentArray){l.vertexTangentArray.offset=this.vertexBuffer.tangentOffset;l.vertexTangentArray.itemSize=3}if(this.vertexBinormalArray){l.vertexBinormalArray.offset=this.vertexBuffer.binormalOffset;l.vertexBinormalArray.itemSize=3}if(this.vertexPreviousPositionArray){l.vertexPreviousPositionArray.offset=this.vertexBuffer.previousPositionOffset;l.vertexPreviousPositionArray.itemSize=3}if(this.vertexNextPositionArray){l.vertexNextPositionArray.offset=this.vertexBuffer.nextPositionOffset;l.vertexNextPositionArray.itemSize=3}if(this.vertexSideExtrusionArray){l.vertexSideExtrusionArray.offset=this.vertexBuffer.sideExtrusionOffset;l.vertexSideExtrusionArray.itemSize=1}if(this.vertexLineDistancesArray){l.vertexLineDistancesArray.offset=this.vertexBuffer.lineDistancesOffset;l.vertexLineDistancesArray.itemSize=2}if(this.vertexSkinIndexArray){l.vertexSkinIndexArray.offset=this.vertexBuffer.skinIndexOffset;l.vertexSkinIndexArray.itemSize=4}if(this.vertexSkinWeightArray){l.vertexSkinWeightArray.offset=this.vertexBuffer.skinWeightOffset;l.vertexSkinWeightArray.itemSize=4}}};j.DrawableInterval=function(l,p,n,m,o){this.layerNum=l||0;this.material=m||null;this.gas=o||null;this.start=p||0;this.count=n||0;this.primitiveStart=0;this.primitiveCount=0};j.DrawableInterval.prototype={constructor:j.DrawableInterval,clone:function(){var l=new j.DrawableInterval(this.layerNum,this.start,this.count,this.material,this.gas);l.primitiveStart=this.primitiveStart;l.primitiveCount=this.primitiveCount;return l}};j.LayerInterval=function(l,n,m){this.geometry=(l!==undefined)?l:null;this.drawableGroup=(n!==undefined)?n:null;this.drawableInterval=(m!==undefined)?m:null};j.LayerInterval.prototype={constructor:j.LayerInterval,clone:function(){var l=new j.LayerInterval();l.geometry=this.geometry;l.drawableGroup=this.drawableGroup;l.drawableInterval=this.drawableInterval.clone();return l},computeOrientedBoundingBox:function(x){var s=true;var t=this.drawableInterval;var n=this.geometry.vertexIndexArray;var v=this.geometry.vertexPositionArray;var r=new j.Vector3();var w=new j.Vector3();var m=new j.Vector3();if(t.layerNum&&t.count){var l=t.start;var p=t.start+t.count;if(s){s=false;var u=n[l];if(this.geometry.compressedVertices){u*=2;var o=this.geometry.uncompressPoint(v[u],v[u+1]);r.set(o.x,o.y,o.z).applyMatrix4(x);w.set(o.x,o.y,o.z).applyMatrix4(x)}else{u*=3;r.set(v[u],v[u+1],v[u+2]).applyMatrix4(x);w.set(v[u],v[u+1],v[u+2]).applyMatrix4(x)}}for(var q=l;q<p;q++){var u=n[q];if(this.geometry.compressedVertices){u*=2;var o=this.geometry.uncompressPoint(v[u],v[u+1]);m.set(o.x,o.y,o.z).applyMatrix4(x)}else{u*=3;m.set(v[u],v[u+1],v[u+2]).applyMatrix4(x)}if(m.x<r.x){r.x=m.x}if(m.y<r.y){r.y=m.y}if(m.z<r.z){r.z=m.z}if(m.x>w.x){w.x=m.x}if(m.y>w.y){w.y=m.y}if(m.z>w.z){w.z=m.z}}}return new j.Box3(r,w)}};j.BufferLayer=function(){this.layers=[];this.upToDate=false};j.BufferLayer.prototype={constructor:j.BufferLayer,clone:function(o){var n=new j.BufferLayer();for(var m=0;m<this.layers.length;m++){var l=this.layers[m].clone();if(o){l.drawableInterval.layerNum=0}n.addLayerInterval(l)}return n},getIntervals:function(q,p,o){var n=[];for(var m=0;m<this.layers.length;m++){var l=this.layers[m];if((l.geometry===q)&&(!p||(l.drawableGroup===p))){n.push(o?l:l.drawableInterval)}}return n},getInterval:function(q){var p=q.group;var o=p.geometry;var n=this.getIntervals(o,p);for(var m=0;m<n.length;m++){var l=n[m];if((q.start>=l.start)&&(q.start+q.count<=l.start+l.count)){return l}}return null},addLayerInterval:function(l){this.layers.push(l);this.upToDate=false},removeIntervals:function(p,o){var l=(o!==undefined);for(var n=0;n<this.layers.length;n++){var m=this.layers[n];if((m.geometry==p)&&(!l||(l&&(m.drawableGroup==o)))){this.layers.splice(n,1);n--}}this.upToDate=false},addPrimitivesToLayersOpacity:function(o,n,m){var l=[];this.addPrimitivesToLayers_internal(o,n,function(q){var p=l[q.id];if(!p){p=q.clone();p.opacity=m;p.transparent=true;l[q.id]=p}return p});this.upToDate=false},addPrimitivesToLayers:function(o,l,m,n){this.addPrimitivesToLayers_internal(o,l,function(){return m},n);this.upToDate=false},addPrimitivesToLayers_internal:function(v,n,q,s){var p,o;var t=[];for(p=0;p<v.length;p++){var l=v[p];for(o=0;o<t.length;o++){var u=t[o];if(u.length&&(u[0].group.geometry==l.group.geometry)&&(u[0].group==l.group)){u.push(l);break}}if(o==t.length){var u=[l];t.push(u)}}for(p=0;p<t.length;p++){t[p].sort(function(y,x){if(y.start<x.start){return -1}if(y.start>x.start){return 1}return 0})}for(p=0;p<t.length;p++){var m=t[p][0].group;var w=m.geometry;var r=q(m.gas);this.addPrimitivesToLayer(w,m,t[p],n,r,s)}},addPrimitivesToLayer:function(s,C,E,w,v,x){var B,K,m;var o=this.getIntervals(s,C);var D=[];if(!o.length){for(B=0;B<E.length;B++){var p=E[B];D.push(new j.DrawableInterval(w,p.start,p.count,v?v:null,x?x:null))}}else{var u=0;var t=o[u];var z=(x===undefined)?t.gas:x;var y=(v===undefined)?t.material:v;K=t.start;m=t.count;for(B=0;B<E.length;B++){var p=E[B];while(p.start+p.count>K+m){if(m){D.push(new j.DrawableInterval(t.layerNum,K,m,t.material,t.gas))}u++;t=o[u];z=(x===undefined)?t.gas:x;y=(v===undefined)?t.material:v;K=t.start;m=t.count}if((w!==t.layerNum)||(y!==t.material)||(z!==t.gas)){if(p.start>K){D.push(new j.DrawableInterval(t.layerNum,K,p.start-K,t.material,t.gas))}D.push(new j.DrawableInterval(w,p.start,p.count,y,z));var H=p.start+p.count;m=t.count-H+t.start;K=H}}if(m>0){D.push(new j.DrawableInterval(t.layerNum,K,m,t.material,t.gas))}for(var B=u+1;B<o.length;B++){D.push(o[B])}this.removeIntervals(s,C)}var L=D[0].layerNum;var l=D[0].material;var r=D[0].gas;K=D[0].start;m=0;for(B=0;B<D.length;B++){var n=D[B];if((n.layerNum===L)&&(n.material===l)&&(n.gas===r)){m+=n.count}else{var G=new j.DrawableInterval(L,K,m,l,r);this.addLayerInterval(new j.LayerInterval(s,C,G));L=n.layerNum;l=n.material;r=n.gas;K=n.start;m=n.count}if(B==D.length-1){var G=new j.DrawableInterval(L,K,m,l,r);this.addLayerInterval(new j.LayerInterval(s,C,G))}}for(var B=0;B<this.layers.length;B++){var J=this.layers[B];var F=J.drawableGroup;var I=J.drawableInterval;var A=0,q=0;if(F.primitives.length){if(F.primitives.length<20){while(I.start>F.primitives[A].start){A++}}else{A=c(F.primitives,I.start)}I.primitiveStart=A;while(I.start+I.count>F.primitives[A].start+F.primitives[A].count){A++}I.primitiveCount=A-I.primitiveStart+1}else{I.primitiveStart=0;I.primitiveCount=0}}}};function c(q,p){if(p<=q[0].start){return 0}var o=q.length-1;var l=0;var m,n=false;while(o-l>1){m=Math.floor((o+l)/2);if(q[m].start<p){l=m}else{o=m}}return o}j.EventTarget=function(){var l={};this.addEventListener=function(m,n){if(l[m]==undefined){l[m]=[]}if(l[m].indexOf(n)===-1){l[m].push(n)}};this.dispatchEvent=function(m){for(var n in l[m.type]){if(l[m.type].hasOwnProperty(n)){l[m.type][n](m)}}};this.removeEventListener=function(n,o){var m=l[n].indexOf(o);if(m!==-1){l[n].splice(m,1)}}};j.ImageUtils.crossOriginPolicy=true;j.ImageUtils.loadCompressedTexture=function(m,l,o,r,s,n){var q=new j.CompressedTexture();q.mapping=l;var p=new XMLHttpRequest();p.onload=function(){j.ImageUtils.nbTexturesBeingLoaded--;var v=p.response;var w=j.ImageUtils.parseDDS(v,true,s);q.format=w.format;if(w.type){q.type=w.type}q.width=w.width;q.height=w.height;if(w.isCubemap){var u=[];q.image=u;var t=w.mipmaps.length/w.mipmapCount;for(var z=0;z<t;z++){u[z]={mipmaps:[]};for(var y=0;y<w.mipmapCount;y++){u[z].mipmaps.push(w.mipmaps[z*w.mipmapCount+y]);u[z].format=w.format;u[z].width=w.width;u[z].height=w.height}}var x=u[3];u[3]=u[2];u[2]=x}else{q.mipmaps=w.mipmaps;q.image.width=w.width;q.image.height=w.height}q.generateMipmaps=false;if(!q.mipmaps){if(q.magFilter!=1003&&q.magFilter!=1006){q.magFilter=1006}if(q.minFilter!=1003&&q.minFilter!=1006){q.minFilter=1006}}q.needsUpdate=true;q.loadEndStatus="complete";if(o){o(q)}};if(n){q.loadEndStatus="pause";q.onRequest=function(){q.loadEndStatus="loading";j.ImageUtils.nbTexturesBeingLoaded++;p.open("GET",m,true);p.responseType="arraybuffer";p.send(null)}}else{q.loadEndStatus="loading";j.ImageUtils.nbTexturesBeingLoaded++;p.open("GET",m,true);p.responseType="arraybuffer";p.send(null)}return q};j.ImageUtils.loadCompressedTextureFromBuffer=function(l,n){var o=new j.CompressedTexture();o.loadEndStatus="complete";o.mapping=n;var m=j.ImageUtils.parseDDS(l,true);o.format=m.format;o.mipmaps=m.mipmaps;o.image.width=m.width;o.image.height=m.height;o.generateMipmaps=false;o.needsUpdate=true;return o};j.ImageUtils.parseDDS=function(ax,l,aw){if(aw===undefined){aw=true}var p={mipmaps:[],width:0,height:0,format:null,mipmapCount:1};var W=542327876;var aJ=1,K=2,at=4,A=8,Y=4096,ao=131072,aR=524288,aA=8388608;var C=8,aW=4194304,Q=4096;var ai=512,af=1024,aO=2048,ad=4096,aM=8192,ac=16384,aK=32768,R=2097152;var aa=1,aF=2,ak=4,aV=64,P=512,N=131072;var av=4;var am=28;var r=6;function y(aZ){return aZ.charCodeAt(0)+(aZ.charCodeAt(1)<<8)+(aZ.charCodeAt(2)<<16)+(aZ.charCodeAt(3)<<24)}function au(aZ){return String.fromCharCode(aZ&255,(aZ>>8)&255,(aZ>>16)&255,(aZ>>24)&255)}function aY(a0){var aZ=a0[4];a0[4]=a0[7];a0[7]=aZ;aZ=a0[5];a0[5]=a0[6];a0[6]=aZ}function az(a0){var aZ=a0[4];a0[4]=a0[5];a0[5]=aZ}function q(a0){var aZ=a0[0];a0[0]=a0[6];a0[6]=aZ;aZ=a0[1];a0[1]=a0[7];a0[7]=aZ;aZ=a0[2];a0[2]=a0[4];a0[4]=aZ;aZ=a0[3];a0[3]=a0[5];a0[5]=aZ;aY(a0.subarray(8,16))}function aG(a0){var aZ=a0[0];a0[0]=a0[2];a0[2]=aZ;aZ=a0[1];a0[1]=a0[3];a0[3]=aZ;aY(a0.subarray(8,16))}function B(a2){var a3=a2[2]+256*(a2[3]+256*a2[4]);var aZ=a2[5]+256*(a2[6]+256*a2[7]);var a0=((a3&4095)<<12)|((a3&16773120)>>12);var a1=((aZ&4095)<<12)|((aZ&16773120)>>12);a2[2]=a1&255;a2[3]=(a1&65280)>>8;a2[4]=(a1&16711680)>>8;a2[5]=a0&255;a2[6]=(a0&65280)>>8;a2[7]=(a0&16711680)>>8;aY(a2.subarray(8,16))}function B(a2){var a3=a2[2]+256*(a2[3]+256*a2[4]);var aZ=a2[5]+256*(a2[6]+256*a2[7]);var a0=((a3&4095)<<12)|((a3&16773120)>>12);var a1=((aZ&4095)<<12)|((aZ&16773120)>>12);a2[2]=a1&255;a2[3]=(a1&65280)>>8;a2[4]=(a1&16711680)>>8;a2[5]=a0&255;a2[6]=(a0&65280)>>8;a2[7]=(a0&16711680)>>8;aY(a2.subarray(8,16))}function aT(a0){var a1=a0[2]+256*(a0[3]+256*a0[4]);var aZ=((a1&4095)<<12);a0[2]=aZ&255;a0[3]=(aZ&65280)>>8;a0[4]=(aZ&16711680)>>8;aY(a0.subarray(8,16))}function aQ(a1,aZ){var a0;for(a0=0;a0<a1.length;a0++){a1[a0]=aZ[a0]}}function aB(ba,a9,a1,bg,bj){var aZ,a6,bc,bh,bk,a4,a2,bi,bf,a0,bl,a7,a5,a8,bd,be;switch(bg){case j.RGB_S3TC_DXT1_Format:bc=8;aZ=aY;a6=az;break;case j.RGBA_S3TC_DXT3_Format:bc=16;aZ=q;a6=aG;break;case j.RGBA_S3TC_DXT5_Format:bc=16;aZ=B;a6=aT;break;default:console.error("flip dds error");return bj}bh=ba;bk=a9;for(bf=0;bf<a1;++bf){bl=bj[bf].data;a4=Math.floor((bh+3)/4);a2=Math.floor((bk+3)/4);bi=a4*a2;if(bk==1){break}else{if(bk==2){for(bd=0;bd<a4;bd++){a6(bl.subarray(a0,bd*bc));a0=+bc}}else{a0=0;for(bd=1;bd<=bi;bd++){if(bd==4095){var bb}aZ(bl.subarray(a0,bd*bc));a0+=bc}be=bc*a4;a8=new Uint8Array(be);for(var a3=0;a3<a2/2;++a3){a7=bl.subarray(a3*be,(a3+1)*be);a5=bl.subarray((a2-a3-1)*be,(a2-a3)*be);aQ(a8,a7);aQ(a7,a5);aQ(a5,a8)}}}bh/=2;if(bh<1){ba=1}bk/=2;if(bk<1){a9=1}}}var M=y("DXT1");var L=y("DXT3");var I=y("DXT5");var aX=y("DX10");var u=116;var aL=31;var aH=5;var aj=0;var m=1;var al=2;var U=3;var s=4;var aN=7;var w=20;var ap=21;var ay=22;var n=23;var aS=24;var an=25;var t=26;var Z=27;var aE=28;var aD=29;var aC=30;var aI=32;var ar=33;var aU=34;var T=35;var x=36;var aq=new Int32Array(ax,0,aL+aH+1);if(aq[aj]!==W){console.error("ImageUtils.parseDDS(): Invalid magic number in DDS header");return p}var G=aq[n];var O=aq[aS];var H=aq[an];var ag=aq[t];var V;var F=aq[ap];if(F===aX){var ah=aq[aI];if((aq[aU]&av)||(aq[T]===6)){p.isCubemap=true}if(ah===am){p.format=j.RGBAFormat;V=4}else{if(ah===r){p.format=j.RGBFormat;V=12;p.type=j.FloatType;aw=false}}}else{switch(F){case M:V=8;p.format=j.RGB_S3TC_DXT1_Format;break;case L:V=16;p.format=j.RGBA_S3TC_DXT3_Format;break;case I:V=16;p.format=j.RGBA_S3TC_DXT5_Format;break;default:if(F===u){p.format=j.RGBAFormat;p.type=j.FloatType;V=16}else{if(aq[ay]===32&&aq[n]&16711680&&aq[aS]&65280&&aq[an]&255&&aq[t]&4278190080){p.format=j.RGBAFormat;V=4}else{if(aq[w]&aV){if(aq[w]&aa){p.format=j.RGBAFormat;V=4}else{p.format=j.RGBFormat;V=3}}else{console.error("ImageUtils.parseDDS(): Unsupported FourCC code: ",au(F));return p}}}}var ab=aq[aE];p.isCubemap=ab&ai?true:false;if(p.isCubemap&&(!(ab&af)||!(ab&aO)||!(ab&ad)||!(ab&aM)||!(ab&ac)||!(ab&aK))){console.error("THREE.DDSLoader.parse: Incomplete cubemap faces");return p}}p.mipmapCount=1;if(aq[al]&ao&&l!==false){p.mipmapCount=Math.max(1,aq[aN])}p.width=aq[s];p.height=aq[U];var S=aq[m]+4;if(F===aX){S+=20}var E=p.isCubemap?6:1;var v=(F===M)||(F===L)||(F===I);for(var o=0;o<E;o++){var aP=p.width;var D=p.height;var J=aP*D;if(v){J=Math.ceil(aP/4)*Math.ceil(D/4)}J*=V;for(var ae=0;ae<p.mipmapCount;ae++){var z=null;if(v){if(S+J>ax.byteLength){console.log("dxterror")}z=new Uint8Array(ax,S,J)}else{if(V===16){z=new Float32Array(ax,S,J/4)}else{if(V===12){z=new Float32Array(ax,S,J/4)}else{if(F===0&&(V!==3)){z=j.ImageUtils.getImageFromColorMasks(ax,S,J,G,O,H,ag)}else{z=j.ImageUtils.loadARGBMip(ax,S,aP,D,V)}}}}var X={data:z,width:aP,height:D};p.mipmaps.push(X);S+=J;aP/=2;if(aP<1){aP=1}D/=2;if(D<1){D=1}J=(v)?Math.ceil(aP/4)*Math.ceil(D/4):aP*D;J*=V}}if(aw){aB(p.width,p.height,p.mipmapCount,p.format,p.mipmaps)}return p};j.ImageUtils.loadARGBMip=function(C,s,B,A,z){var o=B*A*z;var v=(4-((z*B)%4))%4;var u=o+A*v;var l=new Uint8Array(C,s,o);var t=new Uint8Array(u);var G=0;var n=0;var m=0;for(var p=0;p<A;p++){for(var q=0;q<B;q++){var w=l[n];n++;var D=l[n];n++;var E=l[n];n++;var F;if(z===4){F=l[n];n++}t[G]=w;G++;t[G]=D;G++;t[G]=E;G++;if(z===4){t[G]=F;G++}}G+=v}return t};j.ImageUtils.getImageFromColorMasks=function(o,p,n,s,q,x,z){var u=new Int32Array(o,p,n/4);var m=new Uint8Array(n);var y=j.ImageUtils.computeMaskShift(s);var t=j.ImageUtils.computeMaskShift(q);var l=j.ImageUtils.computeMaskShift(x);var v=j.ImageUtils.computeMaskShift(z);for(var r=0;r<n/4;r++){var w=u[r];m[4*r]=(w&s)>>y;m[4*r+1]=(w&q)>>t;m[4*r+2]=(w&x)>>l;m[4*r+3]=(w&z)>>v}return m};j.ImageUtils.computeMaskShift=function(l){var n=l;var m=0;while(!(n&1)){n=n>>1;m++}return m};j.InfinitePlaneShader={uniforms:j.UniformsUtils.merge([j.UniformsLib.common,j.UniformsLib.lights,j.UniformsLib.shadowmap,{ambient:{type:"c",value:new j.Color(328965)},emissive:{type:"c",value:new j.Color(0)},specular:{type:"c",value:new j.Color(1118481)},border:{type:"c",value:new j.Color(268065)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new j.Vector3(1,1,1)},attenuation:{type:"i",value:0},displayGrid:{type:"f",value:1},displayPlane:{type:"f",value:1},gridFromBelow:{type:"f",value:1},gridTexture:{type:"t",value:null},gridTexture2:{type:"t",value:null},gridTexture3:{type:"t",value:null},gridTexture4:{type:"t",value:null},nbSteps:{type:"f",value:5},gridUnit:{type:"f",value:1},gridOffset:{type:"v2",value:new j.Vector2()},gridCoeff:{type:"f",value:0},gridColor:{type:"c",value:new j.Color(16777215)},planeSize:{type:"f",value:100},planeBorder:{type:"f",value:1},planeFalloff:{type:"f",value:0},gridFalloff:{type:"f",value:0},uvScale:{type:"f",value:1},planeOpacity:{type:"f",value:1}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;","#ifndef USE_MAP","varying vec2 vUv;","#endif",j.ShaderChunk.map_pars_vertex,j.ShaderChunk.clip_pars_vertex,j.ShaderChunk.lights_phong_pars_vertex,j.ShaderChunk.color_pars_vertex,j.ShaderChunk.shadowmap_pars_vertex,"void main() {","vUv = uv;",j.ShaderChunk.color_vertex,j.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",j.ShaderChunk.default_vertex,j.ShaderChunk.clip_vertex,"vViewPosition = -mvPosition.xyz;",j.ShaderChunk.worldpos_vertex,j.ShaderChunk.lights_phong_vertex,j.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["const vec3 vOrthoDir = vec3(0.0, 0.0, 1.0);","uniform vec3 diffuse;","uniform float planeOpacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform vec3 border;","uniform int attenuation;","#ifdef PLANE_V2","const float alphaSlope = 0.66666666667;","const float alphaSlope2 = 0.44444444444;","const float edgeSize = 0.01;","const float stepSize = 0.001;","const float small2GridWidth = 0.0005;","const float smallGridWidth = 0.0005;","const float bigGridWidth = 0.0005;","uniform float displayGrid;","uniform float displayPlane;","uniform float gridFromBelow;","uniform float planeFalloff;","uniform float gridFalloff;","uniform float planeSize;","uniform float planeBorder;","uniform sampler2D gridTexture;","uniform sampler2D gridTexture2;","uniform sampler2D gridTexture3;","uniform sampler2D gridTexture4;","uniform float nbSteps;","uniform float gridUnit;","uniform vec2 gridOffset;","uniform float gridCoeff;","uniform vec3 gridColor;","#ifdef USE_MAP","uniform sampler2D map;","#endif","#endif","uniform float uvScale;","varying vec2 vUv;","vec2 uvToUse;",j.ShaderChunk.color_pars_fragment,j.ShaderChunk.lights_phong_pars_fragment,j.ShaderChunk.shadowmap_pars_fragment,"void main() {","uvToUse = vUv * uvScale;","vec3 I = vOrthoDir;","gl_FragColor = vec4(1.0);","if (!(projectionMatrix[3][3] > 0.0)) {","  I = normalize(vViewPosition);","}","float fresnelFactor = dot(I, vNormal);","#ifndef PLANE_V2","if (fresnelFactor < 0.0) {","  discard;","}","if (attenuation == 0) {","  fresnelFactor = 1.0;","}","#endif",j.ShaderChunk.alphatest_fragment,"float shininessValue = shininess;",j.ShaderChunk.specularmap_fragment,j.ShaderChunk.lights_phong_fragment,j.ShaderChunk.color_fragment,"vec3 cCenter = gl_FragColor.xyz;","vec3 cBorder = border;","#if defined(GAMMA_INPUT)","cBorder *= cBorder;","#endif","#ifdef PLANE_V2","float dUV = length(2.0 * vUv - 1.0);","float borderMask = planeBorder * smoothstep(1.0 - 2.0 * edgeSize, 1.0 - 2.0 * edgeSize + stepSize, dUV) * smoothstep(1.0 - edgeSize + stepSize, 1.0 - edgeSize, dUV);","float a2 = max(1.0 - alphaSlope2 * (1.0 + gridCoeff) * (1.0 + gridCoeff), 0.0);","float a1 = 1.0 - alphaSlope2 * gridCoeff * gridCoeff;","float a0 = 1.0 - alphaSlope2 * (1.0 - gridCoeff) * (1.0 - gridCoeff);","float a00 = max(1.0 - alphaSlope2 * (2.0 - gridCoeff) * (2.0 - gridCoeff), 0.0);","vec2 div = 0.5 * planeSize * (2.0 * vUv - 1.0) + gridOffset;","vec2 big2Div = (1.0 / (nbSteps * nbSteps)) * div / gridUnit;","vec2 bigDiv = (1.0 / nbSteps) * div / gridUnit;","vec2 smallDiv = div / gridUnit;","vec2 small2Div = nbSteps * div / gridUnit;","float gridAlpha = texture2D(gridTexture, small2Div).a;","gridAlpha *= a2;","gridAlpha += a1 * texture2D(gridTexture2, smallDiv).a;","gridAlpha += a0 * texture2D(gridTexture3, bigDiv).a;","gridAlpha += a00 * texture2D(gridTexture4, big2Div).a;","gridAlpha = min(1.0, gridAlpha);","#ifdef USE_MAP","vec4 texelColor = texture2D( map, uvToUse );","#ifdef GAMMA_INPUT","texelColor.xyz *= texelColor.xyz;","#endif","cCenter = mix(cCenter, texelColor.xyz, texelColor.a);","#endif","float planeAlpha = 1.0001 - smoothstep(planeFalloff, 1.0, dUV);","gridAlpha *= 1.0001 - smoothstep(gridFalloff, 1.0, dUV);","planeAlpha *= planeOpacity * step(0.0, fresnelFactor) * displayPlane;","gridAlpha *= step(-gridFromBelow, fresnelFactor) * displayGrid;","vec4 planeCol = vec4(mix(mix(cCenter, cBorder, planeBorder), cCenter, planeAlpha), mix(planeAlpha, 1.0, planeBorder));","vec4 gridCol = vec4(gridColor * gridColor, gridAlpha);","vec4 gridOverPlaneColor = vec4((gridCol.xyz * gridCol.a + planeCol.xyz * planeCol.a * (1.0 - gridCol.a)) / (0.0001 + gridCol.a + planeCol.a * (1.0 - gridCol.a)), gridCol.a + planeCol.a * (1.0 - gridCol.a));","gl_FragColor = mix(gridOverPlaneColor, vec4(cBorder, borderMask), step(1.0 - 2.0 * edgeSize, dUV));","#else","vec2 dUV = 2.0 * (vUv * 2.0 - 1.0);","float dist = dot(dUV, dUV);","float dist2 = clamp(dist * dist, 0.0, 1.0);","dist = clamp(dist, 0.0, 1.0);","gl_FragColor = vec4(mix(cCenter, cBorder, dist), fresnelFactor*(1.0 - dist2));","#endif",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n"),fragmentShaderFirstDirOnly:["const vec3 vOrthoDir = vec3(0.0, 0.0, 1.0);","uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform vec3 border;","uniform int attenuation;","varying vec2 vUv;"," vec2 uvToUse;",j.ShaderChunk.color_pars_fragment,j.ShaderChunk.lights_phong_pars_fragment,j.ShaderChunk.shadowmap_pars_fragment,"void main() {","uvToUse=vUv;","vec3 I = vOrthoDir;","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );","if (!(projectionMatrix[3][3] > 0.0)) {","  I = normalize(vViewPosition);","}","float fresnelFactor = dot(I, vNormal);","if (fresnelFactor < 0.0) {","  discard;","}","if (attenuation == 0) {","  fresnelFactor = 1.0;","}",j.ShaderChunk.alphatest_fragment,j.ShaderChunk.specularmap_fragment,j.ShaderChunk.lights_phong_firstdironly_fragment,j.ShaderChunk.color_fragment,"vec3 cCenter = gl_FragColor.xyz;","vec3 cBorder = border;","#ifdef GAMMA_INPUT","cBorder *= cBorder;","#endif","vec2 dUV = 2.0 * (vUv * 2.0 - 1.0);","float dist = dot(dUV, dUV);","float dist2 = clamp(dist * dist, 0.0, 1.0);","dist = clamp(dist, 0.0, 1.0);","gl_FragColor = vec4(mix(cCenter, cBorder, dist), fresnelFactor*(1.0 - dist2));",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};j.InfinitePlaneShaderSimple={uniforms:j.UniformsUtils.merge([j.UniformsLib.common,{ambient:{type:"c",value:new j.Color(328965)},emissive:{type:"c",value:new j.Color(0)},specular:{type:"c",value:new j.Color(1118481)},border:{type:"c",value:new j.Color(268065)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new j.Vector3(1,1,1)},attenuation:{type:"i",value:0}}]),vertexShader:["varying vec3 vViewPosition;","varying vec3 vNormal;","varying vec2 vUv;",j.ShaderChunk.color_pars_vertex,"void main() {","vUv = uv;",j.ShaderChunk.color_vertex,j.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",j.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",j.ShaderChunk.worldpos_vertex,"}"].join("\n"),fragmentShader:["const vec3 vOrthoDir = vec3(0.0, 0.0, 1.0);","uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform vec3 border;","uniform int attenuation;","varying vec3 vViewPosition;","varying vec3 vNormal;","varying vec2 vUv;"," vec2 uvToUse;",j.ShaderChunk.color_pars_fragment,"void main() {","uvToUse=vUv;","vec3 I = vOrthoDir;","gl_FragColor = vec4( diffuse, opacity );","if (!(projectionMatrix[3][3] > 0.0)) {","  I = normalize(vViewPosition);","}","float fresnelFactor = dot(I, vNormal);","if (fresnelFactor < 0.0) {","  discard;","}","if (attenuation == 0) {","  fresnelFactor = 1.0;","}",j.ShaderChunk.alphatest_fragment,j.ShaderChunk.specularmap_fragment,j.ShaderChunk.color_fragment,"vec3 cCenter = gl_FragColor.xyz;","vec3 cBorder = border;","#ifdef GAMMA_INPUT","cBorder *= cBorder;","#endif","vec2 dUV = 2.0 * (vUv * 2.0 - 1.0);","float dist = dot(dUV, dUV);","float dist2 = clamp(dist * dist, 0.0, 1.0);","dist = clamp(dist, 0.0, 1.0);","gl_FragColor = vec4(mix(cCenter, cBorder, dist), fresnelFactor*(1.0 - dist2));",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};j.TexturedGridShader={uniforms:j.UniformsUtils.merge([j.UniformsLib.common,j.UniformsLib.fog,j.UniformsLib.lights,j.UniformsLib.shadowmap,{ambient:{type:"c",value:new j.Color(328965)},emissive:{type:"c",value:new j.Color(0)},specular:{type:"c",value:new j.Color(1118481)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new j.Vector3(1,1,1)},gridCenter:{type:"v3",value:new j.Vector3()},gridSize:{type:"f",value:1},attenuation:{type:"f",value:1}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;",j.ShaderChunk.map_pars_vertex,"void main() {",j.ShaderChunk.map_vertex,j.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",j.ShaderChunk.worldpos_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform vec3 gridCenter;","uniform float gridSize;","uniform float attenuation;",j.ShaderChunk.map_pars_fragment,j.ShaderChunk.lights_phong_pars_fragment,"void main() {","gl_FragColor = vec4( diffuse, 1.0 );","vec4 texelColor = texture2D( map, vUv );","gl_FragColor *= texelColor;",j.ShaderChunk.color_fragment,"vec3 cCenter = gl_FragColor.xyz;","vec3 cBorder = cCenter;","#ifdef GAMMA_INPUT","cBorder *= cBorder;","#endif","vec3 vecDist = - vViewPosition - gridCenter;","float dist = 16.0 * dot(vecDist, vecDist);","dist /= (gridSize * gridSize);","dist = clamp(dist, 0.0, 1.0);","gl_FragColor = vec4( mix(vec4(cCenter, 0.9 * attenuation), vec4(cBorder, 0.0), dist));","gl_FragColor.a *= texelColor.a;","}"].join("\n")};j.GridShader={uniforms:j.UniformsUtils.merge([j.UniformsLib.common,j.UniformsLib.fog,j.UniformsLib.lights,j.UniformsLib.shadowmap,{ambient:{type:"c",value:new j.Color(328965)},emissive:{type:"c",value:new j.Color(0)},specular:{type:"c",value:new j.Color(1118481)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new j.Vector3(1,1,1)},gridCenter:{type:"v3",value:new j.Vector3()},gridSize:{type:"f",value:1},attenuation:{type:"f",value:1},startFalloff:{type:"f",value:0},endFalloff:{type:"f",value:1}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;",j.ShaderChunk.color_pars_vertex,"void main() {",j.ShaderChunk.color_vertex,j.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",j.ShaderChunk.worldpos_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform vec3 gridCenter;","uniform float gridSize;","uniform float attenuation;","#ifdef GRID_V2","uniform float startFalloff;","uniform float endFalloff;","#endif",j.ShaderChunk.color_pars_fragment,j.ShaderChunk.lights_phong_pars_fragment,"void main() {","gl_FragColor = vec4( diffuse, 0.6 );",j.ShaderChunk.color_fragment,"vec3 cCenter = gl_FragColor.xyz;","vec3 cBorder = cCenter;","#ifdef GAMMA_INPUT","cBorder *= cBorder;","#endif","vec3 vecDist = - vViewPosition - gridCenter;","#ifdef GRID_V2","float gridRadius = 0.5 * gridSize;","float dist = smoothstep(startFalloff * gridRadius, endFalloff * gridRadius, length(vecDist));","#else","float dist = 16.0 * dot(vecDist, vecDist);","dist /= (gridSize * gridSize);","dist = clamp(dist, 0.0, 1.0);","#endif","gl_FragColor = vec4( mix(vec4(cCenter, 0.6 * attenuation), vec4(cBorder, 0.0), dist));",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};j.BigGridShader={uniforms:j.UniformsUtils.merge([j.UniformsLib.common,j.UniformsLib.fog,j.UniformsLib.lights,j.UniformsLib.shadowmap,{ambient:{type:"c",value:new j.Color(328965)},emissive:{type:"c",value:new j.Color(0)},specular:{type:"c",value:new j.Color(1118481)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new j.Vector3(1,1,1)},gridCenter:{type:"v3",value:new j.Vector3()},gridSize:{type:"f",value:1},attenuation:{type:"f",value:1}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;",j.ShaderChunk.color_pars_vertex,"void main() {",j.ShaderChunk.color_vertex,j.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",j.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",j.ShaderChunk.worldpos_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform vec3 gridCenter;","uniform float gridSize;","uniform float attenuation;",j.ShaderChunk.color_pars_fragment,j.ShaderChunk.lights_phong_pars_fragment,"void main() {","gl_FragColor = vec4( diffuse, opacity );",j.ShaderChunk.color_fragment,"vec3 cCenter = gl_FragColor.xyz;","vec3 cBorder = cCenter;","#ifdef GAMMA_INPUT","cBorder *= cBorder;","#endif","vec3 vecDist = - vViewPosition - gridCenter;","float dist = 16.0 * dot(vecDist, vecDist);","dist /= (gridSize * gridSize);","dist = clamp(dist, 0.0, 1.0);","gl_FragColor = vec4( mix(vec4(cCenter, attenuation), vec4(cBorder, 0.0), dist));",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};j.SmallPlaneShader={uniforms:j.UniformsUtils.merge([j.UniformsLib.common,j.UniformsLib.lights,j.UniformsLib.shadowmap,{groundShadow:{type:"t",value:null}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;","varying vec2 vUv;",j.ShaderChunk.color_pars_vertex,j.ShaderChunk.clip_pars_vertex,j.ShaderChunk.shadowmap_pars_vertex,"void main() {","vUv = uv;",j.ShaderChunk.color_vertex,j.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",j.ShaderChunk.default_vertex,j.ShaderChunk.clip_vertex,"vViewPosition = -mvPosition.xyz;",j.ShaderChunk.worldpos_vertex,j.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["const vec3 vOrthoDir = vec3(0.0, 0.0, 1.0);","uniform vec3 diffuse;","uniform float opacity;","#ifdef GROUND_SHADOW","  uniform sampler2D groundShadow;","#endif","varying vec3 vViewPosition;","varying vec3 vNormal;","varying vec2 vUv;","vec2 uvToUse;",j.ShaderChunk.color_pars_fragment,j.ShaderChunk.shadowmap_pars_fragment,"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );","uvToUse=vUv;","vec3 I = vOrthoDir;","if (!(projectionMatrix[3][3] > 0.0)) {","  I = normalize(vViewPosition);","}","if (dot(I, vNormal) < 0.0) {","  discard;","}",j.ShaderChunk.alphatest_fragment,j.ShaderChunk.color_fragment,j.ShaderChunk.shadowmap_fragment,"#ifdef GROUND_SHADOW","  float shadowCoeff = texture2D(groundShadow, vUv).x;","  gl_FragColor.xyz *= shadowCoeff;","#endif","vec2 toCenter = 2.0 * (vec2(0.5) - vUv);","float distToCenter = min(1.0, dot(toCenter, toCenter));","gl_FragColor = vec4(mix(gl_FragColor.xyz, vec3(1.0), distToCenter), 1.0);","}"].join("\n")};j.LightProbeMapShader={defines:{sRGB:false,HDR:false},uniforms:{tEnvMap:{type:"t",value:null},ambient:{type:"c",value:new j.Color(16777215)}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tEnvMap;","uniform vec3 ambient;","varying vec3 vWorldPosition;","const float PI = 3.14159;","const float INV_PI = 0.31830988618;","void main() {","vec3 dir = normalize(vWorldPosition - cameraPosition);","dir = vec3(dir.y, dir.z, dir.x);","float probeR = INV_PI * acos( dir.z ) / length(dir.xy);","gl_FragColor = texture2D( tEnvMap, 0.5 * (probeR * dir.xy + 1.0) );","#if defined( GAMMA_INPUT ) && defined( sRGB )","gl_FragColor *= gl_FragColor;","#endif","gl_FragColor *= vec4(ambient, 1.0);","}"].join("\n")};j.FiniteEnvMap={defines:{PROJECTION_CONIC:true,LATLONG_MAP:true,sRGB:false,HDR:false,AMBIENCE_V2:false},uniforms:{tEnvMap:{type:"t",value:null},tEnvMap2:{type:"t",value:null},envMapHDRSize:{type:"v2",value:new j.Vector4(2048,1024)},invScreenSize:{type:"v2",value:new j.Vector2()},tFlip:{type:"f",value:-1},ambienceMatrix:{type:"m4",value:new j.Matrix4()},groundPosition:{type:"v3",value:new j.Vector3(0,0,0)},groundNormal:{type:"v3",value:new j.Vector3(0,0,1)},sceneHeight:{type:"v3",value:new j.Vector3(0,0,0.15)},groundHeight:{type:"v3",value:new j.Vector3(0,0,0.23)},groundOffset:{type:"f",value:0},groundRadius:{type:"f",value:5000},blurCoef:{type:"f",value:0},withGround:{type:"f",value:0},groundScale:{type:"f",value:0.78},intensity:{type:"f",value:1},envMapExposure:{type:"f",value:1},ambient:{type:"c",value:new j.Color(16777215)}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#if defined( LATLONG_MAP ) ","uniform sampler2D tEnvMap;","#else","uniform samplerCube tEnvMap;","#endif","#if defined( ENVMAP2 ) ","uniform sampler2D tEnvMap2;","#endif","uniform float blurCoef;","uniform float withGround;","uniform float envMapExposure;","uniform float tFlip;","uniform vec3 ambient;","uniform vec3 groundPosition;","uniform vec3 groundNormal;","uniform vec3 sceneHeight;","uniform vec3 groundHeight;","uniform float groundOffset;","uniform float groundRadius;","uniform float groundScale;","uniform float intensity;","uniform vec2 invScreenSize;","uniform mat4 ambienceMatrix;","varying vec3 vWorldPosition;","const float PI = 3.14159;","const float INV_PI = 0.31830988618;","#if defined( HDR )","uniform vec2 envMapHDRSize;","vec4 texture2DFromRGBE(sampler2D textureSampler, vec2 uv) {","vec4 texelRGBE = texture2D(textureSampler, uv);","float exponent = pow(2.0, 255.0 * texelRGBE.w - 128.0);","return vec4((255.0 / 256.0) * texelRGBE.xyz * exponent, 1.0);","}","vec4 texture2DBilinearFromRGBE(sampler2D textureSampler, vec2 uv, vec2 textureSize, vec2 texelSize) {","vec4 tl = texture2DFromRGBE(textureSampler, uv);","vec4 tr = texture2DFromRGBE(textureSampler, uv + vec2(texelSize.x, 0.0));","vec4 bl = texture2DFromRGBE(textureSampler, uv + vec2(0.0, texelSize.y));","vec4 br = texture2DFromRGBE(textureSampler, uv + vec2(texelSize.x, texelSize.y));","vec2 f = fract(uv.xy * textureSize.xy);","vec4 tA = mix(tl, tr, f.x);","vec4 tB = mix(bl, br, f.x);","return mix(tA, tB, f.y);","}","vec4 sampleMipMapRoughness(vec2 uv, float mip, float coef, sampler2D map0, sampler2D map1, vec2 textureSize, vec2 texelSize) {","vec4 color1;","vec4 color2;","vec2 uv1;","vec2 uv2;","if (mip < 1.0) {","color1 = texture2DBilinearFromRGBE(map0, uv, textureSize, texelSize);","} else {","textureSize.y *= 2.0;","texelSize.y *= 0.5;","float level1 = clamp(floor(mip) - 1.0, 0.0, 4.0);","float t10 = pow(2.0, -floor(log2(level1 + 1.0)));","float t11 = 2.0 - (level1 + 2.0) * t10;","float t12 = 0.5 * t10;","uv1 = vec2(t11 + 1.5 * texelSize.x + (2.0 * t12 - 3.0 * texelSize.x) * uv.x, t12 + 1.5 * texelSize.x + (t12 - 3.0 * texelSize.x) * uv.y);","color1 = texture2DBilinearFromRGBE(map1, uv1, textureSize, texelSize);","}","float level2 = clamp(floor(mip), 0.0, 5.0);","float t20 = pow(2.0, -floor(log2(level2 + 1.0)));","float t21 = 2.0 - (level2 + 2.0) * t20;","float t22 = 0.5 * t20;","uv2 = vec2(t21 + 1.5 * texelSize.x + (2.0 * t22 - 3.0 * texelSize.x) * uv.x, t22 + 1.5 * texelSize.x + (t22 - 3.0 * texelSize.x) * uv.y);","color2 = texture2DBilinearFromRGBE(map1, uv2, textureSize, texelSize);","return mix(color1, color2, coef);","}","#endif","vec2 MapNormalToTextureCoordinate(vec3 iNormal) {","float phi = atan(iNormal.y, iNormal.x);","float theta = acos(iNormal.z);","vec2 reflectionUV = vec2(fract(0.5 + 0.5 * INV_PI * phi), 1.0 - INV_PI * theta);","return reflectionUV;","}","float IntersectPlane(vec3 iPos, vec3 iRay, vec3 iPlaneOrig, vec3 iPlaneNormal) {","float t = dot(iPlaneNormal, iPlaneOrig-iPos);","float cosNormalDir = dot(iPlaneNormal, iRay);","if (cosNormalDir==0.0) return 0.0;","t = t/cosNormalDir;","return t;","}","float IntersectSphereFar(vec3  iSphereCenter, float iSphereRadius, vec3 iRayDir, vec3  iRayOrig) {","   vec3 dist = iRayOrig - iSphereCenter;","   float B = 2.0*dot(iRayDir, dist);","   float C = dot(dist, dist) - iSphereRadius*iSphereRadius;","   float disc = B*B - 4.0*C;","   if (disc < 0.0)","       return -1.0;","   float t = (-B + sqrt(disc)) / 2.0;","   return t;","}","void main() {","vec3 n = normalize(vWorldPosition - cameraPosition);","vec3 groundPos = (ambienceMatrix * vec4(groundPosition, 1.0)).xyz;","vec3 groundNor = (ambienceMatrix * vec4(groundNormal, 0.0)).xyz;","vec3  sphereCenter  = groundPos + groundNor * sceneHeight * groundRadius;","vec3  offset  = vec3(0.0,0.0,groundOffset);","offset = (ambienceMatrix * vec4(offset, 0.0)).xyz;","#if defined( AMBIENCE_V2 ) ","groundNor = groundNormal;","sphereCenter  = groundPosition +  sceneHeight * groundRadius;","offset = groundOffset * groundNor;","groundPos = groundPosition + offset;","#endif","float sphereRadius  = groundRadius * groundScale;","vec3  rayDir      = vec3(0.0);","vec3  rayOrig     = vec3(0.0);","if (sphereRadius > 0.0) {","#if defined( PROJECTION_CONIC ) ","rayDir      = n;","rayOrig     = cameraPosition;","#else","#endif","float t =  IntersectSphereFar(sphereCenter, sphereRadius, rayDir, rayOrig);","vec3  planeNormal = groundNor;","if (t>0.0) {","if (dot(planeNormal, rayDir)<0.0){","#if defined( AMBIENCE_V2 ) ","float planeT  = IntersectPlane(rayOrig, rayDir, groundPos, planeNormal);","#else","float planeT  = IntersectPlane(rayOrig, rayDir, groundPos + offset, planeNormal);","#endif","planeT = planeT * withGround;","#if defined( PROJECTION_CONIC ) ","t = (planeT>0.0) ? min(planeT,t) : t;","#else","#endif","}","vec3 hitPos = rayOrig + t*rayDir;","#if defined( AMBIENCE_V2 ) ","vec3 projectionCenter = groundPosition + groundHeight * sphereRadius; ","#else","vec3 projectionCenter = groundPos + offset ; ","projectionCenter += groundNor * groundHeight*groundRadius;","#endif","vec3 sn = (hitPos - projectionCenter);","n = normalize(sn);","}","}","#if defined( LATLONG_MAP ) ","n = (ambienceMatrix * vec4(n, 0.0)).xyz;","#if defined( HDR )","#else","n.y *= -1.0;","#endif","vec2 coords = MapNormalToTextureCoordinate(n);","#if defined( HDR )","vec2 texelSize = vec2(1.0 / envMapHDRSize);","#if defined( ENVMAP2 )","float mipValue = max(6.0 + 1.15 * log2(blurCoef + 0.0000001), 0.0);","float mipCoef = fract(mipValue);","if (mipValue > 6.0) {","mipValue = 6.0;","mipCoef = 1.0;","}","gl_FragColor.xyz = envMapExposure * sampleMipMapRoughness( coords, mipValue, mipCoef, tEnvMap, tEnvMap2, envMapHDRSize, texelSize ).xyz;","#else","gl_FragColor.xyz = envMapExposure * texture2DBilinearFromRGBE( tEnvMap, coords, envMapHDRSize, texelSize ).xyz;","#endif","#else","gl_FragColor.xyz = envMapExposure * texture2D( tEnvMap, coords ).xyz;","#endif","#else","n = (ambienceMatrix * vec4(n, 0.0)).xyz;","gl_FragColor.xyz = envMapExposure * textureCube(tEnvMap, vec3(n.x, -n.z,n.y)).xyz;","#endif","gl_FragColor.w = 1.0;","#if defined( GAMMA_OUTPUT ) && defined( HDR )","gl_FragColor.xyz = pow(gl_FragColor.xyz, vec3(1.0 / 2.2));","#elif !defined( GAMMA_OUTPUT ) && defined( sRGB )","gl_FragColor.xyz *= gl_FragColor.xyz;","#endif","gl_FragColor *= vec4(ambient, 1.0);","}"].join("\n")};j.CubeMapShader={uniforms:{tEnvMap:{type:"t",value:null},tFlip:{type:"f",value:-1},envMapExposure:{type:"f",value:1},ambienceMatrix:{type:"m4",value:new j.Matrix4()},ambient:{type:"c",value:new j.Color(16777215)}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform samplerCube tEnvMap;","uniform float tFlip;","uniform vec3 ambient;","uniform float envMapExposure;","uniform mat4 ambienceMatrix;","varying vec3 vWorldPosition;","void main() {","vec3 relPos = vWorldPosition - cameraPosition;","relPos = (ambienceMatrix * vec4(relPos,0.0)).xyz;","#if defined(CUBEMAP_ZUP)","gl_FragColor = vec4(ambient, 1.0) * textureCube( tEnvMap, vec3( -relPos.x, relPos.zy ) );","#else","gl_FragColor = vec4(ambient, 1.0) * textureCube( tEnvMap, vec3( relPos.x, -relPos.z, relPos.y ) );","#endif","}"].join("\n")};j.LatLongMapShader={defines:{sRGB:false,HDR:false},uniforms:{tEnvMap:{type:"t",value:null},tEnvMap2:{type:"t",value:null},envMapHDRSize:{type:"v2",value:new j.Vector4(2048,1024)},invScreenSize:{type:"v2",value:new j.Vector2()},cameraSight:{type:"v3",value:new j.Vector3()},cameraUp:{type:"v3",value:new j.Vector3()},cameraRight:{type:"v3",value:new j.Vector3()},startOffset:{type:"v2",value:new j.Vector2(0,0)},endOffset:{type:"v2",value:new j.Vector2(1,1)},ambienceMatrix:{type:"m4",value:new j.Matrix4()},blurCoef:{type:"f",value:0},envMapExposure:{type:"f",value:1},ambient:{type:"c",value:new j.Color(16777215)}},vertexShader:["void main() {",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tEnvMap;","#if defined( ENVMAP2 ) ","uniform sampler2D tEnvMap2;","#endif","uniform mat4 ambienceMatrix;","uniform float blurCoef;","uniform float envMapExposure;","uniform vec3 ambient;","uniform vec2 invScreenSize;","uniform vec3 cameraSight;","uniform vec3 cameraUp;","uniform vec3 cameraRight;","uniform vec2 startOffset;","uniform vec2 endOffset;","const float INV_PI = 0.31830988618379;","const float PI = 3.14159265359;","#if defined( HDR )","uniform vec2 envMapHDRSize;","vec4 texture2DFromRGBE(sampler2D textureSampler, vec2 uv) {","vec4 texelRGBE = texture2D(textureSampler, uv);","float exponent = pow(2.0, 255.0 * texelRGBE.w - 128.0);","return vec4((255.0 / 256.0) * texelRGBE.xyz * exponent, 1.0);","}","vec4 texture2DBilinearFromRGBE(sampler2D textureSampler, vec2 uv, vec2 textureSize, vec2 texelSize) {","vec4 tl = texture2DFromRGBE(textureSampler, uv);","vec4 tr = texture2DFromRGBE(textureSampler, uv + vec2(texelSize.x, 0.0));","vec4 bl = texture2DFromRGBE(textureSampler, uv + vec2(0.0, texelSize.y));","vec4 br = texture2DFromRGBE(textureSampler, uv + vec2(texelSize.x, texelSize.y));","vec2 f = fract(uv.xy * textureSize.xy);","vec4 tA = mix(tl, tr, f.x);","vec4 tB = mix(bl, br, f.x);","return mix(tA, tB, f.y);","}","vec4 sampleMipMapRoughness(vec2 uv, float mip, float coef, sampler2D map0, sampler2D map1, vec2 textureSize, vec2 texelSize) {","vec4 color1;","vec4 color2;","vec2 uv1;","vec2 uv2;","if (mip < 1.0) {","color1 = texture2DBilinearFromRGBE(map0, uv, textureSize, texelSize);","} else {","textureSize.y *= 2.0;","texelSize.y *= 0.5;","float level1 = clamp(floor(mip) - 1.0, 0.0, 4.0);","float t10 = pow(2.0, -floor(log2(level1 + 1.0)));","float t11 = 2.0 - (level1 + 2.0) * t10;","float t12 = 0.5 * t10;","uv1 = vec2(t11 + 1.5 * texelSize.x + (2.0 * t12 - 3.0 * texelSize.x) * uv.x, t12 + 1.5 * texelSize.x + (t12 - 3.0 * texelSize.x) * uv.y);","color1 = texture2DBilinearFromRGBE(map1, uv1, textureSize, texelSize);","}","float level2 = clamp(floor(mip), 0.0, 5.0);","float t20 = pow(2.0, -floor(log2(level2 + 1.0)));","float t21 = 2.0 - (level2 + 2.0) * t20;","float t22 = 0.5 * t20;","uv2 = vec2(t21 + 1.5 * texelSize.x + (2.0 * t22 - 3.0 * texelSize.x) * uv.x, t22 + 1.5 * texelSize.x + (t22 - 3.0 * texelSize.x) * uv.y);","color2 = texture2DBilinearFromRGBE(map1, uv2, textureSize, texelSize);","return mix(color1, color2, coef);","}","#endif","void main() {","vec2 screenOffset = 2.0 * mix(startOffset, endOffset, gl_FragCoord.xy * invScreenSize) - 1.0;","vec3 dir = normalize(cameraSight + screenOffset.x * cameraRight + screenOffset.y * cameraUp);","dir = (ambienceMatrix * vec4(dir,0.0)).xyz;","#if defined( HDR )","#else","dir.y *= -1.0;","#endif","float phi = atan(dir.y, dir.x);","float theta = acos(dir.z);","vec2 texelCoord = vec2(fract(0.5 + 0.5 * INV_PI * phi), 1.0 - INV_PI * theta);","#if defined( HDR )","vec2 texelSize = vec2(1.0 / envMapHDRSize);","#if defined( ENVMAP2 )","float mipValue = max(6.0 + 1.15 * log2(blurCoef + 0.0000001), 0.0);","float mipCoef = fract(mipValue);","if (mipValue > 6.0) {","mipValue = 6.0;","mipCoef = 1.0;","}","gl_FragColor.xyz = envMapExposure * sampleMipMapRoughness( texelCoord, mipValue, mipCoef, tEnvMap, tEnvMap2, envMapHDRSize, texelSize ).xyz;","#else","gl_FragColor.xyz = envMapExposure * texture2DBilinearFromRGBE( tEnvMap, texelCoord, envMapHDRSize, texelSize ).xyz;","#endif","#else","gl_FragColor.xyz = envMapExposure * texture2D( tEnvMap, texelCoord ).xyz;","#endif","gl_FragColor.w = 1.0;","#if defined( GAMMA_OUTPUT ) && defined( HDR )","gl_FragColor.xyz = pow(gl_FragColor.xyz, vec3(1.0 / 2.2));","#elif !defined( GAMMA_OUTPUT ) && defined( sRGB )","gl_FragColor.xyz = pow(gl_FragColor.xyz,vec3(2.2));","#endif","gl_FragColor *= vec4(ambient, 1.0);","}"].join("\n")};j.SimpleMapShader={defines:{sRGB:false,HDR:false},uniforms:{tEnvMap:{type:"t",value:null},envMapExposure:{type:"f",value:1},ambient:{type:"c",value:new j.Color(16777215)},offset:{type:"v2",value:new j.Vector2(0,0)},invSize:{type:"v2",value:new j.Vector2(512,512)}},vertexShader:["void main() {",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tEnvMap;","uniform vec3 ambient;","uniform vec2 invSize;","uniform vec2 offset;","uniform float envMapExposure;","void main() {","vec2 coord = (gl_FragCoord.xy - offset) * invSize;","vec4 color = vec4(0.0);","color = envMapExposure * texture2D( tEnvMap, coord );","#if defined( GAMMA_INPUT ) && defined( sRGB )","color *= color;","#endif","vec2 edge = step(vec2(0.0), coord) - step(vec2(1.0), coord);","gl_FragColor = color * vec4(ambient, 1.0) * (edge.x * edge.y) + vec4(0.0,0.0,0.0,1.0) * (1.0 - (edge.x * edge.y)) ;","}"].join("\n")};j.GradientBackgroundShader2={uniforms:{colors:{type:"fv",value:[]},},vertexShader:["uniform vec3 colors[2];","varying vec3 vColor;","void main() {","vColor = mix(colors[0], colors[1], smoothstep(-1.0, 1.0, position.z));",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec3 vColor;","void main() {","gl_FragColor = vec4(vColor, 1.0);","#ifdef GAMMA_INPUT","gl_FragColor *= gl_FragColor;","#endif",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};j.GradientBackgroundShader3={uniforms:{colors:{type:"fv",value:[]}},vertexShader:["uniform vec3 colors[3];","varying vec3 vColor;","void main() {","vec3 borderColor = mix(colors[2], colors[0], step(0.0, position.z));","float a = sign(position.z) * position.z;","vColor = mix(colors[1], borderColor, a);",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec3 vColor;","void main() {","gl_FragColor = vec4(vColor, 1.0);","#ifdef GAMMA_INPUT","gl_FragColor *= gl_FragColor;","#endif",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};j.GradientBackgroundShader4={uniforms:{colors:{type:"fv",value:[]},horizonHeight:{type:"f",value:0}},vertexShader:["varying float vPositionZ;","void main() {","vPositionZ = position.z;",j._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 colors[4];","uniform float horizonHeight;","varying float vPositionZ;","void main() {","float positionSign = step(horizonHeight, vPositionZ);","vec3 centerColor = positionSign * colors[1] + ((1.0 - positionSign) * colors[3]);","vec3 borderColor = positionSign * colors[0] + ((1.0 - positionSign) * colors[2]);","float minHeight = positionSign * horizonHeight + ((1.0 - positionSign) * -1.0);","float maxHeight = positionSign + ((1.0 - positionSign) * horizonHeight);","vec3 color = mix(centerColor, borderColor, smoothstep(minHeight, maxHeight, vPositionZ));","gl_FragColor = vec4(color, 1.0);","#ifdef GAMMA_INPUT","gl_FragColor *= gl_FragColor;","#endif",j.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};j.HatchingMeshMaterial=function(l){var m={side:j.FrontSide,uniforms:j.UniformsUtils.merge([j.UniformsLib.clipPlanes,{planeU:{type:"v3",value:new j.Vector3(1,0,0)},planeV:{type:"v3",value:new j.Vector3(0,1,0)},hatchingDirection:{type:"v2",value:new j.Vector2(1,-1)},hatchingNormal:{type:"v2",value:new j.Vector2(-1,-1)},hatchingSpaceWidth:{type:"f",value:10},hatchingSpaceColor:{type:"v4",value:new j.Vector4(10,10,10,1)},hatchingLineWidth:{type:"f",value:1},hatchingLineColor:{type:"v4",value:new j.Vector4(0,0,0,1)}}]),vertexColors:j.VertexColors,vertexShaderPars:[j.ShaderChunk.clip_pars_vertex,"varying vec2 vUv;","varying vec4 myPosition;","uniform vec3 planeU;","uniform vec3 planeV;"].join("\n"),vertexShaderBody:[j._DefaultShaderChunk.model_view_transformation_vertex,"vec3 mvPlaneU = (viewMatrix * vec4(planeU, 0.0)).xyz;","vec3 mvPlaneV = (viewMatrix * vec4(planeV, 0.0)).xyz;",j._DefaultShaderChunk.model_view_normal_vertex,"vUv = vec2(dot(mvPosition.xyz, mvPlaneU), dot(mvPosition.xyz, mvPlaneV))-vec2(dot(viewMatrix[3].xyz, mvPlaneU), dot(viewMatrix[3].xyz, mvPlaneV));","gl_Position = projectionMatrix * mvPosition;","myPosition = gl_Position;",j.ShaderChunk.clip_vertex].join("\n"),fragmentShaderPars:[j.ShaderChunk.clip_pars_fragment,"varying vec2 vUv;","varying vec4 myPosition;","uniform vec2 hatchingDirection;","uniform vec2 hatchingNormal;","uniform float hatchingSpaceWidth;","uniform float hatchingLineWidth;","uniform vec4 hatchingSpaceColor;","uniform vec4 hatchingLineColor;","const float pi = 3.141592653589793;",].join("\n"),fragmentShaderBody:[j.ShaderChunk.clip_fragment,"float eval = hatchingNormal.x*vUv.x + hatchingNormal.y*vUv.y;","float k = mod(eval, hatchingSpaceWidth);","vec2 fwx = dot(hatchingNormal, dFdx(vUv))*hatchingNormal;","vec2 fwy = dot(hatchingNormal, dFdy(vUv))*hatchingNormal;","vec2 fw = abs(fwx) + abs(fwy);","float fwlen = length(fw);","float tol = min(hatchingLineWidth*fwlen, hatchingSpaceWidth - fwlen);","if (k < tol/2.0 || k > hatchingSpaceWidth - tol/2.0) {","  gl_FragColor = hatchingLineColor;","} else {","  gl_FragColor = hatchingSpaceColor;","}",""].join("\n")};this.stripesDirection=new j.Vector2(1,1);this.spaceWidth=1;this.spaceColor=new j.Color(16777215);this.spaceOpacity=1;this.stripesWidth=1;this.stripesColor=new j.Color(0);this.stripesOpacity=1;this.autoSpaceColor=false;this.autoStripesColor=false;j.ShaderMaterialDS.call(this,m);this.enableClipPlanes=true;this.refreshUniforms=function(q,o,p){var r=this._renderedClipPlane;if(r){var n=new j.Vector3();n.crossVectors(r.normal,r.upVector);n.normalize();var s=new j.Vector3();s.crossVectors(n,r.normal);this.uniforms.planeU.value=n;this.uniforms.planeV.value=s}this.uniforms.hatchingDirection.value=this.stripesDirection.clone();this.uniforms.hatchingDirection.value.normalize();this.uniforms.hatchingNormal.value=new j.Vector2(this.stripesDirection.y,-this.stripesDirection.x);this.uniforms.hatchingNormal.value.normalize();this.uniforms.hatchingSpaceWidth.value=this.spaceWidth;this.uniforms.hatchingLineWidth.value=this.stripesWidth;if(q.gammaInput){this.uniforms.hatchingSpaceColor.value=new j.Vector4(this.spaceColor.r*this.spaceColor.r,this.spaceColor.g*this.spaceColor.g,this.spaceColor.b*this.spaceColor.b,this.stripesOpacity);this.uniforms.hatchingLineColor.value=new j.Vector4(this.stripesColor.r*this.stripesColor.r,this.stripesColor.g*this.stripesColor.g,this.stripesColor.b*this.stripesColor.b,this.stripesOpacity)}else{this.uniforms.hatchingSpaceColor.value=new j.Vector4(this.spaceColor.r,this.spaceColor.g,this.spaceColor.b,this.stripesOpacity);this.uniforms.hatchingLineColor.value=new j.Vector4(this.stripesColor.r,this.stripesColor.g,this.stripesColor.b,this.stripesOpacity)}};this.setValues(l)};j.HatchingMeshMaterial.prototype=Object.create(j.ShaderMaterialDS.prototype);j.HatchingMeshMaterial.prototype.clone=function(){var l=new j.HatchingMeshMaterial();j.ShaderMaterialDS.prototype.clone.call(this,l);l.stripesDirection=this.stripesDirection.clone();l.spaceWidth=this.spaceWidth;l.spaceColor=this.spaceColor.clone();l.spaceOpacity=this.spaceOpacity;l.stripesWidth=this.stripesWidth;l.stripesColor=this.stripesColor.clone();l.stripesOpacity=this.stripesOpacity;l.autoStripesColor=this.autoStripesColor;l.autoSpaceColor=this.autoSpaceColor;l.uniforms.planeU.value=this.uniforms.planeU.value.clone();l.uniforms.planeV.value=this.uniforms.planeV.value.clone();return l};j.CSSSVGNode=function(l){j.Object3D.call(this);this.element=l;this.element.renderable=this;this.geometry=new j.Geometry();this.geometry.boundingSphere=new j.Sphere()};j.CSSSVGNode.prototype=Object.create(j.Object3D.prototype);return UWA.namespace("THREEDS/Core",j)});define("Visualization/ThreeJS_DS",["DS/Visualization/ThreeJS_DS","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/ThreeJS_DS");return b});define("DS/Visualization/XMLV6Loader",["DS/VisuLoaders/XMLV6Loader"],function(a){return a});define("Visualization/XMLV6Loader",["DS/Visualization/XMLV6Loader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/XMLV6Loader");return b});define("DS/Visualization/Detector",[],function(){var a={canvas:!!window.CanvasRenderingContext2D,webgl:(function(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(b){return false}})(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var b;if(!this.webgl){if(window.WebGLRenderingContext){b='Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />'}else{b='Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>'}b+='Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'}return b}};return a});define("Visualization/Detector",["DS/Visualization/Detector","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/Detector");return b});define("DS/Visualization/ClippingContext",["UWA/Class"],function(b){var a=b.extend({init:function(c){this.planes=c||[];this.excludeFromClippingPlanes=[];this.clippingSettings=null;this.sectionCappingMaterials=null;this.sectionLinesProperties=null;window.sealWebVisuObjects&&Object.seal(this)},setPlanes:function(c,e){this.planes=c||[];if(e){var d;for(d=this.planes.length-1;d>=0;d--){if(e.indexOf(this.planes[d])>=0){this.planes.splice(d,1)}}}},setExcludeFromClippingPlanes:function(c){this.excludeFromClippingPlanes=c||[]},setFrontAndBackOpacity:function(d,c){if(d===null||c===null){this.clippingSettings=null}else{this.clippingSettings={frontOpacity:d,backOpacity:c}}},getFrontOpacity:function(){return this.frontOpacity},getBackOpacity:function(){return this.backOpacity},setSectionCappingMaterial:function(g,e){if(!this.sectionCappingMaterials){this.sectionCappingMaterials=[];this.sectionCappingMaterials.defaultMaterial=null}var d=e||null;if(!d){this.sectionCappingMaterials.defaultMaterial=g}else{var f=0,c=-1;for(f=0;c===-1&&f<this.sectionCappingMaterials.length;f++){if(this.sectionCappingMaterials[f].clippingPlane===d){c=f}}if(c>=0){this.sectionCappingMaterials[c].material=g}else{this.sectionCappingMaterials.push({clippingPlane:d,material:g})}}},setSectionLinesProperties:function(c){if(c){this.sectionLinesProperties={color:c.color===undefined?null:c.color,width:c.width}}else{this.sectionLinesProperties=null}},getSectionCappingMaterial:function(c){if(this.sectionCappingMaterials){if(!c){return this.sectionCappingMaterials.defaultMaterial}else{var d;for(d=0;d<this.sectionCappingMaterials.length;d++){if(this.sectionCappingMaterials[d].clippingPlane===c){return this.sectionCappingMaterials[d].material}}}}return null},removeSectionCappingMaterial:function(d){if(!this.sectionCappingMaterials){return}var c=d||null;var e=0;for(e=0;e<this.sectionCappingMaterials.length;e++){if(this.sectionCappingMaterials[e].clippingPlane===c){this.sectionCappingMaterials.splice(e,1)}}if(!this.sectionCappingMaterials.length){this.sectionCappingMaterials=null}},clone:function(){var e=new a(this.planes);e.excludeFromClippingPlanes=[].concat(this.excludeFromClippingPlanes);if(this.clippingSettings){e.clippingSettings={frontOpacity:this.clippingSettings.frontOpacity,backOpacity:this.clippingSettings.backOpacity}}if(this.sectionCappingMaterials){e.sectionCappingMaterials=[];e.sectionCappingMaterials.defaultMaterial=this.sectionCappingMaterials.defaultMaterial;var c,d;for(c=0;c<this.sectionCappingMaterials.length;c++){d=this.sectionCappingMaterials[c];e.sectionCappingMaterials.push({clippingPlane:d.clippingPlane,material:d.material})}}e.sectionLinesProperties=this.sectionLinesProperties;return e},addPlane:function(c){if(this.planes.indexOf(c)<0){this.planes.push(c);return true}return false},removePlane:function(c){var d=this.planes.indexOf(c);if(d>=0){this.planes.splice(d,1);return true}return false},isPointVisible:function(c){var g=this.clippingSettings&&this.clippingSettings.frontOpacity<0.5;var f,e,d;for(f=0;f<this.planes.length;f++){e=this.planes[f];if(this.excludeFromClippingPlanes.indexOf(e)<0){if(e.distanceToPoint(c)<0){return g?true:false}}}return g?false:true},_mergeWithParent:function(l){if(!l){return this}var h=new a();var e=[].concat(this.planes);var f;for(f=0;f<l.planes.length;f++){if(e.indexOf(l.planes[f])<0){e.push(l.planes[f])}}h.setPlanes(e,this.excludeFromClippingPlanes);h.clippingSettings=this.clippingSettings||l.clippingSettings;var c=null;if(this.sectionCappingMaterials&&l.sectionCappingMaterials){var c=[].concat(this.sectionCappingMaterials||[]);c.defaultMaterials=this.sectionCappingMaterials.defaultMaterial||l.sectionCappingMaterials.defaultMaterial;var k=l.sectionCappingMaterials||[];var d;var g;for(f=0;f<k.length;f++){g=false;for(d=0;d<c.length&&!g;d++){if(c[d].clippingPlane===k[f].clippingPlane){g=true}}if(!g){c.push(k[f])}}}else{c=this.sectionCappingMaterials||l.sectionCappingMaterials}h.sectionCappingMaterials=c;return h},setAntiPlanes:function(){this.setExcludeFromClippingPlanes.apply(this,arguments)}});return a});define("DS/Visualization/XMLV43Loader",["DS/VisuLoaders/XMLV43Loader"],function(a){return a});define("Visualization/XMLV43Loader",["DS/Visualization/XMLV43Loader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/XMLV43Loader");return b});define("DS/Visualization/ColladaLoader",["DS/VisuLoaders/ColladaLoader","DS/Visualization/ThreeJS_DS"],function(a,b){return b});define("DS/Visualization/TrapSelection",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent"],function(f,d,a,g,h,b,e){var c=function(k){this.extremities={xPix:0,x:0,yPix:0,y:0};this.originPoint=null;this.isActive=false;this.isInterrupted=false;this.advancedSelection=false;this.createCallbacks();if(k){this.viewer=k}if(this.viewer&&this.viewer.divTrap){this.setDiv(this.viewer.divTrap)}var j=this.viewer.currentViewpoint?this.viewer.currentViewpoint.getControl():null;this.mode=j?j._mode:1;this.downEvent=(this.mode===0?"onLeftMouseDown":"onHoldLeftMouseDown")};c.prototype.set=function(j){switch(j){case true:this.activate(false);break;case"advanced":this.activate(true);break;case false:this.disable();break}};c.prototype.updateMode=function(k,l){var j=this.viewer.picking.trapSelection;k.setSpinnerOnHold(this.mode!==0&&j?true:false);if(l!==this.mode){this.mode=l;h.removeEvent(this.viewer.canvas,this.downEvent,this.downCB);this.downEvent=(this.mode===0?"onLeftMouseDown":"onHoldLeftMouseDown");if(j){h.addEvent(this.viewer.canvas,this.downEvent,this.downCB)}}};c.prototype.setDiv=function(j){this.divTrap=j;this.divTrap.setStyles({position:"absolute",opacity:"0.8",pointerEvents:"none",border:"1px dashed black"});this.divTrap.hide()};c.prototype.activate=function(j){this.downEvent=(this.mode===0?"onLeftMouseDown":"onHoldLeftMouseDown");this.forwardSelect=null;this.advancedSelection=j;if(!this.divTrap&&this.viewer&&this.viewer.divTrap){this.setDiv(this.viewer.divTrap)}h.addEvent(this.viewer.canvas,this.downEvent,this.downCB);h.addEvent(this.viewer.canvas,"onHold",this.downCB);h.addEvent(this.viewer.canvas,"onLongHold",this.interrupt)};c.prototype.disable=function(){h.removeEvent(this.viewer.canvas,this.downEvent,this.downCB);h.removeEvent(this.viewer.canvas,"onHold",this.downCB);h.removeEvent(this.viewer.canvas,"onLongHold",this.interrupt)};c.prototype.getExtremities=function(){return this.extremities};c.prototype.setExtremities=function(o,n){if(!n){this.extremities=o;return}var l={};var k={};var j=true;if(o.xPix<n.xPix){j=true;l.xPix=o.xPix;l.x=o.x;k.xPix=n.xPix;k.x=n.x}else{j=false;l.xPix=n.xPix;l.x=n.x;k.xPix=o.xPix;k.x=o.x}if(o.yPix<n.yPix){l.yPix=o.yPix;l.y=o.y;k.yPix=n.yPix;k.y=n.y}else{l.yPix=n.yPix;l.y=n.y;k.yPix=o.yPix;k.y=o.y}this.extremities=l;this.extremities.pt=k;if(this.advancedSelection&&this.divTrap&&this.forwardSelect!==j){var m;if(j){m={border:"2px solid #f5c77e",backgroundColor:"rgba(245, 200, 125, 0.5)"}}else{m={border:"2px dashed #75cdf0",backgroundColor:"rgba(117, 205, 240, 0.5)"}}this.divTrap.setStyles(m);this.forwardSelect=j}};c.prototype.createCallbacks=function(){var j=this;this.interrupt=function(){j.softInterrupt();j.viewer.setCursor("Auto")};this.softInterrupt=function(){j.isActive=false;j.isInterrupted=true;h.removeEvent(document,"onMouseMove",j.moveCB);h.removeEvent(document,"onLeftMouseUp",j.upCB);h.removeEvent(document,"onSwipe",j.moveCB);h.removeEvent(document,"onRelease",j.upCB);j.setExtremities({x:-1,y:-1})};this.downCB=function(k){j.originPoint=j.viewer.getMousePosition(k.from[0].getCurrentPosition(j.viewer.canvas));j.setExtremities(j.originPoint);j.startTime=Date.now();j.isActive=true;if(!j.isInterrupted){j.viewer.setCursor("TrapSelection",100);h.addEvent(document,"onMouseMove",j.moveCB);h.addEvent(document,"onLeftMouseUp",j.upCB);h.addEvent(document,"onSwipe",j.moveCB);h.addEvent(document,"onRelease",j.upCB)}j.isInterrupted=false};this.moveCB=function(k){var l=j.viewer.getMousePosition(k.from[0].getCurrentPosition(j.viewer.canvas));j.setExtremities(j.originPoint,l);if(j.divTrap){j.divTrap.show();j.divTrap.setStyles({width:(j.extremities.pt.xPix-j.extremities.xPix)/(window.devicePixelRatio||1),height:(j.extremities.pt.yPix-j.extremities.yPix)/(window.devicePixelRatio||1),left:j.extremities.xPix/(window.devicePixelRatio||1),top:j.extremities.yPix/(window.devicePixelRatio||1),pointerEvents:"none"})}};this.upCB=function(k){if(j.divTrap){j.divTrap.hide();j.divTrap.setStyles({width:"0px",height:"0px",left:"0px",top:"0px",pointerEvents:"none"})}j.interrupt();j.isInterrupted=false}};return c});define("DS/Visualization/IESUtils",["DS/Visualization/ThreeJS_DS"],function(b){var a={nbTexturesBeingLoaded:0,crossOrigin:"anonymous",loadIESTexture:function(d,c,l,j,g,k){var e=128,m=128;var f=new b.DataTexture(null,e,m,b.LuminanceFormat,b.FloatType);f.mapping=c;f.generateMipmaps=false;f.loadEndStatus="loading";var h=new XMLHttpRequest();h.onload=function(){a.nbTexturesBeingLoaded--;var n=a.parserIES(h.response);f.image.data=n;f.loadEndStatus="complete";f.generateMipmaps=false;f.minFilter=b.LinearFilter;f.magFilter=b.LinearFilter;f.needsUpdate=true;if(l){l(f)}var o;for(o=0;o<f.onLoadCallbacks.length;o++){f.onLoadCallbacks[o](f)}};h.onerror=function(){j();a.nbTexturesBeingLoaded--;f.loadEndStatus="error"};if(k){f.loadEndStatus="pause";f.onRequest=function(){f.loadEndStatus="loading";a.nbTexturesBeingLoaded++;h.open("GET",d,true);h.responseType="text";h.withCredentials=!!g;h.send(null)}}else{f.loadEndStatus="loading";a.nbTexturesBeingLoaded++;h.open("GET",d,true);h.responseType="text";h.withCredentials=!!g;h.send(null)}return f},parserIES:function(j){var Z=j.lastIndexOf("TILT=");var g=j.slice(Z);Z=g.indexOf("\n");g=g.slice(Z+1);g=g.replace(/\n|\s|\r/g,"_");g=g.replace("__","_");g=g.split("_");var B=[];for(var S=0;S<g.length;S++){if(g[S]==""){continue}B[B.length]=parseFloat(g[S])}g=null;var P,F,X,s,f,D,W,O,r,aa,C,k,e,q,t,E,U,M,p=-1,u=-1,H=-1;P=B[0];F=B[1];X=B[2];s=B[3];f=B[4];D=B[5];W=B[6];O=B[7];r=B[8];aa=B[9];C=B[10];k=B[11];e=B[12];E=13;U=128;M=128;q=[s];t=[f];var R=[];var n=new Float32Array(U*M);for(var L=0;L<U;L++){for(var K=0;K<M;K++){n[L*M+K]=0}}for(var N=0;N<s;N++){q[N]=B[N+E]}E+=parseInt(s);for(var T=0;T<f;T++){t[T]=B[T+E]}E+=parseInt(f);if(D==1){if(q[s-1]==90){u=1}else{if(q[s-1]==180){u=2}}if(f==1&&t[0]==0){p=0}else{if(t[f-1]==90){p=1}else{if(t[f-1]==180){p=2}}}for(var T=0;T<f;T++){for(var N=0;N<s;N++){var G=B[N+T*s+E];H=H<G?G:H}}if(p==0){f=2;t[1]=180;for(var N=0;N<s;N++){B[N+s+E]=B[N+E]}}if(p==1){if(u==1){for(var T=0;T<f;T++){var A=90-(t[T]-90);R[t[T]]=[s*2];R[A]=[s*2];for(var N=0;N<s;N++){var o=90-(q[N]-90);R[t[T]][q[N]]=R[A][q[N]]=R[t[T]][o]=R[A][o]=B[N+T*s+E]/H}}for(var N=0;N<s-1;N++){q.push(90-(q[N]-90))}}else{if(u==2){for(var T=0;T<f;T++){var A=90-(t[T]-90);R[t[T]]=[s*2];R[A]=[s*2];for(var N=0;N<s;N++){R[t[T]][q[N]]=R[A][q[N]]=B[N+T*s+E]/H}}}}for(var T=0;T<f-1;T++){t.push(90-(t[T]-90))}}else{if(p==0||p==2){if(u==1){for(var T=0;T<f;T++){R[t[T]]=[s*2];for(var N=0;N<s;N++){var o=90-(q[N]-90);R[t[T]][q[N]]=R[t[T]][o]=B[N+T*s+E]/H}}for(var N=0;N<s-1;N++){q.push(90-(q[N]-90))}}else{if(u==2){for(var T=0;T<f;T++){R[t[T]]=[s];for(var N=0;N<s;N++){R[t[T]][q[N]]=B[N+T*s+E]/H}}}}}else{console.log("Erreur symetricHType "+p)}}t=t.sort(function(v,h){return v-h});q=q.sort(function(v,h){return v-h});var w=180/U;var m=t[0];var Q=t[1];var I=1;for(var T=0;T<180;T+=w){while(T>Q){m=Q;Q=t[I+1];I++}var d=q[0];var J=q[1];var z=1;var l=(T-m)/(Q-m);for(var N=0;N<180;N+=w){while(N>J){d=J;J=q[z+1];z++}var c=(N-d)/(J-d);var Y=(1-c)*R[m][d]+c*R[m][J];var V=(1-c)*R[Q][d]+c*R[Q][J];n[T/w*U+N/w]=(1-l)*Y+l*V}}}else{console.log("Mauvais Gonio Type")}return n}};return a});define("DS/Visualization/BudgetedRenderManager",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(a,c){var b=a.extend({init:function(d){this.viewer=d;this._animationFrameId=-1;this._isRenderFrame=false;this._frameTime=0;this._lastAnimationTimeStamp=-1;this._isActive=false;this._lastRefreshStamp=performance.now();this._objectivePercentage=-1;this._shiftToObjective=0;this._shiftStart=0;this._lastFrameTime=16.7;this._lastRenderFrameTime=16.7;this._framesToSkip=-1;this._maxTime=10000;this._renderCallbackId=-1;return this},_setAsRenderFrame:function(){this._isRenderFrame=true},_askForRender:function(k){if(this._renderCallbackId>=0){clearTimeout(this._renderCallbackId);this._renderCallbackId=-1}if(!this._isActive){k.budgeted=false;this.viewer.render(k)}else{var g=performance.now();var j=g-this._lastRefreshStamp;var h=this._lastRenderFrameTime-this._lastFrameTime;var d=this._objectivePercentage;var f=(performance.now()-this._shiftStart)/this._shiftToObjective;f=Math.min(Math.max(0,f),1);f=f*f*(3-2*f);d=1-f+d*f;var e=0;if(h>d*this._lastRenderFrameTime){e=(h*(1-d))/d}if(e<=j||j>this._maxTime){k.budgeted=false;this._lastRefreshStamp=g;this.viewer.render(k)}else{var l=this;this._renderCallbackId=setTimeout(function(){l.viewer.render(k)},e)}}},_resetShift:function(){this._shiftStart=performance.now();this._framesToSkip=0},resetMeasures:function(){this._lastAnimationTimeStamp=-1;this._lastFrameTime=16.7;this._lastRenderFrameTime=16.7;this._framesToSkip=-1},setBudget:function(d){this._objectivePercentage=Math.max(0,Math.min(1,d));this._isActive=true;var f=this;if(this._animationFrameId<0){var e=function(){var g=performance.now();if(f._lastAnimationTimeStamp>=0){f._frameTime=g-f._lastAnimationTimeStamp}if(f._isRenderFrame){f._lastRenderFrameTime=Math.max(f._frameTime,16)}else{f._lastFrameTime=Math.max(f._frameTime,16);f._framesToSkip--}f._lastAnimationTimeStamp=g;f._isRenderFrame=false;f._animationFrameId=requestAnimationFrame(e)};this._animationFrameId=requestAnimationFrame(e);this.resetMeasures()}},disableBudget:function(){this._isActive=false;this._objectivePercentage=-1;if(this._animationFrameId>0){cancelAnimationFrame(this._animationFrameId);this._animationFrameId=-1}},setMaxTime:function(d){this._maxTime=d},setShiftingObjective:function(d){this._shiftToObjective=d}});return UWA.namespace("THREEDS/BudgetedRenderManager",b)});define("DS/Visualization/CameraSystem",["UWA/Class","DS/Shaders/StereoShaders","DS/Plugins/ShaderPass","DS/Plugins/RenderPass","DS/Visualization/ThreeJS_DS","DS/Plugins/ClearPass"],function(c,d,f,b,e,h){var g=c.extend({init:function(){this._computeCameraArrayCB=null;this._predefinedCombineShader=null;this._shaderParameters=null},setComputeCameraArrayCB:function(k,j){this._computeCameraArrayCB=k;this.useExternalProjectionMatrix=j?true:false},setUsePredefinedCombineShader:function(k,l){this._predefinedCombineShader=k;this._shaderParameters=l;var j=a[this._predefinedCombineShader];if(j.warmup){j.warmup()}},getViewportSize:function(k,j){return a[this._predefinedCombineShader].getViewportSize.apply(this,arguments)},computeCameraArray:function(n,m,k){var j=this._computeCameraArrayCB(n,m,k);var l;for(l=0;j&&l<j.length;l++){j[l].updateProjectionMatrix();j[l].projectionMatrixInverse.getInverse(j[l].projectionMatrix)}return j},getUniformName:function(j){return a[this._predefinedCombineShader].uniformsName[j]},applyShaderParameters:function(j){if(j&&this._shaderParameters){var k;for(k in this._shaderParameters){j[k].value=this._shaderParameters[k]}}},isReady:function(){var j=a[this._predefinedCombineShader];return j.type==="ShaderPass"||j.ready},createPasses:function(j){var k=a[this._predefinedCombineShader];if(k.type==="ShaderPass"){this.stereoPass=new f(k.combineShader,undefined,"stereoPass");j.composerContext.setPassRenderToCanvas(this.stereoPass,true)}else{if(k.type==="RenderPass"){this.clearPass=new h("combineClearPass");j.addPass(this.clearPass);j.composerContext.setPassRenderToCanvas(this.clearPass,true);this.stereoPass=new b(null,null,null,null,null,null,"combineStereoPass");this.stereoPass.setDepthFunc("ALWAYS");this.stereoPass.setDisableBackFaceCulling(true);this.stereoScene=new e.Scene();this.stereoScene.renderResultIndices={};k.fillScene(this.stereoScene);this.stereoPass.scene=this.stereoScene;j.composerContext.setPassClear(this.clearPass,true,new e.Color(0),1);j.composerContext.setPassRenderToCanvas(this.stereoPass,true)}}j.addPass(this.stereoPass)},updatePasses:function(j,p,l){var n;var o=a[this._predefinedCombineShader];if(o.type==="ShaderPass"){for(n=0;n<j.length;n++){var k=this.getUniformName(n);this.stereoPass.uniforms[k].value=l[j[n]]}this.applyShaderParameters(this.stereoPass.uniforms)}else{if(o.type==="RenderPass"){var q=this.stereoPass.scene;for(n=0;n<q.myMeshes.length;n++){q.myMeshes[n].material.uniforms.tEye.value=l[j[q.renderResultIndices[q.myMeshes[n].id]]];var m;for(m in o.parameters[n]){q.myMeshes[n].material.uniforms[m].value=o.parameters[n][m]}if(this._shaderParameters){for(m in this._shaderParameters[n]){q.myMeshes[n].material.uniforms[m].value=this._shaderParameters[n][m]}}}}}this.stereoPass.renderToScreen=p},isStereo:function(){return true}});var a={leftRight:{getViewportSize:function(k,j){return{width:Math.floor(k/2),height:j}},combineShader:d.leftRight,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},oculusDK1:{getViewportSize:function(k,j){return{width:Math.floor(k/2),height:j}},combineShader:d.oculusDK1,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},anaglyph:{getViewportSize:function(k,j){return{width:k,height:j}},combineShader:d.anaglyph,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},oculusDK2:{getViewportSize:function(k,j){return{width:Math.floor(k/2),height:j}},ready:false,warmup:function(){require(["DS/OculusDK2/OculusDK2DeformationMeshCreator"],function(j){a.oculusDK2.ready=true;a.oculusDK2.OculusDK2DeformationMeshCreator=j})},fillScene:function(l){var k=a.oculusDK2;k.uniforms=e.UniformsUtils.clone(d.oculusDK2.uniforms);var j=new e.ShaderMaterial({uniforms:k.uniforms,vertexShader:d.oculusDK2.vertexShader,fragmentShader:d.oculusDK2.fragmentShader});k.OculusDK2DeformationMeshCreator.fillScene(l,j)},parameters:[{eyeToSourceUVScale:new e.Vector2(2*0.232447237,0.376141697),eyeToSourceUVOffset:new e.Vector2(2*0.246082067,0.5)},{eyeToSourceUVScale:new e.Vector2(2*0.232447237,0.376141697),eyeToSourceUVOffset:new e.Vector2(2*(0.753917933-0.5),0.5)}],type:"RenderPass"}};return g});define("DS/Visualization/SubElement",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/VisuIdentification/Node","DS/VisuIdentification/Pattern"],function(a,j,d,f,e){var g={};var c=30;var h=0;var b=a.extend({init:function(m,l){if(l!==g&&c>0){var k=(new Error()).stack;k=k&&k.substring(k.indexOf("\n")+1);console.warn("Use of deprecated constructor.\nUse SubElement.getFromSGNode() instead.\n"+k);c--}this.sgNode=m;this._internalGeometryData=null;this.id=h++},getDimension:function(){if(this.sgNode){var k=this.sgNode;if(k.getFirstPrimitive){k=k.getFirstPrimitive()}switch(k.group.glType){case 0:return"point";case 1:case 2:case 3:return"line";case 4:case 5:case 6:return"surface";default:return""}}return""},getCellDimension:function(){if(this.sgNode){var k=this.sgNode;if(k.getFirstPrimitive){k=k.getFirstPrimitive()}switch(k.group.glType){case 0:return 0;case 1:case 2:case 3:return 1;case 4:case 5:case 6:return 2;default:return -1}}return -1},getBodyDimension:function(){if(this.sgNode){var k=this.sgNode;if(k.getFirstPrimitive){k=k.getFirstPrimitive()}if(k.rep&&k.rep.solid){return 3}return 2}return -1},getType:function(){if(this.sgNode){var k=this.sgNode;if(k.getFirstPrimitive){return"selectionGroup"}switch(k.type){case 0:return"node";case 1:return"bag";case 2:return"rep";case 3:return"primitive";default:return""}}return""},getGeometricType:function(){if(this.sgNode){var l=this.getType();if(l==="primitive"){var k=this.sgNode;var m=k.group;if(m){return d.GeomTypeString[m._geomType]}}}return null},getParent:function(){if(this.sgNode){var k=this.sgNode;if(k.getFirstPrimitive){k=k.getFirstPrimitive()}var l=(this.getType()==="primitive")?k.rep:k.parent;if(l){return THREEDS.SubElement.getFromSGNode(l)}}return null},getChildren:function(){var l,k=[];if(this.sgNode){var m=this.getType();if(m==="rep"){for(l=0;l<this.sgNode.primitives.length;l++){k.push(THREEDS.SubElement.getFromSGNode(this.sgNode.primitives[l]))}}else{if(m==="selectionGroup"){var n=this.sgNode.getPrimitives();for(l=0;l<n.length;l++){k.push(THREEDS.SubElement.getFromSGNode(n[l]))}}else{for(l=0;l<this.sgNode.children.length;l++){k.push(THREEDS.SubElement.getFromSGNode(this.sgNode.children[l]))}}}}return k},getCGMID:function(){if(this.sgNode&&!this.sgNode.getFirstPrimitive){return this.sgNode.cgmId}return""},getModelIdentification:function(){return this.getIdentificationObject()},getIdentificationObject:function(){var l;var k=this.sgNode;if(k){if(k.getFirstPrimitive){k=k.getFirstPrimitive()}if(k.getIdentificationObject){l=k.getIdentificationObject()}}return l},getMeshes:function(){var r=[];var n=[];if(this.sgNode){var s=this.getType();if(s==="primitive"){var k=this.sgNode.group;if(k&&k.geometry){var l=k.geometry.meshList;for(var p=0;p<l.length;p++){var t=l[p];n.push(t._occurrence.node)}}}}var q=-1;var m=null;if(n.length){n.sort(function(v,u){return v.id-u.id});q=n[0].id;r.push(n[0])}for(var o=1;o<n.length;o++){m=n[o];if(q!==m.id){q=m.id;r.push(m)}}return r},getReps:function(){var l,k=[];if(this.getType()==="rep"){k.push(this)}else{for(l=0;l<this.children.length;l++){k=k.concat(this.children[l].getReps())}}return k}});b.getFromSGNode=function(k){if(!k.internalNode){k.internalNode=new THREEDS.SubElement(k,g)}return k.internalNode};return UWA.namespace("THREEDS/SubElement",b)});define("Visualization/SubElement",["DS/Visualization/SubElement","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/SubElement");return b});define("DS/Visualization/PathElement",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/Visualization/SubElement"],function(c,e,a,h,g){var b=0;var f=c.extend({init:function(j){this._uid=b++;this.externalPath=[];this.internalPath=[];this._key=null;this.setFromArray(j)},getUID:function(){return this._uid},getLength:function(){return this.externalPath.length+this.internalPath.length},getLastElement:function(j){if(!j&&this.internalPath.length){return this.internalPath[this.internalPath.length-1]}if(this.externalPath.length){return this.externalPath[this.externalPath.length-1]}return null},getElement:function(j,k){if(j<this.externalPath.length){return this.externalPath[j]}if(!k&&(j<this.getLength())){return this.internalPath[j-this.externalPath.length]}return null},isEqual:function(k){var j;if(!k){return false}if(this.externalPath.length!==k.externalPath.length){return false}if(this.internalPath.length!==k.internalPath.length){return false}for(j=0;j<this.externalPath.length;j++){if(this.externalPath[j]!==k.externalPath[j]){return false}}for(j=0;j<this.internalPath.length;j++){if(this.internalPath[j].sgNode!==k.internalPath[j].sgNode){return false}}return true},empty:function(){this.externalPath=[];this.internalPath=[]},clone:function(){var j=new THREEDS.PathElement(this.externalPath);for(var k=0;k<this.internalPath.length;k++){var l=this.internalPath[k];if(l){j.internalPath.push(l)}}if(this._key){j._key=this._key}if(this.instanceId){j.instanceId=this.instanceId}return j},copy:function(j){this.externalPath=j.externalPath.slice();this.internalPath=j.internalPath.slice()},addElement:function(j){var k;if(j){if(j.getNotAllowedInPathElement){if(j.getNotAllowedInPathElement()){d()}}else{if(j.notAllowedInPathElement){d()}}}if(this._key){delete this._key}if(j instanceof THREEDS.Nodes.Node3D){this.externalPath.push(j);return true}if(j instanceof THREEDS.SubElement){this.internalPath.push(j);return true}return false},setFromArray:function(m,l){this._key=null;var n;if((m===undefined)||!(m instanceof Array)){return false}var k=[];for(n=0;n<m.length;n++){var o=m[n];if((o.getNotAllowedInPathElement&&o.getNotAllowedInPathElement())||o.notAllowedInPathElement){d()}else{if(o===null){return false}k.push(o)}}var p=[];if(l&&(l instanceof Array)){for(n=0;n<l.length;n++){var j=l[n];if(j===null){return false}p.push(j)}}if(this.getLength()){this.empty()}this.externalPath=k;this.internalPath=p;return true},setFromOccurrence:function(m,p,j){if((m===null)||(m===undefined)){return false}var l=m.node;var k=m.parent;this.externalPath=[l];var n=false;while(k!==null&&!n){l=k.node;k=k.parent;if(l.getNotAllowedInPathElement()){break}else{this.externalPath.unshift(l);if(j&&l===j){n=true}}}var o=(j&&n)||!j;if((p===null)||(p===undefined)){return o}var k=p.getParent();this.internalPath=[p];while(k!==null){this.internalPath.unshift(k);k=k.getParent()}return o},setFromOccurrencePath:function(k,m){if((k===null)||(k===undefined)){return false}var o=k.getSize();if(!o){return false}var j=[];for(var n=0;n<o;n++){var l=k.getNodeName(n);if(l===null){return false}var p=m.getChildByName(l);if(p===null){return false}if(p.getNotAllowedInPathElement()){d()}else{j.push(p)}}if(this.getLength()){this.empty()}this.externalPath=j;return true},_getOccurrences:function(s){var n,q,m,l,u,t,r,p,o;if(!this.externalPath.length){return[]}n=this.externalPath[0];if(n===null){return[]}u=n._occurrences;if(s){u=u.filter(function(j){return j.scene3js===s.internalSceneGraph.root3js})}t=[];for(o=1;o<this.externalPath.length;o++){n=this.externalPath[o];for(r=0;r<u.length;r++){q=u[r];m=q.children;for(p=0;p<m.length;p++){l=m[p];if(l.node===n){t.push(l)}}}u=t;t=[]}return u},_getRenderableOccurrences:function(r,q){var k,o,m,p,n,l;k=this._getOccurrences(r);o=[];if(k){for(n=0;n<k.length;n++){p=k[n];m=p._getRenderableOccurrences(q);for(l=0;l<m.length;l++){o.push(m[l])}}}return o},_getUniqueOccurrence:function(k){var j=this._getOccurrences(k);if(j&&j.length===1){return j[0]}return null},getKey:function(){if(!this._key){var j=0,k="";for(j=0;j<this.externalPath.length;j++){k+=(j===0?"":"/")+this.externalPath[j].id}k+="//";for(j=0;j<this.internalPath.length;j++){k+=(j===0?"":"/")+this.internalPath[j].id}this._key=k}return this._key},hash:function(){if(!this._hash){var l=0,m="";var k;if(this.internalPath.length){k=this.internalPath[this.internalPath.length-1];if(k instanceof g){var j=k.sgNode;if(j){if(j.start){m+=j.start+"/"}}}else{throw new Error("Unknown node")}}for(l=this.externalPath.length-1;l>=0;l--){m+=this.externalPath[l].id+"/"}this._hash=m}return this._hash},getParentPath:function(){var l=this.externalPath.concat(this.internalPath);if(l.length<=1){return null}var k=new THREEDS.PathElement(),j;for(j=0;j<l.length-1;j++){k.addElement(l[j])}return k},getChildrenPathes:function(k){var n=[];var j=this.getLastElement(),m,o;var l=k?k.getKey():null;if(j===null){return false}if(j.children){for(m=0;m<j.children.length;m++){o=this.clone();o.addElement(j.children[m]);if(o.getKey()!==l){n.push(o)}}}return n},getSiblingsPathes:function(){var j=this.getParentPath();if(!j){return[]}var k=j.getChildrenPathes(this);return k},getAncestorsPathes:function(){var k=this,j=[];while(k){j.unshift(k);k=k.getParentPath()}return j},getSubPath:function(n){if(this.internalPath.length>0){return null}var k,l,j=null,m=null;for(k=this.externalPath.length-2;k>=0&&j===null;k--){l=this.externalPath[k];if(n(l)){j=k}}if(j!==null){m=new f();for(k=0;k<=j;k++){m.addElement(this.externalPath[k])}}return m},toJSON:function(j){var o={};var n=[];var m=this.externalPath[0];var k;while(m){n=[m].concat(n);m=m.parents.length&&m!==j?m.parents[0]:null}o.firstElementPath=[];function l(p){if(p.getPersistentId){return{persistent:true,value:p.getPersistentId()}}else{return{persistent:false,value:p.parents[0].children.indexOf(p)}}}for(k=0;k<n.length;k++){m=n[k];if(m.parents.length||m!==j){o.firstElementPath.push(l(m))}}o.externalPathRest=[];for(k=1;k<this.externalPath.length;k++){o.externalPathRest.push(l(this.externalPath[k]))}return o},setFromJSON:function(m,k){var n=k;function j(q,r){var p,s;if(!r.persistent){return q.children[r.value]}else{for(p=0;p<q.children.length;p++){s=q.children[p];if(s.getPersistentId&&s.getPersistentId()===r.value){return s}}}return null}var l;for(l=0;l<m.firstElementPath.length;l++){n=j(n,m.firstElementPath[l])}var o=[n];for(l=0;l<m.externalPathRest.length;l++){o.push(j(o[o.length-1],m.externalPathRest[l]))}for(l=0;l<o.length;l++){if(!o[l].getNotAllowedInPathElement()){this.addElement(o[l])}}},_dbgPrint:function(){var j="ext:[";var m=this.externalPath.length;for(var l=0;l<m;l++){var k=this.externalPath[l];if(k){j+=k.name}if(l<m-1){j+=", "}}j+="] int:[";m=this.internalPath.length;for(var l=0;l<m;l++){var k=this.internalPath[l];if(k){j+=k.getCGMID()}if(l<m-1){j+=", "}}j+="]";return j},getMatrix:function(l){var m=this._getUniqueOccurrence(l);if(!m){return null}if(m.originalOverrideSet){var k=m.originalOverrideSet.getSubstituteMatrix();if(k){return k.clone()}}var j=this.getLastElement(true);if(j===null){return null}return j.getMatrix()},getWorldMatrix:function(l,k){var n=this;var m=n._getUniqueOccurrence(l);var j;if(m){m._tryOverridesUpdateWithAncestors(l);if(k){k.copy(m.matrix);return k}else{return m.matrix.clone()}}return null},getMatrixInAxisSystem:function(l,m){var k=this.getWorldMatrix(m);if(!k){return null}var j=new e.Matrix4();var n=new e.Matrix4();n.getInverse(l);j.multiplyMatrices(n,k);return j},getBoundingSphere:function(m,l){if(l==="show"){console.warn("DEPRECATED: use visibleSpace instead of show");l="visibleSpace"}if(l==="noShow"){console.warn("DEPRECATED: use invisibleSpace instead of noShow");l="invisibleSpace"}var k=this.getWorldMatrix(m);if(!k){return null}var n=this._getUniqueOccurrence(m);if(!n){return null}m=m||n.scene3js.viewer;n._tryOverridesUpdateWithAncestors(m);var j=n.getBoundingSphere(l).clone();j.center.applyMatrix4(k);return j},getBoundingBox:function(j,n,m){if(!n){return}if(m==="show"){console.warn("DEPRECATED: use visibleSpace instead of show");m="visibleSpace"}if(m==="noShow"){console.warn("DEPRECATED: use invisibleSpace instead of noShow");m="invisibleSpace"}var l=this.getWorldMatrix(n);if(!l){return null}if(j){j.copy(l)}var o=this._getUniqueOccurrence(n);if(!o){return null}n=n||o.scene3js.viewer;o._tryOverridesUpdateWithAncestors(n);var k=o.getBoundingBox(m).clone();return k},getOrientedBoundingBox:function(o,n,q,j,p){if(!n){return null}var k=j||(n.visibleSpace===1?"visibleSpace":"invisibleSpace");var r=this._getUniqueOccurrence(n);if(!r){return null}q=q?q:e.FixedSizeFiltering.Include;p=p?p:[];var s=0;for(var l=0;l<p.length;l++){var m=p[l];s=s|m}r._tryOverridesUpdateWithAncestors(n);return r.computeAccurateBoundingBox(k,o,q,s)},checkExternalPath:function(){var k=true;var j,l,m;for(j=0;j<this.externalPath.length-1&&k;j++){l=this.externalPath[j];m=this.externalPath[j+1];if(l.children.indexOf(m)<0){k=false}}return k},isAParentOf:function(o){function p(t,r){var q=[];var s=t[0];var u=t[0];if(u.parents.length===1&&u!==r){u=u.parents[0];while(u.parents.length===1&&u!==r){q.unshift(u);u=u.parents[0]}q.unshift(u)}q=q.concat(t);return q}var m,l;var j=this.externalPath[0];var n=o.externalPath[0];var k;if(j===n){m=this.externalPath;l=o.externalPath}else{if(this.externalPath.indexOf(n)>0){m=this.externalPath;l=p(o.externalPath,j)}else{m=p(this.externalPath,n);l=o.externalPath}}if(l[0]===m[0]){if(m.length<=l.length){k=0;while(k<m.length&&m[k]===l[k]){k++}return k===m.length}else{return false}}else{return false}},concatenatePathes:function(k,j){var l=k.externalPath.concat(j.externalPath);this.setFromArray(l)},substractPath:function(n,m){var o=m.externalPath.concat([]);var j=n.externalPath;var k=o.indexOf(j[j.length-1]);var l;for(l=0;l<j.length;l++){if(j[l]!==o[l]){return false}}o.splice(0,j.length-1);this.setFromArray(o);return true},setRenderPasses:function(m){var l=this._getRenderableOccurrences();for(var k=0;k<l.length;k++){l[k].setVisibleInPasses(m)}},getParentOccurrencePath:function(){return this.getParentPath.apply(this,arguments)},getChildrenOccurrencePathes:function(){return this.getChildrenPathes.apply(this,arguments)},getSiblingsOccurrencePathes:function(){return this.getSiblingsPathes.apply(this,arguments)},getAncestorsOccurrencePathes:function(){return this.getAncestorsPathes.apply(this,arguments)},_getIndexFromNode:function(j){return this.externalPath.indexOf(j)}});function d(){console.warn("An attempt to add an unauthorized node to a PathElement has been countered.\nPlease remove the node from your PathElement creation.\nNode returned by viewer.getRootNode() and any of its parents may not be part of a PathElement")}return UWA.namespace("THREEDS/PathElement",f)});define("Visualization/PathElement",["DS/Visualization/PathElement","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/PathElement");return b});define("DS/Visualization/Utils",["UWA/Class","UWA/Utils","DS/Visualization/ProxyAbstraction"],function(b,a,d){var c=b.extend({init:function(){}});c.parseUrl=function(e){return a.parseUrl(e)};c.getExtension=function(k){var g=k.replace(/\.\./g,"");g=g.split(".");if(g.length===1||(g[0]===""&&g.length===2)){return""}var j=g.pop();var f=j.indexOf("?")+1;if(f){g=j.substring(0,f-1)}else{g=j}var h=new RegExp(/^[a-zA-Z0-9_]+$/);var e=h.exec(g);if(e!==null){return g}return""};c.getDomain=function(e){var f=e;if(!a.isAbsoluteUrl(e)){f=window.location}return c.parseUrl(f).hostname};c.getWorkerFromSpec=function(g,k){var e=window.URL||window.webkitURL;var h=new d();c.setProxyFromSpec(g,h);var f=g.serverurl?g.serverurl:"";f+=g.filename?g.filename:"";var j=h.executeGetHttpRequest(f,"blob",null,function(l){var m=e.createObjectURL(l);var n=new Worker(m);if(k){k(n)}})};c.getJSFromSpec=function(f,j){var g=new d();c.setProxyFromSpec(f,g);var e=f.serverurl?f.serverurl:"";e+=f.filename?f.filename:"";var h=g.executeGetHttpRequest(e,"text",null,function(k){if(j){j(k)}},null,"text/plain, text/javascript, application/javascript, application/x-javascript")};c.getWorkerFromSpecs=function(j,h){var e=window.URL||window.webkitURL;var g="";var f=function(k){c.getJSFromSpec(j[k],function(o){g+=o;if(k<j.length-1){f(k+1)}else{if(h){var l=new Blob([g],{type:"application/javascript"});var m=e.createObjectURL(l);var n=new Worker(m);h(n)}}})};f(0)};c.getWorkerBlobFromSpecs=function(j,h){var e=window.URL||window.webkitURL;var g="";var f=function(k){c.getJSFromSpec(j[k],function(n){g+=n;if(k<j.length-1){f(k+1)}else{if(h){var l=new Blob([g],{type:"application/javascript"});var m=e.createObjectURL(l);h(m)}}})};f(0)};c.getFileURLFromSpec=function(g,k){var e=window.URL||window.webkitURL;var h=new d();c.setProxyFromSpec(g,h);var f=g.serverurl?g.serverurl:"";f+=g.filename?g.filename:"";var j=h.executeGetHttpRequest(f,"blob",null,function(m){var l=e.createObjectURL(m);if(k){k(l)}})};c.getFilesURLFromSpec=function(h,g){var f=[];var e=function(j){c.getFileURLFromSpec(h[j],function(k){f.push(k);if(j<h.length-1){e(j+1)}else{if(g){g(f)}}})};e(0)};c.setProxyFromSpec=function(f,h){if(f.proxyurl){if(f.proxyurl==="none"){h.useNoProxy(f.withCredentials)}else{var g=c.parseUrl(f.proxyurl);if(g===null){h.useUWAProxy()}else{if(g.hostname!=undefined){h.useProxyDefinedBy(g.hostname,g.port)}else{var j=f.proxyurl.indexOf("http://127.0.0.1");if(j==0){var j=f.proxyurl.lastIndexOf(":");var e=f.proxyurl.slice(j+1,f.proxyurl.length);e=e.replace("/","");h.useProxyDefinedBy("127.0.0.1",8023)}}}}}else{h.useUWAProxy({proxymode:f.requiredAuth,requestsOptions:f.requestsOptions,login:f.login,contextid:f.contextid})}};return UWA.namespace("THREEDS/Utils",c)});define("Visualization/Utils",["DS/Visualization/Utils","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/Utils");return b});define("DS/Visualization/MaterialManager",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/CoreEvents/ModelEvents"],function(a,c,h,e,b){function g(n,m){return h.ImageUtils.loadTextureCube(n,m)}function f(n,m){return h.ImageUtils.loadTexture(n,undefined,null,null,m)}var j=null,k=null,d=null,l=a.extend({init:function(n,m,o,p){if(j!==null){if(!j.multiViewer&&m){j.precomputedTexture1&&j.precomputedTexture1.dispose();j.precomputedTexture2&&j.precomputedTexture2.dispose();j.precomputedTexture3&&j.precomputedTexture3.dispose();j.precomputedAreaGGX1texture&&j.precomputedAreaGGX1texture.dispose();j.precomputedAreaGGX2texture&&j.precomputedAreaGGX2texture.dispose();j.precomputedAreaSheentexture&&j.precomputedAreaSheentexture.dispose()}else{this.multiViewer=j.multiViewer;this.canvas=j.canvas;this.context=j.context;this.materials=j.materials;this.threeDXMaterials=j.threeDXMaterials;this.textures=j.textures;this.resources=[];this._modelEvent=j._modelEvent;if(j.backgroundColorMaterial==null){this.backgroundColorMaterial=null;this.initBackgroundColorMaterial(p)}else{this.backgroundColorMaterial=j.backgroundColorMaterial}this.precomputedTexture1=j.precomputedTexture1;this.precomputedTexture2=j.precomputedTexture2;this.precomputedTexture3=j.precomputedTexture3;this.precomputedAreaGGX1texture=j.precomputedAreaGGX1texture;this.precomputedAreaGGX2texture=j.precomputedAreaGGX2texture;this.precomputedAreaSheentexture=j.precomputedAreaSheentexture;return this}}this.materials=[];this.threeDXMaterials=new Map();this.textures=[];this.resources=[];this._modelEvent=new b();k=null;d=null;this.backgroundColorMaterial=null;j=this;this.initResources(n,m,o);this.initBackgroundColorMaterial(p);return this},cleanAll:function(){j.materials=[];j.threeDXMaterials=new Map();this.deallocateSharedMaterials()},deallocateSharedMaterials:function(){var u=["Invisible","Normal","Depth","NormalDepth","ShadowMapDepth","Picking","Highlight","PreHighlight","HighlightMobile"];var o=["Face","Line","Point"];var t=["0","1","2"];var y=["true","false"];var n=[1];for(var s=0;s<u.length;s++){var x=h.DefaultMaterials[u[s]];if(!x){continue}for(var r=0;r<o.length;r++){var z=x[o[r]];if(!z){continue}for(var q=0;q<t.length;q++){var v=z[t[q]];if(!v){continue}for(var p=0;p<y.length;p++){var m=v[y[p]];if(!m){continue}var w=m[n[0]];if(w){w.needsUpdate=true}}}}}},initBackgroundColorMaterial:function(n){if(n==null){return}var m=new h.MeshBasicMaterial({color:n.ambience.getBackgroundColor(),side:h.DoubleSide});this.backgroundColorMaterial=m;n.onBackgroundModify(function(p){var o=new h.Color(p);m.color=o})},initResources:function(q,v,u){this.multiViewer=v;if(v){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("experimental-webgl",{alpha:true,premultipliedAlpha:false,antialias:u,stencil:true,preserveDrawingBuffer:q||false})}var t=c.getWebappsAssetUrl("Effects","");var p=h.ImageUtils.loadTGATexture(t+"precomputedTexture1.bin",new h.UVMapping(),null,null,true,true);p.minFilter=h.NearestFilter;p.magFilter=h.NearestFilter;this.precomputedTexture1=p;var n=h.ImageUtils.loadTGATexture(t+"precomputedTexture2.bin",new h.UVMapping(),null,null,true,true);n.minFilter=h.NearestFilter;n.magFilter=h.NearestFilter;this.precomputedTexture2=n;var m=h.ImageUtils.loadTGATexture(t+"precomputedTexture3.bin",new h.UVMapping(),null,null,true,true);m.minFilter=h.NearestFilter;m.magFilter=h.NearestFilter;this.precomputedTexture3=m;var s=h.ImageUtils.loadCompressedTexture(t+"AreaLightGGX1.dds",new h.UVMapping(),null,null,false,true);s.minFilter=h.LinearFilter;s.magFilter=h.LinearFilter;this.precomputedAreaGGX1texture=s;var r=h.ImageUtils.loadCompressedTexture(t+"AreaLightGGX2.dds",new h.UVMapping(),null,null,false,true);r.minFilter=h.LinearFilter;r.magFilter=h.LinearFilter;this.precomputedAreaGGX2texture=r;var o=h.ImageUtils.loadCompressedTexture(t+"AreaLightSheen.dds",new h.UVMapping(),null,null,false,true);o.minFilter=h.LinearFilter;o.magFilter=h.LinearFilter;this.precomputedAreaSheentexture=o},setCanvasSize:function(n,m){if(this.multiViewer){this.canvas.width=Math.max(this.canvas.width,n);this.canvas.height=Math.max(this.canvas.height,m)}},getCanvas:function(){return this.canvas},getContext:function(){return this.context},onPDSFXMaterial:function(m){return this._modelEvent.subscribe({event:"PDSFXMaterial"},m)},cleanResources:function(){j.textures=[];this.textures=[];this.materials=this.materials.filter(function(m){return !m.hasTexture})},getMaterialById:function(n){var m;for(m=0;m<this.materials.length;m++){if(this.materials[m].threejs_mat.id===n){return this.materials[m].threejs_mat}}return null},getMaterialByName:function(m){var n;for(n=0;n<this.materials.length;n++){if(this.materials[n].threejs_mat.name===m){return this.materials[n].threejs_mat}}return null},getBackgroundColorMaterial:function(){if(this.backgroundColorMaterial){return this.backgroundColorMaterial}else{var m=new h.MeshBasicMaterial({side:h.DoubleSide});return m}},getMaterialCgr:function(n,q,r,t){var p,o,s;if(n.backgoundColor!==undefined){return this.getBackgroundColorMaterial()}for(o=0;o<this.materials.length;o++){p=this.materials[o];s=p.params;if(s.type!=="material"){continue}if((s.ambientCoef!==n.ambientCoef)||(s.diffuseCoef!==n.diffuseCoef)||(s.specularCoef!==n.specularCoef)){continue}if((s.colorAmbient[0]!==n.colorAmbient[0])||(s.colorAmbient[1]!==n.colorAmbient[1])||(s.colorAmbient[2]!==n.colorAmbient[2])){continue}if((s.colorDiffuse[0]!==n.colorDiffuse[0])||(s.colorDiffuse[1]!==n.colorDiffuse[1])||(s.colorDiffuse[2]!==n.colorDiffuse[2])){continue}if((s.colorSpecular[0]!==n.colorSpecular[0])||(s.colorSpecular[1]!==n.colorSpecular[1])||(s.colorSpecular[2]!==n.colorSpecular[2])){continue}if((s.url!==undefined)&&(n.textureId===-1)){continue}if((s.url===undefined)&&(n.textureId!==-1)){continue}if(n.textureId!==-1){continue}if(s.transparent!==n.transparent){continue}if(s.shininess!==n.shininess){continue}if(s.textureImageNumberComposante!==n.textureImageNumberComposante){continue}if(s.textureBlending!==n.textureBlending){continue}if(s.magFilter!==n.magFilter){continue}if(s.minFilter!==n.minFilter){continue}if(s.mappingFunction!==n.mappingFunction){continue}if(s.textureWrapS!==n.textureWrapS){continue}if(s.textureWrapT!==n.textureWrapT){continue}if(s.addedComposantInTexEnv!==n.addedComposantInTexEnv){continue}if(s.mapping){if(!n.mapping||s.mapping.type!==n.mapping.type||s.mapping.ObjectTransformation!==n.mapping.ObjectTransformation||s.mapping.UvTransformation!==n.mapping.UvTransformation){continue}}return p.threejs_mat}p=this.createMaterial(n,q,r,t);return p},getMaterial3DXML:function(n,r,s,u,o){var q,p,t;for(p=0;p<this.materials.length;p++){q=this.materials[p];t=q.params;if(t.type!=="material3DXML"){continue}if(t.shading!==n.shading){continue}if((t.reflectivityCoef!==n.reflectivityCoef)||(t.shininess!==n.shininess)||(t.specularCoef!==n.specularCoef)){continue}if((t.WrappingModeU!==n.WrappingModeU)||(t.WrappingModeV!==n.WrappingModeV)||(t.FlipU!==n.FlipU)||(t.FlipV!==n.FlipV)){continue}if((t.transparency!==n.transparency)||(t.transparent!==n.transparent)||(t.alphaTest!==n.alphaTest)||(t.mappingFunction!==n.mappingFunction)||(t.MappingType!==n.MappingType)){continue}if((t.TextureDimension!==n.TextureDimension)||(t.TextureFunction!==n.TextureFunction)||(t.DiffuseMap!==n.DiffuseMap)){continue}if((t.DiffuseMapRepeat[0]!==n.DiffuseMapRepeat[0])||(t.DiffuseMapRepeat[1]!==n.DiffuseMapRepeat[1])||(t.DiffuseMapWrap[0]!==n.DiffuseMapWrap[0])||(t.DiffuseMapWrap[1]!==n.DiffuseMapWrap[1])){continue}if((t.colorAmbient[0]!==n.colorAmbient[0])||(t.colorAmbient[1]!==n.colorAmbient[1])||(t.colorAmbient[2]!==n.colorAmbient[2])){continue}if((t.colorDiffuse[0]!==n.colorDiffuse[0])||(t.colorDiffuse[1]!==n.colorDiffuse[1])||(t.colorDiffuse[2]!==n.colorDiffuse[2])){continue}if((!t.colorSpecular&&n.colorSpecular)||(t.colorSpecular&&!n.colorSpecular)){continue}if(t.colorSpecular&&n.colorSpecular){if((t.colorSpecular[0]!==n.colorSpecular[0])||(t.colorSpecular[1]!==n.colorSpecular[1])||(t.colorSpecular[2]!==n.colorSpecular[2])){continue}}if(o){if(t.__nbTexturesToLoad===0){o(q.threejs_mat)}else{if(!t.__cbLoadedImages){t.__cbLoadedImages=[]}t.__cbLoadedImages.push(o)}}return q.threejs_mat}q=this.createMaterial(n,r,s,null,o);return q},getTexture:function(r){var q,s,n,o,m=[];if(!r.offset){r.offset=[0,0]}if(!r.repeat){r.repeat=[1,1]}if(!r.wrap){r.wrap=[1,1]}if(!r.filter){r.filter=[5,1]}if(r.resourceId!==undefined){if(this.textures[r.resourceId]){m=this.textures[r.resourceId]}}if(m.length){for(n=0;n<m.length;n++){q=m[n];o=q;s=q.params;if(r.texturePoint!==s.texturePoint){continue}if((r.offset[0]!==s.offset[0])||(r.offset[1]!==s.offset[1])||(r.repeat[0]!==s.repeat[0])||(r.repeat[1]!==s.repeat[1])||(r.wrap[0]!==s.wrap[0])||(r.wrap[1]!==s.wrap[1])||(r.filter[0]!==s.filter[0])||(r.filter[1]!==s.filter[1])){}return q.threejs_texture}q=o.threejs_texture.clone();q.offset.set(r.offset[0],r.offset[1]);q.repeat.set(r.repeat[0],r.repeat[1]);if((r.wrap[0]===1)||(r.wrap[0]=="repeat")){q.wrapS=h.RepeatWrapping}else{q.wrapS=h.ClampToEdgeWrapping}if((r.wrap[1]===1)||(r.wrap[0]=="repeat")){q.wrapT=h.RepeatWrapping}else{q.wrapT=h.ClampToEdgeWrapping}switch(r.filter[0]){case 0:q.min=h.NearestFilter;break;case 1:q.min=h.LinearFilter;break;case 2:q.min=h.NearestMipMapNearestFilter;break;case 3:q.min=h.NearestMipMapLinearFilter;break;case 4:q.min=h.LinearMipMapNearestFilter;break;case 5:q.min=h.LinearMipMapLinearFilter;break}switch(r.filter[1]){case 0:q.mag=h.NearestFilter;break;case 1:q.mag=h.LinearFilter;break;case 2:q.mag=h.NearestMipMapNearestFilter;break;case 3:q.mag=h.NearestMipMapLinearFilter;break;case 4:q.mag=h.LinearMipMapNearestFilter;break;case 5:q.mag=h.LinearMipMapLinearFilter;break}var p={offset:r.offset,repeat:r.repeat,wrap:r.wrap,filter:r.filter,texturePoint:r.texturePoint};this.textures[r.resourceId]=[{params:p,threejs_texture:q}];q._source=h.AssetSource.MATERIAL_MANAGER;return q}q=this.createTexture(r);if(r.resourceId!==undefined){var p={offset:r.offset,repeat:r.repeat,wrap:r.wrap,filter:r.filter,texturePoint:r.texturePoint};this.textures[r.resourceId]=[{params:p,threejs_texture:q}];q._source=h.AssetSource.MATERIAL_MANAGER}return q},createMaterial:function(X,aj,K,R,J){var Y;X.__nbTexturesToLoad=0;X.__cbLoadedImages=[];J&&X.__cbLoadedImages.push(J);function O(){return Y}function ab(m){return(m[0]*255<<16)+(m[1]*255<<8)+m[2]*255}function D(am,al,ap,an){var aq={};var ar=c.getWebappsAssetUrl("Visualization","");var m=f(ar+"default_white_color.png");var ao=f(ar+"slot_normal_default.jpg");var at=f(ar+"slot_specular_anisotropy_direction_default.jpg");if(am.AmbientOcclusion2D&&am.AmbientOcclusion2D.url=="slot_ambient_occlusion_default.tif"){ap.AmbientOcclusion2D=m}else{ap.AmbientOcclusion2D=an.getTexture({type:"data",resources:al[am.AmbientOcclusion2D.imgId],resourceId:am.AmbientOcclusion2D.imgId})}if(am.Clarity2D&&am.Clarity2D.url=="slot_clarity_default.tif"){ap.Clarity2D=m}else{ap.Clarity2D=an.getTexture({type:"data",resources:al[am.Clarity2D.imgId],resourceId:am.Clarity2D.imgId})}if(am.Diffuse2D&&am.Diffuse2D.url=="slot_diffuse_default.tif"){ap.Diffuse2D=m}else{ap.Diffuse2D=an.getTexture({type:"data",resources:al[am.Diffuse2D.imgId],resourceId:am.Diffuse2D.imgId})}if(am.Emissive2D&&am.Emissive2D.url=="slot_emissive_default.tif"){ap.Emissive2D=m}else{ap.Emissive2D=an.getTexture({type:"data",resources:al[am.Emissive2D.imgId],resourceId:am.Emissive2D.imgId})}if(am.Height2D&&am.Height2D.url=="slot_displacement_default.tif"){ap.Height2D=m}else{ap.Height2D=an.getTexture({type:"data",resources:al[am.Height2D.imgId],resourceId:am.Height2D.imgId})}if(am.Normal2D&&am.Normal2D.url=="slot_normal_default.tif"){ap.Normal2D=ao}else{ap.Normal2D=an.getTexture({type:"data",resources:al[am.Height2D.imgId],resourceId:am.Height2D.imgId})}if(am.Specular2D&&am.Specular2D.url=="slot_specular_default.tif"){ap.Specular2D=m}else{ap.Specular2D=an.getTexture({type:"data",resources:al[am.Specular2D.imgId],resourceId:am.Specular2D.imgId})}if(am.SpecularAnisotropyDirection2D&&am.SpecularAnisotropyDirection2D.url=="slot_specular_anisotropy_direction_default.tif"){ap.SpecularAnisotropyDirection2D=at}else{ap.SpecularAnisotropyDirection2D=an.getTexture({type:"data",resources:al[am.SpecularAnisotropyDirection2D.imgId],resourceId:am.SpecularAnisotropyDirection2D.imgId})}if(am.SpecularGlossiness2D&&am.SpecularGlossiness2D.url=="slot_specular_glossiness_default.tif"){ap.SpecularGlossiness2D=m}else{ap.SpecularGlossiness2D=an.getTexture({type:"data",resources:al[am.SpecularGlossiness2D.imgId],resourceId:am.SpecularGlossiness2D.imgId})}if(am.Transparency2D&&am.Transparency2D.url=="slot_transparency_default.tif"){ap.Transparency2D=m}else{ap.Transparency2D=an.getTexture({type:"data",resources:al[am.Transparency2D.imgId],resourceId:am.Transparency2D.imgId})}}function V(m,an,ar,ap){var al=0,ao=m.param;for(al in ao){var aq=ao[al].imgId;if(aq!==undefined){if(an[aq]&&an[aq].url){ao[al].url=an[aq].url}ao[al].map=ar.getTexture({type:"data",resources:an[aq],resourceId:aq});ar.resources[aq]=ao[al].map}}var am={name:m.name,parameters:m.param,material:null};ar._modelEvent.publish({event:"PDSFXMaterial",data:am});if(am.material){return am.material}return null}function y(ay,aA,az,aD){if(ay!=null){var am=ay.param;var aw=0;if(am.transparency_multiply_blend!=undefined){aw=am.transparency_multiply_blend}var at=c.getWebappsAssetUrl("Visualization","");if(k==null){var aC=[at+"studio_pure_white_Specular_Map/posx.jpg",at+"studio_pure_white_Specular_Map/negx.jpg",at+"studio_pure_white_Specular_Map/posy.jpg",at+"studio_pure_white_Specular_Map/negy.jpg",at+"studio_pure_white_Specular_Map/posz.jpg",at+"studio_pure_white_Specular_Map/negz.jpg"];k=g(aC)}var aB;switch(ay.name){case"MPM_basic":case"MPM_material":case"MPM_colored_glass":case"MPM_diffuse":case"MPM_soft_plastic":case"MPM_polished_plastic":case"MPM_clear_glass":case"MPM_frosted_glass":case"MPM_diamond":case"MPM_satinated_metal":case"MPM_anisotropic_metal":case"MPM_polished_metal":case"MPM_emissive":var at=c.getWebappsAssetUrl("Visualization","");var aC=[at+"studio_pure_white_Diffuse_Map/posx.jpg",at+"studio_pure_white_Diffuse_Map/negx.jpg",at+"studio_pure_white_Diffuse_Map/posy.jpg",at+"studio_pure_white_Diffuse_Map/negy.jpg",at+"studio_pure_white_Diffuse_Map/posz.jpg",at+"studio_pure_white_Diffuse_Map/negz.jpg"];var ar=am.mapping_world_to_object_position_1st_column;var aq=am.mapping_world_to_object_position_2nd_column;var ao=am.mapping_world_to_object_position_3rd_column;var an=am.mapping_world_to_object_position_4th_column;var ap=new h.Matrix4(ar[0],ar[1],ar[2],ar[3],aq[0],aq[1],aq[2],aq[3],ao[0],ao[1],ao[2],ao[3],an[0],an[1],an[2],an[3]);var al=new h.Matrix4();al.getInverse(ap);var au=g(aC);var ax={};D(am,aA,ax,az);aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{mapping_world_inverse:{type:"m4",value:al},default_sp_normal:{type:"fv4",value:am.default_sp_normal},default_generic_brdf_diffuse_color:{type:"fv4",value:am.default_generic_brdf_diffuse_color},default_generic_brdf_specular_color:{type:"fv4",value:am.default_generic_brdf_specular_color},default_generic_edf_diffuse_color:{type:"fv4",value:am.default_generic_edf_diffuse_color},default_vp_color:{type:"fv4",value:am.default_vp_color},default_sp_bump:{type:"f",value:am.default_sp_bump},default_sp_displacement:{type:"f",value:am.default_sp_displacement},default_sp_height:{type:"f",value:am.default_sp_height},default_sp_opacity:{type:"f",value:am.default_sp_opacity},default_sp_ambient_occlusion:{type:"f",value:am.default_sp_ambient_occlusion},default_generic_brdf_ior:{type:"f",value:am.default_generic_brdf_ior},default_generic_brdf_diffuse_weight:{type:"f",value:am.default_generic_brdf_diffuse_weight},default_generic_brdf_diffuse_glossiness:{type:"f",value:am.default_generic_brdf_diffuse_glossiness},default_generic_brdf_specular_weight:{type:"f",value:am.default_generic_brdf_specular_weight},default_generic_brdf_specular_glossiness:{type:"f",value:am.default_generic_brdf_specular_glossiness},default_generic_brdf_specular_anisotropy:{type:"f",value:am.default_generic_brdf_specular_anisotropy},default_generic_brdf_specular_anisotropy_rotation:{type:"f",value:am.default_generic_brdf_specular_anisotropy_rotation},default_generic_btdf_transparency_weight:{type:"f",value:am.default_generic_btdf_transparency_weight},default_generic_btdf_transparency_glossiness:{type:"f",value:am.default_generic_btdf_transparency_glossiness},default_generic_edf_diffuse_weight:{type:"f",value:am.default_generic_edf_diffuse_weight},default_vp_ior:{type:"f",value:am.default_vp_ior},default_vp_absorption:{type:"f",value:am.default_vp_absorption},default_vp_abbe_number:{type:"f",value:am.default_vp_abbe_number},default_slot_normal:{type:"i",value:am.default_slot_normal},default_slot_ambient_occlusion:{type:"i",value:am.default_slot_ambient_occlusion},default_slot_height:{type:"i",value:am.default_slot_height},default_slot_opacity:{type:"i",value:am.default_slot_opacity},default_slot_diffuse_color:{type:"i",value:am.default_slot_diffuse_color},default_slot_specular_color:{type:"i",value:am.default_slot_specular_color},default_slot_specular_glossiness:{type:"i",value:am.default_slot_specular_glossiness},default_slot_specular_anisotropy_direction:{type:"i",value:am.default_slot_specular_anisotropy_direction},default_slot_transparency:{type:"i",value:am.default_slot_transparency},default_slot_clarity:{type:"i",value:am.default_slot_clarity},default_slot_emissive_color:{type:"i",value:am.default_slot_emissive_color},mapping_scale_u:{type:"f",value:am.mapping_scale_u},mapping_scale_v:{type:"f",value:am.mapping_scale_v},mapping_flip_u:{type:"f",value:am.mapping_flip_u},mapping_flip_v:{type:"f",value:am.mapping_flip_v},mapping_offset_u:{type:"f",value:am.mapping_offset_u},mapping_offset_v:{type:"f",value:am.mapping_offset_v},mapping_repeat_u:{type:"f",value:am.mapping_repeat_u},mapping_repeat_v:{type:"f",value:am.mapping_repeat_v},mapping_ratio_u:{type:"f",value:am.mapping_ratio_u},mapping_ratio_v:{type:"f",value:am.mapping_ratio_v},mapping_rotation_z:{type:"f",value:am.mapping_rotation_z},thin_walled:{type:"f",value:am.thin_walled},mapping_type:{type:"i",value:am.mapping_type},mapping_world_to_object_position_1st_column:{type:"fv4",value:am.mapping_world_to_object_position_1st_column},mapping_world_to_object_position_2nd_column:{type:"fv4",value:am.mapping_world_to_object_position_2nd_column},mapping_world_to_object_position_3rd_column:{type:"fv4",value:am.mapping_world_to_object_position_3rd_column},mapping_world_to_object_position_4th_column:{type:"fv4",value:am.mapping_world_to_object_position_4th_column},AmbientOcclusion2D:{type:"t",value:ax.AmbientOcclusion2D},Clarity2D:{type:"t",value:ax.Clarity2D},Diffuse2D:{type:"t",value:ax.Diffuse2D},Emissive2D:{type:"t",value:ax.Emissive2D},Height2D:{type:"t",value:ax.Height2D},Normal2D:{type:"t",value:ax.Normal2D},Specular2D:{type:"t",value:ax.Specular2D},SpecularAnisotropyDirection2D:{type:"t",value:ax.SpecularAnisotropyDirection2D},SpecularGlossiness2D:{type:"t",value:ax.SpecularGlossiness2D},Transparency2D:{type:"t",value:ax.Transparency2D},Opacity2D:{type:"t",value:ax.Opacity2D},IBLDiffuse:{type:"t",value:au},IBLSpecular:{type:"t",value:k}}]),vertexShaderPars:h.ShaderChunk.mpm_pars,vertexShaderBody:h.ShaderChunk.mpm_vertex,fragmentShaderPars:["uniform mat4 mapping_world_inverse;","uniform float mapping_ratio_u;","uniform float mapping_ratio_v;","uniform float mapping_scale_u;","uniform float mapping_scale_v;","uniform float mapping_flip_u;","uniform float mapping_flip_v;","uniform float mapping_offset_u;","uniform float mapping_offset_v;","uniform float mapping_repeat_u;","uniform float mapping_repeat_v;","uniform float mapping_rotation_z;","uniform int  mapping_type;","uniform vec4  mapping_world_to_object_position_1st_column;","uniform vec4  mapping_world_to_object_position_2nd_column;","uniform vec4  mapping_world_to_object_position_3rd_column;","uniform vec4  mapping_world_to_object_position_4th_column;","uniform float thin_walled;","uniform int default_slot_normal;","uniform int default_slot_height;","uniform int default_slot_opacity;","uniform int default_slot_ambient_occlusion;","uniform int default_slot_diffuse_color;","uniform int default_slot_specular_color;","uniform int default_slot_specular_glossiness;","uniform int default_slot_transparency;","uniform int default_slot_clarity;","uniform int default_slot_emissive_color;","uniform int default_slot_specular_anisotropy_direction;","uniform float default_sp_bump;","uniform vec4 default_sp_normal;","uniform float default_sp_displacement;","uniform float default_sp_height;","uniform float default_sp_opacity;","uniform float default_sp_ambient_occlusion;","uniform float default_generic_brdf_ior;","uniform float default_generic_brdf_diffuse_weight;","uniform vec4 default_generic_brdf_diffuse_color;","uniform float default_generic_brdf_diffuse_glossiness;","uniform float default_generic_brdf_specular_weight;","uniform vec4 default_generic_brdf_specular_color;","uniform float default_generic_brdf_specular_glossiness;","uniform float default_generic_brdf_specular_anisotropy;","uniform float default_generic_brdf_specular_anisotropy_rotation;","uniform float default_generic_btdf_transparency_weight;","uniform float default_generic_btdf_transparency_glossiness;","uniform float default_generic_edf_diffuse_weight;","uniform vec4 default_generic_edf_diffuse_color;","uniform vec4 default_vp_color;","uniform float default_vp_ior;","uniform float default_vp_absorption;","uniform float default_vp_abbe_number;","uniform sampler2D Normal2D;","uniform sampler2D Height2D;","uniform sampler2D Opacity2D;","uniform sampler2D AmbientOcclusion2D;","uniform sampler2D Diffuse2D;","uniform sampler2D Specular2D;","uniform sampler2D SpecularGlossiness2D;","uniform sampler2D SpecularAnisotropyDirection2D;","uniform sampler2D Transparency2D;","uniform sampler2D Clarity2D;","uniform sampler2D Emissive2D;","uniform samplerCube IBLDiffuse;","uniform samplerCube IBLSpecular;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.mpm_pars,h.ShaderChunk.struct_mpm,h.ShaderChunk.constants_mpm,h.ShaderChunk.functions_mpm,h.ShaderChunk.brdf_mpm,h.ShaderChunk.edf_mpm,h.ShaderChunk.opacity_mpm,h.ShaderChunk.blending_mpm,h.ShaderChunk.mapping_mpm,h.ShaderChunk.color_mpm,h.ShaderChunk.parallax_mpm,"contribution_t contribution_environment = contribution_t(vec4(1.0),vec4(1.0),vec4(1.0));"].join("\n"),fragmentShaderBody:[h.ShaderChunk.mpm_fragment,"gl_FragColor = result;"].join("\n")});aB.uniforms.Height2D.value=ax.Height2D;aB.uniforms.Normal2D.value=ax.Normal2D;aB.uniforms.Opacity2D.value=ax.Opacity2D;aB.uniforms.AmbientOcclusion2D.value=ax.AmbientOcclusion2D;aB.uniforms.Diffuse2D.value=ax.Diffuse2D;aB.uniforms.Specular2D.value=ax.Specular2D;aB.uniforms.SpecularGlossiness2D.value=ax.SpecularGlossiness2D;aB.uniforms.SpecularAnisotropyDirection2D.value=ax.SpecularAnisotropyDirection2D;aB.uniforms.Transparency2D.value=ax.Transparency2D;aB.uniforms.Clarity2D.value=ax.Clarity2D;aB.uniforms.Emissive2D.value=ax.Emissive2D;aB.uniforms.IBLSpecular.value=k;aB.uniforms.IBLDiffuse.value=au;aB.needTangentBinormal=true;break;case"mia_phen_polished_metal":aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(am.diffuse!=undefined)?am.diffuse:[1,1,1,1]},emissive_color:{type:"fv4",value:(am.emissive_color!=undefined)?am.emissive_color:[1,1,1,1]},diffuse_weight:{type:"f",value:(am.diffuse_weight!=undefined)?am.diffuse_weight:0},reflectivity:{type:"f",value:(am.reflectivity!=undefined)?am.reflectivity:1},transparency_multiply_blend:{type:"f",value:aw},refr_ior:{type:"f",value:(am.refr_ior!=undefined)?am.refr_ior:8},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(am.emissive_intensity!=undefined)?am.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float diffuse_weight;","uniform vec4  diffuse;","uniform vec4  refl_color;","uniform float reflectivity;","uniform float transparency_multiply_blend;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = 30.0;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_fragment,h.ShaderChunk.fresnel_fragment,"float reflectionDiffuseWeight   = mix( 1.0, 0.8, reflectivity );","const float roughnessWeight = 0.85;","float ambientStrength = diffuse_weight;","float diffuseStrength = roughnessWeight*diffuse_weight*reflectionDiffuseWeight;","float specularStrength = 0.05 + 0.45*reflectivity;","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*diffuse.xyz);","vec3 specularResult = dirSpecular*(specularStrength);","vec3 reflectionResult = reflectivity*diffuse.xyz*environment_lookup*clamp(1.0-getLuminosity(diffuseResult.xyz+specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});break;case"mia_phen_satinated_metal":var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(am.diffuse!=undefined)?am.diffuse:[1,1,1,1]},emissive_color:{type:"fv4",value:(am.emissive_color!=undefined)?am.emissive_color:[1,1,1,1]},diffuse_weight:{type:"f",value:(am.diffuse_weight!=undefined)?am.diffuse_weight:0},reflectivity:{type:"f",value:(am.reflectivity!=undefined)?am.reflectivity:1},refl_gloss:{type:"f",value:(am.refl_gloss!=undefined)?am.refl_gloss:0.25},transparency_multiply_blend:{type:"f",value:aw},refr_ior:{type:"f",value:(am.refr_ior!=undefined)?am.refr_ior:8},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(am.emissive_intensity!=undefined)?am.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float diffuse_weight;","uniform vec4  diffuse;","uniform float reflectivity;","uniform float transparency_multiply_blend;","uniform float refl_gloss;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = mix( 5., 30., pow( refl_gloss, 0.5 ) );","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_blur_fragment,h.ShaderChunk.fresnel_fragment,"float reflectionDiffuseWeight   = mix( 1.0, 0.8, reflectivity );","const float roughnessWeight = 0.85;","float ambientStrength = diffuse_weight;","float diffuseStrength = roughnessWeight*diffuse_weight*reflectionDiffuseWeight;","float specularStrength = 0.05 + 0.45*reflectivity;","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*diffuse.xyz);","vec3 specularResult = dirSpecular*(specularStrength*diffuse.xyz);","vec3 reflectionResult = reflectivity*diffuse.xyz*environment_lookup*clamp(1.0-getLuminosity(diffuseResult.xyz+specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aB.needTangentBinormal=true;break;case"mia_phen_anisotropic_metal":var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(am.diffuse!=undefined)?am.diffuse:[1,1,1,1]},emissive_color:{type:"fv4",value:(am.emissive_color!=undefined)?am.emissive_color:[1,1,1,1]},anisotropy:{type:"f",value:(am.anisotropy!=undefined)?am.anisotropy:0.1},anisotropy_rotation:{type:"f",value:(am.anisotropy_rotation!=undefined)?am.anisotropy_rotation:0},diffuse_weight:{type:"f",value:(am.diffuse_weight!=undefined)?am.diffuse_weight:0},reflectivity:{type:"f",value:(am.reflectivity!=undefined)?am.reflectivity:1},refl_gloss:{type:"f",value:(am.refl_gloss!=undefined)?am.refl_gloss:0.25},transparency_multiply_blend:{type:"f",value:aw},refr_ior:{type:"f",value:(am.refr_ior!=undefined)?am.refr_ior:8},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(am.emissive_intensity!=undefined)?am.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float diffuse_weight;","uniform vec4  diffuse;","uniform float anisotropy_rotation;","uniform float anisotropy;","uniform float reflectivity;","uniform float transparency_multiply_blend;","uniform float refl_gloss;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = mix( 5., 30., pow( refl_gloss, 0.5 ) );","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_anisotropic_fragment,"}","#endif",h.ShaderChunk.environment_blur_fragment,h.ShaderChunk.fresnel_fragment,"float reflectionDiffuseWeight   = mix( 1.0, 0.8, reflectivity );","const float roughnessWeight = 0.85;","float ambientStrength = diffuse_weight;","float diffuseStrength = roughnessWeight*diffuse_weight*reflectionDiffuseWeight;","float specularStrength = 0.05 + 0.45*reflectivity;","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*diffuse.xyz);","vec3 specularResult = dirSpecular*specularStrength;","vec3 reflectionResult = reflectivity*diffuse.xyz*environment_lookup*clamp(1.0-getLuminosity(diffuseResult.xyz+specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aB.needTangentBinormal=true;break;case"mia_phen_soft_plastic":var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(am.diffuse!=undefined)?am.diffuse:[1,1,1,1]},refl_gloss:{type:"f",value:(am.refl_gloss!=undefined)?am.refl_gloss:0.25},refl_color:{type:"fv4",value:(am.refl_color!=undefined)?am.refl_color:[1,1,1,1]},emissive_color:{type:"fv4",value:(am.emissive_color!=undefined)?am.emissive_color:[1,1,1,1]},diffuse_weight:{type:"f",value:(am.diffuse_weight!=undefined)?am.diffuse_weight:0.77},reflectivity:{type:"f",value:(am.reflectivity!=undefined)?am.reflectivity:0.7},transparency_multiply_blend:{type:"f",value:aw},refr_ior:{type:"f",value:(am.refr_ior!=undefined)?am.refr_ior:2},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(am.emissive_intensity!=undefined)?am.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float diffuse_weight;","uniform vec4  diffuse;","uniform vec4  refl_color;","uniform float reflectivity;","uniform float refl_gloss;","uniform float transparency_multiply_blend;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = mix(5.0, 30.0,pow(refl_gloss,0.5));","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_blur_fragment,h.ShaderChunk.fresnel_fragment,"float reflectionDiffuseWeight   = mix( 1.0, 0.8, reflectivity );","const float roughnessWeight = 0.85;","float ambientStrength = diffuse_weight;","float diffuseStrength = roughnessWeight*diffuse_weight*reflectionDiffuseWeight;","float specularStrength = 0.05 + 0.15*reflectivity;","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*diffuse.xyz);","vec3 specularResult = dirSpecular*(specularStrength*refl_color.xyz);","vec3 reflectionResult = reflectivity*refl_color.xyz*environment_lookup*clamp(1.0-getLuminosity(diffuseResult.xyz+specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aB.needTangentBinormal=true;break;case"mia_phen_polished_plastic":var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(am.diffuse!=undefined)?am.diffuse:[1,1,1,1]},refl_color:{type:"fv4",value:(am.refl_color!=undefined)?am.refl_color:[1,1,1,1]},emissive_color:{type:"fv4",value:(am.emissive_color!=undefined)?am.emissive_color:[1,1,1,1]},diffuse_weight:{type:"f",value:(am.diffuse_weight!=undefined)?am.diffuse_weight:0.77},reflectivity:{type:"f",value:(am.reflectivity!=undefined)?am.reflectivity:0.75},transparency_multiply_blend:{type:"f",value:aw},refr_ior:{type:"f",value:(am.refr_ior!=undefined)?am.refr_ior:2},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(am.emissive_intensity!=undefined)?am.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float diffuse_weight;","uniform vec4  diffuse;","uniform vec4  refl_color;","uniform float reflectivity;","uniform float transparency_multiply_blend;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = 30.0;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_fragment,h.ShaderChunk.fresnel_fragment,"float reflectionDiffuseWeight   = mix( 1.0, 0.8, reflectivity );","const float roughnessWeight = 0.85;","float ambientStrength = diffuse_weight;","float diffuseStrength = roughnessWeight*diffuse_weight*reflectionDiffuseWeight;","float specularStrength = 0.05 + 0.15*reflectivity;","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*diffuse.xyz);","vec3 specularResult = dirSpecular*(specularStrength*refl_color.xyz);","vec3 reflectionResult = reflectivity*refl_color.xyz*environment_lookup*clamp(1.0-getLuminosity(diffuseResult.xyz+specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});break;case"mia_phen_diffuse":var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(am.diffuse!=undefined)?am.diffuse:[1,1,1,1]},emissive_color:{type:"fv4",value:(am.emissive_color!=undefined)?am.emissive_color:[1,1,1,1]},diffuse_roughness:{type:"f",value:(am.diffuse_roughness!=undefined)?am.diffuse_roughness:1},transparency_multiply_blend:{type:"f",value:aw},emissive_intensity:{type:"f",value:(am.emissive_intensity!=undefined)?am.emissive_intensity:0}}]),vertexShaderPars:h.ShaderChunk.basic_pars,vertexShaderBody:h.ShaderChunk.basic_vertex,fragmentShaderPars:["uniform vec4  diffuse;","uniform float diffuse_roughness;","uniform float transparency_multiply_blend;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","float diffuse_power  = mix(0.5,3.0,diffuse_roughness);","const float specular_power = 5.0;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif","float roughnessWeight = mix(0.85,1.0,diffuse_roughness);","const float ambientStrength = 0.77;","float diffuseStrength = roughnessWeight*0.77;","const float specularStrength = 0.05;","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*diffuse.xyz);","vec3 specularResult = dirSpecular*(specularStrength);","vec3 result = emitResult.xyz + diffuseResult + specularResult;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});break;case"mia_phen_frosted_glass":var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{refr_falloff_color:{type:"fv4",value:(am.refr_falloff_color!=undefined)?am.refr_falloff_color:[1,1,1,1]},emissive_color:{type:"fv4",value:(am.emissive_color!=undefined)?am.emissive_color:[1,1,1,1]},transparency_multiply_blend:{type:"f",value:aw},refr_ior:{type:"f",value:(am.refr_ior!=undefined)?am.refr_ior:1.45},refr_gloss:{type:"f",value:(am.refr_gloss!=undefined)?am.refr_gloss:1},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(am.emissive_intensity!=undefined)?am.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float refr_gloss;","uniform vec4  refr_falloff_color;","uniform float transparency_multiply_blend;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","float refl_gloss  = refr_gloss;","const float diffuse_power  = 0.5;","float specular_power = mix(5.0, 30.0,pow(refl_gloss,0.5));","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_blur_fragment,h.ShaderChunk.fresnel_fragment,"const float reflectionDiffuseWeight   = 0.8;","const float roughnessWeight = 0.85;","const float ambientStrength = 0.77;","float diffuseStrength = roughnessWeight*0.77*reflectionDiffuseWeight;","float specularStrength = 0.5;","vec4 refl_color = vec4(1.0);","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*refl_color.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*refl_color.xyz);","diffuseResult *= 0.5 * refr_falloff_color.xyz;","vec3 specularResult = dirSpecular*(specularStrength*refl_color.xyz);","vec3 reflectionResult = refl_color.xyz*environment_lookup*clamp(1.0-getLuminosity(specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float opacity = 0.0;","opacity += fresnel*(1.0+length(specularResult.xyz));","opacity += clamp(1.0-length(refr_falloff_color.xyz),0.0,1.0);","opacity += (1.0-fresnel)*length(emitResult.xyz);","opacity = min(opacity,1.0);","float post_process_transparency_blend = mix( opacity, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aB.needTangentBinormal=true;break;case"mia_phen_clear_glass":var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{emissive_color:{type:"fv4",value:(am.emissive_color!=undefined)?am.emissive_color:[1,1,1,1]},transparency_multiply_blend:{type:"f",value:aw},refr_ior:{type:"f",value:(am.refr_ior!=undefined)?am.refr_ior:1.45},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(am.emissive_intensity!=undefined)?am.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float transparency_multiply_blend;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = 30.0;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_fragment,h.ShaderChunk.fresnel_fragment,"const float reflectionDiffuseWeight   = 0.8;","const float roughnessWeight = 0.85;","const float ambientStrength = 0.77;","float diffuseStrength = roughnessWeight*0.77*reflectionDiffuseWeight;","float specularStrength = 0.5;","vec4 refl_color = vec4(1.0);","vec4 refr_color = vec4(1.0);","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*refl_color.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*refl_color.xyz);","diffuseResult *= 0.5 * refr_color.xyz;","vec3 specularResult = dirSpecular*(specularStrength*refl_color.xyz);","vec3 reflectionResult = refl_color.xyz*environment_lookup*clamp(1.0-getLuminosity(specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float opacity = 0.0;","opacity += fresnel*(1.0+length(specularResult.xyz));","opacity += clamp(1.0-length(refr_color.xyz),0.0,1.0);","opacity += (1.0-fresnel)*length(emitResult.xyz);","opacity = min(opacity,1.0);","float post_process_transparency_blend = mix( opacity, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aB.needTangentBinormal=true;break;case"mia_phen_colored_glass":var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{refr_falloff_color:{type:"fv4",value:(am.refr_falloff_color!=undefined)?am.refr_falloff_color:[1,1,1,1]},emissive_color:{type:"fv4",value:(am.emissive_color!=undefined)?am.emissive_color:[1,1,1,1]},transparency_multiply_blend:{type:"f",value:aw},refr_ior:{type:"f",value:(am.refr_ior!=undefined)?am.refr_ior:1.45},reflectivity:{type:"f",value:(am.reflectivity!=undefined)?am.reflectivity:0.66},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(am.emissive_intensity!=undefined)?am.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform vec4  refr_falloff_color;","uniform float transparency_multiply_blend;","uniform float refr_ior;","uniform float reflectivity;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","const float specular_power = 30.0;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_fragment,h.ShaderChunk.fresnel_fragment,"float intensity_specular    = /* weight */ 0.50;","float intensity_environment = /* weight */ 1.00;","float intensity_emissive    = /* weight */ emissive_intensity * /* attenuation */ 0.75;","/* contributions */","vec4 emitResult = intensity_emissive*emissive_color;","vec3 specularResult = dirSpecular*intensity_specular;","vec3 reflectionResult = environment_lookup*intensity_environment;","vec3  reflective_specular   = /* specular reflection weight */ reflectivity * ( specularResult + reflectionResult );","vec3  refractive_specular   = refr_falloff_color.rgb;","float luminosity_reflective               = getLuminosity( reflective_specular );","float cursor_refraction_reflection        = clamp( fresnel + luminosity_reflective, 0.0, 1.0 );","vec3  perceived                           = mix( refractive_specular, reflective_specular, cursor_refraction_reflection ) + emitResult.xyz;","float opacity = fresnel;","const float interpolation_power           = 3.0;","float luminosity_reflective_interpolation = pow( luminosity_reflective, interpolation_power );","float post_process_transparency_blend = mix( mix( opacity, 1.0, luminosity_reflective_interpolation ), 0.0, transparency_multiply_blend );","gl_FragColor = vec4( perceived.rgb * perceived.rgb, post_process_transparency_blend );"].join("\n")});aB.needTangentBinormal=true;break;case"diamond":var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{refr_color:{type:"fv4",value:(am.refr_color!=undefined)?am.refr_color:[1,1,1,1]},refl_color:{type:"fv4",value:(am.refl_color!=undefined)?am.refl_color:[1,1,1,1]},transparency_multiply_blend:{type:"f",value:aw},abbe_number:{type:"f",value:(am.abbe_number!=undefined)?am.abbe_number:55},refr_ior:{type:"f",value:(am.refr_ior!=undefined)?am.refr_ior:2.4},ReflectionCUBEMap:{type:"t",value:k}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform vec4  refl_color;","uniform vec4  refr_color;","uniform float transparency_multiply_blend;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float abbe_number;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:["//float specularStrength;",h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = 30.0;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_fragment,h.ShaderChunk.fresnel_fragment,"const float reflectionDiffuseWeight   = 0.8;","const float roughnessWeight = 0.85;","const float ambientStrength = 0.77;","float diffuseStrength = roughnessWeight*0.77*reflectionDiffuseWeight;","float specularStrength = 0.5;","float emissive_intensity = 0.0;","vec4 emissive_color = vec4(1.0);","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*refl_color.xyz);","diffuseResult += dirDiffuse*(diffuseStrength*refl_color.xyz);","diffuseResult *= 0.5 * refr_color.xyz;","vec3 specularResult = dirSpecular*(specularStrength*refl_color.xyz);","vec3 reflectionResult = refl_color.xyz*environment_lookup*clamp(1.0-getLuminosity(specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float opacity = 0.0;","opacity += fresnel*(1.0+length(specularResult.xyz));","opacity += clamp(1.0-length(refr_color.xyz),0.0,1.0);","opacity += (1.0-fresnel)*length(emitResult.xyz);","opacity = min(opacity,1.0);","float post_process_transparency_blend = mix( opacity, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aB.needTangentBinormal=true;break;case"mia_phen_emissive":var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{color:{type:"f",value:(am.color!=undefined)?am.color:[1,1,1,1]},intensity:{type:"fv4",value:(am.intensity!=undefined)?am.intensity:1000}}]),vertexShaderPars:h.ShaderChunk.basic_pars,vertexShaderBody:h.ShaderChunk.basic_vertex,fragmentShaderPars:["uniform vec4  color;","uniform float intensity;","uniform float transparency_multiply_blend;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,"float diffuseLobeShape = 0.5*dot(viewPosition,normal)+0.5;","diffuseLobeShape = pow(diffuseLobeShape,0.1);","vec4 emitResult = color * diffuseLobeShape*clamp(intensity,0.0,1.0);","vec3 result = emitResult.xyz;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});break;case"CATIATemplateUseMapCubic":var av;av=az.getTexture({type:"data",resources:aA[am.KdText.imgId],resourceId:am.KdText.imgId});var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{KaColor:{type:"fv4",value:(am.KaColor!=undefined)?am.KaColor:[1,1,1,1]},KdColor:{type:"fv4",value:(am.KdColor!=undefined)?am.KdColor:[1,1,1,1]},KsColor:{type:"fv4",value:(am.KsColor!=undefined)?am.KsColor:[1,1,1,1]},Kd:{type:"f",value:(am.Kd!=undefined)?am.Kd:1},Ka:{type:"f",value:(am.Ka!=undefined)?am.Ka:0},KbBump:{type:"f",value:(am.KbBump!=undefined)?am.KbBump:0},transparency_multiply_blend:{type:"f",value:aw},Kr:{type:"f",value:(am.Kr!=undefined)?am.Kr:1},KsShi:{type:"f",value:(am.KsShi!=undefined)?am.KsShi:0.75},Kt:{type:"f",value:(am.Kt!=undefined)?am.Kt:0},RepeatU:{type:"f",value:(am.RepeatU!=undefined)?am.RepeatU:1},RepeatV:{type:"f",value:(am.RepeatV!=undefined)?am.RepeatV:1},TextOperMapType:{type:"f",value:(am.TextOperMapType!=undefined)?am.TextOperMapType:0},ReflectionCUBEMap:{type:"t",value:k},KdText:{type:"t",value:av},Ks:{type:"f",value:(am.Ks!=undefined)?am.Ks:1}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,"varying vec2 vUV;",h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,"vUV = uv;",h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform vec4  KaColor;","uniform vec4  KdColor;","uniform vec4  KsColor;","uniform float Kd;","uniform float Ka;","uniform float KbBump;","uniform float transparency_multiply_blend;","uniform float Kr;","uniform float KsShi;","uniform float Kt;","uniform float RepeatU;","uniform float RepeatV;","uniform float TextOperMapType;","uniform float Ks;","uniform samplerCube ReflectionCUBEMap;","uniform sampler2D KdText;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","varying vec2 vUV;",h.ShaderChunk.basic_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"float alpha = 1.0;","vec3 texture_diffuse_lookup;","vec3 normal_mix = normal;","vec3  Bumps = vec3( 0.0, 0.0, 0.0 );","//application input","if (TextOperMapType > 0.0) {","vec2 clamped_uv = clamp(vUV, vec2(0.0), vec2(1.0) );","vec2 repeat     = vec2( RepeatU, RepeatV );","vec2 texel      = mix( clamped_uv, vUV, repeat );","//baking","vec4  textMap = texture2D( KdText, texel );","texture_diffuse_lookup = textMap.xyz;","alpha = textMap.w;","}","else {","texture_diffuse_lookup = vec3(1.0);","alpha = 1.0;","}","float interpolator_texture   = TextOperMapType;","//normal","if (TextOperMapType > 0.0) {","float bump_intensity      = KbBump;","vec3  bump_loopkup        = vec3( ( texture_diffuse_lookup.r + texture_diffuse_lookup.g + texture_diffuse_lookup.b ) / 3.0 - 0.5);","#ifdef USE_TANGENT_BINORMAL","Bumps = bump_loopkup.x * tangent + bump_loopkup.y * binormal;","#endif","normal_mix          = normal + Bumps;","normal_mix          = normalize(normal_mix);","}","//vec3 normal = normalize( normal );","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 2.0;","float specular_power = 95. * KsShi + 5.;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_fragment,"vec4 result = vec4( 0.0, 0.0, 0.0, alpha *(1.0 - Kt) );","result.xyz += Ka/2.0 * KaColor.xyz;","result.xyz += Kd   * KdColor.xyz * dirDiffuse;","result.xyz *= texture_diffuse_lookup.xyz;","result.xyz += Ks * KsColor.xyz * dirSpecular;","result.xyz += Kr * environment_lookup *clamp(1.0-getLuminosity(result.xyz),0.0,1.0);","result.a = mix( result.a, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb*result.rgb, result.a );"].join("\n")});aB.uniforms.KdText.value=av;aB.needTangentBinormal=false;break;case"CATIATemplateUseMapSpheric":var av=az.getTexture({type:"data",resources:aA[am.KdText.imgId],resourceId:am.KdText.imgId});var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{KaColor:{type:"fv4",value:(am.KaColor!=undefined)?am.KaColor:[1,1,1,1]},KdColor:{type:"fv4",value:(am.KdColor!=undefined)?am.KdColor:[1,1,1,1]},KsColor:{type:"fv4",value:(am.KsColor!=undefined)?am.KsColor:[1,1,1,1]},Kd:{type:"f",value:(am.Kd!=undefined)?am.Kd:1},Ka:{type:"f",value:(am.Ka!=undefined)?am.Ka:0},KbBump:{type:"f",value:(am.KbBump!=undefined)?am.KbBump:0},transparency_multiply_blend:{type:"f",value:aw},Kr:{type:"f",value:(am.Kr!=undefined)?am.Kr:1},KsShi:{type:"f",value:(am.KsShi!=undefined)?am.KsShi:0.75},Kt:{type:"f",value:(am.Kt!=undefined)?am.Kt:0},RepeatU:{type:"f",value:(am.RepeatU!=undefined)?am.RepeatU:1},RepeatV:{type:"f",value:(am.RepeatV!=undefined)?am.RepeatV:1},TextOperMapType:{type:"f",value:(am.TextOperMapType!=undefined)?am.TextOperMapType:0},ReflectionCUBEMap:{type:"t",value:k},KdText:{type:"t",value:av},Ks:{type:"f",value:(am.Ks!=undefined)?am.Ks:1}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,"varying vec2 vUV;",h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,"vUV = uv;",h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform vec4  KaColor;","uniform vec4  KdColor;","uniform vec4  KsColor;","uniform float Kd;","uniform float Ka;","uniform float KbBump;","uniform float transparency_multiply_blend;","uniform float Kr;","uniform float KsShi;","uniform float Kt;","uniform float RepeatU;","uniform float RepeatV;","uniform float TextOperMapType;","uniform float Ks;","uniform samplerCube ReflectionCUBEMap;","uniform sampler2D KdText;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","varying vec2 vUV;",h.ShaderChunk.basic_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.envMaps_pars].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"float alpha = 1.0;","vec3 texture_diffuse_lookup;","vec3 normal_mix = normal;","vec3  Bumps = vec3( 0.0, 0.0, 0.0 );","//application input","if (TextOperMapType > 0.0) {","vec2 clamped_uv = clamp(vUV, vec2(0.0), vec2(1.0) );","vec2 repeat     = vec2( RepeatU, RepeatV );","vec2 texel      = mix( clamped_uv, vUV, repeat );","//baking","vec4  textMap = texture2D( KdText, texel );","texture_diffuse_lookup = textMap.xyz;","alpha = textMap.w;","}","else {","texture_diffuse_lookup = vec3(1.0);","alpha = 1.0;","}","float interpolator_texture   = TextOperMapType;","//normal","if (TextOperMapType > 0.0) {","float bump_intensity      = KbBump;","vec3  bump_loopkup        = vec3( ( texture_diffuse_lookup.r + texture_diffuse_lookup.g + texture_diffuse_lookup.b ) / 3.0 - 0.5);","#ifdef USE_TANGENT_BINORMAL","Bumps = bump_loopkup.x * tangent + bump_loopkup.y * binormal;","#endif","normal_mix          = normal + Bumps;","normal_mix          = normalize(normal_mix);","}","//vec3 normal = normalize( normal );","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 2.0;","float specular_power = 95. * KsShi + 5.;","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_fragment,"vec4 result = vec4( 0.0, 0.0, 0.0, alpha *(1.0 - Kt) );","result.xyz += Ka/2.0 * KaColor.xyz;","result.xyz += Kd   * KdColor.xyz * dirDiffuse;","result.xyz *= texture_diffuse_lookup.xyz;","result.xyz += Ks * KsColor.xyz * dirSpecular;","result.xyz += Kr * environment_lookup *clamp(1.0-getLuminosity(result.xyz),0.0,1.0);","result.a = mix( result.a, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb*result.rgb, result.a );"].join("\n")});aB.uniforms.KdText.value=av;aB.needTangentBinormal=true;break;case"mia_phen_material":var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(am.diffuse!=undefined)?am.diffuse:[1,1,1,1]},emissive_color:{type:"fv4",value:(am.emissive_color!=undefined)?am.emissive_color:[1,1,1,1]},refl_color:{type:"fv4",value:(am.refl_color!=undefined)?am.refl_color:[1,1,1,1]},refr_color:{type:"fv4",value:(am.refr_color!=undefined)?am.refr_color:[1,1,1,1]},anisotropy:{type:"f",value:(am.anisotropy!=undefined)?am.anisotropy:1},anisotropy_rotation:{type:"f",value:(am.anisotropy_rotation!=undefined)?am.anisotropy_rotation:0},cutout_opacity:{type:"f",value:(am.cutout_opacity!=undefined)?am.cutout_opacity:1},diffuse_roughness:{type:"f",value:(am.diffuse_roughness!=undefined)?am.diffuse_roughness:1},diffuse_weight:{type:"f",value:(am.diffuse_weight!=undefined)?am.diffuse_weight:0.77},reflectivity:{type:"f",value:(am.reflectivity!=undefined)?am.reflectivity:0},refl_gloss:{type:"f",value:(am.refl_gloss!=undefined)?am.refl_gloss:0},refr_gloss:{type:"f",value:(am.refr_gloss!=undefined)?am.refr_gloss:1},transparency:{type:"f",value:(am.transparency!=undefined)?am.transparency:0},transparency_multiply_blend:{type:"f",value:aw},refr_ior:{type:"f",value:(am.refr_ior!=undefined)?am.refr_ior:1.5},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(am.emissive_intensity!=undefined)?am.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform float diffuse_weight;","uniform float diffuse_roughness;","uniform vec4  diffuse;","uniform vec4  refl_color;","uniform vec4  refr_color;","uniform float anisotropy_rotation;","uniform float anisotropy;","uniform float reflectivity;","uniform float transparency;","uniform float transparency_multiply_blend;","uniform float refl_gloss;","uniform float refr_gloss;","uniform float refr_ior;","uniform float cutout_opacity;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","float diffuse_power  = mix(0.5, 3.0, diffuse_roughness);","float specular_power = mix( 5., 30., pow( refl_gloss, 0.5 ) );","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_anisotropic_fragment,"}","#endif",h.ShaderChunk.environment_blur_fragment,h.ShaderChunk.fresnel_fragment,"float reflectionDiffuseWeight   = mix( 1.0, 0.8, reflectivity );","float roughnessWeight = mix( 0.8, 1.0, diffuse_roughness );","float ambientStrength = diffuse_weight;","float diffuseStrength = roughnessWeight*diffuse_weight*reflectionDiffuseWeight;","float specularStrength = 0.05 + 0.45*reflectivity;","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*diffuse.xyz*diffuseStrength;","diffuseResult *= mix(vec3(1.0),0.5*refr_color.xyz,transparency);","vec3 specularResult = dirSpecular*(specularStrength*refl_color.xyz);","vec3 reflectionResult = reflectivity*refl_color.xyz*environment_lookup*clamp(1.0-getLuminosity((1.0-transparency)*diffuseResult.xyz+specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float opacity = 0.0;","opacity += fresnel*(1.0+length(specularResult.xyz));","opacity += clamp(1.0-length(refr_color.xyz),0.0,1.0);","opacity += (1.0-fresnel)*length(emitResult.xyz);","opacity =mix(1.0,min(opacity,cutout_opacity),transparency);","float post_process_transparency_blend = mix( opacity, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aB.needTangentBinormal=true;break;case"mia_phen_reflective_translucent":var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{diffuse:{type:"fv4",value:(am.diffuse!=undefined)?am.diffuse:[1,1,1,1]},emissive_color:{type:"fv4",value:(am.emissive_color!=undefined)?am.emissive_color:[1,1,1,1]},refr_trans_color:{type:"fv4",value:(am.refr_trans_color!=undefined)?am.refr_trans_color:[1,1,1,1]},refr_trans_weight:{type:"f",value:(am.refr_trans_weight!=undefined)?am.refr_trans_weight:1},reflectivity:{type:"f",value:(am.reflectivity!=undefined)?am.reflectivity:0},refr_gloss:{type:"f",value:(am.refr_gloss!=undefined)?am.refr_gloss:1},transparency:{type:"f",value:(am.transparency!=undefined)?am.transparency:0.8},transparency_multiply_blend:{type:"f",value:aw},refr_ior:{type:"f",value:(am.refr_ior!=undefined)?am.refr_ior:1.3},ReflectionCUBEMap:{type:"t",value:k},emissive_intensity:{type:"f",value:(am.emissive_intensity!=undefined)?am.emissive_intensity:0}}]),vertexShaderPars:[h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:[h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_fct,"uniform vec4  diffuse;","uniform vec4  refr_trans_color;","uniform float refr_trans_weight;","uniform float reflectivity;","uniform float transparency;","uniform float transparency_multiply_blend;","uniform float refr_gloss;","uniform float refr_ior;","uniform samplerCube ReflectionCUBEMap;","uniform float emissive_intensity;","uniform vec4  emissive_color;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif",h.ShaderChunk.basic_pars,h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float diffuse_power  = 0.5;","float specular_power = mix( 5., 30., pow( refr_gloss, 0.5 ) );","const float ambient_contribution  = 1.0;","float refl_gloss = refr_gloss;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_fragment,h.ShaderChunk.illumination_specular_fragment,"}","#endif",h.ShaderChunk.environment_blur_fragment,h.ShaderChunk.fresnel_fragment,"float reflectionDiffuseWeight = mix(1.0,0.8,reflectivity);","const float roughnessWeight = 0.85;","const float ambientStrength = 0.77;","float diffuseStrength = roughnessWeight* 0.77*reflectionDiffuseWeight;","float specularStrength = 0.05 + 0.45*reflectivity;","vec3 refl_color = vec3(1.0);","vec3 refr_color = mix(vec3(1.0) ,refr_trans_color.xyz,refr_trans_weight);","/* contributions */","vec4 emitResult = 0.75*clamp(emissive_intensity,0.0,1.0)*emissive_color;","vec3 diffuseResult = dirAmbient*(ambientStrength*diffuse.xyz);","diffuseResult += dirDiffuse*diffuse.xyz*diffuseStrength;","diffuseResult *= mix(vec3(1.0),0.5*refr_color.xyz,transparency);","vec3 specularResult = dirSpecular*specularStrength;","vec3 reflectionResult = reflectivity*refl_color.xyz*environment_lookup*clamp(1.0-getLuminosity((1.0-transparency)*diffuseResult.xyz+specularResult.xyz),0.0,1.0);","vec3 result = emitResult.xyz + diffuseResult + specularResult + fresnel*reflectionResult;","float opacity = 0.0;","opacity += fresnel*(1.0+length(specularResult.xyz));","opacity += clamp(1.0-length(refr_color.xyz),0.0,1.0);","opacity += (1.0-fresnel)*length(emitResult.xyz);","opacity =mix(1.0,min(opacity,1.0),transparency);","float post_process_transparency_blend = mix( opacity, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( result.rgb * result.rgb, post_process_transparency_blend );"].join("\n")});aB.needTangentBinormal=true;break;case"mip_metallic_paint":var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{ambient:{type:"fv4",value:(am.ambient!=undefined)?am.ambient:[0,0,0,1]},base_color:{type:"fv4",value:(am.base_color!=undefined)?am.base_color:[0,1,0,1]},scene_ambient:{type:"fv4",value:(am.__scene_ambient!=undefined)?am.__scene_ambient:[0,0,0,0]},edge_color:{type:"fv4",value:(am.edge_color!=undefined)?am.edge_color:[0.6,0.07,0.07,1]},flake_color:{type:"fv4",value:(am.flake_color!=undefined)?am.flake_color:[1,1,1,1]},lit_color:{type:"fv4",value:(am.lit_color!=undefined)?am.lit_color:[0.6,0,0.2,1]},spec:{type:"fv4",value:(am.spec!=undefined)?am.spec:[1,1,1,1]},spec_sec:{type:"fv4",value:(am.spec_sec!=undefined)?am.spec_sec:[1,1,1,1]},diffuse_bias:{type:"f",value:(am.diffuse_bias!=undefined)?am.diffuse_bias:1.5},diffuse_weight:{type:"f",value:(am.diffuse_weight!=undefined)?am.diffuse_weight:1},edge_color_bias:{type:"f",value:(am.edge_color_bias!=undefined)?am.edge_color_bias:1},flake_bump:{type:"f",value:(am.flake_bump!=undefined)?am.flake_bump:0},flake_decay:{type:"f",value:(am.flake_decay!=undefined)?am.flake_decay:0.01},flake_exp:{type:"f",value:(am.flake_exp!=undefined)?am.flake_exp:45},flake_reflect:{type:"f",value:(am.flake_reflect!=undefined)?am.flake_reflect:0.01},flake_weight:{type:"f",value:(am.flake_weight!=undefined)?am.flake_weight:0.01},global_weight:{type:"f",value:(am.global_weight!=undefined)?am.global_weight:1},irradiance_weight:{type:"f",value:(am.irradiance_weight!=undefined)?am.irradiance_weight:1},lit_color_bias:{type:"f",value:(am.lit_color_bias!=undefined)?am.lit_color_bias:8},mode:{type:"f",value:(am.mode!=undefined)?am.mode:0},spec_exp:{type:"f",value:(am.spec_exp!=undefined)?am.spec_exp:60},spec_glazing:{type:"f",value:(am.spec_glazing!=undefined)?am.spec_glazing:1},spec_sec_exp:{type:"f",value:(am.spec_sec_exp!=undefined)?am.spec_sec_exp:25},spec_sec_weight:{type:"f",value:(am.spec_sec_weight!=undefined)?am.spec_sec_weight:0.5},spec_weight:{type:"f",value:(am.spec_weight!=undefined)?am.spec_weight:0.2},transparency_multiply_blend:{type:"f",value:aw}}]),vertexShaderPars:["varying vec3 mPosition;","varying vec3 mNormal;",h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:["mPosition = position;","mNormal = normal;",h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:[h.ShaderChunk.utils_paint_fct,"uniform vec4 ambient;","uniform vec4 scene_ambient;","uniform vec4 base_color;","uniform vec4 edge_color;","uniform float edge_color_bias;","uniform vec4 lit_color;","uniform float lit_color_bias;","uniform float diffuse_weight;","uniform float diffuse_bias;","uniform float irradiance_weight;","uniform vec4 spec;","uniform float spec_weight;","uniform float spec_exp;","uniform vec4 spec_sec;","uniform float spec_sec_weight;","uniform float spec_sec_exp;","uniform bool spec_glazing;","uniform vec4 flake_color;","uniform float flake_weight;","uniform float flake_reflect;","uniform float flake_exp;","uniform float flake_decay;","uniform float flake_bump;","uniform float global_weight;","uniform float transparency_multiply_blend;","uniform float mode;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","varying vec3 mPosition;","varying vec3 mNormal;",h.ShaderChunk.basic_pars,].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,h.ShaderChunk.paint_fragment,"vec4 X0000025 = vec4(0.0, 0.0, 0.0, 1.0);","vec3 X0000026;","float X0000027;","vec4 X0000028;","float X0000029;","#if MAX_DIR_LIGHTS > 0","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {",h.ShaderChunk.illumination_lights_paint_fragment,"}","#endif","/* contributions */","if (X0000015 > 0.0)","{","result += ((X0000015 * (scene_ambient)) * X0000017);","}","result *= global_weight_v;","result.a = 1.0;","result.a = mix( result.a, 0.0, transparency_multiply_blend );","gl_FragColor = vec4(result);"].join("\n")});aB.needTangentBinormal=true;break;case"mip_car_paint":var aE=f(at+"car_paint_flakes.jpg",h.ImageUtils.crossOriginPolicy);var aB=new h.ShaderMaterialDS({side:h.DoubleSide,uniforms:h.UniformsUtils.merge([h.UniformsLib.lights,{ambient:{type:"fv4",value:(am.ambient!=undefined)?am.ambient:[0,0,0,1]},base_color:{type:"fv4",value:(am.base_color!=undefined)?am.base_color:[0,1,0,1]},scene_ambient:{type:"fv4",value:(am.__scene_ambient!=undefined)?am.__scene_ambient:[0,0,0,0]},edge_color:{type:"fv4",value:(am.edge_color!=undefined)?am.edge_color:[0.6,0.07,0.07,1]},flake_color:{type:"fv4",value:(am.flake_color!=undefined)?am.flake_color:[1,1,1,1]},lit_color:{type:"fv4",value:(am.lit_color!=undefined)?am.lit_color:[0.6,0,0.2,1]},spec:{type:"fv4",value:(am.spec!=undefined)?am.spec:[1,1,1,1]},Environment_map_cubic_1_env_tex_props:{type:"fv4",value:(am.Environment_map_cubic_1_env_tex_props!=undefined)?am.Environment_map_cubic_1_env_tex_props:[0,0,0,0]},msl_Carpaint_spec_sec:{type:"fv4",value:(am.msl_Carpaint_spec_sec!=undefined)?am.msl_Carpaint_spec_sec:[1,1,1,1]},msl_mi_bump_flakes_1_noise_tex_props:{type:"fv4",value:(am.msl_mi_bump_flakes_1_noise_tex_props!=undefined)?am.msl_mi_bump_flakes_1_noise_tex_props:[0,0,0,0]},raster_offset:{type:"fv2",value:(am.__raster_offset!=undefined)?am.__raster_offset:[0,0]},differential_scale:{type:"f",value:(am.__differential_scale!=undefined)?am.__differential_scale:1},incident_ior:{type:"f",value:(am.__incident_ior!=undefined)?am.__incident_ior:1},light_normal_mode:{type:"f",value:(am.__light_normal_mode!=undefined)?am.__light_normal_mode:1},light_scaling_factor:{type:"f",value:(am.__light_scaling_factor!=undefined)?am.__light_scaling_factor:0},object_label:{type:"f",value:(am.__object_label!=undefined)?am.__object_label:0},orthographic:{type:"f",value:(am.__orthographic!=undefined)?am.__orthographic:0},refracted_ior:{type:"f",value:(am.__refracted_ior!=undefined)?am.__refracted_ior:1.01},diffuse_bias:{type:"f",value:(am.diffuse_bias!=undefined)?am.diffuse_bias:1.5},diffuse_weight:{type:"f",value:(am.diffuse_weight!=undefined)?am.diffuse_weight:1},edge_color_bias:{type:"f",value:(am.edge_color_bias!=undefined)?am.edge_color_bias:1},flake_decay:{type:"f",value:(am.flake_decay!=undefined)?am.flake_decay:0.01},flake_density:{type:"f",value:(am.flake_density!=undefined)?am.flake_density:0.5},flake_exp:{type:"f",value:(am.flake_exp!=undefined)?am.flake_exp:45},flake_reflect:{type:"f",value:(am.flake_reflect!=undefined)?am.flake_reflect:0.01},flake_scale:{type:"f",value:(am.flake_scale!=undefined)?am.flake_scale:5},flake_strength:{type:"f",value:(am.flake_strength!=undefined)?am.flake_strength:2},flake_weight:{type:"f",value:(am.flake_weight!=undefined)?am.flake_weight:0.01},global_weight:{type:"f",value:(am.global_weight!=undefined)?am.global_weight:1},irradiance_weight:{type:"f",value:(am.irradiance_weight!=undefined)?am.irradiance_weight:1},lit_color_bias:{type:"f",value:(am.lit_color_bias!=undefined)?am.lit_color_bias:8},msl_Carpaint_spec_sec_exp:{type:"f",value:(am.msl_Carpaint_spec_sec_exp!=undefined)?am.msl_Carpaint_spec_sec_exp:25},msl_Carpaint_spec_sec_weight:{type:"f",value:(am.msl_Carpaint_spec_sec_weight!=undefined)?am.msl_Carpaint_spec_sec_weight:0.3},msl_Environment_map_cubic_1_intensity:{type:"f",value:(am.msl_Environment_map_cubic_1_intensity!=undefined)?am.msl_Environment_map_cubic_1_intensity:1},msl_mi_bump_flakes_1_noise_tex:{type:"t",value:aE},ReflectionCUBEMap:{type:"t",value:k},spec_exp:{type:"f",value:(am.spec_exp!=undefined)?am.spec_exp:60},spec_glazing:{type:"f",value:(am.spec_glazing!=undefined)?am.spec_glazing:1},spec_weight:{type:"f",value:(am.spec_weight!=undefined)?am.spec_weight:0.2},transparency_multiply_blend:{type:"f",value:aw}}]),vertexShaderPars:["varying vec3 mPosition;","varying vec3 mNormal;","varying vec2 vUV;",h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars,h.ShaderChunk.basic_pars].join("\n"),vertexShaderBody:["mPosition = position;","mNormal = normal;","vUV = uv;",h.ShaderChunk.envMaps_vertex,h.ShaderChunk.tangent_Binormal_vertex,h.ShaderChunk.basic_vertex].join("\n"),fragmentShaderPars:["uniform vec4 ambient;","uniform vec4 base_color;","uniform vec4 scene_ambient;","uniform vec4 edge_color;","uniform vec4 flake_color;","uniform vec4 lit_color;","uniform vec4 spec;","uniform vec4 Environment_map_cubic_1_env_tex_props;","uniform vec4 msl_Carpaint_spec_sec;","uniform vec4 msl_mi_bump_flakes_1_noise_tex_props;","uniform vec4 raster_offset;","uniform float differential_scale;","uniform float incident_ior;","uniform float light_normal_mode;","uniform float light_scaling_factor;","uniform float object_label;","uniform float orthographic;","uniform float refracted_ior;","uniform float diffuse_bias;","uniform float diffuse_weight;","uniform float edge_color_bias;","uniform float flake_decay;","uniform float flake_density;","uniform float flake_exp;","uniform float flake_reflect;","uniform float flake_scale;","uniform float flake_strength;","uniform float flake_weight;","uniform float global_weight;","uniform float irradiance_weight;","uniform float lit_color_bias;","uniform float msl_Carpaint_spec_sec_exp;","uniform float msl_Carpaint_spec_sec_weight;","uniform float msl_Environment_map_cubic_1_intensity;","uniform float spec_exp;","uniform bool spec_glazing;","uniform float spec_weight;","uniform float transparency_multiply_blend;","uniform sampler2D msl_mi_bump_flakes_1_noise_tex;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","varying vec3 mPosition;","varying vec3 mNormal;","varying vec2 vUV;","uniform samplerCube ReflectionCUBEMap;",h.ShaderChunk.basic_pars,h.ShaderChunk.envMaps_pars,h.ShaderChunk.tangent_Binormal_pars].join("\n"),fragmentShaderBody:[h.ShaderChunk.basic_fragment,h.ShaderChunk.tangent_Binormal_fragment,"vec2 texel      = mod( vUV, vec2(1.0) );","//baking","vec4  flake_lookup = texture2D( msl_mi_bump_flakes_1_noise_tex, texel );","vec3  flake_noise                  = flake_lookup.rgb;","float flake_intensity              = pow( flake_lookup.a, 1.0 / flake_density );","vec3  flake_normal_gradient_object = flake_noise.rgb - vec3(0.5);","vec3  flake_normal                 = normalize( normal + ( flake_normal_gradient_object * flake_strength ) );","vec3  flake_tint                   = flake_color.rgb * flake_intensity;","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular1 = vec3( 0.0 );","vec3 dirSpecular2 = vec3( 0.0 );","vec3 dirSpecular3 = vec3( 0.0 );","vec3 dirAmbient = vec3( 0.0 );","const float ambient_contribution  = 1.0;","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 direction_fragment_to_light = normalize(- lDirection.xyz );","vec3  direction_fragment_to_camera = -viewPosition;","vec3  reflected_light              = reflect( normalize(lDirection.xyz), normal );","vec3  half_light_eye                 = normalize( direction_fragment_to_light + direction_fragment_to_camera );","float angle_normal_light             = max( 0.0, dot(normal, direction_fragment_to_light) );","float angle_normal_camera            = max( 0.0, dot(normal, direction_fragment_to_camera ) );","float angle_normal_half_surface      = max( 0.0, dot(normal, half_light_eye) );","float angle_normal_half_flake        = max( 0.0, dot(flake_normal, half_light_eye) );","float  diffuse_bias_contribution     = pow( angle_normal_light, diffuse_bias );","float  color_variation_cursor        = pow( angle_normal_light, lit_color_bias ) * abs( angle_normal_camera );","vec3   diffuse_color_variation       = mix( vec3(1.0), lit_color.rgb, color_variation_cursor );","float  specular_intensifier          = pow( angle_normal_light, 0.5 );","float  specular_lobe_1               = step( 0.0, angle_normal_half_surface ) * exp( log( angle_normal_half_surface ) * 0.5 * spec_exp );","float  specular_lobe_2               = step( 0.0, angle_normal_half_surface ) * exp( log( angle_normal_half_surface ) * 0.5 * msl_Carpaint_spec_sec_exp );","float specular_lobe_flake         = step( 0.0, angle_normal_half_flake ) * exp( log( angle_normal_half_flake ) * 0.5 );","vec3  diffuse_contribution    = diffuse_color_variation * diffuse_bias_contribution;","float specular_1_contribution = specular_lobe_1         * specular_intensifier;","float specular_2_contribution = specular_lobe_2         * specular_intensifier;","float specular_3_contribution = specular_lobe_flake     * specular_intensifier;","dirDiffuse  +=  mix( vec3(0.0), directionalLightColor[i], diffuse_contribution );","dirSpecular1 +=  mix( vec3(0.0), vec3( 1.0 ), specular_1_contribution );","dirSpecular2 +=  mix( vec3(0.0), vec3( 1.0 ), specular_2_contribution );","dirSpecular3 +=  mix( vec3(0.0), vec3( 1.0 ), specular_3_contribution );","dirAmbient  +=  mix( vec3(0.0), vec3( 0.0 ), ambient_contribution );","}","#endif","float angle_normal_camera            = dot( normal, -viewPosition);",h.ShaderChunk.environment_fragment,"float cursor_edge_bias            = step( 0.0, edge_color_bias );","float color_variation_cursor_edge = pow( abs( angle_normal_camera ), edge_color_bias ); // Normal could lead to 0.0 > dot","vec3  diffuse_color_angular       = mix( base_color.rgb, mix( edge_color.rgb, base_color.rgb, color_variation_cursor_edge ), cursor_edge_bias );","float falloff                     = 1.0 - clamp( angle_normal_camera, 0.0, 1.0 );","vec3 mix_environment              = falloff * environment_lookup.rgb * msl_Environment_map_cubic_1_intensity;","vec3 mix_ambient                  = ambient.rgb * diffuse_color_angular;","vec3 mix_irradiance               = ( scene_ambient.rgb / Pi ) * diffuse_color_angular * irradiance_weight;","vec3 mix_diffuse                  = dirDiffuse.rgb * diffuse_color_angular * diffuse_weight;","vec3 mix_specular                 = dirSpecular1.rgb * spec.rgb                  * spec_weight"," + dirSpecular2.rgb * msl_Carpaint_spec_sec.rgb * msl_Carpaint_spec_sec_weight"," + dirSpecular3.rgb * flake_tint                * flake_weight;","vec3 mix_result = global_weight * ( mix_ambient + mix_irradiance + mix_diffuse + mix_specular ) + mix_environment;","float post_process_transparency_blend = mix( 1.0, 0.0, transparency_multiply_blend );","gl_FragColor = vec4( mix_result.rgb * mix_result.rgb, post_process_transparency_blend );"].join("\n")});aB.needTangentBinormal=true;aB.uniforms.msl_mi_bump_flakes_1_noise_tex.value=aE;break;default:return new h.MeshPhongMaterial();break}aB.force=true;aB.lights=true;if(aB.uniforms.ReflectionCUBEMap){aB.uniforms.ReflectionCUBEMap.value=k}if(aD!==undefined){if(aD!==0){aB.transparent=true}}return aB}return new h.MeshPhongMaterial()}var ag,A,aa,u="MeshPhongMaterial",F={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,blending:h.NormalBlending,side:h.DoubleSide};if(X.physicalMaterial){var z={};var Q=X.physicalMaterial.PhysicalMaterial;if(Q.isVisDescription){var s=this;var E=(X.mapping&&X.mapping.type)||Q.type==="Visu.EVisuPBR";var ak=function(am,an,ar,m,ap){var aq=Q[an];if(typeof aq!=="undefined"){if(aq.length){z[am]=new h.Color();z[am].setRGB(aq[0],aq[1],aq[2]);return}if(typeof aq.MADCoefficients!=="undefined"){var al=aq.MADCoefficients;z[am+"MulCoef"]=new h.Vector3(al[0],al[1],al[2]);z[am+"AddCoef"]=new h.Vector3(al[3],al[4],al[5])}if(typeof aq.value!=="undefined"){z[am]=new h.Color();z[am].setRGB(aq.value[0],aq.value[1],aq.value[2])}else{if(typeof aq.texture!=="undefined"&&m){z[am+"Map"]=s.getTexture({wrap:U,type:"data",resources:R[aq.texture]});z[am+"MapLinear"]=ap;var ao=Q[an+"UvTransform"];if(ao&&E){var at=new h.Matrix3();at.set(ao[0],ao[2],ao[4],ao[1],ao[3],ao[5],0,0,1);z[am+"UvTransform"]=at}}else{if(ar!==null){z[am]=new h.Color();z[am].setRGB(ar.x,ar.y,ar.z)}}}}};var t=function(am,an,ar,m,ap){var aq=Q[an];if(typeof aq!=="undefined"){if(typeof aq!=="object"){z[am]=aq;return}if(typeof aq.MADCoefficients!=="undefined"){var al=aq.MADCoefficients;z[am+"MulCoef"]=al[0];z[am+"AddCoef"]=al[1]}if(typeof aq.value!=="undefined"){z[am]=aq.value}else{if(typeof aq.texture!=="undefined"&&m){z[am+"Map"]=s.getTexture({wrap:U,type:"data",resources:R[aq.texture]});z[am+"MapLinear"]=ap;var ao=Q[an+"UvTransform"];if(ao&&E){var at=new h.Matrix3();at.set(ao[0],ao[2],ao[4],ao[1],ao[3],ao[5],0,0,1);z[am+"UvTransform"]=at}}else{if(ar!==null){z[am]=ar}}}}};var U=[0,0];if(Q.RepeatU){U[0]=1}if(Q.RepeatV){U[1]=1}var x=Q.diffuse||Q.albedo;if(x){if(x.MADCoefficients){var Z=x.MADCoefficients;z.diffuseMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.diffuseAddCoef=new h.Vector3(Z[3],Z[4],Z[5])}if(x.value){z.color=new h.Color();z.color.setRGB(x.value[0],x.value[1],x.value[2])}else{if(x.texture!=undefined){z.map=this.getTexture({wrap:U,type:"data",resources:R[x.texture]});var af=Q.diffuseUvTransform;if(af&&E){var G=new h.Matrix3();G.set(af[0],af[2],af[4],af[1],af[3],af[5],0,0,1);z.diffuseUvTransform=G}}}}if(Q.type==="Visu.EVisuPBR"){var N=function(ao,al){var m=Q[al];if(typeof m!=="undefined"){if(typeof m.texture!=="undefined"){z[ao+"Map"]=s.getTexture({wrap:U,type:"data",resources:R[m.texture]});var an=Q[ao+"MapUvTransform"];if(an){var am=new h.Matrix3();am.set(an[0],an[2],an[4],an[1],an[3],an[5],0,0,1);z[ao+"UvTransform"]=am}}}};t("metalness","metallic",0,true,true);t("roughness","roughness",0,true,true);t("anisotropyAngle","anisotropyRotation",0,true,true);N("normal","normal");t("opacity","cutoutOpacity",1,true,true);t("sheen","sheen",0,true,true);t("specularContrib","specular",1,true,true);ak("specular","specularTint",new h.Vector3(1,1,1),true,false);ak("flakesColor","flakeColor",new h.Vector3(1,1,1),true,false);t("flakesCoverage","flakeCoverage",0,true,false);t("flakesSize","flakeSize",0.5,true,false);t("flakesRoughness","flakeRoughness",0,true,false);t("clearCoat","clearcoat",0,true,true);N("clearCoatNormal","clearcoatNormal");t("clearCoatRoughness","clearcoatRoughness",0,false,true);t("orangePeel","orangePeel",false,false,true);t("orangePeelScale","orangePeelScale",0,false,true);ak("emissionColor","emissionColor",new h.Vector3(1,1,1),true,false);t("emissionValue","emissionValue",0,false,true);t("emissionNormalized","emissionEnergyNormalization",false,false,true);t("thinWalled","thinWalled",false,false,true);t("ior","ior",1.5,false,true);ak("attenuationColor","attenuationColor",new h.Vector3(1,1,1),false,false);ak("subsurfaceColor","subsurfaceColor",new h.Vector3(0,0,0),false,false);t("attenuationDistance","attenuationDistance",100000000,false,true)}else{ak("specular","fresnelCoefficient",new h.Vector3(1,1,1),true,false);ak("emissive","emissive",new h.Vector3(1,1,1),true,false);ak("flakesColor","flakesColor",new h.Vector3(0,0,0),false,false);ak("pearlFlakesColor","pearlFlakesColor",new h.Vector3(0,0,0),false,false);t("glossiness","glossiness",1,true,true);t("opacity","opacity",1,true,true);t("anisotropyAngle","anisotropyAngle",0,true,true);t("clearCoat","Coating",0,false,true);t("bumpScale","bumpScale",1,true,true);t("coatingGlossiness","coatingGlossiness",1,false,true);t("clearCoatNormalScale","coatingNormalBump",0,false,true);t("orangePeel","ProceduralCoating",false,false,true);t("orangePeelScale","coatingNormalScale",1,false,true);t("flakes","Flakes",false,false,true);t("flakesDensity","flakesDensity",0,true,false);t("flakesBump","flakesBump",1,false,true);t("flakesScale","flakesScale",0.5,false,true);t("flakesRoughness","flakesRoughness",0.25,false,true);t("pearlFlakesBump","pearlFlakesBump",1,false,true);t("pearlFlakesDensity","pearlFlakesDensity",1,false,true);if(Q.normalMap){z.normalMap=this.getTexture({type:"data",resources:R[Q.normalMap.texture],resourceId:Q.normalMap.texture});if(!Q.NormalMapConventionPositiveY){z.normalMapFlipY=false}else{z.normalMapFlipY=true}var af=Q.normalMapUvTransform;if(af&&E){var G=new h.Matrix3();G.set(af[0],af[2],af[4],af[1],af[3],af[5],0,0,1);z.normalUvTransform=G}}if(Q.coatingMap){z.clearCoatNormalMap=this.getTexture({type:"data",resources:R[Q.coatingMap.texture],resourceId:Q.coatingMap.texture})}}t("anisotropy","anisotropy",0,true,true);t("transparency","transparency",0,true,true);if(Q.UseAlphaDiffuseChannel){z.transparent=true}else{z.useAlphaFromDiffuseMap=false}if((z.opacity==1&&z.transparency>0)||z.opacityMap){z.transparent=true}if(Q.IsAlphaTestEnabled){z.transparent=false;z.alphaTest=0.5}}else{var n=Q.MappingOperator.Type;if(n!="None"){z.mappingUseFragment=true;z.mappingObjTransformation=new h.Matrix4();z.mappingObjTransformation.elements=Q.MappingOperator.ObjectTransformation;z.mappingNormTransformation=new h.Matrix3().getInverse(z.mappingObjTransformation).transpose();if(n=="Planar"){z.mappingType=1}else{if(n=="Spherical"){z.mappingType=2}else{if(n=="Spherical Normalized"){z.mappingType=3}else{if(n=="Cubic"){z.mappingType=4}else{if(n=="FiniteCylindrical"){z.mappingType=5}else{if(n=="InfiniteCylindrical"){z.mappingType=6}else{if(n=="InfiniteCylindrical Normalized"){z.mappingType=7}}}}}}}}z.mappingUVTransformation=new h.Matrix3();z.mappingUVTransformation.elements=Q.MappingOperator.UvTransformation;if(Q.Float3Parameter){var P=Q.Float3Parameter;if(P.diffuse){var Z=P.diffuse.MADCoefficients;if(P.diffuse.AsTexture==false){z.color=new h.Color();z.color.setRGB(P.diffuse.Value[0],P.diffuse.Value[1],P.diffuse.Value[2]);z.diffuseMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.diffuseAddCoef=new h.Vector3(Z[3],Z[4],Z[5])}else{var U=[0,0];if(P.diffuse.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(P.diffuse.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(P.diffuse.UvTransform&&n!="None"){var M=P.diffuse.UvTransform;z.diffuseUvTransform=new h.Matrix3(M[0],M[4],M[8],M[1],M[5],M[9],M[2],M[6],M[10])}z.diffuseMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.diffuseAddCoef=new h.Vector3(Z[3],Z[4],Z[5]);z.map=this.getTexture({wrap:U,type:"data",resources:R[P.diffuse.Texture],resourceId:P.diffuse.Texture})}}if(P.fresnelCoefficient){var Z=P.fresnelCoefficient.MADCoefficients;if(P.fresnelCoefficient.AsTexture==false){z.specular=new h.Color();z.specular.setRGB(P.fresnelCoefficient.Value[0],P.fresnelCoefficient.Value[1],P.fresnelCoefficient.Value[2]);z.specularMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.specularAddCoef=new h.Vector3(Z[3],Z[4],Z[5])}else{var U=[0,0];if(P.fresnelCoefficient.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(P.fresnelCoefficient.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(P.fresnelCoefficient.UvTransform&&n!="None"){var q=P.fresnelCoefficient.UvTransform;z.specularUvTransform=new h.Matrix3(q[0],q[4],q[8],q[1],q[5],q[9],q[2],q[6],q[10])}z.specularMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.specularAddCoef=new h.Vector3(Z[3],Z[4],Z[5]);z.specularMap=this.getTexture({wrap:U,type:"data",resources:R[P.fresnelCoefficient.Texture],resourceId:P.fresnelCoefficient.Texture});z.specularMapLinear=false}}if(P.emissive){var Z=P.emissive.MADCoefficients;if(P.emissive.AsTexture==false){z.emissive=new h.Color();z.emissive.setRGB(P.emissive.Value[0],P.emissive.Value[1],P.emissive.Value[2]);z.emissiveMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.emissiveAddCoef=new h.Vector3(Z[3],Z[4],Z[5])}else{z.emissive=new h.Color();z.emissive.setRGB(1,1,1);var U=[0,0];if(P.emissive.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(P.emissive.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(P.emissive.UvTransform&&n!="None"){var S=P.emissive.UvTransform;z.emissiveUvTransform=new h.Matrix3(S[0],S[4],S[8],S[1],S[5],S[9],S[2],S[6],S[10])}z.emissiveMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.emissiveAddCoef=new h.Vector3(Z[3],Z[4],Z[5]);z.emissiveMap=this.getTexture({wrap:U,type:"data",resources:R[P.emissive.Texture],resourceId:P.emissive.Texture});z.emissiveMapLinear=false}}if(P.coatingFresnelCoefficient){if(P.coatingFresnelCoefficient.AsTexture===false){z.coatingSpecularColor=new h.Color();z.coatingSpecularColor.setRGB(P.coatingFresnelCoefficient.Value[0],P.coatingFresnelCoefficient.Value[1],P.coatingFresnelCoefficient.Value[2])}}if(P.flakesColor){var Z=P.flakesColor.MADCoefficients;if(P.flakesColor.AsTexture===false){z.flakesColor=new h.Color();z.flakesColor.setRGB(P.flakesColor.Value[0],P.flakesColor.Value[1],P.flakesColor.Value[2]);z.flakesColorMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.flakesColorAddCoef=new h.Vector3(Z[3],Z[4],Z[5])}}if(P.pearlFlakesColor){var Z=P.pearlFlakesColor.MADCoefficients;if(P.pearlFlakesColor.AsTexture===false){z.pearlFlakesColor=new h.Color();z.pearlFlakesColor.setRGB(P.pearlFlakesColor.Value[0],P.pearlFlakesColor.Value[1],P.pearlFlakesColor.Value[2]);z.pearlFlakesColorMulCoef=new h.Vector3(Z[0],Z[1],Z[2]);z.pearlFlakesColorAddCoef=new h.Vector3(Z[3],Z[4],Z[5])}}}if(Q.FloatParameter){var v=Q.FloatParameter;if(v.glossiness){var Z=v.glossiness.MADCoefficients;if(v.glossiness.AsTexture==false){z.glossiness=v.glossiness.Value;z.glossinessMulCoef=Z[0];z.glossinessAddCoef=Z[1]}else{var U=[0,0];if(v.glossiness.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(v.glossiness.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(v.glossiness.UvTransform&&n!="None"){var L=v.glossiness.UvTransform;z.glossinessUvTransform=new h.Matrix3(L[0],L[4],L[8],L[1],L[5],L[9],L[2],L[6],L[10])}z.glossinessMulCoef=Z[0];z.glossinessAddCoef=Z[1];z.glossinessMap=this.getTexture({wrap:U,type:"data",resources:R[v.glossiness.Texture],resourceId:v.glossiness.Texture})}}if(v.bumpScale){var Z=v.bumpScale.MADCoefficients;if(v.bumpScale.AsTexture==false){var I=v.bumpScale.Value;z.normalScale=new h.Vector2(I,I);z.normalScaleMulCoef=Z[0];z.normalScaleAddCoef=Z[1]}}if(v.opacity){var Z=v.opacity.MADCoefficients;if(v.opacity.AsTexture==false){z.opacity=v.opacity.Value;z.opacityMulCoef=Z[0];z.opacityAddCoef=Z[1]}else{var U=[0,0];if(v.opacity.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(v.opacity.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(v.opacity.UvTransform&&n!="None"){var ae=v.opacity.UvTransform;z.opacityUvTransform=new h.Matrix3(ae[0],ae[4],ae[8],ae[1],ae[5],ae[9],ae[2],ae[6],ae[10])}z.opacityMulCoef=Z[0];z.opacityAddCoef=Z[1];z.opacityMap=this.getTexture({wrap:U,type:"data",resources:R[v.opacity.Texture],resourceId:Q.MapParameter.normalMap.Texture})}}if(v.transparency){var Z=v.transparency.MADCoefficients;if(v.transparency.AsTexture==false){z.transparency=v.transparency.Value;z.transparencyMulCoef=Z[0];z.transparencyAddCoef=Z[1]}}if(v.anisotropy){var Z=v.anisotropy.MADCoefficients;if(v.anisotropy.AsTexture==false){z.anisotropy=v.anisotropy.Value;z.anisotropyMulCoef=Z[0];z.anisotropyAddCoef=Z[1]}else{var U=[0,0];if(v.anisotropy.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(v.anisotropy.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(v.anisotropy.UvTransform&&n!="None"){var ai=v.anisotropy.UvTransform;z.anisotropyUvTransform=new h.Matrix3(ai[0],ai[4],ai[8],ai[1],ai[5],ai[9],ai[2],ai[6],ai[10])}z.anisotropyMulCoef=Z[0];z.anisotropyAddCoef=Z[1];z.anisotropyMap=this.getTexture({wrap:U,type:"data",resources:R[v.anisotropy.Texture],resourceId:v.anisotropy.Texture})}}if(v.anisotropyAngle){if(v.anisotropyAngle.AsTexture==false){var Z=v.anisotropyAngle.MADCoefficients;z.anisotropyAngle=v.anisotropyAngle.Value;z.anisotropyAngleMulCoef=Z[0];z.anisotropyAngleAddCoef=Z[1]}else{var U=[0,0];if(v.anisotropyAngle.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(v.anisotropyAngle.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(v.anisotropyAngle.UvTransform&&n!="None"){var W=v.anisotropyAngle.UvTransform;z.anisotropyAngleUvTransform=new h.Matrix3(W[0],W[4],W[8],W[1],W[5],W[9],W[2],W[6],W[10])}z.anisotropyAngleMulCoef=Z[0];z.anisotropyAngleAddCoef=Z[1];z.anisotropyAngleMap=this.getTexture({wrap:U,type:"data",resources:R[v.anisotropyAngle.Texture],resourceId:v.anisotropyAngle.Texture})}}if(v.coatingGlossiness){var Z=v.coatingGlossiness.MADCoefficients;if(v.coatingGlossiness.AsTexture===false){var I=Z[1]+v.coatingGlossiness.Value*Z[0];z.coatingGlossiness=I}else{var U=[0,0];if(v.coatingGlossiness.Sampling.TexCoordUWrap=="eRepeat"){U[0]=1}if(v.coatingGlossiness.Sampling.TexCoordVWrap=="eRepeat"){U[1]=1}if(v.coatingGlossiness.UvTransform&&n!="None"){var ad=v.coatingGlossiness.UvTransform;z.coatingGlossinessUvTransform=new h.Matrix3(ad[0],ad[4],ad[8],ad[1],ad[5],ad[9],ad[2],ad[6],ad[10])}z.coatingGlossinessMulCoef=Z[0];z.coatingGlossinessAddCoef=Z[1];z.coatingGlossinessMap=this.getTexture({wrap:U,type:"data",resources:R[v.coatingGlossiness.Texture],resourceId:v.coatingGlossiness.Texture})}}if(v.coatingBump){var Z=v.coatingBump.MADCoefficients;if(v.coatingBump.AsTexture===false){var I=Z[1]+v.coatingBump.Value*Z[0];z.clearCoatNormalScale=I}}if(v.coatingScale){var Z=v.coatingScale.MADCoefficients;if(v.coatingScale.AsTexture===false){var I=Z[1]+v.coatingScale.Value*Z[0];z.orangePeelScale=I}}if(v.flakesBump){var Z=v.flakesBump.MADCoefficients;if(v.flakesBump.AsTexture===false){var I=Z[1]+v.flakesBump.Value*Z[0];z.flakesBump=I}}if(v.flakesDensity){var Z=v.flakesDensity.MADCoefficients;if(v.flakesDensity.AsTexture===false){var I=Z[1]+v.flakesDensity.Value*Z[0];z.flakesDensity=I}}if(v.flakesScale){var Z=v.flakesScale.MADCoefficients;if(v.flakesScale.AsTexture===false){var I=Z[1]+v.flakesScale.Value*Z[0];z.flakesScale=I}}if(v.flakesRoughness){var Z=v.flakesRoughness.MADCoefficients;if(v.flakesRoughness.AsTexture===false){var I=Z[1]+v.flakesRoughness.Value*Z[0];z.flakesRoughness=I}}if(v.pearlFlakesBump){var Z=v.pearlFlakesBump.MADCoefficients;if(v.pearlFlakesBump.AsTexture===false){var I=Z[1]+v.pearlFlakesBump.Value*Z[0];z.pearlFlakesBump=I}}if(v.pearlFlakesDensity){var Z=v.pearlFlakesDensity.MADCoefficients;if(v.pearlFlakesDensity.AsTexture===false){var I=Z[1]+v.pearlFlakesDensity.Value*Z[0];z.pearlFlakesDensity=I}}}if(Q.AlphaMode=="eDiffuseChannel"){z.transparent=true}else{if((z.opacity==1&&z.transparency>0)||z.opacityMap){z.transparent=true}}if(Q.AlphaTest==true){z.transparent=false;z.alphaTest=0.5}if(Q.Coating===true){z.coating=1}if(Q.ProceduralCoating===true){z.orangePeel=true}if(Q.Flakes===true){z.flakes=true}if(Q.NormalMap&&Q.NormalMap.UseNormalMap==true){z.normalMap=this.getTexture({type:"data",resources:R[Q.NormalMap.Texture],resourceId:Q.NormalMap.Texture})}if(Q.MapParameter&&Q.MapParameter.normalMap&&Q.MapParameter.normalMap.Enabled==true){z.normalMap=this.getTexture({type:"data",resources:R[Q.MapParameter.normalMap.Texture],resourceId:Q.MapParameter.normalMap.Texture});if(Q.MapParameter.normalMap.UvTransform&&n!="None"){var o=Q.MapParameter.normalMap.UvTransform;z.normalUvTransform=new h.Matrix3(o[0],o[4],o[8],o[1],o[5],o[9],o[2],o[6],o[10])}if(Q.NormalMapConvention!="PositiveY"){z.normalMapFlipY=false}else{z.normalMapFlipY=true}}if(Q.MapParameter&&Q.MapParameter.coatingBumpMap&&Q.MapParameter.coatingBumpMap.Enabled==true){z.clearCoatNormalMap=this.getTexture({type:"data",resources:R[Q.MapParameter.coatingBumpMap.Texture],resourceId:Q.MapParameter.coatingBumpMap.Texture});if(Q.MapParameter.coatingBumpMap.UvTransform&&n!="None"){var o=Q.MapParameter.coatingBumpMap.UvTransform;z.clearCoatNormalUvTransform=new h.Matrix3(o[0],o[4],o[8],o[1],o[5],o[9],o[2],o[6],o[10])}if(Q.CoatingBumpMapConvention!="PositiveY"){z.clearCoatNormalMapFlipY=false}else{z.clearCoatNormalMapFlipY=true}}}z.NRECompatibility=true;var Y=new h.PhysicalMaterial(z);if(X.mapping){var r=null;if(X.mapping.ObjectTransformation){r=new h.Matrix4();r.elements=X.mapping.ObjectTransformation}var p=null;if(X.mapping.UvTransformation&&(Q.type==="Visu.EVisuPBR"||X.mapping.type)){p=new h.Matrix3();p.elements=X.mapping.UvTransformation}var H=X.mapping.type;if(Q.type!="Visu.EVisuPBR"){if(H==7){H--}if(H>=3){H--}}Y.setMappingOperator(H,r,p,true)}return Y}if(X.shaderMaterial){if(X.shaderMaterial.PDSFX){Y=V(X.shaderMaterial,R,this,X.transparent);if(Y){return Y}}else{return Y=y(X.shaderMaterial,R,this,X.transparent)}}if(X===null){return new h.MeshPhongMaterial()}if(X.wireframe!==undefined){F.wireframe=X.wireframe}if(X.transparent!==undefined){F.opacity=1-X.transparent;if(F.opacity!==1){F.transparent=true}}if(X.shading){if(X.shading==="Phong"){u="MeshPhongMaterial"}else{if(X.shading==="Basic"){u="MeshBasicMaterial"}}}if(X.blending){if(X.blending==="Additive"){F.blending=h.AdditiveBlending}else{if(X.blending==="Subtractive"){F.blending=h.SubtractiveBlending}else{if(X.blending==="Multiply"){F.blending=h.MultiplyBlending}}}}if(X.depthTest!==undefined){F.depthTest=X.depthTest}if(X.vertexColors!==undefined){if(X.vertexColors==="face"){F.vertexColors=h.FaceColors}else{if(X.vertexColors){F.vertexColors=h.VertexColors}}}var C;if(X.colorDiffuse){if(typeof(X.diffuseCoef)!="undefined"){C=[X.colorDiffuse[0]*X.diffuseCoef,X.colorDiffuse[1]*X.diffuseCoef,X.colorDiffuse[2]*X.diffuseCoef];F.color=ab(C)}else{F.color=ab(X.colorDiffuse)}}else{if(X.DbgColor){F.color=X.DbgColor}}if(X.colorSpecular){if(typeof(X.specularCoef)!="undefined"){C=[X.colorSpecular[0]*X.specularCoef,X.colorSpecular[1]*X.specularCoef,X.colorSpecular[2]*X.specularCoef];F.specular=ab(C)}else{F.specular=ab(X.colorSpecular)}}if(X.colorAmbient){if(typeof(X.ambientCoef)!="undefined"){C=[X.colorAmbient[0]*X.ambientCoef,X.colorAmbient[1]*X.ambientCoef,X.colorAmbient[2]*X.ambientCoef];F.ambient=ab(C)}else{F.ambient=ab(X.colorAmbient)}}if(X.transparency){F.opacity=X.transparency;if(F.opacity!==1){F.transparent=true}}if(X.shininess){F.shininess=X.shininess}if(X.reflectivityCoef){F.reflectivity=X.reflectivityCoef}if(X.alphaTest){F.alphaTest=X.alphaTest}if((X.reflectivityCoef>0.1)&&(X.ReflectionMap===undefined)){var ah=c.getWebappsAssetUrl("Visualization","");var B=f(ah+"defaultEnvMap.png",h.ImageUtils.crossOriginPolicy);B.flipY=true;F.envMap=B;F.combine=h.MixOperation;F.envMap.mapping=new h.SphericalReflectionMapping();F.perPixel=true}if(X.textureId!==undefined&&X.textureId!==-1){if(X.textureBlending!==undefined){F.textureBlending=X.textureBlending}if(X.mappingFunction==="SPHERICAL_ENV_MAP"){F.sphereMap=true}else{F.map=this.getTexture({type:"data",resources:R[X.textureId],filter:[X.minFilter,X.magFilter],wrap:[X.textureWrapS,X.textureWrapT],resourceId:X.textureId});if(F.map.transparent){F.transparent=true;F.alphaTest=0.0001}}}if(X.DiffuseMap&&aj){F.map=this.getTexture({type:"url",sourceFile:X.DiffuseMap,texturePath:aj,material:X,cb:O,repeat:X.DiffuseMapRepeat,offset:X.DiffuseMapOffset,wrap:X.DiffuseMapWrap,format:K})}if(X.mapLight&&aj){F.lightMap=this.getTexture({type:"url",sourceFile:X.mapLight,material:X,cb:O,texturePath:aj,repeat:X.mapLightRepeat,offset:X.mapLightOffset,wrap:X.mapLightWrap})}if(X.mapNormal&&aj){F.normalMap=this.getTexture({type:"url",sourceFile:X.mapNormal,material:X,cb:O,texturePath:aj,repeat:X.mapNormalRepeat,offset:X.mapNormalOffset,wrap:X.mapNormalWrap})}if(X.mapSpecular&&aj){F.specularMap=this.getTexture({type:"url",sourceFile:X.mapSpecular,material:X,cb:O,texturePath:aj,repeat:X.mapSpecularRepeat,offset:X.mapSpecularOffset,wrap:X.mapSpecularWrap})}if(X.ReflectionMap&&aj){F.envMap=this.getTexture({type:"url_envMap",sourceFile:X.mapSpecular,material:X,cb:O,texturePath:aj,repeat:X.mapSpecularRepeat,offset:X.mapSpecularOffset,wrap:X.mapSpecularWrap})}if(X.mapNormal){ag=h.ShaderUtils.lib.normal;A=h.UniformsUtils.clone(ag.uniforms);A.tNormal.texture=F.normalMap;if(X.mapNormalFactor){A.uNormalScale.value=X.mapNormalFactor}if(F.map){A.tDiffuse.texture=F.map;A.enableDiffuse.value=true}if(F.specularMap){A.tSpecular.texture=F.specularMap;A.enableSpecular.value=true}if(F.lightMap){A.tAO.texture=F.lightMap;A.enableAO.value=true}A.uDiffuseColor.value.setHex(F.color);A.uSpecularColor.value.setHex(F.specular);A.uAmbientColor.value.setHex(F.ambient);A.uShininess.value=F.shininess;if(F.opacity!==undefined){A.uOpacity.value=F.opacity}aa={fragmentShader:ag.fragmentShader,vertexShader:ag.vertexShader,uniforms:A,lights:true,fog:true};Y=new h.ShaderMaterial(aa)}else{Y=new h[u](F);if(X.mapping){var r=null;if(X.mapping.ObjectTransformation){r=new h.Matrix4();r.elements=X.mapping.ObjectTransformation}var p=null;if(X.mapping.UvTransformation){p=new h.Matrix3();p.elements=X.mapping.UvTransformation}Y.setMappingOperator(X.mapping.type,r,p,true)}}if(X.DbgName!==undefined){Y.name=X.DbgName}if(X.textureId!==undefined&&X.textureId!==-1){X.url=R[X.textureId].url}var w=false;for(var T in Y){if(Y.hasOwnProperty(T)&&Y[T] instanceof h.Texture){w=true;break}}this.materials.push({params:X,threejs_mat:Y,hasTexture:w,});Y._source=h.AssetSource.MATERIAL_MANAGER;if(X.__nbTexturesToLoad===0){for(var ac=0;ac<X.__cbLoadedImages.length;ac++){X.__cbLoadedImages[ac](Y)}}if(Y.map&&Y.map.needToCheckTransparency){Y.map.transparentCb=function(m){Y.transparent=m}}return Y},createPointMaterial:function(s){var p=null;var u=9;var m=false;var n=s.color;var r;var o=s.opacity;var t=false;if(s.symbol){o=undefined;if(typeof s.symbol==="object"){n=new h.Color(16777215);r=this.getTexture({type:"data",resources:s.resource[s.symbol.id],texturePoint:true,resourceId:s.symbol.id});if(r.zoom){u=9;m=false}else{u=r.size;t=true}}else{var q=c.getWebappsAssetUrl("Visualization","");switch(s.symbol){case 0:r=null;u=1;break;case 1:r=f(q+"textures/point/cross.png",h.ImageUtils.crossOriginPolicy);break;case 2:r=f(q+"textures/point/plus.png",h.ImageUtils.crossOriginPolicy);break;case 3:r=f(q+"textures/point/concentric.png",h.ImageUtils.crossOriginPolicy);break;case 4:r=f(q+"textures/point/coincident.png",h.ImageUtils.crossOriginPolicy);break;case 5:r=f(q+"textures/point/fullCircle.png",h.ImageUtils.crossOriginPolicy);u=5;break;case 6:r=f(q+"textures/point/fullSquare.png",h.ImageUtils.crossOriginPolicy);u=7;break;case 7:r=f(q+"textures/point/star.png",h.ImageUtils.crossOriginPolicy);break;case 8:r=f(q+"textures/point/dot.png",h.ImageUtils.crossOriginPolicy);u=3;break;case 9:r=f(q+"textures/point/smallDot.png",h.ImageUtils.crossOriginPolicy);u=2;break;default:r=f(q+"textures/point/cross.png",h.ImageUtils.crossOriginPolicy);break}t=true;u=Math.round(u*(window.devicePixelRatio||1))}}else{u=s.size}p=new h.ParticleBasicMaterial({size:u,color:n,map:r,blending:h.NormalBlending,depthTest:false,sizeAttenuation:m,transparent:t,alphatest:0.001});if(o){p.opacity=o}return p},createTexture:function(D){function v(Y){var X=Math.log(Y)/Math.LN2;return Math.floor(X)===X}function R(Y){var X=Math.log(Y)/Math.LN2;return Math.pow(2,Math.round(X))}function J(Z,Y){var ab=new Image(),aa,X;h.ImageUtils.nbTexturesBeingLoaded++;D.material.__nbTexturesToLoad++;Z.loadEndStatus="loading";ab.onload=function(){Z.loadEndStatus="complete";if(!v(ab.width)||!v(ab.height)){aa=R(ab.width);X=R(ab.height);Z.image.width=aa;Z.image.height=X;Z.image.getContext("2d").drawImage(ab,0,0,aa,X)}else{Z.image=ab}Z.needsUpdate=true;h.ImageUtils.nbTexturesBeingLoaded--;D.material.__nbTexturesToLoad--;for(var ac=0;ac<Z.onLoadCallbacks.length;ac++){Z.onLoadCallbacks[ac](Z)}if(D.material.__nbTexturesToLoad===0){for(var ac=0;ac<D.material.__cbLoadedImages.length;ac++){D.material.__cbLoadedImages[ac](D.cb())}}};ab.onerror=function(){h.ImageUtils.nbTexturesBeingLoaded--;D.material.__nbTexturesToLoad--;Z.loadEndStatus="error";if(D.material.__nbTexturesToLoad===0){for(var ac=0;ac<D.material.__cbLoadedImages.length;ac++){D.material.__cbLoadedImages[ac](D.cb())}}};ab.crossOrigin="anonymous";ab.src=Y}function N(Z,Y){var aa,X;Z.image=[];h.ImageUtils.nbTexturesBeingLoaded++;Z.image.loadCount=0;for(aa=0,X=6;aa<X;++aa){Z.image[aa]=new Image();Z.image[aa].onload=function(){Z.image.loadCount+=1;if(Z.image.loadCount===6){Z.needsUpdate=true;h.ImageUtils.nbTexturesBeingLoaded--;for(var ab=0;ab<Z.onLoadCallbacks.length;ab++){Z.onLoadCallbacks[ab](Z)}}};Z.image[aa].onerror=function(){Z.image.loadCount+=1;if(Z.image.loadCount===6){h.ImageUtils.nbTexturesBeingLoaded--}};Z.image[aa].crossOrigin="anonymous";Z.image[aa].src=Y}}function u(an,ak,aq,ah,ac,ap){var ao=ak/ah,Y=new Float32Array(aq*ah*ap),ad,Z,aa,aj,X,ai,af,ae,am,al,ab,ag;if(ao!==1){ai=ao/2;for(af=0;af<ah;af++,ai+=ao){ad=Math.floor(ai);if(ad>=(aq-1)){Z=0}else{Z=ap}aa=ai-ad;aj=af*ap;X=ad*ap;for(ae=0;ae<aq;ae++,aj+=ah*ap,X+=ak*ap){for(am=0;am<ap;am++){Y[aj+am]=an[X+am]*(1-aa)+an[X+Z+am]*aa}}}}else{for(al=0;al<aq*ah*ap;al++){Y[al]=an[al]}}ab=aq/ac;ag=new Uint8Array(ac*ah*ap);if(ab!==1){ai=ab/2;for(ae=0;ae<ac;ae++,ai+=ab){ad=Math.floor(ai);if(ad>=(aq-1)){Z=0}else{Z=ap*ah}aa=ai-ad;aj=ae*ah*ap;X=ad*ah*ap;for(af=0;af<ah;af++,aj+=ap,X+=ap){for(am=0;am<ap;am++){ag[aj+am]=Y[X+am]*(1-aa)+Y[X+Z+am]*aa}}}}else{for(al=0;al<ac*ah*ap;al++){ag[al]=Y[al]}}return ag}function t(Y){var X;for(X=3;X<Y.length;X+=4){if(Y[X]!=255){return true}}return false}function O(ar,ap,ae,az,aE){var aa,aj,au,aA,aF,ah,af,aB,ay,av,ad,aG,am,ai,ao,aC,ax,al,X,an,Z;function Y(aH){aC=aH[4];aH[4]=aH[7];aH[7]=aC;aC=aH[5];aH[5]=aH[6];aH[6]=aC}function ak(aH){aC=aH[4];aH[4]=aH[5];aH[5]=aC}function aD(aH){aC=aH[0];aH[0]=aH[6];aH[6]=aC;aC=aH[1];aH[1]=aH[7];aH[7]=aC;aC=aH[2];aH[2]=aH[4];aH[4]=aC;aC=aH[3];aH[3]=aH[5];aH[5]=aC;Y(aH.subarray(8,16))}function ac(aH){aC=aH[0];aH[0]=aH[2];aH[2]=aC;aC=aH[1];aH[1]=aH[3];aH[3]=aC;Y(aH.subarray(8,16))}function ab(aH){al=aH[2]+256*(aH[3]+256*aH[4]);an=aH[5]+256*(aH[6]+256*aH[7]);X=((al&4095)<<12)|((al&16773120)>>12);Z=((an&4095)<<12)|((an&16773120)>>12);aH[2]=Z&255;aH[3]=(Z&65280)>>8;aH[4]=(Z&16711680)>>8;aH[5]=X&255;aH[6]=(X&65280)>>8;aH[7]=(X&16711680)>>8;Y(aH.subarray(8,16))}function ab(aH){al=aH[2]+256*(aH[3]+256*aH[4]);an=aH[5]+256*(aH[6]+256*aH[7]);X=((al&4095)<<12)|((al&16773120)>>12);Z=((an&4095)<<12)|((an&16773120)>>12);aH[2]=Z&255;aH[3]=(Z&65280)>>8;aH[4]=(Z&16711680)>>8;aH[5]=X&255;aH[6]=(X&65280)>>8;aH[7]=(X&16711680)>>8;Y(aH.subarray(8,16))}function aq(aH){al=aH[2]+256*(aH[3]+256*aH[4]);X=((al&4095)<<12);aH[2]=X&255;aH[3]=(X&65280)>>8;aH[4]=(X&16711680)>>8;Y(aH.subarray(8,16))}function aw(aJ,aH){var aI;for(aI=0;aI<aJ.length;aI++){aJ[aI]=aH[aI]}}switch(az){case h.RGB_S3TC_DXT1_Format:au=8;aa=Y;aj=ak;break;case h.RGBA_S3TC_DXT3_Format:au=16;aa=aD;aj=ac;break;case h.RGBA_S3TC_DXT5_Format:au=16;aa=ab;aj=aq;break;default:console.error("flip dds error");return aE}aA=ar;aF=ap;for(ay=0;ay<ae;++ay){aG=aE[ay].data;ah=Math.floor((aA+3)/4);af=Math.floor((aF+3)/4);aB=ah*af;if(aF==1){break}else{if(aF==2){for(av=0;av<ah;av++){aj(aG.subarray(ad,av*au));ad=+au}}else{ad=0;for(av=1;av<=aB;av++){if(av==4095){var at}aa(aG.subarray(ad,av*au));ad+=au}ax=au*ah;ao=new Uint8Array(ax);for(var ag=0;ag<af/2;++ag){am=aG.subarray(ag*ax,(ag+1)*ax);ai=aG.subarray((af-ag-1)*ax,(af-ag)*ax);aw(ao,am);aw(am,ai);aw(ai,ao)}}}aA/=2;if(aA<1){ar=1}aF/=2;if(aF<1){ap=1}}}function B(aa,ad,af,X,ae){var ab;var ac=parseInt((af/2),10)+af%2;var ag=new Uint8Array(X*(ae+af)*4);if(ad==h.RGBAFormat){var Z=ac*X*4;for(ab=0;ab<aa.length;ab++){ag[Z+ab]=aa[ab]}}else{var Z=ac*X*4;var Y=0;for(ab=0;ab<aa.length;ab+=3,Y+=4){ag[Z+Y]=aa[ab];ag[Z+Y+1]=aa[ab+1];ag[Z+Y+2]=aa[ab+2];ag[Z+Y+3]=1}}return ag}function H(ad,af,Z,X,ag){var ae,ac,aa,ab;var Y=parseInt((Z/2),10)+Z%2;var ah=new Uint8Array(ag*(X+Z)*4);if(af==h.RGBAFormat){ab=0;for(ae=0;ae<ag;ae++){ab=Y*4+(X+Z)*4*ae;for(ac=0;ac<X*4;ac++){ah[ab+ac]=ad[ae*X*4+ac]}}}else{ab=0;for(ae=0;ae<ag;ae++){ab=Y*4+(X+Z)*4*ae;for(ac=0,aa=0;ac<X;ac+=3,aa+=4){ah[ab+aa]=ad[ae*X*4+ac];ah[ab+aa+1]=ad[ae*X*4+ac+1];ah[ab+aa+2]=ad[ae*X*4+ac+2];ah[ab+aa+3]=1}}}return ah}var E,A,G,V,w,P;if((D.wrap[0]===1)||(D.wrap[0]=="repeat")){E=h.RepeatWrapping}else{E=h.ClampToEdgeWrapping}if((D.wrap[1]===1)||(D.wrap[0]=="repeat")){A=h.RepeatWrapping}else{A=h.ClampToEdgeWrapping}switch(D.filter[0]){case 0:V=h.NearestFilter;break;case 1:V=h.LinearFilter;break;case 2:V=h.NearestMipMapNearestFilter;break;case 3:V=h.NearestMipMapLinearFilter;break;case 4:V=h.LinearMipMapNearestFilter;break;case 5:V=h.LinearMipMapLinearFilter;break}switch(D.filter[1]){case 0:G=h.NearestFilter;break;case 1:G=h.LinearFilter;break;case 2:G=h.NearestMipMapNearestFilter;break;case 3:G=h.NearestMipMapLinearFilter;break;case 4:G=h.LinearMipMapNearestFilter;break;case 5:G=h.LinearMipMapLinearFilter;break}switch(D.type){case"url":var K=/(?:\.([^.]+))?$/,T=K.exec(D.sourceFile.filename)[1],r,o;if(T==="dds"){w=h.ImageUtils.loadCompressedTextureFromBuffer(D.sourceFile.buffer)}else{r=document.createElement("canvas");w=new h.Texture(r);if(D.format==="XMLV6"){w.sourceFile=D.sourceFile}else{w.sourceFile=window.URL.createObjectURL(D.sourceFile.buffer)}}if(D.offset){w.offset.set(D.offset[0],D.offset[1])}if(T==="dds"){if(w&&w.mipmaps){o=w.mipmaps;if((o[o.length-1].height!=1)||(o[o.length-1].width!=1)){V=G=h.LinearFilter}}w.flipY=true;break}if(D.format==="XMLV6"){J(w,D.texturePath+"/"+D.sourceFile)}else{J(w,w.sourceFile)}if(w){w.flipY=true}break;case"url_envMap":var K=/(?:\.([^.]+))?$/,T=K.exec(sourceFile.filename)[1],r,o;if(T==="dds"){w=h.ImageUtils.loadCompressedTextureFromBuffer(sourceFile.buffer)}else{r=document.createElement("canvas");w=new h.Texture(r);if(D.format==="XMLV6"){w.sourceFile=sourceFile}else{w.sourceFile=window.URL.createObjectURL(sourceFile.buffer)}}if(D.offset){w.offset.set(D.offset[0],D.offset[1])}if(T==="dds"){if(w&&w.mipmaps){o=w.mipmaps;if((o[o.length-1].height!=1)||(o[o.length-1].width!=1)){w.minFilter=w.magFilter=h.LinearFilter}}w.flipY=true;break}N(w,D.texturePath+"/"+sourceFile);if(w){w.flipY=true}break;case"data":var m,p,U,z,F,s,M,S=false,Q=false;if(D.resources.mipmaps){var C=D.resources;if(C.url=="default_white_color.dds"){if(d==null){var W=c.getWebappsAssetUrl("Visualization","");w=f(W+"default_white_color.png")}else{w=d}break}var L=0;switch(C.format){case 3:L=h.RGBAFormat;break;case 6:L=h.RGB_S3TC_DXT1_Format;S=true;break;case 7:L=h.RGBA_S3TC_DXT1_Format;S=true;break;case 8:L=h.RGBA_S3TC_DXT3_Format;S=true;break;case 9:L=h.RGBA_S3TC_DXT5_Format;S=true;break}if(S){O(C.width,C.height,C.mipmapCount,L,C.mipmaps)}w=new h.CompressedTexture(C.mipmaps,C.width,C.height,L,undefined,new h.UVMapping(),E,A,G,V);w.flipY=false;w.generateMipmaps=false;w.needsUpdate=true;break}m=D.resources.width;p=D.resources.height;U=D.resources.img;z=D.resources.format;var x=false;if(D.filter[0]>1||D.filter[1]>1){x=true}if(E==h.RepeatWrapping||A==h.RepeatWrapping){x=true}if(D.resources.zoom){P=true}switch(z){case 0:z=h.LuminanceFormat;break;case 1:z=h.LuminanceAlphaFormat;break;case 2:z=h.RGBFormat;break;case 3:z=h.RGBAFormat;M=t(U);break;default:}if(D.resources.compression){var I=function(aa){var X=aa.image;var Y=document.createElement("canvas");Y.width=X.width;Y.height=X.height;Y.getContext("2d").drawImage(X,0,0,X.width,X.height);var Z=Y.getContext("2d").getImageData(0,0,X.width,X.height);w.transparent=t(Z.data);if(w.transparentCb){w.transparentCb(w.transparent)}};var y=new Blob([U],{type:"image/png"});var q=URL.createObjectURL(y);w=h.ImageUtils.loadTexture(q,undefined,I,null,h.ImageUtils.crossOriginPolicy,x);w.needToCheckTransparency=true;w.size=m;break}if(D.texturePoint){if(m>p){U=B(U,z,m-p,m,p);p=m}else{if(p>m){U=H(U,z,p-m,m,p);m=p}}}else{if((!v(m)||!v(p))&&x){F=R(m);s=R(p);if(z===h.RGBAFormat){U=u(U,m,p,F,s,4)}else{if(z===h.RGBFormat){U=u(U,m,p,F,s,3)}}m=F;p=s}}w=new h.DataTexture(U,m,p,z,undefined,undefined,E,A,G,V);if(w){w.size=m;w.flipY=false;if(M){w.transparent=true}if(z==h.RGBFormat){var n=m*3;if(n%4){w.unpackAlignment=2;if(n%2){w.unpackAlignment=1}}}}w.needsUpdate=true;break}if(w){if(P){w.zoom=true}w.wrapS=E;w.wrapT=A;w.magFilter=G;w.minFilter=V}return w},_getDashPattern:function(n){var m;switch(n){case e.LinePatternEnum.DOTTED:m=new Float32Array(2);m[0]=3;m[1]=3;break;case e.LinePatternEnum.DASHED:m=new Float32Array(2);m[0]=5;m[1]=1;break;case e.LinePatternEnum.DOTDASHED:m=new Float32Array(4);m[0]=5;m[1]=3;m[2]=2;m[3]=3;break;case e.LinePatternEnum.PHANTOM:m=new Float32Array(6);m[0]=2;m[1]=2;m[2]=2;m[3]=2;m[4]=6;m[5]=2;break;case e.LinePatternEnum.SMALLDOTTED:m=new Float32Array(2);m[0]=1;m[1]=1;break;case e.LinePatternEnum.JISAXIS:m=new Float32Array(4);m[0]=14;m[1]=2;m[2]=4;m[3]=2;break;default:m=new Float32Array(1);m[0]=-1;break}return m},set3DXMaterial:function(m,n){this.threeDXMaterials.set(m,n)},get3DXMaterial:function(m){if(this.threeDXMaterials.has(m)){return this.threeDXMaterials.get(m)}return null},getMaterialFromGAS:function(q){var p,s,o;if(q.color==undefined){q.color=new h.Color()}if(q.opacity===undefined){q.opacity=1}for(o=0;o<this.materials.length;o++){p=this.materials[o];s=p.params;if(s.type!=="color"){continue}if((q.symbol!==undefined)&&(s.style!=="point")){continue}if((q.lineWidth!==undefined)&&(s.style!=="line")){continue}if((q.lineWidth===undefined)&&(q.symbol===undefined)&&(s.style!=="fill")){continue}if((q.pattern!==undefined)&&(s.pattern!==q.pattern)){continue}if((s.color.r!==q.color.r)||(s.color.g!==q.color.g)||(s.color.b!==q.color.b)){continue}if(s.opacity!==q.opacity){continue}if((q.lineWidth!==undefined)&&(s.lineWidth!==q.lineWidth)){continue}if((q.symbol!==undefined)&&(s.symbol!==q.symbol)){continue}if((q.size!==undefined)&&(s.size!==q.size)){continue}if((q.solid!==undefined)&&(s.solid!==q.solid)){continue}if((q.basic)&&(s.basic!==q.basic)){continue}return p.threejs_mat}if(q.symbol!==undefined){s={type:"color",style:"point",color:q.color,opacity:q.opacity,symbol:q.symbol,size:q.size};var p=this.createPointMaterial({symbol:q.symbol,color:q.color,opacity:q.opacity,resource:q.resource,size:q.size})}else{if(q.lineWidth!==undefined){s={type:"color",style:"line",color:q.color,opacity:q.opacity,lineWidth:q.lineWidth,pattern:q.pattern};var n=(q.pattern instanceof Array)?q.pattern:this._getDashPattern(q.pattern);p=new h.LineBasicMaterial({color:q.color.getHex(),lineWidth:q.lineWidth,scale:6.66,dashPattern:n,opacity:q.opacity,transparent:(q.opacity<1)})}else{if(q.basic){s={type:"color",style:"fill",color:q.color,opacity:q.opacity,basic:q.basic,solid:q.solid};p=new h.MeshBasicMaterial({color:q.color.getHex(),side:q.solid===1?h.FrontSide:h.DoubleSide,opacity:q.opacity,transparent:(q.opacity<1)})}else{s={type:"color",style:"fill",color:q.color,opacity:q.opacity,solid:q.solid};p=new h.MeshPhongMaterial({color:q.color.getHex(),opacity:q.opacity,transparent:(q.opacity<1),side:q.solid===1?h.FrontSide:h.DoubleSide,specular:16777215,shininess:76})}}}var m=false;for(var r in p){if(p.hasOwnProperty(r)&&p[r] instanceof h.Texture){m=true;break}}this.materials.push({params:s,threejs_mat:p,hasTexture:m});p._source=h.AssetSource.MATERIAL_MANAGER;return p}});return UWA.namespace("THREEDS/MaterialManager",l)});define("Visualization/MaterialManager",["DS/Visualization/MaterialManager","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/MaterialManager");return b});define("DS/Visualization/RenderTargetPool",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(a,b){var c=a.extend({init:function(e){var d=b.FloatType;if(!e.supportsFloatTextures()){d=b.UnsignedByteType}this.rtOptionsMap={linear:{minFilter:b.LinearFilter,magFilter:b.LinearFilter,stencilBuffer:true,format:b.RGBAFormat,type:d},nearest:{minFilter:b.NearestFilter,magFilter:b.NearestFilter,stencilBuffer:true,format:b.RGBAFormat,type:d},uint:{minFilter:b.LinearFilter,magFilter:b.LinearFilter,stencilBuffer:true,format:b.RGBAFormat,type:b.UnsignedByteType},uintRGBA:{minFilter:b.LinearFilter,magFilter:b.LinearFilter,stencilBuffer:false,format:b.RGBAFormat,type:b.UnsignedByteType},uintNearest:{minFilter:b.NearestFilter,magFilter:b.NearestFilter,stencilBuffer:true,format:b.RGBAFormat,type:b.UnsignedByteType},uintRGBNearest:{minFilter:b.NearestFilter,magFilter:b.NearestFilter,stencilBuffer:true,format:b.RGBFormat,type:b.UnsignedByteType},cubelinear:{minFilter:b.LinearFilter,magFilter:b.LinearFilter,stencilBuffer:true,format:b.RGBAFormat,type:d},};this.renderTargetPool=[]},areRenderTargetOptionsEqual:function(e,d){if(!e||!d){return e===d}return e.height===d.height&&e.width===d.width&&e.options===d.options},resetRenderTargetPool:function(){var d=0;for(d=0;d<this.renderTargetPool.length;d++){this.renderTargetPool[d].dispose()}this.renderTargetPool=[]},rtpStats:{nbCreation:0},dumpPool:function(){var e="dumpPool: [";var d;for(d=0;d<this.renderTargetPool.length;d++){if(d>0){e+=", "}e+=this.renderTargetPool[d].uniqueID}e+="]";console.log(e)},buildRenderTarget:function(e,n,m,j,f,d){var o=this.rtOptionsMap[m],g;var k=null,h,l=-1;if(!d){for(h=0;h<this.renderTargetPool.length&&l<0;h++){g=this.rtOptionsMap[this.renderTargetPool[h].optionsId];if(g&&g.type===o.type&&this.renderTargetPool[h].width===e&&this.renderTargetPool[h].height===n){k=this.renderTargetPool[h];k.reset(this.rtOptionsMap[m]);l=h}else{}}if(l>=0){this.renderTargetPool.splice(l,1)}}if(!k){if(m==="cubelinear"){k=new b.WebGLRenderTargetCube(e,n,this.rtOptionsMap[m])}else{k=new b.WebGLRenderTarget(e,n,this.rtOptionsMap[m])}if(e>0&&n>0){this.rtpStats.nbCreation++}}if(f){k.shareDepthFrom=f}k.optionsId=m;return k},pushRenderTarget:function(d,e){this.renderTargetPool.push(d)}});return c});define("Visualization/RenderTargetPool",["DS/Visualization/RenderTargetPool","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/RenderTargetPool");return b});define("DS/Visualization/GeometryHelper",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],function(b,c,d){var e=document.createElement("canvas");e.width=512;e.height=64;var a=b.extend({init:function(){return this},CreateVis3DCuboid:function(E,n,g,u,C,A,l){var x,t,p,h,f,s,w,D,z,y,B,m,o,r,v,q,k;if(E instanceof c.Vector3){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");this.fill=A!==undefined?A:1;this.cornerPoint=E!==undefined?E:new c.Vector3(0,0,0);this.firstAxis=n!==undefined?n:new c.Vector3(1,0,0);this.secondAxis=g!==undefined?g:new c.Vector3(0,1,0);this.thirdAxis=u!==undefined?u:new c.Vector3(0,0,1);this.color=C!==undefined?C:new d.Color(0.5,0.5,0.5,1);k=l?l:0}else{this.fill=E.fill!==undefined?E.fill:1;this.cornerPoint=E.cornerPoint!==undefined?E.cornerPoint:new c.Vector3(0,0,0);this.firstAxis=E.firstAxis!==undefined?E.firstAxis:new c.Vector3(1,0,0);this.secondAxis=E.secondAxis!==undefined?E.secondAxis:new c.Vector3(0,1,0);this.thirdAxis=E.thirdAxis!==undefined?E.thirdAxis:new c.Vector3(0,0,1);this.color=E.color!==undefined?E.color:new d.Color(0.5,0.5,0.5,1);k=E.layerNb?E.layerNb:0}x=new d.PrimitiveGroup();x.fillAttr=new d.FillAttributes();x.lineAttr=new d.LineAttributes();x.pointAttr=new d.PointAttributes();t=new d.Buffer();t.size=24;t.component=d.VertexComponentEnum.POSITION;t.format=d.DataTypeEnum.FLOAT;t.dimension=3;t.data=new Float32Array(24);p=new d.Buffer();p.size=18;p.component=d.VertexComponentEnum.NORMAL;p.format=d.DataTypeEnum.FLOAT;p.dimension=3;p.data=new Float32Array(18);h=new d.Buffer();h.size=12;h.component=d.VertexComponentEnum.TEX_COORD_0;h.format=d.DataTypeEnum.FLOAT;h.dimension=3;h.data=new Float32Array(12);f=new d.Buffer();f.indexBuffer=true;f.size=24;f.format=d.DataTypeEnum.UINT;f.dimension=1;f.data=new Uint16Array(24);s=new d.Buffer();s.indexBuffer=true;s.size=24;s.format=d.DataTypeEnum.UINT;s.dimension=1;s.data=new Uint16Array(24);w=new d.Buffer();w.indexBuffer=true;w.size=24;w.format=d.DataTypeEnum.UINT;w.dimension=1;w.data=new Uint16Array(24);x.addBuffer(0,t);x.addBuffer(1,p);x.addBuffer(2,h);x.addBuffer(3,f);x.addBuffer(4,s);x.addBuffer(5,w);D=t.data;z=0;B=new c.Vector3();B.addVectors(this.cornerPoint,this.thirdAxis);D[z++]=B.x;D[z++]=B.y;D[z++]=B.z;B.add(this.firstAxis);D[z++]=B.x;D[z++]=B.y;D[z++]=B.z;B.add(this.secondAxis);D[z++]=B.x;D[z++]=B.y;D[z++]=B.z;B.addVectors(this.cornerPoint,this.thirdAxis);B.add(this.secondAxis);D[z++]=B.x;D[z++]=B.y;D[z++]=B.z;B.addVectors(this.cornerPoint,this.secondAxis);D[z++]=B.x;D[z++]=B.y;D[z++]=B.z;B.add(this.firstAxis);D[z++]=B.x;D[z++]=B.y;D[z++]=B.z;B.addVectors(this.cornerPoint,this.firstAxis);D[z++]=B.x;D[z++]=B.y;D[z++]=B.z;D[z++]=this.cornerPoint.x;D[z++]=this.cornerPoint.y;D[z++]=this.cornerPoint.z;if(this.fill){D=f.data;z=0;y=0;D[z++]=0;D[z++]=1;D[z++]=3;D[z++]=2;D[z++]=4;D[z++]=5;D[z++]=7;D[z++]=6;D[z++]=0;D[z++]=3;D[z++]=7;D[z++]=4;D[z++]=6;D[z++]=5;D[z++]=1;D[z++]=2;D[z++]=5;D[z++]=4;D[z++]=2;D[z++]=3;D[z++]=7;D[z++]=6;D[z++]=0;D[z++]=1;D=s.data;z=0;for(y=0;y<6;y++){D[z++]=y;D[z++]=y;D[z++]=y;D[z++]=y}D=w.data;z=0;for(y=0;y<6;y++){D[z++]=2;D[z++]=3;D[z++]=0;D[z++]=1;D[z++]=1;D[z++]=0;D[z++]=3;D[z++]=2;D[z++]=3;D[z++]=1;D[z++]=2;D[z++]=0;D[z++]=3;D[z++]=1;D[z++]=2;D[z++]=0;D[z++]=1;D[z++]=0;D[z++]=3;D[z++]=2;D[z++]=2;D[z++]=3;D[z++]=0;D[z++]=1}D=p.data;z=0;D[z++]=0;D[z++]=0;D[z++]=1;D[z++]=0;D[z++]=0;D[z++]=-1;D[z++]=-1;D[z++]=0;D[z++]=0;D[z++]=1;D[z++]=0;D[z++]=0;D[z++]=0;D[z++]=1;D[z++]=0;D[z++]=0;D[z++]=-1;D[z++]=0;D=h.data;z=0;D[z++]=0;D[z++]=0;D[z++]=0;D[z++]=1;D[z++]=0;D[z++]=0;D[z++]=0;D[z++]=1;D[z++]=0;D[z++]=1;D[z++]=1;D[z++]=0}else{D=f.data;z=0;y=0;D[z++]=0;D[z++]=3;D[z++]=3;D[z++]=2;D[z++]=2;D[z++]=1;D[z++]=1;D[z++]=0;D[z++]=7;D[z++]=4;D[z++]=4;D[z++]=5;D[z++]=5;D[z++]=6;D[z++]=6;D[z++]=7;D[z++]=0;D[z++]=7;D[z++]=3;D[z++]=4;D[z++]=2;D[z++]=5;D[z++]=1;D[z++]=6}for(y=0;y<6;y++){o=new d.Primitive();o.nbIndices=4;o.connectivity=this.fill?d.ConnectivityTypeEnum.TRIANGLE_STRIP:d.ConnectivityTypeEnum.LINES;o.attr={fill:new d.FillAttributes(this.color,1),line:new d.LineAttributes(),point:new d.PointAttributes()};r=new d.VertexComponent();r.component=d.VertexComponentEnum.POSITION;r.nbVertices=4;r.nbValuesPerVertex=3;r.format=d.DataTypeEnum.FLOAT;r.cardinality=0;r.bufferId=0;r.indices=new d.IndexArray();r.indices.format=d.DataTypeEnum.UINT;r.indices.bufferId=3;r.indices.offset=4*y;o.addVertexComponent(r);if(this.fill){v=new d.VertexComponent();v.component=d.VertexComponentEnum.NORMAL;v.nbVertices=4;v.nbValuesPerVertex=3;v.format=d.DataTypeEnum.FLOAT;v.cardinality=0;v.bufferId=1;v.indices=new d.IndexArray();v.indices.format=d.DataTypeEnum.UINT;v.indices.bufferId=4;v.indices.offset=4*y;q=new d.VertexComponent();q.component=d.VertexComponentEnum.TEX_COORD_0;q.nbVertices=4;q.nbValuesPerVertex=3;q.format=d.DataTypeEnum.FLOAT;q.cardinality=0;q.bufferId=2;q.indices=new d.IndexArray();q.indices.format=d.DataTypeEnum.UINT;q.indices.bufferId=5;q.indices.offset=4*y;o.addVertexComponent(v);o.addVertexComponent(q)}x.addPrimitive(o)}x.noz=k>0;return x},CreateVis3DSphere:function(g,A,I,h,C,D,L,x,l){var w,X,m,E,s,H,p,O,J,V,Q,y,B,G,q,t,z,R,U,T,P,r,K,M,Z,o,Y,N,n,W;var f=false;if(g instanceof c.Matrix4||g===undefined){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");this.matrix=g!==undefined?g:null;this.radius=A!==undefined?A:1;this.meridianStart=I!==undefined?I:0;this.meridianEnd=h!==undefined?h:Math.PI*2;this.parallelStart=C!==undefined?C:0;this.parallelEnd=D!==undefined?D:Math.PI*2;this.sag=L!==undefined?L:80;Z=(x!==undefined)?x:new d.Color(0.5,0.5,0.5,1);W=l?l:0}else{this.matrix=g.matrix!==undefined?g.matrix:null;this.radius=g.radius!==undefined?g.radius:1;this.meridianStart=g.meridianStart!==undefined?g.meridianStart:0;this.meridianEnd=g.meridianEnd!==undefined?g.meridianEnd:Math.PI*2;this.parallelStart=g.parallelStart!==undefined?g.parallelStart:0;this.parallelEnd=g.parallelEnd!==undefined?g.parallelEnd:Math.PI*2;this.sag=g.sag!==undefined?g.sag:80;Z=(g.color!==undefined)?g.color:new d.Color(0.5,0.5,0.5,1);W=g.layerNb?g.layerNb:0;f=g.tgtBinorm?g.tgtBinorm:false}if(this.parallelStart<0){this.parallelStart=0}if(this.parallelStart>Math.PI){this.parallelStart=Math.PI}w=this.parallelEnd-this.parallelStart;if(w<0){w=0}if(this.parallelStart+w>Math.PI){w=Math.PI-this.parallelStart}if(this.meridianStart<0){this.meridianStart=0}if(this.meridianStart>2*Math.PI){this.meridianStart=2*Math.PI}X=this.meridianEnd-this.meridianStart;if(X<0){X=0}if(this.meridianStart+X>2*Math.PI){X=2*Math.PI-this.meridianStart}m=3*(this.sag+1)*this.sag;E=6*this.sag*(this.sag-1);s=new d.PrimitiveGroup();s.fillAttr=new d.FillAttributes();s.lineAttr=new d.LineAttributes();s.pointAttr=new d.PointAttributes();H=new d.Buffer();H.size=3*m;H.component=d.VertexComponentEnum.POSITION;H.format=d.DataTypeEnum.FLOAT;H.dimension=3;H.data=new Float32Array(H.size);p=new d.Buffer();p.size=3*m;p.component=d.VertexComponentEnum.NORMAL;p.format=d.DataTypeEnum.FLOAT;p.dimension=3;p.data=new Float32Array(p.size);O=new d.Buffer();O.size=3*m;O.component=d.VertexComponentEnum.TEX_COORD_0;O.format=d.DataTypeEnum.FLOAT;O.dimension=3;O.data=new Float32Array(O.size);if(f){J=new d.Buffer();J.size=3*m;J.component=d.VertexComponentEnum.TEX_COORD_2;J.format=d.DataTypeEnum.FLOAT;J.dimension=3;J.data=new Float32Array(J.size);V=new d.Buffer();V.size=3*m;V.component=d.VertexComponentEnum.TEX_COORD_3;V.format=d.DataTypeEnum.FLOAT;V.dimension=3;V.data=new Float32Array(V.size);s.addBuffer(5,J);s.addBuffer(6,V)}Q=new d.Buffer();Q.indexBuffer=true;Q.size=E;Q.format=d.DataTypeEnum.UINT;Q.dimension=1;Q.data=new Uint16Array(Q.size);s.addBuffer(0,H);s.addBuffer(1,p);s.addBuffer(2,O);s.addBuffer(3,Q);B=Q.data;R=0;for(U=0;U<this.sag-1;U++){for(T=0;T<this.sag;T++){B[R++]=U*(this.sag+1)+T;B[R++]=(U+1)*(this.sag+1)+T;B[R++]=(U+1)*(this.sag+1)+T+1;B[R++]=U*(this.sag+1)+T;B[R++]=(U+1)*(this.sag+1)+T+1;B[R++]=U*(this.sag+1)+T+1}}B=H.data;G=p.data;q=O.data;if(f){t=J.data;z=V.data}R=0;P=1/(this.sag-1);r=new c.Vector3();for(U=0;U<this.sag;U++){K=U*P;for(T=0;T<=this.sag;T++,R+=3){M=T/this.sag;G[R]=Math.sin(this.parallelStart+K*w)*Math.cos(this.meridianStart+M*X);r.x=this.radius*G[R];q[R]=T/this.sag;G[R+1]=Math.sin(this.parallelStart+K*w)*Math.sin(this.meridianStart+M*X);r.y=this.radius*G[R+1];q[R+1]=U/this.sag;G[R+2]=Math.cos(this.parallelStart+K*w);r.z=this.radius*G[R+2];q[R+2]=0;if(f){t[R]=G[R+1];t[R+1]=-G[R];t[R+2]=0;z[R]=G[R]*G[R+2];z[R+1]=G[R+1]*G[R+2];z[R+2]=-G[R]*G[R]-G[R+1]*G[R+1]}if(this.matrix){r.applyMatrix4(this.matrix)}B[R]=r.x;B[R+1]=r.y;B[R+2]=r.z}}o=new d.Primitive();o.nbIndices=E;o.connectivity=d.ConnectivityTypeEnum.TRIANGLES;o.attr={fill:new d.FillAttributes(Z,1),line:new d.LineAttributes(),point:new d.PointAttributes()};Y=new d.VertexComponent();Y.component=d.VertexComponentEnum.POSITION;Y.nbVertices=m;Y.nbValuesPerVertex=3;Y.format=d.DataTypeEnum.FLOAT;Y.cardinality=0;Y.bufferId=0;Y.indices=new d.IndexArray();Y.indices.format=d.DataTypeEnum.UINT;Y.indices.bufferId=3;Y.indices.offset=0;N=new d.VertexComponent();N.component=d.VertexComponentEnum.NORMAL;N.nbVertices=m;N.nbValuesPerVertex=3;N.format=d.DataTypeEnum.FLOAT;N.cardinality=0;N.bufferId=1;N.indices=new d.IndexArray();N.indices.format=d.DataTypeEnum.UINT;N.indices.bufferId=3;N.indices.offset=0;n=new d.VertexComponent();n.component=d.VertexComponentEnum.TEX_COORD_0;n.nbVertices=m;n.nbValuesPerVertex=3;n.format=d.DataTypeEnum.FLOAT;n.cardinality=0;n.bufferId=2;n.indices=new d.IndexArray();n.indices.format=d.DataTypeEnum.UINT;n.indices.bufferId=3;n.indices.offset=0;o.addVertexComponent(Y);o.addVertexComponent(N);o.addVertexComponent(n);if(f){var F=new d.VertexComponent();F.component=d.VertexComponentEnum.TEX_COORD_2;F.nbVertices=m;F.nbValuesPerVertex=3;F.format=d.DataTypeEnum.FLOAT;F.cardinality=0;F.bufferId=5;F.indices=new d.IndexArray();F.indices.format=d.DataTypeEnum.UINT;F.indices.bufferId=3;F.indices.offset=0;var S=new d.VertexComponent();S.component=d.VertexComponentEnum.TEX_COORD_3;S.nbVertices=m;S.nbValuesPerVertex=3;S.format=d.DataTypeEnum.FLOAT;S.cardinality=0;S.bufferId=6;S.indices=new d.IndexArray();S.indices.format=d.DataTypeEnum.UINT;S.indices.bufferId=3;S.indices.offset=0;o.addVertexComponent(F);o.addVertexComponent(S)}s.addPrimitive(o);s.noz=W>0;return s},CreateVis3DTube:function(g,A,L,Q,F,w,m){var D,v,h,T,E,W,n,l,B,u,f,C,r,I,M,x,y,J,O,t,z,o,G,N,p,s,V,k,U,H,q,K,S,P;if(g instanceof c.Vector3){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");D=g;v=new c.Vector3(0,0,0);v.addVectors(g,A);h=Q?Q:1;T=L?L:1;V=(w!==undefined)?w:new d.Color(0.2,0.8,0.2,1);S=m?m:0;P=F}else{D=g.bottomCenterPoint;v=new c.Vector3(0,0,0);v.addVectors(g.bottomCenterPoint,g.extrusionVector);h=g.externalRadius?g.externalRadius:1;T=g.internalRadius?g.internalRadius:1;P=g.sag?g.sag:0;V=(g.color!==undefined)?g.color:new d.Color(0.2,0.8,0.2,1);S=g.layerNb?g.layerNb:0}if(T===h){return this.CreateVis3DCylinderCustom({bottomCenterPoint:D,topCenterPoint:v,bottomRadius:h,topRadius:h,sag:P,bottomCap:false,topCap:false,internal:false,layerNb:S})}E=this.CreateVis3DCylinderCustom({bottomCenterPoint:D,topCenterPoint:v,bottomRadius:h,topRadius:h,sag:P,bottomCap:false,topCap:false,internal:false,layerNb:S});W=this.CreateVis3DCylinderCustom({bottomCenterPoint:D,topCenterPoint:v,bottomRadius:T,topRadius:T,sag:P,bottomCap:false,topCap:false,internal:true,layerNb:S});n=(P+1)*3*8;l=(P+1)*3*8;B=24*P;u=T/h;f=new d.PrimitiveGroup();f.fillAttr=new d.FillAttributes();f.lineAttr=new d.LineAttributes();f.pointAttr=new d.PointAttributes();C=new d.Buffer();C.size=n;C.component=d.VertexComponentEnum.POSITION;C.format=d.DataTypeEnum.FLOAT;C.dimension=3;C.data=new Float32Array(C.size);r=new d.Buffer();r.size=l;r.component=d.VertexComponentEnum.NORMAL;r.format=d.DataTypeEnum.FLOAT;r.dimension=3;r.data=new Float32Array(r.size);I=new d.Buffer();I.size=n;I.component=d.VertexComponentEnum.TEX_COORD_0;I.format=d.DataTypeEnum.FLOAT;I.dimension=3;I.data=new Float32Array(I.size);M=new d.Buffer();M.indexBuffer=true;M.size=B;M.format=d.DataTypeEnum.UINT;M.dimension=1;M.data=new Uint16Array(M.size);C.data.set(E.buffers[0].data.subarray(0,2*3*(P+1)),0);C.data.set(W.buffers[0].data.subarray(0,2*3*(P+1)),2*3*(P+1));C.data.set(E.buffers[0].data.subarray(0,3*(P+1)),4*3*(P+1));C.data.set(W.buffers[0].data.subarray(0,3*(P+1)),5*3*(P+1));C.data.set(E.buffers[0].data.subarray(3*(P+1),6*(P+1)),6*3*(P+1));C.data.set(W.buffers[0].data.subarray(3*(P+1),6*(P+1)),7*3*(P+1));I.data.set(E.buffers[2].data.subarray(0,2*3*(P+1)),0);I.data.set(W.buffers[2].data.subarray(0,2*3*(P+1)),2*3*(P+1));I.data.set(E.buffers[2].data.subarray(0,3*(P+1)),4*3*(P+1));I.data.set(W.buffers[2].data.subarray(0,3*(P+1)),5*3*(P+1));I.data.set(E.buffers[2].data.subarray(3*(P+1),6*(P+1)),6*3*(P+1));I.data.set(W.buffers[2].data.subarray(3*(P+1),6*(P+1)),7*3*(P+1));r.data.set(E.buffers[1].data.subarray(0,(P+1)*3*2),0);r.data.set(W.buffers[1].data.subarray(0,(P+1)*3*2),(P+1)*3*2);y=(P+1)*3*4;for(var R=0;R<2*(P+1);R++){r.data[y++]=0;r.data[y++]=0;r.data[y++]=-1}for(var R=0;R<2*(P+1);R++){r.data[y++]=0;r.data[y++]=0;r.data[y++]=1}M.data.set(E.buffers[3].data,0);t=E.buffers[3].size;z=E.buffers[0].size/3;o=E.buffers[1].size/3;for(O=0;O<t;O++){M.data[O+t]=W.buffers[3].data[O]+z}y=E.buffers[3].size+W.buffers[3].size;z*=2;G=(E.buffers[1].size+W.buffers[1].size)/3;for(N=0;N<P;++N){p=N+1;M.data[y++]=N+z;M.data[y++]=P+1+N+z;M.data[y++]=p+z;M.data[y++]=P+1+N+z;M.data[y++]=P+1+p+z;M.data[y++]=p+z}G+=1;z+=((P+1)*2);for(N=0;N<P;++N){p=N+1;M.data[y++]=P+1+N+z;M.data[y++]=N+z;M.data[y++]=p+z;M.data[y++]=p+z;M.data[y++]=P+1+p+z;M.data[y++]=P+1+N+z}f.addBuffer(0,C);f.addBuffer(1,r);f.addBuffer(2,I);f.addBuffer(3,M);f.addPrimitive(E.primitives[0]);f.addPrimitive(W.primitives[0]);s=W.primitives[0].vertexComponents;for(O=0;O<s.length;O++){s[O].indices.offset+=t}k=new d.Primitive();k.nbIndices=6*this.sag;k.connectivity=d.ConnectivityTypeEnum.TRIANGLES;k.attr={fill:new d.FillAttributes(V,1),line:new d.LineAttributes(),point:new d.PointAttributes()};U=new d.VertexComponent();U.component=d.VertexComponentEnum.POSITION;U.nbVertices=(this.sag+1)*2;U.nbValuesPerVertex=3;U.format=d.DataTypeEnum.FLOAT;U.cardinality=0;U.bufferId=0;U.indices=new d.IndexArray();U.indices.format=d.DataTypeEnum.UINT;U.indices.bufferId=3;U.indices.offset=E.buffers[3].size+W.buffers[3].size;H=new d.VertexComponent();H.component=d.VertexComponentEnum.NORMAL;H.nbVertices=(this.sag+1)*2;H.nbValuesPerVertex=3;H.format=d.DataTypeEnum.FLOAT;H.cardinality=0;H.bufferId=1;H.indices=new d.IndexArray();H.indices.format=d.DataTypeEnum.UINT;H.indices.bufferId=3;H.indices.offset=E.buffers[3].size+W.buffers[3].size;q=new d.VertexComponent();q.component=d.VertexComponentEnum.TEX_COORD_0;q.nbVertices=(this.sag+1)*2;q.nbValuesPerVertex=3;q.format=d.DataTypeEnum.FLOAT;q.cardinality=0;q.bufferId=2;q.indices=new d.IndexArray();q.indices.format=d.DataTypeEnum.UINT;q.indices.bufferId=3;q.indices.offset=E.buffers[3].size+W.buffers[3].size;k.addVertexComponent(U);k.addVertexComponent(H);k.addVertexComponent(q);f.addPrimitive(k);K=new d.Primitive();K.nbIndices=6*this.sag;K.connectivity=d.ConnectivityTypeEnum.TRIANGLES;K.attr={fill:new d.FillAttributes(V,1),line:new d.LineAttributes(),point:new d.PointAttributes()};U=new d.VertexComponent();U.component=d.VertexComponentEnum.POSITION;U.nbVertices=(this.sag+1)*2;U.nbValuesPerVertex=3;U.format=d.DataTypeEnum.FLOAT;U.cardinality=0;U.bufferId=0;U.indices=new d.IndexArray();U.indices.format=d.DataTypeEnum.UINT;U.indices.bufferId=3;U.indices.offset=E.buffers[3].size+W.buffers[3].size+(P*6);H=new d.VertexComponent();H.component=d.VertexComponentEnum.NORMAL;H.nbVertices=(this.sag+1)*2;H.nbValuesPerVertex=3;H.format=d.DataTypeEnum.FLOAT;H.cardinality=0;H.bufferId=1;H.indices=new d.IndexArray();H.indices.format=d.DataTypeEnum.UINT;H.indices.bufferId=3;H.indices.offset=E.buffers[3].size+W.buffers[3].size+(P*6);q=new d.VertexComponent();q.component=d.VertexComponentEnum.TEX_COORD_0;q.nbVertices=(this.sag+1)*2;q.nbValuesPerVertex=3;q.format=d.DataTypeEnum.FLOAT;q.cardinality=0;q.bufferId=2;q.indices=new d.IndexArray();q.indices.format=d.DataTypeEnum.UINT;q.indices.bufferId=3;q.indices.offset=E.buffers[3].size+W.buffers[3].size+(P*6);K.addVertexComponent(U);K.addVertexComponent(H);K.addVertexComponent(q);f.addPrimitive(K);f.noz=S>0;return f},CreateVis3DCylinder:function(l,h,k,j,f){var g;if(l instanceof c.Vector3){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");g={bottomCenterPoint:l,topCenterPoint:h,bottomRadius:k,topRadius:k,sag:j,bottomCap:true,topCap:true,internal:false,layerNb:f}}else{g={bottomCenterPoint:l.bottomCenterPoint,topCenterPoint:l.topCenterPoint,bottomRadius:l.radius,topRadius:l.radius,sag:l.sag,bottomCap:true,topCap:true,internal:false,color:l.color,layerNb:l.layerNb}}return this.CreateVis3DCylinderCustom(g)},CreateVis3DCone:function(m,h,n,l,k,j,f){var g;if(m instanceof c.Vector3){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");g={bottomCenterPoint:m,topCenterPoint:h,bottomRadius:n!==undefined?n:1,topRadius:l!==undefined?l:1,sag:k,bottomCap:true,topCap:true,internal:false,color:(j!==undefined)?j:new d.Color(0.2,0.8,0.2,1),layerNb:f||0}}else{g={bottomCenterPoint:m.bottomCenterPoint,topCenterPoint:m.topCenterPoint,bottomRadius:m.bottomRadius!==undefined?m.bottomRadius:1,topRadius:m.topRadius!==undefined?m.topRadius:1,sag:m.sag,bottomCap:true,topCap:true,internal:false,color:(m.color!==undefined)?m.color:new d.Color(0.2,0.8,0.2,1),layerNb:m.layerNb||0}}if(g.topRadius<=0){g.topCap=false}if(g.bottomRadius<=0){g.bottomCap=false}return this.CreateVis3DCylinderCustom(g)},CreateVis3DCylinderCustom:function(n,D,F,ai,ab,t,r,w,M,q){var am,I,aw,Q,C,g,S,ah,K,Y,o,x,T,s,p,L,X,B,af,ak,N,P,V,aj,ap,ao,R,z,an,W,y,v,ag,H,al,ac,ae,aq,G,U,J,av,E,au,ad,A,Z,aa,l,at,O;if(n instanceof c.Vector3){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");this.bottomCenterPoint=n!==undefined?n:new c.Vector3(0,0,0);this.topCenterPoint=D!==undefined?D:new c.Vector3(0,5,0);this.bottomRadius=F!==undefined?F:1;this.topRadius=ai!==undefined?ai:1;this.sag=ab!==undefined?ab:80;am=r!==undefined?r:true;I=t!==undefined?t:true;aw=w!==undefined?w:false;at=q?q:0;av=M?M:new d.Color(0.2,0.8,0.2,1)}else{this.bottomCenterPoint=n.bottomCenterPoint!==undefined?n.bottomCenterPoint:new c.Vector3(0,0,0);this.topCenterPoint=n.topCenterPoint!==undefined?n.topCenterPoint:new c.Vector3(0,5,0);this.bottomRadius=n.bottomRadius!==undefined?n.bottomRadius:1;this.topRadius=n.topRadius!==undefined?n.topRadius:1;this.sag=n.sag!==undefined?n.sag:80;am=n.topCap!==undefined?n.topCap:true;I=n.bottomCap!==undefined?n.bottomCap:true;aw=n.internal!==undefined?n.internal:false;at=n.layerNb?n.layerNb:0;av=n.color?n.color:new d.Color(0.2,0.8,0.2,1)}Q=new c.Vector4(0,0,0,0);Q.subVectors(this.topCenterPoint,this.bottomCenterPoint);Q.w=0;Q.normalize();C=new c.Matrix4();if(Q.x===0&&Q.y===0){C.identity()}else{C.set(Q.x/Math.sqrt(Q.x*Q.x+Q.y*Q.y),Q.y/Math.sqrt(Q.x*Q.x+Q.y*Q.y),0,0,-Q.y/Math.sqrt(Q.x*Q.x+Q.y*Q.y),Q.x/Math.sqrt(Q.x*Q.x+Q.y*Q.y),0,0,0,0,1,0,0,0,0,1)}g=new c.Matrix4();if(Q.x===0&&Q.y===0&&Q.z===0){g.identity()}else{g.set(Q.z/Math.sqrt(Q.x*Q.x+Q.y*Q.y+Q.z*Q.z),0,-Math.sqrt(Q.x*Q.x+Q.y*Q.y)/Math.sqrt(Q.x*Q.x+Q.y*Q.y+Q.z*Q.z),0,0,1,0,0,Math.sqrt(Q.x*Q.x+Q.y*Q.y)/Math.sqrt(Q.x*Q.x+Q.y*Q.y+Q.z*Q.z),0,Q.z/Math.sqrt(Q.x*Q.x+Q.y*Q.y+Q.z*Q.z),0,0,0,0,1)}S=new c.Matrix4();S.multiplyMatrices(g,C);S.transpose();K=S.clone();Y=new c.Vector3(this.bottomCenterPoint.x,this.bottomCenterPoint.y,this.bottomCenterPoint.z);ah=S.clone();S.elements[12]=Y.x;S.elements[13]=Y.y;S.elements[14]=Y.z;o=Math.sqrt((this.bottomCenterPoint.x-this.topCenterPoint.x)*(this.bottomCenterPoint.x-this.topCenterPoint.x)+(this.bottomCenterPoint.y-this.topCenterPoint.y)*(this.bottomCenterPoint.y-this.topCenterPoint.y)+(this.bottomCenterPoint.z-this.topCenterPoint.z)*(this.bottomCenterPoint.z-this.topCenterPoint.z));x=(this.bottomRadius-this.topRadius)/o;T=6*this.sag;s=2*(this.sag+1);p=2*(this.sag+1);var f=s;if(am){T+=3*(this.sag-2);f+=this.sag;p+=this.sag;s+=this.sag}if(I){T+=3*(this.sag-2);f+=this.sag;p+=this.sag;s+=this.sag}L=new d.PrimitiveGroup();L.fillAttr=new d.FillAttributes();L.lineAttr=new d.LineAttributes();L.pointAttr=new d.PointAttributes();X=new d.Buffer();X.size=3*s;X.component=d.VertexComponentEnum.POSITION;X.format=d.DataTypeEnum.FLOAT;X.dimension=3;X.data=new Float32Array(X.size);B=new d.Buffer();B.size=3*p;B.component=d.VertexComponentEnum.NORMAL;B.format=d.DataTypeEnum.FLOAT;B.dimension=3;B.data=new Float32Array(B.size);af=new d.Buffer();af.size=3*f;af.component=d.VertexComponentEnum.TEX_COORD_0;af.format=d.DataTypeEnum.FLOAT;af.dimension=3;af.data=new Float32Array(af.size);ak=new d.Buffer();ak.indexBuffer=true;ak.size=T;ak.format=d.DataTypeEnum.UINT;ak.dimension=1;ak.data=new Uint16Array(ak.size);L.addBuffer(0,X);L.addBuffer(1,B);L.addBuffer(2,af);L.addBuffer(3,ak);P=ak.data;aj=0;if(aw){for(ao=0;ao<this.sag;++ao){z=ao+1;P[aj++]=z;P[aj++]=ao;P[aj++]=this.sag+1+ao;P[aj++]=z;P[aj++]=this.sag+1+ao;P[aj++]=this.sag+1+z}}else{for(ao=0;ao<this.sag;++ao){z=ao+1;P[aj++]=ao;P[aj++]=z;P[aj++]=this.sag+1+ao;P[aj++]=this.sag+1+ao;P[aj++]=z;P[aj++]=this.sag+1+z}}if(am){for(ao=0;ao<this.sag-2;ao++){P[aj++]=2*this.sag+2;P[aj++]=2*this.sag+2+ao+1;P[aj++]=2*this.sag+2+ao+2}}if(I){if(am){for(ao=0;ao<this.sag-2;ao++){P[aj++]=3*this.sag+2;P[aj++]=3*this.sag+2+ao+1;P[aj++]=3*this.sag+2+ao+2}}else{for(ao=0;ao<this.sag-2;ao++){P[aj++]=2*this.sag+2;P[aj++]=2*this.sag+2+ao+1;P[aj++]=2*this.sag+2+ao+2}}}ag=X.data;H=af.data;var al=0;for(ao=0;ao<this.sag+1;ao++,al+=3){G=(ao/this.sag)*2*Math.PI;ag[al]=this.bottomRadius*Math.cos(G);ag[al+1]=this.bottomRadius*Math.sin(G);ag[al+2]=0;H[al]=ao/this.sag;H[al+1]=1;H[al+2]=0}al=3*(this.sag+1);for(ao=0;ao<this.sag+1;ao++,al+=3){G=(ao/this.sag)*2*Math.PI;ag[al]=this.topRadius*Math.cos(G);ag[al+1]=this.topRadius*Math.sin(G);ag[al+2]=o;H[al]=ao/this.sag;H[al+1]=0;H[al+2]=0}if(am){G=0;for(ap=0;ap<this.sag;ap++){G=(ap/this.sag)*2*Math.PI;ag[al]=ag[3*(this.sag+ap+1)];H[al++]=(Math.cos(G)+1)/2;ag[al]=ag[3*(this.sag+ap+1)+1];H[al++]=1-(Math.sin(G)+1)/2;ag[al]=ag[3*(this.sag+ap+1)+2];H[al++]=0}}if(I){G=0;for(ap=0;ap<this.sag;ap++){G=(ap/this.sag)*2*Math.PI;ag[al]=ag[3*(this.sag-1-ap)];H[al++]=(Math.cos(G)+1)/2;ag[al]=ag[3*(this.sag-1-ap)+1];H[al++]=1-(Math.sin(G)+1)/2;ag[al]=ag[3*(this.sag-1-ap)+2];H[al++]=0}}ag=B.data;al=0;for(var ar=0;ar<2;ar++){for(ao=0;ao<this.sag+1;ao++){G=(ao/this.sag)*2*Math.PI;J=new c.Vector3();J.x=X.data[ao*3];J.y=X.data[ao*3+1];J.z=X.data[ao*3+2];J.z=Math.sqrt(J.x*J.x+J.y*J.y)*x;J.normalize();if(aw){ag[al++]=-J.x;ag[al++]=-J.y;ag[al++]=-J.z}else{ag[al++]=J.x;ag[al++]=J.y;ag[al++]=J.z}}}if(am){for(var ar=0;ar<this.sag;ar++){ag[al++]=0;ag[al++]=0;ag[al++]=1}}if(I){for(var ar=0;ar<this.sag;ar++){ag[al++]=0;ag[al++]=0;ag[al++]=-1}}for(ap=0;ap<s;ap++){J=new c.Vector3();J.x=X.data[ap*3];J.y=X.data[ap*3+1];J.z=X.data[ap*3+2];J.applyMatrix4(S);X.data[ap*3]=J.x;X.data[ap*3+1]=J.y;X.data[ap*3+2]=J.z}for(ap=0;ap<p;ap++){J=new c.Vector3();J.x=B.data[ap*3];J.y=B.data[ap*3+1];J.z=B.data[ap*3+2];J.applyMatrix4(ah);B.data[ap*3]=J.x;B.data[ap*3+1]=J.y;B.data[ap*3+2]=J.z}E=new d.Primitive();E.nbIndices=6*this.sag;E.connectivity=d.ConnectivityTypeEnum.TRIANGLES;E.attr={fill:new d.FillAttributes(av,1),line:new d.LineAttributes(),point:new d.PointAttributes()};au=new d.VertexComponent();au.component=d.VertexComponentEnum.POSITION;au.nbVertices=2*this.sag;au.nbValuesPerVertex=3;au.format=d.DataTypeEnum.FLOAT;au.cardinality=0;au.bufferId=0;au.indices=new d.IndexArray();au.indices.format=d.DataTypeEnum.UINT;au.indices.bufferId=3;au.indices.offset=0;ad=new d.VertexComponent();ad.component=d.VertexComponentEnum.NORMAL;ad.nbVertices=2*this.sag;ad.nbValuesPerVertex=3;ad.format=d.DataTypeEnum.FLOAT;ad.cardinality=0;ad.bufferId=1;ad.indices=new d.IndexArray();ad.indices.format=d.DataTypeEnum.UINT;ad.indices.bufferId=3;ad.indices.offset=0;A=new d.VertexComponent();A.component=d.VertexComponentEnum.TEX_COORD_0;A.nbVertices=2*this.sag;A.nbValuesPerVertex=3;A.format=d.DataTypeEnum.FLOAT;A.cardinality=0;A.bufferId=2;A.indices=new d.IndexArray();A.indices.format=d.DataTypeEnum.UINT;A.indices.bufferId=3;A.indices.offset=0;E.addVertexComponent(au);E.addVertexComponent(ad);E.addVertexComponent(A);L.addPrimitive(E);if(am){Z=new d.Primitive();Z.nbIndices=3*(this.sag-2);Z.connectivity=d.ConnectivityTypeEnum.TRIANGLES;Z.attr={fill:new d.FillAttributes(av,1),line:new d.LineAttributes(),point:new d.PointAttributes()};au=new d.VertexComponent();au.component=d.VertexComponentEnum.POSITION;au.nbVertices=this.sag;au.nbValuesPerVertex=3;au.format=d.DataTypeEnum.FLOAT;au.cardinality=0;au.bufferId=0;au.indices=new d.IndexArray();au.indices.format=d.DataTypeEnum.UINT;au.indices.bufferId=3;au.indices.offset=6*this.sag;ad=new d.VertexComponent();ad.component=d.VertexComponentEnum.NORMAL;ad.nbVertices=this.sag;ad.nbValuesPerVertex=3;ad.format=d.DataTypeEnum.FLOAT;ad.cardinality=0;ad.bufferId=1;ad.indices=new d.IndexArray();ad.indices.format=d.DataTypeEnum.UINT;ad.indices.bufferId=3;ad.indices.offset=6*this.sag;A=new d.VertexComponent();A.component=d.VertexComponentEnum.TEX_COORD_0;A.nbVertices=this.sag;A.nbValuesPerVertex=3;A.format=d.DataTypeEnum.FLOAT;A.cardinality=0;A.bufferId=2;A.offset=2*(this.sag+1);Z.addVertexComponent(au);Z.addVertexComponent(ad);Z.addVertexComponent(A);L.addPrimitive(Z)}if(I){aa=6*this.sag;if(am){aa+=3*(this.sag-2)}l=new d.Primitive();l.nbIndices=3*(this.sag-2);l.connectivity=d.ConnectivityTypeEnum.TRIANGLES;l.attr={fill:new d.FillAttributes(av,1),line:new d.LineAttributes(),point:new d.PointAttributes()};au=new d.VertexComponent();au.component=d.VertexComponentEnum.POSITION;au.nbVertices=this.sag;au.nbValuesPerVertex=3;au.format=d.DataTypeEnum.FLOAT;au.cardinality=0;au.bufferId=0;au.indices=new d.IndexArray();au.indices.format=d.DataTypeEnum.UINT;au.indices.bufferId=3;au.indices.offset=aa;ad=new d.VertexComponent();ad.component=d.VertexComponentEnum.NORMAL;ad.nbVertices=this.sag;ad.nbValuesPerVertex=3;ad.format=d.DataTypeEnum.FLOAT;ad.cardinality=0;ad.bufferId=1;ad.indices=new d.IndexArray();ad.indices.format=d.DataTypeEnum.UINT;ad.indices.bufferId=3;ad.indices.offset=aa;A=new d.VertexComponent();A.component=d.VertexComponentEnum.TEX_COORD_0;A.nbVertices=this.sag+2;A.nbValuesPerVertex=3;A.format=d.DataTypeEnum.FLOAT;A.cardinality=0;A.bufferId=2;A.offset=am?this.sag:0;A.offset+=2*(this.sag+1);l.addVertexComponent(au);l.addVertexComponent(ad);l.addVertexComponent(A);L.addPrimitive(l)}L.noz=at>0;return L},createLine:function(g,v,R,l){var H,J,Q,u,f,L,U,S,C=d.ConnectivityTypeEnum.LINE_STRIP,I=false;var m=false;var s=false;if(g instanceof Array){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");H=g;f=R;J=[];Q=[];U=(v!==undefined)?v:new d.Color(0.5,0.5,0.5,1);S=l?l:0}else{if(g instanceof Object){H=g.points;J=g.colors?g.colors:[];Q=g.idx?g.idx:[];C=g.drawMode?g.drawMode:C;I=g.editable?g.editable:false;u=g.patternOffsets?g.patternOffsets:[];if(C!==d.ConnectivityTypeEnum.LINES&&C!==d.ConnectivityTypeEnum.LINE_STRIP){console.warn("Invalid draw mode for the line, passing to strip mode");C=d.ConnectivityTypeEnum.LINE_STRIP}if(C===d.ConnectivityTypeEnum.LINES&&Q.length===0){for(var O=0;O<H.length-1;O++){Q.push(O);Q.push(O+1)}}if(g.hasOwnProperty("material")){var F=function(){if(Q.length===0){return false}if(g.material.is2DLine){return g.material.isDashedLine}var V=new Set();var Y=0;for(var W=0;W<Q.length;W++){var X=Q[W];if(V.has(X)&&X!==Y){return true}Y=X;V.add(X)}return false};f=g.material.lineWidth;m=F();U=(g.material.color!==undefined)?g.material.color:new d.Color(0.5,0.5,0.5,1);if(u.length&&u.length===Q.length){s=true}}else{f=g.width;U=(g.color!==undefined)?g.color:new d.Color(0.5,0.5,0.5,1)}S=g.layerNb?g.layerNb:0}}if(m){var r=[],t=[],y=[];for(var O=0;O<Q.length;O++){var z=Q[O];r.push(H[z]);if(J.length){t.push(J[z])}if(s){y.push(u[z])}Q[O]=O}H=r;J=t;u=y}var h=H.length;var k=J.length;var P=Q.length;if(!h){return null}var E=function(aa,X,W,Z,Y){var V=new d.Buffer();V.size=aa*X;V.component=W;V.format=Z;V.dimension=aa;V.data=new Float32Array(V.size);return V};var x=function(W){var V=new d.Buffer();V.indexBuffer=true;V.size=W;V.format=d.DataTypeEnum.UINT;V.dimension=1;if(W>65535){V.data=new Uint32Array(V.size)}else{V.data=new Uint16Array(V.size)}return V};var p=new d.PrimitiveGroup();p.fillAttr=new d.FillAttributes();p.lineAttr=new d.LineAttributes(U,f);p.pointAttr=new d.PointAttributes();var D=0;var A=E(3,h,d.VertexComponentEnum.POSITION,d.DataTypeEnum.FLOAT);var G=D++;p.addBuffer(G,A);L=A.data;for(var O=0;O<h;O++){var q=H[O];L[3*O]=q.x;L[3*O+1]=q.y;L[3*O+2]=q.z}var o=false;var j=0;if(k===h){o=E(4,k,d.VertexComponentEnum.DIFFUSE_COLOR,d.DataTypeEnum.FLOAT);j=D++;p.addBuffer(j,o);L=o.data;for(var O=0;O<k;O++){var n=J[O];L[4*O]=n.x;L[4*O+1]=n.y;L[4*O+2]=n.z;L[4*O+3]=n.w}}var K=false;var w=0;if(P){w=D++;K=x(Q.length);p.addBuffer(w,K);L=K.data;for(var O=0;O<P;O++){L[O]=Q[O]}}if(s){p.patternOffsets=u}var M=new d.Primitive();M.nbIndices=P?P:h;M.connectivity=C;M.attr={fill:new d.FillAttributes(U),line:new d.LineAttributes(U,f),point:new d.PointAttributes()};var B=function(W,aa,Z,ab,Y,V){var X=new d.VertexComponent();X.component=W.component;X.nbValuesPerVertex=W.dim;X.format=W.format;X.nbVertices=Z;X.cardinality=0;X.bufferId=aa;if(ab){X.indices=new d.IndexArray();X.indices.format=ab.format;X.indices.bufferId=Y;X.indices.offset=V}return X};var T=B(A,G,h,K,w,0);M.addVertexComponent(T);var N;if(k){N=B(o,j,k,K,w,0);M.addVertexComponent(N)}p.addPrimitive(M);p.noz=S>0;p.editable=I;return p},createRectangle:function(F,m,C,D,j,h){var G,v,p,u,f,s,y,E,B,l,r,q,n,o,x,z,w,A,t,g,H,k;if(F instanceof Object){z=F.width?F.width:1;w=F.height?F.height:1;A=F.fill?F.fill:false;l=(F.color!==undefined)?F.color:new d.Color(0.5,0.5,0.5,1);t=(F.noEdge?F.noEdge:false);g=(F.layerNb?F.layerNb:0);H=F.sharing?F.sharing:false;k=F.cornerPoint?F.cornerPoint:new c.Vector2(0,0)}else{console.warn("DEPRECATED: Please use a litteral object to define your primitive.");z=F?F:1;w=m?m:1;A=C?C:false;l=(D!==undefined)?D:new d.Color(0.5,0.5,0.5,1);t=(j?j:false);g=(h?h:0);k=new c.Vector2(0,0);H=false}G=new d.PrimitiveGroup();G.sharing=H;G.fillAttr=new d.FillAttributes();G.lineAttr=new d.LineAttributes();G.pointAttr=new d.PointAttributes();v=new d.Buffer();v.size=15;v.component=d.VertexComponentEnum.POSITION;v.format=d.DataTypeEnum.FLOAT;v.dimension=3;v.data=new Float32Array(v.size);p=new d.Buffer();p.size=3;p.component=d.VertexComponentEnum.NORMAL;p.format=d.DataTypeEnum.FLOAT;p.dimension=3;p.data=new Float32Array(p.size);u=new d.Buffer();u.size=12;u.component=d.VertexComponentEnum.TEX_COORD_0;u.format=d.DataTypeEnum.FLOAT;u.dimension=3;u.data=new Float32Array(u.size);f=new d.Buffer();f.indexBuffer=true;f.size=A?9:5;f.format=d.DataTypeEnum.UINT;f.dimension=1;f.data=new Uint16Array(f.size);s=new d.Buffer();s.indexBuffer=true;s.size=5;s.format=d.DataTypeEnum.UINT;s.dimension=1;s.data=new Uint16Array(s.size);y=new d.Buffer();y.indexBuffer=true;y.size=A?4:0;y.format=d.DataTypeEnum.UINT;y.dimension=1;y.data=new Uint16Array(y.size);G.addBuffer(0,v);G.addBuffer(1,p);G.addBuffer(2,f);G.addBuffer(3,s);G.addBuffer(4,u);G.addBuffer(5,y);E=f.data;B=0;E[B++]=0;E[B++]=1;E[B++]=2;E[B++]=3;E[B++]=4;if(A){E[B++]=0;E[B++]=1;E[B++]=3;E[B++]=2}E=s.data;B=0;E[B++]=0;E[B++]=0;E[B++]=0;E[B++]=0;E[B++]=0;E=y.data;B=0;if(A){E[B++]=0;E[B++]=1;E[B++]=3;E[B++]=2}E=v.data;B=0;E[B++]=k.x;E[B++]=k.y;E[B++]=0;E[B++]=z+k.x;E[B++]=k.y;E[B++]=0;E[B++]=z+k.x;E[B++]=w+k.y;E[B++]=0;E[B++]=k.x;E[B++]=w+k.y;E[B++]=0;E[B++]=k.x;E[B++]=k.y;E[B++]=0;E=p.data;B=0;E[B++]=0;E[B++]=0;E[B++]=1;E=u.data;B=0;E[B++]=0;E[B++]=0;E[B++]=0;E[B++]=1;E[B++]=0;E[B++]=0;E[B++]=1;E[B++]=1;E[B++]=0;E[B++]=0;E[B++]=1;E[B++]=0;if(!t){r=new d.Primitive();r.nbIndices=5;r.connectivity=d.ConnectivityTypeEnum.LINE_STRIP;r.attr={fill:new d.FillAttributes(l),line:new d.LineAttributes(l),point:new d.PointAttributes()};q=new d.VertexComponent();q.component=d.VertexComponentEnum.POSITION;q.nbVertices=5;q.nbValuesPerVertex=3;q.format=d.DataTypeEnum.FLOAT;q.cardinality=0;q.bufferId=0;q.indices=new d.IndexArray();q.indices.format=d.DataTypeEnum.UINT;q.indices.bufferId=2;q.indices.offset=0;x=new d.VertexComponent();x.component=d.VertexComponentEnum.NORMAL;x.nbVertices=1;x.nbValuesPerVertex=3;x.format=d.DataTypeEnum.FLOAT;x.cardinality=0;x.bufferId=1;x.indices=new d.IndexArray();x.indices.format=d.DataTypeEnum.UINT;x.indices.bufferId=3;x.indices.offset=0;r.addVertexComponent(q);r.addVertexComponent(x);G.addPrimitive(r)}if(A){o=new d.Primitive();o.nbIndices=4;o.connectivity=d.ConnectivityTypeEnum.TRIANGLE_STRIP;o.attr={fill:new d.FillAttributes(l),line:new d.LineAttributes(),point:new d.PointAttributes()};q=new d.VertexComponent();q.component=d.VertexComponentEnum.POSITION;q.nbVertices=4;q.nbValuesPerVertex=3;q.format=d.DataTypeEnum.FLOAT;q.cardinality=0;q.bufferId=0;q.indices=new d.IndexArray();q.indices.format=d.DataTypeEnum.UINT;q.indices.bufferId=2;q.indices.offset=5;x=new d.VertexComponent();x.component=d.VertexComponentEnum.NORMAL;x.nbVertices=1;x.nbValuesPerVertex=3;x.format=d.DataTypeEnum.FLOAT;x.cardinality=0;x.bufferId=1;x.indices=new d.IndexArray();x.indices.format=d.DataTypeEnum.UINT;x.indices.bufferId=3;x.indices.offset=0;n=new d.VertexComponent();n.component=d.VertexComponentEnum.TEX_COORD_0;n.nbVertices=4;n.nbValuesPerVertex=3;n.format=d.DataTypeEnum.FLOAT;n.cardinality=0;n.bufferId=4;n.indices=new d.IndexArray();n.indices.format=d.DataTypeEnum.UINT;n.indices.bufferId=5;n.indices.offset=0;o.addVertexComponent(q);o.addVertexComponent(x);o.addVertexComponent(n);G.addPrimitive(o)}G.noz=g>0;return G},createCircle:function(Q,F,L,O,D,N,h){var n,z,r,y,f,w,B,P,G,J,K,s,p,v,m,u,t,q,A,o,M,I,C,x,l,E,H,g;if(Q instanceof Object){l=Q.radius?Q.radius:1;E=Q.segments?Q.segments:24;I=Q.startAngle!==undefined?Q.startAngle:0;C=Q.endAngle!==undefined?Q.endAngle:Math.PI*2;H=Q.fill?Q.fill:false;m=(Q.color!==undefined)?Q.color:new d.Color(0.5,0.5,0.5,1);x=(Q.noEdge?Q.noEdge:false);g=(Q.layerNb?Q.layerNb:0)}else{console.warn("DEPRECATED: Please use a litteral object to define your primitive.");l=Q?Q:1;E=F?F:24;I=O!==undefined?O:0;C=D!==undefined?D:Math.PI*2;H=L?L:false;x=false;m=(N!==undefined)?N:new d.Color(0.5,0.5,0.5,1);g=(h?h:0)}M=C-I;n=new d.PrimitiveGroup();n.fillAttr=new d.FillAttributes();n.lineAttr=new d.LineAttributes();n.pointAttr=new d.PointAttributes();z=new d.Buffer();z.size=3*(E+2);z.component=d.VertexComponentEnum.POSITION;z.format=d.DataTypeEnum.FLOAT;z.dimension=3;z.data=new Float32Array(z.size);r=new d.Buffer();r.size=3;r.component=d.VertexComponentEnum.NORMAL;r.format=d.DataTypeEnum.FLOAT;r.dimension=3;r.data=new Float32Array(r.size);y=new d.Buffer();y.size=2*3;y.component=d.VertexComponentEnum.TEX_COORD_0;y.format=d.DataTypeEnum.FLOAT;y.dimension=3;y.data=new Float32Array(y.size);f=new d.Buffer();f.indexBuffer=true;f.size=H?2*(E+1)+1:E+1;f.format=d.DataTypeEnum.UINT;f.dimension=1;f.data=new Uint16Array(f.size);w=new d.Buffer();w.indexBuffer=true;w.size=E+2;w.format=d.DataTypeEnum.UINT;w.dimension=1;w.data=new Uint16Array(w.size);B=new d.Buffer();B.indexBuffer=true;B.size=H?E+2:0;B.format=d.DataTypeEnum.UINT;B.dimension=1;B.data=new Uint16Array(B.size);n.addBuffer(0,z);n.addBuffer(1,r);n.addBuffer(2,y);n.addBuffer(3,f);n.addBuffer(4,w);n.addBuffer(5,B);P=f.data;G=0;for(J=1;J<E+2;J++){P[G++]=J}if(H){G=E+1;P[G++]=0;for(J=1;J<E+2;J++){P[G++]=J}}P=w.data;G=0;for(G=0;G<=E+2;G++){P[G++]=0}if(H){P=B.data;P[0]=0;for(G=1;G<=E+2;G++){P[G]=1}}P=z.data;G=0;P[G++]=0;P[G++]=0;P[G++]=0;for(J=0;J<E+2;J++){p=(J/E)*M+I;P[G++]=l*Math.cos(p);P[G++]=l*Math.sin(p);P[G++]=0}P=r.data;K=0;P[K++]=0;P[K++]=0;P[K++]=1;P=y.data;K=0;P[K++]=0;P[K++]=0;P[K++]=0;P[K++]=1;P[K++]=0;P[K++]=0;if(!x){u=new d.Primitive();u.nbIndices=E+1;u.connectivity=d.ConnectivityTypeEnum.LINE_STRIP;u.attr={fill:new d.FillAttributes(m),line:new d.LineAttributes(),point:new d.PointAttributes()};t=new d.VertexComponent();t.component=d.VertexComponentEnum.POSITION;t.nbVertices=E+2;t.nbValuesPerVertex=3;t.format=d.DataTypeEnum.FLOAT;t.cardinality=0;t.bufferId=0;t.indices=new d.IndexArray();t.indices.format=d.DataTypeEnum.UINT;t.indices.bufferId=3;t.indices.offset=0;A=new d.VertexComponent();A.component=d.VertexComponentEnum.NORMAL;A.nbVertices=1;A.nbValuesPerVertex=3;A.format=d.DataTypeEnum.FLOAT;A.cardinality=0;A.bufferId=1;A.indices=new d.IndexArray();A.indices.format=d.DataTypeEnum.UINT;A.indices.bufferId=4;A.indices.offset=0;u.addVertexComponent(t);u.addVertexComponent(A);n.addPrimitive(u)}if(H){q=new d.Primitive();q.nbIndices=E+2;q.connectivity=d.ConnectivityTypeEnum.TRIANGLE_FAN;q.attr={fill:new d.FillAttributes(m),line:new d.LineAttributes(),point:new d.PointAttributes()};t=new d.VertexComponent();t.component=d.VertexComponentEnum.POSITION;t.nbVertices=E+2;t.nbValuesPerVertex=3;t.format=d.DataTypeEnum.FLOAT;t.cardinality=0;t.bufferId=0;t.indices=new d.IndexArray();t.indices.format=d.DataTypeEnum.UINT;t.indices.bufferId=3;t.indices.offset=E+1;A=new d.VertexComponent();A.component=d.VertexComponentEnum.NORMAL;A.nbVertices=1;A.nbValuesPerVertex=3;A.format=d.DataTypeEnum.FLOAT;A.cardinality=0;A.bufferId=1;A.indices=new d.IndexArray();A.indices.format=d.DataTypeEnum.UINT;A.indices.bufferId=4;A.indices.offset=0;o=new d.VertexComponent();o.component=d.VertexComponentEnum.TEX_COORD_0;o.nbVertices=2;o.nbValuesPerVertex=3;o.format=d.DataTypeEnum.FLOAT;o.cardinality=0;o.bufferId=2;o.indices=new d.IndexArray();o.indices.format=d.DataTypeEnum.UINT;o.indices.bufferId=5;o.indices.offset=0;q.addVertexComponent(t);q.addVertexComponent(A);q.addVertexComponent(o);n.addPrimitive(q)}n.noz=g>0;return n},createTorus:function(g,H,l,p,o,J,A,h){var B,n,E,r,G,N,P,C,F,x,O,Q,f,S,R,K,I,y,z,D,q,w,L,V,t,U,s,M,T;if(g instanceof c.Matrix4){console.warn("DEPRECATED: Please use a litteral object to define your primitive.");this.axis=g||null;this.majorRadius=H||100;this.minorRadius=l||40;this.majorStartAngle=p||0;this.majorEndAngle=o||Math.PI*2;this.sag=J||8;V=(A!==undefined)?A:new d.Color(0.5,0.5,0.5,1);T=(h?h:0)}else{if(g instanceof Object){this.axis=g.axis||null;this.majorRadius=g.majorRadius||100;this.minorRadius=g.minorRadius||40;this.majorStartAngle=g.majorStartAngle||0;this.majorEndAngle=g.majorEndAngle||Math.PI*2;this.sag=g.sag||8;V=g.color||((A!==undefined)?A:new d.Color(0.5,0.5,0.5,1));T=(h?h:0)}}B=(this.majorEndAngle-this.majorStartAngle)/this.sag;n=(this.sag+1)*(this.sag+1);E=6*this.sag*this.sag;r=new d.PrimitiveGroup();r.fillAttr=new d.FillAttributes();r.lineAttr=new d.LineAttributes();r.pointAttr=new d.PointAttributes();G=new d.Buffer();G.size=3*n;G.component=d.VertexComponentEnum.POSITION;G.format=d.DataTypeEnum.FLOAT;G.dimension=3;G.data=new Float32Array(G.size);w=new d.Buffer();w.size=3*n;w.component=d.VertexComponentEnum.NORMAL;w.format=d.DataTypeEnum.FLOAT;w.dimension=3;w.data=new Float32Array(w.size);N=new d.Buffer();N.size=3*n;N.component=d.VertexComponentEnum.TEX_COORD_0;N.format=d.DataTypeEnum.FLOAT;N.dimension=3;N.data=new Float32Array(N.size);P=new d.Buffer();P.indexBuffer=true;P.size=E;P.format=d.DataTypeEnum.UINT;P.dimension=1;P.data=new Uint16Array(P.size);r.addBuffer(0,G);r.addBuffer(1,w);r.addBuffer(2,N);r.addBuffer(3,P);C=P.data;O=0;for(S=0;S<(this.sag);++S){D=S+1;for(R=0;R<this.sag;++R){q=R+1;C[O]=S*(this.sag+1)+R;C[O+1]=D*(this.sag+1)+R;C[O+2]=S*(this.sag+1)+q;C[O+3]=D*(this.sag+1)+q;C[O+4]=S*(this.sag+1)+q;C[O+5]=D*(this.sag+1)+R;O+=6}}C=G.data;F=w.data;x=N.data;Q=0;f=new c.Vector3();for(S=0;S<(this.sag+1);S++){K=this.majorStartAngle+S*B;for(R=0;R<this.sag+1;R++,Q+=3){I=R/this.sag*2*Math.PI;f.x=this.majorRadius*Math.cos(K);f.y=this.majorRadius*Math.sin(K);y=new c.Vector3();y.x=(this.majorRadius+this.minorRadius*Math.cos(I))*Math.cos(K);y.y=(this.majorRadius+this.minorRadius*Math.cos(I))*Math.sin(K);y.z=this.minorRadius*Math.sin(I);z=y.clone();if(this.axis){y.applyMatrix4(this.axis)}C[Q]=y.x;C[Q+1]=y.y;C[Q+2]=y.z;L=new c.Vector3();L.subVectors(z,f).normalize();if(this.axis){L.applyMatrix4(this.axis)}L.normalize();F[Q]=L.x;F[Q+1]=L.y;F[Q+2]=L.z;x[Q]=S/this.sag;x[Q+1]=1-R/this.sag;x[Q+2]=0}}t=new d.Primitive();t.nbIndices=E;t.connectivity=d.ConnectivityTypeEnum.TRIANGLES;t.attr={fill:new d.FillAttributes(V,1),line:new d.LineAttributes(),point:new d.PointAttributes()};U=new d.VertexComponent();U.component=d.VertexComponentEnum.POSITION;U.nbVertices=n;U.nbValuesPerVertex=3;U.format=d.DataTypeEnum.FLOAT;U.cardinality=0;U.bufferId=0;U.indices=new d.IndexArray();U.indices.format=d.DataTypeEnum.UINT;U.indices.bufferId=3;U.indices.offset=0;M=new d.VertexComponent();M.component=d.VertexComponentEnum.NORMAL;M.nbVertices=n;M.nbValuesPerVertex=3;M.format=d.DataTypeEnum.FLOAT;M.cardinality=0;M.bufferId=1;M.indices=new d.IndexArray();M.indices.format=d.DataTypeEnum.UINT;M.indices.bufferId=3;M.indices.offset=0;s=new d.VertexComponent();s.component=d.VertexComponentEnum.TEX_COORD_0;s.nbVertices=n;s.nbValuesPerVertex=3;s.format=d.DataTypeEnum.FLOAT;s.cardinality=0;s.bufferId=2;s.indices=new d.IndexArray();s.indices.format=d.DataTypeEnum.UINT;s.indices.bufferId=3;s.indices.offset=0;t.addVertexComponent(U);t.addVertexComponent(M);t.addVertexComponent(s);r.addPrimitive(t);r.noz=T>0;return r},createPoints:function(f,h,j,g){var k=this.createMesh(f,undefined,undefined,undefined,d.ConnectivityTypeEnum.POINTS,h,g,undefined,undefined,undefined,j);k.pointAttr.size=j;k.noz=g>0;return k},createMesh:function(G,h,L,H,z,C,t,k,j,o,v){var I,B,E,w,m,f,u,q,g,A,J,D,F,K,n,l,s,x,r,y;F=new c.Vector3();K=new c.Vector3();this.bufferPosition=G!==undefined?G:[];this.bufferNormal=h!==undefined?h:[];this.bufferUV=L!==undefined?L:[];this.bufferColor=o!==undefined?o:[];this.bufferIndex=H!==undefined?H:[];this.glType=z!==undefined?z:d.ConnectivityTypeEnum.TRIANGLES;I=this.bufferPosition.length;B=this.bufferNormal.length;E=this.bufferUV.length;w=this.bufferColor.length;m=this.bufferIndex.length;f=new d.PrimitiveGroup();f.fillAttr=new d.FillAttributes();f.lineAttr=new d.LineAttributes();f.pointAttr=new d.PointAttributes();q=null;g=null;A=null;u=new d.Buffer();u.size=I;u.component=d.VertexComponentEnum.POSITION;u.format=d.DataTypeEnum.FLOAT;u.dimension=3;u.data=new Float32Array(this.bufferPosition);f.addBuffer(0,u);if(B){q=new d.Buffer();q.size=B;q.component=d.VertexComponentEnum.NORMAL;q.format=d.DataTypeEnum.FLOAT;q.dimension=3;q.data=new Float32Array(this.bufferNormal);f.addBuffer(1,q)}if(E){g=new d.Buffer();g.size=E;g.component=d.VertexComponentEnum.TEX_COORD_0;g.format=d.DataTypeEnum.FLOAT;g.dimension=3;g.data=new Float32Array(this.bufferUV);f.addBuffer(2,g)}if(w){A=new d.Buffer();A.size=w;A.component=d.VertexComponentEnum.DIFFUSE_COLOR;A.format=d.DataTypeEnum.FLOAT;A.dimension=3;A.data=new Float32Array(this.bufferColor);f.addBuffer(4,A)}if(m){J=new d.Buffer();J.indexBuffer=true;J.size=m;J.format=d.DataTypeEnum.UINT;J.dimension=1;if(m>65535){J.data=new Uint32Array(this.bufferIndex)}else{J.data=new Uint16Array(this.bufferIndex)}f.addBuffer(3,J)}if(k){for(D=0;D<I/3;D++){F.x=u.data[D*3];F.y=u.data[D*3+1];F.z=u.data[D*3+2];k.multiplyVector3(F);u.data[D*3]=F.x;u.data[D*3+1]=F.y;u.data[D*3+2]=F.z}for(D=0;D<B/3;D++){K.x=q.data[D*3];K.y=q.data[D*3+1];K.z=q.data[D*3+2];k.multiplyVector3(K);q.data[D*3]=K.x;q.data[D*3+1]=K.y;q.data[D*3+2]=K.z}}n=(C!=="undefined")?C:new d.Color(0.5,0.5,0.5,1);var p=v||1;l=new d.Primitive();l.nbIndices=m?m:I/3;l.connectivity=this.glType;l.attr={fill:new d.FillAttributes(n),line:new d.LineAttributes(n),point:new d.PointAttributes(n,p)};s=new d.VertexComponent();s.component=d.VertexComponentEnum.POSITION;s.nbVertices=I/3;s.nbValuesPerVertex=3;s.format=d.DataTypeEnum.FLOAT;s.cardinality=0;s.bufferId=0;s.indices=null;if(m){s.indices=new d.IndexArray();s.indices.format=d.DataTypeEnum.UINT;s.indices.bufferId=3;s.indices.offset=0}l.addVertexComponent(s);if(B){x=new d.VertexComponent();x.component=d.VertexComponentEnum.NORMAL;x.nbVertices=B/3;x.nbValuesPerVertex=3;x.format=d.DataTypeEnum.FLOAT;x.cardinality=0;x.bufferId=1;x.indices=null;if(m){x.indices=new d.IndexArray();x.indices.format=d.DataTypeEnum.UINT;x.indices.bufferId=3;x.indices.offset=0}l.addVertexComponent(x)}if(E){r=new d.VertexComponent();r.component=d.VertexComponentEnum.TEX_COORD_0;r.nbVertices=E/3;r.nbValuesPerVertex=3;r.format=d.DataTypeEnum.FLOAT;r.cardinality=0;r.bufferId=2;r.indices=null;if(m){r.indices=new d.IndexArray();r.indices.format=d.DataTypeEnum.UINT;r.indices.bufferId=3;r.indices.offset=0}l.addVertexComponent(r)}if(w){y=new d.VertexComponent();y.component=d.VertexComponentEnum.DIFFUSE_COLOR;y.nbVertices=w/3;y.nbValuesPerVertex=3;y.format=d.DataTypeEnum.FLOAT;y.cardinality=0;y.bufferId=4;y.indices=null;if(m){y.indices=new d.IndexArray();y.indices.format=d.DataTypeEnum.UINT;y.indices.bufferId=3;y.indices.offset=0}l.addVertexComponent(y)}f.addPrimitive(l);if(t){t.force=true;f.material=t}f.noz=j>0;return f},createText:function(n,p,g,w,z,f){if(z===undefined){z=32}var j,q,h,t,k,s,u,l,v,m,r,o;j="font-family: "+p+"; font-size: "+z+"px;";q=this._determineTextSize(n,j);h=q.width;t=q.height;k=h/t;s=e;s.width=h;s.height=t;u=s.getContext("2d");l=0;v=0;u.fillStyle="#"+w.getHexString();u.lineWidth=0;u.strokeStyle="#"+w.getHexString();u.font=z+"px "+p;u.textAlign="left";u.textBaseline="top";u.fillText(n,l,v);u.restore();m=h/z;r=this.createRectangle(g*m,g*m/k,true,undefined,undefined,f);var o=undefined;if(s.width!=0||s.height!=0){var y=u.getImageData(0,0,s.width,s.height);var A=new ArrayBuffer(y.data.length);var B=new Uint8Array(A);for(var x=0;x<4*s.width*s.height;++x){B[x]=y.data[x]}o=new c.DataTexture(B,s.width,s.height,c.RGBAFormat,c.UnsignedByteType,new c.UVMapping(),c.ClampToEdgeWrapping,c.ClampToEdgeWrapping,c.LinearFilter,c.LinearMipMapLinearFilter);o.needsUpdate=true}r.material=new c.MeshBasicMaterial({map:o,transparent:true});r.material.force=true;r.noz=f>0;return r},convertFromTHREEMesh:function(y){if(!(y instanceof c.Mesh)){return}var x=true;var V=0.00001;var R=function(j,m,k,l){return(Math.abs(j.x-m[k])<V)&&(Math.abs(j.y-m[k+1])<V)&&((l===2)||(Math.abs(j.z-m[k+2])<V))};var o,af,ae,ac,ab,H,n,Q,ai,ag,r,al,g,q,aj,S,p,T,O,ad,s,D,U,G,X,P,aa,ak,I,B,u,v,t,L,w,h={x:0,y:0},o=y.geometry;if(o._type!==0){return}L=[];w=[];v=false;var N=o.faces;var M=o.faceVertexUvs[0];for(af=0;af<N.length;af++){w[af]={face:N[af],uv:M?M[af]:null}}if(y.material instanceof c.MeshFaceMaterial){v=true;w.sort(function(k,j){return k.face.materialIndex-j.face.materialIndex})}H=0;n=0;I=0;ak=[];B=0;t=(w.length&&(w[0].face.materialIndex!==undefined))?w[0].face.materialIndex:-1;for(af=0;af<w.length;af++){var W=w[af].face;if(v&&(t!==W.materialIndex)){ak[I]={nbIndices:H,nbVertices:n,start:B,end:af,material:v?y.material.materials[t]:y.material};I+=1;B=af;H=0;n=0;t=W.materialIndex}if(W instanceof c.Face3){H+=3;n+=3}else{H+=6;n+=4}}if(H!=0){ak[I]={nbIndices:H,nbVertices:n,start:B,end:af,material:v?y.material.materials[t]:y.material}}g=o.vertices;var C=new Int32Array(g.length);var ah=["a","b","c","d"];for(ab=0;ab<ak.length;ab++){var F=ak[ab];var A=false;n=F.nbVertices;H=F.nbIndices;Q=new Float32Array(3*n);ai=new Float32Array(3*n);ag=new Float32Array(3*n);r=new Float32Array(3*n);al=new Uint32Array(H);var Y=0;for(af=0;af<C.length;af++){C[af]=-1}B=F.start;u=F.end;ac=0;if(x){for(af=B;af<u;af++){q=w[af].face;G=w[af].uv;S=q.vertexNormals&&q.vertexNormals.length?q.vertexNormals:null;p=q.vertexColors&&q.vertexColors.length?q.vertexColors:null;T=q.normal;O=null;if(!S||!S.length){S=null}if(!p||!p.length){p=null}var f=(q instanceof c.Face4)?4:3;for(ae=0;ae<f;ae++){s=S?S[ae]:T;D=p?p[ae]:O;X=G?G[ae]:h;var J=C[q[ah[ae]]];if((J===-1)||!R(s,ai,3*J,3)||!R(X,r,3*J,2)||(D&&!R(D,ag,3*J,3))){C[q[ah[ae]]]=Y;aj=g[q[ah[ae]]];Q[3*Y]=aj.x;Q[3*Y+1]=aj.y;Q[3*Y+2]=aj.z;ai[3*Y]=s.x;ai[3*Y+1]=s.y;ai[3*Y+2]=s.z;if(D){A=true;ag[3*Y]=D.r;ag[3*Y+1]=D.g;ag[3*Y+2]=D.b}r[3*Y]=X.x;r[3*Y+1]=X.y;r[3*Y+2]=0;if(ae===3){al[ac++]=al[ac-4];al[ac++]=al[ac-3]}al[ac++]=Y++}else{if(ae===3){al[ac++]=al[ac-4];al[ac++]=al[ac-3]}al[ac++]=J}}}}else{for(af=B;af<u;af++){q=w[af].face;G=w[af].uv;S=q.vertexNormals&&q.vertexNormals.length?q.vertexNormals:null;T=q.normal;if(!S||!S.length){S=null}var f=(q instanceof c.Face4)?4:3;for(ae=0;ae<f;ae++){var J=C[q[ah[ae]]];if(J===-1){C[q[ah[ae]]]=Y;aj=g[q[ah[ae]]];s=S?S[ae]:T;X=G?G[ae]:h;Q[3*Y]=aj.x;Q[3*Y+1]=aj.y;Q[3*Y+2]=aj.z;ai[3*Y]=s.x;ai[3*Y+1]=s.y;ai[3*Y+2]=s.z;r[3*Y]=X.x;r[3*Y+1]=X.y;r[3*Y+2]=0;if(ae===3){al[ac++]=al[ac-4];al[ac++]=al[ac-3]}al[ac++]=Y++}else{if(ae===3){al[ac++]=al[ac-4];al[ac++]=al[ac-3]}al[ac++]=J}}}}var Z=new Float32Array(3*Y);var z=new Float32Array(3*Y);var K=new Float32Array(3*Y);var E=new Float32Array(3*Y);for(af=0;af<3*Y;af++){Z[af]=Q[af];z[af]=ai[af];K[af]=ag[af];E[af]=r[af]}Q=Z;ai=z;ag=A?K:null;r=E;if(A){F.material.vertexColors=c.VertexColors}L[L.length]={bufPos:Q,bufNorm:ai,bufCol:ag,bufUV:r,bufInd:al,connectivity:d.ConnectivityTypeEnum.TRIANGLES,material:F.material}}return this.createPrimGroup(L)},createPrimGroup:function(g){var z,v,s,x,j,f,r,n,m,h,B,w,y,C,l,k,q,t,p,o;f=new d.PrimitiveGroup();f.fillAttr=new d.FillAttributes();f.lineAttr=new d.LineAttributes();f.pointAttr=new d.PointAttributes();for(w=0;w<g.length;w++){var A=!!g[w].bufCol;var u=A?5:4;z=g[w].bufPos.length;v=g[w].bufNorm.length;if(A){s=g[w].bufCol.length}x=g[w].bufUV.length;j=g[w].bufInd.length;r=new d.Buffer();r.size=z;r.component=d.VertexComponentEnum.POSITION;r.format=d.DataTypeEnum.FLOAT;r.dimension=3;r.data=new Float32Array(g[w].bufPos);n=new d.Buffer();n.size=v;n.component=d.VertexComponentEnum.NORMAL;n.format=d.DataTypeEnum.FLOAT;n.dimension=3;n.data=new Float32Array(g[w].bufNorm);if(A){m=new d.Buffer();m.size=s;m.component=d.VertexComponentEnum.DIFFUSE_COLOR;m.format=d.DataTypeEnum.FLOAT;m.dimension=3;m.data=new Float32Array(g[w].bufCol)}h=new d.Buffer();h.size=x;h.component=d.VertexComponentEnum.TEX_COORD_0;h.format=d.DataTypeEnum.FLOAT;h.dimension=3;h.data=new Float32Array(g[w].bufUV);B=new d.Buffer();B.indexBuffer=true;B.size=j;B.format=d.DataTypeEnum.UINT;B.dimension=1;B.data=new Uint32Array(g[w].bufInd);f.addBuffer(w*u,r);f.addBuffer(1+w*u,n);f.addBuffer(2+w*u,h);f.addBuffer(3+w*u,B);if(A){f.addBuffer(4+w*u,m)}}l=new d.Color(0.5,0.5,0.5,1);for(w=0;w<g.length;w++){var A=!!g[w].bufCol;var u=A?5:4;z=g[w].bufPos.length;v=g[w].bufNorm.length;if(A){s=g[w].bufCol.length}x=g[w].bufUV.length;j=g[w].bufInd.length;k=new d.Primitive();k.nbIndices=j;k.connectivity=g[w].connectivity;switch(k.connectivity){case d.ConnectivityTypeEnum.TRIANGLES:case d.ConnectivityTypeEnum.TRIANGLE_FAN:case d.ConnectivityTypeEnum.TRIANGLE_STRIP:k.geomType="FACE";break;case d.ConnectivityTypeEnum.LINES:case d.ConnectivityTypeEnum.LINE_STRIP:case d.ConnectivityTypeEnum.LINE_LOOP:k.geomType="WIRE_EDGE";break;case d.ConnectivityTypeEnum.POINTS:k.geomType="FREE_POINT";break;default:k.geomType=null;break}k.attr={fill:new d.FillAttributes(l),line:new d.LineAttributes(),point:new d.PointAttributes()};q=new d.VertexComponent();q.component=d.VertexComponentEnum.POSITION;q.nbVertices=z/3;q.nbValuesPerVertex=3;q.format=d.DataTypeEnum.FLOAT;q.cardinality=0;q.bufferId=w*u;q.indices=new d.IndexArray();q.indices.format=d.DataTypeEnum.UINT;q.indices.bufferId=3+w*u;q.indices.offset=0;t=new d.VertexComponent();t.component=d.VertexComponentEnum.NORMAL;t.nbVertices=v/3;t.nbValuesPerVertex=3;t.format=d.DataTypeEnum.FLOAT;t.cardinality=0;t.bufferId=1+w*u;t.indices=new d.IndexArray();t.indices.format=d.DataTypeEnum.UINT;t.indices.bufferId=3+w*u;t.indices.offset=0;if(A){p=new d.VertexComponent();p.component=d.VertexComponentEnum.DIFFUSE_COLOR;p.nbVertices=s/3;p.nbValuesPerVertex=3;p.format=d.DataTypeEnum.FLOAT;p.cardinality=0;p.bufferId=4+w*u;p.indices=new d.IndexArray();p.indices.format=d.DataTypeEnum.UINT;p.indices.bufferId=3+w*u;p.indices.offset=0}o=new d.VertexComponent();o.component=d.VertexComponentEnum.TEX_COORD_0;o.nbVertices=x/3;o.nbValuesPerVertex=3;o.format=d.DataTypeEnum.FLOAT;o.cardinality=0;o.bufferId=2+w*u;o.indices=new d.IndexArray();o.indices.format=d.DataTypeEnum.UINT;o.indices.bufferId=3+w*u;o.indices.offset=0;k.addVertexComponent(q);k.addVertexComponent(t);if(A){k.addVertexComponent(p)}k.addVertexComponent(o);k.material=g[w].material;f.addPrimitive(k)}if(g[0]&&g[0].material){f.material=g[0].material}return f},_determineTextSize:function(l,k){var g,j,m,h,f;g=document.getElementsByTagName("body")[0];j=document.createElement("div");j.setAttribute("style",k);m=document.createElement("span");m.setAttribute("style","white-space: nowrap");h=document.createTextNode(l);m.appendChild(h);j.appendChild(m);g.appendChild(j);f={width:0,height:0};f.width=m.offsetWidth;f.height=m.offsetHeight;g.removeChild(j);return f}});return UWA.namespace("THREEDS/GeometryHelper",a)});define("Visualization/GeometryHelper",["DS/Visualization/GeometryHelper","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/GeometryHelper");return b});define("DS/Visualization/TrackballControls",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Animation/ANIM","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent","DS/WebRecordEnabler/Adapter"],function(f,n,g,d,k,e,c,h,m,a,l){var b=0;var j=function(o,p){if(h._isInit===undefined){h.init()}this.manipulatedViewList=[p];n.EventTarget.call(this);this.viewpoint=o;this.viewer=o.viewer;this.domElement=(p!==undefined)?p:document;this.isMac=navigator.platform.toUpperCase().indexOf("MAC")>=0;this.camera=o.camera;this.id=b++;if(window.DSWebRecord){h._record_registerObject(this,"TrackballControls")}this.radius=0.5*Math.max(this.domElement.clientWidth,this.domElement.clientHeight);this.radiusZoom=0.25*(this.domElement.clientWidth+this.domElement.clientHeight);this.panSpeed=1;this.rotateSpeed=1;this.zoomSpeed=5;this.lockZ=false;this.lockRotation=false;this.lockMouseRotation=false;this.lockTouchRotation=false;this.lockZoom=false;this.lockPan=false;this.lockMouse=false;this.lockReframeOnDblTap=false;this.mouseInertia=false;this.touchInertia=true;this.rotateDirection=1;this.lastLockZState=null;this.lockZRotationSpeed=0.002;this.target=o.target;this.position=o.position;this.orientation=new n.Quaternion();this.distanceToTarget=700;this._state=j.State.NONE;this._clickTimer=null;this._leftClicking=false;this._middleClicking=false;this._rightClicking=false;this._leftButtonPressed=false;this._middleButtonPressed=false;this._rightButtonPressed=false;this._ctrlKeyPressed=false;this._shiftKeyPressed=false;this._clickTolerancy=10;this._blockVptOnHold=true;this._showSpinnerOnHold=false;this._pickingCB=true;this._forcePan=false;this._forceRotate=false;this._forceZoom=false;this._forcePanCmd=null;this._forceRotateCmd=null;this._forceZoomCmd=null;this._2DMode=false;this.oldManipActive=false;this._mode=j.Mode.COMBINED;this._zoomType=j.ZoomType.ZOOM_POS_CHANGE;var q=this;this._onWindowResize=function(r){q._resize(r)};this._onContextMenu=function(r){r.preventDefault()};this._onBlurCB=function(){q._ctrlKeyPressed=false;q._shiftKeyPressed=false};this.basicEventID=0;this.editEventBeginID=0;this.editEventKOID=0;this.infiniteRender=false;this._mouseDownPos=null;this._oldCursor="";this._modelEvent=new c();this.attachEvents();this.setMode(j.Mode.COMBINED);this._createShortHoldSpinner(1,"#3da4e0");this._customZoomTokens=[];this._customPanTokens=[];this._customRotateTokens=[];this.needsRotationFinalized=false;this._isIE11=((new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent)!=null));this._isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1};j.Mode={CATIA:0,SIMPLE:1,COMBINED:2};j.State={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,FORCE_ROTATE:3,FORCE_ZOOM:4,FORCE_PAN:5,HOLD:6,ZOOM_PAN_ROTATE:7,STOP:8};j.changeEvent={type:"change"};j.prototype.setActive=function(o){if(o instanceof Object){if(o.viewpoint!==undefined){this._changeState(o.viewpoint?j.State.NONE:j.State.STOP)}if(o.picking!==undefined){this._pickingCB=o.picking}}else{this._changeState(o?j.State.NONE:j.State.STOP)}};j.prototype.setMouseActive=function(o){this.lockMouse=!o};j.prototype.setRotationActive=function(o){this.lockRotation=!o};j.prototype.setMouseRotationActive=function(o){this.lockMouseRotation=!o};j.prototype.setTouchRotationActive=function(o){this.lockTouchRotation=!o};j.prototype.getMouseRotationActive=function(){return this.lockMouseRotation};j.prototype.getTouchRotationActive=function(){return this.lockTouchRotation};j.prototype.setZoomActive=function(o){this.lockZoom=!o};j.prototype.setPanActive=function(o){this.lockPan=!o};j.prototype.setReframeOnDoubleTap=function(o){this.lockReframeOnDblTap=!o};j.prototype.setRotationRolling=function(o){this.lockZ=!o};j.prototype.setRotationInertia=function(o){if(o.mouse!==undefined){this.mouseInertia=o.mouse}if(o.touch!==undefined){this.touchInertia=o.touch}};j.prototype.setRotationSpeed=function(o){this.rotateSpeed=o;this.lockZRotationSpeed=o*0.0015};j.ZoomType={ZOOM_POS_CHANGE:0,ZOOM_FOV_CHANGE:1};j.prototype.setZoomType=function(o){this._zoomType=o};j.prototype.onPan=function(q){if(q){var p=this._modelEvent.subscribe({event:"Pan"},q);this._customPanTokens.push(p);return p}else{for(var o=0;o<this._customPanTokens.length;o++){this._modelEvent.unsubscribe(this._customPanTokens[o])}this._customPanTokens=[]}};j.prototype.onRotate=function(q){if(q){var p=this._modelEvent.subscribe({event:"Rotate"},q);this._customRotateTokens.push(p);return p}else{for(var o=0;o<this._customRotateTokens.length;o++){this._modelEvent.unsubscribe(this._customRotateTokens[o])}this._customRotateTokens=[]}};j.prototype.onZoom=function(q){if(q){var p=this._modelEvent.subscribe({event:"Zoom"},q);this._customZoomTokens.push(p);return p}else{for(var o=0;o<this._customZoomTokens.length;o++){this._modelEvent.unsubscribe(this._customZoomTokens[o])}this._customZoomTokens=[]}};j.prototype.blockViewpointOnHold=function(o){this._blockVptOnHold=o};j.prototype.setSpinnerOnHold=function(o){this._showSpinnerOnHold=o};j.prototype.isCurrentViewpoint=function(){var o=this.viewpoint.viewer.currentViewpoint;if(o){return(o===this.viewpoint)}return false};j.prototype.isLeftButtonPressed=function(){return this._leftButtonPressed};j.prototype.isMiddleButtonPressed=function(){return this._middleButtonPressed};j.prototype.isRightButtonPressed=function(){return this._rightButtonPressed};j.prototype.isCtrlKeyPressed=function(){return this._ctrlKeyPressed};j.prototype.isShiftKeyPressed=function(){return this._shiftKeyPressed};j.prototype.isLeftClick=function(){return this._leftClicking};j.prototype.isMiddleClick=function(){return this._middleClicking};j.prototype.isRightClick=function(){return this._rightClicking};j.prototype.startLeftClick=function(){var o=this;this._leftClicking=true;if(this._clickTimer){clearTimeout(this._clickTimer)}if(!l.isReplaying()){this._clickTimer=setTimeout(function(){if(h.RecordEventsManager){h.RecordEventsManager.recordSpecialEvent(o.viewer,"TrackballControls","TrackballControlCancelLeftClick")}o.cancelLeftClick()},300)}};j.prototype.cancelLeftClick=function(){this._leftClicking=false};j.prototype.cancelMiddleClick=function(){this._middleClicking=false};j.prototype.cancelRightClick=function(){this._rightClicking=false};j.prototype.resetLeftClick=function(){this._leftClicking=false;if(this._clickTimer){clearTimeout(this._clickTimer)}this._clickTimer=null};j.prototype.getManipulationState=function(){return this._state};j.prototype.isMoving=function(){if(this._state===j.State.NONE||this._state===j.State.STOP||this._state===j.State.HOLD){return false}if(this._targetAnim&&!this._targetAnim.isRunning()){return false}return true};j.prototype.setMode=function(o){if((o===undefined)||(o===this._mode)){return}this._mode=o;var p=h._getGesture(document,"onEdit");p&&p.setTimerMouse((this._mode>0)?h.getHoldTime():0);if(this.viewer.trapSelection){this.viewer.trapSelection.updateMode(this,this._mode)}};j.prototype.setDebugEvents=function(o){h.setDebugEvents(o)};j.prototype.attachEvents=function(){this.initGestureCB();this.domElement.addEventListener("contextmenu",this._onContextMenu,false);window.addEventListener("blur",this._onBlurCB)};j.prototype.detachEvents=function(){this.resetGestureCB();this.domElement.removeEventListener("contextmenu",this._onContextMenu,false);window.removeEventListener("blur",this._onBlurCB)};j.prototype._setCapture=function(){var o=this.viewer?this.viewer.canvas:null;if(!o){return}if(o.setCapture&&((this._isIE11||(this._isFirefox&&!o.draggable))&&!(o.tagName&&(o.tagName.toLowerCase()==="input")))){o.setCapture(false)}};j.prototype._releaseCapture=function(){if((this._isIE11||this._isFirefox)&&document.releaseCapture){document.releaseCapture()}};j.prototype.initGestureCB=function(){if(this.gestureCBReady){return}var o=this;this._onLeftMouseDownCB=function(q){o._onLeftMouseDown.call(o,q)};this._onMiddleMouseDownCB=function(q){o._onMiddleMouseDown.call(o,q)};this._onRightMouseDownCB=function(q){o._onRightMouseDown.call(o,q)};this._onLeftMouseUpCB=function(q){o._onLeftMouseUp.call(o,q)};this._onMiddleMouseUpCB=function(q){o._onMiddleMouseUp.call(o,q)};this._onRightMouseUpCB=function(q){o._onRightMouseUp.call(o,q)};this._onMouseMoveCB=function(q){o._onMouseMove.call(o,q)};this._onMouseOutCB=function(q){o._onMouseOut.call(o,q)};this._onSwipeCB=function(q){o._onSwipe.call(o,q)};this._onTapCB=function(q){o._onTap.call(o,q)};this._onPinchPanRotateCB=function(q){o._onPinchPanRotate.call(o,q)};this._onDoubleTapCB=function(q){o._onDoubleTap.call(o,q)};this._onDoublePinchTapCB=function(q){o._onDoublePinchTap.call(o,q)};this._onHoldCB=function(q){o._onHold.call(o,q)};this._onTouchCB=function(q){o._onTouch.call(o,q)};this._onReleaseCB=function(q){o._onRelease.call(o,q)};this._onEditCB=function(q){o._onStopManip.call(o,q)};h.addEvent(document,"onLeftMouseDown",this._onLeftMouseDownCB);h.addEvent(document,"onRightMouseDown",this._onRightMouseDownCB);h.addEvent(document,"onLeftMouseUp",this._onLeftMouseUpCB);h.addEvent(document,"onMiddleMouseUp",this._onMiddleMouseUpCB);h.addEvent(document,"onRightMouseUp",this._onRightMouseUpCB);h.addEvent(document,"onMouseMove",this._onMouseMoveCB);h.addEvent(document,"onMouseOut",this._onMouseOutCB);h.addEvent(this.domElement,"onDoubleTap",this._onDoubleTapCB);h.addEvent(this.domElement,"onDoublePinchTap",this._onDoublePinchTapCB);h.addEvent(this.domElement,"onHold",this._onHoldCB);h.addEvent(document,"onRelease",this._onReleaseCB);h.addEvent(document,"onEdit",this._onEditCB);var p=h._getGesture(document,"onEdit");p&&p.setTimerMouse((this._mode>0)?h.getHoldTime():0);this.addViewToGestures(this.domElement);if(this.viewer&&this.viewer.divCssElement){this.addViewToManipulation(this.viewer.divCssElement)}this.basicEventID=e.subscribe({event:"/VISU/onBasicEvent"},function(q){o._onBasicEvent.call(o,q)});this.editEventBeginID=e.subscribe({event:"/VISU/onEditEventBegin"},function(q){if(o._showSpinnerOnHold){o._onEditEventBegin.call(o,q)}});this.editEventKOID=e.subscribe({event:"/VISU/onEditEventKO"},function(q){o._onEditEventKO.call(o,q)});this.gestureCBReady=true};j.prototype.resetGestureCB=function(){if(!this.gestureCBReady){return}var q=this;h.removeEvent(document,"onLeftMouseDown",this._onLeftMouseDownCB);h.removeEvent(document,"onRightMouseDown",this._onRightMouseDownCB);h.removeEvent(document,"onLeftMouseUp",this._onLeftMouseUpCB);h.removeEvent(document,"onMiddleMouseUp",this._onMiddleMouseUpCB);h.removeEvent(document,"onRightMouseUp",this._onRightMouseUpCB);h.removeEvent(document,"onMouseMove",this._onMouseMoveCB);h.removeEvent(document,"onMouseOut",this._onMouseOutCB);h.removeEvent(this.domElement,"onDoubleTap",this._onDoubleTapCB);h.removeEvent(this.domElement,"onDoublePinchTap",this._onDoublePinchTapCB);h.removeEvent(this.domElement,"onHold",this._onHoldCB);h.removeEvent(document,"onRelease",this._onReleaseCB);h.removeEvent(document,"onEdit",this._onEditCB);for(var p=0;p<this.manipulatedViewList.length;p++){var o=this.manipulatedViewList[p];this.removeViewFromGestures(o)}e.unsubscribe(this.basicEventID);e.unsubscribe(this.editEventBeginID);e.unsubscribe(this.editEventKOID);this.gestureCBReady=false};j.prototype.addViewToGestures=function(o){h.addEvent(o,"onMiddleMouseDown",this._onMiddleMouseDownCB);h.addEvent(o,"onTouch",this._onTouchCB);h.addEvent(o,"onSwipe",this._onSwipeCB);h.addEvent(o,"onPinchPanRotate",this._onPinchPanRotateCB);h.addEvent(o,"onTap",this._onTapCB)};j.prototype.removeViewFromGestures=function(o){h.removeEvent(o,"onMiddleMouseDown",this._onMiddleMouseDownCB);h.removeEvent(o,"onTouch",this._onTouchCB);h.removeEvent(o,"onSwipe",this._onSwipeCB);h.removeEvent(o,"onPinchPanRotate",this._onPinchPanRotateCB);h.removeEvent(o,"onTap",this._onTapCB)};j.prototype.addViewToManipulation=function(o){var p=this.manipulatedViewList.indexOf(o);if(p!==-1){return false}this.manipulatedViewList.push(o);this.addViewToGestures(o);return true};j.prototype.removeViewFromManipulation=function(o){var p=this.manipulatedViewList.indexOf(o);if(p===-1){return false}this.manipulatedViewList.splice(p,1);this.removeViewFromGestures(o);return true};j.prototype.setTarget=function(o){this.target.copy(o)};j.prototype.onMove=function(o){return this._modelEvent.subscribe({event:"ViewpointMove"},o)};j.prototype.unsubscribe=function(p){var o=this._customZoomTokens.indexOf(p);if(o!==-1){this._customZoomTokens.splice(o,1)}else{o=this._customPanTokens.indexOf(p);if(o!==-1){this._customPanTokens.splice(o,1)}else{o=this._customRotateTokens.indexOf(p);if(o!==-1){this._customRotateTokens.splice(o,1)}}}this._modelEvent.unsubscribe(p)},j.prototype.update=function(){var p=this.camera.position.clone(),o=this.camera.quaternion.clone(),s=new n.Vector3(0,0,1),q=false;this.camera.useQuaternion=true;s.applyQuaternion(this.orientation);s.setLength(this.distanceToTarget);this.camera.position.addVectors(this.target,s);if(this.camera.isOrtho){this.camera.setVisualizedHeight(this.distanceToTarget);this.camera.updateProjectionMatrix()}this.camera.quaternion.copy(this.orientation);this.camera.up=new n.Vector3(0,1,0);this.camera.up.applyQuaternion(this.orientation);p.sub(this.camera.position);o.sub(this.camera.quaternion);this.position.copy(this.camera.position);this.camera.updateMatrix();this.camera.matrixWorld.copy(this.camera.matrix);this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld);this.camera.updateProjectionMatrix();if(this.infiniteRender||(p.lengthSq()>1e-7)||(o.lengthSq()>1e-7||this.camera._hasChanged)){q=true;this.dispatchEvent(j.changeEvent);this.viewpoint._updateFrustum();this._modelEvent.publish({event:"ViewpointMove",context:this});if(this._2DMode&&this.viewer.svgRoot){this.viewer._updateSVGVisu()}if(this.viewer){this.viewer.renderIteration=0}}this.camera._hasChanged=false;var r={eventChannel:q?"/VISU/":"/VISU/SpriteNodeInit",eventType:"@onViewpointChange",viewpoint:this.viewpoint,cameraEye:this.position,cameraTarget:this.target,cameraUp:this.camera.up};e.publish({event:q?"/VISU/":"/VISU/SpriteNodeInit",data:r});return q};j.prototype.moveTo=function(y){console.log("TrackballControls.prototype.moveTo is DEPRECATED: use Viewpoint.moveTo instead.");var r={position:y.position,target:y.target||this.target.clone(),orientation:y.orientation||this.orientation.clone(),distanceToTarget:y.distanceToTarget||this.distanceToTarget,duration:y.duration||0};if(y instanceof n.Vector3){console.warn("TrackballControls.prototype.moveTo now uses options litteral object as argument.");r.target=arguments[0];if(arguments[1]){r.orientation=arguments[1]}if(arguments[2]!==undefined){r.distanceToTarget=arguments[2]}if(arguments[3]!==undefined){r.duration=arguments[3]}}var q,u,o;if(this._targetAnim){this._targetAnim.stop()}if(this._orientationAnim){this._orientationAnim.stop()}if(this._distanceToTargetAnim){this._distanceToTargetAnim.stop()}if(r.position&&y.target){var p=new n.Vector3().subVectors(y.target,r.position);r.distanceToTarget=p.length();if(!y.orientation){var t=new n.Matrix4().lookAt(r.position,y.target,new n.Vector3(0,0,1));r.orientation.setFromRotationMatrix(t)}}else{if(r.position){var s=new n.Vector3(0,0,1);s.applyQuaternion(r.orientation);s.setLength(r.distanceToTarget);var x=new n.Vector3().subVectors(r.position,s);r.target=x}}if(r.duration===0){this.setTarget(r.target);this.orientation=r.orientation;this.distanceToTarget=r.distanceToTarget;this.update()}else{q=new d(this.target.clone(),r.target,r.duration);q.setInterpolator(function(z,A,C){var B=A.clone();B.lerp(C,z);return B});var w=this;var v=function(A){if(A===g.State.STOPPED){var z={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:w.viewpoint,cameraEye:w.camera.position,cameraUp:w.camera.up};e.publish({event:"/VISU/",data:z})}};this._targetAnim=new k(this,"setTarget",q,v);u=new d(this.orientation,r.orientation,r.duration);u.setInterpolator(function(z,A,C){var B=new n.Quaternion();n.Quaternion.slerp(A,C,B,z);return B});this._orientationAnim=new k(this,"orientation",u);o=new d(this.distanceToTarget,r.distanceToTarget,r.duration);this._distanceToTargetAnim=new k(this,"distanceToTarget",o);this._targetAnim.start();this._orientationAnim.start();this._distanceToTargetAnim.start()}};j.prototype.handleEvent=function(o){if(typeof this[o.type]=="function"){this[o.type](o)}};j.prototype.startPan=function(o){this.endRotate();this.endZoom();this._forcePan=true;if(o){this._forcePanCmd=o}if(this.viewer){this.oldManipActive=this.viewer.getManipulators();this.viewer.setManipulators({activated:false});this.viewer.setCursor("Pan",0)}};j.prototype.startRotate=function(o){this.endPan();this.endZoom();this._forceRotate=true;if(o){this._forceRotateCmd=o}if(this.viewer){this.oldManipActive=this.viewer.getManipulators();this.viewer.setManipulators({activated:false});this.viewer.setCursor("Rotate",0)}};j.prototype.startZoom=function(o){this.endPan();this.endRotate();this._forceZoom=true;if(o){this._forceZoomCmd=o}if(this.viewer){this.oldManipActive=this.viewer.getManipulators();this.viewer.setManipulators({activated:false});this.viewer.setCursor("Zoom",0)}};j.prototype.endPan=function(o){this._forcePan&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive});this._forcePan=false;if(this._forcePanCmd){this._forcePanCmd.end(true);this.viewer.setCursor("Auto",0);this._changeState(j.State.NONE);if(this.viewer.trapSelection){this.viewer.trapSelection.isInterrupted=false}}};j.prototype.endRotate=function(o){this._forceRotate&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive});this._forceRotate=false;if(this._forceRotateCmd){this._forceRotateCmd.end(true);this.viewer.setCursor("Auto",0);this._changeState(j.State.NONE);if(this.viewer.trapSelection){this.viewer.trapSelection.isInterrupted=false}}};j.prototype.endZoom=function(o){this._forceZoom&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive});this._forceZoom=false;if(this._forceZoomCmd){this._forceZoomCmd.end(true);this.viewer.setCursor("Auto",0);this._changeState(j.State.NONE);if(this.viewer.trapSelection){this.viewer.trapSelection.isInterrupted=false}}};j.prototype._getMouseProjectionOnBall=function(q){var s,r,p,o;s=new n.Vector3((q.x-this.domElement.clientWidth*0.5)/this.radius,(this.domElement.clientHeight*0.5-q.y)/this.radius,0);r=s.length();if(r>1){s.normalize()}else{s.z=Math.sqrt(1-r*r)}p=(new n.Vector3()).subVectors(this.camera.position,this.target);o=new n.Vector3();o.add(this.camera.up.clone().cross(p).setLength(s.x));o.add(this.camera.up.clone().setLength(s.y));o.add(p.clone().setLength(s.z));return o};j.prototype._pan=function(o,p){this.update();this._doPan(o.x-p.x,o.y-p.y)};j.prototype._doPan=function(q,p){var o,s,r;if((q===0)&&(p===0)){return}o=new n.Vector3().copy(this.camera.position).sub(this.target);if(this.camera.isOrtho){s=(this.camera.top-this.camera.bottom)/this.viewer.div.clientHeight}else{s=2*this.distanceToTarget*Math.tan(0.5*this.camera.fov*Math.PI/180)/this.viewer.div.clientHeight}r=new n.Vector3();r.add(o.clone().cross(this.camera.up).setLength(s*q));r.add(this.camera.up.clone().setLength(s*p));this.target.add(r)};j.prototype._rotate=function(o,s){this.update();var u,r,t,q,p;u=this._getMouseProjectionOnBall(s);r=this._getMouseProjectionOnBall(o);t=Math.acos(u.dot(r)/(u.length()*r.length()));if(t){q=(new n.Vector3()).crossVectors(u,r).normalize();t*=this.rotateSpeed;p=(new n.Quaternion()).setFromAxisAngle(q,-t);this.orientation.multiplyQuaternions(p,this.orientation.clone())}};j.prototype._rotateLockZ=function(p,o){this.update();this._stopRotation();if(this._state===j.State.ZOOM_PAN_ROTATE){if(!this.rotateDirection||this._state!==this.lastLockZState){var q=this.camera.getLookAt().z;q=+q;if(q===0||isNaN(q)){this.rotateDirection=q}else{this.rotateDirection=q>0?1:-1}}var r=this.orientation.toEuler();r.x-=o*this.lockZRotationSpeed;r.z+=this.rotateDirection*p*this.lockZRotationSpeed;r.y=0;this.orientation=(new n.Quaternion()).setFromEuler(r,"ZYX")}else{if(!this.rotateDirection||this._state!==this.lastLockZState){var q=this.camera.up.z;q=+q;if(q===0||isNaN(q)){this.rotateDirection=q}else{this.rotateDirection=q>0?1:-1}}var r=this.orientation.toEuler();r.x-=o*this.lockZRotationSpeed;r.z-=this.rotateDirection*p*this.lockZRotationSpeed;r.y=0;this.orientation=(new n.Quaternion()).setFromEuler(r,"ZYX")}this.lastLockZState=this._state;this.needsRotationFinalized=true};j.prototype._finalizeRotateLockZ=function(z,r){this._stopRotation();if(!this.needsRotationFinalized){return}if(this.lockRotation){return}if(r&&this.lockTouchRotation){return}if(!r&&this.lockMouseRotation){return}var A=z.currentTime-z.startTime;var q=0.01;var p=new n.Vector2();p.copy(z.offsetPosition);p.multiplyScalar(0.003/A);var v=p.length();if(v<1e-7){return}if(p.length()>q){p.setLength(q)}var y=new n.Quaternion().copy(this.orientation);var x=y.toEuler();var s=p.clone().normalize().multiplyScalar(0.000006);var o=p.length()/s.length();var u=new d(0,0,o);u.setInterpolator(function(E,F,H){var G=new n.Quaternion();E*=o;var I=x.clone();var C=I.x>=0?1:-1;var D=p.x*E-0.5*s.x*E*E;var B=p.y*E-0.5*s.y*E*E;I.x-=B;I.z-=C*D;I.y=0;G=(new n.Quaternion()).setFromEuler(I,"ZYX");return G});var t=function(B){this.me.orientation=B};var w={me:this,setOrientation:t};this._orientationAnim=new k(w,"setOrientation",u);this._orientationAnim.start();this.needsRotationFinalized=false};j.prototype._zoom=function(o,r){this.update();var p,q;p=o.y-r.y;p*=0.5/this.radiusZoom;q=1+p*this.zoomSpeed;if(q!==1&&q>0){if(this._zoomType===j.ZoomType.ZOOM_FOV_CHANGE){this._zoomFOVChange(new n.Vector2(Math.floor(this.viewer.SCREEN_WIDTH*0.5),Math.floor(this.viewer.SCREEN_HEIGHT*0.5)),q<1,q)}else{this.distanceToTarget*=q}}};j.prototype._zoomPanRotate=function(C,u){this.update();this._stopRotation();var t=C.getEvents();var x=t[0];var v=t[1];if(!this.lockZoom&&(!u||(u===1))){var D,A;D=C.distance-C.lastDistance;D*=0.5/this.radiusZoom;A=1-D*this.zoomSpeed;var B={gesture:C,factor:A,defaultBehavior:true};this._modelEvent.publish({event:"Zoom",data:B,context:this});if(B.defaultBehavior&&(A!==1&&A>0)){var s=new n.Vector2().addVectors(x.lastPosition,v.lastPosition).multiplyScalar(0.5);if(this._zoomType===j.ZoomType.ZOOM_FOV_CHANGE){this._zoomFOVChange(s,A<1,A)}else{this._zoomSimple(s,A<1,A)}}}if(!this.lockPan&&(!u||(u===2))){var E,r;var p=x.getCurrentPosition(this.domElement);var o=v.getCurrentPosition(this.domElement);var y=x.getLastPosition(this.domElement);var w=v.getLastPosition(this.domElement);E=0.5*(p.x+o.x)-0.5*(y.x+w.x);D=0.5*(p.y+o.y)-0.5*(y.y+w.y);var z={gesture:C,defaultBehavior:true};this._modelEvent.publish({event:"Pan",data:z,context:this});if(z.defaultBehavior){this._doPan(E,D)}}if(!this.lockRotation&&!this.lockTouchRotation&&(!u||(u===3))){var q={gesture:C,defaultBehavior:true};this._modelEvent.publish({event:"Rotate",data:q,context:this});if(q.defaultBehavior){this._rotateLockZ(-200*C.getDeltaAngle(),0)}}};j.prototype._zoomSimple=function(L,E,A){var p=new n.Projector();var w=this.viewer.getMousePosition(L);var B;if(A!==undefined){B=A}else{B=E?0.9:1.1}var w=this.viewer.getMousePosition(L);var y=this.camera.getLookAt();var H=this.camera.position;var z=this.target.clone().sub(y.clone().multiplyScalar(this.distanceToTarget*B));var s=new n.Vector3(w.x,w.y,0.5);var o=new n.Vector3(w.x,w.y,0.5);p.unprojectVector(s,this.camera);var I=null;if(this.camera instanceof n.OrthographicCamera){this.camera.setVisualizedHeight(this.distanceToTarget*B);p.unprojectVector(o,this.camera);I=s.sub(o)}else{var q,F;this.camera.matrixWorld.setPosition(z);p.unprojectVector(o,this.camera);this.camera.matrixWorld.setPosition(H);q=new n.Ray(H,s.clone().sub(H).normalize());F=new n.Ray(z,o.clone().sub(z).normalize());var v=this.viewpoint.getBoundingSphere();var r=q.at(this.camera.near/q.direction.clone().dot(y));var x=q.direction.clone().dot(v.center.clone().sub(r));var K=Math.max(0,x-v.radius);var J=Math.max(0,x+v.radius);var D=r.add(q.direction.clone().multiplyScalar((K+J)*0.5));var C=y.negate();var G=-C.clone().dot(D);var t=new n.Plane(C,G);var u=F.intersectPlane(t);I=D.clone().sub(u)}z.add(I);this.viewpoint.moveTo({eyePosition:z,distanceToTarget:this.distanceToTarget*B})};j.prototype._zoomFOVChange=function(I,A,T){var J=new n.Projector();var C=this.viewer.getMousePosition(I);var u;if(T!==undefined){u=T}else{u=A?0.9:1/0.9}var C=this.viewer.getMousePosition(I);var p=this.camera.getLookAt();var V=this.camera.position;var q=V.clone();var E=new n.Vector3(C.x,C.y,0.5);var U=new n.Vector3(C.x,C.y,0.5);J.unprojectVector(E,this.camera);var F=null;var M=this.viewpoint.getBoundingSphere();var S=this.viewpoint.getAngle()/2;var B=22.5;var X=p.clone().dot(M.center.clone().sub(V));var P=2*M.radius;if(X<P){var v=X-P;var O=p.clone().multiplyScalar(v);var t=Math.tan(n.Math.degToRad(this.viewpoint.getAngle()*0.5));var W=n.Math.radToDeg(Math.atan(t*(X+v)/X));if(W>B||W<0){W=B}else{V.add(O);q=V.clone()}S=W;this.viewpoint.setAngle(W*2);this.camera.updateProjectionMatrix();X=P}if(!A){var Q=1;if(S<B){var H=S*u;if(H>B){this.viewpoint.setAngle(B*2);Q=H/B}else{this.viewpoint.setAngle(H*2)}this.camera.updateProjectionMatrix()}else{Q=u}if(Q!=1){var R=Q*X;var O=p.clone().multiplyScalar(X-R);q.add(O)}}else{var H=S*u;var Z=u;if(X>P){var D=X-P;var Y=P/X;if(Y<u){D=X-(X*u);Z=1}else{var s=S*Y;Z=H/s}if(D>0){q.add(p.clone().multiplyScalar(D))}}if(Z!=1){this.viewpoint.setAngle(Z*S*2);this.camera.updateProjectionMatrix()}}var y,G,x;x=this.target.clone().sub(q).length();this.camera.matrixWorld.setPosition(q);J.unprojectVector(U,this.camera);this.camera.matrixWorld.setPosition(V);y=new n.Ray(V,E.clone().sub(V).normalize());G=new n.Ray(q,U.clone().sub(q).normalize());var r=y.at(this.camera.near/y.direction.clone().dot(p));var z=y.direction.clone().dot(M.center.clone().sub(r));var N=Math.max(0,z-M.radius);var w=Math.max(0,z+M.radius);var L=r.add(y.direction.clone().multiplyScalar((N+w)*0.5));var K=p.negate();var o=-K.clone().dot(L);var ab=new n.Plane(K,o);var aa=G.intersectPlane(ab);F=L.clone().sub(aa);q.add(F);this.viewpoint.setAngle(Math.min(this.viewpoint.getAngle(),45));if(this.camera instanceof n.OrthographicCamera){this.camera.setVisualizedHeight(x)}this.camera._hasChanged=true;this.viewpoint.moveTo({eyePosition:q,distanceToTarget:x})};j.prototype._mouseWheel=function(p){p.event.preventDefault();var q=UWA.Event.wheelDelta(p.getJSEvent());if(this.isMac){q*=-1}var o={evt:p,factor:q,defaultBehavior:true};this._modelEvent.publish({event:"Zoom",data:o,context:this});if(o.defaultBehavior){if(this._zoomType===j.ZoomType.ZOOM_FOV_CHANGE){!this.lockZoom&&this._zoomFOVChange(p.getCurrentPosition(this.domElement),q>0)}else{!this.lockZoom&&this._zoomSimple(p.getCurrentPosition(this.domElement),q>0)}}};j.prototype._resize=function(p,o){this.radius=0.5*Math.max(p,o);this.radiusZoom=0.25*(p+o)};j.prototype._stopRotation=function(o){if(this._orientationAnim){this._orientationAnim.stop()}};j.prototype._changeState=function(q){var o=this._state;if(this._state===j.State.NONE){this._oldCursor=this.viewer.getCursor()}this._state=q;switch(q){case j.State.ZOOM:case j.State.FORCE_ZOOM:!this.lockZoom&&this.viewer.setCursor("Zoom",100);break;case j.State.PAN:case j.State.FORCE_PAN:!this.lockPan&&this.viewer.setCursor("Pan",100);break;case j.State.ROTATE:case j.State.FORCE_ROTATE:!this.lockRotation&&this.viewer.setCursor("Rotate",100);break;case j.State.HOLD:break;default:this.viewer.setCursor(this._oldCursor,0,true);break}if(this.viewpoint){var r=(q!==j.State.NONE)&&(q!==j.State.HOLD)&&(q!==j.State.STOP);if(this.viewpoint._isMoving===r){return}this.viewpoint._isMoving=r;var p={eventChannel:"/VISU/",eventType:r?"@onViewpointBeginMove":"@onViewpointEndMove",viewpoint:this.viewpoint,cameraEye:this.viewpoint.camera.position,cameraUp:this.viewpoint.camera.up};e.publish({event:"/VISU/",data:p})}if(l.isRecording()&&this._state===j.State.NONE&&this._state!==o&&!this.isLeftClick()&&!this.isRightClick()){if(!window.WebVisuCurrentGesture.highLevelRecordJSON){window.WebVisuCurrentGesture.highLevelRecordJSON={}}window.WebVisuCurrentGesture.highLevelRecordJSON.TrackBallControls={name:this._recordRegisterName,setViewPoint:this.positionToJSON()}}};j.prototype._onBasicEvent=function(o){if(!o.from){return}for(var r=0;r<o.from.length;r++){var q=o.from[r];var v=q.getType();var t=q.getState();if(v==="Keyboard"){var p=q.getKey();if(t===m.State.BEGIN){if(p===m.KeyboardKey.CTRL){this._ctrlKeyPressed=true}if(p===m.KeyboardKey.SHIFT){this._shiftKeyPressed=true}if(this._mode>0){if(this._ctrlKeyPressed&&(this._state===j.State.ROTATE)){this._changeState(j.State.FORCE_PAN)}}}else{if(t===m.State.END){if(p===m.KeyboardKey.CTRL){this._ctrlKeyPressed=false}if(p===m.KeyboardKey.SHIFT){this._shiftKeyPressed=false}if(this._mode>0){if(!this._ctrlKeyPressed&&(this._state===j.State.PAN)){if(this.isCurrentViewpoint()){this._changeState(j.State.ROTATE)}}}}}if(h.RecordEventsManager){h.RecordEventsManager.recordSpecialEvent(this,"TrackballControls","UpdateControlKeys",{ctrl:this._ctrlKeyPressed,shift:this._shiftKeyPressed})}}else{if(v==="Mouse"){if(this.lockMouse){continue}var s=q.button;if(t===m.State.BEGIN){var u=false;if(((s===m.MouseButton.MIDDLE)||(s===m.MouseButton.WHEEL))&&q.isInView(this.manipulatedViewList)){u=true;if(q.getJSEvent().stopPropagation){q.getJSEvent().stopPropagation()}}if((s===m.MouseButton.WHEEL)&&(this._mode>0)&&q.isInView(this.manipulatedViewList)&&(this._state!==j.State.STOP)){this._mouseWheel(q)}if(u&&(s!==m.MouseButton.WHEEL||this._mode!==j.Mode.CATIA)){UWA.Event.preventDefault(q.getJSEvent())}}else{if(t===m.State.MOVE){if(q.offsetPosition.length()>this._clickTolerancy){if((s===m.MouseButton.LEFT)&&this._leftButtonPressed){if(this._leftClicking&&h.RecordEventsManager){h.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelLeftClick")}this.resetLeftClick()}if((s===m.MouseButton.MIDDLE)&&this._middleButtonPressed){if(this._middleClicking&&h.RecordEventsManager){h.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelMiddleClick")}this._middleClicking=false}if((s===m.MouseButton.RIGHT)&&this._rightButtonPressed){if(this._rightClicking&&h.RecordEventsManager){h.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelRightClick")}this._rightClicking=false}}}}}}}};j.prototype._onEditEventBegin=function(r){var s=(r.from&&r.from.length)?r.from[0]:null;if(s===null){return}var q=s instanceof a;if((this._mode>0)||q){var p=s.getCurrentPosition(this.domElement);var o=q?80:40;this._setPositionSpinner(this.ShortHoldSpinner,p,o);this._shortHoldCircleAnim=this._showSpinner(this.ShortHoldSpinner,this.SVGCircle,o,6)}};j.prototype._onEditEventKO=function(o){this._hideSpinner(this.ShortHoldSpinner,this._shortHoldCircleAnim)};j.prototype._onLeftMouseDown=function(o){if(this.handleRecordData(o)){return}if(this.lockMouse){return}var q=(o.from&&o.from.length)?o.from[0]:null;if(q===null){return}if(this._isIE11){var p=q.getJSEvent();if(p&&(p.ctrlKey!==undefined)){this._ctrlKeyPressed=p.ctrlKey}}var s=q.isInView(this.manipulatedViewList);if(s){this._setCapture()}this._publishWUXEvent("PrimaryPointerDown",o,false);this._leftButtonPressed=true;this.startLeftClick();if(!this.isCurrentViewpoint()){return}this._mouseDownPos=this.viewer.getMousePosition(q.getCurrentPosition(this.viewer.canvas));var t=this;var r=(this._forcePan||this._forceRotate||this._forceZoom);if((this._state===j.State.STOP)||(this._state===j.State.HOLD&&!r)){if(this._pickingCB&&this.viewer&&this.viewer.leftMouseDownCB){this.viewer.leftMouseDownCB(q,this)}return}if(s&&r&&(this._state===j.State.NONE||this._state===j.State.HOLD)){if(this._forcePan){this._changeState(j.State.FORCE_PAN)}else{if(this._forceRotate){this._changeState(j.State.FORCE_ROTATE)}else{if(this._forceZoom){this._changeState(j.State.FORCE_ZOOM)}}}}else{if(this._2DMode&&this._mode>0){this._changeState(j.State.PAN)}else{if(this._mode===j.Mode.SIMPLE){s&&this._changeState(j.State.ROTATE)}else{if((this._state===j.State.PAN)||(this._state===j.State.ZOOM)){this._changeState(j.State.ROTATE)}if(this._mode===j.Mode.CATIA&&this.viewer.trapSelection){this.viewer.trapSelection.interrupt()}(this._mode===j.Mode.COMBINED)&&s&&!this.lockRotation&&this._changeState(j.State.ROTATE)}}}if(this._pickingCB&&this.viewer&&this.viewer.leftMouseDownCB){this.viewer.leftMouseDownCB(q,this);if(this.viewer.trapSelection&&r){this.viewer.trapSelection.softInterrupt()}}this.tagEventIfModeNotNONE(o)};j.prototype._onMiddleMouseDown=function(o){if(this.handleRecordData(o)){return}if(this.lockMouse){return}var q=(o.from&&o.from.length)?o.from[0]:null;if(q===null){return}if(this._isIE11){var p=q.getJSEvent();if(p&&(p.ctrlKey!==undefined)){this._ctrlKeyPressed=p.ctrlKey}}var r=q.isInView(this.manipulatedViewList);if(r){this._setCapture()}this._middleButtonPressed=true;this._middleClicking=true;if(!this.isCurrentViewpoint()){return}if((this._state===j.State.STOP)||(this._state===j.State.HOLD)){if(this._pickingCB&&this.viewer&&this.viewer.centerMouseDownCB){this.viewer.centerMouseDownCB(q,this)}return}if(this._mode>0){this._changeState(j.State.PAN)}else{if(this._state===j.State.NONE){if(!this._leftButtonPressed&&!this._rightButtonPressed){this._changeState(j.State.PAN)}}}if(this._pickingCB&&this.viewer&&this.viewer.centerMouseDownCB){this.viewer.centerMouseDownCB(q,this)}this.tagEventIfModeNotNONE(o)};j.prototype._onRightMouseDown=function(o){if(this.handleRecordData(o)){return}if(this.lockMouse){return}var q=(o.from&&o.from.length)?o.from[0]:null;if(q===null){return}if(this._isIE11){var p=q.getJSEvent();if(p&&(p.ctrlKey!==undefined)){this._ctrlKeyPressed=p.ctrlKey}}var r=q.isInView(this.manipulatedViewList);if(r){this._setCapture()}this._rightClicking=true;this._rightButtonPressed=true;if(!this.isCurrentViewpoint()){return}if((this._state===j.State.STOP)||(this._state===j.State.HOLD)){return}if((this._mode>0)&&(this._state===j.State.NONE)){if(q.isInView(this.manipulatedViewList)){this._changeState(j.State.ZOOM)}}else{if((this._state===j.State.PAN)||(this._state===j.State.ZOOM)){this._changeState(j.State.ROTATE)}}this.tagEventIfModeNotNONE(o)};j.prototype._onLeftMouseUp=function(o){if(this.handleRecordData(o)){this._leftButtonPressed=false;this._mouseDownPos=null;return}if(this.lockMouse){return}var q=(o.from&&o.from.length)?o.from[0]:null;if(q===null){return}if(this._isIE11){var p=q.getJSEvent();if(p&&(p.ctrlKey!==undefined)){this._ctrlKeyPressed=p.ctrlKey}}this._releaseCapture();this._publishWUXEvent("PrimaryPointerUp",o,false);this._leftButtonPressed=false;if(!this.isCurrentViewpoint()){this.resetLeftClick();return}var r=this;if(this._state===j.State.STOP){if(this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB){this.viewer.leftMouseUpCB(q,this)}this.resetLeftClick();return}if(this._state===j.State.FORCE_PAN||this._state===j.State.FORCE_ROTATE||this._state===j.State.FORCE_ZOOM){this._changeState(j.State.NONE)}else{if(this._mode===j.Mode.SIMPLE){this._changeState(j.State.NONE);this.endRotate();if(this._2DMode){this.endPan()}}else{if(this._2DMode&&this._mode===j.Mode.COMBINED){this._changeState(j.State.NONE);this.endPan()}else{if(this._state===j.State.HOLD){this._changeState(j.State.NONE)}else{if(this._state===j.State.ROTATE){if((this._mode===j.Mode.CATIA)||((this._mode===j.Mode.COMBINED)&&this._middleButtonPressed)){if(!this._rightButtonPressed){this._changeState(j.State.ZOOM)}}else{if(this.mouseInertia&&this.lockZ&&this._finalizeRotateLockZ){this._finalizeRotateLockZ(q,false)}this._changeState(j.State.NONE);this.endRotate();this.rotateDirection=0}}}}}}if(this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB){this.viewer.leftMouseUpCB(q,this)}this.resetLeftClick();this._mouseDownPos=null;this.tagEventIfModeNotNONE(o)};j.prototype._onMiddleMouseUp=function(o){if(this.handleRecordData(o)){this._middleButtonPressed=false;this._middleClicking=false;return}if(this.lockMouse){return}var q=(o.from&&o.from.length)?o.from[0]:null;if(q===null){return}if(this._isIE11){var p=q.getJSEvent();if(p&&(p.ctrlKey!==undefined)){this._ctrlKeyPressed=p.ctrlKey}}this._releaseCapture();var r=q.isInView(this.manipulatedViewList);this._middleButtonPressed=false;if(!this.isCurrentViewpoint()){this._middleClicking=false;return}if(this._state===j.State.STOP){if(r&&this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB){this.viewer.centerMouseUpCB(q,this)}this._middleClicking=false;return}this._changeState(j.State.NONE);if(r&&this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB){this.viewer.centerMouseUpCB(q,this)}this._middleClicking=false;this.tagEventIfModeNotNONE(o)};j.prototype._onRightMouseUp=function(o){if(this.handleRecordData(o)){this._rightButtonPressed=false;this._rightClicking=false;return}if(this.lockMouse){return}var q=(o.from&&o.from.length)?o.from[0]:null;if(q===null){return}if(this._isIE11){var p=q.getJSEvent();if(p&&(p.ctrlKey!==undefined)){this._ctrlKeyPressed=p.ctrlKey}}this._releaseCapture();this._rightButtonPressed=false;if(!this.isCurrentViewpoint()){this._rightClicking=false;return}if(this._state===j.State.STOP){if(this._pickingCB&&this.viewer&&this.viewer.rightMouseUpCB){this.viewer.rightMouseUpCB(q,this)}this._rightClicking=false;return}if((this._mode>0)&&(this._state===j.State.ZOOM)){this._changeState(j.State.NONE)}else{if(this._state===j.State.HOLD){this._changeState(j.State.NONE)}else{if(this._state===j.State.ROTATE){if((this._mode===j.Mode.CATIA)||((this._mode===j.Mode.COMBINED)&&this._middleButtonPressed)){if(!this._leftButtonPressed){this._changeState(j.State.ZOOM)}}else{if(this.mouseInertia&&this.lockZ&&this._finalizeRotateLockZ){this._finalizeRotateLockZ(q,false)}this._changeState(j.State.NONE);this.endRotate();this.rotateDirection=0}}}}if(this._pickingCB&&this.viewer&&this.viewer.rightMouseUpCB){this.viewer.rightMouseUpCB(q,this)}this._rightClicking=false;this.tagEventIfModeNotNONE(o)};j.prototype._onMouseMove=function(x){if(this.handleRecordData(x)){return}if(this.lockMouse){return}var q=(x.from&&x.from.length)?x.from[0]:null;if(q===null){return}this._publishWUXEvent("PrimaryPointerMove",x,true);if(!this.isCurrentViewpoint()){return}var u=this;if((this._state===j.State.STOP)||(this._state===j.State.HOLD)){if(this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB){this.viewer.mouseMoveCB(q,this)}return}var t=q.getCurrentPosition(this.domElement);var p=q.getLastPosition(this.domElement);for(var r=0;r<x.from.length;r++){var s=x.from[r];if(s.getButton&&(s.getButton()!==m.MouseButton.NONE)){t=s.getCurrentPosition(this.domElement);p=s.getLastPosition(this.domElement);break}}if(!l.isReplaying()){if(!this.lockPan&&((this._state===j.State.PAN)||(this._state===j.State.FORCE_PAN))){var w={gesture:x.gesture,defaultBehavior:true};this._modelEvent.publish({event:"Pan",data:w,context:this});if(w.defaultBehavior){this._pan(t,p)}}else{if(!this.lockRotation&&!this.lockMouseRotation&&((this._state===j.State.ROTATE)||(this._state===j.State.FORCE_ROTATE))){var o={gesture:x.gesture,defaultBehavior:true};this._modelEvent.publish({event:"Rotate",data:o,context:this});if(o.defaultBehavior){if(this.lockZ){this._rotateLockZ(t.x-p.x,t.y-p.y)}else{this._rotate(t,p)}}}else{if(!this.lockZoom&&((this._state===j.State.ZOOM)||(this._state===j.State.FORCE_ZOOM))){var v={gesture:x.gesture,defaultBehavior:true};this._modelEvent.publish({event:"Zoom",data:v,context:this});if(v.defaultBehavior){this._zoom(t,p)}}}}}if(this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB){this.viewer.mouseMoveCB(q,this)}this.tagEventIfModeNotNONE(x)};j.prototype._onMouseOut=function(p){if(this.handleRecordData(p)){return}if(this.lockMouse){return}this._leftButtonPressed=false;this._rightButtonPressed=false;this._middleButtonPressed=false;if(!this.isCurrentViewpoint()){return}var q=(p.from&&p.from.length)?p.from[0]:null;if(q){var o=q.getJSEvent();var r=o.target;if(!r){r=o.srcElement}if(r!==this.viewer.canvas){return}var s=o.toElement;while(s){if(s===this.viewer.divCssElement){return}s=s.parentNode}}if(this._state!==j.State.STOP){this._changeState(j.State.NONE)}this.tagEventIfModeNotNONE(p)};j.prototype._onSwipe=function(p){if(this.handleRecordData(p)){return}var r=(p.from&&p.from.length)?p.from[0]:null;if(r===null){return}this._publishWUXEvent("PrimaryPointerMove",p,true);if(!this.isCurrentViewpoint()){return}if(this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB){this.viewer.mouseMoveCB(r,this)}if(this._state===j.State.STOP){return}if(this._state===j.State.HOLD){return}var o=r.currentPosition;var u=r.lastPosition;if(!this.lockPan&&(this._state===j.State.FORCE_PAN)){var s={gesture:p.gesture,defaultBehavior:true};this._modelEvent.publish({event:"Pan",data:s,context:this});if(s.defaultBehavior){this._pan(o,u)}}else{if(!this.lockRotation&&!this.lockTouchRotation&&((this._state===j.State.ROTATE)||(this._state===j.State.FORCE_ROTATE))){var t={gesture:p.gesture,defaultBehavior:true};this._modelEvent.publish({event:"Rotate",data:t,context:this});if(t.defaultBehavior){this._rotateLockZ(o.x-u.x,o.y-u.y)}}else{if(!this.lockZoom&&(this._state===j.State.FORCE_ZOOM)){var q={gesture:p.gesture,defaultBehavior:true};this._modelEvent.publish({event:"Zoom",data:q,context:this});if(q.defaultBehavior){this._zoom(o,u)}}}}this.tagEventIfModeNotNONE(p)};j.prototype._onTap=function(o){if(this.handleRecordData(o)){return}var p=(o.from&&o.from.length)?o.from[0]:null;if(p===null){return}if(!this.isCurrentViewpoint()){return}this.startLeftClick();if(this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB){this.viewer.leftMouseUpCB(p,this)}this.resetLeftClick();this.tagEventIfModeNotNONE(o)};j.prototype._onDoubleTap=function(o){if(this.handleRecordData(o)){return}var p=(o.from&&o.from.length)?o.from[0]:null;if(p===null){return}if(!this.isCurrentViewpoint()){return}this._middleClicking=true;if(this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB){this.viewer.centerMouseUpCB(p,this)}this._middleClicking=false;this.tagEventIfModeNotNONE(o)};j.prototype._onDoublePinchTap=function(o){if(this.handleRecordData(o)){return}var r=o.gesture.getEvents();if(!r.length){return}if(!this.isCurrentViewpoint()){return}if(this._state===j.State.STOP){return}this._stopRotation();var q=this.viewer.getMousePosition(r[0].currentPosition);var t=this.viewer.pick(q,"mesh",false);var s=null;if(t.length){var p=t.path[0]._getRenderableOccurrences();if(p.length){s=p[0]}}this.viewpoint.reframe(null,undefined,s);this.tagEventIfModeNotNONE(o)};j.prototype._onHold=function(o){if(this.handleRecordData(o)){return}if(!this.isCurrentViewpoint()){return}if((h.debugEvents===2)||(h.debugEvents>=4)){console.log(data)}this.tagEventIfModeNotNONE(o)};j.prototype._onStopManip=function(o){if(this.handleRecordData(o)){return}if(!this._blockVptOnHold){return}if(!this.isCurrentViewpoint()){return}if(this._state!==j.State.STOP){if((this._state!==j.State.FORCE_PAN)&&(this._state!==j.State.FORCE_ZOOM)&&(this._state!==j.State.FORCE_ROTATE)){this._changeState(j.State.HOLD)}}this.tagEventIfModeNotNONE(o)};j.prototype._onPinchPanRotate=function(o,q){if(this.handleRecordData(o)){return}var p=o.gesture;if(!this.isCurrentViewpoint()){return}if((this._state===j.State.HOLD)||(this._state===j.State.STOP)){return}this._changeState(j.State.ZOOM_PAN_ROTATE);this._zoomPanRotate(p,q);this.tagEventIfModeNotNONE(o)};j.prototype._onTouch=function(o){if(this.handleRecordData(o)){return}this._publishWUXEvent("PrimaryPointerDown",o,false);if(!this.isCurrentViewpoint()){return}if((this._state===j.State.HOLD)||(this._state===j.State.STOP)){return}if(this._forcePan){this._changeState(j.State.FORCE_PAN)}else{if(this._forceRotate){this._changeState(j.State.FORCE_ROTATE)}else{if(this._forceZoom){this._changeState(j.State.FORCE_ZOOM)}else{if(!this.lockTouchRotation){this._changeState(j.State.ROTATE)}}}}this.tagEventIfModeNotNONE(o)};j.prototype._onRelease=function(o){if(this.handleRecordData(o)){return}var p=(o.from&&o.from.length)?o.from[0]:null;if(p===null){return}this._publishWUXEvent("PrimaryPointerUp",o,false);if(!this.isCurrentViewpoint()){return}if(this._state===j.State.STOP){if(this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB){this.viewer.leftMouseUpCB(p,this)}return}if(this._state===j.State.ROTATE||this._state===j.State.ZOOM_PAN_ROTATE){if(this.touchInertia&&this._finalizeRotateLockZ){this._finalizeRotateLockZ(p,true)}this.rotateDirection=0}if(this._state===j.State.HOLD){if(this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB){this.viewer.leftMouseUpCB(p,this)}}this._changeState(j.State.NONE);this.tagEventIfModeNotNONE(o)};j.prototype._publishWUXEvent=function(p,o,q){var r={eventChannel:"/VISU/",eventType:"@on"+p,eventID:"",from:o.from};e.publish({event:"/VISU/on"+p,data:r});if((!q&&((h.debugEvents===2)||(h.debugEvents>=4)))||(q&&(h.debugEvents>=3))){console.log(r)}};j.prototype._createShortHoldSpinner=function(p,o){var q=document.createElementNS("http://www.w3.org/2000/svg","svg");q.setAttribute("id","svgNode");q.style.position="absolute";q.style.top=0;q.style.left=0;q.style.right=0;q.style.bottom=0;q.style.setProperty("pointer-events","none");q.style.setProperty("z-index",10000);var r=document.createElementNS("http://www.w3.org/2000/svg","circle");r.setAttribute("id","svgCircle");r.setAttribute("fill","none");r.style.fill="none";r.style.stroke=o;r.style.setProperty("stroke-linecap","square");if(p){this.SVGCircle=r;this.ShortHoldSpinner=q}else{this.SVGCircleLarge=r;this.ShortHoldSpinnerLarge=q}q.appendChild(r);this.viewer.div.appendChild(q)};j.prototype._showSpinner=function(r,w,v,y){var u=v-0.5*y;r.style.display="block";r.setAttribute("width",(2*v)+"px");r.setAttribute("height",(2*v)+"px");w.setAttribute("cx",v);w.setAttribute("cy",v);w.setAttribute("r",u);w.setAttribute("transform","rotate(-90, "+v+","+v+")");w.style.setProperty("stroke-width",y);w.style.setProperty("stroke-dasharray",2*Math.PI*u+1);w.style.setProperty("stroke-dashoffset",2*Math.PI*u+1);var z=function(B,A,D,E,C){this._nbLoops=1;this._duration=D;this.duration=function(){return this._duration};this.valueAt=function(H){var I=this._duration,F=(H%I)/I;if(F>=0&&F<E){return B}else{if(F<1-C){var G=(F-E)/(1-E-C);return B*(1-G)+A*G}else{return A}}}};var s=true;var o=2*Math.PI*u+1;var x=0;var q=function(A){if(A===o){if(s){r.style.display="none";s=false}}else{if(!s){r.style.display="block";s=true}this.circle.style.setProperty("stroke-dashoffset",A)}};var t={circle:w,setOffset:q};var p=new k(t,"setOffset",new z(o,x,1.2*h.getHoldTime(),0.3,0));p.start();return p};j.prototype._hideSpinner=function(o,p){if(p){p.stop()}o.style.display="none"};j.prototype._setPositionSpinner=function(q,p,o){q.style.left=(p.x-o)+"px";q.style.top=(p.y-o)+"px"};j.prototype._setCursor=function(p){var r=this;var o="auto";if(p!=="Auto"){var q=f.getWebappsAssetUrl("Visualization","")+"icons/";o="url('"+q+"WebViewer"+p+".png'), url('"+q+"WebViewer"+p+".cur'), auto"}this.viewer.canvas.style.cursor=o};j.prototype.tagEventIfModeNotNONE=function(o){if(l.isRecording()&&this._state!==j.State.NONE&&o.gesture){if(!o.gesture.highLevelRecordJSON){o.gesture.highLevelRecordJSON={}}o.gesture.highLevelRecordJSON.TrackBallControls={ignore:true}}};j.prototype.handleRecordData=function(o){if(l.isReplaying()){if(this.testRecordMoveViewpoint(o)){return true}}};j.prototype.getRecordData=function(o,p){var q=o.gesture&&o.gesture.highLevelRecordJSON&&o.gesture.highLevelRecordJSON.TrackBallControls;return q&&(!q.name||q.name===this._recordRegisterName)&&q[p]};j.prototype.testRecordMoveViewpoint=function(p){if(this.getRecordData(p,"setViewPoint")){var o=this.getRecordData(p,"setViewPoint");this.setPositionFromJSON(o);this.viewer.render();return true}return false};j.prototype.positionToJSON=function(){return{target:this.target.createJSON(),orientation:this.orientation.createJSON(),distanceToTarget:this.distanceToTarget}};j.prototype.setPositionFromJSON=function(o){this.target.setFromJSON(o.target);this.orientation.setFromJSON(o.orientation);this.distanceToTarget=o.distanceToTarget};return j});define("Visualization/TrackballControls",["DS/Visualization/TrackballControls","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/TrackballControls");return b});define("DS/Visualization/RenderMode",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(a,f){var d=a.extend({init:function(g){this._mask=0;this._gssoMask=0;this._setFromMasks(0,0,f.GeomTypeEnum.FACE);this._useRenderLineMask=true;this._useRenderFaceMask=true;this._useRenderPointMask=true;this._outlineWidth=1;if(g&&g.renderLineMode!==undefined){this._setRenderLineMode(g.renderLineMode)}},clone:function(){var g=new d();g._mask=this._mask;g._gssoMask=this._gssoMask;g._useRenderLineMask=this._useRenderLineMask;g._useRenderPointMask=this._useRenderPointMask;g._useRenderFaceMask=this._useRenderFaceMask;return g},combine:function(g){if(g){this._mask=g._mask}},setOutlineWidth:function(g){this._outlineWidth=g},setRenderMode:function(l,h){if(l==="@InternalEdge"){this.setRenderMode("InternalSharpEdge",h);this.setRenderMode("InternalSmoothEdge",h)}else{if(l==="@Edge"){this.setRenderMode("InternalSharpEdge",h);this.setRenderMode("InternalSmoothEdge",h);this.setRenderMode("BoundaryEdge",h);this.setRenderMode("WireEdge",h)}else{if(l==="@Point"){this.setRenderMode("BoundaryPoint",h);this.setRenderMode("SharpPoint",h);this.setRenderMode("SmoothPoint",h);this.setRenderMode("SurfacicPoint",h);this.setRenderMode("FreePoint",h)}else{var k={InternalSharpEdge:"SHARP_EDGE",InternalSmoothEdge:"SMOOTH_EDGE",BoundaryEdge:"BOUNDARY_EDGE",WireEdge:"WIRE_EDGE",Outline:"_OUTLINE",SectionLine:"_SECTION_LINE",Face:"FACE",BoundaryPoint:"BOUNDARY_POINT",SharpPoint:"SHARP_POINT",SurfacicPoint:"SURFACIC_POINT",SmoothPoint:"SMOOTH_POINT",FreePoint:"FREE_POINT",AxisSystem:"AXIS_SYSTEM",InfiniteFace:"INFINITE_FACE"};var g=k[l];if(!g){console.warn(l+"unknown category")}else{var m=f.GeomTypeEnum[g];var j,n;j=this._mask||0;if(h){n=j|m}else{n=j&~m}this._setMask(n)}}}}},_setRenderLineMode:function(k){k=k||0;var g=this._mask,j,h=d.linesMask;g=g&(~h);j=(k&h)|g;this._setMask(j)},_setFromMasks:function(j,g,h){this._setMask((j&b)|(g&e)|(h&c))},getRenderLineMode:function(){return this._mask&e},_setMask:function(g){this._mask=g;this._gssoMask=g|d.defaultMask}});d.createChild=function(g,h){var j=null;if(g||h){if(g){j=g.clone();j.combine(h)}else{j=h}}return j};d.defaultMask=f.GeomTypeEnum.EDGE|f.GeomTypeEnum.UNKNOWN;var b=f.GeomTypeEnum.BOUNDARY_POINT|f.GeomTypeEnum.SHARP_POINT|f.GeomTypeEnum.SMOOTH_POINT|f.GeomTypeEnum.SURFACIC_POINT|f.GeomTypeEnum.FREE_POINT|f.GeomTypeEnum.HIDDEN_SEAM_POINT;d.pointsMask=b;var e=f.GeomTypeEnum.EDGE|f.GeomTypeEnum.WIRE_EDGE|f.GeomTypeEnum.BOUNDARY_EDGE|f.GeomTypeEnum.SHARP_EDGE|f.GeomTypeEnum.SMOOTH_EDGE|f.GeomTypeEnum.HIDDEN_SEAM_EDGE|f.GeomTypeEnum._OUTLINE|f.GeomTypeEnum._SECTION_LINE;d.linesMask=e;var c=f.GeomTypeEnum.INFINITE_FACE|f.GeomTypeEnum.FACE|f.GeomTypeEnum.AXIS_SYSTEM;d.facesMask=c;d.defaultRenderLineMode=f.GeomTypeEnum.EDGE;f.RenderMode=d;return d});define("DS/Visualization/OccurrenceInterface",["UWA/Class","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS"],function(a,e,d){function c(f){if(!f._occurrenceExplorer._occurrenceInterfaceList){var g=new Error("Use of expired OccurrenceInterface (= outside of callback function given to OccurrenceExplorer.explore())");g.expiredOccurrenceInterfaceError=true;throw g}var h=f._occurrenceExplorer._occurrenceList[f._node][f._index].occurrence;return h}var b=a.extend({init:function(h,g,f){this._node=h;this._index=g;this._occurrenceExplorer=f},getNbChildren:function(){var f=c(this);return f.children.length},getParent:function(){var g=c(this);var f=this._occurrenceExplorer.getOccurrenceInterface(g.parent);return f},getChild:function(g){var h=c(this);var f=this._occurrenceExplorer.getOccurrenceInterface(h.children[g]);return f},getChildren:function(){var h=c(this);var g=[];var f;for(f=0;f<h.children.length;f++){g.push(this._occurrenceExplorer.getOccurrenceInterface(h.children[f]))}return g},traverse:function(l,h){var k=c(this);var f=l(this,h);if(!f){var g=0;var j;for(g=0;g<k.children.length;g++){j=this._occurrenceExplorer.getOccurrenceInterface(k.children[g]);j.traverse(l,h)}}},getNode:function(){var f=c(this);return f.node},getMesh3D:function(){var f=c(this);if(f.node.getNodeType()==="Mesh3D"){return f.node}return null},getColor:function(f){var n=c(this);this._tryOverridesUpdate(n);if(n.renderable){var m=n.occurrenceRenderingOverride&&n.occurrenceRenderingOverride.materialOverride;var l=(m&&m.getColor())||null;var g=m&&m.getFullMaterial();var k=n.renderable.matApp&&n.renderable.matApp._getMaterialFromGLType(4,d.GeomTypeEnum.FACE);var j=false;if(!k&&n.renderable.material){k=n.renderable.material;j=true;if(k&&(f||!k.force)){k=null}}else{if(k&&f){k=null}}var h=null;if((l!==null||g)&&(!k||!k.color||k.overridable)){h=(g&&g.color&&g.color.clone());if(l!==null&&(!h||g.overridable)){h=new d.Color(l)}}else{h=k&&k.color&&(!j||k.force)&&k.color.clone()}}return h},getWorldMatrix:function(f){var g=c(this);this._tryOverridesUpdate(g);if(f){f.copy(g.matrix);return f}else{return g.matrix.clone()}},getMatrix:function(g){var h=c(this);this._tryOverridesUpdate(h);var f=h.getLocalMatrix();if(g){g.copy(f);return g}else{return f.clone()}},getMatrixInAxisSystem:function(j,h){var g=this.getWorldMatrix();if(!g){return null}var f=h||new d.Matrix4();var k=new d.Matrix4();k.getInverse(j);f.multiplyMatrices(k,g);return f},getRenderableDescendants:function(){var h=c(this);var f=[];var g=this;h.traverse(function(j){if(j.renderable){f.push(g._occurrenceExplorer.getOccurrenceInterface(j))}});return f},buildPathElement:function(f){var g=new e();var h=c(this);if(g.setFromOccurrence(h,null,f)){return g}else{return null}},getVisibility:function(){var f=c(this);this._tryOverridesUpdate(f);return f._getVisible()},getBoundingSphere:function(f){var g=c(this);return g.getBoundingSphere(f,false)},getBoundingBox:function(f){var g=c(this);return g.getBoundingBox(f)},isAParentOf:function(f){var g=f;while(g&&this!==g){g=g.getParent()}return g===this},findAncestor:function(f){var h=this.getParent();var g=null;while(h&&!g){if(f(h)){g=h}h=h.getParent()}return g},_tryOverridesUpdate:function(h){var f;var g=this._occurrenceExplorer.viewer;if(h._getNeedOverridesUpdate()){f=h;while(f.parent){f=f.parent}g=g||(h.scene3js&&h.scene3js.viewer);f.node._tryOverridesUpdate(g)}}});return b});define("DS/Visualization/BoundingBoxGPUCompute",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(a,b){var c=a.extend({init:function(d){this.renderer=d;this.minMaxExtension=b.supportedExtensions.minMaxBlending;this.useBackUpAlgorithm=true;this._pixels=this.useBackUpAlgorithm?1:32;this.renderTarget=null;this.zRenderTarget=null;this.zMaterial=null;this.material=null;this._useUnindexed=((new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent)!=null));return this},setPixelCount:function(d){this._pixels=d;if(this.renderTarget){_initRenderTarget()}},_initMaterial:function(){var g=new b.ParticleBasicMaterial();g.sizeAttenuation=false;g.fog=false;g.activatePDSFX();var d={orientationMatrix:{type:"m4",value:new b.Matrix4()}};g.setPDSFXUniforms(d);var f={vPos:{type:"v3"}};g.setPDSFXVaryings(f);var e={ComputeVaryingValues:["void ComputeVaryingValues() {","vPos=vec3(orientationMatrix * modelMatrix * vec4( position, 1.0 )).xyz;","float xPos = fract(sin(vPos.z)*1000.0)*2.0-1.0;","gl_Position=vec4(xPos,0.0,0.0,1.0);","}"].join("\n"),ComputeObjectTexCoord0:["vec4 ComputeObjectTexCoord0() {","	return vec4(0.0,0.0, 0.0, 0.0);","}"].join("\n"),ComputeObjectNormal:["vec3 ComputeObjectNormal() {","	return vec3(0.0,0.0,1.0);","}"].join("\n")};var h={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor.xyz = vPos;","}"].join("\n")};g.setPDSFXOverridableFunctions(e,h);return g},_initBackUpMaterial:function(){var g=new b.ParticleBasicMaterial();g.sizeAttenuation=false;g.fog=false;g.activatePDSFX();var d={composante:{type:"v3",value:new b.Vector3()},orientationMatrix:{type:"m4",value:new b.Matrix4()},zMin:{type:"f",value:0},zMax:{type:"f",value:0},};g.setPDSFXUniforms(d);var f={vZ:{type:"f"}};g.setPDSFXVaryings(f);var e={ComputeVaryingValues:["void ComputeVaryingValues() {","vZ=dot(composante,vec3(orientationMatrix * modelMatrix * vec4( position, 1.0 )));","gl_Position=vec4(0.0,0.0,2.0*(vZ)/(zMax-zMin)-(zMin+zMax)/(zMax-zMin),1.0);","}"].join("\n"),ComputeObjectTexCoord0:["vec4 ComputeObjectTexCoord0() {","	return vec4(0.0,0.0, 0.0, 0.0);","}"].join("\n"),ComputeObjectNormal:["vec3 ComputeObjectNormal() {","	return vec3(0.0,0.0,1.0);","}"].join("\n")};var h={ProcessFinalColor:["float shift_right(float v, float amt) {","v = floor(v) + 0.5;","return floor(v / exp2(amt));","}","float shift_left(float v, float amt) {","return floor(v * exp2(amt) + 0.5);","}","float mask_last(float v, float bits) {","return mod(v, shift_left(1.0, bits));","}","float extract_bits(float num, float from, float to) {","from = floor(from + 0.5);","to = floor(to + 0.5);","return mask_last(shift_right(num, from), to - from);","}","vec4 encode_float(float val) {","if (val == 0.0)","return vec4(0, 0, 0, 0);","float sign = val > 0.0 ? 0.0 : 1.0;","val = abs(val);","float exponent = floor(log2(val));","float biased_exponent = exponent + 127.0;","float fraction = ((val / exp2(exponent)) - 1.0) * 8388608.0;","float t = biased_exponent / 2.0;","float last_bit_of_biased_exponent = fract(t) * 2.0;","float remaining_bits_of_biased_exponent = floor(t);","float byte4 = extract_bits(fraction, 0.0, 8.0) / 255.0;","float byte3 = extract_bits(fraction, 8.0, 16.0) / 255.0;","float byte2 = (last_bit_of_biased_exponent * 128.0 + extract_bits(fraction, 16.0, 23.0)) / 255.0;","float byte1 = (sign * 128.0 + remaining_bits_of_biased_exponent) / 255.0;","return vec4(byte4, byte3, byte2, byte1);","}","void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = encode_float(vZ);","}"].join("\n")};g.setPDSFXOverridableFunctions(e,h);return g},_initRenderTarget:function(){if(this.useBackUpAlgorithm){var d={minFilter:b.NearestFilter,magFilter:b.NearestFilter,type:b.UnsignedByteType,format:b.RGBAFormat};this.renderTarget=new b.WebGLRenderTarget(6,this._pixels,d)}else{var d={minFilter:b.NearestFilter,magFilter:b.NearestFilter,type:b.FloatType,format:b.RGBAFormat};this.renderTarget=new b.WebGLRenderTarget(this._pixels,2,d)}},_initZRenderTarget:function(){var d={minFilter:b.NearestFilter,magFilter:b.NearestFilter,type:b.UnsignedByteType,format:b.RGBAFormat};this.zRenderTarget=new b.WebGLRenderTarget(1,1,d)},_render:function(n,l){var y=new b.Scene();var r=new b.OrthographicCamera();var h=this.renderTarget;var x=false;var g=true;var m=false;var u=false;var s=new b.StateSortingResult();s.init();var d=new b.DisplayList({name:"MYPOINT",priority:0,zSort:b.FrontToBack,side:b.Constants.DoubleSide,polygonOffset:false});s.addDisplayList(d);var t=new b.DisplayRangeList(l,null);d._displayRangeLists[0]=t;var w=d._materialList;var o={material:l,occurrenceRenderingOverride:null,id:0,occurrenceRenderingOverrideId:-1};w[d.usefulListLength++]=o;var k=[];var f=0;for(var q=0;q<n.length;q++){var e=n[q];for(var p=0;p<e.obj.length;p++){var v=e.obj[p];k[f++]=v.glType;v.glType=0;var z={0:e.renderable,1:v.geometry,2:v,3:v.start,4:v.count,next:null};if(t.first===null){t.first=t.last=z}else{t.last.next=z;t.last=z}}}this.renderer.renderer.currentPass={isOITPass:false};this.renderer.renderer.render(y,r,this.renderTarget,x,g,s,m,u);this.renderer.renderer.currentPass=null;for(var q=n.length-1;q>=0;q--){var e=n[q];for(var p=e.obj.length-1;p>=0;p--){var v=e.obj[p];v.glType=k[--f]}}},_drawBBDGs:function(f){var h=true;var g=new b.OrthographicCamera();for(var e=0;e<f.length;e++){var m=f[e];for(var d=0;d<m.obj.length;d++){var l=m.obj[d];var k=l.glType;l.glType=0;this.renderer.renderer.renderInterval(g,[],null,m.renderable,this.material,null,l.geometry,l,l.start,l.count,null,null,h,null);l.glType=k;h=false}}},_drawBBDGsDepth:function(n,d,s,g,e){if(!this.material){this.material=this._initBackUpMaterial()}this.material.updatePDSFXUniform("orientationMatrix",d);this.material.updatePDSFXUniform("composante",e);this.material.updatePDSFXUniform("zMin",s);this.material.updatePDSFXUniform("zMax",g);this.material.id++;var t=true;var o=new b.OrthographicCamera();if(!this._useUnindexed){for(var m=0;m<n.length;m++){var f=n[m];if(!f.renderable._modelViewMatrix){f.renderable._modelViewMatrix=new b.Matrix4()}for(var k=0;k<f.obj.length;k++){var r=f.obj[k];var h=r.glType;r.glType=0;this.renderer.renderer.renderInterval(o,[],null,f.renderable,this.material,null,r.geometry,r,r.start,r.count,null,null,t,null);r.glType=h;t=false}}}else{for(var m=0;m<n.length;m++){var l=n[m].renderable;if(!l._modelViewMatrix){l._modelViewMatrix=new b.Matrix4()}for(var k=0;k<l.geometry.length;k++){var q=l.geometry[k];var p=0;if(q.vertexPositionArray){p=q.compressedVertices?q.vertexPositionArray.length/2:q.vertexPositionArray.length/3}else{p=q.verticeCount}var r={glType:0,start:0,count:p,nonIndexed:true};this.renderer.renderer.renderInterval(o,[],null,l,this.material,null,q,r,r.start,r.count,null,null,t,null);t=false}}}},_drawZMinDGsDepth:function(d,o,e){if(!this.zMaterial){this.zMaterial=this._initBackUpMaterial()}this.zMaterial.updatePDSFXUniform("orientationMatrix",new b.Matrix4());this.zMaterial.updatePDSFXUniform("composante",new b.Vector3(0,0,1));this.zMaterial.updatePDSFXUniform("zMin",o);this.zMaterial.updatePDSFXUniform("zMax",e);this.zMaterial.id++;var p=true;var k=new b.OrthographicCamera();for(var h=0;h<d.length;h++){var g=d[h];if(!g._modelViewMatrix){g._modelViewMatrix=new b.Matrix4()}for(var f=0;f<g.geometry.length;f++){var n=g.geometry[f];var m=0;if(n.vertexPositionArray){m=n.compressedVertices?n.vertexPositionArray.length/2:n.vertexPositionArray.length/3}else{m=n.verticeCount}var l={glType:0,start:0,count:m,nonIndexed:true};this.renderer.renderer.renderInterval(k,[],null,g,this.zMaterial,null,n,l,l.start,l.count,null,null,p,null);p=false}}},_setRendererState:function(){var e,g;var h=this.renderer.gl.getParameter(this.renderer.gl.SCISSOR_BOX);g=this.renderer.renderer.getViewport();e=this.renderer.renderer.getScissorTest();var f=this.renderer.renderer.enablerenderPluginsPre;this.renderer.renderer.enableRenderPluginsPre=false;var j=this.renderer.renderer.renderPoints;this.renderer.renderer.renderPoints=true;this.renderer.renderer.materialToUse=0;var k=this.renderer.renderer._oldDepthTest;var d={scissor:e,scissorValue:h,viewport:g,enablerenderpluginsPre:f,renderPoints:j,depthTest:k};return d},_resetRendererState:function(e){this.renderer.renderer.setViewport(e.viewport.x,e.viewport.y,e.viewport.width,e.viewport.height);this.renderer.renderer.enableScissorTest(e.scissor);this.renderer.renderer.setScissor(e.scissorValue[0],e.scissorValue[1],e.scissorValue[2],e.scissorValue[3]);this.renderer.renderer.renderPoints=e.renderPoints;this.renderer.renderer.setDepthTest(e.depthTest);this.renderer.renderer.enableRenderPluginsPre=e.enablerenderpluginsPre;var f=this.renderer.renderer.getClearColor();var d=this.renderer.renderer.getClearAlpha();this.renderer.gl.clearColor(f.r,f.g,f.b,d)},computeZMinGPU:function(l,k){if(!this.zRenderTarget){this._initZRenderTarget()}this.renderer.renderer.setRenderTarget(this.zRenderTarget);var e=this._setRendererState();var f=l.getSceneBoundingSphere();if(f.pixelRadius>0){var j=l.currentViewpoint.camera;var d=j.getWorldSizeFromPixelSize(1,f.center,l.div.clientHeight);if(typeof j.fullWidth!=="undefined"&&j.fullWidth>0){var h=Math.max(j.width*1/j.fullWidth,j.height*1/j.fullHeight);d*=h}f.radius+=d*f.pixelRadius}var g=this._computeZMin(k,f);this._resetRendererState(e);return g},computeBoundingBoxGPU:function(g,l,e){if(!e){e=new b.Matrix4()}var f=new b.Matrix4().getInverse(e);if(!this.renderTarget){this._initRenderTarget()}this.renderer.renderer.setRenderTarget(this.renderTarget);var m=this._setRendererState();var n=g.getSceneBoundingSphere();n.center.applyMatrix4(f);if(n.pixelRadius>0){var h=g.currentViewpoint.camera;var d=h.getWorldSizeFromPixelSize(1,n.center,g.div.clientHeight);if(typeof h.fullWidth!=="undefined"&&h.fullWidth>0){var k=Math.max(h.width*1/h.fullWidth,h.height*1/h.fullHeight);d*=k}n.radius+=d*n.pixelRadius}var j;if(this.useBackUpAlgorithm){j=this._computeBoundingBoxBackUp(l,f,n)}else{j=this._computeBoundingBoxMain(l,f,n)}this._resetRendererState(m);return j},_computeBoundingBoxMain:function(n,j,o){this.renderer.gl.clearColor(o.center.x+o.radius*2,o.center.y+o.radius*2,o.center.z+o.radius*2,1);this.renderer.renderer.clear();this.renderer.renderer.setDepthTest(false);this.renderer.gl.enable(this.renderer.gl.BLEND);this.renderer.gl.blendEquation(this.minMaxExtension.MIN_EXT);this.renderer.renderer.setViewport(0,0,this._pixels,1);if(!this.material){this.material=this._initMaterial()}this.material.updatePDSFXUniform("orientationMatrix",j);this.material.blendEquation=b.MinEquation;this._drawBBDGs(n);this.renderer.gl.blendEquation(this.minMaxExtension.MAX_EXT);this.renderer.renderer.setViewport(0,1,this._pixels,1);this.renderer.renderer.enableScissorTest(true);this.renderer.renderer.setScissor(0,1,this._pixels,1);this.renderer.gl.clearColor(o.center.x-o.radius*2,o.center.y-o.radius*2,o.center.z-o.radius*2,1);this.renderer.renderer.clear();this.material.blendEquation=b.MaxEquation;this._drawBBDGs(n);var l=new Float32Array(4*this._pixels*2);this.renderer.gl.readPixels(0,0,this._pixels,2,this.renderer.gl.RGBA,this.renderer.gl.FLOAT,l);var h=l[0];var g=l[1];var f=l[2];var m=this._pixels*4;var e=l[m];var d=l[m+1];var p=l[m+2];for(var k=1;k<this._pixels;k++){h=Math.min(h,l[k*4]);g=Math.min(g,l[k*4+1]);f=Math.min(f,l[k*4+2]);e=Math.max(e,l[m+k*4]);d=Math.max(d,l[m+k*4+1]);p=Math.max(p,l[m+k*4+2])}return new b.Box3(new b.Vector3(h,g,f),new b.Vector3(e,d,p))},_computeZMin:function(g,d){this.renderer.gl.clearColor(0,0,0,0);this.renderer.renderer.clear();this.renderer.gl.disable(this.renderer.gl.BLEND);this.renderer.renderer.setDepthTest(true);this.renderer.gl.depthFunc(this.renderer.gl.LESS);var h=d.center.z;this._drawZMinDGsDepth(g,h-d.radius,h+d.radius);this.renderer.gl.depthFunc(this.renderer.gl.LEQUAL);this.renderer.renderer.setViewport(0,0,1,1);var f=new Uint8Array(4*1);this.renderer.gl.readPixels(0,0,1,1,this.renderer.gl.RGBA,this.renderer.gl.UNSIGNED_BYTE,f);var e=new Float32Array(f.buffer);return e[0]},_computeBoundingBoxBackUp:function(r,k,s){this.renderer.gl.clearColor(0,0,0,0);this.renderer.renderer.clear();this.renderer.gl.disable(this.renderer.gl.BLEND);this.renderer.renderer.setDepthTest(true);this.renderer.gl.depthFunc(this.renderer.gl.LEQUAL);for(var n=0;n<6;n++){this.renderer.renderer.setViewport(n,0,1,this._pixels);var h=new b.Matrix4();var l=new b.Vector3(0,0,1);var p=s.center.z;if(n==1){l.set(1,0,0);p=s.center.x}else{if(n==2){l.set(0,1,0);p=s.center.y}else{if(n==3){this.renderer.gl.depthFunc(this.renderer.gl.GEQUAL);this.renderer.gl.clearDepth(-1);this.renderer.renderer.clear(false,true,false)}else{if(n==4){l.set(1,0,0);p=s.center.x}else{if(n==5){l.set(0,1,0);p=s.center.y}}}}}this._drawBBDGsDepth(r,k,p-s.radius,p+s.radius,l)}this.renderer.gl.clearDepth(1);this.renderer.gl.depthFunc(this.renderer.gl.LEQUAL);var q=new Uint8Array(4*6*this._pixels);this.renderer.gl.readPixels(0,0,6,this._pixels,this.renderer.gl.RGBA,this.renderer.gl.UNSIGNED_BYTE,q);var o=new Float32Array(q.buffer);var f=o[0];var j=o[1];var g=o[2];var t=o[3];var e=o[4];var d=o[5];for(var n=1;n<this._pixels;n++){f=Math.min(f,o[n*6]);j=Math.min(j,o[n*6+1]);g=Math.min(g,o[n*6+2]);t=Math.max(t,o[n*6+3]);e=Math.max(e,o[n*6+4]);d=Math.max(d,o[n*6+5])}return new b.Box3(new b.Vector3(j,g,f),new b.Vector3(e,d,t))},});return UWA.namespace("THREEDS/BoundingBoxGPUCompute",c)});define("DS/Visualization/MaterialApplication",["DS/Visualization/ThreeJS_DS"],function(a){a.MaterialLayerUndefined=Number.MAX_SAFE_INTEGER||(Math.pow(2,53)-1);a.MaterialLayerMax=a.MaterialLayerUndefined-1;var b=function(c){this.isMatApp=true;this._mergeWithGAS=false;this._material=null;this._materialGeomFace=null;this._materialLine=null;this._materialPoint=null;this._inheritance=1;this._layer=a.MaterialLayerMax;this.setParameters(c)};b.prototype.copy=function(c){this._mergeWithGAS=c._mergeWithGAS;this._material=c._material;this._materialGeomFace=c._materialGeomFace;this._materialLine=c._materialLine;this._materialPoint=c._materialPoint;this._inheritance=c._inheritance;this._layer=c._layer};b.prototype.clone=function(){return new b({faceMaterial:this._material,geometricalFaceMaterial:this._materialGeomFace,lineMaterial:this._materialLine,pointMaterial:this._materialPoint,inheritance:this._inheritance,layer:this._layer,mergeWithGAS:this._mergeWithGAS})};b.prototype.setParameters=function(c){if(c.faceMaterial){this._material=c.faceMaterial}if(c.geometricalFaceMaterial){this._materialGeomFace=c.geometricalFaceMaterial}if(c.lineMaterial){this._materialLine=c.lineMaterial}if(c.pointMaterial){this._materialPoint=c.pointMaterial}if(c.inheritance!==undefined){this._inheritance=c.inheritance}if(c.layer!==undefined){this._layer=c.layer}if(c.mergeWithGAS!==undefined){this._mergeWithGAS=c.mergeWithGAS}};b.prototype._getMaterialFromGLType=function(c,d){if(c===4){if((d===a.GeomTypeEnum.FACE)&&this._materialGeomFace){return this._materialGeomFace}else{return this._material}}else{if(c===1){return this._materialLine}}return this._materialPoint};b.prototype.solveInheritance=function(c){if(!c){return this}if((this._inheritance!==0)&&((this._layer<c._layer)||((this._layer===c._layer)&&((this._layer<a.MaterialLayerMax)||(this._inheritance===2||(this._inheritance===1&&c._inheritance===0)))))){return this}else{return c}};b.prototype.getMaterial=function(e,c,d){if(!e){return this._getMaterialFromGLType(c,d)}if((this._inheritance!==0)&&((this._layer<e._layer)||((this._layer===e._layer)&&((this._layer<a.MaterialLayerMax)||(this._inheritance===2||(this._inheritance===1&&e._inheritance===0)))))){return this._getMaterialFromGLType(c,d)}else{return e._getMaterialFromGLType(c,d)}};return b});define("DS/Visualization/RenderStyle",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/RenderMode"],function(a,c,b){var d=a.extend({init:function(){this._renderMode=new b();this._renderMode._setMask(c.ShowAllRenderLineMode|c.ShowAllFaces);this._faceMode=d.FaceModes.MATERIAL;this._locked=false},setOutlineWidth:function(e){this._renderMode.setOutlineWidth(e)},setRenderMode:function(f,e){if(this._locked){return false}this._renderMode.setRenderMode(f,e);return true},setFaceMode:function(e){if(this._locked){return false}this._faceMode=d.FaceModes[e];return true},clone:function(){var e=new d();e._renderMode=this._renderMode.clone();e._faceMode=this._faceMode;return e},_lock:function(){this._locked=true}});d.FaceModes={MATERIAL:1,GAS:2,ZONLY:3,BACKGROUND:4};c.RenderStyle=d;return d});define("DS/Visualization/Node3D",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/OccurrencePath","DS/Visualization/PathElement","DS/Mesh/MeshUtils","DS/CoreEvents/ModelEvents","DS/Visualization/OccurrenceRenderingOverride","DS/Visualization/SessionNodesWithSectionProfile","DS/Visualization/ClippingContext","DS/Visualization/RenderMode","DS/Visualization/RenderStyle","DS/Visualization/MaterialApplication"],function(v,o,A,p,s,g,l,z,n,h,j,c,f){var d=5;var B=0,m=0.001;var q=new A.Matrix4();var t=function(C,D){this.node=(C!==undefined)?C:null;this.parent=null;this.children=[];this.visible;this.visibilityFree;this.pickable;this.drawInHLRender;this._needBEUpdate;this._needOverridesUpdate;this._descendantNeedsOverridesUpdate;this.matrix=null;this.material=null;this.matApp=null;this.gas=null;this._setVisible(true);this._setVisibilityFree(false);this._setPickable(true);this.setDrawInHLRender(true);this.renderPriority=null;this.scene3js=(D!==undefined)?D:null;this.renderable=null;this.renderMode=null;this.faceMode=null;this._setNeedBEUpdate(true);this.passes=null;this.pickingPriorityID=null;this.clippingContext=null;this.__rdo_visited=0;this.localMatrixOverride=null;this._bsShow=undefined;this._bsNoShow=undefined;this._bbShow=undefined;this._bbNoShow=undefined;this.occurrenceRenderingOverride=null;this.originalOverrideSet=null;this.overrideLink=null;this._setNeedOverridesUpdate(false);this._setDescendantNeedsOverridesUpdate(false);return this};t.prototype.updateMatrix=function(C,D){if(D){if(C){if(this.localMatrixOverride){this.localMatrixOverride.copy(C)}else{this.localMatrixOverride=C.clone()}}else{this.localMatrixOverride.identity()}}else{this.localMatrixOverride=null}if(this.parent){if(C){if(this.parent.matrix){if(!this.matrix){this.matrix=new A.Matrix4()}this.matrix.multiplyMatrices(this.parent.matrix,C)}else{if(this.matrix){this.matrix.copy(C)}else{this.matrix=C.clone()}}}else{if(this.parent.matrix){if(this.matrix){this.matrix.copy(this.parent.matrix)}else{this.matrix=this.parent.matrix.clone()}}else{this.matrix=new A.Matrix4()}}}else{if(C){if(this.matrix){this.matrix.copy(C)}else{this.matrix=C.clone()}}else{this.matrix=new A.Matrix4()}}};t.prototype.getViewer=function(){return this.scene3js&&this.scene3js.viewer};t.prototype.getLocalMatrix=function(){return this.localMatrixOverride||this.node._matrix||q};t.prototype.requestOverridesUpdate=function(){var C=this.parent;while(C&&!C._getDescendantNeedsOverridesUpdate()){C._setDescendantNeedsOverridesUpdate(true);C=C.parent}this.traverseWithCondition(function(D){if(!D._getNeedOverridesUpdate()){if(D.parent){D.parent._setDescendantNeedsOverridesUpdate(true)}D._setNeedOverridesUpdate(true);return true}else{return null}})};t.prototype.doesADescendantNeedOverrideUpdate=function(){return this._getDescendantNeedsOverridesUpdate()};t.prototype.isOverridesUpdateRequested=function(){return this._getNeedOverridesUpdate()};t.prototype.clearOverridesUpdateRequest=function(){this.traverseWithCondition(function(C){var D=C._getDescendantNeedsOverridesUpdate()?true:null;C._setNeedOverridesUpdate(false);C._setDescendantNeedsOverridesUpdate(false);return D})};t.prototype.updateOverrideStatus=function(E){function C(M){var G=M.originalOverrideSet;if(G&&G.lib){G.lib.length=0}var K=null,L=null;if(M.parent){K=M.parent.overrideLink;L=M.parent.originalOverrideSet}if(K&&K.lib){K.lib.length=0}var I=M.overrideLink,J;var H=G||K;if(!I){if(H){J=(G&&G.visibilityFix)||(K&&K.visibilityFix);I=H.createOverrideLink(J);M.overrideLink=I}}if(I){I.combine(G,K,L)}return I}if(E){this.traverse(function(G){C(G)})}else{this.traverse(function(G){if(G.overrideLink){G.overrideLink.reset()}})}if(this.parent){this.parent.node._updateOccurrences(this.parent,this,false)}else{var F=this.children;var D=0;for(D=0;D<F.length;D++){this.node._updateOccurrences(this,F[D],!E)}}};t.prototype._tryOverridesUpdateWithAncestors=function(D){if(this._needOverridesUpdate||this._descendantNeedsOverridesUpdate){var C=this;while(C.parent){C=C.parent}C.node._tryOverridesUpdate(D||(this.scene3js&&this.scene3js.viewer))}};t.prototype.lightCopy=function(){var C,G=this.node,F=new t(G,this.scene3js);if(this.renderable!==null){C=G.createRenderable();C.name=G.name;C._occurrence=F;F.renderable=C;if(G._occurrences[0]&&G._occurrences[0]._manipulators){var E=G._occurrences[0]._manipulators;var D;for(D in E){var H=E[D];if(!F._manipulators){F._manipulators={}}F._manipulators[D]=H}}}return F};t.prototype.traverse=function(G,E){var D,C=this.children.length,F;F=G(this,E);for(D=0;D<C;D++){this.children[D].traverse(G,F)}};t.prototype.traverseWithCondition=function(G,E){var D,C=this.children.length,F;F=G(this,E);if(F){for(D=0;D<C;D++){this.children[D].traverseWithCondition(G,F)}}};t.prototype._getRenderableOccurrences=function(H){var G,F,D,E,C;G=[];F=this.children;if(this.renderable!==null){G.push(this.renderable)}var I;for(E=0;E<F.length;E++){I=F[E];if(!H||!I.node.getExcludeFromBounding()){D=I._getRenderableOccurrences();for(C=0;C<D.length;C++){G.push(D[C])}}}return G};t.prototype.getBoundingSphere=function(E,D){var C=this._getBoundingSphere(E,D);if(C){return C.clone()}else{return null}};t.prototype.getBoundingBox=function(C){return this._getBoundingBox(C)};t.prototype._getRenderModes=function(){var D=this.scene3js&&this.scene3js.viewer;if(D&&this.renderable!==null){var C=D.renderer.renderer;return C.getRenderMode(this.renderable)._gssoMask}return 0};t.prototype._getAccurateRenderableOccurrences=function(D,J,U,P){var L=P||this.node.getRatio()>0;if(U.fixedSizeNodesStatus===A.FixedSizeFiltering.Exclude&&L){return D}var E=this.children;if(this.renderable!==null){var N=this.renderable;var C=false;if(N.visibilityFree){C=N.visible}else{C=U.space?N.visible:!N.visible}if(C){var F=[];var S=this._getRenderModes();if(!N.layer){for(var R=0;R<N.geometry.length;R++){var O=N.geometry[R];for(var Q=0;Q<O.drawingGroups.length;Q++){var T=O.drawingGroups[Q];if(T.disabled(S,U.mask)){continue}F.push(T)}}}else{var I=N.layer.layers;for(var Q=0;Q<I.length;Q++){var V=I[Q];if(V.drawableGroup.disabled(S)){continue}F.push(V)}}if(F.length>0){var M=new A.Matrix4();if(U.handleMatrix!==null){M.multiplyMatrices(new A.Matrix4().getInverse(U.handleMatrix),N._getMMMatrix())}else{M=N._getMMMatrix()}var K=U.fixedSizeNodesStatus===A.FixedSizeFiltering.CenterOnly&&L?new A.Box3(new A.Vector3(0,0,0),new A.Vector3(0,0,0)):N.boundingBox.clone();var H=new A.DGBoundingBoxArray({fastBBox:K.applyMatrix4(M),matrix:M,renderable:N});H.setDGs(F);D.push(H)}}}var G;for(var R=0;R<E.length;R++){G=E[R];if(!J||!G.node.getExcludeFromBounding()){G._getAccurateRenderableOccurrences(D,J,U,L)}}return D};t.prototype.computeAccurateBoundingBox=function(C,M,N,H){var D=C==="visibleSpace";var F=[];var E=false;var L=this;while(L!=null){E=E||L.node.getRatio()>0;L=L.parent;if(E){break}}this._getAccurateRenderableOccurrences(F,true,{space:D,handleMatrix:M,fixedSizedNodesStatus:N?N:A.FixedSizeFiltering.Include,mask:H?H:0},E);var K=[];for(var I=F.length-1;I>=0;I--){if(!F[I].renderable.geometry[0].vertexPositionArray){K.push(F[I]);F.splice(I,1)}}var G=new A.Box3();G.fromDGBoundingBoxArray(F);if(K.length){var J=this.getViewer();G.union(J.renderer.boundingBoxGPUCompute.computeBoundingBoxGPU(J,K,M))}return G};t.prototype.needsBoundingElement=function(){var D,C=this.children.length;for(D=0;D<C;D++){var E=this.children[D];if(E.localMatrixOverride||E._bsShow!==undefined||E._bsNoShow!==undefined||E._bbShow!==undefined||E._bbNoShow!==undefined||(E.overrideLink&&E.overrideLink.hasVisibilityOverride())){return true}}return false};t.prototype._getBoundingSphere=function(G,E){G=G||"visibleSpace";this._updateBoundingElements();var F=null;var D=this._bsShow!==undefined?this._bsShow:this.node._bsShow;var C=this._bsNoShow!==undefined?this._bsNoShow:this.node._bsNoShow;if(this._getVisibilityFree()){if(this._getVisible()){F=D}else{F=null}}else{if(this._getVisible()){if(G==="visibleSpace"){F=D}else{F=C}}else{if(G==="visibleSpace"){F=null}else{F=x(D&&D.clone(),C,this.node.getRatio())}}}if(!F&&!E){F=new A.Sphere()}return F};t.prototype._getBoundingBox=function(F){F=F||"visibleSpace";this._updateBoundingElements();var E=null;var D=this._bbShow!==undefined?this._bbShow:this.node._bbShow;var C=this._bbNoShow!==undefined?this._bbNoShow:this.node._bbNoShow;if(this._getVisibilityFree()){if(this._getVisible()){E=D}else{E=null}}else{if(this._getVisible()){if(F==="visibleSpace"){E=D}else{E=C}}else{if(F==="visibleSpace"){E=null}else{E=y(D&&D.clone(),C)}}}if(!E){E=new A.Box3()}return E};t.prototype.updateVisibilityFlag=function(){this._invalidateBoundingElements(false)};t.prototype.updateVisibilityFreeFlag=function(){this._invalidateBoundingElements(false)};t.prototype._invalidateBoundingElements=function(C){if(!this._getNeedBEUpdate()){this._setNeedBEUpdate(true);if(this.parent&&(!this.node.getExcludeFromBounding()||C)){this.parent._invalidateBoundingElements(false)}}};t.prototype._updateBoundingElements=function(C,E){if(!C){this.node._updateBoundingElements()}if(this._getNeedBEUpdate()){if(!this.node._getForceBoundingElements()){E=this.node._updateShadowMapsIfNeeded(E);var D=0;for(D=0;D<this.children.length;D++){this.children[D]._updateBoundingElements(true,E)}this._updateBoundingElements_internal("_bsShow","_bsNoShow",x,"bSphere");this._updateBoundingElements_internal("_bbShow","_bbNoShow",y,"bBox")}this._setNeedBEUpdate(false);if(!this.parent){if(this.scene3js){this.scene3js.boundingSphere=this._getBoundingSphere("visibleSpace").clone();this.scene3js.boundingSphere.radius=100;this.scene3js.boundingBox=this._getBoundingBox("visibleSpace").clone()}}}};t.prototype._updateBoundingElements_internal=function(K,M,F,H){if(this.node._getForceBoundingElements()){return}if(this.needsBoundingElement()){if(this.children.length){var E=0,D;var G=null,J=null;var I,L,C;for(E=0;E<this.children.length;E++){D=this.children[E];if(!D.node.getExcludeFromBounding()){I=D[K]!==undefined?D[K]:D.node[K];L=D[M]!==undefined?D[M]:D.node[M];C=D.localMatrixOverride||D.node._matrix;if(D._getVisibilityFree()){if(D._getVisible()){G=F(G,I,C,D.node.getRatio());J=F(J,I,C,D.node.getRatio())}}else{if(D._getVisible()){G=F(G,I,C,D.node.getRatio());J=F(J,L,C,D.node.getRatio())}else{J=F(J,I,C,D.node.getRatio());J=F(J,L,C,D.node.getRatio())}}}}}else{if(this._getHasExplicitBE()){G=this[K]!==undefined?this[K]:this.node[H];J=null}}this[K]=G;this[M]=J}else{this[K]=undefined;this[M]=undefined}};var k=v.extend({init:function(C){this.id=B;B++;this.linkedToSceneGraph;this._forceBoundingElements;this.excludeFromBounding;this._needBEUpdate;this.visible;this.visibilityFree;this.pickable;this.drawInHLRender;this.pickParent;this._treeModified;this.notAllowedInPathElement;this._visibilityInTree;this.isManipulator;this.modelIdentification=null;this.name=(C!==undefined)?C:"";this.parents=[];this.children=[];this.setLinkedToSceneGraph(false);this._bsShow=null;this._bsNoShow=null;this._bbShow=null;this._bbNoShow=null;this._setForceBoundingElements(false);this._matrix=new A.Matrix4();this.setExcludeFromBounding(false);this.userData=null;this._setNeedBEUpdate(true);this.material=null;this._matApp=null;this._gas=null;this._setVisible(true);this._setVisibilityFree(false);this._setPickable(true);this.setDrawInHLRender(true);this._occurrences=[];var D=new t(this,this.scene3js);this._occurrences.push(D);this._setPickParent(false);this.__setTreeModified(false);this.passes=null;this.clippingContext=null;this._renderMode=null;this.setNotAllowedInPathElement(false);this.modelEvents=undefined;this.productType="";this.persistentId=0;this._setVisibilityInTree(true);this._iconInTree="";this.pickingPriorityID=null;this.clipPolyLine=null;this.setIsManipulator(false);return this},_getPickingCameraName:function(){var C=this._occurrences;var D=C[0].passes;if(D){if(D.length===1){if(D[0]==="robot"){return"connectedRobotCamera"}else{if(D[0]==="robotOrtho"){return"robotCameraOrtho"}}}}return""},_setTreeModified:function(){if(!this._getTreeModified()){this.__setTreeModified(true);var C=0;for(C=0;C<this.parents.length;C++){this.parents[C]._setTreeModified()}}},getModelIdentification:function(){return this.modelIdentification},setModelIdentification:function(C){this.modelIdentification=C},getIdentificationObject:function(){return this.modelIdentification},setIdentificationObject:function(C){this.modelIdentification=C},setNodeUsage:function(C){this.persistentId=C},getNodeUsage:function(){return this.persistentId},isOOCNode:function(){var C=this.getNodeUsage();if(C===k.REFERENCE_NODE||C===k.INSTANCE_NODE||C===k.REPRESENTATION_NODE){return true}else{return false}},isOOCRepReference:function(){return this.getNodeUsage()===k.REPRESENTATION_NODE},isOOCReference:function(){return this.getNodeUsage()===k.REFERENCE_NODE},isOOCInstance:function(){return this.getNodeUsage()===k.INSTANCE_NODE&&!this.isOOCRepInstance()},isOOCRepInstance:function(){if(this.getNodeUsage()===k.INSTANCE_NODE){var C;for(C=0;C<this.children.length;C++){if(this.children[C].isOOCRepReference()){return true}}}return false},addChild:function(D){if(a>0){throw new Error("Attempt to modify locked node hierarchy.")}this._setTreeModified();var L,I,E,C,G,M;if(D instanceof A.Object3D){console.warn("THREE.Object3D can not be a child of Node3D. This is probably due to a migration problem.")}L=(D.parents.length<this.children.length)?D.parents.indexOf(this):this.children.indexOf(D);if(L!==-1){return false}D._invalidateBoundingElements(false,false);this.children.push(D);D.parents.push(this);var O=null;var K=this;D.traverse(function(S){var R=S.clippingContext&&S.clippingContext.planes;if(R){if(!O){O=K._getAllOwningViewers()}var Q,P;for(Q=0;Q<O.length;Q++){for(P=0;P<R.length;P++){O[Q]._addClippingPlane(R[P])}}}});this.onLinkToSceneGraph(D);E=this._occurrences.length;C=D._occurrences.length;I=0;if(!E||!C){return false}for(I=0;I<E;I++){G=this._occurrences[I];M=D._occurrences[0];if(G&&G.originalOverrideSet&&G.originalOverrideSet.onAddChild){var J=G.scene3js&&G.scene3js.viewer;G.originalOverrideSet.onAddChild(J)}if((C>1)||(M.parent!==null)){M=this._copyTree(M)}G.children.push(M);M.parent=G;this._updateOccurrences(G,M,true);M.requestOverridesUpdate()}var N,F;if(!this._getNeedBEUpdate()&&!D._areBoundingElementsIncludedInParent(this)){this._invalidateBoundingElements(false,false)}var H={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"ADD",fromNode:this,toNode:D};o.publish({event:"/VISU/onSceneGraphUpdate",data:H})},removeChild:function(D){if(a>0){throw new Error("Attempt to modify locked node hierarchy.")}this._setTreeModified();var M,N,E,C,G,O,I,F;M=this.children.indexOf(D);if(M===-1){return false}this.children.splice(M,1);N=D.parents.indexOf(this);if(N===-1){return false}D.parents.splice(N,1);this.onLinkToSceneGraph(D);var P=null;var L=this;D.traverse(function(T){var S=T.clippingContext&&T.clippingContext.planes;if(S){if(!P){P=L._getAllOwningViewers()}var R,Q;for(R=0;R<P.length;R++){for(Q=0;Q<S.length;Q++){P[R]._removeClippingPlane(S[Q])}}}});E=this._occurrences.length;C=D._occurrences.length;if(!E||!C){return false}for(I=0;I<E;I++){G=this._occurrences[I];C=D._occurrences.length;O=D._occurrences[0];if(C===1){M=G.children.indexOf(O);if(M!==-1){G.children.splice(M,1)}O.parent=null;O.material=D.material;if(D._matrix){if(!O.matrix){O.matrix=D._matrix.clone()}else{O.matrix.copy(D._matrix)}}else{O.matrix=null}if(O.renderable!==null){O.renderable.setMatrix(O.matrix,false);if(O.node.getNodeType()==="Mesh3D"||O.node.getNodeType()==="ParticlesNode3D"){if(O.material!==null){O.renderable.material=O.material}if(O.matApp!==null){O.renderable.matApp=O.matApp}if(O.gas!==null){O.renderable.gas=O.gas}if((O.scene3js!==null)&&(O.scene3js.containsObject(O.renderable))){this._removeFromVisuSelection(O.renderable);O.scene3js.remove(O.renderable);if(O.node.getNodeType()==="Mesh3D"){O.renderable.releaseVBO()}}}else{if(O.node.getNodeType()==="LightNode3D"){if((O.scene3js!==null)&&(O.scene3js.containsLight(O.renderable))){O.scene3js.remove(O.renderable)}}else{if(O.node.getNodeType()==="LensFlareNode3D"){if((O.scene3js!==null)&&(O.scene3js.containsLensFlare(O.renderable))){O.scene3js.remove(O.renderable)}}else{if(O.node.getNodeType()==="CSS2DNode"||O.node.getNodeType()==="CSS3DNode"){O.renderable.element.parentNode.removeChild(O.renderable.element);if(O.scene3js!==null){O.scene3js.remove(O.renderable)}}}}}}var J=O.scene3js&&O.scene3js.viewer;if(J&&J._sceneGraphStateVersion===2){O.traverse(function K(Q){if(Q.originalOverrideSet){Q.originalOverrideSet.onDetach(J);Q.originalOverrideSet=null}Q.overrideLink=null})}O.scene3js=null;for(F=0;F<O.children.length;F++){this._updateOccurrences(O,O.children[F],true)}}else{for(F=0;F<G.children.length;F++){O=G.children[F];if(O.node===D){break}}G.children.splice(F,1);this._deleteTree(O)}}this._removeInvalidElementsInXSO(D);if(!D.getExcludeFromBounding()){this._invalidateBoundingElements(false,false)}var H={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"REMOVE",fromNode:this,toNode:D};o.publish({event:"/VISU/onSceneGraphUpdate",data:H})},removeChildren:function(){while(this.children.length){this.removeChild(this.children[0],false)}this._invalidateBoundingElements(false,false);return true},traverse:function(I,H,F){var G,D,C=false;C=I(this,H);var E=F?this.parents:this.children;D=E.length;if(!C){for(G=0;G<D;G++){C=E[G].traverse(I,H,F);if(C){break}}}return C},traverseUnique:function(H,G,D,C){var F=[];this._traverse_internal(H,G,D,C,F);var E;for(E=0;E<F.length;E++){F[E]._occurrences[0].__rdo_visited=0}return F},_traverse_internal:function(J,H,E,F,D){if(!this._occurrences[0].__rdo_visited){D.push(this);var I,G,K=false;K=J(this,H);var C=E?this.parents:this.children;G=C.length;if(!K){for(I=0;I<G;I++){C[I]._traverse_internal(J,H,E,F,D)}}this._occurrences[0].__rdo_visited=1}},getChildrenByName:function(D,C){var E={root:this,nodes:[]};this.traverse(function(G,F){if(G.name===D){F.nodes.push(G)}return false},E,C);return E.nodes},_forceGeomType:function(C){for(var D=0;D<this.children.length;D++){this.children[D]._forceGeomType(C)}},_setRatio:function(D){for(var C=0;C<this.children.length;C++){this.children[C]._setRatio(D)}},_setFixedSizeCameraName:function(D){for(var C=0;C<this.children.length;C++){this.children[C]._setFixedSizeCameraName(D)}},_setFixedSizeCenter:function(C,E){for(var D=0;D<this.children.length;D++){this.children[D]._setFixedSizeCenter(C,E)}},getChildByName:function(D,C){var E={root:this,node:null};this.traverse(function(G,F){if(G.name===D){F.node=G;return true}return false},E,C);return E.node},getChildById:function(E,C){var D={root:this,node:null};this.traverse(function(G,F){if(G.persistentId===E){F.node=G;return true}return false},D,C);return D.node},oldSetMaterial:function(G){var F,C,H,I,E,D;this.material=G;F=this._occurrences.length;for(E=0;E<F;E++){H=this._occurrences[E];H.material=G;if(H.renderable!==null){H.renderable._gsso_cache=null;if(!A.disableJHGDev||H.material!==null){H.renderable.material=H.material}}}for(E=0;E<F;E++){H=this._occurrences[E];C=H.children.length;for(D=0;D<C;D++){I=H.children[D];this._updateOccurrences(H,I,false)}}},setMaterial:function(G){var F=this;if(G&&G._source===A.AssetSource.MATERIAL_MANAGER){console.error("Error: you can't assign a material you did not create to a Node");return}var D=function(H){if(!F.linkedToSceneGraph){return}if(H&&H._source===A.AssetSource.MATERIAL_MANAGER){H._useCount--;if(H._useCount<=0){H.dispose()}for(var I in H){if(H.hasOwnProperty(I)&&H[I] instanceof A.Texture){var J=H[I];if(J._source===A.AssetSource.MATERIAL_MANAGER){J._useCount--;if(J._useCount<=0){J.dispose()}}}}D(H.line);D(H.point)}};if(!window.newMaterialInheritance){D(this.material);this.oldSetMaterial(G);return}var C=null;if(this._matApp&&(this._matApp._material===G)){C=this._matApp}if(C){this._matApp=C;this._updateMaterial()}else{D(this._matApp?this._matApp._material:null);this._matApp=null;var E={faceMaterial:G,layer:0};if(G&&G.line){E.lineMaterial=G.line}if(G&&G.point){E.pointMaterial=G.point}C=new f(E);this._setMaterialApplication(C)}},getMaterialApplication:function(){return this._matApp},setMaterialApplication:function(C){this._setMaterialApplication(C)},removeMaterialApplication:function(){this._removeMaterialApplication()},_getMaterialApplication:function(){return this._matApp},_setMaterialApplication:function(D){var C=this._getMaterialApplication();if(C){if((D._layer<C._layer)||(D._layer===C._layer&&D._inheritance>=C._inheritance)){this._matApp=D}}else{this._matApp=D}this._updateMaterial()},_removeMaterialApplication:function(){this._matApp=null;this._updateMaterial()},_updateMaterial:function(){var F,G,E,D;F=this._occurrences.length;var C=this._getMaterialApplication();for(D=0;D<F;D++){G=this._occurrences[D];E=G.parent;if(!E&&C){G.matApp=C}else{this._updateOccurrences(E,G,false)}if(G.renderable!==null){G.renderable.matApp=G.matApp}}},setGAS:function(C){this._setGAS(C)},getGAS:function(){return this._gas},_setGAS:function(G){if(!G){return}if(this._gas){this._gas.copy(G)}else{this._gas=G.clone()}var E,F,D,C;E=this._occurrences.length;for(C=0;C<E;C++){F=this._occurrences[C];D=F.parent;if(!D){F.gas=this._gas?this._gas.clone():null}else{this._updateOccurrences(D,F,false)}if(F.renderable!==null){F.renderable.gas=F.gas}}},_getGAS:function(){return this._gas},setVisibility:function(O,L){if(this._getVisible()===O){return}var E,D,G,M,J,H;this._setVisible(O);if(L){var K=this._getViewer();var N;if(K){N=K.getRobot()}if(N){if(N.isTargetGone(K.visibleSpace)){N.setConnectionState(false)}}}E=this._occurrences.length;for(J=0;J<E;J++){G=this._occurrences[J];if(G.parent){G._setVisible(G.parent._getVisible()&&this._getVisible())}else{G._setVisible(this._getVisible())}if(G.renderable!==null){G.renderable.visible=G._getVisible();if((G.renderable.highlight!==undefined)&&(G.renderable.highlight!==null)){G.renderable.highlight.visible=G._getVisible()}if((G.renderable.preHighlight!==undefined)&&(G.renderable.preHighlight!==null)){G.renderable.preHighlight.visible=G._getVisible()}if(G.renderable instanceof A.CSS2DNode||G.renderable instanceof A.CSS3DNode){var F=true;if(this._getViewer()){F=this._getViewer().visibleSpace}var C=true;if(G._getVisibilityFree()){C=G._getVisible()}else{C=F?G._getVisible():!G._getVisible()}if(!C){G.renderable.element.style.display="none"}}}G.updateVisibilityFlag()}for(J=0;J<E;J++){G=this._occurrences[J];D=G.children.length;for(H=0;H<D;H++){M=G.children[H];this._updateOccurrences(G,M,true)}}this._updateVisibilityFlag();var I={eventChannel:"/VISU/onSceneGraphUpdate",eventType:O?"SHOWTREE":"HIDETREE",fromNode:this,toNode:null};o.publish({event:"/VISU/onSceneGraphUpdate",data:I})},setVisibilityFree:function(N){if(this._getVisibilityFree()===N){return}var E,D,G,L,J,H;this._setVisibilityFree(N);var K=this._getViewer();var M;if(K){M=K.getRobot()}if(M){if(M.isTargetGone(K.visibleSpace)){M.setConnectionState(false)}}E=this._occurrences.length;for(J=0;J<E;J++){G=this._occurrences[J];if(G.parent){G._setVisibilityFree(G.parent._getVisibilityFree()||this._getVisibilityFree())}else{G._setVisibilityFree(this._getVisibilityFree())}if(G.renderable!==null){G.renderable.visibilityFree=G._getVisibilityFree();if((G.renderable.highlight!==undefined)&&(G.renderable.highlight!==null)){G.renderable.highlight.visibilityFree=G._getVisibilityFree()}if((G.renderable.preHighlight!==undefined)&&(G.renderable.preHighlight!==null)){G.renderable.preHighlight.visibilityFree=G._getVisibilityFree()}if(G.renderable instanceof A.CSS2DNode||G.renderable instanceof A.CSS3DNode){var F=true;if(this._getViewer()){F=this._getViewer().visibleSpace}var C=true;if(G._getVisibilityFree()){C=G._getVisible()}else{C=F?G._getVisible():!G._getVisible()}if(!C){G.renderable.element.style.display="none"}}}G.updateVisibilityFreeFlag()}for(J=0;J<E;J++){G=this._occurrences[J];D=G.children.length;for(H=0;H<D;H++){L=G.children[H];this._updateOccurrences(G,L,false)}}this._updateVisibilityFreeFlag();var I={eventChannel:"/VISU/onSceneGraphUpdate",eventType:N?"VISIBILITYFREE":"VISIBILITYDEPENDENT",fromNode:this,toNode:null};o.publish({event:"/VISU/onSceneGraphUpdate",data:I})},setMatrix:function(D,C){if(!D){this._matrix=null}else{if(!this._matrix){this._matrix=new A.Matrix4().copy(D)}else{this._matrix.copy(D)}}this._updateMatrix(C)},applyMatrix:function(C){if(this._matrix){this._matrix.multiplyMatrices(C,this._matrix)}else{this._matrix=new A.Matrix4();this._matrix.copy(C)}this._updateMatrix()},setVisibilityInTree:function(C){if(this._getVisibilityInTree()===C){return}this._setVisibilityInTree(C);for(var D=0;D<this.parents.length;D++){var E={eventChannel:"/VISU/onSceneGraphUpdate",eventType:C?"ADDTREE":"REMOVETREE",fromNode:this.parents[D],toNode:this};o.publish({event:"/VISU/onSceneGraphUpdate",data:E})}},getVisibilityInTree:function(){return(this._getVisibilityInTree()!==undefined)?this._getVisibilityInTree():true},setIcon:function(C){if(C===""){this._iconInTree=""}else{this._iconInTree=C}var D={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"CHANGEICON",fromNode:this,toNode:null};o.publish({event:"/VISU/onSceneGraphUpdate",data:D})},getIcon:function(){return(this._iconInTree!==undefined)?this._iconInTree:""},setName:function(C){this.name=C;var D={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"CHANGENAME",fromNode:this,toNode:null};o.publish({event:"/VISU/onSceneGraphUpdate",data:D})},getName:function(){return this.name},getPickable:function(){if(this.getDrawInHLRender()){if(this._getPickable()){return g.PICKABLE}else{return g.NOPICKABLE}}return g.NODRAWHL},setPickable:function(G){var F,C,H,I,E,D;if(typeof G==="boolean"){console.log("boolean is DEPRECATED in setPickable() method.\n Use ENUM Mesh")}this._setPickable(G===g.PICKABLE);this.setDrawInHLRender(G!==g.NODRAWHL);F=this._occurrences.length;for(E=0;E<F;E++){H=this._occurrences[E];if(H.parent){H._setPickable(H.parent._getPickable()&&this._getPickable());H.setDrawInHLRender(H.parent.getDrawInHLRender()&&this.getDrawInHLRender())}else{H._setPickable(this._getPickable());H.setDrawInHLRender(this.getDrawInHLRender())}if(H.renderable!==null){H.renderable.pickable=H._getPickable();H.renderable.drawInHLRender=H.getDrawInHLRender()}}for(E=0;E<F;E++){H=this._occurrences[E];C=H.children.length;for(D=0;D<C;D++){I=H.children[D];this._updateOccurrences(H,I,false)}}},isPickable:function(){return this._getPickable()},setPickParent:function(C){this._setPickParent(C)},getPickParent:function(){if(this._getPickParent()){return true}else{return false}},setPickingPriorityId:function(D){var G,C,H,I,F,E;if(!this.pickingPriorityID){this.pickingPriorityID={faces:null,edges:null,points:null}}if(typeof D==="string"){this.pickingPriorityID.faces=D;this.pickingPriorityID.edges=D;this.pickingPriorityID.points=D}if(D.faces||(D.faces===null)){this.pickingPriorityID.faces=D.faces}if(D.edges||(D.edges===null)){this.pickingPriorityID.edges=D.edges}if(D.points||(D.points===null)){this.pickingPriorityID.points=D.points}G=this._occurrences.length;for(F=0;F<G;F++){H=this._occurrences[F];H.pickingPriorityID=this.pickingPriorityID;if(H.renderable!==null){H.renderable.pickingPriorityID=H.pickingPriorityID}}for(F=0;F<G;F++){H=this._occurrences[F];C=H.children.length;for(E=0;E<C;E++){I=H.children[E];this._updateOccurrences(H,I,false)}}},getPickingPriorityId:function(){return this.pickingPriorityID},exludeFromBounding:function(C){this.setExcludeFromBounding(C);this._invalidateBoundingElements(false,true)},translate:function(E,D){var C=new A.Vector3();if(this._matrix){D.transformDirection(this._matrix);C.getPositionFromMatrix(this._matrix)}C.add(D.multiplyScalar(E));if(!this._matrix){this._matrix=new A.Matrix4()}this._matrix.setPosition(C);this._updateMatrix()},translateX:function(D){var C=new A.Vector3(1,0,0);this.translate(D,C)},translateY:function(D){var C=new A.Vector3(0,1,0);this.translate(D,C)},translateZ:function(D){var C=new A.Vector3(0,0,1);this.translate(D,C)},getMaterial:function(D){var C=this._getMaterialApplication();if(!C){return this.material}if(!D||(D==="Face")){return C._material}else{if(D==="GeomFace"){return C._materialGeomFace}else{if(D==="Line"){return C._materialLine}else{if(D==="Point"){return C._materialPoint}}}}return C._material},isVisible:function(){return this._getVisible()},getMatrix:function(){return this._matrix?this._matrix.clone():new A.Matrix4()},getChildren:function(){return[].concat(this.children)},getParents:function(){return[].concat(this.parents)},getNodeType:function(){return"Node3D"},whiteVectorInBlack:function(){this.modifyColor(new A.Color(0),new A.Color(16777215))},modifyColor:function(K,I,D){if(this.getNodeType()==="Mesh3D"){var C=this._occurrences[0].renderable;var M=C.geometry;if(!(M instanceof Array)){return}for(var F=0;F<M.length;F++){var N=M[F];var O=N.drawingGroups;for(var H=0;H<O.length;H++){var L=O[H];if(L.gas&&L.gas.color){if(L.gas instanceof A.ParticleBasicMaterial){continue}var E=L.gas.color;if(D&&(D!==L.glType)){continue}if(E.equals(I)){var J=L.gas.clone();J.color=K;L.gas=J}}if(L.material&&L.material.color){if(L.material instanceof A.ParticleBasicMaterial){continue}var E=L.material.color;if(D&&(D!==L.glType)){continue}if(E.equals(I)){var G=L.material.clone();G.color=K;L.material=G}}}}}for(var H=0;H<this.children.length;H++){this.children[H].modifyColor(K,I,D)}},getBoundingSphere:function(E,D){if(E==="show"){console.warn("DEPRECATED: use visibleSpace instead of show");E="visibleSpace"}if(E==="noShow"){console.warn("DEPRECATED: use invisibleSpace instead of noShow");E="invisibleSpace"}var C=this._getBoundingSphere(E,D);if(C){return C.clone()}else{return null}},_getViewer:function(){if(this._occurrences.length>0&&this._occurrences[0].scene3js){return this._occurrences[0].scene3js.viewer}return null},_getAllOwningViewers:function(){var C=[];var D,E;for(D=0;D<this._occurrences.length;D++){if(this._occurrences[D].scene3js){E=this._occurrences[D].scene3js.viewer;if(E&&C.indexOf(E)<0){C.push(E)}}}return C},_tryOverridesUpdate:function(F){var G=F.getSceneGraphOverrideSetManager();G&&G._fullOccurrencesUpdate();var E=F?F.hasSceneGraphOverrideSet():null;var C;var D=this._occurrences;for(C=0;C<D.length;C++){D[C].traverseWithCondition(function(H){if(H.isOverridesUpdateRequested()){H.updateOverrideStatus(E);return null}else{if(H.doesADescendantNeedOverrideUpdate()){return true}else{return null}}});D[C].clearOverridesUpdateRequest()}},forceBoundingElements:function(E,C,G){function F(K){function J(N){if(!N){return null}var O=new A.Vector3(2*N.radius,2*N.radius,2*N.radius);var M=new A.Box3();M.setFromCenterAndSize(N.center,O);return M}function L(N){if(!N){return null}var M=new A.Vector3(0.5*(N.min.x+N.max.x),0.5*(N.min.y+N.max.y),0.5*(N.min.z+N.max.z));var O=M.distanceTo(N.max);var P=new A.Sphere();P.center=M;P.radius=O;return P}var I=null;if(K.sphere!==undefined||K.box!==undefined){I={sphere:K.sphere||L(K.box),box:K.box||J(K.sphere)}}return I}if(!E){if(this._getForceBoundingElements()){this._setForceBoundingElements(false);this._invalidateBoundingElements(false,false)}}else{C=C||{};G=G||{};var H=F(C),D=F(G);this.__forceBoundingElements(H,D)}},__forceBoundingElements:function(D,C){this._setForceBoundingElements(true);this._bsShow=D&&D.sphere;this._bsNoShow=C&&C.sphere;this._bbShow=D&&D.box;this._bbNoShow=C&&C.box;this._invalidateBoundingElements(false,false)},getBoundingBox:function(C){if(C==="show"){console.warn("DEPRECATED: use visibleSpace instead of show");C="visibleSpace"}if(C==="noShow"){console.warn("DEPRECATED: use invisibleSpace instead of noShow");C="invisibleSpace"}return this._getBoundingBox(C).clone()},_getBoundingSphere:function(G,E){G=G||"visibleSpace";var F=null;var D,C;if(this.getHasExplicitBE()){D=this.explicitBSphere;C=null}else{this._updateBoundingElements();D=this._bsShow;C=this._bsNoShow}if(this._getVisibilityFree()){if(this._getVisible()){F=D}else{F=null}}else{if(this._getVisible()){if(G==="visibleSpace"){F=D}else{F=C}}else{if(G==="visibleSpace"){F=null}else{F=x(D&&D.clone(),C,this.getRatio())}}}if(!F&&!E){F=new A.Sphere()}return F},_getBoundingBox:function(F){F=F||"visibleSpace";var E=null;var D,C;if(this.getHasExplicitBE()){D=this.explicitBBox;C=null}else{this._updateBoundingElements();D=this._bbShow;C=this._bbNoShow}if(this._getVisibilityFree()){if(this._getVisible()){E=D}else{E=null}}else{if(this._getVisible()){if(F==="visibleSpace"){E=D}else{E=C}}else{if(F==="visibleSpace"){E=null}else{E=y(D&&D.clone(),C)}}}if(!E){E=new A.Box3()}return E},_invalidateBoundingElements:function(D,E){if(!D){var F=0;for(F=0;F<this._occurrences.length;F++){this._occurrences[F]._invalidateBoundingElements(E)}}if(!this._getNeedBEUpdate()){this._setNeedBEUpdate(true);if(!this.getExcludeFromBounding()||E){var C=0;for(C=0;C<this.parents.length;C++){this.parents[C]._invalidateBoundingElements(true,false)}}}},_updateVisibilityFlag:function(){this._invalidateBoundingElements(false,false)},_updateVisibilityFreeFlag:function(){this._invalidateBoundingElements(false,false)},_updateShadowMapsIfNeeded:function(E){var D=this._getViewer();var C=E;if(D&&D.useShadowMap){if(C===undefined){C=true;this.traverse(function(F){if(F.getExcludeFromBounding()){C=false;return true}return false},undefined,true)}C=C&&!this.getExcludeFromBounding();if(C){D._updateShadowMaps()}}return C},_updateBoundingElements:function(C,E){var D;if(this._getNeedBEUpdate()){E=this._updateShadowMapsIfNeeded(E);if(!this._getForceBoundingElements()){for(D=0;D<this.children.length;D++){this.children[D]._updateBoundingElements(true,E)}this.updateBoundingElements_internal("_bsShow","_bsNoShow",x,"bSphere");this.updateBoundingElements_internal("_bbShow","_bbNoShow",y,"bBox")}if(!C){for(D=0;D<this._occurrences.length;D++){this._occurrences[D]._updateBoundingElements(true)}}this._setNeedBEUpdate(false)}},_areBoundingElementsIncludedInParent:function(E){var H=new A.Sphere();var G=new A.Box3();var D=this._matrix;function F(J,I){if(J&&!I){return false}if(!J){return true}H.copy(J);if(D){H.applyMatrix4(D)}if(I.containsSphere(H)){return true}return false}function C(J,I){if(J&&!I){return false}if(!J){return true}G.copy(J);if(D){G.applyMatrix4(D)}if(I.containsBox(G)){return true}return false}this._updateBoundingElements();return F(this._bsShow,E._bsShow)&&C(this._bbShow,E._bbShow)&&F(this._bsNoShow,E._bsNoShow)&&C(this._bbNoShow,E._bbNoShow)},updateBoundingElements_internal:function(J,L,E,G){if(this._getForceBoundingElements()){return}var F=null,I=null;if(this.children.length){var D=0,C;var H,K;for(D=0;D<this.children.length;D++){C=this.children[D];if(!C.getExcludeFromBounding()){H=C[J];K=C[L];if(C._getVisibilityFree()){if(C._getVisible()){F=E(F,H,C._matrix,C.getRatio());I=E(I,H,C._matrix,C.getRatio())}}else{if(C._getVisible()){F=E(F,H,C._matrix,C.getRatio());I=E(I,K,C._matrix,C.getRatio())}else{I=E(I,H,C._matrix,C.getRatio());I=E(I,K,C._matrix,C.getRatio())}}}}}else{if(this.getHasExplicitBE()){F=this[G];I=null}}this[J]=F;this[L]=I},getRatio:function(){return 0},updateBoundingSphere:function(){this._invalidateBoundingElements(false,false)},updateBoundingSphereFromParentToChildren:function(){k.DEPRECATED_Method(new Error())},updateBoundingBox:function(){this._invalidateBoundingElements(false,false)},isIncludedIn:function(D){if(!this.bSphere.radius){return true}var C=this.bSphere.clone();if(this._matrix){C.applyMatrix4(this._matrix)}return(C.center.distanceTo(D.bSphere.center)+C.radius<=D.bSphere.radius)},getMatrixWorld:function(F){var E,C;if(this._occurrences.length===1){return this._occurrences[0].matrix?this._occurrences[0].matrix.clone():new A.Matrix4()}if(F===undefined){console.warn("This node is an instance. An occurrence path has to be specified.");return null}if(F instanceof p){var D=new s();D.setFromOccurrencePath(F);F=D}C=F._getOccurrences();if(C.length>1){console.warn("More than one occurrence satisfies this occurrence path. Unable to return a unique matrixWorld.");return null}if(!C.length){console.warn("No occurrence satisfies this occurrence path. Unable to return a matrixWorld.");return null}for(E=0;E<this._occurrences.length;E++){if(C[0]===this._occurrences[E]){return C[0].matrix?C[0].matrix.clone():new A.Matrix4()}}console.warn("The occurrence path has to terminate with the current node name. Unable to return a matrixWorld.");return null},isInstance:function(){return(this._occurrences.length>1)},setScene:function(I){var F,C,G,H,E,D;F=this._occurrences.length;for(E=0;E<F;E++){G=this._occurrences[E];G.scene3js=I}for(E=0;E<F;E++){G=this._occurrences[E];C=G.children.length;for(D=0;D<C;D++){H=G.children[D];this._updateOccurrences(G,H,true)}}},subscribe:function(D,C){if(this.modelEvents===undefined){this.modelEvents=new l()}this.modelEvents.subscribe(D,C)},isReady:function(){return true},_updateMatrix:function(E){var H,C,I,J,G,F,D;H=this._occurrences.length;for(G=0;G<H;G++){I=this._occurrences[G];I.updateMatrix(this._matrix);if(I.renderable!==null){I.renderable.setMatrix(I.matrix,false);I.renderable.orientation=(!I.matrix||(I.matrix.determinant()>0))?1:-1;if((I.renderable.highlight!==undefined)&&(I.renderable.highlight!==null)){I.renderable.highlight.setMatrix(I.matrix,false)}if((I.renderable.preHighlight!==undefined)&&(I.renderable.preHighlight!==null)){I.renderable.preHighlight.setMatrix(I.matrix,false)}}}for(G=0;G<H;G++){I=this._occurrences[G];C=I.children.length;for(F=0;F<C;F++){J=I.children[F];this._updateOccurrences(I,J,true,E)}}if(!E){for(G=0,D=this.parents.length;G<D;G++){if(!this.getExcludeFromBounding()){this.parents[G]._invalidateBoundingElements(false,false)}}}},_copyTree:function(G){var F,D,C,H,E;F=G.lightCopy();G.node._occurrences.push(F);G._invalidateBoundingElements(false);C=G.children.length;for(E=0;E<C;E++){H=G.children[E];D=this._copyTree(H);D.parent=F;F.children.push(D);F._invalidateBoundingElements(false)}return F},_deleteTree:function(G){var F,D,E,C,H;F=G.node;D=F._occurrences.indexOf(G);if(D!==-1){F._occurrences.splice(D,1)}if((G.renderable!==null)&&(G.scene3js!==null)){if(G.node.getNodeType()==="Mesh3D"||G.node.getNodeType()==="ParticlesNode3D"){if(G.scene3js.containsObject(G.renderable)){this._removeFromVisuSelection(G.renderable);G.scene3js.remove(G.renderable);if(G.node.getNodeType()==="Mesh3D"){G.renderable.releaseVBO()}}}else{if(G.node.getNodeType()==="LightNode3D"){if(G.scene3js.containsLight(G.renderable)){G.scene3js.remove(G.renderable)}}else{if(G.node.getNodeType()==="LensFlareNode3D"){if(G.scene3js.containsLensFlare(G.renderable)){G.scene3js.remove(G.renderable)}}else{if(G.node.getNodeType()==="CSS2DNode"||G.node.getNodeType()==="CSS3DNode"){if(G.scene3js.containsObject(G.renderable)){G.scene3js.remove(G.renderable);G.renderable.element.parentNode.removeChild(G.renderable.element)}}}}}}var I=G.scene3js&&G.scene3js.viewer;if(I&&I._sceneGraphStateVersion===2){if(G.originalOverrideSet){G.originalOverrideSet.onDetach(I);G.originalOverrideSet=null}G.overrideLink=null}G.scene3js=null;C=G.children.length;for(E=0;E<C;E++){H=G.children[E];this._deleteTree(H)}},forceUpdate:function(){this._forceUpdate()},_forceUpdate:function(){var E,D,F,G;var C=this._getAllOwningViewers();for(E=0;E<C.length;E++){if(C[E]){this._tryOverridesUpdate(C[E])}}if(this.parents.length>0){for(E=0;E<this._occurrences.length;E++){F=this._occurrences[E];this._updateOccurrences(F.parent,F,true)}}else{for(E=0;E<this.children.length;E++){this.children[E]._forceUpdate()}}},onLinkToSceneGraph:function(G){var C=G.traverseUnique(function(K){});var H=[];var F=[];var I,E;for(I=0;I<C.length;I++){E=C[I];E._occurrences[0].__rdo_visited=0}for(I=0;I<C.length;I++){var D,J;E=C[I];for(D=0;D<E.children.length;D++){J=E.children[D];J._occurrences[0].__rdo_visited++}}G._onLinkToSceneGraph_internal(true,H,F);for(I=0;I<C.length;I++){var D,J;E=C[I];E._occurrences[0].__rdo_visited=0}for(I=H.length-1;I>=0;I--){E=H[I];E._onLinkedToSceneGraph();if(E.clipPolyLine){n.addNode(E)}}for(I=F.length-1;I>=0;I--){E=F[I];E._onUnlinkedToSceneGraph();if(E.clipPolyLine){n.removeNode(E)}}if(k._onLinkToSceneGraph_DEBUG!==null){k._onLinkToSceneGraph_DEBUG(C,H,F)}},_onLinkToSceneGraph_internal:function(C,I,G){var H=false,E;var D=C,F;for(E=0;!D&&E<this.parents.length;E++){F=this.parents[E];if(F._occurrences.length>0&&F._occurrences[0].__rdo_visited===-1){D=true}}if(D){for(E=0;E<this.parents.length;E++){if(this.parents[E].getLinkedToSceneGraph()){H=true;break}}var J;if(this.getLinkedToSceneGraph()!==H){this.setLinkedToSceneGraph(H);this._occurrences[0].__rdo_visited=-1;if(H){I.push(this)}else{G.push(this)}}for(E=0;E<this.children.length;E++){J=this.children[E];J._occurrences[0].__rdo_visited--;if(J._occurrences[0].__rdo_visited===0){J._onLinkToSceneGraph_internal(false,I,G)}}}},_propagateGAS:function(C,D){if(D){if(C.gas){C.gas.copy(D)}else{C.gas=D.clone()}}else{C.gas=null}},_propagateMatApp:function(C,D){if(D){if(C.matApp){C.matApp.copy(D)}else{C.matApp=D.clone()}}else{C.matApp=null}},_updateOccurrences:function(ac,E,N,Y){var V,L,ao,al,ad;V=ac.node;L=E.node;ao=E.scene3js;var ah=null;var ap=null;var aq=null;var an=null;var P=null;var aa=null;var J=false;var W=false,U=false;if(E.overrideLink){if(E.renderable){if(E.overrideLink.internalMaterialOverrideReset){E.overrideLink.internalMaterialOverrideReset=false;E.renderable.layer=null}if(E.overrideLink.internalMaterialOverride&&E.originalOverrideSet){var T=E.overrideLink.internalMaterialOverride;if(T.material){ad=new s();ad.setFromArray(E.originalOverrideSet.pathElement.externalPath,T.internalPath);k._applyMaterialToPath(ad,T.material)}E.overrideLink.internalMaterialOverrideReset=true}}ah=E.overrideLink.getSubstituteMatrix();ap=E.overrideLink.getVisibility();P=E.overrideLink.getVisibilityFree();aq=E.overrideLink.getPickability();an=E.overrideLink.getClipping();aa=E.overrideLink.getRenderStyle();W=E.overrideLink.visibilityFix;if(E.originalOverrideSet){if(E.originalOverrideSet.invalidateBE){E.originalOverrideSet.unsetInvalidateBE();J=true}}if(E.overrideLink.getMatrixUpdate()){E.overrideLink.clearMatrixUpdate();U=true}}var F=null;if(E&&E.originalOverrideSet&&(E.originalOverrideSet.hasMaterialOverride()||E.originalOverrideSet.internalMaterialOverride)){F=E.overrideLink}if(E!==null){E.scene3js=ac.scene3js;if(N||U){if(ah){E.updateMatrix(ah,true)}else{ah=L._matrix;if(L._isDynamic&&E.scene3js){var R=E.scene3js.viewer.currentViewpoint;if(R){var ai=L._getDynamicMatrix(ac.matrix,null,R);if(ai){ah=ai;if(!L._matrix){L._matrix=new A.Matrix4()}L._matrix.copy(ah);if(!Y){L._invalidateBoundingElements(false,false)}}}}if(E.localMatrixOverride){J=true}if(E._relativeMatrix){ah=new A.Matrix4();ah.multiplyMatrices(ah,E._relativeMatrix)}E.updateMatrix(ah)}}var Z=ac.getViewer();E.renderMode=(aa&&aa._renderMode)||L._renderMode||ac.renderMode;var D=aa||(Z&&Z._renderStyle);E.faceMode=(D&&D._faceMode)||ac.faceMode;var S=L.passes?L.passes:ac.passes;var Q=E.scene3js&&E.scene3js.parent instanceof A.Scene?E.scene3js.parent:null;if(E.renderable&&E.renderable.fromLoadedModel){if(E.faceMode===c.FaceModes.ZONLY){S=["ZOnly"]}else{if(E.faceMode===c.FaceModes.BACKGROUND){S=["background"]}}}var ae=S;var G=null;if(E.renderPriority||ac.renderPriority){G=b(ac.renderPriority,E.renderPriority)}var C=Z&&Z._renderPriorityManager&&Z._renderPriorityManager.enabled;E.renderPriority=G;var I=-1;if(C){if(!G){G=w();E.renderPriority=G}I=(G&&G.priority)||0;ae=u(S,I)}var ag=ae!==E.passes||(E.renderPriority&&I!==E.renderPriority.lastRenderPriority);if(E.renderPriority){E.renderPriority.lastRenderPriority=I}if(E.renderable&&Q&&ag){Q.updateObjectPasses(E.renderable,ae)}E.passes=S;if(ac.material&&ac.material.force==="forceGeomTypeFACE"){E.material=L.material||ac.material}else{E.material=(ac.material!==null)?ac.material:L.material}if(ac.gas&&!L._gas){this._propagateGAS(E,ac.gas)}else{this._propagateGAS(E,L._gas)}if(ac.gas&&L._gas){E.gas.merge(ac.gas)}var af=L._getMaterialApplication();if(af&&ac.matApp){if((af._inheritance!==0)&&((af._layer<ac.matApp._layer)||((af._layer===ac.matApp._layer)&&((af._layer<A.MaterialLayerMax)||(af._inheritance===2||(af._inheritance===1&&ac.matApp._inheritance===0)))))){this._propagateMatApp(E,af)}else{this._propagateMatApp(E,ac.matApp)}}else{if(af){this._propagateMatApp(E,af)}else{this._propagateMatApp(E,ac.matApp)}}var K=E._getVisible();var X=E._getVisibilityFree();if(W){E._setVisible(ac._getVisible()&&(ap?ap.visibility:L._getVisible()));E._setVisibilityFree(ac._getVisibilityFree()||(P?P.visibilityFree:L._getVisibilityFree()));E._setPickable(ac._getPickable()&&(aq?aq==="PICKABLE":L._getPickable()));E.setDrawInHLRender(ac.getDrawInHLRender()&&(aq?aq!=="IGNORED":L.getDrawInHLRender()))}else{E._setVisible(ap?ap.visibility:(ac._getVisible()&&L._getVisible()));E._setVisibilityFree(ac._getVisibilityFree()||L._getVisibilityFree());E._setPickable(aq?aq==="PICKABLE":(ac._getPickable()&&L._getPickable()));E.setDrawInHLRender(aq?aq!=="IGNORED":(ac.getDrawInHLRender()&&L.getDrawInHLRender()))}if(E._getVisible()!==K){E.updateVisibilityFlag()}if(E._getVisibilityFree()!==X){E.updateVisibilityFreeFlag()}E.pickingPriorityID=L.pickingPriorityID?L.pickingPriorityID:ac.pickingPriorityID}if(E.renderable!==null){E.renderable._gsso_cache=null;E.renderable.setMatrix(E.matrix,false);E.renderable._ratioData=L._ratioData;E.renderable.orientation=(!E.matrix||(E.matrix.determinant()>0))?1:-1;if((E.renderable.highlight!==undefined)&&(E.renderable.highlight!==null)){E.renderable.highlight.setMatrix(E.matrix,false);E.renderable.highlight.visible=E._getVisible();E.renderable.highlight.visibilityFree=E._getVisibilityFree();E.renderable.highlight._ratioData=L._ratioData}if((E.renderable.preHighlight!==undefined)&&(E.renderable.preHighlight!==null)){E.renderable.preHighlight.setMatrix(E.matrix,false);E.renderable.preHighlight.visible=E._getVisible();E.renderable.preHighlight.visibilityFree=E._getVisibilityFree();E.renderable.preHighlight._ratioData=L._ratioData}if(E.renderable instanceof A.CSS2DNode||E.renderable instanceof A.CSS3DNode){var ab=true;if(this._getViewer()){ab=this._getViewer().visibleSpace}var H=true;if(E._getVisibilityFree()){H=E._getVisible()}else{H=ab?E._getVisible():!E._getVisible()}if(!H){E.renderable.element.style.display="none"}}if(A.disableJHGDev){if(E.material!==null){E.renderable.material=E.material}}else{if(!E.material&&E.renderable._3dxmlMaterial){E.renderable.material=E.renderable._3dxmlMaterial}else{var aj=E.renderable.material;if(!aj||!aj.canvasNodeTextureSize){E.renderable.material=E.material}}}E.renderable.matApp=E.matApp;E.renderable.gas=E.gas;E.renderable.visible=E._getVisible();E.renderable.visibilityFree=E._getVisibilityFree();E.renderable.pickable=E._getPickable();E.renderable.drawInHLRender=E.getDrawInHLRender();E.renderable.pickingPriorityID=E.pickingPriorityID;if(E.scene3js!==null){if(E.node.getNodeType()==="Mesh3D"||E.node.getNodeType()==="ParticlesNode3D"||E.node.getNodeType()==="CSS3DNode"||E.node.getNodeType()==="CSS2DNode"){if(!E.scene3js.containsObject(E.renderable)){E.scene3js.add(E.renderable,E.passes);if(E.node.getNodeType()==="Mesh3D"){E.renderable.addRefVBO()}}}else{if(E.node.getNodeType()==="LightNode3D"){if(!E.scene3js.containsLight(E.renderable)){E.scene3js.add(E.renderable)}}else{if(E.node.getNodeType()==="LensFlareNode3D"){if(!E.scene3js.containsLensFlare(E.renderable)){E.scene3js.add(E.renderable)}}}}if(E.scene3js.viewer){if(!E.scene3js.viewer._lockRenderIteration){E.scene3js.viewer.renderIteration=0}if(E.renderable.castShadow){for(var ak=0;ak<E.scene3js.parent.__lights.length;ak++){var O=E.scene3js.parent.__lights[ak];if(!O.blockUpdate){O.updateShadowMap=true}}}}}else{if(ao!==null){if(E.node.getNodeType()==="Mesh3D"||E.node.getNodeType()==="ParticlesNode3D"){if(ao.containsObject(E.renderable)){this._removeFromVisuSelection(E.renderable);ao.remove(E.renderable);if(E.node.getNodeType()==="Mesh3D"){E.renderable.releaseVBO()}}}else{if(E.node.getNodeType()==="LightNode3D"){if(ao.containsLight(E.renderable)){ao.remove(E.renderable)}}else{if(E.node.getNodeType()==="LensFlareNode3D"){if(ao.containsLensFlare(E.renderable)){ao.remove(E.renderable)}}else{if(E.node.getNodeType()==="CSS2DNode"||E.node.getNodeType()==="CSS3DNode"){if(ao.containsObject(E.renderable)){ao.remove(E.renderable);E.renderable.element.parentNode.removeChild(E.renderable.element)}}}}}}}}var am=false;var M=an||L.clippingContext;E.clippingContext=M?M._mergeWithParent(ac.clippingContext):ac.clippingContext;if(E.clippingContext!==ac.clippingContext){am=true}if(E.renderPriority!==ac.renderPriority){am=true}if(F){if(!ac.occurrenceRenderingOverride||!ac.occurrenceRenderingOverride.materialOverride||ac.occurrenceRenderingOverride.materialOverride!==F){am=true}}if(am){E.occurrenceRenderingOverride=new z();E.occurrenceRenderingOverride.clipPlanes=E.clippingContext&&E.clippingContext.planes;E.occurrenceRenderingOverride.sectionLinesProperties=E.clippingContext&&E.clippingContext.sectionLinesProperties;E.occurrenceRenderingOverride.sectionCappingMaterials=E.clippingContext&&E.clippingContext.sectionCappingMaterials;E.occurrenceRenderingOverride.materialOverride=F||(ac.occurrenceRenderingOverride&&ac.occurrenceRenderingOverride.materialOverride);E.occurrenceRenderingOverride.clippingSettings=E.clippingContext&&E.clippingContext.clippingSettings;E.occurrenceRenderingOverride.setRenderPriority(E.renderPriority)}else{E.occurrenceRenderingOverride=ac.occurrenceRenderingOverride}if(E.node._updateOccurrenceRenderingOverride){E.occurrenceRenderingOverride=E.node._updateOccurrenceRenderingOverride(E.occurrenceRenderingOverride);if(E.occurrenceRenderingOverride){E.occurrenceRenderingOverride.setReadOnly()}}if(E.renderable){E.renderable.occurrenceRenderingOverride=E.occurrenceRenderingOverride;if(E.renderable.highlight){E.renderable.highlight.occurrenceRenderingOverride=E.occurrenceRenderingOverride}}for(al=0;al<E.children.length;al++){this._updateOccurrences(E,E.children[al],N||U)}if(J){ac._invalidateBoundingElements(false)}return true},_getOccurrencesFromOccurrencePath:function(J){var F,I,C,E,D,M,L,K,H,G;if(!J.path.length){return[]}F=this.getChildByName(J.path[0]);if(F===null){F=this.getChildByName(J.path[0],1)}if(F===null){return[]}M=F._occurrences;L=[];for(G=1;G<J.path.length;G++){C=J.path[G];for(K=0;K<M.length;K++){I=M[K];E=I.children;for(H=0;H<E.length;H++){D=E[H];if(D.node.name===C){L.push(D)}}}M=L;L=[]}return M},_getRenderableOccurrencesFromOccurrencePath:function(D){var C,H,F,I,G,E;C=this._getOccurrencesFromOccurrencePath(D);H=[];for(G=0;G<C.length;G++){I=C[G];F=this._getRenderableOccurrencesFromOccurrence(I);for(E=0;E<F.length;E++){H.push(F[E])}}return H},_getRenderableOccurrencesFromOccurrence:function(H){var G,F,D,E,C;G=[];F=H.children;if(H.renderable!==null){G.push(H.renderable)}for(E=0;E<F.length;E++){D=this._getRenderableOccurrencesFromOccurrence(F[E]);for(C=0;C<D.length;C++){G.push(D[C])}}return G},_removeFromVisuSelection:function(C){o.publish({event:"/VISU/SELECTION/REMOVE",data:C})},_removeInvalidElementsInXSO:function(E){var K,J;var N=this;var O=WUX.Selection.CSOManager;var P=WUX.Selection.HSOManager;var L=WUX.Selection.PSOManager;var I=[O,P,L];for(K=0;K<I.length;K++){var H=I[K];var G=[];var D=H.get();for(J=0;J<D.length;J++){var F=D[J];var Q=F.pathElement;if(!Q&&F.options){Q=F.options.pathElement}if(!Q){continue}var M=Q._getIndexFromNode(this);if(M===-1){var C=Q.getElement(0,true)}else{if(Q.getElement(M+1,true)===E){G.push(F)}}}for(J=0;J<G.length;J++){H.remove(G[J])}}},addAsyncDependancies:function(C){console.warn("The addAsyncDependancies function doesn't do anything anymore: it shouldn't be called anymore.")},onAsyncDependancyCompleted:function(){this._onAllAsyncDependanciesCompleted()},_onAllAsyncDependanciesCompleted:function(){if(this.modelEvents!==undefined){this.modelEvents.publish("onReady")}},_onLinkedToSceneGraph:function(){},_onUnlinkedToSceneGraph:function(){},setNoZ:function(C){this.setRenderPasses(C?["noz"]:["main"])},setNoHighlightNoZ:function(C){this.setRenderPasses(C?["afterHighlightNoZ"]:["main"])},setRenderPasses:function(E){var F=E.concat([]);var D;for(D=0;D<E.length;D++){if(E[D]&&E[D]._getIdString){F[D]=E[D]._getIdString()}}E=F;var C=E;if(E.length===4&&E.indexOf("colorOld")>=0&&E.indexOf("depthOld")>=0&&E.indexOf("colorOldCapping")>=0&&E.indexOf("depthOldCapping")>=0){C=["compareOld"]}if(E.length===2&&E.indexOf("depthNew")>=0&&E.indexOf("depthNewCapping")>=0){C=["compareNew"]}this.passes=C;this._forceUpdate()},setRenderLineMode:function(D){var C=this._renderMode;if(!C){C=new j();C._useRenderPointMask=false;C._useRenderFaceMask=false;this._renderMode=C}C._setRenderLineMode(D);this._requestOverridesUpdate()},enableLocalRenderEdgeMode:function(C){var D=null;if(C){D=new j({renderLineMode:A.HideAllRenderLineMode});D._useRenderFaceMask=false;D._useRenderPointMask=false}this._renderMode=D;this._requestOverridesUpdate()},setRenderMode:function(D,C){if(!D||D.indexOf("Edge")<0){return}if(this._renderMode){this._renderMode.setRenderMode(D,C);this._requestOverridesUpdate()}},getLocalBoundingBox:function(){var E=new A.Matrix4();var O=new A.Matrix4();var P=new A.Vector3();var I=null;var N=null;var H=this._occurrences[0];var K=H.matrix;E.getInverse(K);var J=H._getRenderableOccurrences();for(var G=0;G<J.length;G++){var Q=J[G];O.multiplyMatrices(E,Q.matrix);for(var F=0;F<Q.geometry.length;F++){var M=Q.geometry[F];var L=M.vertexPositionArray;if(L){var D=L.length;if(D>=3){if(!I){P.set(L[0],L[1],L[2]);P.applyMatrix4(O);I=new A.Vector3().copy(P);N=new A.Vector3().copy(P)}for(var C=0;C<D;C+=3){P.set(L[C],L[C+1],L[C+2]);P.applyMatrix4(O);if(P.x<I.x){I.x=P.x}if(P.y<I.y){I.y=P.y}if(P.z<I.z){I.z=P.z}if(P.x>N.x){N.x=P.x}if(P.y>N.y){N.y=P.y}if(P.z>N.z){N.z=P.z}}}}}}return new A.Box3(I,N)},enableClippingPlane:function(E,D){var F,G;var C;if(D){if(!this.clippingContext){this.clippingContext=new h()}if(this.clippingContext.addPlane(E)){this._forceUpdate();C=this._getAllOwningViewers();for(F=0;F<C.length;F++){G=C[F];G._addClippingPlane(E)}}}else{if(this.clippingContext&&this.clippingContext.removePlane(E)){this._forceUpdate();C=this._getAllOwningViewers();for(F=0;F<C.length;F++){G=C[F];G._removeClippingPlane(E)}}}},setSectionCappingMaterial:function(D,C){if(!this.clippingContext){this.clippingContext=new h()}this.clippingContext.setSectionCappingMaterial(D,C);this.requestOverridesUpdate()},deleteSectionCappingMaterial:function(D){if(!this.sectionCappingMaterials){return}var C=D||null;var E=0;for(E=0;E<this.sectionCappingMaterials.length;E++){if(this.sectionCappingMaterials[E].clippingPlane===C){this.sectionCappingMaterials.splice(E,1)}}if(!this.sectionCappingMaterials.length){this.sectionCappingMaterials=null}},getSectionCappingMaterial:function(C){return this.clippingContext&&this.clippingContext.getSectionCappingMaterial(C)},removeSectionCappingMaterial:function(C){this.clippingContext&&this.clippingContext.removeSectionCappingMaterial(C)},requestOverridesUpdate:function(){var C=0;for(C=0;C<this._occurrences.length;C++){this._occurrences[C].requestOverridesUpdate()}},createRenderable:function(){return null},add:function(){this.addChild.apply(this,arguments)},remove:function(){this.removeChild.apply(this,arguments)},_requestOverridesUpdate:function(){var C;for(C=0;C<this._occurrences.length;C++){this._occurrences[C].requestOverridesUpdate()}},setClippingProfile:function(H){if(H){this.clipPolyLine={};this.clipPolyLine.planeOrigin=H.planeOrigin;this.clipPolyLine.planeU=H.planeU.clone();this.clipPolyLine.planeU.normalize();this.clipPolyLine.planeV=H.planeV.clone();this.clipPolyLine.planeV.normalize();var G=H.polyLinePoints.length;this.clipPolyLine.polyLineSize=G;var E=this.clipPolyLine.planeOrigin.dot(this.clipPolyLine.planeU);var C=this.clipPolyLine.planeOrigin.dot(this.clipPolyLine.planeV);var D=new Float32Array(G*4);var F;for(F=0;F<G;F++){D[4*F]=H.polyLinePoints[F].x+E;D[4*F+1]=H.polyLinePoints[F].y+C;D[4*F+2]=0;D[4*F+3]=1}this.clipPolyLine.clippingPolygonTexture=new A.DataTexture(D,G,1,A.RGBAFormat,A.FloatType,undefined,A.ClampToEdgeWrapping,A.ClampToEdgeWrapping,A.NearestFilter,A.NearestFilter);this.clipPolyLine.clippingPolygonTexture.needsUpdate=true;if(this.getLinkedToSceneGraph()){n.addNode(this)}}else{this.clipPolyLine=null}n.updateNode(this);var F;for(F=0;F<this._occurrences.length;F++){this._occurrences[F].requestOverridesUpdate()}},isPointOfViewDependant:function(){return false},_updateOccurrenceRenderingOverride:function(C){var D=C;if(this.clipPolyLine!==null){if(!D&&!this.clipPolyLine){return null}if(!D){D=new z()}if(D.clipPolyLine!=this.clipPolyLine){if(D.readOnly){D=D.clone()}D.clipPolyLine=this.clipPolyLine}}return D},setLocalRenderEdgeMode:function(){this.setRenderMode.apply(this,arguments)},setUserData:function(C){this.userData=C},getUserData:function(C){return this.userData}});var a=0;k._LockNodeHierarchy=function(){a++};k._UnlockNodeHierarchy=function(){a--};k._applyMaterialToPath=function(K,I){if(K===null){return false}var H=K._getRenderableOccurrences();var D=H.length;var G,C;for(G=0;G<D;G++){C=H[G];if(C){C._gsso_cache=null}}var E=K.getLastElement();if(E===null){return false}if(E instanceof k){for(var G=0;G<D;G++){var C=H[G];if(I!==null){if(!C.userData.oldMaterial){C.userData.oldMaterial=C.material}C.material=I}else{if(C.userData.oldMaterial){C.material=C.userData.oldMaterial}}}}else{if(D!==1){return false}var J=[];if(E.getType()==="rep"){var F=E.getChildren();for(var G=0;G<F.length;G++){J.push(F[G].sgNode)}}else{if(E.getType()==="primitive"){J.push(E.sgNode)}}if(H[0].layer===null){H[0].initLayers(1)}H[0].layer.addPrimitivesToLayers(J,1,I)}return true};k.DEPRECATED_SceneGraph=function(D,C){if(d!==0){console.log("[SceneGraph] DEPRECATED API USE\n"+D.stack);d--}if(!window.I_solemnly_swear_I_am_up_to_no_good&&!C){throw D}};k.DEPRECATED_Method=function(D,C){if(d!==0){console.log("[Node3D] DEPRECATED API USE\n"+D.stack);d--}};k.DEPRECATED_matrix=function(C){if(d!==0){console.warn("Node3D API : use getMatrix() accessor instead of .matrix  "+C.stack);d--;if(!d){console.warn("Node3D API : too many errors, no more errors will be reported.")}}};Object.defineProperty(k.prototype,"root",{get:function(){k.DEPRECATED_SceneGraph(new Error());return this}});Object.defineProperty(k.prototype,"bSphere",{get:function(){if(this.getHasExplicitBE()){return this.explicitBSphere}else{return this.getBoundingSphere()}},set:function(C){if(this.getHasExplicitBE()){this.explicitBSphere=C}else{throw new Error("bSphere is read-only")}}});Object.defineProperty(k.prototype,"bBox",{get:function(){if(this.getHasExplicitBE()||this.hasExplicitBE){return this.explicitBBox}else{return this.getBoundingBox()}},set:function(C){if(this.getHasExplicitBE()||this.hasExplicitBE){this.explicitBBox=C}else{throw new Error("bBox is read-only")}}});function x(G,E,D,F){if(E&&!E.isNaN()){var C=E.clone();if(F){C._updateRatio(F)}if(D){C.applyMatrix4(D)}if(!G){G=C}else{G.mergeWithSphere(C,G)}}return G}function y(G,E,C,D){if(E&&!E.isNaN()){var F=E.clone();if(D){F.max=new A.Vector3(0,0,0);F.min=new A.Vector3(0,0,0)}if(C){F.applyMatrix4(C)}if(!G){G=F}else{G.mergeWithBox(F)}}return G}Object.defineProperty(k.prototype,"matrix",{get:function(){k.DEPRECATED_matrix(new Error());return this._matrix},set:function(C){k.DEPRECATED_matrix(new Error());this._matrix=C}});var r=30;k.FORBIDDEN_ACCESS_occurrences=function(C){if(r!==0){console.log("[Node3D] INTERNAL PROPERTY ACCESS\nAccess to 'occurrences' member is strictly forbidden.\nYou must use authorized APIs.\nIf you are trying to create a pathElement using setFromOccurrence, please consider using ?new PathElement([node3d])? instead.\n"+C.stack);r--}};Object.defineProperty(k.prototype,"occurrences",{get:function(){k.FORBIDDEN_ACCESS_occurrences(new Error());return this._occurrences},set:function(C){k.FORBIDDEN_ACCESS_occurrences(new Error());this._occurrences=C}});Object.defineProperty(k.prototype,"clippingPlanes",{get:function(){return this.clippingContext&&this.clippingContext.planes},set:function(){}});function b(D,E){var C;if(!E){if(D&&(D.userPriority||D.userOpacity)){C={userPriority:false,priority:D.priority,userOpacity:false,opacity:D.opacity,lastRenderPriority:D.lastRenderPriority};return C}return{userPriority:D.userPriority,priority:D.priority,userOpacity:D.userOpacity,opacity:D.opacity,lastRenderPriority:D.lastRenderPriority}}if(!D){return{userPriority:E.userPriority,priority:E.priority,userOpacity:E.userOpacity,opacity:E.opacity,lastRenderPriority:E.lastRenderPriority}}C={userPriority:E.userPriority,priority:E.userPriority?E.priority:D.priority,userOpacity:E.userOpacity,opacity:E.userOpacity?E.opacity:D.opacity,lastRenderPriority:E.lastRenderPriority};return C}function w(){return{userPriority:false,priority:0,userOpacity:false,opacity:-1,lastRenderPriority:-1}}var e=[["renderPriority","p0"],["renderPriority","p1"],["renderPriority","p2"],["renderPriority","p3"],["renderPriority","p4"]];k.REFERENCE_NODE=-1;k.INSTANCE_NODE=-2;k.REPRESENTATION_NODE=-3;k._onLinkToSceneGraph_DEBUG=null;function u(F,E){if(!F||(F.length===1&&F[0]==="main")){return e[E]}else{var G=[],C,D;for(C=0;C<F.length;C++){D=F[C];if(D==="main"){G=G.concat(e[E])}else{G.push(D)}}return G}}t.prototype._getVisible=function(){return this.visible};t.prototype._setVisible=function(C){this.visible=C};t.prototype._getVisibilityFree=function(){return this.visibilityFree};t.prototype._setVisibilityFree=function(C){this.visibilityFree=C};t.prototype._getPickable=function(){return this.pickable};t.prototype._setPickable=function(C){this.pickable=C};t.prototype.getDrawInHLRender=function(){return this.drawInHLRender};t.prototype.setDrawInHLRender=function(C){this.drawInHLRender=C};t.prototype._getNeedBEUpdate=function(){return this._needBEUpdate};t.prototype._setNeedBEUpdate=function(C){this._needBEUpdate=C};t.prototype._getNeedOverridesUpdate=function(){return this._needOverridesUpdate};t.prototype._setNeedOverridesUpdate=function(C){this._needOverridesUpdate=C};t.prototype._getDescendantNeedsOverridesUpdate=function(){return this._descendantNeedsOverridesUpdate};t.prototype._setDescendantNeedsOverridesUpdate=function(C){this._descendantNeedsOverridesUpdate=C};k.prototype.getLinkedToSceneGraph=function(){return this.linkedToSceneGraph};k.prototype.setLinkedToSceneGraph=function(C){this.linkedToSceneGraph=C};k.prototype._getForceBoundingElements=function(){return this._forceBoundingElements};k.prototype._setForceBoundingElements=function(C){this._forceBoundingElements=C};k.prototype.getExcludeFromBounding=function(){return this.excludeFromBounding};k.prototype.setExcludeFromBounding=function(C){this.excludeFromBounding=C};k.prototype._getNeedBEUpdate=function(){return this._needBEUpdate};k.prototype._setNeedBEUpdate=function(C){this._needBEUpdate=C};k.prototype._getVisible=function(){return this.visible};k.prototype._setVisible=function(C){this.visible=C};k.prototype._getVisibilityFree=function(){return this.visibilityFree};k.prototype._setVisibilityFree=function(C){this.visibilityFree=C};k.prototype._getPickable=function(){return this.pickable};k.prototype._setPickable=function(C){this.pickable=C};k.prototype.getDrawInHLRender=function(){return this.drawInHLRender};k.prototype.setDrawInHLRender=function(C){this.drawInHLRender=C};k.prototype._getPickParent=function(){return this.pickParent};k.prototype._setPickParent=function(C){this.pickParent=C};k.prototype._getTreeModified=function(){return this._treeModified};k.prototype.__setTreeModified=function(C){this._treeModified=C};k.prototype.getNotAllowedInPathElement=function(){return this.notAllowedInPathElement};k.prototype.setNotAllowedInPathElement=function(C){this.notAllowedInPathElement=C};k.prototype._getVisibilityInTree=function(){return this._visibilityInTree};k.prototype._setVisibilityInTree=function(C){this._visibilityInTree=C};k.prototype.getIsManipulator=function(){return this.isManipulator};k.prototype.setIsManipulator=function(C){this.isManipulator=C};k.prototype.getHasExplicitBE=function(){return false};return UWA.namespace("THREEDS/Nodes/Node3D",k)});define("Visualization/Node3D",["DS/Visualization/Node3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/Node3D");return b});define("DS/Visualization/OccurrenceExplorer",["UWA/Class","DS/Visualization/OccurrenceInterface","DS/Visualization/Node3D","DS/Visualization/OccurrenceInterfaceFactory"],function(b,c,e,d){var a=b.extend({init:function(g){this.viewer=g},explore:function(g){if(!g){return}this._exploreInternal(null,g)},exploreQuick:function(h,g){if(!h||!g){return}this._exploreInternal(h,g)},_exploreInternal:function(k,j){var l=new f();var g=new d(l,this.viewer);e._LockNodeHierarchy();try{if(k){var m=g.getOccurrenceItf(k);j(m,g)}else{j(g)}e._UnlockNodeHierarchy();l.cleanUp()}catch(h){e._UnlockNodeHierarchy();l.cleanUp();throw h}}});var f=function(){this._occurrenceList=[];this._occurrenceInterfaceList=[]};f.prototype.cleanUp=function(){this._occurrenceList=null;this._occurrenceInterfaceList=null};f.prototype.getOccurrenceInterface=function(l){if(!l||!this._occurrenceList){return null}if(!this._occurrenceList[l.node.id]){this._occurrenceList[l.node.id]=[]}var g=this._occurrenceList[l.node.id];var h;var k;var j=-1;for(k=0;j<0&&k<g.length;k++){if(g[k].occurrence===l){j=g[k].index}}if(j<0){h=new c(l.node.id,g.length,this);g.push({occurrence:l,index:this._occurrenceInterfaceList.length});this._occurrenceInterfaceList.push(h)}else{h=this._occurrenceInterfaceList[j]}return h};return a});define("DS/Visualization/Selection",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/Selection/HSOManager","DS/Selection/PSOManager"],function(a,c,h,e,f,d,b,g){var j=a.extend({init:function(l){var n=this;this.sceneGraph=l;this.sceneHL=new h.Scene();this.selectedMeshes=new Map();this.doubleSideHighlight=true;this.matHL=null;this.lightHL=new h.DirectionalLight(16777215,1);this.lightHL.position.set(0,0,0);this.lightHL.castShadow=false;this.sceneHL.add(this.lightHL);var m={HSO:b,PSO:g};this.node3DMap=new Map();this.onSceneGraphUpdate=c.subscribe({event:"/VISU/onSceneGraphUpdate"},function(t){if(n.node3DMap.has(t.fromNode)){if(t.eventType=="ADD"){var v=n.node3DMap.get(t.fromNode);n.addNodeToMap(t.toNode,n.node3DMap,v);for(var p=0;p<v.length;p++){var s=v[p].getLastElement();var r=t.toNode;var q=[];n._getPaths(s,r,[],q);for(var o=0;o<q.length;o++){var u=new d(v[p].externalPath.slice());u.externalPath=u.externalPath.concat(q[o]);n._add(t.toNode,u)}}}if(t.eventType=="REMOVE"){n.removeNodeToMap(t.fromNode,n.node3DMap)}}});var k=m[this.eventType];this._xsoManager=k;this.toUnsubscribe=[];this.toUnsubscribe.push(k.onPostAdd(function(o){if(o!==null){var p=o.pathElement;if(!p&&o.options){p=o.options.pathElement}if(p){n.add(p,o.parameters);if(n.sceneGraph.viewer){n.sceneGraph.viewer.render({onlyPostProcess:true})}}if(o instanceof Array){o.forEach(function(q){n.add(q.pathElement,q.parameters)});if(n.sceneGraph.viewer){n.sceneGraph.viewer.render({onlyPostProcess:true})}}}}));this.toUnsubscribe.push(k.onPostRemove(function(o){if(o!==null){var p=o.pathElement;if(!p&&o.options){p=o.options.pathElement}if(p){n.remove(p,o.parameters);if(n.sceneGraph.viewer){n.sceneGraph.viewer.render({onlyPostProcess:true})}}if(o instanceof Array){o.forEach(function(q){n.remove(q.pathElement,o.parameters)});if(n.sceneGraph.viewer){n.sceneGraph.viewer.render({onlyPostProcess:true})}}}}));this.toUnsubscribe.push(k.onEmpty(function(){n.clearAll();if(n.sceneGraph.viewer){n.sceneGraph.viewer.render({onlyPostProcess:true})}}));return this},_detachEvents:function(){var k;for(k=0;k<this.toUnsubscribe.length;k++){this._xsoManager.unsubscribe(this.toUnsubscribe[k])}c.unsubscribe(this.onSceneGraphUpdate)},setDoubleSideHighlight:function(k){this.doubleSideHighlight=k},_getPaths:function(q,o,p,r){var n,k;if(o==q){r.push(p.slice(0));return}p.unshift(o);var m=o.parents;k=m.length;for(n=0;n<k;n++){this._getPaths(q,m[n],p,r)}p.shift(o)},addNodeToMap:function(k,l,m){k.traverse(function(o){var n;if(o instanceof f){n=l.get(o);if(n&&n.length){l.set(o,n.concat(m))}else{l.set(o,m)}}})},removeNodeToMap:function(k,l){k.traverse(function(n){var m;if(n instanceof f){l["delete"](n)}})},add:function(l){var k;if(l!==null&&l!==undefined){k=l.getLastElement();if(k===null){return false}if(k instanceof f){this.addNodeToMap(k,this.node3DMap,[l])}this._add(k,l)}return true},_add:function(l,p){var k=p._getRenderableOccurrences(this.sceneGraph.viewer);var n=k.length;if(l instanceof f){if(n){for(var m=0;m<n;m++){var o=k[m];if(p.instanceId!==undefined&&o._instancingInfos){o._instancingInfos.pickedInstanceId=p.instanceId}if(!this.sceneGraph.scene.containsMesh(o)){continue}this.addMesh(o)}}}else{if(n!==1){return false}if(!this.sceneGraph.scene.containsMesh(k[0])){return false}this.addPrimitive(k[0],l)}},remove:function(p){var l;if(p){var k=p._getRenderableOccurrences(this.sceneGraph.viewer);var n=k.length;l=p.getLastElement();if(l===null){return}if(l instanceof f){if(this.node3DMap.has(l)){this.removeNodeToMap(l,this.node3DMap)}if(n){for(var m=0;m<n;m++){var o=k[m];if(!this.sceneGraph.scene.containsMesh(o)){continue}this.removeMesh(o)}}}else{if(n!==1){return false}if(!this.sceneGraph.scene.containsMesh(k[0])){return false}this.removePrimitive(k[0],l)}}},addPrimitive:function(t,n){var m=null;if(!this.selectedMeshes.has(t)){m=this.duplicateMeshForHighlight(t,true);this.selectedMeshes.set(t,{hlMeshScene:null,hlMeshPrimScene:m,nbSelections:0});this.sceneHL.add(m);t.addRefVBO()}else{var q=this.selectedMeshes.get(t);if(!q.hlMeshPrimScene){q.hlMeshPrimScene=this.duplicateMeshForHighlight(t,true);this.sceneHL.add(q.hlMeshPrimScene)}m=q.hlMeshPrimScene}if((n.getType()==="rep")||(n.getType()==="selectionGroup")){var p=[];var k=[];var r=n.getChildren();for(var o=0;o<r.length;o++){var l=r[o];var s=m.highLight.primitives.indexOf(l.sgNode);if(s===-1){k.push(l)}else{p.push(l)}}if(!p.length&&(n.getType()!=="selectionGroup")){m.addHighLightRep(n.sgNode)}else{for(var o=0;o<k.length;o++){m.addHighLightPrimitive(k[o].sgNode)}}}else{if(n.getType()==="primitive"){var s=m.highLight.primitives.indexOf(n.sgNode);if(s===-1){m.addHighLightPrimitive(n.sgNode)}}}return m},addMesh:function(m){var k=null;if(!this.selectedMeshes.has(m)){k=this.duplicateMeshForHighlight(m);this.selectedMeshes.set(m,{hlMeshScene:k,hlMeshPrimScene:null,nbSelections:1});this.sceneHL.add(k);m.addRefVBO()}else{var l=this.selectedMeshes.get(m);l.nbSelections++;if(!l.hlMeshScene){l.hlMeshScene=this.duplicateMeshForHighlight(m);this.sceneHL.add(l.hlMeshScene)}k=l.hlMeshScene}return k},removeMesh:function(m){var k=null;if(m){if(this.selectedMeshes.has(m)){var l=this.selectedMeshes.get(m);k=l.hlMeshScene;if(!k){return null}l.nbSelections--;if(!l.nbSelections){l.hlMeshScene=null;this.sceneHL.remove(k);if(!l.hlMeshPrimScene){this.selectedMeshes["delete"](m);m.releaseVBO();k=null}}}}return k},removeMeshAndPrimitives:function(n){if(n){if(this.selectedMeshes.has(n)){var m=this.selectedMeshes.get(n);var k=m.hlMeshScene;var l=m.hlMeshPrimScene;k&&this.sceneHL.remove(k);l&&this.sceneHL.remove(l);this.selectedMeshes["delete"](n);n.releaseVBO()}}},removePrimitive:function(p,k){var m=null;if(p){if(this.selectedMeshes.has(p)){var o=this.selectedMeshes.get(p);m=o.hlMeshPrimScene;if(!m){return null}if(k.getType()==="rep"){m.removeHighLightRep(k.sgNode)}else{if(k.getType()==="selectionGroup"){var n=k.getChildren();for(var l=0;l<n.length;l++){m.removeHighLightPrimitive(n[l].sgNode)}}else{if(k.getType()==="primitive"){m.removeHighLightPrimitive(k.sgNode)}}}if(m.isMeshHiddenByLayer()){o.hlMeshPrimScene=null;this.sceneHL.remove(m)}if(!o.nbSelections&&!o.hlMeshPrimScene){this.selectedMeshes["delete"](p);p.releaseVBO();m=null}}}return m},updateHighlight:function(k){this.lightHL.position=k.camera.getLookAt().negate()},duplicateMeshForHighlight:function(t,r){var p,k=t.material;p=new h.Mesh(t.geometry,k);p.matApp=t.matApp;p.gas=t.gas;p.materialMode=t.materialMode;p.occurrenceRenderingOverride=t.occurrenceRenderingOverride;p._occurrence=t._occurrence;p.matrixAutoUpdate=false;p.visible=t.visible;p.visibilityFree=t.visibilityFree;p.fromLoadedModel=t.fromLoadedModel;p._ratioData=t._ratioData;if(t.layer){p.layer=t.layer.clone(r)}p.setMatrix(t.matrix);if(t._instancingInfos&&t._instancingInfos.isInstanceNode3D){p._instancingInfos={isInstanceNode3D:true,nbInstances:-1,instancingSelectionMode:t._instancingInfos.instancingSelectionMode,instanceAttribArrays:null,pickedInstanceId:-1};if(t._instancingInfos.instancingSelectionMode==="instance"){var o=t._instancingInfos.instanceAttribArrays;p._instancingInfos.nbInstances=1;p._instancingInfos.instanceAttribArrays={id:o.id};var n,l,m,q,s;for(n in o){if(n!=="id"){q=o[n].itemSize;p._instancingInfos.instanceAttribArrays[n]={itemSize:q};s=o[n].isMat4?16:q;if(s===16){p._instancingInfos.instanceAttribArrays[n].isMat4=true}l=(t._instancingInfos.pickedInstanceId/5-1)*s;m=l+s;p._instancingInfos.instanceAttribArrays[n].array=o[n].array.subarray(l,m);p._instancingInfos.instanceAttribArrays[n].buffer=null}}}else{p._instancingInfos.nbInstances=t._instancingInfos.nbInstances;p._instancingInfos.instanceAttribArrays=t._instancingInfos.instanceAttribArrays}t._instancingInfos.pickedInstanceId=-1}return p},clearAll:function(){var k=this;this.selectedMeshes.forEach(function(n,p,o){var l=n.hlMeshScene;var m=n.hlMeshPrimScene;if(l){k.sceneHL.remove(l)}if(m){k.sceneHL.remove(m)}p.releaseVBO()});this.selectedMeshes.clear();this.node3DMap.clear()}});return j});define("Visualization/Selection",["DS/Visualization/Selection","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/Selection");return b});define("DS/Visualization/PreHighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Selection","DS/Shaders/AdvancedPreHighlightShader"],function(b,d,e,c,f){var a=c.extend({init:function(g){this.eventType="PSO";this._parent(g);var h=this;this.onSelectionRemove=b.subscribe({event:"/VISU/SELECTION/REMOVE"},function(j){h.removeMeshAndPrimitives(j);j.preHighlight=null});return this},_detachEvents:function(){b.unsubscribe(this.onSelectionRemove);this._parent()},addMesh:function(j){if(!j||!j._occurrence){return null}var h=j._occurrence.node;if(h&&h._getExcludeFromPreHL()){return null}var g=this._parent(j);if(g){j.preHighlight=g}return g},removeMesh:function(h){var g=this._parent(h);h.preHighlight=g},addPrimitive:function(j,h){var g=this._parent(j,h);if(g){j.preHighlight=g}return g},removePrimitive:function(j,h){var g=this._parent(j,h);j.preHighlight=g}});return a});define("Visualization/PreHighlightSelection",["DS/Visualization/PreHighlightSelection","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/PreHighlightSelection");return b});define("DS/Visualization/HighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Selection","DS/Shaders/AdvancedHighlightShader","DS/Shaders/AdvancedHighlightShaderSinglePass"],function(b,f,g,e,a,d){var c=e.extend({init:function(h){this.eventType="HSO";this._parent(h);this.passes=[];this.colorHighlight={color:new f.Color().setRGB(1,0,0),outlineColor:new f.Color().setRGB(0,1,1),intensity:0.5,polygonOffsetParameters:{activated:false,factor:1,unit:1}};if(f.mobileVersion){this.colorHighlight.color.setRGB(0,0.6,1)}this._updateColor();this.isMultiColorSet=false;this.linkToHSO=true;var j=this;this.onSelectionRemove=b.subscribe({event:"/VISU/SELECTION/REMOVE"},function(k){j.removeMeshAndPrimitives(k);k.highlight=null});return this},_detachEvents:function(){b.unsubscribe(this.onSelectionRemove);this._parent()},add:function(j,h){if(!this.isMultiColorSet){if(!h||(h&&!h.highlightColor)){this._parent(j)}}else{if(h&&h.highlightColor&&this.isEqualColor(h.highlightColor)){this._parent(j)}}},clearAll:function(){this.passes=[];this._parent()},addMesh:function(k){if(k instanceof f.CSS2DNode){k.element.classList.add("wux-css2dnode-highlighted");return null}if(!k||!k._occurrence){return null}var j=k._occurrence.node;if(j&&j._getExcludeFromHL()){return null}var h=this._parent(k);if(h){k.highlight=h}return h},removeMesh:function(j){if(j instanceof f.CSS2DNode){j.element.classList.remove("wux-css2dnode-highlighted");return null}var h=this._parent(j);j.highlight=h},addPrimitive:function(k,j){var h=this._parent(k,j);if(h){k.highlight=h}return h},removePrimitive:function(k,j){var h=this._parent(k,j);k.highlight=h},getColorHighlight:function(){return this.colorHighlight},detachToHSO:function(){this.linkToHSO=false;this._detachEvents()},setColorHighlight:function(h){if(h.color){this.colorHighlight.color=h.color}if(h.outlineColor){this.colorHighlight.outlineColor=h.outlineColor}if(h.intensity){this.colorHighlight.intensity=h.intensity}if(h.polygonOffsetParameters){if(h.polygonOffsetParameters.activated){this.colorHighlight.polygonOffsetParameters.activated=h.polygonOffsetParameters.activated}if(h.polygonOffsetParameters.factor){this.colorHighlight.polygonOffsetParameters.factor=h.polygonOffsetParameters.factor}if(h.polygonOffsetParameters.unit){this.colorHighlight.polygonOffsetParameters.unit=h.polygonOffsetParameters.unit}}this._updateColor()},setMultiColorMode:function(h){this.isMultiColorSet=h},_updateColor:function(){this.sceneHL.colorHighlight=this.colorHighlight},isEqualColor:function(h){if(!h){return false}if(!h.color){return false}if(this.sceneHL.colorHighlight.color.r!=h.color.r||this.sceneHL.colorHighlight.color.g!=h.color.g||this.sceneHL.colorHighlight.color.b!=h.color.b){return false}if(!h.outlineColor){return false}if(this.sceneHL.colorHighlight.outlineColor.r!=h.outlineColor.r||this.sceneHL.colorHighlight.outlineColor.g!=h.outlineColor.g||this.sceneHL.colorHighlight.outlineColor.b!=h.outlineColor.b){return false}if(this.sceneHL.colorHighlight.intensity!=h.intensity){return false}if(!h.polygonOffsetParameters&&this.sceneHL.colorHighlight.polygonOffsetParameters.activated){return false}if(h.polygonOffsetParameters){if(this.sceneHL.colorHighlight.polygonOffsetParameters.activated!=h.polygonOffsetParameters.activated){return false}if(h.polygonOffsetParameters.activated){if(this.sceneHL.colorHighlight.polygonOffsetParameters.factor!=h.polygonOffsetParameters.factor){return false}if(this.sceneHL.colorHighlight.polygonOffsetParameters.unit!=h.polygonOffsetParameters.unit){return false}}}return true}});return c});define("Visualization/HighlightSelection",["DS/Visualization/HighlightSelection","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/HighlightSelection");return b});define("DS/Visualization/SpriteNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],function(c,d,a){var b=d.extend({init:function(e,f){this._parent(f);this.anchor=e;var g=this;this.cbInit=function(j){var h=new c.Matrix4().lookAt(j.cameraEye,j.cameraTarget,j.cameraUp);h.setPosition(g.anchor);g.setMatrix(h)};this.cbChange=function(j){if(j.eventType==="@onViewpointChange"){var h=new c.Matrix4().lookAt(j.cameraEye,j.cameraTarget,j.cameraUp);h.setPosition(g.anchor);g.setMatrix(h)}};return this},_onLinkedToSceneGraph:function(){this.tokenInit=a.subscribe({event:"/VISU/SpriteNodeInit"},this.cbInit);this.tokenChange=a.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){a.unsubscribe(this.tokenInit);a.unsubscribe(this.tokenChange)},getNodeType:function(){return"SpriteNode3D"}});return UWA.namespace("THREEDS/Nodes/Sprite",b)});define("Visualization/SpriteNode3D",["DS/Visualization/SpriteNode3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/SpriteNode3D");return b});define("DS/Visualization/ViewManager",["UWA/Class","DS/CoreEvents/ModelEvents","DS/CSICommandBinder/CSICommandBinder","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/WebVisuParameters/CSIViewParameter"],function(a,b,j,h,f,k){var g={};var d={};var e={};var l={};var m=false;var c=null,n=a.extend({init:function(q){if(!m&&q&&!q.newModelIdentification){var r=this;k.prototype.declareType();var p=function(s){var t=s.readObject("view","CSIViewParam");if(!t){return false}r._executeParameter(t);return true};var o=j.getDefaultResponse();o.onAnswerDomain("view",p);m=true}if(c){this.views=c.views;if(q){c.viewer=q}this.viewer=c.viewer;this._updatePlane=c._updatePlane;return this}this.views={};this.viewer=q;this._updatePlane=true;c=this;return this},_executeParameter:function(o){o.setStaticMaterials(g);o.setDefaultMaterials(e);o.setTemporaryBodies(l);o.execute(this);this.viewer._modelEvent.publish({event:"VisuAnswer",context:this});this.viewer.render({updateInfinitePlane:this._updatePlane})},clear:function(){for(var o in this.views){delete this.views[o]}},addView:function(p,q){var o=this.views[p];if(!o){o=q;this.views[p]=o}return o},removeView:function(p){var o=this.views[p];if(o){o=null;this.views[p]=o}return o},getView:function(p){var o=this.views[p];if(!o){o=new f();this.viewer.addNode(o);this.views[p]=o}return o},getKey:function(o){for(var p in this.views){if(o===this.views[p]){return p}}return null},onVisuAnswer:function(o){return this.viewer._modelEvent.subscribe({event:"VisuAnswer"},o)},unsubscribe:function(o){this.viewer._modelEvent.unsubscribe(o)},_publishVisuAnswer:function(o){if(o){this.viewer._modelEvent.publish({event:"VisuAnswer",context:this})}this.viewer.render({updateInfinitePlane:this._updatePlane})},setStaticMaterial:function(o,p){if(o===""||!p){return false}g[o]=p;return true},getStaticMaterial:function(o){return g[o]},setStaticLook:function(o,p){if(o===""||!p){return false}d[o]=p;return true},getStaticLook:function(o){return d[o]},setDefaultMaterials:function(o){e=o},getDefaultMaterials:function(){return e},setTemporaryBodies:function(o){l=o||{}},updatePlaneOnViewMessage:function(o){this._updatePlane=o}});return UWA.namespace("THREEDS/ViewManager",n)});define("DS/Visualization/ParticlesNode3D",["DS/Mesh/Mesh","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(c,a,b){var d=b.extend({init:function(j,f){this._parent(f);var g=j.material?j.material:null;if(!a.disableJHGDev){this.material=g}this.particles3js=(j!==undefined)?j:new a.ParticleSystem();var e=a.convertParticleSystemToBufferGeometryDS(this.particles3js.geometry);this.particles3js=new a.Mesh(e,g);this.particles3js.frustumCulled=false;j=this.createRenderable();var h=this._occurrences[0];h.renderable=j;h.renderable.name=this.name;h.renderable._occurrence=h;this.hasExplicitBE=true;this.explicitBSphere=null;this.explicitBBox=null;if(this.particles3js.geometry.boundingSphere!==undefined){this.explicitBSphere=this.particles3js.geometry.boundingSphere.clone()}return this},createRenderable:function(){var e=this.particles3js.clone();e.matrixAutoUpdate=false;e.matrixWorldNeedsUpdate=false;e.visible=this.particles3js.visible;e.pickable=this.particles3js.pickable;e.drawInHLRender=this.particles3js.drawInHLRender;e.renderDepth=this.particles3js.renderDepth;e.frustumCulled=this.particles3js.frustumCulled;e.enableNormalDepth=false;return e},add:function(){return false},setPickable:function(f){var e,g;if(typeof f==="boolean"){console.log("boolean is DEPRECATED in setPickable() method.\n Use ENUM Mesh")}if(this.particles3js!==null){this.particles3js.pickable=(f===c.PICKABLE);this.particles3js.drawInHLRender=(f!==c.NODRAWHL)}for(e=0;e<this._occurrences.length;e++){g=this._occurrences[e];if(g.renderable!==null){g.renderable.pickable=this.particles3js.pickable;g.renderable.drawInHLRender=this.particles3js.drawInHLRender}}},getNodeType:function(){return"ParticlesNode3D"}});return UWA.namespace("THREEDS/Nodes/Particles",d)});define("Visualization/ParticlesNode3D",["DS/Visualization/ParticlesNode3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/ParticlesNode3D");return b});define("DS/Visualization/LensFlareNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(a,b){var c=b.extend({init:function(e,d){this._parent(d);this.lensflare3js=(e!==undefined)?e:new a.ParticleSystem();e=this.createRenderable();var f=this._occurrences[0];f.renderable=e;f.renderable.name=this.name;f.renderable._occurrence=f;return this},createRenderable:function(){var d=this.lensflare3js.clone();d.matrixAutoUpdate=false;d.matrixWorldNeedsUpdate=false;d.visible=this.lensflare3js.visible;d.pickable=false;d.drawInHLRender=false;d.enableNormalDepth=false;return d},add:function(){return false},getNodeType:function(){return"LensFlareNode3D"}});return UWA.namespace("THREEDS/Nodes/LensFlare",c)});define("Visualization/LensFlareNode3D",["DS/Visualization/LensFlareNode3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/LensFlareNode3D");return b});define("DS/Visualization/LightNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(b,c){var a=c.extend({init:function(d,f,e){this._parent(f);this.light3js=(d!==undefined)?d:new b.AmbientLight();d=this.createRenderable();this._matrix=new b.Matrix4().setPosition(new b.Vector3(0,0,1));this._intensity=d.intensity;this._color=d.color;this._attachedToVpt=e?true:false;var g=this._occurrences[0];g.renderable=d;g.renderable.name=this.name;g.renderable._occurrence=g;return this},createRenderable:function(){var d=this.light3js.clone();d.matrixAutoUpdate=false;d.visible=this.light3js.visible;d.matrixWorldNeedsUpdate=false;d.castShadow=this.light3js.castShadow;d.shadowCameraLeft=this.light3js.shadowCameraLeft;d.shadowCameraRight=this.light3js.shadowCameraRight;d.shadowCameraTop=this.light3js.shadowCameraTop;d.shadowCameraBottom=this.light3js.shadowCameraBottom;d.shadowCameraNear=this.light3js.shadowCameraNear;d.shadowCameraFar=this.light3js.shadowCameraFar;d.shadowBias=this.light3js.shadowBias;d.shadowDarkness=this.light3js.shadowDarkness;d.shadowMapWidth=this.light3js.shadowMapWidth;d.shadowMapHeight=this.light3js.shadowMapHeight;d.shadowCameraVisible=this.light3js.shadowCameraVisible;return d},add:function(){return false},updateShadowMap:function(d){var e,f;if(this.light3js!==null){this.light3js.updateShadowMap=d}for(e=0;e<this._occurrences.length;e++){f=this._occurrences[e];if(f.renderable!==null){f.renderable.updateShadowMap=d}}},attachToViewpoint:function(d){this._attachedToVpt=d},setIntensity:function(d){if(d===undefined){this._intensity=1}else{this._intensity=d}this._updateIntensity()},_updateIntensity:function(){var e,f,d;this.light3js.intensity=this._intensity;e=this._occurrences.length;for(d=0;d<e;d++){f=this._occurrences[d];f.renderable.intensity=this._intensity}},setColor:function(d){if(!d instanceof b.Color){this._color=new b.Color(hex)}else{this._color=d}this._updateColor()},_updateColor:function(){var e,f,d;this.light3js.color=this._color;e=this._occurrences.length;for(d=0;d<e;d++){f=this._occurrences[d];f.renderable.color=this._color}},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"LightNode3D"}});return UWA.namespace("THREEDS/Nodes/Light",a)});define("Visualization/LightNode3D",["DS/Visualization/LightNode3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/LightNode3D");return b});define("DS/Visualization/WebGLV6Renderer",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/CompositeShader","DS/Shaders/MirrorShaders","DS/Shaders/BloomShaders","DS/Effects/FXAAEffect","DS/Effects/MLAAEffect","DS/Effects/MSAAEffect","DS/Effects/SMAAEffect","DS/Effects/HighlightEffect","DS/Effects/VignettingEffect","DS/Effects/SSAO2Effect","DS/Effects/SSAO2IterativeEffect","DS/Effects/SSLREffect","DS/Effects/BokehDOFEffect","DS/Effects/ToneMappingEffect","DS/Effects/FlareEffect","DS/Effects/DebugPassEffect","DS/Effects/DebugShadowMapsEffect","DS/Shaders/DeferredShaders","DS/Effects/PreHighlightEffect","DS/Plugins/ComposerContext","DS/Plugins/ClearPass","DS/Visualization/RenderTargetPool","DS/Plugins/PluginPass","DS/Shaders/StereoShaders","DS/CoreEvents/Events","DS/Effects/OITEffect","DS/Plugins/CSSNodesPass","DS/Visualization/BoundingBoxGPUCompute"],function(C,I,G,f,H,v,t,E,A,r,k,m,B,u,n,e,x,s,h,b,q,p,J,y,j,g,d,w,c,z,a,F,o){var D=-1;var l=C.extend({init:function(M){this.useCompositing=M.useCompositing!==undefined?M.useCompositing:true;this.NoOperator=0;this.SimpleOperator=1;this.LinearOperator=2;this.ReinhardOperator=3;this.FilmicOperator=4;this.UnchartedOperator=5;if(M.canvas===undefined){return}this.canvas=M.canvas;this.divCSS=M.divCSS;this.useOffscreenCanvas=M.useOffscreenCanvas;this.bgColor=M.bgColor!==undefined?M.bgColor:0;this.bgAlpha=M.bgAlpha!==undefined?M.bgAlpha:1;this.setBackgroundColor(this.bgColor,this.bgAlpha);this.antiAliasing=M.antiAliasing!==undefined?M.antiAliasing:"NoAA";if(!this.useOffscreenCanvas){this.cssWidth=Math.max(2,M.canvas.offsetWidth);this.cssHeight=Math.max(2,M.canvas.offsetHeight)}else{this.cssWidth=Math.max(2,M.canvas.width);this.cssHeight=Math.max(2,M.canvas.height)}this.devicePixelRatio=window.devicePixelRatio||1;this.deviceWidth=Math.floor(this.devicePixelRatio*this.cssWidth);this.deviceHeight=Math.floor(this.devicePixelRatio*this.cssHeight);this.viewportWidth=this.deviceWidth;this.viewportHeight=this.deviceHeight;this.brightness=M.brightness!==undefined?M.brightness:1;this.tonemapping=M.tonemapping!==undefined?M.tonemapping:1;this.disableBackFaceCulling=false;this.visibleSpace=M.visibleSpace!==undefined?M.visibleSpace:1;this.useOIT=false;this.renderer=new I.WebGLRenderer({context:M.context,alpha:true,premultipliedAlpha:false,antialias:(this.antiAliasing===true),canvas:this.canvas,divCSS:this.divCSS,visibleSpace:this.visibleSpace,preserveDrawingBuffer:M.preserveDrawingBuffer,debugContext:M.debugContext,sortRenderListByBuffer:true});this.renderTargetPool=new d(this.renderer);if(!this.useOffscreenCanvas){this.renderer.setGLSize(this.cssWidth,this.cssHeight,this.cssWidth,this.cssHeight)}else{this.renderer.setGLSize(Math.max(2,this.canvas.width),Math.max(2,this.canvas.height),this.viewportWidth,this.viewportHeight)}this.renderer.setClearColorHex(0,0);this.renderer.gammaInput=true;this.renderer.gammaOutput=!this.useCompositing;this.renderer.autoClear=false;this.renderer.shadowMapCascade=false;this.renderer._gpuPickingTolerance=2;this.renderer._smallTargetPicking=I.mobileVersion;this.gl=this.renderer.context;this.info={memory:new I.MemoryInfo(),render:new I.RenderInfo()};this.compPickingGPU=null;this.compDepth=null;this.compNormal=null;this.compNormalDepth=null;this.compMirror=null;this.compForward=null;this.composers=[];this.passPickingGPU=null;this.passDepth=null;this.passNormal=null;this.passColor=null;this.passNormalDepth=null;this.passMirror=null;this.passMirrorBlur=null;this.passMirrorBlur1=null;this.passMirrorBlur2=null;this.passMirrorBlur3=null;this.infPlanePass=null;this.mirrorBlendPass=null;this.shadowPass=null;this.zPrePass=null;this.forwardPass=null;this.ZOnlyPass=null;this.backgroundPass=null;this.highlightSinglePass=null;this.passLightFullscreen=null;this.passLightProxy=null;this.OITEffect=null;this.PreHighlightEffect=null;this.BokehDOFEffect=null;this.ToneMappingEffect=null;this.FlareEffect=null;this.HighlightEffect=null;this.VignettingEffect=null;this.SSAOEffect=null;this.SSAOIterativeEffect=null;this.SSLREffect=null;this.FXAAEffect=null;this.MLAAEffect=null;this.SMAAEffect=null;this.MSAAEffect=null;this.DebugPassEffect=null;this.DebugShadowMapsEffect=null;this.customEffects=[];this.allEffects=[];this.forwardPassStateSortingResult=null;this.sectionCappingEnabled=false;this.meshesGPU={};this.positionsGPU={};this.normalsGPU={};this.currentGPUPickPosition={x:-1,y:-1};var N=I.FloatType;var L=I.LinearFilter;if(!this.renderer.supportsFloatTextures()){N=I.UnsignedByteType}if(!this.renderer.supportsFloatLinearTextures()){L=I.NearestFilter}this.rtParamsFloatLinear={minFilter:L,magFilter:L,stencilBuffer:true,format:I.RGBAFormat,type:N};this.rtParamsFloatNearest={minFilter:I.NearestFilter,magFilter:I.NearestFilter,stencilBuffer:false,format:I.RGBAFormat,type:N};this.rtParamsFloatNearestStencilBuffer={minFilter:I.NearestFilter,magFilter:I.NearestFilter,stencilBuffer:true,format:I.RGBAFormat,type:N};this.rtParamsUByteNearest={minFilter:I.NearestFilter,magFilter:I.NearestFilter,stencilBuffer:false,format:I.RGBAFormat,type:I.UnsignedByteType};this.rtParamsUByteWithStencilBuffer={minFilter:I.NearestFilter,magFilter:I.LinearFilter,stencilBuffer:true,format:I.RGBAFormat,type:I.UnsignedByteType};this.rtParamsUByte2={minFilter:I.LinearFilter,magFilter:I.LinearFilter,stencilBuffer:false,format:I.RGBAFormat,type:I.UnsignedByteType};this.boundingBoxGPUCompute=new o(this);var K=["-->(initClear)","initClearPass","-->infPlane","infPlanePass","mirrorClearDepth","mirrorBlendPass","afterMirrorClearDepth","shadowPass","-->main","backgroundPass","renderPriorityClear","renderPriorityStencilP4","renderPriorityStencilP3","renderPriorityStencilP2","renderPriorityStencilP1","renderPriorityStencilP0","renderPriorityDrawP3","renderPriorityDrawP2","renderPriorityDrawP1","renderPriorityDrawP0","passSectionCappingFrontFaces","cssPass","zPrePass","forwardPass","ZOnlyPass","oitPass","lensFlarePass","-->(postEffects1)","passMirrorBlur","passMirrorBlur1","passMirrorBlur2","passMirrorBlur3","SSAOEffect","SSAO2IterativeEffect","SSAOIterativeEffect","compareModelPass","-->noz","noEffectNozClearPass","noEffectNozPass","-->(postEffects2)","compositePass","SSLREffect","BokehDOFEffect","FlareEffect","MSAAEffect","HighlightEffect","PreHighlightEffect","highlightClearPass","highlightSinglePass","DebugPassEffect","DebugShadowMapsEffect","-->afterHighlightNoz","noEffectAfterHighlightNozClearPass","noEffectAfterHighlightNozPass","-->robot","noEffectRobotClearPass","noEffectRobotPass","noEffectRobotOrthoPass","-->(postEffects3)","VignettingEffect","FXAAEffect","MLAAEffect","SMAAEffect","-->canvas2D","noEffectCanvas2DPass"];this.mainComposer=new G(this.renderer,undefined,this.renderTargetPool,K);this.initForwardRender();this.highlightPass=null;this.pickingGPUComposerContext=null;this.normalComposerContext=null;this.depthComposerContext=null;this.normalDepthComposerContext=null;this.outlineDepthComposerContext=null;this.clippingScene=null;this.superFinalComposer=null;this.customComposerContexts=null},initEffect:function(K){if(I.mobileVersion){return null}if(!this.useCompositing){if((K!=="Highlight")&&(K!=="PreHighlight")&&(K!=="SSAO")){return null}}var L=null;switch(K){case"OIT":this.OITEffect=new a(this.renderer,this.renderTargetPool,this.forwardPassStateSortingResult);L=this.OITEffect;break;case"FXAA":this.FXAAEffect=new A(this.renderer,this.renderTargetPool);L=this.FXAAEffect;break;case"MLAA":this.MLAAEffect=new r(this.renderer,this.renderTargetPool);L=this.MLAAEffect;break;case"MSAA":this.MSAAEffect=new k(this.renderer,this.renderTargetPool);L=this.MSAAEffect;break;case"SMAA":this.SMAAEffect=new m(this.renderer,this.renderTargetPool);L=this.SMAAEffect;break;case"Vignetting":this.VignettingEffect=new u(this.renderer,this.renderTargetPool);L=this.VignettingEffect;break;case"Highlight":this.HighlightEffect=new B(this.renderer,this.renderTargetPool,!this.useCompositing);L=this.HighlightEffect;break;case"PreHighlight":this.PreHighlightEffect=new y(this.renderer,this.renderTargetPool);L=this.PreHighlightEffect;break;case"SSAO":this.SSAOEffect=new n(this.renderer,this.renderTargetPool);L=this.SSAOEffect;break;case"SSAOIterative":this.SSAOIterativeEffect=new e(this.renderer,this.renderTargetPool);L=this.SSAOIterativeEffect;break;case"SSLR":this.SSLREffect=new x(this.renderer,this.renderTargetPool);L=this.SSLREffect;break;case"DOF":this.BokehDOFEffect=new s(this.renderer,this.renderTargetPool);L=this.BokehDOFEffect;break;case"Bloom":break;case"ToneMapping":this.ToneMappingEffect=new h(this.renderer,this.renderTargetPool);L=this.ToneMappingEffect;break;case"Flare":this.FlareEffect=new b(this.renderer,this.renderTargetPool);L=this.FlareEffect;break;case"DebugPass":this.DebugPassEffect=new q(this.renderer,this.renderTargetPool);L=this.DebugPassEffect;break;case"DebugShadowMaps":this.DebugShadowMapsEffect=new p(this.renderer,this.renderTargetPool);L=this.DebugShadowMapsEffect;break;default:break}if(L!==null){L.updateComposersName(K);L.setSize(this.viewportWidth,this.viewportHeight);L.initEffect(!this.useCompositing,this);this.allEffects.push(L)}return L},setEffect:function(O,L){var N=null;var P=false;if(I.mobileVersion){return}if(!this.useCompositing){if((O!=="Highlight")&&(O!=="PreHighlight")&&(O!=="SSAO")){return}}switch(O){case"OIT":N=this.OITEffect;P=!this.isDeviceCompatibleWithOIT();this.useOIT=L&&!P;this.compForwardComposerContext.needRequiredReadBuffer=this.useOIT;this.zPrePass.isOITPass=this.useOIT;this.forwardPass.isOITPass=this.useOIT;this.renderer.useOIT=this.useOIT;var K=this.forwardPassStateSortingResult;K.getDisplayListByName("TRANSPAR").depthWrite=this.useOIT;K.getDisplayListByName("TRANSPAR1D").depthWrite=this.useOIT;break;case"FXAA":N=this.FXAAEffect;this.antiAliasing=L?O:"NoAA";break;case"MLAA":N=this.MLAAEffect;this.antiAliasing=L?O:"NoAA";break;case"MSAA":N=this.MSAAEffect;this.antiAliasing=L?O:"NoAA";break;case"SMAA":N=this.SMAAEffect;this.antiAliasing=L?O:"NoAA";break;case"FSAA":case"SSAA":if(L){if(this.compMirrorComposerContext){this.compMirrorComposerContext.setSize(2*this.viewportWidth,2*this.viewportHeight)}this.compForwardComposerContext.setSize(2*this.viewportWidth,2*this.viewportHeight)}else{if(this.compMirrorComposerContext){this.compMirrorComposerContext.setSize(this.viewportWidth,this.viewportHeight)}this.compForwardComposerContext.setSize(this.viewportWidth,this.viewportHeight)}this.antiAliasing=L?O:"NoAA";break;case"Vignetting":N=this.VignettingEffect;break;case"Highlight":N=this.HighlightEffect;break;case"PreHighlight":N=this.PreHighlightEffect;break;case"SSAO":N=this.SSAOEffect;P=!this.isDeviceCompatibleWithSSAO();break;case"SSAOIterative":N=this.SSAOIterativeEffect;P=!this.isDeviceCompatibleWithSSAO();break;case"SSLR":N=this.SSLREffect;break;case"DOF":N=this.BokehDOFEffect;break;case"Bloom":N=this.ToneMappingEffect;break;case"ToneMapping":N=this.ToneMappingEffect;break;case"Flare":N=this.FlareEffect;break;case"DebugPass":N=this.DebugPassEffect;break;case"DebugShadowMaps":N=this.DebugShadowMapsEffect;break}if(L&&!P){if(!N){N=this.initEffect(O)}}if(N!==null){var M=L&&!P;(O==="Bloom")?N.setBloom(M):N.setEnabled(M);if(this.compMirrorComposerContext&&O==="OIT"){this.compMirrorComposerContext.enablePass(N.mixPass,this.useOIT);this.compMirrorComposerContext.needRequiredReadBuffer=this.useOIT}M&&N.setSize(this.viewportWidth,this.viewportHeight)}this.updateFinalComposer(true)},getCustomEffect:function(K){return this.customEffects[K]},addCustomEffect:function(K){if(!K){return -1}var L=this.customEffects.length;this.customEffects.push(K);K.updateComposersName("customEffect_"+this.customEffects.length);K.setSize(this.viewportWidth,this.viewportHeight);K.initEffect("",this);return L},setCustomEffect:function(M,K){var L=this.customEffects[M];if(L!==null){L.setEnabled(K);if(K){L.setSize(this.viewportWidth,this.viewportHeight)}}this.updateFinalComposer(true)},updateEffects:function(L,N,O,K){if(this.SSAOEffect&&this.SSAOEffect.enabled){this.SSAOEffect.update("deferred",L,N,O)}if(this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled){this.SSAOIterativeEffect.update("deferred",L,N,O)}if(this.SSLREffect&&this.SSLREffect.enabled){this.SSLREffect.update("deferred",L,N)}if(this.HighlightEffect&&this.HighlightEffect.enabled){this.HighlightEffect.update("forward",L,N,O,K)}if(this.PreHighlightEffect&&this.PreHighlightEffect.enabled){this.PreHighlightEffect.update("forward",L,N,O,K)}if(this.BokehDOFEffect&&this.BokehDOFEffect.enabled){this.BokehDOFEffect.update("deferred",L,N)}if(this.DebugShadowMapsEffect&&this.DebugShadowMapsEffect.enabled){this.DebugShadowMapsEffect.update("forward",L,N)}if(this.MSAAEffect&&this.MSAAEffect.enabled){this.MSAAEffect.update("forward",L,N,O)}for(var M=0;M<this.customEffects.length;M++){var P=this.customEffects[M];if(P&&P.enabled){P.update("forward",L,N)}}},getMaxIterationEffects:function(){var K=0;if(this.SSAOEffect&&this.SSAOEffect.enabled){K=Math.max(K,this.SSAOEffect.getMaxIteration())}if(this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled){K=Math.max(K,this.SSAOIterativeEffect.getMaxIteration())}if(this.MSAAEffect&&this.MSAAEffect.enabled){K=Math.max(K,this.MSAAEffect.getMaxIteration())}return K},setRendererSize:function(N,K,P,L,M,O){if(this.cssWidth!==N||this.cssHeight!==K||this.devicePixelRatio!==O||P){this.devicePixelRatio=O;this.cssWidth=Math.max(2,N);this.cssHeight=Math.max(2,K);this.deviceWidth=Math.floor(O*this.cssWidth);this.deviceHeight=Math.floor(O*this.cssHeight);this.viewportWidth=Math.floor(O*Math.max(2,L));this.viewportHeight=Math.floor(O*Math.max(2,M));this.renderer.setGLSize(this.cssWidth,this.cssHeight,L,M);this.setScale()}},setBackgroundColor:function(L,M){this.bgColor=L;this.bgAlpha=M;var K=new I.Color(this.bgColor);if(this.useCompositing){K.convertGammaToLinear()}this.bgColor=K.getHex()},resetGSSOCache:function(){this.renderer.resetGSSOCache()},computeIntersectionGPU:function(T,X,ac,aa,V,ak,af,an,ad,aj,K){var ah=this.gl,ao=T.scene,ab,L={},am=new Array(),P,ag;var ai=X.camera;var at={main:ai,mainNoJittering:ai,connectedRobotCamera:X.connectedRobotCamera,robotCameraOrtho:X.robotCameraOrtho};this.renderer.currentFrameIndex++;if(!this.pickingGPUComposerContext){this.initComposer("PickingGPU")}this.renderer.gammaInput=false;var S=this.renderer.gammaOutput;this.renderer.gammaOutput=false;this.renderer.autoClear=false;this.renderer.lensFlareEnabled=false;this.mainComposer.updateScene(ao);if(this.OITEffect){this.OITEffect.revealPass.scene=ao;this.OITEffect.accumPass.scene=ao}this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.renderer.materialToUse=I.MaterialToUse.pickingMaterial;var Z=this.renderer.renderFaces;this.renderer.renderFaces=ak;var Y=this.renderer.renderLineMode;this.renderer.renderLineMode=af;var aq=this.renderer.renderPoints;this.renderer.renderPoints=an;var O=this.renderer.renderHiddenEdges;this.renderer.renderHiddenEdges=false;var R=this.renderer.renderPointMode;this.renderer.renderPointMode=ad;this.renderer.setPickingPriorityMapping(aj,this.renderer._stateSortingResult);var al=this.forwardPass.getUsedStateSortingResult(this.renderer);this.renderer.setPickingPriorityMapping(aj,al);this.mainComposer.setComposerContext(this.pickingGPUComposerContext);this.mainComposer.render(undefined,undefined,at,"main");this.pickingGPUComposerContext.needsUpdate=false;this.renderer.setPickingPriorityMapping(null,this.renderer._stateSortingResult);this.renderer.setPickingPriorityMapping(null,al);var ap=this.computeMeshPick(T,ac,V);var U;var M=ap&&ap.tab.length==1&&ap.tab[0]&&ap.tab[0]._instancingInfos&&ap.tab[0]._instancingInfos.isInstanceNode3D;if(M&&ap.tab[0]._instancingInfos.instancingSelectionMode==="instance"){if(!this.pickingGPUComposerContext){this.initComposer("PickingGPU")}var W=new I.Scene();var ar=ap.tab[0].clone();ap.tab[0].copyInstancingInfos(ar);W.add(ar);this.renderer.autoUpdateScene=true;W.updateMatrixWorld();this.mainComposer.updateScene(W);if(this.OITEffect){this.OITEffect.revealPass.scene=W;this.OITEffect.accumPass.scene=W}this.renderer.materialToUse=I.MaterialToUse.pickingMaterialInstancing;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.mainComposer.setComposerContext(this.pickingGPUComposerContext);this.pickingGPUComposerContext.needsUpdate=true;this.mainComposer.render(undefined,undefined,at,"main");this.pickingGPUComposerContext.needsUpdate=false;U=this.computeInstancePick(T,ac,V);this.pickingGPUComposerContext.needsUpdate=true;W.dispose();W=null}aa=aa||(K&&M);var P=ap.tab;for(ag=0;ag<P.length;++ag){if(P[ag]){var L={};L.object=P[ag];L.type=ap.type;if(ag==0&&P.length==1&&U!==undefined){L.instanceId=U}am.push(L)}}if(!am.length){am.push({object:null})}if(aa){if(!this.normalComposerContext){this.initComposer("Normal")}if(!this.depthComposerContext){this.initComposer("Depth")}this.renderer.autoUpdateScene=true;ao.updateMatrixWorld();this.mainComposer.updateScene(ao);if(this.OITEffect){this.OITEffect.revealPass.scene=ao;this.OITEffect.accumPass.scene=ao}this.renderer.materialToUse=I.MaterialToUse.normalMaterial;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.mainComposer.setComposerContext(this.normalComposerContext);this.mainComposer.render(undefined,undefined,at,"main");this.normalComposerContext.needsUpdate=false;this.computeNormalPick(am,ai,ap.outMouse);this.renderer.autoUpdateScene=true;ao.updateMatrixWorld();this.mainComposer.updateScene(ao);if(this.OITEffect){this.OITEffect.revealPass.scene=ao;this.OITEffect.accumPass.scene=ao}this.renderer.materialToUse=I.MaterialToUse.depthMaterial;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.mainComposer.setComposerContext(this.depthComposerContext);this.mainComposer.render(undefined,undefined,at,"main");this.depthComposerContext.needsUpdate=false;var N=ai,ae=(am[0].object&&am[0].object._occurrence)?am[0].object._occurrence.node:null;var Q="";if(ae){Q=ae._getPickingCameraName();if(Q!==""){ai=X[Q]}}this.computePositionPick(am,ai,ap.outMouse)}this.renderer.lensFlareEnabled=true;this.renderer.gammaOutput=S;this.renderer.renderFaces=Z;this.renderer.renderLineMode=Y;this.renderer.renderPoints=aq;this.renderer.renderPointMode=R;this.renderer.renderHiddenEdges=O;return am},computeIntersectionGPUSmallTarget:function(aB,aw,ak,W,aO,an,ax,Y,U,ao,at){var T=this.gl,af=aB.scene,ai,O={},am=new Array(),aD,aF;var av=this.renderer.getViewportSize();var az=av.width;var V=av.height;var ac=Math.round(ak.xPix);var P=Math.round(ak.yPix);var Z=aw.camera;var aN={main:Z,mainNoJittering:Z,connectedRobotCamera:aw.connectedRobotCamera,robotCameraOrtho:aw.robotCameraOrtho};var ay=null;if(Z.fullWidth){ay={fullWidth:Z.fullWidth,fullHeight:Z.fullHeight,x:Z.x,y:Z.y,width:Z.width,height:Z.height}}aN.main.useRealSize=true;aN.connectedRobotCamera.useRealSize=true;aN.robotCameraOrtho.useRealSize=true;var N=this.gpuPickingTolerance*2+1;var aJ=this.gpuPickingTolerance;var aI=this.gpuPickingTolerance;var ae=0;var S=0;if(aO&&ak.pt){ae=Math.round(Math.abs(ak.xPix-ak.pt.xPix));S=Math.round(Math.abs(ak.yPix-ak.pt.yPix))}if(ay){var X=1;var aa=1;X=ay.width/ay.fullWidth;aa=ay.height/ay.fullHeight;var ah=ay.fullWidth/az;var K=ay.fullHeight/V;az=ay.fullWidth;V=ay.fullHeight;ac*=ah;P*=K;ac=ac*X+ay.x;P=P*aa+ay.y;aJ=aJ*X;aI=aI*aa;ae=ae*X;S=S*aa}var au=(aO&&ae!==0)?ae:2*aJ+1;var aH=(aO&&S!==0)?S:2*aI+1;var ag=aO?ac:ac-aJ;var aj=aO?P:P-aI;aw._setPickingViewOffset({cameraSet:aN,fullHeight:V,fullWidth:az,x:ag,y:aj-1,width:au,height:aH,pickingRatioW:N/av.width,pickingRatioH:N/av.height,});this.renderer.currentFrameIndex++;if(!this.pickingGPUComposerContext){this.initComposer("PickingGPU",true)}if(aO){this.pickingGPUComposerContext.setSize(Math.abs(ac-ak.pt.xPix),Math.abs(P-ak.pt.yPix))}var aq=false;if(this.currentGPUPickPosition.x!=ac||this.currentGPUPickPosition.y!=P){this.currentGPUPickPosition.x=ac;this.currentGPUPickPosition.y=P;aq=true}this.renderer.gammaInput=false;var aE=this.renderer.gammaOutput;this.renderer.gammaOutput=false;this.renderer.autoClear=false;this.renderer.lensFlareEnabled=false;this.mainComposer.updateScene(af);if(this.OITEffect){this.OITEffect.revealPass.scene=af;this.OITEffect.accumPass.scene=af}this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.renderer.materialToUse=I.MaterialToUse.pickingMaterial;var Q=this.renderer.renderFaces;this.renderer.renderFaces=an;var aK=this.renderer.renderLineMode;this.renderer.renderLineMode=ax;var aG=this.renderer.renderPoints;this.renderer.renderPoints=Y;var ar=this.renderer.renderHiddenEdges;this.renderer.renderHiddenEdges=false;var al=this.renderer.renderPointMode;this.renderer.renderPointMode=U;this.renderer.setPickingPriorityMapping(ao,this.renderer._stateSortingResult);var aM=this.forwardPass.getUsedStateSortingResult(this.renderer);this.renderer.setPickingPriorityMapping(ao,aM);this.mainComposer.setComposerContext(this.pickingGPUComposerContext);this.pickingGPUComposerContext.needsUpdate=aq||this.pickingGPUComposerContext.needsUpdate;this.mainComposer.render(undefined,undefined,aN,"main");this.pickingGPUComposerContext.needsUpdate=false;this.renderer.setPickingPriorityMapping(null,this.renderer._stateSortingResult);this.renderer.setPickingPriorityMapping(null,aM);var aL=this.computeMeshPickSmallTarget(aB,ak,aO);var R;var L=aL&&aL.tab.length==1&&aL.tab[0]&&aL.tab[0]._instancingInfos&&aL.tab[0]._instancingInfos.isInstanceNode3D;if(L&&aL.tab[0]._instancingInfos.instancingSelectionMode==="instance"){if(!this.pickingGPUComposerContext){this.initComposer("PickingGPU",true)}var aA=new I.Scene();var ab=aL.tab[0].clone();aL.tab[0].copyInstancingInfos(ab);aA.add(ab);this.renderer.autoUpdateScene=true;aA.updateMatrixWorld();this.mainComposer.updateScene(aA);if(this.OITEffect){this.OITEffect.revealPass.scene=aA;this.OITEffect.accumPass.scene=aA}this.renderer.materialToUse=I.MaterialToUse.pickingMaterialInstancing;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.mainComposer.setComposerContext(this.pickingGPUComposerContext);this.pickingGPUComposerContext.needsUpdate=true;this.mainComposer.render(undefined,undefined,aN,"main");this.pickingGPUComposerContext.needsUpdate=false;R=this.computeInstancePickSmallTarget(aB,ak,aO);this.pickingGPUComposerContext.needsUpdate=true;aA.dispose();aA=null}W=W||(at&&L);var aD=aL.tab;for(aF=0;aF<aD.length;++aF){if(aD[aF]){var O={};O.object=aD[aF];O.type=aL.type;if(aF==0&&aD.length==1&&R!==undefined){O.instanceId=R}am.push(O)}}if(!am.length){am.push({object:null})}if(W){if(!this.normalComposerContext){this.initComposer("Normal",true)}if(!this.depthComposerContext){this.initComposer("Depth",true)}if(aO){aw._setPickingViewOffset({cameraSet:aN,fullHeight:av.height,fullWidth:av.width,x:ac-aJ,y:P-aI-1,width:2*aJ+1,height:2*aI+1})}this.renderer.autoUpdateScene=true;af.updateMatrixWorld();this.mainComposer.updateScene(af);if(this.OITEffect){this.OITEffect.revealPass.scene=af;this.OITEffect.accumPass.scene=af}this.renderer.materialToUse=I.MaterialToUse.normalMaterial;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.mainComposer.setComposerContext(this.normalComposerContext);this.normalComposerContext.needsUpdate=aq||this.normalComposerContext.needsUpdate;this.mainComposer.render(undefined,undefined,aN,"main");this.normalComposerContext.needsUpdate=false;this.computeNormalPickSmallTarget(am,Z,aL.outMouse);this.renderer.autoUpdateScene=true;af.updateMatrixWorld();this.mainComposer.updateScene(af);if(this.OITEffect){this.OITEffect.revealPass.scene=af;this.OITEffect.accumPass.scene=af}this.renderer.materialToUse=I.MaterialToUse.depthMaterial;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.mainComposer.setComposerContext(this.depthComposerContext);this.depthComposerContext.needsUpdate=aq||this.depthComposerContext.needsUpdate;this.mainComposer.render(undefined,undefined,aN,"main");this.depthComposerContext.needsUpdate=false;var aC=Z,ap=(am[0].object&&am[0].object._occurrence)?am[0].object._occurrence.node:null;var M="";if(ap){M=ap._getPickingCameraName();if(M!==""){Z=aw[M]}}this.computePositionPickSmallTarget(am,Z,aL.outMouse)}this.renderer.lensFlareEnabled=true;this.renderer.gammaOutput=aE;this.renderer.renderFaces=Q;this.renderer.renderLineMode=aK;this.renderer.renderPoints=aG;this.renderer.renderPointMode=al;this.renderer.renderHiddenEdges=ar;aw._setPickingViewOffset({cameraSet:aN,reset:true});if(ay){var ad=aw.camera._hasChanged;aw.setViewOffset(ay);aw.camera._hasChanged=ad}aN.main.useRealSize=false;aN.connectedRobotCamera.useRealSize=false;aN.robotCameraOrtho.useRealSize=false;if(aO){this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)}return am},computeDepthBuffer:function(K,L,M){var O={main:L.camera,mainNoJittering:L.camera,connectedRobotCamera:L.connectedRobotCamera,robotCameraOrtho:L.robotCameraOrtho};var N=K.scene;if(!this.depthComposerContext){this.initComposer("Depth")}if(M){this.depthComposerContext.needsUpdate=true}this.renderer.gammaInput=false;var P=this.renderer.gammaOutput;this.renderer.gammaOutput=false;this.renderer.autoClear=false;this.renderer.lensFlareEnabled=false;this.renderer.materialToUse=I.MaterialToUse.depthMaterial;this.renderer.autoUpdateScene=true;N.updateMatrixWorld();this.mainComposer.updateScene(N);if(this.OITEffect){this.OITEffect.revealPass.scene=N;this.OITEffect.accumPass.scene=N}this.mainComposer.setComposerContext(this.depthComposerContext);this.mainComposer.render(undefined,undefined,O,"main");this.depthComposerContext.needsUpdate=false;this.renderer.lensFlareEnabled=true;this.renderer.gammaOutput=P},computePositionGPU:function(M,O,S){var P=this.gl,Q=M.scene,R,N=[];var K={main:O.camera,mainNoJittering:O.camera,connectedRobotCamera:O.connectedRobotCamera,robotCameraOrtho:O.robotCameraOrtho};this.renderer.gammaInput=false;var L=this.renderer.gammaOutput;this.renderer.gammaOutput=false;this.renderer.autoClear=false;this.renderer.lensFlareEnabled=false;if(!this.depthComposerContext){this.initComposer("Depth")}this.renderer.autoUpdateScene=true;Q.updateMatrixWorld();this.mainComposer.updateScene(Q);if(this.OITEffect){this.OITEffect.revealPass.scene=Q;this.OITEffect.accumPass.scene=Q}this.renderer.materialToUse=I.MaterialToUse.depthMaterial;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;this.mainComposer.setComposerContext(this.depthComposerContext);this.mainComposer.render(undefined,undefined,K,"main");this.depthComposerContext.needsUpdate=false;N[0]={point:null};this.computePositionPick(N,camera,S);this.renderer.lensFlareEnabled=true;this.renderer.gammaOutput=L;return N[0].point},overrideUpdate:function(K){function M(){var N;var O=K.root._occurrences;for(N=0;N<O.length;N++){O[N].requestOverridesUpdate()}}var L=K.root._getViewer();if(K.root._getTreeModified()&&L.getCurrentSceneGraphState()){M()}if(K.root._getTreeModified()&&L._sceneGraphOverrideSetManager){L._sceneGraphOverrideSetManager._updateOverridesWithMissingTarget(L)}K.root._tryOverridesUpdate(L);if(K.root._getTreeModified()){K.root.traverse(function(N){N.__setTreeModified(false);if(N.isOOCNode()){return true}})}},renderRealDepth:function(U,P,O,K,R,S,L){if(!this.outlineDepthComposerContext){this.initComposer("OutlineDepth")}this.outlineDepthComposerContext.setCameraName(U);this.mainComposer.updateScene(P);if(this.OITEffect){this.OITEffect.revealPass.scene=P;this.OITEffect.accumPass.scene=P}var Q=this.renderer.supportsFloatTextures();this.renderer.materialToUse=Q?I.MaterialToUse.normalDepthMaterial:I.MaterialToUse.shadowMapDepthMaterial;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;O.stencilOp(O.REPLACE,O.REPLACE,O.REPLACE);O.stencilFunc(O.ALWAYS,1,4294967295);O.clearStencil(0);this.renderer.lensFlareEnabled=false;this.zPrePass.setDLsToDisable(["EDGE","POINT","TRANSPAR1D"]);this.forwardPass.setDLsToDisable(["EDGE","POINT","TRANSPAR1D"]);this.ZOnlyPass.setDLsToDisable(["EDGE","POINT","TRANSPAR1D"]);this.backgroundPass.setDLsToDisable(["EDGE","POINT","TRANSPAR1D"]);this.outlineDepthComposerContext.setPassClear(this.initClearPass,true,new I.Color(0),0);this.outlineDepthComposerContext.enableRenderCuttingElementsPasses(S);this.mainComposer.setComposerContext(this.outlineDepthComposerContext);var V,T;if(this.renderer.splitScreenMode){V=this.renderer.getScissorTest();this.renderer.enableScissorTest(false);T=this.renderer.getViewport();this.renderer.setViewport(0,0,T.width,T.height)}var N=L.root._getViewer();var M=false;if(N.infPlaneSmall!==null){M=N.infPlaneSmall.visible;N.infPlaneSmall.visible=false}this.mainComposer.render(undefined,undefined,K,R);if(N.infPlaneSmall!==null){N.infPlaneSmall.visible=M}if(this.renderer.splitScreenMode){this.renderer.setViewport(T.x,T.y,T.width,T.height);this.renderer.enableScissorTest(V)}this.renderer.dBuffer=this.mainComposer.getRenderResult("main");this.renderer.requestDBuffer=false;this.renderer.lensFlareEnabled=true;this.zPrePass.setDLsToDisable([]);this.forwardPass.setDLsToDisable([]);this.ZOnlyPass.setDLsToDisable([]);this.backgroundPass.setDLsToDisable([])},render:function(aL,ae,aK,aC,aP,aD,U,V,L,aM,ax,ai,av,Y,P,aN,ak,ao){this.renderer.renderIteration=aN;this.renderer.currentFrameIndex++;this.renderer.info.render.calls=0;this.renderer.info.render.vertices=0;this.renderer.info.render.faces=0;this.renderer.info.render.points=0;this.renderer.info.render.lines=0;this.renderer.info.render.meshes=0;this.renderer.info.render.culledMeshes=0;aP.mainNoJittering=aP.main;if(this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&this.BokehDOFEffect.iterative){var aq=null;if(this.MSAAEffect&&this.MSAAEffect.enabled){aq=this.MSAAEffect.computeJitterValues(aP.main,aN)}aP.main=this.BokehDOFEffect.computeJitterCamera(aP.main,aN,aq);aP.cameraBackground=this.BokehDOFEffect.computeJitterCamera(aP.cameraBackground,aN,aq)}else{if(this.MSAAEffect&&this.MSAAEffect.enabled){aP.main=this.MSAAEffect.computeJitterCamera(aP.main,aN);aP.cameraBackground=this.MSAAEffect.computeJitterCamera(aP.cameraBackground,aN);if(aP.mirrorCamera){aP.mirrorCamera=this.MSAAEffect.computeJitterCamera(aP.mirrorCamera,aN)}}}this.renderer.fixedSizeArrayPool.makeArraysReusable();this.overrideUpdate(aD,ax);var M,an,ap,aF,aH,aG,at,am,W=this.gl,N,S;this.renderer.gammaInput=true;this.renderer.materialToUse=I.MaterialToUse.originalMaterial;am=aD.scene;this.shadowPass.setScene(am);var Q=!ai&&(L||((this.renderer.getViewportSize().width===this.viewportWidth)&&(this.renderer.getViewportSize().height===this.viewportHeight)));var X=WUX.Selection.HSOManager;var ad=WUX.Selection.PSOManager;N=this.HighlightEffect&&!X.isEmpty();S=this.PreHighlightEffect&&!ad.isEmpty();N&&this.HighlightEffect.setEnabled(N);N&&this.HighlightEffect.setSize(this.viewportWidth,this.viewportHeight);S&&this.PreHighlightEffect.setEnabled(S);S&&this.PreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight);var af=this.HighlightEffect&&this.HighlightEffect.enabled;var R=this.PreHighlightEffect&&this.PreHighlightEffect.enabled;this.updateFinalComposer(L);var ah=false;if(this.sectionCappingEnabled&&this.renderer.clipPlanes.length>0){ah=true}if(this.afterMirrorClearDepth){this.afterMirrorClearDepth.setClearStencil(ah)}if(ah){if(!this.clippingScene){this.clippingScene=new I.Scene(),aH;this.clippingScene.autoUpdateScene=false;this.clippingScene.matrixWorldNeedsUpdate=false;this.clippingScene.matrixAutoUpdate=false;var T=aD.getBoundingSphere();var au=new I.PlaneGeometry(50*T.radius,50*T.radius);var aB;for(aH=0;aH<this.renderer.clipPlanes.length;aH++){aB=this.renderer.clipPlanes[aH].clippingContext[this.renderer.id];var Z=aB.sectionCappingMaterial;if(Z){Z=Z.clone();Z.clipPlaneIndex=aH+1}var aj=new I.Mesh(au,Z||new I.MeshPhongMaterial({color:"purple"}));aj.clippingPlane=this.renderer.clipPlanes[aH];aB.clippingMeshIndex=aH+1;this.clippingScene.add(aj)}for(aH=0;aH<am.children.length;aH++){var aA=am.children[aH];if(aA instanceof I.Light){this.clippingScene.add(aA.clone())}}}var al=this.mainComposer.getAllPasses(),K;for(aH=0;aH<al.length;aH++){K=al[aH];if(K.renderCuttingElements){K.setCuttingScene(this.clippingScene)}}this.updateClippingScene(aD)}if(!aM||!this.useCompositing||!this.highlightPass){if(this.pickingGPUComposerContext){this.pickingGPUComposerContext.needsUpdate=true;this.meshesGPU={}}if(this.normalComposerContext){this.normalComposerContext.needsUpdate=true;this.normalsGPU={}}if(this.depthComposerContext){this.depthComposerContext.needsUpdate=true;this.positionsGPU={}}this.currentGPUPickPosition={x:-1,y:-1};this.renderer.autoUpdateScene=true;am.updateMatrixWorld();this.renderer.initWebGLObjects(am);var ab=(!aN||ak)&&((this.SSAOEffect&&this.SSAOEffect.enabled)||(this.SSLREffect&&this.SSLREffect.enabled)||(this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&!this.BokehDOFEffect.iterative)||(am.__webglFlares&&am.__webglFlares.length));ab=ab||(this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&((aN===1)||((aN>1)&&this.MSAAEffect&&this.MSAAEffect.enabled)));if(ab){if(!this.normalDepthComposerContext){this.initComposer("NormalDepth")}this.mainComposer.updateScene(am);if(this.OITEffect){this.OITEffect.revealPass.scene=am;this.OITEffect.accumPass.scene=am}this.renderer.materialToUse=I.MaterialToUse.normalDepthMaterial;this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;W.stencilOp(W.REPLACE,W.REPLACE,W.REPLACE);W.stencilFunc(W.ALWAYS,1,4294967295);W.clearStencil(0);this.renderer.lensFlareEnabled=false;this.zPrePass.setDLsToDisable(["EDGE","POINT","TRANSPAR1D"]);this.forwardPass.setDLsToDisable(["EDGE","POINT","TRANSPAR1D"]);this.ZOnlyPass.setDLsToDisable(["EDGE","POINT","TRANSPAR1D"]);this.normalDepthComposerContext.setPassClear(this.initClearPass,true,new I.Color(0),0);this.normalDepthComposerContext.enableRenderCuttingElementsPasses(ah);this.mainComposer.setComposerContext(this.normalDepthComposerContext);var aJ,az;if(this.renderer.splitScreenMode){aJ=this.renderer.getScissorTest();this.renderer.enableScissorTest(false);az=this.renderer.getViewport();this.renderer.setViewport(0,0,az.width,az.height)}this.mainComposer.render(undefined,undefined,aP,ao);if(this.renderer.splitScreenMode){this.renderer.setViewport(az.x,az.y,az.width,az.height);this.renderer.enableScissorTest(aJ)}this.renderer.lensFlareEnabled=true;this.zPrePass.setDLsToDisable([]);this.forwardPass.setDLsToDisable([]);this.ZOnlyPass.setDLsToDisable([])}this.renderer.materialToUse=I.MaterialToUse.originalMaterial;var ay=this.renderer.requestDBuffer||(this.renderer.getRenderMode(null)._mask&I.OutlineMask);if(ae&&this.useCompositing){if(ay){this.renderRealDepth("mirrorCamera",am,W,aP,ao,ah,aD)}this.renderer.materialToUse=I.MaterialToUse.originalMaterial;this.compMirrorComposerContext.setPassClear(this.initClearPass,true,new I.Color(0),0);this.compMirrorComposerContext.enableRenderCuttingElementsPasses(ah);this.mainComposer.updateScene(am);if(this.OITEffect){this.OITEffect.revealPass.scene=am;this.OITEffect.accumPass.scene=am}var ag=false;if(U!==null){ag=U.visible;U.visible=false}var aI=false;var aE=(1-V)*20;this.passMirrorBlur.uniforms.radius.value=aE;if(aE>0){aI=true}this.compMirrorComposerContext.enablePass(this.passMirrorBlur,aI);aI=false;if(aE>12){aI=true}this.compMirrorComposerContext.enablePass(this.passMirrorBlur1,aI);aI=false;if(aE>16){aI=true}this.compMirrorComposerContext.enablePass(this.passMirrorBlur2,aI);aI=false;if(aE>18){aI=true}this.compMirrorComposerContext.enablePass(this.passMirrorBlur3,aI);this.compMirrorComposerContext.setRenderPlugins(this.forwardPass,true);this.compMirrorComposerContext.enablePass(this.zPrePass,false);this.renderer.shadowMapEnabled=aK;this.renderer.shadowMapSoft=false;this.mainComposer.setComposerContext(this.compMirrorComposerContext);this.mainComposer.render(0.1,undefined,aP,ao);if(U!==null){U.visible=ag}}if(ay){this.renderRealDepth("main",am,W,aP,ao,ah,aD)}this.renderer.materialToUse=I.MaterialToUse.originalMaterial;this.renderer.autoClear=false;this.compForwardComposerContext.enablePass(this.infPlanePass,aL);this.compForwardComposerContext.setPassClear(this.initClearPass,true,new I.Color(this.bgColor),this.bgAlpha);this.infPlanePass.scene=aC;this.compForwardComposerContext.enableRenderCuttingElementsPasses(ah);if(this.useCompositing){this.compForwardComposerContext.enablePass(this.mirrorBlendPass,aL&&ae);this.compForwardComposerContext.enablePass(this.mirrorClearDepth,aL&&ae);this.compForwardComposerContext.enablePass(this.afterMirrorClearDepth,ae);this.compForwardComposerContext.setPassClear(this.mirrorClearDepth,true,new I.Color(0),1);this.compForwardComposerContext.setPassClear(this.afterMirrorClearDepth,false,new I.Color(0),1);this.compForwardComposerContext.setPassClearDepth(this.afterMirrorClearDepth,true)}this.compForwardComposerContext.setPassClear(this.initClearPass,true,new I.Color(this.bgColor),this.bgAlpha);this.forwardPass.scene=am;this.zPrePass.scene=am;this.backgroundPass.scene=am;this.ZOnlyPass.scene=am;this.mainComposer.updateScene(am);if(this.OITEffect){this.OITEffect.revealPass.scene=am;this.OITEffect.accumPass.scene=am}if(I.mobileVersion){this.compForwardComposerContext.setPassClear(this.highlightClearPass,false,new I.Color(0),0);this.compForwardComposerContext.setPassClearDepth(this.highlightClearPass,true);this.highlightSinglePass.scene=aD.selectionHL.sceneHL}this.renderer.shadowMapEnabled=aK;this.renderer.shadowMapSoft=aK;if(this.customComposerContexts){var aa=this.mainComposer.getPostEffectPasses();for(aG=0;aG<aa.length;aG++){for(aH=0;aH<this.customComposerContexts.length;aH++){this.customComposerContexts[aH].enablePass(aa[aG],false)}}for(aH=0;aH<this.customComposerContexts.length;aH++){this.customComposerContexts[aH].enablePass(this.afterMirrorClearDepth,false);this.customComposerContexts[aH].enableRenderCuttingElementsPasses(ah);this.mainComposer.setComposerContext(this.customComposerContexts[aH]);this.mainComposer.render(undefined,undefined,aP,ao)}}if(av){var aw=new I.WebGLRenderTargetProperties(Y,Y,"cubelinear");var aO=this.compForwardComposerContext.originalRenderTargetProperties;var ac=this.compForwardComposerContext.keepResult;var ar=this.compForwardComposerContext.renderResults.main;var O=ar.useCount;this.compForwardComposerContext.keepResult=true;ar.useCount=1;this.compForwardComposerContext.releaseRenderTargets(this.mainComposer.renderTargetPool);this.compForwardComposerContext.originalRenderTargetProperties=aw;this.mainComposer.setComposerContext(this.compForwardComposerContext);if(this.ToneMappingEffect){this.compForwardComposerContext.setAsLastPass(this.ToneMappingEffect.mixPass,true)}this.mainComposer.render(0.1,P,aP,ao);if(this.ToneMappingEffect){this.compForwardComposerContext.setAsLastPass(this.ToneMappingEffect.mixPass,false)}this.compForwardComposerContext.originalRenderTargetProperties=aO;this.compForwardComposerContext.keepResult=ac;ar.useCount=O}else{this.mainComposer.setComposerContext(this.compForwardComposerContext);if(this.MSAAEffect&&this.MSAAEffect.enabled){this.mainComposer.setPreviousNormalDepthBuffer(this.normalDepthComposerContext);this.mainComposer.setPreviousColorBuffer(this.MSAAEffect.composers[0].composerContext)}this.mainComposer.render(0.1,undefined,aP,ao)}this.renderer.shadowMapEnabled=false;this.renderer.shadowMapSoft=false;this.updateInfos()}else{if(this.customComposerContexts){var aa=this.mainComposer.getPostEffectPasses();for(aG=0;aG<aa.length;aG++){for(aH=0;aH<this.customComposerContexts.length;aH++){this.customComposerContexts[aH].enablePass(aa[aG],false)}}for(aH=0;aH<this.customComposerContexts.length;aH++){this.customComposerContexts[aH].enablePass(this.afterMirrorClearDepth,false);this.customComposerContexts[aH].enableRenderCuttingElementsPasses(ah);this.mainComposer.setComposerContext(this.customComposerContexts[aH]);this.mainComposer.render(undefined,undefined,aP,ao)}}this.mainComposer.setComposerContext(this.compForwardComposerContext);this.mainComposer.updateLinks(ao);this.mainComposer.setComposerContext(this.compForwardComposerContext);this.mainComposer.render(0.1,undefined,aP,ao,this.highlightPass)}this.renderer.renderAssets();this.renderer.autoClearDepth=true;this.renderer.autoClearStencil=true;W.depthFunc(W.LEQUAL)},combineResults:function(K,N,M){if(!M.isReady()){return false}if(!this.superFinalComposer){var O=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint");O.generateMipmaps=false;this.superFinalComposer=new G(this.renderer,O,this.renderTargetPool);this.superFinalComposer.composerContext.name="superFinalComposer";M.createPasses(this.superFinalComposer)}M.updatePasses(K,N,this.compForwardComposerContext.renderResults);var L=this.renderer.getViewportSize();this.renderer.setViewport(0,0,this.deviceWidth,this.deviceHeight);this.superFinalComposer.render(0.1,undefined,{},"superFinal");this.renderer.setViewport(0,0,L.width,L.height);return true},computeMeshPick:function(Q,ab,S){var U=Math.round(ab.xPix),T=Math.round(ab.yPix),W=(S&&ab.pt&&Math.round(ab.xPix-ab.pt.xPix)!==0)?Math.round(Math.abs(ab.xPix-ab.pt.xPix)):1,ak=(S&&ab.pt&&Math.round(ab.yPix-ab.pt.yPix)!==0)?Math.round(Math.abs(ab.yPix-ab.pt.yPix)):1,aa=this.viewportHeight,ac,ai,ag,af,ae,M={},aq=[];var R=U;var aj=T;var L=true;if(S==false){L=this.pickingGPUComposerContext.needsUpdate;for(var ai=U-this.gpuPickingTolerance;ai<=U+this.gpuPickingTolerance;++ai){for(var ag=T-this.gpuPickingTolerance;ag<=T+this.gpuPickingTolerance;++ag){if(!this.meshesGPU[ag*this.viewportWidth+ai]){L=true}}}R=U-this.gpuPickingTolerance;aj=T-this.gpuPickingTolerance;W=2*this.gpuPickingTolerance+1;ak=2*this.gpuPickingTolerance+1}if(L){var ah=new Uint8Array(4*W*ak);this.gl.readPixels(R,aa-aj-ak+1,W,ak,this.gl.RGBA,this.gl.UNSIGNED_BYTE,ah);for(ai=0;ai<W;++ai){for(ag=0;ag<ak;++ag){ae=4*(ag*W+ai);ac=((ah[ae]&63)<<16)|(ah[ae+1]<<8)|(ah[ae+2]);var O=ah[ae]>>6&3;var X=M[ac];if(X===undefined){X=this.getObjectById(Q.scene,ac);M[ac]=X;if(X){aq.push(X)}}this.meshesGPU[(aj+ak-ag-1)*this.viewportWidth+R+ai]={object:X,glType:O}}}}if(S){return{tab:aq,outMouse:ab}}else{var V=0;var K=0;var Z=null;var ao=false;var P=2;var N=this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;var Y=[N,N,0];for(var ai=R;ai<R+W;++ai){for(var ag=aj;ag<aj+ak;++ag){var an=ai-U;var am=ag-T;var ad=an*an+am*am;var X=this.meshesGPU[ag*this.viewportWidth+ai];if(X){var ap=X.object;var O=X.glType;var al=ap&&ap.hasPriorityManipulators&&ap.hasPriorityManipulators();if(ao&&!al){continue}if(ap&&ap.pickable&&((!ao&&al)||(O<=P&&ad<=Y[O]))){ao=al;Y[O]=ad;Z=ap;P=O;V=ai;K=ag}}}}if(Z){return{tab:[Z],outMouse:{xPix:V,yPix:K,x:(V-this.viewportWidth/2)/(this.viewportWidth/2),y:(this.viewportHeight/2-K)/(this.viewportHeight/2)},type:P}}else{return{tab:[],outMouse:ab}}}},computeInstancePick:function(M,U,O){if(O){return}var Q=Math.round(U.xPix),P=Math.round(U.yPix),R=(O&&U.pt&&Math.round(U.xPix-U.pt.xPix)!==0)?Math.round(Math.abs(U.xPix-U.pt.xPix)):1,af=(O&&U.pt&&Math.round(U.yPix-U.pt.yPix)!==0)?Math.round(Math.abs(U.yPix-U.pt.yPix)):1,T=this.viewportHeight,V,ad,Z,Y,X,aa={};var N=Q;var ae=P;var K=true;N=Q-this.gpuPickingTolerance;ae=P-this.gpuPickingTolerance;R=2*this.gpuPickingTolerance+1;af=2*this.gpuPickingTolerance+1;var ac=new Uint8Array(4*R*af);this.gl.readPixels(N,T-ae-af+1,R,af,this.gl.RGBA,this.gl.UNSIGNED_BYTE,ac);var ab=0;var L=this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;for(ad=0;ad<R;++ad){for(Z=0;Z<af;++Z){X=4*(Z*R+ad);V=((ac[X])<<16)|(ac[X+1]<<8)|(ac[X+2]);if(V===0||V>16777215){continue}else{var S=V%5;if(S!==0){if(S>3){V=V+5-S}else{if(S<3){V=V-S}else{V=undefined}}}if(V===0){continue}}if(V!==undefined){var ah=ad+N-Q;var ag=Z+ae-P;var W=ah*ah+ag*ag;if(W<L){ab=V}}}}if(ab===0){ab=undefined}return ab},computePositionPick:function(K,O,P){var T=P.xPix,R=P.yPix,U=this.viewportHeight,S=new Uint8Array(4),N,Q,M;if(!this.depthComposerContext.needsUpdate&&this.positionsGPU[R*this.viewportWidth+T]){N=this.positionsGPU[R*this.viewportWidth+T]}else{this.gl.readPixels(T,U-R,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,S);Q=new Float32Array(S.buffer);if(!Q[0]){M=1}else{M=2*Q[0]-1}N=new I.Vector4(P.x,P.y,M,1);N.applyMatrix4(O.projectionMatrixInverse);N.multiplyScalar(1/N.w);N.applyMatrix4(O.matrixWorld);this.positionsGPU[R*this.viewportWidth+T]=N.clone()}for(var L=0;L<K.length;++L){K[L].point=new I.Vector3(N.x,N.y,N.z)}},computeNormalPick:function(L,Q,R){var W=R.xPix,U=R.yPix,X=this.viewportHeight,V=new Uint8Array(4),P;if(!this.normalComposerContext.needsUpdate&&this.normalsGPU[U*this.viewportWidth+W]){P=this.normalsGPU[U*this.viewportWidth+W]}else{this.gl.readPixels(W,X-U,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,V);P=new I.Vector4((V[0]/255)*2-1,(V[1]/255)*2-1,(V[2]/255)*2-1,0);var K=P.x,T=P.y,M=P.z;var O=Q.matrixWorld.elements;var S=1/(O[3]*K+O[7]*T+O[11]*M+O[15]);P.x=(O[0]*K+O[4]*T+O[8]*M)*S;P.y=(O[1]*K+O[5]*T+O[9]*M)*S;P.z=(O[2]*K+O[6]*T+O[10]*M)*S;this.normalsGPU[U*this.viewportWidth+W]=P.clone()}for(var N=0;N<L.length;++N){L[N].normal=new I.Vector3(P.x,P.y,P.z);L[N].tangent=null}},computeMeshPickSmallTarget:function(R,ac,T){var V=Math.round(ac.xPix),U=Math.round(ac.yPix),X=(T&&ac.pt&&Math.round(ac.xPix-ac.pt.xPix)!==0)?Math.round(Math.abs(ac.xPix-ac.pt.xPix)):1,am=(T&&ac.pt&&Math.round(ac.yPix-ac.pt.yPix)!==0)?Math.round(Math.abs(ac.yPix-ac.pt.yPix)):1,ab=this.viewportHeight,ad,ak,ai,ah,ag,N={},at=[];var S=V;var al=U;var M=true;if(T==false){M=this.pickingGPUComposerContext.needsUpdate;for(var ak=V-this.gpuPickingTolerance;ak<=V+this.gpuPickingTolerance;++ak){for(var ai=U-this.gpuPickingTolerance;ai<=U+this.gpuPickingTolerance;++ai){if(!this.meshesGPU[ai*this.viewportWidth+ak]){M=true}}}S=V-this.gpuPickingTolerance;al=U-this.gpuPickingTolerance;X=2*this.gpuPickingTolerance+1;am=2*this.gpuPickingTolerance+1}if(M){var aj=new Uint8Array(4*X*am);this.gl.readPixels(0,0,X,am,this.gl.RGBA,this.gl.UNSIGNED_BYTE,aj);for(ak=0;ak<X;++ak){for(ai=0;ai<am;++ai){ag=4*(ai*X+ak);ad=((aj[ag]&63)<<16)|(aj[ag+1]<<8)|(aj[ag+2]);var P=aj[ag]>>6&3;var Y=N[ad];if(Y===undefined){Y=this.getObjectById(R.scene,ad);N[ad]=Y;if(Y){at.push(Y)}}this.meshesGPU[(al+am-ai-1)*this.viewportWidth+S+ak]={object:Y,glType:P}}}}if(T){return{tab:at,outMouse:ac}}else{var W=0;var L=0;var af=0;var K=0;var aa=null;var aq=false;var Q=2;var O=this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;var Z=[O,O,0];for(var ak=S;ak<S+X;++ak){for(var ai=al;ai<al+am;++ai){var ap=ak-V;var ao=ai-U;var ae=ap*ap+ao*ao;var Y=this.meshesGPU[ai*this.viewportWidth+ak];if(Y){var ar=Y.object;var P=Y.glType;var an=ar&&ar.hasPriorityManipulators&&ar.hasPriorityManipulators();if(aq&&!an){continue}if(ar&&ar.pickable&&((!aq&&an)||(P<=Q&&ae<=Z[P]))){aq=an;Z[P]=ae;aa=ar;Q=P;W=ak;L=ai;af=ak-S;K=ai-al}}}}if(aa){return{tab:[aa],outMouse:{xPix:W,yPix:L,xDev:af,yDev:K,x:(W-this.viewportWidth/2)/(this.viewportWidth/2),y:(this.viewportHeight/2-L)/(this.viewportHeight/2)},type:Q}}else{return{tab:[],outMouse:ac}}}},computeInstancePickSmallTarget:function(M,U,O){if(O){return}var Q=Math.round(U.xPix),P=Math.round(U.yPix),R=(O&&U.pt&&Math.round(U.xPix-U.pt.xPix)!==0)?Math.round(Math.abs(U.xPix-U.pt.xPix)):1,af=(O&&U.pt&&Math.round(U.yPix-U.pt.yPix)!==0)?Math.round(Math.abs(U.yPix-U.pt.yPix)):1,T=this.viewportHeight,V,ad,Z,Y,X,aa={};var N=Q;var ae=P;var K=true;N=Q-this.gpuPickingTolerance;ae=P-this.gpuPickingTolerance;R=2*this.gpuPickingTolerance+1;af=2*this.gpuPickingTolerance+1;var ac=new Uint8Array(4*R*af);this.gl.readPixels(0,0,R,af,this.gl.RGBA,this.gl.UNSIGNED_BYTE,ac);var ab=0;var L=this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;for(ad=0;ad<R;++ad){for(Z=0;Z<af;++Z){X=4*(Z*R+ad);V=((ac[X])<<16)|(ac[X+1]<<8)|(ac[X+2]);if(V===0||V>16777215){continue}else{var S=V%5;if(S!==0){if(S>3){V=V+5-S}else{if(S<3){V=V-S}else{V=undefined}}}if(V===0){continue}}if(V!==undefined){var ah=ad+N-Q;var ag=Z+ae-P;var W=ah*ah+ag*ag;if(W<L){ab=V}}}}if(ab===0){ab=undefined}return ab},computePositionPickSmallTarget:function(K,P,Q){var U=Q.xPix,S=Q.yPix,V=this.viewportHeight,T=new Uint8Array(4),O,R,M;if(!this.depthComposerContext.needsUpdate&&this.positionsGPU[S*this.viewportWidth+U]){O=this.positionsGPU[S*this.viewportWidth+U]}else{var N=2*this.gpuPickingTolerance+1;this.gl.readPixels(Q.xDev,N-Q.yDev-1,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,T);R=new Float32Array(T.buffer);if(!R[0]){M=1}else{M=2*R[0]-1}O=new I.Vector4(Q.x,Q.y,M,1);O.applyMatrix4(P.realProjectionMatrixInverse);O.multiplyScalar(1/O.w);O.applyMatrix4(P.matrixWorld);this.positionsGPU[S*this.viewportWidth+U]=O.clone()}for(var L=0;L<K.length;++L){K[L].point=new I.Vector3(O.x,O.y,O.z)}},computeNormalPickSmallTarget:function(L,R,S){var X=S.xPix,V=S.yPix,Y=this.viewportHeight,W=new Uint8Array(4),Q;if(!this.normalComposerContext.needsUpdate&&this.normalsGPU[V*this.viewportWidth+X]){Q=this.normalsGPU[V*this.viewportWidth+X]}else{var O=2*this.gpuPickingTolerance+1;this.gl.readPixels(S.xDev,O-S.yDev-1,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,W);Q=new I.Vector4((W[0]/255)*2-1,(W[1]/255)*2-1,(W[2]/255)*2-1,0);var K=Q.x,U=Q.y,M=Q.z;var P=R.matrixWorld.elements;var T=1/(P[3]*K+P[7]*U+P[11]*M+P[15]);Q.x=(P[0]*K+P[4]*U+P[8]*M)*T;Q.y=(P[1]*K+P[5]*U+P[9]*M)*T;Q.z=(P[2]*K+P[6]*U+P[10]*M)*T;this.normalsGPU[V*this.viewportWidth+X]=Q.clone()}for(var N=0;N<L.length;++N){L[N].normal=new I.Vector3(Q.x,Q.y,Q.z);L[N].tangent=null}},getObjectById:function(L,O){var N,K,M;if(L.id===O){return L}for(N=0,K=L.children.length;N<K;N++){M=this.getObjectById(L.children[N],O);if(M!==null){return M}}return null},insertComposer:function(K,L){if(I.mobileVersion){return}if(K!==null){this.composers.push(K)}L.disabledByDefault=true;this.mainComposer.addPass(L);this.compForwardComposerContext.enablePass(L,true);if(L.name==="HighlightEffect"){this.highlightPass=L}this.updateFinalComposer(true)},updateFinalComposer:function(O){if(I.mobileVersion){return}var L=this.mainComposer;var Q=this.compForwardComposerContext;if(!L){return}var N=L.getAllPasses();var R=N.length,M,K,P;for(M=0;M<R;M++){Q.setPassRenderToCanvas(N[M],false)}if(O){for(M=R-1;M>=0;M--){P=N[M];if(Q.passStates[M].enabled&&P instanceof H){Q.setPassRenderToCanvas(P,true);break}}for(K=R-1;K>=0;K--){P=N[K];if(Q.passStates[K].enabled&&P instanceof H){break}if(Q.passStates[K].enabled&&(P instanceof f||P instanceof g)){Q.setPassRenderToCanvas(P,true)}}}},getComposer:function(K){if(K==="normalDepth"){if(!this.normalDepthComposerContext){this.initComposer("NormalDepth")}return this.normalDepthComposerContext}else{if(K==="result"){return this.compForwardComposerContext}else{if(K==="previousColor"){if(this.MSAAEffect&&this.MSAAEffect.enabled){return this.MSAAEffect.composers[0].composerContext}}}}return null},updateInfos:function(){this.renderer.info.memory.copyTo(this.info.memory);this.forwardPass.info.copyTo(this.info.render)},getInfos:function(){return this.info},setScale:function(){this.renderTargetPool.resetRenderTargetPool();var O,M,N,P,L,R,K;if(this.antiAliasing==="FSAA"||this.antiAliasing==="SSAA"){if(this.compMirrorComposerContext){this.compMirrorComposerContext.setSize(2*this.viewportWidth,2*this.viewportHeight)}if(this.compForwardComposerContext){this.compForwardComposerContext.setSize(2*this.viewportWidth,2*this.viewportHeight)}}else{if(this.compForwardComposerContext){this.compForwardComposerContext.setSize(this.viewportWidth,this.viewportHeight)}if(this.compMirrorComposerContext){this.compMirrorComposerContext.setSize(this.viewportWidth,this.viewportHeight)}}if(this.normalDepthComposerContext){this.normalDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight)}if(this.outlineDepthComposerContext){this.outlineDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight)}if(!this.smallTargetPicking){if(this.pickingGPUComposerContext){this.pickingGPUComposerContext.setSize(this.viewportWidth,this.viewportHeight)}if(this.normalComposerContext){this.normalComposerContext.setSize(this.viewportWidth,this.viewportHeight)}if(this.depthComposerContext){this.depthComposerContext.setSize(this.viewportWidth,this.viewportHeight)}}if(this.FXAAEffect&&this.FXAAEffect.enabled){this.FXAAEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.MLAAEffect&&this.MLAAEffect.enabled){this.MLAAEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.MSAAEffect&&this.MSAAEffect.enabled){this.MSAAEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.SMAAEffect&&this.SMAAEffect.enabled){this.SMAAEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.SSAOEffect&&this.SSAOEffect.enabled){this.SSAOEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled){this.SSAOIterativeEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.SSLREffect&&this.SSLREffect.enabled){this.SSLREffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.BokehDOFEffect&&this.BokehDOFEffect.enabled){this.BokehDOFEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.ToneMappingEffect&&this.ToneMappingEffect.enabled){this.ToneMappingEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.FlareEffect&&this.FlareEffect.enabled){this.FlareEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.HighlightEffect&&this.HighlightEffect.enabled){this.HighlightEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.PreHighlightEffect&&this.PreHighlightEffect.enabled){this.PreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.DebugPassEffect&&this.DebugPassEffect.enabled){this.DebugPassEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.DebugShadowMapsEffect&&this.DebugShadowMapsEffect.enabled){this.DebugShadowMapsEffect.setSize(this.viewportWidth,this.viewportHeight)}if(this.OITEffect&&this.OITEffect.enabled){this.OITEffect.setSize(this.viewportWidth,this.viewportHeight)}for(var O=0;O<this.customEffects.length;O++){var Q=this.customEffects[O];if(Q&&Q.enabled){Q.setSize(this.viewportWidth,this.viewportHeight)}}if(this.passMirrorBlur!==null){this.passMirrorBlur.uniforms.invSize.value.x=1/this.viewportWidth;this.passMirrorBlur.uniforms.invSize.value.y=1/this.viewportHeight}},initComposer:function(L,P){switch(L){case"Depth":var K;if(P){K=new I.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest")}else{K=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest")}K.generateMipmaps=false;this.depthComposerContext=new j(K,this.mainComposer,"depthComposerContext");this.setupPickingComposerContext(this.depthComposerContext,0,0);break;case"Normal":var M;if(P){M=new I.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest")}else{M=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest")}this.normalComposerContext=new j(M,this.mainComposer,"normalComposerContext");this.setupPickingComposerContext(this.normalComposerContext,0,1);break;case"NormalDepth":var R=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"nearest");R.generateMipmaps=false;this.normalDepthComposerContext=new j(R,this.mainComposer,"normalDepthComposerContext");this.normalDepthComposerContext.keepResult=true;this.normalDepthComposerContext.enablePass(this.mirrorBlendPass,false);this.normalDepthComposerContext.enablePass(this.mirrorClearDepth,false);this.normalDepthComposerContext.enablePass(this.afterMirrorClearDepth,false);this.normalDepthComposerContext.enablePass(this.infPlanePass,false);this.normalDepthComposerContext.setRenderPlugins(this.forwardPass,false);this.normalDepthComposerContext.setOnEffectComposerChangeCallback(function(U){var T=U.composer.getPostEffectPasses();var S;for(S=0;S<T.length;S++){U.enablePass(T[S],false)}});this.normalDepthComposerContext.linkTo_internal(this.lensFlarePass.plugin._lensFlare.uniforms.tNormalDepth,undefined,"main");if(this.highlightSinglePass){this.normalDepthComposerContext.enablePass(this.highlightClearPass,false)}break;case"OutlineDepth":var N=this.renderer.supportsFloatTextures();var Q=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,N?"nearest":"uintNearest");Q.generateMipmaps=false;this.outlineDepthComposerContext=new j(Q,this.mainComposer,"outlineDepthComposerContext");this.outlineDepthComposerContext.keepResult=true;this.outlineDepthComposerContext.enablePass(this.mirrorBlendPass,false);this.outlineDepthComposerContext.enablePass(this.mirrorClearDepth,false);this.outlineDepthComposerContext.enablePass(this.afterMirrorClearDepth,false);this.outlineDepthComposerContext.enablePass(this.infPlanePass,false);this.outlineDepthComposerContext.setRenderPlugins(this.forwardPass,false);this.outlineDepthComposerContext.setOnEffectComposerChangeCallback(function(U){var T=U.composer.getPostEffectPasses();var S;for(S=0;S<T.length;S++){U.enablePass(T[S],false)}});break;case"PickingGPU":var O;if(P){O=new I.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest")}else{O=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest")}O.generateMipmaps=false;this.pickingGPUComposerContext=new j(O,this.mainComposer,"pickingGPUComposerContext");this.setupPickingComposerContext(this.pickingGPUComposerContext,0,1);break;default:break}},setupPickingComposerContext:function(O,P,K){O.keepResult=true;O.setPassClear(this.initClearPass,true,new I.Color(P),K);O.enablePass(this.infPlanePass,false);O.enablePass(this.mirrorBlendPass,false);O.enablePass(this.mirrorClearDepth,false);O.enablePass(this.afterMirrorClearDepth,false);var M;var L=this.mainComposer.getAllPasses(),N;for(M=0;M<L.length;M++){N=L[M];if(N.renderCuttingElements){O.enablePass(N,false)}}O.enablePass(this.noEffectRobotClearPass,true);O.setPassClear(this.noEffectRobotClearPass,false);O.setPassClearDepth(this.noEffectRobotClearPass,true);O.enablePass(this.noEffectRobotPass,true);O.enablePass(this.noEffectRobotOrthoPass,true);O.enablePass(this.noEffectCanvas2DPass,true);O.enablePass(this.noEffectNozClearPass,true);O.setPassClear(this.noEffectNozClearPass,false);O.setPassClearDepth(this.noEffectNozClearPass,true);O.enablePass(this.noEffectNozPass,true);O.enablePass(this.noEffectAfterHighlightNozClearPass,true);O.setPassClear(this.noEffectAfterHighlightNozClearPass,false);O.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,true);O.enablePass(this.noEffectAfterHighlightNozPass,true);O.setRenderPlugins(this.forwardPass,false);if(this.highlightSinglePass){O.enablePass(this.highlightClearPass,false);O.enablePass(this.highlightSinglePass,false)}},initForwardRender:function(){var O=null,P=null,N;this.initClearPass=new g("initClearPass");this.infPlanePass=new f(null,null,null,null,null,null,"infPlanePass");this.infPlanePass.lockScene=true;this.infPlanePass.setCameraName("cameraBackground");this.shadowPass=new w(null,null,"shadowPass",new I.ShadowMapPlugin(),this.renderer);this.zPrePass=new f(null,null,null,null,null,null,"zPrePass");this.zPrePass.setDisableColorWrite(true);this.zPrePass.forcePolygonOffset=I.PolygonOffsetForceStatus.ENABLED;this.forwardPass=new f(null,null,null,null,null,null,"forwardPass");this.forwardPassStateSortingResult=new I.StateSortingResult();this.forwardPassStateSortingResult.init();this.forwardPass.setStateSortingResult(this.forwardPassStateSortingResult,true);this.cssPass=new F(null,"cssPass");this.backgroundPass=new f(null,null,null,null,null,null,"backgroundPass");this.backgroundPass.idString="background";this.backgroundPass.setMaterialToUse(I.MaterialToUse.ZOnlyMaterial);this.ZOnlyPass=new f(null,null,null,null,null,null,"ZOnlyPass");this.ZOnlyPass.idString="ZOnly";this.ZOnlyPass.setMaterialToUse(I.MaterialToUse.ZOnlyMaterial);this.lensFlarePass=new w(null,null,"lensFlarePass",new I.LensFlarePlugin(),this.renderer);this.forwardPass.setDisableBackFaceCulling(this.disableBackFaceCulling);this.zPrePass.setDisableBackFaceCulling(this.disableBackFaceCulling);if(this.useCompositing){this.mirrorBlendPass=new H(t.blend,undefined,"mirrorBlendPass");P=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint");O=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear")}this.compForwardComposerContext=new j(O,this.mainComposer,"compForwardComposerContext");if(D===-1){if(true){D=true;console.log("#############\n## GSSOCache has been enabled !!!\n#############")}else{D=false}}if(D){this.compForwardComposerContext.setGSSOCache(true);this.forwardPass.setGSSOCache(true)}this.compForwardComposerContext.keepResult=true;this.mainComposer.addPass(this.initClearPass);this.mainComposer.addPass(this.infPlanePass);if(this.mirrorBlendPass!==null){this.mirrorClearDepth=new g("mirrorClearDepth");this.mirrorClearDepth.clear=false;this.mirrorClearDepth.setClearDepth(false);this.afterMirrorClearDepth=new g("afterMirrorClearDepth");this.mainComposer.addPass(this.mirrorBlendPass);this.mainComposer.addPass(this.afterMirrorClearDepth)}this.passSectionCappingFrontFaces=new f(null,null,null,true,false,false,"passSectionCappingFrontFaces");this.passSectionCappingFrontFaces.setRenderCuttingElements(true);this.passSectionCappingFrontFaces.setEnableStencilTest(true);this.passSectionCappingFrontFaces.setEnableStencilWrite(true);this.passSectionCappingFrontFaces.setDisableColorWrite(true);this.passSectionCappingFrontFaces.setDisableDepthWrite(true);this.passSectionCappingFrontFaces.setStencilFunc("ALWAYS");this.passSectionCappingFrontFaces.setStencilOps("INCR_WRAP","DECR_WRAP");this.passSectionCappingFrontFaces.setDisableBackFaceCulling(true);this.passSectionCappingFrontFaces.setHideSurfacesAndUnclippedMeshes(true);this.passSectionCappingFrontFaces.setDisableBackFaceClipPlanes(1);this.passSectionCappingFrontFaces.setRenderPluginsPre(false);this.passSectionCappingFrontFaces.setRenderPluginsPost(false);this.passSectionCappingFrontFaces.ignoreNoZ=true;this.mainComposer.addPass(this.shadowPass);this.mainComposer.addPass(this.cssPass);this.mainComposer.addPass(this.zPrePass);this.mainComposer.addPass(this.forwardPass);this.mainComposer.addPass(this.backgroundPass);this.mainComposer.addPass(this.ZOnlyPass);this.setEffect("OIT",this.useOIT);this.mainComposer.addPass(this.lensFlarePass);this.mainComposer.addPass(this.passSectionCappingFrontFaces);this.compForwardComposerContext.enablePass(this.zPrePass,false);this.compForwardComposerContext.setRenderPlugins(this.forwardPass,true);this.compForwardComposerContext.enablePass(this.shadowPass,true);this.compForwardComposerContext.enablePass(this.lensFlarePass,true);this.compForwardComposerContext.enablePass(this.backgroundPass,true);this.compForwardComposerContext.enablePass(this.ZOnlyPass,true);this.compForwardComposerContext.enablePass(this.cssPass,true);this.passMirrorBlur=new H(E.PoissonBlur,undefined,"passMirrorBlur");this.passMirrorBlur.material.needsUpdate=true;this.passMirrorBlur.disabledByDefault=true;this.passMirrorBlur1=new H(E.PoissonBlur,undefined,"passMirrorBlur1");this.passMirrorBlur1.disabledByDefault=true;this.passMirrorBlur2=new H(E.PoissonBlur,undefined,"passMirrorBlur2");this.passMirrorBlur2.disabledByDefault=true;this.passMirrorBlur3=new H(E.PoissonBlur,undefined,"passMirrorBlur3");this.passMirrorBlur3.disabledByDefault=true;this.passMirrorBlur.uniforms.invSize.value.x=1/this.viewportWidth;this.passMirrorBlur.uniforms.invSize.value.y=1/this.viewportHeight;this.passMirrorBlur3.uniforms.invSize=this.passMirrorBlur2.uniforms.invSize=this.passMirrorBlur1.uniforms.invSize=this.passMirrorBlur.uniforms.invSize;this.mainComposer.addPass(this.passMirrorBlur);this.mainComposer.addPass(this.passMirrorBlur1);this.mainComposer.addPass(this.passMirrorBlur2);this.mainComposer.addPass(this.passMirrorBlur3);this.noEffectNozClearPass=new g("noEffectNozClearPass");this.noEffectNozClearPass.idString="noz";this.noEffectNozPass=new f(null,null,null,undefined,undefined,undefined,"noEffectNozPass");this.noEffectNozPass.idString="noz";this.mainComposer.addPass(this.noEffectNozClearPass);this.mainComposer.addPass(this.noEffectNozPass);if(I.mobileVersion){this.highlightClearPass=new g("highlightClearPass");this.mainComposer.addPass(this.highlightClearPass);this.highlightSinglePass=new f(null,null,null,undefined,undefined,undefined,"highlightSinglePass");this.highlightSinglePass.setRenderPluginsPre(false);this.highlightSinglePass.setRenderPluginsPost(false);this.highlightSinglePass.setMaterialToUse(I.MaterialToUse.highlightMaterial);this.highlightSinglePass.setDisableBackFaceCulling(true);this.mainComposer.addPass(this.highlightSinglePass)}this.noEffectAfterHighlightNozClearPass=new g("noEffectAfterHighlightNozClearPass");this.noEffectAfterHighlightNozClearPass.idString="afterHighlightNoZ";this.noEffectAfterHighlightNozClearPass.order=60;this.noEffectAfterHighlightNozPass=new f(null,null,null,undefined,undefined,undefined,"noEffectAfterHighlightNozPass");this.noEffectAfterHighlightNozPass.idString="afterHighlightNoZ";this.noEffectAfterHighlightNozPass.order=61;this.noEffectAfterHighlightNozPass.setCameraName("mainNoJittering");this.mainComposer.addPass(this.noEffectAfterHighlightNozClearPass);this.mainComposer.addPass(this.noEffectAfterHighlightNozPass);this.noEffectRobotClearPass=new g("noEffectRobotClearPass");this.noEffectRobotClearPass.order=70;this.noEffectRobotPass=new f(null,null,null,undefined,undefined,undefined,"noEffectRobotPass");this.noEffectRobotPass.idString="robot";this.noEffectRobotPass.setDisableClippingPlanes(true);this.noEffectRobotPass.setDisableToneMapping(true);this.noEffectRobotPass.isRobotPass=true;this.noEffectRobotPass.setCameraName("connectedRobotCamera");this.noEffectRobotPass.order=71;this.noEffectRobotPass.setForceMaterialMode(true);this.noEffectRobotOrthoPass=new f(null,null,null,undefined,undefined,undefined,"noEffectRobotOrthoPass");this.noEffectRobotOrthoPass.idString="robotOrtho";this.noEffectRobotOrthoPass.setDisableClippingPlanes(true);this.noEffectRobotOrthoPass.setCameraName("robotCameraOrtho");this.noEffectRobotOrthoPass.order=72;this.noEffectRobotOrthoPass.isRobotPass=true;this.noEffectRobotOrthoPass.setDisableToneMapping(true);this.noEffectRobotOrthoPass.setForceMaterialMode(true);this.noEffectCanvas2DPass=new f(null,null,null,undefined,undefined,undefined,"noEffectCanvas2DPass");this.noEffectCanvas2DPass.idString="canvas2D";this.noEffectCanvas2DPass.disabledByDefault=true;this.noEffectCanvas2DPass.setDisableClippingPlanes(true);this.noEffectCanvas2DPass.order=100000;this.noEffectCanvas2DPass.setDisableToneMapping(true);this.noEffectCanvas2DPass.setCameraName("mainNoJittering");this.mainComposer.addPass(this.noEffectRobotClearPass);this.mainComposer.addPass(this.noEffectRobotPass);this.mainComposer.addPass(this.noEffectRobotOrthoPass);this.mainComposer.addPass(this.noEffectCanvas2DPass);this.compForwardComposerContext.enablePass(this.noEffectCanvas2DPass,true);if(this.useCompositing){this.compMirrorComposerContext=new j(P,this.mainComposer,"compMirrorComposerContext");this.compMirrorComposerContext.linkToShaderPassUniform(this.mirrorBlendPass,this.mirrorBlendPass.uniforms.tReflectedScene);this.compMirrorComposerContext.enablePass(this.mirrorBlendPass,false);this.compMirrorComposerContext.enablePass(this.mirrorClearDepth,false);this.compMirrorComposerContext.enablePass(this.afterMirrorClearDepth,false);this.compMirrorComposerContext.enableRenderCuttingElementsPasses(true);this.compMirrorComposerContext.enablePass(this.infPlanePass,false);this.compMirrorComposerContext.enablePass(this.shadowPass,true);this.compMirrorComposerContext.enablePass(this.noEffectRobotClearPass,false);this.compMirrorComposerContext.enablePass(this.noEffectRobotOrthoPass,false);this.compMirrorComposerContext.setPassClear(this.noEffectRobotClearPass,false);this.compMirrorComposerContext.setPassClearDepth(this.noEffectRobotClearPass,true);this.compMirrorComposerContext.enablePass(this.noEffectNozPass,false);this.compMirrorComposerContext.setPassClear(this.noEffectNozClearPass,false);this.compMirrorComposerContext.setPassClearDepth(this.noEffectNozClearPass,true);this.compMirrorComposerContext.enablePass(this.noEffectAfterHighlightNozPass,false);this.compMirrorComposerContext.setPassClear(this.noEffectAfterHighlightNozClearPass,false);this.compMirrorComposerContext.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,true);this.compMirrorComposerContext.setCameraName("mirrorCamera");this.compMirrorComposerContext.setBeforeRenderCB(function M(S){S.composer.renderer.initWebGLObjects(S.composer.renderScene);var T=S.composer.renderScene.getAllWebGLObjects(S.composer.renderer.currentFrameIndex);var R;var Q;for(Q=0;Q<T.length;Q++){if(T[Q]===null){continue}R=T[Q].object;if(R.disableMirror&&R.visible){R.visible=false;R.disableMirror=2}}});this.compMirrorComposerContext.setAfterRenderCB(function K(S){var T=S.composer.renderScene.getAllWebGLObjects(S.composer.renderer.currentFrameIndex);var R;var Q;for(Q=0;Q<T.length;Q++){if(T[Q]===null){continue}R=T[Q].object;if(R.disableMirror===2){R.visible=true;R.disableMirror=1}}});var L=new I.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint");L.generateMipmaps=false;this.compositeClearPass=new g("compositeClearPass");this.compositeClearPass.invertTarget=true;this.canvas2DPass=new f(null,null,null,undefined,undefined,undefined,"canvas2DPass");this.canvas2DPass.order=1100;this.canvas2DPass.idString="canvas2D";this.canvas2DPass.setDisableToneMapping(true);this.canvas2DPass.setDisableClippingPlanes(true);this.compositeClearPass.order=5;this.setEffect("ToneMapping",true);this.ToneMappingEffect.setBrightness(this.brightness);this.ToneMappingEffect.setToneMapping(this.tonemapping)}this.compForwardComposerContext.setPassClear(this.noEffectRobotClearPass,false);this.compForwardComposerContext.setPassClearDepth(this.noEffectRobotClearPass,true);this.compForwardComposerContext.setPassClear(this.noEffectNozClearPass,false);this.compForwardComposerContext.setPassClearDepth(this.noEffectNozClearPass,true);this.compForwardComposerContext.setPassClear(this.noEffectAfterHighlightNozClearPass,false);this.compForwardComposerContext.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,true)},resetClippingScene:function(){this.clippingScene=null},_enableZPrePass:function(K){if(!this.forwardPass){return}if(K){this.forwardPass.setDisableDepthWrite(true);this.forwardPass.forcePolygonOffset=I.PolygonOffsetForceStatus.DISABLED;this.compForwardComposerContext.enablePass(this.zPrePass,true);this.compMirrorComposerContext&&this.compMirrorComposerContext.enablePass(this.zPrePass,true)}else{this.forwardPass.forcePolygonOffset=I.PolygonOffsetForceStatus.DEFAULT;this.forwardPass.setDisableDepthWrite(false);this.compForwardComposerContext.enablePass(this.zPrePass,false);this.compMirrorComposerContext&&this.compMirrorComposerContext.enablePass(this.zPrePass,false)}},dispose:function(){if(this.compForwardComposerContext){this.compForwardComposerContext.dispose();this.compForwardComposerContext=null}if(this.compMirrorComposerContext){this.compMirrorComposerContext.dispose();this.compMirrorComposerContext=null}if(this.depthComposerContext){this.depthComposerContext.dispose();this.depthComposerContext=null}if(this.normalComposerContext){this.normalComposerContext.dispose();this.normalComposerContext=null}if(this.normalDepthComposerContext){this.normalDepthComposerContext.dispose();this.normalDepthComposerContext=null}if(this.outlineDepthComposerContext){this.outlineDepthComposerContext.dispose();this.outlineDepthComposerContext=null}if(this.pickingGPUComposerContext){this.pickingGPUComposerContext.dispose();this.pickingGPUComposerContext=null}if(this.lensFlarePass){this.lensFlarePass.dispose();this.lensFlarePass=null}for(var L=0;L<this.allEffects.length;L++){if(this.allEffects[L]&&this.allEffects[L].dispose){this.allEffects[L].dispose()}}for(var L=0;L<this.customEffects.length;L++){if(this.customEffects[L]&&this.customEffects[L].dispose){this.customEffects[L].dispose()}}this.allEffects=null;this.customEffects=null;this.mainComposer.dispose();this.renderer.dispose();var K;for(K in this){if(this.hasOwnProperty(K)){this[K]=null}}},isDeviceCompatibleWithSSAO:function(){return this.renderer.supportsFloatTextures()},isDeviceCompatibleWithOIT:function(){if(!this.renderer.supportsFloatTextures()){console.warn("Warning: your device is not compatible with OITs")}return this.renderer.supportsFloatTextures()},setDisableBackFaceCulling:function(K){this.disableBackFaceCulling=K;if(this.forwardPass){this.forwardPass.setDisableBackFaceCulling(this.disableBackFaceCulling);this.zPrePass.setDisableBackFaceCulling(this.disableBackFaceCulling)}},clearCameraSystemData:function(){this.superFinalComposer=null},recompileAllShaders:function(){this.renderer.recompileAllShaders()},updateClippingScene:function(K){var R=K.getBoundingSphere();var O,M=new I.Vector3();for(O=0;O<this.renderer.clipPlanes.length;O++){var P=this.renderer.clipPlanes[O];P.projectPoint(R.center,M);var U=this.clippingScene.children[O];U.matrixAutoUpdate=false;U.matrixWorldNeedsUpdate=false;var Q=P.normal.clone().multiplyScalar(-1);var N=-P.constant;var T=new I.Vector3();var S=new I.Vector3(1,0,0);var L=1;if(Math.abs(Q.y)<=0.01&&Math.abs(Q.z)<=0.01){S=new I.Vector3(0,1,0)}T.crossVectors(Q,S);T.normalize();S.crossVectors(Q,T);U.matrixWorld.set(L*T.x,L*S.x,L*Q.x,M.x,L*T.y,L*S.y,L*Q.y,M.y,L*T.z,L*S.z,L*Q.z,M.z,0,0,0,1)}}});Object.defineProperty(l.prototype,"gpuPickingTolerance",{get:function(){return this.renderer._gpuPickingTolerance},set:function(K){this.renderer._gpuPickingTolerance=K;if(this.smallTargetPicking){if(this.pickingGPUComposerContext){this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1);this.pickingGPUComposerContext.needsUpdate=true}if(this.normalComposerContext){this.normalComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1);this.normalComposerContext.needsUpdate=true}if(this.depthComposerContext){this.depthComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1);this.depthComposerContext.needsUpdate=true}}}});Object.defineProperty(l.prototype,"smallTargetPicking",{get:function(){return this.renderer._smallTargetPicking},set:function(K){this.renderer._smallTargetPicking=K;if(K){if(this.pickingGPUComposerContext){this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)}if(this.normalComposerContext){this.normalComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)}if(this.depthComposerContext){this.depthComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)}}else{if(this.pickingGPUComposerContext){this.pickingGPUComposerContext.setSize(this.viewportWidth,this.viewportHeight)}if(this.normalComposerContext){this.normalComposerContext.setSize(this.viewportWidth,this.viewportHeight)}if(this.depthComposerContext){this.depthComposerContext.setSize(this.viewportWidth,this.viewportHeight)}}}});l.testMode=false;return l});define("Visualization/WebGLV6Renderer",["DS/Visualization/WebGLV6Renderer","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/WebGLV6Renderer");return b});define("DS/Visualization/GraphicAttributeSet",["DS/Visualization/ThreeJS_DS","DS/Visualization/MaterialManager","DS/Mesh/Mesh"],function(c,a,e){c.GASEnum={NO_INHERIT:0,COLOR_INHERIT:1,RGB_INHERIT:1,ALPHA_INHERIT:1<<1,LINEWIDTH_INHERIT:1<<2,LINETYPE_INHERIT:1<<3,ASMCOLOR_INHERIT:1<<4,SYMBOLTYPE_INHERIT:1<<5};c.GASEnum.RGBA_INHERIT=c.GASEnum.COLOR_INHERIT|c.GASEnum.ALPHA_INHERIT;var h=new c.Color(0);var b=new c.Color(16777215);var g=[1,2,3,4,5,6,7,8,9];var f=[9,9,9,9,5,7,9,3,2];var d=function(j){this.isGAS=true;this._color=null;this._alpha=1;this._lineWidth=1;this._lineType=e.LinePatternEnum.SOLID;this._symbolType=null;this._inheritance=c.GASEnum.RGBA_INHERIT;this._material=null;j&&this.setParameters(j)};d.prototype.setParameters=function(j){if(j.colorRGB!==undefined){this._color=j.colorRGB?j.colorRGB.clone():null}if(j.colorA!==undefined){this._alpha=j.colorA}if(j.lineWidth!==undefined){this._lineWidth=j.lineWidth}if(j.lineType!==undefined){this._lineType=j.lineType}if(j.symbolType!==undefined){this._symbolType=j.symbolType}if(j.inheritance!==undefined){this._inheritance=j.inheritance}};d.prototype.merge=function(j){if(j._color&&(j._inheritance&c.GASEnum.COLOR_INHERIT)){this._color=j._color.clone();this._inheritance|=c.GASEnum.COLOR_INHERIT}if(j._color&&(j._inheritance&c.GASEnum.ASMCOLOR_INHERIT)){this._color=j._color.clone();this._inheritance|=c.GASEnum.ASMCOLOR_INHERIT}if((j._alpha!==null)&&(j._inheritance&c.GASEnum.ALPHA_INHERIT)){this._alpha=j._alpha;this._inheritance|=c.GASEnum.ALPHA_INHERIT}if(j._lineWidth&&(j._inheritance&c.GASEnum.LINEWIDTH_INHERIT)){this._lineWidth=j._lineWidth;this._inheritance|=c.GASEnum.LINEWIDTH_INHERIT}if((j._lineType!==null)&&(j._inheritance&c.GASEnum.LINETYPE_INHERIT)){this._lineType=j._lineType;this._inheritance|=c.GASEnum.LINETYPE_INHERIT}if((j._symbolType!==null)&&(j._inheritance&c.GASEnum.SYMBOLTYPE_INHERIT)){this._symbolType=j._symbolType;this._inheritance|=c.GASEnum.SYMBOLTYPE_INHERIT}};d.prototype.copy=function(j){this._color=j._color?j._color.clone():null;this._alpha=j._alpha;this._lineWidth=j._lineWidth;this._lineType=j._lineType;this._symbolType=j._symbolType;this._inheritance=j._inheritance};d.prototype.clone=function(){return new d({colorRGB:this._color?this._color.clone():null,colorA:this._alpha,lineType:this._lineType,lineWidth:this._lineWidth,symbolType:this._symbolType,inheritance:this._inheritance})};d.prototype.getPointSize=function(){var j=(this._symbolType!==null)?this._symbolType:e.PointSymbolEnum.CROSS;return Math.round(f[j]*(window.devicePixelRatio||1))};d.prototype.getMaterial=function(n,j,m){var l=new a();var o={};if(this._color&&(this._inheritance&(c.GASEnum.COLOR_INHERIT+c.GASEnum.ASMCOLOR_INHERIT))){o.color=this._color}else{if(n){o.color=n.isGAS?n._color:n.color}}if((this._alpha!==null)&&(this._inheritance&c.GASEnum.ALPHA_INHERIT)){o.opacity=this._alpha}else{if(n){o.opacity=n.isGAS?n._alpha:n.opacity}}if(j===1){o.lineWidth=1;if(this._inheritance&c.GASEnum.ASMCOLOR_INHERIT){o.color=h;o.opacity=1}if(this._lineWidth&&(this._inheritance&c.GASEnum.LINEWIDTH_INHERIT)){o.lineWidth=this._lineWidth}else{if(n){o.lineWidth=n.isGAS?n._lineWidth:n.lineWidth;if(!o.lineWidth){o.lineWidth=1}}}if((this._lineType!==null)&&(this._inheritance&c.GASEnum.LINETYPE_INHERIT)){o.pattern=this._lineType}else{if(n){o.pattern=n.isGAS?n._lineType:n.dashPattern;if(!o.pattern){o.pattern=e.LinePatternEnum.SOLID}}}}if(j===0){var k=e.PointSymbolEnum.DOT;if((this._symbolType!==null)&&(this._inheritance&c.GASEnum.SYMBOLTYPE_INHERIT)){k=this._symbolType}else{if(n&&n.isGAS&&(n._symbolType!==null)){k=n._symbolType}}o.symbol=g[k]}return l.getMaterialFromGAS(o)};return d});define("DS/Visualization/Mesh3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/GraphicAttributeSet"],function(b,f,e,d,c){var g=0;var a=f.extend({init:function(o,h){this._parent(h);this.hasExpliciteBE;this._excludeFromCSO;this._excludeFromHSO;this._excludeFromPSO;this._excludeFromHL;this._excludeFromPreHL;this.isInstanceNode3D;this.setHasExplicitBE(true);this.explicitBSphere=new b.Sphere();this.explicitBBox=new b.Box3();this.mesh3js=(o!==undefined)?o:new b.Mesh();this._setExcludeFromCSO(false);this._setExcludeFromHSO(false);this._setExcludeFromPSO(false);this._setExcludeFromHL(false);this._setExcludeFromPreHL(false);this.setIsInstanceNode3D(false);this.nbInstances=0;this._bodyDim=0;var n=this;var k=function(){return n.parents[0]&&n.parents[0]._occurrences[0].scene3js?n.parents[0]._occurrences[0].scene3js.viewer.currentViewpoint:null};this._ratioData={ratio:0,center:null,vptData:k,cameraName:null};o=this.createRenderable();var j=this._occurrences[0];j.renderable=o;j.renderable.name=this.name;j.renderable._occurrence=j;if(this.mesh3js.geometry.boundingSphere){this.explicitBSphere.copy(this.mesh3js.geometry.boundingSphere)}if(this.mesh3js.geometry.boundingBox){this.explicitBBox.copy(this.mesh3js.geometry.boundingBox)}else{var m=new b.Vector3(2*this.explicitBSphere.radius,2*this.explicitBSphere.radius,2*this.explicitBSphere.radius);this.explicitBBox.setFromCenterAndSize(this.explicitBSphere.center,m)}if(!b.disableJHGDev){var l=o.geometry;if(l._type===1||(l.length>0&&l[0]._type===1)){if(o.material){this.setMaterial(o.material)}}}this._updateBEInternal();return this},getRatio:function(){return this._ratioData.ratio},getFixedSizeCenter:function(){return this._ratioData.center?this._ratioData.center.clone():null},setRatio:function(h){if(h===this._ratioData.ratio){return}var k=this._occurrences[0];if(!k){return}var j=k.renderable;if(!j){return}this._ratioData.ratio=h;this.explicitBBox.copy(j.geometry.boundingBox);this.explicitBSphere.copy(j.geometry.boundingSphere);this._updateBEInternal()},setFixedSizeCenter:function(h,j){var l=this._occurrences[0];if(!l){return}var k=l.renderable;if(!k){return}this._ratioData.center=h?h.clone():null;if(j){this._ratioData.center.multiplyScalar(j)}this.explicitBBox.copy(k.geometry.boundingBox);this.explicitBSphere.copy(k.geometry.boundingSphere);this._updateBEInternal()},setFixedSizeCameraName:function(h){this._ratioData.cameraName=h?h:"camera"},_setRatio:function(h){this.setRatio(h)},_setFixedSizeCameraName:function(h){this.setFixedSizeCameraName(h)},_setFixedSizeCenter:function(h,j){this.setFixedSizeCenter(h,j)},_updateBEInternal:function(){if(this._ratioData.ratio>0){if(this.explicitBBox){this.explicitBBox.max=new b.Vector3(0,0,0);this.explicitBBox.min=new b.Vector3(0,0,0)}if(this.explicitBSphere){if(this._ratioData.center){var h=this._ratioData.center.clone();h.multiplyScalar(1/this._ratioData.ratio);this.explicitBSphere.center.add(h)}this.explicitBSphere._updateRatio(this._ratioData.ratio)}}this._invalidateBoundingElements(false,false)},computeBoundingElements:function(){var n=this._occurrences[0];if(!n){return}var m=n.renderable;if(!m){return}var l=m.geometry.boundingBox;var h=m.geometry.boundingSphere;for(var k=0;k<m.geometry.length;k++){var j=m.geometry[k];j.computeBoundingBox();j.computeBoundingSphere();if(k){l.expandByPoint(j.boundingBox.min);l.expandByPoint(j.boundingBox.max);h.clone().mergeWithSphere(j.boundingSphere,h)}else{l.copy(j.boundingBox);h.copy(j.boundingSphere)}}for(var k=0;k<this._occurrences.length;k++){var o=this._occurrences[k];var m=this._occurrences[k].renderable;var j=m.geometry;j.boundingBox.copy(l);j.boundingSphere.copy(h);if(!m.boundingBox){m.boundingBox=new b.Box3()}if(!m.boundingSphere){m.boundingSphere=new b.Sphere()}m.boundingBox.copy(l);m.boundingSphere.copy(h);m._updateWorldCenterAndRadius()}this.explicitBBox.copy(l);this.explicitBSphere.copy(h);this._updateBEInternal()},forceBoundingSphere:function(h){this.forceBoundingElements(true,{sphere:h});this._updateBEInternal()},_forceBoundingSphere:function(h){if(!this.mesh3js){console.log("Couldn't force bounding sphere.");return}if(!this.mesh3js.geometry){console.log("Couldn't force bounding sphere.");return}this.setHasExplicitBE(true);if(!this.mesh3js.geometry.boundingSphere){this.mesh3js.geometry.boundingSphere=new b.Sphere()}this.mesh3js.geometry.boundingSphere.copy(h);this.explicitBSphere.copy(h)},forceBoundingBox:function(h){this.forceBoundingElements(true,{box:h});this._updateBEInternal()},_forceBoundingBox:function(h){if(!this.mesh3js){console.log("Couldn't force bounding box.");return}if(!this.mesh3js.geometry){console.log("Couldn't force bounding box.");return}if(!this.mesh3js.geometry.boundingBox){this.mesh3js.geometry.boundingBox=new b.Box3()}this.setHasExplicitBE(true);this.mesh3js.geometry.boundingBox.copy(h);this.explicitBBox.copy(h)},__forceBoundingElements:function(j,h){if(j){if(j.sphere){this._forceBoundingSphere(j.sphere)}if(j.box){this._forceBoundingBox(j.box)}var l;for(var k=0;k<this._occurrences.length;k++){l=this._occurrences[k];if(l.renderable!==null){l.renderable._updateWorldCenterAndRadius()}}}},_forceGeomType:function(h){var n=typeof h==="string"?b.GeomTypeEnum[h]:h;if(this.mesh3js){for(var m=0;m<this.mesh3js.geometry.length;m++){var l=this.mesh3js.geometry[m];for(var k=0;k<l.drawingGroups.length;k++){var o=l.drawingGroups[k];o._geomType=n}}}},createRenderable:function(){var l=new b.Mesh(this.mesh3js.geometry,this.mesh3js.material);l.matrixAutoUpdate=false;l.matrixWorldNeedsUpdate=false;l.visible=this.mesh3js.visible;l.pickable=this.mesh3js.pickable;l.drawInHLRender=this.mesh3js.drawInHLRender;l.renderDepth=this.mesh3js.renderDepth;l.frustumCulled=this.mesh3js.frustumCulled;l.enableNormalDepth=this.mesh3js.enableNormalDepth;l.castShadow=this.mesh3js.castShadow;l.receiveShadow=this.mesh3js.receiveShadow;l.beforeRenderCB=this.mesh3js.beforeRenderCB;l.fromLoadedModel=this.mesh3js.fromLoadedModel;l._ratioData=this.mesh3js._ratioData;l.materialMode=this.mesh3js.materialMode;l._bodyDim=this._bodyDim;if(this.mesh3js.disableMirror){l.disableMirror=this.mesh3js.disableMirror}var j=this._occurrences[0].renderable;if(j){if(j.layer){l.layer=j.layer.clone()}var k=j.selectionGroups;if(k){for(var h=0;h<k.length;h++){l.addSelectionGroup(k[h].clone())}}}this.mesh3js.copyInstancingInfos(l);return l},add:function(){return false},setRenderDepth:function(k){var h,j;if(this.mesh3js!==null){this.mesh3js.renderDepth=k}for(h=0;h<this._occurrences.length;h++){j=this._occurrences[h];if(j.renderable!==null){j.renderable.renderDepth=k}}},setFrustumCulled:function(h){var j,k;if(this.mesh3js!==null){this.mesh3js.frustumCulled=h}for(j=0;j<this._occurrences.length;j++){k=this._occurrences[j];if(k.renderable!==null){k.renderable.frustumCulled=h}}},setSSAO:function(h){var j,k;if(this.mesh3js!==null){this.mesh3js.enableNormalDepth=h}for(j=0;j<this._occurrences.length;j++){k=this._occurrences[j];if(k.renderable!==null){k.renderable.enableNormalDepth=h}}},setShadow:function(h,l){var j,k;if(this.mesh3js!==null){this.mesh3js.castShadow=h;this.mesh3js.receiveShadow=l}for(j=0;j<this._occurrences.length;j++){k=this._occurrences[j];if(k.renderable!==null){k.renderable.castShadow=h;k.renderable.receiveShadow=l}}},setMirror:function(h){var j,k;if(this.mesh3js!==null){if(h){this.mesh3js.disableMirror=0}else{this.mesh3js.disableMirror=1}}for(j=0;j<this._occurrences.length;j++){k=this._occurrences[j];if(k.renderable!==null){if(h){k.renderable.disableMirror=0}else{k.renderable.disableMirror=1}}}},excludeFromCSO:function(h){this._setExcludeFromCSO(h)},excludeFromHSO:function(h){this._excludeFromHSO=h},excludeFromPSO:function(h){this._excludeFromPSO=h},excludeFromHighlight:function(j,h){this._setExcludeFromHL(j);this._setExcludeFromPreHL(h)},clone:function(j){var l=new b.Mesh(this.mesh3js.geometry,this.mesh3js.material);var h=j?true:false;if(h){if(this.mesh3js.geometry.boundingSphere){l.geometry.boundingSphere=this.mesh3js.geometry.boundingSphere.clone()}if(this.mesh3js.geometry.boundingBox){l.geometry.boundingBox=this.mesh3js.geometry.boundingBox.clone()}}this.mesh3js.copyInstancingInfos(l);l.castShadow=this.mesh3js.castShadow;l.receiveShadow=this.mesh3js.receiveShadow;var k=new THREEDS.Nodes.Mesh(l,this.name);if(this.getIsInstanceNode3D()){k.setIsInstanceNode3D(true)}return k},getPrimitive:function(k,h){var j=this._getPrimitives(k,h);return j.length?j[0]:null},getPrimitives:function(h){return this._getPrimitives(undefined,h)},show:function(h){if(h){this._setLayer(h,1)}else{this._initLayer(1)}},hide:function(h){if(h){this._setLayer(h,0)}else{this._initLayer(0)}},setMaterial:function(h,j){if(!h||h instanceof b.Material){this._parent(h)}else{if(h){this._initLayer(1);this._setLayer(h,1,j)}}},_setGAS:function(h,j){if(!h||h instanceof c){this._parent(h)}else{if(h){this._initLayer(1);this._setLayer(h,1,undefined,j)}}},_getGas:function(h){return this._getMaterials(h,true)},_getMaterials:function(t,m){var u=this._getPrimitivesFromElts(t);var r=[];var h=this._occurrences[0].renderable;if(!h){return false}if(h.layer){for(var n=0;n<u.length;n++){var q=u[n];for(var p=0;p<h.layer.layers.length;p++){var s=h.layer.layers[p].drawableGroup;var l=h.layer.layers[p].drawableInterval;if(l.layerNum===-1){continue}if(!m&&!l.material){continue}if(m&&!l.gas){continue}for(var o=l.primitiveStart;o<l.primitiveStart+l.primitiveCount;o++){if(s.primitives[o]===q){if(m){r.push(l.gas)}else{r.push(l.material)}return r}}}}}return r},setMaterialMode:function(l){var j=l?1:(l===null)?2:0;if(this.mesh3js!==null){this.mesh3js.materialMode=j}for(var h=0;h<this._occurrences.length;h++){var k=this._occurrences[h];if(k.renderable!==null){k.renderable.materialMode=j}}},getNodeType:function(){return"Mesh3D"},getBodyDimension:function(){if(this._bodyDim){return this._bodyDim}return -1},isEditable:function(){return false},setInstancingParameters:function(q,t,v){var l;if(this.mesh3js!==undefined){l=this.mesh3js}else{return}var r=this._matApp&&this._matApp._getMaterialFromGLType(4,b.GeomTypeEnum.FACE);if(!r){r=this.material}if(!r){console.error("Error: An instancing material wasn't set to the Mesh3D.");return}else{r.isInstancingMaterial=true}this.setIsInstanceNode3D(true);this.nbInstances=q;l._instancingInfos={isInstanceNode3D:true,nbInstances:q,instancingSelectionMode:v?v:"instance",instanceAttribArrays:null,pickedInstanceId:-1};var s=new Float32Array(q);for(var p=0;p<q;p++){s[p]=5+p*5}var u={};u.id=g;g++;r.attributes={};u.instanceId={};u.instanceId.array=s;u.instanceId.buffer=null;u.instanceId.itemSize=1;r.attributes.instanceId={type:"f"};for(var o=0;o<t.length;o++){u[t[o].attribName]={};switch(t[o].type){case"f":u[t[o].attribName].array=new Float32Array(t[o].data);r.attributes[t[o].attribName]={type:"f"};u[t[o].attribName].itemSize=1;break;case"v2":if(t[o].isFlattened){u[t[o].attribName].array=new Float32Array(t[o].data)}else{u[t[o].attribName].array=new Float32Array(q*2);for(var m=0;m<q;m++){u[t[o].attribName].array[m*2]=t[o].data[m].x;u[t[o].attribName].array[m*2+1]=t[o].data[m].y}}r.attributes[t[o].attribName]={type:"v2"};u[t[o].attribName].itemSize=2;break;case"v3":if(t[o].isFlattened){u[t[o].attribName].array=new Float32Array(t[o].data)}else{u[t[o].attribName].array=new Float32Array(q*3);for(var m=0;m<q;m++){u[t[o].attribName].array[m*3]=t[o].data[m].x;u[t[o].attribName].array[m*3+1]=t[o].data[m].y;u[t[o].attribName].array[m*3+2]=t[o].data[m].z}}r.attributes[t[o].attribName]={type:"v3"};u[t[o].attribName].itemSize=3;break;case"v4":if(t[o].isFlattened){u[t[o].attribName].array=new Float32Array(t[o].data)}else{u[t[o].attribName].array=new Float32Array(q*4);for(var m=0;m<q;m++){u[t[o].attribName].array[m*4]=t[o].data[m].x;u[t[o].attribName].array[m*4+1]=t[o].data[m].y;u[t[o].attribName].array[m*4+2]=t[o].data[m].z;u[t[o].attribName].array[m*4+3]=t[o].data[m].w}}r.attributes[t[o].attribName]={type:"v4"};u[t[o].attribName].itemSize=4;break;case"m4":if(t[o].isFlattened){u[t[o].attribName].array=new Float32Array(t[o].data)}else{u[t[o].attribName].array=new Float32Array(t[o].data.length*16);for(var w=0;w<t[o].data.length;w++){var h=new Float32Array(16);h=t[o].data[w].elements;for(var p=0;p<16;p++){u[t[o].attribName].array[16*w+p]=h[p]}}}r.attributes[t[o].attribName]={type:"m4"};u[t[o].attribName].itemSize=4;u[t[o].attribName].isMat4=true;break;default:break}u[t[o].attribName].buffer=null}l._instancingInfos.instanceAttribArrays=u;if(r._PDSFXData&&r._PDSFXData.PDSFX){var k="";for(var o=0;o<t.length;o++){k+="attribute "+b.ToGLSLTypes[t[o].type].t+" "+t[o].attribName+";\n"}r._PDSFXData.pdsfxAttributesCode=k}for(var n=0;n<this._occurrences.length;n++){l.copyInstancingInfos(this._occurrences[n].renderable)}},updateInstanceAttribValue:function(l){if(!l.instanceId||!l.attribName||l.value===undefined){console.error("Error: all parameters params.instanceId, params.attribName and params.value are needed.");return}var p=this._matApp&&this._matApp._getMaterialFromGLType(4,b.GeomTypeEnum.FACE);if(!p){p=this.material}var k=this.mesh3js;if(!k._instancingInfos){console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).");return}if(l.instanceId%5!==0||l.instanceId<5||l.instanceId>k._instancingInfos.nbInstances*5){console.error("Error: the instance id is incorrect or out of range.");return}if(!(k._instancingInfos.instanceAttribArrays[l.attribName]&&p.attributes[l.attribName])){console.error("Error: the attribute "+l.attribName+" doesn't exist for this mesh node.");return}var r=l.instanceId/5-1;var q=p.attributes[l.attribName].type;var o=true;var s=k._instancingInfos.instanceAttribArrays;switch(q){case"f":if(!(typeof l.value==="number"&&!isNaN(l.value))){o=false}else{s[l.attribName].array[r]=l.value}break;case"v2":if(!(l.value instanceof b.Vector2)){o=false}else{s[l.attribName].array[r*2]=l.value.x;s[l.attribName].array[r*2+1]=l.value.y}break;case"v3":if(!(l.value instanceof b.Vector3)){o=false}else{s[l.attribName].array[r*3]=l.value.x;s[l.attribName].array[r*3+1]=l.value.y;s[l.attribName].array[r*3+2]=l.value.z}break;case"v4":if(!(l.value instanceof b.Vector4)){o=false}else{s[l.attribName].array[r*4]=l.value.x;s[l.attribName].array[r*4+1]=l.value.y;s[l.attribName].array[r*4+2]=l.value.z;s[l.attribName].array[r*4+3]=l.value.w}break;case"m4":if(!(l.value instanceof b.Matrix4)){o=false}else{var h=new Float32Array(16);h=l.value.elements;for(var n=0;n<16;n++){s[l.attribName].array[16*r+n]=h[n]}}break;default:o=true;break}if(!o){console.error("Error: the type of the new value doesn't match the type of the attribute data.");return}s[l.attribName].isDynamic=true;var j;for(var m=0;m<this._occurrences.length;m++){j=this._occurrences[m].renderable;j._instancingInfos.instanceAttribArrays[l.attribName].isDynamic=true;if(j.highlight){j.highlight._instancingInfos.instanceAttribArrays[l.attribName].isDynamic=true}}},updateInstanceAttribArray:function(l){if(!l.attribName||!l.array){return}var q=this._matApp&&this._matApp._getMaterialFromGLType(4,b.GeomTypeEnum.FACE);if(!q){q=this.material}var k=this.mesh3js;if(!k._instancingInfos){console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).");return}if(!(k._instancingInfos.instanceAttribArrays[l.attribName]&&q.attributes[l.attribName])){console.error("Error: the attribute "+l.attribName+" doesn't exist for this mesh node.");return}var p=true;var t=k._instancingInfos.instanceAttribArrays;if(l.isFlattened){if(l.array instanceof Array){l.array=new Float32Array(l.array)}t[l.attribName].array=l.array}else{var r=q.attributes[l.attribName].type;var m=l.array[0];switch(r){case"f":if(!(typeof m==="number"&&!isNaN(m))){p=false}else{t[l.attribName].array.set(new Float32Array(l.array))}break;case"v2":if(!(m instanceof b.Vector2)){p=false}else{for(var s=0;s<k._instancingInfos.nbInstances;s++){t[l.attribName].array[s*2]=l.array[s].x;t[l.attribName].array[s*2+1]=l.array[s].y}}break;case"v3":if(!(m instanceof b.Vector3)){p=false}else{for(var s=0;s<k._instancingInfos.nbInstances;s++){t[l.attribName].array[s*3]=l.array[s].x;t[l.attribName].array[s*3+1]=l.array[s].y;t[l.attribName].array[s*3+2]=l.array[s].z}}break;case"v4":if(!(m instanceof b.Vector4)){p=false}else{for(var s=0;s<k._instancingInfos.nbInstances;s++){t[l.attribName].array[s*4]=l.array[s].x;t[l.attribName].array[s*4+1]=l.array[s].y;t[l.attribName].array[s*4+2]=l.array[s].z;t[l.attribName].array[s*4+3]=l.array[s].w}}break;case"m4":if(!(m instanceof b.Matrix4)){p=false}else{var h;for(var s=0;s<k._instancingInfos.nbInstances;s++){h=l.array[s].elements;for(var o=0;o<16;o++){t[l.attribName].array[16*s+o]=h[o]}}}break;default:p=true;break}}if(!p){console.error("Error: the type of the new values don't match the type of the attribute data.");return}t[l.attribName].isDynamic=true;var j;for(var n=0;n<this._occurrences.length;n++){j=this._occurrences[n].renderable;j._instancingInfos.instanceAttribArrays[l.attribName].isDynamic=true;if(j.highlight){j.highlight._instancingInfos.instanceAttribArrays[l.attribName].isDynamic=true}}},setInstancingSelectionMode:function(l){if(this.mesh3js._instancingInfos&&this.mesh3js._instancingInfos.isInstanceNode3D){this.mesh3js._instancingInfos.instancingSelectionMode=l;var k=this._occurrences;var h=k.length;for(var j=0;j<h;j++){k[j].renderable._instancingInfos.instancingSelectionMode=l}}},_getPrimitivesFromElts:function(m){var n=[];if(m.length){if(m[0] instanceof d){for(var l=0;l<m.length;l++){if(m[l].getType()==="rep"){for(var h=0;h<m[l].sgNode.primitives.length;h++){n.push(m[l].sgNode.primitives[h])}}else{n.push(m[l].sgNode)}}}else{n=m.slice()}}return n},_setLayer:function(o,k,l,n){var j,m,h=[],p;p=this._getPrimitivesFromElts(o);if(k===-1){var m=this._occurrences[0].renderable;if(!m){return}h=m.getRenderablesFromGeometries()}else{for(j=0;j<this._occurrences.length;j++){h.push(this._occurrences[j].renderable)}}for(j=0;j<h.length;j++){m=h[j];if(!m){continue}m._gsso_cache=null;if(m.layer===null){m.initLayers(1);if(m.highlight){m.highlight.layer=m.layer.clone()}}m.layer.addPrimitivesToLayers(p,k,l,n)}},_initLayer:function(k){var h,j;for(h=0;h<this._occurrences.length;h++){j=this._occurrences[h];if(j.renderable!==null){j.renderable._gsso_cache=null;if(j.renderable.layer===null){j.renderable.initLayers(k)}}}},_removePrimitives:function(h){if(h){this._setLayer(h,-1)}},_addDynamicGeometry:function(j,h,n){var l=null;var m=this._occurrences[0].renderable;if(!m){return false}for(var k=0;k<m.geometry.length;k++){if(m.geometry[k].dynamic){l=m.geometry[k];break}}if(!l){j.dynamic=true;for(var k=0;k<this._occurrences.length;k++){m=this._occurrences[k].renderable;if(m){m.addGeometry(j)}}}else{l.merge(j,h,n)}},_optimizeBuffers:function(z){var q={invalidRatio:(z&&(z.invalidRatio!==undefined))?z.invalidRatio:0.5};var h=this._occurrences[0].renderable;if(!h){return}var m=h.geometry;if(!(m instanceof Array)){return}var t=h.layer?h.layer.layers:null;if(!t){return}var y=e.mergeGeometries({geometries:m,layers:t,invalidRatio:q.invalidRatio,force:false});if(!y){return}for(var u=0;u<this._occurrences.length;u++){var h=this._occurrences[u].renderable;if(!h){continue}h.releaseVBO();h.geometry.length=0;for(var s=0;s<y.length;s++){h.geometry.push(y[s])}for(var s=0;s<y.length;s++){y[s].addRefVBO(h)}if(y.boundingBox){h.geometry.boundingBox=y.boundingBox.clone()}if(y.boundingSphere){h.geometry.boundingSphere=y.boundingSphere.clone()}var v=h.layer.layers;var r=false;var w=[];for(var s=0;s<v.length;s++){var p=[];var x=v[s].drawableGroup;var l=v[s].drawableInterval;if((l.layerNum>0)&&l.material){r=true;for(var o=l.primitiveStart;o<l.primitiveStart+l.primitiveCount;o++){var n=x.primitives[o];if(n._newPrim){p.push(n._newPrim);delete (n._newPrim)}}w.push({layerInterval:l,primitives:p})}}h.layer=null;if(r){h.initLayers(1);for(var s=0;s<w.length;s++){h.layer.addPrimitivesToLayers(w[s].primitives,w[s].layerInterval.layerNum,w[s].layerInterval.material)}}}},_getPrimitives:function(h,n){if(h===""){h=null}var r=[];var l=this._occurrences[0].renderable;if(!l){return false}if(l.layer){for(var q=0;q<l.layer.layers.length;q++){var u=l.layer.layers[q].drawableGroup;var m=l.layer.layers[q].drawableInterval;if(m.layerNum===-1){continue}if(n&&!m.layerNum){continue}for(var p=m.primitiveStart;p<m.primitiveStart+m.primitiveCount;p++){if(h!==undefined){if(u.primitives[p].cgmId===h){r.push(d.getFromSGNode(u.primitives[p]));return r}}else{r.push(d.getFromSGNode(u.primitives[p]))}}}}else{var t=l.geometry;if(!(t instanceof Array)){return r}for(var p=0;p<t.length;p++){var s=t[p];var v=s.drawingGroups;for(var q=0;q<v.length;q++){var u=v[q];for(var o=0;o<u.primitives.length;o++){if(h!==undefined){if(u.primitives[o].cgmId===h){r.push(d.getFromSGNode(u.primitives[o]));return r}}else{r.push(d.getFromSGNode(u.primitives[o]))}}}}}return r},_setBeforeRenderCB:function(j){var h,k;if(this.mesh3js!==null){this.mesh3js.beforeRenderCB=j}for(h=0;h<this._occurrences.length;h++){k=this._occurrences[h];if(k.renderable!==null){k.renderable.beforeRenderCB=j}}}});a.prototype.getHasExplicitBE=function(){return this.hasExpliciteBE};a.prototype.setHasExplicitBE=function(h){this.hasExpliciteBE=h};a.prototype._getExcludeFromCSO=function(){return this._excludeFromCSO};a.prototype._setExcludeFromCSO=function(h){this._excludeFromCSO=h};a.prototype._getExcludeFromHSO=function(){return this._excludeFromHSO};a.prototype._setExcludeFromHSO=function(h){this._excludeFromHSO=h};a.prototype._getExcludeFromPSO=function(){return this._excludeFromPSO};a.prototype._setExcludeFromPSO=function(h){this._excludeFromPSO=h};a.prototype._getExcludeFromHL=function(){return this._excludeFromHL};a.prototype._setExcludeFromHL=function(h){this._excludeFromHL=h};a.prototype._getExcludeFromPreHL=function(){return this._excludeFromPreHL};a.prototype._setExcludeFromPreHL=function(h){this._excludeFromPreHL=h};a.prototype.getIsInstanceNode3D=function(){return this.isInstanceNode3D};a.prototype.setIsInstanceNode3D=function(h){this.isInstanceNode3D=h};return UWA.namespace("THREEDS/Nodes/Mesh",a)});define("Visualization/Mesh3D",["DS/Visualization/Mesh3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/Mesh3D");return b});define("DS/Visualization/PrimitiveIterator",["UWA/Class","DS/Mesh/MeshUtils","DS/Visualization/Mesh3D","DS/Visualization/PathElement"],function(b,e,a,d){var f={};var c=b.extend({init:function(g,h){if(h!==f){return}var j=g;this._primitives=null;this._sgRep=null;this._sgPrimitive=null;if(g instanceof d){j=g.getLastElement()}if(j instanceof a){this._primitives=j.getPrimitives()}else{if(j.sgNode){switch(j.sgNode.type){case 2:this._sgRep=j.sgNode;break;case 3:this._sgPrimitive=j.sgNode;break;default:console.log("PrimitiveIterator: unsupported SubElement type")}}}},getNbPrimitives:function(){if(this._primitives){return this._primitives.length}else{if(this._sgPrimitive){return 1}else{if(this._sgRep){return this._sgRep.primitives.length}}}throw new Error("Internal error")},getConnectivityType:function(h){var g=this._getSGNode(h);return g.group.glType},getLength:function(h){var g=this._getSGNode(h);return g.count},getOffset:function(h){var g=this._getSGNode(h);return g.start},getIndexArray:function(h){var g=this._getSGNode(h);return g.group.geometry.vertexIndexArray},getPositionArray:function(h){var g=this._getSGNode(h);return g.group.geometry.vertexPositionArray},getNormalArray:function(h){var g=this._getSGNode(h);return g.group.geometry.vertexNormalArray},getMaterial:function(h){var g=this._getSGNode(h);return g.group.material},getGas:function(h){var g=this._getSGNode(h);return g.group.gas},getGeomType:function(h){var g=this._getSGNode(h);return e.GeomTypeString[g.group._geomType]},_getSGNode:function(g){if(this._primitives){return this._primitives[g].sgNode}else{if(this._sgPrimitive&&g===0){return this._sgPrimitive}else{if(this._sgRep){return this._sgRep.primitives[g]}}}return undefined}});c.POINTS=0;c.LINES=1;c.LINE_LOOP=2;c.LINE_STRIP=3;c.TRIANGLES=4;c.TRIANGLE_STRIP=5;c.TRIANGLE_FAN=6;c._authorizedTeamsOnly_getKey=function(){return f};return c});define("DS/Visualization/EditableMesh3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement"],function(c,b,e,d){var a=b.extend({init:function(g,f){this._parent(g,f);return this},clone:function(){var f=new c.Mesh(this.mesh3js.geometry,this.mesh3js.material);this.mesh3js.copyInstancingInfos(f);return new THREEDS.Nodes.EditableMesh(f,this.name)},getNodeType:function(){return"Mesh3D"},isEditable:function(){return true},getBuffer:function(f,g){var j=g?g:this.mesh3js.geometry[0];var h=this._getDataArray(f);return h?j[h]:null},getIndexBuffer:function(f){var g=f?f:this.mesh3js.geometry[0];return this._getIndexArray(g)},updateIndexBuffer:function(f,l,n){this._clearGSSOCache();var m=n?n:this.mesh3js.geometry[0];var o=this._getIndexArray(m);if(o&&m.vertexBuffer){var g=m.vertexLayout;var k=g.vertexIndexArray;k.needsUpdate=true;if(k.start===-1){k.start=f;k.count=l}else{var j=Math.min(k.start,f);var h=Math.max(k.start+k.count,f+l);k.start=j;k.count=h-j}}},updateBuffer:function(o,g,l,n){this._clearGSSOCache();var m=n?n:this.mesh3js.geometry[0];var f=this._getDataArray(o);var p=f?m[f]:null;if(p&&m.vertexBuffer){var h=m.vertexLayout;var q=h[f];q.needsUpdate=true;if(q.start===-1){q.start=g;q.count=l}else{var k=Math.min(q.start,g);var j=Math.max(q.start+q.count,g+l);q.start=k;q.count=j-k}}if(m.vertexBuffer){m.vertexBuffer.needsUpdate=true;if(m.vertexBuffer.start===null){m.vertexBuffer.start=g;m.vertexBuffer.count=l}else{var k=Math.min(m.vertexBuffer.start,g);var j=Math.max(m.vertexBuffer.start+m.vertexBuffer.count,g+l);m.vertexBuffer.start=k;m.vertexBuffer.count=j-k}}if(m.wideLines){if(m.wideLines.vertexBuffer){m.wideLines.vertexBuffer.needsUpdate=true}}},addBuffer:function(g,j,h){this._clearGSSOCache();var l=h?h:this.mesh3js.geometry[0];var k=this._getDataArray(g);var f=k?l[k]:null;if(f){return}l.needsUpdate=true;switch(g){case e.VertexComponentEnum.POSITION:l.vertexPositionArray=j;break;case e.VertexComponentEnum.NORMAL:l.vertexNormalArray=j;break;case e.VertexComponentEnum.DIFFUSE_COLOR:l.vertexColorArray=j;break;case e.VertexComponentEnum.TEX_COORD_0:l.vertexUvArray=j;break;case e.VertexComponentEnum.TEX_COORD_1:l.vertexUv2Array=j;break;case e.VertexComponentEnum.TEX_COORD_2:l.vertexTangentArray=j;break;case e.VertexComponentEnum.TEX_COORD_3:l.vertexBinormalArray=j;break;default:break}},removeBuffer:function(g,h){this._clearGSSOCache();var k=h?h:this.mesh3js.geometry[0];var j=this._getDataArray(g);var f=j?k[j]:null;if(!f){return}k.needsUpdate=true;switch(g){case e.VertexComponentEnum.POSITION:k.vertexPositionArray=null;break;case e.VertexComponentEnum.NORMAL:k.vertexNormalArray=null;break;case e.VertexComponentEnum.DIFFUSE_COLOR:k.vertexColorArray=null;break;case e.VertexComponentEnum.TEX_COORD_0:k.vertexUvArray=null;break;case e.VertexComponentEnum.TEX_COORD_1:k.vertexUv2Array=null;break;case e.VertexComponentEnum.TEX_COORD_2:k.vertexTangentArray=null;break;case e.VertexComponentEnum.TEX_COORD_3:k.vertexBinormalArray=null;break;default:break}},_getIndexArray:function(f){return f.vertexIndexArray},_getDataArray:function(f){switch(f){case e.VertexComponentEnum.POSITION:return"vertexPositionArray";case e.VertexComponentEnum.NORMAL:return"vertexNormalArray";case e.VertexComponentEnum.DIFFUSE_COLOR:return"vertexColorArray";case e.VertexComponentEnum.TEX_COORD_0:return"vertexUvArray";case e.VertexComponentEnum.TEX_COORD_1:return"vertexUv2Array";case e.VertexComponentEnum.TEX_COORD_2:return"vertexTangentArray";case e.VertexComponentEnum.TEX_COORD_3:return"vertexBinormalArray";default:break}return null},_clearGSSOCache:function(){var f,g=null,h=null;for(f=0;f<this._occurrences.length;f++){h=this._occurrences[f];g=h.renderable;if(g){g._gsso_cache=null}}}});return UWA.namespace("THREEDS/Nodes/EditableMesh",a)});define("Visualization/EditableMesh3D",["DS/Visualization/EditableMesh3D","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/EditableMesh3D");return b});define("DS/Visualization/SceneGraphFactory",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/EditableMesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/CanvasNodeTexture","DS/SceneGraphNodes/CanvasNode","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/Canvas2DNode","DS/Effects/ComputeSDFFontIterative","DS/Effects/DownSamplingEffect","DS/Effects/ComputeSDFFontMergeTiles"],function(t,j,d,a,r,f,o,k,p,w,l,n,v,x,c,u){var b=new p();var s={textCanvas:null,iterativeCompute:null,downSampling:null,mergeTiles:null};var q=["left","center","right"];var h=[0,0.5,1];var m=["top","bottom","middle","alphabetic","hanging"];var g=[0,1,0.5,1,0];var e={createMeshNode:function(C,B,M,J){var y,K,F,E=(M!==undefined)?M:0,N=(B!==undefined)?B:C.material,O,Q,z,V,D;if(t.disableJHGDev){if((N===undefined)||(N===null)){y=new t.Color();K=new t.Color(6710886);F=new t.Color();N=new t.MeshPhongMaterial({color:y.getHex(),opacity:1});N.line=new t.LineBasicMaterial({color:K.getHex(),lineWidth:1,opacity:1});N.point=new t.ParticleBasicMaterial({color:F.getHex(),size:1,opacity:1})}}O=new f.SGBag();Q=new f.SGRep({cgmId:E,parent:O});f.validatePrimitiveGroup(C);var I=f.checkMeshOptimizable(C);var P=I&&C.editable;var W=I&&(C.editable||C.optimized);var G=!P&&C.sharing;if(W){V=[f.createGeometryOptimized(C,Q)];if(P){V[0].editable=true}}else{if(C.editable){console.warn("Could not make the mesh editable since it does not satisfy the editability rules : no strips and fans, no multi-indexation, 1 buffer per vertex component, 1 index buffer.")}else{if(C.optimized){console.warn("Could not optimize the mesh build since it does not satisfy the editability rules : no strips and fans, no multi-indexation, 1 buffer per vertex component, 1 index buffer.")}}for(var U=0;U<C.buffers.length;U++){var S=C.buffers[U];if(S&&S.component===f.VertexComponentEnum.DIFFUSE_COLOR){if(S.dimension===3){S.dimension=4;S.size*=4/3;var X=S.data;var H=X.length/3;var L=new Float32Array(4*H);var R=0;for(var T=0;T<H;T++){L[R]=X[3*T];L[R+1]=X[3*T+1];L[R+2]=X[3*T+2];L[R+3]=1;R+=4}S.data=L}else{if(S.dimension!==4){console.error("ERROR : Your Color Buffer should have 4 values per vertex (RGBA)")}}break}}z=f.convertToGeometry3js(C,undefined,undefined,undefined,J);z.rep=Q;V=f.divideRep(z);V.sceneGraph=O;if(C.patternOffsets){V.patternOffsets=C.patternOffsets}}D=f.convertTo3jsMesh(V,N,true,G);var A;if(P){A=new a(D)}else{A=new d(D)}if(!t.disableJHGDev&&N){A.setMaterial(N)}if(C.noz){A.setRenderPasses(["noz"])}return A},isReady:function(){return this.root.isReady()},applyMaterialOpacityOverrideToPath:function(){return false},applyMaterialOverrideToPath:function(){return false},removeAnyMaterialOverride:function(){return false},createCuboidNode:function(z){var y=b.CreateVis3DCuboid(z);return this.createMeshNode(y,z.material)},createSphereNode:function(z){var y=b.CreateVis3DSphere(z);return this.createMeshNode(y,z.material,undefined,"mono")},createTubeNode:function(z){var y=b.CreateVis3DTube(z);return this.createMeshNode(y,z.material,undefined,"mono")},createCylinderNode:function(z){var y=b.CreateVis3DCylinder(z);return this.createMeshNode(y,z.material,undefined,"mono")},createConeNode:function(z){var y=b.CreateVis3DCone(z);return this.createMeshNode(y,z.material,undefined,"mono")},createCylinderCustomNode:function(z){var y=b.CreateVis3DCylinderCustom(z);return this.createMeshNode(y,z.material,undefined,"mono")},createLineNode:function(z){var y=b.createLine(z);return this.createMeshNode(y,z.material)},createRectangleNode:function(z){var y=b.createRectangle(z);return this.createMeshNode(y,z.material)},createCircleNode:function(z){var y=b.createCircle(z);return this.createMeshNode(y,z.material)},createTorusNode:function(z){var y=b.createTorus(z);return this.createMeshNode(y,z.material)},createPointsNode:function(z){var y=b.createPoints(z.positions,z.color,z.size,z.layerNb);return this.createMeshNode(y,z.material)},createSimpleMeshNode:function(z){var y=b.createMesh(z.bufferPosition,z.bufferNormal,z.bufferUV,z.bufferIndex,z.glType,z.color,undefined,z.axis,z.layerNb);return this.createMeshNode(y,z.material)},createTextNode:function(y){if(y.sdf){return this.createSDFTextNode.apply(this,arguments)}else{return this.createTextNodeZoomable.apply(this,arguments)}},createSDFTextNode:function(A){A.resolutionCoef=256;if(!A.color){A.color=new t.Color("white")}var ap,S,I,ar,ac,C,P,au,U,T,E,N;ap="font-family: "+A.font+"; font-size: "+A.resolutionCoef+"px;";S=b._determineTextSize(A.text,ap);I=S.width;ar=S.height;ac=I/ar;if(!s.textCanvas){s.textCanvas=document.createElement("canvas")}C=s.textCanvas;C.width=I;C.height=ar;P=C.getContext("2d");au=0;U=0;P.fillStyle="#ffffff";P.fillRect(0,0,I,ar);P.fillStyle="#000000";P.lineWidth=0;P.strokeStyle="#000000";P.font=A.resolutionCoef+"px "+A.font;P.textAlign="left";P.textBaseline="top";P.fillText(A.text,au,U);P.restore();T=I/A.resolutionCoef;E=b.createRectangle(A.fontSize*T,A.fontSize*T/ac,true,undefined,undefined,A.layerNb);E.noz=A.layerNb>0;var ae=null;var ai=50;if(C.width!==0||C.height!==0){if(!s.iterativeCompute){s.iterativeCompute=new x(debugWebGLV6Viewer.renderer.renderer,debugWebGLV6Viewer.renderer.renderTargetPool)}if(!s.downSampling){s.downSampling=new c(debugWebGLV6Viewer.renderer.renderer,debugWebGLV6Viewer.renderer.renderTargetPool)}if(!s.mergeTiles){s.mergeTiles=new u(debugWebGLV6Viewer.renderer.renderer,debugWebGLV6Viewer.renderer.renderTargetPool)}var G=s.iterativeCompute.gl;var Y=performance.now();var R=Y;var al=P.getImageData(0,0,C.width,C.height);var O=new ArrayBuffer(al.data.length);var ah=512;var B=512;var aw=64;var ab=8;var ad=ah/ab;var y=B/ab;var W=Math.floor(C.width/ab);var J=Math.floor(C.height/ab);var X=1+Math.ceil((C.width-ah)/(ah-aw));var V=1+Math.ceil((C.height-B)/(B-aw));var at=new Uint8Array(4*ah*B);var z=new Uint8Array(4*ad*y);var Q=new Uint8Array(4*W*J);var N=null;var L=performance.now();for(var ao=0;ao<V;ao++){var Z=(B-aw)*ao;var F=Z/ab;for(var an=0;an<X;an++){var aa=(ah-aw)*an;var H=aa/ab;var ak=(an===X-1)?(C.width-an*(ah-aw)):ah;var aj=(ao===V-1)?(C.height-ao*(B-aw)):B;var ag=Math.floor(ak/ab);var af=Math.floor(aj/ab);var M=Z*C.width+aa;var D=0;Y=performance.now();for(var K=0;K<B;K++){for(var av=0;av<ah;av++){if(av<ak&&K<aj){var am=M+K*C.width+av;at[D++]=al.data[4*am];at[D++]=al.data[4*am+1];at[D++]=al.data[4*am+2];at[D++]=al.data[4*am+3]}else{at[D++]=255;at[D++]=255;at[D++]=255;at[D++]=255}}}if(!N){N=new t.DataTexture(at,ah,B,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping(),t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.NearestFilter,t.NearestFilter);s.iterativeCompute.setMap(N,ai);s.downSampling.setSize(ah,B);s.downSampling.setInput(s.iterativeCompute.composers[1]);s.mergeTiles.setSize(W,J);s.mergeTiles.setInput(s.downSampling.composers[2])}N.needsUpdate=true;Y=performance.now();for(var aq=0;aq<ai;aq++){s.iterativeCompute.executeStep(aq,(aq===(ai-1)))}s.downSampling.execute();s.mergeTiles.setTileInfos(H,F,ad,y,ag,af);s.mergeTiles.execute()}}Y=performance.now();G.readPixels(0,0,W,J,G.RGBA,G.UNSIGNED_BYTE,Q);ae=new t.DataTexture(Q,W,J,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping(),t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearMipMapLinearFilter);ae.needsUpdate=true;ae.flipY=true;console.log(">>>>> generated SDF from bitmap in "+(performance.now()-R)+"ms")}E.material=new t.ShaderMaterialDS({force:true,side:t.FrontSide,transparent:true,uniforms:{fontMap:{type:"t",value:ae},color:{type:"v3",value:new t.Vector3(A.color.r,A.color.g,A.color.b)},ratio:{type:"f",value:J/W},},vertexShaderPars:"varying vec2 vUv;",vertexShaderBody:[t._DefaultShaderChunk.model_view_transformation_vertex,t._DefaultShaderChunk.model_view_normal_vertex,"vUv = uv;","gl_Position = projectionMatrix * mvPosition;",].join("\n"),fragmentShaderPars:["varying vec2 vUv;","uniform sampler2D fontMap;","uniform vec3 color;","uniform float ratio;"].join("\n"),fragmentShaderBody:["float epsilon = 0.003;","float alphaTest = 0.01;","float texel = texture2D(fontMap, vUv).r;","#ifdef GL_OES_standard_derivatives","    float w = clamp(200.0 * epsilon * (abs(dFdx(texel)) + abs(dFdy(texel))), 0.0, 0.5);","#else","    float w = epsilon;","#endif","float alpha = smoothstep(0.5 - w, 0.5 + w, 1.0 - texel);","alpha = pow(alpha, 1.0/2.2);","if (alpha < alphaTest) discard;","gl_FragColor = vec4(color, alpha);"].join("\n")});return this.createMeshNode(E)},createTextNodeZoomable:function(Q){var O=Q.resolutionCoef||32;var B="font-family: "+Q.font+"; font-size: "+O+"px;";var K=b._determineTextSize(Q.text,B);var A=K.width;var M=K.height;var F=A/M;var E=Q.textAlign?q[Q.textAlign]:"left";var P=Q.textBaseline?m[Q.textBaseline]:"top";var C=Q.textAlign?h[Q.textAlign]:0;var R=Q.textBaseline?g[Q.textBaseline]:0;var z=Q.zoom||1;var J=A/O;var N=Q.fontSize*J*z;var L=Q.fontSize*J/F*z;var G=Q.stroke?Q.stroke:false;var S=A;var I=M;if(Q._fix&&(!S||!I||!isFinite(I)||!isFinite(S))){return null}var y=new w({width:S,height:I,drawCB:function(W,T,V){var X=C*S;var U=R*I;try{T.fillStyle="#"+Q.color.getHexString();T.lineWidth=0;T.strokeStyle="#"+Q.color.getHexString();T.font=(Q.bold?"bold ":"")+O+"px "+Q.font;T.textAlign=E;T.textBaseline=P;if(G){T.strokeText(Q.text,X,U)}else{T.fillText(Q.text,X,U)}if(Q._debug){T.strokeStyle="red";T.moveTo(0,U);T.lineTo(S,U);T.stroke();T.moveTo(0,0);T.moveTo(X,0);T.lineTo(X,I);T.stroke();T.moveTo(0,0)}if(window.WUXDisableTextNodes){T.clearRect(0,0,S,I);return}}catch(Y){}},rectangleTexture:true,maxZoom:8,depthWrite:Q.depthWrite});var D;var H=Q.hotspot||{x:0,y:0};if(Q.bbox){D=new l({name:Q.name,bottomLeftcorner:new t.Vector3(Q.bbox[0],Q.bbox[2],0),widthVector:new t.Vector3(Q.bbox[1]-Q.bbox[0],0,0),heightVector:new t.Vector3(0,Q.bbox[3]-Q.bbox[2],0),canvasNodeTexture:y},e)}else{D=new l({name:Q.name,bottomLeftcorner:new t.Vector3(-H.x*N,-H.y*L,0),widthVector:new t.Vector3(N,0,0),heightVector:new t.Vector3(0,L,0),canvasNodeTexture:y},e)}return D},createCanvasNode:function(y){return new l(y,e)},createCanvas2DNode:function(y){return new v(y,e)},createNodeFromTHREEMesh:function(z){var y=b.convertFromTHREEMesh(z);return this.createMeshNode(y)},createFixedSizeNode:function(z){z=z||{};var y=new n({name:z.name,ratio:z.ratio||1});return y},createGeometry3:function(ar,Q,aa,am){var K,I,Z,H,R,ag,ah,au,G,an,ai,al,J,C,S,V,aj,ab,W,ac,ad,af,aq,U,L,M,P,N,X,A,ao,z,E,B,O,ae,at,T,Y,D,ap,ak;K=false;var y=(ar.byteLength>28);R=null;if(y){if(typeof am==="undefined"){I=new t.Color();Z=new t.Color(3355443);H=new t.Color();am=new t.MeshPhongMaterial({color:I.getHex(),opacity:1,side:t.DoubleSide});am.line=new t.LineBasicMaterial({color:Z.getHex(),lineWidth:1,opacity:1});am.point=new t.ParticleBasicMaterial({color:H.getHex(),size:1,opacity:1});am.force=true}R=new f.Mesh()}ag=0;ah=(new Uint32Array(ar,ag,1))[0];ag+=4;if(y){au=(new Uint32Array(ar,ag,1))[0];ag+=4;G=new f.SGRep({cgmId:au});R.rep=G;an=(new Uint32Array(ar,ag,1))[0];ag+=4;ai=0;al=[];J=[];for(ap=0;ap<an;ap++){C=new Uint32Array(ar,ag,3);ag+=12;S=C[0];V=C[1];aj=C[2];ab=new f.MeshPrimitive(S,0,V,aj);ai+=aj;J.push(ab)}W=new f.DrawingGroup(am,am,4,0,ai);W.geometry=R;W.primitives=J;for(ap=0;ap<J.length;ap++){J[ap].groupIndex=W}R.drawingGroups.push(W);ac=ai;ad=[];af=[];aq=(new Uint32Array(ar,ag,1))[0];ag+=4;for(ap=0;ap<aq;ap++){U=new Uint32Array(ar,ag,3);ag+=12;L=U[0];V=U[1];aj=U[2];M=new f.MeshPrimitive(L,0,V,aj);ai+=aj;af.push(M)}P=new f.DrawingGroup(am.line,am.line,1,ac,ai-ac);P.geometry=R;P.primitives=af;for(ap=0;ap<af.length;ap++){af[ap].groupIndex=P}R.drawingGroups.push(P);N=new Uint32Array(ar,ag,4);ag+=Q?16:12;X=N[0];A=N[1];ao=N[2];z=N[3];E=new Uint32Array(ar,ag,X);ag+=4*X;B=new Float32Array(ar,ag,3*A);ag+=12*A;O=new Float32Array(ar,ag,3*ao);ag+=12*ao;if(Q){ae=new Float32Array(ar,ag,3*z);ag+=12*z;R.vertexUvArray=ae}R.vertexPositionArray=B;R.vertexNormalArray=O;R.vertexIndexArray=E;at=[0,0,0];T=[0,0,0];Y=R.vertexPositionArray.length;if(Y>=3){at=[R.vertexPositionArray[0],R.vertexPositionArray[1],R.vertexPositionArray[2]];T=[R.vertexPositionArray[0],R.vertexPositionArray[1],R.vertexPositionArray[2]];for(ak=0;ak<Y;ak+=3){if(R.vertexPositionArray[ak]<at[0]){at[0]=R.vertexPositionArray[ak]}if(R.vertexPositionArray[ak+1]<at[1]){at[1]=R.vertexPositionArray[ak+1]}if(R.vertexPositionArray[ak+2]<at[2]){at[2]=R.vertexPositionArray[ak+2]}if(R.vertexPositionArray[ak]>T[0]){T[0]=R.vertexPositionArray[ak]}if(R.vertexPositionArray[ak+1]>T[1]){T[1]=R.vertexPositionArray[ak+1]}if(R.vertexPositionArray[ak+2]>T[2]){T[2]=R.vertexPositionArray[ak+2]}}}R.AABB={min:at,max:T};D=f.divideRep(R);R=f.convertTo3jsMesh(D,am);R=new d(R,"dim-"+ah)}if(aa){var F={name:"dim-"+ah,mesh:null};aa.traverse(function(aw,av){if(aw.name===av.name){av.mesh=aw;return true}return false},F);if(F.mesh!==null){aa.remove(F.mesh)}if(y){aa.add(R)}}ar={eventChannel:"/VISU/",eventType:"@onServerDone",eventID:"",from:""};o.publish({event:"/VISU/",data:ar});return R},};return e});define("Visualization/SceneGraphFactory",["DS/Visualization/SceneGraphFactory","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/SceneGraphFactory");return b});define("DS/Visualization/Ambience",["DS/Visualization/ThreeJS_DS","DS/Effects/ConvertCubemapToLatlong","DS/Visualization/SceneGraphFactory","DS/Visualization/Utils"],function(h,j,g,a){var e=function(n,o){switch(n){case"cubemap":return new h.CubeEnvMapping();break;case"environment":return new h.LatLongReflectionMapping();break;case"latlong":return new h.LatLongEnvMapping();break;case"backplate":return new h.SimpleEnvMapping()}};var c=function(r,u){r=r||{};var t=r.image!==undefined?r.image:null;var s=r.format!==undefined?r.format:null;var p=r.type!==undefined?r.type:"url";var q=r.texture!==undefined?r.texture:null;var o=u!==undefined?u:null;var n=function(){console.log("loading image error")};this.stream=function(){if(q){return{texture:q,format:s}}return null};this.getTexture=function(){return q};this.getImage=function(){return t};this.getFormat=function(){return s};this.getType=function(){return p};this.setTexture=function(v){q=v};this.setFormat=function(v){s=v};this.setType=function(v){p=v};this.loadImage=function(v){var w=this.getImage();if(this.getType()=="url"){if(this.getFormat()=="hdr"){q=h.ImageUtils.loadHDRTexture(w,v,o,n,false,false);q.minFilter=h.NearestFilter;q.magFilter=h.NearestFilter}else{if(this.getFormat()=="dds"){q=h.ImageUtils.loadCompressedTexture(w,v,o)}else{q=new h.ImageUtils.loadTexture(w,v,o,null,h.ImageUtils.crossOriginPolicy)}}}if(this.getType()=="urlCube"){q=h.ImageUtils.loadTextureCube(w,v,o)}else{if(w&&w instanceof h.Texture){q=w;if(q.loadEndStatus==="complete"){o()}else{q.onLoadCallbacks.push(o)}}}}};var k=function(){var u=false;this.needUpdate=false;this.needUpdateParameters=false;var w="latlong";var n=[];var o=0;var q=new c();var v="bestFit";var r=1;var x=null;var p=0;var s=this;var t=function(){s.needUpdate=true};this.setFromJson=function(y){u=true;this.needUpdate=true;if(y.type){w=y.type}if(y.sizeScaling){v=y.sizeScaling}if(y.intensity){r=y.intensity}if(y.blur){p=y.blur}if(y.horizonHeight){o=y.horizonHeight}if(y.image&&y.image.texture){q.setTexture(y.image.texture);q.setFormat(y.image.format)}if(y.colors){for(var z=0;z<y.colors.length;z++){n.push(new h.Color().setRGB(y.colors[z][0],y.colors[z][1],y.colors[z][2]))}}};this.stream=function(){if(u){var A={};A.type=w;if(n.length){var z=[];for(var y=0;y<n.length;y++){z.push([n[y].r,n[y].g,n[y].b])}A.colors=z}A.horizonHeight=o;A.sizeScaling=v;A.intensity=r;A.blur=p;A.image=q.stream();return A}return null};this.isActivated=function(){return u};this.getType=function(){return w};this.initDefaultColors=function(y){n=[];for(var z=0;z<y;z++){n.push(new h.Color())}};this.getColors=function(){switch(this.getType()){case"gradient":if(n.length!=2){this.initDefaultColors(2)}break;case"gradient3":if(n.length!=3){this.initDefaultColors(3)}break;case"gradientWithHorizon":if(n.length!=4){this.initDefaultColors(4)}break}return n};this.getHorizonHeight=function(){return o};this.getImage=function(){return q};this.getSizeScaling=function(){return v};this.getIntensity=function(){return r};this.getBlur=function(){return p};this.getBackplateCB=function(){return x};this.setActivated=function(y){if(y!=u){this.needUpdate=true}u=y};this.setType=function(y){if(w!=y){w=y;this.needUpdate=true}if(!u){this.setActivated(true)}};this.setColors=function(y){n=y;var z;switch(n.length){case 2:z="gradient";break;case 3:z="gradient3";break;case 4:z="gradientWithHorizon";break;default:return false}this.setType(z);this.needUpdateParameters=true};this.setHorizonHeight=function(y){o=y;this.needUpdateParameters=true};this.setSizeScaling=function(y){v=y;this.needUpdateParameters=true};this.setIntensity=function(y){r=y;this.needUpdateParameters=true};this.setBlur=function(y){p=y;this.needUpdateParameters=true};this.setBackplateCB=function(y){x=y;this.needUpdateParameters=true};this.hasGradient=function(){return(u&&(w=="gradient"||w=="gradientWithHorizon"))};this.loadImage=function(y){y.type="url";if(y&&y.image&&y.image instanceof h.Texture){y.type="THREETexture"}if(y&&y.image&&y.image instanceof Array){y.type="urlCube"}q=new c(y,t);q.loadImage(e(this.getType(),this.getSizeScaling()))};this.withImage=function(){if(!q.getTexture()){return false}var y=this.getType();if((y=="cubemap")||(y=="latlong")||(y=="backplate")){return true}else{return false}}};var d=function(){var o=false;this.needUpdate=false;this.needUpdateParameters=false;var q="sphere";var p=5000;var n=new h.Vector3(0,0,0.5);this.setFromJson=function(r){o=true;this.needUpdate=true;if(r.type){q=r.type}if(r.size){p=r.size}if(r.shootPosition){n.set(r.shootPosition[0]/r.size,r.shootPosition[1]/r.size,r.shootPosition[2]/r.size)}};this.stream=function(){if(o){var r={};r.type=q;r.size=p;r.shootPosition=n.toArray();return r}return null};this.isActivated=function(){return o};this.getType=function(){return q};this.getSize=function(){return p};this.getShootPosition=function(){return n};this.getWorldShootPosition=function(r){var s=new h.Matrix4().extractRotation(r);return n.clone().applyMatrix4(s)};this.setActivated=function(r){if(r!=o){this.needUpdate=true}o=r};this.setType=function(r){q=r;this.needUpdate=true};this.setSize=function(r){p=r;this.needUpdateParameters=true};this.setShootPosition=function(r){n=r;this.needUpdateParameters=true}};var f=function(){var o=false;this.needUpdate=false;this.needUpdateParameters=false;var t="transparent";var n=0;var u=0;var r=1;var p=0;var s=null;var q=true;this.setFromJson=function(v){o=true;this.needUpdate=true;if(v.type){t=v.type}if(v.height!==undefined){n=v.height}if(v.reflectivity!==undefined){u=v.reflectivity}if(v.glossiness!==undefined){r=v.glossiness}if(v.shadowIntensity!==undefined){p=v.shadowIntensity}if(v.material){s=v.material}};this.stream=function(){if(o){var v={};v.type=t;v.height=n;v.autoHeight=q;v.reflectivity=u;v.glossiness=r;v.shadowIntensity=p;v.material=s;return v}return null};this.isActivated=function(){return o};this.getType=function(){return t};this.getHeight=function(){return n};this.getAutoHeight=function(){return q};this.getReflectivity=function(){return u};this.getGlossiness=function(){return r};this.getShadowIntensity=function(){return p};this.getMaterial=function(){return s};this.setActivated=function(v){if(v!=o){this.needUpdate=true;this.needUpdateParameters=true}o=v};this.setType=function(v){if(o&&(t!=v)){this.needUpdate=true}t=v};this.setHeight=function(v){n=v;this.needUpdateParameters=true};this.setAutoHeight=function(v){q=v;this.needUpdateParameters=true};this.setReflectivity=function(v){if((u===0||v===0)&&(u>0||v>0)){this.needUpdate=true}u=v;this.needUpdateParameters=true};this.setGlossiness=function(v){r=v;this.needUpdateParameters=true};this.setShadowIntensity=function(v){if((p===0||v===0)&&(p>0||v>0)){this.needUpdate=true;this.needUpdateParameters=true}p=v};this.setMaterial=function(v){s=v;this.needUpdateParameters=true}};var m=function(x){var t=false;this.needUpdate=false;this.needUpdateParameters=false;var u=x;var o=new c();var r="latlong";var n=new h.Color(16777215);var p=1;var v=new h.Matrix4();var w=new h.Matrix4();var q=this;var s=function(){q.needUpdate=true};this.setFromJson=function(B,A){t=true;if(B.projection){r=B.projection}if(B.emissionColor){n=n.setRGB(B.emissionColor[0],B.emissionColor[1],B.emissionColor[2])}if(B.emissionValue){p=B.emissionValue}if(u){if(B.matrix){var y=new h.Matrix4().setFromArray(B.matrix);v.multiplyMatrices(v,y)}this.updateMatrix()}else{v.rotateZ(-Math.PI/2);if(B.matrix){var y=new h.Matrix4().setFromArray(B.matrix);var z=new h.Matrix4().getInverse(y);v.multiplyMatrices(v,z)}}if(B.image&&B.image.texture){o.setTexture(B.image.texture);o.setFormat(B.image.format);this.needUpdate=true}};this.updateMatrix=function(){w.identity();w.rotateZ(-Math.PI/2);var y=new h.Matrix4().getInverse(v);w.multiplyMatrices(w,y)};this.stream=function(){if(t){var y={};y.projection=r;y.emissionColor=[n.r,n.g,n.b];y.emissionValue=p;y.matrix=v.elements.slice(0);y.image=o.stream();return y}return null};this.isActivated=function(){return t};this.getImage=function(){return o};this.getProjection=function(){return scale};this.getValue=function(){return value};this.getMatrix=function(){return v};this.getInverseMatrix=function(){return w};this.getIntensity=function(){return p};this.setActivated=function(y){if(y!=t){this.needUpdate=true;t=y}};this.setValue=function(y){value=y;this.needUpdateParameters=true};this.setIntensity=function(y){p=y;this.needUpdateParameters=true};this.setMatrix=function(y){v=y;if(u){this.updateMatrix()}this.needUpdateParameters=true};this.loadImage=function(z){z.type="url";if(z&&z.image&&z.image instanceof h.Texture){z.type="THREETexture"}if(z&&z.image&&z.image instanceof Array){z.type="urlCube"}var y;if(z.cb){y=function(){z.cb();s()}}else{y=s}o=new c(z,y);o.loadImage(new h.LatLongReflectionMapping())};this.updateMatrix()};var l=function(){var o=new h.Vector3(0,0,0);var p=new h.Vector3(0,0,1);var r=new h.Vector3(0,0,0);var n=1;var q=true;this.needUpdateParameters=false;this.setFromJson=function(s){if(s.groundPosition){o=s.groundPosition}if(s.groundNormal){p=s.groundNormal}if(s.sceneHeight){r=s.sceneHeight}if(s.groundScale){n=s.groundScale}if(s.withGround){q=s.withGround}};this.updateFromMatrix=function(s){o.getPositionFromMatrix(s);var t=new h.Matrix4().extractRotation(s);p.set(0,0,1);p.applyMatrix4(t)};this.stream=function(){var s={};s.groundPosition=o;s.groundNormal=p;s.sceneHeight=r;s.groundScale=n;s.withGround=q;return s};this.isWithGround=function(){return q};this.getGroundPosition=function(){return o};this.getGroundNormal=function(){return p};this.getSceneHeight=function(){return r};this.getGroundScale=function(){return n};this.setGroundPosition=function(s){o.copy(s);this.needUpdateParameters=true};this.setWithGround=function(s){q=s};this.setGroundNormal=function(s){console.warn("DEPRECATED: use setTransfrom instead of setGroundNormal")};this.setSceneHeight=function(s){r=s;this.needUpdateParameters=true};this.setGroundScale=function(s){n=s;this.needUpdateParameters=true}};var b=function(ad){var r=this;if(!ad){ad={}}var U=ad.viewer!==undefined?ad.viewer:null;var N=ad.roughnessMap!==undefined?ad.roughnessMap:null;var x="";var af=ad.v2!==undefined?ad.v2:false;var W=new k();var s=new d();var p=new f();var H=new m(af);var aa=new l();var K=new h.Matrix4();var L=new h.Matrix4();var I={};var z=false;var ab=false;var X=[];var y=[];if(ad.finiteEnv){s.setActivated(true)}var B=null;if(ad.autoGroundOffset===false){p.setAutoHeight(false)}var o=new h.Color(0);var A=1;var ac=null;var G=1920;var C=1080;var v=1;var q=false;this.needUpdateIBL=false;this.updateAmbience=function(){Y();t();this.needUpdateIBL=true};this.setGroundOptions=function(ag){if(U){U.setGroundOptions(ag);I=U._getGroundOptions()}};this.updateMatrix=function(){L.identity();L.rotateZ(-Math.PI/2);var ag=new h.Matrix4().getInverse(K);ag.elements[12]=K.elements[12];ag.elements[13]=K.elements[13];ag.elements[14]=K.elements[14];L.multiplyMatrices(L,ag)};this.loadFrom3dx=function(al,ag,am){var ai=al;if(am){af=true}if(ai.name){x=ai.name}if(af){if(ai.transform){var aj=new h.Matrix4().setFromArray(ai.transform);K.multiplyMatrices(K,aj);aa.updateFromMatrix(K)}this.updateMatrix()}else{K.rotateZ(-Math.PI/2);if(ai.transform){var aj=new h.Matrix4().setFromArray(ai.transform);var ak=new h.Matrix4().getInverse(aj);ak.elements[12]=aj.elements[12];ak.elements[13]=aj.elements[13];ak.elements[14]=aj.elements[14];K.multiplyMatrices(K,ak)}}if(ai.backgroundGeometry){s.setFromJson(ai.backgroundGeometry)}if(ai.ground){p.setFromJson(ai.ground)}else{if(am){this.setGroundGeometry(false)}}if(ai.environmentLight){H.setFromJson(ai.environmentLight,am)}p.setAutoHeight(false);if(ai.background){if(ai.background.type=="color"&&ai.background.type=="color"){var ah=ai.background.colors[0];o.setRGB(ah[0],ah[1],ah[2]);A=ah[3];U.setBackgroundColor(o.getHex(),A)}else{W.setFromJson(ai.background)}}if(ag){this.loadImageFrom3dx(ag)}else{this.needUpdateIBL=true}};this.loadImageFrom3dx=function(ag){if(ad.images){if(ad.images.background){W.loadImage({image:ad.images.background.data,format:ad.images.background.format})}if(ad.images.environmentLight){if(ad.images.environmentLight.format=="hdr"){var ah=function(){r.needUpdateIBL=true;var an=r.getEnvironmentLight().getImage().getTexture();if(an&&an.image){var aj=an.image;var al=parseInt(aj.width,10);var ai=parseInt(aj.height,10);if(!isNaN(al)&&!isNaN(ai)){if(!((ai*2)==al)){console.warn("ibl width should be 2x ibl height");N=an}}if(al<8||ai<4){var am=new Uint8Array(8*4*4);for(var ak=0;ak<8*4;ak++){am[ak*4]=aj.data[0];am[ak*4+1]=aj.data[1];am[ak*4+2]=aj.data[2];am[ak*4+3]=aj.data[3]}aj.height="4";aj.width="8";aj.data=am;N=null}}};H.loadImage({cb:ah,image:ad.images.environmentLight.data,format:ad.images.environmentLight.format})}else{if(ad.images.environmentLight.format=="dds"){var ah=function(){if(!ac){ac=new j(U.renderer.renderer,U.renderer.renderTargetPool)}var ai=H.getImage().getTexture();ac.setEnvMap(ai,1);ac.execute();var aj=ac.getResultRGBE(true);H.getImage().setTexture(aj);r.needUpdateIBL=true;N=null};H.loadImage({cb:ah,image:ad.images.environmentLight.data,format:ad.images.environmentLight.format})}else{if(ad.images.environmentLight.format=="png"){var ah=function(){N=H.getImage().getTexture();r.needUpdateIBL=true}}}}}else{this.needUpdateIBL=true}}};this.isFiniteMode=function(){return s.isActivated()};this.getTransform=function(){return K};this.setTransform=function(ag){K=ag;if(af){this.updateMatrix();aa.updateFromMatrix(K)}q=true};this.getEnvironmentLightMatrix=function(ag){if(ag&&af){return H.getInverseMatrix()}return H.getMatrix()};this.getGroundOptions=function(){return I};this.setEnvironmentLightMatrix=function(ag){H.setMatrix(ag);q=true};this.getBackgroundGeometryEditor=function(){return aa};this.getBackgroundGeometry=function(){return s};this.getBackground=function(){return W};this.getGround=function(){return p};this.getEnvironmentLight=function(){return H};this.getBackgroundColor=function(){return o};this.getBackgroundAlpha=function(){return A};this.setBackgroundAlpha=function(ag){A=ag};this.setBackgroundColor=function(ag){o=new h.Color(ag)};this.update=function(){if(W.needUpdate){t();W.needUpdate=false;W.needUpdateParameters=false;H.needUpdateParameters=false}if(s.needUpdate){t();s.needUpdate=false;W.needUpdateParameters=false;H.needUpdateParameters=false;s.needUpdateParameters=false}if(H.needUpdate){H.needUpdate=false}if(p.needUpdate){p.needUpdate=false;Y()}if(q||p.needUpdateParameters||W.needUpdateParameters||H.needUpdateParameters||s.needUpdateParameters||aa.needUpdateParameters){V();W.needUpdateParameters=false;H.needUpdateParameters=false;p.needUpdateParameters=false;s.needUpdateParameters=false;aa.needUpdateParameters=false;q=false}};var t=function(){if(W.isActivated()){switch(W.getType()){case"gradient":case"gradient3":case"gradientWithHorizon":P();break;case"cubemap":if(s.isActivated()){if(s.getType()=="sphere"){O()}}else{T()}break;case"latlong":if(s.isActivated()){if(s.getType()=="sphere"){O()}}else{F()}break;case"backplate":ae();break;default:return false}}if(B){B.side=h.DoubleSide;B.depthTest=false;B.force=true;B.forceSide=true}V()};var w=function(){if(U&&U.renderer&&U.renderer.mirrorBlendPass){return U.renderer.mirrorBlendPass}};var V=function(){if(W.isActivated()){if(W.withImage()){var ah=W.getImage();B.uniforms.tEnvMap.value=ah.getTexture();if(B.uniforms.tEnvMap.value.envMapExposure){B.uniforms.tEnvMap.value.envMapExposure=W.getIntensity()}B.uniforms.envMapExposure.value=W.getIntensity();if(B.defines.HDR!=(ah.getFormat()=="hdr")){B.defines.HDR=(ah.getFormat()=="hdr");B.needsUpdate=true}if(B.defines.sRGB==(ah.getFormat()=="hdr")){B.defines.sRGB=!(ah.getFormat()=="hdr");B.needsUpdate=true}}if(s.isActivated()){if(W.getType()=="gradient"||W.getType()=="gradientWithHorizon"||W.getType()=="gradient3"){u(W.getType()=="gradientWithHorizon")}else{if(W.getType()=="backplate"){n()}else{R()}}}else{if(W.getType()=="latlong"){D()}if(W.getType()=="cubemap"){Z()}if(W.getType()=="backplate"){n()}if(W.getType()=="gradient"||W.getType()=="gradientWithHorizon"||W.getType()=="gradient3"){u(W.getType()=="gradientWithHorizon")}}}if(H.isActivated()){var ag=H.getImage().getTexture();if(ag){ag.envMapExposure=H.getIntensity()}if(N){N.envMapExposure=H.getIntensity()}}if(p.isActivated()){M()}};var M=function(){if(p.getReflectivity()>0){var ag=w();if(ag){ag.uniforms.reflectivity.value=p.getReflectivity()}}};var u=function(ak){B.uniforms.colors.value=[];var ag=B.uniforms.colors.value;var ah=W.getColors();for(var aj=0;aj<ah.length;aj++){var ai=ah[aj];ag.push(ai.r);ag.push(ai.g);ag.push(ai.b)}if(ak){B.uniforms.horizonHeight.value=W.getHorizonHeight()}};var n=function(){J()};var Z=function(){var ah=W.getImage();var ag=ah.getTexture();if(ag){if(af){B.uniforms.ambienceMatrix.value=L}else{B.uniforms.ambienceMatrix.value=K}}};var D=function(){var aj=W.getImage();var ai=aj.getTexture();if(ai){ai.minFilter=h.LinearFilter;var ah=2048;var ag=1024;if(ai.image){ah=ai.image.width;ag=ai.image.height}else{if(ai.width&&ai.height){ah=ai.width;ag=ai.height}}B.uniforms.envMapHDRSize.value.x=parseInt(ah);B.uniforms.envMapHDRSize.value.y=parseInt(ag);if(af){B.uniforms.ambienceMatrix.value=L}else{B.uniforms.ambienceMatrix.value=K}if(W.getBlur()&&N){B.uniforms.tEnvMap2.value=N;B.uniforms.blurCoef.value=W.getBlur();if(!B.defines.ENVMAP2){B.defines.ENVMAP2=true;B.needsUpdate=true}}}};var R=function(){var aj=W.getImage();var ai=aj.getTexture();if(ai){ai.minFilter=h.LinearFilter;var ah=2048;var ag=1024;if(ai.image){ah=ai.image.width;ag=ai.image.height}else{if(ai.width&&ai.height){ah=ai.width;ag=ai.height}}B.uniforms.tEnvMap.value=ai;if(af){B.uniforms.ambienceMatrix.value=L;B.uniforms.groundHeight.value=s.getWorldShootPosition(K)}else{B.uniforms.ambienceMatrix.value=K;B.uniforms.groundHeight.value=s.getShootPosition()}B.uniforms.envMapHDRSize.value.x=parseInt(ah);B.uniforms.envMapHDRSize.value.y=parseInt(ag);B.uniforms.groundPosition.value=aa.getGroundPosition();B.uniforms.groundNormal.value=aa.getGroundNormal();B.uniforms.groundOffset.value=p.getHeight();B.uniforms.sceneHeight.value=aa.getSceneHeight();B.uniforms.groundRadius.value=s.getSize();B.uniforms.groundScale.value=aa.getGroundScale();B.uniforms.withGround.value=aa.isWithGround();if(B.defines.LATLONG_MAP!=!(W.getType()=="cubemap")){B.defines.LATLONG_MAP=!(W.getType()=="cubemap");B.needsUpdate=true}}};var P=function(){var ag=W.getType();var ai;switch(ag){case"gradient":ai=h.GradientBackgroundShader2;break;case"gradient3":ai=h.GradientBackgroundShader3;break;case"gradientWithHorizon":ai=h.GradientBackgroundShader4;break;default:return false}var ah={fragmentShader:ai.fragmentShader,vertexShader:ai.vertexShader,uniforms:ai.uniforms,};B=new h.ShaderMaterial(ah)};var O=function(){var ah=h.FiniteEnvMap;var ag={fragmentShader:ah.fragmentShader,vertexShader:ah.vertexShader,uniforms:ah.uniforms,defines:ah.defines};ah.defines.LATLONG_MAP=(W.getType()=="latlong");if(af){ah.defines.AMBIENCE_V2=true}else{ah.defines.AMBIENCE_V2=false}B=new h.ShaderMaterial(ag)};var Y=function(){if(U){if(p.isActivated()&&p.getReflectivity()>0){U.setMirror(true,undefined,null,p.getReflectivity(),p.getGlossiness())}else{U.setMirror(false)}if(p.isActivated()&&p.getShadowIntensity()>0){U.setShadowPlane(true);U.setGroundShadow(true)}else{U.setGroundShadow(false)}}};var F=function(){var ai=W.getImage();var ah=h.LatLongMapShader;var ag={fragmentShader:ah.fragmentShader,vertexShader:ah.vertexShader,uniforms:ah.uniforms,defines:ah.defines};ag.defines.HDR=(ai.getFormat()=="hdr");ag.defines.sRGB=(!(ai.getFormat()=="hdr"));if(N&&(W.getBlur()>=0)){ag.defines.ENVMAP2=true}ag.defines.sRGB=(!(ai.getFormat()=="hdr"));B=new h.ShaderMaterial(ag)};var T=function(){var ah=h.CubeMapShader;var ag={fragmentShader:ah.fragmentShader,vertexShader:ah.vertexShader,uniforms:ah.uniforms,defines:ah.defines};B=new h.ShaderMaterial(ag)};var ae=function(){var ai=W.getImage();var ah=h.SimpleMapShader;var ag={fragmentShader:ah.fragmentShader,vertexShader:ah.vertexShader,uniforms:h.UniformsUtils.clone(h.SimpleMapShader.uniforms),defines:ah.defines};ag.defines.HDR=(ai.getFormat()=="hdr");ag.defines.sRGB=(!(ai.getFormat()=="hdr"));B=new h.ShaderMaterial(ag);J()};var S=function(aj){var ak;if(aj.url){if(aj.url instanceof Array){ak=h.ImageUtils.loadTextureCube(aj.url,aj.mapping,aj.onMapsLoaded)}else{if(aj.hdr){ak=h.ImageUtils.loadHDRTexture(aj.url,aj.mapping);aj.hdr=true;ak.onLoadCallbacks.push(aj.onMapsLoaded)}else{var ah=aj.url.split(".");var ag=ah[ah.length-2];var al=ah[ah.length-1];al=al.toLowerCase();if(al=="hdr"){ak=h.ImageUtils.loadHDRTexture(aj.url,aj.mapping);aj.hdr=true;ak.onLoadCallbacks.push(aj.onMapsLoaded)}else{if(al=="dds"){var ai=h.ImageUtils.loadCompressedTexture(iParams.envMap,new h.LatLongReflectionMapping(),function(){if(!ac){ac=new j(U.renderer.renderer,U.renderer.renderTargetPool)}ac.setEnvMap(ai,1);ac.execute();ak=ac.getResultRGBE(true);aj.onMapsLoaded()})}else{ak=new h.ImageUtils.loadTexture(aj.url,aj.mapping,aj.onMapsLoaded,null,h.ImageUtils.crossOriginPolicy)}}}}}return ak};var E=function(am,ag,ai){var ah=W.getImage();ah.setTexture(am);var an=ai?"hdr":"png";ah.setFormat(an);var ak=am;var ao=!!ai;var al;var aj;if(ag instanceof h.SimpleEnvMapping){al="backplate";aj="simple"}else{if(ag instanceof h.SimpleEnvMappingCustom){al="backplate";aj="custom"}else{if(ag instanceof h.SimpleEnvMappingFit){al="backplate";aj="fit"}else{if(ag instanceof h.SimpleEnvMappingPreserveRatio){al="backplate";aj="bestFit"}else{if(ag instanceof h.SimpleEnvMappingFitWidth){al="backplate";aj="fitWidth"}else{if(ag instanceof h.SimpleEnvMappingFitHeight){al="backplate";aj="fitHeight"}else{if(ag instanceof h.LatLongEnvMapping){al="latlong"}else{if(ag instanceof h.CubeEnvMapping){al="cubemap"}}}}}}}}if(ao){ak.minFilter=h.NearestFilter;ak.magFilter=h.NearestFilter;ak.wrapS=h.RepeatWrapping;ak.wrapT=h.RepeatWrapping}if((al!=W.getType())||(!B)||((W.getType()=="backplate")&&(W.getSizeScaling()!=aj))){W.setType(al);if(aj){W.setSizeScaling(aj)}t()}else{q=true}};var J=function(){var ai=W.getImage();var an=ai.getTexture();if(W.getType()=="backplate"&&an){var ag=2048;var ao=1024;if(an.image){ag=an.image.width;ao=an.image.height}else{if(an.width&&an.height){ag=an.width;ao=an.height}}var ak=ag/ao;var am=G/C;var al=0;var aj=0;if(W.getSizeScaling()=="custom"){var ah=W.getBackplateCB();if(ah){ah({textureWidth:ag,textureHeight:ao,viewportWidth:G,viewportHeight:C,devicePixelRatio:v})}}else{if(W.getSizeScaling()=="simple"){ag=G;ao=C;B.uniforms.invSize.value.set(1/(v*ag),1/(v*ao))}else{if(W.getSizeScaling()=="fitHeight"){ag=C*ak;ao=C;al=0.5*(G-ag);B.uniforms.offset.value.set((v*al),(v*aj));B.uniforms.invSize.value.set(1/(v*ag),1/(v*ao))}else{if(W.getSizeScaling()=="fitWidth"){ag=G;ao=G/ak;aj=0.5*(C-ao);B.uniforms.offset.value.set((v*al),(v*aj));B.uniforms.invSize.value.set(1/(v*ag),1/(v*ao))}else{if(W.getSizeScaling()=="bestFit"){if(ak>am){ao=C;ag=ao*ak}else{ag=G;ao=ag/ak}B.uniforms.offset.value.set((v*al),(v*aj));B.uniforms.invSize.value.set(1/(v*ag),1/(v*ao))}else{if(W.getSizeScaling()=="fit"){if(ak>am){ag=G;ao=G/ak;aj=0.5*(C-ao)}else{ag=C*ak;ao=C;al=0.5*(G-ag)}B.uniforms.offset.value.set((v*al),(v*aj));B.uniforms.invSize.value.set(1/(v*ag),1/(v*ao))}}}}}}}};var Q=function(){var ag=g.createSphereNode({radius:1,sag:64,material:B});var ah=ag._occurrences[0].renderable;ah.frustumCulled=false;ah.renderDepth=2;ah.visible=true;ah.visibilityFree=true;return ah};this.getIblMap=function(){if(H.isActivated()){var ag=H.getImage().getTexture();if(ag&&ag.loadEndStatus=="complete"){return ag}}return null};this.getRoughnessMap=function(){if(H.isActivated()){return N}return null};this.getRadiusEnvMap=function(){return(s.getSize()*aa.getGroundScale())*2};this.getCenter=function(){var ah;var ag;if(af){ah=aa.getSceneHeight().clone();ah.multiplyScalar(s.getSize());ah.add(aa.getGroundPosition())}else{ah=aa.getGroundNormal().clone().multiply(aa.getSceneHeight());ah.multiplyScalar(s.getSize());ag=aa.getGroundPosition().clone().applyMatrix4(K);ah.add(ag)}return ah};this.getRadius=function(){var ag=s.getSize()*aa.getGroundScale();return ag};this.getProjectionCenter=function(){var ah;var ag;if(af){ah=s.getShootPosition().clone();ah.multiplyScalar(s.getSize());ah.add(aa.getGroundPosition())}else{ah=aa.getGroundNormal().clone().multiply(s.getShootPosition());ah.multiplyScalar(s.getSize());ag=aa.getGroundPosition().clone().applyMatrix4(K);ah.add(ag);ah.z+=p.getHeight()}return ah};this.updateCamera=function(aj,ak,ah){if(B){if(W.getType()=="latlong"||W.getType()=="gradientWithHorizon"||W.getType()=="gradient"||W.getType()=="gradient3"){var al=B.uniforms;if(al&&al.startOffset){if(ah.fullWidth){al.invScreenSize.value.x=1/(ah.width);al.invScreenSize.value.y=1/(ah.height);al.startOffset.value.x=ah.x/ah.fullWidth;al.endOffset.value.y=1-(ah.y/ah.fullHeight);al.endOffset.value.x=(ah.x+ah.width)/ah.fullWidth;al.startOffset.value.y=1-((ah.y+ah.height)/ah.fullHeight)}else{var ai=ak.renderer.getViewportSize();al.invScreenSize.value.x=1/ai.width;al.invScreenSize.value.y=1/ai.height;al.startOffset.value.x=0;al.startOffset.value.y=0;al.endOffset.value.x=1;al.endOffset.value.y=1}}if(al&&al.cameraSight){var ag=Math.tan(0.5*h.Math.degToRad(aj.camera.fov));al.cameraSight.value.copy(aj.getSightDirection());al.cameraUp.value.copy(aj.camera.up).multiplyScalar(ag);al.cameraRight.value.crossVectors(aj.getSightDirection(),aj.camera.up);al.cameraRight.value.multiplyScalar(aj.camera.aspect*ag);al.invScreenSize.value.x=1/ak.deviceWidth;al.invScreenSize.value.y=1/ak.deviceHeight}}}};this.resize=function(ah,ai,ag){G=ah;C=ai;v=ag;if(W.getType()=="backplate"){J()}};this.getSphere=function(){return Q()};this.createGroundGeometry=function(){var ag=g.createCircleNode({radius:p.getScale(),segments:512,fill:true,material:p.getMaterial()?p.getMaterial():new h.PhysicalMaterial()});return ag};this.updateSphere=function(ah,ak,ai){var ag,aj;if(s.isActivated()){ag=new h.Vector3().getPositionFromMatrix(K);if(!af){ag.add(aa.getGroundPosition())}aj=s.getSize()*aa.getGroundScale()*2}else{ag=ak;aj=ah}ai.position.set(ag.x,ag.y,ag.z);ai.scale.set(aj,aj,aj);ai.updateMatrix();if(B){ai.material=B}ai.visible=true};this.updateGround=function(ah){var ai=p.getScale();var ag=aa.getGroundPosition();ag.z+=p.getHeight();ag.applyMatrix4(K);ah.position.set(ag.x,ag.y,ag.z);ah.scale.set(ai,ai,ai);ah.updateMatrix();if(p.getMaterial()){ah.material=p.getMaterial()}ah.visible=true};this.setIblMap=function(ag){var ai=this;var ah=null;ag.onMapsLoaded=function(){var aj=ah;H.getImage().setTexture(aj);H.setActivated(true);aj.minFilter=h.NearestFilter;aj.magFilter=h.NearestFilter;aj.wrapS=h.RepeatWrapping;aj.wrapT=h.RepeatWrapping;if(ag.mapping){aj.mapping=ag.mapping}if(ag.hdr){aj.hdr=ag.hdr}if(ag.generateRougnessMap){var al=U.getRenderer().ambianceGenerators;ab=false;for(var ak=0;ak<y.length;ak++){y[ak].setIblMap({texture:map,mapping:ag.mapping,hdr:ag.hdr})}y=[];if(ag.doneCallback){ag.doneCallback()}ai.needUpdateIBL=true;N=null}if(ag.doneCallback&&!ag.generateRougnessMap){ab=false;for(var ak=0;ak<y.length;ak++){y[ak].setIblMap({texture:map,mapping:ag.mapping,hdr:ag.hdr})}y=[];ag.doneCallback();ai.needUpdateIBL=true}};if(ag.url){ab=true;ah=S(ag)}else{if(ag.texture&&ag.texture instanceof h.Texture){ab=true;ah=ag.texture;if(ah.loadEndStatus==="complete"){ag.onMapsLoaded()}else{ah.onLoadCallbacks.push(ag.onMapsLoaded)}}}};this.setReflectionMap=function(ak){var am=this;var al=null;var aj=ak.url;var ai=null;ak.onMapsLoaded=function(){var an=al;H.getImage().setTexture(an);H.setActivated(true);N=ai;an.minFilter=N.minFilter=h.NearestFilter;an.magFilter=N.magFilter=h.NearestFilter;an.wrapS=N.wrapS=h.RepeatWrapping;an.wrapT=N.wrapT=h.RepeatWrapping;ak.doneCallback&&ak.doneCallback();am.needUpdateIBL=true};var ag=(a.getExtension(aj)==="dds");if(ag){var ah=h.ImageUtils.loadCompressedTexture(aj,new h.LatLongReflectionMapping(),function(){if(!ac){ac=new j(U.renderer.renderer,U.renderer.renderTargetPool)}ac.setEnvMap(ah,1);ac.execute();ai=null;al=ac.getResultRGBE(true);ak.onMapsLoaded()})}};this.setRoughnessMap=function(ah){var ai=this;var ag=null;ah.onMapsLoaded=function(){N=ag;N.minFilter=h.NearestFilter;N.magFilter=h.NearestFilter;N.wrapS=h.RepeatWrapping;N.wrapT=h.RepeatWrapping;if(ah.mapping){ag.mapping=ah.mapping}if(ah.hdr){ag.hdr=ah.hdr}ah.doneCallback&&ah.doneCallback();ai.needUpdateIBL=true};if(ah.url){ag=S(ah)}else{if(ah.texture&&ah.texture instanceof h.Texture){ag=ah.texture;if(ag.loadEndStatus==="complete"){ah.onMapsLoaded()}else{ag.onLoadCallbacks.push(ah.onMapsLoaded)}}}};this.setBackplateMap=function(ag){var ah=null;var ai=this;ag.onMapsLoaded=function(){ai.setFiniteMode(false);E(ah,ag.mapping,ag.hdr);ag.doneCallback&&ag.doneCallback()};if(ag.url){ah=S(ag)}else{if(ag.texture&&ag.texture instanceof h.Texture){ah=ag.texture;if(!ag.mapping){ag.mapping=ah.mapping}if(!ag.hdr){ag.hdr=ah.hdr}if(ah.loadEndStatus==="complete"){ag.onMapsLoaded()}else{ah.onLoadCallbacks.push(ag.onMapsLoaded)}}}};this.setBackGroundMap=function(ag){var ah=null;ag.onMapsLoaded=function(){E(ah,ag.mapping,ag.hdr);z=false;for(var ai=0;ai<X.length;ai++){X[ai].setBackGroundMap({texture:ah,mapping:ag.mapping,hdr:ag.hdr})}X=[];ag.doneCallback&&ag.doneCallback()};if(ag.url){z=true;ah=S(ag)}else{if(ag.texture&&ag.texture instanceof h.Texture){z=true;ah=ag.texture;if(!ag.mapping){ag.mapping=ah.mapping}if(!ag.hdr){ag.hdr=ah.hdr}if(ah.loadEndStatus==="complete"){ag.onMapsLoaded()}else{ah.onLoadCallbacks.push(ag.onMapsLoaded)}}}};this.setExposure=function(ag){W.setIntensity(ag);H.setIntensity(ag)};this.getEnvMapExposure=function(){return W.getIntensity()};this.setFiniteMode=function(ag){if(s.isActivated()==ag){return}s.setActivated(ag)};this.setGroundGeometry=function(ag){aa.setWithGround(ag)};this.getGroundPosition=function(){return aa.getGroundPosition()};this.setGroundPosition=function(ag){aa.setGroundPosition(ag)};this.setGroundNormal=function(ag){console.warn("DEPRECATED: use setTransfrom instead of setGroundNormal");aa.setGroundNormal(ag)};this.setSceneHeight=function(ag){aa.setSceneHeight(ag)};this.setGroundHeight=function(ag){s.setShootPosition(ag)};this.setGroundRadius=function(ag){s.setSize(ag);if(U&&U.planeV2&&U.planeGrid){U.planeGrid.size=ag*2}};this.displayGround=function(ag){p.setActivated(ag);if(U){U.displayInfinitePlane(ag)}};this.setGroundScale=function(ag){aa.setGroundScale(ag)};this.updateScene=function(ag){aa.setGroundPosition(ag)};this.isAutoGroundOffset=function(){return p.getAutoHeight()};this.setAutoGroundOffset=function(ag){p.setAutoHeight(ag)};this.setGroundOffset=function(ag){p.setHeight(ag)};this.setEnvMapBlur=function(ag){W.setBlur(ag)};this.getOffset=function(){return p.getHeight()};this.setEnvMapOffset=function(ag){K.makeRotationZ(ag);H.getMatrix().makeRotationZ(ag);if(af){H.updateMatrix();this.updateMatrix()}q=true};this.setGroundReflectivitiy=function(ag){p.setReflectivity(ag);p.setActivated(true)};this.setGroundReflectivity=function(ag){p.setReflectivity(ag);p.setActivated(true)};this.setGroundShadowIntensity=function(ag){p.setShadowIntensity(ag);p.setActivated(true)};this.isUsedMirror=function(){return(p.isActivated()&&p.getType()=="transparent"&&p.getReflectivity()>0)};this._setMirror=function(ag){if(ag||p.getType()=="transparent"){p.setActivated(ag);p.setType("transparent");p.setReflectivity(0.3)}};this.getGroundGlossiness=function(){return p.getGlossiness()};this.setCustomBackplateCallback=function(ag){W.setType("backplate");W.setSizeScaling("custom");W.setBackplateCB(ag)};this.setBackplateOffset=function(ag,ah){if(B&&B.uniforms&&B.uniforms.offset){B.uniforms.offset.value.set(ag,ah)}};this.setBackplateSize=function(ah,ag){if(B&&B.uniforms&&B.uniforms.invSize){B.uniforms.invSize.value.set(ah,ag)}};this.setGroundGlossiness=function(ag){p.setGlossiness(ag)};this.setTranslation=function(ag){K.translate(ag);if(af){this.updateMatrix()}};this.dispose=function(){if(N){N.dispose()}if(this.getIblMap()){this.getIblMap().dispose()}var ah=W.getImage();var ag=ah.getTexture();if(ag){ag.dispose()}W.setActivated(false);H.setActivated(false);s.setActivated(false);this.needUpdateIBL=true};this.clone=function(ak){if(!ak){ak={}}var aj=ak.viewer!==undefined?ak.viewer:null;var ah={roughnessMap:N,viewer:aj};var ag={};ag.name=x;ag.backgroundGeometryEditor=aa.stream();ag.transform=K.elements.slice(0);ag.background=W.stream();ag.backgroundGeometry=s.stream();ag.environmentLight=H.stream();ag.ground=p.stream();ah.v2=af;ah.ambiance=ag;var ai=new b(ah);ai.getGround().setAutoHeight(true);ai.setBackgroundColor(o.getHex());ai.setBackgroundAlpha(A);if(aj){aj.setBackgroundColor(o.getHex(),A)}if(z){X.push(ai)}if(ab){y.push(ai)}return ai};this.updateMatrix();if(ad.ambiance){this.loadFrom3dx(ad.ambiance,ad.images,ad.from3DX)}t()};return b});define("DS/Visualization/PolygonTessellator",["UWA/Class","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Mesh/MeshUtils","libtess/libtess.min"],function(b,h,g,f,a){var c=0;var d=b.extend({init:function(){this.polygons=[];this.polygonGroupEnd=[];this.currentPolygon=this._createEmptyPolygon()},addPointToCurrentPolygonLoop:function(n,o,m){if(this.currentPolygon.points.length===0){this.currentPolygon.userData=m}var l;if(this.currentPolygon.points.length>0){l=this.currentPolygon.points.length-2;if(this.currentPolygon.points[l]===n&&this.currentPolygon.points[l+1]===o){return}}this.currentPolygon.points.push(n);this.currentPolygon.points.push(o)},closeCurrentPolygonLoop:function(){if(this.currentPolygon.points.length>2){this.currentPolygon.closed=true;this.polygons.push(this.currentPolygon)}this.currentPolygon=this._createEmptyPolygon()},endCurrentPolygon:function(){this._startNewPolygon();this.polygonGroupEnd.push(this.polygons.length)},createNode3D:function(w,t){var s,v,x;var C;var B=new g();var u,D;var y,A=[];var o,l;var n=0,m=this.polygonGroupEnd.length;for(o=n;o<m;o++){l=true;u=[];for(s=(o===0)?0:this.polygonGroupEnd[o-1];s<this.polygonGroupEnd[o]&&l;s++){if(this.polygons[s].closed){D=[];v=this.polygons[s].points;for(x=0;x<v.length;x+=2){D.push(v[x],-v[x+1])}D.push(v[0],-v[1]);u.push(D)}else{l=false}}if(u.length&&l){y=j(u,t);A=A.concat(y)}else{if(u.length){throw new Error("fill open polygon")}}}if(A.length===0){return null}var p=new Uint32Array(A.length/3);for(var E=0;E<p.length;++E){p[E]=E}var r=[];for(E=0;E<A.length;E+=3){r.push(0,0,1)}var q=h.createSimpleMeshNode({bufferPosition:A,bufferIndex:p,glType:f.ConnectivityTypeEnum.TRIANGLES,material:w,bufferNormal:r});B.addChild(q);return B},_startNewPolygon:function(){if(this.currentPolygon.points.length>2){this.polygons.push(this.currentPolygon)}this.currentPolygon=this._createEmptyPolygon()},_createEmptyPolygon:function(){return{points:[],closed:false,userData:null,id:c++}}});var e=(function k(){function n(s,r){r[r.length]=s[0];r[r.length]=s[1];r[r.length]=s[2]}function q(r){if(r!==a.primitiveType.GL_TRIANGLES){console.log("expected TRIANGLES but got type: "+r)}}function l(r){console.log("error callback");console.log("error number: "+r)}function p(t,s,r){return[t[0],t[1],t[2]]}function m(r){}var o=new a.GluTesselator();o.gluTessCallback(a.gluEnum.GLU_TESS_VERTEX_DATA,n);o.gluTessCallback(a.gluEnum.GLU_TESS_BEGIN,q);o.gluTessCallback(a.gluEnum.GLU_TESS_ERROR,l);o.gluTessCallback(a.gluEnum.GLU_TESS_COMBINE,p);o.gluTessCallback(a.gluEnum.GLU_TESS_EDGE_FLAG,m);return o})();function j(r,q){e.gluTessNormal(0,0,1);var o=[];e.gluTessBeginPolygon(o);for(var n=0;n<r.length;n++){e.gluTessBeginContour();var m=r[n];for(var l=0;l<m.length;l+=2){var p=[m[l],m[l+1],q];e.gluTessVertex(p,p)}e.gluTessEndContour()}e.gluTessEndPolygon();return o}return d});define("DS/Visualization/SceneGraphUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Visualization/PathElement","DS/SceneGraphNodes/AxisSystemNode"],function(o,b,l,q,c,j,p,g,f,e,d,n,h,m){var r=null;var a={applyMaterialToOccurrencePath:function(s,t,v){var w=s._getRenderableOccurrencesFromOccurrencePath(t),u;for(u=0;u<w.length;u++){w[u].material=v}return},applyMaterialToPath:function(t,s){return l._applyMaterialToPath(t,s)},applyVisibilityToPath:function(A,s){if(A===null){return false}var y=A._getRenderableOccurrences();var u=y.length;var x,t;for(x=0;x<u;x++){t=y[x];if(t){t._gsso_cache=null}}var v=A.getLastElement();if(v===null){return false}if(v instanceof l){if(s===2){v.setVisibility(!v.visible,true)}else{v.setVisibility(s,true)}}else{if(u!==1){return false}var z=[];if(v.getType()==="rep"){var w=v.getChildren();for(var x=0;x<w.length;x++){z.push(w[x].sgNode)}}else{if(v.getType()==="primitive"){z.push(v.sgNode)}}if(y[0].layer===null){y[0].initLayers(1)}y[0].layer.addPrimitivesToLayers(z,s)}return true},getVisibilityFromPath:function(C){if(!C){return false}var A=C._getRenderableOccurrences();var t=A.length;var v=C.getLastElement();if(!v){return false}if(v instanceof l){return v.isVisible()}else{if(t!==1){return false}var s=A[0];if(s.layer===null){return true}var z;if(v.getType()==="rep"){var x=v.getChildren();if(x[0]){z=x[0].sgNode}}else{if(v.getType()==="primitive"){z=v.sgNode}}for(var y=0;y<s.layer.layers.length;y++){var B=s.layer.layers[y].drawableGroup;var u=s.layer.layers[y].drawableInterval;for(var w=u.primitiveStart;w<u.primitiveStart+u.primitiveCount;w++){if(B.primitives[w]===z){return(u.layerNum===1)}}}}return false},getOrientedBoundingBoxFromPathElements:function(v,z,x){var t=new o.Box3();var w=new o.Matrix4().extractRotation(z);for(var u=0;u<v.length;++u){var y=v[u].getOrientedBoundingBox(z,x);if(y){t=t.union(y)}}var s={cornerPoint:new o.Vector3().copy(t.min).applyMatrix4(z),firstAxis:new o.Vector3(t.max.x-t.min.x,0,0).applyMatrix4(w),secondAxis:new o.Vector3(0,t.max.y-t.min.y,0).applyMatrix4(w),thirdAxis:new o.Vector3(0,0,t.max.z-t.min.z).applyMatrix4(w),localBBox:t};return s},getMaterialsFromPath:function(v,t,x){v.getRootNode()._tryOverridesUpdate(v);var y=t._getUniqueOccurrence(),s;var B=null,A=null,z=null;if(y&&y.renderable){A=[];this._traversePathMaterials(y,function u(C){if(A.indexOf(C)<0){A.push(C)}},function w(){},null,false);if(y.overrideLink){z={color:y.overrideLink.getColor(),opacity:y.overrideLink.getOpacity(),material:y.overrideLink.getFullMaterial()}}B={materials:A,overrides:z}}return B},buildModelIdPath:function(v){var s={elements:[],subElements:[]};var x,u,t;var w=v.getLastElement();if(w instanceof m&&w._sgRep){x={id:w._sgRep.cgmId,namingContext:w._sgRep.namingContext};s.elements.push(x)}else{for(u=0;u<v.internalPath.length;u++){t=v.internalPath[u].sgNode;if(t.type===1||t.type===2){x={id:t.cgmId,namingContext:t.namingContext};s.elements.push(x)}else{if(t.type===3){s.subElements.push(t.cgmId)}}}}return s},buildPathElementFromModelIdPath:function(E,G){var s=E.getLastElement(true);if(!(s instanceof q)){return null}var L=null;var x=G.elements;var t;var B=null;var J,I,H,u,A,w,K,D,C=false,v;if(G.subElements.length>0){var L=G.subElements[0];if(L>0){for(J=0;J<s.mesh3js.geometry.length&&!C;J++){w=s.mesh3js.geometry[J];for(I=0;I<w.drawingGroups.length&&!C;I++){K=w.drawingGroups[I];for(H=0;H<K.primitives.length&&!C;H++){D=K.primitives[H];if(D.cgmId===L){u=x.length-1;A=D.rep;while(A&&u>=0&&A.cgmId===x[u].id){A=A.parent;u--}if(!A&&u<0){C=true}}}}}}}if(C){v=E._getUniqueOccurrence();if(v){B=new h();B.setFromOccurrence(v,c.getFromSGNode(D))}}else{if(x.length===1){var y=s.parents[0];var z=y&&y.getChildByName("AxisSystems");if(z){for(J=0;J<z.children.length&&!C;J++){var F=z.children[J]._sgRep;if(F&&F.cgmId===x[0].id){C=z.children[J]}}if(C){B=new h();for(J=0;J<E.externalPath.length&&E.externalPath[J]!==s;J++){B.addElement(E.externalPath[J])}B.addElement(z);B.addElement(C)}}}}return B},buildPathesLeadingToNode:function(v,s){var u;var t=[];var x,w;for(u=0;u<v._occurrences.length;u++){x=v._occurrences[u];w=new h();if(w.setFromOccurrence(x,null,s)){t.push(w)}}return t},setRenderPriority:function(u,t,w){if(k.indexOf(t)<0){console.warn("SceneGraphUtils.setRenderPriority invalid input priority value");return false}var x=u._getUniqueOccurrence(w);if(x){var v=x.renderPriority;var s={userPriority:t!==null,priority:t,userOpacity:v&&v.userOpacity?true:false,opacity:v?v.opacity:null,lastRenderPriority:v?v.lastRenderPriority:-1};x.renderPriority=s;x.node._forceUpdate();return true}console.warn("SceneGraphUtils.setRenderPriority error: invalid pathElement");return false},setRenderPriorityOpacity:function(u,t,w){if(!t&&t!==0){t=null}var x=u._getUniqueOccurrence(w);if(x){var v=x.renderPriority;var s={userPriority:v&&v.userPriority?true:false,priority:v?v.priority:null,userOpacity:t!==null,opacity:t,lastRenderPriority:v?v.lastRenderPriority:-1};x.renderPriority=s;x.node._forceUpdate();return true}console.warn("SceneGraphUtils.setRenderPriority error: invalid pathElement");return false},_traversePathMaterials:function(w,G,D,x,E,y){if(w===null){return null}var v={};v[0]=0;v[3]=1;v[2]=1;v[1]=1;v[5]=2;v[6]=2;v[4]=2;function C(P){var N=[];var Q=0;for(Q=0;Q<P.geometry.length;Q++){var S=0;var R=P.geometry[Q];for(S=0;S<R.drawingGroups.length;S++){var O=R.drawingGroups[S];if(!N[v[O.glType]]){N[v[O.glType]]=O.gas}else{if(N[v[O.glType]]!==O.gas){return null}}}}return N}var H=[];if(w.renderable){H.push(w.renderable)}var u=H.length;for(var K=0;K<u;K++){var J=H[K];var M=!y&&C(J);if(J.material&&J.material.force){var B=(J.userData&&J.userData.oldMaterial)?J.userData.oldMaterial:J.material;G(B,B,function(N){J.material=N},J)}else{if(M){var F=M[2];if(!F){F=new o.MeshBasicMaterial()}if(M[0]){F.point=M[0]}if(M[1]){F.line=M[1]}G(M[2],F,function(N){N.force=true;J.material=N},J)}else{if(!E&&!J.layer){if(x){x(J)}var I=0;for(I=0;I<J.geometry.length;I++){var L=0;var z=J.geometry[I];for(L=0;L<z.drawingGroups.length;L++){var s=z.drawingGroups[L];if(s&&(!y||s._geomType===y)){G(s.gas,s.gas,function(N){J.layer.addPrimitivesToLayers(s.primitives,1,N)})}}}}else{var A=0;for(A=0;A<J.layer.layers.length;A++){var t=J.layer.layers[A];if(!y||t.drawableGroup._geomType===y){if(t.drawableInterval.material){G(t.drawableInterval.material,t.drawableInterval.material,function(N){t.drawableInterval.material=N})}else{G(t.drawableGroup.gas,t.drawableGroup.gas,function(N){t.drawableInterval.material=N})}}}}}}D()}},streamVisu:function(G){var A=["vertexIndexArray","vertexPositionArray","vertexNormalArray","vertexUvArray","vertexUv2Array","vertexTangentArray","vertexBinormalArray","vertexColorArray"];var x=G.layers||false;var K=G.node?G.node:G;var M=G.nodejsContext;var t=G.nodeCallback;var H=G.imageCallback;var w=G.loadedTexturesCallback;var I=null;var B=G.embeddedTextures||false;var O=0;var s={textures:{},materials:{},geometries:{},nodes:{}};var E=100000000;var y=0;var D=[{size:0,buffers:[],data:null}];var C={json:s,chunks:D};function J(S){var U="";if(S.substring(0,5)==="blob:"){return null}else{if(S.substring(0,7)==="http://"){U=S}else{if(S.substring(0,8)==="https://"){U=S}else{if(S.substring(0,1)==="/"){U=S}else{if(S.substring(0,7)==="file://"){return null}else{var T=location.href;var R=T.indexOf("?");if(R!==-1){T=T.substring(0,R)}var Q=T.lastIndexOf("/");if(Q!==-1){T=T.substring(0,Q+1)}U=T+S}}}}}return U}function N(){for(var T=0;T<D.length;T++){var S=D[T];S.data=new Uint8Array(S.size);for(var R=0;R<S.buffers.length;R++){var W=S.buffers[R];var V=W.buffer;var U=W.offset;for(var Q=0;Q<V.byteLength;Q++){S.data[U+Q]=V[Q]}}}return D}function F(S){if(D[y].size+S.byteLength>E){y++;D[y]={size:0,buffers:[],data:null}}var R=D[y];var T=R.size;R.buffers.push({buffer:new Uint8Array(S.buffer,S.byteOffset,S.byteLength),offset:T});R.size+=S.byteLength;if(R.size%4){R.buffers.push({buffer:new Uint8Array(4-(R.size%4)),offset:R.size});R.size+=4-(R.size%4)}return T;if(nodejsContext){var Q=new Buffer(new Uint8Array(S.buffer,S.byteOffset,S.byteLength));if(binaryData===null){binaryData=Q}else{binaryData=Buffer.concat([binaryData,Q])}}}function z(){O--;console.log("nb textures loading: "+O);if(I&&!O){I(C)}}function L(V,W){if(V.image){if(V.image.getContext||(V.image.tagName&&(V.image.tagName.toLowerCase()==="img"))){if(V.sourceFile&&V.sourceFile.substring(0,5)==="blob:"){var ac=new XMLHttpRequest();ac.open("GET",V.sourceFile,true);ac.responseType="blob";ac.onload=function(ae){if(this.status===200){var af=this.response.type;W.format=(af==="image/jpeg")?"jpeg":"png";W.data=this.response;W.path="texture_"+W.id+"."+W.format;console.log("canvas blob");z()}};ac.send()}else{if(V.image.getContext){var ad=V.image.getContext("2d");var Q=ad.getImageData(0,0,V.image.width,V.image.height);W.format="png";W.data=Q;W.path="texture_"+W.id+"."+W.format;console.log("png");z()}}}else{if(V.mipmaps&&V.mipmaps.length){var R=V.image.width;var ab=V.image.height;W.format="dds";W.data=new Blob([o.ImageUtils.streamDDS(V)],{type:"arraybuffer"});W.path="texture_"+W.id+"."+W.format;console.log("dds");z()}else{var R=V.image.width;var ab=V.image.height;var aa=r?r:document.createElement("canvas");aa.width=R;aa.height=ab;var ad=aa.getContext("2d");var Q=ad.getImageData(0,0,R,ab);var T=Q.data;for(var U=0;U<ab;U++){for(var S=0;S<4*R;S++){T[(ab-U-1)*4*R+S]=V.image.data[U*4*R+S]}}ad.putImageData(Q,0,0,0,0,R,ab);var Z=atob(aa.toDataURL("image/png").split(",")[1]);var Y=new Array(Z.length);for(var U=0;U<Z.length;U++){Y[U]=Z.charCodeAt(U)}var X=new Uint8Array(Y);W.format="png";W.data=new Blob([X],{type:"image/png"});W.path="texture_"+W.id+"."+W.format;console.log("uncompressed");z()}}}}function v(U,R){var S=R.textures[U.id];if(!S){var Q={id:U.id,anisotropy:U.anisotropy,magFilter:U.magFilter,minFilter:U.minFilter,wrapS:U.wrapS,wrapT:U.wrapT,repeat:U.repeat};if(H){H(U,Q)}else{if(B){if(!U.loadEndStatus||(U.loadEndStatus==="complete")){O++;console.log("nb textures loading: "+O);L(U,Q)}else{if(U.loadEndStatus==="error"){console.log("texture was not loaded: impossible to embed it in streamvisu.");return undefined}else{O++;console.log("nb textures loading: "+O);U.onLoadCallbacks.push(function(V){L(V,Q)})}}}else{if(U.sourceFile){Q.format=b.getExtension(U.sourceFile);var T=J(U.sourceFile);if(T){Q.path=T}}}}R.textures[U.id]=Q}return U.id}function P(T,S){var Q="MeshPhong";if(T instanceof o.LineBasicMaterial){Q="LineBasic"}else{if(T instanceof o.PhysicalMaterial){Q="Physical"}else{if(T instanceof o.MeshLambertMaterial){Q="MeshLambert"}}}var R={id:T.id,type:Q,visible:T.visible,force:T.force,side:T.side,enableClipPlanes:T.enableClipPlanes,transparent:T.transparent,opacity:T.opacity,alphaTest:T.alphaTest,depthTest:T.depthTest,depthWrite:T.depthWrite};if(T.color){R.color=T.color}if((T instanceof o.MeshPhongMaterial)||(T instanceof o.MeshLambertMaterial)||(T instanceof o.PhysicalMaterial)){R.ambient=T.ambient;R.emissive=T.emissive;R.specular=T.specular;R.shininess=T.shininess;R.vertexColors=T.vertexColors;if(T.glossiness!==undefined){R.glossiness=T.glossiness}if(T.metalness!==undefined){R.metalness=T.metalness}if(T.map){R.diffuseMap=v(T.map,S)}if(T.bumpMap){R.bumpMap=v(T.bumpMap,S)}if(T.normalMap){R.normalMap=v(T.normalMap,S)}if(T.specularMap){R.specularMap=v(T.specularMap,S)}if(T.lightMap){R.lightMap=v(T.lightMap,S)}if(T.emissiveMap){R.emissiveMap=v(T.emissiveMap,S)}if(T.metalnessMap){R.metalnessMap=v(T.metalnessMap,S)}if(T.glossinessMap){R.glossinessMap=v(T.glossinessMap,S)}if(T.bumpMap&&(T.bumpScale!==undefined)){R.bumpScale=T.bumpScale}if(T.coating){R.coating=T.coating}if(T.coating&&(T.coatingGlossiness!==undefined)){R.coatingGlossiness=T.coatingGlossiness}}return R}var u=function(ar,ai){var an=ai.nodes[ar.id];if(!an){var aD=ar.getNodeType();an={id:ar.id,type:aD};if(ar._matrix&&!ar._matrix.isIdentity()){var T=[];ar._matrix.flattenToArray(T);an.matrix=T}if(ar.material){var ay=ai.materials[ar.material.id];if(!ay){ay=ar.material;ai.materials[ar.material.id]=P(ay,ai)}an.material=ar.material.id}ai.nodes[ar.id]=an;if(aD==="Node3D"){var ad=[];for(var aB=0;aB<ar.children.length;aB++){ad.push(ar.children[aB].id)}an.children=ad}else{var ah=ar._occurrences[0].renderable;var av=ah.boundingSphere;var af=ah.boundingBox;if(!af){af=av.getBoundingBox()}var ag=false;if(x){for(var aB=0;aB<ar._occurrences.length;aB++){if(ar._occurrences[aB].renderable.layer){ag=true;break}}}var Y=[];for(var aB=0;aB<ah.geometry.length;aB++){var am=ah.geometry[aB].id;Y.push(am);var W=ai.geometries[am];if(!W){W=ah.geometry[aB];var aw={};aw.id=W.id;for(var aA=0;aA<A.length;aA++){var ac=W[A[aA]];if(ac){var at=F(ac);var S={chunk:y,offset:at,byteLength:ac.byteLength,bpe:ac.BYTES_PER_ELEMENT,itemSize:ac.itemSize};aw[A[aA]]=S}}aw.dgs=[];for(var aA=0;aA<W.drawingGroups.length;aA++){var ab=W.drawingGroups[aA];if(x&&ag){ab.__id__=aA}var Q=ab.primitives;var aj=0;for(var az=0;az<Q.length;az++){var U=Q[az].decoration;if(U&&U.length){aj+=U.length}}var ao=new Uint32Array(4*Q.length);var aa=new Uint8Array(aj);var al=0;for(var az=0;az<Q.length;az++){var ae=Q[az];ao[4*az]=ae.cgmId;ao[4*az+1]=ae.rep?ae.rep.cgmId:0;ao[4*az+2]=ae.start;ao[4*az+3]=ae.count;var U=Q[az].decoration;if(U&&U.length){console.log(U.length);if(U.length>255){console.log("panic")}aa[al++]=U.length;for(var ax=0;ax<U.length;++ax){aa[al++]=U[ax]}}else{aa[al++]=0}}var at=F(ao);var X={chunk:y,offset:at,byteLength:ao.byteLength,bpe:ao.BYTES_PER_ELEMENT,itemSize:ao.itemSize};var aC=undefined;if(aj){var aq=F(aa);aC={chunk:y,offset:aq,byteLength:aa.byteLength,bpe:aa.BYTES_PER_ELEMENT,itemSize:aa.itemSize}}aw.dgs[aA]={start:ab.start,count:ab.count,geomType:j.GeomTypeString[ab._geomType],glType:ab.glType,primitives:X,canonicals:aC};if(ab.material instanceof o.Material){var ak=ai.materials[ab.material.id];if(!ak){ai.materials[ab.material.id]=P(ab.material,ai)}aw.dgs[aA].material=ab.material.id}else{if(ab.gas){var V=ai.materials[ab.gas.id];if(!V){ai.materials[ab.gas.id]=P(ab.gas,ai)}aw.dgs[aA].gas=ab.gas.id}}}ai.geometries[am]=aw}}an.mesh3js={bs:{c:[av.center.x,av.center.y,av.center.z],r:av.radius},bbox:{min:[af.min.x,af.min.y,af.min.z],max:[af.max.x,af.max.y,af.max.z]},geometries:Y};if(x&&ag){an.occurrences={};for(var aB=0;aB<ar._occurrences.length;aB++){var ap=ar._occurrences[aB].renderable;if(ap.layer){var au=[];an.occurrences[aB]={index:aB,layers:au};for(var aA=0;aA<ap.layer.layers.length;aA++){var R=ap.layer.layers[aA];var Z={start:R.drawableInterval.start,count:R.drawableInterval.count,primitiveStart:R.drawableInterval.primitiveStart,primitiveCount:R.drawableInterval.primitiveCount,layerNum:R.drawableInterval.layerNum};if(R.drawableInterval.material){Z.material=R.drawableInterval.material.id;var ay=ai.materials[Z.material];if(!ay){ay=R.drawableInterval.material;ai.materials[Z.material]=P(ay,ai)}}au.push({geometry:R.geometry.id,drawableGroup:R.drawableGroup.__id__,drawableInterval:Z})}}}}if(ah.material){var ay=ai.materials[ah.material.id];if(!ay){ay=ah.material;ai.materials[ah.material.id]=P(ay,ai)}an.mesh3js.material=ah.material.id}}if(t){t(ar,an)}}};K.traverse(u,s);s.nbChunks=D.length;if(w){I=w}C.chunks=N();if(!O&&I){I(C)}return C}};var k=[0,1,2,3,4];return a});define("DS/Visualization/SceneGraph",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Visualization/SceneGraphUtils"],function(b,m,k,o,d,j,n,h,g,f,e,l,a){if(!window.undoSceneGraphMigrationStep2){return function c(){}}});define("Visualization/SceneGraph",["DS/Visualization/SceneGraph","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/SceneGraph");return b});define("DS/Visualization/InternalSceneGraph",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents"],function(b,n,k,p,c,j,o,h,g,e,d){var l,f,a;var m=b.extend({init:function(u,r,t){this.parentSceneGraph=null;this.bShowReferenceAxisSystem=true;this.lockShowReferenceAxisSystem=t;this.scene=new n.Scene();this.scene.matrixWorldNeedsUpdate=false;this.viewer=u;this.drivesTheRobot=false;this.viewpointAdded=false;this.root=new k();this.root.setLinkedToSceneGraph(true);this.root.setNotAllowedInPathElement(true);this.userRoot=new k();this.userRoot.setLinkedToSceneGraph(true);if(r||window.userRootOutOfPathElements){this.userRoot.setNotAllowedInPathElement(true)}this.root.addChild(this.userRoot);if(this.viewer._svgMode){this.svgRoot=new k();this.svgRoot._isSVGRoot=true;this.root.addChild(this.svgRoot)}this.robotRoot=new k();this.robotRoot.exludeFromBounding(true);this.robotRoot._setVisibilityFree(true);this.root.addChild(this.robotRoot);this._robot=null;this._customReferenceAxisSystem=null;var s=this;var q=function(){s.modelEvents.publish("onready")};this.root.subscribe("onready",q);this.root3js=new n.Object3D();this.root3js.isRoot3ds=true;this.root3js.viewer=u;this.root3js.matrixAutoUpdate=false;this.root3js.matrixWorldNeedsUpdate=false;this.root.setScene(this.root3js);this.root3js.node=this.root;this.scene.add(this.root3js);this.modelEvents=new d();this.selectionHL=new o(this);this.selectionPreHL=new h(this);this._subscribedEvents=[];this._onViewpointChangedEvent=null;return this},onSelectViewpoint:function(){this.subscribeToOnViewpointChanged()},subscribeToOnViewpointChanged:function(){var s=this.viewer.currentViewpoint;var q=this._onViewpointChangedEvent;var t=false;if(q){if(s===q.object){return}else{q.object.unsubscribe(q.token);this._onViewpointChangedEvent=null;t=true}}var r=this.viewer.currentViewpoint.onMove(this.onViewpointChange.bind(this));this._onViewpointChangedEvent={object:this.viewer.currentViewpoint,token:r};if(t){this.onViewpointChange()}},onAddViewpoint:function(){this.subscribeToOnViewpointChanged();if(!this.viewpointAdded){var q=this.viewer.onViewerResize(this.onViewpointChange.bind(this));this._subscribedEvents.push({object:this.viewer,token:q})}this.viewpointAdded=true;if(!this.lockShowReferenceAxisSystem){this.showReferenceAxisSystem(this.bShowReferenceAxisSystem,true)}},onViewpointChange:function(){var q=this.viewer.currentViewpoint;if(!q){return}q._updateRobotCamera(this);if(this._robot){this._robot.onViewpointChange()}if(this.referenceAxisSystemNode){this.referenceAxisSystemNode.onViewpointChange()}},_detachEvents:function(){this.selectionPreHL._detachEvents();this.selectionHL._detachEvents();var r,q;for(r=0;r<this._subscribedEvents.length;r++){q=this._subscribedEvents[r];q.object.unsubscribe(q.token)}this._subscribedEvents=[]},getChildByName:function(q){return this.root.getChildByName(q)},getMeshMin:function(v){var r=null,q=new n.Vector3(),A,B,u,t,s,w;B=null;u=0;if(v.geometry.length>=0){B=v.geometry[0];u=v.geometry.length}else{if(v.geometry._type===2){B=v.geometry;u=1}}for(t=0;t<u;t++){w=B.vertexPositionArray;if(w===null){B=v.geometry[t+1];continue}A=v._getMMMatrix();if(B.compressedVertices){for(s=0;s<w.length;s+=2){var C=w[s];var z=w[s+1];var D=B.uncompressPoint(C,z);q.x=D.x;q.y=D.y;q.z=D.z;q.applyMatrix4(A);if((q.z<r)||(r===null)){r=q.z}}}else{for(s=0;s<w.length;s+=3){q.x=w[s];q.y=w[s+1];q.z=w[s+2];q.applyMatrix4(A);if((q.z<r)||(r===null)){r=q.z}}}B=v.geometry[t+1]}v._minZ=r;return r},getSceneMin:function(E){if(!this.root3js){return 0}if(E){if(this.root){var D=this.root.getBoundingBox("show");if(D){return D.min.z}}return 0}var q=this.root3js.children,x=null,y,C,v,s,u,z=null,s=new n.Vector3();var G,t;for(y=0,C=q.length;y<C;y++){v=q[y];var w=true;if(v.visibilityFree){w=v.visible}else{w=this.viewer.visibleSpace?v.visible:!v.visible}if(w&&v.frustumCulled&&v.geometry&&(v.geometry.boundingSphere!==null)&&v.geometry.boundingSphere.radius&&v.geometry.length&&v.geometry[0].drawingGroups.length){var B=v._getMMMatrix();s.copy(v.geometry.boundingSphere.center);s.applyMatrix4(B);v._centerZ=s.z;u=B?B.getMaxScaleOnAxis():1;G=v._centerZ+v.geometry.boundingSphere.radius*u;if((x===null)||(G<x)){x=G}}}var r=[];for(y=0,C=q.length;y<C;y++){v=q[y];var w=true;if(v.visibilityFree){w=v.visible}else{w=this.viewer.visibleSpace?v.visible:!v.visible}if(w&&v.frustumCulled&&v.geometry&&(v.geometry.boundingSphere!==null)&&v.geometry.boundingSphere.radius&&v.geometry.length&&v.geometry[0].drawingGroups.length){var B=v._getMMMatrix();u=B?B.getMaxScaleOnAxis():1;t=v._centerZ-v.geometry.boundingSphere.radius*u;if(t<x){if(!v.geometry[0].vertexPositionArray){r.push(v)}else{var F=this.getMeshMin(v)}if((z===null)||(F<z)){z=F}}}}if(r.length){var A=this.viewer.renderer.boundingBoxGPUCompute.computeZMinGPU(this.viewer,r);if(z===undefined){z=A}else{z=Math.min(A,z)}}return z},updateShaders:function(){this.viewer.renderer.recompileAllShaders()},getBoundingSphere:function(s,r){var q=this.root._occurrences[0].getBoundingSphere(s,true);if(!r&&(!q||(q.radius<=0&&q.pixelRadius<=0))){q=new n.Sphere(new n.Vector3(),100)}return q},clearSelection:function(){this.selectionHL.clearAll();this.selectionPreHL.clearAll()},addRobotNode:function(q){this.robotRoot.addChild(q)},addUserNode:function(r,q){if(q){this.userRoot.children[0].addChild(r)}else{this.userRoot.addChild(r)}},removeUserNode:function(r,q){if(q){this.userRoot.children[0].removeChild(r,true)}else{if(r instanceof k||!r){this.userRoot.removeChild(r,true)}else{this.userRoot.removeChild(r._private_root,true)}}},setRobot:function(r,s,t,q){if(r&&!q){this.lockShowReferenceAxisSystem=false}s=s||{};this.drivesTheRobot=true;this.createAxisSystem();if(this._robot&&r){this.robotRoot.remove(this._robot,true);this._robot._dispose();this._robot=null;this.robot=null}if(!this._robot){this.createRobot(t,s,l)}if(r){this._robot.setHiddenMode(false)}else{this._robot.setHiddenMode(true)}if(!q){this.robot=r?this._robot:undefined}return true},getRobot:function(){if(this.drivesTheRobot){return this.robot}else{return this.getChildByName("robot")}},setCustomReferenceAxisSystem:function(q){if(this._customReferenceAxisSystem){this.robotRoot.removeChild(this._customReferenceAxisSystem);this._customReferenceAxisSystem._dispose();this._customReferenceAxisSystem=null}if(q){this._customReferenceAxisSystem=new a(this.viewer,q);this._customReferenceAxisSystem.setRenderPasses(["robotOrtho"]);this.robotRoot.addChild(this._customReferenceAxisSystem);this._customReferenceAxisSystem.onViewpointChange()}},clearScene:function(x,u,w){this.clearSelection();var s=(x!==undefined)?x:false,t=(u!==undefined)?u:false,v=this.userRoot.children.length,r;if(w==="deprecated"){var q=this.userRoot.children[0];while(q.children.length){q.remove(q.children[0])}}else{for(r=0;r<v;r++){this.userRoot.remove(this.userRoot.children[0])}}},getUserNodes:function(q){var t=[],r;var s=this.getUserRoot(q);for(r=0;r<s.children.length;r++){t.push(s.children[r])}return t},getUserRoot:function(q){return q?this.userRoot.children[0]:this.userRoot},addDebugNode:function(q){if(!this.debugRoot){this.debugRoot=new k();this.debugRoot.excludeFromBounding=true;this.root.addChild(this.debugRoot)}this.debugRoot.addChild(q)},removeDebugNode:function(q){this.debugRoot.removeChild(q)},showReferenceAxisSystem:function(r,q){if(!q){this.lockShowReferenceAxisSystem=false}this.bShowReferenceAxisSystem=r;if(this.viewpointAdded){this.createAxisSystem();this.updateReferenceAxisSystemVisibility()}},createAxisSystem:function(){if(!this.referenceAxisSystemNode){this.referenceAxisSystemNode=new f("referenceAxisSystem",this.viewer);this.robotRoot.addChild(this.referenceAxisSystemNode);this.referenceAxisSystemNode.setCameraName("robotCameraOrtho");this.referenceAxisSystemNode.setRenderPasses(["robotOrtho"])}},createRobot:function(s,q,r){this._robot=new r(this,"robot",s,q.snapOnFace,q.showOnlyManipulated,"I solemnly swear that I am up to no good.",q.touchMode);this.onViewpointChange();this.updateReferenceAxisSystemVisibility()},updateReferenceAxisSystemVisibility:function(){if(this.referenceAxisSystemNode){this.referenceAxisSystemNode._setEnabled(this.bShowReferenceAxisSystem)}},setRobotAndRefAxisSystemEnabled:function(q){if(this._robot){this._robot._setEnabled(q)}if(this.referenceAxisSystemNode){this.referenceAxisSystemNode._setEnabled(q)}},dispose:function(){if(this._robot){this._robot._dispose()}if(this.referenceAxisSystemNode){this.referenceAxisSystemNode._dispose()}if(this._customReferenceAxisSystem){this._customReferenceAxisSystem._dispose()}this._robot=null;this.robot=null;this.referenceAxisSystemNode=null;this._detachEvents();this.clearScene();while(this.root.children.length){this.root.removeChild(this.root.children[0])}this.scene.dispose();this.selectionHL=null;this.selectionPreHL=null;var q;for(q in this){this[q]=null}}});m.setRobotClasses=function(q,s,r){l=q;f=s;a=r};return UWA.namespace("THREEDS/InternalSceneGraph",m)});define("Visualization/InternalSceneGraph",["DS/Visualization/InternalSceneGraph","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/InternalSceneGraph");return b});define("DS/Visualization/ModelLoader",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Visualization/SceneGraph","DS/VisuEvents/EventsManager"],function(b,d,e,f,a){var c=b.extend({init:function(g,h){this.fileType="xmlv43";this.geometryMode="3dxmlgeometry";this.smartLoading=false;this.filterNavReps=false;this.modelName="";this.Ox4MQLV6Loader=null;this.cgrLoader=null;this.uvrLoader=null;this.xmlv43Loader=null;this.xmlv6Loader=null;this.xmlv6SmartLoader=null;this.colladaLoader=null;this.jsonLoader=null;this.objLoader=null;this.xcadLoader=null;this.particlesLoader=null;this.streamVisuLoader=null;this.threeDXLoader=null;this.multipartMode=false;this.CGRNewInfra=true;this.keepLoaderMode=false;this.expandMode=false;this.readDecoration=false;this.primitiveWithBS=false;this.withSAG=false;this.useUvrWorker=true;this.withSceneGraph=false;this.smartStaticBatching=true;this.edgeTransparency=true;this.sharedBuffers=true;this.noMeshInRAM=false;this.processText=false;this.targetNode=null;this.glContext=g;this.renderer=null;this.renderCB=null;this.onLoadedCB=function(){if(a.RecordEventsManager){a.RecordEventsManager.sendSynchroPoint("ModelLoaded")}window.webVisuPerfo.endPerfo("load");d.loadingModels=false};this.onLoadedPrdCB=null;this.onProgressCB=null;this.onErrorCB=null;this.refreshTime=2000;this.debugBBox=(h!==undefined)?h:false;this.poolOfModels={xmlv43:{loading:false,models:[]},xmlv6:{loading:false,models:[]},Ox4MQLV6:{loading:false,models:[]},OxMQLV5:{loading:false,models:[]},cgr:{loading:false,models:[]},streamvisu:{loading:false,models:[]},"3dx":{loading:false,models:[]}};this._Ox4ProxyAbstraction=null;return this},setSceneGraph:function(g){this.targetNode=g},setTargetNode:function(g){this.targetNode=g},setWebGLContext:function(g){this.glContext=g},getCGROptions:function(){return{readDeco:this.readDecoration,primWithBS:this.primitiveWithBS,edgeTransparency:this.getEdgeTransparency(),cgrWithSG:this.getCGRWithSG(),sharedBuffers:this.getSharedBuffers(),noMeshInRAM:this.getNoMeshInRAM(),smartStaticBatching:this.smartStaticBatching,withSAG:this.withSAG,withSceneGraph:this.getCGRWithSG(),uvrWorker:this.useUvrWorker,cgrMultipartMode:this.getMultipartMode(),cgrExpandMode:this.getExpandMode(),processText:this.processText}},setRenderCallback:function(g,h){this.renderCB=g;this.refreshTime=h?h:2000},setOnLoadedCallback:function(g){this.onLoadedCB=function(h){window.webVisuPerfo.endPerfo("load");if(a.RecordEventsManager){a.RecordEventsManager.sendSynchroPoint("ModelLoaded")}d.loadingModels=false;if(g){g.call(this,h)}}},setOnLoadedProductStructureCallback:function(g){this.onLoadedPrdCB=g},setOnProgressCallback:function(g){this.onProgressCB=g},setOnErrorCallback:function(g){this.onErrorCB=g},activateSmartLoading:function(g){if(g===null){return}this.renderer=g;this.smartLoading=true},deactivateSmartLoading:function(){this.smartLoading=false},setFilterNavReps:function(g){this.filterNavReps=g},getFileType:function(){return this.fileType},setFileType:function(g){this.fileType=g},getGeometryMode:function(){return this.geometryMode},setGeometryMode:function(g){this.geometryMode=g;if(this.xmlv6Loader!==null){this.xmlv6Loader.setGeometryMode(g)}},getMultipartMode:function(){return this.multipartMode},setMultipartMode:function(g){this.multipartMode=g},getCGRNewInfra:function(){return this.CGRNewInfra},setKeepLoaderMode:function(g){if(this.cgrLoader){this.cgrLoader.setKeepLoaderMode(g)}this.keepLoaderMode=g},getKeepLoaderMode:function(){return this.keepLoaderMode},setCGRNewInfra:function(g){this.CGRNewInfra=g},getCGRWithSG:function(){return this.withSceneGraph},setCGRWithSG:function(g){this.withSceneGraph=g},getEdgeTransparency:function(){return this.edgeTransparency},setEdgeTransparency:function(g){this.edgeTransparency=g},getSharedBuffers:function(){return this.sharedBuffers},setSharedBuffers:function(g){this.sharedBuffers=g},getNoMeshInRAM:function(){return this.noMeshInRAM},setNoMeshInRAM:function(g){this.noMeshInRAM=g},getExpandMode:function(){return this.expandMode},setExpandMode:function(g){this.expandMode=g},enableLDH:function(l,h,k,j,n,g){var m=this;require(["DS/SelectiveLoading/SelectiveLoadingAsync"],function(o){m.LDH=o;m.LDH.Helpers._enableLDH(m,l,h,k,n,g);if(m.LDHAsyncDestruction!==undefined){m.destructLDH()}else{if(j){j()}}},function(p){var o=p.requireModules&&p.requireModules[0];console.error("Module "+o+" is missing.");if(m.onErrorCB){m.onErrorCB()}})},getLDHInterface:function(){return this._ldhInterface},destructLDH:function(){if(this.LDH===undefined){this.LDHAsyncDestruction=true}else{this.LDH.Helpers._ldhCleanup(this);delete this.LDHAsyncDestruction;delete this.LDH}},_onModuleError:function(g,h){return function(k){var j=k.requireModules&&k.requireModules[0];console.log("Module "+j+" is missing.");if(g){g({url:h,type:"FORMAT"})}}},_xmlv43LoaderCB:function(g){this.xmlv43Loader.load(g.jsonSettings,function(h){g.destination.addChild(h);if(g.loadedProductCB!==null){g.loadedProductCB(h)}if(g.renderCB!==null){g.renderCB({needReframe:false})}g.destination=null},g.progressCB,g.loadedCB,g.errorCB,g.filterNavReps,g.refreshTime,g.readDecoration,g.cgrNewInfra,g.primitiveWithBS,g.edgeTransparency,g.cgrWithSG,g.sharedBuffers,g.noMeshInRAM,g.smartStaticBatching,g.cgrWithSAG,g.uvrWorker,g.applicativeContainers,g.processText)},_xmlv6LoaderCB:function(g){this.xmlv6Loader.load(g.modelName,function(h){g.destination.addChild(h);if(g.loadedProductCB!==null){g.loadedProductCB(h)}if(g.renderCB!==null){g.renderCB({needReframe:true})}g.destination=null},g.progressCB,g.loadedCB)},_Ox4MQLV6LoaderCB:function(g){this.Ox4MQLV6Loader.load(g.jsonSettings,function(h){g.destination.addChild(h);if(g.loadedProductCB!==null){g.loadedProductCB(h)}if(g.renderCB!==null){g.renderCB({needReframe:false})}g.destination=null},g.progressCB,g.loadedCB,g.errorCB,{edgeTransparency:g.edgeTransparency})},_OxMQLV5LoaderCB:function(g){this.OxMQLV5Loader.load(g.jsonSettings,function(h){g.destination.addChild(h);if(g.loadedProductCB!==null){g.loadedProductCB(h)}if(g.renderCB!==null){g.renderCB({needReframe:false})}},g.progressCB,g.loadedCB,g.errorCB,{edgeTransparency:g.edgeTransparency})},_cgrLoaderCB:function(h){var j={isBuffer:h.isBuffer,destination:h.destination,isMultipartMode:h.cgrMultipartMode,isExpandMode:h.cgrExpandMode,isCGRNewInfra:h.cgrNewInfra,readDeco:h.readDecoration,primWithBS:h.primitiveWithBS,smartStaticBatching:h.smartStaticBatching,withSAG:h.cgrWithSAG,edgeTransparency:h.edgeTransparency,sharedBuffers:h.sharedBuffers,noMeshInRAM:h.noMeshInRAM,withSceneGraph:h.cgrWithSG,applicativeContainers:h.applicativeContainers,processText:h.processText};var k=function(l){if(h.loadedProductCB!==null){h.loadedProductCB(l)}};var g={readyCallback:k,doneCallback:h.loadedCB,errorCallback:h.errorCB,progressCallback:h.progressCB};this.cgrLoader.load(h.jsonSettings,g,j);h.destination=null},_streamVisuLoaderCB:function(g){this.streamVisuLoader.load(g.modelName,function(h){if(g.loadedProductCB!==null){g.loadedProductCB(h)}},null,g.loadedCB,g.destination)},_threeDXLoaderCB:function(h){this.threeDXLoader.setMode(h.fileType==="3dxc"?"concat":"zipped");this.threeDXLoader.setSharedBuffers(h.sharedBuffers);this.threeDXLoader.setNoMeshInRAM(h.noMeshInRAM);var j=true;var g=false;var k=false;var l=h.jsonSettings&&h.jsonSettings.loaderSettings;if(l){j=l.primitives;g=l.reps;k=l.ssb}this.threeDXLoader.load({url:h.modelName,primitives:j,reps:g,ssb:k,lightMapAsIrradiance:l&&l.lightMapAsIrradiance,destinationNode:h.destination,readyCallback:function(m){if(h.loadedProductCB!==null){h.loadedProductCB(m)}},doneCallback:h.loadedCB,errorCallback:h.errorCB,gasSharing:(l&&l.gasSharing)?true:false})},loadModelFromBuffer:function(j,g,h){return this.loadModel(j,g,true,h)},loadModel:function(g,l,p,n){window.webVisuPerfo.startPerfo("load",-1);d.loadingModels=true;if((this.LDH!==undefined)&&(g.localAABox!==undefined)){return this.LDH.Helpers._onLoadModel(this,g,l,p)}var j=this,o=null,m=(l!==undefined)?l:j.targetNode;if(m===null){return false}p=p!==undefined?p:false;if(!p){var h=(typeof g==="string");o=this.buildPath(g);this.modelName=o.serverurl?o.serverurl:"";this.modelName+=o.filename?o.filename:"";this.setFileTypeFromSpec(o)}var k={modelName:this.modelName,fileType:this.fileType,jsonSettings:o,destination:m,isBuffer:p,geometryMode:this.geometryMode,renderCB:this.renderCB,loadedProductCB:this.onLoadedPrdCB,progressCB:this.onProgressCB,loadedCB:this.onLoadedCB,errorCB:this.onErrorCB,filterNavReps:this.filterNavReps,refreshTime:this.refreshTime,readDecoration:this.readDecoration,cgrNewInfra:this.getCGRNewInfra(),primitiveWithBS:this.primitiveWithBS,edgeTransparency:this.getEdgeTransparency(),cgrWithSG:this.getCGRWithSG(),sharedBuffers:this.getSharedBuffers(),noMeshInRAM:this.getNoMeshInRAM(),smartStaticBatching:this.smartStaticBatching,cgrWithSAG:this.withSAG,uvrWorker:this.useUvrWorker,cgrMultipartMode:this.getMultipartMode(),cgrExpandMode:this.getExpandMode(),waitMaterial:this.waitMaterial,processText:this.processText};if(this.fileType==="xmlv43"){if(p){return false}if(n&&n.applicativeContainers){k.applicativeContainers=n.applicativeContainers}if(!this.xmlv43Loader){this.poolOfModels.xmlv43.models.push(k);if(!this.poolOfModels.xmlv43.loading){this.poolOfModels.xmlv43.loading=true;require(["DS/VisuLoaders/XMLV43Loader"],function(s){j.poolOfModels.xmlv43.loading=false;j.xmlv43Loader=new s(j.glContext,j.renderCB);var r=j.poolOfModels.xmlv43.models;for(var q=0;q<r.length;q++){j._xmlv43LoaderCB(r[q])}j.poolOfModels.xmlv43.models=[]},this._onModuleError(k.errorCB,k.modelName))}}else{this._xmlv43LoaderCB(k)}}else{if(this.fileType==="xmlv6"){if(p){return false}if(!this.xmlv6Loader){this.poolOfModels.xmlv6.models.push(k);if(!this.poolOfModels.xmlv6.loading){this.poolOfModels.xmlv6.loading=true;require(["DS/VisuLoaders/XMLV6Loader","DS/VisuLoaders/XMLV6SmartLoaderPassPlugin"],function(r,t){j.poolOfModels.xmlv6.loading=false;j.xmlv6Loader=new r(j.glContext,j.renderCB,j.debugBBox,j.geometryMode);if(j.smartLoading&&(j.xmlv6SmartLoader===null)){j.xmlv6SmartLoader=new t(j.xmlv6Loader);j.xmlv6SmartLoader.enabled=true;j.xmlv6SmartLoader.renderTarget=null;j.renderer.addPrePlugin(j.xmlv6SmartLoader)}else{if(!j.smartLoading&&(j.xmlv6SmartLoader!==null)){j.xmlv6SmartLoader.enabled=false}else{if(j.xmlv6SmartLoader!==null){j.xmlv6SmartLoader.enabled=true}}}var s=j.poolOfModels.xmlv6.models;for(var q=0;q<s.length;q++){j._xmlv6LoaderCB(s[q])}j.poolOfModels.xmlv6.models=[]},this._onModuleError(k.errorCB,k.modelName))}}else{this._xmlv6LoaderCB(k)}}else{if(this.fileType=="Ox4MQLV6"){if(!this.Ox4MQLV6Loader){this.poolOfModels.Ox4MQLV6.models.push(k);if(!this.poolOfModels.Ox4MQLV6.loading){this.poolOfModels.Ox4MQLV6.loading=true;require(["DS/VisuDataAccess/Ox4MQLV6Loader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(t,s){j.poolOfModels.Ox4MQLV6.loading=false;j._Ox4ProxyAbstraction=s;j.Ox4MQLV6Loader=new t(j.glContext,j.renderCB,j.debugBBox,j.geometryMode);var r=j.poolOfModels.Ox4MQLV6.models;for(var q=0;q<r.length;q++){e.setProxyFromSpec(r[q].jsonSettings,s);j._Ox4MQLV6LoaderCB(r[q])}j.poolOfModels.Ox4MQLV6.models=[]},this._onModuleError(k.errorCB,k.modelName))}}else{e.setProxyFromSpec(k.jsonSettings,this._Ox4ProxyAbstraction);this._Ox4MQLV6LoaderCB(k)}}else{if(this.fileType=="svg"){require(["DS/SVGLoader/SVGLoader"],function(q){var r=new q({renderCB:j.renderCB,onProgressCB:j.onProgressCB,onLoadedCB:j.onLoadedCB,onErrorCB:j.onErrorCB});r.load(o,m)})}else{if(this.fileType=="OxMQLV5"){if(!this.OxMQLV5Loader){this.poolOfModels.OxMQLV5.models.push(k);if(!this.poolOfModels.OxMQLV5.loading){this.poolOfModels.OxMQLV5.loading=true;require(["DS/EV53DPlay/OxMQLV5Loader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(r,t){j.poolOfModels.OxMQLV5.loading=false;j._Ox4ProxyAbstraction=t;j.OxMQLV5Loader=new r(j.glContext,j.renderCB);var s=j.poolOfModels.OxMQLV5.models;for(var q=0;q<s.length;q++){e.setProxyFromSpec(s[q].jsonSettings,t);j._OxMQLV5LoaderCB(s[q])}j.poolOfModels.OxMQLV5.models=[]},this._onModuleError(k.errorCB,k.modelName))}}else{e.setProxyFromSpec(k.jsonSettings,j._Ox4ProxyAbstraction);this._OxMQLV5LoaderCB(k)}}else{if(this.fileType==="cgr"||this.fileType==="uvr"){if(n&&n.applicativeContainers){k.applicativeContainers=n.applicativeContainers}if(!this.cgrLoader){if(p){k.jsonSettings=g}this.poolOfModels.cgr.models.push(k);if(!this.poolOfModels.cgr.loading){this.poolOfModels.cgr.loading=true;require(["DS/VisuLoaders/CGRReader"],function(r){j.poolOfModels.cgr.loading=false;j.cgrLoader=new r(j.glContext,j.renderCB,{keepLoader:j.getKeepLoaderMode()});var s=j.poolOfModels.cgr.models;for(var q=0;q<s.length;q++){j._cgrLoaderCB(s[q])}j.poolOfModels.cgr.models=[]},this._onModuleError(k.errorCB,k.modelName))}}else{if(p){k.jsonSettings=g}this._cgrLoaderCB(k)}}else{if(this.fileType==="dae"){if(p){return false}require(["DS/VisuLoaders/DAEReader"],function(q){if(j.colladaLoader===null){j.colladaLoader=new q(j.glContext,j.renderCB)}if(j.waitMaterial){j.colladaLoader.setWaitMaterial(j.waitMaterial)}j.colladaLoader.loadFromSpec(o,function r(s){m.addChild(s);if(j.onLoadedPrdCB!==null){j.onLoadedPrdCB(s)}if(j.renderCB!==null){j.renderCB({needReframe:false})}m=null},null,j.onLoadedCB)},function(r){var q=r.requireModules&&r.requireModules[0];console.log("Module "+q+" is missing.");if(j.onErrorCB){j.onErrorCB({url:j.modelName,type:"FORMAT"})}})}else{if(this.fileType==="json"){if(p){return false}require(["DS/VisuLoaders/JSONReader"],function(r){if(j.jsonLoader===null){j.jsonLoader=new r(j.glContext,j.renderCB)}j.jsonLoader.load(j.modelName,function q(s){m.addChild(s);if(j.onLoadedPrdCB!==null){j.onLoadedPrdCB(s)}if(j.renderCB!==null){j.renderCB({needReframe:false})}m=null},null,j.onLoadedCB)},function(r){var q=r.requireModules&&r.requireModules[0];console.log("Module "+q+" is missing.");if(j.onErrorCB){j.onErrorCB({url:j.modelName,type:"FORMAT"})}})}else{if(this.fileType==="obj"){if(p){return false}require(["DS/VisuLoaders/OBJReader"],function(r){if(j.objLoader===null){j.objLoader=new r(j.glContext,j.renderCB)}j.objLoader.load(o,function q(s){m.addChild(s);if(j.onLoadedPrdCB!==null){j.onLoadedPrdCB(s)}if(j.renderCB!==null){j.renderCB({needReframe:false})}m=null},null,j.onLoadedCB)},function(r){var q=r.requireModules&&r.requireModules[0];console.log("Module "+q+" is missing.");if(j.onErrorCB){j.onErrorCB({url:j.modelName,type:"FORMAT"})}})}else{if(this.fileType==="streamvisu"){if(p){return false}if(!this.streamVisuLoader){this.poolOfModels.streamvisu.models.push(k);if(!this.poolOfModels.streamvisu.loading){this.poolOfModels.streamvisu.loading=true;require(["DS/VisuLoaders/StreamVisuLoader"],function(q){j.poolOfModels.streamvisu.loading=false;j.streamVisuLoader=new q(j.renderCB);var s=j.poolOfModels.streamvisu.models;for(var r=0;r<s.length;r++){j._streamVisuLoaderCB(s[r])}j.poolOfModels.streamvisu.models=[]},this._onModuleError(k.errorCB,k.modelName))}}else{this._streamVisuLoaderCB(k)}}else{if(this.fileType==="3dx"||this.fileType==="3dxc"||this.fileType==="3dxm"){if(p){return false}if(!this.threeDXLoader){this.poolOfModels["3dx"].models.push(k);if(!this.poolOfModels["3dx"].loading){this.poolOfModels["3dx"].loading=true;require(["DS/VisuLoaders/ThreeDXLoader"],function(q){j.poolOfModels["3dx"].loading=false;j.threeDXLoader=new q();var s=j.poolOfModels["3dx"].models;for(var r=0;r<s.length;r++){j._threeDXLoaderCB(s[r])}j.poolOfModels["3dx"].models=[]},this._onModuleError(k.errorCB,k.modelName))}}else{this._threeDXLoaderCB(k)}}else{if(this.fileType==="stp"||this.fileType==="step"||this.fileType==="stl"){require(["DS/XCADLoader/XCADModelLoaderPlug"],function(t){var s=[new t()];var q=function(u){m.addChild(u);if(j.onLoadedPrdCB!==null){j.onLoadedPrdCB(u)}if(j.renderCB!==null){j.renderCB({needReframe:false})}};for(var r=0;r<s.length;r++){if(s[r].isManagedType(j.fileType)){if(p){return false}s[r].loadModel(j.fileType,j.glContext,j.renderCB,j.modelName,q,j.onProgressCB,j.onLoadedCB,j.onErrorCB,j.filterNavReps,j.refreshTime,m,o)}}},function(r){var q=r.requireModules&&r.requireModules[0];console.log("Module "+q+" is missing.");if(j.onErrorCB){j.onErrorCB({url:j.modelName,type:"FORMAT"})}})}else{if(this.fileType==="particles"){require(["DS/VisuLoaders/ParticlesLoader"],function(q){if(j.particlesLoader===null){j.particlesLoader=new q(j.sceneGraph,j.renderCB)}var r=o;if(p){r=g}j.particlesLoader.load(r,function s(t){m.add(t);if(j.onLoadedPrdCB!==null){j.onLoadedPrdCB(t)}if(j.renderCB!==null){j.renderCB({needReframe:false})}m=null},null,j.onLoadedCB)},function(r){var q=r.requireModules&&r.requireModules[0];console.log("Module "+q+" is missing.");if(j.onErrorCB){j.onErrorCB({url:j.modelName,type:"FORMAT"})}})}else{require(["DS/ModelLoader_"+this.fileType.toLowerCase()+"/loader"],function(q){var r=new q();var t=o;if(p){t=g}r.load(t,function s(u){m.addChild(u);if(j.onLoadedPrdCB!==null){j.onLoadedPrdCB(u)}m=null},j.onProgressCB,j.onLoadedCB,j.onErrorCB,j.renderCB)},function(r){var q=r.requireModules&&r.requireModules[0];console.log("Module "+q+" is missing.");if(j.onErrorCB){j.onErrorCB({url:j.modelName,type:"FORMAT"})}})}}}}}}}}}}}}}return true},getLoader:function(g,j){var h=this;switch(g){case"3dx":require(["DS/VisuLoaders/ThreeDXLoader"],function(k){if(h.threeDXLoader===null){h.threeDXLoader=new k()}j&&j(h.threeDXLoader)});break;default:break}return this.threeDXLoader},buildPath:function(k){if(typeof k==="string"){var n="";var m="";if(k.substring(0,5)==="blob:"){return k={provider:"FILE",serverurl:"",filename:k,requiredAuth:null,proxyurl:"none"}}else{if(k.substring(0,7)==="http://"){n=k}else{if(k.substring(0,8)==="https://"){n=k}else{if(k.substring(0,1)==="/"){n=k}else{if(k.substring(0,10)==="ms-appx://"){n=k}else{if(k.substring(0,7)==="file://"){n=k}else{var l=location.href;var h=l.indexOf("?");if(h!==-1){l=l.substring(0,h)}var g=l.lastIndexOf("/");if(g!==-1){l=l.substring(0,g+1)}n=l+k}}}}}}n=e.parseUrl(n);m=n.protocol;if(n.protocol!==""){m+="://"}m+=n.authority+n.path.substring(0,n.path.lastIndexOf("/"))+"/";var j=n.path.substring(n.path.lastIndexOf("/")+1,n.path.length);if(n.query!==""){j=j+"?"+n.query}k={provider:"FILE",serverurl:m,filename:j,requiredAuth:null,proxyurl:"none"};return k}else{if(k.provider==="EV6"){n=e.parseUrl(k.serverurl);k.serverdefinition={};k.serverdefinition.protocol=n.protocol;k.serverdefinition.hostname=(n.user!=="")?n.user+"@"+n.domain:n.domain;k.serverdefinition.port=n.port;k.serverdefinition.rooturi=n.path;if(k.serverdefinition.rooturi.slice(0,1)==="/"){k.serverdefinition.rooturi=k.serverdefinition.rooturi.slice(1,k.serverdefinition.rooturi.length)}}return k}},setFileTypeFromSpec:function(h){var k="xmlv43";var j="";if((typeof h)==="string"){j=e.getExtension(h)}else{if(!h.provider||(h.provider==="FILE")){if(h.format&&(h.format!=="")){j=h.format}else{var g=h.serverurl?h.serverurl:"";g+=h.filename?h.filename:"";j=e.getExtension(g)}}else{if(h.provider==="EV6"){this.fileType="Ox4MQLV6"}else{if(h.provider==="EV5"){this.fileType="OxMQLV5"}else{this.fileType=h.provider}}}}if(j!==""){if(j.toLowerCase){j=j.toLowerCase()}this.fileType=(j==="3dxml")?"xmlv43":j}},reloadUVR:function(h,j,g,k){var l=this;require(["DS/VisuUnstreamers/UnstreamTaskDriver","DS/VisuUnstreamers/FileInZipStreamObject","DS/Visualization/ProxyAbstraction"],function(o,m,r){var s=l.buildPath(h);var t=new r();e.setProxyFromSpec(s,t);var u=s.serverurl?s.serverurl:"";u+=s.filename?s.filename:"";var p=[];for(var n=0;n<j.length;n++){p.push(j[n].name)}var q=function(x){for(var w=0;w<p.length;w++){var v=new m(x,p[w]);(function(y){o.getTask("CGR",v,j[y],function(z){var B=l.getCGROptions();if(k&&k.applicativeContainers){B.applicativeContainers=k.applicativeContainers}B.unlinkToSG=true;B.destination=[];for(var A=0;A<j[y].parents.length;A++){B.destination.push(j[y].parents[A])}z.run(function(F){var D=F.nodes;if(j&&j[y]&&j[y].parents){var H=j[y].parents.length;for(var E=0;E<H;E++){var G=j[y].parents[E];G.removeChildren();for(var C=0;C<D.length;C++){G.addChild(D[C])}}}},g?g.onLoadedCB:null,g?g.onErrorCB:null,B)})})(w)}};t.executeGetHttpRequest(u,"blob",null,q,l.onErrorCB)})},setWaitMaterial:function(g){this.waitMaterial=g.clone()},abort:function(){if(this.cgrLoader!==null){this.cgrLoader.abort()}if(this.xmlv43Loader!==null){this.xmlv43Loader.abort()}}});return UWA.namespace("THREEDS/ModelLoader",c)});define("Visualization/ModelLoader",["DS/Visualization/ModelLoader","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/ModelLoader");return b});define("DS/Visualization/CGRNode",["UWA/Class","DS/Visualization/SceneGraphUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/PathElement"],function(a,b,j,g,e,c,d){var h=function(o,r,p){var n,k=o.children?o.children.length:0,m=o.primitives?o.primitives.length:0,q;q=r(o,p);if(!q.stop){for(n=0;n<k;n++){h(o.children[n],r,q)}for(n=0;n<m;n++){q=r(o.primitives[n],q)}}else{q.stop=false}};var f=g.extend({init:function(l,k){this._parent(k);this.internalSceneGraph=l;return this},setInternalSceneGraph:function(k){this.internalSceneGraph=k},setHighlight:function(s){var m=0,k=0,o=false;var q=this._getPrimitives(s);for(m in q){o=true;var p=WUX.Selection.HSOManager;var u=q[m].mesh;var n=u._occurrence;var t=new d();var r=q[m].primitives;for(k=0;k<r.length;k++){var t=new d();t.setFromOccurrence(n,r[k]);var l={pathElement:t};var u=l.pathElement.getLastElement(true);if(!u._excludeFromHL){p.add(l)}}}return o},removeHighlight:function(v){var o=0,m=0,q=false;var t=this._getPrimitives(v);for(o in t){q=true;var r=WUX.Selection.HSOManager;var x=t[o].mesh;var p=x._occurrence;var u=t[o].primitives;for(m=0;m<u.length;m++){var w=new d();w.setFromOccurrence(p,u[m]);var n={pathElement:w};var s=false;var k=r.get();for(var o=0;o<k.length;o++){var l=k[o];var w=l.pathElement;if(!w&&l.options){w=l.options.pathElement}if(w&&w.isEqual(n.pathElement)){r.remove(l);s=true;break}}}}return q},show:function(m){var l=0,o=false;var q=this._getPrimitives(m);for(l in q){o=true;var p=q[l].mesh;var k=p._occurrence.node;var n=q[l].primitives;k.show(n)}return o},hide:function(m){var l=0,o=false;var q=this._getPrimitives(m);for(l in q){o=true;var p=q[l].mesh;var k=p._occurrence.node;var n=q[l].primitives;k.hide(n)}return o},getPathElement:function(v,l){var q=0,p=0,s=[];var t=this._getPrimitivesNew(v);for(q in t){var x=t[q].mesh;var r=x._occurrence;var n=r.node;var u=[];while(n.id!==this.id&&n.parents&&n.parents[0]){u.unshift(n);n=n.parents[0]}if(l&&l.externalPath){u=l.externalPath.concat(u)}var m=t[q].reps;for(p=0;p<m.length;p++){var o=[m[p]];var n=m[p];if(m[p].getType()=="primitive"){n=THREEDS.SubElement.getFromSGNode(m[p].sgNode.rep);o.unshift(n)}while(n&&n.sgNode&&n.sgNode.parent){var k=THREEDS.SubElement.getFromSGNode(n.sgNode.parent);o.unshift(k);n=k}var w=new d();w.setFromArray(u,o);s.push(w)}}return s},_getPrimitives:function(o){var n={};if(!(o instanceof Array)){return n}var m=function(t,s){var q,r=t.length;for(q=0;q<r;q++){if(t[q].id==s){return true}}return false};var l=function(s,u){if(s.type==3){var q=new c(s);var t=s.group;if(t&&t.geometry){var v=t.geometry.meshList[0];var r=v.id;if(u.res[r]){if(!m(u.res[r].primitives,q.id)){u.res[r].primitives.push(q)}}else{u.res[r]={mesh:v,primitives:[q]}}}}return u};var p=function(r,s){var q=function(t,u){if(t.cgmId==u.path[u.index]){u.index++;if(u.path.length==u.index){u.res.push(t);u.stop=true;return u}return u}u.stop=true;return u};h(r,q,s)};var k=function(r,t){var x,w,u,y,s=r.children?r.children.length:0,v=t.idArray.length;for(x=0;x<v;x++){if(r.cgmId==t.idArray[x][0]){var q=[];p(r,{path:t.idArray[x],index:0,res:q,stop:false});if(q.length){h(q[0],l,t)}}}return t};h(this.internalSceneGraph,k,{idArray:o,res:n,stop:false});return n},_getPrimitivesNew:function(o){var n={};if(!(o instanceof Array)){return n}var m=function(t,s){var q,r=t.length;for(q=0;q<r;q++){if(t[q].id==s){return true}}return false};var l=function(r,u){if(r.type==2){u.stop=true;if(r.primitives&&r.primitives.length){var t=r.primitives[0].group;var s=THREEDS.SubElement.getFromSGNode(r);if(t&&t.geometry){var v=t.geometry.meshList[0];var q=v.id;if(u.res[q]){if(!m(u.res[q].reps,s.id)){u.res[q].reps.push(s)}}else{u.res[q]={mesh:v,reps:[s]}}}}}return u};var p=function(r,s){var q=function(t,u){if(t.cgmId==u.path[u.index]){u.index++;if(u.path.length==u.index){u.res.push(t);u.stop=true;return u}return u}u.stop=true;return u};h(r,q,s)};var k=function(t,v){var z,y,w,C,u=t.children?t.children.length:0,x=v.idArray.length;for(z=0;z<x;z++){if(t.cgmId==v.idArray[z][0]){var q=[];p(t,{path:v.idArray[z],index:0,res:q,stop:false});if(q.length){if(q[0].type==3){var A=THREEDS.SubElement.getFromSGNode(q[0]);var s=q[0].group;if(s&&s.geometry){var B=s.geometry.meshList[0];var r=B.id;if(v.res[r]){if(!m(v.res[r].reps,A.id)){v.res[r].reps.push(A)}}else{v.res[r]={mesh:B,reps:[A]}}}}else{h(q[0],l,v)}}}}return v};h(this.internalSceneGraph,k,{idArray:o,res:n,stop:false});return n}});return UWA.namespace("THREEDS/Nodes/CGRNode",f)});define("Visualization/CGRNode",["DS/Visualization/CGRNode","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/CGRNode");return b});define("DS/Visualization/LoaderUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/CGRNode","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Mesh/Mesh","DS/SceneGraphNodes/AxisSystemNode","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/FixedSizePlaneNode","DS/Visualization/SceneGraphFactory"],function(l,g,h,m,p,f,k,e,n,d,j){var a=function(x,r){var t=r.materialLibrary;var v=r.baseUrl;var w=new p();var q=t[x];if(q===undefined){return null}var s=t[q.instance];if(s===undefined){return null}var u=t[s.instance];if(u===undefined){return null}if((u.material===undefined)&&(u.params!==undefined)){u.material=w.getMaterial3DXML(u.params,v,"XMLV43");u.material.force=true}else{if(u.params===undefined){u.material=new l.MeshLambertMaterial();u.material.force=true}}return u.material};var o=function(u,D,y,w,s){var t=5;var H=u.length/t;var G=new Array(H);var r=[];var B=-1;var q=null;var v=0;var x=0;var A=0;var z=null;var C=null;var E=0;for(var F=0;F<H;F++){B=u[E++]-1;q=D[u[E++]];v=u[E++];x=u[E++];A=u[E++];C=new f.SGPrimitive({cgmId:B,rep:q,start:v,count:x,decoration:A,group:y});G[F]=C;q.primitives.push(C)}if(w&&w.noShowPrim&&w.noShowPrim.length){for(var F=0;F<w.noShowPrim.length;F++){r.push(G[w.noShowPrim[F]])}}return{primitives:G,noShowPrim:r}};var b=function(y,N,x,q,r,B,K){var L,v=null,Y,Q=false,z=false,H=null,w=[],O=null,G=null,S=new l.Sphere(),C=new l.Box3(),T=[];var s=K.sgRep;var u=K.decorations;var E=new p();for(var X=0;X<y.length;X++){var P=y[X];var D=K.noMeshInRAM;var J=new l.BufferGeometryDS();var aa=new l.Vector3(P.AABB.min[0],P.AABB.min[1],P.AABB.min[2]);var I=new l.Vector3(P.AABB.max[0],P.AABB.max[1],P.AABB.max[2]);J.boundingBox=new l.Box3(aa,I);J.boundingSphere=J.boundingBox.getBoundingSphere();if(O===null){O=aa}if(G===null){G=I}if(aa.x<O.x){O.x=aa.x}if(aa.y<O.y){O.y=aa.y}if(aa.z<O.z){O.z=aa.z}if(I.x>G.x){G.x=I.x}if(I.y>G.y){G.y=I.y}if(I.z>G.z){G.z=I.z}C.set(O,G);S.radius=G.clone().sub(O).multiplyScalar(0.5).length();S.center=G.clone().add(O).multiplyScalar(0.5);for(var W=0;W<P.drawingGroups.length;W++){v=P.drawingGroups[W];P.drawingGroups[W]=new f.DrawingGroup(v.gas,v.material,v.glType,v.start,v.count,v.primitives,null,v._geomType,v.gasIndex);P.drawingGroups[W].cullingData=v.cullingData;if(K.fromCGR){var A=o(v.primitives,s,P.drawingGroups[W],v,K);P.drawingGroups[W].primitives=A.primitives;T=T.concat(A.noShowPrim)}else{v=P.drawingGroups[W];Y=v.primitives;for(var V=0;V<Y.length;V++){Y[V].group=v}}v=P.drawingGroups[W];v.geometry=J;var t=v.gas;var U=v.material;v.gas=null;v.material=null;if((U!==null)&&(U.file!=="")){v.material=a(U.id,B)}else{if((U!==null)&&(U.id!==-1)&&((v.glType===4)||(t.forceMaterial))){if(r[U.id]){L=r[U.id]}else{if(U.shading){x[U.id].shading=U.shading}L=E.getMaterialCgr(x[U.id],undefined,"CGR",q);r[U.id]=L;if(typeof L.needTangentBinormal!=="undefined"){if(!L.needTangentBinormal||!P.vertexTangentArray||!P.vertexBinormalArray){L.needTangentBinormal=false}}}v.material=L}}if(t!==null){var M=new l.Color();M.setRGB(t.color.r,t.color.g,t.color.b);if(t.lineWidth&&K&&!K.edgeTransparency){t.opacity=1}if((t.pattern>1)||(t.lineWidth>1)){D=false}v.gas=E.getMaterialFromGAS({color:M,opacity:t.opacity,pattern:t.pattern,lineWidth:t.lineWidth,forceLineWidth:t.forceLineWidth,solid:t.solid,symbol:t.symbol,basic:t.basic,resource:q})}}J.drawingGroups=P.drawingGroups;J.decorations=u;J.vertexPositionArray=P.vertexPositionArray;if(P.vertexNormalArray!==null){J.vertexNormalArray=P.vertexNormalArray}if(P.vertexUvArray!==null){J.vertexUvArray=P.vertexUvArray}if(P.vertexTangentArray!==null){J.vertexTangentArray=P.vertexTangentArray}if(P.vertexBinormalArray!==null){J.vertexBinormalArray=P.vertexBinormalArray}J.vertexIndexArray=P.vertexIndexArray;if(K&&K.sharedBuffers){J.sharedBuffers=true}J.noMeshInRAM=D;w.push(J)}var ab=new l.Color();ab.setRGB(y[0].gas.fill.color.r,y[0].gas.fill.color.g,y[0].gas.fill.color.b);var Z=new l.Color();Z.setRGB(y[0].gas.line.color.r,y[0].gas.line.color.g,y[0].gas.line.color.b);var U=E.getMaterialFromGAS({color:ab,opacity:y[0].gas.fill.opacity,solid:y[0].gas.fill.solid,basic:y[0].gas.fill.basic,resource:q});U.line=E.getMaterialFromGAS({color:Z,opacity:y[0].gas.line.opacity,lineWidth:y[0].gas.line.lineWidth});w.boundingSphere=S;w.boundingBox=C;H=new l.Mesh(w,U);H.fromLoadedModel=true;for(var X=0;X<w.length;X++){var R=f.unindexPoints(w[X]);if(R){w[X].sharedBuffers=false}}H.matrixAutoUpdate=false;H.castShadow=true;H.receiveShadow=true;var F=new m(H);if(T.length){F.hide(T)}return F};var c={__storeCGRNames:1,createEmptyMesh:function(){var r=new l.BufferGeometryDS();r.boundingSphere=new l.Sphere(new l.Vector3(),0);r.boundingBox=new l.Box3();var q=new l.MeshPhongMaterial();var s=new l.Mesh(r,q);s.matrixAutoUpdate=false;s.castShadow=true;s.receiveShadow=true;return new m(s)},processData:function(aq,ap,L,X,V){var ai=function(az,aK){var aC,aG,aF,aE,aA,r,ax;aC=az.view32UInt[az.offset++];aG=az.view8UInt[az.offset*4];switch(aG){case 1:aF=az.view8UInt[az.offset*4+1];az.offset++;aE=az.view32UInt[az.offset++];ax=new f.SGBag({cgmId:aC,solid:aF,parent:aK});for(aA=0;aA<aE;aA++){r=ai(az,ax);ax.children.push(r)}break;case 2:aF=az.view8UInt[az.offset*4+1];az.offset++;aE=az.view32UInt[az.offset++];ax=new f.SGRep({cgmId:aC,solid:aF,parent:aK});for(aA=0;aA<aE;aA++){aC=az.view32UInt[az.offset++];aG=az.view8UInt[az.offset*4];var aD,aw,aH,ay,aJ,aI,aB,av;av=az.view8UInt[az.offset*4+1];aB=az.view8UInt[az.offset*4+2];az.offset++;aD=az.view32UInt[az.offset++];aw=az.view32UInt[az.offset++];if(aB){aJ=[];for(aA=0;aA<aB+1;aA++){aJ.push(az.view8UInt[az.offset*4+aA])}az.offset+=((aB+1)/4>>0)+1}if(av){aI={center:[],radius:0};aI.center[0]=az.view32F[az.offset++];aI.center[1]=az.view32F[az.offset++];aI.center[2]=az.view32F[az.offset++];aI.radius=az.view32F[az.offset++]}}break;case 3:var aD,aw,aH,ay,aJ,aI,aB,av;av=az.view8UInt[az.offset*4+1];aB=az.view8UInt[az.offset*4+2];az.offset++;aD=az.view32UInt[az.offset++];aw=az.view32UInt[az.offset++];ay=az.view32UInt[az.offset++];if(ay==az.groupArray.length){aH={group:ay,primitives:[]};az.groupArray[ay]=aH}else{aH=az.groupArray[ay]}if(aB){aJ=[];for(aA=0;aA<aB+1;aA++){aJ.push(az.view8UInt[az.offset*4+aA])}az.offset+=((aB+1)/4>>0)+1}if(av){aI={center:[],radius:0};aI.center[0]=az.view32F[az.offset++];aI.center[1]=az.view32F[az.offset++];aI.center[2]=az.view32F[az.offset++];aI.radius=az.view32F[az.offset++]}break}return};var t=function(ax){var aw=ax.length;for(var av=0;av<ax.length;av++){var az=ax[av].img;var ay=ax[av].format;if(ay==2){for(var r=0;r<az.length;r+=3){if(az[r]==255&&az[r+1]==255&&az[r+2]==255){az[r]=0;az[r+1]=0;az[r+2]=0}}}if(ay==3){for(var r=0;r<az.length;r+=4){if((az[r]==255&&az[r+1]==255&&az[r+2]==255)){az[r]=0;az[r+1]=0;az[r+2]=0}}}}};var D=function(az,av){if(!az){return[]}var ay=3;if(av.withSAG){ay+=1}if(av.primitiveWithBS){ay+=4}var ax=az.length/ay;var aA=new Array(ax);var r=0;if(av.withSAG){if(av.primitiveWithBS){for(var aw=0;aw<ax;aw++){aA[aw]=new f.SGRep({cgmId:az[r++]-1,solid:az[r++],namingContext:az[r++],sag:az[r++],boundingSphere:{radius:az[r++],center:[az[r++],az[r++],az[r++]]}})}}else{for(var aw=0;aw<ax;aw++){aA[aw]=new f.SGRep({cgmId:az[r++]-1,solid:az[r++],namingContext:az[r++],sag:az[r++]})}}}else{if(av.primitiveWithBS){for(var aw=0;aw<ax;aw++){aA[aw]=new f.SGRep({cgmId:az[r++]-1,solid:az[r++],namingContext:az[r++],boundingSphere:{radius:az[r++],center:[az[r++],az[r++],az[r++]]}})}}else{for(var aw=0;aw<ax;aw++){aA[aw]=new f.SGRep({cgmId:az[r++]-1,solid:az[r++],namingContext:az[r++]})}}}return aA};var ah=function(ax,az){if(!ax||!az){return}var av=ax.children;var ay=null;var r=av.length;for(var aw=0;aw<r;aw++){if(av[aw].children){ah(av[aw],az)}else{if(!ay){ay=[]}if(av[aw].parent){}else{az[av[aw]].parent=ax;ay.push(az[av[aw]])}}}if(ay){ax.children=ay}};var Z=function(az){var r=[];for(var ax=0;ax<az.length;){var ay=az[ax]+1;var aw=new Uint8Array(ay);for(var av=0;av<ay;av++){aw[av]=az[ax++]}r.push(aw)}return r};var A=function(){this.children=[]};A.prototype.addChild=function(r){this.children.push(r)};var M=null,J=null,U=null,ad=[],w=[],O=[],v;if(!V){V={}}if(V&&V.textureInBlack&&ap){t(ap.resource)}if(X){v=new g(ap.sceneGraph)}else{v=new A()}var P=new p();P.cleanResources();var I=true;if(ap.rep){if(ap.rep.length>0){M=b(ap.rep,ad,ap.material,ap.resource,w,L,V)}if(M){v.addChild(M);I=false}}else{V.fromCGR=true;var C=D(ap.sgRep,V);if(X){ah(ap.sceneGraph,C)}V.sgRep=C;V.decorations=ap.decorations;for(var ao=0;ao<ap.reps.length;ao++){if(!ap.reps[ao].length){continue}if(ao&1){M=new h();M.name=ap.node+"_parallelToScreen";for(var an=0;an<ap.reps[ao].length;++an){var ab=b(ap.reps[ao][an].tab,ad,ap.material,ap.resource,w,L,V);var aa=ap.reps[ao][an].globalMatrix;var q={type:"Spherical",};var ak=new e(q);ak.addChild(ab);ak.setMatrix(new l.Matrix4().setFromArray(aa.elements));M.addChild(ak)}if(M.children.length==0){M=null}}else{M=b(ap.reps[ao],ad,ap.material,ap.resource,w,L,V);if(this.__storeCGRNames===1){M.name=ap.node}}if(ao&2){M.setExcludeFromBounding(true)}if(ao&4){M.setNoZ(true)}if(M){O.push(M);v.addChild(M);I=false}}}if(V.processText&&ap.texts&&ap.texts.length>0){for(var ao=0;ao<ap.texts.length;++ao){var ac=ap.texts[ao];var Y=new l.Color(ac.color.r*255,ac.color.g*255,ac.color.b*255);var ar=j.createTextNode({bbox:ac.bbox,text:ac.text,font:ac.fontName,color:Y,stroke:ac.stroke,fontSize:ac.bbox[3]-ac.bbox[2],textAlign:ac.horJustif,resolutionCoef:128,path:ac.path});if(ac.matrix){ar.setMatrix(new l.Matrix4().setFromArray(ac.matrix.elements))}O.push(ar);v.addChild(ar);I=false}}if(ap.refPlanes&&ap.refPlanes.length>0){var am=new h();U=new h("RefPlanes");U.setNoZ(true);U.setVisibility(false);U.setVisibilityInTree(false);var y=0.264583333;for(var ao=0;ao<ap.refPlanes.length;++ao){for(var an=0;an<ap.refPlanes[ao].length;an++){var s=ap.refPlanes[ao][an];var au=null;var K=s.length*0.7071068*window.devicePixelRatio/y;var al=new l.Vector3(s.origin[0],s.origin[1],s.origin[2]);var Y=new f.Color(s.color[0],s.color[1],s.color[2],s.color[3]);if(s.zoomable){au=j.createRectangleNode({color:Y,width:K,height:K,fill:false});au.setShadow(false);au.setFrustumCulled(false);var ae=new l.Vector3(-K/2,-K/2,0);var z=new l.Matrix4().setPosition(ae);au.setMatrix(z)}else{var q={sgRep:C[s.rep],origin:al,direction2:new l.Vector3(s.xAxis[0]+s.yAxis[0],s.xAxis[1]+s.yAxis[1],s.xAxis[2]+s.yAxis[2]),direction1:new l.Vector3(s.xAxis[0]-s.yAxis[0],s.xAxis[1]-s.yAxis[1],s.xAxis[2]-s.yAxis[2]),sceneGraph:am,color:Y,length:K,name:"ref Plane "+ao,};au=new d(q)}U.addChild(au)}}}if(U){U._forceGeomType("INFINITE_FACE");O.push(U);v.addChild(U);I=false}if(ap.axisSystems&&ap.axisSystems.length>0){var am=new h();J=new h("AxisSystems");J.setVisibility(false);J.setVisibilityFree(true);J.setVisibilityInTree(false);var y=0.264583333;for(var ao=0;ao<ap.axisSystems.length;++ao){var B=ap.axisSystems[ao];var u=null;var S=B.zoomable||false;var q={sgRep:C[B.rep],headLength:10,arrowLength:S?B.length:50,arrowWidth:2,sceneGraph:am,colors:{colorX:new f.Color(B.color[0]/255,B.color[1]/255,B.color[2]/255,0),colorY:new f.Color(B.color[0]/255,B.color[1]/255,B.color[2]/255,0),colorZ:new f.Color(B.color[0]/255,B.color[1]/255,B.color[2]/255,0),},name:"axis System 1",head:k.types.ARROW,zoomable:S};u=new k(q);var H=new l.Matrix4();var x=[];x[0]=B.xAxis[0];x[1]=B.xAxis[1];x[2]=B.xAxis[2];x[3]=0;x[4]=B.yAxis[0];x[5]=B.yAxis[1];x[6]=B.yAxis[2];x[7]=0;x[8]=B.zAxis[0];x[9]=B.zAxis[1];x[10]=B.zAxis[2];x[11]=0;x[12]=B.origin[0];x[13]=B.origin[1];x[14]=B.origin[2];x[15]=1;H.setFromArray(x);u.setMatrix(H);J.addChild(u);if(B.refPlanes!==undefined){var G=null;if(S){G=new h();var F=null;for(var aj=0;aj<B.refPlanes.length;aj++){var Y=new f.Color(B.color[0]/255,B.color[1]/255,B.color[2]/255,B.color[3]/255);F=B.refPlanes[aj];var R=new l.Vector3(F[0],F[1],F[2]);var Q=new l.Vector3(F[3],F[4],F[5]);var N=new l.Vector3(F[6],F[7],F[8]);var ag=[R,Q,N];var au=j.createLineNode({points:ag,color:Y});au.setShadow(false);au.setFrustumCulled(false);G.addChild(au)}}else{G=new h("fixedSizeHalfPlanes");var at=new l.Matrix4().getInverse(H);var af=[B.xAxis,B.yAxis,B.zAxis];for(var aj=0;aj<B.refPlanes.length&&B.refPlanes[aj].mode===1;aj++){var K=B.refPlanes[aj].length*window.devicePixelRatio/y;var Y=new f.Color(B.color[0]/255,B.color[1]/255,B.color[2]/255,B.color[3]/255);var T=B.refPlanes[aj].direction1;var E=B.refPlanes[aj].direction2;var Q=new l.Vector3(0.5*K*T[0],0.5*K*T[1],0.5*K*T[2]);var R=new l.Vector3(Q.x+0.5*0.5*K*(T[0]+E[0]),Q.y+0.5*0.5*K*(T[1]+E[1]),Q.z+0.5*0.5*K*(T[2]+E[2]));var N=new l.Vector3(Q.x+0.5*0.5*K*(T[0]-E[0]),Q.y+0.5*0.5*K*(T[1]-E[1]),Q.z+0.5*0.5*K*(T[2]-E[2]));var ag=[R,Q,N];var au=j.createLineNode({points:ag,color:Y});au.setShadow(false);au.setFrustumCulled(false);G.addChild(au)}var W=new l.Matrix4().multiplyMatrices(at,new l.Matrix4().setPosition(new l.Vector3(B.origin[0],B.origin[1],B.origin[2])));G.setMatrix(W);G._setRatio(1)}G.setNoZ(true);u.addChild(G)}}}if(J){J._forceGeomType("AXIS_SYSTEM");O.push(J);v.addChild(J);I=false}if(aq&&!V.unlinkToSG){if(X){for(var ao=0;ao<aq.length;ao++){if(aq[ao]){if(I){M=c.createEmptyMesh();M.name=ap.node;aq[ao].addChild(M)}else{aq[ao].addChild(v);O=[v]}if(ap.sceneGraph&&ap.sceneGraph.noShow){v.setVisibility(false)}}}}else{for(var ao=0;ao<aq.length;ao++){if(aq[ao]){if(I){M=c.createEmptyMesh();M.name=ap.node;aq[ao].addChild(M)}else{for(var an=0;an<v.children.length;an++){aq[ao].addChild(v.children[an])}}}}}}return O}};return c});define("DS/Visualization/WebGLV6Viewer",["DS/Visualization/WebGLViewer","DS/Robot/Robot","DS/Robot/ReferenceAxisSystemNode","DS/Robot/CustomReferenceAxisSystem","DS/Visualization/InternalSceneGraph","DS/SceneGraphOverrides/SceneGraphState","DS/SceneGraphOverrides/SceneGraphOverrideSetManager","DS/Visualization/OccurrenceRenderingOverride","DS/SceneGraphOverrides/OverrideLink2","DS/QualityManager/QMController"],function(c,g,d,b,h,e,f,k,a,j){var l=c.extend({init:function(p){this._ignoreQM=(p.ignoreQM!==undefined)?!!p.ignoreQM:false;this._QMModif=false;this._QMSettings={AntiAliasing:{modified:false,value:{"static":"SMAA",dynamic:"SMAA"}},AllowOutline:{modified:false,value:{"static":true,dynamic:true}},PixelCulling:{modified:false,value:{"static":4.5,dynamic:4.5}},Transparency:{modified:false,value:{"static":"AlphaBlending",dynamic:"AlphaBlending"}},AllowGroundShadows:{modified:false,value:{"static":true,dynamic:true}},AllowInterObjectShadows:{modified:false,value:{"static":true,dynamic:true}},ShadowQuality:{modified:false,value:{"static":"Medium",dynamic:"Medium"}},ShadowFilter:{modified:false,value:{"static":"PCFOptimized",dynamic:"PCFOptimized"}},AllowGroundReflection:{modified:false,value:{"static":true,dynamic:true}},AllowSSAO:{modified:false,value:{"static":true,dynamic:true}},AllowBloom:{modified:false,value:{"static":true,dynamic:true}},AllowDepthOfField:{modified:false,value:{"static":true,dynamic:true}},ZPrePass:{modified:false,value:{"static":false,dynamic:false}},};if(!j.isInitialized){j.init();j.initPresetDB("QualityPresets")}j.linkToViewer(this);this._parent(p);this._sceneGraphOverrideSetManager=new f(this);this._iterativeAA=false;this._staticAAPostPro="SMAA";var o=j.getCurrentGlobalPreset("Static");var n=j.getPresetValue("Static",o);if(n){var m={AntiAliasing:n.AntiAliasing.IterativeAntiAliasing?"MSAA":n.AntiAliasing.AntiAliasing,AllowOutline:n.OutlineViewMode.AllowOutline,PixelCulling:n.PixelCulling.PixelCulling,Transparency:n.Transparency.Transparency,AllowGroundShadows:n.Shadows.AllowGroundShadows,AllowInterObjectShadows:n.Shadows.AllowInterObjectShadows,ShadowQuality:n.Shadows.ShadowQuality,ShadowFilter:n.Shadows.ShadowFilter,AllowGroundReflection:n.Reflections.AllowGroundReflection,AllowSSAO:n.AmbientOcclusion.AllowSSAO,AllowBloom:n.Bloom.AllowBloom,AllowDepthOfField:n.DepthOfField.AllowDepthOfField};this._iterativeAA=!!n.AntiAliasing.IterativeAntiAliasing;this._staticAAPostPro=n.AntiAliasing.AntiAliasing;!this.ODTMode&&this._setQMSettings(m,"static")}o=j.getCurrentGlobalPreset("Dynamic");n=j.getPresetValue("Dynamic",o);if(n){var m={AntiAliasing:n.AntiAliasing.AntiAliasing,AllowOutline:n.OutlineViewMode.AllowOutline,PixelCulling:n.PixelCulling.PixelCulling,Transparency:n.Transparency.Transparency,AllowGroundShadows:n.Shadows.AllowGroundShadows,AllowInterObjectShadows:n.Shadows.AllowInterObjectShadows,ShadowQuality:n.Shadows.ShadowQuality,ShadowFilter:n.Shadows.ShadowFilter,AllowGroundReflection:n.Reflections.AllowGroundReflection,AllowSSAO:n.AmbientOcclusion.AllowSSAO,AllowBloom:n.Bloom.AllowBloom,AllowDepthOfField:n.DepthOfField.AllowDepthOfField};!this.ODTMode&&this._setQMSettings(m,"dynamic")}},setRobot:function(m,n){if(this.internalSceneGraph&&this.internalSceneGraph.setRobot(m,n,this)){this.render()}},getRobot:function(){if(!this.internalSceneGraph){return null}return this.internalSceneGraph.getRobot()},setCustomReferenceAxisSystem:function(m){if(this.internalSceneGraph){this.internalSceneGraph.setCustomReferenceAxisSystem(m);this.render()}},getCustomReferenceAxisSystem:function(){return this.internalSceneGraph&&this.internalSceneGraph._customReferenceAxisSystem},setReferenceAxisSystem:function(m){this.internalSceneGraph.showReferenceAxisSystem(m,undefined)},createSceneGraphState:function(){if(this._sceneGraphStateVersion&&this._sceneGraphStateVersion!==1){console.warn("Cannot use both v1 and v2 sceneGraphStates");throw Error()}if(!this._sceneGraphStateVersion){this._sceneGraphStateVersion=1}var m=this.getRootNode();if(m){return new e(this,this.getRootNode())}},setCurrentSceneGraphState:function(n){if(this._sceneGraphStateMode&&this._sceneGraphStateVersio!==1){console.warn("Cannot use both v1 and v2 sceneGraphStates");throw Error()}if(!this._sceneGraphStateVersion){this._sceneGraphStateVersion=1}if(n instanceof e||(this.sceneGraphState instanceof e&&!n)){var m=this.getRootNode();if(!n||(n.viewer===this&&n.sceneGraph===m)){if(n!==this.sceneGraphState){if(this.sceneGraphState){this.sceneGraphState.onDeactivation(m)}if(n){n.onActivation(m)}this.sceneGraphState=n;this.internalSceneGraph.root._occurrences[0].requestOverridesUpdate()}}}},_qmSetShadow:function(m,n){if(m&&!this._QMSettings.AllowInterObjectShadows.value[n]){if(this._QMModif){return false}else{this._QMSettings.AllowInterObjectShadows.value[n]=true;this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowInterObjectShadows",value:true,staticValue:this._QMSettings.AllowInterObjectShadows.value["static"],dynamicValue:this._QMSettings.AllowInterObjectShadows.value.dynamic,viewer:this}})}}return true},_qmSetOIT:function(m,o){var n=m?"WeightedAverage":"AlphaBlending";this._QMSettings.Transparency.value[o]=n;if(!this._QMModif){this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"Transparency",value:n,staticValue:this._QMSettings.Transparency.value["static"],dynamicValue:this._QMSettings.Transparency.value.dynamic,viewer:this}})}return true},_qmEnableZPrePass:function(m,n){this._QMSettings.ZPrePass.value[n]=m;if(!this._QMModif){this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"ZPrePass",value:m,staticValue:this._QMSettings.ZPrePass.value["static"],dynamicValue:this._QMSettings.ZPrePass.value.dynamic,viewer:this}})}return true},_qmSetShadowFilter:function(m,n){this._QMSettings.ShadowFilter.value[n]=m;if(!this._QMModif){this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"ShadowFilter",value:m,staticValue:this._QMSettings.ShadowFilter.value["static"],dynamicValue:this._QMSettings.ShadowFilter.value.dynamic,viewer:this}})}return true},_qmSetShadowQuality:function(m,n){this._QMSettings.ShadowQuality.value[n]=m;if(!this._QMModif){this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"ShadowQuality",value:m,staticValue:this._QMSettings.ShadowQuality.value["static"],dynamicValue:this._QMSettings.ShadowQuality.value.dynamic,viewer:this}})}return true},_qmSetGroundShadow:function(m,n){if(m&&!this._QMSettings.AllowGroundShadows.value[n]){if(this._QMModif){return false}else{this._QMSettings.AllowGroundShadows.value[n]=true;this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowGroundShadows",value:true,staticValue:this._QMSettings.AllowGroundShadows.value["static"],dynamicValue:this._QMSettings.AllowGroundShadows.value.dynamic,viewer:this}})}}return true},_qmSetMirror:function(m,n){if(m&&!this._QMSettings.AllowGroundReflection.value[n]){if(this._QMModif){return false}else{this._QMSettings.AllowGroundReflection.value[n]=true;this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowGroundReflection",value:true,staticValue:this._QMSettings.AllowGroundReflection.value["static"],dynamicValue:this._QMSettings.AllowGroundReflection.value.dynamic,viewer:this}})}}return true},_qmSetAntiAliasing:function(m,n){this._QMSettings.AntiAliasing.value[n]=m;if(!this._QMModif){this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AntiAliasing",value:m,staticValue:this._QMSettings.AntiAliasing.value["static"],dynamicValue:this._QMSettings.AntiAliasing.value.dynamic,viewer:this}})}return true},_qmSetPixelCulling:function(n,m){this._QMSettings.PixelCulling.value[m]=n;if(!this._QMModif){this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"PixelCulling",value:n,staticValue:this._QMSettings.PixelCulling.value["static"],dynamicValue:this._QMSettings.PixelCulling.value.dynamic,viewer:this}})}return true},_qmSetSSAO:function(m,n){if(m&&!this._QMSettings.AllowSSAO.value[n]){if(this._QMModif){return false}else{this._QMSettings.AllowSSAO.value[n]=true;this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowSSAO",value:true,staticValue:this._QMSettings.AllowSSAO.value["static"],dynamicValue:this._QMSettings.AllowSSAO.value.dynamic,viewer:this}})}}return true},_qmSetDOF:function(m,n){if(m&&!this._QMSettings.AllowDepthOfField.value[n]){if(this._QMModif){return false}else{this._QMSettings.AllowDepthOfField.value[n]=true;this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowDepthOfField",value:true,staticValue:this._QMSettings.AllowDepthOfField.value["static"],dynamicValue:this._QMSettings.AllowDepthOfField.value.dynamic,viewer:this}})}}return true},_qmSetBloom:function(m,n){if(m&&!this._QMSettings.AllowBloom.value[n]){if(this._QMModif){return false}else{this._QMSettings.AllowBloom.value[n]=true;this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowBloom",value:true,staticValue:this._QMSettings.AllowBloom.value["static"],dynamicValue:this._QMSettings.AllowBloom.value.dynamic,viewer:this}})}}return true},setVisuEnv:function(m){this._QMModif=true;this._parent(m);this._QMModif=false},_setQMSettings:function(n,o){if(this._ignoreQM){return}this._QMModif=true;o=o.toLowerCase();if((o!=="static")&&(o!=="dynamic")){o="static"}if(o==="dynamic"){if(n.AntiAliasing!==undefined){this.setAntiAliasing(n.AntiAliasing,o)}}else{if(n.AntiAliasing!==undefined){this._staticAAPostPro=n.AntiAliasing}if(n.IterativeAntiAliasing!==undefined){if(n.IterativeAntiAliasing){this._iterativeAA=true;this.setAntiAliasing("MSAA",o)}else{this._iterativeAA=false;this.setAntiAliasing(this._staticAAPostPro,o)}}else{if(n.AntiAliasing!==undefined){if(!this._iterativeAA){this.setAntiAliasing(this._staticAAPostPro,o)}}}}if(n.PixelCulling!==undefined){this.setPixelCulling(n.PixelCulling,o)}if(n.Transparency!==undefined){if(!this._QMSettings.Transparency.modified){this.setOIT(n.Transparency==="WeightedAverage",o)}}if(n.AllowGroundShadows!==undefined){if(!this._QMSettings.AllowGroundShadows.modified){this._QMSettings.AllowGroundShadows.value[o]=n.AllowGroundShadows;if(!n.AllowGroundShadows){this.setGroundShadow(false,o)}}}if(n.AllowInterObjectShadows!==undefined){if(!this._QMSettings.AllowInterObjectShadows.modified){this._QMSettings.AllowInterObjectShadows.value[o]=n.AllowInterObjectShadows;if(!n.AllowInterObjectShadows){this.setShadow(false,false,o)}}}if(n.ShadowQuality!==undefined){if(!this._QMSettings.ShadowQuality.modified){this.setShadowQuality(n.ShadowQuality,o)}}if(n.ShadowFilter!==undefined){if(!this._QMSettings.ShadowFilter.modified){var m=(n.ShadowFilter==="PCF")?"PCFOptimized":n.ShadowFilter;this.setShadowFilter(m,o)}}if(n.AllowGroundReflection!==undefined){if(!this._QMSettings.AllowGroundReflection.modified){this._QMSettings.AllowGroundReflection.value[o]=n.AllowGroundReflection;if(!n.AllowGroundReflection){this.setMirror(false,true,o)}}}if(n.AllowSSAO!==undefined){if(!this._QMSettings.AllowSSAO.modified){this._QMSettings.AllowSSAO.value[o]=n.AllowSSAO;if(!n.AllowSSAO){this.setSSAO(false,o)}}}if(n.AllowBloom!==undefined){if(!this._QMSettings.AllowBloom.modified){this._QMSettings.AllowBloom.value[o]=n.AllowBloom;if(!n.AllowBloom){this.setBloom(false,o)}}}if(n.AllowDepthOfField!==undefined){if(!this._QMSettings.AllowDepthOfField.modified){this._QMSettings.AllowDepthOfField.value[o]=n.AllowDepthOfField;if(!n.AllowDepthOfField){this.setDOF(false,o)}}}this._QMModif=false},_getQMSetting:function(m){var n=this._QMSettings[m];if(m==="IterativeAntiAliasing"){n={modified:false,value:{"static":this._iterativeAA,dynamic:false}}}else{if(!n){return null}}return{modified:n.modified,value:n.value["static"],staticValue:n.value["static"],dynamicValue:n.value.dynamic}},_onQMSettingModified:function(m){return this._modelEvent.subscribe({event:"QMSettingModified"},m)},dispose:function(){j.dispose();this._parent()}});h.setRobotClasses(g,d,b);k.setOverrideLink2Class(a);return UWA.namespace("THREEDS/WebGLV6Viewer",l)});define("Visualization/WebGLV6Viewer",["DS/Visualization/WebGLV6Viewer","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/WebGLV6Viewer");return b});define("DS/Visualization/CSIViewer",["DS/Visualization/WebGLV6Viewer","DS/Visualization/ViewManager"],function(c,b){var a=c.extend({init:function(d){this._parent(d);this.newModelIdentification=(d.newModelIdentification!==undefined)?d.newModelIdentification:false;this.viewManager=new b(this);return this},onVisuAnswer:function(d){return this.viewManager.onVisuAnswer(d)},setStaticMaterial:function(d,e){console.warn("setStaticMaterial method is deprecated. Use setStaticLook instead.");this.viewManager.setStaticMaterial(d,e)},setStaticLook:function(d,e){this.viewManager.setStaticLook(d,e)},setDefaultMaterials:function(d){this.viewManager.setDefaultMaterials(d)},setAlternativeEditDisplay:function(d){this.viewManager.setTemporaryBodies(d)},empty:function(e,d){this._parent(e,d);this.viewManager.clear()},updatePlaneOnViewMessage:function(d){this.viewManager.updatePlaneOnViewMessage(d)}});return UWA.namespace("THREEDS/CSIViewer",a)});define("DS/Visualization/AnnotationServices",["UWA/Class","DS/Visualization/Utils","DS/Formats/CGRFile","DS/Visualization/ModelLoader","DS/Visualization/ProxyAbstraction","DS/ZipJS/LoaderInflate"],function(b,g,h,e,f,d){var a=null,c=b.extend({init:function(){if(a!==null){this.loader=a.loader;this.modelLoader=a.modelLoader;return this}this.loader=new h();this.modelLoader=new e();a=this;return this},cleanAll:function(){this.loader=null;this.modelLoader=null},getApplicativeContainer:function(k,j,l,n,p){if(p){var r=this.modelLoader.buildPath(k);var s=new f();g.setProxyFromSpec(r,s);var t=r.serverurl?r.serverurl:"";t+=r.filename?r.filename:"";var m=this;var o=function(u){return function(w){m.loader.setFileBuffer(new Uint8Array(w));var v=m.loader.getApplicativeContainerOld(u);l(v)}};var q=o(j);s.executeGetHttpRequest(t,"arraybuffer",null,q,n)}else{this.getFTAContainer(k,j,l,n)}},getApplicativeContainerNew:function(k,j,l,n){var q=this.modelLoader.buildPath(k);var r=new f();g.setProxyFromSpec(q,r);var s=q.serverurl?q.serverurl:"";s+=q.filename?q.filename:"";var m=this;var o=function(t){return function(v){m.loader.setFileBuffer(new Uint8Array(v));var u=m.loader.getApplicativeContainer(t);l(u)}};var p=o(j);r.executeGetHttpRequest(s,"arraybuffer",null,p,n)},processFTABuffer:function(m){var j=function(w){var r,t,q,v,u,s;r="";q=w.length;t=0;while(t<q){v=w[t++];switch(v>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:r+=String.fromCharCode(v);break;case 12:case 13:u=w[t++];r+=String.fromCharCode(((v&31)<<6)|(u&63));break;case 14:u=w[t++];s=w[t++];r+=String.fromCharCode(((v&15)<<12)|((u&63)<<6)|((s&63)<<0));break}}return r};if(!m){return null}var k=m.buffer.subarray(m.options.offset,m.options.compressed+m.options.offset);if(k.length<=2){return null}if(k[0]!==120){return null}if(k[1]!==218){return null}var p=2;var l=k.subarray(p,m.options.compressed);var n=new d();var o=n.Inflate(l);return j(o)},getFTAContainer:function(k,l,o,m){var p=this;var j=function(r){var q=p.processFTABuffer(r);if(q){o({xml:q})}else{o()}};var n=this.getApplicativeContainerNew(k,l,j,m)},openSceneGraph:function(j){return this.loader.openSceneGraph(j)}});return UWA.namespace("THREEDS/AnnotationServices",c)});define("Visualization/AnnotationServices",["DS/Visualization/AnnotationServices","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/AnnotationServices");return b});define("DS/Visualization/TextNode",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/EditableMesh3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement"],function(c,f,a,e,d){var h={count:97,width:256,height:256,chars:{0:{yoffset:1.5,width:4,xadvance:0,y:238,x:223,height:4,xoffset:-1.5},13:{yoffset:1.5,width:4,xadvance:9.25,y:252,x:250,height:4,xoffset:-1.5},32:{yoffset:1.5,width:4,xadvance:9.25,y:252,x:246,height:4,xoffset:-1.5},33:{yoffset:27.063,width:12,xadvance:9.5,y:0,x:186,height:30,xoffset:-0.688},34:{yoffset:27.063,width:15,xadvance:18,y:15,x:210,height:14,xoffset:3},35:{yoffset:26.438,width:24,xadvance:19.5,y:125,x:48,height:28,xoffset:-1.875},36:{yoffset:32.125,width:24,xadvance:19.938,y:65,x:24,height:40,xoffset:-1.625},37:{yoffset:27.938,width:30,xadvance:31.813,y:94,x:48,height:31,xoffset:1.5},38:{yoffset:24.75,width:36,xadvance:33.25,y:38,x:0,height:27,xoffset:-0.25},39:{yoffset:27.063,width:8,xadvance:10.875,y:238,x:246,height:14,xoffset:3},40:{yoffset:33,width:16,xadvance:12,y:105,x:24,height:41,xoffset:-0.5},41:{yoffset:33,width:16,xadvance:12,y:211,x:48,height:41,xoffset:-2.188},42:{yoffset:28.938,width:19,xadvance:16.375,y:238,x:227,height:18,xoffset:0.438},43:{yoffset:20.688,width:19,xadvance:18.875,y:237,x:135,height:19,xoffset:0.25},44:{yoffset:6.938,width:11,xadvance:9.5,y:15,x:225,height:15,xoffset:-2.25},45:{yoffset:14.938,width:15,xadvance:15.063,y:247,x:181,height:7,xoffset:0.25},46:{yoffset:6.938,width:10,xadvance:9.5,y:243,x:92,height:10,xoffset:-0.875},47:{yoffset:31.875,width:22,xadvance:19.25,y:94,x:135,height:38,xoffset:-1},48:{yoffset:26.875,width:22,xadvance:21.25,y:65,x:81,height:29,xoffset:0.188},49:{yoffset:26.375,width:16,xadvance:15.75,y:0,x:74,height:28,xoffset:0},50:{yoffset:26.875,width:21,xadvance:19,y:65,x:190,height:29,xoffset:-1.438},51:{yoffset:26.813,width:22,xadvance:18.938,y:65,x:147,height:29,xoffset:-2.188},52:{yoffset:27.063,width:22,xadvance:20.188,y:65,x:125,height:29,xoffset:-0.938},53:{yoffset:26.375,width:23,xadvance:19.688,y:182,x:48,height:29,xoffset:-1.688},54:{yoffset:26.813,width:21,xadvance:20.375,y:65,x:211,height:29,xoffset:0.125},55:{yoffset:26.438,width:20,xadvance:16.875,y:65,x:232,height:29,xoffset:0.188},56:{yoffset:26.813,width:22,xadvance:21.125,y:65,x:103,height:29,xoffset:-0.688},57:{yoffset:26.813,width:21,xadvance:20.375,y:222,x:24,height:30,xoffset:0.438},58:{yoffset:20.188,width:11,xadvance:9.5,y:185,x:243,height:23,xoffset:-0.875},59:{yoffset:20.25,width:13,xadvance:9.5,y:0,x:173,height:29,xoffset:-2.25},60:{yoffset:22.563,width:20,xadvance:18.875,y:0,x:121,height:21,xoffset:0.25},61:{yoffset:18.75,width:20,xadvance:18.875,y:0,x:210,height:15,xoffset:0.688},62:{yoffset:22.563,width:20,xadvance:18.875,y:0,x:141,height:21,xoffset:-0.563},63:{yoffset:27.625,width:19,xadvance:18.625,y:185,x:0,height:30,xoffset:0.938},64:{yoffset:27.625,width:38,xadvance:37.75,y:0,x:0,height:38,xoffset:0.188},65:{yoffset:27.125,width:26,xadvance:21.563,y:209,x:201,height:29,xoffset:-3.125},66:{yoffset:27.063,width:23,xadvance:22.875,y:123,x:233,height:29,xoffset:0.188},67:{yoffset:27.625,width:24,xadvance:21.063,y:187,x:109,height:30,xoffset:0.25},68:{yoffset:27.063,width:25,xadvance:24.188,y:123,x:183,height:29,xoffset:0.188},69:{yoffset:27.063,width:22,xadvance:19.5,y:94,x:234,height:29,xoffset:0.188},70:{yoffset:27.063,width:21,xadvance:18.188,y:65,x:169,height:29,xoffset:0.188},71:{yoffset:27.625,width:25,xadvance:23.625,y:153,x:230,height:30,xoffset:0.25},72:{yoffset:27.063,width:25,xadvance:24.625,y:94,x:184,height:29,xoffset:0.188},73:{yoffset:27.063,width:12,xadvance:10.813,y:0,x:198,height:29,xoffset:0.188},74:{yoffset:27.063,width:16,xadvance:11,y:215,x:0,height:35,xoffset:-3.75},75:{yoffset:27.063,width:26,xadvance:22.438,y:209,x:227,height:29,xoffset:0.188},76:{yoffset:27.063,width:19,xadvance:18.563,y:0,x:38,height:29,xoffset:0.188},77:{yoffset:27.063,width:31,xadvance:29.188,y:94,x:78,height:29,xoffset:-1.25},78:{yoffset:27.063,width:25,xadvance:24.75,y:123,x:208,height:29,xoffset:0.188},79:{yoffset:27.625,width:26,xadvance:25.5,y:123,x:157,height:30,xoffset:0.25},80:{yoffset:27.125,width:24,xadvance:21.875,y:123,x:78,height:29,xoffset:0.188},81:{yoffset:27.625,width:26,xadvance:25.5,y:94,x:109,height:34,xoffset:0.25},82:{yoffset:27.125,width:24,xadvance:22.375,y:217,x:109,height:29,xoffset:0.188},83:{yoffset:27.625,width:24,xadvance:20.313,y:157,x:109,height:30,xoffset:-1.75},84:{yoffset:27.063,width:23,xadvance:19.375,y:153,x:48,height:29,xoffset:0.125},85:{yoffset:27.063,width:25,xadvance:24.25,y:153,x:205,height:30,xoffset:0.75},86:{yoffset:27.063,width:25,xadvance:21.625,y:94,x:209,height:29,xoffset:0.438},87:{yoffset:27.125,width:33,xadvance:30.875,y:65,x:48,height:29,xoffset:0.813},88:{yoffset:27.063,width:27,xadvance:21.063,y:94,x:157,height:29,xoffset:-3},89:{yoffset:27.063,width:25,xadvance:21,y:128,x:109,height:29,xoffset:0.125},90:{yoffset:27.063,width:24,xadvance:19.438,y:152,x:78,height:29,xoffset:-2.125},91:{yoffset:31.813,width:17,xadvance:12,y:146,x:24,height:38,xoffset:-1.625},92:{yoffset:31.875,width:20,xadvance:19.375,y:209,x:181,height:38,xoffset:-0.438},93:{yoffset:31.875,width:17,xadvance:12,y:184,x:24,height:38,xoffset:-1.938},94:{yoffset:32.688,width:22,xadvance:19.875,y:238,x:201,height:15,xoffset:0.5},95:{yoffset:-0.563,width:22,xadvance:19.25,y:248,x:157,height:7,xoffset:-3.313},96:{yoffset:31.875,width:14,xadvance:12.125,y:243,x:78,height:11,xoffset:-0.438},97:{yoffset:21.625,width:22,xadvance:21.375,y:38,x:60,height:24,xoffset:-0.375},98:{yoffset:29.438,width:22,xadvance:21.75,y:132,x:135,height:32,xoffset:-0.125},99:{yoffset:21.625,width:20,xadvance:17.25,y:38,x:211,height:24,xoffset:-0.375},100:{yoffset:29.438,width:24,xadvance:21.688,y:153,x:181,height:32,xoffset:-0.375},101:{yoffset:21.625,width:21,xadvance:19.25,y:38,x:169,height:24,xoffset:-0.375},102:{yoffset:29.5,width:24,xadvance:12.375,y:65,x:0,height:40,xoffset:-4.188},103:{yoffset:21.688,width:23,xadvance:21.625,y:216,x:157,height:32,xoffset:-1.125},104:{yoffset:29.438,width:22,xadvance:21.25,y:212,x:78,height:31,xoffset:-0.25},105:{yoffset:30.938,width:13,xadvance:10,y:0,x:108,height:33,xoffset:-0.375},106:{yoffset:30.938,width:17,xadvance:10,y:196,x:135,height:41,xoffset:-4.938},107:{yoffset:29.438,width:22,xadvance:20.813,y:181,x:78,height:31,xoffset:-0.25},108:{yoffset:29.438,width:12,xadvance:10.438,y:0,x:161,height:32,xoffset:0},109:{yoffset:21.625,width:32,xadvance:31.375,y:185,x:181,height:24,xoffset:-0.25},110:{yoffset:21.625,width:22,xadvance:21.25,y:38,x:104,height:24,xoffset:-0.25},111:{yoffset:21.625,width:22,xadvance:21.313,y:38,x:82,height:24,xoffset:-0.375},112:{yoffset:21.625,width:24,xadvance:21.75,y:153,x:157,height:32,xoffset:-1.375},113:{yoffset:21.625,width:22,xadvance:21.563,y:164,x:135,height:32,xoffset:-0.375},114:{yoffset:21.625,width:18,xadvance:14.313,y:0,x:90,height:24,xoffset:-0.25},115:{yoffset:21.563,width:20,xadvance:17.563,y:38,x:231,height:24,xoffset:-1.938},116:{yoffset:26,width:17,xadvance:13.75,y:0,x:57,height:29,xoffset:-0.563},117:{yoffset:21.063,width:21,xadvance:21.063,y:38,x:148,height:24,xoffset:0.313},118:{yoffset:21.125,width:22,xadvance:18.375,y:38,x:126,height:23,xoffset:-0.375},119:{yoffset:21.125,width:30,xadvance:27.125,y:185,x:213,height:23,xoffset:0},120:{yoffset:21.063,width:24,xadvance:18,y:38,x:36,height:23,xoffset:-3.438},121:{yoffset:21.125,width:24,xadvance:18.313,y:185,x:157,height:31,xoffset:-2.25},122:{yoffset:21.063,width:21,xadvance:16.375,y:38,x:190,height:23,xoffset:-2.5},123:{yoffset:32.438,width:16,xadvance:12,y:145,x:0,height:40,xoffset:-0.813},124:{yoffset:31.375,width:12,xadvance:14.375,y:211,x:64,height:37,xoffset:1.688},125:{yoffset:32.438,width:16,xadvance:12,y:105,x:0,height:40,xoffset:-2.313},126:{yoffset:16.125,width:21,xadvance:18.875,y:246,x:109,height:9,xoffset:-0.438}},base:41};var b=function(m,o,j,n){var l=this.opacity;if(n&&n.getOpacity()!==null){l=n.getOpacity()}o.uniform1f(j.opacity,l);var k=0;o.uniform1i(j.fontMap,k);m.setTexture(this.uniforms.fontMap.value,k);o.uniform1fv(j.quad,this.uniforms.quad.value);o.uniform2f(j.invSize,this.uniforms.invSize.value.x,this.uniforms.invSize.value.y);o.uniform1f(j.screenRatio,this.uniforms.screenRatio.value)};var g=a.extend({init:function(j){this.lineHeight=1;this.nbChars=0;this.textArray={};this.primitivePicking=true;this.billboard=false;this.billboardAxis=false;this.fixedSize=false;this.viewSpace=false;this.projectionSpace=false;this.textMaterial=null;this._initMaterial();this._setFont();var k=new c.Mesh();this._token=0;this.mesh3js=null;this._parent(k,j);this.mesh3js=this._occurrences[0].renderable;this._reallocate(512);this.setFrustumCulled(true);return this},clone:function(){var j=new c.Mesh(this.mesh3js.geometry,this.mesh3js.material);return new g(j,this.name)},getNodeType:function(){return"Mesh3D"},setPrimitivePicking:function(j){this.primitivePicking=j},setBillboard:function(j,k){if((this.billboard===j)&&(this.billboardAxis===k)){return}this.billboard=j;this.billboardAxis=k;this._updateDefines()},setFixedSize:function(j){if(this.fixedSize===j){return}this.fixedSize=j;if(j){this.billboard=true}this._updateDefines()},_setViewSpace:function(j){if(this.viewSpace===j){return}this.viewSpace=j;this.projectionSpace=!j;this._updateDefines()},_setProjectionSpace:function(j){if(this.projectionSpace===j){return}this.projectionSpace=j;this.viewSpace=!j;this._updateDefines()},_updateDefines:function(){this.textMaterial.defines={USE_BILLBOARD:this.billboard,USE_AXIS:this.billboardAxis,USE_FIXEDSIZE:this.fixedSize,USE_VIEWSPACE:this.viewSpace,USE_PROJSPACE:this.projectionSpace};this.textMaterial.updateDeferredMaterials();this.textMaterial.needsUpdate=true},getBillboard:function(){return this.billboard},addText:function(n){var m=n.string.length;var j=this._addText(n);if(j){n.primitive=j;this.textArray[j.cgmId]=n;this.nbChars+=m;return j.cgmId}var k=this._reallocate(m);var l=this._occurrences[0].renderable;j=this._addText(n,(k!==null)?l.layer.layers[k]:null,k);if(j){n.primitive=j;this.textArray[j.cgmId]=n;this.nbChars+=m;return j.cgmId}return -1},removeText:function(j){var k=this.textArray[j];if(k){this.hide([d.getFromSGNode(k.primitive)]);this.nbChars-=k.string.length;delete (this.textArray[j])}},_setFont:function(){var j=f.getWebappsAssetUrl("Visualization","");this.fontTexture=new c.ImageUtils.loadTexture(j+"fonts/default.png",undefined,null,null,true);this.fontTexture.flipY=true;this.fontTexture.anisotropy=16;if(this.textMaterial){this.textMaterial.uniforms.fontMap.value=this.fontTexture}},_reallocate:function(s){function t(k){var j=Math.log(k)/Math.LN2;return Math.pow(2,Math.ceil(j))}var C=this._occurrences[0].renderable;var L=4*s;var K=C.geometry.length;var u=K?C.geometry[K-1]:null;var r=u?u.vertexPositionArray.length/3:0;var B=!K||(r===65536);var m=B?t(L):t(r+L);var D=new c.BufferGeometryDS();D.editable=true;D.vertexIndexArray=new Uint16Array(6*m/4);D.vertexPositionArray=new Float32Array(3*m);D.vertexColorArray=new Float32Array(4*m);D.vertexNormalArray=new Float32Array(3*m);D.vertexUvArray=new Float32Array(3*m);D.vertexUv2Array=new Float32Array(3*m);D.vertexTangentArray=new Float32Array(3*m);D.vertexBinormalArray=new Float32Array(3*m);for(var H=0;H<3*m;H+=3){D.vertexPositionArray[H]=NaN}var y=null;if(B){var q=new e.SGPrimitive({cgmId:this._token,rep:null,start:0,count:6*m/4});this._token++;var J=new e.DrawingGroup(this.textMaterial,this.textMaterial,4,0,6*m/4,[q]);J.geometry=D;D.drawingGroups.push(J);q.group=J;for(var F=0;F<this._occurrences.length;F++){var o=this._occurrences[F].renderable;o.geometry.push(D);D.addRefVBO(o);o._initLayersForGeometry(0,D);var w=o.layer.getIntervals(D,null,true);y=w.length?o.layer.layers.indexOf(w[0]):-1}}else{for(var H=0;H<4*r;H++){D.vertexColorArray[H]=u.vertexColorArray[H];if(H<3*r){D.vertexPositionArray[H]=u.vertexPositionArray[H];D.vertexNormalArray[H]=u.vertexNormalArray[H];D.vertexUvArray[H]=u.vertexUvArray[H];D.vertexUv2Array[H]=u.vertexUv2Array[H];D.vertexTangentArray[H]=u.vertexTangentArray[H];D.vertexBinormalArray[H]=u.vertexBinormalArray[H]}}for(var H=0;H<6*r/4;H++){D.vertexIndexArray[H]=u.vertexIndexArray[H]}var l=u.drawingGroups[0].primitives.slice();var G=l[l.length-1];var n=G.start+G.count;var p=6*m/4-n;var A=new e.SGPrimitive({cgmId:this._token,rep:null,start:n,count:p});l.push(A);this._token++;var J=new e.DrawingGroup(this.textMaterial,this.textMaterial,4,0,6*m/4,l);J.geometry=D;D.drawingGroups.push(J);for(var F=0;F<l.length;F++){l[F].group=J}for(var F=0;F<this._occurrences.length;F++){var o=this._occurrences[F].renderable;var w=o.layer.getIntervals(o.geometry[K-1],null,true);for(var E=0;E<w.length;E++){w[E].geometry=D;w[E].drawableGroup=D.drawingGroups[0]}var x=w[w.length-1];var z=o.layer.layers.indexOf(x);if(!x.drawableInterval.layerNum){x.drawableInterval.count+=p;x.drawableInterval.primitiveCount++;y=z}else{var v=new c.DrawableInterval(0,n,p);v.primitiveStart=l.length-1;v.primitiveCount=1;var I=new c.LayerInterval(D,D.drawingGroups[0],v);o.layer.layers.splice(z+1,0,I);y=z+1}D.addRefVBO(o);o.geometry[K-1].releaseVBO(o);o.geometry.splice(K-1,1);o.geometry.push(D)}}return y},_initMaterial:function(){var j=c.UniformsUtils.mergeNoClone([{fontMap:{type:"t",value:null},quad:{type:"fv1",value:[-0.5,-0.5,0.5,-0.5,0.5,0.5,-0.5,0.5]},invSize:{type:"v2",value:new c.Vector2(512,512)},screenRatio:{type:"f",value:1},opacity:{type:"f",value:1}},c.UniformsUtils.clone(c.UniformsLib.clipPlanes)]);this.textMaterial=new c.ShaderMaterialDS({force:true,side:c.FrontSide,transparent:true,uniforms:j,vertexColors:c.VertexColors,vertexShaderPars:["varying vec4 vColor; varying vec2 vUv; uniform float quad[8]; uniform vec2 invSize; uniform float screenRatio;",c.ShaderChunk.clip_pars_vertex].join("\n"),vertexShaderBody:["vec3 corner = vec3(quad[2*int(color.w)], quad[2*int(color.w) + 1], 0.0);","#ifdef USE_BILLBOARD","#ifdef USE_FIXEDSIZE","#ifdef USE_VIEWSPACE","vec4 mvPosition = (modelMatrix * vec4(position.xyz, 1.0));","#elif defined(USE_PROJSPACE)","vec4 projPosition = vec4(position.xy, 0.0, 1.0);","#else",c._DefaultShaderChunk.model_view_transformation_vertex,"#endif","#ifdef USE_AXIS","#ifdef USE_VIEWSPACE","vec4 mvPosition2 = (modelMatrix * vec4(position.xyz + binormal, 1.0));","#elif defined(USE_PROJSPACE)","vec4 projPosition2 = vec4(binormal.xy, 0.0, 1.0);","#else",c._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPosition2","vec4(position.xyz + binormal, 1.0)"),"#endif","#endif","#else",c._DefaultShaderChunk.getModelViewTransformationChunk("vec4 _mvPos","vec4(position.xyz, 1.0)"),"vec4 mvPosition = _mvPos + vec4(normal, 0.0) + vec4(corner * vec3(uv2, 1.0), 0.0);","#endif","#else","vec3 newPosition = position + mat3(binormal, tangent, vec3(0.0, 0.0, 1.0)) * (normal + corner * vec3(uv2, 1.0));",c._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPosition","vec4(newPosition, 1.0)"),"#endif","vec3 mvNormal;","#ifdef USE_PROJSPACE","gl_Position = projPosition;","#else","gl_Position = projectionMatrix * mvPosition;","#endif","#ifdef USE_FIXEDSIZE","#ifdef USE_AXIS","#ifdef USE_PROJSPACE","vec2 toPixels = 0.5 / invSize;","vec2 projPt1 = toPixels * projPosition.xy;","vec2 projPt2 = toPixels * projPosition2.xy;","#else","vec4 glPosition2 = projectionMatrix * mvPosition2;","vec2 toPixels1 = 0.5 / (invSize * gl_Position.w);","vec2 toPixels2 = 0.5 / (invSize * glPosition2.w);","vec2 projPt1 = toPixels1 * gl_Position.xy;","vec2 projPt2 = toPixels2 * glPosition2.xy;","#endif","vec2 rightVecPx = normalize(projPt2.xy - projPt1.xy);","vec2 upVecPx = vec2(-rightVecPx.y, rightVecPx.x);","vec2 offsetVec = (normal.xy + corner.xy * uv2);","offsetVec = offsetVec.x * rightVecPx + offsetVec.y * upVecPx;","#ifdef USE_PROJSPACE","gl_Position.xy += 2.0 * invSize * offsetVec;","#else","gl_Position.xy += 2.0 * invSize * offsetVec * gl_Position.w;","#endif","#else","gl_Position.xy += 2.0 * invSize * (normal.xy + corner.xy * uv2) * gl_Position.w;","#endif","#endif","vColor = vec4(color.rgb, 1.0);","vUv = uv;","#ifdef USE_CLIPPINGPLANES","vec4 _mvPos;","if(nbClipPlanes > 0) {","for( int i = 0; i < MAX_CLIP_PLANES; i++ ) {",c._DefaultShaderChunk.getModelViewTransformationChunk("_mvPos","vec4(position.xyz, 1.0)"),"clipDist[ i ] = dot( _mvPos.xyz, clipPlaneEquations[ i ].xyz ) + clipPlaneEquations[ i ].w;","}","}","#endif"].join("\n"),fragmentShaderPars:["varying vec4 vColor; varying vec2 vUv; uniform sampler2D fontMap;","uniform float opacity;",c.ShaderChunk.clip_pars_fragment].join("\n"),fragmentShaderBody:[c.ShaderChunk.clip_fragment,"float epsilon = 0.1;","float alphaTest = 0.01;","vec4 texture = texture2D(fontMap, vUv);","#ifdef GL_OES_standard_derivatives","    float w = clamp(200.0 * epsilon * (abs(dFdx(vUv.x)) + abs(dFdy(vUv.y))), 0.0, 0.5);","#else","    float w = epsilon;","#endif","float alpha = smoothstep(0.5 - w, 0.5 + w, texture.r);","alpha = pow(alpha, 1.0/2.2);","if (alpha < alphaTest) discard;","gl_FragColor = vec4(vColor.xyz, alpha * opacity);"].join("\n")});this.textMaterial.enableClipPlanes=true;this.textMaterial.loadUniforms=b},_addText:function(n,o,l){var j=n.string.length;var k=this._occurrences[0].renderable;if(!o){for(var m=0;m<k.layer.layers.length;m++){var p=k.layer.layers[m];var q=p.drawableInterval;if(!q.layerNum&&(q.count>=6*j)){o=p;l=m;break}}}if(o){var r=this._updatePrimitives(o,l,j);this._updateBuffers(r,n);return r}return null},_updateBuffers:function(x,P){var R=new c.Box2();var n=x.group.geometry;var q=x.start/6;var N=x.start;var o=4*q;var l=P;var y=l.string.length;var t=this.getBuffer(e.VertexComponentEnum.POSITION,n);var Z=this.getBuffer(e.VertexComponentEnum.NORMAL,n);var v=this.getBuffer(e.VertexComponentEnum.DIFFUSE_COLOR,n);var m=this.getBuffer(e.VertexComponentEnum.TEX_COORD_0,n);var F=this.getBuffer(e.VertexComponentEnum.TEX_COORD_1,n);var z=this.getBuffer(e.VertexComponentEnum.TEX_COORD_2,n);var B=this.getBuffer(e.VertexComponentEnum.TEX_COORD_3,n);var A=this.getIndexBuffer(n);var M=l.size/h.base;var aa=l.lineLength?l.lineLength:0;var U=0;var O=new c.Vector3();var G=N;var T=o;var s=3*o;var J=4*o;var E=3*o;var r=3*o;var C=3*o;var H=3*o;var D=3*o;var X=0;var k=0;for(var W=0;W<y;W++){var u=l.string[W];if(u==="\n"){O.x=0;O.y-=M*this.lineHeight*h.base;U=0}else{if(aa&&u===" "){if(U>aa){O.x=0;O.y-=M*this.lineHeight*h.base;U=0;continue}}u=h.chars[u.charCodeAt(0)];if(!u){continue}k++;A[G++]=T;A[G++]=T+1;A[G++]=T+2;A[G++]=T;A[G++]=T+2;A[G++]=T+3;T+=4;m[C++]=u.x/h.width;m[C++]=(h.height-(u.y+u.height))/h.height;m[C++]=0;m[C++]=(u.x+u.width)/h.width;m[C++]=(h.height-(u.y+u.height))/h.height;m[C++]=0;m[C++]=(u.x+u.width)/h.width;m[C++]=(h.height-u.y)/h.height;m[C++]=0;m[C++]=u.x/h.width;m[C++]=(h.height-u.y)/h.height;m[C++]=0;var L=O.x+M*(0.5*u.width+u.xoffset);var K=O.y+M*(u.yoffset-0.5*u.height);var I=O.z;O.x+=M*u.xadvance;U+=M*u.xadvance;if(R){if(L-0.5*M*u.width<R.min.x){R.min.x=L-0.5*M*u.width}if(L+0.5*M*u.width>R.max.x){R.max.x=L+0.5*M*u.width}if(K-0.5*M*u.height<R.min.y){R.min.y=K-0.5*M*u.height}if(K+0.5*M*u.height>R.max.y){R.max.y=K+0.5*M*u.height}}for(var V=0;V<4;V++){v[J++]=l.color.r;v[J++]=l.color.g;v[J++]=l.color.b;v[J++]=V;Z[s++]=L;Z[s++]=K;Z[s++]=0;t[E++]=l.anchor.x;t[E++]=l.anchor.y;t[E++]=l.anchor.z;F[r++]=M*u.width;F[r++]=M*u.height;F[r++]=0;z[H++]=l.up.x;z[H++]=l.up.y;z[H++]=l.up.z;B[D++]=l.right.x;B[D++]=l.right.y;B[D++]=l.right.z}}}for(var W=0;W<6*(y-k);W++){A[G++]=0}this.updateBuffer(e.VertexComponentEnum.POSITION,o,4*y,n);this.updateBuffer(e.VertexComponentEnum.NORMAL,o,4*y,n);this.updateBuffer(e.VertexComponentEnum.DIFFUSE_COLOR,o,4*y,n);this.updateBuffer(e.VertexComponentEnum.TEX_COORD_0,o,4*y,n);this.updateBuffer(e.VertexComponentEnum.TEX_COORD_1,o,4*y,n);this.updateBuffer(e.VertexComponentEnum.TEX_COORD_2,o,4*y,n);this.updateBuffer(e.VertexComponentEnum.TEX_COORD_3,o,4*y,n);this.updateIndexBuffer(N,6*y,n);var Y=new c.Vector3(R.min.x,R.min.y,-0.5);var w=new c.Vector3(R.max.x,R.max.y,0.5);var S=this.getBoundingBox();var Q=new c.Box3(Y,w);this.forceBoundingBox(S.union(Q));if(!P.labelExtent){P.labelExtent=R}},getTextExtent:function(r){var q=new c.Box2();r.labelExtent=q;var l=r;var u=l.string.length;var s=l.size/h.base;var t=l.lineLength?l.lineLength:0;var m=0;var o=new c.Vector2();for(var p=0;p<u;p++){var n=l.string[p];if(n==="\n"){o.x=0;o.y-=s*this.lineHeight*h.base;m=0}else{if(t&&n===" "){if(m>t){o.x=0;o.y-=s*this.lineHeight*h.base;m=0;continue}}n=h.chars[n.charCodeAt(0)];if(!n){continue}var k=o.x+s*(0.5*n.width+n.xoffset);var j=o.y+s*(n.yoffset-0.5*n.height);o.x+=s*n.xadvance;m+=s*n.xadvance;if(k-0.5*s*n.width<q.min.x){q.min.x=k-0.5*s*n.width}if(k+0.5*s*n.width>q.max.x){q.max.x=k+0.5*s*n.width}if(j-0.5*s*n.height<q.min.y){q.min.y=j-0.5*s*n.height}if(j+0.5*s*n.height>q.max.y){q.max.y=j+0.5*s*n.height}}}return q},_updatePrimitives:function(q,l,A){this._mergePrimitives(q,l);var u=q.geometry;var z=u.drawingGroups[0].primitives;var t=q.drawableInterval;var r=z[t.primitiveStart];var v=r.count;r.count=6*A;var y=v-r.count;if(y>0){var x=new e.SGPrimitive({cgmId:this._token,rep:null,group:r.group,start:r.start+r.count,count:y});this._token++;z.splice(t.primitiveStart+1,0,x)}for(var o=0;o<this._occurrences.length;o++){var B=this._occurrences[o].renderable;var p=B.layer.layers[l];var m=l?B.layer.layers[l-1]:null;var s=m&&(m.geometry===p.geometry);if(m&&s&&m.drawableInterval.layerNum===1){m.drawableInterval.count+=r.count;m.drawableInterval.primitiveCount++;if(y>0){p.drawableInterval.start=r.start+r.count;p.drawableInterval.count=y;p.drawableInterval.primitiveStart++}else{B.layer.layers.splice(l,1)}}else{p.drawableInterval.count=6*A;p.drawableInterval.layerNum=1;if(y>0){var w=p.clone();w.drawableInterval.layerNum=0;w.drawableInterval.start=r.start+r.count;w.drawableInterval.count=y;B.layer.layers.splice(l+1,0,w)}}if(y>0){for(var n=l+1;n<B.layer.layers.length;n++){if(B.layer.layers[n].geometry!==u){break}B.layer.layers[n].drawableInterval.primitiveStart++}}}return r},_mergePrimitives:function(p,m){var r=p.geometry;var t=r.drawingGroups[0].primitives;var q=p.drawableInterval;if(q.primitiveCount<=1){return}var s=t[q.primitiveStart];var l=t[q.primitiveStart+q.primitiveCount-1];s.count=l.start+l.count-s.start;t.splice(q.primitiveStart+1,q.primitiveCount-1);for(var o=0;o<this._occurrences.length;o++){var u=this._occurrences[o].renderable;for(var n=m+1;n<u.layer.layers.length;n++){if(u.layer.layers[n].geometry!==r){break}u.layer.layers[n].drawableInterval.primitiveStart-=q.primitiveCount-1}}q.primitiveCount=1},});return UWA.namespace("THREEDS/Nodes/TextNode",g)});define("DS/Visualization/PlaneGrid",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/TextNode"],function(c,h,n,m,a){var f=new n.Color().setRGB(1,1,1);var p=new n.Vector3(0,0,1);var k=new n.Vector3(0,0,-1);var j=new n.Vector3(1,0,0);var q=new n.Vector3(0,1,0);var g=new n.Vector3(-1,0,0);var r=new n.Vector3(0,-1,0);var d=new n.Vector3();var l=new n.Vector2();var o=new n.Vector2();var e=function(s,t,u){if(typeof u==="undefined"||+u===0){return Math[s](t)}t=+t;u=+u;if(isNaN(t)||!(typeof u==="number"&&u%1===0)){return NaN}t=t.toString().split("e");t=Math[s](+(t[0]+"e"+(t[1]?(+t[1]-u):-u)));t=t.toString().split("e");return +(t[0]+"e"+(t[1]?(+t[1]+u):u))};if(!Math.round10){Math.round10=function(s,t){return e("round",s,t)}}var b=c.extend({init:function(s){this.viewer=s;this.position=new n.Vector3();this.size=100;this.displayLabels=false;this.gridLabels=null;this.labelColor=f;this.labelCB=null;this.displayLabelCB=null;this.labels={rightNS:[],rightWE:[],bottomNS:[],bottomWE:[],all:[]};this.displayGrid=s.displayGrid;this.displayGridFromBelow=s.displayGridFromBelow;this.gridScreenSize=50;this.gridNbSteps=s.gridNbSteps;this.gridUnit=1;this.gridOffset=new n.Vector2();this.gridCoeff=0;this.gridFalloff=0;this.gridColor=s.gridColor;this.displayPlane=1;this.planeFalloff=0;this.planeColor=s.planeColor;this.planeOpacity=1;this.planeTexture=null;this.planeTextureScale=1;this.planeBorder=false;this.edgeColor=new n.Color();this.mesh=null;this.matrix=new n.Matrix4();this.material=null;this.gridTextures={};this.viewProjMatrix=new n.Matrix4();this.tmpFrustum=new n.Frustum();this.tmpPoly1=new n.CGPolygon();this.tmpPoly2=new n.CGPolygon();this.tmpLine=new n.Line3(new n.Vector3(),new n.Vector3())},setGridNbSteps:function(s){this.gridNbSteps=s;this.setGridTextures()},setLabels:function(s){if(s===this.displayLabels){return}this.displayLabels=s;if(s&&!this.gridLabels){this.gridLabels=new a("gridLabels");this.gridLabels.setBillboard(true,true);this.gridLabels.setFixedSize(true);this.gridLabels._setProjectionSpace(true);var t=this.gridLabels._occurrences[0].renderable;t.renderDepth=0;t.receiveShadow=false;this.viewer.sceneBackground.add(t)}if(this.gridLabels){this.gridLabels.setVisibility(s);this.gridLabels.setVisibilityFree(s)}},setLabelColor:function(s){this.labelColor=new n.Color();this.labelColor.set(s)},setLabelCallback:function(s){this.labelCB=s},setDisplayLabelCallback:function(s){this.displayLabelCB=s},getUnitGridTexture:function(t){if(this.gridTextures[t]){return this.gridTextures[t]}var v=new Uint8Array(t*t);for(var s=0;s<t;++s){v[s]=255;v[t*(t-1)+s]=255;v[t*s]=255;v[(t*s)+t-1]=255}var u=new n.DataTexture(v,t,t,n.AlphaFormat,n.UnsignedByteType,new n.UVMapping(),n.RepeatWrapping,n.RepeatWrapping,n.LinearFilter,n.LinearMipMapLinearFilter,16);u.needsUpdate=true;this.gridTextures[t]=u;return u},setGridTextures:function(){if(!this.material){return}var y=function(A){var z=Math.log(A)/Math.LN2;return Math.pow(2,Math.round(z))};var w=64;var x=2;var t=this.gridNbSteps/x;var v=y(w*t);var u=y(w*t*t);var s=Math.min(y(w*t*t*t),4096);this.material.uniforms.gridTexture.value=this.getUnitGridTexture(w);this.material.uniforms.gridTexture2.value=this.getUnitGridTexture(v);this.material.uniforms.gridTexture3.value=this.getUnitGridTexture(u);this.material.uniforms.gridTexture4.value=this.getUnitGridTexture(s)},createPlaneGrid:function(u,z,x,y){this.size=u;this.position=z;this.computeGridUnit(x.camera,Math.abs(x.camera.position.z-this.position.z));var v=this.gridNbSteps*this.gridUnit;this.gridOffset.x=y?(z.x-v*Math.floor(z.x/v)):0;this.gridOffset.y=y?(z.y-v*Math.floor(z.y/v)):0;if(!this.mesh){var w=n.InfinitePlaneShader;var A={defines:{PLANE_V2:true},fragmentShader:w.fragmentShader,vertexShader:w.vertexShader,uniforms:n.UniformsUtils.clone(w.uniforms)};var t=new n.ShaderMaterial(A);this.material=t;t.lights=true;t.useBlending=true;t.depthTest=false;t.depthWrite=false;t.side=n.DoubleSide;t.uniforms.ambient.value.copyGammaToLinear(new n.Color(328965));t.force=true;this.setGridTextures();var s=m.createRectangleNode({width:1,height:1,fill:true,noEdge:true,material:t});s.setVisibilityFree(true);this.mesh=s._occurrences[0].renderable;this.mesh.frustumCulled=false;this.mesh.receiveShadow=false;this.mesh.renderDepth=1;this.viewer.sceneBackground.add(this.mesh);this.mesh.pickable=false}this.mesh.visible=true;this.mesh.position.set(z.x-0.5*u,z.y-0.5*u,z.z);this.mesh.scale.set(u,u,1);this.mesh.updateMatrix();this.material.uniforms.displayPlane.value=this.displayPlane;this.material.uniforms.displayGrid.value=this.displayGrid;this.material.uniforms.gridFromBelow.value=this.displayGridFromBelow;this.material.uniforms.diffuse.value.copyGammaToLinear(this.planeColor);this.material.uniforms.planeOpacity.value=this.planeOpacity;if((this.material.map&&!this.planeTexture)||(!this.material.map&&this.planeTexture)){this.material.needsUpdate=true}this.material.map=this.planeTexture;this.material.uniforms.map.value=this.planeTexture;this.material.uniforms.uvScale.value=this.planeTextureScale;this.material.uniforms.border.value.copyGammaToLinear(this.edgeColor);this.material.uniforms.attenuation.value=this.viewer.planeAttenuation?1:0;this.material.uniforms.planeBorder.value=this.planeBorder?1:0;this.material.uniforms.planeFalloff.value=this.planeFalloff;this.material.uniforms.gridFalloff.value=this.gridFalloff;this.material.uniforms.gridUnit.value=this.gridUnit;this.material.uniforms.gridOffset.value.copy(this.gridOffset);this.material.uniforms.gridCoeff.value=this.gridCoeff;this.material.uniforms.gridColor.value.copyGammaToLinear(this.gridColor);this.material.uniforms.planeSize.value=u;this.material.uniforms.nbSteps.value=this.gridNbSteps},computeGridUnit:function(t,w){var s=1;if(t instanceof n.PerspectiveCamera){s=2*this.gridScreenSize*Math.tan(Math.PI*t.fov/360)*w/this.viewer.div.clientHeight}else{if(t instanceof n.OrthographicCamera){s=this.gridScreenSize*(t.top-t.bottom)/this.viewer.div.clientHeight}}var v=1/(this.gridNbSteps*this.gridNbSteps);var u=0;while(v<s){if(this.gridNbSteps===1){v++}else{v*=this.gridNbSteps}u++}this.gridUnit=v;if(this.gridNbSteps===1){this.gridCoeff=(s-v-1)}else{this.gridCoeff=(s-v/this.gridNbSteps)/(v-v/this.gridNbSteps)}},updateLabels:function(s){if(!this.displayLabels){return}this.cleanLabels();this.computeLabelPositions(s.camera);this.displayLabelsFunc();this.gridLabels&&this.gridLabels.textMaterial.uniforms.invSize.value.set(1/this.viewer.renderer.deviceWidth,1/this.viewer.renderer.deviceHeight);if(this.gridLabels){this.gridLabels.textMaterial.uniforms.screenRatio.value=this.viewer.renderer.deviceWidth/this.viewer.renderer.deviceHeight}},addLabel:function(z,y,B,D,C,E,A){var w=(E==="x")?j:q;var s={string:z,anchor:y,color:this.labelColor,size:20*window.devicePixelRatio,lineLength:500,up:p,right:w,isRight:false};var G=this.gridLabels.getTextExtent(s);var u=Math.abs(G.max.x-G.min.x);var t=Math.abs(G.max.y-G.min.y);G.min.x=-t;G.min.y=-t;G.max.x=t;G.max.y=t;G.translate(B);d.addVectors(y,w);var x=this.viewer.currentViewpoint.project(d,A);l.set(x.x-B.x,x.y-B.y);l.normalize();if(l.x<0){s.right=(E==="x")?g:r}var F=false;if(C){F=true;if(l.x>0){l.negate()}}else{if(((l.x<0)&&(l.y<0))||((l.x>0)&&(l.y>0))){F=true}if((l.x>0)&&(l.y>0)){l.negate()}}if(F){l.multiplyScalar(u);B.x+=l.x;B.y+=l.y}s.anchor=this.viewer.currentViewpoint.unProject(B,A);s.right=new n.Vector3().addVectors(s.anchor,s.right);s.anchor.applyProjection(this.viewProjMatrix);s.right.applyProjection(this.viewProjMatrix);l.set(s.right.x-s.anchor.x,s.right.y-s.anchor.y);l.normalize();s.right.copy(s.anchor);s.right.x+=l.x;s.right.y+=l.y;if(!this.displayLabelCB){for(var v=0;v<D.length;v++){if(G.isIntersectionBox(D[v]._text.labelExtent)){return}}}var H={token:null,_text:s,isRight:C,display:true};D.push(H);this.labels.all.push(H)},isBottomRightEdge:function(s){var t=2;if(s.x<t){return false}if(s.y<t){return false}return true},isRightEdgeFunc:function(s){var t=2;return(s.x>this.viewer.SCREEN_WIDTH-t)},isInsideFrustum:function(s){if(s.x<-1||s.x>this.viewer.SCREEN_WIDTH+1){return false}if(s.y<-1||s.y>this.viewer.SCREEN_HEIGHT+1){return false}if(s.z<-1.001||s.z>1.001){return false}return true},cleanLabels:function(){for(var s=0;s<this.labels.all.length;s++){(this.labels.all[s].token!==null)&&this.gridLabels.removeText(this.labels.all[s].token)}this.labels={rightNS:[],rightWE:[],bottomNS:[],bottomWE:[],all:[]}},displayLabelsFunc:function(){this.displayLabelCB&&this.displayLabelCB(this.labels.all);for(var u=0;u<this.labels.all.length;u++){var v=this.labels.all[u];if(!v.display){continue}if(v.offset||v.offsetFromScreenEdge||v.offsetFromAxis){var s=v.offset?v.offset.x:0;var w=v.offset?v.offset.y:0;l.set(0.5*this.viewer.SCREEN_WIDTH*(v._text.right.x-v._text.anchor.x),0.5*this.viewer.SCREEN_HEIGHT*(v._text.right.y-v._text.anchor.y));l.normalize();o.set(-l.y,l.x);if(v.isRight||(l.y<0)){l.negate()}if(!v.isRight&&(l.y<0)){o.negate()}o.multiplyScalar(v.offsetFromAxis||0);l.multiplyScalar(v.offsetFromScreenEdge||0);v._text.anchor.x+=2*(s+o.x+l.x)/this.viewer.SCREEN_WIDTH;v._text.anchor.y+=2*(w+o.y+l.y)/this.viewer.SCREEN_HEIGHT;v._text.right.x+=2*(s+o.x+l.x)/this.viewer.SCREEN_WIDTH;v._text.right.y+=2*(w+o.y+l.y)/this.viewer.SCREEN_HEIGHT}if(v.size){v._text.size=v.size*window.devicePixelRatio}if(v.color){v._text.color=v.color}var t=this.gridLabels.addText(v._text);v.token=t}},computeIntersectionsForLabels:function(L,C,F,D,u,H,N){var t="y";var B=this.labels.rightWE;var A=this.labels.bottomWE;var x="E";var I="W";if(L==="y"){t="x";B=this.labels.rightWE;A=this.labels.bottomWE;x="N";I="S"}var G=Math.round((C.min[L]-this.position[L])/this.gridUnit);var O=Math.round((C.max[L]-this.position[L])/this.gridUnit);if(F<0){O=Math.min(G+1000,O)}else{G=Math.max(O-1000,G)}var E=this.tmpLine;for(var M=G;M<=O;M++){E.start[L]=M*this.gridUnit+this.position[L];E.start[t]=-0.5*this.size+this.position[t];E.start.z=this.position.z;E.end[L]=E.start[L];E.end[t]=0.5*this.size+this.position[t];E.end.z=this.position.z;var w=D.planes[u];var J=w.intersectLine(E);var y=J&&H.project(J,N);var v=!!J&&this.isInsideFrustum(y)&&this.isBottomRightEdge(y);var z=v&&this.isRightEdgeFunc(y);if(v){var K=(M*this.gridUnit)+this.position[L];var P=Math.round10(K,-2);var s=(P>=0);var Q;if(this.labelCB){Q=this.labelCB(K,(s?x:I))}else{Q=Math.abs(P)+" "+(s?x:I)}this.addLabel(Q,J,y,z?B:A,z,t,N)}}},computeLabelPositions:function(){var w=this.viewer.currentViewpoint;var z=this.viewer.cameraBackground;this.viewProjMatrix.multiplyMatrices(z.projectionMatrix,z.matrixWorldInverse);var G=this.tmpFrustum;G.setFromMatrix(this.viewProjMatrix);var H=G.getCorners();var A=this.tmpPoly1;A.addPoints([new n.Vector3().copy(H[0]),new n.Vector3().copy(H[1]),new n.Vector3().copy(H[5]),new n.Vector3().copy(H[4]),]);var E=this.tmpPoly2;E.addPoints([new n.Vector3().copy(H[1]),new n.Vector3().copy(H[2]),new n.Vector3().copy(H[6]),new n.Vector3().copy(H[5]),]);var x=new n.Plane();x.setFromNormalAndCoplanarPoint(k,this.position);var B=A.clipByPlane(x,new n.CGPolygon());var I=E.clipByPlane(x,new n.CGPolygon());var F=new n.Vector2();var t=new n.Vector2();var D,C,u,s;var v=null;var y=null;if(B.corner.length===2){F.subVectors(B.corner[1],B.corner[0]);F.normalize();D=F.dot(j);C=F.dot(q);v=new n.Box3().setFromPoints([B.corner[0],B.corner[1]])}if(I.corner.length===2){t.subVectors(I.corner[1],I.corner[0]);t.normalize();u=t.dot(j);s=t.dot(q);y=new n.Box3().setFromPoints([I.corner[0],I.corner[1]])}if(Math.abs(D)>0.707){v&&this.computeIntersectionsForLabels("x",v,D,G,2,w,z);y&&this.computeIntersectionsForLabels("y",y,s,G,0,w,z)}else{v&&this.computeIntersectionsForLabels("y",v,C,G,2,w,z);y&&this.computeIntersectionsForLabels("x",y,u,G,0,w,z)}this.gridLabels.setFrustumCulled(false)}});return b});define("DS/Visualization/SceneGraphTree",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/SceneGraph","DS/Controls/Tree","DS/Controls/TreeNode","DS/Controls/Tile","DS/CoreEvents/Events"],function(b,c,k,d,h,l,e,a){var f=d.getWebappsAssetUrl("Visualization","icons/");var n=false;var m=function(p){var o=p.node;return !o.productType||(o.productType!=="ReferenceRep"&&o.productType!=="InstanceRep")};var j=function(){if(this.isExpanded()){return}var s,r;var w=this.getChildren().length?this.getNthChild(0):null;var t=this.options.tree.options.viewer;if(w&&(w.options.label==="__dummy__")){this.removeChildren();var C=this.options.pathElement;var p=C.getLastElement();if(p instanceof h){var q=C._getUniqueOccurrence(t);if(!q){return}for(s=0;s<q.children.length;s++){var z=q.children[s];if((!n||(n&&m(z)))&&z.node.getVisibilityInTree()){var v=z.node._occurrences;var y="",s;var x=z.node._iconInTree?z.node._iconInTree:(f+"SWXUiConvertEntitiesHeader.png");if(z.node.isInstance()){for(r=0;r<v.length;r++){if(v[r]===z){break}}y=" (inst_"+r+")"}var u=C.clone();u.addElement(z.node);var A=z.node.name+y;if(A===""){A="-"}var o=new WUX.Controls.TreeNode({backgroundColor:"rgba(255, 255,255,0.5)",label:A,pathElement:u,icons:[x],renderSaver:0});this.addChild(o);if(!z._getVisible()){o.options.UI=UWA.extend(UWA.clone(this.getTree().options.UI,"false"),{label:{filter:"grayscale(100%)",opacity:0.3}})}else{o.options.UI=this.getTree().options.UI}if(z.children.length){var B=new WUX.Controls.TreeNode({label:"__dummy__"});o.addChild(B);o.onPreExpand(j)}}}}}};var g=b.extend({init:function(o,q){var p={viewer:q};this.tree=new WUX.Controls.Tree(p);this.tree.inject(document.body);var s=null;var r=this;this.toUnsubscribe=c.subscribe({event:"/VISU/onSceneGraphUpdate"},function(O){if(!r._sg){return}var I=O.fromNode,x=O.toNode,K,J;var G=[];for(K=0;K<I._occurrences.length;K++){var P=I._occurrences[K];var E=new e();E.setFromOccurrence(P);if(E){G.push(E)}}var v=[];for(K=0;K<G.length;K++){var E=G[K];var F=r.getTreeNode(E);if(F){v.push(F)}}var z=[];for(K=0;K<v.length;K++){var F=v[K];if(!x){if(O.eventType==="CHANGEICON"){F.setIcon({picture:I._iconInTree})}else{if(O.eventType==="CHANGENAME"){F.setLabel(I.name)}else{if((O.eventType==="SHOWTREE")||(O.eventType==="HIDETREE")){r._applyVisibilityToTreeNodes(F,I._occurrences[K])}}}continue}var y=F.getChildren();var w=(y&&y.length)?F.getNthChild(0):null;if(w&&(w.options.label==="__dummy__")){continue}else{if(y){var D=F.getPathElement?F.getPathElement():null;if(!D&&F.options&&F.options.pathElement){D=F.options.pathElement}if((O.eventType==="REMOVE")||(O.eventType==="REMOVETREE")){var C=F.getChildren().length;for(J=0;J<C;J++){var A=F.getNthChild(J);if(!A.getPathElement()){continue}var H=A.getPathElement().getLastElement();if(H===x){z.push({fromNode:F,toNode:A})}}}else{if(((O.eventType==="ADD")||(O.eventType==="ADDTREE"))&&x.getVisibilityInTree()){var u=D.clone();u.addElement(x);var t=x.name;if(t===""){t="-"}var L=x._iconInTree?x._iconInTree:(f+"SWXUiConvertEntitiesHeader.png");var N=new WUX.Controls.TreeNode({backgroundColor:"rgba(255, 255,255,0.5)",label:t,pathElement:u,icons:[L]});F.addChild(N);if(x.children.length){var M=new WUX.Controls.TreeNode({label:"__dummy__"});N.addChild(M);N.onPreExpand(j)}}}}else{var M=new WUX.Controls.TreeNode({label:"__dummy__"});F.addChild(M);F.onPreExpand(j)}}}for(K=0;K<z.length;K++){var B=z[K];B.fromNode.removeChild(B.toNode,false)}});return this},setSceneGraph:function(p){this._sg=null;var o=this.tree.getRoots();var s=null;if(o.length){s=this.tree.getNthRoot(0);s.removeChildren();s.collapse();if(s._updateView){s._updateView(true)}}else{var r=null;if(p instanceof a){r=p._private_root._occurrences[0]}else{r=p._occurrences[0]}var t=new e();t.setFromOccurrence(r);var u=r.node.name;if(u===""){u="-"}this.tree.addRoot({backgroundColor:"rgba(255, 255, 255, 0.498039)",label:u,pathElement:t,icons:[f+"SWXUiCustomizeHeader.png"]});s=this.tree.getNthRoot(0)}var q=new WUX.Controls.TreeNode({label:"__dummy__"});s.addChild(q);s.onPreExpand(j);this._sg=p},getTreeNode:function(p){var o=this.tree.getNthRoot(0);if(!o){return}var q={node:null};this.traverse(o,function(s,t){var r=s.getPathElement?s.getPathElement():null;if(!r&&s.options&&s.options.pathElement){r=s.options.pathElement}if(r){if(r.isEqual(p)){t.node=s;return true}}return false},q);return q.node},traverse:function(r,t,s){var q,p,o=false;o=t(r,s);p=r.getChildren()?r.getChildren().length:0;if(!o){for(q=0;q<p;q++){o=this.traverse(r.getNthChild(q),t,s);if(o){break}}}return o},dispose:function(){c.unsubscribe(this.toUnsubscribe);this.toUnsubscribe=null;this.tree.remove();this._sg=null},_applyVisibilityToTreeNodes:function(q,p){if(!q||!p){return}if(!p._getVisible()){q.options.UI=UWA.extend(UWA.clone(q.getTree().options.UI,"false"),{label:{filter:"grayscale(100%)",opacity:0.3}})}else{q.options.UI=q.getTree().options.UI}for(var o=0;o<p.children.length;o++){this._applyVisibilityToTreeNodes(q.getNthChild(o),p.children[o])}q._updateView(true)}});return UWA.namespace("THREEDS/SceneGraphTree",g)});define("Visualization/SceneGraphTree",["DS/Visualization/SceneGraphTree","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/SceneGraphTree");return b});define("DS/Visualization/Viewpoint",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Animation/ANIM","DS/Animation/PropertyAnimation","DS/Animation/AnimationPath","DS/Visualization/TrackballControls","DS/Visualization/SceneGraph","DS/Visualization/Node3D"],function(b,d,m,e,h,c,g,a,k){var j=new m.Projector();var f=new m.Matrix4();var l=b.extend({init:function(y,o,t,r,p){var s,q,v;var u;if(y.hasOwnProperty("viewer")){this.viewer=y.viewer;this.projectionType=(y.projectionType!==undefined?y.projectionType:l.PERSPECTIVE);s=(y.angle!==undefined)?y.angle:(y.fov!==undefined)?y.fov:45;if(y.fov){console.warn("Deprecated. Use options.angle instead.")}q=(y.near!==undefined)?y.near:10;v=(y.far!==undefined)?y.far:2500;u=(y.defaultController!==undefined)?y.defaultController:true}else{console.warn("Deprecated. You must use a litteral object to define your viewpoint.");this.viewer=y;s=(o!==undefined)?o:45;q=(t!==undefined)?t:10;v=(r!==undefined)?r:2500;this.projectionType=l.PERSPECTIVE;u=(p!==undefined)?p:true}this.divCameraCSSElement=UWA.createElement("div");this.divCameraCSSElement.style.WebkitTransformStyle="preserve-3d";this.divCameraCSSElement.style.MozTransformStyle="preserve-3d";this.divCameraCSSElement.style.oTransformStyle="preserve-3d";this.divCameraCSSElement.style.transformStyle="preserve-3d";this.divCameraCSSElement.id="camera";this.viewer.divCss3DElement.appendChild(this.divCameraCSSElement);this.viewer.divCss3DElement.style.overflow="hidden";this.divCameraCSSElement.style.width=this.viewer.divCss3DElement.style.width;this.divCameraCSSElement.style.height=this.viewer.divCss3DElement.style.height;var n=(this.viewer.canvas.offsetWidth?this.viewer.canvas.offsetWidth:1),x=(this.viewer.canvas.offsetHeight?this.viewer.canvas.offsetHeight:1),w=n/x,u;if(this.projectionType===l.PERSPECTIVE){this.camera=new m.PerspectiveCamera(s,w,q,v)}else{this.camera=new m.OrthographicCamera(0,0,0,0,q,v);this.camera.setVisualizedHeight(null,w,s)}this._renderedCamera=this.camera;this.camera._viewpoint=this;this.robotCameraOrtho=new m.OrthographicCamera(0,0,0,0,q,v);this.camera.clone(this.robotCameraOrtho);this.robotCameraOrtho.setVisualizedHeight(null,w,s);this.robotCameraOrtho._viewpoint=this;this.connectedRobotCamera=this.camera.clone();this.connectedRobotCamera._viewpoint=this;this.target=new m.Vector3();this.position=new m.Vector3();this.sceneGraphRoot=null;this.control=null;this._isMoving=false;this.updateAnimation=function(z){};this._viewpointAnimation=null;this._frustum=new m.Frustum();this.setDefaultController(u);if(!u){this.resetCameraOrientation()}if(this.viewer.internalSceneGraph){this._updateRobotCamera(this.viewer.internalSceneGraph)}this._customReframeCB=null;this._customCenterCameraCB=null;this._2DMode=false;this._focusMode=l._FOCUS_MODE.TRANSLATION;return this},getCamera:function(){return this.camera},getCameraTarget:function(){console.warn("DEPRECATED");return this.target},getCameraPosition:function(){console.warn("DEPRECATED");return this.position},getControl:function(){return this.control},setEyePosition:function(n){var o=n.clone().add(this.getSightDirection().multiplyScalar(this.getTargetDistance()));this.control.setTarget(o);this.control.update()},getEyePosition:function(){return this.camera.position.clone()},setSightDirection:function(q){q.normalize();var o=this.camera.getLookAt();o.normalize();var s=Math.acos(q.clone().dot(o));if(s){var p=q.clone().cross(o);p.normalize();var n=new m.Quaternion().setFromAxisAngle(p,-s);this.control.orientation.multiplyQuaternions(n,this.control.orientation.clone());var r=this.getEyePosition().add(q.clone().multiplyScalar(this.getTargetDistance()));this.control.setTarget(r)}this.control.update()},getSightDirection:function(){return this.camera.getLookAt()},setUpDirection:function(q){q.normalize();var p=this.camera.up.clone();var r=Math.acos(q.dot(p));if(r){var o=q.clone().cross(p);o.normalize();var n=new m.Quaternion().setFromAxisAngle(o,-r);this.control.orientation.multiplyQuaternions(n,this.control.orientation.clone())}this.control.update()},getUpDirection:function(){return this.camera.up.clone()},setAngle:function(n){this.camera.fov=(360+n)%360;this.control.update()},getAngle:function(){return this.camera.fov},setTarget:function(q){var n=this.getEyePosition();var s=q.clone().sub(n).normalize();var r=Math.acos(s.dot(this.getSightDirection()));if(r){var p=(s.clone().cross(this.getSightDirection())).normalize();var o=new m.Quaternion().setFromAxisAngle(p,-r);this.getControl().orientation.multiplyQuaternions(o,this.control.orientation.clone())}this.getControl().setTarget(q);this.getControl().distanceToTarget=q.distanceTo(n);this.control.update()},getTarget:function(){return this.target.clone()},setTargetDistance:function(n){var o=this.getEyePosition().add(this.getSightDirection().multiplyScalar(n));this.control.setTarget(o);this.control.distanceToTarget=n;if(this.projectionType===l.ORTHOGRAPHIC){this.camera.setVisualizedHeight(n)}this.control.update()},getTargetDistance:function(){return this.getControl().distanceToTarget},setProjectionType:function(p){if(p!==this.projectionType){this.projectionType=p;if(!this.cameraOther){var q=this.camera.near;var n=this.camera.far;if(p===l.PERSPECTIVE){this.cameraOther=new m.PerspectiveCamera(this.camera.fov,this.camera.aspect,q,n)}else{this.cameraOther=new m.OrthographicCamera(0,0,0,0,q,n)}this.cameraOther._viewpoint=this}this.cameraOther.position=this.camera.position;this.cameraOther.fov=this.camera.fov;this.cameraOther.aspect=this.camera.aspect;this.cameraOther.pixelCulling=this.camera.pixelCulling;if(this.camera.fullWidth){this.cameraOther.setViewOffsetInternal(this.camera.fullWidth,this.camera.fullHeight,this.camera.x,this.camera.y,this.camera.width,this.camera.height)}var o=this.camera;this.camera=this.cameraOther;this.connectedRobotCamera=this.camera.clone();this.connectedRobotCamera._viewpoint=this;this.cameraOther=o;this.camera.updateMatrix();this.camera.matrixWorld.copy(this.camera.matrix);this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld);this.camera._hasChanged=true;this.control.camera=this.camera;this.control.update();this.viewer.render()}},getProjectionType:function(){return this.projectionType},_setIntraOccularDistance:function(n){},setPixelCulling:function(o,n){this.viewer&&this.viewer.setPixelCulling(o,n)},_setPixelCulling:function(n){this.camera.pixelCulling=n},setDefaultController:function(n,p){var o={SIMPLE:g.Mode.SIMPLE,CATIA:g.Mode.CATIA,COMBINED:g.Mode.COMBINED};if(!n&&(this.control===null)){return}if(n&&(this.control!==null)){if(p!==undefined){this.control.setMode(o[p])}return}if(n){this.control=new g(this,this.viewer.canvas);if(p!==undefined){this.control.setMode(o[p])}this.control.rotateSpeed=1;this.control.lockZRotationSpeed=0.002;this.control.zoomSpeed=5;this.control.panSpeed=1.1}else{if(this.control!==null){this.control.detachEvents()}this.control=null}this.resetCameraOrientation()},setControlActive:function(n){if(this.control!==null){this.control.setActive(n)}},addDivToManipulation:function(n){if(this.control){return this.control.addViewToManipulation(n)}return false},removeDivToManipulation:function(n){if(this.control){return this.control.removeViewFromManipulation(n)}return false},onReframe:function(n){this._customReframeCB=n},onCenterCamera:function(n){this._customCenterCameraCB=n},_setFocusMode:function(n){this._focusMode=n},__rotatedFocusMoveTo:function(q){q.sight=q.sightDirection;q.position=q.eyePosition;var r=true;var u,v,F,w,E,p;w=q.distanceToTarget;if(q.orientation){p=q.orientation;var n=new m.Vector3(0,0,-1);n.applyQuaternion(p);n.normalize();v=n}else{if(q.sight){v=q.sight.clone().normalize();var D=this.camera.getLookAt().clone().normalize();var A=Math.acos(v.dot(D));if(A){var o=(v.clone().cross(D)).normalize();var y=new m.Quaternion().setFromAxisAngle(o,-A);p=new m.Quaternion().multiplyQuaternions(y,this.control.orientation.clone())}else{p=this.control.orientation.clone();v=D}}}F=q.position;E=new m.Vector3().addVectors(F,v.clone().multiplyScalar(w));var C={position:F,target:E,distanceToTarget:w,orientation:p,duration:q.duration||0};if(this._viewpointAnimation){this._viewpointAnimation.stop()}var s={eventChannel:"/VISU/",eventType:"@onViewpointBeginMove_bis",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};if(C.duration===0){d.publish({event:"/VISU/",data:s});var n=new m.Vector3(0,0,-1);n.applyQuaternion(C.orientation);n.normalize();var E=new m.Vector3().addVectors(this.control.position,n.multiplyScalar(C.distanceToTarget));this.control.setTarget(E);this.control.orientation=C.orientation.clone();this.control.distanceToTarget=C.distanceToTarget;this.control.update();var B={eventChannel:"/VISU/",eventType:"@onViewpointEndMove_bis",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};d.publish({event:"/VISU/",data:B})}else{var x=new c({orientation:this.control.orientation.clone(),distanceToTarget:this.control.distanceToTarget},{orientation:C.orientation,distanceToTarget:C.distanceToTarget},C.duration);x.setInterpolator(function(H,I,J){var G={};var K=new m.Quaternion();m.Quaternion.slerp(I.orientation,J.orientation,K,H);G.orientation=K;G.distanceToTarget=I.distanceToTarget+(J.distanceToTarget-I.distanceToTarget)*H;return G});this.updateAnimation=function(G){if(this.control){var H=new m.Vector3(0,0,-1);H.applyQuaternion(G.orientation);H.normalize();var I=new m.Vector3().addVectors(this.control.position,H.multiplyScalar(G.distanceToTarget));this.control.setTarget(I);this.control.orientation=G.orientation.clone();this.control.distanceToTarget=G.distanceToTarget;this.control.update()}};var z=this;var t=function(H){if(H===e.State.STOPPED){var G={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:z,cameraEye:z.camera.position,cameraUp:z.camera.up};d.publish({event:"/VISU/",data:G})}};this._viewpointAnimation=new h(this,"updateAnimation",x,t);this._viewpointAnimation.start();d.publish({event:"/VISU/",data:s})}},moveTo:function(r){if(r.up||r.sight||r.position){console.log("DEPRECATED Naming: options.up => options.upDirection, options.sight => options.sightDirection, options.position => options.eyePosition.")}else{r.up=r.upDirection;r.sight=r.sightDirection;r.position=r.eyePosition}var u,v,G,w,F,q;w=r.distanceToTarget||this.control.distanceToTarget;if(r.orientation){q=r.orientation;var H=new m.Vector3(0,1,0);H.applyQuaternion(q);H.normalize();u=H;var n=new m.Vector3(0,0,-1);n.applyQuaternion(q);n.normalize();v=n}else{if(r.up&&r.sight){u=r.up.clone().normalize();v=r.sight.clone().normalize()}else{if(r.up){u=r.up.clone().normalize();var p=this.camera.up.clone().normalize();var B=Math.acos(u.dot(p));if(B){var o=(u.clone().cross(p)).normalize();var y=new m.Quaternion().setFromAxisAngle(o,-B);v=this.camera.getLookAt().clone().applyQuaternion(y).normalize();q=new m.Quaternion().multiplyQuaternions(y,this.control.orientation.clone())}else{q=this.control.orientation.clone();u=p;v=this.camera.getLookAt().clone().normalize()}}else{if(r.sight){v=r.sight.clone().normalize();var E=this.camera.getLookAt().clone().normalize();var B=Math.acos(v.dot(E));if(B){var o=(v.clone().cross(E)).normalize();var y=new m.Quaternion().setFromAxisAngle(o,-B);u=this.camera.up.clone().applyQuaternion(y).normalize();q=new m.Quaternion().multiplyQuaternions(y,this.control.orientation.clone())}else{q=this.control.orientation.clone();v=E;u=this.camera.up.clone().normalize()}}else{q=this.control.orientation.clone();var H=new m.Vector3(0,1,0);H.applyQuaternion(this.control.orientation);H.normalize();u=H;var n=new m.Vector3(0,0,-1);n.applyQuaternion(this.control.orientation);n.normalize();v=n}}}}if(r.position){G=r.position;F=new m.Vector3().addVectors(G,v.clone().multiplyScalar(w))}else{G=new m.Vector3().subVectors(this.control.target,v.clone().multiplyScalar(w));F=this.control.target.clone()}if(!q){q=new m.Quaternion();var A=new m.Matrix4();A.lookAt(G,F,u);q.setFromRotationMatrix(A)}var D={position:G,target:F,distanceToTarget:w,orientation:q,duration:r.duration||0};if(this._viewpointAnimation){this._viewpointAnimation.stop()}var s={eventChannel:"/VISU/",eventType:"@onViewpointBeginMove_bis",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};if(D.duration===0){d.publish({event:"/VISU/",data:s});this.control.setTarget(D.target);this.control.orientation=D.orientation;this.control.distanceToTarget=D.distanceToTarget;this.control.update();var C={eventChannel:"/VISU/",eventType:"@onViewpointEndMove_bis",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};d.publish({event:"/VISU/",data:C})}else{var x=new c({target:this.control.target.clone(),orientation:this.control.orientation.clone(),distanceToTarget:this.control.distanceToTarget},{target:D.target,orientation:D.orientation,distanceToTarget:D.distanceToTarget},D.duration);x.setInterpolator(function(K,L,M){var J={};var I=L.target.clone();I.lerp(M.target,K);J.target=I;var N=new m.Quaternion();m.Quaternion.slerp(L.orientation,M.orientation,N,K);J.orientation=N;J.distanceToTarget=L.distanceToTarget+(M.distanceToTarget-L.distanceToTarget)*K;return J});this.updateAnimation=function(I){if(this.control){this.control.setTarget(I.target);this.control.orientation=I.orientation.clone();this.control.distanceToTarget=I.distanceToTarget;this.control.update()}};var z=this;var t=function(J){if(J===e.State.STOPPED){var I={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:z,cameraEye:z.camera.position,cameraUp:z.camera.up};d.publish({event:"/VISU/",data:I})}};this._viewpointAnimation=new h(this,"updateAnimation",x,t);this._viewpointAnimation.start();d.publish({event:"/VISU/",data:s})}},onMove:function(n){if(this.control){return this.control.onMove(n)}},unsubscribe:function(n){if(this.control){this.control.unsubscribe(n)}},isMoving:function(){return this._isMoving},resize:function(o,n){if(this.robotCameraOrtho&&this.camera){this.robotCameraOrtho.setVisualizedHeight(null,undefined,this.camera.fov)}if(this.control!==null){this.control._resize(o,n)}},setSceneGraph:function(n){k.DEPRECATED_SceneGraph(new Error());if(n instanceof a){this.sceneGraph=n}},_setNode:function(n){this.sceneGraphRoot=n},_set2DMode:function(n){this._2DMode=n;if(n){this.setSightDirection(new m.Vector3(0,0,-1));this.setUpDirection(new m.Vector3(0,1,0));this.setProjectionType(1);if(this.control){this.control._2DMode=true;this.control.setMouseRotationActive(false);this.control.setTouchRotationActive(false)}}else{this.control._2DMode=false;this.control.setMouseRotationActive(true);this.control.setTouchRotationActive(true)}},resetCameraOrientation:function(){if(this._2DMode){return}var q,o,n,r;q=new m.Vector3(0.35*Math.PI,0,0.75*Math.PI);o=new m.Quaternion();o.setFromEuler(q,"ZXY");n=1.1*100/Math.tan(22.5*Math.PI/180);if(this.sceneGraphRoot!==null){r=this.getBoundingSphere().radius;n=1.1*r/Math.tan(22.5*Math.PI/180)}this.camera.position=new m.Vector3(n,n,n).multiplyScalar(1/Math.sqrt(3));if(this.control===null){this.camera.quaternion=o;this.camera.useQuaternion=true;this.camera.updateMatrix()}else{this.control.orientation=o;var p=new m.Vector3(0,0,-1);p.applyQuaternion(o);p.normalize();this.moveTo({orientation:o,eyePosition:p.clone().multiplyScalar(-n),distanceToTarget:n,duration:0})}},reframe:function(t,p,r,o,q){if(!this.sceneGraphRoot){return}if(this.control===null){return}if(!o&&this.viewer){o=this.viewer.visibleSpace?"visibleSpace":"invisibleSpace"}if(this._customReframeCB){this._customReframeCB(t,p,r,o);return}var s,n,v;n=(p!==undefined)?p:400;if(r||!this._2DMode){if((r!==undefined)&&(r instanceof m.Mesh)){s=r.boundingSphere.clone();s.applyMatrix4(r.matrixWorld)}else{if((r!==undefined)&&(r instanceof m.Sphere)){s=r.clone()}else{s=this.getBoundingSphere(o,q)}}v=this._buildReframeTarget(s,t)}else{v=this._buildReframeTarget2D(o)}if(v){var u=new m.Vector3(0,0,-1);u.applyQuaternion(v.orientation);u.normalize();this.moveTo({orientation:v.orientation,eyePosition:new m.Vector3().addVectors(v.target,u.clone().multiplyScalar(-v.distanceToTarget)),distanceToTarget:v.distanceToTarget,duration:n})}},_buildReframeTarget2D:function(o){var v=null,r,u,t,s;var q=this.getBoundingBox2D(o);if(q.empty()){q.set(new m.Vector2(-100,-100),new m.Vector2(100,100))}r=new m.Vector3((q.min.x+q.max.x)/2,(q.min.y+q.max.y)/2,0);var n=this.camera.aspect;var p=0.5/Math.tan(this.camera.fov*Math.PI/360);t=p*(q.max.x-q.min.x)/n;s=p*(q.max.y-q.min.y);u=Math.max(t,s);return{target:r,orientation:new m.Quaternion(),distanceToTarget:u,}},_buildReframeTarget:function(s,t){var v=null,n,p,u,r,q,o;if(s||boundingBox2D){p=this.target.clone();n=this.control.orientation.clone();u=this.control.distanceToTarget;if(t==null||this._2DMode){u=1.1*s.radius/Math.tan(this.camera.fov*Math.PI/360);p=s.center.clone()}else{if(t==="right"){o=new m.Vector3(0.5*Math.PI,0,Math.PI);n=new m.Quaternion();n.setFromEuler(o,"ZXY")}else{if(t==="left"){o=new m.Vector3(0.5*Math.PI,0,0);n=new m.Quaternion();n.setFromEuler(o,"ZXY")}else{if(t==="top"){o=new m.Vector3(0,0,0.5*Math.PI);n=new m.Quaternion();n.setFromEuler(o,"ZXY")}else{if(t==="bottom"){o=new m.Vector3(Math.PI,0,0.5*Math.PI);n=new m.Quaternion();n.setFromEuler(o,"ZXY")}else{if(t==="front"){o=new m.Vector3(0.5*Math.PI,0,0.5*Math.PI);n=new m.Quaternion();n.setFromEuler(o,"ZXY")}else{if(t==="back"){o=new m.Vector3(0.5*Math.PI,0,-0.5*Math.PI);n=new m.Quaternion();n.setFromEuler(o,"ZXY")}else{if(t==="iso"){o=new m.Vector3(0.35*Math.PI,0,0.75*Math.PI);n=new m.Quaternion();n.setFromEuler(o,"ZXY")}}}}}}}}v={target:p,orientation:n,distanceToTarget:u,}}return v},centerCamera:function(s){if(this.control===null){return}if(this._customCenterCameraCB){this._customCenterCameraCB(s);return}if(s===null){return}var v=s.clone();var p=this.control.orientation.clone();var x=v.distanceTo(this.camera.position);if(this._focusMode===l._FOCUS_MODE.TRANSLATION){var A=new m.Vector3(0,0,-1);A.applyQuaternion(p);A.normalize();var z=this.viewer.ODTMode;var u=new m.Vector3().addVectors(v.clone(),A.clone().multiplyScalar(-x));this.moveTo({eyePosition:u,distanceToTarget:x,duration:z?0:200})}else{if(this._focusMode===l._FOCUS_MODE.ROTATION){var o=new m.Vector3().subVectors(v,this.control.position).normalize();var z=this.viewer.ODTMode;if(this.control.lockZ||m.mobileVersion){var w=this.camera.getLookAt().clone().normalize();var t=null;var r=Math.acos(o.dot(w));if(r){var q=(o.clone().cross(w)).normalize();var y=new m.Quaternion().setFromAxisAngle(q,-r);t=new m.Quaternion().multiplyQuaternions(y,this.control.orientation.clone())}else{t=this.control.orientation.clone();o=w}var n=t.toEuler();n.y=0;t=(new m.Quaternion()).setFromEuler(n,"ZYX");this.__rotatedFocusMoveTo({eyePosition:this.control.position,orientation:t,distanceToTarget:x,duration:z?0:200})}else{this.__rotatedFocusMoveTo({eyePosition:this.control.position,sightDirection:o,distanceToTarget:x,duration:z?0:200})}}}},centerCameraSVG:function(p,o){this.control.update();var v=p.x-o.x;var u=p.y-o.y;var q,r,s;if((v===0)&&(u===0)){return}q=new m.Vector3().copy(this.camera.position).sub(this.target);r=(this.camera.top-this.camera.bottom)/this.viewer.div.clientHeight;s=new m.Vector3();s.add(q.clone().cross(this.camera.up).setLength(r*v));s.add(this.camera.up.clone().setLength(r*u));var t=this.viewer.ODTMode;var n=this.camera.position.clone().add(s);this.moveTo({eyePosition:n,duration:t?0:200})},pan:function(p){if(this.control===null){return}var s=new m.Vector3(),r,o,n;switch(p){case"left":s.x=-1;break;case"right":s.x=1;break;case"top":s.y=1;break;case"bottom":s.y=-1;break;default:s.x=1}s.applyQuaternion(this.control.orientation);s.setLength(0.05*this.control.distanceToTarget);r=this.target.clone().add(s);o=this.control.orientation.clone();n=this.control.distanceToTarget;var q=this.viewer.ODTMode;this.moveTo({eyePosition:new m.Vector3().addVectors(r,this.getCamera().getLookAt().clone().normalize().multiplyScalar(-n)),duration:q?0:100})},zoom:function(q){if(this.control===null){return}var p=0.9,s,o,n;if(q==="out"){p=1.1}s=this.target.clone();o=this.control.orientation.clone();n=this.control.distanceToTarget*p;var r=this.viewer.ODTMode;this.moveTo({eyePosition:new m.Vector3().addVectors(s,this.getCamera().getLookAt().clone().normalize().multiplyScalar(-n)),distanceToTarget:n,duration:r?0:100})},rotateCameraForPerfos:function(o,s,n){if(this.control===null){return}var p=function(){var t=new m.Vector3(0.35*Math.PI,0,0.75*Math.PI);this._orientation=(new m.Quaternion()).setFromEuler(t,"ZXY");this._key1=new m.Quaternion();this._key2=(new m.Quaternion()).setFromAxisAngle(new m.Vector3(0,0,1),Math.PI/2);this._key3=(new m.Quaternion()).setFromAxisAngle(new m.Vector3(0,0,1),Math.PI);this._key4=(new m.Quaternion()).setFromAxisAngle(new m.Vector3(0,0,1),3*Math.PI/2);this._nbLoops=(o!==undefined)?o:5;this._duration=(s!==undefined)?s:10000;this.duration=function(){return this._duration};this.valueAt=function(x){var u,A,z,w,y=this._duration/this._nbLoops,v=(x%y)/y;if(v>=0&&v<0.25){u=this._key1;A=this._key2;w=v/0.25}else{if(v>=0.25&&v<0.5){u=this._key2;A=this._key3;w=(v-0.25)/0.25}else{if(v>=0.5&&v<0.75){u=this._key3;A=this._key4;w=(v-0.5)/0.25}else{u=this._key4;A=this._key1;w=(v-0.75)/0.25}}}z=new m.Quaternion();m.Quaternion.slerp(u,A,z,w);return z.multiply(this._orientation)}},r=new p(),q=new h(this.control,"orientation",r);if(n){q.setLoop(1)}q.start()},getBoundingBox2D:function(q){if(!this._2DMode){return null}var t=this.viewer||this.sceneGraphRoot._getViewer();var r=null;var o;if(t.svgRoot){var s=this.viewer.svgRoot.getBBox();o=new m.Box2(new m.Vector2(s.x,-s.y-s.height),new m.Vector2(s.x+s.width,-s.y))}var n=t?t.getSceneBoundingBox(q):this.sceneGraphRoot.getBoundingBox(q);var p=new m.Box2(new m.Vector2(n.min.x,n.min.y),new m.Vector2(n.max.x,n.max.y));if(o){p.union(o)}return p},getBoundingSphere:function(o,p){var q=this.viewer||this.sceneGraphRoot._getViewer();var n=q?q.getSceneBoundingSphere(o,true):this.sceneGraphRoot.getBoundingSphere(o,true);if(!n){n=new m.Sphere(new m.Vector3(),100)}else{if(n.radius===0&&n.pixelRadius>0){if(p!==undefined){n.radius=p}else{n.radius=n.pixelRadius}}else{if(n.radius===0){if(p!==undefined){n.radius=p}else{n.radius=100}}}}return n},setViewOffset:function(p){function o(u,w){if(!p){u.setViewOffsetInternal(0,0,0,0,w.SCREEN_WIDTH,w.SCREEN_HEIGHT)}else{if(p.camera){u=p.camera}var v=p.fullWidth?p.fullWidth:w.SCREEN_WIDTH,s=p.fullHeight?p.fullHeight:w.SCREEN_HEIGHT,r=p.x?p.x:0,z=p.y?p.y:0,t=p.width?p.width:w.SCREEN_WIDTH,q=p.height?p.height:w.SCREEN_HEIGHT;u.setViewOffsetInternal(v,s,r,z,t,q)}}var n=this.camera;o(n,this.viewer);n.clone(this.robotCameraOrtho);this.robotCameraOrtho.setVisualizedHeight(null,undefined,n.fov)},project:function(p,q){var o=q||this.camera;var n=p.clone();j.projectVector(n,o);n.x=0.5*this.viewer.canvas.offsetWidth*(n.x+1);n.y=0.5*this.viewer.canvas.offsetHeight*(1-n.y);return n},unProject:function(q,r){var p=r||this.camera;var n=(q.x/this.viewer.canvas.offsetWidth)*2-1;var s=-(q.y/this.viewer.canvas.offsetHeight)*2+1;var o=new m.Vector3(n,s,q.z);j.unprojectVector(o,p);return o},create3DRayFrom2DPoint:function(p,r){var n=(p.x/this.viewer.canvas.offsetWidth)*2-1;var t=-(p.y/this.viewer.canvas.offsetHeight)*2+1;var o=new m.Vector3(n,t,-1);j.unprojectVector(o,r?r:this.camera);var s=new m.Vector3(n,t,1);j.unprojectVector(s,r?r:this.camera);var q=new m.Vector3().copy(s).sub(o);q.normalize();return new m.Ray(o,q)},dump:function(){var n="viewpoint.control.target = new THREE.Vector3("+this.control.target.x+", "+this.control.target.y+", "+this.control.target.z+");\nviewpoint.control.orientation = new THREE.Quaternion("+this.control.orientation.x+", "+this.control.orientation.y+", "+this.control.orientation.z+", "+this.control.orientation.w+");\nviewpoint.control.distanceToTarget = "+this.control.distanceToTarget+";";console.log(n)},setFromJSON:function(n){},_setPickingViewOffset:function(o){function n(s,r){var q=s._hasChanged;if(o.reset){s.setViewOffsetInternal(0,0,0,0,r.SCREEN_WIDTH,r.SCREEN_HEIGHT,{});s._hasChanged=q}else{var w=o.fullWidth?o.fullWidth:r.SCREEN_WIDTH,u=o.fullHeight?o.fullHeight:r.SCREEN_HEIGHT,v=o.x?o.x:0,t=o.y?o.y:0,p=o.width?o.width:r.SCREEN_WIDTH,z=o.height?o.height:r.SCREEN_HEIGHT;s.setViewOffsetInternal(w,u,v,t,p,z,{ratioW:o.pickingRatioW,ratioH:o.pickingRatioH});s._hasChanged=q}}if(o&&o.cameraSet){n(o.cameraSet.main,this.viewer);n(o.cameraSet.robotCameraOrtho,this.viewer);n(o.cameraSet.connectedRobotCamera,this.viewer)}},_updateRobotCamera:function(t){function r(E,D){var F=new m.Vector3().subVectors(E.center,D.position);var C=D.getLookAt();var G=F.dot(C);return{near:G-E.radius,far:G+E.radius}}var u=this.camera;u.clone(this.robotCameraOrtho);this.robotCameraOrtho.position.set(0,0,0);this.robotCameraOrtho.updateMatrix();this.robotCameraOrtho.updateMatrixWorld();this.robotCameraOrtho.updateProjectionMatrix();this.robotCameraOrtho.projectionMatrixInverse.getInverse(this.robotCameraOrtho.projectionMatrix);u.clone(this.connectedRobotCamera);var x=t.robotRoot;var q,y,s,n,A,z,B;y=x.getMatrixWorld();s=x.getBoundingSphere();if(s.pixelRadius>0){var o=this.robotCameraOrtho.getWorldSizeFromPixelSize(1,s.center,this.viewer.div.clientHeight);if((typeof this.robotCameraOrtho.fullWidth!=="undefined")&&this.robotCameraOrtho.fullWidth>0){var w=Math.max(this.robotCameraOrtho.width*1/this.robotCameraOrtho.fullWidth,this.robotCameraOrtho.height*1/this.robotCameraOrtho.fullHeight);o*=w}s.radius+=o*s.pixelRadius}if(s.radius===0){s.radius=10}if(s){z=r(s,this.robotCameraOrtho);this.robotCameraOrtho.near=z.near;this.robotCameraOrtho.far=z.far;this.robotCameraOrtho.updateProjectionMatrix();this.robotCameraOrtho.projectionMatrixInverse.getInverse(this.robotCameraOrtho.projectionMatrix);var p=t._robot;if(p){var v=!p.isConnected||p.isManipulatedInPlane;if(!v){q=p.getMatrixWorld();n=p.getBoundingSphere();if(n.pixelRadius>0){var o=this.connectedRobotCamera.getWorldSizeFromPixelSize(1,n.center,this.viewer.div.clientHeight);if((typeof this.connectedRobotCamera.fullWidth!=="undefined")&&this.connectedRobotCamera.fullWidth>0){var w=Math.max(this.connectedRobotCamera.width*1/this.connectedRobotCamera.fullWidth,this.connectedRobotCamera.height*1/this.connectedRobotCamera.fullHeight);o*=w}n.radius+=o*n.pixelRadius}n.applyMatrix4(q);B=r(n,this.camera);this.connectedRobotCamera.near=Math.min(B.near,u.near);this.connectedRobotCamera.far=Math.max(B.far,u.far);this.connectedRobotCamera.updateProjectionMatrix();this.connectedRobotCamera.projectionMatrixInverse.getInverse(this.connectedRobotCamera.projectionMatrix)}}}},_updateFrustum:function(){var n=this.camera;f.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse);this._frustum.setFromMatrix(f)}});l._FOCUS_MODE={TRANSLATION:0,ROTATION:1};l.PERSPECTIVE=0;l.ORTHOGRAPHIC=1;return UWA.namespace("THREEDS/Viewpoint",l)});define("Visualization/Viewpoint",["DS/Visualization/Viewpoint","DS/DSMigration/DSMigration"],function(b,a){a.deprecateModule("Visualization/Viewpoint");return b});