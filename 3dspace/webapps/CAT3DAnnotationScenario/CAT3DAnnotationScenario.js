define("DS/CAT3DAnnotationScenario/CAT3DAnnotationScenario",["DS/3DPlay/PlayScenario3D","DS/Selection/CSOManager","DS/WebappsUtils/WebappsUtils","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/WebSystem/Environment","i18n!DS/CAT3DAnnotationScenario/assets/nls/CAT3DAnnotationScenario"],function(f,b,e,d,c,a){return f.extend({init:function(k){this._parent(k);var n=k.scenarioManager.getExperience();var w=n.pad3DViewer;n.args.applicativeContainers=null;var v=this;var q;var j;var o={},r={};var l;var t=false;var s=false;var i;var y=false;var g;var x;var u,h;n.subscribe("ASSET/LOADINGFINISHED",function(){t=true;y=false;if(h){h()}},true);n.subscribe("ASSET/LOADINGSTARTED",function(){d.setLoadedAssetType(null);l=null;t=false},true);n.subscribe("EXPERIENCE/STOP",function(){if(j){v.stop()}},true);this.launch=function(){require(["DS/CAT3DAnnotationController/CAT3DAnnotBaseControllerInstance","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController","DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager","DS/PADUtils/PADUtilsServices","DS/CoreEvents/Events","DS/3DPlayConnectors/3DPlayInputPreProcessor"],function(K,L,D,F,G,C,M,B){h=function(){if(t&&l&&s){if(l&&l.length){d.setLoadedAssetType("3DXML");for(var O=0;O<l.length;O++){if(l[O].node&&l[O].xml){l[O].node.xml=l[O].xml}}}if(!y&&j){j.setActiveState(0);j.setActiveState(1)}}};function N(){var P=0;var O=w.getFrameWindow().getActionBar().onActionBarReady(function(){if(P===0){P=1;v.loadWorkbench({name:"3DPlay.xml",module:"3DPlay"},true)}else{if(P===1){P=2;v.loadWorkbench({name:"3DPlayShare.xml",module:"3DPlay"},true)}else{w.getFrameWindow().getActionBar().removeCallback(O)}}});v.loadWorkbench({name:"CAT3DAnnotationScenario.xml",module:"CAT3DAnnotationScenario"},false)}function J(){var Q=[],X;if(!w){return Q}var Y=[];var S=b.get();var U=w.getRootBagPath();for(X=0;X<S.length;X++){if(S[X].pathElement&&U.isAParentOf(S[X].pathElement)){Y.push(S[X].pathElement)}}if(Y.length===0){return Q}var O=false,T=false;for(X=0;X<Y.length;X++){if(!O){var V=typeof i==="function"?i():false;if(V===true||V===false||V===undefined){var R;if(S.length===1&&((S[0].pathElement.getLastElement(true).getAnnotationClassType&&S[0].pathElement.getLastElement(true).getAnnotationClassType()==="tpsAnnotationSet")||!S[0].pathElement.getLastElement(true).getAnnotationClassType)){R=V?"CAT3DAnnotationSetHideHdr":"CAT3DAnnotationSetShowHdr"}else{R=V?"CAT3DAnnotationHideHdr":"CAT3DAnnotationShowHdr"}Q.push({line:1,name:V?"CAT3DAnnotationHideStr":"CAT3DAnnotationShowStr",hdr_list:[R]});O=true}}var W=Y[X].getParentPath();var P=Y[X].getLastElement(true);if(((P.getAnnotationClassType&&P.getAnnotationClassType()!=="tpsAnnotationSet")||!P.getAnnotationClassType)&&Y.length===1){if(!T){if(W&&W.getLastElement(true).name!=="RootBag"){Q.push({line:1,name:"CAT3DAnnotationLevelSelectorStr",hdr_list:["CAT3DAnnotationLevelSelectorHdr"]});T=true}}}}return{cmdList:Q}}if(window.widget){window.widget.setMetas({helpPath:"CAT3DAnnotationScenario/assets/help"})}n.modelLoader.setCGRWithSG(true);N();n.args.applicativeContainers=["V4V5_FDT"];r.appContainer=n.subscribe("ASSET/APPLICATIVECONTAINERS/V4V5_FDT",function(O){l=O;h()});r.assetChanged=n.subscribe("ASSET/CHANGE",function(){w.publish({event:"on3DPlayAssetChanged",data:{}})});x=new B();var E=new K({ctxViewer:w});E.onAdditionalInfosRequired({controller:"AnnotScenario",cb:function(O){i=O.func}});q=E.subscribe("onSlideShowActiveStateModified",function(O){M.publish({event:O.state?"3DPLAY/SPECTREE/DISABLE":"3DPLAY/SPECTREE/ENABLE",data:{}});n._enableCMenu=!O.state});D.registerAnnotationController({annotController:E,context:w});var A=function(O){x.run(O,function(P){n.clearView();n.load(P)})};var I=G.getFavoriteContextManager({context:w,addRoots:function(P){y=true;var O=n.loadAssetInfo.originalAsset||{provider:"EV6",tenant:C.getPlatformId()};O.physicalid=P[0].path[0];O.id=P[0].path[0];A(O)},addRootNodesFromContent:function(P){y=true;var O=n.loadAssetInfo.originalAsset||{provider:"EV6",tenant:C.getPlatformId()};O.physicalid=P[0].objectId;O.id=P[0].objectId;O.displayName=P[0].displayName;O.type=P[0].objectType;O.dtype=P[0].objectType;A(O)}});o.onAddRoot=w.subscribe({event:"onRootAdded"},function(){d.setLoadedAssetType(null)});j=L.getAnnotationModelLoader({context:w,favoriteCtxManager:I});F.get3DAnnotBrowserController({context:w,defaultDockingSide:"left"}).setActiveState(true);s=true;w.getFrameWindow().getContextualUIManager().register({onContextualBarReady:J,context:w.getCommandContext?w.getCommandContext():n.ctx,workbenchName:"CAT3DAnnotationScenario",module:"CAT3DAnnotationScenario",cmdPrefix:"",subscriberId:"CAT3DAnnotationScenario",merge:true});j.setActiveState(1);E.setActiveState(true);g=w.getViewer().currentViewpoint.control.lockZ;w.getViewer().currentViewpoint.control.lockZ=false;if(n.loadAssetInfo&&n.loadAssetInfo.format==="3dxml"){x.run(n.loadAssetInfo.originalAsset?n.loadAssetInfo.originalAsset:n.loadAssetInfo,function(O){n.clearView();n.load(O)})}var z=0;var H=setInterval(function(){if(j&&!j.isRunning()){clearInterval(H);var O=w.getRootBagPath().getChildrenPathes();if(O.length===1&&d.is3DLeaf(O[0].getLastElement())){I.manageFavoriteContext({path:O[0]},true)}}z++;if(z>=100){clearInterval(H)}},500);u=function(){w.getViewer().currentViewpoint.control.lockZ=g;n.modelLoader.setCGRWithSG(false);n.args.applicativeContainers=[];var O;if(l&&l.length){for(O=0;O<l.length;O++){l[O].node.xml=null}}l=null;if(q){var Q=D.giveAnnotationController({context:w});if(Q){Q.unsubscribe(q)}}D.unreferenceAnnotationController({context:w});L.unreferenceAnnotationModelLoader({context:w});F.unreference3DAnnotBrowserController({context:w});G.unreferenceFavoriteContextManager({context:w});var P=Object.keys(o);for(O=0;O<P.length;O++){w.unsubscribe(o[P[O]])}o={};P=Object.keys(r);for(O=0;O<P.length;O++){n.unsubscribe(r[P[O]])}r={};if(w.getFrameWindow()){w.getFrameWindow().getContextualUIManager().unregister("CAT3DAnnotationScenario")}j=x=null;u=h=null}})};var m=this.stop;this.stop=function(){s=false;if(window.widget){window.widget.setMetas({helpPath:undefined})}if(u){u()}m()};this.getTitle=function(){return a.A3EScenario_Title};this.getDescription=function(){return a.A3EScenario_Description};var p=e.getWebappsAssetUrl("CAT3DAnnotationScenario","icons/I_A3E_3DPlayScenario.png");this.getIcon=function(){return p};this.isMobileCompatible=function(){if(c.isSet("3DPlay.FTAMobile")){return true}return false}}})});