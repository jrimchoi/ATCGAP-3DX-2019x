define("DS/SocialUserMention/Controls/AbstractAutocomplete",["UWA/Core","UWA/Promise","UWA/Json","UWA/Utils/Client","DS/WAFData/WAFData","DS/UIKIT/Autocomplete","DS/Logger/Logger"],function(e,g,c,h,i,j,a){var l=10,d="sm-autocomplete",k=function(n,m,o){n.initKeyEvent(m,true,true,window,o.ctrlKey,o.altKey,o.shiftKey,o.metaKey,e.is(o.keyCode)?o.keyCode:(o.key||o.which),o.charCode)},f=function(m,n){Object.defineProperty(m,"keyCode",{get:function(){return this.customKeyCode}});Object.defineProperty(m,"which",{get:function(){return this.customKeyCode}});m.customKeyCode=n};var b=j.extend({_areSuggestsVisible:false,_lastRange:null,name:"autocomplete",defaultOptions:{swymUrl:"",tenantId:"",swymServerToken:null,boundingElement:null,userGroups:null,defaultClassName:"",editorElement:null,allowFreeInput:true,noResultsMessage:false,itemMultiSelect:true,minLengthBeforeSearch:1,typeDelayBeforeSearch:300},_get3DSwymServerToken:function(){var m=this.options;return new g(function(p,o){var n=m.swymUrl;if(m.swymServerToken){p(m.swymServerToken)}else{if(!n){o("3DSwym URL could not be found!")}else{i.authenticatedRequest(n+"/api/index/tk",{method:"GET",onComplete:function(q){q=e.is(q,"string")?c.decode(q):q;if(q&&q.result&&q.result.ServerToken){m.swymServerToken=q.result.ServerToken;p(q.result.ServerToken)}else{o("3DSwym server token is missing from server response")}},onFailure:function(){o("Error retrieving 3DSwym server token")},onTimeout:function(){o("Time out while trying to retrieve 3DSwym server token")}})}}})},_initSocialMentionDataSet:function(){throw new Error("This method is supposed to be overridden!")},_positionComponent:function(o,n){var m=this.elements&&this.elements.container;if(m){m.style.setProperty("top",o+"px","important");m.style.setProperty("left",n+"px","important")}},_getBoundingClientRect:function(m){var n=m.getBoundingClientRect();if(h.Features.touchEvents&&(n.top===0)&&(n.right===0)&&(n.bottom===0)&&(n.left===0)){n=m.getClientRects()[0]}return n},init:function(){this._parent.apply(this,arguments);if(!this.options.editorElement){throw new Error("Editor element is missing")}this._initSocialMentionDataSet()},propagateKeyboardEventToInput:function(p){var o=null,n=p.type,m=this.elements&&this.elements.input;if(!p){throw new Error("The event to propagate is missing!")}if(!m){throw new Error("Autocomplete input element is missing!")}if(!h.Engine.ie&&window.KeyboardEvent&&!h.Features.touchEvents){o=new KeyboardEvent(n,{bubbles:true,cancelable:true,view:window,key:p.key,code:p.code,ctrlKey:p.ctrlKey,altKey:p.altKey,shiftKey:p.shiftKey,metaKey:p.metaKey,which:(e.is(p.which)?p.which:p.keyCode),charCode:p.charCode,keyCode:p.keyCode,isComposing:p.isComposing,repeat:p.repeat,location:p.location})}else{if(typeof(document.createEvent)==="function"){o=document.createEvent("KeyboardEvent");if(o.initKeyEvent){k(o,n,p)}else{o.initKeyboardEvent(n,true,true,window,p.key,p.location,p.ctrlKey,p.altKey,p.shiftKey,p.metaKey,p.keyCode,p.charCode)}}}if(o){if(h.Engine.webkit){f(o,p.keyCode)}m.dispatchEvent(o)}else{a.error("Failed to link the editor to autocomplete component")}},buildSkeleton:function(){var m=this._parent.apply(this,arguments),n=this.getOption("defaultClassName");if(!this.elements.container){throw new Error("Autocomplete container cannot be found")}if(!this.options.editorElement.parentElement){throw new Error("Editable element has no parent")}if(!n){n=""}this.elements.container.addClassName((n?(n+" "):"")+d);this.elements.userAutocompleteWrapper=e.createElement("div",{"class":(n?n+"-wrapper ":"")+d+"-wrapper"});this.inject(this.elements.userAutocompleteWrapper);this.elements.userAutocompleteWrapper.inject(this.options.containerElement||this.options.editorElement.parentElement);return m},areSuggestsVisible:function(){return this._areSuggestsVisible},displayContextually:function(v){if(!(this.elements&&this.elements.suggestsContainer)){return}var D=null,y=null,p=this.elements.userAutocompleteWrapper.parentElement;if(p){e.extendElement(p);e.extendElement(document.body);if(v){this._lastRange=v}else{v=this._lastRange}if(this.options.boundingElement){D=e.extendElement(this.options.boundingElement);y=this._getBoundingClientRect(D)}var F,t,q=false,m=document.body.getSize(),B=D?y.bottom:m.height,s=D?y.right:m.width,n,C,w,r,o,E,u,A=this.elements.suggestsContainer.getSize(),z=A.width,x=A.height;if(!z||!x){this.show();q=true;A=this.elements.suggestsContainer.getSize();z=A.width;x=A.height}u=x+l;n=this._getBoundingClientRect(v);if(!n){a.error("Range bounding element rectangle could not be computed!");return}w=n.top;r=n.bottom;o=n.left;E=n.right;C=this._getBoundingClientRect(p);F=n.top-C.top;t=n.left-C.left;if(h.Features.touchEvents){if(w>u){F=w-C.top-u}else{if((B-r)>x){F=F+n.height+l}else{F=F+n.height+l}}}else{if((B-r)>x){F=F+n.height+l}else{if(w>u){F=w-C.top-u}else{F=F+n.height+l}}}if((s-E)>z){}else{if(o+z>s){t=s-z-C.left}else{t=0}}this._positionComponent(F,t);if(q!==true){this.show()}}},onShowSuggests:function(){this._areSuggestsVisible=true;var m=this._parent.apply(this,arguments);this.displayContextually();return m},onHideSuggests:function(){this._areSuggestsVisible=false;return this._parent.apply(this,arguments)},onHide:function(){this._areSuggestsVisible=false;return this._parent.apply(this,arguments)},destroy:function(){this._areSuggestsVisible=false;return this._parent.apply(this,arguments)}});b.DEFAULT_CLASSNAME=d;return b});define("DS/SocialUserMention/Utils/Generic",["UWA/Core"],function(b){var a={throttle:function(e,d,c){if(typeof e==="function"){return(function(){var h=null,k=null,j=false,m=true,l=d||30,i=c?b.clone(c,false):{},g=function(){while(m===true){m=false;e.apply(k,h)}if(typeof(i.after)==="function"){i.after.apply(k,h)}j=false},f=function(){m=true;k=this;h=arguments;if(j===false){j=true;if(typeof(i.before)==="function"){i.before.apply(k,h)}setTimeout(g,l)}};return f})()}else{throw new Error("First argument is supposed to be a function")}}};return a});define("DS/SocialUserMention/AbstractSocialMention",["UWA/Core","UWA/Event","UWA/String","UWA/Promise","UWA/Utils","UWA/Utils/Client","UWA/Class/Events","UWA/Class/Listener","DS/SocialUserMention/Utils/Generic","DS/Logger/Logger","css!DS/UIKIT/UIKIT","css!DS/SocialUserMention/SocialUserMention"],function(a,c,b,f,j,r,n,g,l,u){var e=200,k=3,q=[".","!","?","$","^","*","+","|","\\","/",":",",","=","[","]","{","}","(",")"],h=q.map(function(z){return("\\"+z)}).join(""),i="\\s|\\u200B|&#8203;",v=("["+h+"]"),p=("^|$|"+v),x=(i+"|$|"+v),t=(i+"|"+p),w=new RegExp("("+v+")"),d=new RegExp(x),o=new RegExp("^("+t+")$"),y={};function s(D,A){try{var z=document.createRange(),B=document.getSelection();if(D){if(!a.is(A,"number")){A=D.nodeValue.length}z.setStart(D,A);z.collapse(true);B.removeAllRanges();B.addRange(z)}}catch(C){}}var m=g.extend(n,{_autocompleteClass:null,_attributeForStoringAutocompleteId:null,_triggerCharacter:null,_appendTriggerCharacterToMention:true,_queryMatcher:null,_removeEndingSlash:function(z){if(a.is(z,"string")&&(z.length>0)&&(z.charAt(z.length-1)==="/")){return z.slice(0,z.length-1)}else{return z}},_get3DSwymUrl:function(z){var A=this;return new f(function(D,C){var B=z["3DSwymUrl"];if(B){D(B)}else{require(["DS/i3DXCompassServices/i3DXCompassServices"],function(E){E.getPlatformServices({onComplete:function(G){var F=z.tenantId;if(Array.isArray(G)){G.forEach(function(H){if(H.platformId===F){B=A._removeEndingSlash(H["3DSwym"])}})}if(B){D(B)}else{C("There is no 3DSwym instance on this tenant")}},onFailure:function(){C("Error calling MyApps. Please make sure the TopFrame is correctly configured.")}})})}})},_handleAutoCompleteDisplay:function(){var J,D,E,C=null,H=0,B=null,K=null,G="",F=null,I=-1,A=false,z=function(){var L;if(I>=1){L=F[I-1].match(o);return(L&&(typeof(L[1])==="string"))}else{u.error("Position of trigger-character is incorrect")}return false};J=window.getSelection();if(J.rangeCount===0){u.warn("Can't display list. There is no selection!");return}D=J.getRangeAt(0);E=D&&D.cloneRange();if(E&&E.collapsed){H=E.endOffset;K=E.endContainer;F=K.nodeValue;if(F){I=F.substring(0,H).lastIndexOf(this._triggerCharacter)}if(I!==-1){if(F&&(I<H)){if((I+1)===H){C=F.substring(I,F.length).match(this._queryMatcher);if(C&&typeof(C[1])==="string"){G=C[1]}else{I=-1}}else{B=H+F.substring(H).search(d);if(B<H){throw new Error("Can't find the end of the word. This was not supposed to happen.")}C=F.substring(I+1,B).match(w);if(!C||(typeof(C[1])!=="string")){G=F.substring(I+1,B).split(/\s+/).slice(0,k).join(" ");if(H>(I+G.length+1)){I=-1}}else{I=-1}}}if(I!==-1){if(I===0){A=true}else{if(z()&&(((I+1)===H)||(F&&F[I+1].match(/^\S$/)))){A=true}}}}}if(A===true){E.setStart(K,I+1);E.setEnd(K,I+1);return{unalteredQuery:G,query:G.replace(/(\u200B|&#8203;)/g,""),container:K,triggerCharIndex:I,cursorIndex:H,range:E}}else{return null}},getMention:function(C){var B,A="",E,D;if(!C||!C.object||!C.object.value||!C.object.label){throw new Error("Required information are missing")}D=C.linksExtraAttributes;E=((this._appendTriggerCharacterToMention===false)?"":this._triggerCharacter)+b.escapeHTML(C.object.label);if(C.stringFormat===false){B=document.createDocumentFragment();B.appendChild(a.createElement("a",a.merge({contenteditable:"false",html:E},C.linksExtraAttributes)));B.appendChild(document.createTextNode(((C.includeNonBreakableSpace===false)?"":"\u00A0")));return B}else{if(a.is(D,"object")){for(var z in D){if(D.hasOwnProperty(z)){A+=(" "+z+'="'+D[z]+'"')}}}return("<a"+A+' contenteditable="false">'+E+"</a>"+((C.includeNonBreakableSpace===false)?"":"\u00A0"))}},enableFeature:function(A){var D=this,F,G,z,B,C=null,E=null;if(!A||!A.editableElement||((z=a.extendElement(A.editableElement).getAttribute("contenteditable"))&&(z!=="true")&&(z!==""))){throw new Error("An editable element is required")}if(!A["3DSwymUrl"]&&!A.tenantId){throw new Error("Tenant (online instance) ID is required.")}if(!this._autocompleteClass){throw new Error("Autocomplete class is missing!")}if(!this._attributeForStoringAutocompleteId){throw new Error("Attribute for storing autocomplete ID is missing!")}if(!this._triggerCharacter){throw new Error("The character supposed to trigger the display of suggestions is missing!")}if(!this._queryMatcher){this._queryMatcher=new RegExp("^"+this._triggerCharacter+"(.*?)(?="+t+")")}F=A.editableElement;G=A.containerElement;B={keydown:l.throttle(function(H){if(!C){return}C.propagateKeyboardEventToInput(H)},e),keyup:l.throttle(function(J){var H,I;if(!C){return}I=c.whichKey(J);switch(I){case"left":case"right":case"home":case"end":return;default:}H=C.elements&&C.elements.input;if(!H){return}if((I!=="del")&&(I!=="backspace")){F.normalize()}E=D._handleAutoCompleteDisplay();if(E){H.value=E.query.trim();C.displayContextually(E.range);C.propagateKeyboardEventToInput(J)}else{H.value="";C.hide()}},e),keypress:l.throttle(function(H){if(!C){return}C.propagateKeyboardEventToInput(H)},e)};D.listenTo(A.editableElement,{keydown:function(I){var H=c.whichKey(I);switch(H){case"return":case"up":case"down":if(!C||!C.areSuggestsVisible()){return}c.stopPropagation(I);c.preventDefault(I);I.stopImmediatePropagation();break;default:}B.keydown.apply(this,arguments)},keyup:function(H){switch(c.whichKey(H)){case"return":case"up":case"down":if(!C||!C.areSuggestsVisible()){return}c.stopPropagation(H);c.preventDefault(H);H.stopImmediatePropagation();C.propagateKeyboardEventToInput(H);break;default:B.keyup.apply(this,arguments)}},keypress:function(H){B.keypress.apply(this,arguments)}},1000);D._get3DSwymUrl(A).then(function(I){if(F[D._attributeForStoringAutocompleteId]){return}var H=j.getUUID();y[H]=C=new (D._autocompleteClass)(a.merge({editorElement:F,containerElement:G,tenantId:A.tenantId,swymUrl:I,swymServerToken:A["3DSwymServerToken"],boundingElement:A.boundingElement,events:{onSelect:function(M){var K,J,L,N;if(!E){throw new Error("Something went wrong...")}L=E.container.parentElement||E.container.parentNode;J=E.container.nodeValue;N=((E.triggerCharIndex+E.unalteredQuery.length+1)===J.length);E.container.nodeValue=(J.substring(0,E.triggerCharIndex)+J.substring(E.triggerCharIndex+E.unalteredQuery.length+1,J.length));K=E.container.splitText(E.triggerCharIndex);L.insertBefore(D.getMention({object:M,linksExtraAttributes:A.linksExtraAttributes,stringFormat:false,includeNonBreakableSpace:N}),K);if(typeof(F&&F.focus)==="function"){F.focus()}setTimeout(function(){s(K,0);if(a.is(A.events&&A.events.onInsert,"function")){A.events.onInsert({cursorPosition:{node:K,offset:0}})}},0);E=null}}},A.autocompleteOptions));F[D._attributeForStoringAutocompleteId]=H},function(H){u.error(H)})},disableFeature:function(z){var A;if(!z||!z.editableElement){throw new Error("An HTML element is required")}this.stopListening(z.editableElement);A=z.editableElement[this._attributeForStoringAutocompleteId]&&y[z.editableElement[this._attributeForStoringAutocompleteId]];if(A){A.destroy();z.editableElement[this._attributeForStoringAutocompleteId]=null}}});return m});define("DS/SocialUserMention/Controls/UserAutocomplete",["UWA/Core","UWA/Json","UWA/Promise","UWA/Array","DS/WAFData/WAFData","DS/UWPClientCode/I18n","DS/SocialUserMention/Controls/AbstractAutocomplete","DS/Logger/Logger"],function(f,d,g,a,h,i,c,b){var e="iam:",j=c.extend({defaultOptions:{defaultClassName:"sum-user-autocomplete",fedSearchUrl:"",currentUserInfo:null},_isUsersGroupServiceAvailable:function(){var k=this;return new g(function(l){require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(m){m.getServiceUrl({serviceName:"usersgroup",platformId:k.options.tenantId,onComplete:function(n){l((typeof(n)==="string")&&(n!==""))},onFailure:function(){l(false)}})},function(){l(false)})})},_initSocialMentionDataSet:function(){var k=this;this.addDataset({name:"Users",items:[],searchUrl:this.options.fedSearchUrl+"/search",remoteSearchEngine:function(m,n){var l=this;return this._isUsersGroupServiceAvailable().then(function(o){return new g(function(r,q){var s,p=l.options.userGroups&&l.options.userGroups["3DSwymCommunity"];if(m.searchUrl){s={start:0,nresults:20,tenant:l.options.tenantId,source:["swym"].concat(o===true?["usersgroup"]:[]),specific_source_parameter:{usersgroup:{additional_query:" AND [ds6w:label]:("+n.trim()+"*)"},swym:{additional_query:" AND personOrGroup:("+n+")"}},select_predicate:["ds6w:label","ds6w:type"],label:"SocialUserMention-"+l.options.currentUserInfo.userLogin+"-"+(new Date()).getTime(),query:'[ds6w:type]:("foaf:Group" OR "pno:Person")',with_synthesis:false,with_synthesis_attribute:false,locale:i.getCurrentLanguage()};if(p){s.community_id=p}h.authenticatedRequest(m.searchUrl,{method:"POST",type:"json",proxy:"passport",headers:{"Content-Type":"application/json;charset=utf-8"},data:d.encode(s),onComplete:function(u){var t={};t.matchingItems=[];if(u){t.matchingItems=(f.is(m.dataParser,"function"))?(m.dataParser.call(l,m,u)):(l.defaultDataParser(u))}t.dataset=m;r(t)},onFailure:function(t){t.type="error";t.dataset=m;q(t)},onTimeout:function(t){t.type="timeout";t.dataset=m;q(t)}})}})})},dataParser:function(m,l){if(!Array.isArray(l&&l.results)){return[]}return l.results.reduce(function(o,n){var r=false,p=false,q=n.attributes.reduce(function(s,t){switch(t.name){case"ds6w:label":r=true;if(!t.value){p=true}s.label=t.value;break;case"resourceid":s.value=t.value;break;case"ds6w:type":case"ds6w:what/ds6w:type":if(t.value==="foaf:Group"){s.memberType="usersgroup"}break;default:break}return s},{memberType:"user"});if(r&&!p){if(q.memberType==="user"){q.value=q.value.replace(e,"")}o.push(q)}return o},[])}},{templateEngine:function(l,n,m){var o;l.addClassName("user-template");o=f.createElement("span",{"class":"item-label"});o.setText(m.label);l.setContent([m.memberType==="user"?f.createElement("img",{src:k.getOption("swymUrl")+"/api/user/getpicture/login/"+m.value+"/format/mini"}):f.createElement("span",{"class":"fonticon fonticon-users-group"}),o])},onError:function(){k.hide()},onTimeout:function(){k.hide()}})}});return j});define("DS/SocialUserMention/SocialUserMention",["UWA/Core","UWA/Promise","DS/SocialUserMention/AbstractSocialMention","DS/SocialUserMention/Controls/UserAutocomplete","DS/Logger/Logger"],function(e,d,a,f,c){var b=a.singleton({_triggerCharacter:"@",_autocompleteClass:f,_attributeForStoringAutocompleteId:"_socialUserMentionAutocompleteId",_getFedSearchUrl:function(g){return new d(function(i,h){require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(j){j.getServiceUrl({serviceName:"3DSearch",platformId:g.tenantId,onComplete:function(k){if(k&&typeof(k)==="string"){i(k)}else{h("Couldn't find 3DSearch instance on this tenant")}},onFailure:function(){h("Error calling MyApps. Please make sure the TopFrame is correctly configured.")}})})})},_getUserInfo:function(g){return new d(function(i,h){if(g.userLogin&&g.userName){i({userLogin:g.userLogin,userName:g.userName})}else{require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(k){try{k.getUser({platformId:g.tenantId,onComplete:function(l){i({userLogin:l.id,userName:l.firstname+" "+l.lastname,userIsAdmin:l.admin})},onFailure:function(){h("Error retrieving user information. Please make sure that the TopFrame is correctly configured and that 3DCompass is up and running.")}})}catch(j){h("Error trying to call 3DCompass: "+j.message)}})}})},getMention:function(g){var h=g?e.clone(g,false):{},i={"class":"sum-user-link sm-link"};if(h.object){i[h.object.memberType==="usersgroup"?"data-users-group-uri":"data-login"]=h.object.value}h.linksExtraAttributes=e.merge(i,typeof(h.linksExtraAttributes)==="function"?h.linksExtraAttributes.call(null,h.object):h.linksExtraAttributes);return this._parent.call(this,h)},enableFeature:function(g){var h=undefined,i=this._parent,j=this;if(g){h=e.clone(g,false);h.autocompleteOptions={userGroups:g.userGroups}}else{h={autocompleteOptions:{}}}d.all([this._getFedSearchUrl(g),this._getUserInfo(g)]).then(function(k){h.autocompleteOptions.fedSearchUrl=k[0];h.autocompleteOptions.currentUserInfo=k[1];i.call(j,h)})},disableFeature:function(){return this._parent.apply(this,arguments)}});return b});