define("DS/VCXWebVisualization/VCXInteractor",["UWA/Class","DS/Visualization/ThreeJS_DS",],function(b,c){var a=b.extend({init:function(d){this._pathElement=null;this._handle=null;this._constraint=a.EConstraint.Pick;this._constraintReferential=a.EConstraintReferential.World;this._application=a.EApplication.None;this._active=true;this.disabledByManipulable=false;this._enableMultiSelect=false;this._visibility=a.EVisibility.NoChange;this._manipulatorType=a.EManipulatorType.Handle;this._handleInfos=null;this._matrix=new c.Matrix4();this._component=d},isHandleNeeded:function(){return this.manipulatorType!==a.EManipulatorType.None}});a.EConstraint={Pick:0,XYPlane:1,XZPlane:2,YZPlane:3,CustomPlane:4,XAxis:5,YAxis:6,ZAxis:7,CustomAxis:8,Radial:9};a.EConstraintReferential={World:0,Object:1,Geometry:2,Screen:3,};a.EApplication={None:0,"3DIllustration":1<<1,"3DPlayCATIAComposer":1<<2,CityIllustration:1<<3,};a.EVisibility={NoChange:0,OnObjectOver:1<<1,OnObjectSelected:1<<2,OnInteractorOver:1<<3,Always:1<<4};a.EManipulatorType={None:0,Axis:1,Handle:2,};a.ECursorDisplay={TopLeft:"nwse-resize",BottomRight:"nwse-resize",TopRight:"nesw-resize",BottomLeft:"nesw-resize",Top:"ns-resize",Bottom:"ns-resize",Left:"ew-resize",Right:"ew-resize"};Object.defineProperty(a.prototype,"pathElement",{enumerable:true,get:function(){return this._pathElement},set:function(d){this._pathElement=d}});Object.defineProperty(a.prototype,"handle",{enumerable:true,get:function(){return this._handle},set:function(d){return this._handle=d}});Object.defineProperty(a.prototype,"node",{enumerable:true,get:function(){if(this.isHandleNeeded()){return this._handle&&this._handle.getHandleGeom()}else{return this._pathElement&&this._pathElement.getLastElement()}},set:function(j){if(!j){this._pathElement=null;return}if(this._component){var i=this._component.QueryInterface("W3AISGNodeHolder");var l=i&&i.giveSGNode();if(j===l){this._pathElement=i.getPathElement().clone()}else{var g=[];var d=j;var e=this._component._experienceBase.getManager("VCXContextManager");if(!e){return}var f=e.getRootNode();if(!f){return}while(d.parents&&d.parents[0]&&d!==l&&d!==f){g.push(d);d=d.parents[0]}if(d===l){this._pathElement=i.getPathElement().clone();for(var k=g.length-1;k>=0;k--){this._pathElement.addElement(g[k])}}else{if(d===f){var h=e.getRootComponent();var m=h&&h.QueryInterface("W3AISGNodeHolder").getPathElement();this._pathElement=m.clone();this._pathElement.setFromArray(g)}}}}}});Object.defineProperty(a.prototype,"constraint",{enumerable:true,get:function(){return this._constraint},set:function(d){this._constraint=d}});Object.defineProperty(a.prototype,"constraintReferential",{enumerable:true,get:function(){return this._constraintReferential},set:function(d){this._constraintReferential=d}});Object.defineProperty(a.prototype,"application",{enumerable:true,get:function(){return this._application},set:function(d){if(typeof d==="number"){this._application=d}}});Object.defineProperty(a.prototype,"active",{enumerable:true,get:function(){var e=this.component._experienceBase.getManager("VCXContextManager");var d=this.component._experienceBase.getManager("VCXExperience");var f=Boolean(d.GetPreviewMode&&d.GetPreviewMode());if(this.application===a.EApplication.None||((f||e.getPlayerMode())&&!(this.application&a.EApplication["3DPlayCATIAComposer"]))||(e.getCityMode()&&!(this.application&a.EApplication.CityIllustration))){return false}if(this.handleInfos&&this.handleInfos.stayVisible){return true}if(this.disabledByManipulable){return false}return this._active},set:function(d){this._active=d;if(this.manipulator){if(this.active){this.manipulator.enable()}else{this.manipulator.disable()}}}});Object.defineProperty(a.prototype,"enableMultiSelect",{enumerable:true,get:function(){return this._enableMultiSelect},set:function(d){if(typeof d==="boolean"){this._enableMultiSelect=d}}});Object.defineProperty(a.prototype,"visibility",{enumerable:true,get:function(){return this._visibility},set:function(d){this._visibility=d}});Object.defineProperty(a.prototype,"manipulatorType",{enumerable:true,get:function(){return this._manipulatorType},set:function(d){this._manipulatorType=d}});Object.defineProperty(a.prototype,"handleInfos",{enumerable:true,get:function(){return this._handleInfos},set:function(d){if(!d){this._handleInfos=null}else{if(d.color||d.opacity||d.size){if(!this._handleInfos){this._handleInfos={}}if(d.color){this._handleInfos.color=d.color}if(d.opacity){this._handleInfos.opacity=d.opacity}if(d.size){this._handleInfos.size=d.size}if(d.stayVisible){this._handleInfos.stayVisible=d.stayVisible}}else{return false}}return true},});Object.defineProperty(a.prototype,"matrix",{enumerable:true,get:function(){return this._matrix},set:function(d){if(d instanceof c.Matrix4){this._matrix=d}}});Object.defineProperty(a.prototype,"component",{enumerable:true,get:function(){return this._component},set:function(d){this._component=d}});return a});define("DS/VCXWebVisualization/VCXImageManager",["DS/WebApplicationBase/W3AAManager","DS/VCXWebProperties/VCXColor","DS/VCXWebKernelTools/VCXPixelImage",],function(d,a,b){var c=d.extend({initialize:function(){this._imagesCacheSize=10;this._imagesCache=[]},_findInCache:function(j,g,e,k){for(var h=0;h<this._imagesCache.length;++h){var f=this._imagesCache[h];if(f.iDocID===j&&f.iEffect===g&&f.expectedWidth===e&&f.expectedHeight===k){return f}}return null},_addToCache:function(g,f,e,i,h){var j={iDocID:g,iEffect:f,expectedWidth:e,expectedHeight:i,effectImage:h};if(this._imagesCache.length<this._imagesCacheSize){this._imagesCache[this._imagesCache.length]=j}else{this._imagesCache=this._imagesCache.slice(1,this._imagesCacheSize);this._imagesCache[this._imagesCacheSize-1]=j}},GetImageFromDocID:function(j,r,h,k,m){if(!h){return}var g=this._experienceBase.getManager("VCXDocManager");var n=g.GetPropPath(j);if(!n){h(j,null);return}var q=n.GetValueURL();var t=q.Value;var e=this._findInCache(j,r,k,m);if(e&&e.effectImage){if(e.effectImage.status&&e.effectImage.status==="isLoading ..."){e.effectImage.cbs.push(h)}else{h(j,e.effectImage)}return}var f=document.createElement("canvas");f.status="isLoading ...";f.cbs=[];this._addToCache(j,r,k,m,f);var s=(r&c.Effect.RemoveBorder);var i=(r&c.Effect.BlankRest);var p=(r&c.Effect.RedimensionPower2);var o=new b();if(k!==undefined&&m!==undefined){o.setPreferredSize(k,m)}var l=this;o.loadFrom(t,function u(){var y=o.getPixelWidth();var J=o.getPixelHeight();if(s){var G={};var E=o.buildBorderHist(G);if(!E){var F;var I;for(var z in G){if(F===undefined||G[z]>I){F=z;I=G[z]}}var A=new a().FromHex(F);var K=false;if(I>J+y){K=true}if(K){var L=new a().FromRGBA(0,0,0,0);var x;if(i){x=new a().FromRGBA(0,0,0,1/255)}o.replaceKeyColorByOther(A,L,x)}}else{var A=new a().FromRGBA(0,0,0,0);var L=new a().FromRGBA(0,0,0,0);var x;if(i){x=new a().FromRGBA(0,0,0,1/255)}}}o.fillCanvas(f);if(p){if(!o.isPowerOf2(o.getPixelWidth())||!o.isPowerOf2(o.getPixelHeight())){var w=o.getNearestPow2(o.getPixelWidth());var H=o.getNearestPow2(o.getPixelHeight());var v=document.createElement("canvas");v.width=w;v.height=H;v.getContext("2d").drawImage(f,0,0,w,H);var B=f.status;var D=f.cbs;f=v;f.status=B;f.cbs=D}}f._IsReadyToUse=true;h(j,f);for(var C=0;C<f.cbs.length;++C){f.cbs[C](j,f)}delete f.status;f.cbs=null;delete f.cbs})},});c.Effect={None:0,RedimensionPower2:1<<0,RemoveBorder:1<<1,BlankRest:1<<2};Object.defineProperty(c.prototype,"componentType",{enumerable:true,get:function(){return"VCXImageManager"}});return c});define("DS/VCXWebVisualization/VCXRobotAdapter",["DS/WebApplicationBase/W3AAManager","DS/Visualization/ThreeJS_DS","DS/ApplicationFrame/CommandsManager","DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey","DS/VCXWebModifiablesServices/VCXModifiablesServices","DS/CoreEvents/Events","DS/Mesh/MeshUtils"],function(h,f,d,c,b,a,g){var e=h.extend({initialize:function(){},postInitialize:function(){this._experienceBase.getManager("VCXContextManager").getMainViewer().setRobot(true,{snapOnFace:true,showOnlyManipulated:true});this._robot=this._experienceBase.getManager("VCXContextManager").getMainViewer().getRobot();var l=new f.Vector3(1,0,0);var k=new f.Vector3(0,1,0);var i=new f.Vector3(0,0,1);this._robot.updateAxis(l,k,i);var n=this._robot.ratio.docked;this._robot.setRatio({docked:n,moving:n,connected:n});this._robot.setDisplayScalingNodes(false);var m=this;var j=function(s,o,u){var r=m._robot&&m._robot.fixedSizeNode3D.ratio/7;var t=m._experienceBase&&m._experienceBase.getManager("VCXGUIManager");var p=t&&t.getUsableArea();var q=p&&p.getBoundingClientRect();if(q&&typeof r==="number"){return{x:2*u*(q.right-100*r)/s-1,y:2*(1-u*((q.bottom-100*r)/o))-1}}else{return{x:0.85,y:-0.8}}};this._robot.setGetPositionCB(j);if(this._experienceBase.getManager("VCXContextManager").getPlayerMode()){this._robot.robotHandle.setPickable(g.NOPICKABLE)}else{var m=this;this._robot.setMoveMode("CALLBACK_ONLY");this._robot.setAddToHSO(false);this._robot.setAddToCSO(false);this.tokens={};this.tokens.lineTranslationBegin=this._robot.subscribe("LineTranslationBegin",function(o){o.target&&m._lineTranslationBeginCB(o)});this.tokens.lineTranslationManipulation=this._robot.subscribe("LineTranslationManipulation",function(o){o.target&&m._lineTranslationManipulationCB(o)});this.tokens.lineTranslationEnd=this._robot.subscribe("LineTranslationEnd",function(o){o.target&&m._lineTranslationEndCB(o)});this.tokens.planeTranslationBegin=this._robot.subscribe("PlaneTranslationBegin",function(o){o.target&&m._planeTranslationBeginCB(o)});this.tokens.planeTranslationManipulation=this._robot.subscribe("PlaneTranslationManipulation",function(o){o.target&&m._planeTranslationManipulationCB(o)});this.tokens.planeTranslationEnd=this._robot.subscribe("PlaneTranslationEnd",function(o){o.target&&m._planeTranslationEndCB(o)});this.tokens.rotationBegin=this._robot.subscribe("RotationBegin",function(o){o.target&&m._rotationBeginCB(o)});this.tokens.rotationManipulation=this._robot.subscribe("RotationManipulation",function(o){o.target&&m._rotationManipulationCB(o)});this.tokens.rotationEnd=this._robot.subscribe("RotationEnd",function(o){o.target&&m._rotationEndCB(o)});this.tokens.screenPlaneTranslationBegin=this._robot.subscribe("ScreenPlaneTranslationBegin",function(o){m._screenPlaneTranslationBeginCB(o)});this.tokens.screenPlaneTranslationEnd=this._robot.subscribe("ScreenPlaneTranslationEnd",function(o){m._screenPlaneTranslationEndCB(o)});this._arrayModifiables=null;this._initialFramesInParents=null;this._initialPivotsInParents=null;this._lastData=null}},unInitialize:function(){if(this._robot){if(!this._experienceBase.getManager("VCXContextManager").getPlayerMode()){for(var j in this.tokens){if(this.tokens.hasOwnProperty(j)){var i=this.tokens[j];this._robot.unsubscribe(i);this.tokens[j]=null}}}this._robot.setGetPositionCB(null);this._robot=null;this.tokens=null}},_lineTranslationBeginCB:function(i){this._saveInitialPositions();this._togglePrePicking(false);this._experienceBase.getManager("VCXCommandManager").StartTransaction()},_lineTranslationManipulationCB:function(i){if(!this._arrayModifiables||this._arrayModifiables.length===0){return}this._updateWithManipulation("translation",i.translationVector);this._lastData=i},_lineTranslationEndCB:function(j){this._experienceBase.getManager("VCXCommandManager").EndTransaction("Robot Line Translation");this._togglePrePicking(true);if(this._experienceBase.odt==="record"){var i=this._arrayModifiables.map(function(l){return l.GetObject().GetID()});var k={commandName:"VCXTransformCmd",transformType:"translation",inputStr:this._lastData.translationVector.createJSON(),componentsIDs:i};this._experienceBase.getManager("VCXODTManager").LogAPI("VCXExecuteTransform",k)}this._arrayModifiables=null;this._initialFramesInParents=null;this._initialPivotsInParents=null;this._lastData=null},_planeTranslationBeginCB:function(i){this._lineTranslationBeginCB(i)},_planeTranslationManipulationCB:function(i){this._lineTranslationManipulationCB(i)},_planeTranslationEndCB:function(i){this._lineTranslationEndCB(i)},_rotationBeginCB:function(i){this._saveInitialPositions();this._togglePrePicking(false);this._experienceBase.getManager("VCXCommandManager").StartTransaction()},_rotationManipulationCB:function(i){if(!this._arrayModifiables||this._arrayModifiables.length===0){return}this._updateWithManipulation("rotation",i.rotationMatrix,this._robot.initialMatrix);this._lastData=i},_rotationEndCB:function(j){this._experienceBase.getManager("VCXCommandManager").EndTransaction("Robot Rotation");this._togglePrePicking(true);if(this._experienceBase.odt==="record"){var i=this._arrayModifiables.map(function(l){return l.GetObject().GetID()});var k={commandName:"VCXTransformCmd",transformType:"rotation",initialMatrixStr:this._robot.initialMatrix.createJSON(),inputStr:this._lastData.rotationMatrix.createJSON(),componentsIDs:i};this._experienceBase.getManager("VCXODTManager").LogAPI("VCXExecuteTransform",k)}this._arrayModifiables=null;this._initialFramesInParents=null;this._initialPivotsInParents=null},_screenPlaneTranslationBeginCB:function(k){var i=this._experienceBase.getManager("VCXContextManager").getContext();var j=d.getCommand("VCXTransformCmd",i);if(j&&!j.isRunning()){j.end()}if(this._experienceBase.getManager("VCXSelectionManager").GetComponentsFromCurrentSelection("VCXWebComponentOccurrence").length===0){this._robot.setAddToHSO(true);this._robot.setAddToCSO(true)}else{this._robot.setAddToHSO(false);this._robot.setAddToCSO(false)}this._togglePrePicking(false)},_screenPlaneTranslationEndCB:function(k){if(k.target){a.publish({event:"VCX_DONT_CHNG_ROBOT_POS_AT_TRANSFORM_BEGIN"});var i=this._experienceBase.getManager("VCXContextManager").getContext();var j=d.getCommand("VCXTransformCmd",i);if(j&&!j.isRunning()){j.begin()}}this._togglePrePicking(true)},_updateWithManipulation:function(j,q,k){var o=this;var n=j.toLowerCase();var r=null;switch(n){case"rotation":if(!(q instanceof f.Matrix4)){console.error("A THREE.Matrix4 object is needed as input !");return}r=function(i){return b.buildPropertyLocationWithRotationInWCS(i,q,k)};break;case"translation":if(!(q instanceof f.Vector3)){console.error("A THREE.Vector3 object is needed as input !");return}r=function(i){return b.buildPropertyLocationWithTranslationInWCS(i,q)};break;default:console.error("A compatible manipulation type ('translation' or 'rotation') must be specified as argument !");return}this._restoreLastInitPositions();var p=new c(this._experienceBase.getManager("VCXScenarioManager"),this._experienceBase.getManager("VCXCommandManager"));for(var m=0;m<this._arrayModifiables.length;m++){var l=r(this._arrayModifiables[m]);p.ChangeProperty(this._arrayModifiables[m],l)}this._experienceBase.getManager("VCXCommandManager").Push(p)},_saveInitialPositions:function(){this._arrayModifiables=[];var k=this._experienceBase.getManager("VCXSelectionManager").GetComponentsFromSelection("CSO");k=b.filterChildrenOfCompsFromArray(k);for(var m=0;m<k.length;++m){if(k[m].IsKindOf("VCXWebComponentOccurrence")&&!k[m].IsDressup){var l=k[m].QueryInterface("VCXIModifiable");l&&this._arrayModifiables.push(l)}}if(this._arrayModifiables.length===0){return}this._initialFramesInParents=[];this._initialPivotsInParents=[];for(var m=0;m<this._arrayModifiables.length;m++){var j=this._arrayModifiables[m].GetProperty("Actor.Position").GetPropertyValue();this._initialFramesInParents[m]=j.GetFrame().GetValue();this._initialPivotsInParents[m]=j.GetPivot().GetValue()}},_restoreLastInitPositions:function(){for(var j=0;j<this._arrayModifiables.length;j++){var k=new f.Matrix4().copy(this._initialFramesInParents[j]);var m=new f.Matrix4().copy(this._initialPivotsInParents[j]);var l=b.buildPropertyLocationWithFramePivot(k,m);this._arrayModifiables[j].OnChangeProperty("Actor.Position",l.GetPropertyValue());this._arrayModifiables[j].OnChangePropertiesEnd()}},_togglePrePicking:function(j){var i=this._experienceBase.getManager("VCXContextManager");var k=i&&i.getMainViewer();k&&k.setPrePicking({activated:j})},executeTransformODT:function(m){var j;var l=null;var k=new f.Matrix4();if(m.transformType==="rotation"){l=new f.Matrix4();k.setFromJSON(m.initialMatrixStr)}else{if(m.transformType==="translation"){l=new f.Vector3()}}l.setFromJSON(m.inputStr);var i=this._experienceBase.ComponentsMap.GetComponentsFromIDs(m.componentsIDs);this._saveInitialPositions();this._updateWithManipulation(m.transformType,l,k);this._arrayModifiables=null}});Object.defineProperty(e.prototype,"componentType",{enumerable:true,get:function(){return"VCXRobotAdapter"}});return e});define("DS/VCXWebVisualization/VCXIViewpointController",["DS/WebComponentModeler/CATWebInterface"],function(a){var b=a.singleton({interfaceName:"VCXIViewpointController",required:{toViewpoint:function(){},fromViewpoint:function(c){},resetMatrixAndDOI:function(){},shouldUseSphericalInterpolator:function(){},getMatrixAndDOI:function(){},GetInterpolator:function(){}}});return b});define("DS/VCXWebVisualization/VCXPickInfo",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/VCXWebKernelTools/VCXMathTools","DS/VCXWebModifiablesServices/VCXModifiablesAccess"],function(a,b,d,e){var c=a.extend({init:function(i,g){this._experienceBase=g;this._viewer=i;if(!this._viewer&&this._experienceBase){this._viewer=this._experienceBase.getManager("VCXContextManager").getMainViewer()}if(this._experienceBase){var h=this._experienceBase.getManager("VCXDressupManager");var f=h.QueryInterface("VCXIModelNavigable");this._currentWorkingRoot=f.getWorkingRoot().GetObject()}this._pathElement=null;this._modifiableIsDirty=true;this._modifiable=null;this._canonics=[];this._position=new b.Vector3();this._normal=new b.Vector3(0,1,0);this._matrixIsDirty=true;this._matrix=null;this._smartMode=true;this._smartMouse=new b.Vector2()},reset:function(){this._viewer=null;this._experienceBase=null;this._pathElement=null;this._modifiableIsDirty=true;this._modifiable=null;this._position=null;this._normal=null;this._matrixIsDirty=true;this._matrix=null;this._smartMouse=null;delete this._canonics;this._canonics=null},});Object.defineProperty(c.prototype,"pathElement",{enumerable:true,get:function(){return this._pathElement},set:function(f){this._pathElement=f;this._modifiableIsDirty=true}});Object.defineProperty(c.prototype,"modifiable",{enumerable:true,get:function(){if(this._modifiableIsDirty&&this._experienceBase){if(this._pathElement){this._modifiable=e.GetModifiableFromPathElement(this._pathElement,this._experienceBase);if(!this._modifiable){}}else{this._modifiable=null}this._modifiableIsDirty=false}return this._modifiable}});Object.defineProperty(c.prototype,"canonics",{enumerable:true,get:function(){if(this._modifiableIsDirty){this._canonics=[]}return this._canonics},set:function(f){this._canonics=f}});Object.defineProperty(c.prototype,"globalPosition",{enumerable:true,get:function(){return this._position},set:function(f){this._position=f;this._matrixIsDirty=true}});Object.defineProperty(c.prototype,"localPosition",{enumerable:true,get:function(){var f=this.modifiable;if(!f){f=this._currentWorkingRoot}var g=f.QueryInterface("W3AISGNodeHolder");if(g){return g.getPositionInLCS(this._viewer,this.globalPosition)}return this.globalPosition.clone()},});Object.defineProperty(c.prototype,"globalNormal",{enumerable:true,get:function(){return this._normal},set:function(f){this._normal=f;this._matrixIsDirty=true}});Object.defineProperty(c.prototype,"localNormal",{enumerable:true,get:function(){var f=this.modifiable;if(!f){f=this._currentWorkingRoot}var g=f.QueryInterface("W3AISGNodeHolder");if(g){return g.getDirectionInLCS(this._viewer,this.globalNormal)}},});Object.defineProperty(c.prototype,"globalMatrix",{enumerable:true,get:function(){if(this._matrixIsDirty){this._matrix=d.getMatrixFromOVz(this._position,this._normal);this._matrixIsDirty=false}return this._matrix}});Object.defineProperty(c.prototype,"localMatrix",{enumerable:true,get:function(){var f=this.modifiable;if(!f){f=this._currentWorkingRoot}var g=f.QueryInterface("W3AISGNodeHolder");if(g){return g.getMatrixInLCS(this._viewer,this.globalMatrix)}},});Object.defineProperty(c.prototype,"viewer",{enumerable:true,get:function(){return this._viewer}});Object.defineProperty(c.prototype,"smartMode",{enumerable:true,get:function(){return this._smartMode},set:function(f){this._smartMode=f}});Object.defineProperty(c.prototype,"smartMouse",{enumerable:true,get:function(){return this._smartMouse},set:function(f){this._smartMouse=f}});return c});define("DS/VCXWebVisualization/VCXPublishRasterImage",["UWA/Class","DS/VCXWebKernelTools/VCXPixelImage","DS/VCXWebKernelCommands/VCXCmdGoToScenario",],function(b,a,c){var d=b.extend({init:function(){},getViewer:function(e){if(!this._viewer){return e.getManager("VCXContextManager").getMainViewer()}else{return this._viewver}},getUsePaperRatio:function(){if(this._usePaperRatio===undefined){return true}else{return this._usePaperRatio}},captureViewport:function(f,e){var h=f.getManager("VCXVisuManager");h.setTileOutput(true);var j=this._viewer?this._viewer:f.getManager("VCXContextManager").getMainViewer();var g={data:null,width:j.SCREEN_WIDTH,height:j.SCREEN_HEIGHT};j.renderToTarget(g,j.currentViewpoint);var i=null;if(g.data!==null){i=new a(g.data,g.width,g.height);i.rotate180()}h.setTileOutput(false);if(e){e(i)}},hideDiggerAnchors:function(j){var e=j.getManager("VCXDressupManager").getDressupsFromGroup("Diggers");for(var i=0;i<e.length;i++){var f=e[i];if(!f){continue}var h=f.QueryInterface("W3AISGNodeHolder");var k=h.getSGNode();if(k.isVisible()){var n=k.Modifiable;if(n){var g=n.QueryInterface("VCXIManipulable");var l=g&&g.getAllInteractors();var m=l&&l["Interactor Anchor.0"];if(m&&m.node&&m.node.handle){m.node.handle.Hide(true)}}}}},doHiResImageDiggerAndMerge:function(l,s,t,o){var r=l.getManager("VCXPaperManager");var g=r.MMToPixel2(null,r.Size);r.updatePaper({viewportSize:{x:s,y:t}});var u={x:0,y:0};var p=r.MMToPixel2(null,u);var m=l.getManager("VCXDressupManager").getDressupsFromGroup("Diggers");for(var k=0;k<m.length;k++){var i=m[k];if(!i){continue}var e=i.QueryInterface("W3AISGNodeHolder");var j=e.getSGNode();if(!j.isVisible()){continue}var h=2*j.getRadiusInPixel();var v=2*j.getRadiusInPixel();var q=j._viewer.SCREEN_WIDTH;var n=j._viewer.SCREEN_HEIGHT;h-=2*j.DiggerUI.diggerComponent.borderThickness;v-=2*j.DiggerUI.diggerComponent.borderThickness;var f=j;j.doHiRes(l,h,v,function(E){var w=o.toCanvas();var K=w.getContext("2d");var A=f.getPositionInPixel();var I=A.x-p.x;var F=A.y-p.y;var D=j.getRadiusInPixel();var C=f.GetOpacity();f.DiggerUI.drawBorder(K,I,F,D,C);if(f.getAttachDisplay()){var z=f.getAnchorVector();var B=f.convert3DPointToCanvasPxl(z,f._viewer,w);B.x-=p.x;B.y-=p.y;var J=f.calcDiggerAnchorPoints(D+f.DiggerUI.diggerComponent.borderThickness,A,B);if(J){f.DiggerUI.drawAttach(K,B,J,C)}}f.DiggerUI.drawImage(K,I,F,E,C);var H=E.getPixelWidth()/2;f.DiggerUI.drawInnerBorder(K,I,F,H,C);var G=K.getImageData(0,0,w.width,w.height);o._bufferRGBA=new Uint8ClampedArray(G.data)})}r.updatePaper()},_doHiResImage:function(m,t,u,i){var g=this._viewer?this._viewer:m.getManager("VCXContextManager").getMainViewer();var l=g.getRobot();if(l){var f=l.isConnected;var j=l.getMatrix();l.setVisibility(false)}var v=m.getManager("VCXSelectionManager").GetComponentsFromSelection("CSO");m.getManager("VCXSelectionManager").removeComponentsFromSelection(v,false);var r=m.getManager("VCXVisuManager");r.setTileOutput(true);var s=m.getManager("VCXPaperManager");t=parseInt(t);if(this.getUsePaperRatio()){u=Math.floor(t*s.Ratio)}else{u=parseInt(u)}var q={data:null,width:t,height:u};if(this.getUsePaperRatio()){s.updatePaper({viewportSize:{x:t,y:u}})}try{g.renderToTarget(q,g.currentViewpoint)}catch(p){if(p instanceof RangeError&&m){var o="Publish Raster Image : Image too big";var w=m.getManager("VCXNLSManager");if(w){var h=w.GetNLS(["VCXWebVisualization/VCXWebVisualization"]);o=h?h.getTitle({key:"RasterImage.SizeTooBig"}):""}var k=m.getManager("VCXContextManager");if(k){var e={level:"error",title:"error",message:o};k.addNotification(e)}}console.log(p)}if(this.getUsePaperRatio()){s.updatePaper()}var n=null;if(q.data!==null){n=new a(q.data,q.width,q.height);n.rotate180()}m.getManager("VCXSelectionManager").addComponentsToSelection(v,false);if(l){l.setVisibility(true)}if(f){l.setConnectionState(true);l.fixedSizeNode3D.setRatio(7);l.setRobotMatrix(j)}r.setTileOutput(false);if(i){i(n)}else{return n}},_doHiResImageWithSubDivs:function(f,g,h,e){this.hideDiggerAnchors(f);var i=this;this._doHiResImage(f,g,h,function(j){i.doHiResImageDiggerAndMerge(f,g,h,j);if(e){e(j)}})},doHiRes:function(f,A,B,m,k){if(!f){console.log("Experience is null !");return}var h=f.getManager("VCXScenarioManager");if(!h){k(null);return}var x=m&&(m.mode===d.Mode.Selected||m.mode===d.Mode.All);if(!x){this._doHiResImageWithSubDivs(f,A,B,function(i){if(i&&m.quality!==undefined&&m.quality>=0&&m.quality<=1){i.setQuality(m.quality)}k({image:i,scenario:h._Scenarios[h.GetCurrentScenario()]})});return}var D=f.getManager("VCXSelectionManager");var u=f.getManager("VCXSequenceManager");if(!u){k(null);return}var r=u?u.GetListSequencesFromType(0):[];var q=[];for(var w=0;w<r.length;w++){var s=r[w];if(!s){continue}var z=s.GetListScenariosId();for(var v=0;v<z.length;v++){var C=z[v];var l=h.GetScenarios()[C];if(l&&l._ID){if(m.mode!==d.Mode.Selected||D.isIn(l)){q.push(l._ID)}}}}var n=h?h.GetCurrentScenario():null;var e=false;var y=f.getManager("VCXVisuManager");if(y){e=y.CameraControlsViewpoint;y.CameraControlsViewpoint=true}var g=this._viewer?this._viewer:f.getManager("VCXContextManager").getMainViewer();if(!g){k(null);return}if(!q.length){k(null);return}for(var t=0;t<q.length;++t){var o=q[t];f.getManager("VCXExperience").GoToScenario(o);var p=g.currentViewpoint;f._ManagerSet.update({viewer:g,viewpoint:g.currentViewpoint});this._doHiResImageWithSubDivs(f,A,B,function(i){if(m&&m.quality!==undefined&&m.quality>=0&&m.quality<=1){i.setQuality(m.quality)}k({image:i,scenario:h._Scenarios[o]})})}f.getManager("VCXExperience").GoToScenario(n);if(y){y.CameraControlsViewpoint=e}},doThumbnailToDataUrl:function(e,h,g){var k=null;var j=e.getManager("VCXPaperManager");var f=Math.floor(h);var i;if(this.getUsePaperRatio()){i=h*(j._ViewBoxPxSize.y/j._ViewBoxPxSize.x)}else{i=Math.floor(g)}this.doHiRes(e,f,i,{mode:d.Mode.Current,quality:0.8,usePaper:true},function(m){var p=m?m.image:null;if(!p){return}var o=document.createElement("canvas");o.width=p._width;o.height=p._height;var n=o.getContext("2d");var l=n.getImageData(0,0,p._width,p._height);l.data.set(p._bufferRGBA);n.putImageData(l,0,0,0,0,p._width,p._height);k=o.toDataURL("image/jpeg",0.8)});return k},});d.Mode={Current:1,Selected:2,All:3};return d});define("DS/VCXWebVisualization/VCXIManipulable",["DS/WebComponentModeler/CATWebInterface"],function(a){var b=a.singleton({interfaceName:"VCXIManipulable",required:{getAllInteractors:function(){},getActiveInteractors:function(){},interact:function(c){},}});return b});define("DS/VCXWebVisualization/VCXPaperManager",["DS/CoreEvents/Events","DS/WebApplicationBase/W3AAManager","DS/Visualization/ThreeJS_DS",],function(b,d,c){var a=d.extend({init:function(){},initialize:function(){this._PaperSize=new c.Vector2(297,210);this._Orientation=0;this._zoom=1;this._fullFrame=false;this._pan=new c.Vector2(0,0);this._panToCenter=new c.Vector2(0,0);this._viewer=null;this._zoomCBtoken=null;this._ViewBox=new c.Vector2(0,0);this._ViewBoxSize=new c.Vector2(1,1);this._ViewBoxPx=new c.Vector2(0,0);this._ViewBoxPxSize=new c.Vector2(1,1);this._zPaper=null;this._paperDiv=null;this._paperDivContent=new UWA.Element("div",{id:"divPaperSpace"})},unInitialize:function(){if(this._paperDiv&&this._paperDiv.parentNode){this._paperDiv.parentNode.removeChild(this._paperDiv)}if(this._usableAreaUpdateEvent){b.unsubscribe(this._usableAreaUpdateEvent);delete this._usableAreaUpdateEvent}if(this._onResizeCB){if(window.detachEvent){window.detachEvent("onresize",this._onResizeCB)}else{if(window.removeEventListener){window.removeEventListener("resize",this._onResizeCB,true)}}delete this._onResizeCB}if(this._viewer){var e=this._viewer.currentViewpoint;if(e&&e.control){if(this._originalPan){var f=e.control;f._pan=this._originalPan;delete this._originalPan}if(this._zoomCBtoken){f.unsubscribe(this._zoomCBtoken)}}}this._viewer=null;this._paperDivContent=null},postInitialize:function(){this._viewer=this._experienceBase.getManager("VCXContextManager").getMainViewer();if(this._viewer){var p=this;this._usableAreaUpdateEvent=b.subscribe({event:"VCX_GUI_USABLEAREA_UPDATE",},function(s){if(JSON.stringify(s)!=JSON.stringify(p._usableAreaRect)){p._usableAreaRect=s;p.updatePaper({propagateEvent:true})}});var g=this._viewer.currentViewpoint;if(g&&g.control&&this._experienceBase.getManager("VCXContextManager").getDisplayPaper()!==false){var h=g.control;this._originalPan=h._pan;var k=this;h._pan=function(s,u){h.update();if(!h._ctrlKeyPressed&&!k._touchControl){h._doPan(s.x-u.x,s.y-u.y)}else{var t=k._pan.clone();t.add(new c.Vector2(s.x-u.x,s.y-u.y));k.Pan=t}};var q=this;var f=function(s){if(s&&s.factor){if(s.evt&&s.evt.event&&s.evt.event.ctrlKey){var u=s.factor;var t={x:s.evt.event.clientX,y:s.evt.event.clientY};q.zoomPaper(u,t);s.defaultBehavior=false}}};if(h._modelEvent){this._zoomCBtoken=h._modelEvent.subscribe({event:"Zoom"},f)}}var e={position:"absolute",top:"0",left:"0",height:"320px",width:"240px",backgroundColor:"rgba(128, 128, 128, 0.0)",border:"1px solid rgba(128, 128, 128, 0.8)",boxSizing:"border-box",boxShadow:"5px 5px 5px #000",pointerEvents:"none"};var i={position:"absolute",top:"0",left:"0",height:"320px",width:"240px",backgroundColor:"rgba(215, 215, 215, 0.8)",border:"0px",pointerEvents:"none"};var m={position:"absolute",top:"0",left:"0",height:"100%",width:"100%",border:"0px",pointerEvents:"none"};if(!this._paperDiv){this._paperDiv=new UWA.Element("div",{id:"divPaperSpaceContainer",styles:m});this._paperDivContent.setStyles(e);var l=new UWA.Element("div",{id:"divPaperSpaceTop",styles:i});var o=new UWA.Element("div",{id:"divPaperSpaceLeft",styles:i});var j=new UWA.Element("div",{id:"divPaperSpaceBottom",styles:i});var r=new UWA.Element("div",{id:"divPaperSpaceRight",styles:i});this._paperDivContent.inject(this._paperDiv);l.inject(this._paperDiv);o.inject(this._paperDiv);j.inject(this._paperDiv);r.inject(this._paperDiv);this._paperDiv.inject(this._viewer.div)}}this._autoFit=true;this.updatePaper({propagateEvent:true});this._touchControl=false;var n=this;this._onResizeCB=function(){n.updatePaper({propagateEvent:true})};if(window.attachEvent){window.attachEvent("onresize",this._onResizeCB,true)}else{if(window.addEventListener){window.addEventListener("resize",this._onResizeCB,true)}}if(this._experienceBase.getManager("VCXContextManager").getDisplayPaper()===false){this.setPaperVisibility(false)}},update:function(e){if(this._frameToRender){this._frameToRender--;this._viewer.render()}},postRender:function(e){this._zPaper=null},GetZPpaper:function(f){if(this._zPaper===null){var e=new c.Vector3();var g=this.ModelToMM2(f,f.viewer.getSceneBoundingSphere().center.clone());this._zPaper=g.z;if(this._zPaper>=1){this._zPaper=0.8}if(this._zPaper<=0){this._zPaper=0.2}}return this._zPaper},ToggleAutoFit:function(){return this.AutoFit=!this.AutoFit},ToggleTouchControl:function(){this._touchControl=!this._touchControl;return this._touchControl},SetWidth:function(e){this._PaperSize.x=e},GetWidth:function(){return this._PaperSize.x},SetHeight:function(e){this._PaperSize.y=e},GetHeight:function(){return this._PaperSize.y},SetOrientation:function(e){this._Orientation=e},GetOrientation:function(){return this._Orientation},getDefaultOptions:function(){return{viewer:this._viewer,viewpoint:this._viewer.currentViewpoint}},updatePaper:function(g){var e={};if(g&&(g.viewportSize||g.fullFrame)){this._fullFrame=true;this._specificViewer=true;if(!g.viewportSize){this._viewportSize=new c.Vector2(this._viewer.div.clientWidth,this._viewer.div.clientHeight)}else{this._viewportSize=new c.Vector2(g.viewportSize.x,g.viewportSize.y)}e.top=0;e.left=0;e.width=this._viewportSize.x;e.height=this._viewportSize.y}else{this._fullFrame=false;this._specificViewer=false;this._viewportSize=new c.Vector2(this._viewer.div.clientWidth,this._viewer.div.clientHeight);if(!this._usableAreaRect){this._usableAreaRect={top:0,left:0,width:this._viewportSize.x,height:this._viewportSize.y}}e.top=this._usableAreaRect.top;e.left=this._usableAreaRect.left;e.width=this._usableAreaRect.width;e.height=this._usableAreaRect.height;if(this._autoFit){var h=this.Ratio;var f=e.height/e.width;if(this._viewportSize.y>0){if(h<f){this._zoom=(e.width*h)/this._viewportSize.y}else{this._zoom=e.height/this._viewportSize.y}}this._pan=new c.Vector2()}}this._panToCenter=new c.Vector2(e.left+(e.width-this._viewportSize.x)*0.5,e.top+(e.height-this._viewportSize.y)*0.5);this._updateCameraOffset(g);if(g&&g.propagateEvent){b.publish({event:"/VCX/Paper/PanChanged",data:{value:this.Pan,updatePaper:false,autoFit:this._autoFit}});b.publish({event:"/VCX/Paper/ZoomChanged",data:{value:this.Zoom,updatePaper:false,autoFit:this._autoFit}});this.updatePaperViz();this._frameToRender=2}},_updateViewBox:function(){var g=this.Size;var e=this._viewportSize.y/this._viewportSize.x;var f=g.y/g.x;if(f>e){this._ViewBoxSize.y=g.y;this._ViewBoxSize.x=this._ViewBoxSize.y/e;this._ViewBoxPxSize.y=this._viewportSize.y;this._ViewBoxPxSize.x=this._ViewBoxPxSize.y/f}else{this._ViewBoxSize.x=g.x;this._ViewBoxSize.y=this._ViewBoxSize.x*e;this._ViewBoxPxSize.x=this._viewportSize.x;this._ViewBoxPxSize.y=this._ViewBoxPxSize.x*f}this._ViewBoxSize.multiplyScalar(1/this.Zoom);this._ViewBox.subVectors(g,this._ViewBoxSize).multiplyScalar(0.5);this._ViewBoxPxSize.multiplyScalar(this.Zoom);this._ViewBoxPx.subVectors(this._viewportSize,this._ViewBoxPxSize).multiplyScalar(0.5);this._ViewBoxPx.add(this.Pan);this._ViewBoxPx.add(this._panToCenter)},updatePaperViz:function(){var k=document.getElementById("divPaperSpace");var j=document.getElementById("divPaperSpaceTop");var f=document.getElementById("divPaperSpaceLeft");var l=document.getElementById("divPaperSpaceRight");var m=document.getElementById("divPaperSpaceBottom");if(k!==null){var i=this._ViewBoxPx.x;var h=this._ViewBoxPx.y;var g=this._ViewBoxPxSize.x;var e=this._ViewBoxPxSize.y;k.style.left=i+"px";k.style.top=h+"px";k.style.width=(g>0?g:0)+"px";k.style.height=(e>0?e:0)+"px";j.style.left="0px";j.style.top="0px";j.style.width=(this._viewportSize.x>0?this._viewportSize.x:0)+"px";j.style.height=(h>0?h:0)+"px";f.style.left="0px";f.style.top=h+"px";f.style.width=(i>0?i:0)+"px";f.style.height=(e>0?e:0)+"px";m.style.left="0px";m.style.top=h+e+"px";m.style.width=this._viewportSize.x+"px";m.style.height=this._viewportSize.y-(h+e)+"px";l.style.left=i+g+"px";l.style.top=h+"px";l.style.width=this._viewportSize.x-(i+g)+"px";l.style.height=e+"px"}},_updateCameraOffset:function(h){this._updateViewBox();if(this._viewer){var g=this._viewer.currentViewpoint;if(g){var e=this._ViewBoxPx.x;var j=this._ViewBoxPx.y;var i=this._ViewBoxPxSize.x;var f=this._ViewBoxPxSize.y;g.setViewOffset({fullWidth:i,fullHeight:f,x:-e,y:-j,width:this._viewportSize.x,height:this._viewportSize.y})}}},MMToPixelRatio:function(f){if(!f){f=this.getDefaultOptions()}var e=this._viewportSize.y;if(f&&f.viewer&&f.viewer._zoomFactor){e*=f.viewer._zoomFactor}return e/this._ViewBoxSize.y},_GetPan:function(e){if(this._specificViewer||(e&&e.viewer&&e.viewer._isDigger)){if(!e){e=this.getDefaultOptions()}var f=new c.Vector2();if(this._specificViewer){f.add(this._ViewBoxPx)}f.sub(e.viewpoint.camera);f.sub(new c.Vector2(this._viewportSize.x,this._viewportSize.y).multiplyScalar(0.5));f.add(this._ViewBoxPxSize.clone().multiplyScalar(0.5));if(e.viewer._zoomFactor){f.multiplyScalar(e.viewer._zoomFactor)}return f}else{return new c.Vector2().addVectors(this.Pan,this._panToCenter)}},MMToPixel:function(f){var e=0;e=f*this.MMToPixelRatio();return e},MMToPixelX:function(f){var e=0;e=(f-this._ViewBox.x)*this.MMToPixelRatio();e+=this.Pan.x;e+=this._panToCenter.x;return e},MMToPixelY:function(f){var e=0;e=(f-this._ViewBox.y)*this.MMToPixelRatio();e+=this.Pan.y;e+=this._panToCenter.y;return e},MMToPixel2:function(f,g){if(!f){f=this.getDefaultOptions()}var e=new c.Vector2(0,0);e.subVectors(g,this._ViewBox).multiplyScalar(this.MMToPixelRatio(f)).add(this._GetPan(f));return e},PixelToMM:function(e){var f=0;f=e/this.MMToPixelRatio();return f},PixelToMMX:function(e){var f=0;f=(e-(this.Pan.x+this._panToCenter.x))/this.MMToPixelRatio()+this._ViewBox.x;return f},PixelToMMY:function(e){var f=0;f=(e-(this.Pan.y+this._panToCenter.y))/this.MMToPixelRatio()+this._ViewBox.y;return f},PixelToMM2:function(f,e){if(!f){f=this.getDefaultOptions()}var g=new c.Vector2(0,0);g.subVectors(e,this._GetPan(f)).multiplyScalar(1/this.MMToPixelRatio(f)).add(this._ViewBox);return g},ModelToMM2:function(h,f){var e=h.viewpoint.project(f);var i=new c.Vector2(0,0);i=this.PixelToMM2(h,e);var g=new c.Vector3(0,0,0);g.x=i.x;g.y=i.y;g.z=e.z;return g},MMToModel2:function(h,g){var j=new c.Vector2(0,0);j.x=g.x;j.y=g.y;var i=new c.Vector2(0,0);i=this.MMToPixel2(h,j);var f=new c.Vector3(0,0,0);f.x=i.x;f.y=i.y;f.z=g.z;var e=h.viewpoint.unProject(f);return e},GetMmToPxRatio:function(i){var f=new c.Vector2(0,0);var e=new c.Vector2(1,0);var h=this.MMToPixel2(i,f);var g=this.MMToPixel2(i,e);return h.distanceTo(g)},GetPaperRatio:function(h,e){var i=1;if(!e||e===null){return i}var g=new c.Vector3().addVectors(e,h.viewpoint.getUpDirection());var l=this.ModelToMM2(h,e);var k=this.ModelToMM2(h,g);var j=e.distanceTo(g);var f=l.distanceTo(k);if(f!==0){i=j/f}return i},GetModelPointFromModelPointAndPaperPosition:function(n,o,l,m){var h=this.ModelToMM2(n,o);var p=h.clone();p.x+=l.x;p.y+=l.y;var j=this.MMToModel2(n,p);if(m>0){var g=Math.min(this.Size.x,this.Size.y);var e=this.GetPaperRatio(n,o);var i=m/e;if(i<g*0.04){i=g*0.04}else{if(i>g*0.7){i=g*0.7}}var k=i*e;var f=new c.Vector3().subVectors(j,o);f.normalize().multiplyScalar(k);return new c.Vector3().addVectors(o,f)}else{return j}},setPaperVisibility:function(g){if(!this._paperDiv){return}if(g===true){this._paperDiv.style.display=""}else{if(g===false){this._paperDiv.style.display="none"}else{console.log("[VCXPaperManager::setPaperVisibility] Parameter is not a boolean. Aborting.")}}var e=this._experienceBase.getManager("VCXVisuManager").getActiveViewport();if(e){var f=e.QueryInterface("VCXIModifiable");if(f){f.OnChangePropertiesEnd();var h=f.QueryInterface("W3AISGNodeHolder");if(h){h.setSGNodeDirty(true)}}}},getPaperVisibility:function(){if(this._paperDiv){return this._paperDiv.style.display===""}return false},zoomPaper:function(j,k){var l=(1+j*0.05);var e=this._viewer.SCREEN_WIDTH*0.5;var o=this._viewer.SCREEN_HEIGHT*0.5;if(k.x>0&&k.x<this._viewer.SCREEN_WIDTH&&k.y>0&&k.y<this._viewer.SCREEN_HEIGHT){e=k.x;o=k.y}var i=(this._ViewBoxPxSize.x>0?this._ViewBoxPxSize.x:0)*0.5+this._ViewBoxPx.x;var h=(this._ViewBoxPxSize.y>0?this._ViewBoxPxSize.y:0)*0.5+this._ViewBoxPx.y;var g=l*(i-e)+e;var f=l*(h-o)+o;var m=this._pan.clone();m.add(new c.Vector2(g-i,f-h));var n=this.Zoom;this.Zoom*=l;if(n!==this.Zoom){this.Pan=m}},});Object.defineProperty(a.prototype,"Pan",{enumerable:true,get:function(){if(this._fullFrame){return new c.Vector2()}else{return this._pan}},set:function(e){if(this._pan!==e){this._pan=e;this._autoFit=false;this.updatePaper({propagateEvent:true})}}});Object.defineProperty(a.prototype,"Zoom",{enumerable:true,get:function(){if(this._fullFrame){return 1}else{return this._zoom}},set:function(e){if(this._zoom!==e){this._zoom=e;if(this._zoom<=0){this._zoom=0.01}this._autoFit=false;this.updatePaper({propagateEvent:true})}}});Object.defineProperty(a.prototype,"AutoFit",{enumerable:true,get:function(){return this._autoFit},set:function(e){this._autoFit=e;this.updatePaper({propagateEvent:true})}});Object.defineProperty(a.prototype,"Size",{enumerable:true,get:function(){var e=1;if(this._PaperSize.x){e=this._PaperSize.y/this._PaperSize.x}if(e>1&&this._Orientation){return new c.Vector2(this._PaperSize.y,this._PaperSize.x)}else{return new c.Vector2(this._PaperSize.x,this._PaperSize.y)}},});Object.defineProperty(a.prototype,"Ratio",{enumerable:true,get:function(){var e=1;if(this._PaperSize.x){e=this._PaperSize.y/this._PaperSize.x}if(e>1&&this._Orientation){return this._PaperSize.x/this._PaperSize.y}else{return this._PaperSize.y/this._PaperSize.x}},});Object.defineProperty(a.prototype,"componentType",{enumerable:true,get:function(){return"VCXPaperManager"}});return a});define("DS/VCXWebVisualization/VCXHandle",["UWA/Class","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey","DS/VCXWebKernelTools/VCXMathTools","DS/VCXWebVisibility/VCXIVisibility","DS/Visualization/GeometryHelper","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils"],function(a,c,b,e,n,m,l,f,k,g,i,j,d){var h=a.extend({init:function(p){if(!p.interactor){console.log("Needs interactor in parameters to pursue creation of handle");return}this._parentOwnerComponent=p.parentOwner;this._id=p.id;this.interactor=p.interactor;this._modelEvents=new b();this.manipulator=null;this.manipulatorTokens={};var o=this.interactor.data&&this.interactor.data.handleVisual;this.setColor(o&&o.color?o.color:this.getDefaultColor());this.setOpacity(o&&o.opacity?o.opacity:this.getDefaultOpacity());this.setSize(o&&o.size?o.size:this.getDefaultSize());this._experienceBase=this._parentOwnerComponent._experienceBase;this._viewer=this._experienceBase.getManager("VCXContextManager").getMainViewer();this.sceneGraph=this._viewer.getRootNode();this._anchor=this._generateHandleGeom(p);this._anchor.setVisibilityInTree(false);this._anchor.exludeFromBounding(true);this._anchor.handle=this;this._stayVisible=o&&typeof o.stayVisible==="boolean"?o.stayVisible:false;this.updateVisibility()},getSize:function(){if(typeof this._displaySize!=="number"){this._displaySize=this.getDefaultSize()}return this._displaySize},setSize:function(o){if(typeof o!=="number"){return false}this._displaySize=o;if(this.fixedSizeNode){this.fixedSizeNode.setRatio(this._displaySize)}return true},getDefaultSize:function(){return 16},getDefaultColor:function(){return new j.Color("#FFFFFF")},setColor:function(o){if(!(o instanceof j.Color)){return false}this._color=o;if(this.pointMat){this.pointMat.color=this._color}return true},getColor:function(){if(!(this._color instanceof j.Color)){this._color=this.getDefaultColor()}return this._color},getDefaultOpacity:function(){return 1},setOpacity:function(o){if(typeof o!=="number"){console.log("Issue with assignment of handle opacity");return}this.opacity=o;if(this.pointMat){this.pointMat.opacity=this.opacity}return true},getOpacity:function(){if(typeof this.opacity!=="number"){this.opacity=this.getDefaultOpacity()}return this.opacity},setPosition:function(o,q,p){this._anchor.setMatrix(new j.Matrix4().setPosition(new j.Vector3(o,q,p)))},setMatrix:function(o){this._anchor.setMatrix(o)},StayVisible:function(o){if(typeof o==="boolean"){this._stayVisible=o}},remove:function(){this.sceneGraph.remove(this._anchor);this._anchor=null;this._parentOwnerComponent=null;this._id=null;this.interactor=null;this._modelEvents=null;this.manipulator=null;this.manipulatorTokens=null;this.sceneGraph=null},_generateHandleGeom:function(q){var p=new g(q.name);this.isPreactivated=false;this.isManipulated=false;var y=q.noz!==undefined?q.noz:true;var s=this;var r=new k();var t={width:1,height:1,fill:true,fillColor:null,noEdge:true,layerNb:y?1:0};var w=r.createRectangle(t);var x=d.getWebappsAssetUrl("Robot","");var v=new j.ImageUtils.loadTexture(x+"models/textures/Point.png",undefined,null,null,j.ImageUtils.crossOriginPolicy);v.flipY=false;v.minFilter=j.LinearMipMapLinearFilter;this.pointMat=new j.MeshBasicMaterial({map:v,side:j.DoubleSide,transparent:true,alphaTest:0.05,enableClipPlanes:false,opacity:this.opacity});this.pointMat.force=true;var u=i.createMeshNode(w,this.pointMat);u.setShadow(false);u.setFrustumCulled(false);u.name="diskNode";u.excludeFromCSO(true);u.excludeFromHighlight(true,true);u.setNoHighlightNoZ(true);u.setMatrix(new j.Matrix4().setPosition(new j.Vector3(-0.5,-0.5,0)));this.diskNode=u;var o={position:this.position,name:"billBoard1",type:"Spherical"};this.billBoardNode=new e(o);this.billBoardNode.add(u);this.fixedSizeNode=new n({name:"fixedSizeNode3D",ratio:this._displaySize});this.fixedSizeNode.add(this.billBoardNode);p.add(this.fixedSizeNode);this.sceneGraph.add(p);return p},getHandleGeom:function(){return this._anchor},updateManipulatorCallbacks:function(o){if(o===this.manipulator){return}if(this.manipulator&&this.manipulatorTokens){var q=Object.keys(this.manipulatorTokens);for(var s=0;s<q.length;++s){var r=q[s];var p=this.manipulatorTokens[r];this.manipulator.unsubscribe(p)}this.manipulatorTokens={};this.manipulator=null}this.manipulator=o},_createManipulatorCallbacks:function(o){if(!this._anchor){console.log("Manipulable node not found, abort.");return}var p=this;this.manipulatorTokens.tokenBeginManipulate=o.subscribe("BeginManipulate",function(q){p.pointMat.color=new j.Color("#1B6E9C");q.viewer.setCursor("-webkit-grabbing");p.isManipulated=true;p.fixedSizeNode.setRatio(1.2*p._displaySize);if(p._loadingOption&&p._loadingOption.isShowPickerDebug()){p._debugHTMLAcquired()}p._handleInitPosition=q.intersection.position;q.handleID=p._id;p._modelEvents.publish({event:"BeginManipulate",data:q,context:this})});this.manipulatorTokens.tokenManipulate=o.subscribe("Manipulate",function(q){if(p._loadingOption&&p._loadingOption.isShowPickerDebug()){p._debugHTMLAcquired()}q.handleID=p._id;p._modelEvents.publish({event:"Manipulate",data:q,context:this})});this.manipulatorTokens.tokenEndManipulate=o.subscribe("EndManipulate",function(q){q.handleID=p._id;p._modelEvents.publish({event:"EndManipulate",data:q,context:this});if(!p.isPreactivated){q.viewer.setCursor("auto");p.pointMat.color=p.color;p.fixedSizeNode.setRatio(p._displaySize)}else{q.viewer.setCursor("pointer");p.pointMat.color=new j.Color("#A1D9ED")}p.isManipulated=false});this.manipulatorTokens.tokenBeginPreactivate=o.subscribe("BeginPreactivate",function(q){p._modelEvents.publish({event:"BeginPreactivate",data:q,context:this});p.isPreactivated=true;if(!p.isManipulated){p.pointMat.color=new j.Color("#A1D9ED")}p.fixedSizeNode.setRatio(1.2*p._displaySize)});this.manipulatorTokens.tokenPreactivate=o.subscribe("Preactivate",function(q){p._modelEvents.publish({event:"Preactivate",data:q,context:this})});this.manipulatorTokens.tokenEndPreactivate=o.subscribe("EndPreactivate",function(q){p._modelEvents.publish({event:"EndPreactivate",data:q,context:this});p.isPreactivated=false;if(!p.isManipulated){p.pointMat.color=p.color;p.fixedSizeNode.setRatio(p._displaySize)}})},Show:function(){if(this.fixedSizeNode){this.fixedSizeNode.setRatio(this._displaySize)}this._anchor.setVisibility(true)},Hide:function(o){if(o||this._stayVisible===false){if(this.fixedSizeNode){this.fixedSizeNode.setRatio(1)}this._anchor.setVisibility(false)}},IsVisible:function(){return this._anchor.visible},isDisplayed:function(){return this.IsVisible()&&this.getOpacity()>0},updateVisibility:function(){var s=this._experienceBase.getManager("VCXSelectionManager");var v=false;var r=this._parentOwnerComponent;var u=r.GetID();var o=r.QueryInterface("VCXIVisibility");if(o&&o.GetVisibility()===f.EVisState.Hidden){if(this.isDisplayed()){this.Hide(true)}return}var p=s.GetComponentsFromSelection("HSO");var t=p.map(function(x){return x.GetID()});if(t.includes(u)){v=true}else{var w=s.GetComponentsFromSelection("PSO");var q=w.map(function(x){return x.GetID()});if(q.includes(u)){v=true}}if(v||this._stayVisible){this.Show()}else{this.Hide()}},getMatrixInWCS:function(){var p=this._anchor.getMatrix();var o=this._anchor.getMatrixInWCS&&this._anchor.getMatrixInWCS();return this._anchor.getMatrix()},_debugHTMLAcquired:function(){var q=this._experienceBase.getManager("VCXExperience");if(!q.debugTools){return}var s='<div style="width:220px;padding:5px;"><div style="margin:5px;width:210px" align="center"><b>Anchor moving</b></div>';if(this._experienceBase.getManager("VCXContextManager").isTouchCompliantDevice()){s+='<div style="margin:5px;" align="left">Touch compliante: size increase</div>'}s+='<div style="width:200px;border:1px solid black; margin:5px;padding:5px;">';var p=q.debugTools.getImgCoord();s+="<div>";var r=new j.Vector3().getPositionFromMatrix(this._initialMatrixInWCS);var o=new j.Vector3().getPositionFromMatrix(this._anchor.getMatrix());s+="Initial Position<br>";s+=p+r.x.toFixed(2)+"/"+r.y.toFixed(2)+"/"+r.z.toFixed(2)+"<br>";s+="Current Position<br>";s+=p+o.x.toFixed(2)+"/"+o.y.toFixed(2)+"/"+o.z.toFixed(2)+"<br>";s+="</div>";s+="</div>";s+="</div>";this._experienceBase.getManager("VCXExperience").debugTools.updateImmersiveConsole(s)},});return h});define("DS/VCXWebVisualization/VCXPickerCanonics",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/VCXWebKernelTools/VCXMathTools"],function(b,c,d){var a=b.extend({init:function(){this._picked=new Map();this._axisInScene=new Map();this._circleCentersInScene=new Map();this._pixelsEpsilon=6;this._bboxes=new Map()},clear:function(){this._picked.clear();this._bboxes.clear();this._axisInScene.clear();this._circleCentersInScene.clear()},_getGeometry:function(f){if(!f||!f.externalPath.length){return null}var g=f.externalPath.length;var e=g?f.externalPath[g-1]:null;while(e){e=e.children.length?e.children[0]:null;if(e){if("Mesh3D"===e.getNodeType()){return e.mesh3js.geometry}}}return null},_makeKey:function(e,g){var f=Math.log2(e);return f*1000000+g},_computeBbox:function(j,p,h,r){if(!p){return null}var s=3*h[j];var n=r[s],e=r[s];var f=r[s+1],t=r[s+1];var u=r[s+2],q=r[s+2];var o=new c.Vector3();for(var l=1;l<p;++l){var g=3*h[j+l];o.x=r[g];o.y=r[g+1];o.z=r[g+2];if(e>o.x){e=o.x}else{if(n<o.x){n=o.x}}if(t>o.y){t=o.y}else{if(f<o.y){f=o.y}}if(q>o.z){q=o.z}else{if(u<o.z){u=o.z}}}var m=Math.max(Math.max(n-e),f-t,u-q);var v=m*0.1;return new c.Box3(new c.Vector3(e-v,t-v,q-v),new c.Vector3(n+v,f+v,u+v))},_getVerticesForLinearSystem:function(o,h,t,l,w,y,g,q){var f=[];if(!g||!w){return f}var v=3*l[o+h];var e=new c.Vector3(w[v],w[v+1],w[v+2]);var x=y?new c.Vector3(y[v],y[v+1],y[v+2]):new c.Vector3(0,0,0);if(x.x===0&&x.y===0&&x.z===0){if(q){return f}}else{x.normalize()}if(g===1){return f}f.push({point:e,normal:x});for(var p=h+1;p<t;p+=3){var s=3*l[o+p];var r=new c.Vector3(w[s],w[s+1],w[s+2]);var u=y?new c.Vector3(y[s],y[s+1],y[s+2]):x;if(u.x===0&&u.y===0&&u.z===0){if(q){return f}}else{u.normalize()}for(var m=0;m<f.length;++m){if(Math.abs(f[m].normal.dot(u))>1-0.1){break}}if(m!==f.length){continue}f.push({point:r,normal:u});if(f.length===g){break}}return f.length===g?f:null},_getPixelsDistanceToCircle:function(h,f,k,m,l,i){if(!f||!h||!k||!l||!m||!i||!i.currentViewpoint){return null}var j=new c.Plane().setFromNormalAndCoplanarPoint(k,f);var n=j.intersectLine(new c.Line3(m,l));if(!n){return null}var g=new c.Vector3().subVectors(n,f).normalize();var o=new c.Vector3(f.x+h*g.x,f.y+h*g.y,f.z+h*g.z);var e=i.currentViewpoint.project(o);e.z=0;var p=i.currentViewpoint.project(l);p.z=0;return{pixels:e.distanceTo(p),closestPoint:o}},_getPixelsDistanceToLine:function(k,h,m,l,j){if(!k||!h||!l||!m||!j||!j.currentViewpoint){return null}var p=d.getNearestPointsBetween2Lines(k,h,m,new c.Vector3().subVectors(l,m));var n=p.p1;var e=j.currentViewpoint.project(n);e.z=0;var o=j.currentViewpoint.project(new c.Vector3(n.x+h.x,n.y+h.y,n.z+h.z));o.z=0;var f=j.currentViewpoint.project(l);f.z=0;var g=new c.Vector3(o.x-e.x,o.y-e.y,o.z-e.z);g.z=0;var i=d.getPointProjectionOnLine(e,g,f);return{pixels:i.distanceTo(f),closestPoint:n}},_getPixelsDistanceToPoint:function(h,f,g,i){if(!h||!f||!g||!i||!i.currentViewpoint){return 1000000000}var e=i.currentViewpoint.project(h);e.z=0;var j=i.currentViewpoint.project(g);j.z=0;return e.distanceTo(j)},_isPoint:function(g,i,f,h){if(count!==3){return null}var e=3*f[g];return{point:new c.Vector3(h[e],h[e+1],h[e+2]),type:a.GeometricPrimitive.Point}},_isEdge:function(t,q,w,m,j){var o=3*w[t];var n=3*w[t+1];var r=new c.Vector3(m[o],m[o+1],m[o+2]);var p=new c.Vector3(m[n],m[n+1],m[n+2]);var l=new c.Vector3();var h=new c.Vector3();var g=new c.Vector3();var s=Math.cos(j);for(var v=2;v<q;++v){var u=3*w[t+v];l.x=m[u];l.y=m[u+1];l.z=m[u+2];if(l.equals(r)||l.equals(p)){continue}h.x=r.x-l.x;h.y=r.y-l.y;h.z=r.z-l.z;h.normalize();g.x=p.x-l.x;g.y=p.y-l.y;g.z=p.z-l.z;g.normalize();var f=h.dot(g);if(f<s){return null}var e=l.distanceToSquared(r);var x=l.distanceToSquared(p);if(e>=x){p=l}else{if(x>=e){r=l}}}return{extremity1:r,extremity2:p,normal:h,type:a.GeometricPrimitive.Line}},_isCircle:function(w,t,A,r,D){var q=this._getVerticesForLinearSystem(w,0,t,A,r,null,4,false);if(!q||q.length!==4){return null}var n=q[0].point,m=q[1].point;var j=q[2].point,f=q[3].point;var g=new c.Plane();g.setFromCoplanarPoints(n,m,j);var l=new c.Vector3().subVectors(m,n);var h=new c.Vector3().subVectors(j,n);var s=l.clone().cross(h).normalize();l.subVectors(m,n).cross(s).normalize();h.subVectors(f,j).cross(s).normalize();var E=d.getNearestPointsBetween2Lines(new c.Vector3().addVectors(n,m).multiplyScalar(0.5),l,new c.Vector3().addVectors(j,f).multiplyScalar(0.5),h);var u=new c.Vector3().addVectors(E.p1,E.p2).multiplyScalar(0.5);var e=D*D;var o=n.distanceTo(u);var x=((o-D)*(o-D)),z=((o+D)*(o+D));var p=new c.Vector3();for(var y=3;y<t;++y){var v=3*A[w+y];p.x=r[v];p.y=r[v+1];p.z=r[v+2];var B=p.distanceToSquared(u);if(B<x||B>z){return null}}return{center:u,radius:o,normal:s,type:a.GeometricPrimitive.Circle}},_isPlane:function(j,o,h,r,u,t){if(!r||!u){return null}var s=3*h[j];var p=new c.Vector3(r[s],r[s+1],r[s+2]);var q=new c.Vector3(u[s],u[s+1],u[s+2]);var n=new c.Plane();n.setFromNormalAndCoplanarPoint(q,p);var f=t*t;var m=new c.Vector3();for(var l=0;l<o;++l){var g=3*h[j+l];m.x=r[g];m.y=r[g+1];m.z=r[g+2];var e=n.projectPoint(m).distanceToSquared(m);if(e>f){return null}}return{origin:p,normal:q,type:a.GeometricPrimitive.Plane}},_isCylinder:function(o,K,U,E,J,L){if(!E||!J){return null}var h=this._getVerticesForLinearSystem(o,0,K,U,E,J,2,true);if(!h||h.length!==2){return null}var w=h[0].point,f=h[0].normal;var u=h[1].point,e=h[1].normal;var z=f.clone().cross(e);var p=d.getNearestPointsBetween2Lines(w,f,u,e);var t=new c.Vector3().addVectors(p.p1,p.p2).multiplyScalar(0.5);var m=w.distanceTo(p.p1);var j=new c.Vector3();for(var Q=1;Q<K;++Q){h=this._getVerticesForLinearSystem(o,Q,K,U,E,J,2,true);if(!h||h.length!==2){break}var O=h[0].point,B=h[0].normal;var M=h[1].point,A=h[1].normal;z.add(B.clone().cross(A));var F=d.getNearestPointsBetween2Lines(O,B,M,A);m+=O.distanceTo(F.p1);t.add(j.addVectors(F.p1,F.p2).multiplyScalar(0.5))}t.divideScalar(Q);m/=Q;z.normalize();var T=d.getPointProjectionOnLine(t,z,w);var S=T.clone();var D=m-L,l=m+L;var G=D*D,v=l*l;var n=new c.Vector3();var y=new c.Vector3(),x=new c.Vector3(),j=new c.Vector3();for(var Q=0;Q<K;++Q){var N=3*U[o+Q];n.x=E[N];n.y=E[N+1];n.z=E[N+2];var r=d.getPointProjectionOnLine(t,z,n);j.x=n.x-r.x;j.y=n.y-r.y;j.z=n.z-r.z;j.normalize();if(Math.abs(j.dot(z))>0.001){return null}var g=n.distanceToSquared(r);if(g<G||g>v){return null}y.subVectors(T,r);x.subVectors(S,r);if(y.dot(x)<0){continue}var s=r.distanceToSquared(T);var q=r.distanceToSquared(S);if(s>=q){S=r}else{if(q>=s){T=r}}}t=new c.Vector3().addVectors(T,S).multiplyScalar(0.5);return{center:t,radius:m,normal:z,point1:T,point2:S,type:a.GeometricPrimitive.Cylinder}},_isCone:function(I,y,K,u,L,Q){if(!u||!L){return null}var s=this._getVerticesForLinearSystem(I,0,y,K,u,L,3,true);if(!s||s.length!==3){return null}var n=s[0].point,D=s[0].normal;var l=s[1].point,C=s[1].normal;var h=s[2].point,B=s[2].normal;var v=new c.Matrix4().set(D.x,D.y,D.z,0,C.x,C.y,C.z,0,B.x,B.y,B.z,0,0,0,0,1);if(v.determinant()===0){return null}var j=new c.Vector3(D.x*n.x+D.y*n.y+D.z*n.z,C.x*l.x+C.y*l.y+C.z*l.z,B.x*h.x+B.y*h.y+B.z*h.z);var q=j.applyMatrix4(new c.Matrix4().getInverse(v));var F=new c.Vector3().subVectors(q,n).cross(D);var E=new c.Vector3().subVectors(q,l).cross(C);var f=F.clone().cross(E);var r=new c.Vector3(),t=new c.Vector3(),g=new c.Vector3();for(J=2;J<y;++J){var G=3*K[I+J];r.x=u[G];r.y=u[G+1];r.z=u[G+2];t.x=L[G];t.y=L[G+1];t.z=L[G+2];f.add(F.clone().cross(g.subVectors(q,r).cross(t)))}f.normalize();if(f.dot(new c.Vector3().subVectors(n,q))<0){f.negate()}if(Math.abs(D.dot(f))<0.001){return null}var p=new c.Vector3(),m=new c.Vector3();var z=d.getPointProjectionOnLine(q,f,n),x=z.clone();var w=Math.atan(z.distanceTo(n)/z.distanceTo(q));var o=0;for(var J=0;J<y;++J){var G=3*K[I+J];r.x=u[G],r.y=u[G+1],r.z=u[G+2];var A=d.getPointProjectionOnLine(q,f,r);o+=Math.atan(A.distanceTo(r)/A.distanceTo(q));if(p.subVectors(z,A).dot(m.subVectors(x,A))<0){continue}var e=A.distanceToSquared(z);var O=A.distanceToSquared(x);if(e>=O){x=A}else{if(O>=e){z=A}}}o/=J;if(Math.abs(w-o)>0.001){return null}return{normal:f,apex:q,semiAngle:o,point1:z,point2:x,type:a.GeometricPrimitive.Cone}},_isSphere:function(z,r,B,q,E,G){if(!q||!E){return null}var o=this._getVerticesForLinearSystem(z,0,r,B,q,E,2,true);if(!o||o.length!==2){return null}var l=o[0].point,v=o[0].normal;var j=o[1].point,u=o[1].normal;var H=d.getNearestPointsBetween2Lines(l,v,j,u);var w=new c.Vector3().addVectors(H.p1,H.p2).multiplyScalar(0.5);var h=new c.Vector3();for(var A=1;A<r;++A){o=this._getVerticesForLinearSystem(z,A,r,B,q,E,2,true);if(!o||o.length!==2){break}var g=o[0].point,t=o[0].normal;var f=o[1].point,s=o[1].normal;H=d.getNearestPointsBetween2Lines(g,t,f,s);w.add(h.addVectors(H.p1,H.p2).multiplyScalar(0.5))}w.divideScalar(A);var e=G*G;var m=l.distanceTo(w);var D=(m-G),F=(m+G);var n=new c.Vector3(),p=new c.Vector3();for(var A=1;A<r;++A){var y=3*B[z+A];n.x=q[y];n.y=q[y+1];n.z=q[y+2];m+=n.distanceTo(w);p.x=E[y];p.y=E[y+1];p.z=E[y+2];p.normalize();h.subVectors(n,w);h.normalize();var x=p.dot(h);if(Math.abs(x)<1-0.001){return null}}m/=A;if(m<D||m>F){return null}return{center:w,radius:m,type:a.GeometricPrimitive.Sphere}},findPrimitiveFromBuffers:function(g,r){var i=g.start;var k=g.count;var h=g.group.geometry.vertexIndexArray;var m=g.group.geometry.vertexPositionArray;var q=g.group.geometry.vertexNormalArray;if(r&a.GeometricPrimitive.Point){var o=this._isPoint(i,k,h,m);if(o){return o}}if(r&a.GeometricPrimitive.Line){var p=this._isEdge(i,k,h,m,Math.PI*0.001);if(p){return p}}if(r&a.GeometricPrimitive.Circle){var e=this._isCircle(i,k,h,m,0.001);if(e){return e}}if(r&a.GeometricPrimitive.Plane){var j=this._isPlane(i,k,h,m,q,0.001);if(j){return j}}if(r&a.GeometricPrimitive.Cylinder){var n=this._isCylinder(i,k,h,m,q,0.001);if(n){return n}}if(r&a.GeometricPrimitive.Cone){var l=this._isCone(i,k,h,m,q,0.001);if(l){return l}}if(r&a.GeometricPrimitive.Sphere){var f=this._isSphere(i,k,h,m,q,0.001);if(f){return f}}return null},pick:function(x,al){if(!x){return}if(al===a.Canonic.None){return}var ae=x.viewer;if(!ae||!ae.currentViewpoint){return}var ao=x.modifiable?x.modifiable.QueryInterface("W3AISGNodeHolder"):null;var ak=ao?ao.getPathElement():null;var am=ak?ak.getWorldMatrix():new c.Matrix4();if(!am){am=new c.Matrix4()}var S=x.localPosition;var D=x.localNormal;var ar=x.globalPosition;var ap=ae.currentViewpoint.getEyePosition();x.canonics=[];var s=0;if(al&(a.Canonic.Point)){s|=a.GeometricPrimitive.Point}if(al&(a.Canonic.Line|a.Canonic.EdgeExtremity)){s|=a.GeometricPrimitive.Line}if(al&(a.Canonic.Circle|a.Canonic.CircleCenter)){s|=a.GeometricPrimitive.Circle}if(al&(a.Canonic.Plane)){s|=a.GeometricPrimitive.Plane}if(al&(a.Canonic.Cylinder|a.Canonic.Circle|a.Canonic.CircleCenter|a.Canonic.PointOnAxis)){s|=a.GeometricPrimitive.Cylinder}if(al&(a.Canonic.Cone|a.Canonic.Circle|a.Canonic.CircleCenter|a.Canonic.PointOnAxis)){s|=a.GeometricPrimitive.Cone}if(al&(a.Canonic.Sphere)){s|=a.GeometricPrimitive.Sphere}var y=this._getGeometry(ak);var af=y?y.boundingSphere:null;var aa=y?y.length:0;for(var z=0;z<aa;++z){var p=y[z]?y[z].drawingGroups:null;var au=p?p.length:0;for(var B=0;B<au;B++){var ad=p[B];if(!ad){continue}var Q=ad.primitives.length;for(var V=0;V<Q;V++){var E=ad.primitives[V];if(!E){continue}var Y=(""+E.cgmId)+("i0"+E.start);var L=this._bboxes.get(Y);if(!L){L=this._computeBbox(E.start,E.count,E.group.geometry.vertexIndexArray,E.group.geometry.vertexPositionArray);this._bboxes.set(Y,L)}if(!L||!L.containsPoint(S)){continue}var aw=this.findPrimitiveFromBuffers(E,s);if(!aw){continue}if(aw.type&a.GeometricPrimitive.Point){if(al&a.Canonic.Point){var l=aw.point.clone().applyMatrix4(am);this._picked.set(this._makeKey(a.Canonic.Point,ap.distanceToSquared(ar)),{type:a.Canonic.Point,point:l,id:Y,pathElement:ak})}continue}if(aw.type&a.GeometricPrimitive.Line){var q=aw;var I=q.extremity1.clone().applyMatrix4(am);var F=q.extremity2.clone().applyMatrix4(am);var n=q.normal.clone().transformDirection(am);var J=this._getPixelsDistanceToLine(I,new c.Vector3().subVectors(F,I),ap,ar,ae);var r=J?J.closestPoint:null;var aq=J?J.pixels:1000000000;if(!r||aq>this._pixelsEpsilon||new c.Vector3().subVectors(I,r).dot(new c.Vector3().subVectors(F,r))>0){continue}if(al&a.Canonic.Line){this._picked.set(this._makeKey(a.Canonic.Line,ap.distanceToSquared(r)),{type:a.Canonic.Line,point:r,extremity1:I,extremity2:F,normal:n,id:Y,pathElement:ak})}if(al&a.Canonic.EdgeExtremity){if(this._getPixelsDistanceToPoint(I,ap,ar,ae)<this._pixelsEpsilon){this._picked.set(this._makeKey(a.Canonic.EdgeExtremity,ap.distanceToSquared(I)),{type:a.Canonic.EdgeExtremity,point:I,extremity1:I,extremity2:F,id:Y,pathElement:ak})}else{if(this._getPixelsDistanceToPoint(F,ap,ar,ae)<this._pixelsEpsilon){this._picked.set(this._makeKey(a.Canonic.EdgeExtremity,ap.distanceToSquared(F)),{type:a.Canonic.EdgeExtremity,point:F,extremity1:I,extremity2:F,id:Y,pathElement:ak})}}}continue}if(aw.type&a.GeometricPrimitive.Circle){var K=aw;var u=K.center.clone().applyMatrix4(am);var k=K.radius;var w=K.normal.clone().transformDirection(am);if(al&(a.Canonic.PointOnAxis)){if(!this._axisInScene.has(Y)){this._axisInScene.set(Y,{radius:k,center:u,normal:w,id:Y,pathElement:ak})}}if(al&(a.Canonic.CircleCenter)){if(!this._circleCentersInScene.has(Y)){this._circleCentersInScene.set(Y,{radius:k,center:u,normal:w,id:Y,pathElement:ak})}}var J=this._getPixelsDistanceToCircle(k,u,w,ap,ar,ae);var r=J?J.closestPoint:null;var aq=J?J.pixels:1000000000;if(!r||aq>this._pixelsEpsilon){continue}if(al&a.Canonic.Circle){this._picked.set(this._makeKey(a.Canonic.Circle,ap.distanceToSquared(u)),{type:a.Canonic.Circle,point:r,radius:k,center:u,normal:w,id:Y,pathElement:ak})}continue}if(aw.type&a.GeometricPrimitive.Plane){var U=aw;if(d.isOnPlane(S,U.origin,U.normal,0.01)&&Math.abs(D.dot(U.normal))>(1-0.01)){var m=U.origin.clone().applyMatrix4(am);var n=U.normal.clone().transformDirection(am);if(al&a.Canonic.Plane){var U=new c.Plane().setFromNormalAndCoplanarPoint(n,m);var r=U.projectPoint(ar);this._picked.set(this._makeKey(a.Canonic.Plane,ap.distanceToSquared(m)),{type:a.Canonic.Plane,point:r,origin:r,normal:n,width:af.radius,height:af.radius,id:Y,pathElement:ak})}continue}}if(aw.type&a.GeometricPrimitive.Cylinder){var T=aw;if(d.isOnCylinder(S,T.center,T.point1.distanceTo(T.point2),T.radius,T.normal,T.radius*0.1)){var k=T.radius;var u=T.center.clone().applyMatrix4(am);var I=T.point1.clone().applyMatrix4(am);var F=T.point2.clone().applyMatrix4(am);var w=T.normal.clone().transformDirection(am).normalize();var r=I.distanceTo(F);if(al&(a.Canonic.PointOnAxis)){if(!this._axisInScene.has(Y)){var ab=new c.Vector3(u.x+0.5*r*w.x,u.y+0.5*r*w.y,u.z+0.5*r*w.z);this._axisInScene.set(Y,{radius:k,center:ab,normal:w,id:Y,pathElement:ak})}if(!this._axisInScene.has(Y+"_")){var Z=new c.Vector3(u.x-0.5*r*w.x,u.y-0.5*r*w.y,u.z-0.5*r*w.z);this._axisInScene.set(Y+"_",{radius:k,center:Z,normal:w,id:Y,pathElement:ak})}}if(al&(a.Canonic.CircleCenter)){if(!this._circleCentersInScene.has(Y)){var ab=new c.Vector3(u.x+0.5*r*w.x,u.y+0.5*r*w.y,u.z+0.5*r*w.z);this._circleCentersInScene.set(Y,{radius:k,center:ab,normal:w,id:Y,pathElement:ak})}if(!this._circleCentersInScene.has(Y+"_")){var Z=new c.Vector3(u.x-0.5*r*w.x,u.y-0.5*r*w.y,u.z-0.5*r*w.z);this._circleCentersInScene.set(Y+"_",{radius:k,center:Z,normal:w,id:Y,pathElement:ak})}}if(al&a.Canonic.Circle){var X=new c.Vector3().subVectors(I,u);var h=this._getPixelsDistanceToCircle(k,I,X,ap,ar,ae);var av=h?h.closestPoint:null;var f=h?h.pixels:1000000000;if(av&&f<this._pixelsEpsilon){this._picked.set(this._makeKey(a.Canonic.Circle,ap.distanceToSquared(av)),{type:a.Canonic.Circle,point:av,center:I,radius:k,normal:X,id:Y,pathElement:ak})}var W=new c.Vector3().subVectors(F,u);var g=this._getPixelsDistanceToCircle(k,F,W,ap,ar,ae);var at=g?g.closestPoint:null;var e=g?g.pixels:1000000000;if(at&&e<this._pixelsEpsilon){this._picked.set(this._makeKey(a.Canonic.Circle,ap.distanceToSquared(at)),{type:a.Canonic.Circle,point:at,center:F,radius:k,normal:W,id:Y+"_",pathElement:ak})}}if(al&a.Canonic.Cylinder){this._picked.set(this._makeKey(a.Canonic.Cylinder,ap.distanceToSquared(u)),{type:a.Canonic.Cylinder,point:ar,radius:k,center:u,normal:w,length:r,id:Y,pathElement:ak})}continue}}if(aw.type&a.GeometricPrimitive.Cone){var aj=aw;if(d.isOnCone(S,aj.apex,aj.semiAngle,Math.max(aj.apex.distanceTo(aj.point1),aj.apex.distanceTo(aj.point2)),aj.normal,0.1)){var I=aj.point1.clone().applyMatrix4(am);var F=aj.point2.clone().applyMatrix4(am);var ac=aj.apex.clone().applyMatrix4(am);var w=aj.normal.clone().transformDirection(am).normalize();var G=aj.semiAngle,o=Math.tan(G);var av=ac.distanceTo(I);var ab=new c.Vector3(ac.x+av*w.x,ac.y+av*w.y,ac.z+av*w.z);var ai=av*o;var at=ac.distanceTo(F);var Z=new c.Vector3(ac.x+at*w.x,ac.y+at*w.y,ac.z+at*w.z);var ag=at*o;var r=Math.max(av,at);var k=Math.max(ai,ag);var t=ai>ag?ab:Z;var u=new c.Vector3(ac.x+0.5*r*w.x,ac.y+0.5*r*w.y,ac.z+0.5*r*w.z);if(al&(a.Canonic.PointOnAxis)){if(!this._axisInScene.has(Y)){this._axisInScene.set(Y,{normal:w,center:ab,radius:ai,pathElement:ak})}if(!this._axisInScene.has(Y+"_")){this._axisInScene.set(Y+"_",{normal:w,center:Z,radius:ag,pathElement:ak})}}if(al&(a.Canonic.CircleCenter)){if(!this._circleCentersInScene.has(Y)){this._circleCentersInScene.set(Y,{radius:ai,center:ab,normal:w})}if(!this._circleCentersInScene.has(Y+"_")){this._circleCentersInScene.set(Y+"_",{radius:ag,center:Z,normal:w})}}if(al&a.Canonic.Circle){var X=new c.Vector3().subVectors(I,u);var h=this._getPixelsDistanceToCircle(k,I,X,ap,ar,ae);var av=h?h.closestPoint:null;var f=h?h.pixels:1000000000;if(av&&f<this._pixelsEpsilon){this._picked.set(this._makeKey(a.Canonic.Circle,ap.distanceToSquared(I)),{type:a.Canonic.Circle,point:av,center:I,radius:ai,normal:X,id:Y,pathElement:ak})}var W=new c.Vector3().subVectors(F,u);var g=this._getPixelsDistanceToCircle(k,F,W,ap,ar,ae);var at=g?g.closestPoint:null;var e=g?g.pixels:1000000000;if(at&&e<this._pixelsEpsilon){this._picked.set(this._makeKey(a.Canonic.Circle,ap.distanceToSquared(F)),{type:a.Canonic.Circle,point:at,center:F,radius:ag,normal:W,id:Y+"_",pathElement:ak})}}if(al&a.Canonic.Cone){this._picked.set(this._makeKey(a.Canonic.Cone,ap.distanceToSquared(u)),{type:a.Canonic.Cone,point:ar,bottomRadius:k,topRadius:0,length:r,center:u,bottomCenterPoint:t,topCenterPoint:ac,normal:w,id:Y,pathElement:ak})}continue}}if(aw.type&a.GeometricPrimitive.Sphere){var M=aw;if(d.isOnSphere(S,M.center,M.radius,M.radius*0.01)){var u=M.center.clone().applyMatrix4(am);var k=M.radius;if(al&a.Canonic.Sphere){this._picked.set(this._makeKey(a.Canonic.Sphere,ap.distanceToSquared(u)),{type:a.Canonic.Sphere,point:ar,radius:k,center:u,id:Y,pathElement:ak})}continue}}}}}if(al&a.Canonic.PointOnAxis){var j=this;this._axisInScene.forEach(function(C,O){var A=j._getPixelsDistanceToLine(C.center,C.normal,ap,ar,ae);var N=A?A.closestPoint:null;var i=A?A.pixels:1000000000;if(N&&i<j._pixelsEpsilon){j._picked.set(j._makeKey(a.Canonic.PointOnAxis,C.center.distanceToSquared(N)),{type:a.Canonic.PointOnAxis,point:N,center:C.center,radius:C.radius,normal:C.normal,id:C.id,pathElement:C.pathElement})}})}if(al&a.Canonic.CircleCenter){var j=this;this._circleCentersInScene.forEach(function(A,C){var i=j._getPixelsDistanceToPoint(A.center,ap,ar,ae);if(i<j._pixelsEpsilon){j._picked.set(j._makeKey(a.Canonic.CircleCenter,A.center.distanceToSquared(ap)),{type:a.Canonic.CircleCenter,point:A.center,center:A.center,radius:A.radius,normal:A.normal,id:A.id,pathElement:A.pathElement})}})}var v=[];this._picked.forEach(function ah(A,i,C){v.push(i)});v.sort();for(var an=0;an<v.length;++an){x.canonics.push(this._picked.get(v[an]))}this._picked.clear()}});a.GeometricPrimitive={None:0,Point:1<<0,Line:1<<1,Circle:1<<2,Plane:1<<3,Cylinder:1<<4,Cone:1<<5,Sphere:1<<6};a.Canonic={None:0,Point:1<<0,CircleCenter:1<<1,EdgeExtremity:1<<2,PointOnAxis:1<<3,Line:1<<4,Circle:1<<5,Plane:1<<6,Cylinder:1<<7,Cone:1<<8,Sphere:1<<9};return a});define("DS/VCXWebVisualization/VCXVisuManager",["DS/WebApplicationBase/W3AAManager","DS/VCXWebKernelTools/VCXEnums","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Plugins/UserRenderList","DS/Effects/SpatialOccupationEffect","DS/VCXWebVisibility/VCXIVisibility","DS/Visualization/SceneGraphUtils","DS/VCXWebVisualization/VCXPickerCanonics"],function(f,g,c,i,h,b,d,a,e){var j=f.extend({init:function(){this._onIdleSSAOCB=null;this._isInTransition=false;this._CameraControlsViewpoint=false},postInitialize:function(){this._timerWithNoRefresh=0;this._idle=false;this._idleCBs=[];this._idleIndex=1;this._activeViewport=null;this._bUpdateViewport=true;this.CameraControlsViewpoint=false;this._verticalFrame=new i.Matrix4();this._inverseVerticalFrame=new i.Matrix4();this._experienceBase.getManager("VCXContextManager").getMainViewer().setSmallRenderTargetPicking(true);if(this._experienceBase.getManager("VCXContextManager").getCityMode()){this._experienceBase.getManager("VCXContextManager").getMainViewer().setOIT(false)}else{this._experienceBase.getManager("VCXContextManager").getMainViewer().setOIT(true)}var l=this;var k=this._experienceBase.getManager("VCXContextManager").getMainViewer();this._onViewpointToken=c.subscribe({event:"/VISU/"},function(m){if(m&&m.viewpoint&&m.eventType==="@onViewpointChange"&&k===m.viewpoint.viewer){l.viewpointHasMovedRequested=true}})},unInitialize:function(){this.SSAOONIdle=false;this._activeViewport=null;this._idleCBs=[];delete this._spatialOccupationEffect;if(this._onViewpointToken){c.unsubscribe(this._onViewpointToken);this._onViewpointToken=null}},getUpdatePriority:function(){return -7},addOnIdleCB:function(l,m){var k={};if(!m){m=0.5}k.time=m;k.idle=false;k.cbFunction=l;k.id=this._idleIndex;this._idleIndex++;this._idleCBs.push(k);return k.id},removeOnIdleCB:function(k){for(var l=0;l<this._idleCBs.length;l++){if(this._idleCBs[l].id===k){this._idleCBs.splice(l,1);return true}}return false},setActiveViewport:function(k){this._activeViewport=k},getActiveViewport:function(){return this._activeViewport},setUpdateViewport:function(k){this._bUpdateViewport=k},getUpdateViewport:function(){return this._bUpdateViewport},setTransitionMode:function(k){this._isInTransition=k},isInTransitionMode:function(){return this._isInTransition},setTileOutput:function(k){this._isInTileMode=k},setVertical:function(l){var k=new i.Vector3(1,0,0);var n=new i.Vector3(0,1,0);var m=new i.Vector3(0,0,1);switch(l){case 0:k.set(0,1,0);n.set(0,0,1);m.set(1,0,0);break;case 1:k.set(0,0,1);n.set(1,0,0);m.set(0,1,0);break;case 2:break;case 3:k.set(0,0,1);n.set(0,1,0);m.set(-1,0,0);break;case 4:k.set(1,0,0);n.set(0,0,1);m.set(0,-1,0);break;case 5:k.set(0,1,0);n.set(1,0,0);m.set(0,0,-1);break}this._verticalFrame.makeBasis(k,n,m);this._inverseVerticalFrame.getInverse(this._verticalFrame);return this._verticalFrame},getMatrixToAdjustVertical:function(k){return this._verticalFrame},getInverseMatrixToAdjustVertical:function(k){return this._inverseVerticalFrame},getOccupationGrid:function(k,p,o){var m=this._experienceBase.getManager("VCXContextManager").getRootNode();if(m){if(!m._PassToCheckAvailableSpaceAdded){m._PassToCheckAvailableSpaceAdded=true;m.setRenderPasses(["main","PassToCheckAvailableSpace"])}}if(this._previousSizeX!==k||this._previousSizeY!==p){this._previousSizeX=k;this._previousSizeY=p;this._spatialOccupationEffect=new b(o,{targetWidth:k,targetHeight:p,name:"PassToCheckAvailableSpace"})}if(this._spatialOccupationEffect){var n=this._experienceBase.getManager("VCXPaperManager");n.updatePaper({viewportSize:{x:this._previousSizeX,y:this._previousSizeY}});var l=this._spatialOccupationEffect.renderResult({flipImage:false});n.updatePaper();return l}},isInFrustum:function(l,n){if(this._isInTileMode){return true}var k=true;if(n.GetPropertyValue("Collab.HideIfOutsideAnchorFrustrum")){k=false;var m=new i.Frustum;m.setFromMatrix(new i.Matrix4().multiplyMatrices(l.viewpoint.camera.projectionMatrix,l.viewpoint.camera.matrixWorldInverse));var o=this;n.processAnchorsIDs(function(p){var s=false;var r=n._Anchors[p];if(r){var v=true;var w=r.GetValueLink().Value;if(w){var u=o._experienceBase.ComponentsMap.GetComponentFromID(w);if(u){var t=u.QueryInterface("VCXIVisibility");if(t){if(t.GetVisibility()===d.EVisState.Hidden){v=false}}}}if(v){var q=n.GetAnchorWorldMatrix(p,l);if(m.containsPoint(new i.Vector3().getPositionFromMatrix(q))){k=true;return s}}}});return k}return k},getRenderList:function(l){var k=this._experienceBase.getManager("VCXContextManager");var m=k.getFrameWindow();if(m){if(!m._renderList){m._renderList={}}if(!m._renderList[l]){m._renderList[l]=new h(l)}return m._renderList[l]}return null},createViewerLayers:function(q){var l=q.getUserPassManager();if(!l){return}var o;var n;var r={};var s;o="VCXBackground";s=l.createUserRenderPass(o,this.getRenderList(o));if(s){s._passes[0].setScene(q.internalSceneGraph.scene);s.setEnableStencilTest(false);s.setEnableStencilWrite(false);s.setDisableColorWrite(false);s.setDisableBackFaceCulling(false);s.setDisableDepthWrite(true);s.setDepthFunc("ALWAYS");r[o]=s}o="VCXBackground2DDressups";s=l.createUserRenderPass(o,this.getRenderList(o));if(s){s._passes[0].setScene(q.internalSceneGraph.scene);s.setEnableStencilTest(false);s.setEnableStencilWrite(false);s.setDisableColorWrite(false);s.setDisableBackFaceCulling(false);s.setDisableDepthWrite(true);s.setDepthFunc("ALWAYS");r[o]=s}o="VCXGround";s=l.createUserRenderPass(o,this.getRenderList(o));if(s){s._passes[0].setScene(q.internalSceneGraph.scene);s.setEnableStencilTest(false);s.setEnableStencilWrite(false);s.setDisableColorWrite(false);s.setDisableBackFaceCulling(false);s.setDisableDepthWrite(true);s.setDepthFunc("ALWAYS");r[o]=s}o="VCXBackground3DDressups";s=l.createUserRenderPass(o,this.getRenderList(o));if(s){s._passes[0].setScene(q.internalSceneGraph.scene);s.setEnableStencilTest(false);s.setEnableStencilWrite(false);s.setDisableColorWrite(false);s.setDisableBackFaceCulling(false);s.setDisableDepthWrite(true);s.setDepthFunc("ALWAYS");r[o]=s}o="VCXOc3DDressups";s=l.createUserRenderPass(o,this.getRenderList(o));if(s){s._passes[0].setScene(q.internalSceneGraph.scene);r[o]=s}n="VCXPreNOc3DDressups";o="VCXNOc3DDressups";s=l.createUserClearPass(n,this.getRenderList(o));if(s){s._passes[0].setScene(q.internalSceneGraph.scene);s.setClearStencil(true);s.setClearDepth(true);r[n]=s}s=l.createUserRenderPass(o,this.getRenderList(o));if(s){s._passes[0].setScene(q.internalSceneGraph.scene);r[o]=s}n="VCXPre2DDressups";o="VCX2DDressups";var t="VCX2DDressups2";s=l.createUserClearPass(n,this.getRenderList(n));if(s){s._passes[0].setScene(q.internalSceneGraph.scene);s.setClearStencil(true);s.setClearDepth(true);r[n]=s}s=l.createUserRenderPass(o,this.getRenderList(o));if(s){s._passes[0].setScene(q.internalSceneGraph.scene);r[o]=s}s=l.createUserRenderPass(t,this.getRenderList(t));if(s){s._passes[0].setScene(q.internalSceneGraph.scene);r[t]=s}n="VCXPreManipulators";o="VCXManipulators";s=l.createUserClearPass(n,this.getRenderList(o));if(s){s._passes[0].setScene(q.internalSceneGraph.scene);s.setClearStencil(false);s.setClearDepth(true);r[n]=s}s=l.createUserRenderPass(o,this.getRenderList(o));if(s){s._passes[0].setScene(q.internalSceneGraph.scene);r[o]=s}n="VCXPreForeground";o="VCXForeground";s=l.createUserClearPass(n,this.getRenderList(o));if(s){s._passes[0].setScene(q.internalSceneGraph.scene);s.setClearStencil(false);s.setClearDepth(true);r[n]=s}s=l.createUserRenderPass(o,this.getRenderList(o));if(s){s._passes[0].setScene(q.internalSceneGraph.scene);r[o]=s}var k=l.getSystemPass("main");var p=l.getSystemPass("infinitePlane");l.insertUserPassBeforePass(r.VCXGround,p);l.insertUserPassBeforePass(r.VCXBackground2DDressups,r.VCXGround);l.insertUserPassBeforePass(r.VCXBackground,r.VCXBackground2DDressups);l.insertUserPassAfterPass(r.VCXBackground3DDressups,p);l.insertUserPassAfterPass(r.VCXOc3DDressups,k);if(this._experienceBase.getManager("VCXContextManager").getCityMode()){var m=l.getSystemPass("noz");l.insertUserPassBeforePass(r.VCXPreNOc3DDressups,m)}else{l.insertUserPassAfterPass(r.VCXPreNOc3DDressups,r.VCXOc3DDressups)}l.insertUserPassAfterPass(r.VCXNOc3DDressups,r.VCXPreNOc3DDressups);l.insertUserPassAfterPass(r.VCXPre2DDressups,r.VCXNOc3DDressups);l.insertUserPassAfterPass(r.VCX2DDressups,r.VCXPre2DDressups);l.insertUserPassAfterPass(r.VCX2DDressups2,r.VCX2DDressups);l.insertUserPassAfterPass(r.VCXPreManipulators,r.VCX2DDressups2);l.insertUserPassAfterPass(r.VCXManipulators,r.VCXPreManipulators);l.insertUserPassAfterPass(r.VCXPreForeground,r.VCXManipulators);l.insertUserPassAfterPass(r.VCXForeground,r.VCXPreForeground);q.setPickingPriority([{id:"VCXSection",priority:-10},]);q._VCXLayersCreated=true},update:function(n){this._parent(n);var l=this._experienceBase.getManager("VCXContextManager");var p=this;l.applyToViewers(function(q){if(!q._VCXLayersCreated){p.createViewerLayers(q)}});this.viewpointHasMoved=p.viewpointHasMovedRequested;var k=n.viewpoint.control.update();this.viewpointHasMoved|=k;p.viewpointHasMovedRequested=false;if(this.SSAOONIdle){this._timerWithNoRefresh+=n.deltaTime/1000;for(var o=0;o<this._idleCBs.length;o++){if(this._timerWithNoRefresh>this._idleCBs[o].time&&!this._idleCBs[o].idle){this._idleCBs[o].idle=true;this._idleCBs[o].cbFunction(true);this._renderingTimeToIgnore=0.1}}if(this._renderingTimeToIgnore){this._renderingTimeToIgnore-=n.deltaTime/1000}}if(this.viewpointHasMoved&&this.getActiveViewport()){var m=this.getActiveViewport().QueryInterface("VCXIViewpointController");if(m){m.fromViewpoint()}}if(this._renderPriorityDirty){this.activateRenderPriorityIfNeeded()}},dirtifyRenderPriority:function(){this._renderPriorityDirty=true},activateRenderPriorityIfNeeded:function(){this._renderPriorityDirty=false;var m=this._experienceBase.getManager("VCXContextManager");var n=m.getMainViewer();var l=m.getActiveViewport();var k=false;if(l.renderMode===g.ERenderMode.Custom&&this.hasOnePartRenderPriorityDifferentFromCentral()){k=true}if(n.setRenderPriority){if(k){n.setSectionCapping(false);n.setRenderPriority(true)}else{n.setSectionCapping(true);n.setRenderPriority(false)}n.setRenderPriorityDefaultOpacity(0.5);a.setRenderPriority(m.getRootPathElement(),2,n)}},hasOnePartRenderPriorityDifferentFromCentral:function(){var n=this._experienceBase.getManager("VCXContextManager").getRootComponent();if(n){var k=n.QueryInterface("VCXIModelNavigable");var l=false;var m={};k.traverse(function(o,q,p){if(Number.isInteger(o.GetObject().priority)&&o.GetObject().priority!==2){l=true;p.stop=true}},undefined,m);this._priorityDifferentFromCentral=l}return this._priorityDifferentFromCentral},findGeometricPrimitivesFromVisuBuffers:function(y,k,r,l,D,w,t){var B=0;if(k){B|=e.GeometricPrimitive.Line}if(r){B|=e.GeometricPrimitive.Circle}if(l){B|=e.GeometricPrimitive.Plane}if(D){B|=e.GeometricPrimitive.Cylinder}if(w){B|=e.GeometricPrimitive.Cone}if(t){B|=e.GeometricPrimitive.Sphere}var C=[];if(!y){return C}var n=new e();var s=n._getGeometry(y);var z=s?s.length:0;for(var A=0;A<z;++A){var E=s[A]?s[A].drawingGroups:null;var q=E?E.length:0;for(var x=0;x<q;++x){var v=E[x];if(!v){continue}var u=v.primitives?v.primitives.length:0;for(var o=0;o<u;++o){var m=v.primitives[o];if(!m){continue}var p=n.findPrimitiveFromBuffers(m,B);if(p){C.push(p)}}}}return C},postUpdate:function(k){this._parent(k);this.viewpointHasMoved=false},preRender:function(l){this._parent(l);if(this.SSAOONIdle){if(l&&l.viewer&&l.viewer._renderParams&&l.viewer._renderParams.length){var k=true;for(var m=0;m<l.viewer._renderParams.length;m++){if(!l.viewer._renderParams[m].onlyPostProcess){k=false}}if(!k){if(this._renderingTimeToIgnore>0){}else{this._timerWithNoRefresh=0;for(var n=0;n<this._idleCBs.length;n++){if(this._idleCBs[n].idle){this._idleCBs[n].idle=false;this._idleCBs[n].cbFunction(false)}}}}}}}});j.getViewerOptions=function(){return{defaultAnimationLoop:false,useOIT:true,antiAliasing:"SMAA",useShadowMap:false,mirror:false,ssao:false,debugShadowLight:false,debugBSphere:false,debugPrimitiveBSphere:false,debugRepBBox:false,debugPicking:false,picking:true,prePicking:true,multiViewer:true,multiViewerFix:true,infinitePlane:false,displayGrid:false,backgroundColor:15527148,planeV2:true,triLights:true}};Object.defineProperty(j.prototype,"CameraControlsViewpoint",{enumerable:true,get:function(){return this._CameraControlsViewpoint},set:function(k){this._CameraControlsViewpoint=k}});Object.defineProperty(j.prototype,"SSAOONIdle",{enumerable:true,get:function(){return(this._onIdleSSAOCB!==null)},set:function(k){if(k){if(!this._onIdleSSAOCB){var l=this;this._onIdleSSAOCB=this.addOnIdleCB(function(m){l._experienceBase.getManager("VCXContextManager").getMainViewer().setSSAO(m,false)})}}else{this._experienceBase.getManager("VCXContextManager").getMainViewer().setSSAO(false,false);if(this._onIdleSSAOCB){this.removeOnIdleCB(this._onIdleSSAOCB);this._onIdleSSAOCB=null}}}});Object.defineProperty(j.prototype,"componentType",{enumerable:true,get:function(){return"VCXVisuManager"}});Object.defineProperty(j.prototype,"HasViewpointMoved",{enumerable:true,get:function(){return this.viewpointHasMoved},});return j});define("DS/VCXWebVisualization/VCXMaterialManager",["DS/Visualization/ThreeJS_DS","DS/Visualization/RenderStyle","DS/VCXWebComponents/VCXWebComponentOccurrence","DS/VCXWeb3DMaster/VCXComponentMesh","DS/Visualization/PathElement","DS/WebApplicationBase/W3AAManager","DS/WebappsUtils/WebappsUtils","DS/VCXWebKernelTools/VCXEnums","DS/VCXWebVisualization/VCXImageManager","DS/Visualization/MaterialManager"],function(h,e,i,j,b,f,a,g,c,k){var d=f.extend({initialize:function(){this._renderStyles=new Map();this._materialsPhong=new Map();this._materialsBasic=new Map();this._materialsLineBasic=new Map();this._materialsPoint=new Map();this._materialsCustom=new Map();this._materialFlat=null;this._texSteelSpecular=null;this._texSteelNormal=null;this._texSteelGlossiness=null;this._texMetalbrushedAlbedo=null;this._texMetalbrushedNormal=null;this._texMetalbrushedGlossiness=null;this._texMetalbrushedSpecular=null;this._imagesCacheSize=10;this._imagesCache=[]},_releaseTexture:function(l){if(l&&l.dispose){l.dispose();l=null}},_releaseMaterials:function(l){if(l&&l.size){l.forEach(function(n,m){if(n&&n.dispose){n.dispose()}});l.clear();l=null}},unInitialize:function(){this._releaseMaterials(this._renderStyles);this._releaseMaterials(this._materialsPhong);this._releaseMaterials(this._materialsBasic);this._releaseMaterials(this._materialsLineBasic);this._releaseMaterials(this._materialsPoint);this._releaseMaterials(this._materialsCustom);this._releaseTexture(this._materialFlat);this._releaseTexture(this._texSteelSpecular);this._releaseTexture(this._texSteelNormal);this._releaseTexture(this._texSteelGlossiness);this._releaseTexture(this._texMetalbrushedAlbedo);this._releaseTexture(this._texMetalbrushedNormal);this._releaseTexture(this._texMetalbrushedGlossiness);this._releaseTexture(this._texMetalbrushedSpecular);this._imagesCacheSize=0;this._imagesCache=null;this.materialManager=null},postInitialize:function(){this._texSteelSpecular=h.ImageUtils.loadTexture(a.getWebappsAssetUrl("VCXWebVisualization","texture/VCX_steel_s.jpg"));this._texSteelNormal=h.ImageUtils.loadTexture(a.getWebappsAssetUrl("VCXWebVisualization","texture/VCX_steel_n.jpg"));this._texSteelGlossiness=h.ImageUtils.loadTexture(a.getWebappsAssetUrl("VCXWebVisualization","texture/VCX_steel_g.jpg"));this._texMetalbrushedAlbedo=h.ImageUtils.loadTexture(a.getWebappsAssetUrl("VCXWebVisualization","texture/VCX_metalbrushed_d.jpg"));this._texMetalbrushedNormal=h.ImageUtils.loadTexture(a.getWebappsAssetUrl("VCXWebVisualization","texture/VCX_metalbrushed_n.jpg"));this._texMetalbrushedGlossiness=h.ImageUtils.loadTexture(a.getWebappsAssetUrl("VCXWebVisualization","texture/VCX_metalbrushed_g.jpg"));this._texMetalbrushedSpecular=h.ImageUtils.loadTexture(a.getWebappsAssetUrl("VCXWebVisualization","texture/VCX_metalbrushed_s.jpg"));this.materialManager=new k()},_findTextureInCache:function(o,m){for(var n=0;n<this._imagesCache.length;++n){var l=this._imagesCache[n];if(l.iDocID===o&&l.iEffect===m){return l.texture}}return null},_addTextureToCache:function(n,m,l){var o={iDocID:n,iEffect:m,texture:l};if(this._imagesCache.length<this._imagesCacheSize){this._imagesCache[this._imagesCache.length]=o}else{this._imagesCache=this._imagesCache.slice(1,this._imagesCacheSize);this._imagesCache[this._imagesCacheSize-1]=o}},getRenderStyle:function(m){var l=m;var n=this._renderStyles.get(l);if(!n){n=null;switch(m){case i.ERenderingMode.SmoothOutline:n=new e();n.setRenderMode("Face",true);n.setRenderMode("@Edge",true);n.setOutlineWidth(2);n.setFaceMode("MATERIAL");break;case i.ERenderingMode.Technical:n=new e();n.setRenderMode("Face",true);n.setRenderMode("@Edge",true);n.setRenderMode("Outline",true);n.setOutlineWidth(2);n.setFaceMode("MATERIAL");break;case i.ERenderingMode.FlatTechnical:n=new e();n.setRenderMode("Face",true);n.setRenderMode("@Edge",true);n.setRenderMode("Outline",true);n.setOutlineWidth(2);n.setFaceMode("MATERIAL");break;case i.ERenderingMode.Silhouette:n=new e();n.setRenderMode("Face",true);n.setRenderMode("Outline",true);n.setOutlineWidth(2);n.setFaceMode("ZONLY");break;default:n=null;break}this._renderStyles.set(l,n)}return n},getMaterialPoint:function(l,p,n){var m=l.getHex()+"|"+p+"|"+n;var o=this._materialsPoint.get(m);if(o===undefined){o=new h.ParticleBasicMaterial({color:l,opacity:p,size:n,sizeAttenuation:false});o.force=true;this._materialsPoint.set(m,o)}return o},getMaterialLine:function(l,p,n){var m=l.getHex()+"|"+p+"|"+n;var o=this._materialsLineBasic.get(m);if(o===undefined){o=new h.LineBasicMaterial({color:l,opacity:p,dashSize:0,gapSize:0,side:h.DoubleSide,polygonBorderMode:true});o.setLineWidth(n);o.force=true;this._materialsLineBasic.set(m,o)}return o},getMaterialBasic:function(l,o){var m=l.getHex()+"|"+o;var n=this._materialsBasic.get(m);if(n===undefined){n=new h.MeshBasicMaterial({color:l,opacity:o});n.force=true;this._materialsBasic.set(m,n)}return n},getMaterialPhong:function(n,r,q){var l="";if(q){l=q}var o=n.getHex()+"|"+r+"|"+l;var p=this._materialsPhong.get(o);if(p===undefined){p=new h.PhysicalMaterial({color:new h.Color(n.getHex()),opacity:r,side:h.DoubleSide,specular:new h.Color(16777215),roughness:1,metalness:0,force:true});p.line=new h.LineBasicMaterial({color:new h.Color(65280),lineWidth:1,opacity:1});p.point=new h.ParticleBasicMaterial({color:new h.Color(16711680),size:1,opacity:1});this._materialsPhong.set(o,p);if(q){var m=h.ImageUtils.loadTexture(q,h.UVMapping);m.wrapS=h.RepeatWrapping;m.wrapT=h.RepeatWrapping;m.repeat.set(1,1);m.needsUpdate=true;p.map=m;p.force=true;p.update=true;p.needsUpdate=true}}return p},getMaterialFlat:function(){if(!this._materialFlat){this._materialFlat=new h.PhysicalMaterial({NRECompatibility:true,side:h.DoubleSide});this._materialFlat.useLighting=false;this._materialFlat.name="Flat"}return this._materialFlat},createMaterial:function(m){var l=null;if(m._envID){l=new h.PhysicalMaterial({NRECompatibility:true,side:h.DoubleSide,force:true})}else{l=new h.PhysicalMaterial({NRECompatibility:true,side:h.DoubleSide,force:true})}return l},getSharedMaterial:function(n){var l=n._envID+"|"+n._textureDocID;var m=this._materialsCustom.get(l);if(!m){m=this.createMaterial(n);switch(n._envID){case g.EnvironmentalId.None:m.color=g.Color.Black;m.specular=g.Color.White;m.roughness=1;m.metalness=0;m.name="None";break;case g.EnvironmentalId.Chromic:m.color=g.Color.White;m.opacity=1;m.metalness=0.3;m.metalnessMap=this._texMetalbrushedNormal;m.transparent=false;m.name="Chromic";break;case g.EnvironmentalId.Metal:m.color=g.Color.White;m.opacity=1;m.metalnessMap=this._texSteelGlossiness;m.transparent=false;m.roughness=0.1;m.metalness=0.2;m.specularContrib=0.3;m.name="Metal";break;case g.EnvironmentalId.MetalBrushed:m.color=g.Color.White;m.opacity=1;m.metalnessMap=this._texSteelGlossiness;m.transparent=false;m.roughness=0.5;m.metalness=0.2;m.specularContrib=0.3;m.name="MetalBrushed";break;case g.EnvironmentalId.Plastic:m.color=g.Color.Black;m.opacity=1;m.transparent=false;m.roughness=0.1;m.metalness=0.1;m.specularContrib=0.3;m.name="Plastic";break;case g.EnvironmentalId.Glass:m.color=g.Color.Black;m.opacity=0.5;m.transparent=true;m.roughness=0.1;m.metalness=0.8;m.specularContrib=0.3;m.name="Glass";break;case g.EnvironmentalId.GlassPlastic:m.color=g.Color.Black;m.opacity=0.3;m.transparent=true;m.roughness=0.1;m.metalness=0.4;m.specularContrib=0.3;m.name="GlassPlastic";break;case g.EnvironmentalId.ChromicWithColor:m.color=g.Color.White;m.opacity=1;m.emissive=g.Color.Black;m.metalness=0.8;m.glossiness=0.9;m.specularMap=this._texSteelSpecular;m.transparent=false;m.name="ChromicWithColor";break;case g.EnvironmentalId.Unknown:break;case g.EnvironmentalId.Gold:m.color=g.Color.Gold;m.opacity=1;m.emissive=g.Color.Black;m.specular=g.Color.Black;m.metalness=0.5;m.normalMap=this._texMetalbrushedNormal;m.transparent=false;m.name="Gold";break;case g.EnvironmentalId.Aluminium:m.color=g.Color.White;m.opacity=1;m.metalness=0.2;m.metalnessMap=this._texSteelSpecular;m.transparent=false;m.roughness=0.5;m.metalness=0.2;m.specularContrib=0.1;m.name="Aluminium";break;case g.EnvironmentalId.Satin:m=new h.PhysicalMaterial({color:240,specular:657930,glossiness:0.05,sheen:0.25,sheenMode:h.SheenMode.SATIN});m.color=g.Color.Satin;m.opacity=1;m.emissive=g.Color.Black;m.name="Satin";break;default:break}this._materialsCustom.set(l,m)}return m},isTextureVisible:function(l){var m=false;switch(l){case g.EnvironmentalId.None:case g.EnvironmentalId.Metal:case g.EnvironmentalId.MetalBrushed:case g.EnvironmentalId.Plastic:case g.EnvironmentalId.GlassPlastic:case g.EnvironmentalId.ChromicWithColor:m=true;break;default:break}return m},getBboxInNewBasis:function(n,v){var s=new h.Matrix4().getInverse(n);var p=new h.Vector3(v.min.x,v.min.y,v.min.z);p.applyMatrix4(s);var l=p.x;var q=p.x;var t=p.y;var o=p.y;var r=p.z;var u=p.z;if(l>p.x){l=p.x}else{if(q<p.x){q=p.x}}if(t>p.y){t=p.y}else{if(o<p.y){o=p.y}}if(r>p.z){r=p.z}else{if(u<p.z){u=p.z}}p.x=v.min.x;p.y=v.min.y;p.z=v.max.z;p.applyMatrix4(s);if(l>p.x){l=p.x}else{if(q<p.x){q=p.x}}if(t>p.y){t=p.y}else{if(o<p.y){o=p.y}}if(r>p.z){r=p.z}else{if(u<p.z){u=p.z}}p.x=v.min.x;p.y=v.max.y;p.z=v.min.z;p.applyMatrix4(s);if(l>p.x){l=p.x}else{if(q<p.x){q=p.x}}if(t>p.y){t=p.y}else{if(o<p.y){o=p.y}}if(r>p.z){r=p.z}else{if(u<p.z){u=p.z}}p.x=v.min.x;p.y=v.max.y;p.z=v.max.z;p.applyMatrix4(s);if(l>p.x){l=p.x}else{if(q<p.x){q=p.x}}if(t>p.y){t=p.y}else{if(o<p.y){o=p.y}}if(r>p.z){r=p.z}else{if(u<p.z){u=p.z}}p.x=v.max.x;p.y=v.min.y;p.z=v.min.z;p.applyMatrix4(s);if(l>p.x){l=p.x}else{if(q<p.x){q=p.x}}if(t>p.y){t=p.y}else{if(o<p.y){o=p.y}}if(r>p.z){r=p.z}else{if(u<p.z){u=p.z}}p.x=v.max.x;p.y=v.min.y;p.z=v.max.z;p.applyMatrix4(s);if(l>p.x){l=p.x}else{if(q<p.x){q=p.x}}if(t>p.y){t=p.y}else{if(o<p.y){o=p.y}}if(r>p.z){r=p.z}else{if(u<p.z){u=p.z}}p.x=v.max.x;p.y=v.max.y;p.z=v.min.z;p.applyMatrix4(s);if(l>p.x){l=p.x}else{if(q<p.x){q=p.x}}if(t>p.y){t=p.y}else{if(o<p.y){o=p.y}}if(r>p.z){r=p.z}else{if(u<p.z){u=p.z}}p.x=v.max.x;p.y=v.max.y;p.z=v.max.z;p.applyMatrix4(s);if(l>p.x){l=p.x}else{if(q<p.x){q=p.x}}if(t>p.y){t=p.y}else{if(o<p.y){o=p.y}}if(r>p.z){r=p.z}else{if(u<p.z){u=p.z}}var m=new h.Box3();m.min.x=l;m.min.y=t;m.min.z=r;m.max.x=q;m.max.y=o;m.max.z=u;return m},getBbox:function(r){if(!r){return null}var n=r.QueryInterface("W3AISGNodeHolder").getPathElement();if(!n||n===undefined||!n.externalPath.length){return null}var q=new b();for(var m=0;m<n.externalPath.length;++m){q.addElement(n.externalPath[m])}var l=q.getLastElement();while(l){l=l.children.length?l.children[0]:null;if(l){q.addElement(l);if("InstanceRep"===l.getNodeType()){break}}}var p=this._experienceBase.getManager("VCXContextManager").getMainViewer();var o=q.getBoundingBox(null,p);return o},doTextureUV:function(p,l){var o=p._textureProjectionMatrix||new h.Matrix4();var n=new h.Matrix3();var m=p._textureUVMatrix||new h.Matrix4();n.set(m.elements[0],m.elements[1],0,m.elements[4],m.elements[5],0,0,0,1);l.setMappingOperator(p._textureProjectionType,o,n,true)},doTextureMappingPlanar:function(q,n){if(!q){return}var z=q.QueryInterface("W3AISGNodeHolder").getPathElement();var p=this._experienceBase.getManager("VCXContextManager").getMainViewer();var l=this.getBbox(q);var F=1;var E=1;var D=1;if(q._textureUVscale<50){F=1+(50-q._textureUVscale)/2}else{F=1-(q._textureUVscale-50)/50}E=F;D=F;var x=1;if(q._textureUVratio<=50){x=q._textureUVratio/50}else{x=1+(q._textureUVratio-50)/5}E*=x;var u=q._textureProjectionMatrix||new h.Matrix4();var A=this.getBboxInNewBasis(u,l);var o=A.max.x-A.min.x;var w=o;if(o>0){F=F/o}o=A.max.y-A.min.y;var v=o;if(o>0){E=E/o}o=A.max.z-A.min.z;var t=o;if(o>0){D=D/o}var B=new h.Matrix4().copy(u);B.elements[12]=(l.max.x+l.min.x)*0.5;B.elements[13]=(l.max.y+l.min.y)*0.5;B.elements[14]=(l.max.z+l.min.z)*0.5;B=new h.Matrix4().getInverse(B);var m=new h.Matrix4();m.scale(new h.Vector3(F,E,D));B=new h.Matrix4().multiplyMatrices(m,B);var s=new h.Matrix3();var y=q._textureUVMatrix||new h.Matrix4();s.set(y.elements[0],y.elements[1],0,y.elements[4],y.elements[5],0,0,0,1);var r=new h.Matrix3();r.set(1,0,0.5-y.elements[12],0,1,0.5-y.elements[13],0,0,1);var C=new h.Matrix3().multiplyMatrices(s,r);n.setMappingOperator(q._textureProjectionType,B,C,true)},doTextureMappingSpherical:function(p,n){if(!p){return}var y=p.QueryInterface("W3AISGNodeHolder").getPathElement();var l=y.getLastElement().getBoundingBox();var G=1;var F=1;var E=1;if(p._textureUVscale<50){G=1+(50-p._textureUVscale)/2}else{G=1-(p._textureUVscale-50)/50}F=G;E=G;var w=1;if(p._textureUVratio<=50){w=p._textureUVratio/50}else{w=1+(p._textureUVratio-50)/5}F*=w;var z=new h.Matrix4().makeRotationZ(Math.PI/2);var t=p._textureProjectionMatrix||new h.Matrix4();var C=new h.Matrix4().multiplyMatrices(t,z);var B=this.getBboxInNewBasis(C,l);var A=Math.max(Math.max(B.max.x-B.min.x,B.max.y-B.min.y),B.max.z-B.min.z);var o=A*Math.sqrt(2);var v=o;if(o>0){G=G/o}o=A*Math.sqrt(2);var u=o;if(o>0){F=F/o}o=A*Math.sqrt(2);var s=o;if(o>0){E=E/o}C.elements[12]=(l.max.x+l.min.x)*0.5;C.elements[13]=(l.max.y+l.min.y)*0.5;C.elements[14]=(l.max.z+l.min.z)*0.5;C=new h.Matrix4().getInverse(C);var m=new h.Matrix4();m.scale(new h.Vector3(G,F,E));C=new h.Matrix4().multiplyMatrices(m,C);var r=new h.Matrix3();var x=p._textureUVMatrix||new h.Matrix4();r.set(x.elements[0],x.elements[1],0,x.elements[4],x.elements[5],0,0,0,1);var q=new h.Matrix3();q.set(1,0,0.5-x.elements[12],0,1,0.5-x.elements[13],0,0,1);var D=new h.Matrix3().multiplyMatrices(r,q);n.setMappingOperator(p._textureProjectionType,C,D,true)},applyTexture:function(m,n,l){if(n._textureBorderMode){l.wrapS=h.RepeatWrapping;l.wrapT=h.RepeatWrapping}else{l.wrapS=h.ClampToEdgeWrapping;l.wrapT=h.ClampToEdgeWrapping}l.repeat.set(1,1);l.needsUpdate=true;m.map=l;m.needsUpdate=true;m.updateDeferredMaterials()},loadTexture:function(r,l,o,m){var q=this._findTextureInCache(r._textureDocID,m);if(q){this.applyTexture(l,r,q);return q}var n=this._experienceBase.getManager("VCXImageManager");if(!n){return}var p=this;n.GetImageFromDocID(r._textureDocID,m,function(t,v){var w=p._findTextureInCache(r._textureDocID,m);if(w){p.applyTexture(l,r,w);return w}var s=v.toDataURL("image/png");var u=h.ImageUtils.loadTexture(s,{},function(x){p.applyTexture(l,r,x)});p._addTextureToCache(r._textureDocID,m,u);return u})},setMaterialAttributesFromOccurrence:function(s,o){if(!o){return}var m=this.getSharedMaterial(s);if(m){o.color=m.color.clone();o.specular=m.specular.clone();o.normalMap=m.normalMap;o.metalnessMap=m.metalnessMap;o.roughnessMap=m.roughnessMap;o.glossinessMap=m.glossinessMap;o.specularMap=m.specularMap;o.transparent=m.transparent;o.metalness=m.metalness;o.shininess=m.shininess;o.glossiness=m.glossiness;o.roughness=m.roughness;o.specularContrib=m.specularContrib;o.transparent=m.transparent;o.NRECompatibility=m.NRECompatibility;o.side=m.side}if(!this.isTextureVisible(s._envID)){o.map=null;return}var n=this._experienceBase.getManager("VCXDocManager");var q=null;if(n){q=n.GetPropPath(s._textureDocID)}var t=null;if(q){t=q.GetValueURL()}var l=null;if(t){l=t.Value}if(l){var p=c.Effect.RedimensionPower2;if(s.localColor){o.diffuseMulCoef=new h.Vector3(s.localColor.r,s.localColor.g,s.localColor.b)}o.diffuseAddCoef=new h.Vector3(0,0,0);if(s._textureTransparency){o.transparent=true;if(s._textureBlending){p|=c.Effect.RemoveBorder}else{}}else{o.transparent=false;if(s._textureBlending){}else{o.color=g.Color.White;o.diffuseMulCoef=new h.Vector3(1,1,1)}}if(s.getDirtyFlag(i.FDirty.EnvID|i.FDirty.TextureDocID|i.FDirty.TextureTransparency|i.FDirty.TextureBlending)){this.loadTexture(s,o,l,p)}}if(s.getDirtyFlag(i.FDirty.TextureBorderMode)){var r=o.map;if(r){if(s._textureBorderMode){r.wrapS=h.RepeatWrapping;r.wrapT=h.RepeatWrapping}else{r.wrapS=h.ClampToEdgeWrapping;r.wrapT=h.ClampToEdgeWrapping}r.repeat.set(1,1);r.needsUpdate=true}}if(s._textureProjectionType===g.TextureMapping.Planar){this.doTextureMappingPlanar(s,o)}else{if(s._textureProjectionType===g.TextureMapping.Spherical){this.doTextureMappingSpherical(s,o)}else{this.doTextureUV(s,o)}}},getLineMaterialFromParams:function(n,q){var p=null,l=null,r=null;if(typeof n.type==="number"){if(n.type===i.ELineType.None){p="None"}else{if(n.type===i.ELineType.Solid){p="Solid"}else{var m=this.getCustomLineDashPatternFromType(n.type);if(!m){p="Solid"}else{if(m[0]>0){l=m;r=true}}}}}else{if(Array.isArray(n.dashPattern)){l=n.dashPattern;r=true}}if(q){if(typeof p==="string"&&q.dashType!==p){q.setDashPatternType(p)}else{if(l&&q.dashPattern!==l){q.setDashPatternArray(l)}}if(typeof r==="boolean"&&q.isCPUPattern!==r){q.setCPUPattern(r)}if(typeof n.lineWidth==="number"&&q.lineWidth!==n.lineWidth){n.lineWidth&&q.setLineWidth(n.lineWidth)}if(n.color&&!q.color.equals(n.color)){q.color=n.color}if(typeof n.opacity==="number"&&q.opacity!==n.opacity){q.opacity=n.opacity}if(n.vertexColors&&q.vertexColors!==n.vertexColors){q.vertexColors=n.vertexColors}if(n.backMaterial&&(!q.backMaterial||q.backMaterial.id!==n.backMaterial.id)){n.backMaterial&&q.setBackMaterial(n.backMaterial)}this._experienceBase.getManager("VCXContextManager").renderAll();return q}else{var o={transparent:true,force:true,polygonBorderMode:false,alphaTest:2/255,scale:typeof n.scale==="number"?n.scale:1,lineWidth:typeof n.lineWidth==="number"?n.lineWidth:2,opacity:typeof n.opacity==="number"?n.opacity:1};if(typeof p==="number"){o.dashType=p}else{if(l){o.dashPattern=new Float32Array(l)}}if(n.backMaterial&&n.backMaterial.isCPUPattern){o.isCPUPattern=true}else{if(typeof r==="boolean"){o.isCPUPattern=r}}if(n.vertexColors){o.vertexColors=n.vertexColors}if(n.color){o.color=n.color}if(n.backMaterial){o.backMaterial=n.backMaterial}if(n.polygonOffset){o.polygonOffset=n.polygonOffset;o.polygonOffsetFactor=n.polygonOffsetFactor;o.polygonOffsetUnits=n.polygonOffsetUnits}return new h.LineBasicMaterial(o)}},getCustomLineDashPatternFromType:function(n){if(!n){return}var m=[0];var o=Object.keys(i.ELineType);for(var l=0;l<o.length;++l){var p=o[l];if(i.ELineType[p]===n){m=i.ELineDashPattern[p];break}}return m}});Object.defineProperty(d.prototype,"componentType",{enumerable:true,get:function(){return"VCXMaterialManager"}});return d});define("DS/VCXWebVisualization/VCXAnchorHandle",["DS/VCXWebVisualization/VCXHandle","DS/Visualization/ThreeJS_DS"],function(b,c){var a=b.extend({init:function(d){this._parent(d)},getAnchorMatrixInWCS:function(){var d=this._parentOwnerComponent.QueryInterface("VCXIModifiable");return d.GetAnchorWorldMatrix(this._id,null)},getMatrixInWCS:function(){return this.getAnchorMatrixInWCS()}});return a});define("DS/VCXWebVisualization/VCXManipulatorManager",["DS/ApplicationFrame/CommandsManager","DS/CoreEvents/Events","DS/Manipulators/ScreenPlaneManipulator","DS/Manipulators/LineTranslationManipulator","DS/Manipulators/HandlePointManipulator","DS/Manipulators/PlaneTranslationManipulator","DS/Manipulators/ScalingManipulator","DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey","DS/VCXWebKernelTools/VCXMathTools","DS/VCXWebVisibility/VCXIVisibility","DS/VCXWebVisualization/VCXAnchorHandle","DS/VCXWebVisualization/VCXHandle","DS/VCXWebVisualization/VCXInteractor","DS/VCXWebProperties/VCXPropertyMap","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/WebApplicationBase/W3AAManager"],function(b,p,c,j,f,m,a,q,l,i,o,n,k,d,h,r,e){var g=e.extend({init:function(){},initialize:function(){this._parent()},unInitialize:function(){this._parent();for(var u in this._WUXEventTokens){if(this._WUXEventTokens.hasOwnProperty(u)&&this._WUXEventTokens[u]){p.unsubscribe(this._WUXEventTokens[u]);this._WUXEventTokens[u]=null}}for(var s=0;s<this._iManipulables.length;++s){var t=this._iManipulables[s];this.unregisterManipulable(t)}this._iManipulables=null;this._manipulationTokens=null;this.bManipulationsAllowed=null;this._manipulatorsActive=null;this._manipulatorsPreactive=null},postInitialize:function(){this._parent();var u=this;this._iManipulables=[];this._manipulationTokens={};this._WUXEventTokens={};var s=this._experienceBase.getManager("VCXContextManager");var t=s.getMainViewer();if(typeof this._manipulatorsActive!=="boolean"&&t.getManipulators){this._manipulatorsActive=t.getManipulators()}if(typeof this._manipulatorsPreactive!=="boolean"){this._manipulatorsPreactive=t.pPicking&&t.manipulatorManager&&t.manipulatorManager.preActivation}t.setManipulators({activated:this._manipulatorsActive,preActivate:this._manipulatorsPreactive});this._WUXEventTokens.VCX_INTERACTOR_CREATED=p.subscribe({event:"VCX_INTERACTOR_ADDED"},function(x){var w=x.interactor;var v=x.manipulable;if(!u._iManipulables.includes(v)){u.registerManipulable(v)}});this._WUXEventTokens.VCX_PREHIGHLIGHT_EMPTY=p.subscribe({event:"VCX_PREHIGHLIGHT_EMPTY"},function(v){u.removeManipulators()});this._WUXEventTokens.VCX_HIGHLIGHT_EMPTY=p.subscribe({event:"VCX_HIGHLIGHT_EMPTY"},function(v){u.removeManipulators()});this._WUXEventTokens.VCX_PREHIGHLIGHT_REMOVE=p.subscribe({event:"VCX_PREHIGHLIGHT_REMOVE"},function(x){var w=x.map(function(y){return y.pathElement});var v=u._experienceBase.ComponentsMap.GetComponentsFromPathElements(w);u.removeManipulators(v,false);u.refreshHandlesFromComponentList(v)});this._WUXEventTokens.VCX_HIGHLIGHT_REMOVE=p.subscribe({event:"VCX_HIGHLIGHT_REMOVE"},function(x){var w=x.map(function(y){return y.pathElement});var v=u._experienceBase.ComponentsMap.GetComponentsFromPathElements(w);u.removeManipulators(v,true);u.refreshHandlesFromComponentList(v)});this._WUXEventTokens.VCX_SELECTION_REMOVE=p.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_REMOVE"},function(v){u.removeManipulators(v,true)});this._WUXEventTokens.VCX_SELECTED_ACTORS_EMPTY=p.subscribe({event:"VCX_SELECTED_ACTORS_EMPTY"},function(v){u.removeManipulators(v,true)});this._WUXEventTokens.VCX_PREHIGHLIGHT_ADD=p.subscribe({event:"VCX_PREHIGHLIGHT_ADD"},function(x){var w=x.map(function(y){return y.pathElement});var v=u._experienceBase.ComponentsMap.GetComponentsFromPathElements(w);u.addManipulators(v,false);u.refreshHandlesFromComponentList(v)});this._WUXEventTokens.VCX_HIGHLIGHT_ADD=p.subscribe({event:"VCX_HIGHLIGHT_ADD"},function(x){var w=x.map(function(y){return y.pathElement});var v=u._experienceBase.ComponentsMap.GetComponentsFromPathElements(w);u.addManipulators(v,false);u.refreshHandlesFromComponentList(v)});this._WUXEventTokens.VCX_SELECTION_ADD=p.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_ADD"},function(v){u.addManipulators(v,true);u.refreshHandlesFromComponentList(v)});this._WUXEventTokens.VCX_VISIBILITY_CHANGED=p.subscribe({event:"VCX_VISIBILITY_CHANGED"},function(v){if(v.visibility===i.EVisState.Hidden){u.refreshHandlesFromComponentList(v.components)}});this._WUXEventTokens.VCX_DRESSUPS_REMOVE=p.subscribe({event:"VCX_DRESSUPS_REMOVED"},function(z){var v=z;for(var w=0;w<z.length;++w){var y=v[w];var x=y&&y.QueryInterface("VCXIManipulable");x&&u.unregisterManipulable(x)}})},registerManipulable:function(s){this._iManipulables.push(s)},unregisterManipulable:function(x){var y=x.GetObject();var w=y.GetID();for(var z=0;z<this._iManipulables.length;++z){var v=this._iManipulables[z];var s=v.GetObject().GetID();if(s===w){break}}if(s!==w){return}var B=this._iManipulables[z];if(!B){return}var A=B.getAllInteractors();for(var u in A){if(A.hasOwnProperty(u)){var t=A[u];this.unsubscribeInteractor(y,t,true)}}this._iManipulables.splice(z,1)},unsubscribeInteractor:function(y,v,s){var x=v.manipulator;if(!x){return}var t=y.GetID();if(!(this._manipulationTokens&&this._manipulationTokens[t]&&this._manipulationTokens[t][v.id])){return}var A=Object.keys(this._manipulationTokens[t][v.id]);for(var u=0;u<A.length;++u){var z=A[u];if(z==="interactor"){continue}var w=this._manipulationTokens[t][v.id][z];if(!w){continue}x.unsubscribe(w)}x.interactor=null;v.manipulator.unlink(v.manipulatorToken);v.manipulator=null;v.manipulatorToken=null;if(s&&v.handle){v.handle.remove();v.handle=null}},addManipulators:function(x){if(Array.isArray(x)){var s=this._experienceBase.getManager("VCXSelectionManager");for(var w=0;w<x.length;++w){var v=x[w];var u=v&&v.QueryInterface("VCXIManipulable");if(u){u._over=true;u._selected=s.isIn(u.GetObject());var t=this._iManipulables.indexOf(u);if(t===-1){this.registerManipulable(u)}}}}else{console.warn("Data given by SelectionManager for adds have changed..")}},removeManipulators:function(x){var t=this._experienceBase.getManager("VCXSelectionManager");if(Array.isArray(x)){for(var w=0;w<x.length;++w){var v=x[w];var u=v&&v.QueryInterface("VCXIManipulable");if(u){u._over=false;u._selected=t.isIn(u.GetObject())}}}else{if(!this._iManipulables){return}for(var s=0;s<this._iManipulables.length;s++){var u=this._iManipulables[s];u._over=false;u._selected=t.isIn(u.GetObject())}}},updateManipulatorsOfManipulable:function(D){var w=this._experienceBase.getManager("VCXContextManager");var E=this._experienceBase.getManager("VCXExperience");var s=true;var B=D.GetObject();var F=D.QueryInterface("VCXIModifiable");var C=D.getAllInteractors();for(var y in C){if(C.hasOwnProperty(y)){var v=C[y];if(!v){return}if(v.data&&typeof v.data.anchorID==="number"){if(!F.GetAnchorValue(v.data.anchorID)){if(v.manipulator){this.unsubscribeInteractor(B,v,true)}delete C[y];continue}}if(!v.active){this.disableInteractor(v);continue}else{s=false}var A=this.updateInteractorManipulator(D,v);if(v.manipulatorType!==k.EManipulatorType.None){if(!v.matrix){console.log("Every interactor should have a set matrix");continue}if(!v.handle){v.handle=this.createHandle(B,v);var u=D.QueryInterface("W3AISGNodeHolder").getPathElement();v.pathElement=u.clone();v.pathElement.setFromArray([v.handle.getHandleGeom()])}if(!v.handle){console.log("Handle not specified for this interactor");return}var z=v.handle;if(!v.manipulatorToken){v.manipulatorToken=A.linkToNode(v.node);z.updateManipulatorCallbacks(A)}var x=new r.Vector3().getPositionFromMatrix(v.matrix);z.setPosition(x.x,x.y,x.z);var t=v.handleInfos;if(v.handleInfos){typeof t.stayVisible==="boolean"&&z.StayVisible(t.stayVisible);z.getOpacity()!==t.opacity&&z.setOpacity(t.opacity);z.getColor()!==t.color&&z.setColor(t.color);z.getSize()!==t.size&&z.setSize(t.size)}if(!z.isDisplayed()&&(v.visibility===k.EVisibility.Always||z.getOpacity()>0)){z.Show()}else{if(z.isDisplayed()&&(v.visibility===k.EVisibility.NoChange||z.getOpacity()===0)){z.Hide()}}}else{if(!v.manipulatorToken){v.manipulatorToken=A.linkToNode(v.pathElement.getLastElement())}A.setSelectionAllowed(true)}if(v.active){A.enable()}else{A.disable()}}}if(D.GetObject().IsKindOf("VCXComponentMarkup")&&D.updateDashedOutline){D.updateDashedOutline(!s)}},removeManipulatorsFromIManipulable:function(u){var s=u.getAllInteractors();var w=u.GetObject();for(var x in s){if(s.hasOwnProperty(x)){var v=s[x];var t=v&&v.manipulator;if(t){this.unsubscribeInteractor(w,t.interactor,true)}}}},disableManipulable:function(t){var s=t.getAllInteractors();var v=t.GetObject();for(var w in s){if(s.hasOwnProperty(w)){var u=s[w];u&&this.disableInteractor(u)}}},disableInteractor:function(s){var t=s.manipulator;t&&t.disable()},updateInteractorManipulator:function(u,t){var s=this._checkManipulatorMatchesInteractor(t);if(s){if(t.constraintReferential===k.EConstraintReferential.Screen){}else{if(t.constraint===k.EConstraint.CustomPlane){t.manipulator.axis=t.constraintInfos.planeAxis}}}else{this.unsubscribeInteractor(u.GetObject(),t);this.generateInteractorManipulator(u,t)}return t.manipulator},_checkManipulatorMatchesInteractor:function(t){if(!(t&&t.manipulator)){return false}var s=t.manipulator;var u=false;if(t.constraintReferential===k.EConstraintReferential.Screen){u=s instanceof c}else{switch(t.constraint){case k.EConstraint.Pick:u=s instanceof f;break;case k.EConstraint.XYPlane:case k.EConstraint.XZPlane:case k.EConstraint.YZPlane:case k.EConstraint.CustomPlane:u=s instanceof m;break;case k.EConstraint.XAxis:case k.EConstraint.YAxis:case k.EConstraint.ZAxis:case k.EConstraint.CustomAxis:u=s instanceof j;break;case k.EConstraint.Radial:u=s instanceof a;break;default:u=false;break}}return u},generateInteractorManipulator:function(x,u){var C=null;if(u.constraintReferential===k.EConstraintReferential.Screen){C=new c()}else{switch(u.constraint){case k.EConstraint.Pick:C=new f();break;case k.EConstraint.XYPlane:C=new m({axis:l.getVzFromMatrix(u.matrix)});break;case k.EConstraint.XZPlane:C=new m({axis:l.getVyFromMatrix(u.matrix)});break;case k.EConstraint.YZPlane:C=new m({axis:l.getVxFromMatrix(u.matrix)});break;case k.EConstraint.XAxis:C=new j({axis:l.getVxFromMatrix(u.matrix)});break;case k.EConstraint.YAxis:C=new j({axis:l.getVyFromMatrix(u.matrix)});break;case k.EConstraint.ZAxis:C=new j({axis:l.getVzFromMatrix(u.matrix)});break;case k.EConstraint.Radial:C=new a({axis:l.getVzFromMatrix(u.matrix)});break;case k.EConstraint.CustomPlane:C=new m({axis:u.constraintInfos.planeAxis});break;default:break}}C.checkManipulatorsOnCreation(true);C.setExclusive(true);u.manipulator=C;C.interactor=u;var y=this;var v=this._experienceBase.getManager("VCXContextManager");var w=C.subscribe("BeginPreactivate",this._beginPreactivateCB(x));var A=C.subscribe("Preactivate",this._preactivateCB(x));var z=C.subscribe("EndPreactivate",this._endPreactivateCB(x));var t=C.subscribe("BeginManipulate",this._beginManipulateCB(x));var B=C.subscribe("Manipulate",this._manipulateCB(x));var D=C.subscribe("EndManipulate",this._endManipulateCB(x));var s=x.GetObject().GetID();if(!this._manipulationTokens[s]){this._manipulationTokens[s]={}}this._manipulationTokens[s][u.id]={interactor:u,tokenBeginPreactivate:w,tokenPreactivate:A,tokenEndPreactivate:z,tokenBeginManipulate:t,tokenManipulate:B,tokenEndManipulate:D,}},checkManipulationInProgress:function(){var u=false;for(var s=0;s<this._iManipulables.length;++s){var t=this._iManipulables[s];if(t.isManipulated()){u=true;break}}return u},createHandle:function(v,u){var w;var t={parentOwner:v,id:u.id,manipulator:u.manipulator,interactor:u};if(u.data&&typeof u.data.anchorID==="number"){var s=v.QueryInterface("VCXIModifiable");if(s.GetAnchorValue(u.data.anchorID)){w=new o(t)}}else{w=new n(t)}return w},_computeRequestedMatrix:function(v){var s=v.manipulator;var t=v.manipulator.interactor;var u=new r.Matrix4();function z(A){if(A.intersection.ray&&A.viewer&&A.viewer.currentViewpoint){if(!s._lastValidPosition){s._lastValidPosition=new r.Vector3().getPositionFromMatrix(t.matrix)}var D=new r.Plane().setFromNormalAndCoplanarPoint(A.viewer.currentViewpoint.getSightDirection(),s._lastValidPosition);var C=A.intersection.ray.intersectPlane(D);var B=null;if(A.manipulator._initNormal){B=A.manipulator._initNormal}else{B=A.viewer.currentViewpoint.getSightDirection().normalize().negate()}u=l.getMatrixFromOVz(C,B)}}if(t.constraintReferential===k.EConstraintReferential.Screen){z(v)}else{switch(t.constraint){case k.EConstraint.Pick:var y=v.intersection.position&&v.intersection.path.length;if(y){s._lastValidPosition=v.intersection.position;var x=v.intersection.normal.clone().normalize();u=l.getMatrixFromOVz(v.intersection.position,x)}else{z(v)}break;case k.EConstraint.XYPlane:case k.EConstraint.XZPlane:case k.EConstraint.YZPlane:case k.EConstraint.CustomPlane:u=t.matrix.clone();var w=new r.Vector3().addVectors(s.initial3dIntersectionPoint,v.translationVector);u.setPosition(w);break;default:break}}return u},_changePropertiesFromPropSet:function(v,s){var t=v.GetHashing();var w=new d();w.AddOrModifyPropertySet(t,s);var u=new q(this._experienceBase.getManager("VCXScenarioManager"),this._experienceBase.getManager("VCXCommandManager"));u.ChangePropertiesFromMap(w);this._experienceBase.getManager("VCXCommandManager").Push(u)},refreshHandlesVisAndPositions:function(z){var v=z.GetObject();var s=z.getAllInteractors();var w=this.getActiveManipulables().includes(z);for(var y in s){if(s.hasOwnProperty(y)){var u=s[y];if(u.handle){var x=u.handle;if(this._manipulationInProgress){x.isDisplayed()&&x.Hide()}else{if(w&&this.bManipulationsAllowed&&u.active){!x.isDisplayed()&&x.Show()}else{x.isDisplayed()&&x.Hide(true)}}if(x.isDisplayed()){var t=new r.Vector3().getPositionFromMatrix(u.matrix);x.setPosition(t.x,t.y,t.z)}}if(!this.bManipulationsAllowed){this.unsubscribeInteractor(v,u,true)}}}z.updateDashedOutline&&z.updateDashedOutline(z.isActive())},refreshHandlesFromComponentList:function(v){for(var s=0;s<v.length;++s){var u=v[s];var t=u&&u.QueryInterface("VCXIManipulable");if(t){this.refreshHandlesVisAndPositions(t)}}},getActiveManipulables:function(){var S=[];var w=[];var Q=this._experienceBase.getManager("VCXSelectionManager");var T=Q.GetComponentsFromSelection("CSO");var E=[];for(var K=0;K<T.length;++K){var R=T[K];var t=R.QueryInterface("VCXIManipulable");if(!t){continue}var L=t.getAllInteractors();for(var v in L){if(L.hasOwnProperty(v)){var C=L[v];if(C.handleInfos&&C.handleInfos.stayVisible){S.push(t);break}}}E.push(t)}if(E.length>1){var u=true;if(this._lastManipulablesSelected&&this._lastManipulablesSelected.length>1&&E.length===this._lastManipulablesSelected.length){for(var F=0;F<E.length;++F){var J=E[F];if(!this._lastManipulablesSelected.indexOf(J)){u=false;break}}}else{u=false}if(u){w=this._lastReturnedList.slice()}else{if(this._disabledInteractors){var y=Object.keys(this._disabledInteractors);for(var M=0;M<y.length;++M){var x=y[M];var G=this._experienceBase.ComponentsMap.GetComponentFromID(x);var J=G&&G.QueryInterface("VCXIManipulable");if(J){J.enableInteractors(this._disabledInteractors[x])}}this._disabledInteractors={}}var N=[];var I=true;for(var Y=0;Y<E.length;++Y){var t=E[Y];var L=t.getActiveInteractors();var B=Object.keys(L);if(I){for(var v in L){if(L.hasOwnProperty(v)){var C=L[v];if(C.enableMultiSelect){N.push(v)}}}I=false}else{for(var D=0;D<N.length;++D){var H=N[D];if(!H){continue}var C=L[H];if(!C||!C.enableMultiSelect){N[D]=null}}}}N=N.filter(function(ab){return Boolean(ab)});if(N.length!==0){var A=[];for(var Y=0;Y<E.length;++Y){var J=E[Y];var W=J.getActiveInteractors();var U=Object.keys(W);var V=U.slice();for(var D=0;D<N.length;++D){var aa=N[D];var O=U.indexOf(aa);if(O>=0){V[O]=null}}var x=J.GetObject().GetID();if(!this._disabledInteractors){this._disabledInteractors={}}if(!this._disabledInteractors[x]){this._disabledInteractors[x]=[]}this._disabledInteractors[x]=V.filter(function(ab){return Boolean(ab)});J.disableInteractors(this._disabledInteractors[x]);if(U.length!==this._disabledInteractors[x].length){w.push(J)}}}}}else{if(this._disabledInteractors){var y=Object.keys(this._disabledInteractors);for(var M=0;M<y.length;++M){var x=y[M];var G=this._experienceBase.ComponentsMap.GetComponentFromID(x);var J=G&&G.QueryInterface("VCXIManipulable");if(J){J.enableInteractors(this._disabledInteractors[x])}}}this._disabledInteractors={};if(E.length===0){var s=Q.GetComponentsFromSelection("PSO");var P=[];for(var K=0;K<s.length;++K){var G=s[K];var J=G.QueryInterface("VCXIManipulable");if(J){P.push(J)}}if(P.length===1&&P[0]&&P[0].isActive()){w=[P[0]]}else{w=[]}}else{if(E.length===1&&E[0]&&E[0].isActive()){w=[E[0]]}}}this._lastManipulablesSelected=E.slice();this._lastReturnedList=w.slice();for(var z=0;z<S.length;++z){var X=S[z];var Z=w.indexOf(X);if(Z>=0){S[z]=null}}S.filter(function(ab){return Boolean(ab)});return S.concat(w)},update:function(u){this._parent(u);if(!this.bManipulationsAllowed){return}if(!(Array.isArray(this._iManipulables)&&this._iManipulables.length>0)){return}var v=this.getActiveManipulables();for(var s=0;s<this._iManipulables.length;s++){var t=this._iManipulables[s];if(!t.isManipulated()){if(v.includes(t)){this.updateManipulatorsOfManipulable(t)}else{this.disableManipulable(t);t.updateDashedOutline&&t.updateDashedOutline(false)}}}},postRender:function(s){this._parent(s)},setManipulatorsRequirements:function(s){if(!s){return}if(typeof s.active==="boolean"){this._manipulatorsActive=s.active}if(typeof s.preActive==="boolean"){this._manipulatorsPreactive=s.preActive}},getManipulatorsRequirements:function(){return{activated:this._manipulatorsActive,preActivate:this._manipulatorsPreactive}},_manageCursorPreactivate:function(u,t){var s="grab";var v=u&&u.cursorPreactivate;if(typeof v==="function"){return v(u,t)}else{if(typeof u.cursorPreactivate==="string"){return u.cursorPreactivate}}return s},_beginPreactivateCB:function(u){var t=this;var s=this._experienceBase.getManager("VCXGUIManager");return function(x){var w=x.manipulator.interactor;var v=t._manageCursorPreactivate(w,x);if(!t._manipulationInProgress){s.SetCursor(v)}u.interact(x)}},_preactivateCB:function(u){var t=this;var s=this._experienceBase.getManager("VCXGUIManager");return function(x){var w=x.manipulator.interactor;var v=t._manageCursorPreactivate(w,x);if(!t._manipulationInProgress){s.SetCursor(v)}var y=x.intersection.position;u.interact(x)}},_endPreactivateCB:function(u){var t=this;var s=this._experienceBase.getManager("VCXGUIManager");return function(v){if(!t._manipulationInProgress){s.SetCursor("default")}u.interact(v)}},_beginManipulateCB:function(t){var s=this;return function(y){t._inManipulation=true;s._manipulationInProgress=true;var w=s._experienceBase.getManager("VCXContextManager");var z=w.getMainViewer();z.setPrePicking({activated:false});z.currentViewpoint.control._oldCursor="default";var v=y.manipulator.interactor;var B=v&&v.cursorManipulate||"grabbing";var u=s._experienceBase.getManager("VCXGUIManager");u&&u.SetCursor(B);var x=0;var D=v.id.split("Anchor.")[1];if(D){x=parseInt(D)}var C=t.QueryInterface("VCXIModifiable");var A=C&&C.GetAnchorWorldMatrix(x,{viewer:z,viewpoint:z.currentViewpoint});if(A){y.manipulator._initNormal=l.getVzFromMatrix(A);y.manipulator._initPosition=l.getOFromMatrix(A)}t.interact(y);s._experienceBase.getManager("VCXCommandManager").StartTransaction()}},_manipulateCB:function(t){var s=this;return function(x){var w=x.manipulator.interactor;var v=w&&w.cursorManipulate||"grabbing";var y=s._experienceBase.getManager("VCXGUIManager");y&&y.SetCursor(v);w.requestedMatrix=s._computeRequestedMatrix(x);x.requestedMatrix=w.requestedMatrix;t.interact(x);if(w.requestedMatrix){w.requestedMatrix=null}if(w.requestedPropertySet){var u=t.QueryInterface("VCXIModifiable");s._changePropertiesFromPropSet(u,w.requestedPropertySet);w.requestedPropertySet=null}}},_endManipulateCB:function(t){var s=this;return function(x){t._inManipulation=false;s._manipulationInProgress=s.checkManipulationInProgress();if(!s._manipulationInProgress){var v=s._experienceBase.getManager("VCXContextManager");var y=v.getMainViewer();y&&y.setPrePicking({activated:true});s.refreshHandlesVisAndPositions(t)}var w=x.manipulator.interactor;w.requestedMatrix=s._computeRequestedMatrix(x);x.requestedMatrix=w.requestedMatrix;t.interact(x);if(w.requestedMatrix){w.requestedMatrix=null}if(w.requestedPropertySet){var u=t.QueryInterface("VCXIModifiable");s._changePropertiesFromPropSet(u,w.requestedPropertySet);w.requestedPropertySet=null}s._experienceBase.getManager("VCXCommandManager").EndTransaction();var z=s._experienceBase.getManager("VCXGUIManager");z.SetCursor("default");if(x.manipulator._initNormal){delete x.manipulator._initNormal;delete x.manipulator._initPosition}}},_primPointerClickCB:function(t){var s=this;return function(u){t.interact(u)}},_primPointerDblClickCB:function(t){var s=this;return function(u){t.interact(u)}},});Object.defineProperty(g.prototype,"componentType",{enumerable:true,get:function(){return"VCXManipulatorManager"}});Object.defineProperty(g.prototype,"bManipulationsAllowed",{enumerable:true,get:function(){var s=this._experienceBase.getManager("VCXContextManager");var t=s&&s.getContext();var v=b.getCommand("VCXTransformFreeDragCmd",t);if(v&&v.isRunning()){return false}var u=this._experienceBase.getManager("VCXScenarioManager").GetIsPlayingCurrentScenario()||this._experienceBase.getManager("VCXVisuManager").isInTransitionMode();if(u){return false}return this._manipulatorsActive},set:function(){},});return g});