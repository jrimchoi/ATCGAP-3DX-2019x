define("DS/Latency/TestReportFormatter",["UWA/Core","UWA/String","i18n!DS/Latency/assets/nls/latency"],function(c,a,b){return{formatFile:function(h){var k=c.Utils.Client,j=h.testResults,g=h.date||new Date(),e=h.buildDeploy,d=h.geolocation,i=c.Utils.Client.getSize(),f="----"+Array(b.configurationFile.length+1).join("-");return"\t\t\t"+f+"\r\n\t\t\t| "+b.configurationFile+" |\r\n\t\t\t"+f+"\r\n\r\n\t"+a.format(b.colon,b.date,g.toLocaleDateString(window.dsLang,{timeZone:"UTC",weekday:"long",year:"numeric",month:"2-digit",day:"2-digit",hour:"numeric",minute:"numeric",timeZoneName:"short"}))+"\r\n\r\n\t"+a.format(b.separator,a.format(b.colon,b.browser,k.Engine.name.ucfirst()),a.format(b.colon,b.version,k.Engine.version))+"\r\n\r\n\t"+a.format(b.colon,b.operationSystem,k.Platform.name)+"\r\n\r\n\t"+a.format(b.colon,b.orientation,b[k.getOrientation()])+"\r\n\t"+a.format(b.colon,b.resolution,"")+"\r\n\t\t"+a.format(b.colon,b.screen,"")+"\r\n\t\t\t"+a.format(b.colon,b.width,window.screen.width)+"\r\n\t\t\t"+a.format(b.colon,b.height,window.screen.height)+"\r\n\t\t"+a.format(b.colon,b.viewport,"")+"\r\n\t\t\t"+a.format(b.colon,b.width,i.width)+"\r\n\t\t\t"+a.format(b.colon,b.height,i.height)+"\r\n\t"+(d?(b.geolocation+"\r\n\t\t"+a.format(b.colon,b.latitude,d.coords.latitude)+"\r\n\t\t"+a.format(b.colon,b.longitude,d.coords.longitude)+"\r\n"):"")+"\r\n\t"+b.platforms+":\r\n"+j.map(function(l){return"\t\t"+a.format(b.colon,b.name,l.platformId)+"\r\n\t\t\t"+a.format(b.valueInMilliseconds,a.format(b.colon,b.latency,l.latency.toFixed(1)))+"\r\n\t\t\t"+a.format(b.valueInMegabitsPerSecond,a.format(b.colon,b.downloadRate,l.downloadRate.toFixed(1)))+"\r\n"}).join("")+"\r\n\t"+a.format(b.colon,a.format(b.separator,b.build,b.deploy),e)+"\r\n"},formatFileName:function(e){e=e||{};var d=e.date||new Date();return"browserInformation_"+d.toISOString().replace("T","_").replace(":","-").split(":")[0]+".txt"}}});define("DS/Latency/ReportModel",["UWA/Class/Model"],function(b){var a={good:"good",average:"average",bad:"bad"};return b.extend({defaults:{latency:-1,downloadRate:-1,platformId:""},getLatencyScore:function(){var c=120,e=350,d=this.get("latency");if(d<=c){return a.good}if(d>e){return a.bad}return a.average},getDownloadRateScore:function(){var c=16,e=4,d=this.get("downloadRate");if(d>=c){return a.good}if(d<e){return a.bad}return a.average}})});define("DS/Latency/TestRunner",["UWA/Core","UWA/Class","DS/WebappsUtils/Performance","DS/i3DXCompassServices/i3DXCompassServices"],function(h,d,e,a){var c={idle:"idle",running:"running",aborting:"aborting"},g={latency:{path:"/webapps/LatencyResources/assets/images/latency_small.png",sizeMb:0*8},downloadRate:{path:"/webapps/LatencyResources/assets/images/download_20mb.jpg",sizeMb:20*8}},b={tenants:null};function f(){try{return e.now()}catch(i){return Date.now()}}return d.extend({init:function(i){i=i||{};this._tenantId=i.tenantId;this._state=c.idle},start:function(){var j=this,i=[];j._checkState("start",c.idle);j._state=c.running;return j._getTenantsUnderTest().then(function(k){return k.map(function(l){return j._runTestOnTenant.bind(j,l)}).reduce(function(m,l){return m.then(l).then(function(n){i.push(n)})},Promise.resolve()).then(function(){j._state=c.idle;return i},function(l){j._state=c.idle;throw l})})},abort:function(){this._checkState("abort",c.running);this._state=c.aborting},_checkState:function(j,i){if(this._state!==i){throw new Error("Cannot "+j+" test during non-"+i+" state")}},_getTenantsUnderTest:function(){var i=this;return(b.tenants?Promise.resolve(b.tenants):i._getTenantData("3DSwym")["catch"](function(){return i._getTenantData("3DSpace")})).then(function(j){b.tenants=j;return i._tenantId?j.filter(function(k){return k.platformId===i._tenantId}):j})},_getTenantData:function(i){return new Promise(function(k,j){a.getServiceUrl({serviceName:i,onComplete:function(l){if(l.length>0&&l[0].url){k(l)}else{j(l)}},onFailure:function(l){j(l)}})})},_runTestOnTenant:function(l){var k=this,j=l.url,i=h.clone(l);return k._runLatencyTest(j).then(function(m){i.latency=m;return k._runDownloadRateTest(j)}).then(function(m){i.downloadRate=m;return i})},_runLatencyTest:function(i){return this._getResponseTime({baseUrl:i,testResourcePath:g.latency.path,totalRequests:10}).then(function(j){return j/2})},_runDownloadRateTest:function(i){return this._getResponseTime({baseUrl:i,testResourcePath:g.downloadRate.path,totalRequests:2}).then(function(j){return g.downloadRate.sizeMb/(j/Math.pow(10,3))})},_getResponseTime:function(j){var m=this,l=j.baseUrl,k=j.testResourcePath,i=j.totalRequests,n=[];return new Promise(function(q,p){function o(){var r;function s(){n.push(f()-r);if(m._state===c.aborting){return p({reason:"aborted"})}if(n.length<i){o()}else{q(n.reduce(function(t,u){return t+u},0)/i)}}r=f();h.createElement("img",{src:l+k+"?random="+Math.random(),events:{load:s,error:p}})}o()})}})});define("DS/Latency/ReportItemView",["UWA/Class/View","UWA/String","i18n!DS/Latency/assets/nls/latency","css!DS/Latency/Latency"],function(c,a,b){return c.extend({render:function(){var f=this.model.collection.length>1,e=f?"h4":"h2",d=f?"h4":"h1",g;g=[{tag:"div","class":"rate-element latency",html:[{tag:"div","class":e+" latency-label",text:b.latency},{tag:"div","class":d+" latency-value "+this.model.getLatencyScore(),text:a.format(b.valueInMilliseconds,this.model.get("latency").toFixed(1))}]},{tag:"div","class":"rate-element download",html:[{tag:"div","class":e+" download-label",text:b.downloadRate},{tag:"div","class":d+" download-value "+this.model.getDownloadRateScore(),text:a.format(b.valueInMegabitsPerSecond,this.model.get("downloadRate").toFixed(1))}]}];if(f){g.unshift({tag:"div","class":"h5",text:a.format(b.colon,b.platformName,this.model.get("platformId"))})}this.container.addContent(g)}})});define("DS/Latency/ReportCollectionView",["UWA/Class/View","DS/Latency/ReportItemView"],function(b,a){return b.extend({render:function(){this.collection.map(function(c){return new a({model:c,collection:this.collection,container:this.container})},this).forEach(function(c){c.render()})}})});define("DS/Latency/ReportCollection",["UWA/Class/Collection","DS/Latency/ReportModel"],function(b,a){return b.extend([],{model:a})});define("DS/Latency/SupportDialogBuilder",["UWA/Core","UWA/String","DS/UIKIT/Alert","DS/UIKIT/Spinner","DS/UIKIT/Input/Button","DS/Latency/TestRunner","DS/Latency/TestReportFormatter","DS/Latency/ReportModel","DS/Latency/ReportCollection","DS/Latency/ReportCollectionView","i18n!DS/Latency/assets/nls/latency","css!DS/Latency/Latency"],function(e,a,g,c,h,j,k,b,d,i,l){function f(q){var r=q.content,p=q.name,o=new Blob([r],{type:"text/html"}),n;if(e.Utils.Client.Engine.name==="ie"){window.navigator.msSaveBlob(o,p)}else{if(e.Utils.Client.Features.touchEvents===true){var m=btoa(unescape(encodeURIComponent(r)));window.open("data:text/plain;charset=UTF-8;base64,"+m,"UTF-8 Text")}else{n=e.createElement("a",{text:l.download,href:URL.createObjectURL(o),target:"_blank",download:p});document.body.appendChild(n);n.click();document.body.removeChild(n)}}}return{build:function(z){var n=z.container,o=z.tenantId,m=z.buildDeploy,u=new j({tenantId:o}),s="template-cont",q="network-title",v=n.getBody().getElement("."+s),p,w,y,r,x,t;navigator.geolocation.getCurrentPosition(function(A){x=A});v.empty();v.setAttribute("class",s);v.addClassName("support");v.setStyle("height","355px");v.setStyle("padding","10px");v.appendChild(e.createElement("div",{html:{tag:"h3","class":q,text:l.networkPerformance}}));p=e.createElement("div",{"class":"spinner-support"}).inject(v);new c().inject(p).show();w=new h({className:"input-submit primary",value:l.downloadInformationFile,disabled:true,events:{onClick:function(){var A=new Date();f({name:k.formatFileName({date:A}),content:k.formatFile({testResults:r,date:A,buildDeploy:m,geolocation:x,})})}}});y=new g({closable:false,visible:true,messages:[{message:l.errorLatency,className:"warning"}]});n.getFooter().show();n.setFooter(w);t=new MutationObserver(function(A){[].forEach.call(A[0].removedNodes,function(B){if(B.hasClassName(q)||B.getElement("."+q)){t.disconnect();try{u.abort()}catch(C){}}})});t.observe(v.parentElement,{childList:true,subtree:true});return u.start().then(function(B){r=B;var C=new d(),A=new i({collection:C,container:e.createElement("div").inject(v)}),D=B.map(function(E){return new b(e.extend({collection:C},E))});C.add(D);p.remove();w.setDisabled(false);A.render()},function(A){if(e.is(A,"object")&&A.reason==="aborted"){return}p.remove();y.inject(v)})}}});