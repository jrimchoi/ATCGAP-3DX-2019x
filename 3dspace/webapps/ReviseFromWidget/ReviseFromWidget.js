define("DS/ReviseFromWidget/NewRevisionFromTree",["UWA/Class","UWA/Class/Events","DS/UIKIT/Mask","DS/LifecycleServices/LifecycleServicesSettings","DS/LifecycleServices/LifecycleServices","DS/WAFData/WAFData","DS/LifecycleControls/AssemblyTreeList","DS/UIKIT/Input/Select","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","DS/LifecycleServices/AssemblyJson"],function(j,e,g,a,d,i,f,h,c,k){var b=j.extend(e,{init:function(m,p,o,l){this.roots=[];this.tenant=p;this.context=o;for(var n=0;n<m.length;++n){this.roots.push({id:m[n]})}this.filterDuplicateInstances=l},openAdvancedTree:function(l,n,m){if(!this.container){this.container=l;this.container.setStyle("min-height","250px");g.mask(this.container);if(!m){this.createExpandedTree(n)}else{this.createTree(m,n)}}},getAssembly:function(){return this.assembly},getInstances:function(l){return this.treeList.getSameNodes(l)},getNewRevFromData:function(n,r){var l=this.treeList.tree.getDocument().getNthRoot(0);var q=[];var m=[];var s=0;this.addNodeData(q,l,m,s,n,r);var p={physicalid:l.options.physicalId,treeData:q};var o=[];o.push(p);return o},addNodeData:function(K,B,G,l,q,F){if(G.indexOf(B.options.nodeId)!==-1){return}G.push(B.options.nodeId);var C=B.dropdownListSelectedIndex;var J=C?C.action:0;var E=this.getOptions({occId:B.options.occId}).options;var x=E[J];if(x==="exclude"){return}var H=x==="insertnew";var A=x==="reuse";var M=k.getOccurence(this.assembly,B.options.occId);if(H&&F&&M.insertedInstance){return}var D=k.getNode(this.assembly,B.options.nodeId);var L={physicalid:!H?D.clonedFromPhysicalid?D.clonedFromPhysicalid:B.options.physicalId:"",operation:x,physicalid_dup:B.options.physicalId,level:l};if(!A&&B.hasChildren()){L.children=[];var r=B.getChildren();var m=r.length;var u=0;for(u=0;u<m;u++){var t=r[u];var p=k.getNode(this.assembly,t.options.nodeId);var o=t.dropdownListSelectedIndex;var I=o?o.action:0;var n=this.getOptions({occId:t.options.occId}).options;var w=n[I];if(w==="exclude"){continue}var s=w==="insertnew";var z=w==="reuse";var v=k.getOccurence(this.assembly,t.options.occId);if(s&&F&&v.insertedInstance){continue}var y={physicalid:!s?p.clonedFromPhysicalid?p.clonedFromPhysicalid:t.options.physicalId:"",operation:w,physicalid_dup:t.options.physicalId};if(q){if(v.refOccRelId){y.rel_physicalid=v.refOccRelId}if(v.relId){y.rel_physicalid_dup=v.relId}}L.children.push(y);if(!z&&(!s||F)&&t.hasChildren()){this.addNodeData(K,t,G,l+1,q,F)}}}K.push(L)},getOptions:function(o){var m=k.getOccurence(this.assembly,o.occId);var l=[];var n=[];if(m.actionInfo){if(m.actionInfo.revise){l.push("revise");n.push(c.revise)}if(m.actionInfo.reuse){l.push("reuse");n.push(c.reuse)}if(m.actionInfo.insertnew){l.push("insertnew");n.push(c.insert)}if(m.actionInfo.exclude){l.push("exclude");n.push(c.exclude)}}else{l.push("");n.push("")}return{options:l,translated:n}},createExpandedTree:function(l){var m=this;d.getSecurityContextPromise(this.tenant,this.context).then(function(n){m.expandStructure(n,function(o){g.unmask(m.container);m.assembly=k.convertFromExpandFormat(o);m.updateAssemblyNodesWithParentInfo();m.createAdvancedTree(l);var p={};m.dispatchEvent("onTreeCreated",p)})})},createTree:function(l,m){var n=this;g.unmask(n.container);n.assembly=l;n.createAdvancedTree(m);var o={};n.dispatchEvent("onTreeCreated",o)},createAdvancedTree:function(n){var p=["revision"];if(n.addActionCol){p.push("action")}this.treeList=new f({getChildrenInTreeOrder:n.getChildrenInTreeOrder,allCols:p});var r={filterDuplicates:this.filterDuplicateInstances};this.container.setContent(this.treeList);var q=this;if(n.addActionCol){var l={column:"action",translated:c.action};this.treeList.insertDropdownListCol(0,l.column,l.translated,function o(s){return q.getOptions(s).translated},function m(t,s,u){var w=q.treeList.getSameNodes(u.options.nodeId);w.forEach(function(x){var y=x.getAllDescendants();y.forEach(function(A){var z=q.treeList.getSameNodes(A.options.nodeId);q.treeList.setDropdownSelectionIf(z,0,l.column)})});var v={preSelIdx:t,selIdx:s,selNodes:w};q.dispatchEvent("onDropdownListChange",v);q.treeList.tree.getManager().updateView()})}this.treeList.load(this.assembly,p,r);this.container.getElement(".wux-layouts-gridengine").setStyle("min-height","150px");this.adjustHeight();this.treeList.tree.getDocument().expandAll()},setTreeNodeChildrenToReuse:function(n){var m=this;var l=[];if(n.hasChildren()){n.getChildren().forEach(function(o){var p=m.treeList.getSameNodes(o.options.nodeId);p.forEach(function(q){var s=q.options.occId;var r=k.getOccurence(m.assembly,s);if(r.actionInfo.revise&&r.actionInfo.reuse){l.push(q)}})})}m.treeList.setDropdownSelectionIf(l,1,"action")},updateAssemblyNodesWithParentInfo:function(){var l=this;l.assembly.nodes.forEach(function(m){if(m.followsParent===undefined){m.followsParent=m.type==="CATIA Embedded Component"||m.type==="3DShape"}})},getHtmlParent:function(l,n){var m=l;do{if(m.className===n){return m}m=m.getParent()}while(m!==null)},getParentHeight:function(n){var m=this.getHtmlParent(this.container,"reviseFrom_popup");if(m==null){return 0}var l=Number(m.getStyle("height").slice(0,-2));var o=n.getBoundingClientRect().top-m.getBoundingClientRect().top;return l-o},adjustHeight:function(){var m=this.container.getElements(".wux-layouts-gridengine");for(var n=0;n<m.length;++n){var o=m[n];var l=this.getParentHeight(o);o.setStyle("height",l)}},sortOccRelsOnOrder:function(){if(!this.assembly){return}if(!this.assembly.occurrencerelationships){return}this.assembly.occurrencerelationships.sort(function(m,l){if(m.parent>l.parent){return 1}if(m.parent<l.parent){return -1}if(m.order&&l.order){if(m.order>l.order){return 1}if(m.order<l.order){return -1}}return 0})},expandStructure:function(o,l){var n=this;var p={intent:"explore_2D",debug:false,type_filter_bo:["CATProduct","CATProcess","CATPart","CATDrawing","CATAnalysis","CATIA Embedded Component","CATIA CGR","CATShape","CATIA V4 Model","CATIA Design Table","VPMReference","VPMRepReference","3DShape"],roots:this.roots,level:"-1",source:"cstorage",authored:true,root_physicalid:this.roots[0].id};var m=a.get3DSpaceWSUrl(this.tenant,"/resources/enopad/lwc/expand",null);i.authenticatedRequest(m,{method:"POST",headers:a.getHeaders(o),timeout:600000,data:JSON.stringify(p),type:"json",onComplete:function(q){l(q)},onFailure:function(r){var q=r;if(r.hasOwnProperty("error")){q=r.error}else{if(r.hasOwnProperty("message")){q=r.message}}n.dispatchEvent("onError",q);console.error("NewRevisionFromTree.expandStructure: onFailure -> "+r)},onTimeout:function(q){n.dispatchEvent("onError",c.connectionTimeout);console.log("NewRevisionFromTree.expandStructure timeout error -> "+q)}})}});return b});define("DS/ReviseFromWidget/ReviseFromModel",["UWA/Controls/Abstract"],function(b){var a=b.extend({init:function(){this.histLinksNodes={};this.histLinksConnections={}},setHistLinksData:function(d){var c=JSON.parse(d);if(c.hasOwnProperty("nodes")){this.histLinksNodes=c.nodes}if(c.hasOwnProperty("connections")){this.histLinksConnections=c.connections}},getHistLinksNodes:function(){return this.histLinksNodes},getHistLinksConnections:function(){return this.histLinksConnections},getDuplicates:function(n,q){var m=[];var g=[];var p;for(var h=0;h<this.histLinksNodes.length;++h){if(this.histLinksNodes[h].id===n){p=this.histLinksNodes[h].nId;break}}for(var f=0;f<this.histLinksConnections.length;++f){var o=this.histLinksConnections[f];var c=o.typ;if(o.src===p){if(c==="duplicate"||(q&&(c==="evolution"||c==="revision"||c==="revisionFrom"))){g.push(o.trg)}}else{if(q&&o.trg===p){if(c==="duplicate"||c==="evolution"||c==="revision"||c==="revisionFrom"){g.push(o.src)}}}}for(var e=0;e<g.length;++e){for(var d=0;d<this.histLinksConnections.length;++d){var o=this.histLinksConnections[d];var c=o.typ;if(o.src===g[e]){if(c==="revision"||c==="revisionFrom"||(q&&(c==="duplicate"||c==="evolution"))){if(o.trg!=p&&g.indexOf(o.trg)<0){g.push(o.trg)}}}else{if(q&&o.trg===g[e]){if(c==="duplicate"||c==="evolution"||c==="revision"||c==="revisionFrom"){if(o.src!=p&&g.indexOf(o.src)<0){g.push(o.src)}}}}}}if(g.length>0){m=this.histLinksNodes.filter(function(k){for(var j=0;j<g.length;++j){if(g[j]===k.nId){return true}}return false})}return m},});return a});define("DS/ReviseFromWidget/ReviseFromController",["UWA/Controls/Abstract","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleServicesSettings","DS/ReviseFromWidget/ReviseFromModel","DS/WAFData/WAFData","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","DS/LifecycleServices/LifecycleCommandManager","DS/LifecycleCmd/MessageMediator"],function(g,c,a,f,i,b,e,h){var d=g.extend({tenant:null,context:null,init:function(){this.model=new f();this.commandManager=new e()},setContext:function(j){this.context=j},getDuplicates:function(k){var j=this;c.getSecurityContextPromise(this.tenant,this.context).then(function(l){j.getRevisionHistory(k,l)})},getObjectInfo:function(l,m,j){var k=this;c.getSecurityContextPromise(this.tenant,this.context).then(function(n){k.getAttributes(l,n,m,j)})},createNewRevisionFrom:function(k){var j=this;c.getSecurityContextPromise(this.tenant,this.context).then(function(l){j.reviseFromServiceRequest(k,l)})},getRevisionHistory:function(o,m){var l=this;var k=a.get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/history/links",null);var p=function(q){console.log("getRevisionHistory: COMPLETED");l.onObjectLinksDownloaded(q)};var j=function(q,r){l.dispatchEvent("onError",c.parseWebServiceError(q,r));console.log("Failed to retrive data from the server")};var n=function(q){l.dispatchEvent("onError",b.timeout);console.log("Timeout error")};if(o.hasOwnProperty("physicalid")){i.authenticatedRequest(k,{method:"GET",headers:a.getHeaders(m),timeout:600000,onComplete:p,data:"physicalid="+o.physicalid+"&depth=100",ontimeout:n,onFailure:j,type:"text"})}},onObjectLinksDownloaded:function(j){this.model.setHistLinksData(j);this.dispatchEvent("onDuplicatesRetrieved")},getAttributes:function(p,m,q,k){var l=this;var o=JSON.stringify(p);var j=a.get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/product/attributeList",null);var n=function(r){l.dispatchEvent("onError",b.timeout);console.log("Timeout error")};i.authenticatedRequest(j,{method:"POST",headers:a.getHeaders(m),timeout:600000,onComplete:q,data:o,ontimeout:n,onFailure:k,type:"json"})},reviseFromServiceRequest:function(p,m){var l=this;console.log("reviseFrom:");var o=JSON.stringify(p);var k=a.get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/revise/from",null);var q=function(x){console.log("reviseFrom: COMPLETED");if(x!==undefined&&x!==null&&x.hasOwnProperty("status")&&x.hasOwnProperty("report")){if(x.status==="failure"){var v=b.reviseFailed;for(var t=0;t<x.report.length;t++){var z=x.report[t];if(!!z.error&&z.error!==v){v=z.error;break}}l.dispatchEvent("onError",v);return}}var w={created:[],deleted:[],modified:[]};w.context=this.context;var y=x.results;function s(B){return B.level==0}var r=p.data[0].treeData.findIndex(s);var A=[];A.push(p.data[0].treeData[r]);var u=l.commandManager.findObjectDerivedFromSelection(y,A);u.forEach(function(C){var B=false;if(C.hasOwnProperty("derivedfromphysicalid")){B=true}var D={physicalid:C.physicalid,sourceObjectId:C.derivedfromphysicalid,operation:"Revise",refreshPSD:B};if(C.hasOwnProperty("folders")){w.refreshFolder=true;D.folders=C.folders}w.created.push(D)});h.dispatchEvent("onModification",w);l.dispatchEvent("onReviseSuccess")};var j=function(r,s){l.dispatchEvent("onError",c.parseWebServiceError(r,s).toString());console.log("Failed to retrive data from the server")};var n=function(r){l.dispatchEvent("onError",b.timeout);console.log("Timeout error")};i.authenticatedRequest(k,{method:"POST",headers:a.getHeaders(m),timeout:1000*60*60*6,onComplete:q,data:o,ontimeout:n,onFailure:j,type:"json"})},setTenant:function(j){this.tenant=j}});return d});define("DS/ReviseFromWidget/ReviseFromWidget",["css!DS/ReviseFromWidget/ReviseFromWidget","UWA/Core","UWA/Controls/Abstract","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleCommandManager","DS/LifecycleServices/LifecycleServicesSettings","DS/ReviseFromWidget/ReviseFromController","DS/WAFData/WAFData","DS/ReviseFromWidget/NewRevisionFromTree","DS/LifecycleServices/AssemblyJson","DS/LifecycleControls/CommandDialog","DS/LifecycleServices/DictionaryServices"],function(i,j,h,d,e,n,c,b,l,a,m,g,f){var k=h.extend({securityContext:null,context:null,tenant:null,dupes:null,pickDialog:null,refReviseFromTree:null,srcReviseFromTree:null,resReviseFromTree:null,resStructDiv:null,folderId:null,filterDuplicateInstances:false,srcStructDiv:null,srcStructDivhidden:null,irpcBehavior:false,activePDTabElPath:".facets-list > .facet.interactive.tab-behavior.selected",activePDTabName:null,activePDTabNameWidgetPref:"LCS_NRF_LastPDActiveTabName",init:function(){var o=this;this.physicalIds=[];this.onCompleteFnArr=[];this.resultRevisionCalculated=false;this.commandManager=new n();this.controller=new b()},executeCmd:function(p,o,s){this._setupEventHandlers(p,s);this.context=o.context;this.folderId=o.targetFolderId;try{if(c.getActiveFolder!==undefined){var q=c.getActiveFolder();if(q.id!==null){this.folderId=q.id;this.securityContex=q.sc!==""&&q.sc!==undefined?q.sc:this.securityContex;require(["DS/PlatformAPI/PlatformAPI"],function(t){t.publish("FolderEditor.ActiveFolderCallBack",{id:q.id,label:q.label})})}}}catch(r){this.folderId=o.targetFolderId;this.securityContex=c.getCurrentFolderSecurityContext()}this.controller.setContext(this.context);this.setObjects(p)},_handleError:function(o){document.body.style.cursor="default";this.showError(o);this._onComplete()},_saveLastPDTabPref:function(){var p=null;var o=null;if(this.srcStructDiv){o=this.srcStructDiv.getElement(this.activePDTabElPath)}if(o){p=o.dataset.name}else{if(this.activePDTabName){p=this.activePDTabName}}if(p){widget.setValue(this.activePDTabNameWidgetPref,p)}},_setupEventHandlers:function(o,p){this.addEvent("onReady",function(){this._showCommandUI(o)},this);this.addEvent("onComplete",function(){this._saveLastPDTabPref();this.onCompleteFnArr.forEach(function(q){q.apply(this)},this);p()},this);this.controller.addEvent("onDuplicatesRetrieved",function(){document.body.style.cursor="default";var q=this.controller.model.getDuplicates(this.physicalIds[0],this.irpcBehavior);if(q.length<1){this.showNotification(d.noDuplicatesCreated,"error");this._onComplete()}else{this.dupes=q;this.dispatchEvent("onReady")}},this);this.controller.addEvent("onError",this._handleError.bind(this));this.controller.addEvent("onReviseSuccess",function(q){document.body.style.cursor="default";this.showNotification(d.reviseSuccessful);this._onComplete()},this)},_showCommandUI:function(o){this.refReviseFromTree=new a([this.physicalIds[0]],this.tenant,this.context,this.filterDuplicateInstances);this.refReviseFromTree.addEvent("onTreeCreated",this._handleRefTreeCreated.bind(this));this.refReviseFromTree.addEvent("onError",this._handleError.bind(this));this.resReviseFromTree=new a([this.physicalIds[0]],this.tenant,this.context,this.filterDuplicateInstances);var p=this._renderDialogContent(o[0].displayName);var r=new g();var q=r.create(p,{title:d.newRevisionFrom,imageUrl:o[0].imageUrl||"",resizable:true,closeButton:true,onOk:function(){this.createNewRevision()},onClose:function(){this._onComplete()},enableCmd:function(){return this.resultRevisionCalculated},events:{onResizeFloating:function(){var s=this.elements.container.getElements(".wux-layouts-gridengine");for(var t=0;t<s.length;++t){var w=s[t];var v=this.elements.container.getElement(".reviseFrom_popup");var u=Number(v.getStyle("height").slice(0,-2));var x=w.getBoundingClientRect().top-v.getBoundingClientRect().top;w.setStyle("height",u-x)}}}},this);q.inject(widget.body);q.setNewBodySize({width:800,height:600});q.setNewSize({});this.onCompleteFnArr.push(function(){r.destroy()});this.addEvent("ResultRevisionCalculated",function(){this.createResultTree();r.updateUI()},this)},_renderDialogContent:function(y){var w=document.createElement("div");w.className="reviseFrom_popup";var B=j.createElement("table",{"class":"table",id:"newRevFromTable",height:"100%",width:"100%"});var r=j.createElement("thead");var t=j.createElement("tr");var C=j.createElement("th");C.setHTML(d.refStructure);C.inject(t);var z=j.createElement("th");z.setHTML(d.srcStructure);z.inject(t);var s=j.createElement("th");s.setHTML(d.resPreview);s.inject(t);t.inject(r);r.inject(B);var q=j.createElement("tbody");var x=j.createElement("tr");var o=j.createElement("td");var v=j.createElement("div",{id:"div1"});o.setHTML(v);o.inject(x);var A=j.createElement("td");this.srcStructDiv=j.createElement("div",{id:"div2",});this.srcStructDiv.style.height="100%";this.srcStructDivhidden=j.createElement("div",{id:"div3"});A.setHTML(this.srcStructDiv);A.inject(x);var u=j.createElement("td");this.resStructDiv=j.createElement("div");this.resStructDiv.style.padding="0";u.setHTML(this.resStructDiv);u.inject(x);x.inject(q);q.inject(B);this.refReviseFromTree.openAdvancedTree(v,{addActionCol:false,getChildrenInTreeOrder:true});var p=j.createElement("div",{"class":"mainDiv",styles:{"min-width":"1200px",height:"100%"}});B.inject(p);w.appendChild(p);return w},_onComplete:function(){this.dispatchEvent("onComplete")},setObjects:function(q){var p=this;if(q.length===0){throw d.noObject}else{if(q.length>1){throw d.multipleSelection}else{var o=q[0];this.tenant=o.tenant;if(o.hasOwnProperty("physicalid")&&o.physicalid===""){throw d.epmtyPhysicalId}if(o.hasOwnProperty("type")){f.getIsKindOfPromise(this.tenant,["CATPart","CATProduct","VPMReference"],o.type).then(function(r){if(!r){p._handleError(d.objectTypeNotSupported)}else{f.getIsKindOfPromise(p.tenant,["VPMReference"],o.type).then(function(s){p.irpcBehavior=s})}})}this.physicalIds.push(o.physicalid);this.tenant=o.tenant;this.commandManager.setTenant(this.tenant);this.controller.setTenant(this.tenant);document.body.style.cursor="wait";this.controller.getDuplicates(o)}}if(typeof(this.tenant)=="undefined"||this.tenant===null){this.tenant="OnPremise"}},_handleRefTreeCreated:function(o){if(this.dupes.length===1){this._renderDuplicateTree(this.dupes[0].id,this.srcStructDiv)}else{this._renderSelectionList(this.srcStructDiv,this.srcStructDivhidden)}},_handleSrcTreeCreated:function(o){this.getObjectInfo()},addPhysIdsToData:function(q,t){var p=q.nodes;var u=p.length;for(var r=0;r<u;r++){var s=p[r];var o={physicalid:s.physicalid};t.push(o)}},getObjectInfo:function(){document.body.style.cursor="wait";var r={data:[],attributes:["physicalid","attribute[MCADInteg-ClonedFrom]","attribute[PLMReference.V_DerivedFrom]","attribute[PLMEntity.V_usage]","attribute[PLMCoreRepReference.V_isOnceInstantiable]","firstRevision","nextRevisionVG","last.current","last.current.revisionable","hasReviseAccess","last.attribute[Title]","last.attribute[PLMEntity.V_Name]","logicalid","attribute[PLMReference.V_fromExternalID]","attribute[PLMEntity.PLM_ExternalID]","revision","attribute[XCADEmbeddedCmp.V_IsEmbeddedComponent]"]};if(this.irpcBehavior){r.attributes.push("majorids.bestsofar.physicalid");r.attributes.push("majorids.bestsofar.revision");r.attributes.push("majorids.bestsofar.attribute[PLMReference.V_DerivedFrom]")}var p=this.srcReviseFromTree.getAssembly();this.addPhysIdsToData(p,r.data);var o=this.refReviseFromTree.getAssembly();this.addPhysIdsToData(o,r.data);var q=this;this.controller.getObjectInfo(r,function s(u){document.body.style.cursor="default";q.onCompleteGetObjectInfo(u)},function t(u){document.body.style.cursor="default";q.showError(u);q._onComplete()})},addObjectInfo:function(p,E,u){var I=E.nodes;var M=I.length;var H=p.length;for(var N=0;N<H;N++){var G=p[N];for(var L=0;L<M;L++){var K=I[L];if(G.physicalid===K.physicalid){if(u.addClonedFrom){var v=false;var A=null;var O=G["attribute[MCADInteg-ClonedFrom]"];if(O){v=true}else{var S=G.logicalid;for(var C=0;C<H;C++){var s=p[C];if(s.physicalid!=G.physicalid&&s.logicalid===S){O=s.physicalid;v=true;break}}if(!v){O=G["attribute[PLMReference.V_DerivedFrom]"];if(O){for(var C=0;C<H;C++){var s=p[C];if(s.physicalid===O){v=true;break}}}}if(!v){var J=G["attribute[PLMReference.V_fromExternalID]"];if(J){for(var C=0;C<H;C++){var s=p[C];var r=s["attribute[PLMEntity.PLM_ExternalID]"];r+=" "+s.revision;if(r===J){O=s.physicalid;v=true;break}}}}if(!v){var J=G["attribute[PLMReference.V_fromExternalID]"];if(J){for(var C=0;C<H;C++){var s=p[C];var r=s["attribute[PLMEntity.PLM_ExternalID]"];if(s.physicalid!=G.physicalid&&J.startsWith(r)){O=s.physicalid;v=true;break}}}}if(!v){for(var C=0;C<H;C++){var s=p[C];var R=s["attribute[PLMReference.V_DerivedFrom]"];if(R&&R===G.physicalid){O=s.physicalid;v=true;break}}}if(!v){var x=G["majorids.bestsofar.physicalid"];if(x){var D=x.split("\x07");for(var C=0;C<H;C++){var s=p[C];if(s.physicalid===G.physicalid){continue}var y=s["majorids.bestsofar.attribute[PLMReference.V_DerivedFrom]"];if(y){var Q=y.split("\x07");var B=Q.some(function(o){return D.indexOf(o)>=0});if(B){O=s.physicalid;v=true;break}}}}}}if(v&&O){var z=O.split("|");A=z[0]}K.clonedFromPhysicalid=A}if(u.addFirstRevision){K.firstRevision=G.firstRevision}if(u.addNextRevision){K.nextRevision=G.nextRevisionVG}if(u.addIsRevisionable){var t=G["last.current.revisionable"];K.isRevisionable=t==="TRUE"?true:false;K.hasReviseAccess=G.hasReviseAccess}if(u.addLatestRevTitle){K.latestRevTitle=G["last.attribute[Title]"];if(!K.latestRevTitle){K.latestRevTitle=G["last.attribute[PLMEntity.V_Name]"]}}if(K.type==="3DShape"){var P=G["attribute[PLMEntity.V_usage]"];var F=G["attribute[PLMCoreRepReference.V_isOnceInstantiable]"]==="TRUE"?true:false;if(P){if(P==="3DPart"){K.followsParent=true}else{if(P==="3DShape"&&F){K.followsParent=true}else{K.followsParent=false}}}}var w=G["attribute[XCADEmbeddedCmp.V_IsEmbeddedComponent]"]==="TRUE"?true:false;if(w){K.followsParent=true}break}}}},getNodeFromPhysicalId:function(p,q){var o=p.nodes;var t=o.length;for(var r=0;r<t;r++){var s=o[r];if(s.physicalid===q){return s}}return null},verifyRootIsRevisionable:function(p){var r=m.getRootOccurenceId(p);var q=m.getNodeIdFromOccurenceId(p,r);var o=m.getNode(p,q);if(o.isRevisionable&&o.hasReviseAccess&&!o.followsParent){return true}if(o.followsParent){this.showError(d.selectParentToPerformOperation)}else{this.showRootNotRevisionableErrMsg(o)}return false},showRootNotRevisionableErrMsg:function(p){var r=p.Title;var s="<b>"+r+"</b>";var o;if(!p.isRevisionable){o="cannotBeRevised"}else{o="noReviseAccess"}var q=d.replace(d.get(o),{dispName:s,});this.showError(q)},verifyNoMultipleDuplicates:function(x,q){var p={};var o=x.nodes;var t=o.length;for(var v=0;v<t;v++){var u=o[v];if(u.clonedFromPhysicalid){var s=p[u.clonedFromPhysicalid];if(!s){p[u.clonedFromPhysicalid]=u.physicalid}else{if(u.physicalid!==s){var w=this.getNodeFromPhysicalId(q,u.clonedFromPhysicalid);var r=this.getNodeFromPhysicalId(x,s);this.showMultiDupeErrMsg(w,u,r);return false}}}}return true},showMultiDupeErrMsg:function(p,q,o){var s=p.Title+" "+p.revision;var v=q.Title+" "+q.revision;var u=o.Title+" "+o.revision;var t="<b>"+s+"</b>";var r=d.replace(d.get("multipleDuplicates"),{dupeSource:t,});r=r+"<br>";r=r+"&nbsp;&nbsp;<b>"+v+"</b><br>";r=r+"&nbsp;&nbsp;<b>"+u+"</b><br>";r=r+d.pleaseUpdateStruct;this.showError(r)},onCompleteGetObjectInfo:function(w){var z=w.results;var u=this.srcReviseFromTree.getAssembly();var t={addClonedFrom:true,addFirstRevision:true,addNextRevision:false,addIsRevisionable:false,addLatestRevTitle:false};this.addObjectInfo(z,u,t);var o=this.refReviseFromTree.getAssembly();var x={addClonedFrom:false,addFirstRevision:false,addNextRevision:true,addIsRevisionable:true,addLatestRevTitle:true};this.addObjectInfo(z,o,x);var A=m.getRootOccurenceId(u);var B=m.getNodeIdFromOccurenceId(u,A);var s=m.getNode(u,B);if(!s.clonedFromPhysicalid){var v=m.getRootOccurenceId(o);var r=m.getNodeIdFromOccurenceId(o,v);var y=m.getNode(o,r);s.clonedFromPhysicalid=y.physicalid}var p=this.verifyRootIsRevisionable(o);if(!p){this._onComplete();return}var q=this.verifyNoMultipleDuplicates(u,o);if(q===true){this.resultRevisionCalculated=true;this.dispatchEvent("ResultRevisionCalculated")}else{this._onComplete()}},createResultTree:function(){var u=this;var o=this.refReviseFromTree.getAssembly();var r=this.srcReviseFromTree.getAssembly();var q={uicontroltype:"piecewisecgrviewer",version:2,rootoccurrence:0,nodes:[],occurrences:[],occurrencerelationships:[]};var t={resOccId:0,resNodeId:0,refOccId:10000,refNodeId:10000,srcOccId:10000,srcNodeId:10000};var s=m.getRootOccurenceId(o);var p=m.getRootOccurenceId(r);this.addNode(q,t,o,s,r,p,null,null,null,1);this.srcReviseFromTree.sortOccRelsOnOrder();this.refReviseFromTree.createAdvancedTree({addActionCol:false,getChildrenInTreeOrder:true});this.srcReviseFromTree.createAdvancedTree({addActionCol:true,getChildrenInTreeOrder:false});this.resReviseFromTree.openAdvancedTree(this.resStructDiv,{addActionCol:false,getChildrenInTreeOrder:false},q);this.srcReviseFromTree.addEvent("onDropdownListChange",function(v){v.selNodes.forEach(function(B){var D=B.options.occId;var A=u.srcReviseFromTree.getAssembly();var y=u.resReviseFromTree.getAssembly();var w=m.getOccurence(A,D);var C=m.getNodeIdFromOccurenceId(y,w.resOccId);var z=m.getNode(y,C);var x=(v.selIdx===0);if(x){z.revision=z.nextRevision;z.Title=z.latestRevTitle}else{z.revision=z.currentRevision;z.Title=z.currentRevTitle}u.setChildrenToReviseOrReuse(x,o,A,y,D);if(x){u.srcReviseFromTree.setTreeNodeChildrenToReuse(B)}});u.resReviseFromTree.createAdvancedTree({addActionCol:false,getChildrenInTreeOrder:false})})},updateInsertNewResNodeForReviseOrReuse:function(o,v,t){var w=m.getNodeIdFromOccurenceId(v,t);var s=m.getNode(v,w);if(this.irpcBehavior||o){delete s.revision;delete s.Title;delete s.type_icon_url}else{s.revision="";s.Title="";s.type_icon_url=""}var u=m.getChildOccurenceIds(v,t,this.filterDuplicateInstances);var p=u.length;for(var r=0;r<p;r++){var q=u[r];this.updateInsertNewResNodeForReviseOrReuse(o,v,q)}},updateExcludeResNodeForReviseOrReuse:function(p,o,y,v){var z=m.getNodeIdFromOccurenceId(y,v);var t=m.getNode(y,z);var w=m.getOccurence(y,v);var A=m.getNodeIdFromOccurenceId(o,w.refOccId);var u=m.getNode(o,A);if(p){delete t.revision;delete t.Title;delete t.type_icon_url}else{t.revision=u.revision;t.Title=u.Title;t.type_icon_url=u.attributes.type_icon_url}var x=m.getChildOccurenceIds(y,v,this.filterDuplicateInstances);var q=x.length;for(var s=0;s<q;s++){var r=x[s];var t=m.getNode(y,z);this.updateExcludeResNodeForReviseOrReuse(p,o,y,r)}},setChildrenToReviseOrReuse:function(r,p,z,y,A){var x=this;var B=m.getNodeIdFromOccurenceId(z,A);var o=m.getChildOccurenceIds(z,A,this.filterDuplicateInstances);var s=o.length;var w=function(F){var E=x.srcReviseFromTree.getInstances(F);var D=E.every(function(H){var G=H.getParent();if(G.options.occId===A||G.options.nodeId===B){return true}var I=G.dropdownListSelectedIndex;return I.action===0});return D};var q=function(F){var K=F.options.occId;var H=m.getNodeIdFromOccurenceId(z,K);var J=m.getNode(z,H);var G=m.getOccurence(z,K);if(!G.actionInfo){return}if(G.actionInfo.insertnew){x.updateInsertNewResNodeForReviseOrReuse(r,y,G.resOccId);return}if(G.actionInfo.exclude){x.updateExcludeResNodeForReviseOrReuse(r,p,y,G.resOccId);return}var L=m.getNodeIdFromOccurenceId(y,G.resOccId);var I=m.getNode(y,L);var E=false;if(!r&&G.actionInfo.revise){G.actionInfo.revise=false;I.revision=I.currentRevision;I.Title=I.currentRevTitle;G.canBeRevised=true;if(J.followsParent){G.actionInfo.reuse=true}E=true}else{if(r&&!G.actionInfo.revise){if(G.canBeRevised){var D=w(F.options.nodeId);if(D){G.actionInfo.revise=true;if(J.followsParent){G.actionInfo.reuse=false;I.revision=I.nextRevision;I.Title=I.latestRevTitle}E=true}}}}if(E&&(!r||J.followsParent)){x.setChildrenToReviseOrReuse(r,p,z,y,K)}};for(var v=0;v<s;v++){var u=o[v];var t=m.getNodeIdFromOccurenceId(z,u);var C=this.srcReviseFromTree.getInstances(t);C.forEach(q)}},addNode:function(Z,ac,B,R,r,s,y,O,p,L){var C=null;var an=null;var N={revise:false,reuse:false,insertnew:false,exclude:false};if(s===null){N.exclude=true;var W={nodeid:ac.srcNodeId,physicalid:"0",Title:"",mod:"",type:"",cgrurl:"",attributes:{type_icon_url:""}};r.nodes.push(W);ac.srcNodeId=ac.srcNodeId+1;var I={occurrenceid:ac.srcOccId,nodeid:W.nodeid,actionInfo:N};s=ac.srcOccId;ac.srcOccId=ac.srcOccId+1;r.occurrences.push(I);if(p!==null){var al={parent:p,child:I.occurrenceid,order:L};r.occurrencerelationships.push(al)}if(O!==null){I.refOccRelId=m.getRelationshipId(B,O,R)}var S={nodeid:ac.resNodeId,physicalid:"0",Title:"",mod:"",type:"",cgrurl:"",attributes:{type_icon_url:""}};Z.nodes.push(S);ac.resNodeId=ac.resNodeId+1;an={occurrenceid:ac.resOccId,nodeid:S.nodeid};an.refOccId=R;I.resOccId=ac.resOccId;C=ac.resOccId;ac.resOccId=ac.resOccId+1;Z.occurrences.push(an);if(y!==null){var Q={parent:y,child:an.occurrenceid,order:L};Z.occurrencerelationships.push(Q)}}else{var v=m.getNodeIdFromOccurenceId(B,R);var aq=m.getNode(B,v);var X=Object.create(aq);X.nodeid=ac.resNodeId;Z.nodes.push(X);C=ac.resOccId;var aa={occurrenceid:C,nodeid:X.nodeid};aa.refOccId=R;Z.occurrences.push(aa);ac.resNodeId=ac.resNodeId+1;ac.resOccId=ac.resOccId+1;if(y!==null){var E={parent:y,child:aa.occurrenceid,order:L};Z.occurrencerelationships.push(E)}var T=m.getNodeIdFromOccurenceId(r,s);var U=m.getNode(r,T);var A=m.getOccurence(r,s);var V=false;if(O!==null){var x=m.getNodeIdFromOccurenceId(B,O);var M=m.getNode(B,x);if(M.followsParent){aq.followsParent=M.followsParent}var u=m.getOccurence(r,p);V=u.actionInfo.reuse&&!u.actionInfo.revise}U.followsParent=aq.followsParent;if(!aq.isRevisionable||!aq.hasReviseAccess||V||(!this.irpcBehavior&&aq.physicalid===U.physicalid)){N.reuse=true}else{A.canBeRevised=true;N.revise=true;var ao=m.getRootOccurenceId(r);if(s!==ao&&!aq.followsParent){N.reuse=true}X.currentRevision=this.irpcBehavior?U.revision:X.revision;X.nextRevision=aq.nextRevision;X.currentRevTitle=this.irpcBehavior?U.Title:X.Title;X.latestRevTitle=aq.latestRevTitle;X.revision=X.nextRevision;X.Title=X.latestRevTitle}A.actionInfo=N;A.resOccId=C;if(p!==null){A.relId=m.getRelationshipId(r,p,s)}if(O!==null){A.refOccRelId=m.getRelationshipId(B,O,R)}}var Y=m.getChildOccurenceIdsTreeOrder(B,R,this.filterDuplicateInstances);var ah=Y.length;var w=[];if(r!==null&&s!==null){w=m.getChildOccurenceIds(r,s,this.filterDuplicateInstances)}var ag=w.length;var H=[];for(var am=0;am<ah;am++){var J=Y[am];var t=m.getNodeIdFromOccurenceId(B,J);var G=m.getNode(B,t);var D=null;for(var ak=0;ak<ag;ak++){var ai=w[ak];if(H.indexOf(ai)!==-1){continue}var P=m.getNodeIdFromOccurenceId(r,ai);var ad=m.getNode(r,P);if((ad.clonedFromPhysicalid&&(ad.clonedFromPhysicalid===G.physicalid))||(ad.physicalid===G.physicalid)){D=ai;H.push(D);break}}var ap=am+1;this.addNode(Z,ac,B,J,r,D,C,R,s,ap);m.setOccurenceRelationshipOrder(B,R,J,ap);if(D!==null){m.setOccurenceRelationshipOrder(r,s,D,ap);if(this.filterDuplicateInstances){this.updateMatchingChildOccurrenceData(r,s,D,ap)}}}var af=H.length;if(af<ag){var F=ah;for(var aj=0;aj<ag;aj++){var ae=w[aj];var z=false;for(var ab=0;ab<af;ab++){var K=H[ab];if(ae===K){z=true;break}}if(!z){this.addNodeForInsertNew(B,r,Z,ac,s,ae,R,C,F)}}}},updateMatchingChildOccurrenceData:function(p,t,r,q){var u=m.getOccurence(p,r);var o=m.getChildOccurenceIds(p,t,false);var s=o.forEach(function(v){if(v!==r){var w=m.getOccurence(p,v);if(w.nodeid===u.nodeid){w.actionInfo=u.actionInfo;w.canBeRevised=u.canBeRevised;w.resOccId=u.resOccId;m.setOccurenceRelationshipOrder(p,t,v,q)}}})},addNodeForInsertNew:function(I,K,q,A,x,r,D,t,J){var u={revise:false,reuse:false,insertnew:true,exclude:false};var p=m.getOccurence(K,r);p.actionInfo=u;if(x!==null){p.relId=m.getRelationshipId(K,x,r)}J=J+1;var s={nodeid:A.refNodeId,physicalid:"0",Title:"",mod:"",type:"",cgrurl:"",attributes:{type_icon_url:""}};I.nodes.push(s);A.refNodeId=A.refNodeId+1;var H={occurrenceid:A.refOccId,nodeid:s.nodeid};A.refOccId=A.refOccId+1;I.occurrences.push(H);if(D!==null){var L={parent:D,child:H.occurrenceid,order:J};I.occurrencerelationships.push(L)}var y=m.getNodeIdFromOccurenceId(K,r);var B=m.getNode(K,y);var w=Object.create(B);var v=null;if(B.clonedFromPhysicalid&&B.clonedFromPhysicalid.length>0){v=m.getNodeFromPhysicalId(I,B.clonedFromPhysicalid)}if(this.irpcBehavior){if(v){w.currentRevision=this.irpcBehavior?B.revision:v.revision;w.nextRevision=v.nextRevision;w.currentRevTitle=this.irpcBehavior?B.Title:v.Title;w.latestRevTitle=v.latestRevTitle;w.revision=v.nextRevision;w.Title=v.latestRevTitle;p.insertedInstance=true;p.actionInfo.insertnew=false;p.actionInfo.revise=true;p.actionInfo.reuse=v.followsParent?false:true}else{w.currrentRevision=w.revision;w.firstRevision=B.firstRevision;w.revision=w.firstRevision}}w.nodeid=A.resNodeId;q.nodes.push(w);var C={occurrenceid:A.resOccId,nodeid:w.nodeid};C.refOccId=H.occurrenceid;q.occurrences.push(C);p.resOccId=A.resOccId;A.resNodeId=A.resNodeId+1;A.resOccId=A.resOccId+1;if(t!==null){var z={parent:t,child:C.occurrenceid,order:J};q.occurrencerelationships.push(z)}m.setOccurenceRelationshipOrder(K,x,r,J);if(this.filterDuplicateInstances){this.updateMatchingChildOccurrenceData(K,x,r,J)}var F=m.getChildOccurenceIds(K,r,this.filterDuplicateInstances);var E=F.length;for(var G=0;G<E;G++){var o=F[G];this.addNodeForInsertNew(I,K,q,A,r,o,H.occurrenceid,C.occurrenceid,J)}},_renderDuplicateTree:function(o,p){this.srcReviseFromTree=new a([o],this.tenant,this.context,this.filterDuplicateInstances);this.srcReviseFromTree.addEvent("onTreeCreated",this._handleSrcTreeCreated.bind(this));this.srcReviseFromTree.addEvent("onError",this._handleError.bind(this));this.srcReviseFromTree.openAdvancedTree(p,{addActionCol:true,getChildrenInTreeOrder:false})},_renderSelectionList:function(q,u){var t=this;var o=null;var s=c.get3DSpaceBaseUrl(t.tenant);document.body.style.cursor="wait";var r="DS/CompareWidget/PickDialog";var p="i18n!DS/CompareWidget/assets/nls/CompareWidget";require([r,p],function(z,y){var w=y.noRevision;var v=y.noAlternateDesign;y.noRevision=d.noRevisions;y.noAlternateDesign=d.noDuplicates;document.body.style.cursor="default";o=new z(q,u,s,"passport",t.irpcBehavior?false:true);t.onCompleteFnArr.push(function(){y.noRevision=w;y.noAlternateDesign=v});var x=widget.getValue(t.activePDTabNameWidgetPref);if(!x){x="alternateDesignsFacet"}if(t.pickDialog===null){var A={physicalid:t.physicalIds[0]};o.load(A,function(C){var B=q.getElement(t.activePDTabElPath);if(B){t.activePDTabName=B.dataset.name}t._renderDuplicateTree(C.physicalid,q)},x,t.irpcBehavior?false:true,t.irpcBehavior?"all":"direct",t.irpcBehavior?"all":"derivedFrom",t.context,t.tenant);t.pickDialog=o}},function(v){document.body.style.cursor="default";t.showNotification(d.commandNotSupported,"error");t._onComplete()})},clone:function(o){return JSON.parse(JSON.stringify(o))},addRelationsAndAppendInstances:function(s,q,o,t){o.sort();t.sort();var u=Math.max(o.length,t.length);for(var p=0;p<u;++p){var r=q;if(p>0){r=this.clone(q);s.push(r)}r.rel_physicalid=o.length>p?o[p]:null;r.rel_physicalid_dup=t.length>p?t[p]:null}},attachRelationships:function(t){var q=t.length;for(var u=0;u<q;++u){var y=m.getNodeFromPhysicalId(this.refReviseFromTree.assembly,t[u].physicalid);var r=m.getNodeFromPhysicalId(this.srcReviseFromTree.assembly,t[u].physicalid_dup);if(t[u].hasOwnProperty("children")){var v=t[u].children.length;for(var s=0;s<v;++s){var o=m.getNodeFromPhysicalId(this.refReviseFromTree.assembly,t[u].children[s].physicalid);var x=m.getNodeFromPhysicalId(this.srcReviseFromTree.assembly,t[u].children[s].physicalid_dup);var w=[];var p=[];if(y!==null&&o!==null){w=m.getRelationships(this.refReviseFromTree.assembly,y.nodeid,o.nodeid)}if(r!==null&&x!==null){p=m.getRelationships(this.srcReviseFromTree.assembly,r.nodeid,x.nodeid)}this.addRelationsAndAppendInstances(t[u].children,t[u].children[s],w,p)}}}},createNewRevision:function(){var o={};o.data=this.srcReviseFromTree.getNewRevFromData(!this.filterDuplicateInstances,this.irpcBehavior);o.folderid=this.folderId;if(this.filterDuplicateInstances){this.attachRelationships(o.data[0].treeData)}document.body.style.cursor="wait";this.controller.createNewRevisionFrom(o)},showNotification:function(o,q){if(typeof this.context.displayNotification==="function"){var p={eventID:((typeof q==="string")?q:"primary"),msg:o};this.context.displayNotification(p)}else{alert(o)}},showError:function(p){if(typeof this.context.displayNotification==="function"){var o={eventID:"error",msg:p};this.context.displayNotification(o)}else{alert(p)}},});return k});