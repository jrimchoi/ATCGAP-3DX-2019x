define("DS/MessageBus/MessageBus",[],function(){var g=false,m=[],d=[],e;if(window.Promise){e=Promise.resolve([window.location.origin])}else{require([["DS","WebappsUtils","Promise"].join("/")],function(p){e=p.resolve([window.location.origin])})}function h(q){var p=document.createElement("a");p.href=q;return["http:","https:"].indexOf(p.protocol)>-1&&p.host?p.protocol+"//"+p.hostname+((!p.port||p.protocol==="http:"&&p.port==="80"||p.protocol==="https:"&&p.port==="443")?"":":"+p.port):""}var o=(function(){var r={},q=0;function s(){var t=200,u=[].slice.call(window.frames).concat(window.parent===window?[]:[window.parent]);return u.map(function(v){try{return Promise.resolve({value:v,origin:v.location.origin})}catch(w){}v.postMessage({type:"MessageBus:queryOrigin"},"*");return new Promise(function(y,x){var z=q++;r[z]={window:v,callback:y};setTimeout(function(){delete r[z];x(new Error("Window did not answer origin query"))},t)}).then(function(x){return e.then(function(y){if(y.indexOf(x)===-1){throw new Error("Untrusted window returned an origin")}return{value:v,origin:x}})})})}function p(t){s().forEach(function(u){u.then(function(v){if(!v.origin||v.origin==="null"){return}t(v.value,v.origin)})["catch"](function(){})})}window.addEventListener("message",function(w){var v=w.data,u=v.options,x=w.source,t=w.origin;if(!v||!v.type){return}switch(v.type){case"MessageBus:queryOrigin":return x.postMessage({type:"MessageBus:queryOrigin:answer"},t);case"MessageBus:queryOrigin:answer":return Object.keys(r).forEach(function(y){if(r[y].window===x){r[y].callback(t);delete r[y]}});case"MessageBus:publish":return e.then(function(y){if(y[0]!=="*"&&y.indexOf(t)===-1){return}u._sourceWindow=x;a.publish(u)})}});return function(v){var t={},u=v._sourceWindow;delete v._sourceWindow;Object.keys(v).forEach(function(w){t[w]=v[w]});t.data=t.data===undefined?t.data:JSON.parse(JSON.stringify(t.data));p(function(x,w){if(x===u){return}x.postMessage({type:"MessageBus:publish",options:t},w)})}}());var b={cache:{},regex:{},compare:function(u,r){var t,q,s,p=(this.cache[r]&&this.cache[r][u]);if(typeof p!=="undefined"){return p}if(!(q=this.regex[u])){t="^"+u.split(".").map(function(w){var v="";if(s){v=s!=="#"?"\\.\\b":"\\b"}if(w==="#"){v+="[\\s\\S]*"}else{if(w==="*"){v+="[^.]+"}else{v+=w}}s=w;return v}).join("")+"$";q=this.regex[u]=new RegExp(t)}this.cache[r]=this.cache[r]||{};this.cache[r][u]=p=q.test(r);return p},reset:function(){this.cache={};this.regex={}}};function f(q,p){return function(){try{q(JSON.parse(p.data),p)}catch(r){}}}function k(){while(m.length){var p=m.shift();p&&p()}g=false;n()}function n(){while(d.length){a.unsubscribe(d.shift())}}function j(p){for(var q in p){if(p.hasOwnProperty(q)){return false}}return true}function i(p){if(!p){return function(){return true}}else{return function(s){var t=0,q=0;for(var r in p){if(p.hasOwnProperty(r)){t+=1;if((r==="topic"&&b.compare(s.topic,p.topic))||(s[r]===p[r])){q+=1}}}return t===q}}}var l=function(r,q,s,p){if(arguments.length<3){throw new Error("You must provide a channel, topic and callback when creating a Subscription instance.")}if(q.length===0){throw new Error("Topics cannot be empty")}this.channel=r;this.topic=q;this.callback=s;this.crossFrame=p};l.prototype.unsubscribe=function(){if(!this.inactive){this.inactive=true;a.unsubscribe(this)}};l.prototype.subscribe=function(p){this.callback=p;return this};var c=function(p){this.name=p||a.options.defaultChannel};c.prototype.publish=function(p){a.publish({channel:this.name,topic:p.topic,data:p.data})};c.prototype.subscribe=function(p){return a.subscribe({channel:this.name,topic:p.topic,callback:p.callback})};var a={options:{defaultChannel:"Internal"},subscriptions:{},Subscription:l,Channel:c,getSubscriptions:function(s){var p=[],u,r;for(var t in this.subscriptions){if(this.subscriptions.hasOwnProperty(t)){u=this.subscriptions[t];for(var q in u){if(u.hasOwnProperty(q)){r=u[q];p=p.concat(r.filter(i(s)))}}}}return p},channel:function(p){return new c(p)},publish:function(B){var w=B.channel||this.options.defaultChannel,t=B.topic,r=this.subscriptions[w],y,p,q,A,s,u,x={channel:w,topic:t,timestamp:new Date()};if(typeof B.data!=="undefined"){try{y=JSON.stringify(B.data)}catch(v){throw new Error("Please provide a valid Object data. Cause: "+v)}}x.data=y||"{}";if(r&&t){for(var z in r){if(r.hasOwnProperty(z)&&r[z]){p=r[z];for(s=0,u=p.length;s<u;s++){q=p[s];if(!q.inactive&&(q.crossFrame||!B._sourceWindow)&&b.compare(q.topic,x.topic)){A=f(q.callback,x);m.push(A)}}if(!g){g=true;setTimeout(k,0)}}}}B.crossFrame&&o(B)},subscribe:function(p){var r,s,q;r=new l(p.channel||this.options.defaultChannel,p.topic,p.callback,p.crossFrame);s=this.subscriptions[r.channel];if(!s){s=this.subscriptions[r.channel]={}}q=this.subscriptions[r.channel][r.topic];if(!q){q=this.subscriptions[r.channel][r.topic]=[]}q.push(r);return r},unsubscribe:function(q){var s,t,u,r,p;if(q instanceof l){s=[q]}else{if(Object.prototype.toString.call(q)==="[object Array]"){s=q}else{s=this.getSubscriptions(q)}}for(r=s.length;r--;){t=s[r];if(g){d.push(t);continue}u=this.subscriptions[t.channel];s=u&&u[t.topic];if(s){p=s.indexOf(t);if(p>-1){s.splice(p,1)}if(!s.length){delete u[t.topic];if(j(u)){delete this.subscriptions[t.channel]}}}}},reset:function(){this.unsubscribe();b.reset();this.subscriptions={}},setTrustedOrigins:function(p){var q=e||[window.location.origin];e=Promise.resolve(p).then(function(r){var s={};if(!(typeof r==="object"&&"length" in r)){throw new Error("Origins trusted by MessageBus must be an array-like object")}r=Array.prototype.slice.call(r);if(r.indexOf("*")>-1){throw new Error('MessageBus does not allow "*" as a trusted origin')}[window.location.origin].concat(r.map(function(t){return h(t)}).filter(function(t){return !!t})).forEach(function(t){s[t]=true});return Object.keys(s)})["catch"](function(r){setTimeout(function(){throw r});return q})},getTrustedOrigins:function(){return e.then(function(p){return p.slice()})}};return a});