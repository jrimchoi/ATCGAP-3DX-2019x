define("DS/WAfrCommandsArchitecture/mod_CommandsManagerComponent",["DS/WAfrHandlers/private/private_CommandHandlerUtilities","DS/WAfrHandlers/mod_HandlerComponent","DS/ApplicationFrame/Private_AfrCore","DS/CoreEvents/ModelEvents","DS/CoreEvents/Events","DS/CoreUtilities/ErrorManagement","UWA/Class/Promise","DS/ApplicationFrame/CommandsManager","DS/AfrUndoRedoUI/Private_UndoRedoManager","DS/AfrUndoRedoUI/Private_UndoStep"],function(b,C,F,o,K,s,r,w,l,m){console.error("###################################################################");console.error("## Load DS/WAfrCommandsArchitecture/mod_CommandsManagerComponent ##");console.error("## DRAFT MODULE                                                  ##");console.error("## DO NOT USE WITHOUT AFR TEAM AUTHORIZATION                     ##");console.error("###################################################################");var B={exclusiveCmdCalled:0,secondExecuteCalled:1,killedByInfra:2,askedByCmd:3};var i=false;function v(O,N){if(i){console.log(N+" : "+method)}}var x=false;var H=Object.create(null);H.CommandsManagerComponent=function(){var N=this;if(!this._private){this._private=Object.create(null)}this._private._defaultCommand=null;this._private._runningCmd=null;this._private._pausedCmds=[];this._private._executionChain=[];this._private._currentExecution=null;this._private._currentExecutionDone=true;this._private._waitingExecution=0;this._private._modelEvents=new o();K.subscribe({event:"COMMAND_MANAGER/Ending_Commands"},function(){N.endAll(undefined)});w._newCmdMgt=true};H.CommandsManagerComponent.DEFAULT_COMPONENT_NAME="AFR_CommandsManager";H.CommandsManagerComponent.prototype.initialize=function(){var N=this;x=false;return r.resolve()};H.CommandsManagerComponent.prototype.clean=function(){x=true;this.setDefaultCommand(null);return r.resolve()};H.CommandsManagerComponent.prototype.isCmdExecuting=function(N){return N.getState()===b.HandlerState.EXECUTING};H.CommandsManagerComponent.prototype.setDefaultCommand=function(O){if(O===undefined||O&&typeof O!=="string"){throw new Error("CommandsManagerComponent.setDefaultCommand can only take null or a string (commandHandlerID) as input parameter")}if(O&&((this._private._runningCmd===null&&this._private._pausedCmds.length===0&&this._private._waitingExecution===0&&this._private._currentExecutionDone)||this._private._runningCmd.getId()===O)){var N=this.getExecutionContext();f({commandHandlerId:O,executionCtx:N})}this._private._defaultCommand=O};H.CommandsManagerComponent.prototype.getDefaultCommand=function(){return this._private._defaultCommand};H.CommandsManagerComponent.prototype.subscribeToCmdState=function(Q,P,N){var O;if(Q===""){O=P}else{O=Q+"/"+P}return this._private._modelEvents.subscribe({event:O},function(R){N(R)})};H.CommandsManagerComponent.prototype.subscribeOnceToCmdState=function(Q,P,N){var O;if(Q===""){O=P}else{O=Q+"/"+P}return this._private._modelEvents.subscribeOnce({event:Q+"/"+P},function(R){N(R)})};H.CommandsManagerComponent.prototype.unsubscribeToCmdState=function(N){this._private._modelEvents.unsubscribe(N)};H.CommandsManagerComponent.prototype.getRunningCommand=function(){return this._private._runningCmd?this._private._runningCmd.getId():null};H.CommandsManagerComponent.prototype.getExposedComponentCtor=function(){var N=this;function O(){this.cancelReason=B}O.prototype.getDefaultCommand=N.getDefaultCommand.bind(N);O.prototype.getRunningCommand=N.getRunningCommand.bind(N);O.prototype.setDefaultCommand=N.setDefaultCommand.bind(N);O.prototype.isCmdExecuting=N.isCmdExecuting.bind(N);O.prototype.subscribeToCmdState=N.subscribeToCmdState.bind(N);O.prototype.unsubscribeToCmdState=N.unsubscribeToCmdState.bind(N);O.prototype.subscribeOnceToCmdState=N.subscribeOnceToCmdState.bind(N);return O};H.CommandsManagerComponent.prototype.stackCommandExecutionRequest=function(P,O){var N=Object.create(null);N.cmdsManager=this;N.cmdHandler=O.handler;var Q=O.cb;a({callback:function(R){if(!R){throw new error("mod_CommandsManagerComponent.js callback in chainNewExecution cannot start a command is no capsuleObject is passed")}if(x){return}if(Q===null||typeof Q!=="function"){Q=undefined}if(t(R.cmdHandler)){if(R.cmdsManager._private._currentExecution){R.cmdsManager._private._currentExecutionDone=true}setTimeout(function(){u.call(R.cmdsManager)},0);return}if(h(R.cmdHandler)){if(!R.cmdHandler._private._appCB){R.cmdHandler._private._appCB=[]}if(Q){R.cmdHandler._private._appCB.push(Q)}R.cmdHandler._private._command._instance.params=Object.create(null);R.cmdHandler._private._command._instance.params.cancelReason=B.secondExecuteCalled;q(R)}else{R.cmdHandler.setStateAndSendEvent({state:b.HandlerState.EXECUTING,event:b.LifeCycleEvents.BEGIN});require([R.cmdHandler._private._command._module],function(V){if(V){var T=null;var S=R.cmdsManager.getExecutionContext();if(S){T=S.applicationContext;T.ID=R.cmdsManager._private._executionContext.getId()}if(!O.args){O.args=Object.create(null)}O.args.cmdLifeCyleEventsChanel=R.cmdsManager._private._modelEvents;O.ID=R.cmdHandler.getId();V.prototype.isNewInfraActivated=function(){return true};var U=new V({args:O.args,executionContext:T,ID:O.ID});if(U){if(R.cmdHandler.isUsingComputeServer()){U.getCSIdentifier=function(){return U};U.hasDecalredCS=function(){return true};U.onCmdEnded=function(W){return D.call(R,W)}}U.getId=function(){return R.cmdHandler.getId()};U.askForUndoGroupingAtEnd=function(W){U._endUndoGroupingRequested=true;U._undoGroupID=W};U._evtID=T.ID+O.ID;R.cmdHandler._private._command._instance=U;R.cmdHandler._private._cb=P;if(!R.cmdHandler._private._appCB){R.cmdHandler._private._appCB=[]}if(Q){R.cmdHandler._private._appCB.push(Q)}L(R)}else{u.call(R.cmdsManager);throw new Error("Call to "+R.cmdHandler._private._command._module+" constructor returned undefined")}}else{console.error("Failed to load the module related to the command",R.cmdHandler._private._id)}},function(){var S=new Error("Require failed ("+R.cmdHandler._private._command._module+")");if(Q&&typeof Q==="function"){Q(S)}else{throw S}u.call(R.cmdsManager)})}},caller:N})};H.CommandsManagerComponent.prototype.endAll=function(Q){var T=this;this._private._executionChain.length=0;var P=T._private._pausedCmds;var V=[];var O=0;var N=false;this._private._waitingExecution=0;if(T._private._runningCmd&&T._private._runningCmd._private._id!=="WAFRUndoCmd"){var R=Object.create(null);R.cmdsManager=T;R.cmdHandler=T._private._runningCmd;q(R)}O=P.length;for(var U in P){var S=Object.create(null);S.cmdsManager=T;S.cmdHandler=P.pop();q(S)}K.publish({event:"COMMAND_MANAGER/ALL_CMD_ENDED"})};function L(O){if(!O||!O.cmdsManager||!O.cmdHandler||!O.cmdHandler._private._command._instance||!O.cmdHandler._private._cb||!O.cmdHandler._private._cb){throw new Error("executeCmd require the parameter capsuleObject with a valid CommandsManager and cmdHandler with a valid command instance")}v("begin",O.cmdHandler.getId());O.cmdsManager._private._modelEvents.publish({event:O.cmdHandler.getId()+"/begin"});O.cmdsManager._private._modelEvents.publish({event:"begin",data:O.cmdHandler.getId()});O.cmdsManager._private._runningCmd=O.cmdHandler;if(!O.cmdHandler._private._command._instance.beginExecute&&O.cmdHandler._private._command._instance.stateGraph!==true){throw new Error("mod_CommandsManagerComponent.executeCmd : Cannot execute a command without a beginExecute method defined on it. It has no sense. BAD Command : "+O.cmdHandler._private._command._module)}O.cmdHandler._private._command._instance._previousUndoId=l.getLastCreatedUndoStepId();if(O.cmdHandler.isUsingComputeServer()){var P={from:O.cmdHandler._private._command._instance};var N=F.sendStartCommand(P);if(!s.hasSucceeded(N)){s.logResult(N);D.call(O);return}}if(O.cmdHandler._private._command._instance.stateGraph!==true){O.cmdHandler._private._command._instance.done=J.bind(O);z({callback:O.cmdHandler._private._command._instance.beginExecute,caller:O.cmdHandler._private._command._instance})}else{if(O.cmdHandler._private._command._instance.asyncGraph===true){O.cmdHandler._private._command._instance.done=j.bind(O)}else{O.cmdHandler._private._command._instance.done=J.bind(O)}z({callback:O.cmdHandler._private._command._instance.buildGraph,caller:O.cmdHandler._private._command._instance});if(O.cmdHandler._private._command._instance.asyncGraph!==true){z({callback:O.cmdHandler._private._command._instance._initGraph,caller:O.cmdHandler._private._command._instance})}}if(O.cmdsManager._private._currentExecution){O.cmdsManager._private._currentExecutionDone=true}z({callback:function(){if(O.cmdsManager._private._currentExecutionDone&&h(O.cmdHandler)){u.call(O.cmdsManager)}}})}function M(N){if(!N||!N.cmdsManager||!N.cmdHandler){throw new Error("pauseCmd require the parameter capsuleObject with a valid cmdsManager and cmdHandler with a valid command instance")}if(h(N.cmdHandler)){v("pause",N.cmdHandler.getId());N.cmdsManager._private._modelEvents.publish({event:N.cmdHandler.getId()+"/pause"});N.cmdsManager._private._modelEvents.publish({event:"pause",data:N.cmdHandler.getId()});N.cmdHandler.setStateAndSendEvent({state:b.HandlerState.PAUSED,event:b.LifeCycleEvents.PAUSE});N.cmdsManager._private._pausedCmds.push(N.cmdHandler);if(N.cmdHandler._private._command._instance.stateGraph){N.cmdHandler._private._command._instance._unsubscribeFromAllEvents(N.cmdHandler._private._command._instance._getCurrentStateId())}if(N.cmdHandler._private._command._instance.pauseExecute){N.cmdHandler._private._command._instance.done=c.bind(N);z({callback:N.cmdHandler._private._command._instance.pauseExecute,caller:N.cmdHandler._private._command._instance})}else{z({callback:c,caller:N})}}}function n(N){v("resume",N.cmdHandler.getId());N.cmdsManager._private._modelEvents.publish({event:N.cmdHandler.getId()+"/resume"});N.cmdsManager._private._modelEvents.publish({event:"resume",data:N.cmdHandler.getId()});N.cmdHandler.setStateAndSendEvent({state:b.HandlerState.EXECUTING,event:b.LifeCycleEvents.RESUME});N.cmdsManager._private._runningCmd=N.cmdHandler;if(N.cmdHandler._private._command._instance.stateGraph){N.cmdHandler._private._command._instance._SuscribeToStateEvent(N.cmdHandler._private._command._instance._getCurrentStateId())}N.cmdHandler._private._command._instance.done=J.bind(N);if(N.cmdHandler._private._command._instance.resumeExecute){z({callback:N.cmdHandler._private._command._instance.resumeExecute,caller:N.cmdHandler._private._command._instance})}z({callback:function(){if(N.cmdsManager._private._currentExecutionDone&&h(N.cmdHandler)){u.call(N.cmdsManager)}}})}function q(N){if(!N||!N.cmdsManager||!N.cmdHandler||!N.cmdHandler._private._cb){throw new Error("cancelCmd require the parameter capsuleObject with a valid cmdsManager and cmdHandler with a valid command instance")}if(h(N.cmdHandler)){N.cmdHandler.setStateAndSendEvent({state:b.HandlerState.CANCELED,event:b.LifeCycleEvents.CANCEL});v("canceling",N.cmdHandler.getId());N.cmdsManager._private._modelEvents.publish({event:N.cmdHandler.getId()+"/canceling"});N.cmdsManager._private._modelEvents.publish({event:"canceling",data:N.cmdHandler.getId()});if(N.cmdHandler._private._command._instance.cancelExecute){N.cmdHandler._private._command._instance.done=A.bind(N);z({callback:N.cmdHandler._private._command._instance.cancelExecute,caller:N.cmdHandler._private._command._instance,arg:N.cmdHandler._private._command._instance.params})}else{z({callback:A,caller:N})}}}function A(Q){if(Q&&Q.undoOnEnd){if(!this.cmdsManager._private._runningCmd._private._command._instance.params){this.cmdsManager._private._runningCmd._private._command._instance.params={}}this.cmdsManager._private._runningCmd._private._command._instance.params.undoOnEnd=Q.undoOnEnd}this.cmdHandler._private._command._instance.done=function(){};if(this.cmdHandler.getState()!==b.HandlerState.CANCELED){this.cmdHandler.setStateAndSendEvent({state:b.HandlerState.ENDING})}if(this.cmdHandler.isUsingComputeServer()){var P={from:this.cmdHandler._private._command._instance};var N=F.sendStopCommand(P);if(s.hasSucceeded(N)){return}else{s.logResult(N)}}var O=this;setTimeout(function(){D.call(O,Q)},0)}function J(N){this.cmdHandler._private._command._instance.done=function(){};if(this.cmdsManager._private._runningCmd!==this.cmdHandler||!h(this.cmdHandler)){v("done execute callback called but command paused/canceled in between",this.cmdHandler.getId());return}this.cmdHandler._private._command._instance.params={};if(N&&N.error){this.cmdHandler._private._command._instance.params.error=N.error}if(N&&N.cancel){this.cmdHandler._private._command._instance.params.cancelReason=B.askedByCmd;if(N.undoOnEnd){this.cmdHandler._private._command._instance.params.undoOnEnd=N.undoOnEnd}q(this)}else{A.call(this)}}function j(O){var N=this;this.cmdHandler._private._command._instance.done=J.bind(N);if(this.cmdsManager._private._runningCmd!==this.cmdHandler||!h(this.cmdHandler)){v("done execute callback called but command paused/canceled in between",this.cmdHandler.getId());return}z({callback:this.cmdHandler._private._command._instance._initGraph,caller:this.cmdHandler._private._command._instance})}function c(){this.cmdHandler._private._command._instance.done=function(){};v("paused",this.cmdHandler.getId());this.cmdsManager._private._modelEvents.publish({event:this.cmdHandler.getId()+"/paused"});this.cmdsManager._private._modelEvents.publish({event:"paused",data:this.cmdHandler.getId()});this.cmdsManager._private._runningCmd=null;if(this.cmdsManager._private._currentExecution){this.cmdsManager._private._currentExecutionDone=true}var N=this;setTimeout(function(){u.call(N.cmdsManager)},0)}function D(S){if(this.cmdsManager._private._runningCmd._private._command._instance._endUndoGroupingRequested===true){l._stopConcatenateUS(this.cmdsManager._private._runningCmd._private._command._instance._undoGroupID);this.cmdsManager._private._runningCmd._private._command._instance._endUndoGroupingRequested=false}var O=null;if(this.cmdsManager._private._runningCmd._private._command._instance._createCmdGlobalUndo){O=this.cmdsManager._private._runningCmd._private._command._instance._createCmdGlobalUndo()}if(G){O=G(this.cmdsManager._private._runningCmd._private._command._instance)}if(this.cmdsManager._private._runningCmd._private._command._instance.params&&this.cmdsManager._private._runningCmd._private._command._instance.params.undoOnEnd){var P=this.cmdsManager.getExecutionContext();if(O){this.cmdsManager._private._runningCmd._private._command._instance.isCanceled=function(){return true};l.undo()}}this.cmdsManager._private._runningCmd=null;if(this.cmdsManager._private._currentExecution){this.cmdsManager._private._currentExecutionDone=true}var N=e(this.cmdHandler);var R=(this.cmdHandler.getRepeatMode()===b.RepeatMode.ALWAYS&&!N&&this.cmdsManager._private._waitingExecution===0);this.cmdHandler.setStateAndSendEvent({state:b.HandlerState.ENDED,event:b.LifeCycleEvents.END,repeated:R,canceled:N});v("end",this.cmdHandler.getId());this.cmdsManager._private._modelEvents.publish({event:this.cmdHandler.getId()+"/end",data:{repeated:R,canceled:N}});this.cmdsManager._private._modelEvents.publish({event:"end",data:{handlerId:this.cmdHandler.getId(),repeated:R,canceled:N}});if(this.cmdHandler._private._cb&&typeof this.cmdHandler._private._cb==="function"){this.cmdHandler._private._cb(S?S.error:undefined);if(!R){this.cmdHandler._private._appCB=[]}}if(this.cmdHandler._private._command._instance.destroy){this.cmdHandler._private._command._instance.destroy.call(this.cmdHandler._private._command._instance)}this.cmdHandler._private._command._instance=null;if(R){this.cmdHandler.execute();u.call(this.cmdsManager)}else{var Q=this;setTimeout(function(){if(!Q.cmdsManager._private._runningCmd){I(Q)}},0)}}function I(Q){if(Q.cmdsManager._private._runningCmd){console.error("CmdsManager.runNextCmd a command is already running")}if(!Q.cmdsManager._private._currentExecutionDone){return}var P;if(Q.cmdsManager._private._executionChain.length>0){P=Q.cmdsManager._private._executionChain[0].caller.cmdHandler}if(Q.cmdsManager._private._pausedCmds.length>0&&(!Q.cmdsManager._private._waitingExecution||P===Q.cmdsManager._private._pausedCmds[0]||P.getMode()!==b.CmdMode.NESTED)){var N=Object.create(null);N.cmdsManager=Q.cmdsManager;N.cmdHandler=Q.cmdsManager._private._pausedCmds.pop();n(N);return}else{if(Q.cmdsManager._private._waitingExecution===0&&Q.cmdsManager._private._currentExecutionDone){var O=Q.cmdsManager.getDefaultCommand();if(O){f({commandHandlerId:O,executionCtx:Q.cmdsManager.getExecutionContext()})}}}setTimeout(function(){if(Q.cmdsManager._private._waitingExecution){u.call(Q.cmdsManager)}else{if(Q.cmdsManager._private._currentExecution&&Q.cmdsManager._private._currentExecutionDone){Q.cmdsManager._private._currentExecution=null}}},0)}function f(O){if(!O.commandHandlerId){return}if(!O.executionCtx){throw new Error("mod_commandsManagerComponent.js cannot execute a command without an execution context")}var N=O.executionCtx.getComponent(C.DEFAULT_COMPONENT_NAME);if(!N){throw new Error("mod_commandsManagerComponent.js cannot execute a command without a handler component registered on the execution context")}N.executeHandler({id:O.commandHandlerId})}function E(N){return(N._private._runningCmd.getState()===b.HandlerState.PAUSED||N._private._runningCmd.getState()===b.HandlerState.CANCELED)}function h(N){return N.getState()===b.HandlerState.EXECUTING}function t(N){return N.getState()===b.HandlerState.PAUSED}function e(N){return N.getState()===b.HandlerState.CANCELED}var d=new Array(50);var k=0;function z(N){d[k]=N.callback;d[k+1]=N.caller;d[k+2]=N.arg;k+=3;if(k===3){setTimeout(g,0)}}function g(){for(var P=0;P<k;P+=3){var Q=d[P];var O=d[P+1];var N=d[P+2];Q.call(O,N);d[P]=undefined;d[P+1]=undefined;d[P+2]=undefined}k=0}function a(O){O.caller.cmdsManager._private._waitingExecution++;if(O.caller.cmdsManager._private._currentExecution||!O.caller.cmdsManager._private._currentExecutionDone||(O.caller.cmdsManager._private._runningCmd&&!h(O.caller.cmdsManager._private._runningCmd))){if(O.caller.cmdsManager._private._executionChain.length>0){O.caller.cmdsManager._private._waitingExecution--;var N=O.caller.cmdsManager._private._executionChain.pop();N.caller.cmdHandler.setStateAndSendEvent({state:b.HandlerState.ENDED,event:b.LifeCycleEvents.END,notStarted:true});if(N.caller.cmdHandler===O.caller.cmdHandler){O.caller.cmdsManager._private._waitingExecution--}else{O.caller.cmdsManager._private._executionChain.push(O)}}else{O.caller.cmdsManager._private._executionChain.push(O)}}else{var P=p(O);if(P){O.caller.cmdsManager._private._executionChain.push(O);P.caller.cmdsManager._private._currentExecution=y(P)}else{O.caller.cmdsManager._private._currentExecution=y(O)}}}function y(N){if(!N.caller.cmdsManager._private._currentExecutionDone){throw new Error("begin forbidden")}N.caller.cmdsManager._private._waitingExecution--;N.caller.cmdsManager._private._currentExecutionDone=false;setTimeout(function(){N.callback.call(undefined,N.caller)},0);return N.caller}function p(N){var O;if(N.caller.cmdHandler.getState()===b.HandlerState.PAUSED){return undefined}if(N.caller.cmdsManager._private._runningCmd&&(N.caller.cmdsManager._private._runningCmd!==N.caller.cmdHandler)&&h(N.caller.cmdsManager._private._runningCmd)){N.caller.cmdsManager._private._waitingExecution++;O=Object.create(null);O.caller=Object.create(null);O.caller.cmdsManager=N.caller.cmdsManager;O.caller.cmdHandler=N.caller.cmdsManager._private._runningCmd;if(N.caller.cmdHandler.getMode()===b.CmdMode.EXCLUSIVE||N.caller.cmdsManager._private._runningCmd._private._command._instance.cancelWhenPaused===true){O.callback=q;O.caller.cmdHandler._private._command._instance.params=Object.create(null);O.caller.cmdHandler._private._command._instance.params.cancelReason=B.exclusiveCmdCalled}else{if(N.caller.cmdHandler.getMode()===b.CmdMode.NESTED){O.callback=M}}}return O}function u(){if(!this._private._currentExecutionDone){return}if(this._private._executionChain.length===0){this._private._waitingExecution=0;this._private._executionChain=[];this._private._currentExecution=null;this._private._currentExecutionDone=true;if(!this._private._runningCmd){I({cmdsManager:this,cmdHandler:undefined})}}else{var N=p(this._private._executionChain[0]);if(!N){N=this._private._executionChain.shift()}this._private._currentExecution=y(N)}}function G(S){var N=false;if(!S._dirtyUndoStack){return N}var R=l._private._undoStack.getLastStepId();if(S._previousUndoId<R){var Q=true;if(S._mode==="shared"&&S._executeUndoAtEnd){Q=false}var P=new m({undoTitle:S.getId(),exclusivity:Q,redoEnabled:!S._executeUndoAtEnd});l.registerAction(P);var O=l._private._undoStack.groupSteps(P.getId(),S._previousUndoId+1);if(s.hasSucceeded(O)){N=true}else{var T=l._private._undoStack.removeStepWithId(l._private._undoStack.getLastStepId());if(!s.hasSucceeded(T)){s.logResult(T)}}}return N}return H});