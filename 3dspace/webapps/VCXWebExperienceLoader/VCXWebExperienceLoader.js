define("DS/VCXWebExperienceLoader/VCXExperienceSaverBase",["UWA/Class","DS/VCXWebProperties/VCXPropertyValueMap","DS/VCXWebProperties/VCXPropertyValueList","DS/WebRBTree/WebRBIterator"],function(c,d,b,a){var e=c.extend({init:function(){},_reformatObjectIDForPathOfId:function(j,f){var g=f.ComponentsMap.GetComponentFromID(j);var h;if(g){var i=f.getManager("VCXContextManager").getCat3DXIntegration();if(i&&g.QueryInterface("CATI3DExperienceObject")){h={};h.pathOfIds=g.GetID().split(",")}else{h=g.GetID()}}return h},_MetaPropertiesDefToJson:function(f){var l=[];var h=f.getManager("VCXMetaPropertyManager")._MetaPropertyDef;for(var k in h){if(h.hasOwnProperty(k)){var i=h[k];var j=i.GetPropertyInfo();var g={name:k,type:i.GetType(),behavior:j.GetBehaviorType(),defaultLabel:i.GetDefaultLabel()};if(j.IsBounded()){g.bounds=j.GetBounds()}l.push(g)}}return l},_PropertiesLinksToJson:function(n){var f=[];for(var m in n._links){if(n._links.hasOwnProperty(m)){var h=n._links[m];if(h){for(var j in h){var k=h[j];if(k){for(var i in k){if(k.hasOwnProperty(i)){var g=k[i];for(var o in g){if(g.hasOwnProperty(o)){var l={inID:m,inProp:j,outID:i,outProp:o};f.push(l)}}}}}}}}}return f},_ComponentsMapToJson:function(l){var i=[];var n=l.ComponentsMap.GetComponentTable();for(var f in n){if(n.hasOwnProperty(f)){var k=n[f];var j=k.GetPersistency();if(j!==0){continue}var m=k.GetType();var g={};g.objectID=f;g.objectType=m;var h=null;if(k.BuildLoadData){h=k.BuildLoadData()}if(h){g.objectData=h}i.push(g)}}return i},_W3AISGNodeHolderToJson:function(n){var k=[];var p=n.ComponentsMap.GetComponentTable();for(var g in p){if(p.hasOwnProperty(g)){var m=p[g];var l=m.GetPersistency();if(l===2){continue}var h={};h.objectID=g;var o=m.QueryInterface("W3AISGNodeHolder");if(o){if(!o.isSelfManagedPathElement()){var j=m.QueryInterface("VCXIModelNavigable");if(j){var i=j.getAssetNavigable();if(i){var f=o.getRelativePathElement(i);var q=this._BuildArrayIDsFromPathElement(f);h.PathElement=q;k.push(h)}}}}}}return k},_VCXIModelNavigableToJson:function(o){var l=[];var p=o.ComponentsMap.GetComponentTable();for(var g in p){if(p.hasOwnProperty(g)){var n=p[g];var m=n.GetPersistency();if(m===2){continue}var h={};h.objectID=g;var k=null;var j=n.QueryInterface("VCXIModelNavigable");if(j){if(j.isSelfOrganized()){var i=j.getWorkingRoot();if(i){h.WorkingRoot=i.GetObject().GetID();l.push(h)}}else{var f=j.getParent();if(f){h.NavigableParent=f.GetObject().GetID();l.push(h)}}}}}return l},_BuildArrayIDsFromPathElement:function(h){if(h){}else{return}var f=[];var k=h.externalPath;if(k){for(var g=0;g<k.length;g++){var j=k[g];var m=j.persistentId;var l=j.id;if(m){f.push(m.toString())}else{if(l){f.push(l.toString())}else{var n=j.name;f.push(n)}}}}return f},_NeutralsToJson:function(k){var l=[];var h=k.getManager("VCXScenarioManager")._keyframer._Neutrals;for(var n in h._map){if(h._map.hasOwnProperty(n)){var p=k.getManager("VCXScenarioManager").ModifiableServer.GetModifiableFromHashing(n);var m=p.GetObject();var i=m.GetPersistency();if(i===2){continue}var j=h.GetPropertySet(n);var o=this._PropSetToJson(j,k);var g=this._reformatObjectIDForPathOfId(m.GetID(),k);var f={objectID:g,properties:o};l.push(f)}}return l},_PropSetToJson:function(h,g){var f=[];for(var k in h._map){if(h._map.hasOwnProperty(k)){var j=h.GetProperty(k);var l=j.GetPropertyValue();var i=l.GetType();var m=this._PropertyToJson(l,g);f.push({name:k,type:i,value:m})}}return f},_PropMapToJson:function(k,m){var l={};for(var i in m._map){if(m._map.hasOwnProperty(i)){var f=m.GetPropertySet(i);var j=k.getManager("VCXScenarioManager").ModifiableServer.GetModifiableFromHashing(i);if(j){var h=j.GetObject().GetID();var g=this._PropSetToJson(f,k);l[h]=g}}}return l},_PropertyToJson:function(k,p){var r=null;var g=k.GetType();if(g==="VCXPropertyValueColor"){r=k.GetValue().GetRGBA();for(var l=0;l<r.length;l++){r[l]=r[l]}}else{if(k instanceof d){r=[];for(var l=0;l<k._value.length;l++){var f=k._value[l];if(f){var j=this._PropertyToJson(f,p);r.push({type:f.GetType(),index:l,value:j})}}}else{if(k instanceof b){r=[];for(var l=0;l<k._value.length;l++){var f=k._value[l];var j=this._PropertyToJson(f,p);r.push({type:f.GetType(),value:j})}}else{if(g==="VCXPropertyValueFrame"){r=[];var s=k.GetValue().elements;for(var u in s){if(s.hasOwnProperty(u)){if(u!=="3"&&u!=="7"&&u!=="11"&&u!=="15"){r.push(s[u])}}}}else{if(g==="VCXPropertyValueBoolean"){r=k.GetValue()}else{if(g==="VCXPropertyValueDate"){r=k.ToISOString()}else{if(g==="VCXPropertyValuePoint2D"){var o=k.GetValue();r=[];r.push(o.x);r.push(o.y)}else{if(g==="VCXPropertyValuePoint"){var n=k.GetValue();r=[];r.push(n.x);r.push(n.y);r.push(n.z)}else{if(g==="VCXPropertyValueVector"){var h=k.GetValue();r=[];for(var l=0;l<h.length;l++){r.push(h[l])}}else{if(g==="VCXPropertyValueLink"){var q=k.ToString();var m=this._reformatObjectIDForPathOfId(q,p);return m}else{var t=k.GetValue();if(typeof t==="number"){r=t}else{r=k.ToString()}}}}}}}}}}}if(typeof r!=="undefined"){}else{r="undefined"}return r},_ScenarioToJson:function(m,g){var j=[];g.GetListModifiables(j);var f=[];for(var k=0;k<j.length;k++){var q=j[k];var r=m.getManager("VCXScenarioManager").ModifiableServer.GetModifiableFromHashing(q);var n=r.GetObject();var l=n.GetPersistency();if(l===2){continue}var o=g.GetObjectAnimation(q);var h=this._TracksToJson(o,r,m);f.push(h)}var p=g.GetName();return{name:p,ID:g.GetID(),listMods:f}},_VisibilityToJson:function(f,n){var q=[];var o=[];var r=[];var l=f.GetVisibles();for(var j=0;j<l.length;j++){var m=this._reformatObjectIDForPathOfId(l[j],n);q.push({objectID:m})}var g=f.GetInvisibles();for(var j=0;j<g.length;j++){var k=this._reformatObjectIDForPathOfId(g[j],n);o.push({objectID:k})}var p=f.GetVisibleCollabs();for(var j=0;j<p.length;j++){var h=this._reformatObjectIDForPathOfId(p[j],n);r.push({objectID:h})}return{listVisible:q,listInvisible:o,listVisibleCollabs:r}},_TracksToJson:function(o,q,m){var k=[];if(o){var p=[];o.GetListTrackNames(p);for(var h=0;h<p.length;h++){var l=p[h];var g=o.GetTrack(l);var i=this._KeysToJson(g,l,m);k.push(i)}}var n=q.GetObject();var f=this._reformatObjectIDForPathOfId(n.GetID(),m);return{objectID:f,listTracks:k}},_KeysToJson:function(j,l,m){var f="";var p=[];var q=j._treekeys;var n=new a(q);var o=n.next();while(o!==null){var h=o.GetFrame();var g=o.GetValue();if(f){}else{f=g.GetType()}var i=this._PropertyToJson(g,m);p.push({time:h,value:i});o=n.next()}var k={name:l,type:f,listKeys:p};return k}});return e});define("DS/VCXWebExperienceLoader/VCXExperienceLoaderBase",["UWA/Class","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS","DS/VCXWebProperties/VCXColor","DS/VCXWebProperties/VCXPropertyValueString","DS/VCXWebProperties/VCXPropertyValueFloat","DS/VCXWebProperties/VCXPropertyValueInt","DS/VCXWebProperties/VCXPropertyValueEnum","DS/VCXWebProperties/VCXPropertyValueBoolean","DS/VCXWebProperties/VCXPropertyValueFrame","DS/VCXWebProperties/VCXPropertyValuePoint2D","DS/VCXWebProperties/VCXPropertyValuePoint","DS/VCXWebProperties/VCXPropertyValueLocation","DS/VCXWebProperties/VCXPropertyValueColor","DS/VCXWebProperties/VCXPropertyValueVector","DS/VCXWebProperties/VCXPropertyValuePath","DS/VCXWebProperties/VCXPropertyValueHyperlinkId","DS/VCXWebProperties/VCXPropertyValueDocId","DS/VCXWebProperties/VCXPropertyValueAnchor","DS/VCXWebProperties/VCXPropertyValueLink","DS/VCXWebProperties/VCXPropertyValueBase64","DS/VCXWebProperties/VCXPropertyValueBin","DS/VCXWebProperties/VCXPropertyValueFont","DS/VCXWebProperties/VCXPropertyValueDate","DS/VCXWebProperties/VCXPropertyValueMap","DS/VCXWebProperties/VCXPropertyValueList","DS/VCXWebProperties/VCXPropertySet","DS/VCXWebProperties/VCXPropertyMap","DS/VCXWebProperties/VCXProperty","DS/VCXWebProperties/VCXPropertyInfo","DS/VCXWebKernelCommands/VCXCmdChangeScenario","DS/VCXWebKernelCommands/VCXCmdChangeKeys","DS/VCXWebKernelCommands/VCXCmdChangeNeutralProperties","DS/VCXWebModifiables/VCXMetaPropertyDef"],function(b,E,D,w,i,h,F,o,l,s,A,g,y,a,I,z,v,p,c,f,m,q,H,G,x,r,J,d,n,t,B,k,e,j){var u=false;var C=b.extend({InitLoader:function(K){this._experienceBase=K;if(K){this._factory=K.Factory;this._scenarioManager=K.getManager("VCXScenarioManager");this._ComponentsMap=K.ComponentsMap}else{console.log("VCXExperienceLoaderBase : experience base param missing!")}},_reformatObjectIDForPathOfId:function(L){if(typeof L=="undefined"){return L}if(L.pathOfIds){var K="";for(var M=0;M<L.pathOfIds.length;M++){if(M!=0){K+=","}K+=L.pathOfIds[M]}return K}else{return L}},BuildVCXPropertyValue:function(T,V){var O=null;if(T==="VCXPropertyValueFrame"){O=new s();var U=new D.Matrix4();for(var Q=0;Q<12;Q++){if(typeof V[Q]==="string"){V[Q]=parseFloat(V[Q].replace(",","."))}}U.set(V[0],V[3],V[6],V[9],V[1],V[4],V[7],V[10],V[2],V[5],V[8],V[11],0,0,0,1);O.SetValue(U)}else{if(T==="VCXPropertyValuePoint2D"){O=new A();var M=new D.Vector2();for(var Q=0;Q<2;Q++){if(typeof V[Q]==="string"){V[Q]=parseFloat(V[Q].replace(",","."))}}M.set(V[0],V[1]);O.SetValue(M)}else{if(T==="VCXPropertyValuePoint"){O=new g();var M=new D.Vector3();for(var Q=0;Q<3;Q++){if(typeof V[Q]==="string"){V[Q]=parseFloat(V[Q].replace(",","."))}}M.set(V[0],V[1],V[2]);O.SetValue(M)}else{if(T==="VCXPropertyValueLocation"){if(true){O=new y();O.SetValues(V,this)}else{var O=new s();var R=V[0].value;for(var Q=0;Q<12;Q++){if(typeof R[Q]==="string"){R[Q]=parseFloat(R[Q].replace(",","."))}}var U=new D.Matrix4();U.set(R[0],R[3],R[6],R[9],R[1],R[4],R[7],R[10],R[2],R[5],R[8],R[11],0,0,0,1);O.SetValue(U)}}else{if(T==="VCXPropertyValueColor"){O=new a();for(var Q=0;Q<4;Q++){if(typeof V[Q]==="string"){V[Q]=parseFloat(V[Q].replace(",","."))}}var P=new w().FromRGBA(V[0],V[1],V[2],V[3]);O.SetValue(P)}else{if(T==="VCXPropertyValueFloat"){O=new h();if(typeof V==="string"){V=parseFloat(V.replace(",","."))}O.SetValue(V)}else{if(T==="VCXPropertyValueInt"){O=new F();if(typeof V==="string"){V=parseFloat(V.replace(",","."))}O.SetValue(Math.floor(V))}else{if(T==="VCXPropertyValueEnum"){O=new o();O.SetValue(parseInt(V))}else{if(T==="VCXPropertyValueBoolean"){O=new l();var N;if(typeof V!=="boolean"){N=parseInt(V)===1}else{N=V}O.SetValue(N)}else{if(T==="VCXPropertyValueString"){O=new i();O.SetValue(V)}else{if(T==="VCXPropertyValueVector"){O=new I();for(var Q=0;Q<V.length;Q++){if(typeof V[Q]==="string"){V[Q]=parseFloat(V[Q].replace(",","."))}}O.SetValue(V)}else{if(T==="VCXPropertyValueAnchor"){if(u){var L=V[1].value;O=new s();var U=new D.Matrix4();for(var Q=0;Q<12;Q++){L[Q]=parseFloat(L[Q].replace(",","."))}U.set(L[0],L[3],L[6],L[9],L[1],L[4],L[7],L[10],L[2],L[5],L[8],L[11],0,0,0,1);O.SetValue(U)}else{O=new c();O.SetValues(V,this)}}else{if(T==="VCXPropertyValuePath"){O=new z();O.SetValues(V,this)}else{if((T==="VCXPropertyValueHyperlinkId")||(T==="VCXPropertyValueHyperLinkId")){O=new v();O.SetValue(V)}else{if(T==="VCXPropertyValueDocId"){if(V!==""){O=new p();O.SetValue(V)}}else{if(T==="VCXPropertyValueLink"){O=new f();var K=V;if(K){var S=this._reformatObjectIDForPathOfId(K);O.SetValue(S)}}else{if(T==="VCXPropertyValueBase64"){O=new m();if(V){O.SetValue(V)}}else{if(T==="VCXPropertyValueBin"){O=new q();if(V){O.SetValue(V)}}else{if(T==="VCXPropertyValueFont"){O=new H();O.SetValues(V,this)}else{if(T==="VCXPropertyValueDate"){O=new G();O.FromString(V)}else{if(T==="VCXPropertyValueMap"){O=new x();O.SetValues(V,this)}else{if(T==="VCXPropertyValueList"){O=new r();O.SetValues(V,this)}else{console.log("type inconnu : "+T)}}}}}}}}}}}}}}}}}}}}}}return O},BuildPathElementFromArray:function(R,T,N){function P(V,W){var X=null;if(N){X=V.getChildById(W);if(X){return X}var U;for(U=0;U<V.children.length;U++){X=V.children[U];if(X.getPersistentId&&X.getPersistentId()===W){return X}if(X.id.toString()===W){return X}}}X=V.getChildByName(W);if(X){return X}return null}var S=T.QueryInterface("VCXIModelNavigable");if(S){var M=S.getAssetNavigable();if(M){var O=M.QueryInterface("W3AISGNodeHolder");if(O&&O.getPathElement()){var L=O.getPathElement().clone();var Q;for(Q=0;Q<R.length;Q++){var K=P(L.getLastElement(),R[Q]);if(K){L.addElement(K)}else{console.error("BuildPathElementFromArray : CHILD NODE NOT FOUND !! ",R[Q])}}return L}}}return null},LoadComponents:function(P){if(P){for(var N=0;N<P.length;N++){var O=P[N].objectID;var K=P[N].objectType;if(K==="VCXComponentVPMReference"){K="Model_VPMReference_Spec";console.warn("The type VCXComponentVPMReference is deprecated. Please resave the json.")}var M=this._factory.BuildComponent(K);if(M){M.SetID(O);this._ComponentsMap.AddComponent(M);var L=P[N].objectData;if(L){M.SetLoadData(L)}}}}},LoadW3AISGNodeHolder:function(O){if(O){for(var L=0;L<O.length;L++){var N=O[L].objectID;var P=this._reformatObjectIDForPathOfId(N);var R=this._ComponentsMap.GetComponentFromID(P);if(R){var U=R.QueryInterface("W3AISGNodeHolder");if(U){var Q=O[L].PathElement;if(Q){var T=[];for(var S=0;S<Q.length;S++){T[S]=Q[S]}var K=1;var M=this.BuildPathElementFromArray(T,R,K);if(M){U.setPathElement(M)}}}}}}},LoadVCXIModelNavigable:function(N){if(N){for(var L=0;L<N.length;L++){var M=N[L].objectID;var O=this._reformatObjectIDForPathOfId(M);var R=this._ComponentsMap.GetComponentFromID(O);if(R){var Q=R.QueryInterface("VCXIModelNavigable");if(Q){var U=N[L].NavigableParent;if(U){var T=this._ComponentsMap.GetComponentFromID(U);if(T){var K=T.QueryInterface("VCXIModelNavigable");if(K){Q.setParent(K)}}}else{var V=N[L].WorkingRoot;if(V){var P=this._ComponentsMap.GetComponentFromID(V);if(P){var S=P.QueryInterface("VCXIModelNavigable");if(S){Q.setWorkingRoot(S)}}}}}}}}},LoadMetaPropertiesDef:function(P){if(P){var K=this._experienceBase.getManager("VCXMetaPropertyManager");for(var N=0;N<P.length;N++){var O=P[N];var M=new t(O.name,O.behavior,true);if(O.bounds){if(O.type==="VCXPropertyValueFloat"){M.SetBounds(parseFloat(O.bounds.valueMin),parseFloat(O.bounds.valueMax),parseFloat(O.bounds.step))}else{if(O.type==="VCXPropertyValueFloat"){M.SetBounds(parseInt(O.bounds.valueMin),parseInt(O.bounds.valueMax),parseInt(O.bounds.step))}}}var L=new j(M,O.type);M.SetGroupId("Group.UserProperties");M.SetNlsPathGroup("VCXWebModifiables/VCXWebModifiables");M.SetMetaPropertyDef(L);L.SetDefaultLabel(O.defaultLabel);K.AddMetaPropertyDef(L)}}},LoadPropertiesLinks:function(K){if(K){var L=this._experienceBase.getManager("VCXLinkedPropertyManager");for(var M=0;M<K.length;M++){L.AddLink(K[M].inID,K[M].inProp,K[M].outID,K[M].outProp,null)}}},LoadNeutrals:function(N){var L=new e(this._experienceBase.getManager("VCXScenarioManager"));for(var T=0;T<N.length;T++){var S=N[T];var M=this._reformatObjectIDForPathOfId(S.objectID);var Q=this._ComponentsMap.GetComponentFromID(M);if(Q){var W=Q.QueryInterface("VCXIModifiable");if(W){var O=S.properties;for(var V=0;V<O.length;V++){var U=O[V];var P=U.type;var R=U.value;var K=this.BuildVCXPropertyValue(P,R);if(K){L.ChangeProperty(W,U.name,K)}}}}else{console.log("ERROR : component not found : "+M+"\n")}}this._experienceBase.getManager("VCXCommandManager").Do(L)},LoadPropSet:function(M){var P=new J();for(var Q=0;Q<M.length;Q++){var S=M[Q];var R=S.name;var K=S.type;var L=S.value;var O=this.BuildVCXPropertyValue(S.type,S.value);var N=new n(new t(S.name),O);P.AddOrModifyProperty(N)}return P},LoadPropMap:function(P){var K=new d();for(var N in P){if(P.hasOwnProperty(N)){var M=this._ComponentsMap.GetComponentFromID(N);if(M){var O=M.QueryInterface("VCXIModifiable").GetHashing();var Q=P[N];var L=this.LoadPropSet(Q);K.AddOrModifyPropertySet(O,L)}else{console.log("ERROR : LoadPropMap: component not found : "+N+"\n")}}}return K},LoadScenarios:function(ab){for(var V=0;V<ab.length;V++){var W=ab[V];var ai=this._ComponentsMap.GetComponentFromID(W.ID);if(!ai){console.log("ERROR : LoadScenarios: scenario component not found : "+W.ID+"\n");continue}var ag=new B(this._experienceBase.getManager("VCXScenarioManager"),this._experienceBase.getManager("VCXCommandManager"),this._experienceBase.ComponentsMap);ag.AddScenarios(ai);this._experienceBase.getManager("VCXCommandManager").Do(ag);ai.SetName(W.name);var K=new k(this._experienceBase.getManager("VCXScenarioManager"));var ac=W.listMods;for(var Z=0;Z<ac.length;Z++){var ah=ac[Z];var M=this._reformatObjectIDForPathOfId(ah.objectID);var R=this._ComponentsMap.GetComponentFromID(M);if(!R){console.log("ERROR : LoadScenarios: component not found : "+M+"\n");continue}var Y=R.QueryInterface("VCXIModifiable");if(Y){var ad=ah.listTracks;for(var Q=0;Q<ad.length;Q++){var U=ad[Q];var af=U.name;var N=U.listKeys;if(N){for(var T=0;T<N.length;T++){var aj=N[T];var X=aj.value;var P=this.BuildVCXPropertyValue(U.type,X);if(P){K.ChangeKey(ai,Y,af,parseFloat(aj.time),P)}}}}}}this._experienceBase.getManager("VCXCommandManager").Do(K);var L=W.visibility;if(L){var O=L.listVisible;if(O){for(var aa=0;aa<O.length;aa++){var ah=O[aa];var M=this._reformatObjectIDForPathOfId(ah.objectID);var R=this._ComponentsMap.GetComponentFromID(M);if(R){ai.GetVisibility().AddVisible(R)}}}var ae=L.listInvisible;if(ae){for(var aa=0;aa<ae.length;aa++){var ah=ae[aa];var M=this._reformatObjectIDForPathOfId(ah.objectID);var R=this._ComponentsMap.GetComponentFromID(M);if(R){ai.GetVisibility().AddInvisible(R)}}}var S=L.listVisibleCollabs;if(S){for(var aa=0;aa<S.length;aa++){var ah=S[aa];var M=this._reformatObjectIDForPathOfId(ah.objectID);var R=this._ComponentsMap.GetComponentFromID(M);if(R){ai.GetVisibility().AddVisibleCollab(R)}}}}}}});return C});