define("DS/3DPlayAnnotationUtils/CurvedLayout",["UWA/Core","UWA/Class"],function(c,b){var a=b.extend({init:function(t){this._parent(t);if(!t||!t.childCount){console.error("CurvedLayout: Cannot create layout, params missing.");return false}if(!t.layoutOpts){t.layoutOpts={}}var j=t.childCount;var g=(0===(j%2))?true:false;var n=t.layoutOpts.containerHeight;var q=t.layoutOpts.containerWidth;var p=((n*n)+(4*q*q))/(8*q);var s=Math.atan(n/(2*(p-q)));var o=t.layoutOpts.offsetX||0;var l=t.layoutOpts.offsetY||0;var m=(2*s)/j;this.contentArray=[];var r=0.5;var d=new c.Element("div",{styles:{width:p,height:p,position:"absolute",top:-(p/2)+"px"}}).inject(t.containerElement);var e=function(h){var v=o;var u=l;v=v+(p-(p*Math.cos(h)));u=u+(p-(p*Math.sin(h)));var i=new c.Element("div");i.setStyle("position","absolute");i.setStyle("left",v+"px");i.setStyle("top",u+"px");i.inject(d);return i};if(!g){j--;this.contentArray.push(e(0));r=1}for(var k=0;k<j/2;k++){var f=m*(k+r);this.contentArray.unshift(e(-f))}for(var k=0;k<j/2;k++){var f=m*(k+r);this.contentArray.push(e(f))}}});return a});define("DS/3DPlayAnnotationUtils/ShapeUtils",["DS/WebUtils/Vector2","DS/WebUtils/GeometryUtils","DS/WebSystem/Settings"],function(i,a,b){var f=false;var j=b.get("3DPlay.Annotation.PerformanceMode");var e=4;var g=3;var h=8;var c=8;var d=true;return{shapeEval:function(B){var k=B;var q=B.slice(0);if(B.length==0){return undefined}if(B.length==1){k=[];k[0]=new i(B[0].x,B[0].y);k[1]=new i(B[0].x+1,B[0].y);k.type="point";return{input:q,convexHull:q,boundingBox:q,_largestEnclosedTriangle:q,shape:k}}if(q.length==2){k=[];k[0]=B[0];k[1]=B[B.length-1];k=this._interpolateStraightLine(k);k.type="line";return{input:q,convexHull:q,boundingBox:q,_largestEnclosedTriangle:q,shape:k}}var o=this._isClosed(q);var x=a.convexHullCompute(q);if(x.length==2){if(!d){k=[];k[0]=B[0];k[1]=B[B.length-1];k=this._interpolateStraightLine(k);k.type="line";return{input:B,convexHull:q,boundingBox:q,_largestEnclosedTriangle:q,shape:k}}else{k=q;if(!d){k=this._DouglasPeucker(k);k=this._interpolate2D(k)}k.type="unknownOpen";return{input:B,convexHull:q,boundingBox:q,_largestEnclosedTriangle:q,shape:k}}}var F=this._polyPerimeter(x);var m=this._polyArea(x);var u=a.boundingBoxCompute(x);var v=this._largestEnclosedTriangle(x);var E=this._annotLength(q);if(f&&E/F>1.6){console.log("ERASE");k=x;k.type="erase"}else{var L=F*F/m;if(L<13.35&&o&&E/F<1.1&&E/F>0.9){var A=new i((u[0].x+u[2].x)/2,(u[0].y+u[2].y)/2);var s=(u[0].distanceTo(u[1])+u[1].distanceTo(u[2]))/4;k=this._getCircle(A,s);k.type="circle"}else{if(L>110&&!d){k=[B[0],B[B.length-1]];k=this._interpolateStraightLine(k);k.type="line"}else{var p=this._triangleArea(v[0],v[1],v[2]);var y=u[0].distanceTo(u[1])*u[1].distanceTo(u[2]);var K=p/m;var l=m/y;if(K>0.73&&0.25<l&&0.7>l){if(o&&F/E<1.2&&F/E>0.8){k=v;k=this._interpolateClosedPolygon(k);k.push(k[0]);k.type="triangle";k.data={vertices:v}}else{var w=this._getArrowhead(q,v);var t=this._annotLength(w);if(E/t<1.2&&E/t>0.8&&L<33&&!d){k=w;k.type="arrowhead";k.data={vertices:w}}else{k=q;if(!d){k=this._DouglasPeucker(k);k=this._interpolate2D(k)}k.type="unknownOpen"}}}else{var r=this._polyPerimeter(u);var J=F/r;if(J>0.9&&o){var I=u[0].distanceTo(u[1])/u[1].distanceTo(u[2]);if((I<1.2)&&(I>0.8)){var A=new i((u[0].x+u[2].x)/2,(u[0].y+u[2].y)/2);var z=(u[0].distanceTo(A)+u[1].distanceTo(A))/2;var G=new i((u[2].x-u[0].x)/2,(u[2].y-u[0].y)/2);G.normalize().multiplyScalar(z);k=this._getSquare(A,G);k.type="square"}else{k=this._getRectangle(u,m);k.type="rectangle"}}else{var y=u[0].distanceTo(u[1])*u[1].distanceTo(u[2]);var H=(m*m)/(y*p);if(H>1.6&&o&&E/F<1.2&&E/F>0.8){var A=new i((u[0].x+u[2].x)/2,(u[0].y+u[2].y)/2);var D=u[0].distanceTo(u[1])/2;var C=u[1].distanceTo(u[2])/2;var n=new i(u[1].x-u[0].x,u[1].y-u[0].y);k=this._getEllipse(A,D,C,n.normalize());k.type="ellipse"}else{if(p/y<0.51&&o&&!d){k=q;k=this._DouglasPeucker(k);k=this._interpolate2D(k);k.type="diamond"}else{if(o&&!d){k=q;k=this._DouglasPeucker(k);k=this._interpolate2D(k);k.type="unknownClosed"}else{k=q;if(!d){k=this._DouglasPeucker(k);k=this._interpolate2D(k)}k.type="unknownOpen"}}}}}}}}return{input:B,convexHull:x,boundingBox:u,_largestEnclosedTriangle:v,shape:k}},isArrow3:function(x,t,v,w){if(a.isOverlap(v,w)){var m=x[0];var l=x[x.length-1];var q=t[0].clone().sub(t[1]).normalize();q.add(t[2].clone().sub(t[1]).normalize()).normalize();var o=m.clone().sub(l).normalize();var n=o.dot(q);if(Math.abs(n)>0.85){var u;var p;if(n>0){u=l;p="endArrow"}else{u=m;p="beginArrow"}var s=t[0].distanceTo(t[1]);var r=t[2].distanceTo(t[1]);if(r>s){s=r}var k=u.distanceTo(t[2]);if(k<2*s){console.log("SIMPLE ARROW");return{type:p,distance:k}}}}return false},_checkCurvedArrow:function(m,k,A,p){var w=false;var D=A[0].clone().sub(A[1]).normalize();D.add(A[2].clone().sub(A[1]).normalize()).normalize();var l=k.clone().sub(m).normalize();var t=l.dot(D);if(t>0.85){var o=(A[0].x<A[2].x)?A[0].x:A[2].x;var u=(A[0].x>=A[2].x)?A[0].x:A[2].x;var s=(A[0].y<A[2].y)?A[0].y:A[2].y;var B=(A[0].y>=A[2].y)?A[0].y:A[2].y;if(m.x==k.x&&m.x>o&&m.x<u){w=true}else{if((A[0].x==A[2].x)){var C=(m.y-k.y)/(m.x-k.x);var z=m.y-C*m.x;var q=(C*A[0].x+z);if(q>s&&q<B){w=true}}else{if((m.x!=k.x)&&(A[0].x-A[2].x)){var C=(m.y-k.y)/(m.x-k.x);var z=m.y-C*m.x;var v=(A[0].y-A[2].y)/(A[0].x-A[2].x);var n=A[0].y-v*A[0].x;if(C-v){var r=(n-z)/(C-v);var q=(C*r+z);if(r>o&&r<u&&q>s&&q<B){w=true}}}}}}if(w===true){w=m.distanceTo(A[2])}return w},isCurvedArrow3:function(r,l,p,q){if(a.isOverlap(p,q)){var m=r[0].distanceTo(l[2]);var k=r[r.length-1].distanceTo(l[2]);var n;var o;if(m<k){n=this._checkCurvedArrow(r[0],r[2],l,q);o="beginArrow"}else{n=this._checkCurvedArrow(r[r.length-1],r[r.length-3],l,q);o="endArrow"}if(n!=false){console.log("CURVED ARROW");return{type:o,distance:n}}}return false},isLineArrow2D:function(s,r,n){var m=new i(s[0].x,s[0].y);var l=new i(s[1].x,s[1].y);var q=r[0].clone().sub(r[1]).normalize();q.add(r[2].clone().sub(r[1]).normalize()).normalize();var p=m.clone().sub(l).normalize();var o=p.dot(q);if((o>0.85)&&(n==null||n==1)&&a._isInsidePolygon(l,r)){var k=l.distanceTo(r[1]);return({pointID:1,pointEndID:0,distance:k})}else{if((o<-0.85)&&(n==null||n==0)&&a._isInsidePolygon(m,r)){var k=m.distanceTo(r[1]);return({pointID:0,pointEndID:1,distance:k})}}return false},isArrow2D:function(l,k){return this.isLineArrow2D(l.data.path,k,null)},isCurvedArrow2D:function(m,l){var o=m.data.path;var p=[];p.push(o[0]);p.push(o[2]);var n=this.isLineArrow2D(p,l,0);if(n){n.pointID=0;n.pointEndID=2}else{if(n==false){var k=o.length;p=[];p.push(o[k-1]);p.push(o[k-3]);var n=this.isLineArrow2D(p,l,0);if(n){n.pointID=k-1;n.pointEndID=k-3}}}return n},_largestEnclosedTriangle:function(p){var l,k,q,o,n,m;l=0;k=1;q=2;o=0;n=1;m=2;do{while(((q+1)%p.length)!=l&&(k!=q)){while(this._triangleArea(p[l],p[k],p[q])<=this._triangleArea(p[l],p[k],p[(q+1)%p.length])){q=(q+1)%p.length}if((((k+1)%p.length)!=q)&&this._triangleArea(p[l],p[k],p[q])<=this._triangleArea(p[l],p[(k+1)%p.length],p[q])){k=(k+1)%p.length}else{break}}if(this._triangleArea(p[l],p[k],p[q])>this._triangleArea(p[o],p[n],p[m])){o=l;n=k,m=q}l=(l+1)%p.length;if(l==k){k=(k+1)%p.length}if(k==q){q=(q+1)%p.length}}while(l!=0);return[p[o],p[n],p[m]]},_triangleArea:function(l,k,m){if(l==undefined||k==undefined||m==undefined){return 0}return((k.x-l.x)*(m.y-l.y)-(m.x-l.x)*(k.y-l.y))/2},_polyArea:function(m){var l=0;for(var k=0;k<m.length;k++){l+=m[(k+1)%m.length].x*(m[(k+2)%m.length].y-m[(k)%m.length].y)}return l/2},_isClosed:function(k){var m=k[0].distanceTo(k[k.length-1]);var l=this._polyPerimeter(k);return k[0].distanceTo(k[k.length-1])<this._polyPerimeter(k)/7},_polyPerimeter:function(m){var k=0;for(var l=0;l<m.length;l++){k+=m[l].distanceTo(m[(l+1)%m.length])}return k},_interpolateStraightLine:function(p){var m=p[0].distanceTo(p[1])/4;if(j){m=e}var l=p[1].x-p[0].x;var k=p[1].y-p[0].y;var o=[];o.push(p[0].clone());for(var n=0;n<m;n++){o.push(new i(p[0].x+(n/m)*l,p[0].y+(n/m)*k))}o.push(p[1].clone());return o},_interpolateStraightLineLow:function(p){if(j){return this._interpolateStraightLine(p)}else{var m=p[0].distanceTo(p[1])/8;var l=p[1].x-p[0].x;var k=p[1].y-p[0].y;var o=[];o.push(p[0].clone());for(var n=0;n<m;n++){o.push(new i(p[0].x+(n/m)*l,p[0].y+(n/m)*k))}o.push(p[1].clone());return o}},_interpolateClosedPolygon:function(m){var l=[];for(var k=0;k<m.length-1;k++){this._interpolateStraightLine([m[k],m[k+1]]).forEach(function(n){l.push(n)})}this._interpolateStraightLine([m[m.length-1],m[0]]).forEach(function(n){l.push(n)});return l},_interpolate2D:function(z,n,k,C){n=(typeof n!="undefined")?n:0.5;k=k?k:false;if(j){C=C?C:g}else{C=C?C:10}var o=[];var p=[];var x,w,v,u;var y,q,B;var m,l,s,r;o=z.slice(0);if(k){o.unshift(z[z.length-1]);o.unshift(z[z.length-1]);o.push(z[0])}else{o.unshift(z[0]);o.push(z[z.length-1])}for(B=1;B<(o.length-2);B+=1){m=(o[B+1].x-o[B-1].x)*n;l=(o[B+1].y-o[B-1].y)*n;s=(o[B+2].x-o[B].x)*n;r=(o[B+2].y-o[B].y)*n;for(q=0;q<=C;q++){y=q/C;x=2*Math.pow(y,3)-3*Math.pow(y,2)+1;w=-(2*Math.pow(y,3))+3*Math.pow(y,2);v=Math.pow(y,3)-2*Math.pow(y,2)+y;u=Math.pow(y,3)-Math.pow(y,2);var A=new i(x*o[B].x+w*o[B+1].x+v*m+u*s,x*o[B].y+w*o[B+1].y+v*l+u*r);p.push(A)}}return p},_annotLength:function(l){var m=0;for(var k=1;k<l.length;k++){m+=l[k-1].distanceTo(l[k])}return m},_distPointToSegment:function(l,n,m){var q;function p(s,r){return Math.pow((s.x-r.x),2)+Math.pow((s.y-r.y),2)}var k=p(n,m);if(k==0){return p(l,n)}var o=((l.x-n.x)*(m.x-n.x)+(l.y-n.y)*(m.y-n.y))/k;if(o<0){return p(l,n)}if(o>1){return p(l,m)}q=p(l,{x:n.x+o*(m.x-n.x),y:n.y+o*(m.y-n.y)});return Math.sqrt(q)},_getCircle:function(n,k){var o=[];var m=Math.PI/k;if(j){m=Math.PI/h}for(var l=0;l<2*Math.PI;l+=m){o.push(new i(n.x+k*Math.cos(l),n.y+k*Math.sin(l)))}if(j){o.push(new i(n.x+k*Math.cos(0),n.y+k*Math.sin(0)))}o.data={centre:n,radius:k};return o},_getEllipse:function(k,q,o,r){var v=[];var u,l;var m=r.y;var t=r.x;var p=2*Math.PI/(q+o);if(j){p=Math.PI/c}for(var n=0;n<2*Math.PI;n+=p){u=Math.cos(n);l=Math.sin(n);v.push(new i(k.x+q*u*t-o*l*m,k.y+q*u*m+o*l*t))}if(j){u=Math.cos(0);l=Math.sin(0);v.push(new i(k.x+q*u*t-o*l*m,k.y+q*u*m+o*l*t))}var s=(180*Math.atan2(r.y,r.x))/Math.PI;v.data={centre:k,radius1:q,radius2:o,angle:s};return v},_getSquare:function(k,n){var m=[];m[0]=new i(k.x+n.x,k.y+n.y);m[1]=new i(k.x+n.y,k.y-n.x);m[2]=new i(k.x-n.x,k.y-n.y);m[3]=new i(k.x-n.y,k.y+n.x);var l=[];l=l.concat(m);m=this._interpolateClosedPolygon(m);m.data={vertices:l};return m},_getRectangle:function(r,k){var q=[];var n=k/(r[0].distanceTo(r[1])*r[1].distanceTo(r[2]));n+=(1-n)/2;var p=new i((r[0].x+r[2].x)/2,(r[0].y+r[2].y)/2);var o;for(var m=0;m<4;m++){q[m]=r[m].clone();q[m].sub(p).multiplyScalar(n).add(p)}var l=[];l=l.concat(q);q.push(q[0]);q=this._interpolateClosedPolygon(q);q.data={vertices:l};return q},_getArrowhead:function(p,m){var r=[];var q;var l=Number.MAX_VALUE;var k=Number.MAX_VALUE;var o=0;var s=0;for(var n=0;n<3;n++){q=p[0].distanceTo(m[n]);if(q<l){l=q;o=n}q=p[p.length-1].distanceTo(m[n]);if(q<k){k=q;s=n}}r[0]=m[o];r[2]=m[s];for(var n=0;n<3;n++){if((n!=o)&&(n!=s)){r[1]=m[n]}}return r},_DouglasPeucker:function(o,w){var t=0;var p=0;var s,k=[],r=[],q=[];var n,m;var v,u;if(w==undefined){v=new i(o[(o.length/2).toFixed(0)].x,o[(o.length/2).toFixed(0)].y);u=new i(o[(o.length/2+1).toFixed(0)].x,o[(o.length/2+1).toFixed(0)].y);w=v.distanceTo(u)}for(var l=0;l<o.length-1;l++){s=this._distPointToSegment(o[l],o[0],o[o.length-1]);if(s>t){p=l;t=s}}if(t>=w){for(var l=0;l<p+1;l++){r.push(new i(o[l].x,o[l].y))}for(var l=p;l<o.length;l++){q.push(new i(o[l].x,o[l].y))}n=this._DouglasPeucker(r,w);m=this._DouglasPeucker(q,w);for(var l=0;l<n.length-1;l++){k.push(n[l])}for(var l=0;l<m.length;l++){k.push(m[l])}}else{k=[o[1],o[o.length-1]]}return k},}});define("DS/3DPlayAnnotationUtils/AnnotationSettings",["UWA/Core","DS/WebSystem/Settings","DS/CoreEvents/Events"],function(f,d,b){function c(){var i;var g;var h;var j;this.init=function(){i=d.get("3DPlay.Annotation.Color","#FF0000");g=d.get("3DPlay.Annotation.Thickness","6");h=d.get("3DPlay.Annotation.Opacity","1");j=d.get("3DPlay.Annotation.LastPosition","0.4,0.4")},this._publishChange=function(){b.publish({event:"3DPlay.Annotation.SettingsChanged",data:{color:this.getColor(),thickness:this.getThickness(),opacity:this.getOpacity()}})},this.setColor=function(k){i=k;d.set("3DPlay.Annotation.Color",i);this._publishChange()},this.getColor=function(){return i},this.setThickness=function(k){g=k;d.set("3DPlay.Annotation.Thickness",g);this._publishChange()},this.getThickness=function(){return g},this.setOpacity=function(k){h=k;d.set("3DPlay.Annotation.Opacity",h);this._publishChange()},this.getOpacity=function(){return h},this.setLastPosition=function(k){if(k.x<0||k.x>=1){k.x=0.4}if(k.y<0||k.y>=1){k.y=0.4}j=""+k.x+","+k.y;d.set("3DPlay.Annotation.LastPosition",j)},this.getLastPosition=function(){var k=j.split(",");return{x:k[0],y:k[1]}}}var e;function a(){if(false===f.typeOf(e)){e=new c();e.init()}return e}return f.namespace("DS/3DPlayAnnotationUtils/AnnotationSettings",a)});define("DS/3DPlayAnnotationUtils/AnnotationAbbreviations",["UWA/Class"],function(b){var e={l:"line",c:"circle",e:"ellipse",r:"rectangle",s:"square",t:"triangle",a:"arrow",ca:"curvedArrow",dha:"doubleHeadedArrow",cda:"curvedDoubleHeadedArrow",uo:"unknownOpen",tt:"text",ep:"eyePosition",ud:"upDirection",sd:"sightDirection",td:"targetDistance",vs:"viewpoints",vp:"viewpointInfo",annot:"annotList",at:"type",om:"onModel",g:"geometry",gp:"graphicalProp",pc:"pointsCount",apn:"annotPlaneNormal",asp:"annotStartPoint",co:"color",op:"opacity",fs:"fontSize",fw:"fontWeight",cen:"center",ra:"radius",maa:"majorAxis",mia:"minorAxis",len:"length",v:"vertices",ps:"points",sc:"scale",w:"width",h:"height",oh:"offsetHeight",ls:"lineStart",le:"lineEnd",cs:"curveStart",ce:"curveEnd",cp:"curvePoints",st:"start",en:"end",p:"point",ah:"arrowhead",es:"explodeStates",d:"diamond",li:"linkID",th:"thickness",pa:"path",an:"angle",da:"data",uc:"unknownClosed"};var d={};var c=Object.keys(e);c.forEach(function(f){var g=e[f];d[g]=f});var a=b.extend({init:function(f){this._parent(f)},processJSON:function(r,l){var m;if(l==="expand"){m=e}else{if(l==="minify"){m=d}}var h={};var q=Object.keys(r);for(var k=0;k<q.length;k++){var o=q[k];var n=r[o];if(Array.isArray(n)){var p=[];for(var g=0;g<n.length;g++){var f=(typeof n[g]==="string")?n[g]:this.processJSON(n[g],l);p.push(f)}n=p}else{if(typeof n==="object"&&Object.keys(n).length>0){n=this.processJSON(n,l)}else{if(typeof n==="string"){if(m[n]){n=m[n]}}}}var s=m[o];if(s){h[s]=n}else{h[o]=n}}return h}});return a});define("DS/3DPlayAnnotationUtils/CursorManager",["UWA/Class","DS/WebappsUtils/WebappsUtils","DS/WebSystem/DetectBrowser"],function(b,d,c){var a=b.extend({init:function(e){this._parent(e);this.curBrowser=c().browser.name;this.currentCurSize=null;this.currentCurFill=null;this.currentCur=null},_buildCursor:function(i,h){if(i==="custom"){var j="#000000";var g="11";if(h){if(h.getColor){j=""+h.getColor();g=""+h.getThickness()}else{j="#"+h.getSettingsColor().getHexString();g=""+h.getSettingsPencilThickness()}}if((this.curBrowser==="ie")&&(this.currentCurSize!==g)){this.currentCurSize=g;this.currentCurFill=j;this._cursorType="url("+d.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/cur/";if(g<=4){this._cursorType+="4x4.cur"}else{if(g>4&&g<=8){this._cursorType+="8x8.cur"}else{this._cursorType+="16x16.cur"}}this._cursorType+="), auto";this.currentCur=this._cursorType}else{if((this.curBrowser!=="ie")&&(this.currentCurSize!==g||this.currentCurFill!==j)){this.currentCurSize=g;this.currentCurFill=j;var f='<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="';f+=g;f+='" height="';f+=g;f+='"><circle cx="';f+=(g/2);f+='" cy="';f+=(g/2);f+='" r="';f+=(g/2);f+='" stroke="#A3A3A3" stroke-width="1" style="fill: ';f+=j;f+=';"/></svg>';var e=btoa(f);this._cursorType="url(data:image/svg+xml;base64,"+e+"), auto";this.currentCur=this._cursorType}else{this._cursorType=this.currentCur}}}},setMouseCursor:function(e){if(!e||!e.container){return false}this.container=e.container;this._cursorType="auto";if(e.type&&e.type!==""&&e.type!==this._cursorType){this._buildCursor(e.type,e.drawSettings)}this.container.setStyle("cursor",this._cursorType)},dispose:function(){this.container=null;this._cursorType=null;this.curBrowser=null;this.currentCurSize=null;this.currentCurFill=null;this.currentCur=null}});return a});define("DS/3DPlayAnnotationUtils/AnnotationTextPreview",["UWA/Core","UWA/Controls/Abstract","DS/WebSystem/Nls","css!DS/3DPlayAnnotationUtils/AnnotationTextPreview.css","DS/3DPlayAnnotationUtils/CursorManager","DS/WebSystem/DetectBrowser","DS/Core/PointerEvents"],function(d,f,i,g,a,h,e){var c=205;var b=40;var j=f.extend({init:function(k){var l=this;this.mPosition={};this._parent(k);this.mode=k.mode;this.viewerFrame=this.options.viewerFrame;this.uiFrame=k.uiFrame;this.viewer=k.viewer;this.cursorManager=new a();this._bulidUI(k);this.bindParentMove=function(m){l.onViewerMouseMove(m)};this.bindTapEvent=function(m){m.stopPropagation?m.stopPropagation():{};m.preventDefault?m.preventDefault():{};k.tapEvent(m)};this.viewerFrame.addEventListener("mousemove",l.bindParentMove);this.container.addEventListener("mousemove",l.bindParentMove);this.container.addEventListener(e.POINTERDOWN,l.bindTapEvent,true)},_bulidUI:function(l){var m=this;m.placeHolderText="Type your text";i.nls("3DPlayAnnotationUtils/3DPlayAnnotation","PlaceHolder",function(n){m.placeHolderText=n;if(m.container&&m.AnnotationTextPreview){m.AnnotationTextPreview.setHTML(m.placeHolderText)}});this.container=new d.Element("div",{id:"annotTextPreview"});this.AnnotationTextPreview=new d.Element("div",{"class":"AnnotationTextPreview",id:"preview",text:m.placeHolderText}).inject(this.container);var k=h().browser.name;if(k==="chrome"||k==="firefox"){this.AnnotationTextPreview.setStyle("box-shadow","1px 1px")}},showPreview:function(k){if(k&&(k.clientX||k.x)&&(k.clientY||k.y)){var m=k.clientX?k.clientX:k.x;var l=k.clientY?k.clientY:k.y;this.AnnotationTextPreview.setStyle("left",m);this.AnnotationTextPreview.setStyle("top",l)}this.AnnotationTextPreview.show()},hidePreview:function(){this.AnnotationTextPreview.hide()},setMouseCursor:function(k){if(this.mode==="2D"){if(this.cursorManager){this.cursorManager.setMouseCursor({container:this.viewer.getContainer(),caller:"2D",type:k,drawSettings:undefined})}}},onViewerMouseMove:function(o){if(this.mEnable===true){if(this.mode==="2D"){var n=this.uiFrame.getBoundingClientRect();var l=o.clientX-n.left;var p=o.clientY-n.top}else{var n=this.viewerFrame.getBoundingClientRect();var l=o.clientX-n.left;var p=o.clientY-n.top}var k=this.mPosition.viewerLeft+c;var m=this.mPosition.viewerTop+b;if((l>=this.mPosition.viewerLeft&&l<this.mPosition.viewerWidth-k)&&(p>=this.mPosition.viewerTop&&p<this.mPosition.viewerHeight-m)){this.setMouseCursor("auto");this.AnnotationTextPreview.setStyle("left",l);this.AnnotationTextPreview.setStyle("top",p);this.showPreview()}else{if((l>=this.mPosition.viewerWidth-k&&l<this.mPosition.viewerWidth-this.mPosition.viewerLeft)&&(p>=this.mPosition.viewerHeight-m&&p<this.mPosition.viewerHeight-this.mPosition.viewerTop)){this.setMouseCursor("auto");this.AnnotationTextPreview.setStyle("left",this.mPosition.viewerWidth-this.mPosition.viewerLeft-c);this.AnnotationTextPreview.setStyle("top",this.mPosition.viewerHeight-this.mPosition.viewerTop-b);this.showPreview()}else{if((l>=this.mPosition.viewerWidth-k&&l<this.mPosition.viewerWidth-this.mPosition.viewerLeft)&&(p>=this.mPosition.viewerTop&&p<this.mPosition.viewerHeight-m)){this.setMouseCursor("auto");this.AnnotationTextPreview.setStyle("left",this.mPosition.viewerWidth-this.mPosition.viewerLeft-c);this.AnnotationTextPreview.setStyle("top",p);this.showPreview()}else{if((l>=this.mPosition.viewerLeft&&l<this.mPosition.viewerWidth-k)&&(p>=this.mPosition.viewerHeight-m&&p<this.mPosition.viewerHeight-this.mPosition.viewerTop)){this.setMouseCursor("auto");this.AnnotationTextPreview.setStyle("left",l);this.AnnotationTextPreview.setStyle("top",this.mPosition.viewerHeight-this.mPosition.viewerTop-b);this.showPreview()}else{this.setMouseCursor("not-allowed");this.hidePreview()}}}}}},setBoundingLimits:function(l,k,n,m){this.mPosition.viewerWidth=l;this.mPosition.viewerHeight=k;this.mPosition.viewerTop=n||0;this.mPosition.viewerLeft=m||0},enable:function(){this.mEnable=true;this.AnnotationTextPreview.classList.add("active");this.AnnotationTextPreview.classList.add("no_select")},isEnabled:function(){return this.mEnable},disable:function(){this.mEnable=false;if(this.AnnotationTextPreview){this.AnnotationTextPreview.classList.remove("active");this.AnnotationTextPreview.classList.remove("no_select")}},destroy:function(){this.viewerFrame.removeEventListener("mousemove",this.bindParentMove);this.container.removeEventListener("mousemove",this.bindParentMove);this.container.removeEventListener(e.POINTERDOWN,this.bindTapEvent,true);if(this.cursorManager){this.setMouseCursor("auto");this.cursorManager.dispose();this.cursorManager=null}var k=document.getElementById("annotTextPreview");if(k&&k.remove()){k.remove()}this.mEnable=false;this.viewerFrame=undefined;this.viewer=undefined;this.uiFrame=undefined;this.onTypeStartCB=undefined;this.drawSettings=undefined}});return j});define("DS/3DPlayAnnotationUtils/AnnotationTextPreview2D",["UWA/Core","UWA/Controls/Abstract","DS/WebSystem/Nls","css!DS/3DPlayAnnotationUtils/AnnotationTextPreview2D.css","DS/3DPlayAnnotationUtils/CursorManager","DS/Core/PointerEvents","DS/WebSystem/DetectBrowser"],function(d,f,i,g,a,e,h){var c=205;var b=40;var j=f.extend({init:function(k){this._parent(k);var l=this;this.mPosition={};this.container=k.container;this.cursorManager=new a();this._bulidUI(k);this.container.addEventListener(e.POINTERMOVE,this.onMouseMove.bind(this),true);this.isVisible=false},_bulidUI:function(l){var n=this;var m="Type your text";i.nls("3DPlayAnnotationUtils/3DPlayAnnotation","PlaceHolder",function(o){m=o;if(n.container&&n.AnnotationTextPreview){n.AnnotationTextPreview.setHTML(m)}});this.previewContainer=new d.Element("div",{id:"annotTextPreview",styles:{"pointer-events":"none"}}).inject(this.container);this.AnnotationTextPreview=new d.Element("div",{"class":"AnnotationTextPreview",id:"preview",text:m,styles:{"pointer-events":"none"}}).inject(this.previewContainer);var k=h().browser.name;if(k==="chrome"||k==="firefox"){this.AnnotationTextPreview.setStyle("box-shadow","1px 1px")}},showPreview:function(k){if(k){this.onMouseMove(k)}this.isVisible=true;this.AnnotationTextPreview.show()},hidePreview:function(){this.isVisible=false;this.AnnotationTextPreview.hide()},setMouseCursor:function(k){if(this.cursorManager){this.cursorManager.setMouseCursor({container:this.container,type:k,drawSettings:undefined})}},onMouseMove:function(o){if(this.mEnable===true){var n=o.clientX;var m=o.clientY;if(this.boundingLimits.minX<=n&&this.boundingLimits.maxX>=n&&this.boundingLimits.minY<=m&&this.boundingLimits.maxY>=m){var r=this.container.getBoundingClientRect();var q=n-r.left;var p=m-r.top;var l=(this.boundingLimits.maxX-(r.left+c));var k=(this.boundingLimits.maxY-(r.top+b));if(q<l){this.AnnotationTextPreview.setStyle("left",q)}else{this.AnnotationTextPreview.setStyle("left",l)}if(p<k){this.AnnotationTextPreview.setStyle("top",p)}else{this.AnnotationTextPreview.setStyle("top",k)}this.setMouseCursor("auto");this.showPreview()}else{this.setMouseCursor("not-allowed");this.hidePreview()}}},setBoundingLimitsFromReferenceElement:function(l){if(l){var k=l.getBoundingClientRect();var m=this.container.getBoundingClientRect();this.boundingLimits={minX:k.left>m.left?k.left:m.left,maxX:k.right<m.right?k.right:m.right,minY:k.top>m.top?k.top:m.top,maxY:k.bottom<m.bottom?k.bottom:m.bottom}}},enable:function(){this.mEnable=true;this.AnnotationTextPreview.classList.add("active");this.AnnotationTextPreview.classList.add("no_select")},isEnabled:function(){return this.mEnable},disable:function(){this.mEnable=false;if(this.AnnotationTextPreview){this.AnnotationTextPreview.classList.remove("active");this.AnnotationTextPreview.classList.remove("no_select")}},destroy:function(){this.container.removeEventListener("mousemove",this.bindParentMove);this.container=undefined;this.AnnotationTextPreview.destroy();this.AnnotationTextPreview=undefined;this.previewContainer.destroy();this.previewContainer=undefined;if(this.cursorManager){this.setMouseCursor("auto");this.cursorManager.dispose();this.cursorManager=null}this.mEnable=false;this.drawSettings=undefined}});return j});define("DS/3DPlayAnnotationUtils/AnnotationTextControl2D",["UWA/Core","UWA/Controls/Abstract","css!DS/3DPlayAnnotationUtils/AnnotationTextControl2D","DS/WebSystem/Nls","DS/CoreEvents/Events","DS/3DPlayAnnotationUtils/AnnotationSettings","css!DS/UIKIT/UIKIT.css","DS/Core/PointerEvents"],function(h,k,l,p,o,d,m,j){var q=5;var f=205;var n=163;var e=40;var a=45;var c=0;var b=25;var i=30;var g=k.extend({defaultOptions:{className:"SmartAnnot3DPlayWebTextControl",canvas:null},mScale:1,boundingLimits:{top:undefined,left:undefined,width:undefined,height:undefined},size:{height:undefined,width:undefined,maxHeight:undefined,maxWidth:undefined},position:{x:undefined,y:undefined},init:function(r){this._parent(r);this.container=r.container;this.onTypeStartCB=r.onTypeStartCB;this.drawSettings=new d();this._buildUI(r.containerStyle)},destroy:function(){var r=this;cancelAnimationFrame(this.animationID);this.animationID=undefined;this.bindAnimate=undefined;this.container.removeEventListener("pointerup",this.bindStopDragResizeHandler);this.container.removeEventListener("pointermove",this.bindDragResizeHandler);this.container.removeEventListener("touchend",this.bindStopDragResizeHandler);this.container.removeEventListener("touchmove",this.bindTouchDragResizeHandler);this.container.removeEventListener("mouseup",this.bindStopDragResizeHandler);this.container.removeEventListener("mousemove",this.bindDragResizeHandler);this.container.removeEventListener("mouseup",this.bindParentMouseUp);this.container.removeEventListener("mousemove",this.bindParentMove);o.unsubscribe(this.tokenSettingsChanged);this.textControlContainer.destroy();this.textControlContainer=undefined;this.container=undefined;this.onTypeStartCB=undefined;this.drawSettings=undefined},_setTextProperties:function(r){if(r){this.elements.textField.style.color=r.color;var s=(parseInt(r.thickness)-3)*100;this.elements.textField.style.fontWeight=s}else{this.elements.textField.style.color=this.drawSettings.getColor();var s=(parseInt(this.drawSettings.getThickness())-3)*100;this.elements.textField.style.fontWeight=s}},_buildUI:function(){var x=this;var v=this.container.clientWidth;var s=this.container.clientHeight;var u=this.options.x||Math.round(v*0.4);var t=this.options.y||Math.round(s*0.3);var w;p.nls("3DPlayAnnotationUtils/3DPlayAnnotation","PlaceHolder",function(y){w=y;if(x.elements&&x.elements.mBlankText){x.elements.mBlankText.setHTML(x.placeHolderText)}});this.textControlContainer=new h.Element("div",{id:"annot3dNewTextInput"}).inject(this.container);this.elements.textContainer=new h.Element("div",{styles:{top:t+"px",left:u+"px"},"class":"textAnnot3DPlay-text-container"}).inject(this.textControlContainer);this.elements.mBlankText=new h.Element("div",{html:w,styles:{top:t+"px",left:u+"px"},"class":"textAnnot3DPlay-editor-field blank",id:"editor-field"}).inject(this.textControlContainer);this.elements.textField=new h.Element("textarea",{styles:{top:t+"px",left:u+"px"},"class":"textAnnot3DPlay-editor-field",id:"editor-field-textArea",WRAP:"OFF",events:{dragstart:function(y){y.preventDefault()},drag:function(y){y.preventDefault()},dragover:function(y){y.preventDefault()},dragenter:function(y){y.preventDefault()},dragleave:function(y){y.preventDefault()},drop:function(y){y.preventDefault()},dragend:function(y){y.preventDefault()}}}).inject(this.textControlContainer);this.elements.buttonCancel=new h.Element("div",{"class":"textAnnot3DPlay-toolbar-button cancel",styles:{verticalAlign:"middle"}}).inject(this.elements.textContainer);var r=new h.Element("div",{"class":"fonticon fonticon-2x fonticon-cancel",}).inject(this.elements.buttonCancel);this.elements.buttonCancel.addEventListener(j.POINTERDOWN,this.cancel.bind(this),true);this.elements.buttonCancel.hide();this.text=false;this.elements.resizeHandler=new h.Element("div",{"class":"textAnnot3DPlay-resize-handler"}).inject(this.elements.textContainer);this.elements.resizeHandlerCircle=new h.Element("div",{"class":"textAnnot3DPlay-resize-handler-circle"}).inject(this.elements.resizeHandler);this.elements.resizeHandlerArrow=new h.Element("div",{"class":"textAnnot3DPlay-resize-handler-image"}).inject(this.elements.resizeHandler);this._setTextProperties();this.tokenSettingsChanged=o.subscribe({event:"3DPlay.Annotation.SettingsChanged"},function(y){x._setTextProperties(y)});this.elements.textContainer.addEvent("mousedown",this.onMouseDown.bind(this));this.elements.textContainer.addEvent("mousemove",this.onMouseMove.bind(this));this.elements.textContainer.addEvent("mouseup",this.onMouseUp.bind(this));this.elements.textContainer.addEvent("touchstart",this.onTouchStart.bind(this));this.elements.textContainer.addEvent("touchmove",this.onTouchMove.bind(this));this.elements.textContainer.addEvent("touchend",this.onMouseUp.bind(this));this.elements.textField.addEvent("mousedown",this.onMouseDown.bind(this));this.elements.textField.addEvent("mousemove",this.onMouseMove.bind(this));this.elements.textField.addEvent("mouseup",this.onMouseUp.bind(this));this.elements.textField.addEvent("touchstart",this.onTouchStart.bind(this));this.elements.textField.addEvent("touchmove",this.onTouchMove.bind(this));this.elements.textField.addEvent("touchend",this.onMouseUp.bind(this));this.elements.textField.addEvent("keydown",this._onKeyPress.bind(this));this.bindParentMove=this.onParentMouseMove.bind(this);this.container.addEventListener("mousemove",this.bindParentMove);this.bindParentMouseUp=this.onParentMouseUp.bind(this);this.container.addEventListener("mouseup",this.bindParentMouseUp);this.elements.textField.addEventListener("mousedown",function(){this.focus()});this.elements.textField.addEventListener("touchstart",function(){this.focus()});this.elements.textField.addEventListener("blur",this.removeSelection.bind(this));this.elements.resizeHandler.addEventListener("mousedown",this.onDownResizeHandler.bind(this));this.bindDragResizeHandler=this.onDragResizeHandler.bind(this);this.container.addEventListener("mousemove",this.bindDragResizeHandler);this.bindStopDragResizeHandler=this.stopDragResizeHandler.bind(this);this.container.addEventListener("mouseup",this.bindStopDragResizeHandler);this.elements.resizeHandler.addEventListener("touchstart",this.onTouchDownResizeHandler.bind(this));this.bindTouchDragResizeHandler=this.onTouchDragResizeHandler.bind(this);this.container.addEventListener("touchmove",this.bindTouchDragResizeHandler);this.container.addEventListener("touchend",this.bindStopDragResizeHandler);this.elements.resizeHandler.addEventListener("pointerdown",this.onDownResizeHandler.bind(this));this.container.addEventListener("pointermove",this.bindDragResizeHandler);this.container.addEventListener("pointerup",this.bindStopDragResizeHandler);this.elements.textContainer.contentEditable=false;this.elements.resizeHandler.hide();this.elements.mBlankText.hide();this.controlsHidden=false},_onKeyPress:function(r){if(r.keyCode===13&&!r.shiftKey&&!r.ctrlKey){r.preventDefault();this.validate()}else{if(this.stopTyping&&(r.keyCode===8||r.keyCode===46)){this.stopTyping=false}}if(this.stopTyping){r.preventDefault()}},cancel:function(r){if(r.stopPropagation){r.stopPropagation()}if(r.preventDefault){r.preventDefault()}this.options.onCancel()},validate:function(){var r=this.getFieldText();if(r){this.options.onOk({type:"text",text:r,w:this.size.width-i+q,h:this.size.height,x:this.position.x,y:this.position.y,scale:this.mScale,offsetHeight:this.offsetHeight,fontSize:b})}},clearTextField:function(){var r=this.getFieldText();if(r.length!=0&&r!="Type your text"){this.setFieldText("")}},isEnabled:function(){return this.mEnable},enable:function(){this.mEnable=true;this.elements.textContainer.classList.add("active");this.elements.textContainer.classList.add("no_select");this.elements.resizeHandler.show();this.elements.textField.disabled=false;this.elements.textField.focus();if(!this.getFieldText()){this.elements.mBlankText.show()}this.launchAnimate()},disable:function(){this.mEnable=false;if(this.animationID){cancelAnimationFrame(this.animationID);this.animationID=undefined}this.elements.textContainer.classList.remove("active");this.elements.resizeHandler.hide();this.elements.mBlankText.hide();this.elements.textField.disabled=true;this.elements.textField.blur();this.elements.textField.selectionEnd=0;this.elements.textField.selectionStart=0;this.setFieldText(this.getFieldText())},hideControls:function(){this.elements.textContainer.hide();this.elements.textField.hide();this.controlsHidden=true},showControls:function(r,s){this.setPosition(r,s);this.elements.textField.show();this.elements.textContainer.show();this.controlsHidden=false},canBeCreatedAtPosition:function(r,u){var t=(r>=this.boundingLimits.left&&r<=this.boundingLimits.right);var s=(u>=this.boundingLimits.top&&u<=this.boundingLimits.bottom);if(t&&s){return true}else{return false}},removeSelection:function(){this.elements.textField.classList.remove("no_select")},getFieldText:function(){return this.elements.textField.value},setFieldText:function(r){this.elements.textField.value=r},setPosition:function(r,s){this.mDragCurrX=r;this.mDragCurrY=s},updateDimensions:function(){var r=this.elements.textContainer.getBoundingClientRect();this.size.height=r.height;this.size.width=r.width;this.position.x=r.left;this.position.y=r.top;this._setMaxDimensions()},_setMaxDimensions:function(){if(this.boundingLimits.bottom>0&&this.boundingLimits.right>0&&this.boundingLimits.top>=0&&this.boundingLimits.left>=0){this.size.maxWidth=this.boundingLimits.right-(this.position.x+i);this.size.maxHeight=this.boundingLimits.bottom-this.position.y;this.elements.textField.style.maxWidth=this.size.maxWidth+"px";this.elements.textField.style.maxHeight=this.size.maxHeight+"px";this.elements.textContainer.style.maxWidth=(this.size.maxWidth+i)+"px";this.elements.textContainer.style.maxHeight=this.size.maxHeight+"px"}},setBoundingLimitsFromReferenceElement:function(s){if(s){var r=s.getBoundingClientRect();var t=this.container.getBoundingClientRect();this.boundingLimits.top=(r.top>t.top)?r.top:t.top;this.boundingLimits.left=(r.left>t.left)?r.left:t.left;this.boundingLimits.bottom=(r.bottom<t.bottom)?r.bottom:t.bottom;this.boundingLimits.right=(r.right<t.right)?r.right:t.right}},mDragging:false,mResizing:false,mDragPrevX:0,mDragPrevY:0,mDragCurrX:0,mDragCurrY:0,mResizePrevX:0,mResizeDiffX:0,startDragging:function(){this.elements.textField.blur();this.mDragging=true},stopDragging:function(){this.mDragging=false},drag:function(r,s){this.mDragCurrX=r;this.mDragCurrY=s},onMouseDown:function(r){if(!this.mEnable){return}if(r.srcElement&&r.srcElement.className&&(r.srcElement.className.includes("textAnnot3DPlay-toolbar-button cancel")||r.srcElement.className.includes("fonticon fonticon-2x fonticon-cancel"))){return}if(r.stopPropagation){r.stopPropagation()}this.startDragging();this.mDragPrevX=r.clientX;this.mDragPrevY=r.clientY},onMouseUp:function(){if(!this.mEnable){return}this.stopDragging();this.stopDragResizeHandler()},onMouseMove:function(r){if(!this.mEnable){return}if(r.stopPropagation){r.stopPropagation()}if(this.mDragging){this.drag(r.clientX,r.clientY)}if(this.mResizing){this.dragResizeHandler(r.clientX)}},updateTextFieldSize:function(){this.elements.textField.style.height="10px";this.elements.textField.style.width="10px";var r=Math.max(20,this.elements.textField.scrollHeight);var t=Math.max(20,this.elements.textField.scrollWidth);var s=this.getFieldText();if(s){var v=a+q;if(this.position.x>0){v=this.position.x<=a?a+q-this.position.x:0}if(this.size.maxWidth-v<=(this.elements.textField.scrollWidth+i)*this.mScale&&this.wrap===false){this.wrap=true;var u=(this.size.maxWidth/this.mScale)-v<this.elements.textField.scrollWidth?(this.size.maxWidth/this.mScale)-v:this.elements.textField.scrollWidth;this.elements.textField.style.minWidth=u+"px";this.elements.textField.wrap="hard"}if(this.elements.textField.scrollHeight<this.size.maxHeight/this.mScale){if(this.elements.textField.scrollHeight+this.offsetHeight<this.size.maxHeight/this.mScale&&this.stopTyping===true){this.stopTyping=false}if(this.elements.textField.offsetHeight===this.elements.textField.scrollHeight&&this.currText!==s){this.wrap=false;this.elements.textField.wrap="OFF"}if(this.elements.textField.wrap==="OFF"||this.elements.textField.wrap==="off"){this.elements.textContainer.style.minWidth="0px";this.elements.textField.style.minWidth="0px";this.minWidthSet=false}else{if(this.elements.textField.wrap==="hard"&&this.minWidthSet===false){this.elements.textField.style.minWidth=(this.elements.textField.scrollWidth)+"px";this.minWidthSet=true}}if(this.minWidthSet){t=Math.max(20,parseInt(this.elements.textField.style.minWidth))}this.elements.mBlankText.hide();this.elements.buttonCancel.show();this.textBlank=false}if(this.elements.textField.scrollHeight>=this.size.maxHeight/this.mScale&&this.stopTyping===false&&this.currText){this.stopTyping=true;r=Math.max(20,this.elements.textField.scrollHeight-this.offsetHeight);this.setFieldText(this.currText.substring(0,this.currText.length))}if(this.currText!==s){this.currText=s;o.publish({event:"Text:BeginTyping",data:s});if(this.onTypeStartCB){this.onTypeStartCB({data:s})}}this.offsetHeight=this.elements.textField.offsetHeight}else{this.wrap=false;this.minWidthSet=false;this.currText="";this.stopTyping=false;this.elements.textField.wrap="OFF";if(this.controlsHidden===false&&this.elements.mBlankText.isHidden()===true){this.elements.mBlankText.show()}this.elements.buttonCancel.hide();this.textBlank=true;t=Math.max(this.elements.mBlankText.clientWidth,t);this.elements.textField.style.minWidth=n+"px"}this.elements.textField.style.width=t.toString()+"px";this.elements.textField.style.height=r.toString()+"px"},resizeText:function(B){var t=q*2;if(this.textBlank===false){t=i}var A=this.elements.textField.scrollWidth;if(this.minWidthSet){A=parseInt(this.elements.textField.style.minWidth)}if(this.mResizing===true&&this.mScale<=5&&this.mScale>=1&&B){var r=this.elements.textContainer.offsetWidth;var C=r+B;if((C>A+i)&&(C<A*5)&&(C<this.size.maxWidth)&&(this.elements.textField.scrollHeight*this.mScale<this.elements.textContainer.offsetHeight||B<0)){this.elements.textContainer.style.width=Math.max(35,C)+"px"}}else{this.elements.textContainer.style.width=Math.max(35,(A*this.mScale+t)).toString()+"px"}this.mScale=(this.elements.textContainer.offsetWidth-t)/A*this.mScale<1?1:(this.elements.textContainer.offsetWidth-t)/A;this.mScale=this.mScale>5?5:this.mScale;var v=(this.elements.textField.clientWidth*(this.mScale-1))/2;var s=(this.elements.textField.clientHeight*(this.mScale-1))/2;var x=this.elements.textField.clientHeight*this.mScale;var w="translate("+v+"px, "+s+"px) scale("+this.mScale+")";this.elements.textField.setStyle("transform",w);this.elements.textField.setStyle("-webkit-transform",w);this.elements.textField.style.top=(this.elements.textContainer.offsetTop+q)+"px";this.elements.textField.style.left=(this.elements.textContainer.offsetLeft+q)+"px";this.elements.mBlankText.style.top=this.elements.textField.style.top;this.elements.mBlankText.style.left=this.elements.textField.style.left;var z=(this.elements.mBlankText.clientWidth*(this.mScale-1))/2;var y=(this.elements.mBlankText.clientHeight*(this.mScale-1))/2;var u="translate("+z+"px, "+y+"px) scale("+this.mScale+")";this.elements.mBlankText.setStyle("transform",u);this.elements.mBlankText.setStyle("-webkit-transform",u);this.elements.textContainer.style.height=(x+q)+"px"},updateTextPosition:function(y,x){var z=(y>=this.boundingLimits.left&&y<=this.boundingLimits.right);var t=(x>=this.boundingLimits.top&&x<=this.boundingLimits.bottom);if(z&&t){var w=this.boundingLimits.right-this.elements.textContainer.offsetWidth;var v=this.boundingLimits.bottom-this.elements.textContainer.offsetHeight;var u=this.container.getBoundingClientRect();var s=((y<w)?y:w)-u.left;var r=((x<v)?x:v)-u.top;this.elements.textContainer.setStyle("top",r+"px");this.elements.textContainer.setStyle("left",s+"px");this.elements.textField.setStyle("top",r+"px");this.elements.textField.setStyle("left",s+"px");this.elements.mBlankText.setStyle("top",r+"px");this.elements.mBlankText.setStyle("left",s+"px")}},_setLastPosition:function(s,t){var r={x:0.4,y:0.4};r=this.viewer.getViewerPositionFromMouse({x:s,y:t});r={x:this.viewer.scale*r.x/this.viewer.currentWidth,y:this.viewer.scale*r.y/this.viewer.currentHeight};this.drawSettings.setLastPosition(r)},launchAnimate:function(){function r(){if(!this.mEnable){return}if(!this.elements.textContainer){return}this.updateTextFieldSize();if(this.mDragCurrX||this.mDragCurrY){this.updateTextPosition(this.mDragCurrX,this.mDragCurrY);this.mDragCurrX=undefined;this.mDragCurrY=undefined}this.resizeText(this.mResizeDiffX);this.mResizeDiffX=0;this.updateDimensions();this.updateTextFieldSize();this.bindAnimate=r.bind(this);this.animationID=requestAnimationFrame(this.bindAnimate)}r.bind(this)()},initDragResizeHandler:function(r){this.elements.textField.blur();this.mResizing=true;this.mResizePrevX=r},dragResizeHandler:function(r){if(this.mResizing&&this.mScale>=1&&this.mScale<=5&&this.mResizeDiffX===0){var s=r;this.mResizeDiffX=s-this.mResizePrevX;this.mResizePrevX=s}},stopDragResizeHandler:function(){this.mResizing=false;this.elements.textField.focus();return false},onDownResizeHandler:function(r){if(!this.mEnable){return}if(r.stopPropagation){r.stopPropagation()}this.initDragResizeHandler(r.pageX);return false},onDragResizeHandler:function(r){if(!this.mEnable){return}if(r.stopPropagation){r.stopPropagation()}this.dragResizeHandler(r.pageX);return false},onTouchDownResizeHandler:function(r){if(!this.mEnable){return}if(r.stopPropagation){r.stopPropagation()}if(r.targetTouches.length===1){this.initDragResizeHandler(r.targetTouches[0].pageX)}return false},onTouchDragResizeHandler:function(r){if(!this.mEnable){return}if(r.targetTouches.length===1){this.dragResizeHandler(r.targetTouches[0].pageX)}return false},onParentMouseMove:function(r){if(!this.mEnable){return}if(this.mDragging){this.onMouseMove(r)}},onParentMouseUp:function(){if(!this.mEnable){return}this.stopDragging()},onTouchStart:function(r){if(!this.mEnable){return}if(r.target&&r.target.className&&r.target.className.includes("cancel")){return}if(r.preventDefault){r.preventDefault()}if(r.targetTouches.length===1){var s=r.targetTouches[0];this.startDragging();this.mDragPrevX=s.pageX;this.mDragPrevY=s.pageY}},onTouchEnd:function(r){if(!this.mEnable){return}if(r.preventDefault){r.preventDefault()}this.stopDragging()},onTouchMove:function(r){if(r.preventDefault){r.preventDefault()}if(!this.mEnable){return}if(r.targetTouches.length===1){var s=r.targetTouches[0];if(this.mDragging){this.drag(s.pageX,s.pageY)}if(this.mResizing){this.dragResizeHandler(s.pageX)}}}});return g});define("DS/3DPlayAnnotationUtils/AnnotationTextControl",["UWA/Core","UWA/Controls/Abstract","css!DS/3DPlayAnnotationUtils/AnnotationTextControl","DS/WebSystem/Nls","DS/CoreEvents/Events","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/Core/PointerEvents"],function(h,k,l,o,n,d,j){var p=5;var f=205;var m=163;var e=40;var a=45;var c=0;var b=25;var i=30;var g=k.extend({defaultOptions:{className:"SmartAnnot3DPlayWebTextControl",canvas:null},mScale:1,mPosition:{},init:function(q){this._parent(q);this.mode=q.mode;this.viewerFrame=this.options.viewerFrame;this.uiFrame=q.uiFrame;this._exp=q.experience;if(this._exp&&this._exp.registerCollabAction){this._exp.registerCollabAction("annotTextKeyPress",this._onKeyPress.bind(this));this._exp.registerCollabAction("annotTextValidate",this.validate.bind(this));this._exp.registerCollabAction("annotTextDrag",this.drag.bind(this));this._exp.registerCollabAction("annotTextResize",this.dragResizeHandler.bind(this));this._exp.registerCollabAction("annotTextInitDrag",this.onPointerDown.bind(this));this._exp.registerCollabAction("annotTextInitResize",this.initDragResizeHandler.bind(this));this._exp.registerCollabAction("annotTextStopResize",this.stopDragResizeHandler.bind(this));this._exp.registerCollabAction("annotTextStopDrag",this.onMouseUp.bind(this))}this.viewer=q.viewer;this.onTypeStartCB=q.onTypeStartCB;this.drawSettings=new d();this._buildUI(q.containerStyle)},destroy:function(){var r=this;cancelAnimationFrame(this.animationID);this.animationID=undefined;this.bindAnimate=undefined;this._unSubscribeListners();n.unsubscribe(this.tokenSettingsChanged);this.viewerFrame=undefined;var q=document.getElementById("annot3dNewTextInput");if(q&&q.remove()){q.remove()}this.viewer=undefined;this.uiFrame=undefined;this.onTypeStartCB=undefined;this.drawSettings=undefined},_setTextProperties:function(q){if(q){this.elements.textField.style.color=q.color;var r=(parseInt(q.thickness)-3)*100;this.elements.textField.style.fontWeight=r}else{this.elements.textField.style.color=this.drawSettings.getColor();var r=(parseInt(this.drawSettings.getThickness())-3)*100;this.elements.textField.style.fontWeight=r}},_buildUI:function(){var v=this;var u=this.viewerFrame.getDimensions().width;var r=this.viewerFrame.getDimensions().height;var t=this.options.x||Math.round(u*0.4);var s=this.options.y||Math.round(r*0.3);this.placeHolderText;o.nls("3DPlayAnnotationUtils/3DPlayAnnotation","PlaceHolder",function(w){v.placeHolderText=w;if(v.elements&&v.elements.mBlankText){v.elements.mBlankText.setHTML(v.placeHolderText)}});this.container=new h.Element("div",{id:"annot3dNewTextInput"});this.elements.textContainer=new h.Element("div",{styles:{top:s+"px",left:t+"px"},"class":"textAnnot3DPlay-text-container"}).inject(this.container);this.elements.mBlankText=new h.Element("div",{html:v.placeHolderText,styles:{top:s+"px",left:t+"px"},"class":"textAnnot3DPlay-editor-field blank",id:"editor-field"}).inject(this.container);this.elements.textField=new h.Element("textarea",{styles:{top:s+"px",left:t+"px"},"class":"textAnnot3DPlay-editor-field",id:"editor-field-textArea",WRAP:"OFF",events:{dragstart:function(w){w.preventDefault()},drag:function(w){w.preventDefault()},dragover:function(w){w.preventDefault()},dragenter:function(w){w.preventDefault()},dragleave:function(w){w.preventDefault()},drop:function(w){w.preventDefault()},dragend:function(w){w.preventDefault()}}}).inject(this.container);this.elements.buttonCancel=new h.Element("div",{"class":"textAnnot3DPlay-toolbar-button cancel",styles:{verticalAlign:"middle"}}).inject(this.elements.textContainer);var q=new h.Element("div",{"class":"fonticon fonticon-2x fonticon-cancel",}).inject(this.elements.buttonCancel);this.elements.buttonCancel.hide();this.text=false;this.elements.resizeHandler=new h.Element("div",{"class":"textAnnot3DPlay-resize-handler"}).inject(this.elements.textContainer);this.elements.resizeHandlerCircle=new h.Element("div",{"class":"textAnnot3DPlay-resize-handler-circle",}).inject(this.elements.resizeHandler);this.elements.resizeHandlerArrow=new h.Element("div",{"class":"textAnnot3DPlay-resize-handler-image",}).inject(this.elements.resizeHandler);this._setTextProperties();this.tokenSettingsChanged=n.subscribe({event:"3DPlay.Annotation.SettingsChanged"},function(w){v._setTextProperties(w)});if(!v._exp||v._exp.collabMode!==false){this._subscribeListners()}else{this.elements.textContainer.contentEditable=false}this.elements.resizeHandler.hide();this.elements.mBlankText.hide();this.controlsHidden=false},_subscribeListners:function(){this.onTextContainerPointerDown=function(q){this.onPointerDown(q)}.bind(this);this.onTextContainerPointerMove=function(q){this.onPointerMove(q)}.bind(this);this.onTextContainerPointerUp=function(q){this.onPointerUp(q)}.bind(this);this.elements.textContainer.addEventListener(j.POINTERDOWN,this.onTextContainerPointerDown);this.elements.textContainer.addEventListener(j.POINTERMOVE,this.onTextContainerPointerMove);this.elements.textContainer.addEventListener(j.POINTERUP,this.onTextContainerPointerUp);this.onTextFieldPointerDown=function(q){this.onPointerDown(q)}.bind(this);this.onTextFieldPointerMove=function(q){this.onPointerMove(q)}.bind(this);this.onTextFieldPointerUp=function(q){this.onPointerUp(q)}.bind(this);this.elements.textField.addEventListener(j.POINTERDOWN,this.onTextFieldPointerDown);this.elements.textField.addEventListener(j.POINTERMOVE,this.onTextFieldPointerMove);this.elements.textField.addEventListener(j.POINTERUP,this.onTextFieldPointerUp);this.elements.textField.addEventListener("blur",this.removeSelection.bind(this));this.elements.textField.addEventListener("keydown",this._onKeyPress.bind(this));this.onViewerFramePointerMove=function(q){this.onPointerMove(q)}.bind(this);this.onViewerFramePointerUp=function(q){this.onPointerUp(q)}.bind(this);this.viewerFrame.addEventListener(j.POINTERMOVE,this.onViewerFramePointerMove);this.viewerFrame.addEventListener(j.POINTERUP,this.onViewerFramePointerUp);this.elements.resizeHandler.addEventListener(j.POINTERDOWN,this.onDownResizeHandler.bind(this),true);this.elements.buttonCancel.addEventListener(j.POINTERDOWN,this.cancel.bind(this),true)},_unSubscribeListners:function(){this.elements.textContainer.removeEventListener(j.POINTERDOWN,this.onTextContainerPointerDown);this.elements.textContainer.removeEventListener(j.POINTERMOVE,this.onTextContainerPointerMove);this.elements.textContainer.removeEventListener(j.POINTERUP,this.onTextContainerPointerUp);this.elements.textField.removeEventListener(j.POINTERDOWN,this.onTextFieldPointerDown);this.elements.textField.removeEventListener(j.POINTERMOVE,this.onTextFieldPointerMove);this.elements.textField.removeEventListener(j.POINTERUP,this.onTextFieldPointerUp);this.elements.textField.removeEventListener("blur",this.removeSelection.bind(this));this.elements.textField.removeEventListener("keydown",this._onKeyPress.bind(this));this.elements.resizeHandler.removeEventListener(j.POINTERDOWN,this.onDownResizeHandler.bind(this),true);this.elements.buttonCancel.removeEventListener(j.POINTERDOWN,this.cancel.bind(this),true);this.viewerFrame.removeEventListener(j.POINTERMOVE,this.onViewerFramePointerMove);this.viewerFrame.removeEventListener(j.POINTERUP,this.onViewerFramePointerUp)},_onKeyPress:function(q){var r=this;if(r._exp&&r._exp.collabMode===false){r.setFieldText(q);return}if(r._exp&&r._exp.collabMode===true){setTimeout(function(){r._exp.notifyAction&&r._exp.notifyAction("annotTextKeyPress",[r.getFieldText()])},200)}if(q.keyCode===13&&!q.shiftKey&&!q.ctrlKey){if(q.preventDefault){q.preventDefault()}setTimeout(function(){r.validate();if(r._exp&&r._exp.collabMode===true){r._exp.notifyAction&&r._exp.notifyAction("annotTextValidate")}},200)}if(q.keyCode===9&&q.preventDefault){q.preventDefault()}if(this.stopTyping){if(q.keyCode===8||q.keyCode===46){this.stopTyping=false}else{if(q.keyCode===13){if(q.preventDefault){q.preventDefault()}setTimeout(function(){if(r._exp&&r._exp.collabMode===true){r._exp.notifyAction("annotTextValidate")}r.validate();r.stopTyping=false},200)}else{if(!(q.keyCode===37||q.keyCode===38||q.keyCode===39||q.keyCode===40)&&q.preventDefault){q.preventDefault()}}}}},cancel:function(q){if(q.stopPropagation){q.stopPropagation()}if(q.preventDefault){q.preventDefault()}this.options.onCancel()},validate:function(){var r=this.getFieldText();if(r){var q=this.mPosition.x1;var t=this.mPosition.y1;if(this.mode=="2D"){var s=this.uiFrame.getBoundingClientRect();q+=s.left;t+=s.top}this.options.onOk({type:"text",text:r,w:this.mPosition.width-i+p*6,h:this.mPosition.height,x:q,y:t,scale:this.mScale,offsetHeight:this.offsetHeight,fontSize:b})}},clearTextField:function(){var q=this.getFieldText();if(q.length!=0&&q!="Type your text"){this.setFieldText("")}},enable:function(){this.mEnable=true;this.elements.textContainer.classList.add("active");this.elements.textContainer.classList.add("no_select");this.elements.resizeHandler.show();this.elements.textField.disabled=false;this.elements.mBlankText.show();if(!this.getFieldText()){this.elements.mBlankText.show()}this.launchAnimate();this.setFocus()},disable:function(){this.mEnable=false;this.elements.textContainer.classList.remove("active");this.elements.resizeHandler.hide();this.elements.mBlankText.hide();this.elements.textField.disabled=true;this.elements.textField.blur();this.elements.textField.selectionEnd=0;this.elements.textField.selectionStart=0;this.setFieldText(this.getFieldText())},hideControls:function(){this.elements.textContainer.hide();this.elements.textField.hide();this.controlsHidden=true},showControls:function(q,r){this.elements.textField.show();this.elements.textContainer.show();this.controlsHidden=false;this.setPosition(q,r);this.setFocus()},removeSelection:function(){this.elements.textField.classList.remove("no_select")},getFieldText:function(){return this.elements.textField.value},setFieldText:function(q){this.elements.textField.value=q},setFocus:function(){this.elements.textField.focus()},getContainerWidth:function(){var q=this.elements.textContainer.clientWidth||f;return q},getContainerHeight:function(){var q=this.elements.textContainer.clientHeight||e;return q},setPosition:function(q,r){this.mDragCurrX=q;this.mDragCurrY=r},updateDimensions:function(){this.mPosition.height=this.elements.textContainer.offsetHeight;this.mPosition.width=this.elements.textContainer.offsetWidth;this.mPosition.x1=this.elements.textContainer.offsetLeft;this.mPosition.y1=this.elements.textContainer.offsetTop;this.mPosition.x2=this.mPosition.x1+this.mPosition.width;this.mPosition.y2=this.mPosition.y1+this.mPosition.height;this._setMaxDimensions()},_setMaxDimensions:function(){var r=this.mPosition.viewerLeft<=0?a+p:this.mPosition.viewerLeft+a+p;var q=this.mPosition.viewerTop<=0?c:this.mPosition.viewerTop+c;this.mPosition.maxWidth=(this.mPosition.viewerWidth-this.mPosition.x1-r+a);this.mPosition.maxHeight=(this.mPosition.viewerHeight-this.mPosition.y1-q);this.elements.textField.style.maxWidth=(((this.mPosition.maxWidth+r-a)/this.mScale))+"px";this.elements.textField.style.maxHeight=(((this.mPosition.maxHeight+q)/this.mScale)-q-p)+"px";this.elements.textContainer.style.maxWidth=this.mPosition.maxWidth+"px";this.elements.textContainer.style.maxHeight=this.mPosition.maxHeight+"px"},setBoundingLimits:function(r,q,t,s){this.mPosition.viewerWidth=r;this.mPosition.viewerHeight=q;this.mPosition.viewerTop=t||0;this.mPosition.viewerLeft=s||0},getPosition:function(q){if(q){return({x:(this.mPosition.x1/this.mPosition.viewerWidth),y:(this.mPosition.y1/this.mPosition.viewerHeight)})}else{return({x:this.mPosition.x1,y:this.mPosition.y1})}},getSize:function(){return({w:this.mPosition.width,h:this.mPosition.height})},mDragging:false,mResizing:false,mDragPrevX:0,mDragPrevY:0,mDragCurrX:0,mDragCurrY:0,mResizePrevX:0,mResizeDiffX:0,mPrevPinch:{x1:0,y1:0,x2:0,y2:0},startDragging:function(){this.elements.textField.blur();this.mDragging=true},stopDragging:function(){this.mDragging=false;if(!this._exp||this._exp.collabMode!==false){this.setFocus()}},drag:function(q,r){this.mDragCurrX=q-this.mDragPrevX;this.mDragCurrY=r-this.mDragPrevY;if(this._exp&&this._exp.collabMode===true){this._exp.notifyAction&&this._exp.notifyAction("annotTextDrag",[q,r])}},onPointerDown:function(q){if(!this.mEnable){return}if(q.srcElement&&q.srcElement.className&&(q.srcElement.className.includes("textAnnot3DPlay-toolbar-button cancel")||q.srcElement.className.includes("fonticon fonticon-2x fonticon-cancel"))){return}if(q.stopPropagation){q.stopPropagation()}if(q.preventDefault){q.preventDefault()}this.startDragging();this.mDragPrevX=q.clientX;this.mDragPrevY=q.clientY;if(this._exp&&this._exp.collabMode===true){this._exp.notifyAction&&this._exp.notifyAction("annotTextInitDrag",[q])}},onPointerMove:function(q){if(!this.mEnable){return}if(q.preventDefault){q.preventDefault()}if(q.stopPropagation){q.stopPropagation()}if(this.mDragging){this.drag(q.clientX,q.clientY)}if(this.mResizing){this.dragResizeHandler(q.clientX)}if(this._exp&&this._exp.collabMode===true){this._exp.notifyAction&&this._exp.notifyAction("annotTextDragResize",[q])}},onPointerUp:function(q){if(!this.mEnable){return}if(q.preventDefault){q.preventDefault()}this.stopDragging();this.stopDragResizeHandler()},onMouseUp:function(){if(!this.mEnable){return}this.stopDragging();this.stopDragResizeHandler();if(this._exp&&this._exp.collabMode===true){this._exp.notifyAction&&this._exp.notifyAction("annotTextStopDrag")}},updateTextFieldSize:function(){this.elements.textField.style.height="10px";this.elements.textField.style.width="10px";var v=Math.max(20,this.elements.textField.scrollHeight);var x=Math.max(20,this.elements.textField.scrollWidth);var r=this.getFieldText();if(r){var t=a+p;if(this.mPosition.viewerLeft>0){t=this.mPosition.viewerLeft<=a?a+p-this.mPosition.viewerLeft:0}if(this.mPosition.maxWidth-t<=(this.elements.textField.scrollWidth+i)*this.mScale&&this.wrap===false){this.wrap=true;var q=(this.mPosition.maxWidth/this.mScale)-t<this.elements.textField.scrollWidth?(this.mPosition.maxWidth/this.mScale)-t:this.elements.textField.scrollWidth;this.elements.textField.style.minWidth=q+"px";this.elements.textField.wrap="hard"}if(this.elements.textField.scrollHeight<this.mPosition.maxHeight/this.mScale){if(this.elements.textField.scrollHeight+this.offsetHeight<this.mPosition.maxHeight/this.mScale){this.stopTyping=false}if(this.elements.textField.offsetHeight===this.elements.textField.scrollHeight&&this.currText!==r){this.wrap=false;this.elements.textField.wrap="OFF"}if(this.elements.textField.wrap==="OFF"||this.elements.textField.wrap==="off"){this.elements.textContainer.style.minWidth="0px";this.elements.textField.style.minWidth="0px";this.minWidthSet=false}else{if(this.elements.textField.wrap==="hard"&&this.minWidthSet===false){this.elements.textField.style.minWidth=(this.elements.textField.scrollWidth)+"px";this.minWidthSet=true}}if(this.minWidthSet){x=Math.max(20,parseInt(this.elements.textField.style.minWidth))}this.elements.mBlankText.hide();this.elements.buttonCancel.show();this.textBlank=false}if(this.elements.textField.scrollHeight>=this.mPosition.maxHeight/this.mScale&&this.stopTyping===false&&this.currText){this.setFieldText(this.currText.substring(0,this.currText.length));v=Math.max(20,this.elements.textField.scrollHeight-this.offsetHeight);this.stopTyping=true}if(this.currText!==r){this.currText=r;n.publish({event:"Text:BeginTyping",data:r});if(this.onTypeStartCB){this.onTypeStartCB({data:r})}this.noMoreSpaces=false}this.offsetHeight=this.elements.textField.offsetHeight}else{this.wrap=false;this.minWidthSet=false;this.currText="";this.stopTyping=false;this.elements.textField.wrap="OFF";var y=false;if(this.controlsHidden===false&&this.elements.mBlankText.isHidden()===true){this.elements.mBlankText.show();y=true}this.elements.buttonCancel.hide();this.textBlank=true;x=Math.max(this.elements.mBlankText.clientWidth,x);this.elements.textContainer.style.minWidth=f+"px";this.elements.textField.style.minWidth=m+"px";if(y===true){y=false;var w=this.mPosition.viewerLeft<=0?this.mPosition.viewerWidth-a+p:this.mPosition.viewerWidth-this.mPosition.viewerLeft+p;var u=this.mPosition.viewerLeft<=0?0:this.mPosition.viewerLeft;if(!(this.mPosition.x1<w-f-p&&this.mPosition.x1>u)){this.mPosition.x1=w-f-p}}}var s=x.toString();this.elements.textField.style.width=x.toString()+"px";this.elements.textField.style.height=v.toString()+"px"},resizeText:function(A){var s=p*2;if(this.textBlank===false){s=i}var z=this.elements.textField.scrollWidth;if(this.minWidthSet){z=parseInt(this.elements.textField.style.minWidth)}if(this.mResizing===true&&this.mScale<=5&&this.mScale>=1&&A){var q=this.elements.textContainer.offsetWidth;var B=q+A;if(B>z+i&&B<z*5&&(this.elements.textField.scrollHeight*this.mScale<this.elements.textContainer.offsetHeight||A<0)){this.elements.textContainer.style.width=Math.max(35,B)+"px"}}else{this.elements.textContainer.style.width=Math.max(35,(z*this.mScale+s)).toString()+"px"}this.mScale=(this.elements.textContainer.offsetWidth-s)/z*this.mScale<1?1:(this.elements.textContainer.offsetWidth-s)/z;this.mScale=this.mScale>5?5:this.mScale;var u=(this.elements.textField.clientWidth*(this.mScale-1))/2;var r=(this.elements.textField.clientHeight*(this.mScale-1))/2;var u=(this.elements.textField.clientWidth*(this.mScale-1))/2;var r=(this.elements.textField.clientHeight*(this.mScale-1))/2;var w=this.elements.textField.clientHeight*this.mScale;var v="translate("+u+"px, "+r+"px) scale("+this.mScale+")";this.elements.textField.setStyle("transform",v);this.elements.textField.setStyle("-webkit-transform",v);this.elements.textField.style.top=(this.elements.textContainer.offsetTop+p)+"px";this.elements.textField.style.left=(this.elements.textContainer.offsetLeft+p)+"px";this.elements.mBlankText.style.top=this.elements.textField.style.top;this.elements.mBlankText.style.left=this.elements.textField.style.left;var y=(this.elements.mBlankText.clientWidth*(this.mScale-1))/2;var x=(this.elements.mBlankText.clientHeight*(this.mScale-1))/2;var t="translate("+y+"px, "+x+"px) scale("+this.mScale+")";this.elements.mBlankText.setStyle("transform",t);this.elements.mBlankText.setStyle("-webkit-transform",t);this.elements.textContainer.style.height=(w+p)+"px"},updateTextPosition:function(w,v){var q=this.mPosition.viewerTop<=0?0:this.mPosition.viewerTop;var t=this.mPosition.viewerTop<=0?this.mPosition.viewerHeight-c+p:this.mPosition.viewerHeight-this.mPosition.viewerTop-c+p;var u=this.mPosition.viewerLeft<=0?this.mPosition.viewerWidth-a+p:this.mPosition.viewerWidth-this.mPosition.viewerLeft+p;var s=this.mPosition.viewerLeft<=0?0:this.mPosition.viewerLeft;if(this.mDragging===true){var r=this.mPosition.viewerLeft<=a?0:this.mPosition.viewerLeft+a+p;var A=this.mPosition.viewerTop<=c?0:this.mPosition.viewerTop+c;var x=this.elements.textContainer.offsetTop+v;var z=this.elements.textContainer.offsetLeft+w;if(x>q&&x<t-this.elements.textContainer.scrollHeight&&z<u-this.elements.textContainer.scrollWidth&&z>s){this.elements.textContainer.setStyle("top",(this.elements.textContainer.offsetTop+v)+"px");this.elements.textContainer.setStyle("left",(this.elements.textContainer.offsetLeft+w)+"px");this.elements.textField.setStyle("top",(this.elements.textField.offsetTop+v)+"px");this.elements.textField.setStyle("left",(this.elements.textField.offsetLeft+w)+"px");this.elements.mBlankText.setStyle("top",(this.elements.mBlankText.offsetTop+v)+"px");this.elements.mBlankText.setStyle("left",(this.elements.mBlankText.offsetLeft+w)+"px");this.mDragPrevX+=w;this.mDragPrevY+=v}}else{if(this.mode=="2D"){var y=this.uiFrame.getBoundingClientRect();w-=y.left;v-=y.top}if(v>t-this.elements.textContainer.scrollHeight){v=t-this.elements.textContainer.scrollHeight}if(w>u-this.elements.textContainer.scrollWidth){w=u-this.elements.textContainer.scrollWidth}if((v>q&&v<=t-this.elements.textContainer.scrollHeight)&&(w<=u-this.elements.textContainer.scrollWidth&&w>s)){if(w!=0||v!=0){this._setLastPosition(w,v);this.elements.textContainer.setStyle("top",(v)+"px");this.elements.textContainer.setStyle("left",(w)+"px");this.elements.textField.setStyle("top",(v)+"px");this.elements.textField.setStyle("left",(w)+"px");this.elements.mBlankText.setStyle("top",(v)+"px");this.elements.mBlankText.setStyle("left",(w)+"px");this.mDragPrevX=w;this.mDragPrevY=v}}}},_setLastPosition:function(r,u){var q={x:0.4,y:0.4};if(this.mode=="2D"){q=this.viewer.getViewerPositionFromMouse({x:r,y:u});q={x:this.viewer.scale*q.x/this.viewer.currentWidth,y:this.viewer.scale*q.y/this.viewer.currentHeight}}else{if(this.mode=="3D"){var s=this.viewerFrame.getBoundingClientRect();var t=this.viewerFrame.getDimensions();q={x:(r+s.left)/t.width,y:(u+s.top)/t.height}}}this.drawSettings.setLastPosition(q)},launchAnimate:function(){function q(){if(!this.mEnable){return}if(!this.elements.textContainer){return}this.updateTextFieldSize();if(this.mDragCurrX||this.mDragCurrY){this.updateTextPosition(this.mDragCurrX,this.mDragCurrY);this.mDragCurrX=0;this.mDragCurrY=0}this.resizeText(this.mResizeDiffX);this.mResizeDiffX=0;this.updateDimensions();this.updateTextFieldSize();this.bindAnimate=q.bind(this);this.animationID=requestAnimationFrame(this.bindAnimate)}q.bind(this)()},initDragResizeHandler:function(q){this.elements.textField.blur();this.mResizing=true;this.mResizePrevX=q;if(this._exp&&this._exp.collabMode===true){this._exp.notifyAction&&this._exp.notifyAction("annotTextInitResize",[q])}},dragResizeHandler:function(q){if(this.mResizing&&this.mScale>=1&&this.mScale<=5&&this.mResizeDiffX===0){var r=q;this.mResizeDiffX=r-this.mResizePrevX;this.mResizePrevX=r;if(this._exp&&this._exp.collabMode===true){this._exp.notifyAction&&this._exp.notifyAction("annotTextResize",[q])}}},stopDragResizeHandler:function(){this.mResizing=false;if(!this._exp||this._exp.collabMode!==false){this.setFocus()}if(this._exp&&this._exp.collabMode===true){this._exp.notifyAction&&this._exp.notifyAction("annotTextStopResize")}return false},onDownResizeHandler:function(q){if(!this.mEnable){return}if(q.preventDefault){q.preventDefault()}if(q.stopPropagation){q.stopPropagation()}this.initDragResizeHandler(q.clientX);return false}});return g});define("DS/3DPlayAnnotationUtils/AnnotationTools",["UWA/Class","DS/3DPlayAnnotationUtils/CurvedLayout","DS/3DPlayAnnotationUtils/AnnotationSettings","css!DS/3DPlayAnnotationUtils/AnnotationTools","DS/CoreEvents/Events"],function(b,f,d,g,j){var i=["#FF0000","#FF9900","#FFFF00","#00CC00","#0033CC","#660099","#000000","#FFFFFF"];var c=[4,6,8,10,12];var e;var a=50;var h=b.extend({init:function(k){e=this;this.drawSettings=new d();this.frame=k.container;this.viewerFrame=k.frameWindow.getViewerFrame();var m=k.frameWindow.getActionBar();if(m&&m.MAB){this.MAB=m.MAB}this.exp=k.frameWindow.experience;var l=function(n){e.drawSettings.setColor(n.color);e.drawSettings.setThickness(n.thickness);e.drawSettings.setOpacity(n.opacity)};this._createAnnotPanel();this.exp&&this.exp.registerCollabAction&&this.exp.registerCollabAction("annotChangeSettings",l.bind(this));if(this.exp&&this.exp.notifyAction&&this.exp.collabMode===true){this.tokenSettingsChanged=j.subscribe({event:"3DPlay.Annotation.SettingsChanged"},function(n){e.exp.notifyAction("annotChangeSettings",[n])})}},dispose:function(){if(this.tokenSettingsChanged){j.unsubscribe(this.tokenSettingsChanged)}if(this.MAB){this.MAB.onVisibilityChangeUnsubscribe("PlayWeb-colorPalette");this.MAB.onVisibilityChangeUnsubscribe("PlayWeb-thicknessPalette")}var k;if(this.buttonsColor){while(this.buttonsColor.length>0){k=this.buttonsColor.pop();k.btn.removeEvent("click",k.mouseCB);k.btn.removeEvent("touchstart",k.touchCB);k.btnMAB.removeEvent("click",k.mouseCB);k.btnMAB.removeEvent("touchstart",k.touchCB)}this.buttonsColor=null}if(this.colorPalette){this.colorPalette.remove();this.colorPalette=undefined}if(this.buttonsThickness){while(this.buttonsThickness.length>0){k=this.buttonsThickness.pop();k.btn.removeEvent("click",k.mouseCB);k.btn.removeEvent("touchstart",k.touchCB);k.btnMAB.removeEvent("click",k.mouseCB);k.btnMAB.removeEvent("touchstart",k.touchCB)}this.buttonsThickness=null}if(this.thicknessPalette){this.thicknessPalette.remove();this.thicknessPalette=undefined}this.drawSettings=undefined;this.frame=undefined;this.MAB=null;e=undefined},delayedDispose:function(){if(this.colorPaletteVisible){this.colorPalette.addEventListener("transitionend",function(){e.dispose()});this.hideColorPalette()}if(this.thicknessPaletteVisible){this.thicknessPalette.addEventListener("transitionend",function(){e.dispose()});this.hideThicknessPalette()}},_createAnnotPanel:function(){this.colorPalette=this._createColorContent();this.colorPalette.inject(this.frame);this.thicknessPalette=this._createThicknessContent();this.thicknessPalette.inject(this.frame)},getColorPaletteVisibility:function(){return this.colorPaletteVisible},showColorPalette:function(){if(this._firstLaunchAfterCreation){this.colorPalette.style.right=-(this.colorPalette.clientWidth)+"px";this._firstLaunchAfterCreation=undefined}else{if(this.MAB){this.MAB.showToolMenu(this.buttonsColor)}this.colorPalette.style.transition="right 0.6s ease";this.colorPalette.style.right="0px";this.colorPaletteVisible=true}},hideColorPalette:function(){if(this.MAB){this.MAB.hideToolMenu(this.buttonsColor)}this.colorPalette.style.transition="right 0.6s ease";this.colorPalette.style.right=-(this.colorPalette.clientWidth)+"px";this.colorPaletteVisible=false},showThicknessPalette:function(){if(this.MAB){this.MAB.showToolMenu(this.buttonsThickness)}this.thicknessPalette.style.transition="right 0.6s ease";this.thicknessPalette.style.right="0px";this.thicknessPaletteVisible=true},hideThicknessPalette:function(){this.thicknessPalette.style.transition="right 0.6s ease";this.thicknessPalette.style.right=-(this.thicknessPalette.clientWidth)+"px";this.thicknessPaletteVisible=false},_createColorContent:function(){var k=this.drawSettings.getColor();var m=new UWA.Element("div",{"class":"play3d-annot-palette"});var l=new UWA.Element("div",{"class":"play3d-annot-colorDiv",}).inject(m);this._firstLaunchAfterCreation=true;setTimeout(function(){if(e){var p=new f({childCount:i.length,containerElement:l,layoutOpts:{containerHeight:l.clientHeight,containerWidth:l.clientWidth,offsetX:10,offsetY:0}});e.buttonsColor=[];var s,n;for(var q=0;q<i.length;++q){var o=new UWA.Element("button",{"class":"play3d-annot-colorButton",id:i[q],styles:{"background-color":i[q]}}).inject(p.contentArray[q]);var r=new UWA.Element("button",{"class":"play3d-annot-colorButton",id:i[q],styles:{"background-color":i[q]}});s=function(t){e._setColorSelectButton(this.id)};n=function(t){e._setColorSelectButton(this.id)};o.addEvent("click",s);o.addEvent("touchstart",n);r.addEvent("click",s);r.addEvent("touchstart",n);if(k===i[q]){o.addClassName("selected");r.addClassName("selected")}e.buttonsColor.push({btn:o,btnMAB:r,touch:n,mouse:s})}m.style.top=e.viewerFrame.offsetHeight/2-m.offsetHeight/2+"px";e.showColorPalette()}},0);if(this.MAB){if(this.MAB.state.visible){m.style.display="none"}this.MAB.onVisibilityChangeSubscribe("PlayWeb-colorPalette",function(n){if(n!=="hidden"){m.style.display="none"}else{m.style.display=""}})}return m},_setColorSelectButton:function(n){for(var l=0;l<this.buttonsColor.length;++l){var k=this.buttonsColor[l].btn;var m=this.buttonsColor[l].btnMAB;if(k.id&&k.id===n){k.addClassName("selected");m.addClassName("selected")}else{k.removeClassName("selected");m.removeClassName("selected")}}this.drawSettings.setColor(n);this._setThicknessSelectButton()},_createThicknessContent:function(){var n=this.drawSettings.getThickness();var m=this.drawSettings.getColor()||"#000000";var l=new UWA.Element("div",{"class":"play3d-annot-palette"});var k=new UWA.Element("div",{"class":"play3d-annot-thicknessDiv"}).inject(l);setTimeout(function(){if(e){var q=new f({childCount:c.length,containerElement:k,layoutOpts:{containerHeight:k.clientHeight,containerWidth:k.clientWidth,offsetX:10,offsetY:0}});e.buttonsThickness=[];var v,p;for(var s=0;s<c.length;++s){var u=new UWA.Element("button",{"class":"play3d-annot-thicknessButton",id:c[s]}).inject(q.contentArray[s]);var r=new UWA.Element("div",{styles:{width:c[s]+"px",height:c[s]+"px","border-radius":"50%",border:"1px solid #929292",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)","background-color":m}});r.inject(u);var t=new UWA.Element("button",{"class":"play3d-annot-thicknessButton",id:c[s]});var o=new UWA.Element("div",{styles:{width:c[s]+"px",height:c[s]+"px","border-radius":"50%",border:"1px solid #929292",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)","background-color":m}});o.inject(t);v=function(w){e._setThicknessSelectButton(this.id)};p=function(w){e._setThicknessSelectButton(this.id)};u.addEvent("click",v);u.addEvent("touchstart",p);t.addEvent("click",v);t.addEvent("touchstart",p);if(n===c[s]){u.addClassName("selected");t.addClassName("selected")}e.buttonsThickness.push({btn:u,btnMAB:t,touch:p,mouse:v})}l.style.top=e.viewerFrame.offsetHeight/2-l.offsetHeight/2+"px";l.style.right=-(l.clientWidth)+"px"}},0);if(this.MAB){if(this.MAB.state.visible){l.style.display="none"}this.MAB.onVisibilityChangeSubscribe("PlayWeb-thicknessPalette",function(o){if(o!=="hidden"){l.style.display="none"}else{l.style.display=""}})}return l},_setThicknessSelectButton:function(o){var k=this.drawSettings.getColor();for(var m=0;m<this.buttonsThickness.length;++m){var l=this.buttonsThickness[m].btn;var n=this.buttonsThickness[m].btnMAB;if(o){if(l.id&&l.id===o){l.addClassName("selected");n.addClassName("selected");this.drawSettings.setThickness(o)}else{l.removeClassName("selected");n.removeClassName("selected")}}else{if(l.getChildren().length){l.getChildren()[0].setStyle("background-color",k);n.getChildren()[0].setStyle("background-color",k)}}}}});return h});define("DS/3DPlayAnnotationUtils/AnnotationToolsMenu",["UWA/Class","DS/WebInfraUI/ContextualBarManager","DS/3DPlayAnnotationUtils/AnnotationTools","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/CoreEvents/Events"],function(b,e,c,d,a){var f;return(b.extend({init:function(g){this._newToolsUI=g.newToolsUI;this.contextualMenu=g.contextualMenu;this.frameWindow=g.frameWindow;var h=g.frameWindow.getActionBar();if(h&&h.MAB){this.MAB=h.MAB}this.exp=g.frameWindow.experience;if(this.exp&&this.exp.registerCollabAction){this.exp.registerCollabAction("annotAddTools",this._addTools.bind(this));this.exp.registerCollabAction("annotRemoveTools",this._removeTools.bind(this))}this.drawSettings=new d();f=this;this.viewerFrame=this.frameWindow.getViewerFrame();this._onResize=function(){f._removeTools()};this.viewerFrame.addEvent("resize",this._onResize)},dispose:function(){this.viewerFrame.removeEvent("resize",this._onResize);this._removeTools();this.removeToolsButton(true);this.contextualMenu=undefined;this.frameWindow=undefined;this.drawSettings=undefined;f=undefined},_buildToolsButton:function(h,i){var g=UWA.Element("div",{styles:{width:i+"px",height:i+"px","background-color":h,"border-radius":"50%",position:"absolute",top:"50%",left:"45%",transform:"translate(-50%, -50%)","z-index":"-1","box-shadow":"rgb(0, 0, 0, 0.28) 2px 2px 10px 0px inset"}});if(this._newToolsUI){g.style.border="1px solid #3d3d3d"}return g},showColorPalette:function(){f.contextualMenu.panel.removeBackground();f.colorTool.showColorPalette()},hideColorPalette:function(g){if(f.colorTool&&f.colorTool.getColorPaletteVisibility()){if(!(g===false)){f.uncheckColorPalette?f.uncheckColorPalette():{}}f.contextualMenu.panel.addDefaultBackground();f.colorTool.hideColorPalette()}},addToolsButton:function(){if(this._newToolsUI){this._addToolsButtonNewMenu()}else{this._addToolsButtonOldMenu()}},_addToolsButtonNewMenu:function(){this.colorTool=new c({container:this.frameWindow.getUIFrame(),frameWindow:this.frameWindow});var g={type:this.contextualMenu.Button.Check,id:"Color",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",onclickCB:function(h){f.uncheckColorPalette=h.uncheck;if(f.colorTool&&!f.colorTool.getColorPaletteVisibility()){f.showColorPalette()}else{f.hideColorPalette(false)}}};this.toolsButtonToken=this.contextualMenu.addButtons([g],{barType:this.contextualMenu.Toolbar.Append,showContextBarBackground:true});this._updateToolsButtons();this.hideColorPalette();this.tokenSettingsChanged=a.subscribe({event:"3DPlay.Annotation.SettingsChanged"},function(h){f._updateToolsButton(h);if(f.colorTool.getColorPaletteVisibility()){f.hideColorPalette()}})},_addToolsButtonOldMenu:function(){var g={type:this.contextualMenu.Button.Check,id:"PencilTools",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",onclickCB:function(h){if(h.state){f._addTools();if(f.exp&&f.exp.collabMode===true){f.exp.notifyAction&&f.exp.notifyAction("annotAddTools")}}else{f._removeTools();if(f.exp&&f.exp.collabMode===true){f.exp.notifyAction&&f.exp.notifyAction("annotRemoveTools")}}}};this.toolsButtonToken=this.contextualMenu.addButtons([g],{barType:this.contextualMenu.Toolbar.Append,showContextBarBackground:true});this._updateToolsButton();this.tokenSettingsChanged=a.subscribe({event:"3DPlay.Annotation.SettingsChanged"},function(h){f._updateToolsButton(h);f._updateToolsButtons(h)})},removeToolsButton:function(g){a.unsubscribe(this.tokenSettingsChanged);if(this.toolsButtonToken&&this.contextualMenu){this.contextualMenu.removeButtons(this.toolsButtonToken,g);this.toolsButtonToken=undefined}},removeTools:function(){this._removeTools()},_updateToolsButton:function(g){if(this._newToolsUI){this._updateToolsButtonNewMenu(g)}else{this._updateToolsButtonOldMenu(g)}},_updateToolsButtonNewMenu:function(h){var g=(h)?h.color:this.drawSettings.getColor();var i=this.drawSettings.getThickness();this.contextualMenu.updateButton({id:"Color",getButtonContent:function(){var j=f._buildToolsButton(g,28);return j}})},_updateToolsButtonOldMenu:function(h){var g=(h)?h.color:this.drawSettings.getColor();var i=(h)?h.thickness:this.drawSettings.getThickness();this.contextualMenu.updateButton({id:"PencilTools",getButtonContent:function(){return f._buildToolsButton(g,i)}})},_addTools:function(){this.pencilTools=new c({container:this.frameWindow.getUIFrame(),frameWindow:this.frameWindow});var g=[{type:this.contextualMenu.Button.Radio,content:[{id:"AnnotToolsColor",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",selected:true},{id:"AnnotToolsThick",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation"}],onclickCB:function(h){switch(h.id){case"AnnotToolsColor":f.pencilTools.hideThicknessPalette();f.pencilTools.showColorPalette();break;case"AnnotToolsThick":f.pencilTools.hideColorPalette();f.pencilTools.showThicknessPalette();break;default:}}},{type:this.contextualMenu.Button.Master,id:"AnnotToolsBack",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",onclickCB:function(){f._removeTools(!f.MAB||f.MAB.state.visible!==true);if(f.exp&&f.exp.collabMode===true){f.exp.notifyAction&&f.exp.notifyAction("annotRemoveTools")}}}];this.toolsToken=this.contextualMenu.addButtons(g,{barType:this.contextualMenu.Toolbar.New,showContextBarBackground:false,mab:{flyoutLevel:2,backCB:g[1].onclickCB}});this.pencilTools.showColorPalette();this._updateToolsButtons()},_updateToolsButtons:function(g){if(this._newToolsUI){return this._updateToolsButtonsNewMenu(g)}else{return this._updateToolsButtonsOldMenu(g)}},_updateToolsButtonsNewMenu:function(h){var g=(h)?h.color:this.drawSettings.getColor();var i=(h)?h.thickness:this.drawSettings.getThickness();this.contextualMenu.updateButton({id:"Color",getButtonContent:function(){var j=f._buildToolsButton(g,28);return j}})},_updateToolsButtonsOldMenu:function(h){var g=(h)?h.color:this.drawSettings.getColor();var i=(h)?h.thickness:this.drawSettings.getThickness();this.contextualMenu.updateButton({id:"AnnotToolsColor",getButtonContent:function(){var j=f._buildToolsButton(g,28);return j}});this.contextualMenu.updateButton({id:"AnnotToolsThick",getButtonContent:function(){var j=f._buildToolsButton(g,i);return j}})},_removeTools:function(g){if(this._newToolsUI){if(this.colorTool){this.hideColorPalette();this.colorTool.dispose?this.colorTool.dispose():{};this.colorTool=undefined}}if(this.pencilTools&&this.pencilTools.dispose){if(g){this.pencilTools.delayedDispose()}else{this.pencilTools.dispose()}this.pencilTools=undefined}if(this.contextualMenu&&this.toolsToken){this.contextualMenu.removeButtons(this.toolsToken);this.toolsToken=undefined;this.contextualMenu.setSelected({token:this.contextualMenuToken,id:"PencilTools",state:false});this._updateToolsButton()}}}))});