/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoFitCmd",["DS/ApplicationFrame/CommandCheckHeader"],function(b){var a=b.extend({init:function(c){this._parent(c,{});this.setState(true,true)}});return a});
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridEditCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(a,c){var b=a.extend({init:function(d){this._parent(d,{mode:"exclusive",isAsynchronous:true});this.setRepeatMode(false)},beginExecute:function(){c.get().setRobotVisibility(false)},endExecute:function(){c.get().setRobotVisibility(true)}});return b});
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridBoxHandle",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Manipulators/LineTranslationManipulator","DS/CoreEvents/ModelEvents","DS/Mesh/MeshUtils","DS/Web3DUXUtils/Web3DUXArrow","DS/Ruler/Ruler","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/AxisSystemNode","DS/Manipulators/PointHandle"],function(a,j,f,c,b,d,e,k,h,g,l){var i=a.extend({init:function(P){var P=P||{};var o=this;var C;var ab=[];var W,M,E,u;var V=true;var N=9689341;var A=6543615;var ak;var ap=P.window.getViewer();var ah=P.stepRequired;var Y=new Array(6);var D=new Array(6);var U=true;var aa=new f("BoxEditor_HandleBag");aa.setVisibility(false);aa.exludeFromBounding(true);var t=new f();var x=new Array(6);var ay=null;var n=null;var ax=new b();var ao=false;var al=false;var H=0;var L=new f("BoxEditor_Axis");L.exludeFromBounding(true);L.setPickable(d.NODRAWHL);L.setVisibility(false);var B=new g({headLength:10,arrowLength:50,arrowWidth:2,head:g.types.ARROW,colors:{colorX:new d.Color(1,0.5,0,0),colorY:new d.Color(1,0.5,0,0),colorZ:new d.Color(1,0.5,0,0)}});L.addChild(B);var K=new j.Vector3();var F=new j.Vector3();var w=new j.Vector3();var q=new j.Vector3();var y=new j.Vector3();var p=-1;var ag=new f();var aw=new f();aw.setVisibilityFree(true);aw.setVisibilityInTree(false);var X=new e({sceneGraph:aw,width:60,viewer:ap});X.setVisibility(false);X.setPickable(d.NODRAWHL);aw.addChild(ag);aw.addChild(X);aw.addChild(aa);aw.addChild(t);aw.addChild(L);ap.addNode(aw);var z=new k(P.window,{displayOrigin:true,startValue:0,offset:5});var v=0;var O=0;this.display=function(aB){ak=aB.matrix;aw.setMatrix(ak);aw.name="BoxGridEditor "+aB.rootID;var az=av(aB);C=az.selectedCorner;W=az.fstAxis;M=az.sndAxis;E=az.thdAxis;u=az.cornerPoint;U=aB.displayHandlePoints;Q();af(aB.gridDataPreference);for(var aA=0;aA<6;aA++){an(aA,N,A)}aa.setVisibility(true);if(!v){v=z.subscribe("RulerManipulate",r);O=z.subscribe("RulerManipulateEnd",S)}ap.render()};this.refresh=function(){ar();z.clear();ap.render()};this.setHandlePointsVisibility=function(az){U=az;ar();ap.render()};this.setDataPreference=function(aA){var az=av({gridDataPreference:aA});u=az.cornerPoint;C=az.selectedCorner;ab=[];W=az.fstAxis;M=az.sndAxis;E=az.thdAxis;af(o.getDataPreference())};this.getDataPreference=function(){var aA=new j.Vector3().subVectors(u,C);var aB=Math.round(aA.x)===0?W.x:aA.x;var az=Math.round(aA.y)===0?M.y:aA.y;var aC=Math.round(aA.z)===0?E.z:aA.z;return{origin:C,xAxis:aB,yAxis:az,zAxis:aC}};this.updateAutomaticCorner=function(){var aA=new j.Vector3().crossVectors(M,W);var az=new j.Vector3().crossVectors(W,E);var aB=new j.Vector3().crossVectors(E,M);var aC=u.clone();var aD=ap.currentViewpoint.getSightDirection();if(aD.dot(aA)<0&&aD.dot(az)>0&&aD.dot(aB)>0){aC.add(E)}else{if(aD.dot(aA)>0&&aD.dot(az)<0&&aD.dot(aB)>0){aC.add(M)}else{if(aD.dot(aA)>0&&aD.dot(az)>0&&aD.dot(aB)<0){aC.add(W)}else{if(aD.dot(aA)<0&&aD.dot(az)<0&&aD.dot(aB)>0){aC.add(M);aC.add(E)}else{if(aD.dot(aA)>0&&aD.dot(az)<0&&aD.dot(aB)<0){aC.add(M);aC.add(W)}else{if(aD.dot(aA)<0&&aD.dot(az)>0&&aD.dot(aB)<0){aC.add(E);aC.add(W)}else{if(aD.dot(aA)<0&&aD.dot(az)<0&&aD.dot(aB)<0){aC.add(W);aC.add(M);aC.add(E)}}}}}}}if(aC&&(C.x!==aC.x||C.y!==aC.y||C.z!==aC.z)){aq({selectedCorner:aC})}};this.clean=function(){for(var az=0;az<6;az++){if(x[az]){x[az].unlink(D[az])}if(Y[az]){Y[az].removeChildren()}}Y.splice(0,Y.length);D.splice(0,D.length);x.splice(0,x.length);if(t){t.removeChildren()}if(L){L.removeChildren()}if(ag){ag.removeChildren()}if(aa){aa.removeChildren()}aw.removeChildren();ap.removeNode(aw);X=null;ag=null;p=-1;t=null;L=null;if(v){z.unsubscribe(v);v=0}if(O){z.unsubscribe(O);O=0}z.clear();z=null;ax=null;K=null;F=null;w=null;q=null;y=null;aa=null;ap.render()};this.getBag=function(){return t};this.isSizeOK=function(){return V};this.subscribe=function(az,aA){return ax.subscribe({event:az},aA)};this.unsubscribe=function(az){ax.unsubscribe(az)};var r=function(az){ao=true;au(az.translationVector)};var S=function(){at()};var R=function(aB){var aA=new l({viewer:ap,sceneGraph:aB.parent});aA.name=aB.name;aA.setMatrix(new j.Matrix4().setPosition(aB.position));var az=d.PICKABLE;aA.setPickable(az);aA.setVisibility(true);aA.setSize(20);aA.subscribe("EndManipulate",function(aE){var aC=aE.paths[0].externalPath[2];var aD=new j.Vector3().getPositionFromMatrix(aC.getMatrix());if(C!==aD){aq({selectedCorner:aD});aj("BoxCornerChanged",{cornerChanged:true})}else{aj("BoxCornerChanged",{cornerChanged:false})}});return aA};var Q=function(){var aF=function(aI){var aJ=new j.Vector3();aJ.x=aI.x.toFixed(4);aJ.y=aI.y.toFixed(4);aJ.z=aI.z.toFixed(4);return aJ};var aH=new j.Matrix4();var aD=new j.Color("#FFFFFF");var az=new j.Color("#FF8000");var aE=["mO","mOX","mOY","mOZ","mOXY","mOYZ","mOXZ","mOXYZ"];var aC=[u.clone(),u.clone().add(W),u.clone().add(M),u.clone().add(E),u.clone().add(W).add(M),u.clone().add(M).add(E),u.clone().add(W).add(E),u.clone().add(W).add(M).add(E)];var aB;for(var aG=0;aG<aE.length;aG++){aB=aa.getChildByName(aE[aG]);if(!aB){aH=aH.setPosition(aC[aG]);aB=R({name:aE[aG],position:aC[aG],parent:aa})}else{aB.setMatrix(aH.setPosition(aC[aG]))}var aA=aF(aC[aG]).equals(aF(C));aB.setFillColor(aA?az:aD);aB.setVisibility(U||aA)}};var av=function(aE){var aC=new j.Vector3().copy(aE.gridDataPreference.origin);var aD=new j.Vector3().copy(aE.gridDataPreference.origin);var aA=new j.Vector3(aE.gridDataPreference.xAxis,0,0);var aB=new j.Vector3(0,aE.gridDataPreference.yAxis,0);var az=new j.Vector3(0,0,aE.gridDataPreference.zAxis);if(aC.x+aE.gridDataPreference.xAxis<aC.x){aD.x=aC.x+aA.x;aA.x*=-1}if(aC.y+aE.gridDataPreference.yAxis<aC.y){aD.y=aC.y+aB.y;aB.y*=-1}if(aC.z+aE.gridDataPreference.zAxis<aC.z){aD.z=aC.z+az.z;az.z*=-1}return{selectedCorner:aC,cornerPoint:aD,fstAxis:aA,sndAxis:aB,thdAxis:az}};var af=function(aC){var az=function(aE){aE=+aE;if(aE===0||isNaN(aE)){return aE}return aE>0?1:-1};L.setMatrix(new j.Matrix4().setPosition(aC.origin));L.setVisibility(true);var aD=new j.Matrix4().rotateX(az(aC.yAxis)*3*Math.PI/2);L.children[0].children[0].setMatrix(aD);var aA=new j.Matrix4().rotateY(az(aC.xAxis)*Math.PI/2);L.children[0].children[1].setMatrix(aA);var aB=new j.Matrix4();if(aC.zAxis<0){aB.rotateX(Math.PI)}L.children[0].children[2].setMatrix(aB);return};var G=function(aB,aA){var aD=new j.Vector3().copy(aB);var aC=new j.Vector3().copy(aA);var az=aD.cross(aC).length();if(Math.round(az*100)===0){return true}return false};var aq=function(az){ab=[];C=az.selectedCorner;ar();af(o.getDataPreference())};var T=function(){var aC=function(aI,aH){var aF=aI;var aJ=aI%aH;var aG=null;if(aJ>0){aG=aF-aJ}else{if(aJ<0){aG=aF-(aH+aJ)}else{aG=aF}}return aG};V=true;N=9689341;A=6543615;var aE=new j.Vector3().copy(u);if(aE.x%ah!==0&&aE.x%ah!==0&&aE.x%ah!==0){var aA=new j.Vector3().copy(aE).add(W).add(M).add(E);var aD=aC(aA.x,ah);var aB=aC(aA.y,ah);var az=aC(aA.z,ah);if(aD<aE.x&&aB<aE.y&&az<aE.z){V=false;N=16711765;A=14876748}}};var an=function(aA,aF,az){if(Y[aA]){Y[aA].removeChildren()}var aE=null,aB=null,aG=null,aH=null;switch(aA){case 0:aE=u;aB=M;aG=W;if(ab.length!==3){aH=new j.Vector3().subVectors(C,aE);if(Math.round(new j.Vector3().crossVectors(aB,aG).normalize().dot(aH))===0){ab.push(aA)}}break;case 1:aE=u;aB=E;aG=M;if(ab.length!==3){aH=new j.Vector3().subVectors(C,aE);if(Math.round(new j.Vector3().crossVectors(aB,aG).normalize().dot(aH))===0){ab.push(aA)}}break;case 2:aE=u;aB=W;aG=E;if(ab.length!==3){aH=new j.Vector3().subVectors(C,aE);if(Math.round(new j.Vector3().crossVectors(aB,aG).normalize().dot(aH))===0){ab.push(aA)}}break;case 3:aE=new j.Vector3().copy(u).add(W);aB=M;aG=E;if(ab.length!==3){aH=new j.Vector3().subVectors(C,aE);if(Math.round(new j.Vector3().crossVectors(aB,aG).normalize().dot(aH))===0){ab.push(aA)}}break;case 4:aE=new j.Vector3().copy(u).add(M);aB=E;aG=W;if(ab.length!==3){aH=new j.Vector3().subVectors(C,aE);if(Math.round(new j.Vector3().crossVectors(aB,aG).normalize().dot(aH))===0){ab.push(aA)}}break;case 5:aE=new j.Vector3().copy(u).add(E);aB=W;aG=M;if(ab.length!==3){aH=new j.Vector3().subVectors(C,aE);if(Math.round(new j.Vector3().crossVectors(aB,aG).normalize().dot(aH))===0){ab.push(aA)}}}var aC=m(aE,aB,aG,aF,az,aA);var aD=h.createMeshNode(aC);aD.excludeFromCSO(true);aD.excludeFromHighlight(true);aD.setSSAO(false);aD.setShadow(false,false);if(!Y[aA]){Y[aA]=new f("Face"+aA);t.add(Y[aA])}Y[aA].add(aD);if(x[aA]){x[aA].unlink(D[aA])}x[aA]=ae(aA,new j.Vector3().copy(aB).cross(aG).normalize());D[aA]=x[aA].linkToNode(Y[aA]);ay=ae(-1,new j.Vector3())};var m=function(aO,aA,aE,aP,az){var aC,aH,aI,aJ,aB,aG,aF,aL,aK,aM,aN;aC=new d.PrimitiveGroup();aC.fillAttr=new d.FillAttributes();aC.lineAttr=new d.LineAttributes();aC.pointAttr=new d.PointAttributes();aH=new d.Buffer();aH.size=12;aH.component=d.VertexComponentEnum.POSITION;aH.format=d.DataTypeEnum.FLOAT;aH.dimension=3;aH.data=new Float32Array(12);aJ=new d.Buffer();aJ.indexBuffer=true;aJ.size=9;aJ.format=d.DataTypeEnum.UINT;aJ.dimension=1;aJ.data=new Uint16Array(9);aI=new d.Buffer();aI.size=3;aI.component=d.VertexComponentEnum.NORMAL;aI.format=d.DataTypeEnum.FLOAT;aI.dimension=3;aI.data=new Float32Array(3);aB=new d.Buffer();aB.indexBuffer=true;aB.size=4;aB.format=d.DataTypeEnum.UINT;aB.dimension=1;aB.data=new Uint16Array(4);aC.addBuffer(0,aH);aC.addBuffer(1,aJ);aC.addBuffer(2,aI);aC.addBuffer(3,aB);aG=aH.data;aF=0;aG[aF++]=aO.x;aG[aF++]=aO.y;aG[aF++]=aO.z;aN=new j.Vector3().copy(aO).add(aA);aG[aF++]=aN.x;aG[aF++]=aN.y;aG[aF++]=aN.z;aN=new j.Vector3().copy(aO).add(aA).add(aE);aG[aF++]=aN.x;aG[aF++]=aN.y;aG[aF++]=aN.z;aN=new j.Vector3().copy(aO).add(aE);aG[aF++]=aN.x;aG[aF++]=aN.y;aG[aF++]=aN.z;aG=aJ.data;aG[0]=0;aG[1]=1;aG[2]=3;aG[3]=2;aG=aI.data;aG[0]=0;aG[1]=0;aG[2]=1;aG=aB.data;aG[0]=0;aG[1]=0;aG[2]=0;aG[3]=0;aL=new d.Primitive();aL.nbIndices=4;aL.connectivity=d.ConnectivityTypeEnum.TRIANGLE_STRIP;aL.material=new j.MeshBasicMaterial({side:j.DoubleSide,color:aP,opacity:0.5,transparent:true});aK=new d.VertexComponent();aK.component=d.VertexComponentEnum.POSITION;aK.nbVertices=4;aK.nbValuesPerVertex=3;aK.format=d.DataTypeEnum.FLOAT;aK.cardinality=0;aK.bufferId=0;aK.indices=new d.IndexArray();aK.indices.format=d.DataTypeEnum.UINT;aK.indices.bufferId=1;aK.indices.offset=0;aL.addVertexComponent(aK);aM=new d.VertexComponent();aM.component=d.VertexComponentEnum.NORMAL;aM.nbVertices=4;aM.nbValuesPerVertex=3;aM.format=d.DataTypeEnum.FLOAT;aM.cardinality=0;aM.bufferId=2;aM.indices=new d.IndexArray();aM.indices.format=d.DataTypeEnum.UINT;aM.indices.bufferId=3;aM.indices.offset=0;aL.addVertexComponent(aM);aC.addPrimitive(aL);aG=aJ.data;aF=4;aG[aF++]=0;aG[aF++]=1;aG[aF++]=2;aG[aF++]=3;aG[aF++]=0;var aD=new d.Primitive();aD.nbIndices=4;aD.connectivity=d.ConnectivityTypeEnum.LINE_STRIP;aD.attr={fill:new d.FillAttributes(),line:new d.LineAttributes(new d.Color(az)),point:new d.PointAttributes()};aK=new d.VertexComponent();aK.component=d.VertexComponentEnum.POSITION;aK.nbVertices=5;aK.nbValuesPerVertex=3;aK.format=d.DataTypeEnum.FLOAT;aK.cardinality=0;aK.bufferId=0;aK.indices=new d.IndexArray();aK.indices.format=d.DataTypeEnum.UINT;aK.indices.bufferId=1;aK.indices.offset=4;aD.addVertexComponent(aK);aC.addPrimitive(aD);aC.noz=false;return aC};var ae=function(aB,az){var aA=new c({axis:new j.Vector3().copy(az)});aA.setExclusive(true);if(aB>=0){aA.subscribe("BeginManipulate",function(){Z(aB)});aA.subscribe("Manipulate",function(aC){am(aC)});aA.subscribe("EndManipulate",function(aC){J(aC)});aA.subscribe("BeginPreactivate",function(aC){ai(aB,aC)});aA.subscribe("EndPreactivate",function(){s()})}return aA};var ad=function(aB){var az=null,aA=null;switch(aB){case 0:az=new j.Vector3().copy(M);aA=new j.Vector3().copy(W);break;case 1:az=new j.Vector3().copy(E);aA=new j.Vector3().copy(M);break;case 2:az=new j.Vector3().copy(W);aA=new j.Vector3().copy(E);break;case 3:az=new j.Vector3().copy(M);aA=new j.Vector3().copy(E);break;case 4:az=new j.Vector3().copy(E);aA=new j.Vector3().copy(W);break;case 5:az=new j.Vector3().copy(W);aA=new j.Vector3().copy(M)}return new j.Vector3().copy(aA).cross(az).normalize()};var ac=function(aI,aA){var aH=null,aB=null,aJ=null;switch(aI){case 0:aH=new j.Vector3().copy(u);aB=new j.Vector3().copy(M);aJ=new j.Vector3().copy(W);break;case 1:aH=new j.Vector3().copy(u);aB=new j.Vector3().copy(E);aJ=new j.Vector3().copy(M);break;case 2:aH=new j.Vector3().copy(u);aB=new j.Vector3().copy(W);aJ=new j.Vector3().copy(E);break;case 3:aH=new j.Vector3().copy(u).add(W);aB=new j.Vector3().copy(M);aJ=new j.Vector3().copy(E);break;case 4:aH=new j.Vector3().copy(u).add(M);aB=new j.Vector3().copy(E);aJ=new j.Vector3().copy(W);break;case 5:aH=new j.Vector3().copy(u).add(E);aB=new j.Vector3().copy(W);aJ=new j.Vector3().copy(M)}var aG=aB.length();if(aJ.length()>aG){aG=aJ.length()}var aE=new j.Vector3().copy(aB).setLength((aB.length())/2);var aC=new j.Vector3().copy(aJ).setLength(aJ.length()/2);aH.add(aE).add(aC);var aD=new j.Vector3().copy(aJ).cross(aB).normalize();var aF=new j.Matrix4();aB.normalize();aJ.normalize();var az=aF.elements;if(aA){aD.applyAxisAngle(aB,Math.PI)}az[0]=aB.x;az[1]=aB.y;az[2]=aB.z;az[4]=aJ.x;az[5]=aJ.y;az[6]=aJ.z;az[8]=aD.x;az[9]=aD.y;az[10]=aD.z;aF.setPosition(aH);X.setMatrix(aF);al=aA};var Z=function(aE){H=aE;n=new j.Vector3(0,0,0);ac(H);X.setVisibility(true);ag.removeChildren();ao=true;z.clear();var aB=ad(H);var aD=null;if(G(aB,W)){aD=W}else{if(G(aB,M)){aD=M}else{if(G(aB,E)){aD=E}}}var aA=null,az=null;switch(H){case 0:aA=new j.Vector3().copy(u);az=W;break;case 1:aA=new j.Vector3().copy(u);az=M;break;case 2:aA=new j.Vector3().copy(u).sub(E);az=E;break;case 3:aA=new j.Vector3().copy(u).add(W).sub(E);az=E;break;case 4:aA=new j.Vector3().copy(u).add(M);az=W;break;case 5:aA=new j.Vector3().copy(u).add(E);az=M}var aC=new j.Vector3().copy(aB).setLength(aD.length()).add(new j.Vector3().copy(az).setLength(az.length()));z.origin=new j.Vector3().copy(aA).add(aC).add(new j.Vector3().getPositionFromMatrix(ak));z.initValue=aD.length();z.value=z.initValue;z.direction=aB.multiplyScalar(-1);z.setVisibleFlag(true);z.display();z.beginManipulation();ap.render()};var au=function(aD){n.add(aD);if(0===H){var aC=new j.Vector3().copy(E).sub(aD);E.copy(aC)}else{if(1===H){var aC=new j.Vector3().copy(W).sub(aD);W.copy(aC)}else{if(2===H){var aC=new j.Vector3().copy(M).sub(aD);M.copy(aC)}else{if(3===H){var aC=new j.Vector3().copy(W).add(aD);W.copy(aC)}else{if(4===H){var aC=new j.Vector3().copy(M).add(aD);M.copy(aC)}else{if(5===H){var aC=new j.Vector3().copy(E).add(aD);E.copy(aC)}}}}}}if(0===H||1===H||2===H){u.add(aD)}if(ab.indexOf(H)>-1){C.add(aD)}var aB=Y[H].children[0];var aA=aB.getMatrix();aA.setPosition(new j.Vector3().getPositionFromMatrix(aA).add(aD));aB.setMatrix(aA);I(H);var az=aD.dot(ad(H));if(az>0&&!al){ac(H,true)}else{if(az<0&&al){ac(H,false)}}var aE=new j.Vector3().getPositionFromMatrix(X.getMatrix()).add(aD);X.setMatrix(new j.Matrix4().copy(X.getMatrix()).setPosition(aE));aa.setVisibility(false);L.setVisibility(false)};var am=function(aC){var aB=z.getSnappedTranslationVector(aC);if(aB.returnCode!==0){return null}var aA=new j.Vector3().copy(aB.snappedTranslationVector).sub(n);var az=z.value+aA.length()*(aA.dot(ad(H))<0?1:-1);if(az<=0){az=0;aA.setLength(z.value)}z.setValue(az);au(aA)};var at=function(){if(X){X.setVisibility(false)}ao=false;Q();aa.setVisibility(true);af(o.getDataPreference());aj("EndBoxChanged")};var J=function(){at();z.endManipulation();z.display()};var ai=function(aG){if(ao){return true}var aE=null,az=null,aD=null;switch(aG){case 0:aE=u;az=M;aD=W;break;case 1:aE=u;az=E;aD=M;break;case 2:aE=u;az=W;aD=E;break;case 3:aE=new j.Vector3().copy(u).add(W);az=M;aD=E;break;case 4:aE=new j.Vector3().copy(u).add(M);az=E;aD=W;break;case 5:aE=new j.Vector3().copy(u).add(E);az=W;aD=M}var aB=new j.Vector3().copy(az);aB.cross(aD);aB.normalize();aB.setLength(0.05);var aA=new j.Vector3().copy(aE).sub(aB);var aC=m(aA,az,aD,9689341,6543615,aG);var aF=h.createMeshNode(aC);aF.excludeFromCSO(true);aF.excludeFromHighlight(true);aF.setSSAO(false);aF.setShadow(false,false);ag.removeChildren();ag.add(aF);p=aG;ac(aG);X.setVisibility(true);ap.render()};var s=function(){if(ao){return}X.setVisibility(false);ag.removeChildren();p=-1;ap.render()};var I=function(az){T();for(var aA=0;aA<6;aA++){if(aA!==az){an(aA,N,A)}}};var aj=function(az){return ax.publish({event:az,context:this,data:o.getDataPreference()})};var ar=function(){ag.removeChildren();ao=false;for(var az=0;az<6;az++){if(x[az]){x[az].unlink(D[az])}x[az]=null;if(Y[az]){Y[az].removeChildren()}Y[az]=null}if(t){t.removeChildren();aw.remove(t)}Y=new Array(6);t=new f();aw.addChild(t);x=new Array(6);Q();T();for(var az=0;az<6;az++){an(az,N,A)}ap.render()}}});return i});
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoOriginCmd",["DS/ApplicationFrame/CommandCheckHeader"],function(b){var a=b.extend({init:function(c){this._parent(c,{});this.setState(true,true)}});return a});define("DS/CATRelatedData3DGrid/CATRelatedData3DGrid",[],function(){});
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridView",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/CanvasNodeTexture","DS/Mesh/MeshUtils","DS/Core/Events","DS/VisuEvents/EventsManager","DS/ApplicationFrame/CommandsManager","DS/Manipulators/HandlePointManipulator","DS/CATRelatedData3DGrid/CATRelatedData3DGridEditCmd","DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoFitCmd","DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoOriginCmd","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/PathElement","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,p,q,i,d,r,f,l,o,a,b,c,g,k,m,n,h){var j=p.extend({init:function(a0){if(!a0){return}var a4=a0.viewer;var bC=a0.window;var v=a0.context;var az=false;var aZ=null;var Y=null;var Z=this;var U=[];var t=JSON.parse(localStorage.getItem("CATRelatedData3DGridDftOrigin"));if(!t){t={x:"min",y:"min",z:"min"}}var aF={xStep:a0.stepRequiredX,yStep:a0.stepRequiredY,zStep:a0.stepRequiredZ};var P=new q.Matrix4();if(a0.gridMatrix){P=a0.gridMatrix.clone()}var Q=a0.id;var ai=(a0.isEditable!==undefined)?a0.isEditable:true;var ac=(a0.isLabelManipulable!==undefined)?a0.isLabelManipulable:true;var aW=(a0.owner!==undefined)?a0.owner:undefined;var av=(a0.isAbsoluteMode!==undefined)?a0.isAbsoluteMode:false;var bl=a0.nbMaxLabel;var N={x:"L",y:"W",z:"H"};var ao=Math.round(10*window.devicePixelRatio/2)*2;var af=window.widget;var aM=null;if(af){aM=af.getValue("3DGridData")}if(!aM){if(af){af.addPreference({name:"3DGridData",type:"hidden"})}aM={gridList:[]}}else{aM=JSON.parse(aM)}var aA=null;var bz=false;var aP=new q.Vector3();var bi=null;var x=null;var bF=null;var be=null;var aJ=null;var bk=null;var S=false;var w=true;var V=null;var W=null;var aL=bC.getContextualUIManager();var a3=null;var R={};var aO={};var ak=null;var a8=null;var aa=null;var bd=null;var br=null;var C=null;var D=null;var ae=null;var a6=null;var aE=null;var aG=[];var O=[];var ay=false;var L=[];var K=[];var bg="#FF8000";var ah=null;var aI;var bj;var a1=0;var F;var I=false;var aS={width:a0.freeZoneDim?a0.freeZoneDim.width:0,height:a0.freeZoneDim?a0.freeZoneDim.height:0,left:a0.freeZoneDim?a0.freeZoneDim.left:0,right:a0.freeZoneDim?(a0.freeZoneDim.width-a0.freeZoneDim.right):0,top:a0.freeZoneDim?a0.freeZoneDim.top:0,bottom:a0.freeZoneDim?(a0.freeZoneDim.height-a0.freeZoneDim.bottom):0};var aT=1,aU=Math.pow(10,2);function bo(){if(af&&af.hasPreference("Length")){var bH=af.getValue("Length");if(bH){switch(bH){case"mm":aT=1;break;case"cm":aT=Math.pow(10,-1);break;case"m":aT=Math.pow(10,-3);break;case"km":aT=Math.pow(10,-6);break;case"inch":aT=1/25.4;break;case"foot":aT=1/304.8;break;default:aT=1;break}}}}function aX(bJ){var bH;if(bJ){var bI=bJ.getOrientedBoundingBox?bJ.getOrientedBoundingBox(new q.Matrix4(),a4):bJ.getBoundingBox(null,a4,a4.getVisibleSpace()?"visibleSpace":"invisibleSpace");bH=bI&&!bI.isNaN()?bI:undefined}return bH}var ap=function(bK,bJ){var bH=bK;var bL=bK%bJ;var bI=null;if(bL>0){bI=bH-bL}else{if(bL<0){bI=bH-(bJ+bL)}else{bI=bH}}return bI};var au=function(bK,bJ){var bH=bK;var bL=bK%bJ;var bI=null;if(bL>0){bI=bH+(bJ-bL)}else{if(bL<0){bI=bH-bL}else{bI=bH}}return bI};var aN=function(bH){bH=parseFloat(bH);if(bH===0||isNaN(bH)){return bH}return bH>0?1:-1};var a2=function(bH){if(bH.x<0||bH.y<0||bH.z<0){return -1}return 1};var bq=function(){if(ah){a4.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(ah);ah=null}};var aD=function(bH){if(bH){if(ah){bq()}ah=new m(bH.externalPath[0]);a4.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(ah)}};var bE=function(bI,bH){if(!ah||!bI||!bH){return}if(bH.type==="color"){ah.createOverride(bI).setColor(bH.value)}else{if(bH.type==="pickability"){ah.createOverride(bI).setPickability(bH.value)}}};var H=function(bH,bL,bJ){var bI=bH.getContext("2d");bI.font=ao+"pt sans-serif";bI.fillStyle=bJ;bI.fillText(bL,0,bH.height);for(var bK=aZ.childNodes.length-1;bK>=0;bK--){if(aZ.childNodes[bK].label.name===bL){bI=aZ.childNodes[bK].getContext("2d");bI.font=ao+"pt sans-serif";bI.fillStyle=bJ;bI.fillText(bL,0,aZ.childNodes[bK].height)}}};var E=function(bK){var bI=new n();var bH=[];var bJ=bK;while(bJ&&!bJ.notAllowedInPathElement){bH.splice(0,0,bJ);bJ=bJ.parents[0]}bI.setFromArray(bH);return bI};var bn=function(bN){var bL;var bK;if(bN.preactivated){bK=bN.preactivated.path.externalPath.length}aJ=bN.preactivated?bN.preactivated.path.externalPath[bK-2]:bN.currentTarget.label;bk=bN.currentTarget;if(aJ){var bH=aJ.canvasNodeTexture;bH.isHighlighted=true;bH.requestRedraw();if(bk){H(bk,aJ.name,bg)}var bJ=bN.preactivated?bN.preactivated.path:null;if(!bJ){if(aW){for(bL=0;bL<U.length;bL++){if(U[bL].grid.name===bN.currentTarget.label.gridID){bJ=E(aW);bJ.addElement(U[bL].grid)}}}else{for(bL=0;bL<U.length;bL++){if(U[bL].grid.name===bN.currentTarget.label.gridID){bJ=new n();bJ.addElement(U[bL].grid)}}}}else{while(bJ){if(bJ.getLastElement(true).name.indexOf("3D Grid")!==-1){break}bJ=bJ.getParentPath()}}aD(bJ);var bI=bJ.getChildrenPathes();for(bL=0;bL<bI.length;bL++){var bO=bI[bL].getChildrenPathes()[0].getChildrenPathes();for(var bM=0;bM<bO.length;bM++){if(bO[bM].getLastElement(true).relatedLabel===bH.txtValue){bE(bO[bM],{type:"color",value:bg});if(!bz){bO[bM].getLastElement(true).setNoZ(true)}L.push(bO[bM].getLastElement(true))}}}a4.render()}};var bD=function(){if(aJ){var bH=aJ.canvasNodeTexture;bH.isHighlighted=false;bH.requestRedraw();if(bk){H(bk,aJ.name,W)}aJ=null;bq();if(!bz){for(var bI=0;bI<L.length;bI++){L[bI].setNoZ(false)}}L.splice(0,L.length);a4.render()}};var an=function(bH,bN,bJ,bT,bL){var bP=new f.PrimitiveGroup();bP.noz=false;bP.fillAttr=new f.FillAttributes();bP.lineAttr=new f.LineAttributes();bP.pointAttr=new f.PointAttributes();var bO=new f.Buffer();bO.size=12;bO.component=f.VertexComponentEnum.POSITION;bO.format=f.DataTypeEnum.FLOAT;bO.dimension=3;bO.data=new Float32Array(12);var bY=new f.Buffer();bY.indexBuffer=true;bY.size=4;bY.format=f.DataTypeEnum.UINT;bY.dimension=1;bY.data=new Uint16Array(4);bY.data[0]=0;bY.data[1]=1;bY.data[2]=3;bY.data[3]=2;var bU=new f.Buffer();bU.size=3;bU.component=f.VertexComponentEnum.NORMAL;bU.format=f.DataTypeEnum.FLOAT;bU.dimension=3;bU.data=new Float32Array(3);bU.data[0]=0;bU.data[1]=0;bU.data[2]=1;var bX=new f.Buffer();bX.indexBuffer=true;bX.size=4;bX.format=f.DataTypeEnum.UINT;bX.dimension=1;bX.data=new Uint16Array(4);bX.data[0]=0;bX.data[1]=0;bX.data[2]=0;bX.data[3]=0;bP.addBuffer(0,bO);bP.addBuffer(1,bY);bP.addBuffer(2,bU);bP.addBuffer(3,bX);var bV=bO.data;var bR=0;bV[bR++]=bH.x;bV[bR++]=bH.y;bV[bR++]=bH.z;var bQ=new q.Vector3().copy(bH).add(bN);bV[bR++]=bQ.x;bV[bR++]=bQ.y;bV[bR++]=bQ.z;bQ=new q.Vector3().copy(bH).add(bN).add(bJ);bV[bR++]=bQ.x;bV[bR++]=bQ.y;bV[bR++]=bQ.z;bQ=new q.Vector3().copy(bH).add(bJ);bV[bR++]=bQ.x;bV[bR++]=bQ.y;bV[bR++]=bQ.z;var bM=new f.Primitive();bM.nbIndices=4;bM.connectivity=f.ConnectivityTypeEnum.TRIANGLE_STRIP;var bK=new q.MeshBasicMaterial({side:q.DoubleSide,color:bT,opacity:bL,transparent:true});bM.material=bK;var bW=new f.VertexComponent();bW.component=f.VertexComponentEnum.POSITION;bW.nbVertices=4;bW.nbValuesPerVertex=3;bW.format=f.DataTypeEnum.FLOAT;bW.cardinality=0;bW.bufferId=0;bW.indices=new f.IndexArray();bW.indices.format=f.DataTypeEnum.UINT;bW.indices.bufferId=1;bW.indices.offset=0;var bS=new f.VertexComponent();bS.component=f.VertexComponentEnum.NORMAL;bS.nbVertices=4;bS.nbValuesPerVertex=3;bS.format=f.DataTypeEnum.FLOAT;bS.cardinality=0;bS.bufferId=2;bS.indices=new f.IndexArray();bS.indices.format=f.DataTypeEnum.UINT;bS.indices.bufferId=3;bS.indices.offset=0;bM.addVertexComponent(bW);bM.addVertexComponent(bS);bP.addPrimitive(bM);var bI=d.createMeshNode(bP);bI.setSSAO(false);bI.setShadow(false,false);bI.excludeFromCSO(true);bI.excludeFromHighlight(true,true);bI.setMatrix(P);return bI};var ba=function(bJ){if(a1<2){a1++}if(a1===2&&!aI){a1=4;a4.currentViewpoint.getControl()._changeState(3);aI={};aI.eyePosition=a4.currentViewpoint.getEyePosition();aI.upDirection=a4.currentViewpoint.getUpDirection();aI.sightDirection=a4.currentViewpoint.getSightDirection();aI.distanceToTarget=a4.currentViewpoint.getTargetDistance();bn(F?{currentTarget:F}:{preactivated:{path:bJ.paths[0]}});if(L.length===2){var bO=new q.Vector3().copy(L[0].explicitBBox.min);var bM=new q.Vector3().copy(L[0].explicitBBox.max);bO.applyMatrix4(L[0].getMatrix());bM.applyMatrix4(L[0].getMatrix());var bL=new q.Vector3().copy(L[1].explicitBBox.min);var bK=new q.Vector3().copy(L[1].explicitBBox.max);bL.applyMatrix4(L[1].getMatrix());bK.applyMatrix4(L[1].getMatrix());var bP;if(F){for(var bQ=0;bQ<U.length;bQ++){if(U[bQ].grid.name===F.label.gridID){bP=U[bQ].grid.getMatrix();break}}}else{bP=bJ.paths[0].externalPath[0].getMatrix()}bO.applyMatrix4(bP);bM.applyMatrix4(bP);bL.applyMatrix4(bP);bK.applyMatrix4(bP);var bN=bO;var bH=new q.Vector3();var bI=new q.Vector3();if(!(bN.x===bL.x&&bN.y===bL.y&&bN.z===bL.z)&&!(bN.x===bK.x&&bN.y===bK.y&&bN.z===bK.z)){bN=bM;bH=new q.Vector3().subVectors(bO,bN)}else{bH=new q.Vector3().subVectors(bM,bO)}if(bN.x===bL.x&&bN.y===bL.y&&bN.z===bL.z){bI.subVectors(bK,bN)}else{bI.subVectors(bL,bN)}if(bj){a4.removeNode(bj);bj=null}bj=an(bN,bH,bI,16744448,0.5);bj.name="Box_PreviewPlane";a4.addNode(bj)}}};var bc=function(bH){I=true;setTimeout(function(){if(I){a1=2;ba(bH)}},100)};var aw=function(){I=false;if(F){F=null}if(aI){a4.currentViewpoint.getControl()._changeState(-1);a4.currentViewpoint.moveTo({eyePosition:aI.eyePosition,upDirection:aI.upDirection,sightDirection:aI.sightDirection,distanceToTarget:aI.distanceToTarget,duration:100});aI=null}if(bj){a4.removeNode(bj);bj=null;bD()}a1=0};var aV=function(bL){a1=0;I=false;var bI=bL.type?bL.type:bL.event.from[0].type;if(bI.indexOf==="touch"!==-1){if(bd){clearTimeout(bd);bD();bd=null}bd=setTimeout(function(){bD();bd=null},1000);bn(F?{currentTarget:F}:{preactivated:{path:bL.intersection.path[0]}})}var bH=F?F.label.gridID:(bL.intersection?bL.intersection.path[0].externalPath[0].name:bL.gesture.currentEvent[0].view.label.gridID);for(var bJ=0;bJ<U.length;bJ++){if(U[bJ].grid.name===bH){bi=U[bJ];break}}if(br){br.setState(bi.type!=="userDefined")}if(ak){ak=a.getCommand("CATRelatedData3DGridEditHdr",v.getCommandContext())}var bK=[{name:"CATRelatedData3DGridEdit",line:1,hdr_list:["CATRelatedData3DGridEditHdr"]},{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"]}];aL.showContextualBar({hideWithDistance:true,fillingList:[{onContextualBarReady:function(){return{cmdList:bK}},context:v.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]});if(F){F=null}};var am=function(bI){bI.stopPropagation();bI.preventDefault();var bH;if(bI.type.indexOf("touch")!==-1){if(typeof window.UIEvent==="function"){bH=new window.UIEvent(bI.type)}else{bH=document.createEvent("UIEvent");bH.initUIEvent(bI.type,true,true,window,1)}bH.touches=bI.touches;bH.changedTouches=bI.changedTouches}else{if(typeof window.MouseEvent==="function"){bH=new MouseEvent(bI.type,{bubbles:true,cancelable:true,view:window,clientX:bI.clientX,clientY:bI.clientY,screenX:bI.clientX,screenY:bI.clientY,button:0})}else{bH=document.createEvent("MouseEvent");bH.initMouseEvent(bI.type,true,true,window,1,0,0,bI.clientX,bI.clientY,false,false,false,false,0,null)}}bH._simul=o._ODTMode===true?true:undefined;a4.canvas.dispatchEvent(bH)};var bw=function(bH){I=true;F=bH.currentTarget;a1=0;setTimeout(function(){if(I&&F){a1=2;if(bH.type==="Touch"){am(bH)}ba()}},100)};var aK=function(bH){bH.stopPropagation();bH.preventDefault();if(F){am(bH)}};var bf=function(bH){if(F&&!a1){aV(bH)}else{aw()}};var al=function(bH){var bJ=document.createElement("canvas");var bI=bJ.getContext("2d");bJ.width=bH.width;bJ.height=bH.height;bI.drawImage(bH,0,0);return bJ};var aj=function(bP,b3){var bL;bP.setVisibility(true);var bS=new q.Matrix4().multiplyMatrices(b3,bP.getMatrix());var bI=new q.Vector3().getPositionFromMatrix(bS);var bM=a4.currentViewpoint.project(bI);var bR=bM.clone();var b2=aS.width-aS.right;var b0=aS.height-aS.bottom;var b4=aS.left;var b1=aS.top;var bH=bP.material.uniforms.hotspot.value;function bK(ca){ca.x-=bH.x;ca.y+=bH.y;var b9=aS.left+(b2-aS.left)/2;var cb=aS.top+(b0-aS.top)/2;if(ca.x<=b9/2&&ca.y<=cb/2){ca.y-=bH.height}else{if(ca.x>b9/2&&ca.y>cb/2){ca.x+=bH.width}else{if(ca.x>b9/2&&ca.y<=cb/2){ca.x+=bH.width;ca.y-=bH.height}}}}bK(bR);if(bR.x<b4||bR.y<b1||bR.x>b2||bR.y>b0||Math.abs(bR.z)>1){bP.setVisibility(false);var bX=new q.Vector2(-1,-1);var bV=new q.Vector3().copy(bP.boundaries[0]).applyMatrix4(b3);var bJ=new q.Vector3().copy(bP.boundaries[1]).applyMatrix4(b3);var bW,bU;if(bV.x===bI.x&&bV.y===bI.y&&bV.z===bI.z){bW=bM}else{bW=a4.currentViewpoint.project(bV)}if(bJ.x===bI.x&&bJ.y===bI.y&&bJ.z===bI.z){bU=bM}else{bU=a4.currentViewpoint.project(bJ)}if(Math.abs(bW.z)>1&&Math.abs(bU.z)>1){return bL}if(Math.abs(bW.z)>1||Math.abs(bU.z)>1){var bO=new q.Line3(bV,bJ);var bT=a4.currentViewpoint.getSightDirection().setLength(a4.currentViewpoint.camera.near);var b8=a4.currentViewpoint.getEyePosition().add(bT);var b7=new q.Plane().setFromNormalAndCoplanarPoint(a4.currentViewpoint.getSightDirection(),b8);var bN=b7.intersectLine(bO);if(!bN){return bL}if(Math.abs(bW.z)>1){bW=a4.currentViewpoint.project(bN);if(bV.x===bI.x&&bV.y===bI.y&&bV.z===bI.z){bR=bW.clone();bK(bR)}}else{bU=a4.currentViewpoint.project(bN);if(bJ.x===bI.x&&bJ.y===bI.y&&bJ.z===bI.z){bR=bU.clone();bK(bR)}}}if((bW.x<b4&&bU.x<b4)||(bW.x>b2&&bU.x>b2)||(bW.y<b1&&bU.y<b1)||(bW.y>b0&&bU.y>b0)){return bL}var b6=bU.x-bW.x!==0?(bU.y-bW.y)/(bU.x-bW.x):"infinity";b6=b6!=="infinity"?Math.round(b6*100)/100:"infinity";if(Math.abs(b6)>10000000){b6="infinity"}var b5=Math.round(b6!=="infinity"?bW.y-bW.x*b6:bW.y);if(bR.y<=b1){if(b6===0){return bL}if(bR.x>b4&&bR.x<b2){bX.x=b6!=="infinity"?(-1)*b5/b6:bW.x;bX.y=b1}else{if(bR.x<=b4){if(b6==="infinity"){return bL}if(b6*b4+b5>b1&&b6*b4+b5<b0){bX.x=b4;bX.y=b6*b4+b5}else{bX.x=(-1)*b5/b6;bX.y=b1}}else{if(b6==="infinity"){return bL}if(b6*b2+b5>b1&&b6*b2+b5<b0){bX.x=b2;bX.y=b6*b2+b5}else{bX.x=(-1)*b5/b6;bX.y=b1}}}}else{if(bR.y>=b0){if(b6===0){return bL}if(bR.x>b4&&bR.x<b2){bX.x=b6!=="infinity"?(b0-b5)/b6:bW.x;bX.y=b0}else{if(bR.x<=b4){if(b6==="infinity"){return bL}if(b6*b4+b5>b1&&b6*b4+b5<b0){bX.x=b4;bX.y=b6*b4+b5}else{bX.x=(b0-b5)/b6;bX.y=b0}}else{if(b6==="infinity"){return bL}if(b6*b2+b5>b1&&b6*b2+b5<b0){bX.x=b2;bX.y=b6*b2+b5}else{bX.x=(b0-b5)/b6;bX.y=b0}}}}else{if(bR.x<=b4){if(b6==="infinity"){return bL}if(bR.y>b1&&bR.y<b0){bX.x=b4;bX.y=b6!==0?b6*b4+b5:bW.y}}else{if(bR.x>=b2){if(b6==="infinity"){return bL}if(bR.y>b1&&bR.y<b0){bX.x=b2;bX.y=b6!==0?b6*b2+b5:bW.y}}}}}if(bX.x>=b4&&bX.y>=b1&&bX.x<=b2&&bX.y<=b0&&bX.x>=Math.min(bW.x,bU.x)-bH.width&&bX.y>=Math.min(bW.y,bU.y)-bH.height&&bX.x<=Math.max(bW.x,bU.x)+bH.width&&bX.y<=Math.max(bW.y,bU.y)+bH.height){bX.x=Math.floor(bX.x);bX.y=Math.floor(bX.y);for(var bQ=0;bQ<O.length;bQ++){if(O[bQ].label.name===bP.name&&O[bQ].isUsed===null&&O[bQ].label.gridID===bP.gridID){bL=O[bQ];break}}if(!bL){bL=al(bP.canvasNodeTexture._canvas2DCanvas);bL.style.transform="scale("+1/window.devicePixelRatio+")";bL.className="Grid3D_AnchoredLabel";bL.style.position="absolute";bL.ondrag=function(){};bL.label=bP;if(ac){bL.addEventListener("mouseenter",bn);bL.addEventListener("mouseleave",bD);bL.addEventListener("mousedown",bw);bL.addEventListener("mousemove",aK);bL.addEventListener("mouseup",bf);bL.addEventListener("touchstart",bw);bL.addEventListener("touchmove",aK);bL.addEventListener("touchend",bf)}O.push(bL)}bL.isUsed=true;bL.style.visibility="";var bZ=0,bY=0;if(bX.x===b4){bZ=-5;bY=bL.height/2}if(bX.y===b1){bZ=bL.width/2;bY=-5}if(bX.x===b2){bZ=bL.width+5;bY=bL.height/2}if(bX.y===b0){bZ=bL.width/2;bY=bL.height+5}bZ=Math.floor(bZ);bY=Math.floor(bY);bL.position2D={x:bX.x,y:bX.y};bL.offset2D={x:bZ,y:bY};bL.style.top=(bX.y-bY)+"px";bL.style.left=(bX.x-bZ)+"px";if(!bL.parentNode){aZ.appendChild(bL)}}}return bL};var A=function(bL,bJ){var bI=0,bO=0;var bM=aS.width-aS.right;var bK=aS.height-aS.bottom;var bH=aS.left;var bN=aS.top;if(bL.position2D.x===bH){bI=-5-bJ.width}if(bL.position2D.y===bN){bO=-5-bJ.height}if(bL.position2D.x===bM){bI=bJ.width+5}if(bL.position2D.y===bK){bO=bJ.height+5}bL.style.top=(bL.position2D.y-bL.offset2D.y-bO)+"px";bL.style.left=(bL.position2D.x-bL.offset2D.x-bI)+"px"};var ad=function(bO){var bT;if(w&&aZ){if(bO){O.splice(0,O.length);while(aZ.firstChild){aZ.removeChild(aZ.firstChild)}}else{for(bT=aZ.childNodes.length-1;bT>=0;bT--){aZ.childNodes[bT].style.visibility="hidden"}for(bT=0;bT<O.length;bT++){O[bT].isUsed=null}}var bL=[];var bR=[];for(bT=0;bT<U.length;bT++){if(U[bT].grid&&U[bT].grid.isVisible()){var bS=new q.Matrix4().multiplyMatrices(U[bT].grid.getMatrix(),P);for(var bM=0;bM<U[bT].grid.children.length;bM++){if(U[bT].grid.children[bM].isVisible()){var bK=U[bT].grid.children[bM].children[1];if(bK){if(bK.isVisible()){for(var bH=0;bH<bK.children.length;bH++){var bJ=bK.children[bH];if(bJ.isVisible()){for(var bQ=0;bQ<bJ.children.length;bQ++){var bI=aj(bJ.children[bQ],bS);if(bI){var bP="x:"+bI.position2D.x+", y:"+bI.position2D.y;var bN=bL.indexOf(bP);if(bN!==-1){A(bI,bR[bN])}bL.push(bP);bR.push(bI)}}}}}}}}}}}};var by=function(bI){var bH={};if(bI.origin.x+bI.xAxis<bI.origin.x){bH.x="max"}else{bH.x="min"}if(bI.origin.y+bI.yAxis<bI.origin.y){bH.y="max"}else{bH.y="min"}if(bI.origin.z+bI.zAxis<bI.origin.z){bH.z="max"}else{bH.z="min"}return bH};var G=function(bJ){if(!bJ.grid){return undefined}var bM={origin:new q.Vector3().copy(bJ.gridDataPreference.origin),xAxis:Math.abs(bJ.gridDataPreference.xAxis),yAxis:Math.abs(bJ.gridDataPreference.yAxis),zAxis:Math.abs(bJ.gridDataPreference.zAxis)};if(bJ.gridDataPreference.xAxis<0){bM.origin.x+=bJ.gridDataPreference.xAxis}if(bJ.gridDataPreference.yAxis<0){bM.origin.y+=bJ.gridDataPreference.yAxis}if(bJ.gridDataPreference.zAxis<0){bM.origin.z+=bJ.gridDataPreference.zAxis}bM.origin.applyMatrix4(bJ.grid.getMatrix());var bL=new q.Vector3(0,bM.yAxis,0);var bO=new q.Vector3(bM.xAxis,0,0);bL.applyMatrix4(P);bO.applyMatrix4(P);var bI=new q.Vector3().crossVectors(bL,bO);bL=new q.Vector3(bM.xAxis,0,0);bO=new q.Vector3(0,0,bM.zAxis);bL.applyMatrix4(P);bO.applyMatrix4(P);var bH=new q.Vector3().crossVectors(bL,bO);bL=new q.Vector3(0,0,bM.zAxis);bO=new q.Vector3(0,bM.yAxis,0);bL.applyMatrix4(P);bO.applyMatrix4(P);var bK=new q.Vector3().crossVectors(bL,bO);var bN=a4.currentViewpoint.getSightDirection();if(bN.dot(bI)<0&&bN.dot(bH)>0&&bN.dot(bK)>0){bM.zAxis=-bM.zAxis}else{if(bN.dot(bI)>0&&bN.dot(bH)<0&&bN.dot(bK)>0){bM.yAxis=-bM.yAxis}else{if(bN.dot(bI)>0&&bN.dot(bH)>0&&bN.dot(bK)<0){bM.xAxis=-bM.xAxis}else{if(bN.dot(bI)<0&&bN.dot(bH)<0&&bN.dot(bK)>0){bM.yAxis=-bM.yAxis;bM.zAxis=-bM.zAxis}else{if(bN.dot(bI)>0&&bN.dot(bH)<0&&bN.dot(bK)<0){bM.xAxis=-bM.xAxis;bM.yAxis=-bM.yAxis}else{if(bN.dot(bI)<0&&bN.dot(bH)>0&&bN.dot(bK)<0){bM.xAxis=-bM.xAxis;bM.zAxis=-bM.zAxis}else{if(bN.dot(bI)<0&&bN.dot(bH)<0&&bN.dot(bK)<0){bM.xAxis=-bM.xAxis;bM.yAxis=-bM.yAxis;bM.zAxis=-bM.zAxis}}}}}}}return by(bM)};var z=function(bJ){if(!bJ.grid){return}if(bJ.originType!=="userDefined"){if(S&&aA&&bJ===bi){aA.updateAutomaticCorner()}else{var bI=G(bJ);var bH=by(bJ.gridDataPreference);if(bI.x!==bH.x||bI.y!==bH.y||bI.z!==bH.z){if(bJ.bBox){Z.drawGrids({specifications:[bJ.bBox]})}else{if(bJ.root){Z.drawGrids({rootPaths:[bJ.root]})}}}}}};var aH=function(bJ){var bH=new q.Vector2(0,0);var bI=bJ.positionOnAxis;if(bJ.anchor==="left"){if(bI==="first"){bH.x=bJ.width}else{if(bI==="last"){bH.x=bJ.width;bH.y=bJ.height}else{bH.x=bJ.width;bH.y=bJ.height/2}}}else{if(bJ.anchor==="right"){if(bI==="last"){bH.y=bJ.height}else{if(bI!=="first"){bH.y=bJ.height/2}}}else{if(bJ.anchor==="top"){if(bI==="first"){bH.y=-bJ.height/3}else{if(bI==="last"){bH.x=bJ.width;bH.y=-bJ.height/3}else{bH.x=bJ.width/2;bH.y=-bJ.height/3}}}else{if(bJ.anchor==="bottom"){if(bI==="first"){bH.y=4*bJ.height/3}else{if(bI==="last"){bH.x=bJ.width;bH.y=4*bJ.height/3}else{bH.x=bJ.width/2;bH.y=4*bJ.height/3}}}}}}bH.x=Math.round(bH.x*10)/10;bH.y=Math.round(bH.y*10)/10;bH.width=bJ.width;bH.height=bJ.height;return bH};var M=function(bJ){var bI=bJ.isFirst?"first":(bJ.hasNext===false?"last":"else");var bH=(bJ.axis==="xAxis"&&bJ.axisOrientation>0)||(bJ.axis!=="xAxis"&&bJ.axisOrientation<0);if(bJ.planeSightOrientation.side){bH=!bH}if(bJ.planeID.indexOf("yx")!==-1){if(!bJ.planeSightOrientation.top&&(bJ.labelPositionOnGrid==="left"||bJ.labelPositionOnGrid==="right")){bH=!bH}}else{if(bJ.planeID.indexOf("yz")!==-1||bJ.planeID.indexOf("xz")!==-1){if(!bJ.planeSightOrientation.top&&(bJ.labelPositionOnGrid==="top"||bJ.labelPositionOnGrid==="bottom")){bH=!bH}}}if(bH&&bI!=="else"){bI=bI==="first"?"last":"first"}return bI};var y=function(bR){var bI=new q.Vector3().copy(bR.plane.localYAxis).clone().normalize();var bS=a4.currentViewpoint.getSightDirection();var bM=a4.currentViewpoint.getUpDirection();var bQ=new q.Vector3().crossVectors(bS,bM);var bK=bI.projectOnPlane(bQ);var bJ=(bK.x!==0||bK.y!==0||bK.z!==0)?bK.angleTo(bM):0;var bH={};var bO={};var bP=aN(bR.plane.normal.dot(bS));bO.top=bP>0;bO.side=false;if(bP>0){bH.localYAxis="left";bH.oppositeLocalYAxis="right";bH.localXAxis="bottom";bH.oppositeLocalXAxis="top"}else{if(bR.plane.getName().indexOf("yz")!==-1||bR.plane.getName().indexOf("xz")!==-1){bH.localYAxis="right";bH.oppositeLocalYAxis="left";bH.localXAxis="bottom";bH.oppositeLocalXAxis="top"}else{bH.localYAxis="left";bH.oppositeLocalYAxis="right";bH.localXAxis="top";bH.oppositeLocalXAxis="bottom"}}var bN=false;var bL=null;var bT=null;if(bR.plane.getName().indexOf("yz")!==-1||bR.plane.getName().indexOf("xz")!==-1){if(a2(bR.plane.localYAxis)>0){bL=Math.PI/2;bT=Math.PI}else{bL=0;bT=Math.PI/2}}else{if(a2(bR.plane.localYAxis)===bP){bL=0;bT=Math.PI/2}else{bL=Math.PI/2;bT=Math.PI}}if(bJ&&bJ>=bL&&bJ<=bT){bN=true;bO.side=true}if(bN){bH.localXAxis=bH.localXAxis==="bottom"?"top":"bottom";bH.oppositeLocalXAxis=bH.oppositeLocalXAxis==="top"?"bottom":"top";bH.localYAxis=bH.localYAxis==="right"?"left":"right";bH.oppositeLocalYAxis=bH.oppositeLocalYAxis==="left"?"right":"left"}bH.planeSightOrientation=bO;return bH};var aq=function(bK){var bP=y({plane:bK});var bL=bK.getChildByName("Labels").children;for(var bN=0;bN<bL.length;bN++){if(bL[bN].isVisible()){var bI=bL[bN].children;for(var bJ=0;bJ<bI.length;bJ++){var bO=bI[bJ].material.uniforms.hotspot.value;var bM=M({axis:bI[bJ].axis,axisOrientation:bI[bJ].axisOrientation,isFirst:bI[bJ].labelIsFirst,hasNext:bI[bJ].labelHasNext,labelPositionOnGrid:bP[bL[bN].getName()],planeSightOrientation:bP.planeSightOrientation,planeID:bK.getName()});if(bI[bJ].labelIsFirst&&bI[bJ].labelHasNext){K.push({node:bI[bJ]})}var bH=aH({anchor:bP[bL[bN].getName()],width:bO.width,height:bO.height,positionOnAxis:bM});if(bH.x!==bO.x||bH.y!==bO.y||bH.width!==bO.width||bH.height!==bO.height){bI[bJ].material.uniforms.hotspot.value=bH}}}}};var at=function(bK){var bJ=bK.plane.getChildByName("Labels");var bI="";var bH="";if(bK.plane.getName().indexOf("yx")!==-1){bI=a2(bK.plane.localYAxis)>0?"oppositeLocalXAxis":"localXAxis";bJ.getChildByName(bI).setVisibility(bK.flag);bH=a2(bK.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis";bJ.getChildByName(bH).setVisibility(bK.flag)}else{if(bK.plane.getName().indexOf("yz")!==-1){bI=a2(bK.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis";bJ.getChildByName(bI).setVisibility(bK.flag);bH=a2(bK.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis";bJ.getChildByName(bH).setVisibility(bK.flag)}else{if(bK.plane.getName().indexOf("xz")!==-1){bI=a2(bK.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis";bJ.getChildByName(bI).setVisibility(bK.flag);bH=a2(bK.plane.localXAxis)>0?"oppositeLocalYAxis":"localYAxis";bJ.getChildByName(bH).setVisibility(bK.flag)}}}};var aQ=function(bH){if(!bH.grid){return}var bJ;if(bH.gridDataPreference.xAxis===0||bH.gridDataPreference.yAxis===0||bH.gridDataPreference.zAxis===0){for(bJ=0;bJ<bH.grid.children.length;bJ++){at({plane:bH.grid.children[bJ],flag:true})}}else{var bK=null;for(bJ=0;bJ<bH.grid.children.length;bJ++){var bI;bI=a4.currentViewpoint.getSightDirection().clone().projectOnPlane(bH.grid.children[bJ].normal.applyMatrix4(P));bI.x=parseFloat(bI.x.toFixed(4));bI.y=parseFloat(bI.y.toFixed(4));bI.z=parseFloat(bI.z.toFixed(4));if(bI.x===0&&bI.y===0&&bI.z===0){bK=bH.grid.children[bJ].name;break}}if(bK){bH.grid.setNoZ(true);for(bJ=0;bJ<bH.grid.children.length;bJ++){bH.grid.children[bJ].setVisibility(bK===bH.grid.children[bJ].name);if(bK===bH.grid.children[bJ].name){at({plane:bH.grid.children[bJ],flag:true});aq(bH.grid.children[bJ])}}bz=true}}a4.render()};var J=function(){var bL;var bP;for(var bQ=0;bQ<K.length;bQ++){if(!K[bQ].updated){bP=K[bQ].node;var bM=K[bQ].node.material.uniforms.hotspot.value;var bO=new q.Vector3().getPositionFromMatrix(bP.getMatrix());var bI=[];for(bL=0;bL<K.length;bL++){if(bQ!==bL){var bN=new q.Vector3().getPositionFromMatrix(K[bL].node.getMatrix());if(bN.x===bO.x&&bN.y===bO.y&&bN.z===bO.z){var bK=K[bL].node.material.uniforms.hotspot.value;if(!((bK.y<bM.y-bM.height)||(bM.y-bM.height>bK.y)||(bK.x<bM.x-bM.width)||(bM.x-bM.width>bK.x))){bI.push(bL)}}}}if(bI.length===1){bI.push(bQ);var bJ=0;for(bL=0;bL<bI.length;bL++){bP=K[bI[bL]].node;var bR=bP.material.uniforms.hotspot.value;var bH=new q.Vector2();bH.x=bR.width/2;bH.y=bJ;bH.width=bR.width;bH.height=bR.height;if(bH.x!==bR.x||bH.y!==bR.y){bP.material.uniforms.hotspot.value=bH}bJ+=bR.height;bJ+=3;K[bI[bL]].updated=true}}K[bQ].updated=true}}};var ar=function(bH){var bI,bJ;if(bH.eventType.indexOf("@onViewpoint")!==-1){var bK=a4.currentViewpoint.getSightDirection();if(bH.eventType==="@onViewpointBeginMove"){V=true;bD();ay=true}else{if(bH.eventType==="@onViewpointChange"){if(V===null){V=true}if(!bK.equals(aP)){if(bz){for(bI=0;bI<U.length;bI++){U[bI].grid.setNoZ(false);for(bJ=0;bJ<U[bI].grid.children.length;bJ++){aq(U[bI].grid.children[bJ]);at({plane:U[bI].grid.children[bJ],flag:false});U[bI].grid.children[bJ].setVisibility(true)}}bz=false}for(bI=0;bI<U.length;bI++){aQ(U[bI])}aP.copy(bK)}if(!aI){for(bI=0;bI<U.length;bI++){z(U[bI])}}ad(V);V=false}else{if(bH.eventType==="@onViewpointEndMove"){if(I){aw()}else{V=null;ay=false;ad(true);if(!bz){K.splice(0,K.length);for(bI=0;bI<U.length;bI++){if(U[bI].grid){for(bJ=0;bJ<U[bI].grid.children.length;bJ++){aq(U[bI].grid.children[bJ])}}}J()}}}}}a4.render()}};var bA=function(){if(ai){aA=new Y({window:bC,stepRequired:aF.xStep});aA.display({rootID:h.getNodeID(bi.root.getLastElement(true)),gridDataPreference:bi.gridDataPreference,matrix:bi.grid.getMatrix(),displayHandlePoints:bi.originType==="userDefined"});bF=aA.subscribe("EndBoxChanged",function(){bi.type="userDefined";br.setState(false);aL.showContextualBar({hideWithDistance:true,fillingList:[{onContextualBarReady:function(){return{cmdList:[{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"]}]}},context:v.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]})});be=aA.subscribe("BoxCornerChanged",function(bI){if(bI.cornerChanged===true){bi.originType="userDefined";D.setState(false);localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","false")}else{D.setState(bi.originType!=="userDefined")}aL.showContextualBar({hideWithDistance:true,fillingList:[{onContextualBarReady:function(){return{cmdList:[{name:"CATRelatedData3DGridAutoOrigin",line:1,hdr_list:["CATRelatedData3DGridAutoOriginHdr"]}]}},context:v.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]})});var bH=function(bI){if(a4.pick(a4.getMousePosition(bI.from[0].currentPosition),"mesh",false).path.length===0&&!a4.currentViewpoint.isMoving()){o.removeEvent(a4.canvas,"onPrimaryPointerClick",bH);if(ak){ak.end()}}};ak=a.getCommand("CATRelatedData3DGridEditHdr",v.getCommandContext());o.addEvent(a4.canvas,"onPrimaryPointerClick",bH);a3.disable()}};var aR=function(bI){var bH;if(bI){if(ay&&bI.name==="Labels"){return}if(bI.material){bI.material.dispose();bI.material=null;if(bI.canvasNodeTexture){if(bI.canvasNodeTexture._canvas2DTexture){bI.canvasNodeTexture._canvas2DTexture.dispose();bI.canvasNodeTexture._canvas2DTexture=null}if(bI.canvasNodeTexture.materials&&bI.canvasNodeTexture.materials.length){for(bH=0;bH<bI.materials.canvasNodeTexture.length;bH++){bI.canvasNodeTexture.materials[bH].dispose();bI.canvasNodeTexture.materials[bH]=null}}}}for(bH=bI.children.length-1;bH>=0;bH--){aR(bI.children[bH])}bI.removeChildren()}};var a5=function(){S=true;aD(a0.rootBagPath);for(var bH=0;bH<U.length;bH++){bE(U[bH].root,{type:"pickability",value:"NOT_PICKABLE"});if(U[bH].grid.name===bi.grid.name){aR(U[bH].grid)}}while(aZ.firstChild){aZ.removeChild(aZ.firstChild)}if(!Y){require(["DS/CATRelatedData3DGrid/CATRelatedData3DGridBoxHandle"],function(bI){Y=bI;bA()})}else{bA()}};var bu=function(bL){var bR=true;if(bL.fitToStep==="userDefined"){bR=false}var bO=new q.Vector3(bL.min.x,bL.min.y,bL.min.z);var bN=aN(bL.max.x-bL.min.x);var bP=aN(bL.max.y-bL.min.y);var bU=aN(bL.max.z-bL.min.z);var bI=new q.Vector3(bL.min.x,bL.min.y,bL.min.z);var bJ=bL.max.x;var bT=bL.max.y;var bM=bL.max.z;if(bR){bI.x=bN?bN>0?ap(bO.x,aF.xStep):au(bO.x,aF.xStep):0;bI.y=bP?bP>0?ap(bO.y,aF.yStep):au(bO.y,aF.yStep):0;bI.z=bU?bU>0?ap(bO.z,aF.zStep):au(bO.z,aF.zStep):0;bJ=bN?bN>0?au(bL.max.x,aF.xStep):ap(bL.max.x,aF.xStep):0;bT=bP?bP>0?au(bL.max.y,aF.yStep):ap(bL.max.y,aF.yStep):0;bM=bU?bU>0?au(bL.max.z,aF.zStep):ap(bL.max.z,aF.zStep):0}var bH=bJ-bI.x;var bS=bT-bI.y;var bQ=bM-bI.z;var bK=bL.defaultOrigin;if(bK){if(bK.x==="max"){bI.x=bI.x+bH;bH*=-1}if(bK.y==="max"){bI.y=bI.y+bS;bS*=-1}if(bK.z==="max"){bI.z=bI.z+bQ;bQ*=-1}}return{origin:bI,xAxis:bH,yAxis:bS,zAxis:bQ}};var ag=function(){ak=new c({ID:"CATRelatedData3DGridEditHdr",isEnabled:true,context:v.getCommandContext()});a8=ak.onBegin(function(){a5()});aa=ak.onEnd(function(){if(S){aA.unsubscribe(x);aA.unsubscribe(bF);aA.unsubscribe(be);for(var bH=0;bH<U.length;bH++){if(U[bH].grid.name===bi.grid.name){if(aA.isSizeOK()){U[bH].gridDataPreference=aA.getDataPreference();U[bH].type=bi.type;U[bH].originType=bi.originType;t=by(U[bH].gridDataPreference)}break}}aA.clean();aA=null;S=false;bq();Z.drawGrids({rootPaths:[bi.root]});a3.enable()}})};var u=function(){var bH={gridList:[]};for(var bI=0;bI<U.length;bI++){bH.gridList.push({rootID:U[bI].gridName.split("3D Grid ")[1],gridDataPreference:U[bI].gridDataPreference,type:U[bI].type,originType:U[bI].originType})}if(af){af.setValue("3DGridData",JSON.stringify(bH))}localStorage.setItem("CATRelatedData3DGridDftOrigin",JSON.stringify(t))};var bm=function(bH){if(!bi){return}if(bi.type!=="userDefined"&&!bH){bi.type="userDefined";u();localStorage.setItem("CATRelatedData3DGridAutoFitCmd","false")}else{if(bi.type==="userDefined"&&bH){bi.type="auto";var bK=aX(bi.root),bI=null;if(bK){if(S){bI=bu({min:bK.min,max:bK.max,defaultOrigin:by(aA.getDataPreference())});aA.setDataPreference(bI);aA.refresh()}else{bI=bu({min:bK.min,max:bK.max,defaultOrigin:by(bi.gridDataPreference)});bi.gridDataPreference=bI;Z.drawGrids({rootPaths:[bi.root]});var bJ=[{name:"CATRelatedData3DGridEdit",line:1,hdr_list:["CATRelatedData3DGridEditHdr"]},{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"]}];aL.showContextualBar({hideWithDistance:true,fillingList:[{onContextualBarReady:function(){return{cmdList:bJ}},context:v.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]})}}localStorage.setItem("CATRelatedData3DGridAutoFitCmd","true")}}};var bp=function(){br=new g({ID:"CATRelatedData3DGridAutoFitHdr",isEnabled:true,context:v.getCommandContext()});C=br.onStateChange(function(){bm(this.getState())})};var T=function(bH){if(bi.originType!=="userDefined"&&!bH){bi.originType="userDefined";u();if(S){aA.setHandlePointsVisibility(true)}localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","false")}else{if(bi.originType==="userDefined"&&bH){bi.originType="auto";if(S){aA.setHandlePointsVisibility(false);aA.updateAutomaticCorner()}localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","true")}}};var aY=function(){D=new k({ID:"CATRelatedData3DGridAutoOriginHdr",isEnabled:true,context:v.getCommandContext()});ae=D.onStateChange(function(){T(this.getState())})};this.setActiveState=function(bK){if(bK!==az){az=bK;if(az){if(!aE){aE=document.createElement("canvas")}if(!aZ){aZ=e.createElement("div").inject(bC.getUIFrame())}a6=l.subscribe({event:"/VISU/"},ar);aP.copy(a4.currentViewpoint.getSightDirection());if(ac){a3=new b();a3.setExclusive(true);aO.beginPreactivate=a3.onBeginPreactivate(bn);aO.endPreactivate=a3.onEndPreactivate(bD);aO.primaryPointerClick=a3.onPrimaryPointerClick(aV);aO.beginManipulate=a3.onBeginManipulate(bc);aO.manipulate=a3.onManipulate(ba);aO.endanipulate=a3.onEndManipulate(aw)}if(ai){ag();bp();aY()}}else{if(aZ){bC.getUIFrame().removeChild(aZ)}aZ=null;aE=null;l.unsubscribe(a6);a6=0;if(ac){a3.unsubscribe(aO.beginPreactivate);a3.unsubscribe(aO.endPreactivate);a3.unsubscribe(aO.primaryPointerClick);a3.unsubscribe(aO.beginManipulate);a3.unsubscribe(aO.manipulate);a3.unsubscribe(aO.enManipulate);aO={}}if(ai){l.unsubscribe(aa);aa=null;l.unsubscribe(a8);a8=null;ak=null;br._modelEvents.unsubscribe(C);C=null;br=null;D._modelEvents.unsubscribe(ae);ae=null;D=null}var bJ=Object.keys(R);for(var bH=0;bH<bJ.length;bH++){for(var bI=0;bI<R[bJ[bH]].length;bI++){a3.unlink(R[bJ[bH]][bI])}}R={}}}};this.endEditMode=function(){if(ak){ak.end()}};var bv=function(bJ,bI){var bH=bJ.height;bI.font=ao+"pt sans-serif";bI.fillStyle=this.isHighlighted?bg:W;bI.fillText(this.txtValue,0,bH)};var bh=function(bN){var bP;var bR=aE.getContext("2d");bR.font=ao+"pt sans-serif";var bI=Math.round(bR.measureText(bN.value).width*10)/10;var bQ=ao;aE.width=bI;aE.height=bQ;var bJ;var bL=bN.plane.getName();for(bP=0;bP<aG.length;bP++){if(aG[bP].txtValue===bN.value&&aG[bP].gridID===bN.gridID){bJ=aG[bP].canvasNodeTexture;break}}if(!bJ){bJ=new r({width:bI,height:bQ,drawCB:bv});bJ.txtValue=bN.value;aG.push({txtValue:bN.value,canvasNodeTexture:bJ,gridID:bN.gridID})}var bS=y({plane:bN.plane});for(bP=0;bP<bN.position.length;bP++){var bM="";if(bL.indexOf("yx")!==-1){if(bN.axis==="yAxis"){bM=a2(bN.plane.localYAxis)>0?"oppositeLocalXAxis":"localXAxis"}else{bM=a2(bN.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis"}}else{if(bL.indexOf("yz")!==-1){if(bN.axis==="yAxis"){bM=a2(bN.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis"}else{bM=a2(bN.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis"}}else{if(bL.indexOf("xz")!==-1){if(bN.axis==="xAxis"){bM=a2(bN.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis"}else{bM=a2(bN.plane.localXAxis)>0?"oppositeLocalYAxis":"localYAxis"}}}}if(bP>0){if(bM==="localXAxis"){bM="oppositeLocalXAxis"}else{if(bM==="oppositeLocalXAxis"){bM="localXAxis"}else{if(bM==="localYAxis"){bM="oppositeLocalYAxis"}else{if(bM==="oppositeLocalYAxis"){bM="localYAxis"}}}}}var bO=M({axis:bN.axis,axisOrientation:bN.gridData[bN.axis],planeID:bL,isFirst:bN.isFirst,hasNext:bN.hasNext,planeSightOrientation:bS.planeSightOrientation,labelPositionOnGrid:bS[bM]});var bH=aH({anchor:bS[bM],positionOnAxis:bO,width:bI,height:bQ});var bK=d.createCanvas2DNode({name:bN.value,hotspot:bH,canvasNodeTexture:bJ});bK.setMatrix(new q.Matrix4().makeTranslation(bN.position[bP].x,bN.position[bP].y,bN.position[bP].z));bK.setPickable(f.PICKABLE);bK.labelIsFirst=bN.isFirst;bK.gridID=bN.gridID;bK.labelHasNext=bN.hasNext;bK.axis=bN.axis;bK.axisOrientation=bN.gridData[bN.axis];bK.boundaries=[bN.position[0].clone(),bN.position[1].clone()];bN.labels.getChildByName(bM).addChild(bK);if(a3){if(!R[bN.gridID]){R[bN.gridID]=[]}R[bN.gridID].push(a3.linkToNode(bK))}if(bN.isFirst&&bN.hasNext){K.push({node:bK})}}};var s=function(){var bH=new q.Vector3();var bL=new q.Vector3(),bJ=new q.Vector3(),bI=new q.Vector3();P.extractBasis(bL,bJ,bI);var bK=new q.Vector3(P.elements[12],P.elements[13],P.elements[14]);bH.x=bL.dot(bK);bH.y=bJ.dot(bK);bH.z=bI.dot(bK);return bH};var X=function(b3){K.splice(0,K.length);var bL;if(av){bL=s()}var bP=["yx","yz","xz"],bN;for(var bO=0;bO<bP.length;bO++){var bX=b3.gridData.gridDataPreference;var bM=bP[bO].charAt(0),bI=bP[bO].charAt(1);var bT=bM+"Axis",b0=bI+"Axis";var bV=b3.gridData.grid.getChildByName(bP[bO]+" Plane");if(bX[bT]===0||bX[b0]===0||!bV){continue}var bY=bV.getChildByName("Labels");if(!bY){bY=new i("Labels");bY.addChild(new i("localXAxis"));bY.addChild(new i("localYAxis"));bY.addChild(new i("oppositeLocalXAxis"));bY.addChild(new i("oppositeLocalYAxis"));bV.addChild(bY)}else{for(bN=0;bN<bY.children.length;bN++){bY.children[bN].removeChildren()}}var bQ=bM+"Step",bJ=bI+"Step";var bW=aN(bX[bT])<0?ap(bX.origin[bM],aF[bQ]):au(bX.origin[bM],aF[bQ]);var bZ;var bS=0;if(av){if(bM==="x"){bZ=bW-bL.x}if(bM==="y"){bZ=bW-bL.y}if(bM==="z"){bZ=bW-bL.z}if(Math.abs(bZ)>Math.abs(bX.origin[bM])){bS=aF[bQ]*aN(bX[bT])}}var bK=0;var bR,bU;for(bN=0;Math.abs(bW+bN*aN(bX[bT])-bX.origin[bM])<=Math.abs(bX[bT]);bN+=aF[bQ]){if(bK===0||bK%b3.gridData.labelRatio===0||bK===b3.labelsInfos[bP[bO]].fstAxis){bR=new q.Vector3().copy(bX.origin);bU=new q.Vector3().copy(bX.origin);bR[bM]=bW+bN*aN(bX[bT]);bR[bI]=bX.origin[bI];bU[bM]=bW+bN*aN(bX[bT]);bU[bI]=bX.origin[bI]+bX[b0];bh({value:N[bM]+Math.round(aT*(bW+bS+bN*aN(bX[bT]))*aU)/aU,isFirst:bN===0,hasNext:Math.abs(bW+(bN+aF[bQ])*aN(bX[bT])-bX.origin[bM])<=Math.abs(bX[bT]),position:[bR,bU],axis:bT,labels:bY,plane:bV,gridData:bX,gridID:b3.gridData.grid.getName()})}bK++}var b2=aN(bX[b0])<0?ap(bX.origin[bI],aF[bJ]):au(bX.origin[bI],aF[bJ]);var b1=0;var bH;if(av){if(bM==="x"){bH=b2-bL.x}if(bM==="y"){bH=b2-bL.y}if(bM==="z"){bH=b2-bL.z}if(Math.abs(bH)>Math.abs(bX.origin[bI])){b1=aF[bJ]*aN(bX[b0])}}bK=0;for(bN=0;Math.abs(b2+bN*aN(bX[b0])-bX.origin[bI])<=Math.abs(bX[b0]);bN+=aF[bJ]){if(bK===0||bK%b3.gridData.labelRatio===0||bK===b3.labelsInfos[bP[bO]].scdAxis){bR=new q.Vector3().copy(bX.origin);bU=new q.Vector3().copy(bX.origin);bR[bM]=bX.origin[bM];bR[bI]=b2+bN*aN(bX[b0]);bU[bM]=bX.origin[bM]+bX[bT];bU[bI]=b2+bN*aN(bX[b0]);bh({value:N[bI]+Math.round(aT*(b2+b1+bN*aN(bX[b0]))*aU)/aU,isFirst:bN===0,hasNext:Math.abs(b2+(bN+aF[bJ])*aN(bX[b0])-bX.origin[bI])<=Math.abs(bX[b0]),position:[bR,bU],axis:b0,labels:bY,plane:bV,gridData:bX,gridID:b3.gridData.grid.getName()})}bK++}at({plane:bV,flag:false})}J()};var bb=function(bR){if(!bR){return undefined}var bN={max:0},bK=["yx","yz","xz"],bT;for(var bJ=0;bJ<bK.length;bJ++){var bH=bK[bJ].charAt(0),bL=bK[bJ].charAt(1);var bO=bH+"Axis",bS=bL+"Axis";if(bR[bO]===0||bR[bS]===0){continue}var bI=bH+"Step",bQ=bL+"Step";bN[bK[bJ]]={};var bU=0;var bP=aN(bR[bO])<0?ap(bR.origin[bH],aF[bI]):au(bR.origin[bH],aF[bI]);for(bT=0;Math.abs(bP+bT*aN(bR[bO])-bR.origin[bH])<=Math.abs(bR[bO]);bT+=aF[bI]){bU++;bN.max++}bN[bK[bJ]].fstAxis=bU;bU=0;var bM=aN(bR[bS])<0?ap(bR.origin[bL],aF[bQ]):au(bR.origin[bL],aF[bQ]);for(bT=0;Math.abs(bM+bT*aN(bR[bS])-bR.origin[bL])<=Math.abs(bR[bS]);bT+=aF[bQ]){bU++;bN.max++}bN[bK[bJ]].scdAxis=bU}return bN};var aB=function(){var bH=0,bI=[],bK;for(bK=0;bK<U.length;bK++){if(U[bK].grid&&U[bK].gridDataPreference){var bL=bb(U[bK].gridDataPreference);if(bL){bI.push(bL);bH+=bL.max}}}var bM=bH;var bJ=1;if(bl){while(bH>bl){bJ++;bH=bM/bJ}}for(bK=0;bK<U.length;bK++){if(U[bK].labelRatio!==bJ&&U[bK].grid){U[bK].labelRatio=bJ;X({gridData:U[bK],labelsInfos:bI[bK]})}}ad(true)};var aC=function(b3){var bS=["yx","yz","xz"],bQ;var bM;if(av){bM=s()}for(var bR=0;bR<bS.length;bR++){var bZ=b3.gridData.gridDataPreference;var bP=bS[bR].charAt(0),bJ=bS[bR].charAt(1);var bV=bP+"Axis",b0=bJ+"Axis";if(bZ[bV]===0||bZ[b0]===0){continue}var bX=new i(bP+bJ+" Plane");b3.gridData.grid.addChild(bX);var b1=new i("Lines");b1.setPickable(f.NODRAWHL);bX.addChild(b1);var bI=new q.Vector3();var bO=new q.Vector3();bI[bP]=bZ[bV];bO[bJ]=bZ[b0];bX.localXAxis=bI;bX.localYAxis=bO;bX.normal=new q.Vector3().crossVectors(bI,bO).normalize();if(a2(bX.normal)>0){bX.normal=bX.normal.negate()}var bT=bP+"Step",bL=bJ+"Step";var bY=aN(bZ[bV])<0?ap(bZ.origin[bP],aF[bT]):au(bZ.origin[bP],aF[bT]);if(av){if(bP==="x"){bY=bY-bM.x}if(bP==="y"){bY=bY-bM.y}if(bP==="z"){bY=bY-bM.z}if(Math.abs(bY)>Math.abs(bZ.origin[bP])){bY+=aF[bT]}}var bU=new q.Vector3().copy(bZ.origin),bW=new q.Vector3().copy(bZ.origin);bU[bP]=bY;bU[bJ]=bZ.origin[bJ];bW[bP]=bY;bW[bJ]=bZ.origin[bJ]+bZ[b0];var bN=d.createLineNode({points:[bU,bW]});for(bQ=0;Math.abs(bY+bQ*aN(bZ[bV])-bZ.origin[bP])<=Math.abs(bZ[bV]);bQ+=aF[bT]){var bK=bN;if(bQ!==0){bK=bK.clone()}bK.setMatrix(new q.Matrix4().makeTranslation(bP==="x"?bQ*aN(bZ[bV]):0,bP==="y"?bQ*aN(bZ[bV]):0,bP==="z"?bQ*aN(bZ[bV]):0));bK.relatedLabel=N[bP]+Math.round(bY+bQ*aN(bZ[bV]));b1.addChild(bK)}var b2=aN(bZ[b0])<0?ap(bZ.origin[bJ],aF[bL]):au(bZ.origin[bJ],aF[bL]);if(av){if(bJ==="x"){b2=b2-bM.x}if(bJ==="y"){b2=b2-bM.y}if(bJ==="z"){b2=b2-bM.z}if(Math.abs(b2)>Math.abs(bZ.origin[bJ])){b2+=aF[bL]}}bU=new q.Vector3().copy(bZ.origin);bW=new q.Vector3().copy(bZ.origin);bU[bP]=bZ.origin[bP];bU[bJ]=b2;bW[bP]=bZ.origin[bP]+bZ[bV];bW[bJ]=b2;bN=d.createLineNode({points:[bU,bW]});for(bQ=0;Math.abs(b2+bQ*aN(bZ[b0])-bZ.origin[bJ])<=Math.abs(bZ[b0]);bQ+=aF[bL]){var bH=bN;if(bQ!==0){bH=bH.clone()}bH.setMatrix(new q.Matrix4().makeTranslation(bJ==="x"?bQ*aN(bZ[b0]):0,bJ==="y"?bQ*aN(bZ[b0]):0,bJ==="z"?bQ*aN(bZ[b0]):0));bH.relatedLabel=N[bJ]+Math.round(b2+bQ*aN(bZ[b0]));b1.addChild(bH)}}};var a7=function(bM,bO,bI){var bL,bH;var bK=bO.origin;var bJ=[new q.Vector3(bK.x,bK.y,bK.z),new q.Vector3(bK.x+bO.xAxis,bK.y,bK.z),new q.Vector3(bK.x,bK.y+bO.yAxis,bK.z),new q.Vector3(bK.x,bK.y,bK.z+bO.zAxis),new q.Vector3(bK.x+bO.xAxis,bK.y+bO.yAxis,bK.z),new q.Vector3(bK.x,bK.y+bO.yAxis,bK.z+bO.zAxis),new q.Vector3(bK.x+bO.xAxis,bK.y,bK.z+bO.zAxis),new q.Vector3(bK.x+bO.xAxis,bK.y+bO.yAxis,bK.z+bO.zAxis)];for(var bN=0;bN<bJ.length;bN++){if(bL===undefined&&bH===undefined){bL=new q.Vector3().copy(bJ[bN]);bH=new q.Vector3().copy(bJ[bN])}else{bL.x=Math.min(bJ[bN].x,bL.x);bL.y=Math.min(bJ[bN].y,bL.y);bL.z=Math.min(bJ[bN].z,bL.z);bH.x=Math.max(bJ[bN].x,bH.x);bH.y=Math.max(bJ[bN].y,bH.y);bH.z=Math.max(bJ[bN].z,bH.z)}}return bu({min:bL,max:bH,defaultOrigin:bI,fitToStep:bM.type})};var bG=function(bJ,bK){var bH;var bI;if(bJ.type!=="userDefined"){bI=bu({min:bK.min,max:bK.max,defaultOrigin:t})}else{bI=bJ.gridDataPreference}if(bJ.originType==="userDefined"){bH=by(bJ.gridDataPreference)}else{bH=G(bJ)}if(bH){bI=a7(bJ,bI,bH)}if(bI!==bJ.gridDataPreference){return bI}return undefined};var B=function(bI){var bH=new q.Color(bI);var bJ=Math.round(((bH.r*255*299)+(bH.g*255*587)+(bH.b*255*114))/1000);if(bJ>125){W="black"}else{W="white"}};var bs=function(bI){var bJ;if(aM.gridList&&aM.gridList.length>0){for(var bH=0;bH<aM.gridList.length;bH++){bJ=aM.gridList[bH];if(bJ.rootID===bI.split("3D Grid ")[1]){aM.gridList.splice(bH,1);break}else{bJ=null}}}return bJ};var bt=function(bM,bH,bL){var bI;for(var bJ=0;bJ<U.length;bJ++){if(U[bJ].gridName===bM){if(bH){U[bJ].root=bH.clone()}if(bL){U[bJ].bBox=bL.clone()}bI=U[bJ];if(R&&R[bM]){for(var bK=0;bK<R[bM].length;bK++){a3.unlink(R[bM][bK])}R[bM].splice(0,R[bM].length)}break}}return bI};var ax=function(bN,bK,bP,bH,bM){var bI;var bO=true;var bJ;var bL;var bR;var bQ;if(bN){bL=bN.gridDataPreference;if(bN.type){bR=bN.type}if(bN.originType){bQ=bN.originType}}if(bK){if(!bK.grid){bK.grid=new i(bK.gridName);bK.grid.setVisibilityFree(true)}bI=bK.grid;bL=bK.gridDataPreference;bR=bK.type;bQ=bK.originType;bO=bK.visibility}else{bI=new i(bM);bI.setVisibilityFree(true);if(bM==="3D Grid "+Q){if(bQ===undefined){bQ="auto"}if(bR===undefined){bR="userDefined"}if(bL===undefined){bL=bu({min:bP.min,max:bP.max,defaultOrigin:t,fitToStep:bR})}bK={bBox:bP?bP.clone():undefined,gridName:bM,grid:bI,gridDataPreference:bL,type:bR,originType:bQ}}else{if(bR===undefined){bR=localStorage.getItem("CATRelatedData3DGridAutoFitCmd")==="false"?"userDefined":"auto"}if(bQ===undefined){bQ=localStorage.getItem("CATRelatedData3DGridAutoOriginCmd")==="false"?"userDefined":"auto"}if(bL===undefined){bL=bu({min:bP.min,max:bP.max,defaultOrigin:t})}bK={root:bH?bH.clone():undefined,gridName:bM,grid:bI,gridDataPreference:bL,type:bR,originType:bQ}}U.push(bK)}aR(bI);bK.labelRatio=null;bI.setVisibility(bO);bK.visibility=bO;bJ=bG(bK,bP);if(bJ){bK.gridDataPreference=bJ}aC({gridData:bK});bI.exludeFromBounding(false);bI.setVisibilityInTree(false);aB();return bI};this.drawGrids=function(bK){var bM;B(a4.backgroundColor);bo();var bH=null;var bI;var bN;var bL;var bP;var bJ;if(bK.rootPaths){var bO;for(bO=0;bO<bK.rootPaths.length;bO++){bP=bK.rootPaths[bO];bL="3D Grid "+h.getNodeID(bP.getLastElement(true));bJ=bs(bL);if(!bJ){bH=bt(bL,bP,bN)}bN=aX(bP);if(!bN){if(bH&&bH.grid){bH.grid.setVisibility(false)}continue}bI=ax(bJ,bH,bN,bP,bL);if(!a4.getRootNode().getChildByName("3D Grid "+h.getNodeID(bP.getLastElement(true)))){a4.addNode(bI)}}for(bO=0;bO<bK.rootPaths.length;bO++){for(bM=0;bM<U.length;bM++){if(U[bM].root&&U[bM].root.isEqual(bK.rootPaths[bO])){aQ(U[bM]);break}}}if(bK.rootPaths.length>0){u();a4.render({updateInfinitePlane:true})}}else{if(bK.specifications){bN=bK.specifications[0].BBox;bL="3D Grid "+Q;bJ=bs(bL);if(!bJ){bH=bt(bL,bP,bN)}if(!bN){if(bH&&bH.grid){bH.grid.setVisibility(false)}}bI=ax(bJ,bH,bN,bP,bL);aQ(U[0]);u();if(aW){aW.addChild(bI)}}}};var a9=function(bJ){var bI=R[bJ];if(bI&&bI.length){for(var bH=0;bH<bI.length;bH++){a3.unlink(bI[bH])}bI.splice(0,bI.length)}};var bB=function(bI){if(aZ){if(aZ.childNodes&&aZ.childNodes.length){for(var bH=aZ.childNodes.length-1;bH>=0;bH--){if(aZ.childNodes[bH].label.gridID===bI){aZ.removeChild(aZ.childNodes[bH])}}}}};var ab=function(bI){if(aG){for(var bH=aG.length-1;bH>=0;bH--){if(aG[bH].gridID===bI){aG.splice(bH,1)}}}};var bx=function(bI,bJ){for(var bH=0;bH<U.length;bH++){if(U[bH].gridName===bJ){aR(U[bH].grid);if(bI.rootPaths){a4.removeNode(U[bH].grid)}else{if(bI.owner){bI.owner.removeChild(U[bH].grid)}}if(bI.fromStorage&&U.length>0){U.splice(bH,1);bH--}else{if(U[bH]&&U[bH].grid){delete U[bH].grid}if(U[bH]&&U[bH].root){delete U[bH].root}if(U[bH]&&U[bH].bBox){delete U[bH].bBox}if(U[bH]&&U[bH].labelRatio){delete U[bH].labelRatio}}a9(bJ);break}}bB(bJ);ab(bJ)};this.deleteGrids=function(bJ){var bI=undefined;if(bJ.rootPaths){for(var bH=0;bH<bJ.rootPaths.length;bH++){bI="3D Grid "+h.getNodeID(bJ.rootPaths[bH].getLastElement(true));bx(bJ,bI)}}else{bI="3D Grid "+Q;bx(bJ,bI)}if(bJ.fromStorage&&bJ.rootPaths&&bJ.rootPaths.length>0){u();a4.render()}if(U.length===0){aG.splice(0,aG.length)}else{aB()}};this.getGridRootNames=function(){var bH=[];for(var bI=0;bI<U.length;bI++){bH.push(U[bI].gridName)}return bH};this.setGridsVisibility=function(bO){var bK=[],bL;var bJ,bI;for(bL=0;bL<bO.roots.length;bL++){for(var bN=0;bN<U.length;bN++){bI=h.getNodeID(U[bN].root.getLastElement(true));bJ=h.getNodeID(bO.roots[bL].getLastElement(true));if(bI===bJ&&U[bN].grid&&U[bN].grid.isVisible()!==bO.flag){U[bN].grid.setVisibility(bO.flag);U[bN].visibility=bO.flag;if(bO.flag){var bM=aX(U[bN].root);if(bM){var bH=bG(U[bN],bM);if(bH){U[bN].gridDataPreference=bH;bK.push(bO.roots[bL])}}else{U[bN].grid.setVisibility(false)}}break}}}for(bL=aZ.childNodes.length-1;bL>=0;bL--){aZ.childNodes[bL].style.visibility=bO.flag?"":"hidden"}if(bK.length){Z.drawGrids({rootPaths:bK})}a4.render()};this.updateFreeZone=function(bH){aS=bH;ad(true)}}});return j});
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridController",["UWA/Core","UWA/Utils","UWA/Class","DS/ApplicationFrame/CommandsManager","DS/CATRelatedData3DGrid/CATRelatedData3DGridView","DS/Core/Events","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(j,i,c,a,f,h,d){var b=c.extend({init:function(p){var z=p||{};this._parent(z);var v=false;var l=false;var s=null;var u=["CAT3DComposeExamineSelectionHdr","Explode","CAT3DComposeFakeMoveHdr","CAT3DComposeSetIdentityPositionHdr"];var k=z.ctxViewer;var o={};var y=k.getViewer();var m=null;var t=this;var x=function(){if(v&&!s&&m){var A=k.getFrameWindow().getImmersiveFrame().getFreeZone().getBoundingClientRect();m.updateFreeZone({width:A.width,height:A.height,left:A.left,right:A.width-A.right,bottom:A.height-A.bottom,top:A.top})}};var w=function(C){if(!k){return}if(v&&!s){var B=false;for(var A=0;A<u.length;A++){if(u[A]===C._id){B=true;break}}if(B){var D=a.getCommandCheckHeader("CATRelatedData3DGridHdr",k.getCommandContext?k.getCommandContext():null);D.disable();m.deleteGrids({rootPaths:k.getRootBagPath().getChildrenPathes(),fromStorage:false});s=C.onEnd(function(){D=a.getCommandCheckHeader("CATRelatedData3DGridHdr",k.getCommandContext?k.getCommandContext():null);D.enable();m.drawGrids({rootPaths:k.getRootBagPath().getChildrenPathes()});h.unsubscribe(s);s=null})}}};var n=w;a.onCommandStart(n,k.getCommandContext&&k.getCommandContext()?k.getCommandContext():undefined);var q=function(){k.getFrameWindow().getImmersiveFrame().addEventListener("freeZoneResize",x);o.onViewerResizedToken=y.onViewerResize(x);o.onRootAddedToken=k.subscribe({event:"onRootAdded"},function(C){if(v&&!s){m.endEditMode();var D=C.path;if(C.inContext){var B=k.getRootBagPath().getChildrenPathes();for(var A=0;A<B.length;A++){if(B[A].isAParentOf(C.path)){D=B[A];break}}}m.drawGrids({rootPaths:[D]})}});o.onRootRemovedToken=k.subscribe({event:"onRootRemoved"},function(B){if(v&&!s){m.endEditMode();var A=!l;m.deleteGrids({rootPaths:[B.path],fromStorage:A})}});o.onHide=k.subscribe({event:"onHide"},function(E){if(v&&E&&E.paths instanceof Array&&m&&!s){m.endEditMode();var C=[];var D=k.getRootBagPath().getChildrenPathes();for(var A=0;A<E.paths.length;A++){for(var B=0;B<D.length;B++){if(D[B].isAParentOf(E.paths[A])){C.push(D[B]);break}}}if(C.length){m.drawGrids({rootPaths:C})}}});o.onShow=k.subscribe({event:"onShow"},function(E){if(v&&E&&E.paths instanceof Array&&m&&!s){m.endEditMode();var C=[];var D=k.getRootBagPath().getChildrenPathes();for(var A=0;A<E.paths.length;A++){for(var B=0;B<D.length;B++){if(D[B].isAParentOf(E.paths[A])){C.push(D[B]);break}}}if(C.length){m.drawGrids({rootPaths:C})}}});o.onRefreshBeginToken=k.subscribe({event:"onRefreshBegin"},function(){l=true;m.endEditMode()});o.onRefreshCompletedToken=k.subscribe({event:"onRefreshCompleted"},function(){l=false});o.onRootAttachedToken=k.subscribe({event:"onRootAttached"},function(A){if(v&&!s){m.drawGrids({rootPaths:[A.path]})}});o.onRootDetachedToken=k.subscribe({event:"onRootDetached"},function(A){if(v&&!s){m.endEditMode();m.deleteGrids({rootPaths:[A.path],fromStorage:false})}});o.onLayoutComputedToken=k.subscribe({event:"onLayoutComputationBegin"},function(){if(v&&!s){m.endEditMode();m.deleteGrids({rootPaths:k.getRootBagPath().getChildrenPathes(),fromStorage:false})}});o.onLayoutResetToken=k.subscribe({event:"onLayoutComputationEnd"},function(){if(v&&!s){m.drawGrids({rootPaths:k.getRootBagPath().getChildrenPathes()})}});o.onModelUpdatedToken=k.subscribe({event:"onModelUpdated"},function(D){if(v&&!s){m.endEditMode();var E=[];var C=k.getRootBagPath().getChildrenPathes();if(D.rootNodes){for(var A=0;A<D.rootNodes.length;A++){for(var B=0;B<C.length;B++){if(C[B].getLastElement(true)===D.rootNodes[A]){E.push(C[B]);break}}}m.drawGrids({rootPaths:E})}else{m.drawGrids({rootPaths:C})}}});n=w;o.onBackgroundModifyToken=y.onBackgroundModify(function(){if(v&&!s){m.endEditMode();m.drawGrids({rootPaths:k.getRootBagPath().getChildrenPathes()})}})};var r=function(){k.unsubscribe(o.onRefreshBeginToken);k.unsubscribe(o.onRefreshCompletedToken);k.unsubscribe(o.onRootAddedToken);k.unsubscribe(o.onRootRemovedToken);k.unsubscribe(o.onRootAttachedToken);k.unsubscribe(o.onRootDetachedToken);k.unsubscribe(o.onLayoutComputedToken);k.unsubscribe(o.onLayoutResetToken);k.unsubscribe(o.onModelUpdatedToken);y.unsubscribe(o.onBackgroundModifyToken);y.unsubscribe(o.onViewerResizedToken);k.getFrameWindow().getImmersiveFrame().removeEventListener("freeZoneResize",x);o={};n=null};this.setActiveState=function(A){var I,E;if(A!==v){v=A;var J=k.getRootBagPath().getChildrenPathes();if(v){if(!m){var H={};if(window.location.search!==""){j.extend(H,i.parseQuery(window.location.search));if(H.widgetDomain){j.extend(H,i.parseQuery(H.widgetDomain))}}m=new f({window:k.getFrameWindow(),rootBagPath:k.getRootBagPath(),viewer:y,context:k,nbMaxLabel:"CAT3DGRID_MAXLABEL" in H?H.CAT3DGRID_MAXLABEL:300,stepRequiredX:100,stepRequiredY:100,stepRequiredZ:100});x()}m.setActiveState(true);var C=m.getGridRootNames();var G=false;var F=[],D;for(I=0;I<C.length;I++){for(E=0;E<J.length;E++){D="3D Grid "+d.getNodeID(J[E].getLastElement(true));if(D===C[I]){G=true;break}}if(!G){for(E=0;E<J.length;E++){D="3D Grid "+d.getNodeID(J[E].getLastElement(true));if(D===C[I]){F.push(J[E]);break}}}}m.deleteGrids({rootPaths:F,fromStorage:true});m.drawGrids({rootPaths:J});q();for(I=0;I<u.length;I++){var B=a.getCommand(u[I],k.getCommandContext?k.getCommandContext():null);if(B&&B.isRunning()){w(B);break}}}else{if(m){m.endEditMode();m.deleteGrids({rootPaths:J,fromStorage:false});m.setActiveState(false)}r()}}};this.getActiveState=function(){return v};this.clearController=function(){t.setActiveState(false);k=y=u=m=t=null};this.hide3DGrids=function(){if(v&&!s){m.setGridsVisibility({roots:k.getRootBagPath().getChildrenPathes(),flag:false})}};this.display3DGrids=function(){if(v&&!s){m.setGridsVisibility({roots:k.getRootBagPath().getChildrenPathes(),flag:true})}}}});var g=[];var e=c.singleton({init:function(){},give3DGridController:function(l){if(l&&l.context){for(var k=0;k<g.length;k++){if(g[k].context===l.context){return g[k].gridController}}}return undefined},get3DGridController:function(l){var m=this.give3DGridController(l);if(l&&l.context&&!m){var k=new b({ctxViewer:l.context});m={setActiveState:function(n){if(k){k.setActiveState(n)}},getActiveState:function(){if(k){return k.getActiveState()}return undefined},clearController:function(){if(k){k.clearController();k=null}},hide3DGrids:function(){if(k){k.hide3DGrids()}},display3DGrids:function(){if(k){k.display3DGrids()}}};g.push({context:l.context,gridController:Object.freeze(m)})}return m},unreference3DGridController:function(l){if(l&&l.context){for(var k=g.length-1;k>=0;k--){if(g[k].context===l.context){g[k].gridController.clearController();g.splice(k,1)}}}}});return e});
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext","DS/CATRelatedData3DGrid/CATRelatedData3DGridController"],function(d,c,a){var b=d.extend({init:function(g){this._parent(g,{});var j=this;var h=null;var i=this.onStateChange(function(){if(!h){h=c.get()}a.get3DGridController({context:h}).setActiveState(j.getState());localStorage.setItem("CATRelatedData3DGridCmd",j.getState()?"true":"false")});var f=this._destroy;this._destroy=function(){if(h){a.unreference3DGridController({context:h})}j._modelEvents.unsubscribe(i);f.call(j)};var e=localStorage.getItem("CATRelatedData3DGridCmd");e=e==="true"?true:(e==="false"?false:undefined);this.setState(e===false||e===undefined?false:true,true)},_destroy:function(){this._parent()}});return b});