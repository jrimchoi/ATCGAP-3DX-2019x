define("DS/MPFShopFormComponent/LegalEntityTypeSelector",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Toggle","i18n!DS/MPFShopFormComponent/assets/nls/ShopFormComponent","css!DS/MPFShopFormComponent/MPFShopFormComponent"],function(e,d,c,b){var a=d.extend({className:"mpf-legal-entity-type",setup:function(f){f||(f={});this.individualToggle=this._createIndividualToggle();this.companyToggle=this._createCompanyToggle()},render:function(){this.container.setContent([this.individualToggle,this.companyToggle]);return this},_createIndividualToggle:function(){var f=this;return new c({className:"primary",name:"individualToggle",value:"individual",label:b.get("individual"),checked:true,events:{onChange:function(){if(this.isChecked()){f.companyToggle.setCheck(false);f.dispatchEvent("legalEntityTypeChanged","individual")}}}})},_createCompanyToggle:function(){var f=this;return new c({className:"primary",name:"companyToggle",value:"company",label:b.get("company"),checked:false,events:{onChange:function(){if(this.isChecked()){f.individualToggle.setCheck(false);f.dispatchEvent("legalEntityTypeChanged","company")}}}})}});return a});define("DS/MPFShopFormComponent/ShopInputs",["UWA/Core","UWA/String","UWA/Promise","UWA/Class/View","DS/UIKIT/Tooltip","DS/MPFShopModel/ShopModel","DS/MPFModelFactory/ShopFactory","DS/MPFModelFactory/ShopServiceFactory","DS/MPFCurrencySelectComponent/CurrencySelectComponent","DS/MPFView/FieldTextInputV2","DS/MPFServices/ObjectService","i18n!DS/MPFShopFormComponent/assets/nls/ShopFormComponent","css!DS/MPFShopFormComponent/MPFShopFormComponent"],function(g,i,h,c,e,l,k,j,a,b,f,m){var d=c.extend({className:"mpf-shop-inputs",domEvents:{'change input[name="shopName"]':"_onShopChange",'change input[name="email"]':"_onShopChange",'change input[name="phoneNumber"]':"_onShopChange",'change select[name="supportedCurrencies"]':"_onShopChange"},setup:function(n){n||(n={});f.requiredOfPrototype(n.shopModel,l,"options.shopModel must be a ShopModel");f.requiredOfPrototype(n.shopFactory,k,"options.shopFactory must be a ShopFactory");f.requiredOfPrototype(n.shopServiceFactory,j,"options.shopServiceFactory must be a ShopServiceFactory");this._parent(n);this.shopModel=n.shopModel;this.shopFactory=n.shopFactory;this.shopServiceFactory=n.shopServiceFactory;this.serviceTerm=g.is(n.serviceTerm,"string")?n.serviceTerm:m.get("lab");this.labNameInput=this._createLabNameInput();this.emailInput=this._createEmailInput();this.phoneInput=this._createPhoneInput();this.currencySelectComponent=this._createCurrencySelect();this.shopHasChanged=false},render:function(){this.container.setContent([this.labNameInput.render(),this.emailInput.render(),this._displayInfoMessages("emailPhoneInfo"),this.phoneInput.render(),this.currencySelectComponent.render()]);this._displayCurrencyTooltip();this._checkCurrencyLock();return this},disable:function(n){var o;o=n!==false;this.labNameInput.setDisabled(o);this.emailInput.setDisabled(o);this.phoneInput.setDisabled(o);this.currencySelectComponent.setReadOnly(o)},save:function(n){var o=this;if(this.validate()){this.shopModel.setOwner(n.ownerID);this.shopModel.setAddress(n.addressID);this.shopModel.unset(l.Fields.IS_COMPANY);if(this.shopModel.isNew()){return this.shopModel.savePromise().then(function(){var p;o.shopHasChanged=false;p=o.shopServiceFactory.createModel("shop");p.parentResourceId=o.shopModel.get("id");return p.savePromise()})}else{if(this.shopHasChanged){this.shopModel.dataProxy=this.shopFactory.getDataProxy("shop");return this.shopModel.savePromise(null,{method:"PUT"}).then(function(p){o.shopHasChanged=false})}else{return h.resolve()}}}else{return h.reject("Shop validation failed")}},validate:function(){var q;var o;var p;var n;q=this.labNameInput.validate().isValid;o=this.emailInput.validate().isValid;p=this.phoneInput.validate().isValid;n=this.currencySelectComponent.validate().isValid;return q&&o&&p&&n},_checkCurrencyLock:function(){var n;n=g.is(this.shopModel.getServices())&&g.is(this.shopModel.getServices().products)&&(this.shopModel.getServices().products.length>0);if(n){this.currencySelectComponent.setReadOnly(true)}},_displayCurrencyTooltip:function(){var o;var n;n=this.container.getElement(".mpf-select-v2 .fonticon-info-circled");if(!g.is(n)){n=g.createElement("span",{"class":"fonticon fonticon-info-circled"});n.inject(this.container.getElement(".mpf-select-v2 .mpf-label"));o=new e({position:"right",target:n,body:m.get("currencyInfo")});return o}},_onShopChange:function(){this.shopHasChanged=true},_displayInfoMessages:function(n){return g.createElement("div",{"class":"mpf-infoData "+n,html:[g.createElement("span",{"class":"fonticon fonticon-info-circled"}),"&nbsp;",i.format(m.get(n),this.serviceTerm)]})},_createLabNameInput:function(){var n=i.ucfirst(i.format(m.get("serviceName"),this.serviceTerm));return new b({model:this.shopModel,fieldName:l.Fields.NAME,fieldLabel:n,required:true,readOnly:!(this.shopModel.getState()!==l.States.SUBMITTED),dynamicValidation:true,maxlength:40,silent:false})},_createEmailInput:function(){return new b({model:this.shopModel,fieldName:l.Fields.EMAIL,fieldLabel:m.get("emailAddress"),required:true,readOnly:!(this.shopModel.getState()!==l.States.SUBMITTED),dynamicValidation:true})},_createPhoneInput:function(){return new b({model:this.shopModel,fieldName:l.Fields.PHONE_NUMBER,fieldLabel:m.get("phoneNumber"),required:false,readOnly:!(this.shopModel.getState()!==l.States.SUBMITTED)})},_createCurrencySelect:function(){return new a({model:this.shopModel})},destroy:function(){this.model=null;this._parent();this.container=null}});return d});define("DS/MPFShopFormComponent/ShopFormComponent",["UWA/Core","UWA/String","UWA/Promise","UWA/Class/View","DS/MPFLegalEntityType/LegalEntityType","DS/MPFCountryModel/CountryCollection","DS/MPFShopModel/ShopModel","DS/MPFCompanyModel/CompanyModel","DS/MPFAddressModel/AddressModel","DS/MPFPersonModel/PersonModel","DS/MPFModelFactory/AddressFactory","DS/MPFModelFactory/ShopFactory","DS/MPFModelFactory/ShopServiceFactory","DS/MPFAddressFormComponent/AddressFormComponentV2","DS/MPFCompanyComponent/CompanyShopForm","DS/MPFShopFormComponent/ShopInputs","DS/MPFPersonComponent/PersonNameForm","DS/UIKIT/Alert","DS/UIKIT/Mask","DS/PlatformAPI/PlatformAPI","DS/MPFServices/ObjectService","DS/MPFError/ValidationError","i18n!DS/MPFShopFormComponent/assets/nls/ShopFormComponent","css!DS/MPFShopFormComponent/MPFShopFormComponent"],function(s,r,a,g,x,u,n,d,o,y,i,v,q,j,k,h,c,m,z,b,t,l,p){var e={};e.MAKE="MAKE";e.ENGINEERING="ENGINEERING";function f(E,A){var C;var B;var D;t.requiredOfPrototype(E,n,"shop must be a ShopModel");t.requiredOfPrototype(A,d,"company must be a CompanyModel");B=s.is(A)&&!(A.isNew())&&s.is(A.getName())&&s.is(A.getCeoFirstName())&&s.is(A.getCeoLastName());D=s.is(E)&&!(E.isNew())&&s.is(E.getName())&&s.is(E.getEmail())&&s.is(E.getSupportedCurrencies())&&E.getSupportedCurrencies().length>0&&s.is(E.getAddress());C=B&&D;return C}var w=g.extend({className:"mpf-form mpf-shop-form mpf-horizontal",tagName:"form",domEvents:{'change select[name="country"]':"_onCountryChange",'change input[name*="addressLine"]':"_onAddressChange",'change input[name="city"]':"_onAddressChange",'change input[name="state"]':"_onAddressChange",'change select[name="state"]':"_onAddressChange",'change input[name="postalCode"]':"_onAddressChange"},setup:function(A){A||(A={});this._checkPrototypes(A);this._parent(A);this.service=A.service?A.service.toUpperCase():e.MAKE;this.addressFactory=A.addressFactory;this.shopFactory=A.shopFactory;this.shopServiceFactory=A.shopServiceFactory;this.me=A.me;this.shopModel=this.model;this.countries=A.countries;this.companyModel=A.companyModel;this.addressModel=A.addressModel;this.serviceTerm=s.is(A.serviceTerm,"string")?A.serviceTerm:p.get("lab");this.isCompanyReadOnly=!!this.companyModel.getDrupalId();this.legalEntityType=x.COMPANY;this.isLegalEntityTypeDetermined=true;this.legalEntityForm=this._createLegalEntityForm();this.addressForm=this._createAddresFormComponent();this.shopForm=this._createShopInputs();this.addressHasChanged=false},render:function(){var A=[];A.push([this.legalEntityForm.render(),this._displayInfoMessages(),this.shopForm.render(),this.addressForm.render()]);this.container.setContent(A);return this},validate:function(){var A;var C;var B;A=this.legalEntityForm.validate();C=this.addressForm.validate();B=this.shopForm.validate();return A&&C&&B},save:function(){var D=this;var B=a.deferred();var C=this.shopModel.isCompany();var E=this.validate();var A={};if(E){this.legalEntityForm.save().then(this._saveAddressForm.bind(this)).then(function(){D.addressHasChanged=false;A.addressID=D.addressModel.get("id");if(C){A.ownerID=D.companyModel.get("id")}else{A.ownerID=D.me.get("id")}return D.shopForm.save(A)}).then(function(F){var G=[];if(C){G.push(D.companyModel)}else{G.push(D.me)}G.push(D.addressModel);G.push(D.shopModel);if(F){G.push(F)}B.resolve(G);b.publish("labInfoPage",{completed:true});b.publish("newLabCreated",{id:D.model.id})})["catch"](function(F){var G;if(Error.prototype.isPrototypeOf(F)){G=F.toString()||p.get("errorMsg")}else{G=p.get("errorMsg");F=new Error(G)}new m({closable:true,className:"error",visible:true,messages:{className:"error",message:G}}).inject(D.container,"top");B.reject(F)})}else{B.reject(new l("ShopFormComponent validation failed"))}return B.promise},_onTypeChanged:function(A){if(A==="company"){this.legalEntityForm=this._createCompanyForm();this.shopModel.set(n.Fields.IS_COMPANY,true)}else{if(A==="individual"){this.legalEntityForm=this._createPersonForm();this.shopModel.set(n.Fields.IS_COMPANY,false)}}this.render()},_saveAddressForm:function(){var A=this.shopModel.isCompany();if(this.addressModel.isNew()){if(A){this.addressModel.dataProxy=this.addressFactory.getDataProxy("companyAddress");this.addressModel.parentResourceId=this.companyModel.get("id");return this.addressForm.savePromise()}else{this.addressModel.dataProxy=this.addressFactory.getDataProxy("me");return this.addressForm.savePromise()}}else{if(this.addressHasChanged){this.addressModel.dataProxy=this.addressFactory.getDataProxy("address");return this.addressForm.savePromise({method:"PUT"})}else{return a.resolve()}}},_createAddresFormComponent:function(){return new j({addressModel:this.addressModel,addressConstraints:this.addressFactory.getConstraints(),countries:this.countries,countryReadOnly:this.isCompanyReadOnly,readOnly:this.isCompanyReadOnly,horizontalLayout:true})},_createShopInputs:function(){return new h({shopModel:this.shopModel,shopFactory:this.shopFactory,shopServiceFactory:this.shopServiceFactory,serviceTerm:this.serviceTerm})},_createLegalEntityForm:function(){if(this.isLegalEntityTypeDetermined){if(s.equals(this.legalEntityType,x.COMPANY)){this.shopModel.set(n.Fields.IS_COMPANY,true);return this._createCompanyForm()}else{if(s.equals(this.legalEntityType,x.INDIVIDUAL)){this.shopModel.set(n.Fields.IS_COMPANY,false);return this._createPersonForm()}}}else{this.shopModel.set(n.Fields.IS_COMPANY,false);return this._createPersonForm()}},_createPersonForm:function(){return new c({model:this.me,required:true,readOnly:true,lockSave:true,horizontalLayout:true})},_createCompanyForm:function(){return new k({model:this.companyModel,readOnly:this.isCompanyReadOnly})},_getLegalEntityType:function(){return x.fromPerson(this.me)},_displayInfoMessages:function(){return s.createElement("div",{"class":"mpf-infoData ceoInfo",html:[s.createElement("span",{"class":"fonticon fonticon-info-circled"}),"&nbsp;",p.get("ceoInfo"),s.createElement("br"),s.createElement("br"),r.ucfirst(r.format(p.get("shopNameInfo"),r.ucfirst(r.format(p.get("serviceName"),this.serviceTerm))))]})},_onAddressChange:function(A){this.addressHasChanged=true},_onCountryChange:function(){this.companyModel.setCountry(this.addressModel.getCountry());this._onAddressChange()},_checkPrototypes:function(A){t.requiredOfPrototype(A.me,y,"options.me must be a PersonModel");t.requiredOfPrototype(this.model,n,"this.model must be a ShopModel");t.requiredOfPrototype(A.countries,u,"options.countries must be a CountryCollection");t.requiredOfPrototype(A.addressModel,o,"options.addressModel must be an AddressModel");t.requiredOfPrototype(A.companyModel,d,"options.companyModel must be a CompanyModel");t.requiredOfPrototype(A.addressFactory,i,"options.addressFactory must be an AddressFactory");t.requiredOfPrototype(A.shopFactory,v,"options.shopFactory must be a ShopFactory");t.requiredOfPrototype(A.shopServiceFactory,q,"options.shopServiceFactory must be a ShopServiceFactory")},destroy:function(){this.model=null;this._parent();this.container=null}});w.isCompleted=f;return w});define("DS/MPFShopFormComponent/ShopFormFactory",["UWA/Class","UWA/Promise","DS/MPFDataProxy/Connector","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFShopFormComponent/ShopFormComponent","DS/MPFServices/ObjectService"],function(c,f,b,e,a,d){var g={};g.MAKE="MAKE";g.ENGINEERING="ENGINEERING";var h=c.extend({init:function(i){i||(i={});d.requiredOfPrototype(i.connector,b,"options.connector must be a Connector");this.connector=i.connector;this.service=i.service?i.service.toUpperCase():g.MAKE;this.isCompanyReadOnly=i.isCompanyReadOnly===true;this.isReadOnly=i.isReadOnly===true;this.factoryDispenser=e.getInstance(this.connector)},fromMe:function(i){return this._initFactoriesAndFetchCountries().then(this._fetchMe.bind(this)).then(this._fetchMyCompany.bind(this)).then(this._getCompanyAddressesAsCollection.bind(this)).then(this._getCompanyAddress.bind(this)).then(this._fetchMyShops.bind(this)).then(this._fetchMyShop.bind(this,i)).then(this._buildShopFormComponent.bind(this))},fromShopId:function(i){return this._initFactoriesAndFetchCountries().then(this._fetchShop.bind(this,i)).then(this._fetchCompanyFromShop.bind(this)).then(this._getCompanyAddressesAsCollection.bind(this)).then(this._getCompanyAddress.bind(this)).then(this._fetchMe.bind(this)).then(this._buildShopFormComponent.bind(this))},_initFactoriesAndFetchCountries:function(){var i=this;return f.all([this.factoryDispenser.getFactory(e.Types.PERSON),this.factoryDispenser.getFactory(e.Types.COUNTRY),this.factoryDispenser.getFactory(e.Types.SHOP),this.factoryDispenser.getFactory(e.Types.SHOP_SERVICE),this.factoryDispenser.getFactory(e.Types.COMPANY),this.factoryDispenser.getFactory(e.Types.ADDRESS)]).then(function(j){i.personFactory=j[0];i.countryFactory=j[1];i.shopFactory=j[2];i.shopServiceFactory=j[3];i.companyFactory=j[4];i.addressFactory=j[5];i.companyFactory.addressFactory=i.addressFactory;i.countries=i.countryFactory.createCollection("seller");return i.countries.fetchPromise()})["catch"](function(j){console.error(j);return f.reject("error init factories")})},_fetchMe:function(){this.me=this.personFactory.createModel("me");return this.me.fetchPromise()},_fetchMyCompany:function(){var j;var i;i=this.me.getCompany();if(i){j=this._fetchCompanyFromRef(i)}else{this.company=this.companyFactory.createModel("me");j=f.resolve(this.company)}return j},_fetchCompanyFromRef:function(i){var k;var j;k=i.match(/[A-Z0-9]{32}$/)||[];j=k.pop();this.company=this.companyFactory.createModel(null,{id:j},{addressFactory:this.addressFactory});return this.company.fetchPromise()},_getCompanyAddressesAsCollection:function(){var i;i=this.company.addresses?this.company.addresses.toArray():[];this.companyAddresses=this.addressFactory.createCollection("company",i);this.companyAddresses.parentResourceId=this.company.id},_getCompanyAddress:function(){if(this.companyAddresses.isEmpty()){this.companyAddress=this.addressFactory.createModel("company");this.companyAddress.parentResourceId=this.company.id}else{this.companyAddress=this.companyAddresses.first()}return f.resolve(this.companyAddress)},_fetchMyShops:function(){this.shops=this.shopFactory.createCollection("me");return this.shops.fetchPromise({expand:[]})},_fetchMyShop:function(i){if(this.shops.isEmpty()){this.shop=this.shopFactory.createModel("me")}else{this.shop=this.shops.get(i)||this.shops.first()}return f.resolve(this.shop)},_fetchShop:function(i){this.shop=this.shopFactory.createModel("shop",{id:i});return this.shop.fetchPromise({expand:[]})},_fetchCompanyFromShop:function(){var i;i=this.shop.getOwner();return this._fetchCompanyFromRef(i)},_buildShopFormComponent:function(){return new a({service:this.service,me:this.me,model:this.shop,shopFactory:this.shopFactory,shopServiceFactory:this.shopServiceFactory,countries:this.countries,companyModel:this.company,addressModel:this.companyAddress,addressFactory:this.addressFactory})}});return h});