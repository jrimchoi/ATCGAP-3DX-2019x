define("DS/VCXWebVolatileGhosting/VCXVolatileGhostingManager",["DS/CoreEvents/Events","DS/WebApplicationBase/W3AAManager","DS/VisuEvents/EventsManager","DS/VCXWebExperienceBase/VCXOverridesChangeServices","DS/Visualization/ThreeJS_DS","DS/VCXWebModifiablesServices/VCXModifiablesAccess","DS/VCXWebExperienceBase/VCXSceneGraphOverridesServices","DS/VCXWebVisibility/VCXIVisibility"],function(c,h,d,a,i,j,b,g){var f={NONE:0,KEY:1,CMD:2};var k={UP:0,DOWN:1,REPEAT:2};var e=h.extend({init:function(){this._keepGhostCommand=false;this._allowTAB=false;this._allowMouseClick=false},initialize:function(){this._SceneGraphOverrideSet=null;this._setGhost=[];this._mode=f.NONE;this._shooting=false;this._timeStart=null;this._keyState=k.UP;this._tokenCmdChange=null;this._tokenCSOChange=null;this._mouseEvent=null;this._mouseMoveWhileLeftButtonPressed=false;this._mouseMoveWhileRightButtonPressed=false;this._keepGhostCommand=false;this._LMBx=-1;this._LMBy=-1;this._RMBx=-1;this._RMBy=-1;this._zoomCBToken=null;this._allowTAB=false;this._allowMouseClick=false},postInitialize:function(){var l=this._experienceBase.getManager("VCXContextManager").getMainViewer();if(l){l.setPrePicking({activated:true,displayHL:true,gpu:true,computeNormalDepth:false,primitive:false})}this.addCallbacks()},addCallbacks:function(){var l=this;this._onKeydownEvent=function(q){l.onKeydownEvent(q)};this._onKeyupEvent=function(q){l.onKeyupEvent(q)};this._onMousedownEvent=function(q){l.onMousedownEvent(q)};this._onMouseupEvent=function(q){l.onMouseupEvent(q)};this._onMousemoveEvent=function(q){l.onMousemoveEvent(q)};this._onMousewheelEvent=function(q){l.onMousewheelEvent(q)};var p=this._experienceBase.getManager("VCXContextManager").getMainViewer();if(p){this._tokenCmdChange=c.subscribe({event:"GHOSTABLE_CHANGE"},function(q){l.onGhostableChange(q)});addEventListener("keydown",this._onKeydownEvent);addEventListener("mousemove",this._onMousemoveEvent);var n="onwheel" in document.createElement("div")?"wheel":document.onmousewheel!==undefined?"mousewheel":"DOMMouseScroll";if(n=="mousewheel"){window.addEventListener(n,this._onMousewheelEvent,true)}else{addEventListener(n,this._onMousewheelEvent,true)}var m=p.currentViewpoint;if(m&&m.control){var o=function(q){if(q&&q.factor){if(q.evt&&q.evt.event&&q.evt.event.altKey){q.defaultBehavior=false}}};this._zoomCBToken=m.control._modelEvent.subscribe({event:"Zoom"},o)}}},unInitialize:function(){this.removeCallbacks();var l=this._experienceBase.getManager("VCXContextManager").getMainViewer();if(l){l.setPrePicking({activated:false,displayHL:true,gpu:true,computeNormalDepth:false,primitive:false})}},removeCallbacks:function(){if(this._zoomCBToken){var n=this._experienceBase.getManager("VCXContextManager").getMainViewer();if(n){var m=n.currentViewpoint;if(m&&m.control){m.control._modelEvent.unsubscribe(this._zoomCBToken)}}}c.unsubscribe(this._tokenCmdChange);this._tokenCmdChange=null;removeEventListener("keydown",this._onKeydownEvent);removeEventListener("keyup",this._onKeyupEvent);removeEventListener("mousedown",this._onMousedownEvent);removeEventListener("mouseup",this._onMouseupEvent);removeEventListener("mousemove",this._onMousemoveEvent);var l="onwheel" in document.createElement("div")?"wheel":document.onmousewheel!==undefined?"mousewheel":"DOMMouseScroll";if(l=="mousewheel"){window.removeEventListener(l,this._onMousewheelEvent,true)}else{removeEventListener(l,this._onMousewheelEvent,true)}},setKeepGhostCommand:function(l){this._keepGhostCommand=l},setAllowTAB:function(l){this._allowTAB=l},setAllowMouseClick:function(l){this._allowMouseClick=l},hasVolatileGhostingToRestore:function(){if(this._setGhost===undefined){console.error("Volatile Ghosting: Initialize() was not called before use");return false}var l=this._setGhost.length!==0;return l},resetVolatileGhosting:function(q){if(q===undefined){q=false}if(this.hasVolatileGhostingToRestore()){b.removeSceneGraphOverrideSet(this._experienceBase,this._SceneGraphOverrideSet);this._SceneGraphOverrideSet=null;if(!q){this._setGhost=[]}else{var p=this._setGhost.length;while(p>0){var o=this._setGhost[this._setGhost.length-1];var n=j.GetModifiableFromPathElement(o,this._experienceBase);if(n){var m=n.GetObject();if(m){var l=m.QueryInterface("VCXIVisibility");if(l){l.SetVisibility(g.EVisState.Hidden)}}this._setGhost.pop();p--}}}}if(this._allowMouseClick){removeEventListener("mousedown",this._onMousedownEvent);removeEventListener("mouseup",this._onMouseupEvent)}this._mode=f.NONE;this._experienceBase.getManager("VCXContextManager").renderAll()},pick:function(p){if(p===undefined){p={}}if(p.invalidatePickingBuffer===undefined){p.invalidatePickingBuffer=false}if(p.x===undefined){if(!this._mouseEvent){return null}p.x=this._mouseEvent.clientX}if(p.y===undefined){if(!this._mouseEvent){return null}p.y=this._mouseEvent.clientY}var q=this._experienceBase.getManager("VCXContextManager").getMainViewer();if(!q){return null}var o=q.canvas.getBoundingClientRect();var m=new i.Vector2(p.x-o.left,p.y-o.top);if(p.invalidatePickingBuffer){q.invalidatePickingBuffer()}var l=q.pick(q.getMousePosition(m),"mesh",false);if(p.invalidatePickingBuffer){q.invalidatePickingBuffer()}var n=null;if(l&&l.path&&l.path.length>0&&l.path[0]){n=l.path[0];if(q.multiViewerFix===false){n.externalPath.splice(0,1)}n=j.BuildCleanedPathElement(n)}return n},ghostAndRefreshFromEvent:function(m){var l=this.pick({x:m.clientX,y:m.clientY});if(l){this.ghostAndRefresh(l)}},ghostAndRefresh:function(n){if(n===undefined){n=this.pick();if(!n){return}}for(var m=0;m<this._setGhost.length;m++){if(this._setGhost[m]===n){return false}}if(!this._SceneGraphOverrideSet){this._SceneGraphOverrideSet=b.createAndPushSceneGraphOverrideSet(this._experienceBase)}var l=a.Ghost(this._SceneGraphOverrideSet,n);if(l){this._setGhost.push(n);this.updatePreHighlight();this._experienceBase.getManager("VCXContextManager").renderAll()}return l},unGhostAndRefresh:function(){if(!this.hasVolatileGhostingToRestore()){return false}var m=this._setGhost.pop();var l=false;if(m){l=a.UnGhost(this._SceneGraphOverrideSet,m);if(l){this.updatePreHighlight();this._experienceBase.getManager("VCXContextManager").renderAll()}}return l},updatePreHighlight:function(){WUX.Selection.PSOManager.empty();var l=this.pick({invalidatePickingBuffer:true});if(l){WUX.Selection.PSOManager.add({pathElement:l})}},onKeydownEvent:function(m){if((m.keyCode===18)||((m.keyCode===71||m.keyCode===103)&&m.altKey)||((this._allowTAB&&m.keyCode===9))){if(this._mode===f.CMD){return}m.preventDefault();if(this._mode!==f.KEY){this._mode=f.KEY;if(this._allowMouseClick&&(this._allowTAB&&m.keyCode===9)){addEventListener("mousedown",this._onMousedownEvent);addEventListener("mouseup",this._onMouseupEvent)}}if(m.keyCode!==18){if(!this._shooting){if(this._timeStart&&(this._keyState===k.UP)){var l=new Date().getTime();if(l-this._timeStart<200){this._shooting=true}this._timeStart=null}}if(this._keyState===k.UP){this._keyState=k.DOWN}else{if(this._keyState===k.DOWN){this._keyState=k.REPEAT;this._experienceBase.getManager("VCXContextManager").getMainViewer().setPicking({activated:false,})}}if(!(this._keyState===k.REPEAT&&!this._shooting)){if(m.shiftKey){if(this._allowTAB&&m.keyCode===9){this.unGhostAndRefresh()}}else{this.ghostAndRefresh()}}if(!this._shooting){if(!this._timeStart){this._timeStart=new Date().getTime()}}}addEventListener("keyup",this._onKeyupEvent)}else{if(this._keepGhostCommand&&m.keyCode===75){this.resetVolatileGhosting(true);this.updatePreHighlight();this._experienceBase.getManager("VCXContextManager").renderAll()}}},onKeyupEvent:function(l){if(this._mode===f.CMD){return}if((l.keyCode===18)||((l.keyCode===71||l.keyCode===103))||((this._allowTAB&&l.keyCode===9))){if(this._keyState===k.REPEAT){this._shooting=false;this._timeStart=null;this._experienceBase.getManager("VCXContextManager").getMainViewer().setPicking({activated:true,})}if(l.keyCode!==18){this._keyState=k.UP}if(!(l.altKey||(this._allowTAB&&this._keyState!==k.UP))&&!l.buttons&&!this.isOnGhostableObject()){this.resetVolatileGhosting()}}},onMousewheelEvent:function(l){if(l.altKey){l.preventDefault();var m=l.wheelDelta?l.wheelDelta/120:-(l.detail||l.deltaY||0)/3;if(m>0){this.ghostAndRefreshFromEvent(l)}else{this.unGhostAndRefresh()}}},onMousemoveEvent:function(l){this._mouseEvent=l;if(this._mode!==f.KEY){return}if(this._keyState!==k.UP){if(l.buttons&1){if(this._LMBx!==l.clientX||this._LMBy!==l.clientY){this._mouseMoveWhileLeftButtonPressed=true}}if(l.buttons&2){if(this._RMBx!==l.clientX||this._RMBy!==l.clientY){this._mouseMoveWhileRightButtonPressed=true}}}if(!(l.altKey||(this._allowTAB&&this._keyState!==k.UP))&&!l.buttons&&!this.isOnGhostableObject()){this.resetVolatileGhosting()}},onMousedownEvent:function(l){if(this._mode===f.KEY&&this._keyState===k.UP){return}if(l.which===1){this._mouseMoveWhileLeftButtonPressed=false;this._LMBx=l.clientX;this._LMBy=l.clientY}else{if(l.which===3){this._mouseMoveWhileRightButtonPressed=false;this._RMBx=l.clientX;this._RMBy=l.clientY}}},onMouseupEvent:function(l){if(this._mode===f.KEY&&this._keyState===k.UP){return}if(l.which===1&&!this._mouseMoveWhileLeftButtonPressed){this.ghostAndRefreshFromEvent(l)}else{if(l.which===3&&!this._mouseMoveWhileRightButtonPressed){this.unGhostAndRefresh()}}},isOnGhostableObject:function(){if(!this._SceneGraphOverrideSet){return false}var n=this._setGhost.length;for(var l=0;l<n;l++){var o=this._setGhost[l];a.Ghost(this._SceneGraphOverrideSet,o,false,undefined,1)}var m=this.pick({invalidatePickingBuffer:true});var n=this._setGhost.length;for(var l=0;l<n;l++){var o=this._setGhost[l];a.Ghost(this._SceneGraphOverrideSet,o,false,undefined,2)}if(m){return true}return false},doubleTapCallback:function(l){this.ghostAndRefreshFromEvent(l)},pointerUpCallback:function(l){this._functToCallpointerUp=function(m){l.ghostAndRefreshFromEvent(m)};return this._functToCallpointerUp},onGhostableChange:function(l){if(this._mode===f.KEY){return}if(l){this._mode=f.CMD;if(true){addEventListener("mouseup",this._onMouseupEvent)}else{d.addEvent(document,"onDoubleTap",this.pointerUpCallback(this))}removeEventListener("keydown",this._onKeydownEvent)}else{this.resetVolatileGhosting();addEventListener("keydown",this._onKeydownEvent)}},processGhostableClic:function(){}});Object.defineProperty(e.prototype,"componentType",{enumerable:true,get:function(){return"VCXVolatileGhostingManager"}});return e});define("DS/VCXWebVolatileGhosting/VCXVolatileGhostingCmd",["DS/CoreEvents/Events","DS/ApplicationFrame/CommandCheckHeader"],function(a,b){var c=b.extend({init:function(d){this._parent(d,{});var e=this;this.onStateChange(function(){a.publish({event:"GHOSTABLE_CHANGE",data:e.getState()})})},GetState:function(){return true}});return c});