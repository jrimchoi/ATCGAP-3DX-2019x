define("DS/StateCommandEngine/Xml2Json",["UWA/Core","UWA/Controls/Abstract","DS/WebappsUtils/WebappsUtils","DS/Core/ModelEvents","DS/Utilities/Xml"],function(g,f,d,e,b){var a=true;var c=f.extend({defaultOptions:{xml:null,module:null,directory:"assets/afr/",fileExtension:".xml",onFailure:null,onLoaded:null},init:function(h){this._parent(h);this.options=g.extend(this.defaultOptions,h);var i=this;i._initialize(h)},_initialize:function(i){this._modelEvents=new e();var h=window.location.href.split("/");this._currentModule=h[h.length-2];this._host=d.getWebappsBaseUrl();var k=this;var j=d.getWebappsBaseUrl()+(this.options.module||this._currentModule)+"/"+this.options.directory+this.options.xml;this._loadXML(j,function(l){k._model=l;k.options.onLoaded(l)})},getModel:function(){return this._model},_loadXML:function(i,l){var j=this;var k="Ajax";if(d.getWebappsBaseUrl()!=="../"){k="Data"}if(typeof this.options.xml==="string"){g[k].request(i,{isAsync:true,onComplete:function(o){o.replace(/<!--[\s\S]*?-->/g,"");var n=g.Utils.loadXml(o);var m=j._convertXml2Json(n);l.call(j,m)},onFailure:function(m){console.error("[!]\tError loading file:"+i);if(j.options.onFailure){j.options.onFailure.call(j,m)}}})}else{var h=j._convertXml2Json(this.options.xml);l.call(j,h)}},_convertXml2Json:function(i){var h=b.toJson(i);if(a){console.log("XML model",i);console.log("JSON model",h)}return h}});return c});define("DS/StateCommandEngine/StateCommandGraph",["DS/egraph/core","DS/egraph/views","DS/egraph/iact","DS/egraph/utils","UWA/Class","DS/CoreEvents/Events"],function(c,b,e,a,d,g){var f=d.extend({init:function(r){r.setHTML('<div id="graph_canvas" class="canvas"></div>');var p=document.createElement("link");p.type="text/css";p.rel="stylesheet";p.href="../StateCommandEngine/StateCommandGraph.css";document.getElementsByTagName("head")[0].appendChild(p);p=document.createElement("link");p.type="text/css";p.rel="stylesheet";p.href="../egraph/views.css";document.getElementsByTagName("head")[0].appendChild(p);p=document.createElement("link");p.type="text/css";p.rel="stylesheet";p.href="../egraph/views_default.css";document.getElementsByTagName("head")[0].appendChild(p);function i(){b.HTMLNodeView.call(this)}a.inherit(i,b.HTMLNodeView);i.prototype.buildNodeElement=function(z){var w=document.createElement("div");w.className="my-node";w.style.width="147px";w.style.height="120px";var t=document.createElement("div");t.className="my-node-header";t.appendChild(document.createTextNode(z.data.stateName));w.appendChild(t);var s=document.createElement("div");s.className="my-node-container";w.appendChild(s);var v=document.createElement("div");v.className="my-node-col left";v.innerHTML='<div class="my-node-text" style="top:0px;"></div>';s.appendChild(v);var x=document.createElement("div");x.className="my-node-col right";var y="";for(var u=0;u<z.data.outputsName.length;u++){y+='<div class="my-node-text" style="top:'+30*u+'px;">'+z.data.outputsName[u]+"</div>"}x.innerHTML=y;s.appendChild(x);return w};function n(s,B,w){var A;A=new c.Node();A.views.main=new i();A.data={stateName:w.stateName};A.data.outputsName=[];if(w.outputsName){w.outputsName.forEach(function(x){A.data.outputsName.push(x)})}var u=A.data.outputsName.length;var t=1;A.multiset("left",s,"top",B,"width",150,"height",60+Math.max(t,u)*30);A.data.inputs=[];for(var z=0;z<t;z++){A.data.inputs[z]=l(c.BorderCstr.LEFT,z);A.appendConnector(A.data.inputs[z])}A.data.outputs=[];for(var v=0;v<u;v++){A.data.outputs[v]=l(c.BorderCstr.RIGHT,v);A.appendConnector(A.data.outputs[v])}return A}function l(t,v){var s,u;u=30+2+17+15/2+30*v;s=new c.Connector();s.views.main=new b.SVGConnView();s.multiset(["cstr","attach"],t,["cstr","offset"],u);return s}function h(t,s){var u;u=new c.Edge();u.views.main=new b.SVGEdgeView();j.addEdge(t,s,u);return u}var j,k;j=new c.EGraph();j.addView("main",new b.HTMLGraphView(document.querySelector("#graph_canvas")));k=new e.StateMachine(j,null,null,j.views.main);k.rootState.newDragForElement=function(){};k.pick.pick=function(t,s,z){var y,w,v,x,A,u;for(y=z;y.parentNode;y=y.parentNode){}if(y.elementFromPoint){w=y.elementFromPoint(t,s)}for(v=w;v&&v!==z;v=v.parentNode){if(!x&&v.grElt){x=v.grElt;A=v.subElt}}u=v===z;if(!u){x=null}return{inside:u,grElt:null,subElt:null}};var q=this;var m=function(u){if(u.buildGraph){var s=function(v){q.nodes[q.currentNode].views.main.elts.node.children[0].className="my-node-header";q.nodes[v].views.main.elts.node.children[0].className+=" my-node-header-activ";q.currentNode=v};var t=function(D){console.log("onBeginOfStateCommandFunction : ",D);if(D===u._getInitialStateId()){var E={};var C=[];for(var B=0;B<u._transition[D].length;B++){if(u._transition[D][B].triggerEvent){C.push(u._transition[D][B].triggerEvent)}else{C.push(B)}}E[D]={stateName:D,outputsName:C,rankForNode:0,lineInGraph:0};var A=[];A[0]={lineInGraph:0};for(var w in u._transition){if(w!==D){var K=[];for(var B=0;B<u._transition[w].length;B++){if(u._transition[w][B].triggerEvent){K.push(u._transition[w][B].triggerEvent)}else{K.push(B)}}E[w]={stateName:w,outputsName:K}}}E[u.FINAL_STATE_ID]={stateName:u.FINAL_STATE_ID};var J=function(y){var x=y.finalState.stateId;if(!E[x].rankForNode){E[x].rankForNode=E[y.initState.stateId].rankForNode+1;if(!A[E[x].rankForNode]){A[E[x].rankForNode]={lineInGraph:0,nbLineMax:0};E[x].lineInGraph=0}else{E[x].lineInGraph=A[E[x].rankForNode].lineInGraph+1;A[E[x].rankForNode].lineInGraph++}if(u._transition[x]){u._transition[x].forEach(J)}}};u._transition[D].forEach(J);q.nodes={};for(var N in E){if(N===D){q.nodes[N]=n(15,30,E[N])}else{var M=0;if(E[N].lineInGraph>0){for(var I in E){if(E.hasOwnProperty(I)){if(E[I].rankForNode===E[N].rankForNode&&E[I].lineInGraph<E[N].lineInGraph){if(E[I].outputsName){M=M+(E[I].outputsName.length>0?E[I].outputsName.length:1)}else{M++}}}}}var F=30+E[N].lineInGraph*90+M*30;var H=15+200*E[N].rankForNode;q.nodes[N]=n(H,F,E[N])}}var v=[];j.updateLock();try{for(var z in q.nodes){j.addNode(q.nodes[z])}for(var w in u._states){var G=u._getTransitionsTabForState(w);if(G){var B=0;G.forEach(function(x){if(x.initState===x.finalState){v.push(q.nodes[x.initState.stateId].data.outputs[B])}else{if(q.nodes[x.initState.stateId].data.outputs[B]&&q.nodes[x.finalState.stateId].data.inputs[0]){h(q.nodes[x.initState.stateId].data.outputs[B],q.nodes[x.finalState.stateId].data.inputs[0])}}B++})}}}finally{j.updateUnlock();v.forEach(function(x){a.classListAdd(x.views.main.elts.elt,"transitive")})}var L=200*A.length;r.style.width=String(L)+"px";q.currentNode=D;q.nodes[D].views.main.elts.node.children[0].className+=" my-node-header-activ";u.unsubscribe(q.currentToken);q.currentToken=u.subscribe({event:"changeState"},s)}};q.currentToken=u.subscribe({event:"changeState"},t)}};g.subscribe({event:"/WUX/AFR/CMD/BEGIN/"},m);var o=function(s){if(s.buildGraph){s.unsubscribe(q.currentToken);j.updateLock();try{for(var t in q.nodes){if(q.nodes.hasOwnProperty(t)){j.removeNode(q.nodes[t])}}}finally{j.updateUnlock()}q.currentToken=null;q.nodes={};q.currentNode=null}};g.subscribe({event:"/WUX/AFR/CMD/END/"},o)}});return f});define("DS/StateCommandEngine/UndoRedoManager",["UWA/Core","DS/Core/ActionsStack","DS/Core/ModelEvents"],function(d,a,c){var b=a.singleton({init:function(){this._parent();this._isInit=true;this._commandRank=0;this._commandNumber=0;this._commandLimit=6;this._modelEvents=new c();var e=this;d.Element.addEvent.call(document,"keydown",function(g){var f=d.Event.whichKey(g);if(f==="ctrl+y"){if(e._index===-1){e.relativeGlobalUndoRedo(1);e._modelEvents.publish({event:"UndoRedoManagerNewCommandRank",data:{commandRank:e._commandRank,commandNumber:e._commandNumber}})}else{if(e._stack[e._index].step==="endCommand"){e.relativeGlobalUndoRedo(1);e._modelEvents.publish({event:"UndoRedoManagerNewCommandRank",data:{commandRank:e._commandRank,commandNumber:e._commandNumber}})}else{e.relativeLocalUndoRedo(1);e._modelEvents.publish({event:"UndoRedoManagerNewIndex",data:{commandRank:e._commandRank,commandNumber:e._commandNumber}})}}}else{if(f==="ctrl+z"){if(e._index>0){if(e._stack[e._index].step==="endCommand"){e.relativeGlobalUndoRedo(-1);e._modelEvents.publish({event:"UndoRedoManagerNewCommandRank",data:{commandRank:e._commandRank,commandNumber:e._commandNumber}})}else{if(e._stack[e._index-1].step==="endCommand"&&e._commandRank===e._commandNumber){e.cleanInterruptedEnd();e.relativeGlobalUndoRedo(-1);e._modelEvents.publish({event:"UndoRedoManagerNewCommandRank",data:{commandRank:e._commandRank,commandNumber:e._commandNumber}})}else{e.relativeLocalUndoRedo(-1);e._modelEvents.publish({event:"UndoRedoManagerNewIndex",data:{commandRank:e._commandRank,commandNumber:e._commandNumber}})}}}}}})},pushAction:function(e){if(!this._isRunning){var f;for(f=this._index+1;f<this._stack.length;f++){var g=this._stack[f];g.undoRedoObjectStack._stack.splice(g.undoRedoObjectStack._index+1,g.undoRedoObjectStack._stack.length-g.undoRedoObjectStack._index)}this._parent(e,null);this._stack[this._index].undoRedoObjectStack=e.undoObj;this._stack[this._index].step=e.step;if(this._stack[this._index].step==="endCommand"){this._commandRank++;if(this._commandNumber!==this._commandLimit){this._commandNumber++}if(this._commandRank>this._commandLimit){while(this._stack[0].step!=="endCommand"){this._stack[0].undoRedoObjectStack._stack.splice(0,1);this._stack[0].undoRedoObjectStack._index--;this._stack.splice(0,1);this._index--}this._stack[0].undoRedoObjectStack._stack.splice(0,1);this._stack[0].undoRedoObjectStack._index--;this._stack.splice(0,1);this._index--;this._commandRank--}}this._modelEvents.publish({event:"UndoRedoManagerNewItem",data:[]})}},undo:function(){this._parent();if(this._index===-1){this._commandRank--}else{if(this._stack[this._index].step==="endCommand"){this._commandRank--}}},redo:function(){this._parent();if(this._stack[this._index].step==="endCommand"){this._commandRank++}},absoluteLocalUndoRedo:function(g){if(g===parseInt(g)){if(g>=0){if(g>(this._stack.length-this._index-1)){for(var f=0;f<(g-(this._stack.length-this._index-1));f++){this.undo()}}else{if(g<(this._stack.length-this._index-1)){for(var e=0;e<((this._stack.length-this._index-1)-g);e++){this.redo()}}}}}},absoluteGlobalUndoRedo:function(e){while(e!==this._commandRank){if(e-this._commandRank>0){this.redo()}else{if(e-this._commandRank<0){this.undo()}}}},relativeLocalUndoRedo:function(g){if(g===parseInt(g)){if(g>0){for(var f=0;f<g;f++){this.redo()}}else{if(g<0){for(var e=0;e>g;e--){this.undo()}}}}},relativeGlobalUndoRedo:function(f){var e=this._commandRank;while(e+f!==this._commandRank){if(f>0){if(this._commandRank===this._commandNumber){break}this.redo()}else{if(f<0){if(this._index===-1){break}this.undo()}}}},cleanInterruptedEnd:function(){if(this._index!==-1){while(this._stack[this._index].step!=="endCommand"){this.undo();this._stack[this._index+1].undoRedoObjectStack._stack.splice(this._stack[this._index+1].undoRedoObjectStack._index+1,this._stack[this._index+1].undoRedoObjectStack._stack.length-this._stack[this._index+1].undoRedoObjectStack._index);this._stack.splice(this._index+1,this._stack.length-this._index);if(this._index===-1){break}}if(!this._isRunning){this._modelEvents.publish({event:"UndoRedoManagerNewItem",data:[]})}}}});return b});define("DS/StateCommandEngine/XmlModelsTools",["UWA/Core"],function(b){var a={arrayUnique:function(f){var c=f.concat();for(var e=0;e<c.length;++e){for(var d=e+1;d<c.length;++d){if(c[e]===c[d]){c.splice(d--,1)}}}return c},isArray:function(c){return Object.prototype.toString.call(c)==="[object Array]"},getTag:function(c){return c["@tag"]},getChildren:function(c){return c["@children"]},getAttribute:function(c,d){if(c&&c["@attributes"]){return c["@attributes"][d]}},getAttributes:function(c){if(c){return c["@attributes"]}else{return{}}},printDepth:function(h,g,f,e){var c="";for(var d=0;d<h;d++){c=c+"    "}c=c+"|--"},searchTag:function(g,e){var c;var d=g["@children"];var f=this;d.some(function(i,h,j){if(f.getTag(i)===e){c=i;return true}return false});return c}};return b.namespace("StateCommandEngine/XmlModelsTools",a)});define("DS/StateCommandEngine/DialogAgent",["UWA/Core","UWA/Class","DS/Core/ModelEvents"],function(d,a,b){var c=a.extend({init:function(f){var e={agentId:null};this.options=d.extend(e,f);this._parent(this.options);this._agentId=this.options.agentId;this._activated=false;this._modelEvents=new b()},activate:function(e){if(!this._activated){this._activated=true;if(this.activateAgentControl&&!e){this.activateAgentControl()}}},deactivate:function(){if(this._activated){this._activated=false;if(this.deactivateAgentControl){this.deactivateAgentControl()}}}});return c});define("DS/StateCommandEngine/DE2NamingMap",["UWA/Core"],function(b){var a={behaviorCorrespondence:{CATDE2EngWithPSOHSO:"engWithPSOHSO",CATDE2WithPSO:"withPSO",CATDE2WithHSO:"withHSO",CATDE2ValuedFromCSO:"valuedFromCSO",CATDE2MultiAcquisition:"multiAcquisition",CATDE2MultiAcquisitionCtrl:"multiAcquisitionCtrl",CATDE2WithUndoStep:"withUndoStep",CATDE2WithPrevaluation:"withPrevaluation",CATDE2WithContext:"withContext"},behaviorValues:{CATDE2EngWithPSOHSO:true,CATDE2WithPSO:true,CATDE2WithHSO:true,CATDE2ValuedFromCSO:true,CATDE2MultiAcquisition:true,CATDE2MultiAcquisitionCtrl:true,CATDE2WithUndoStep:false,CATDE2WithPrevaluation:true,CATDE2WithContext:true}};return b.namespace("StateCommandEngine/DE2NamingMap",a)});define("DS/StateCommandEngine/AcquisitionAgent",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/StateCommandEngine/DialogAgent","DS/Selection/CSOManager","DS/Selection/HSOManager"],function(e,f,g,c,a){var j=0;var i=[];var h=[];var b=[];var d=g.extend({init:function(k){this._parent(k);var l={frameWindow:null,withPrevaluation:false,withContext:false};this.options=e.extend(l,this.options);this._viewers=[];if(this.options.frameWindow){this._frameWindow=this.options.frameWindow;this._viewer=this._frameWindow.getViewer();this._viewers=this._frameWindow.getViewers()}else{if(this.options.viewer){this._viewer=this.options.viewer;this._viewers.push(this.options.viewer)}}},activate:function(r){if(!this._activated){this._parent(r);if(j===0){var m=this._computePickingOptions(this.options.pickingMode,this.options.withHSO);var n=this._computePickingOptions(this.options.prePickingMode,this.options.withPSO);for(var l=0;l<this._viewers.length;l++){var q=this._viewers[l];var k=q.picking;i[l]={};for(var p in k){if(k.hasOwnProperty(p)){i[l][p]=k[p]}}b[l]={};var o=q.pPicking;for(var p in o){if(o.hasOwnProperty(p)){b[l][p]=o[p]}}h[l]=q.getDefaultPicking();q.setFillXSOMode(false);q.setPicking(m);q.setPrePicking(n)}}j++}},deactivate:function(){if(this._activated){this._parent();j--;if(j===0){for(var k=0;k<this._viewers.length;k++){var o=this._viewers[k];o.setFillXSOMode(true);o.setPicking(i[k],h[k]);o.setPrePicking(b[k],h[k]);var p=a;var n=c;var m=!p.isEmpty();if(i[k].displayHL&&m){var l=n.get();p.empty();if(l.length>0){p.add(l)}o.render()}}i=[];b=[];h=[]}}},getEventViewer:function(l){var m;if(l){for(var k=0;k<this._viewers.length;k++){if(this._viewers[k]&&this._viewers[k]===l){break}}return l}},_computePickingOptions:function(m,k){var l={activated:true,trapSelection:false,displayHL:true,computeNormalDepth:true};switch(m){case"primHybrid":l.primitive=1;l.gpu=true;break;case"prim":l.primitive=1;l.gpu=false;break;case"rep":l.primitive=2;l.gpu=false;break;default:l.primitive=false;break}return l}});return d});define("DS/StateCommandEngine/UndoRedoObjectStack",["UWA/Core","DS/Core/ActionsStack","DS/StateCommandEngine/UndoRedoManager"],function(d,b,c){var a=b.extend({init:function(e){this._parent();if(!c._isInit){c.init()}this._undoRedoManager=c;this._notifyUndoRedoManager=true;if(e){if(!e.notifyUndoRedoManager){this._notifyUndoRedoManager=false}}},pushAction:function(f){var e=this;if(this._notifyUndoRedoManager){f=d.extend({undoObj:null,undoFunc:null,undoParamsList:[],undoTitle:"Undo",actionObj:null,actionFunc:null,actionParamsList:[],actionTitle:"run",redoObj:null,redoFunc:null,redoParamsList:[],redoTitle:"Redo",step:"normal"},f);var g=function(){var h={undoObj:e,undoFunc:e.undo,undoParamsList:[],undoTitle:f.undoTitle,actionObj:f.actionObj,actionFunc:f.actionFunc,actionParamsList:f.actionParamsList,actionTitle:f.actionTitle,redoObj:e,redoFunc:e.redo,redoParamsList:[],redoTitle:f.redoTitle,step:f.step};e._undoRedoManager.pushAction(h)};this._parent(f,g)}else{this._parent(f)}}});return a});define("DS/StateCommandEngine/EventTimeLine",["UWA/Core","DS/Controls/Gauge","DS/StateCommandEngine/UndoRedoManager"],function(d,b,c){var a=b.extend({className:"wux-timeline",init:function(e){e.graduations=[];this._eventsList=[];e.eventsList.forEach(function(g){var h;h=g.value-e.minValue;var f={label:g.label,value:h,onEvent:g.onEvent,state:0};e.graduations.push(f)});this._parent(e)},setValue:function(g,e){if(e===undefined){e=true}var f=this;this._setValue(g,e);f.options.graduations.forEach(function(h){var k=(h.value+f.options.minValue);if(f._value[1]===k&&h.state===0){h.state=1;if(h.onEvent&&e){h.onEvent.call(f,f._value[1])}for(var j=0;j<f.options.graduations.length;j++){if(f.options.graduations[j].value!==h.value){f.options.graduations[j].state=0}}}if(f._value[1]!==k&&h.state>0){h.state=0}})},getValue:function(){return this._value[1]}});return a});define("DS/StateCommandEngine/UndoRedoWidget",["UWA/Core","UWA/Event","DS/Core/Core","UWA/Class","DS/StateCommandEngine/UndoRedoManager","DS/StateCommandEngine/EventTimeLine","DS/Core/PointerEvents","DS/ApplicationFrame/CommandsManager"],function(c,i,e,b,f,h,d,a){var g=b.extend({init:function(k){if(f._isInit){this._undoRedoManager=f}else{f.init();this._undoRedoManager=f}var l=document.createElement("link");l.type="text/css";l.rel="stylesheet";l.href="../StateCommandEngine/UndoRedoWidget.css";document.getElementsByTagName("head")[0].appendChild(l);k=c.extend({uiFrame:null},k);if(k.uiFrame){this.myUndoButton=new c.Element("div",{"class":"WUXUndoRedoButton-state-disabled"});this.myUndoButton._active=false;this.myUndoButton._disabled=true;this.myUndoButton.inject(k.uiFrame);this.myIcon=new c.Element("div",{"class":"WUXUndoRedoIcon"});this.myIcon.inject(this.myUndoButton);this.undoRedoBox=new c.Element("div",{"class":"WUXUndoRedoBox-inactive WUXUndoRedoBox"});this._eventTimeline=new h({minValue:0,maxValue:2,value:2,dynamicGraduations:false,dynamicGaugeColor:false,graduationsLabel:true,eventsList:[{label:"",value:0,onEvent:function(){alert("Event on 100 has been triggered")}},{label:"",value:1},{label:"",value:2}],activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.undoRedoBox);this.undoRedoBox.inject(k.uiFrame);var j=this;this.myUndoButton.addEventListener(d.POINTERUP,function(m){if(!j.myUndoButton._disabled){if(!j.myUndoButton._active){j.myUndoButton.addClassName("wux-undo-redo-state-active");j.myUndoButton.removeClassName("WUXUndoRedoButton-animationUp");j.myUndoButton.addClassName("WUXUndoRedoButton-animationDown");j.myUndoButton._active=true;j.undoRedoBox.removeClassName("WUXUndoRedoBox-inactive");j.undoRedoBox.removeClassName("WUXUndoRedoBox-animationHide");j.undoRedoBox.addClassName("WUXUndoRedoBox-animationShow")}else{j.myUndoButton.removeClassName("wux-undo-redo-state-active");j.myUndoButton._active=false;j.myUndoButton.addClassName("WUXUndoRedoButton-animationUp");j.myUndoButton.removeClassName("WUXUndoRedoButton-animationDown");j.undoRedoBox.addClassName("WUXUndoRedoBox-animationHide");j.undoRedoBox.removeClassName("WUXUndoRedoBox-animationShow")}}});this._undoRedoManager._modelEvents.subscribe({event:"UndoRedoManagerNewItem"},function(){if(j.myUndoButton._active){j.myUndoButton.removeClassName("wux-undo-redo-state-active");j.myUndoButton._active=false;j.myUndoButton.addClassName("WUXUndoRedoButton-animationUp");j.myUndoButton.removeClassName("WUXUndoRedoButton-animationDown");j.undoRedoBox.addClassName("WUXUndoRedoBox-animationHide");j.undoRedoBox.removeClassName("WUXUndoRedoBox-animationShow")}var x=false;if(j._undoRedoManager._stack.length===0){x=true}else{if(j._undoRedoManager._stack[j._undoRedoManager._index].step==="beginCommand"){x=true}}if(x){j.myUndoButton.addClassName("WUXUndoRedoButton-state-disabled");j.myUndoButton.removeClassName("WUXUndoRedoButton");j.myUndoButton._disabled=true}else{if(j._undoRedoManager._stack[j._undoRedoManager._stack.length-1].step==="normal"){j.undoRedoBox.destroy();var q=0;var v=false;while(!v){q++;if(j._undoRedoManager._stack[j._undoRedoManager._stack.length-q-1].step==="beginCommand"){v=true}}var w=function(z){j._undoRedoManager.absoluteLocalUndoRedo(q-z)};var y=[];for(var t=0;t<=q;t++){y.push({label:j._undoRedoManager._stack[j._undoRedoManager._stack.length-q-1+t].actionTitle,value:t,onEvent:w})}j.undoRedoBox=new c.Element("div",{"class":"WUXUndoRedoBox-inactive WUXUndoRedoBox"}).inject(k.uiFrame);j._eventTimeline=new h({minValue:0,maxValue:q,value:q,eventsList:y,dynamicGraduations:false,dynamicGaugeColor:false,graduationsLabel:true,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(j.undoRedoBox)}else{if(j._undoRedoManager._stack[j._undoRedoManager._index].step==="endCommand"){j.undoRedoBox.destroy();var p=0;for(var s=0;s<j._undoRedoManager._stack.length;s++){if(j._undoRedoManager._stack[j._undoRedoManager._stack.length-s-1].step==="endCommand"){p++}}var n=function(z){j._undoRedoManager.absoluteGlobalUndoRedo(z)};var m=[];var u=0;for(var r=0;r<=p;r++){var o=false;while(!o&&r!==0){u++;if(j._undoRedoManager._stack[u-1].step==="endCommand"){o=true}}if(u!==0){m.push({label:j._undoRedoManager._stack[u-1].actionTitle,value:r,onEvent:n})}else{m.push({label:"Oldest Action",value:r,onEvent:n})}}j.undoRedoBox=new c.Element("div",{"class":"WUXUndoRedoBox-inactive WUXUndoRedoBox"}).inject(k.uiFrame);j._eventTimeline=new h({minValue:0,maxValue:p,value:p,eventsList:m,dynamicGraduations:false,dynamicGaugeColor:false,graduationsLabel:true,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(j.undoRedoBox)}}if(j.myUndoButton._disabled){j.myUndoButton.removeClassName("WUXUndoRedoButton-state-disabled");j.myUndoButton.addClassName("WUXUndoRedoButton");j.myUndoButton._disabled=false}}});this._undoRedoManager._modelEvents.subscribe({event:"UndoRedoManagerNewIndex"},function(m){if(m.commandRank===m.commandNumber){var o=0;var n=false;while(!n){if(j._undoRedoManager._stack[j._undoRedoManager._index-o].step==="beginCommand"){n=true}else{o++}}j._eventTimeline.setValue(o,false)}});this._undoRedoManager._modelEvents.subscribe({event:"UndoRedoManagerNewCommandRank"},function(m){j._eventTimeline.setValue(m.commandRank,false)})}}});return g});define("DS/StateCommandEngine/IndicationAgent",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/StateCommandEngine/AcquisitionAgent","DS/VisuEvents/EventsManager"],function(d,c,b){var a=b.extend({init:function(e){this._parent(e);if(this.options.frameWindow||this.options.viewer){this.setPlane()}},agentTreatment:function(e){if(e){if(!e.viewer){e.viewer=this._viewer}var g=true;var f;if(e.position){f={};f.position=e.position}else{g=e.pickingResult.path.length===0;if(g&&e.pickingResult.position){if(e.viewer){f=this._projectPoint3D(e)}else{f=this._projectPoint2D(e)}}}if(f&&f.position){this._modelEvents.publish({event:this._agentId,data:f})}}},_projectPoint3D:function(f){var e;if(f.viewer&&f.pickingResult.ray){e={};e.eventDatas=f;e.position=f.pickingResult.ray.intersectPlane(this._plane)}return e},_projectPoint2D:function(f){var e;if(f.viewer&&f.pickingResult.position){e={};e.eventDatas=f;e.position=c.Vector2(f.pickingResult.position.x-f.viewer.div.getBoundingClientRect().left,f.pickingResult.position.y-f.viewer.div.getBoundingClientRect().top)}return e},setPlane:function(e){if(!e){for(var f=0;f<this._viewers.length;f++){var h=this._viewers[f];if(h){var g=new c.Vector3();g.subVectors(h.currentViewpoint.target,h.currentViewpoint.camera.position);g.normalize();this._plane=new c.Plane(g,0.1)}}}else{this._plane=e}},getViewerCurrentPlane:function(e){var g;if(e){var f=new c.Vector3();f.subVectors(e.currentViewpoint.target,e.currentViewpoint.camera.position);f.normalize();g=new c.Plane(f,0.1)}return g},activateAgentControl:function(){var e;if(this._tokens&&this._tokens.length!==0){throw new Error("IndicationAgent.activateAgentControl, try to activate an agent which is already listening to events")}this._tokens=[];for(e=0;e<this._viewers.length;e++){this._tokens[e]=[]}for(e=0;e<this._viewers.length;e++){var f=this._viewers[e];if(this.options.withPrevaluation){f.setPrePicking({activated:true});this._tokens[e].push(f.onPreactivate(this.agentTreatment.bind(this)))}else{this._tokens[e].push(f.onActivate(this.agentTreatment.bind(this)));if(this.options.withContext){f.setPicking({contextPick:true})}}}},deactivateAgentControl:function(){for(var f=0;f<this._viewers.length;f++){var g=this._viewers[f];for(var e=0;e<this._tokens[f].length;e++){g.unsubscribe(this._tokens[f][e])}this._tokens[f]=undefined;if(this.options.withContext){g.setPicking({contextPick:false})}}this._tokens=[]}});return a});define("DS/StateCommandEngine/StateCommand",["UWA/Core","DS/ApplicationFrame/Command","DS/CoreEvents/ModelEvents","DS/StateCommandEngine/UndoRedoObjectStack","DS/ApplicationFrame/CommandsManager","DS/CoreEvents/Events"],function(g,b,f,a,e,d){var c=b.extend({defaultOptions:{withUndoRedo:false,isAsynchronous:true},init:function(i,h){this.options=g.extend(g.clone(this.defaultOptions),i);if(this.options.isAsynchronous!==true){console.warn("StateCommand with Id: "+this.options._id+" is not asynchronous. This state command will not work.")}this._modelEvents=new f();this._withUndoRedo=false;if(this.options.withUndoRedo){this._withUndoRedo=true;this._undoRedoObjectStack=new a()}return this._parent(i,h)},_createGraph:function(){this.FINAL_STATE_ID="finalState";this._initialStateId=null;this._transition={};this._states={};this._stateId=null;this._subscribedEvents=[]},_initGraph:function(){if(this._getInitialStateId()){this._changeState(this._getInitialStateId())}},_clearGraph:function(){this._unsubscribeFromAllEvents(this._stateId);this._initialStateId=null;this._transition=null;this._states=null;this._stateId=null;this._subscribedEvents=null},createState:function(i){var h=i.toString();if(!this._getStateFromId(h)){var j={stateId:h,_eventsToListen:[],_enterStateAction:null,_exitStateAction:null};this._states[h]=j}return this._states[h]},setEnterStateAction:function(i,h){if(i&&h){i._enterStateAction=h}},setLeaveStateAction:function(i,h){if(i&&h){i._exitStateAction=h}},setExitStateAction:function(i,h){this.setLeaveStateAction(i,h)},createInitialState:function(h){this._initialStateId=h;return this.createState(h)},getFinalState:function(){return this.createState(this.FINAL_STATE_ID)},_getInitialStateId:function(){return this._initialStateId},_getStateFromId:function(h){return this._states[h]},_getCurrentStateId:function(){return this._stateId},_SuscribeToStateEvent:function(j){var l;var n=this._getStateFromId(j);var h=n._eventsToListen;var m=null;for(l=0;l<h.length;l++){m=h[l];if(m){var o=Object.create(null);if(m.sender){var k=m.sender._modelEvents;if(k===undefined&&m.sender._modelEvent!==undefined){k=m.sender._modelEvent}if(k!==undefined){o.sender=k;o.token=k.subscribe({event:m.eventName},this._searchForTransition({eventName:m.eventName,sender:m.sender}))}}else{o.sender=undefined;o.token=d.subscribe({event:m.eventName},this._searchForTransition({eventName:m.eventName,sender:undefined}))}if(o!==undefined){this._subscribedEvents.push(o)}}}m=null;for(l=0;l<h.length;l++){m=h[l];if(m.isAgent){m.sender.activate()}}},_unsubscribeFromAllEvents:function(m){if(m&&this._subscribedEvents){var l=this._getStateFromId(m);var h=l._eventsToListen;var k=null;for(var j=0;j<h.length;j++){k=h[j];if(k.isAgent){k.sender.deactivate()}}for(var o=0;o<this._subscribedEvents.length;o++){var n=this._subscribedEvents[o];if(n){if(this._subscribedEvents[o].sender){this._subscribedEvents[o].sender.unsubscribe(n.token)}else{d.unsubscribe(n.token)}}}this._subscribedEvents.length=[]}else{this._subscribedEvents=[]}},defaultParameters:{iEvent:null,iInitialState:null,iFinalState:null,iCondition:null,iAction:null,iUndo:null,iRedo:null},addTransition:function(i){var k;g.extend(this.defaultParameters,i);if(!i.iEvent){}if(!i.iCondition){i.iCondition=function(){return true}}if(!i.iAction){i.iAction=function(m,l){m()}}var j={initState:i.iInitialState,finalState:i.iFinalState,condition:i.iCondition,action:i.iAction,undo:i.iUndo,redo:i.iRedo};if(typeof i.iEvent==="string"||(typeof i.iEvent==="object"&&i.iEvent.constructor===String)){j.triggerEvent=i.iEvent;j.sender=i.iSender}else{if(i.iEvent){j.triggerEvent=i.iEvent._agentId;j.sender=i.iEvent}else{j.triggerEvent=null;j.sender=null}}var h=i.iInitialState.stateId.toString();if(!this._transition[h]){this._transition[h]=[]}if(this._transition[h]){this._transition[h].push(j)}if(i.iEvent){if((i.iEvent).hasOwnProperty("_agentId")){k=false;i.iInitialState._eventsToListen.forEach(function(l){if(l.sender===i.iEvent){k=true}});if(!k){i.iInitialState._eventsToListen.push({eventName:i.iEvent._agentId,sender:i.iEvent,isAgent:true})}}else{if(i.iSender){k=false;i.iInitialState._eventsToListen.forEach(function(l){if(l.sender===i.iSender){if(l.eventName===i.iEvent){k=true}}});if(!k){i.iInitialState._eventsToListen.push({eventName:i.iEvent,sender:i.iSender})}}else{k=false;i.iInitialState._eventsToListen.forEach(function(l){if(l.eventName===i.iEvent){k=true}});if(!k){i.iInitialState._eventsToListen.push({eventName:i.iEvent,sender:null})}}}}},_getTransitionsTabForState:function(h){return this._transition[h]},notCondition:function(i){var h=this;var j=function(){var k=i.call(h);var l=!k;return l};return j},andCondition:function(h){var i=this;var j=function(n){var l=0;var k=h.length;var m=true;for(l=0;l<k;l++){m=m&&h[l].call(i,n)}return m};return j},orCondition:function(h){var i=this;var j=function(n){var l=0;var k=h.length;var m=false;for(l=0;l<k;l++){m=m||h[l].call(i,n)}return m};return j},_changeState:function(h,k){if(!this.isNewInfraActivated()&&(!this.isRunning()||this.isEnding())){return}var j=(this._stateId===h);if(!j){if((this._stateId)){this._unsubscribeFromAllEvents(this._stateId);if(this._getStateFromId(this._stateId)._exitStateAction){this._getStateFromId(this._stateId)._exitStateAction.call(this)}}this.publish({event:"changeState",data:h})}this._stateId=h;if(h===this.FINAL_STATE_ID){this.done(k);if(this.isNewInfraActivated()&&!(k&&k.cancel===true)){this.endExecute()}if(!this.isNewInfraActivated()){this.end()}}else{if(!j){var i=this._getStateFromId(h);if(i._enterStateAction){i._enterStateAction.call(this)}}this._evaluateAutomaticTransitions();if(this._getCurrentStateId()===h){if(!j){this._SuscribeToStateEvent(h)}}}},_evaluateAutomaticTransitions:function(){var h=this._searchForTransition(null);h(null)},_searchForTransition:function(i){var h=this;function j(l){if(!h._stateId){return}var s=h._getTransitionsTabForState(h._stateId);if(!s){console.error("stateCmd "+h.getId()+" tries to launch a transition but transitionsTab is "+s);return}var r;if(l instanceof Array){r=[];l.forEach(function(v){r.push(v)})}else{r=l}var t=null;var p=0;var m=s.length;for(p=0;(!t&&p<m);p++){var o=s[p];var q,n;if(i){q=i.eventName;n=i.sender}else{q=null;n=null}if(o.condition&&q===o.triggerEvent&&o.sender===n){var k=o.condition.call(h,l);if(k){t=o}}}if(t){var u=function(x){var v=true;if(x){if(x.error){v=false}}if(v){if(t.undo&&t.redo&&h._withUndoRedo){var z=function(B){var A=true;if(B){if(B.error){A=false}}if(A){h._changeState(t.initState.stateId)}};var w=function(B){var A=true;if(B){if(B.error){A=false}}if(A){h._changeState(t.finalState.stateId)}};var y={undoObj:h,undoParamsList:[z,r],undoTitle:"Undo",actionObj:h,actionFunc:t.action,actionParamsList:[u,r],actionTitle:"Run",redoObj:h,redoTitle:"Redo",redoFunc:t.redo,redoParamsList:[w,r]};if(x){if(x.undoTitle){y.undoTitle=x.undoTitle}if(x.redoTitle){y.redoTitle=x.redoTitle}if(x.actionTitle){y.actionTitle=x.actionTitle}if(x.undoParamsList){y.undoParamsList.push(x.undoParamsList)}if(x.redoParamsList){y.redoParamsList.push(x.redoParamsList)}}if(t.finalState.stateId===h.FINAL_STATE_ID){y.undoFunc=function(C,B,D){var A=e.getCommand(e._getCurrent());A.end();h.begin();t.undo.call(h,C,B,D)};y.step="endCommand"}else{y.undoFunc=t.undo}h._undoRedoObjectStack.pushAction(y)}if(t.finalState.stateId===h.FINAL_STATE_ID&&x&&x.cancel){h.done({cancel:x.cancel,undoOnEnd:x.undoOnEnd})}else{h._changeState(t.finalState.stateId)}}else{g.log("completionHandler: ERROR")}};t.action.call(h,u,l)}}return j},beginExecute:function(){this._parent();this._createGraph();this.buildGraph();if(this._withUndoRedo){var h={undoObj:this,undoFunc:this.end,undoParamsList:[false],undoTitle:"Undo Begin Command",actionObj:this,actionFunc:this.begin,actionParamsList:[],actionTitle:"Begin Command",redoObj:this,redoFunc:this.begin,redoParamsList:[],redoTitle:"Redo Begin Command",step:"beginCommand"};this._undoRedoObjectStack.pushAction(h)}this._initGraph()},pauseExecute:function(h){this._unsubscribeFromAllEvents(this._getCurrentStateId());this._parent();if(!h||h.pauseSynchronous!==false){this.done()}},resumeExecute:function(){this._SuscribeToStateEvent(this._getCurrentStateId());this._parent()},cancelExecute:function(i){if(this.isNewInfraActivated()){var h=this.done;if(i&&i.cancelSynchronous===false){this.done=function(){}}this._changeState(this.FINAL_STATE_ID,i);if(i&&i.cancelSynchronous===false){this.done=h}}},endExecute:function(){if(this._withUndoRedo){if(!this._undoRedoObjectStack._undoRedoManager._isRunning){this._undoRedoObjectStack._undoRedoManager.cleanInterruptedEnd()}}if(!this.isNewInfraActivated()){this._clearGraph()}this._parent()},destroy:function(){if(this._getCurrentStateId()!==this.FINAL_STATE_ID){}if(this.isNewInfraActivated()){this._clearGraph()}this._parent()},buildGraph:function(){},publish:function(h){this._modelEvents.publish(h)},subscribe:function(h,i){return this._modelEvents.subscribe(h,i)},subscribeOnce:function(h,i){this._modelEvents.subscribeOnce(h,i)},unsubscribe:function(h){this._modelEvents.unsubscribe(h)},isWithUndoRedo:function(){return this._withUndoRedo}});return c});define("DS/StateCommandEngine/PathElementAgent",["UWA/Core","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/StateCommandEngine/AcquisitionAgent","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Utilities/Object","DS/StateCommandEngine/UndoRedoObjectStack"],function(f,e,j,g,d,b,i,c,a){var h=g.extend({init:function(k){this._parent(k);var l={engWithPSOHSO:false,withPSO:false,withHSO:false,valuedFromCSO:false,saveToCSO:true,multiAcquisition:false,multiAcquisitionCtrl:false,pickingMode:"",prePickingMode:"",withUndoStep:false,pickingFilter:function(){return true},prePickingFilter:function(){return true}};this.options=f.extend(l,this.options);if(this.options.engWithPSOHSO){this.options.withHSO=true;this.options.withPSO=true}this.pso=WUX.Selection.PSOManager;this.hso=WUX.Selection.HSOManager;this.cso=WUX.Selection.CSOManager;this.currentPSO=[];this.object3D=[];if(!(this.options.pickingMode==="prim"||this.options.pickingMode==="rep"||this.options.pickingMode==="primHybrid")){this.options.pickingMode="mesh"}if(!(this.options.prePickingMode==="prim"||this.options.prePickingMode==="rep"||this.options.prePickingMode==="primHybrid")){this.options.prePickingMode="mesh"}var m={notifyUndoRedoManager:this.options.withUndoStep};this._undoRedoObjectStack=new a(m)},activate:function(){if(!this._activated){var o=false;if(this.options.valuedFromCSO){var m=this.cso.get();if(m.length>0){var n=false;var q=[];this.object3D.forEach(function(k){q.push(k)});this.object3D=[];for(var l=0;l<m.length;l++){if(this.options.pickingFilter(m[l].pathElement)){if(!n){n=true}this.object3D.push(m[l])}}if(this.object3D.length>0&&!this._undoRedoObjectStack._undoRedoManager._isRunning){o=true}}}this._parent(o);if(o){var p=this;setTimeout(function(){p._modelEvents.publish({event:p._agentId,data:p.object3D})},0)}}},deactivate:function(){if(this._activated){this.object3D.length=0;this.pso.empty();this._parent()}},agentTreatment:function(q){var E,D,y,C,r,H;if(q){if(!q.viewer){q.viewer=this._viewer}var w;if(q.hasOwnProperty("selected")){w={path:[q.selected]}}else{w=q.pickingResult}var u=[];var p=false;if(w.path.length>0){if(q.trapSelection){for(var x=w.path.length-1;x>=0;x--){if(this.options.pickingFilter(w.path[x])){p=true}else{w.path.splice(x,1)}}}else{if(this.options.pickingFilter(w.path[0])){p=true}}}if(p){var o=q.ctrl&&this.options.multiAcquisitionCtrl;var v=[];if(!q.trapSelection){v.push({pathElement:w.path[0],normal:w.normal,position:w.position,ray:w.ray,tangent:w.tangent,uv:w.uv,eventDatas:q})}else{for(D=0;D<w.path.length;D++){v.push({pathElement:w.path[D]})}}if(o){this.object3D.forEach(function(k){u.push(k)})}for(D=0;D<v.length;D++){var s=false;for(E=0;(!s&&E<u.length);E++){if(c.areEquals(u[E],v[D])){if(!this.options.withPrevaluation){u.splice(E,1)}s=true}}if(!s){u.push(v[D])}}var G=[];this.object3D.forEach(function(k){G.push(k)});var z=false;this.object3D=[];for(var B=0;B<u.length;B++){if(this.options.pickingFilter(u[B].pathElement)){if(!z){z=true}this.object3D.push(u[B])}}if(z){if(this.options.withPSO){this.pso.empty()}if(this.options.withHSO){this.hso.empty();this.hso.add(this.object3D);q.viewer.render()}this.cso.empty();if(this.options.saveToCSO){this.cso.add(this.object3D)}var t=this;var m=function(k){t.object3D=[];k.forEach(function(l){t.object3D.push(l)});if(t.options.withHSO){t.hso.empty();t.hso.add(t.object3D);q.viewer.render()}t.cso.empty();if(t.options.saveToCSO){t.cso.add(t.object3D)}};var F=[];this.object3D.forEach(function(k){F.push(k)});var A={undoObj:this,undoFunc:m,undoParamsList:[G],undoTitle:"Undo agent treatment",actionObj:this,actionFunc:this.agentTreatment,actionParamsList:[q],actionTitle:"agent treatment",redoObj:this,redoFunc:m,redoParamsList:[F],redoTitle:"Redo agent treatment"};this._undoRedoObjectStack.pushAction(A);this._modelEvents.publish({event:this._agentId,data:this.object3D})}else{C=this.hso.get();r=true;for(y=0;r&&y<C.length;y++){if(!this.options.pickingFilter(C[y].pathElement)){r=false}}H=this.cso.get();for(y=0;r&&y<H.length;y++){if(!this.options.pickingFilter(H[y].pathElement)){r=false}}if(r){this.hso.empty();this.cso.empty()}}}else{if(!(q.ctrl&&this.options.multiAcquisitionCtrl)){if(this.object3D){C=this.hso.get();r=true;for(y=0;r&&y<C.length;y++){if(!this.options.pickingFilter(C[y].pathElement)){r=false}}H=this.cso.get();for(y=0;r&&y<H.length;y++){if(!this.options.pickingFilter(H[y].pathElement)){r=false}}if(r){this.hso.empty();this.cso.empty()}this.object3D=[]}}}}else{}},agentActionOnTheScene:function(o){if(o){var s=o.viewer;if(s){if(this.options.withPSO&&o.pickingResult){var q=o.pickingResult;if(q.path.length>0){if(!o.trapSelection&&q.path.length>1){q.path.splice(1,q.path.length-1)}for(var p=this.currentPSO.length-1;p>=0;p--){var m=false;for(var n=q.path.length-1;n>=0;n--){if(this.currentPSO[p].pathElement.isEqual(q.path[n])){m=true;q.path.splice(n,1)}}if(!m){this.pso.remove(this.currentPSO[p]);this.currentPSO.splice(p,1)}}for(var l=0;l<q.path.length;l++){if(this.options.prePickingFilter(q.path[l])){var r={pathElement:q.path[l]};this.currentPSO.push(r);this.pso.add(r)}}s.render()}else{if(this.currentPSO){this.pso.empty();this.currentPSO.length=0}}}}else{}}},activateAgentControl:function(){var l,m;if(this._tokens&&this._tokens.length!==0){throw new Error("pathElementAgent.activateAgentControl, try to activate an agent which is already listening to events")}this._tokens=[];for(l=0;l<this._viewers.length;l++){this._tokens[l]=[]}for(l=0;l<this._viewers.length;l++){m=this._viewers[l];if(this.options.withPrevaluation){m.setPrePicking({activated:true});this._tokens[l].push(m.onPreactivate(this.agentTreatment.bind(this)))}else{this._tokens[l].push(m.onActivate(this.agentTreatment.bind(this)));if(this.options.withContext){m.setPicking({contextPick:true})}}if(this.options.multiAcquisition){m.setPicking({trapSelection:true})}}if(this._frameWindow&&this._frameWindow.getTree()){var k=this;this._frameWindow.getTree()._modelEvents.unsubscribe(this._frameWindow.getTree()._onNodeClickToken);this._treeToken=this._frameWindow.getTree().onNodeClick(function(n){var o={};o.pickingResult=Object.create(null);o.pickingResult.path=[];o.pickingResult.path.push(n.getPathElement());o.viewer=k._frameWindow.getViewer();k.agentTreatment(o)})}if(this.options.withPSO&&!this.options.withPrevaluation){for(l=0;l<this._viewers.length;l++){m=this._viewers[l];m.setPrePicking({activated:true});this._tokens[l].push(m.onPreactivate(this.agentActionOnTheScene.bind(this)))}}},deactivateAgentControl:function(){for(var l=0;l<this._viewers.length;l++){var m=this._viewers[l];if(this._tokens&&this._tokens.length>0){for(var k=0;k<this._tokens[l].length;k++){m.unsubscribe(this._tokens[l][k])}this._tokens[l]=undefined}if(this._frameWindow&&this._frameWindow.getTree()){this._frameWindow.getTree()._modelEvents.unsubscribe(this._treeToken);this._frameWindow.getTree()._onNodeClickToken=this._frameWindow.getTree().onNodeClick(this._frameWindow.getTree()._onNodeClickCB)}if(this.options.withContext){m.setPicking({contextPick:false})}if(this.options.multiAcquisition){m.setPicking({trapSelection:false})}}this._tokens=[]}});return h});define("DS/StateCommandEngine/StateCommandDeclarative",["DS/StateCommandEngine/StateCommand","DS/StateCommandEngine/Xml2Json","DS/StateCommandEngine/XmlModelsTools","DS/StateCommandEngine/IndicationAgent","DS/StateCommandEngine/PathElementAgent","DS/StateCommandEngine/DE2NamingMap"],function(d,e,b,a,g,f){var c=d.extend({init:function(i,h){UWA.log("StateCommandDeclarative: init");return this._parent(i,h)},buildGraph:function(){UWA.log("StateCommand: buildGraph");this.agents={};var h=this;var j=function(o){var m=o;while(b.getTag(m)!=="StateCommand"){m=b.getChildren(m)[0]}var n=[];b.getChildren(m).forEach(function(q){if(b.getTag(q)==="State"){n.push(q)}});h.createInitialState(b.getAttribute(n[0],"Id"));for(var p=1;p<n.length;p++){h.createState(b.getAttribute(n[p],"Id"))}n.forEach(function(q){b.getChildren(q).forEach(function(r){if(b.getTag(r)==="EnterStateAction"){h.setEnterStateAction(h._getStateFromId(b.getAttribute(q,"Id")),h[b.getAttribute(declarativeParam,"Do")])}if(b.getTag(r)==="LeaveStateAction"){h.setLeaveStateAction(h._getStateFromId(b.getAttribute(q,"Id")),h[b.getAttribute(declarativeParam,"Do")])}})});n.forEach(function(q){b.getChildren(q).forEach(function(u){if(b.getTag(u)==="IndicationAgent"||b.getTag(u)==="PathElementAgent"){var r={agentId:b.getAttribute(u,"Id"),frameWindow:h.getFrameWindow()};if(b.getAttribute(u,"Behavior")){var t=b.getAttribute(u,"Behavior").split("|");for(var s=0;s<t.length;s++){if(f.behaviorCorrespondence[t[s]]){r[f.behaviorCorrespondence[t[s]]]=f.behaviorValues[t[s]]}}}if(b.getTag(u)==="IndicationAgent"){h.agents[b.getAttribute(u,"Id")]=new a(r)}if(b.getTag(u)==="PathElementAgent"){h.agents[b.getAttribute(u,"Id")]=new g(r)}}})});n.forEach(function(q){b.getChildren(q).forEach(function(s){if(b.getTag(s)==="Transition"||b.getTag(s)==="FinalTransition"||b.getTag(s)==="SelfTransition"){var r={iInitialState:h._getStateFromId(b.getAttribute(q,"Id"))};if(b.getTag(s)==="Transition"){r.iFinalState=h._getStateFromId(b.getAttribute(s,"Target"))}else{if(b.getTag(s)==="FinalTransition"){r.iFinalState=h.getFinalState()}else{r.iFinalState=h._getStateFromId(b.getAttribute(q,"Id"))}}b.getChildren(s).forEach(function(u){if(b.getTag(u)==="IsOutputSetCondition"){r.iEvent=h.agents[b.getAttribute(u,"Agent")]}if(b.getTag(u)==="ReceivedEventCondition"){r.iEvent=b.getAttribute(u,"Event")}if(b.getTag(u)==="AndCondition"||b.getTag(u)==="OrCondition"){var t=[];b.getChildren(u).forEach(function(v){if(b.getTag(v)==="IsOutputSetCondition"){r.iEvent=h.agents[b.getAttribute(u,"Agent")]}if(b.getTag(u)==="ReceivedEventCondition"){r.iEvent=b.getAttribute(u,"Event")}if(b.getTag(v)==="Condition"){t.push(h[b.getAttribute(v,"Condition")])}});if(t.length===1){r.iCondition=t[0]}else{if(b.getTag(u)==="AndCondition"){r.iCondition=h.andCondition(t)}else{r.iCondition=h.orCondition(t)}}}if(b.getTag(u)==="Condition"){r.iCondition=h[b.getAttribute(u,"Condition")]}if(b.getTag(u)==="Action"){r.iAction=h[b.getAttribute(u,"Do")];r.iUndo=h[b.getAttribute(u,"BeforeUndo")];r.iRedo=h[b.getAttribute(u,"BeforeRedo")]}});h.addTransition(r)}})})};if(!this.isDeclarativeXmlCharged){var l=function(m){h.isDeclarativeXmlCharged=true;j(m);if(!h._getCurrentStateId()){h._initGraph()}if(h.declarativeDelayedBeginExecute){h.declarativeDelayedBeginExecute()}};var k=(this.module!==null||this.module!==undefined)?this.module:null;var i={xml:this.declarativeXml,module:k,directory:"assets/de2/",fileExtension:".xml",onFailure:this.end,onLoaded:l};this.jsonInformation=new e(i)}else{j(this.jsonInformation.getModel());if(h.declarativeDelayedBeginExecute){h.declarativeDelayedBeginExecute()}}},endExecute:function(){this.agents=undefined;this._parent()},getAgentById:function(h){return this.agents[h]}});return c});