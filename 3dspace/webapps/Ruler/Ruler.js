/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Ruler/RulerManipulator",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator"],function(e,d,b,c){var a=c.extend({init:function(f){var f=f||{};this._parent(f.viewer);this.axis=f.axis;this.clickGradManipulator=false;if(this.axis){this.axis.normalize();this.projector=new d.Projector()}else{this.clickGradManipulator=true;this.associatedValue=f.value;this.linkedNode=f.linkedNode}if(this.setPrePickingDuringManipulation){this.setPrePickingDuringManipulation(false)}if(this.setPreActivationDuringManipulation){this.setPreActivationDuringManipulation(false)}if(this.setPickingDuringManipulation){this.setPickingDuringManipulation(false)}this.setValue=function(g){this.associatedValue=g};this.magnitude=1000;this.setExclusive(true)},BeginManipulate:function(h,f,i){this._parent(h,f,i);this.clickEvent=true;if(!this.clickGradManipulator){this.initial3dIntersectionPoint=i.position;this.initial3dIntersectionPointTranslated=new d.Vector3().copy(this.initial3dIntersectionPoint);this.initial3dIntersectionPointTranslated.add(this.axis)}var g={eventChannel:"BeginManipulate",paths:this.manipulatedPaths,event:f,manipulator:this};this.publish("BeginManipulate",g)},Manipulate:function(l,g){this._parent(l,g);if(!this.clickGradManipulator){var h=new d.Vector2().copy(g.from[0].getCurrentPosition(this.viewer.canvas));var f=this.viewer.currentViewpoint.create3DRayFrom2DPoint(h);var k=f.computeShortestPointToLine(this.initial3dIntersectionPoint,this.initial3dIntersectionPointTranslated);var i=new d.Vector3().subVectors(k,this.initial3dIntersectionPoint);if(Math.round(i.length()*100)>this.magnitude){this.clickEvent=false;var j={event:g,eventChannel:"Manipulate",paths:this.manipulatedPaths,translationVector:i,manipulator:this};this.publish("Manipulate",j)}}},EndManipulate:function(h,f){this._parent(h,f);if(!this.clickGradManipulator){if(this.clickEvent){var g={eventChannel:"Click",paths:this.manipulatedPaths,event:f,manipulator:this};this.publish("Click",g)}else{var g={eventChannel:"EndManipulate",paths:this.manipulatedPaths,manipulator:this,event:f};this.publish("EndManipulate",g)}}},PrimaryPointerClick:function(g,f){this._parent(g,f);var h={eventChannel:"Click",paths:this.manipulatedPaths,event:f,manipulator:this,value:this.clickGradManipulator?this.associatedValue:undefined};this.publish("Click",h)},BeginPreactivate:function(g,f){this._parent(g,f);var h={eventChannel:"BeginPreactivate",preactivated:this.preactivated,manipulator:this,event:f,node:this.clickGradManipulator?this.linkedNode:undefined};this.publish("BeginPreactivate",h)},Preactivate:function(g,f){this._parent(g,f);var h={eventChannel:"Preactivate",preactivated:this.preactivated,manipulator:this,event:f,node:this.clickGradManipulator?this.linkedNode:undefined};this.publish("Preactivate",h)},EndPreactivate:function(g,f){this._parent(g,f);var h={eventChannel:"EndPreactivate",preactivated:this.preactivated,manipulator:this,event:f,node:this.clickGradManipulator?this.linkedNode:undefined};this.publish("EndPreactivate",h)}});return a});
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Ruler/AngularRulerManipulator",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator"],function(e,d,a,c){var b=c.extend({init:function(f){var f=f||{};this._parent(f.viewer);this.axis=f.axis;this.clickGradManipulator=false;if(this.axis){this.axis.normalize();this.centerPosition=new d.Vector3();this.projector=new d.Projector()}else{this.clickGradManipulator=true;this.associatedValue=f.value;this.linkedNode=f.linkedNode}if(this.setPrePickingDuringManipulation){this.setPrePickingDuringManipulation(false)}if(this.setPreActivationDuringManipulation){this.setPreActivationDuringManipulation(false)}if(this.setPickingDuringManipulation){this.setPickingDuringManipulation(false)}this.centerPosition=f.center;this.setExclusive(true)},BeginManipulate:function(g,f,h){this._parent(g,f,h);this.initial3dIntersectionPoint=h.position;this.clickEvent=true;this.publish("BeginManipulate",{event:f})},Manipulate:function(q,o){this._parent(q,o);if(!this.clickGradManipulator){var j=new d.Vector2().copy(o.from[0].getCurrentPosition(this.viewer.canvas));var n=o.viewer.currentViewpoint.create3DRayFrom2DPoint(j);var l=new d.Plane().setFromNormalAndCoplanarPoint(this.axis,this.initial3dIntersectionPoint);var m=n.intersectPlane(l);var g=new d.Vector3().subVectors(this.initial3dIntersectionPoint,this.centerPosition);g.projectOnPlane(this.axis);g.normalize();var h=new d.Vector3().subVectors(m,this.centerPosition);h.projectOnPlane(this.axis);h.normalize();var f=new d.Vector3();f.crossVectors(g,h);f.normalize();var i=g.angleTo(h);var p=new d.Matrix4().makeRotationAxis(f,i);if(Math.round(i*180/Math.PI)>0.05){this.clickEvent=false;var k={rotationMatrix:p,angle:i,axis:f,center:this.centerPosition,event:o};this.publish("Manipulate",k)}}},EndManipulate:function(g,f){this._parent(g,f);if(!this.clickGradManipulator){if(this.clickEvent){this.publish("Click",{event:f})}else{this.publish("EndManipulate",{event:f})}}},PrimaryPointerClick:function(g,f){this._parent(g,f);var h={event:f,value:this.clickGradManipulator?this.associatedValue:undefined};this.publish("Click",h)},BeginPreactivate:function(g,f){this._parent(g,f);var h={event:f,preactivated:this.preactivated,node:this.clickGradManipulator?this.linkedNode:undefined};this.publish("BeginPreactivate",h)},Preactivate:function(g,f){this._parent(g,f);var h={preactivated:this.preactivated,event:f,node:this.clickGradManipulator?this.linkedNode:undefined};this.publish("Preactivate",h)},EndPreactivate:function(g,f){this._parent(g,f);var h={preactivated:this.preactivated,event:f,node:this.clickGradManipulator?this.linkedNode:undefined};this.publish("EndPreactivate",h)}});return b});
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Ruler/RulerEditor",["UWA/Core","DS/SceneGraphNodes/CSS2DNode","DS/Visualization/ThreeJS_DS","DS/VisuEvents/EventsManager","DS/Controls/LineEditor","css!DS/Ruler/Ruler.css"],function(d,i,h,a,c){var f,e,b;require(["i18n!DS/Ruler/assets/nls/Ruler"],function(j){f=j.warningBadValueEntered;e=j.warningValueTooSmall;b=j.warningValueTooBig});var g=i.extend({init:function(l){var u=l||{};var k=d.createElement("div",{id:"WEB3DUXRulersValueEditor","class":"WEB3DUXRulersValueEditor"});var n=new c({selectAllOnFocus:true,autoCommitFlag:true,touchMode:true,pattern:"^[+-]?[0-9]*.?[0-9]*$"}).inject(k);n.elements.container.setStyles({"float":"left"});n.elements.container.childNodes[0].setStyles({border:"none",width:"80px",height:"32px"});n.elements.container.childNodes[0].addClassName("WEB3DUXRulersValueEditorField");var r=d.createElement("span",{id:"WEB3DUXCancelRulerEditionButton","class":"fonticon fonticon-cancel WEB3DUXCancelRulerEditionButton"}).inject(k);var q=d.createElement("span",{id:"WEB3DUXAcceptRulerEditionButton","class":"fonticon fonticon-check WEB3DUXAcceptRulerEditionButton"}).inject(k);var t=d.createElement("span",{"class":"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attention WEB3DUXAcceptRulerEditionWarningDiv"}).inject(k);t.setStyles({visibility:"hidden"});this._parent({html:k,name:"immersiveEditor2DNode"});if(navigator.userAgent.match(/(iPhone|iPad)/i)&&l.frmWindow){l.frmWindow.getUIFrame().appendChild(k.parentNode)}this._getExcludeFromCSO=function(){return true};this.css2DNode.primitive=true;var p=null;n.addEventListener("change",function(){var v=p;if(isNaN(n.value)){p=f}else{if(typeof u.startValue==="number"&&parseFloat(n.value)<u.startValue){p=e+u.startValue}else{if(typeof u.endValue==="number"&&parseFloat(n.value)>u.endValue){p=b+u.endValue}else{p=null}}}t.title=p?p:"";if(v&&!p||!v&&p){t.setStyles({visibility:p?"":"hidden"})}});var m;var j=function(v){if(p===null){u.okCB(v);m()}};var s=function(v){u.cancelCB(v);m()};var o=function(v){var w=v.which||v.keyCode;if(w===13){j({event:v})}else{if(w===27){s({event:v})}}if(w===13||w===27){v.preventDefault();v.stopPropagation()}};m=function(){a.removeEvent(q,"onPrimaryPointerClick",j);a.removeEvent(r,"onPrimaryPointerClick",s);n.elements.container.childNodes[0].removeEventListener("keydown",o)};a.addEvent(q,"onPrimaryPointerClick",j);a.addEvent(r,"onPrimaryPointerClick",s);n.elements.container.childNodes[0].addEventListener("keydown",o);this.getInputValue=function(){return n.value};this.validateEditor=function(){if(p===null&&n.value&&parseFloat(n.value)!==u.value){u.okCB()}else{u.cancelCB()}m()};setTimeout(function(){n.value=parseFloat(u.value);n.elements.container.childNodes[0].select();n.elements.container.childNodes[0].focus()},5)}});return g});
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Ruler/AngularRuler",["UWA/Class","DS/Ruler/RulerEditor","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Ruler/AngularRulerManipulator","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/WebappsUtils/WebappsUtils","DS/VisuEvents/EventsManager","DS/Mesh/MeshUtils","DS/SceneGraphNodes/CSS2DNode"],function(a,j,m,i,k,n,f,p,d,c,e,b,g,o){var h=[];var l=a.extend({init:function(a6,b4){var bL=b4||{};this._parent(bL);this.value=0;this.initValue=0;this.origin=new m.Vector3();this.direction=new m.Vector3(0,0,1);this.originVector=null;this.radius=bL.radius;this.worldRadius=bL.worldRadius;this.openingAngle=bL.openingAngle;this.mainGrad=bL.mainGrad;this.nbSecondaryGrads=bL.nbSecondaryGrads;this.startValue=bL.startValue;this.endValue=bL.endValue;this.lightDisplay=bL.lightDisplay;this.displayRulerDuringLocalTransfo=bL.displayRulerDuringLocalTransfo;this.displayOrigin=bL.displayOrigin;this.unit=bL.unit;this.displayUnit=bL.displayUnit;this.graduationsDisplay=bL.graduationsDisplay;this.originValue=bL.originValue;this.hideOnEmptySelection=bL.hideOnEmptySelection;this.nbDecimals=bL.nbDecimals;var bA=this;var cc=null;var bw=null;var bM=null;var ba=null;var aI;var ab;var bb;var v;var aU;var M;var bq;var aN;var J;var bt;var S,bT;var b2;var aj;var b5;var ci=new m.Vector2();var T;var z;var aY;var bV=1;var aW=1;var aM;var r,q,ct;var ap=0;var a7=0;var U=15;var aQ=1;var bg=35;var aR=20;var aX=15;var V=14;var by=10;var ay=bg*0.33;var aa=100;var bp;var bx;var af="255, 128, 0";var bH="115, 195, 225";var bP="130, 190, 220";var cm="40, 90, 120";var bN="80, 80, 80";var aC="0,0,0";var ck=false;var b0=1;var aZ=new c();var bh=a6.getViewer();var bI=a6.getViewpoint();var H;var am=new i("rulerMainNode");am.setVisibilityInTree(false);am.side=m.DoubleSide;am.exludeFromBounding(true);am._getExcludeFromCSO=function(){return true};am.setNoZ(true);var ax=new i("rulerMainNodeNoPick");ax.setVisibilityInTree(false);ax.side=m.DoubleSide;ax.exludeFromBounding(true);ax._getExcludeFromCSO=function(){return true};ax.setNoZ(true);ax.setPickable(g.NODRAWHL);var bk=new i();var E=new i();var au=new i();var P=new i("rulerGraduationNode");var ca=new i();var y=new i();var aw;var ce=new i();var ac=new i();var av=new i();var aL=new i();var aF=new i();var aT=null;var aO=new i();var bD=new i();var cf;var a8=100;var t=[];var cj=[];var a3=0;var at=0;var bf=null;var aD=0;var aJ=null;var X=0;var x=null;var bs=0;var aE=0;var bX=null;var ah=false;var w=false;var bZ=false;var bE=false;var bn=true;var bm=false;var F=false;var B=false;var bi=false;var O=false;var Y=false;var s=false;var a9=false;var aS=false;var b1=false;var L=false;var bo=false;var Q;var bQ=document.createElement("canvas");var u=document.createElement("canvas");var ak=document.createElement("canvas");var b9=document.createElement("canvas");var bc=document.createElement("canvas");var an=document.createElement("canvas");var aA=document.createElement("canvas");an.width=1;an.height=1;var A=an.getContext("2d");A.clearRect(0,0,an.width,an.height);A.rect(0,0,an.width,an.height);A.fillStyle="rgba(0,0,0,0)";A.fill();var aG=new m.Texture();var cs=new m.Texture();var be=new m.Texture();var ch=new m.Texture();var bl=new m.Texture();bl.image=an;bl.needsUpdate=true;var R=e.getWebappsAssetUrl("Ruler","textures/");var b8=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerArrowManipulator.png",undefined,null,null,true);b8.flipY=false;var I=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerArrowManipulator_Over.png",undefined,null,null,true);I.flipY=false;var bv=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerArrowManipulator_On.png",undefined,null,null,true);bv.flipY=false;var Z=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerArrowManipulator_Half.png",undefined,null,null,true);Z.flipY=false;var cp=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerArrowManipulator_Half_Over.png",undefined,null,null,true);cp.flipY=false;var aV=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerArrowManipulator_Half_On.png",undefined,null,null,true);aV.flipY=false;var a5=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerArrowManipulator_Half.png",undefined,null,null,true);var co=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerArrowManipulator_Half_Over.png",undefined,null,null,true);var cq=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerArrowManipulator_Half_On.png",undefined,null,null,true);var bR=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerZeroArrowManip.png",undefined,null,null,true);var cd=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerArrowManipulator_Half_On.png",undefined,null,null,true);var b6=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerZeroArrowManip.png",undefined,null,null,true);b6.flipY=false;var aP=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerArrowManipulator_Half_On.png",undefined,null,null,true);aP.flipY=false;var bY=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerLight.png",undefined,null,null,true);var ar=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerLightOver.png",undefined,null,null,true);var W=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerLightOn.png",undefined,null,null,true);var ao=new m.ImageUtils.loadTexture(R+"Web3DUX_RulerLightZeroManip.png",undefined,null,null,true);var cb=new m.Texture();var bO;var bS,az,bF;function bK(cv){if(bA.__performanceMeasures){for(var cu=0;cu<bA.__performanceMeasures.measures.length;cu++){if(bA.__performanceMeasures.measures[cu].id===cv){bA.__performanceMeasures.measures[cu].mark=new Date().getTime();return}}bA.__performanceMeasures.measures.push({id:cv,mark:new Date().getTime(),cumulatedTime:0,nbCalls:0})}}function bJ(cv){if(bA.__performanceMeasures){for(var cu=0;cu<bA.__performanceMeasures.measures.length;cu++){if(bA.__performanceMeasures.measures[cu].id===cv){bA.__performanceMeasures.measures[cu].cumulatedTime+=new Date().getTime()-bA.__performanceMeasures.measures[cu].mark;bA.__performanceMeasures.measures[cu].nbCalls+=1;return}}}}function a2(cx,cw,cv){var cu=cx;if(aU===l.SYMETRIC_GRADUATIONS&&cx>180){cu=cx-360}else{if(aU===l.ORIENTED_GRADUATIONS&&cx>180){cu=360-cx}else{if(aU===l.FULLSYMETRIC_GRADUATIONS&&bV===-1){cu=cx-360;if(cu===-360){cu=0}}}}if(!cv){cu*=bt}return cw?cu:Math.round(cu*z)/z}function aq(cw){var cv=cw;if(cv===undefined||cv===null){return undefined}if(cv<-360||cv>360){cv=cv%360}if(cv<0){cv=360+cv}var cu;if(S!==undefined&&bT!==undefined){if(S<bT){if(cv>=S&&cv<=bT){return cv}else{cu=S-(360-(bT-S))/2;if(cu<-360||cu>360){cu=cu%360}if(cu<0){cu=360+cu}if(cv>=0&&cv<S||cv>=cu){return S}else{return bT}}}else{if(cv>=S||cv<=bT){return cv}else{cu=bT+(S-bT)/2;if(cu<-360||cu>360){cu=cu%360}if(cu<0){cu=360+cu}if(cv>=cu){return S}else{return bT}}}}else{return cv}}function bu(){bK("_updateGraduationColors");var cu=new m.Color(bh.backgroundColor).getHSL().l*255;if(cu>120){bN="80, 80, 80";aC="0,0,0"}else{bN="220,220,220";aC="240,240,240"}bJ("_updateGraduationColors")}function ae(){if(!bw){return true}return Math.abs(bw.dot(bI.getSightDirection()))<=0.2}function b7(cv){if(cv.eventType==="@onPrimaryPointerMoveUniqueEvent"){if(cv.from[0].currentPosition&&!isNaN(cv.from[0].currentPosition.x)&&!isNaN(cv.from[0].currentPosition.y)){ci.x=cv.from[0].currentPosition.x;ci.y=cv.from[0].currentPosition.y}return}if(w){w=false;return}if(cv&&!b1&&!bZ){var cu=ce.children[0];if(!cu&&bA.getVisibleFlag()){setTimeout(function(){var cz=null;if(bi){cz="ruler"}if(cz===null){var cA=bh.getMousePosition(cv.from[0].getCurrentPosition(bh));var cw=bh.pick(cA,"primHybrid",false);if(0===cw.path.length||!cw.path[0]){cw=bh.pick(cA,"mesh",false);if(0===cw.path.length||!cw.path[0]){cz=""}}if(cz===null){var cy=cw.path[0];if(cy&&cy.externalPath){for(var cx=0;cx<cy.externalPath.length;cx++){if(cy.externalPath[cx].name==="rulerMainNode"){cz="ruler"}}}}}if(cz===""&&T){bA.clear()}},0)}else{if(cu){cu.validateEditor()}}}}function bW(cv,cw){if(aS&&(cv===P||cv===ca||cv===av)){return}if(cv){if(cv.material){if(cv.material.map&&cw){cv.material.map.dispose()}cv.material.dispose()}for(var cu=cv.children.length-1;cu>=0;cu--){bW(cv.children[cu],cw)}cv.removeChildren()}}function cn(cu,cv){return aZ.publish({event:cu,data:cv,context:this})}function G(cu){bK("_stroke");cu.stroke();bJ("_stroke")}function br(cH){bK("_generateMainCanvas");var cu;var cz=cH?b9:bQ;cz.width=Math.round(bx);cz.height=Math.round(bx);var cw=cz.getContext("2d");cw.clearRect(0,0,cz.width,cz.height);var cG=0;var cE=0;cw.translate(Math.round(bx/2),Math.round(bx/2));var cR=cH?Math.min(v*1.5,Math.PI):v;var cO=Math.round(Math.cos(cR)*(aI+bg));var cx=Math.round(Math.sin(cR)*(aI+bg));var cN=Math.round((aI+bg));var cv=Math.round(Math.sin(cR-Math.PI/4)*(aI+bg)*Math.sqrt(2));var cy=M?0.25:0.4;var cB=M?bN:"255, 255, 255";cu=cw.createLinearGradient(cO,cx,cN,cv);cu.addColorStop(0,"rgba("+cB+",0)");cu.addColorStop(cH||M?0.75:0.25,"rgba("+cB+","+cy+")");if(cR!==Math.PI){cw.strokeStyle=cu}else{cw.strokeStyle="rgba("+cB+","+cy+")"}if(!M){cw.beginPath();cw.arc(cG,cE,Math.round(aI+bg/2),0,cR,false);cw.lineWidth=bg;G(cw)}if(cR!==Math.PI){cw.strokeStyle=cu}else{cw.strokeStyle="rgba("+cB+","+cy+")"}cw.lineWidth=2*aQ;cw.beginPath();cw.arc(cG,cE,aI,0,cR,false);G(cw);if(!M){cw.beginPath();cw.arc(cG,cE,(aI+bg),0,cR,false);G(cw)}cO=Math.round(Math.cos(-cR)*(aI+bg));cx=Math.round(Math.sin(-cR)*(aI+bg));cv=Math.round(Math.sin(-cR+Math.PI/4)*(aI+bg)*Math.sqrt(2));cu=cw.createLinearGradient(cO,cx,cN,cv);cu.addColorStop(0,"rgba("+cB+",0)");cu.addColorStop(cH||M?0.75:0.25,"rgba("+cB+","+cy+")");if(cR!==Math.PI){cw.strokeStyle=cu}else{cw.strokeStyle="rgba("+cB+","+cy+")"}if(!M){cw.beginPath();cw.arc(cG,cE,Math.round(aI+bg/2),-cR,0,false);cw.lineWidth=bg;G(cw)}if(cR!==Math.PI){cw.strokeStyle=cu}else{cw.strokeStyle="rgba("+cB+","+cy+")"}cw.lineWidth=2*aQ;cw.beginPath();cw.arc(cG,cE,aI,-cR,0,false);G(cw);if(!M){cw.beginPath();cw.arc(cG,cE,aI+bg,-cR,0,false);G(cw)}cy=M?0.8:0.5;var cI,cQ;if(aN){var cM=ba-b5;if(cM<-360||cM>360){cM=cM%360}if(cM<0){cM=360+cM}cM*=Math.PI/180;var cK=bH;if(F||B){cK=af}if(cM!==0){var cD=cM>Math.PI?-1:1;cO=Math.round(Math.cos(ck?-cM:cM)*(aI+bg));cx=Math.round(Math.sin(ck?-cM:cM)*(aI+bg));cN=Math.round(aI+bg);if(ck){cv=Math.round(cD<0?0:aI+bg)}else{cv=Math.round(cD<0?aI+bg:0)}cu=cw.createLinearGradient(cO,cx,cN,cv);cu.addColorStop(0,"rgba("+cK+",0)");cu.addColorStop(0.6,"rgba("+cK+","+cy+")");cw.strokeStyle=cu;cw.beginPath();var cF=cD===1?0:-(2*Math.PI-cM);var cJ=cD===1?cM:0;if(ck){cF=cD===1?-cM:0;cJ=cD===1?0:-cM}var cA=M?aI:Math.round(F?aI+(aa+bg+bp)/2:aI+bg/2);cw.arc(cG,cE,cA,cF,cJ,false);cw.lineWidth=M?2*aQ:Math.round(F?aa+bg+bp:bg);G(cw)}else{if(!M){cI=Math.min(cR*0.2,Math.PI/8);cO=Math.round(Math.cos(cI)*(aI+bg));cx=Math.round(Math.sin(cI)*(aI+bg));cN=Math.round(aI+bg);cv=0;cu=cw.createLinearGradient(cO,cx,cN,cv);cu.addColorStop(0,"rgba("+cK+",0)");cu.addColorStop(1,"rgba("+cK+","+cy+")");cw.strokeStyle=cu;cw.beginPath();cw.arc(cG,cE,Math.round(F?(aI+bg/2+aa/2):(aI+bg/2)),0,cI,false);cw.lineWidth=Math.round(F?(aa+bg):bg);G(cw);cI=2*Math.PI-cI;cO=Math.round(Math.cos(cI)*(aI+bg));cx=Math.round(Math.sin(cI)*(aI+bg));cu=cw.createLinearGradient(cO,cx,cN,cv);cu.addColorStop(0,"rgba("+cK+",0)");cu.addColorStop(1,"rgba("+cK+","+cy+")");cw.strokeStyle=cu;cw.beginPath();cw.arc(cG,cE,Math.round(F?(aI+bg/2+aa/2):(aI+bg/2)),0,cI,true);cw.lineWidth=Math.round(F?(aa+bg):bg);G(cw)}}}cy=M?0.8:0.7;if(!cH&&!aN&&(F||B)){if(ba!==0){cQ=0;cI=0;var cL=new m.Vector3().copy(bI.getSightDirection()).normalize();var cC=bw.dot(cL);var cP=false;if(ba<180&&ba>0){cI=ba>(cR*180/Math.PI)?cR:ba*Math.PI/180}else{if(ba>=180&&ba<360){cI=ba*Math.PI/180;cP=true}}cO=Math.round(Math.cos(cI)*(aI+bg));cx=Math.round(Math.sin(cI)*(aI+bg));cN=Math.round(aI+bg);cv=0;cu=null;if(cC<0){cu=cw.createLinearGradient(cO,cx,cN,cv);cu.addColorStop(0,"rgba("+af+",0)");cu.addColorStop(1,"rgba("+af+","+cy+")")}else{cO=Math.round(Math.cos(-cI)*(aI+bg));cx=Math.round(Math.sin(-cI)*(aI+bg));cu=cw.createLinearGradient(cN,cv,cO,cx);cu.addColorStop(0,"rgba("+af+","+cy+")");cu.addColorStop(1,"rgba("+af+",0)")}cw.strokeStyle=cu;cw.beginPath();cw.arc(cG,cE,M?aI:Math.round(F?(aI+bg/2+aa/2+bp/2):(aI+bg/2)),cC<0?cQ:-cI,cC<0?cI:0,cP);cw.lineWidth=M?2*aQ:Math.round(F?(aa+bg+bp):bg);G(cw)}else{if(!M){cI=Math.min(cR*0.2,Math.PI/8);cO=Math.round(Math.cos(cI)*(aI+bg));cx=Math.round(Math.sin(cI)*(aI+bg));cN=Math.round(aI+bg);cv=0;cu=cw.createLinearGradient(cO,cx,cN,cv);cu.addColorStop(0,"rgba("+af+",0)");cu.addColorStop(1,"rgba("+af+","+cy+")");cw.strokeStyle=cu;cw.beginPath();cw.arc(cG,cE,Math.round(F?(aI+bg/2+aa/2):(aI+bg/2)),0,cI,false);cw.lineWidth=Math.round(F?(aa+bg):bg);G(cw);cI=2*Math.PI-cI;cO=Math.round(Math.cos(cI)*(aI+bg));cx=Math.round(Math.sin(cI)*(aI+bg));cu=cw.createLinearGradient(cO,cx,cN,cv);cu.addColorStop(0,"rgba("+af+",0)");cu.addColorStop(1,"rgba("+af+","+cy+")");cw.strokeStyle=cu;cw.beginPath();cw.arc(cG,cE,Math.round(F?(aI+bg/2+aa/2):(aI+bg/2)),0,cI,true);cw.lineWidth=Math.round(F?(aa+bg):bg);G(cw)}}}bJ("_generateMainCanvas");return cz}function cr(){var cv=bh.currentViewpoint.create3DRayFrom2DPoint(ci);var cu=new m.Plane().setFromNormalAndCoplanarPoint(bw,cc);return cv.intersectPlane(cu)}function D(cu){if(S===undefined||bT===undefined){return true}if(S<bT){return cu>=S&&cu<=bT}else{return cu>=S||cu<=bT}}function C(cu){if(cu<0.1){return 0}else{if(cu>=0.1&&cu<0.4){return 0.25}else{if(cu>=0.4&&cu<0.7){return 0.55}else{if(cu>=0.7&&cu<0.9){return 0.75}}}}return 1}function ai(cz){var cx=bA.getMatrix();var cv=cx.elements;var cy=new m.Vector3(cv[4],cv[5],cv[6]);var cu=(ba-cz)*Math.PI/180;if(!ck){cu=-cu}var cw=new m.Matrix4().makeRotationAxis(bw,cu);cy.applyMatrix4(cw);return cy.dot(bI.getUpDirection())<0}function bU(cu){cu.setSSAO(false);cu.setShadow(false,false);cu.setRenderDepth(0);cu.excludeFromCSO(true);cu.excludeFromHighlight(true,true);cu.setFrustumCulled(false)}function aH(cw){var cu=ba;var cv=cw.value;if(aU===l.FULLSYMETRIC_GRADUATIONS&&bV===-1){cv=cv-360;if(cv===-360){cv=0}}bZ=true;bA.setValue(cv);bZ=false;bi=false;cn("AngularRulerManipulateBegin",{eventName:"AngularRulerManipulateBegin",direction:bw,value:ba,event:cw.event});cn("AngularRulerManipulate",{eventName:"AngularRulerManipulate",direction:bw,value:ba,diffAngle:ba-cu,rulerDragged:false,event:cw.event});cn("AngularRulerManipulateEnd",{eventName:"AngularRulerManipulateEnd",status:"Validated",direction:bw,value:ba,event:cw.event})}function bG(cv){if(bZ){bi=false;return}bi=true;var cu=cv.node;if(cu){cu.setRatio(1.05);bh.setTemporaryCursor("pointer");bh.render()}}function K(cv){if(bZ){return}bi=false;var cu=cv.node;if(cu){cu.setRatio(1);bh.unsetTemporaryCursor();bh.render()}}function bC(cG,cz,cB){bK("_drawTextCanvas");var cu=cB||{};var cy=cu.isCurrentValue||false;var cC=cu.onManipulatorPreactivated||false;var cI=cy&&bZ?1:2;var cJ=U*cI*(cy?1.2:1);var cx=cu.reverse;if(cy){cz.width=(bp+aa)*cI}else{cz.width=aa*cI}cz.height=cJ*2;var cv=cz.getContext("2d");cv.globalAlpha=cu.alpha;cv.clearRect(0,0,cz.width,cz.height);var cF=0;var cw=0;if(cx&&!(cy&&bZ&&L&&bo)){cv.rotate(Math.PI);cv.textAlign="right";cF=-10*cI;cw=-10*cI}else{cF=10*cI;cw=cz.height-10*cI}cv.translate(cF,cw);var cA;if(cy){if(F||B){cA="rgba("+af+",1)"}else{if(s){cA="rgba("+cm+",1)"}else{if(cC){cA="rgba("+bP+",1)"}else{cA="rgba("+aC+", 1)"}}}}else{cA="rgba("+bN+",1)"}var cH=a2(cG);if(J&&cy){cH=cH.toString()+" "+H}var cE=cv.font.split(" ");var cD=M?"bold ":"900 ";cv.font=cD+cJ+"pt "+cE[cE.length-1];if(cy&&(F||(s&&bN==="220,220,220"&&!B))){cv.shadowColor="white";cv.shadowBlur=3*cI}cv.fillStyle=cA;cv.fillText(cH,0,0);cz.textDisplayed=cH;bJ("_drawTextCanvas");return cz}function cg(cH,cK){bK("_createGraduationNode");var cD=null;var cx=null;var cC;var cy=cK.alpha;var cG=cK.color;var cJ=a2(cH,false,true);var cA=(ba-cH)*Math.PI/180;if(ck){cA=-cA}for(cC=0;cC<t.length;cC++){if(t[cC].toDispose===false&&t[cC].associatedValue===cH){cx=t[cC];break}}if(!cx){for(cC=0;cC<t.length;cC++){if(t[cC].toDispose===true){cx=t[cC];cx.manipulator.associatedValue=cH;cx.texture.dispose();break}}if(!cx){cx={};var cE=ap>=7?Math.floor(ap/2)-1:ap-1;var cM=v*180/(Math.PI*cE);var cv=k.createRectangleNode({width:aa,height:U*2,fill:true});bU(cv);cv.setMatrix(new m.Matrix4().makeTranslation(0,-U,0));var cF=new p({ratio:1});cF.addChild(cv);cx.texture=new m.Texture();cF.material=new m.MeshBasicMaterial({map:cx.texture,transparent:true,enableClipPlanes:false});cF.material.force=true;cF.material.depthTest=false;var cz=k.createCircleNode({radius:(aI+bg+aa+bp)*a7,segments:32,fill:true,startAngle:-cM*Math.PI/180,endAngle:cM*Math.PI/180});bU(cz);cz.material=new m.MeshBasicMaterial({map:bl,transparent:true,enableClipPlanes:false});cz.material.force=true;cz.material.depthTest=false;cz.setMatrix(new m.Matrix4().makeTranslation(-(aI+bg)*a7,0,-2*b0));var cL=new n({viewer:bh,value:cH,linkedNode:cF});cx.manipulator=cL;cL.subscribe("Click",aH);cL.subscribe("BeginManipulate",null);cL.subscribe("Manipulate",null);cL.subscribe("EndManipulate",null);cL.subscribe("BeginPreactivate",bG);cL.subscribe("EndPreactivate",K);cx.manipNode=new i();cx.manipNode.addChild(cF);cx.manipNode.addChild(cz);cx.token=cL.linkToNode(cx.manipNode);t.push(cx)}cx.associatedValue=cH}for(cC=0;cC<cj.length;cC++){if(cj[cC].toDispose===false&&cj[cC].associatedValue===cJ&&cj[cC].associatedAlpha===cy&&cj[cC].associatedColor===cG&&cj[cC].reverse===cK.reverse){cD=cj[cC];break}}if(!cD){if(cj.length===a8){for(cC=0;cC<cj.length;cC++){if(cj[cC].toDispose===true){cD=cj[cC];break}}}else{cD={canvas:document.createElement("canvas")};cj.push(cD)}cD.canvas=bC(cH,cD.canvas,cK);cD.associatedValue=cJ;cD.associatedAlpha=cy;cD.associatedColor=cG;cD.reverse=cK.reverse}cD.toDispose=false;cx.texture.image=cD.canvas;cx.texture.needsUpdate=true;cx.toDispose=false;var cw=-Math.sin(cA)*(aI+bg+by)*a7;var cI=(-bx/2-Math.cos(v)*aI)*a7+Math.cos(cA)*(aI+bg+by)*a7;var cu=new m.Matrix4().makeTranslation(cI,cw,0);var cB=new m.Matrix4().makeRotationZ((-1)*cA);cx.manipNode.setMatrix(cu.multiply(cB));cx.manipNode.setVisibility(true);P.addChild(cx.manipNode);bJ("_createGraduationNode")}function b3(){bK("_generateGraduations");var cu=bZ||b1?1:2;var cz=u;cz.width=Math.round(cu*bx);cz.height=Math.round(cu*bx);var c7=cz.getContext("2d");c7.clearRect(0,0,cz.width,cz.height);c7.translate(Math.round(cu*bx/2),Math.round(cu*bx/2));var c3=1;var cS=1;var cX=ba*Math.PI/180;var cw=180*(cX-v)/Math.PI;var c4=Math.floor(cw/b2);cw=(c4*b2).valueOf();var cI=b2;if(ap>=7){cI=2*b2}var cv=2*aX*cu;var c1=0;var cB=0;var cF=0;var cY=0;var cH=0;var cy=0;var cC=0;var cN=0;var cA=false;var cP=[];c7.textBaseline="middle";var cZ=[];var cR=[];var c2=(aI+bg)*Math.sin(v)*cu;var cT,cE;for(cT=0;cT<=ap;cT++){cB=((cT*b2+cw)*Math.PI/180);c1=ck?cB-cX:cX-cB;cF=Math.sin(c1)*(aI+bg)*cu;cY=Math.cos(c1)*(aI+bg)*cu;cH=Math.sin(c1)*aI*cu;cy=Math.cos(c1)*aI*cu;cC=Math.sin(c1)*(aI+0.75*bg)*cu;cN=Math.cos(c1)*(aI+0.75*bg)*cu;if(v===Math.PI){c3=1}else{if(Math.abs(c1)<=Math.PI/2){if(v<Math.PI/2){var cD=c2-Math.abs(cF);c3=(cD<cv)?cD/cv:1}else{c3=1}}else{var cL=(aI+bg)*Math.abs(Math.cos(v))*cu;var cM=cL-Math.abs(cY);c3=(cM<cv)?cM/cv:1}}if(Math.abs(c1)<=Math.PI/4&&Math.abs(cF)<cv){cS=Math.max(2*(Math.abs(cF)/cv)-1,0);cA=true}else{cS=c3;cA=false}cB=cT*b2+cw;var cV=cB;if(cB<0){cV=360+cB}else{if(cB>=360){cV=cB-360}}var cx;if(cB%cI===0){cx=Math.round(Math.max(cS-0.2,0)*10)/10;if(cx<0.1||(cA&&!bm&&cx<0.8)){cx=0}if(cx!==0){cx=C(cx+0.1);if(!D(cV)){cx=0}if(cx!==0){cP.push({val:cV,alpha:cx,nearCurrentValue:cA})}}}if(D(cV)){cx=Math.round(Math.max(cS-0.2,0)*10)/10;if(cx!==0){cx=C(cx+0.1);if(cx!==0){var c5={moveTo:{x:Math.round(cy),y:Math.round(cH)},alpha:cx,lineWidth:aQ*cu*2};if(cB%cI!==0){c5.lineTo={x:Math.round(cN),y:Math.round(cC)}}else{c5.lineTo={x:Math.round(cY),y:Math.round(cF)}}cZ.push(c5);if(cR.indexOf(cx)===-1){cR.push(cx)}}}}var cW,cQ;for(cE=1;cE<aj;cE++){cW=(cT+cE/aj)*b2+cw;cQ=cW;if(cW<0){cQ=360+cW}else{if(cW>=360){cQ=cW-360}}if(D(cQ)){var cK=cW*Math.PI/180-cX;if(!ck){cK=-cK}if(Math.abs(cK)>v){continue}cF=Math.sin(cK)*(aI+ay)*cu;cY=Math.cos(cK)*(aI+ay)*cu;cH=Math.sin(cK)*aI*cu;cy=Math.cos(cK)*aI*cu;var cO=(Math.abs(cH)<cv)?Math.max(2*Math.abs(cH)/cv-1,0):c3;if(v===Math.PI&&Math.cos(cK)<0){cO=1}cO=C(cO);if(cO===0){continue}var cG={moveTo:{x:Math.round(cy),y:Math.round(cH)},alpha:cO,lineWidth:aQ*cu};cG.lineTo={x:Math.round(cY),y:Math.round(cF)};cZ.push(cG);if(cR.indexOf(cO)===-1){cR.push(cO)}}}}var cU=[aQ*cu*2,aQ*cu];for(var c6=0;c6<cU.length;c6++){for(cT=0;cT<cR.length;cT++){c7.beginPath();if((c6===0&&F)||(c6===1&&B)){c7.strokeStyle="rgba("+af+","+cR[cT]+")"}else{c7.strokeStyle="rgba(0,0,0,"+cR[cT]+")"}for(cE=0;cE<cZ.length;cE++){if(cZ[cE].alpha===cR[cT]&&cU[c6]===cZ[cE].lineWidth){c7.lineWidth=cZ[cE].lineWidth;c7.moveTo(cZ[cE].moveTo.x,cZ[cE].moveTo.y);c7.lineTo(cZ[cE].lineTo.x,cZ[cE].lineTo.y)}}G(c7)}}for(cT=0;cT<t.length;cT++){t[cT].toDispose=true;t[cT].manipNode.setVisibility(false)}for(cT=0;cT<cj.length;cT++){cj[cT].toDispose=true}for(cT=0;cT<cP.length;cT++){var c0=a2(cP[cT].val);for(cE=0;cE<t.length;cE++){if(t[cE].associatedValue===cP[cT].val){t[cE].toDispose=false}}for(cE=0;cE<cj.length;cE++){if(cj[cE].associatedValue===c0&&cj[cE].associatedAlpha===cP[cT].alpha&&cj[cE].associatedColor===bN){cj[cE].toDispose=false}}}for(cT=0;cT<cP.length;cT++){var cJ=ai(cP[cT].val);cg(cP[cT].val,{alpha:cP[cT].alpha,nearCurrentValue:cP[cT].nearCurrentValue,color:bN,reverse:cJ})}bJ("_generateGraduations");return cz}function bj(cx){s=false;bi=false;var cv=ba;var cw=cx?(cx.event?cx.event:cx.from[0].event):null;if(!Y&&ce.children.length){var cu=ce.children[0].getInputValue();if(!(isNaN(cu)||!cu||cu==="")){var cy=parseFloat(cu)/bt;bE=true;bA.setValue(cy);bE=false;cn("AngularRulerManipulate",{eventName:"AngularRulerManipulate",direction:bw,value:ba,diffAngle:ba-cv,rulerDragged:false,event:cw})}}cn("AngularRulerManipulateEnd",{eventName:"AngularRulerManipulateEnd",status:"Validated",direction:bw,value:ba,event:cw});bS()}function a0(cv){s=false;bi=false;var cu=cv?(cv.event?cv.event:(cv.from?cv.from[0].event:null)):null;cn("AngularRulerManipulateEnd",{eventName:"AngularRulerManipulateEnd",status:"Cancelled",direction:bw,value:ba,event:cu});if(!cv.doNotRefresh){bS()}}function al(cC){bZ=false;if(!ce.children.length){var cw=a2(ba,true);var cz=z;if(cz<1){cz=cz/(aY>0?10:100)}else{cz=cz*(aY>0?10:100)}cw=Math.round(cw*cz)/cz;var cy=new j({value:cw,okCB:bj,cancelCB:a0,startValue:S*bt,endValue:bT*bt,frmWindow:a6});new n({viewer:bh}).linkToNode(cy);ce.addChild(cy);if(cC.event.from[0].currentPosition.x){ci.x=cC.event.from[0].currentPosition.x}if(cC.event.from[0].currentPosition.y){ci.y=cC.event.from[0].currentPosition.y}var cA=cr();var cD=new m.Matrix4().makeTranslation(cA.x,cA.y,cA.z);var cE=new m.Matrix4().getInverse(am.getMatrix());ce.setMatrix(cE.multiply(cD));var cB=-30,cx=-30;var cv=155,cu=30;cA=cC.event.from[0].currentPosition;if(cA.x+cB<0){cB=(-1)*cA.x+15}else{if(cA.x+cB+cv>bh.SCREEN_WIDTH&&(bh.SCREEN_WIDTH>cv)){cB=cB+(-1)*(cA.x+cB+cv-bh.SCREEN_WIDTH)-15}}if(cA.y+cx<0){cx=(-1)*cA.y+15}else{if(cA.y+cx+cu>bh.SCREEN_HEIGHT&&(bh.SCREEN_HEIGHT>cu)){cx=cx+(-1)*(cA.y+cx+cu-bh.SCREEN_HEIGHT)-15}}cy.setOffset(new m.Vector2(cB,cx));ca.setVisibility(false);w=true;bh.render()}}function cl(){var cz=ba-b5;if(cz<0){cz=360+cz}var cv=ck?cz<=180:cz>180;var cx,cu,cw;if(M){cx=bY;cu=W;cw=ar}else{cx=cv&&aN?a5:(aN?Z:b8);cu=cv&&aN?cq:(aN?aV:bv);cw=cv&&aN?co:(aN?cp:I)}var cy=Y===true?cu:(O?cw:cx);if(aw.material.map!==cy){aw.material.map=cy}bh.render()}function aK(){if(!bZ){ch.dispose();ch.image=bC(ba,ak,{isCurrentValue:true,onManipulatorPreactivated:true,alpha:1,reverse:ai(ba)});ch.needsUpdate=true;aT.setRatio(1.05);bi=true;bh.setTemporaryCursor("pointer");bh.render()}}function N(){if(bZ){bi=false;return}ch.dispose();ch.image=bC(ba,ak,{isCurrentValue:true,onManipulatorPreactivated:false,alpha:1,reverse:ai(ba)});ch.needsUpdate=true;aT.setRatio(1);bi=false;bh.unsetTemporaryCursor();bh.render()}function bd(cu){bK("_entireManipulationMeasure");bA.initValue=ba;bZ=true;L=cu&&cu.event&&cu.event.from&&cu.event.from.length&&cu.event.from[0].type==="Touch";bh.setTemporaryCursor("-webkit-grabbing",10);cn("AngularRulerManipulateBegin",{eventName:"AngularRulerManipulateBegin",value:ba,direction:bw,event:cu.event})}function a1(cx){bK("_manipulateCB");var cv=bA.getSnappedRotationValue(cx);var cu=cv.snappedRotationAngle;if(cv.returnCode!==0||cu===undefined){return}var cw=ba;bA.setValue(cu+bA.initValue);cn("AngularRulerManipulate",{eventName:"AngularRulerManipulate",value:cu,diffAngle:ba-cw,rulerDragged:true,direction:bw,event:cx.event});bJ("_manipulateCB")}function ad(cw,cv){F=false;B=false;bh.unsetTemporaryCursor();var cu=cv?cv:false;cn("AngularRulerManipulateEnd",{eventName:"AngularRulerManipulateEnd",status:"Validated",direction:bw,value:ba,event:cw.event});if(!cu){bS()}bZ=false;bJ("_entireManipulationMeasure")}function aB(cy){if(cy.event.from[0].currentPosition.x){ci.x=cy.event.from[0].currentPosition.x}if(cy.event.from[0].currentPosition.y){ci.y=cy.event.from[0].currentPosition.y}var cw=new m.Vector3().copy(cr()).sub(cc);var cu=ba;var cx=r.angleTo(cw)*180/Math.PI;var cz=new m.Vector3().copy(r).cross(cw);if(cz.dot(bw)<0){cx=360-cx}if(Math.abs(cu-cx)>=5){var cv=b2/aj;cx=Math.round(cx/cv)*cv;bA.setValue(cx);bd(cy);cn("AngularRulerManipulate",{eventName:"AngularRulerManipulate",direction:bw,value:ba,diffAngle:ba-cu,rulerDragged:false,event:cy.event})}else{bd(cy)}Y=true}function bB(cx){if(bZ){bi=false;return}if(cx.event.from[0].currentPosition.x){ci.x=cx.event.from[0].currentPosition.x}if(cx.event.from[0].currentPosition.y){ci.y=cx.event.from[0].currentPosition.y}var cv=new m.Vector3().copy(cr()).sub(cc);var cu=ba;var cw=r.angleTo(cv)*180/Math.PI;var cy=new m.Vector3().copy(r).cross(cv);if(cy.dot(bw)<0){cw=360-cw}O=false;if(Math.abs(cu-cw)<5){O=true;if(!M){au.setVisibility(false);bk.setVisibility(true)}}else{if(!M){au.setVisibility(true);bk.setVisibility(false)}}bh.setTemporaryCursor("pointer");cl()}function a4(){bi=false;O=false;if(bZ){return}au.setVisibility(false);bk.setVisibility(true);bh.unsetTemporaryCursor();cl()}function ag(){bK("_initRulerParameters");if(!a9){if(!bA.origin){return}cc=new m.Vector3().copy(bA.origin);if(!bA.direction){return}bw=new m.Vector3().copy(bA.direction).normalize();var cI=l.DEG_UNIT,cu=false;bt=1;if(typeof bA.unit==="number"){if(bA.unit&l.RAD_UNIT){cI=l.RAD_UNIT;bt=Math.PI/180}else{if(bA.unit&l.GRAD_UNIT){cI=l.GRAD_UNIT;bt=1/0.9}else{if(bA.unit&l.MRAD_UNIT){cI=l.MRAD_UNIT;bt=1000*Math.PI/180}else{if(bA.unit&l.INPERFOOT_UNIT){cI=l.INPERFOOT_UNIT;bt=1/4.77464829}else{if(bA.unit&l.PERCENT_UNIT){cI=l.PERCENT_UNIT;bt=100/360}}}}}}else{if(window.widget&&window.widget.hasPreference&&window.widget.hasPreference("Angle")){var cz=window.widget.getValue("Angle");if(cz){switch(cz){case"deg":cI=l.DEG_UNIT;bt=1;break;case"rad":cI=l.RAD_UNIT;bt=Math.PI/180;break}}}}for(var cJ=0;cJ<h.length;cJ++){if(cI===h[cJ].unit&&H!==h[cJ].nls){cu=true;H=h[cJ].nls;break}}J=typeof bA.displayUnit==="boolean"?bA.displayUnit:true;ab=typeof bA.radius==="number"&&!isNaN(bA.radius)&&bA.radius>=0?bA.radius:0;bb=typeof bA.worldRadius==="number"&&!isNaN(bA.worldRadius)&&bA.worldRadius>=0?bA.worldRadius:0;if(bA.originVector){bM=new m.Vector3().copy(bA.originVector).normalize()}if(bM&&Math.round(bM.dot(bw)*100)/100!==0){return}if(typeof bA.openingAngle==="number"&&!isNaN(bA.openingAngle)){if(bA.openingAngle<-360||bA.openingAngle>360){bA.openingAngle=bA.openingAngle%360}if(bA.openingAngle<0){bA.openingAngle=360+bA.openingAngle}if(bA.openingAngle===0){bA.openingAngle=360}v=bA.openingAngle/2}else{v=45}v*=Math.PI/180;b2=typeof bA.mainGrad==="number"&&!isNaN(bA.mainGrad)&&bA.mainGrad>0?bA.mainGrad:10;aj=typeof bA.nbSecondaryGrads==="number"&&!isNaN(bA.nbSecondaryGrads)&&bA.nbSecondaryGrads>=0?bA.nbSecondaryGrads+1:5;S=typeof bA.startValue==="number"&&!isNaN(bA.startValue)?bA.startValue:undefined;bT=typeof bA.endValue==="number"&&!isNaN(bA.endValue)?bA.endValue:undefined;if(S!==undefined&&bT!==undefined){if(S<-360||S>360){S=S%360}if(S<0){S=360+S}if(bT<-360||bT>360){bT=bT%360}if(bT<0){bT=360+bT}if(S===bT){bT=undefined;S=undefined}}b5=typeof bA.originValue==="number"&&!isNaN(bA.originValue)?bA.originValue:0;b5=aq(b5);aU=bA.graduationsDisplay===l.SYMETRIC_GRADUATIONS||bA.graduationsDisplay===l.FULLSYMETRIC_GRADUATIONS||bA.graduationsDisplay===l.ORIENTED_GRADUATIONS?bA.graduationsDisplay:l.DEFAULT_GRADUATIONS;M=typeof bA.lightDisplay==="boolean"?bA.lightDisplay:false;bq=typeof bA.displayRulerDuringLocalTransfo==="boolean"?bA.displayRulerDuringLocalTransfo:false;aN=typeof bA.displayOrigin==="boolean"?bA.displayOrigin:false;T=typeof bA.hideOnEmptySelection==="boolean"?bA.hideOnEmptySelection:true;aY=0;if(typeof bA.nbDecimals==="number"){if(bA.nbDecimals>=0&&bA.nbDecimals<=9){aY=bA.nbDecimals}else{if(bA.nbDecimals<0){aY=0}else{if(bA.nbDecimals>9){aY=9}}}}bp=0;if(J){if(cI!==l.DEG_UNIT&&cI!==l.PERCENT_UNIT){var cw=aA.getContext("2d");var cG=cw.font.split(" ");var cC=M?"bold ":"900 ";cw.font=cC+U*1.1+"pt "+cG[cG.length-1];bp=Math.round(cw.measureText(" "+H).width*10)/10}else{bp=5}}bu();bZ=false;F=false;B=false;Y=false;s=false;bm=false;var cK;if(bI.getProjectionType()===1){cK=bI.camera.top-bI.camera.bottom}else{var cy=bI.getAngle()*Math.PI/180;var cB=new m.Vector3().copy(bI.getEyePosition());var cA=new m.Vector3().copy(cc);var cH=new m.Vector3().subVectors(cA,cB);cK=2*Math.tan(0.5*cy)*cH.length()}var cv=bI.camera.height&&bI.camera.fullHeight?bI.camera.height/bI.camera.fullHeight:1;a7=cK*cv/bh.SCREEN_HEIGHT;if(a7<1){b0=a7}aI=Math.max(bb/a7,0);aI+=ab;aI=Math.max(aI,100);var cF=aa;z=1;if(aY>0){aa=100+aY*15;z=Math.pow(10,aY)}else{aa=100}bx=2*(aI+bg+aa+bp);if(aa!==cF||cu){if(aN){bc=document.createElement("canvas")}cj.length=0;aS=false}ct=new m.Vector3().copy(bw);if(!bM){q=new m.Vector3(ct.y,ct.x,0).normalize();if(q.x===0&&q.y===0&&q.z===0){q=new m.Vector3(ct.z,0,ct.x).normalize()}r=new m.Vector3().crossVectors(ct,q).normalize()}else{r=new m.Vector3().copy(bM)}q=new m.Vector3().crossVectors(ct,r).normalize();var cx=ct.dot(bI.getSightDirection())>0;if(cx){q.multiplyScalar(-1);ct.multiplyScalar(-1);ck=true}else{ck=false}ap=Math.round((2*v*180)/(Math.PI*b2));ap++;if(at===0){var cE=false;var cD=function(){if(ce&&ce.children.length){a0({doNotRefresh:true})}if(!bq){if(bA.getVisibleFlag()===true){bA.setVisibleFlag(false);cE=true}if(!b1){if(aM){clearTimeout(aM);aM=null}aM=setTimeout(bO,200)}}else{var cM=new m.Vector3().copy(bw);var cL=cM.dot(bI.getSightDirection());if(ck===cL>0){aS=true}else{cE=true}if(!ae()){if(cE&&aS&&b1){aS=false;cE=false}bS()}else{am.setVisibility(false);ax.setVisibility(false)}aS=false}};bO=function(){if(!bq){if(cE){bA.setVisibleFlag(true);if(bb===0){if(!ae()){bS()}else{am.setVisibility(false);ax.setVisibility(false)}b1=false}else{b1=false;bS()}}}cE=false};at=d.subscribe({event:"/VISU/"},function(cL){if(cL.eventType==="@onViewpointBeginMove"){b1=true}else{if(cL.eventType==="@onViewpointChange"){cD()}else{if(cL.eventType==="@onViewpointEndMove"){bO();b1=false}}}});a3=bh.onBackgroundModify(function(){if(bA.getVisibleFlag()){bS()}});b.addEvent(bh.canvas,"onPrimaryPointerClick",b7);b.addEvent(bh.canvas,"onPrimaryPointerMoveUnique",b7)}a9=true}bJ("_initRulerParameters")}bS=function(){bK("_internalDisplay");az();ag();bF();var cu=bA.value;if(aU===l.FULLSYMETRIC_GRADUATIONS&&bV===-1){cu=cu-360;if(cu===-360){cu=0}}bA.setValue(cu);bJ("_internalDisplay")};az=function(){bK("_internalClear");if(a9){if(aM&&bO){clearTimeout(aM);aM=null;bO();bO=null}if(!aS){for(var cu=0;cu<t.length;cu++){if(t[cu].manipulator&&t[cu].token!==0){t[cu].manipulator.unlink(t[cu].token)}bW(t[cu].manipNode,false);t[cu].texture.dispose()}t.splice(0,t.length);if(aE!==0){bX.unlink(aE)}if(X!==0){bf.unlink(X)}X=0;aE=0;bX=null;bf=null}if(bs!==0){x.unlink(bs)}if(aD!==0){aJ.unlink(aD)}aD=0;bs=0;aJ=null;x=null;bW(am,false);bW(ax,false);bh.removeNode(am);bh.removeNode(ax);if(at!==0&&(!bq||(bq&&!b1))){d.unsubscribe(at);bh.unsubscribe(a3);b.removeEvent(bh.canvas,"onPrimaryPointerClick",b7);b.removeEvent(bh.canvas,"onPrimaryPointerMoveUnique",b7);at=0}a9=false;ba=null}bJ("_internalClear")};bF=function(){bK("_internalBuild");if(!a9){return}if(aI<bh.SCREEN_WIDTH||aI<bh.SCREEN_HEIGHT){bk=k.createRectangleNode({width:bx*a7,height:bx*a7,fill:true});bU(bk);bk.material=new m.MeshBasicMaterial({map:aG,transparent:true,enableClipPlanes:false});bk.material.force=true;bk.material.depthTest=false;bk.setMatrix(new m.Matrix4().makeTranslation(-(bx+aI*Math.cos(v))*a7,-bx*a7/2,-3*b0));if((!b1&&bb===0)||bb!==0){ah=true}if(!M){au=k.createRectangleNode({width:bx*a7,height:bx*a7,fill:true});bU(au);if(!aN&&ah){be.dispose();be.image=br(true);be.needsUpdate=true}au.material=new m.MeshBasicMaterial({map:be,transparent:true,enableClipPlanes:false});au.material.force=true;au.material.depthTest=false;au.setMatrix(new m.Matrix4().makeTranslation(-(bx+aI*Math.cos(v))*a7,-bx*a7/2,-3*b0));E=k.createRectangleNode({width:bx*a7,height:bx*a7,fill:true});bU(E);E.material=new m.MeshBasicMaterial({map:cs,transparent:true,enableClipPlanes:false});E.material.force=true;E.material.depthTest=false;E.setMatrix(new m.Matrix4().makeTranslation(-(bx+aI*Math.cos(v))*a7,-bx*a7/2,-2*b0))}var cN,cv;if(!aS){cv=k.createRectangleNode({width:bp+aa,height:U*2.4,fill:true});bU(cv);cv.setMatrix(new m.Matrix4().makeTranslation(0,-U*1.2,0));aT=new p({ratio:1});aT.addChild(cv);aT.setVisibility(true);aT.material=new m.MeshBasicMaterial({map:ch,transparent:true,enableClipPlanes:false});aT.material.force=true;ca.addChild(aT);cN=Math.PI/12;var cy=k.createCircleNode({radius:(aI+bg+aa+bp)*a7,segments:32,fill:true,startAngle:-cN,endAngle:cN});bU(cy);cy.material=new m.MeshBasicMaterial({map:bl,transparent:true,enableClipPlanes:false});cy.material.force=true;cy.material.depthTest=false;cy.setMatrix(new m.Matrix4().makeTranslation(-(aI+bg)*a7,0,0));ca.addChild(cy);if(!M){var cu=k.createCircleNode({radius:(aI+bg+aa+bp)*a7,segments:32,fill:true,startAngle:-2*cN,endAngle:2*cN});bU(cu);cu.material=new m.MeshBasicMaterial({map:bl,transparent:true,enableClipPlanes:false});cu.material.force=true;cu.material.depthTest=false;cu.setMatrix(new m.Matrix4().makeTranslation(-(aI+bg)*a7,0,-2*b0));ca.addChild(cu)}var cw=M?(-bx/2+(1-Math.cos(v))*aI+by)*a7:(-bx/2+(1-Math.cos(v))*aI+bg+by)*a7;ca.setMatrix(new m.Matrix4().makeTranslation(cw,0,0));if(X===0){bf=new n({viewer:bh,axis:new m.Vector3().copy(bw),center:cc});bf.subscribe("Click",al);bf.subscribe("BeginManipulate",function(cP){Y=false;s=true;bd(cP)});var cA=true;bf.subscribe("Manipulate",function(cP){cA=false;a1(cP)});bf.subscribe("EndManipulate",function(cP){Y=false;s=false;ad(cP,cA)});bf.subscribe("BeginPreactivate",aK);bf.subscribe("EndPreactivate",N);X=bf.linkToNode(ca)}}cN=1.5*v;if(cN>Math.PI){cN=Math.PI}var cx=M?(aI+bg/2)*a7:(aI+bg/2)*a7;var cL=k.createCircleNode({radius:cx,segments:32,fill:true,startAngle:-cN,endAngle:cN});bU(cL);aL.addChild(cL);aL.material=new m.MeshBasicMaterial({map:bl,transparent:true,enableClipPlanes:false});aL.material.force=true;aL.material.depthTest=false;aL.setMatrix(new m.Matrix4().makeTranslation(-(bx/2+aI*Math.cos(v))*a7,0,b0));if(bs===0){x=new n({viewer:bh,axis:new m.Vector3().copy(bw),center:cc});x.subscribe("BeginManipulate",aB);x.subscribe("Manipulate",a1);x.subscribe("EndManipulate",function(cP){Y=false;ad(cP)});x.subscribe("Click",function(cP){Y=false;ad(cP)});x.subscribe("Preactivate",bB);x.subscribe("EndPreactivate",a4);bs=x.linkToNode(aL)}cN=Math.min(-2*v,Math.PI);cx=M?(aI-bg/2)*a7:aI*a7;var cK=k.createCircleNode({radius:cx,segments:32,fill:true,startAngle:-cN,endAngle:cN});bU(cK);aF.addChild(cK);aF.material=new m.MeshBasicMaterial({map:bl,transparent:true,enableClipPlanes:false});aF.material.force=true;aF.material.depthTest=false;aF.setMatrix(new m.Matrix4().makeTranslation(-(bx/2+aI*Math.cos(v))*a7,0,2*b0));var cI,cO;if(aN){if(!aS&&!M){cv=k.createRectangleNode({width:aa,height:U*2,fill:true});bU(cv);cv.setMatrix(new m.Matrix4().makeTranslation(0,-U,0));var cF=new p({ratio:1});cF.addChild(cv);cb.image=bC(b5,bc,{alpha:1,reverse:ai(b5)});cb.needsUpdate=true;cF.material=new m.MeshBasicMaterial({map:cb,transparent:true,enableClipPlanes:false});cF.material.force=true;cF.material.depthTest=false;av.addChild(cF);var cC=ap>=7?Math.floor(ap/2)-1:ap-1;cN=v/cC;var cG=k.createCircleNode({radius:(aI+bg+aa+bp)*a7,segments:32,fill:true,startAngle:-cN,endAngle:cN});bU(cG);cG.material=new m.MeshBasicMaterial({map:bl,transparent:true,enableClipPlanes:false});cG.material.force=true;cG.material.depthTest=false;cG.setMatrix(new m.Matrix4().makeTranslation(-(aI+bg)*a7,0,-2*b0));av.addChild(cG);bX=new n({viewer:bh,value:b5,linkedNode:cF});bX.subscribe("Click",aH);bX.subscribe("BeginManipulate",null);bX.subscribe("Manipulate",null);bX.subscribe("EndManipulate",null);bX.subscribe("BeginPreactivate",bG);bX.subscribe("EndPreactivate",K);aE=bX.linkToNode(av)}if(!M){cI=((bg+V+4*aQ))*a7;if(aN){cO=(aX/2+2*aQ)*a7}else{cO=(aX+aQ)*a7}}else{cI=0.8*aR*a7;cO=0.8*aR*a7}cf=k.createRectangleNode({width:cI,height:cO,fill:true});bU(cf);cf.material=new m.MeshBasicMaterial({map:M?ao:bR,transparent:true,enableClipPlanes:false});cf.material.force=true;cf.material.depthTest=false}if(!M){cI=((bg+V+4*aQ))*a7;if(aN){cO=(aX/2+2*aQ)*a7}else{cO=(aX+aQ)*a7}}else{cI=aR*a7;cO=aR*a7}aw=k.createRectangleNode({width:cI,height:cO,fill:true});bU(aw);aw.material=new m.MeshBasicMaterial({map:M?bY:(aN?Z:b8),side:m.DoubleSide,transparent:true,alphaTest:0.05,enableClipPlanes:false});aw.material.force=true;aw.material.depthTest=false;aw.setVisibility(true);if(aD===0){aJ=new n({viewer:bh,axis:new m.Vector3().copy(bw),center:cc});aJ.subscribe("Click",null);aJ.subscribe("BeginManipulate",function(cP){Y=true;s=false;bd(cP)});aJ.subscribe("Manipulate",a1);aJ.subscribe("EndManipulate",function(cP){Y=false;s=false;ad(cP)});aJ.subscribe("BeginPreactivate",function(){O=true;bh.setTemporaryCursor("pointer");cl()});aJ.subscribe("EndPreactivate",function(){O=false;bh.unsetTemporaryCursor();cl()});aD=aJ.linkToNode(aw)}if(aN){am.addChild(bD);if(!M){bD.addChild(cf);am.addChild(av)}else{var cz=new f({type:"Spherical"});cz.addChild(cf);cf.setMatrix(new m.Matrix4().makeTranslation(-aR*a7*0.4,-aR*a7*0.4,0));bD.addChild(cz)}}ax.addChild(bk);am.addChild(ca);am.addChild(aL);am.addChild(aF);am.addChild(y);am.addChild(ce);if(!M){y.addChild(aw);ax.addChild(au);ax.addChild(E);am.addChild(P)}else{var cE=new f({type:"Spherical"});cE.addChild(aw);aw.setMatrix(new m.Matrix4().makeTranslation(-aR*a7/2,-aR*a7/2,0));y.addChild(cE)}am.addChild(ac)}var cD=new m.Vector3((-bx/2+(1-Math.cos(v))*aI-V+10)*a7,0,0);var cB=new m.Vector3((-bx/2-Math.cos(v)*aI)*a7,0,0);var cJ=k.createLineNode({points:[cD,cB]});bU(cJ);cJ.material=new m.LineBasicMaterial({color:bN==="80, 80, 80"?0:16777215,opacity:0.5,transparent:true});cJ.material.force=true;cJ.material.depthTest=false;ax.addChild(cJ);if(aN){cD=new m.Vector3((-bx/2+(1-Math.cos(v))*aI-V+10)*a7,0,0);cB=new m.Vector3((-bx/2-Math.cos(v)*aI)*a7,0,0);cJ=k.createLineNode({points:[cD,cB]});bU(cJ);aO.addChild(cJ);aO.material=new m.LineBasicMaterial({color:bN==="80, 80, 80"?0:16777215,opacity:0.5,transparent:true});aO.material.force=true;aO.material.depthTest=false;ax.addChild(aO)}bh.addNode(am,false);bh.addNode(ax,false);var cH=new m.Vector3().copy(r).multiplyScalar((bx/2+aI*Math.cos(v))*a7);var cM=new m.Vector3().copy(cc).add(cH);Q=new m.Matrix4(r.x,q.x,ct.x,cM.x,r.y,q.y,ct.y,cM.y,r.z,q.z,ct.z,cM.z,0,0,0,1);am.setMatrix(Q);ax.setMatrix(Q);ba=null;bJ("_internalBuild")};function bz(){bK("_internalRefresh");if(!a9){bS();return}var cH=new m.Matrix4().makeRotationAxis(bw,bA.value*Math.PI/180);var cz=new m.Matrix4().setPosition(cc);var cN=new m.Matrix4().getInverse(cz).multiply(Q);var cG=new m.Matrix4().copy(cH).multiply(cN);var cR=new m.Matrix4().copy(cz).multiply(cG);am.setMatrix(cR);ax.setMatrix(cR);if((aI<bh.SCREEN_WIDTH||aI<bh.SCREEN_HEIGHT)&&bA.value!==ba){ba=bA.value;ce.removeChildren();bk.setVisibility(true);au.setVisibility(false);if(!aS){P.removeChildren();if(ah||aN){aG.dispose();aG.image=br(false);aG.needsUpdate=true}ah=false;if(aN&&!M){be.dispose();be.image=br(true);be.needsUpdate=true}if(!M){cs.dispose();cs.image=b3();cs.needsUpdate=true}ch.dispose();ch.image=bC(ba,ak,{isCurrentValue:true,onManipulatorPreactivated:false,alpha:1,reverse:ai(ba)});ch.needsUpdate=true}else{if(bb!==0){if(ah||aN){aG.dispose();aG.image=br(false);aG.needsUpdate=true}ah=false;if(aN&&!M){be.dispose();be.image=br(true);be.needsUpdate=true}if(!M){cs.dispose();cs.image=b3();cs.needsUpdate=true}}for(var cJ=0;cJ<t.length;cJ++){if(t[cJ].toDispose===false){var cC=(ba-t[cJ].associatedValue)*Math.PI/180;if(ck){cC=-cC}var cw=-Math.sin(cC)*(aI+bg+by)*a7;var cS=(-bx/2-Math.cos(v)*aI)*a7+Math.cos(cC)*(aI+bg+by)*a7;t[cJ].manipNode.setMatrix(new m.Matrix4().makeTranslation(cS,cw,0).multiply(new m.Matrix4().makeRotationZ((-1)*cC)))}}var cy=M?(-bx/2+(1-Math.cos(v))*aI+by)*a7:(-bx/2+(1-Math.cos(v))*aI+bg+by)*a7;ca.setMatrix(new m.Matrix4().makeTranslation(cy,0,0))}if(aN&&aU&&l.FULLSYMETRIC_GRADUATIONS&&aW!==bV){cb.dispose();cb.image=bC(b5,bc,{alpha:1,reverse:ai(b5)});cb.needsUpdate=true}var cV=0;if(aN){cV=(aX/2+2*aQ)*a7}else{cV=(aX+aQ)*a7}var cK=ba-b5;if(cK<0){cK=360+cK}var cx=ck?cK<=180:cK>180;var cL,cQ;if(!M){cL=cx&&aN?a5:(aN?Z:b8);cQ=cx&&aN?cq:(aN?aV:bv)}else{cL=bY;cQ=W}var cU=Y===true?cQ:cL;if(aw.material.map!==cU){aw.material.map=cU}var cv=new m.Matrix4();if(!M){if(aN){cv.makeTranslation((-bx/2+(1-Math.cos(v))*aI-V)*a7,!cx?0:-cV,0)}else{cv.makeTranslation((-bx/2+(1-Math.cos(v))*aI-V)*a7,-cV/2,0)}y.setMatrix(cv)}else{cv.makeTranslation((-bx/2+(1-Math.cos(v))*aI)*a7,0,0);y.setMatrix(cv)}if(aN){var cB=(ba-b5)*Math.PI/180;if(ck){cB=-cB}var cE=true;for(var cP=0;cP<t.length;cP++){if(t[cP].associatedValue===b5){cE=false}}if(cE&&!M){var cT=Math.abs(ba-b5);if(cT<180&&cT*Math.PI/180>v||cT>=180&&(360-cT)*Math.PI/180>v){var cO=new m.Matrix4().makeTranslation((-bx/2-Math.cos(v)*aI)*a7+Math.cos(cB)*(aI+bg+by)*a7,-Math.sin(cB)*(aI+bg+by)*a7,0);av.setMatrix(cO.multiply(new m.Matrix4().makeRotationZ(-cB)))}else{cE=false}}av.setVisibility(cE);if(!M){var cD=Y===true?(cx?aP:cd):(cx?b6:bR);if(cf.material.map!==cD){cf.material.map=cD}}var cM=new m.Matrix4().makeRotationAxis(bw,b5*Math.PI/180);var cF=new m.Matrix4().copy(cz).multiply(cM.multiply(cN));var cI=new m.Matrix4();if(!M){cI.makeTranslation((-bx/2+(1-Math.cos(v))*aI-V)*a7,!cx?-cV:0,0)}else{cI.makeTranslation((-bx/2+(1-Math.cos(v))*aI)*a7,0,0)}bD.setMatrix(new m.Matrix4().getInverse(cR).multiply(cF).multiply(cI))}if(bZ&&L&&bo){ca.setVisibility(false);if(!ac.children.length&&ch){var cu=new o({html:ch.image});ac.setMatrix(new m.Matrix4().makeTranslation((-bx/2+(1-Math.cos(v))*aI)*a7,0,0));ac.addChild(cu)}ac.children[0].setOffset(new m.Vector2((-ch.image.getContext("2d").measureText(ch.image.textDisplayed).width/2),-85))}else{ca.setVisibility(true);ac.removeChildren()}bm=true;bi=false}if(aN){var cA=new m.Matrix4().copy(cz).multiply(new m.Matrix4().makeRotationAxis(bw,b5*Math.PI/180).multiply(cN));aO.setMatrix(new m.Matrix4().getInverse(cR).multiply(cA))}am.setVisibility(ae()?false:bn);ax.setVisibility(ae()?false:bn);bh.render();bJ("_internalRefresh")}this.setValue=function(cw){bK("setValue");var cu=this.value,cv=cw;if(bE&&!bZ&&aU===l.ORIENTED_GRADUATIONS&&cu>180&&cu!==cv){cv=360-cv}cv=aq(cv);if(bZ&&cv%360===0){if(cu>=180){cv=360}else{if(cu<180){cv=0}}}aW=bV;if(aU===l.FULLSYMETRIC_GRADUATIONS){if(bZ&&(cv>300||cv<60)){if(cu<=180&&cv>180&&cu<cv){bV=-1}else{if(cu>180&&cv<=180&&cu>cv){bV=1}}}else{if(!bZ){bV=cw<0?-1:(cw>0?1:bV)}}}this.value=cv;if(this.getVisibleFlag()){bz()}bJ("setValue")};this.getDisplayedValue=function(cu){return a2(this.value,typeof cu==="boolean"?!cu:true)};this.getMatrix=function(){if(am){return new m.Matrix4().copy(am.getMatrixWorld())}return null};this.setVisibleFlag=function(cv){if(cv!==bn){bn=cv;am.setVisibility(ae()?false:bn);ax.setVisibility(ae()?false:bn);if(bn){var cu=this.value;if(aU===l.FULLSYMETRIC_GRADUATIONS&&bV===-1){cu=cu-360;if(cu===-360){cu=0}}this.setValue(cu)}bh.render()}};this.getVisibleFlag=function(){if(a9){return bn}else{return null}};this.setVisibilityFree=function(cu){if(am&&ax&&am.setVisibilityFree&&ax.setVisibilityFree){ax.setVisibilityFree(cu);am.setVisibilityFree(cu)}};this.getVisibilityFree=function(){if(am){return am.visibilityFree}return null};this.clear=function(){ah=false;w=false;bZ=false;bm=false;F=false;B=false;bi=false;O=false;Y=false;s=false;aS=false;b1=false;L=false;bo=false;az()};this.subscribe=function(cu,cv){if(!cu||!cv||(cu!=="AngularRulerManipulateBegin"&&cu!=="AngularRulerManipulate"&&cu!=="AngularRulerManipulateEnd")){return undefined}return aZ.subscribe({event:cu},cv)};this.unsubscribe=function(cu){if(cu===null||cu===undefined){return}aZ.unsubscribe(cu)};this.getSnappedRotationValue=function(cu){bK("getSnappedRotationValue");var cv=bw.dot(cu.axis);var cD=cv<0?2*Math.PI-cu.angle:cu.angle;cD=180*cD/Math.PI;if(F||B){ah=true}F=false;B=false;bo=false;var cE=cr();var cy=new m.Vector3().copy(cE).sub(cc);var cw=am.getMatrix().elements;var cF=new m.Vector3(cw[0],cw[1],cw[2]);var cA=Math.abs(cF.angleTo(cy));var cz=cy.length();var cC=1.5*v;if(cC>Math.PI){cC=Math.PI}var cx=M?(aI+bg)*a7:(aI+bg+aa+bp)*a7;if(cz<cx&&cA<cC){var cG;if((!M&&cz<aI*a7)||(M&&cz<(aI-bg)*a7)){cG="noSnap"}else{if((!M&&cz<(aI+bg)*a7)||(M&&cz<(aI+bg)*a7)){cG="snappingSmallGrads"}else{if(!M){cG="snappingMainGrads"}else{cG="noSnap"}}}if(cG!=="noSnap"){bo=true;ah=true;F=(cG==="snappingMainGrads");B=(cG==="snappingSmallGrads");cD+=this.initValue;var cB=cG==="snappingSmallGrads"?b2/aj:b2;cD=Math.round(cD/cB)*cB;cD=aq(cD);cD-=this.initValue}}else{if(M){bo=cz>aI*a7&&cz<(aI+bg/2+ch.image.getContext("2d").measureText(ch.image.textDisplayed).width)*a7}}bJ("getSnappedRotationValue");return{snappedRotationAngle:cD,axis:bw,returnCode:0}};this.beginManipulation=function(){bZ=true;am.setPickable(g.NODRAWHL)};this.endManipulation=function(){am.setPickable(g.PICKABLE);bZ=false;F=false;B=false};this.display=function(){ah=false;w=false;bZ=false;bm=false;F=false;B=false;bi=false;O=false;Y=false;s=false;aS=false;b1=false;L=false;bo=false;bS()};this.refresh=function(){this.setValue(this.value)}}});l.DEFAULT_GRADUATIONS=0;l.ORIENTED_GRADUATIONS=1;l.SYMETRIC_GRADUATIONS=2;l.FULLSYMETRIC_GRADUATIONS=3;l.DEG_UNIT=1<<0;l.RAD_UNIT=1<<1;l.GRAD_UNIT=1<<2;l.MRAD_UNIT=1<<3;l.INPERFOOT_UNIT=1<<4;l.PERCENT_UNIT=1<<5;require(["i18n!DS/Ruler/assets/nls/Ruler"],function(q){h.push({unit:l.DEG_UNIT,nls:String.fromCharCode(176)});h.push({unit:l.RAD_UNIT,nls:q.radLbl});h.push({unit:l.GRAD_UNIT,nls:q.gradLbl});h.push({unit:l.MRAD_UNIT,nls:q.mradLbl});h.push({unit:l.INPERFOOT_UNIT,nls:q.inPerFootLbl});h.push({unit:l.PERCENT_UNIT,nls:String.fromCharCode(37)})});return l});
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Ruler/Ruler",["UWA/Core","UWA/Class","DS/CoreEvents/ModelEvents","DS/Ruler/RulerEditor","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Ruler/RulerManipulator","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/WebappsUtils/WebappsUtils","DS/VisuEvents/EventsManager","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/SceneGraphNodes/CSS2DNode"],function(h,a,c,k,n,l,j,q,f,p,e,b,g,d,o){var m;var i=[];require(["i18n!DS/Ruler/assets/nls/Ruler"],function(r){i.push({unit:m.NM_UNIT,nls:r.nmLbl});i.push({unit:m.MICRON_UNIT,nls:r.micronLbl});i.push({unit:m.MM_UNIT,nls:r.mmLbl});i.push({unit:m.CM_UNIT,nls:r.cmLbl});i.push({unit:m.M_UNIT,nls:r.mLbl});i.push({unit:m.HM_UNIT,nls:r.hmLbl});i.push({unit:m.KM_UNIT,nls:r.kmLbl});i.push({unit:m.INCH_UNIT,nls:r.inLbl});i.push({unit:m.FOOT_UNIT,nls:r.ftbl});i.push({unit:m.YARD_UNIT,nls:r.yardLbl});i.push({unit:m.MILE_UNIT,nls:r.mileLbl});i.push({unit:m.NMILE_UNIT,nls:r.nmiLbl})});m=a.extend({init:function(bb,cr){var bZ=cr||{};this._parent(bZ);this.value=0;this.initValue=0;this.origin=new n.Vector3();this.direction=new n.Vector3(0,0,1);this.offset=bZ.offset;this.worldOffset=bZ.worldOffset;this.mainGrad=bZ.mainGrad;this.nbSecondaryGrads=bZ.nbSecondaryGrads;this.startValue=bZ.startValue;this.endValue=bZ.endValue;this.lightDisplay=bZ.lightDisplay;this.displayOrigin=bZ.displayOrigin;this.lockedOrigin=bZ.lockedOrigin;this.onOriginManipulator=bZ.onOriginManipulator;this.unit=bZ.unit;this.displayUnit=bZ.displayUnit;this.displayRulerDuringLocalTransfo=bZ.displayRulerDuringLocalTransfo;this.graduationsDisplay=bZ.graduationsDisplay;this.originValue=bZ.originValue;this.hideOnEmptySelection=bZ.hideOnEmptySelection;this.nbDecimals=bZ.nbDecimals;var bJ=this;var cz=new n.Vector3();var bF=null;var bf=null;var cs;var bS;var cI;var aR;var cH;var S;var L;var bC;var N;var bw;var V,b7;var cn;var an;var aY;var ct;var bV;var cF=new n.Vector2();var W;var a2;var by=true;var s,r,cR;var bN=350;var bG=150;var bc;var Y=14;var X=16;var aV=1;var bm=30;var a0=15;var bH=10;var bv;var aW=20;var aD=bm*0.33;var aj="255, 128, 0";var bT="115, 195, 225";var b3="130, 190, 220";var cK="40, 90, 120";var b0="80, 80, 80";var aH="0,0,0";var bg=1;var aJ=0;var B=1;var cb=false;var ay=cn;var az=cn;var a3=new c();var bn=bb.getViewer();var bW=bb.getViewpoint();var J;var P=48*0.45;var bK=80*0.45;var aq=new j("rulerMainNode");aq.setVisibilityInTree(false);aq.exludeFromBounding(true);aq._getExcludeFromCSO=function(){return true};aq.setNoZ(true);var G;var R=new j("rulerGraduationNode");var cy=new j();var A=new j();var aB;var aT;var a1=new j();a1.setPickable(g.NODRAWHL);var bO=new j("originArrowMNode");var aw=new j("originManipMNode");var cC;var U=null;var aG;var ck;var al=0;var cB=new j();var ag=new j();var aQ;var aA=new j();var aX;var cl=new f({constraintAxis:new n.Vector3(0,1,0),type:"Cylindrical"});var bz=null;var a6=null;var bd=60;var u=[];var cG=[];var a8=0;var ab=0;var aI=0;var bB=0;var bl=null;var y=null;var aO=null;var ax=0;var aK=0;var cd=null;var x=false;var ch=false;var w=false;var cm=false;var bQ=false;var bt=true;var bs=false;var H=false;var D=false;var bo=false;var cq=false;var ac=false;var F=false;var Q=false;var t=false;var be=false;var am=false;var M=false;var bu=false;var aS=null;var v=document.createElement("canvas");var b4=document.createElement("canvas");var ao=document.createElement("canvas");var bi=document.createElement("canvas");var bk=document.createElement("canvas");var at=document.createElement("canvas");var aL=document.createElement("canvas");at.width=1;at.height=1;var C=at.getContext("2d");C.clearRect(0,0,at.width,at.height);C.rect(0,0,at.width,at.height);C.fillStyle="rgba(0,0,0,0)";C.fill();var aM=new n.Texture();var cE=new n.Texture();var ci=new n.Texture();var br=new n.Texture();br.image=at;br.needsUpdate=true;var cu=new n.Texture();var T=e.getWebappsAssetUrl("Ruler","textures/");var cx=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerArrowManipulator.png",undefined,null,null,true);cx.flipY=false;var K=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerArrowManipulator_Over.png",undefined,null,null,true);K.flipY=false;var bE=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerArrowManipulator_On.png",undefined,null,null,true);bE.flipY=false;var af=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerArrowManipulator_Half.png",undefined,null,null,true);af.flipY=false;var cO=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerArrowManipulator_Half_Over.png",undefined,null,null,true);cO.flipY=false;var aZ=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerArrowManipulator_Half_On.png",undefined,null,null,true);aZ.flipY=false;var ba=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerArrowManipulator_Half.png",undefined,null,null,true);var cN=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerArrowManipulator_Half_Over.png",undefined,null,null,true);var cP=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerArrowManipulator_Half_On.png",undefined,null,null,true);var b6=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerZeroArrowManip.png",undefined,null,null,true);var cA=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerArrowManipulator_Half_On.png",undefined,null,null,true);var bx=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerArrowManipulator_Half_Over.png",undefined,null,null,true);var cv=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerZeroArrowManip.png",undefined,null,null,true);cv.flipY=false;var aU=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerArrowManipulator_Half_On.png",undefined,null,null,true);aU.flipY=false;var av=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerArrowManipulator_Half_Over.png",undefined,null,null,true);av.flipY=false;var cf=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerLight.png",undefined,null,null,true);var au=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerLightOver.png",undefined,null,null,true);var aa=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerLightOn.png",undefined,null,null,true);var ar=new n.ImageUtils.loadTexture(T+"Web3DUX_RulerLightZeroManip.png",undefined,null,null,true);var ce=T+"Web3DUX_OriginManipulator.png";var Z=T+"Web3DUX_OriginManipulatorOn.png";var cg=T+"Web3DUX_OriginManipulatorOver.png";var b2;var b5,aC,bP;function bY(cT){if(bJ.__performanceMeasures){for(var cS=0;cS<bJ.__performanceMeasures.measures.length;cS++){if(bJ.__performanceMeasures.measures[cS].id===cT){bJ.__performanceMeasures.measures[cS].mark=new Date().getTime();return}}bJ.__performanceMeasures.measures.push({id:cT,mark:new Date().getTime(),cumulatedTime:0,nbCalls:0})}}function bX(cT){if(bJ.__performanceMeasures){for(var cS=0;cS<bJ.__performanceMeasures.measures.length;cS++){if(bJ.__performanceMeasures.measures[cS].id===cT){bJ.__performanceMeasures.measures[cS].cumulatedTime+=new Date().getTime()-bJ.__performanceMeasures.measures[cS].mark;bJ.__performanceMeasures.measures[cS].nbCalls+=1;return}}}}function ca(cS){cS.setSSAO(false);cS.setShadow(false,false);cS.setRenderDepth(1);cS.excludeFromCSO(true);cS.excludeFromHighlight(true,true);cS.setFrustumCulled(false)}function E(cS){if(cS<0.15){return 0}else{if(cS>=0.15&&cS<0.4){return 0.25}else{if(cS>=0.4&&cS<0.7){return 0.55}else{if(cS>=0.7&&cS<0.9){return 0.75}}}}return 1}function b1(cT,cS,cW,cU,cV){bY("_fillRect");cT.fillRect(cS,cW,cU,cV);bX("_fillRect")}function I(cS){bY("_stroke");cS.stroke();bX("_stroke")}function cc(cT,cU){if(cT){if(cT.material){if(cT.material.map&&cU){cT.material.map.dispose()}cT.material.dispose()}for(var cS=cT.children.length-1;cS>=0;cS--){cc(cT.children[cS],cU)}cT.removeChildren()}}function cM(cS,cT){return a3.publish({event:cS,data:cT,context:this})}function cw(cT){if(cT.eventType==="@onPrimaryPointerMoveUniqueEvent"){if(cT.from[0].currentPosition&&!isNaN(cT.from[0].currentPosition.x)&&!isNaN(cT.from[0].currentPosition.y)){cF.x=cT.from[0].currentPosition.x;cF.y=cT.from[0].currentPosition.y}return}if(x){x=false;return}if(cT&&!cm&&!ch){var cS=cB.children[0];if(!cS&&bJ.getVisibleFlag()){var cU=bn.getMousePosition(cT.from[0].getCurrentPosition(bn));setTimeout(function(){var cY=null;if(bo||cq){cY="ruler"}if(cY===null){var cV=bn.pick(cU,"primHybrid",false);if(0===cV.path.length||!cV.path[0]){cV=bn.pick(cU,"mesh",false);if(0===cV.path.length||!cV.path[0]){cY=""}}if(cY===null){var cX=cV.path[0];if(cX&&cX.externalPath){for(var cW=0;cW<cX.externalPath.length;cW++){if(cX.externalPath[cW].name==="rulerMainNode"){cY="ruler"}}}}}if(cY===""&&W){bJ.clear()}},0)}else{if(cS){cS.validateEditor()}}}}aC=function(){bY("_internalClear");if(be){for(var cS=0;cS<u.length;cS++){if(u[cS].manipulator&&u[cS].token!==0){u[cS].manipulator.unlink(u[cS].token)}cc(u[cS].manipNode,false);u[cS].texture.dispose()}u.splice(0,u.length);if(aK!==0){cd.unlink(aK)}if(al!==0){U.unlink(al)}if(ab!==0){bl.unlink(ab)}if(bB!==0){y.unlink(bB)}if(aI!==0){aO.unlink(aI)}aI=0;ab=0;bB=0;aK=0;al=0;cd=null;U=null;if(ck){ck.destroy()}ck=null;bl=null;y=null;aO=null;cc(aq,false);bn.removeNode(aq);if(ax!==0&&!cm){d.unsubscribe(ax);bn.unsubscribe(a8);b.removeEvent(bn.canvas,"onPrimaryPointerClick",cw);b.removeEvent(bn.canvas,"onPrimaryPointerMoveUnique",cw);ax=0}be=false;bf=null}bX("_internalClear")};function cj(){bY("refreshOrigin");if(bJ.displayOrigin!==aR){aR=bJ.displayOrigin;for(var cS=0;cS<u.length;cS++){if(u[cS].manipulator&&u[cS].token!==0){u[cS].manipulator.unlink(u[cS].token)}cc(u[cS].manipNode,false);u[cS].texture.dispose()}u.splice(0,u.length);cc(aq,false);bn.removeNode(aq);bP();bJ.setValue(bJ.value)}bX("refreshOrigin")}function bU(){bY("_getRatio");var cY=0;var cT;if(bW.getProjectionType()===1){cT=bW.camera.top-bW.camera.bottom}else{var cZ=bW.getAngle()*Math.PI/180;var cS=bW.getEyePosition();var cU=new n.Vector3().copy(bF).multiplyScalar(bJ.value);var cW=new n.Vector3().copy(cz).add(cU);var cV=new n.Vector3().subVectors(cW,cS);cT=2*Math.tan(0.5*cZ)*cV.length()}var cX=bW.camera.height&&bW.camera.fullHeight?bW.camera.height/bW.camera.fullHeight:1;cY=cT*cX/bn.SCREEN_HEIGHT;bX("_getRatio");return cY}function bD(){bY("_updateGraduationColors");var cS=new n.Color(bn.backgroundColor).getHSL().l*255;if(cS>120){b0="80,80,80";aH="0,0,0"}else{b0="220,220,220";aH="240,240,240"}bX("_updateGraduationColors")}function bp(cW){t=false;bo=false;cq=false;var cT=bf;var cV=cW?(cW.event?cW.event:cW.from[0].event):null;if(!ac&&cB.children.length){var cS=cB.children[0].getInputValue();if(!(isNaN(cS)||!cS||cS==="")){var cX=parseFloat(cS)/bC;bQ=true;bJ.setValue(cX);bQ=false;var cU=new n.Vector3().copy(bF).multiplyScalar(bf-cT);cM("RulerManipulate",{eventName:"RulerManipulate",translationVector:cU,value:bf,direction:bF,rulerDragged:false,event:cV})}}cM("RulerManipulateEnd",{eventName:"RulerManipulateEnd",value:bf,direction:bF,status:"Validated",event:cV});b5()}function a4(cT){t=false;bo=false;cq=false;var cS=cT?(cT.event?cT.event:cT.from[0].event):null;cM("RulerManipulateEnd",{eventName:"RulerManipulateEnd",value:bf,direction:bF,status:"Cancelled",event:cS});b5()}function ai(){if(!bF){return true}return Math.abs(bF.dot(bW.getSightDirection()))>0.95}function ak(){bY("_initRulerParameters");if(!be){if(!bJ.origin){return}cz=new n.Vector3().copy(bJ.origin);if(!bJ.direction){return}bF=new n.Vector3().copy(bJ.direction).normalize();if(!bJ.initOrigin){bJ.initOrigin=new n.Vector3().copy(bJ.origin)}var dp=m.MM_UNIT;bC=1;if(typeof bJ.unit==="number"){if(bJ.unit&m.NM_UNIT){dp=m.NM_UNIT;bC=Math.pow(10,6)}else{if(bJ.unit&m.MICRON_UNIT){dp=m.MICRON_UNIT;bC=Math.pow(10,3)}else{if(bJ.unit&m.CM_UNIT){dp=m.CM_UNIT;bC=Math.pow(10,-1)}else{if(bJ.unit&m.M_UNIT){dp=m.M_UNIT;bC=Math.pow(10,-3)}else{if(bJ.unit&m.HM_UNIT){dp=m.HM_UNIT;bC=Math.pow(10,-5)}else{if(bJ.unit&m.KM_UNIT){dp=m.KM_UNIT;bC=Math.pow(10,-6)}else{if(bJ.unit&m.INCH_UNIT){dp=m.INCH_UNIT;bC=1/25.4}else{if(bJ.unit&m.FOOT_UNIT){dp=m.FOOT_UNIT;bC=1/304.8}else{if(bJ.unit&m.YARD_UNIT){dp=m.YARD_UNIT;bC=1/914.4}else{if(bJ.unit&m.MILE_UNIT){dp=m.MILE_UNIT;bC=1/1609344}else{if(bJ.unit&m.NMILE_UNIT){dp=m.NMILE_UNIT;bC=1/1852000}}}}}}}}}}}}else{if(window.widget&&window.widget.hasPreference&&window.widget.hasPreference("Length")){var dc=window.widget.getValue("Length");if(dc){switch(dc){case"mm":dp=m.MM_UNIT;bC=1;break;case"cm":dp=m.CM_UNIT;bC=Math.pow(10,-1);break;case"m":dp=m.M_UNIT;bC=Math.pow(10,-3);break;case"km":dp=m.KM_UNIT;bC=Math.pow(10,-6);break;case"inch":dp=m.INCH_UNIT;bC=1/25.4;break;case"foot":dp=m.FOOT_UNIT;bC=1/304.8;break}}}}for(var dg=0;dg<i.length;dg++){if(dp===i[dg].unit){J=i[dg].nls;break}}L=typeof bJ.displayUnit==="boolean"?bJ.displayUnit:true;bS=typeof bJ.offset==="number"&&!isNaN(bJ.offset)&&bJ.offset>=0?bJ.offset:0;cI=typeof bJ.worldOffset==="number"&&!isNaN(bJ.worldOffset)&&bJ.worldOffset>=0?bJ.worldOffset:0;V=typeof bJ.startValue==="number"&&!isNaN(bJ.startValue)?bJ.startValue:undefined;b7=typeof bJ.endValue==="number"&&!isNaN(bJ.endValue)?bJ.endValue:undefined;if(V!==undefined&&b7!==undefined&&b7<=V){V=undefined;b7=undefined}ct=typeof bJ.originValue==="number"&&!isNaN(bJ.originValue)?bJ.originValue:0;if(V!==undefined&&ct<V){ct=V}if(b7!==undefined&&ct>b7){ct=b7}cn=typeof bJ.mainGrad==="number"&&!isNaN(bJ.mainGrad)&&bJ.mainGrad>0?bJ.mainGrad:10;an=typeof bJ.nbSecondaryGrads==="number"&&!isNaN(bJ.nbSecondaryGrads)&&bJ.nbSecondaryGrads>=0?bJ.nbSecondaryGrads+1:10;aR=typeof bJ.displayOrigin==="boolean"?bJ.displayOrigin:false;cH=typeof bJ.lockedOrigin==="boolean"?bJ.lockedOrigin:true;S=typeof bJ.onOriginManipulator==="function"?bJ.onOriginManipulator:null;bw=typeof bJ.displayRulerDuringLocalTransfo==="boolean"?bJ.displayRulerDuringLocalTransfo:false;N=typeof bJ.lightDisplay==="boolean"?bJ.lightDisplay:false;aY=bJ.graduationsDisplay===m.ORIENTED_GRADUATIONS?bJ.graduationsDisplay:m.DEFAULT_GRADUATIONS;W=typeof bJ.hideOnEmptySelection==="boolean"?bJ.hideOnEmptySelection:true;a2=0;if(typeof bJ.nbDecimals==="number"){if(bJ.nbDecimals>=0&&bJ.nbDecimals<=9){a2=bJ.nbDecimals}else{if(bJ.nbDecimals<0){a2=0}else{if(bJ.nbDecimals>9){a2=9}}}}var dx=aL.getContext("2d");var du=dx.font.split(" ");var dl=N?"bold ":"900 ";dx.font=dl+X+"pt "+du[du.length-1];bv=0;if(L){bv=Math.round(dx.measureText(" "+J).width*10)/10}if(N){bN=200}else{bN=350}bc=bU();if(bc){ch=false;w=false;H=false;D=false;ac=false;F=false;t=false;bs=false;az=cn;bD();cs=Math.max(cI/bc,0);cs+=bS;var c2=Math.floor(1.2*(bN*bc)/az);var dn=az;var df=c2;var dt=3;var cS=15;var dd=function(dA,dz){var dy=Math.floor(1.2*(bN*bc)/dA);if(dy<cS&&dy>df){df=dy;dn=dA}if(dy>=dt&&dy<=cS){return dA}else{if(dy<dt&&dy<dz){return dA}else{if(dy>cS&&dy>dz){return dn}else{if(dy<dt){return dd(dA/an,dy)}else{if(dy>cS){return dd(dA*an,dy)}}}}}return dA};az=dd(az,c2);ay=az;c2=Math.floor(1.2*(bN*bc)/az);var cU=Math.round(bJ.value)+Math.round(c2/2)*az*bC;var de=Math.round(bJ.value)-Math.round(c2/2)*az*bC;aJ=Math.abs(cU-de);r=new n.Vector3().copy(bF);var c7=new n.Vector3(1,0,0);cR=new n.Vector3().crossVectors(c7,r).normalize();if(r.angleTo(c7)<0.001||cR.x===0&&cR.y===0&&cR.z===0){c7=new n.Vector3(0,0,1)}cR=new n.Vector3().crossVectors(c7,r).normalize();s=new n.Vector3().crossVectors(r,cR);if(bW.getSightDirection().angleTo(s)>bW.getSightDirection().angleTo(cR)){var cZ=new n.Vector3().copy(s);s.copy(cR).negate();cR.copy(cZ)}var c5=cR.dot(bW.getSightDirection())>0;if(c5){s.multiplyScalar(-1);cR.multiplyScalar(-1)}cb=r.dot(bW.getUpDirection())<0;bg=-1;if(bc<1){bg=-bc}var di=aJ.toExponential();var c1=di.toString().indexOf("e");var dw=parseFloat(di.toString().substring(c1+1));B=1;for(var c4=1;c4>dw;c4--){B*=10}by=true;if(B>Math.pow(10,a2)){by=false}else{B=Math.pow(10,a2)}var dh=Math.abs(Math.round(bJ.value*bC*B)/B).toString();var cT=Math.abs(Math.round(de*B)/B).toString();var c6=Math.abs(Math.round(cU*B)/B).toString();var dr=Math.abs(Math.round(az/an*B)/B).toString();var c0,dk,db="";if(a2>0||(dr.indexOf(".")!==-1)||(cT.indexOf(".")!==-1)||(c6.indexOf(".")!==-1)||(dh.indexOf(".")!==-1)){db+="."}if(de<0||Math.round(bJ.value*bC*B)/B<0){db+="-"}var dj=cT.split(".");var cW=c6.split(".");var cV=dh.split(".");var ds=dr.split(".");c0=Math.max(dj[0].length,cW[0].length);c0=Math.max(c0,cV[0].length);if(by){dk=a2}else{dk=dj[1]!==undefined?dj[1].length:0;if(cW[1]!==undefined){dk=Math.max(dk,cW[1].length)}if(cV[1]!==undefined){dk=Math.max(dk,cV[1].length)}if(ds[1]!==undefined){dk=Math.max(dk,ds[1].length)}}var c3=c0+dk;for(var dv=0;dv<c3;dv++){db+="A"}var c9=Math.round(dx.measureText(db).width*10)/10;var c8=bG;bG=Y+bm+bv+c9;if(bG!==c8){cG.length=0}if(ax===0){var dm=null;var cX=null;var cY=null;var da;var dq=function(){if(cB&&cB.children.length){a4()}if(cY===null){cY=bt}if(!bw){if(bJ.getVisibleFlag()===true){bJ.setVisibleFlag(false)}if(!cm){if(da){clearTimeout(da)}da=setTimeout(function(){b2()},200)}}else{if(dm===null&&cX===null){dm=bc;cX=bc}var dy=bU();if(!dy||ai()){aq.setVisibility(false)}else{if(dy!==cX){var dz=false;if(Math.abs((dy-cX)/cX)>0.1){dz=true}if(dz||!cm){am=true}b5();if(dz){cX=bc}}else{aq.setVisibility(true)}}}};b2=function(){cm=false;if(!bw){if(cY){bJ.setVisibleFlag(true);var dy=bU();if(!dy||ai()){aq.setVisibility(false)}else{if(dy!==dm){b5()}else{aq.setVisibility(true)}}dm=null}}else{if(cY){b5()}}cY=null};ax=d.subscribe({event:"/VISU/"},function(dy){if(dy.eventType==="@onViewpointBeginMove"){cm=true;if(da){clearTimeout(da)}}else{if(dy.eventType==="@onViewpointChange"){dq()}else{if(dy.eventType==="@onViewpointEndMove"){b2()}}}});a8=bn.onBackgroundModify(function(){if(bJ.getVisibleFlag()){b5()}});b.addEvent(bn.canvas,"onPrimaryPointerClick",cw);b.addEvent(bn.canvas,"onPrimaryPointerMoveUnique",cw)}be=true}}bX("_initRulerParameters")}b5=function(){bY("_internalDisplay");aC();ak();bP();bJ.setValue(bJ.value);bX("_internalDisplay")};function a7(cV,cU,cT){var cS=cV;if(aY===m.ORIENTED_GRADUATIONS&&cS<0){cS=(-1)*cS}if(!cT){cS*=bC}return cU?cS:Math.round(cS*B)/B}function bM(c0,cU,cW){bY("_drawTextCanvas");var c4=cW||{};var cT=c4.isCurrentValue||false;var cX=c4.onManipulatorPreactivated||false;var c2=cT&&ch?1:2;var c3=X*c2*(cT?1.1:1);cU.height=c3*2;cU.width=(bG-bm)*c2;var cS=cU.getContext("2d");cS.globalAlpha=c4.alpha;cS.clearRect(0,0,cU.width,cU.height);if(cb&&!(cT&&ch&&M&&bu)){cS.rotate(Math.PI);cS.textAlign="right";cS.translate(-10*c2,-10*c2)}else{cS.translate(10*c2,cU.height-10*c2)}var cV;if(cT){if(H||D){cV="rgba("+aj+",1)"}else{if(t){cV="rgba("+cK+",1)"}else{if(cX){cV="rgba("+b3+",1)"}else{cV="rgba("+aH+", 1)"}}}}else{cV="rgba("+b0+",1)"}var c1=a7(c0);if(L&&cT){c1=c1+" "+J}var cZ=cS.font.split(" ");var cY=N?"bold ":"900 ";cS.font=cY+c3+"pt "+cZ[cZ.length-1];if(cT&&(H||(t&&b0==="220,220,220"&&!D))){cS.shadowColor="white";cS.shadowBlur=3*c2}cS.fillStyle=cV;cS.fillText(c1,0,0);cU.textDisplayed=c1;bX("_drawTextCanvas");return cU}function cQ(){var cV=bn.currentViewpoint.create3DRayFrom2DPoint(cF);var cT=new n.Vector3().copy(s).multiplyScalar(cs*bc);var cY=new n.Vector3().copy(bF).multiplyScalar(bf).add(cT);var cZ=new n.Vector3().copy(cz).add(cY);var cX=new n.Matrix4().multiplyMatrices(aq.getMatrix(),cl.getMatrix().rotateX(0.5*Math.PI));var cW=cX.elements;var cU=new n.Vector3(cW[8],cW[9],cW[10]);var cS=new n.Plane().setFromNormalAndCoplanarPoint(cU,cZ);return cV.intersectPlane(cS)}function aN(){var cU,cT,cS;if(!aR){return}if(N){cT=au;cU=cf;cS=aa}else{cT=bf>=ct?bx:av;cU=bf>=ct?b6:cv;cS=bf>=ct?cA:aU}var cV=F===true?cS:(cq?cT:cU);if(cC.material.map!==cV){cC.material.map=cV}bn.render()}function aF(){if(!cH){var cS=F===true?Z:(cq?cg:ce);ck.setStyle("backgroundImage",'url("'+cS+'")');if(!F&&!cq&&cz.equals(bJ.initOrigin)){ck.setOpacity(0.5)}else{ck.setOpacity(1)}bn.render()}if(aR){aN()}}function co(){if(!cH&&!w&&bJ.origin3DPos&&!bJ.origin.equals(bJ.initOrigin)){if(bV){aq.removeChild(bV)}var cW=new n.Matrix4().getInverse(aq.getMatrixWorld()),cX=bf?(-bf+bN/2*bc+ct):0,cV=cW.multiply(new n.Matrix4().setPosition(bJ.origin3DPos)),cU=new n.Vector3(-bc*(cs),cX,0),cT=new n.Vector3().getPositionFromMatrix(cV);bV=l.createLineNode({points:[cU,cT]});ca(bV);bV.material=new n.LineBasicMaterial({color:(b0==="80,80,80"?0:16777215),opacity:0.5,dashPattern:[3,2],scale:3});bV.material.force=true;bV.material.depthTest=false;aq.addChild(bV);var cS=l.createSphereNode({matrix:new n.Matrix4().setPosition(cT),radius:0.3,fill:true});ca(cS);bV.addChild(cS)}}function cJ(){var cU,cT,cS;if(N){cT=au;cU=cf;cS=aa}else{cT=bf<ct&&aR?cN:(aR?cO:K);cU=bf<ct&&aR?ba:(aR?af:cx);cS=bf<ct&&aR?cP:(aR?aZ:bE)}var cV=ac===true?cS:(Q?cT:cU);if(aB.material.map!==cV){aB.material.map=cV}bn.render()}function aP(){if(ch){return}var cS=Math.round(bf*B)/B;cE.dispose();cE.image=bM(cS,ao,{isCurrentValue:true,onManipulatorPreactivated:true,alpha:1});cE.needsUpdate=true;aX.setRatio(1.05);bo=true;bn.setTemporaryCursor("pointer");bn.render()}function O(){if(ch){bo=false;return}var cS=Math.round(bf*B)/B;cE.dispose();cE.image=bM(cS,ao,{isCurrentValue:true,onManipulatorPreactivated:false,alpha:1});cE.needsUpdate=true;aX.setRatio(1);bo=false;bn.unsetTemporaryCursor();bn.render()}function bj(cS){bY("_entireManipulationMeasure");M=cS&&cS.event&&cS.event.from&&cS.event.from.length&&cS.event.from[0].type==="Touch";bz=new n.Vector3(0,0,0);bJ.initValue=bf;ch=true;bn.setTemporaryCursor("-webkit-grabbing",10);cM("RulerManipulateBegin",{eventName:"RulerManipulateBegin",value:bf,direction:bF,event:cS.event})}function a5(cW){if(!cH&&bV){aq.removeChild(bV);bV=null}bY("_manipulateCB");var cX=bJ.getSnappedTranslationVector(cW);var cV=cX.snappedTranslationVector;if(cX.returnCode!==0||(H||D)&&cV.x===cW.translationVector.x&&cV.y===cW.translationVector.y&&cV.z===cW.translationVector.z){return}var cU=new n.Vector3().copy(cV).sub(bz);var cS=cU.dot(bF);var cY=cU.length();if(cS<0){cY=cY*(-1)}var cT=bf;bJ.setValue(bf+cY);if(bf!==cT+cY){cU.setLength(bf-cT)}bz.add(cU);if(cU.length()){bn.render();cM("RulerManipulate",{eventName:"RulerManipulate",translationVector:cU,value:bf,direction:bF,rulerDragged:true,event:cW.event})}bX("_manipulateCB")}function ah(cU,cT){H=false;D=false;ch=false;M=false;bn.unsetTemporaryCursor();bn.render();var cS=cT?cT:false;if(!cS){b5()}cM("RulerManipulateEnd",{eventName:"RulerManipulateEnd",value:bf,direction:bF,status:"Validated",event:cU.event});bX("_entireManipulationMeasure")}function bh(cS){bY("_entireOriginManipulationMeasure");M=cS&&cS.event&&cS.event.from&&cS.event.from.length&&cS.event.from[0].type==="Touch";a6=new n.Vector3(0,0,0);ch=true;w=true;F=true;aq.setPickable(g.NODRAWHL);aG.setPickable(g.NODRAWHL);aS=new n.Line3(cz,new n.Vector3().copy(cz).add(bF));bn.setTemporaryCursor("-webkit-grabbing",10);cM("OriginManipulateBegin",{eventName:"OriginManipulateBegin",origin:cz,value:bf,direction:bF,event:cS.event})}function ae(cY){var cV=null;if(!cH&&bV){aq.removeChild(bV);bV=null}if(S){var c0=null,cZ=S(cY);cj();if(cZ){c0=aS.closestPointToPoint(cZ,false);cV=c0.sub(cz);a6=new n.Vector3();bJ.origin3DPos=new n.Vector3().copy(cZ);var cW=new n.Vector3().copy(cQ());var cX=new n.Matrix4().getInverse(aw.getParents()[0].getMatrixWorld()).multiply(new n.Matrix4().setPosition(cW));aw.setMatrix(cX)}}if(cV){var cT=new n.Vector3().copy(cV).sub(a6);var cU=cT.length();if(cU!==0){cz.add(cT);bJ.origin=new n.Vector3().copy(cz);var cS=cT.dot(bF);if(cS>0){cU=cU*(-1)}bJ.setValue(bf+cU);a6.add(cT);cM("OriginManipulate",{eventName:"OriginManipulate",origin:cz,translationVector:cT,value:bf,direction:bF,rulerDragged:true,event:cY.event})}bn.render();bX("_manipulateOriginCB")}}function z(cS){H=false;D=false;ch=false;F=false;M=false;aS=null;aq.setPickable(g.PICKABLE);aG.setPickable(g.PICKABLE);bn.unsetTemporaryCursor();bn.render();b5();w=false;cM("OriginManipulateEnd",{eventName:"OriginManipulateEnd",value:cz,direction:bF,status:"Validated",event:cS.event});bX("_entireOriginManipulationMeasure")}function b9(){cq=true;bn.setTemporaryCursor("pointer");aF()}function ad(){cq=false;if(ch){return}bn.unsetTemporaryCursor();aF()}function aE(cY){var c0=new n.Vector3().copy(s).multiplyScalar(cs*bc);var cS=new n.Vector3().copy(cz).add(c0);if(cY.event.from[0].currentPosition.x){cF.x=cY.event.from[0].currentPosition.x}if(cY.event.from[0].currentPosition.y){cF.y=cY.event.from[0].currentPosition.y}var cW=new n.Vector3().copy(cQ()).sub(cS);var cT=bf;var cZ=cW.dot(r);if(aR){var cX=(a0/2+2*aV)*bc;if(cZ>=0){cZ-=cX/2}else{cZ+=cX/2}}var cV=aR?(a0/2+2*aV)*bc:(a0+2*aV)*bc;if(Math.abs(cT-cZ)>=cV){var c1=ay/an;cZ=Math.round(cZ/c1)*c1;bJ.setValue(cZ);bj(cY);var cU=new n.Vector3().copy(bF).setLength(bf-cT);cM("RulerManipulate",{eventName:"RulerManipulate",translationVector:cU,value:bf,direction:bF,rulerDragged:false,event:cY.event})}else{bj(cY)}ac=true}function bL(cX){if(ch){bo=false;return}bo=true;var cS=new n.Vector3().copy(s).multiplyScalar(cs*bc);var cY=new n.Vector3().copy(cz).add(cS);if(cX.event.from[0].currentPosition.x){cF.x=cX.event.from[0].currentPosition.x}if(cX.event.from[0].currentPosition.y){cF.y=cX.event.from[0].currentPosition.y}var cV=new n.Vector3().copy(cQ()).sub(cY);var cU=bf;var cW=cV.dot(r);if(aR){var cZ=(a0/2+2*aV)*bc;if(cW>=0){cW-=cZ/2}else{cW+=cZ/2}}var cT=aR?(a0/2+2*aV)*bc:(a0+2*aV)*bc;if(Math.abs(cU-cW)<cT){Q=true}else{Q=false}bn.setTemporaryCursor("pointer");cJ()}function a9(){bo=false;Q=false;if(ch){return}bn.unsetTemporaryCursor();cJ()}function cL(cU){var cS=bf;ch=true;bJ.setValue(cU.value);ch=false;var cT=new n.Vector3().copy(bF).multiplyScalar(bf-cS);bo=false;cq=false;bn.render();cM("RulerManipulateBegin",{eventName:"RulerManipulateBegin",value:bf,direction:bF,event:cU.event});cM("RulerManipulate",{eventName:"RulerManipulate",translationVector:cT,value:bf,direction:bF,rulerDragged:false,event:cU.event});cM("RulerManipulateEnd",{eventName:"RulerManipulateEnd",value:bf,direction:bF,status:"Validated",event:cU.event})}function bR(cT){if(ch){bo=false;return}bo=true;var cS=cT.node;if(cS){cS.setRatio(1.05);bn.setTemporaryCursor("pointer");bn.render()}}function b8(cT){if(ch){return}bo=false;var cS=cT.node;if(cS){cS.setRatio(1);bn.unsetTemporaryCursor();bn.render()}}function cD(c4,cS,c6){bY("_createGraduationNode");var c1=null;var c3=null;var cV=c6.alpha;var cW=c6.color;var cT=false;var c5;var c7=a7(c4,false,true);for(c5=0;c5<u.length;c5++){if(u[c5].toDispose===false&&u[c5].associatedValue===c4&&u[c5].associatedAlpha===cV){c3=u[c5];cT=true;break}}if(!c3){for(c5=0;c5<u.length;c5++){if(u[c5].toDispose===true){c3=u[c5];c3.manipulator.associatedValue=c4;c3.texture.dispose();break}}if(!c3){c3={};var c2=l.createRectangleNode({width:bG-bm,height:X*2,fill:true});ca(c2);var cU=new p({ratio:1});cU.addChild(c2);c3.texture=new n.Texture();cU.material=new n.MeshBasicMaterial({map:c3.texture,transparent:true,enableClipPlanes:false});cU.material.force=true;cU.material.depthTest=false;cU.setMatrix(new n.Matrix4().makeTranslation(0,cS/2-bc*X,0));var cY=l.createRectangleNode({width:(bG-bm)*bc,height:cS,fill:true});ca(cY);cY.material=new n.MeshBasicMaterial({map:br,transparent:true,enableClipPlanes:false});cY.material.force=true;cY.material.depthTest=false;var c0=new q({viewer:bn,value:c4,linkedNode:cU});c3.manipulator=c0;c0.subscribe("Click",cL);c0.subscribe("BeginManipulate",null);c0.subscribe("Manipulate",null);c0.subscribe("EndManipulate",null);c0.subscribe("BeginPreactivate",bR);c0.subscribe("EndPreactivate",b8);c3.manipNode=new j();c3.manipNode.addChild(cY);c3.manipNode.addChild(cU);c3.token=c0.linkToNode(c3.manipNode);u.push(c3)}c3.associatedValue=c4;c3.associatedAlpha=cV;c3.ratio=bc}if(!cT){for(c5=0;c5<cG.length;c5++){if(cG[c5].toDispose===false&&cG[c5].associatedValue===c7&&cG[c5].associatedAlpha===cV&&cG[c5].associatedColor===cW&&cG[c5].reverse===cb){c1=cG[c5];break}}if(!c1){if(cG.length===bd){for(c5=0;c5<cG.length;c5++){if(cG[c5].toDispose===true){c1=cG[c5];break}}}else{c1={canvas:document.createElement("canvas")};cG.push(c1)}c1.canvas=bM(c4,c1.canvas,c6);c1.associatedValue=c7;c1.associatedAlpha=cV;c1.associatedColor=cW;c1.reverse=cb}c3.texture.image=c1.canvas;c3.texture.needsUpdate=true;c1.toDispose=false}c3.toDispose=false;var cX=bf-(0.5*bN*bc);var cZ=new n.Matrix4().makeTranslation((bm+bH+Y)*bc,bg,c4-cX-cS/2);c3.manipNode.setMatrix(cZ.rotateX(0.5*Math.PI));R.addChild(c3.manipNode);bX("_createGraduationNode")}function ap(cZ){ch=false;if(!cB.children.length){var c1=a7(bf,true);var cW=B;if(cW<1){cW=cW/(a2>0?10:1000)}else{cW=cW*(a2>0?10:1000)}var cV=new k({value:Math.round(c1*cW)/cW,okCB:bp,cancelCB:a4,startValue:V*bC,endValue:b7*bC,frmWindow:bb});new q({viewer:bn}).linkToNode(cV);cB.addChild(cV);if(cZ.event.from[0].currentPosition.x){cF.x=cZ.event.from[0].currentPosition.x}if(cZ.event.from[0].currentPosition.y){cF.y=cZ.event.from[0].currentPosition.y}var cX=cQ();var c0=new n.Matrix4().makeTranslation(cX.x,cX.y,cX.z);var c2=new n.Matrix4().getInverse(aq.getMatrix());cB.setMatrix(c2.multiply(c0));var cY=-30,cU=-30;var cT=155,cS=30;cX=cZ.event.from[0].currentPosition;if(cX.x+cY<0){cY=(-1)*cX.x+15}else{if(cX.x+cY+cT>bn.SCREEN_WIDTH&&(bn.SCREEN_WIDTH>cT)){cY=cY+(-1)*(cX.x+cY+cT-bn.SCREEN_WIDTH)-15}}if(cX.y+cU<0){cU=(-1)*cX.y+15}else{if(cX.y+cU+cS>bn.SCREEN_HEIGHT&&(bn.SCREEN_HEIGHT>cS)){cU=cU+(-1)*(cX.y+cU+cS-bn.SCREEN_HEIGHT)-15}}cV.setOffset(new n.Vector2(cY,cU));cy.setVisibility(false);x=true;bn.render()}}bP=function(){bY("_internalBuild");var cS,dd,cT;if(!be){return}if(cs<1.5*bn.SCREEN_WIDTH||cs<1.5*bn.SCREEN_HEIGHT){var cY=l.createRectangleNode({width:bG*bc,height:bN*bc,fill:true});ca(cY);cY.setRenderDepth(-1);cY.material=new n.MeshBasicMaterial({map:ci,transparent:true,enableClipPlanes:false});cY.material.force=true;cY.material.depthTest=false;cY.setMatrix(new n.Matrix4().makeTranslation(0,-2*bg,0).rotateX(0.5*Math.PI));if((!cm&&cI===0)||cI!==0){am=true}if(!N){G=l.createRectangleNode({width:(bm+Y)*bc,height:bN*bc,fill:true});ca(G);G.setRenderDepth(-1);G.material=new n.MeshBasicMaterial({map:aM,transparent:true,enableClipPlanes:false});G.material.force=true;G.material.depthTest=false;G.setMatrix(new n.Matrix4().makeTranslation(0,-1.9*bg,0).rotateX(0.5*Math.PI))}if(!cm){cS=l.createRectangleNode({width:(bG-bm),height:X*2.4,fill:true});ca(cS);aX=new p({ratio:1});aX.addChild(cS);aX.setVisibility(true);aX.material=new n.MeshBasicMaterial({map:cE,transparent:true,enableClipPlanes:false});aX.material.force=true;aX.setMatrix(new n.Matrix4().makeTranslation(0,0,-2*bg));cy.addChild(aX);dd=(bG-bm)*bc;cT=bN*bc/10;var c7=l.createRectangleNode({width:dd,height:cT,fill:true});ca(c7);c7.material=new n.MeshBasicMaterial({map:br,transparent:true,enableClipPlanes:false});c7.material.force=true;c7.material.depthTest=false;c7.setMatrix(new n.Matrix4().makeTranslation(0,0,-2*bg));cy.addChild(c7);if(!N){cT=0.5*bc*bN;var cZ=l.createRectangleNode({width:dd,height:cT,fill:true});ca(cZ);cZ.material=new n.MeshBasicMaterial({map:br,transparent:true,enableClipPlanes:false});cZ.material.force=true;cZ.material.depthTest=false;cZ.setMatrix(new n.Matrix4().makeTranslation(0,-cT/2+X*bc*1.2,0));cy.addChild(cZ)}if(ab===0){bl=new q({viewer:bn,axis:new n.Vector3().copy(bF)});bl.subscribe("Click",ap);bl.subscribe("BeginManipulate",function(df){ac=false;F=false;t=true;bj(df)});var cX=true;bl.subscribe("Manipulate",function(df){cX=false;a5(df)});bl.subscribe("EndManipulate",function(df){ac=false;F=false;t=false;ah(df,cX)});bl.subscribe("BeginPreactivate",aP);bl.subscribe("EndPreactivate",O);ab=bl.linkToNode(cy)}}var dc=N?bm/2*bc:bm*bc;var cW=bN*bc;if(D||H){cW=20*bN*bc}aQ=l.createRectangleNode({width:dc,height:cW,fill:true});ca(aQ);aQ.material=new n.MeshBasicMaterial({map:br,transparent:true,enableClipPlanes:false});aQ.material.force=true;aQ.material.depthTest=false;if(bB===0){y=new q({viewer:bn,axis:new n.Vector3().copy(bF)});y.subscribe("BeginManipulate",aE);y.subscribe("Manipulate",a5);y.subscribe("EndManipulate",function(df){ac=false;F=false;ah(df)});y.subscribe("Click",function(df){ac=false;F=false;ah(df)});y.subscribe("Preactivate",bL);y.subscribe("EndPreactivate",a9);bB=y.linkToNode(aQ)}var da,de;if(!cH){var cU=new n.Vector2(-P/2,-bK);ck=h.createElement("div",{"class":"originPinMainDiv"});ck.setStyle("width",P);ck.setStyle("height",bK);ck.setStyle("backgroundImage",'url("'+ce+'")');aG=new o({html:ck});aG.height=bK;aG.width=P;if(w){aG.setPickable(g.NODRAWHL)}aG.setOffset(cU);U=new q({viewer:bn,axis:new n.Vector3().copy(bF),linkedNode:aG});U.subscribe("BeginManipulate",bh);U.subscribe("Manipulate",ae);U.subscribe("EndManipulate",z);U.subscribe("BeginPreactivate",b9);U.subscribe("EndPreactivate",ad);al=U.linkToNode(aG)}if(aR){a1.material=new n.MeshBasicMaterial({map:cu,transparent:true,enableClipPlanes:false});a1.material.force=true;a1.material.depthTest=false;if(!N){da=((bm+Y+2*aV))*bc;if(aR){de=(a0/2+2*aV)*bc}else{de=(a0+aV)*bc}}else{da=0.8*aW*bc;de=0.8*aW*bc}cC=l.createRectangleNode({width:da,height:de,fill:true});ca(cC);cC.material=new n.MeshBasicMaterial({map:N?ar:cv,transparent:true,enableClipPlanes:false});cC.material.force=true;cC.material.depthTest=false;if(!cm&&!N){var c6=bG-bm+10;var c2=X*2;cS=l.createRectangleNode({width:c6,height:c2,fill:true});ca(cS);var c9=new p({ratio:1});c9.addChild(cS);var c5=new n.Texture();c5.image=bM(ct,bi,{alpha:1});c5.needsUpdate=true;c9.material=new n.MeshBasicMaterial({map:c5,transparent:true,enableClipPlanes:false});c9.material.force=true;c9.material.depthTest=false;aA.addChild(c9);var c8=Math.floor(1.2*(bN*bc)/az);dd=(bG-bm)*bc;var c1=c8>=7?Math.floor(c8/2):c8;cT=bN*bc/c1;var c4=l.createRectangleNode({width:dd,height:cT,fill:true});ca(c4);c4.material=new n.MeshBasicMaterial({map:br,transparent:true,enableClipPlanes:false});c4.material.force=true;c4.material.depthTest=false;aA.addChild(c4);cd=new q({viewer:bn,value:ct,linkedNode:c9});cd.subscribe("Click",cL);cd.subscribe("BeginManipulate",null);cd.subscribe("Manipulate",null);cd.subscribe("EndManipulate",null);cd.subscribe("BeginPreactivate",bR);cd.subscribe("EndPreactivate",b8);c9.setMatrix(new n.Matrix4().makeTranslation(0,(cT-c2*bc)/2,0));aK=cd.linkToNode(aA)}}if(!N){da=((bm+Y+2*aV))*bc;if(aR){de=(a0/2+2*aV)*bc}else{de=(a0+aV)*bc}}else{da=aW*bc;de=aW*bc}aB=l.createRectangleNode({width:da,height:de,fill:true});ca(aB);aB.material=new n.MeshBasicMaterial({map:N?cf:(aR?af:cx),side:n.DoubleSide,transparent:true,enableClipPlanes:false});aB.material.force=true;aB.material.depthTest=false;if(aI===0){aO=new q({viewer:bn,axis:new n.Vector3().copy(bF)});aO.subscribe("Click",null);aO.subscribe("BeginManipulate",function(df){ac=true;F=false;t=false;bj(df)});aO.subscribe("Manipulate",a5);aO.subscribe("EndManipulate",function(df){ac=false;F=false;t=false;ah(df)});aO.subscribe("BeginPreactivate",function(){Q=true;bn.setTemporaryCursor("pointer");cJ()});aO.subscribe("EndPreactivate",function(){Q=false;bn.unsetTemporaryCursor();cJ()});aI=aO.linkToNode(aB)}cl.addChild(cY);cl.addChild(aQ);cl.addChild(cy);cl.addChild(A);var cV;if(!N){A.addChild(aB);cl.addChild(R);cl.addChild(G)}else{cV=new f({type:"Spherical"});cV.addChild(aB);aB.setMatrix(new n.Matrix4().makeTranslation(-aW*bc/2,-aW*bc/2,0));A.addChild(cV)}if(aR){cl.addChild(a1);cl.addChild(bO);if(!N){bO.addChild(cC);cl.addChild(aA)}else{cV=new f({type:"Spherical"});cV.addChild(cC);cC.setMatrix(new n.Matrix4().makeTranslation(-aW*bc*0.4,-aW*bc*0.4,0));bO.addChild(cV)}}if(!cH){aq.addChild(aw);aw.addChild(aG)}aq.addChild(cl);aq.addChild(cB);cl.addChild(ag)}var c3,c0;if(cs>0){var db;c3=new n.Vector3(0,bN/2*bc,0);c0=new n.Vector3(-bc*(cs),bN/2*bc,0);db=l.createLineNode({points:[c3,c0]});ca(db);db.material=new n.LineBasicMaterial({color:b0==="80,80,80"?0:16777215,opacity:0.5,transparent:true});db.material.force=true;db.material.depthTest=false;aq.addChild(db);if(aR){c3=new n.Vector3(0,0,0);c0=new n.Vector3(-bc*(cs),0,0);aT=l.createLineNode({points:[c3,c0]});ca(aT);aT.material=new n.LineBasicMaterial({color:b0==="80,80,80"?0:16777215,opacity:0.5,transparent:true});aT.material.force=true;aT.material.depthTest=false;aq.addChild(aT)}}aq.setVisibility(ai()?false:bt);bn.addNode(aq,false);aq.setMatrix(new n.Matrix4(s.x,r.x,cR.x,0,s.y,r.y,cR.y,0,s.z,r.z,cR.z,0,0,0,0,1));bf=null;bX("_internalBuild")};function bA(){bY("_generateMainCanvas");var cW=Math.round(bf*B)/B;var cU=b4;cU.width=bG;cU.height=bN;var cT=cU.getContext("2d");cT.clearRect(0,0,cU.width,cU.height);var cZ=0.4;var cS,c2;if(!N){cS="255, 255, 255";c2=cT.createLinearGradient(0,0,0,cU.height);c2.addColorStop(0,"rgba("+cS+",0)");c2.addColorStop(0.2,"rgba("+cS+","+cZ+")");c2.addColorStop(0.8,"rgba("+cS+","+cZ+")");c2.addColorStop(1,"rgba("+cS+",0)");cT.fillStyle=c2;b1(cT,Y-2*aV,0,bm+4*aV,cU.height);c2=cT.createLinearGradient(0,0,0,cU.height);c2.addColorStop(0,"rgba("+cS+",0)");c2.addColorStop(0.15,"rgba("+cS+",0.8)");c2.addColorStop(0.85,"rgba("+cS+",0.8)");c2.addColorStop(1,"rgba("+cS+",0)");cT.fillStyle=c2;b1(cT,Y-2*aV,0,3*aV,cU.height);b1(cT,Y+bm,0,3*aV,cU.height);var c1=cW-(0.5*cU.height*bc);var cX=cW+(0.5*cU.height*bc);var cY=0.05*cU.height;var cV=0.7;var c0;if(!aR&&D){if(cW>0){if(c1>0){c0=cT.createLinearGradient(Y,0.5*cU.height,Y,cU.height);c0.addColorStop(0,"rgba("+aj+","+cV+")");c0.addColorStop(1,"rgba("+aj+",0)");cT.fillStyle=c0;b1(cT,Y,0.5*cU.height,bm,0.5*cU.height)}else{c0=cT.createLinearGradient(Y,0.5*cU.height,Y,cU.height-Math.abs(c1)/bc);c0.addColorStop(0,"rgba("+aj+","+cV+")");c0.addColorStop(1,"rgba("+aj+",0)");cT.fillStyle=c0;b1(cT,Y,0.5*cU.height,bm,0.5*cU.height-Math.abs(c1)/bc)}}else{if(cW<0){if(cX<0){c0=cT.createLinearGradient(Y,0,Y,0.5*cU.height);c0.addColorStop(0,"rgba("+aj+",0)");c0.addColorStop(1,"rgba("+aj+","+cV+")");cT.fillStyle=c0;b1(cT,Y,0,bm,0.5*cU.height)}else{c0=cT.createLinearGradient(Y,cX/bc,Y,0.5*cU.height);c0.addColorStop(0,"rgba("+aj+",0)");c0.addColorStop(1,"rgba("+aj+","+cV+")");cT.fillStyle=c0;b1(cT,Y,cX/bc,bm,0.5*cU.height-cX/bc)}}else{c0=cT.createLinearGradient(Y,0.5*cU.height,Y,0.5*cU.height+cY);c0.addColorStop(0,"rgba("+aj+","+cV+")");c0.addColorStop(1,"rgba("+aj+",0)");cT.fillStyle=c0;b1(cT,Y,0.5*cU.height,bm,cY);c0=cT.createLinearGradient(Y,0.5*cU.height-cY,Y,0.5*cU.height);c0.addColorStop(0,"rgba("+aj+",0)");c0.addColorStop(1,"rgba("+aj+","+cV+")");cT.fillStyle=c0;b1(cT,Y,0.5*cU.height-cY,bm,cY)}}}else{if(!aR&&H){if(cW>0){if(c1>0){c0=cT.createLinearGradient(Y,0.5*cU.height,Y,cU.height);c0.addColorStop(0,"rgba("+aj+","+cV+")");c0.addColorStop(1,"rgba("+aj+",0)");cT.fillStyle=c0;b1(cT,Y,0.5*cU.height,cU.width-Y,0.5*cU.height)}else{c0=cT.createLinearGradient(Y,0.5*cU.height,Y,cU.height-Math.abs(c1)/bc);c0.addColorStop(0,"rgba("+aj+","+cV+")");c0.addColorStop(1,"rgba("+aj+",0)");cT.fillStyle=c0;b1(cT,Y,0.5*cU.height,cU.width-Y,0.5*cU.height-Math.abs(c1)/bc)}}else{if(cW<0){if(cX<0){c0=cT.createLinearGradient(Y,0,Y,0.5*cU.height);c0.addColorStop(0,"rgba("+aj+",0)");c0.addColorStop(1,"rgba("+aj+","+cV+")");cT.fillStyle=c0;b1(cT,Y,0,cU.width-Y,0.5*cU.height)}else{c0=cT.createLinearGradient(Y,cX/bc,Y,0.5*cU.height);c0.addColorStop(0,"rgba("+aj+",0)");c0.addColorStop(1,"rgba("+aj+","+cV+")");cT.fillStyle=c0;b1(cT,Y,cX/bc,cU.width-Y,0.5*cU.height-cX/bc)}}else{c0=cT.createLinearGradient(Y,0.5*cU.height,Y,0.5*cU.height+cY);c0.addColorStop(0,"rgba("+aj+","+cV+")");c0.addColorStop(1,"rgba("+aj+",0)");cT.fillStyle=c0;b1(cT,Y,0.5*cU.height,cU.width-Y,cY);c0=cT.createLinearGradient(Y,0.5*cU.height-cY,Y,0.5*cU.height);c0.addColorStop(0,"rgba("+aj+",0)");c0.addColorStop(1,"rgba("+aj+","+cV+")");cT.fillStyle=c0;b1(cT,Y,0.5*cU.height-cY,cU.width-Y,cY)}}}}}else{cS=b0;c2=cT.createLinearGradient(0,0,0,cU.height);cV=0.5;c2.addColorStop(0,"rgba("+cS+",0)");c2.addColorStop(0.15,"rgba("+cS+","+cV+")");c2.addColorStop(0.85,"rgba("+cS+","+cV+")");c2.addColorStop(1,"rgba("+cS+",0)");cT.fillStyle=c2;b1(cT,0,0,aV,cU.height);if(D){c1=cW-(0.5*cU.height*bc);cX=cW+(0.5*cU.height*bc);cV=0.7;if(!aR){if(cW>0){if(c1>0){c0=cT.createLinearGradient(Y,0.5*cU.height,Y,cU.height);c0.addColorStop(0,"rgba("+aj+","+cV+")");c0.addColorStop(1,"rgba("+aj+",0)");cT.fillStyle=c0;b1(cT,0,0.5*cU.height,aV,0.5*cU.height)}else{c0=cT.createLinearGradient(Y,0.5*cU.height,Y,cU.height-Math.abs(c1)/bc);c0.addColorStop(0,"rgba("+aj+","+cV+")");c0.addColorStop(1,"rgba("+aj+",0)");cT.fillStyle=c0;b1(cT,0,0.5*cU.height,aV,0.5*cU.height-Math.abs(c1)/bc)}}else{if(cW<0){if(cX<0){c0=cT.createLinearGradient(Y,0,Y,0.5*cU.height);c0.addColorStop(0,"rgba("+aj+",0)");c0.addColorStop(1,"rgba("+aj+","+cV+")");cT.fillStyle=c0;b1(cT,0,0,aV,0.5*cU.height)}else{c0=cT.createLinearGradient(Y,cX/bc,Y,0.5*cU.height);c0.addColorStop(0,"rgba("+aj+",0)");c0.addColorStop(1,"rgba("+aj+","+cV+")");cT.fillStyle=c0;b1(cT,0,cX/bc,aV,0.5*cU.height-cX/bc)}}}}}}bX("_generateMainCanvas");return cU}function cp(){bY("_generateGraduations");var cV=ch||cm?1:2;var cW=v;cW.width=Math.round(cV*(bm+Y));cW.height=Math.round(cV*bN);var cT=cW.getContext("2d");cT.clearRect(0,0,cW.width,cW.height);var c4=bc/cV;var da=Math.floor(1.2*(cW.height*c4)/az);da++;var c9=da>=7?Math.floor(da/2)-1:da-1;var c8=bf-(0.5*cW.height*c4);var cX=az;if(da>=7){cX=2*az}cX*=B;var db=Math.floor(c8/az);c8=(db*az).valueOf();cT.textBaseline="middle";var cY=2*a0*cV;var c0=1;var cZ=1;var c3=false;var c5=[];var dg=[];var c1=[];var df,c6,dc,cU,cS,di;for(c6=0;c6<=da;c6++){cS=0.5*cW.height+(bf-c6*az-c8)/c4;c0=(cS<cY)?cS/cY:((cS>cW.height-cY)?((cW.height-cS)/cY):1);if(Math.abs(cS-0.5*cW.height)<cY){cZ=Math.max(2*(Math.abs(cS-0.5*cW.height)/cY)-1,0);c3=true}else{cZ=c0;c3=false}var c2=Math.round((c6*az+c8)*B)/B;var c7=c2*B%cX===0;if(c7){df=Math.round(Math.max(cZ-0.2,0)*10)/10;if(df<0.1||(c3&&!bs&&df<0.8)){df=0}if(df!==0){df=E(df+0.1);if(V!==undefined&&c2<V||b7!==undefined&&c2>b7){df=0}if(df!==0){c5.push({val:c2,alpha:df,nearCurrentValue:c3})}}}if(!(V!==undefined&&c2<V||b7!==undefined&&c2>b7)){df=Math.round(Math.max(cZ-0.2,0)*10)/10;if(df!==0){df=E(df+0.1);if(df!==0){di={moveTo:{x:Math.round(cV*Y),y:Math.round(cS)},alpha:df,lineWidth:aV*cV*2};if(c7){di.lineTo={x:Math.round(cV*(bm+Y)),y:Math.round(cS)}}else{di.lineTo={x:Math.round(cV*(Y+0.75*bm)),y:Math.round(cS)}}dg.push(di);if(c1.indexOf(df)===-1){c1.push(df)}}}}}for(c6=0;c6<=da;c6++){for(dc=1;dc<an;dc++){var dd=Math.round(((c6-dc*(1/an))*az+c8)*B)/B;if(!(V!==undefined&&dd<V||b7!==undefined&&dd>b7)){cS=0.5*cW.height+(bf-(c6-dc*(1/an))*az-c8)/c4;c0=(cS<cY)?cS/cY:((cS>cW.height-cY)?((cW.height-cS)/cY):1);var dh=(Math.abs(cS-0.5*cW.height)<cY)?Math.max(2*(Math.abs(cS-0.5*cW.height)/cY)-1,0):c0;dh=E(dh);if(dh!==0){di={moveTo:{x:Math.round(cV*Y),y:Math.round(cS)},alpha:dh,lineWidth:aV*cV};di.lineTo={x:Math.round(cV*(aD+Y)),y:Math.round(cS)};dg.push(di);if(c1.indexOf(dh)===-1){c1.push(dh)}}}}}var dj=[aV*cV*2,aV*cV];for(cU=0;cU<dj.length;cU++){for(c6=0;c6<c1.length;c6++){cT.beginPath();cT.lineWidth=dj[cU];if((cU===0&&H)||(cU===1&&D)){cT.strokeStyle="rgba("+aj+","+c1[c6]+")"}else{cT.strokeStyle="rgba(0,0,0,"+c1[c6]+")"}for(dc=0;dc<dg.length;dc++){if(dg[dc].alpha===c1[c6]&&dg[dc].lineWidth===dj[cU]){cT.moveTo(dg[dc].moveTo.x,dg[dc].moveTo.y);cT.lineTo(dg[dc].lineTo.x,dg[dc].lineTo.y)}}I(cT)}}if(!cm){for(c6=0;c6<u.length;c6++){u[c6].toDispose=true}for(c6=0;c6<cG.length;c6++){cG[c6].toDispose=true}for(c6=0;c6<c5.length;c6++){var de=a7(c5[c6].val);for(dc=0;dc<u.length;dc++){if(u[dc].associatedValue===c5[c6].val&&u[dc].associatedAlpha===c5[c6].alpha&&Math.abs(u[dc].ratio-bc)/u[dc].ratio<0.2){u[dc].toDispose=false}}for(dc=0;dc<cG.length;dc++){if(cG[dc].associatedValue===de&&cG[dc].associatedAlpha===c5[c6].alpha&&cG[dc].associatedColor===b0&&cG[dc].reverse===cb){cG[dc].toDispose=false}}}for(c6=0;c6<c5.length;c6++){cD(c5[c6].val,bN*bc/c9,{alpha:c5[c6].alpha,reverse:cb,nearCurrentValue:c5[c6].nearCurrentValue,color:b0})}}bX("_generateGraduations");return cW}function bq(){bY("_generateOriginTexture");var cT=bT;var cW=0.7;if(H||D){cT=aj}var cU=bk.getContext("2d");cU.clearRect(0,0,bk.width,bk.height);bk.width=N?3*aV:H?bm:bG-Y;var cS=Math.round(bf*B)/B;var cV;if(cS!==ct){bk.height=(cS-ct)/bc;cV=cU.createLinearGradient(0,0,0,bk.height);if(cS>ct){cV.addColorStop(0,"rgba("+cT+","+cW+")");cV.addColorStop(1,"rgba("+cT+",0)")}else{cV.addColorStop(0,"rgba("+cT+",0)");cV.addColorStop(1,"rgba("+cT+","+cW+")")}cU.fillStyle=cV;b1(cU,0,0,bk.width,bk.height)}else{if(!N){bk.height=0.1*bN;cV=cU.createLinearGradient(0,0,0,bk.height);cV.addColorStop(0,"rgba("+cT+",0)");cV.addColorStop(0.5,"rgba("+cT+","+cW+")");cV.addColorStop(1,"rgba("+cT+",0)");cU.fillStyle=cV;b1(cU,0,0,bk.width,bk.height)}}bX("_generateOriginTexture");return bk}function bI(){bY("_internalRefresh");if(!be){b5();return}if(bJ.value!==bf){bf=bJ.value;var cU=new n.Vector3().copy(s).multiplyScalar(cs*bc);var cZ=new n.Vector3().copy(bF).multiplyScalar(bf-0.5*bN*bc).add(cU);var df=new n.Vector3().copy(cz).add(cZ);aq.setMatrix(aq.getMatrix().setPosition(df));if(cs<1.5*bn.SCREEN_WIDTH||cs<1.5*bn.SCREEN_HEIGHT){cB.removeChildren();R.removeChildren();var cT=null;if(am){ci.dispose();ci.image=bA();ci.needsUpdate=true}am=false;if(!N){aM.dispose();aM.image=cp();aM.needsUpdate=true}if(!cm){cE.dispose();cE.image=bM(bf,ao,{isCurrentValue:true,onManipulatorPreactivated:false,alpha:1});cE.needsUpdate=true;var c6=bf-(0.5*bN*bc);var db=X*1.2*2;var cW=N?bH*bc:(bm+bH+Y)*bc;cT=new n.Matrix4().makeTranslation(cW,0,bf-c6-bc*db/2);cy.setMatrix(cT.rotateX(0.5*Math.PI));bl.magnitude=aJ/bC;if(U){U.magnitude=aJ/bC}}var dg=0;if(N){dg=aW*bc}else{if(aR){dg=(a0/2+2*aV)*bc}else{dg=(a0+aV)*bc}}var c5,dd;if(N){c5=cf;dd=aa}else{c5=bf<ct&&aR?ba:(aR?af:cx);dd=bf<ct&&aR?cP:(aR?aZ:bE)}var de=ac===true?dd:c5;if(aB.material.map!==de){aB.material.map=de}cT=new n.Matrix4();if(!N){if(aR){if(bf>=ct){cT.makeTranslation(0,-1.5*bg,bN/2*bc)}else{cT.makeTranslation(0,-1.5*bg,bN/2*bc-dg)}}else{cT.makeTranslation(0,-1.5*bg,bN/2*bc-dg/2)}A.setMatrix(cT.rotateX(0.5*Math.PI))}else{cT.makeTranslation(0,0,bN/2*bc);A.setMatrix(cT.rotateX(0.5*Math.PI))}aO.magnitude=aJ/bC;y.magnitude=aJ/bC;var c1=bN*bc;if(D||H){c1=20*bN*bc}if(N){cT=new n.Matrix4().makeTranslation(-bm/4*bc,0,(bN*bc-c1)/2)}else{cT=new n.Matrix4().makeTranslation((Y)*bc,-bg,(bN*bc-c1)/2)}aQ.setMatrix(cT.rotateX(0.5*Math.PI));cT=new n.Matrix4().makeTranslation(((bm+Y))*bc,-bg,(bN*bc-c1)/2);if(aR||!cH){a1.removeChildren();var c3=null;var c8,c9;if(N){c9=2*aV*bc}else{if(H){c9=bG*bc}else{c9=bm*bc}}if(bf!==ct){c8=Math.abs(bf-ct)+bc}else{c8=0.1*bN*bc}if(c8>0){c3=l.createRectangleNode({width:c9,height:c8,fill:true});ca(c3);c3.setRenderDepth(0);a1.addChild(c3);cu.dispose();cu.image=bq();cu.needsUpdate=true}cT=new n.Matrix4();if(bf<ct){cT.makeTranslation(N?-aV*bc:Y*bc,0,0.5*bN*bc)}else{if(bf>ct){cT.makeTranslation(N?-aV*bc:Y*bc,0,-bf+0.5*bN*bc+ct)}else{cT.makeTranslation(N?-aV*bc:Y*bc,0,0.45*bN*bc)}}a1.setMatrix(cT.rotateX(0.5*Math.PI));var c0=true;for(var c4=0;c4<u.length;c4++){if(u[c4].associatedValue===ct){c0=false}}if(!N){if(c0&&!(bf+0.15*aJ>ct&&bf-0.15*aJ<ct)){var da=Math.floor(1.2*(bN*bc)/az);var c7=da>=7?Math.floor(da/2):da;var cX=bN*bc/c7;var cV=bf-(0.5*bN*bc);cT=new n.Matrix4().makeTranslation((bm+bH+Y)*bc,bg,-cV-cX/2+ct);aA.setMatrix(cT.rotateX(0.5*Math.PI));aA.setVisibility(true)}else{aA.setVisibility(false)}aF();cT=new n.Matrix4().makeTranslation(0,0,bf>=ct?-bf+0.5*bN*bc-dg+bc+ct:-bf+0.5*bN*bc+ct)}else{cT=new n.Matrix4().makeTranslation(0,0,-bf+bN/2*bc+ct)}if(aR){bO.setMatrix(cT.rotateX(0.5*Math.PI))}if(!cH){if(bJ.displayOrigin&&bJ.origin3DPos){var dc=new n.Matrix4().getInverse(aw.getParents()[0].getMatrixWorld()).multiply(new n.Matrix4().setPosition(bJ.origin3DPos));aw.setMatrix(dc)}else{aw.setMatrix(new n.Matrix4().setPosition(new n.Vector3(0,bN/2*bc,0)))}}}if(ch&&M&&bu){cy.setVisibility(false);if(!ag.children.length&&cE){var cS=new o({html:cE.image});ag.setMatrix(new n.Matrix4().makeTranslation(0,0,(bN/2)*bc));ag.addChild(cS)}var cY=(-cE.image.getContext("2d").measureText(cE.image.textDisplayed).width/2);cY+=!N?(bm/2+Y/2-4*aV):-(bm/4+2*aV);ag.children[0].setOffset(new n.Vector2(cY,-85))}else{cy.setVisibility(true);ag.removeChildren()}bs=true;bo=false;cq=false}if(cs>0&&aR){aT.setMatrix(new n.Matrix4().makeTranslation(0,-bf+bN/2*bc+ct,0));co();if(bJ.origin3DPos){var c2=new n.Matrix4().getInverse(aw.getParents()[0].getMatrixWorld()).multiply(new n.Matrix4().setPosition(bJ.origin3DPos));aw.setMatrix(c2)}}bn.render()}bX("_internalRefresh")}this.setValue=function(cT){bY("setValue");var cS=cT;if(bQ&&aY===m.ORIENTED_GRADUATIONS&&!ch&&this.value<0){cS=(-1)*cS}if(V!==undefined&&cS<V){this.value=V}else{if(b7!==undefined&&cS>b7){this.value=b7}else{this.value=cS}}if(this.getVisibleFlag()){bI()}bX("setValue")};this.getDisplayedValue=function(cS){return a7(this.value,typeof cS==="boolean"?!cS:true)};this.getMatrix=function(){if(aq){return new n.Matrix4().copy(aq.getMatrixWorld())}return undefined};this.setVisibleFlag=function(cS){if(cS!==bt){bt=cS;aq.setVisibility(ai()?false:bt);if(cS){this.setValue(this.value)}bn.render()}};this.getVisibleFlag=function(){if(be){return bt}else{return null}};this.setVisibilityFree=function(cS){if(aq&&aq.setVisibilityFree){aq.setVisibilityFree(cS)}};this.getVisibilityFree=function(){if(aq){return aq.visibilityFree}return undefined};this.clear=function(){x=false;ch=false;cm=false;bs=false;H=false;D=false;bo=false;cq=false;ac=false;F=false;Q=false;t=false;am=false;M=false;bu=false;aC()};this.subscribe=function(cS,cT){if(!cS||!cT||(cS!=="RulerManipulateBegin"&&cS!=="RulerManipulate"&&cS!=="RulerManipulateEnd"&&cS!=="OriginManipulateBegin"&&cS!=="OriginManipulate"&&cS!=="OriginManipulateEnd")){return undefined}return a3.subscribe({event:cS},cT)};this.unsubscribe=function(cS){if(cS===null||cS===undefined){return}a3.unsubscribe(cS)};this.getSnappedTranslationVector=function(cT){bY("getSnappedTranslationVector");var da=new n.Vector3().copy(cT.translationVector);if(H||D){am=true}H=false;D=false;bu=false;var cY=bn.currentViewpoint.create3DRayFrom2DPoint(cF);var cU=new n.Vector3().copy(s).multiplyScalar(cs*bc);var cV=new n.Vector3().copy(bF).multiplyScalar(bf).add(cU);var c8=new n.Vector3().copy(cz).add(cV);var c3=new n.Matrix4().multiplyMatrices(aq.getMatrix(),cl.getMatrix().rotateX(0.5*Math.PI));var c7=c3.elements;var cX=new n.Vector3(c7[0],c7[1],c7[2]);var cW=new n.Vector3(c7[8],c7[9],c7[10]);var c2=new n.Plane().setFromNormalAndCoplanarPoint(cW,c8);var c4=cY.intersectPlane(c2);if(!N){c8.add(new n.Vector3().copy(cX).multiplyScalar(Y*bc))}var c0=new n.Vector3().copy(c4).sub(c8);var c9=c0.dot(cX);var c1=this.initValue+cT.translationVector.length()*(bF.dot(cT.translationVector)>0?1:-1);var c6=N?-bm*bc:0;var c5=N?bm*bc:bc*bG;if(c9<c6||c9>c5){if(N&&c9>c6&&c9<(bm+cE.image.getContext("2d").measureText(cE.image.textDisplayed).width)*bc){bu=true}if(V!==undefined&&c1<V){da=new n.Vector3().copy(bF).multiplyScalar(V-this.initValue)}else{if(b7!==undefined&&c1>b7){da=new n.Vector3().copy(bF).multiplyScalar(b7-this.initValue)}}}else{var cS=c9>bm*bc?"snappingMainGrads":"snappingSmallGrads";bu=true;if(N){cS="snappingSmallGrads"}am=true;H=(cS==="snappingMainGrads");D=(cS==="snappingSmallGrads");var cZ=(cS==="snappingMainGrads")?ay:ay/an;c1=Math.round(c1/cZ)*cZ;if(V!==undefined&&c1<V){c1=V}else{if(b7!==undefined&&c1>b7){c1=b7}}c1-=this.initValue;da=new n.Vector3().copy(bF).multiplyScalar(c1)}bX("getSnappedTranslationVector");return{snappedTranslationVector:da,returnCode:0}};this.beginManipulation=function(){ch=true;aq.setPickable(g.NODRAWHL)};this.endManipulation=function(){aq.setPickable(g.PICKABLE);ch=false;H=false;D=false};this.display=function(){x=false;ch=false;w=false;cm=false;bs=false;H=false;D=false;bo=false;cq=false;ac=false;F=false;Q=false;t=false;am=false;M=false;bu=false;b5()};this.refresh=function(){this.setValue(this.value)}}});m.DEFAULT_GRADUATIONS=0;m.ORIENTED_GRADUATIONS=1;m.NM_UNIT=1<<0;m.MICRON_UNIT=1<<1;m.MM_UNIT=1<<2;m.CM_UNIT=1<<3;m.M_UNIT=1<<4;m.HM_UNIT=1<<5;m.KM_UNIT=1<<6;m.INCH_UNIT=1<<7;m.FOOT_UNIT=1<<8;m.YARD_UNIT=1<<9;m.MILE_UNIT=1<<10;m.NMILE_UNIT=1<<11;return m});