/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/3DPlayCommonSimulation/3DPlayCommonSimulation",["DS/3DPlayExperienceModule/PlayExperience3D","DS/WebSystem/Nls","DS/WebInfraUI/Notification","UWA/Core","DS/CoreEvents/Events","DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/3DPlay/3DPlay","DS/SPYLoader/SPYLoader"],function(c,j,d,b,a,f,i,h,g){var e=c.extend({_postCreateSequenceCallback:function(){var l=this.frmWindow.getViewer();if(l){l.setMaterialMode(true);var k=this.getRootBag();if(!k){k=new f();l.addNode(k)}if(k){k.name=this.mySPM.getSimulationName()}}if(this.mySPMUI){if(this.mySPMUI.getActiveSequence()===-1){this.mySPMUI.activateSequence(0,this.onDefaultDDActivation)}}this.loader.continueLoading()},_createSequenceErrorCallback:function(){var l=this.loader.getReport();if(l){var m=false;var o="NoValidStream";if(!isNaN(l.streamNb)&&!isNaN(l.invalidStreamNb)&&l.streamNb===l.invalidStreamNb){m=true}else{if(l.filteredContent){m=true;o="FilteredContent"}}if(m){var n="3DPlayCommonSimulation/Loading";var k=d.info;j.nls(n,o,function(p){h.sendEvent(this.args.ctx,eventType.notif,k,{msg:p})}.bind(this))}}if(this.loader.isLoadingComplete()){a.publish({event:this.ctx+"/SPY/PROGRESS/END",data:{value:0}});this.mySPMUI.createFakeSphere();this.markAssetLoaded()}this.loader.continueLoading()},init:function(l){this._parent(l);var k={workbenchs:[{name:"BasicSimulationPlayer",module:"3DPlayBasicSimulation"}],swapVisible:true,selection:true,preSelection:true,visu:{picking:true,antiAliasing:true,useShadowMap:true,infinitePlane:true,displayLines:true,debugShadowLight:false,debugBSphere:false,debugBBox:false},ui:{displayTree:false,displayActionBar:true},options:{loadAnimation:5,splashscreen:{custom:""},enopad:{interwidgetComAvailability:false,windowOptions:{allowDnD:false}}},mabModel:{speeddial:[{id:"CATSPYAnimateCmdHdr",rsc:"SPYUI/SimulationPlayer"},{id:"CATSPYMSRAccessCmdHdr",rsc:"SPYUI/SimulationPlayer"},{id:"Share",icon:"3DPlay/assets/icons/32/I_3DSHAREShare.png",flyout:[{id:"ShareTo3DSwYm",rsc:"3DPlay/3DPlay"},{id:"ShareDownload",rsc:"3DPlay/3DPlay"},{id:"SharePrint",rsc:"3DPlay/3DPlay"}]}],sections:[{id:"CATSPYHideShowCmdHdr",rsc:"SPYUI/SimulationPlayer",nls:"SPYUI/SimulationPlayer",hideAB:true,showBack:true},{id:"CATSPYHideShowLegendCmdHdr",rsc:"SPYUI/SimulationPlayer",nls:"SPYUI/SimulationPlayer"},{id:"CATSPYShowHideExtremaCmdHdr",rsc:"SPYUI/SimulationPlayer",nls:"SPYUI/SimulationPlayer",hideAB:true,showBack:true},{id:"Reframe",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D",hideAB:true,showBack:true},{id:"ViewSelector",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D",hideAB:true,showBack:true},{id:"Ambiance",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D",flyout:[{id:"VisuNoEnv",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuV6Env",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuCleanSpaceEnv",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuDarkBlueEnv",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuDarkGreyEnv",rsc:"ViewerCommands/ViewerCommands"},{id:"VisuShinyEnv",rsc:"ViewerCommands/ViewerCommands"}]}]}};this.args=b.extend(l,k,true);this.loader=g;this.dataFactoryPath="DS/SPY/CATSimNavDataLWFactory";this.markAssetLoaded=function(){if(!this._assetMarkedAsLoaded){var m={model:"",isDefault:this._myAsset.isDefaultModel,isNonSupportedEdge:this._edgeVersionKO};this.publish("MODEL/LOADINGFINISHED",m);this.publish("ASSET/LOADINGFINISHED",m);this._assetMarkedAsLoaded=true}}.bind(this);if(this.args.options.callbacks&&this.args.options.callbacks.ui){this.onDefaultDDActivation=this.args.options.callbacks.ui.DefaultActivationFinished}},unload:function(){this.loader.clean();if(this.mySPMUI){this.mySPMUI.clean();delete this.mySPMUI}if(this.frmWindow&&this.frmWindow.SPMUI){delete this.frmWindow.SPMUI}if(this.mySPM){this.mySPM.clean();delete this.mySPM}},dispose:function(){this.unload();this._parent()},_loadAsset:function(o,m){if(this._myAsset){this._assetMarkedAsLoaded=false;this.unload();var p=this.frmWindow;var n={window:p,context:this.ctx};this.mySPM=new o(n);var l={spm:this.mySPM,window:p,context:this.ctx};this.mySPMUI=new m(l);p.SPMUI=this.mySPMUI;var k=this.ctx;a.publish({event:k+"/SPY/PROGRESS/INIT",data:{red:true}});this.loader.onQueryStart(this.ctx,function(){a.publish({event:k+"/SPY/PROGRESS/UPDATE",data:{value:5,total:100}})});this.loader.onQueryProgress(this.ctx,function(q){a.publish({event:k+"/SPY/PROGRESS/UPDATE",data:{value:q*60/100,total:100}})});this.loader.onQueryError(this.ctx,function(r){a.publish({event:k+"/SPY/PROGRESS/END",data:{value:0}});var t="3DPlayCommonSimulation/Loading";var s="Failed";var q=d.error;if(r==="NOSTREAM"){s="NoLightWeightStream";q=d.info}j.nls(t,s,function(u){h.sendEvent(k,eventType.notif,q,{msg:u})})});this.loader.onUnstreamStart(this.ctx,function(){a.publish({event:k+"/SPY/PROGRESS/UPDATE",data:{value:60,total:100}})});this.loader.onFileNotSupported(this.ctx,function(){alert("File not supported")});this.loader.onUnstreamComplete(this.ctx,this._postCreateSequenceCallback.bind(this));this.loader.onUnstreamError(this.ctx,this._createSequenceErrorCallback.bind(this));this.loader.onTimeOut(this.ctx,function(){var s="3DPlayCommonSimulation/Loading";var r="TimeOut";var q=d.warning;j.nls(s,r,function(t){h.sendEvent(k,eventType.notif,q,{msg:t})})});this.loader.load(this._myAsset,this.dataFactoryPath,this.mySPM)}},loadAsset:function(m){var l=true;var n=navigator.userAgent;var o=n.indexOf("Edge/");if(o>0){l=parseInt(n.substring(o+5,n.indexOf(".",o)),10)>16}if(!l){var q="3DPlayCommonSimulation/Loading";var p="EdgeLevel";if(undefined!==window.WinJS){p="EdgeLevelWin10app"}var k=d.info;j.nls(q,p,function(r){h.sendEvent(this.args.ctx,eventType.notif,k,{msg:r})}.bind(this));this._edgeVersionKO=true;this._myAsset={};this.markAssetLoaded()}else{this._myAsset=m.asset?m.asset:this.args.input.asset;if(!this._myAsset){return}require(["DS/SPY/SimulationPlayerModel","DS/SPYUI/controllers/SimulationPlayerUI"],this._loadAsset.bind(this))}},onPreCreate:function(){if(this.args.mabModel){this.mabModel=this.args.mabModel}},onPostCreate:function(){if(!this._debugStats){this.stats=undefined}if(this.PanelManager&&this.PanelManager.topBarProxy){this.PanelManager.topBarProxy.setContent({help:[]})}var l=this.frmWindow.getViewer();l.setAutoUpdateLights(true);l.setLightOnViewpoint(true);l.setGrid(false);l.setPicking({trapSelection:"advanced"});var k=function(r,n){var q={};if(n&&n.XmousePosition){var m=new i.Vector2(n.XmousePosition,n.YmousePosition);var o=l.getMousePosition(m);var p=l.pick(o,"mesh",true);if(p.path.length===0){q={cmdList:[{name:"Dropdown_1",line:1,hdr_list:["VisuNoEnv"]},{name:"Dropdown_2",line:1,hdr_list:["VisuV6Env"]},{name:"Dropdown_2",line:1,hdr_list:["VisuCleanSpaceEnv"]},{name:"Dropdown_2",line:1,hdr_list:["VisuDarkBlueEnv"]},{name:"Dropdown_2",line:1,hdr_list:["VisuDarkGreyEnv"]},{name:"Dropdown_2",line:1,hdr_list:["VisuShinyEnv"]}]}}}return q};this.frmWindow.getContextualUIManager().register({workbenchName:this.args.workbenchs[0].name,module:this.args.workbenchs[0].module,cmdPrefix:"",onContextualMenuReady:k})},isDefaultExperience:function(){return(this._myAsset&&this._myAsset.isDefaultModel)},_setScreenshotUI:function(m){var r=m.getContext("2d");if(r){var q=this.mySPMUI.frame2D;if(q){var n=this.mySPMUI.getActiveDD();if(n){var s=function(t){if(t){t.drawToCanvas(r,q.offsetLeft,q.offsetTop)}};var l=n.getNavData2DViewList();for(var o=0;o<l.length;o++){if(l[o]&&l[o].visibility){l[o].QI("CATISimNavDataSpecUI",s)}}}}var p=this.mySPMUI.disclaimer;if(p){p.drawToCanvas(r)}var k=this.mySPMUI.watermark;if(k){k.drawToCanvas(r)}}},expworkbenchName:"",expmodule:""});return b.namespace("3DPlayCommonSimulation/3DPlayCommonSimulation",e)});