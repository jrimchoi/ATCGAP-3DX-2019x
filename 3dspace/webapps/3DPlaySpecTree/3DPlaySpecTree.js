/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/3DPlaySpecTree/3DPlaySpecTreeSOManager",["UWA/Class","DS/Visualization/PathElement","DS/Selection/XSO","DS/Selection/CSOManager","DS/Selection/HSOManager"],function(b,e,g,d,c){var i=Object.create({object:{_objectId:"",treeObject:{_objectId:"",_object:{}},visuObject:{_objectId:"",_object:{}},getId:function(){return this._objectId}},getObjectForId:function(k){for(var j in this){if(j.getId()===k){return j}}}});var f=function(j){};var h=function(j){};var a=b.extend({init:function(j){this._parent(j);var k=function(n,m){return false};var l=function(m){return false};this._cso=new g({getElementID:l,useUniqueID:true,areEquals:k})},getCSO:function(){return this._cso},dispose:function(){this._parent()}});return a});define("DS/3DPlaySpecTree/3DPlaySpecTree",[],function(){});define("DS/3DPlaySpecTree/3DPlaySpecTreeUtils",["DS/Windows/Panel","DS/WebSystem/Settings","DS/Visualization/PathElement","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/3DPlaySpecTree/3DPlaySpecTreeSOManager","DS/WebappsUtils/WebappsUtils"],function(f,e,h,c,d,a,g){var b=e.get("3DPlay.SpecTree.LoggingEnabled");return{CSOManager:c,HSOManager:d,isDebugLog:b,log:b?console.log.bind(window.console):function(){},specTreeModel:null,rootPaths:null,disposeModelNode:function(){this.specTreeModel=null;this.specTreeView=null;this.viewer=null;this.rootPaths=null},registerModelNodes:function(k,i,j){var l=this;if(!k||!i||!j){this.log("3DPlay : Error - Could resolve specTreeModel, specTreeView or frameWindow",k,i,j);return false}this.viewer=j.getViewer();this.specTreeModel=k;this.specTreeView=i;this.rootPaths=this.setRootPaths(j);this.addSelectionCB();k.registerModelNodeType({nodeType:"model-node",buildIcons:function(){return[{iconName:"product"}]},buildLabel:function(m){return m.nodeModel.options.label},onSelect:function(n){var m=n.nodeModel;if(m.play3DData.fromCSO){delete m.play3DData.fromCSO}else{l.select3DNode(m.play3DData.id,l.viewer)}},onUnselect:function(p){var n=p.nodeModel;if(n.play3DData.fromCSO){delete n.play3DData.fromCSO}else{var o=n.getChildren();l.unselect3DNode(n.play3DData.id,l.viewer);if(o){for(var m=0;m<o.length;m++){if(o[m].isSelected()){l.select3DNode(o[m].play3DData.id,l.viewer)}}}}},})},buildPanel:function(l,k){var j=new UWA.Element("div");if(k.content){j.appendChild(k.content)}var i=new f({titleBarVisibleFlag:false,icon:g.getWebappsAssetUrl("3DPlaySpecTree","icons/32/")+"I_3DPlaySpecTree.png",title:"",content:j,immersiveFrame:l,resizableFlag:true,movableFlag:false,currentDockArea:k.currentDockArea|WUXDockAreaEnum.NoneDockArea,width:400,verticallyStretchableFlag:true,usePaddingFlag:false,closeButtonFlag:false,floatableFlag:false,expandedFlag:true,ensureHeightDefinitionOnHierarchy:true});return{panel:i,content:j}},setRootPaths:function(l){var i=l.getViewer().getNodes();var j=l.experience?l.experience.getRootBag():null;var k=[];i.forEach(function(m){var p=new h();if(j&&m===j){var o=m.getChildren();var q=o.length;for(var n=0;n<q;n++){p.addElement(o[n])}}else{p.addElement(m)}k.push(p)});return k},createPathFromId:function(n,m){var l=this.rootPaths;var j;var i=n.split("/");var k=function(p,o){if(p.length>0){p.forEach(function(u){var s=u.getLastElement();var t;if(s.getPersistentId!==undefined){if(s.productType=="Instance3D"||s.getPersistentId()==1){t=s.getPersistentId();if(t==o[0]){o.splice(0,1);j=u}}}else{if(s.id!==undefined){var q=s.worktype?s.worktype:s.plmtype;if(q=="VPMReference"||q=="VPMInstance"||q=="VPMRepInstance"||q=="VPMRepReference"||q=="3DShape"||q=="CATProduct"||q=="CATPart"||q=="Viewable"||q=="CgrViewable"){t=s.id;if(t==o[0]){o.splice(0,1);j=u}}}}var r=u.getChildrenOccurrencePathes();if(r!==undefined&&r!==null){k(r,o)}})}};k(l,i);return j},createIdFromPath:function(i){var n=i.pathElement;var l="";while(n!==undefined&&n!==null){var k=n.getLastElement(true);if(k.getPersistentId!==undefined){if(k.productType=="Instance3D"||k.getPersistentId()==1){if(l.length!==0){l="/"+l}l=k.getPersistentId()+l}}else{if(k.id!==undefined&&k.id!==0){var j=k.worktype?k.worktype:k.plmtype;if(j=="VPMReference"||j=="VPMInstance"||j=="VPMRepInstance"||j=="VPMRepReference"||j=="3DShape"||j=="CATProduct"||j=="CATPart"||j=="Viewable"||j=="CgrViewable"){if(l.length!==0){l="/"+l}var m=k.id;l=m+l}}}n=n.getParentOccurrencePath()}return l},select3DNode:function(m,k){this.log("-- select3DNode --:",m);var l=this;var i=[];var j=[];if(!Array.isArray(m)){j.push(m)}else{j=m}j.forEach(function(n){i.push({pathElement:l.createPathFromId(n,k)})});this.removeSelectionCB();c.add(i);d.add(i);this.addSelectionCB()},unselect3DNode:function(o,i){this.log("-- unselect3DNode --:",o);var n=this;var m=c.get();var l=[];m.forEach(function(p){l.push(n.createIdFromPath(p))});var k=[];if(!Array.isArray(o)){k.push(o)}else{k=o}var j=[];k.forEach(function(q){for(var p=0;p<l.length;p++){if(l[p].indexOf(q)>-1){j.push(m[p])}}});j.forEach(function(p){n.removeSelectionCB();c.remove(p);d.remove(p);n.addSelectionCB()})},emptySelection:function(){c.empty();d.empty()},addSelectionCB:function(){var i=this;if(this.treeSelectionCB!==undefined){this.treeSelectionCB.onAddToken=c.onAdd(function(j){if(!Array.isArray(j)){j=[j]}var k=[];j.forEach(function(l){k.push(i.createIdFromPath(l))});i.treeSelectionCB("ADD/VISUNODE",k)});this.treeSelectionCB.onRemoveToken=c.onRemove(function(j){if(!Array.isArray(j)){j=[j]}var k=[];j.forEach(function(l){k.push(i.createIdFromPath(l))});i.treeSelectionCB("REMOVE/VISUNODE",k)});this.treeSelectionCB.onEmptyToken=c.onEmpty(function(){i.treeSelectionCB("EMPTY/VISUNODE")})}},removeSelectionCB:function(){if(this.treeSelectionCB!==undefined){if(this.treeSelectionCB.onAddToken!==undefined){c.unsubscribe(this.treeSelectionCB.onAddToken)}if(this.treeSelectionCB.onRemoveToken!==undefined){c.unsubscribe(this.treeSelectionCB.onRemoveToken)}}},treeSelectionCB:function(l,k){var m=this;var j=[];var i=function(){var n=m.specTreeModel.search({match:function(p){for(var o=0;o<k.length;o++){var q=k[o];if(q&&p.nodeModel.play3DData.id===q){return true}}}});return n};m.specTreeModel.prepareUpdate();switch(l){case"EMPTY/VISUNODE":m.specTreeModel.unselectAll();break;case"ADD/VISUNODE":i().forEach(function(o,n){o.play3DData.fromCSO=true;o.select();o.reverseExpand()});break;case"REMOVE/VISUNODE":i().forEach(function(n){n.play3DData.fromCSO=true;n.unselect()});break;default:break}m.specTreeModel.pushUpdate()},}});define("DS/3DPlaySpecTree/3DPlaySpecTreePanel",["UWA/Class","DS/Visualization/PathElement","DS/SpecTree/SpecTreeView","DS/SpecTree/SpecTreeDocument","DS/Tree/TreeNodeModel","DS/Utilities/Utils","DS/Selection/CSOManager","DS/3DPlaySpecTree/3DPlaySpecTreeUtils","DS/3DPlaySpecTree/3DPlaySpecTreeSOManager","DS/WebSystem/Settings","DS/CoreEvents/Events"],function(c,e,i,h,g,j,d,f,b,a,k){return c.extend({init:function(l){this._parent(l);this._sceneRootBag=l.sceneRootBag;this._frameWindow=l.frameWindow;if(window.__karma__){this._SpecTreeUtils=f}},dispose:function(){this._destroyPanel();f.removeSelectionCB();this._sceneRootBag=undefined;this._frameWindow=undefined;this._parent()},instanciateSpecTreePanel:function(){var o=this;var n=this._frameWindow.getImmersiveFrame();this._specTreeModel=new h();this._specTreeView=new i({height:"auto",treeDocument:o._specTreeModel,show:{rowHeaders:false,columnHeaders:false},isEditable:false,enableDragAndDrop:false});var l=a.get("3DPlay.SpecTree.VisuTreeEnabled")==="true";if(l){this._frameWindow.getTree().show()}var m=l?WUXDockAreaEnum.RightDockArea:WUXDockAreaEnum.LeftDockArea;this._dockingElement=n.getDockingElement(m);this._dockingElement.collapseDockingZoneFlag=true;this._panelModel=f.buildPanel(n,{content:o._specTreeView.getContent(),currentDockArea:m});this._setupSpecTreePanel();this.SpecTreeDisableSubscribe=k.subscribe({event:"3DPLAY/SPECTREE/DISABLE"},this._disableSpecTree.bind(this));this.SpecTreeEnableSubscribe=k.subscribe({event:"3DPLAY/SPECTREE/ENABLE"},this._enableSpecTree.bind(this))},_disableSpecTree:function(){var l=this;if(!this._dockingElement.collapseDockingZoneFlag){this._dockingElement.collapseDockingZoneFlag=true}setTimeout(function(){l._dockingElement.visibleDockingZoneFlag=false;l=undefined},500)},_enableSpecTree:function(){this._dockingElement.visibleDockingZoneFlag=true},_destroyPanel:function(){if(this.SpecTreeDisableSubscribe){k.unsubscribe(this.SpecTreeDisableSubscribe)}if(this.SpecTreeEnableSubscribe){k.unsubscribe(this.SpecTreeEnableSubscribe)}if(this._specTreeView){this._specTreeView.destroy();this._specTreeView=null}if(this._panelModel&&this._panelModel.panel){this._panelModel.panel.destroy();this._panelModel.panel=null}this._specTreeModel.removeRoots();this._specTreeModel=null;f.disposeModelNode()},_setupSpecTreePanel:function(){f.registerModelNodes(this._specTreeModel,this._specTreeView,this._frameWindow);this._specTreeModel.prepareUpdate();var m;for(var l=0;l<this._sceneRootBag.children.length;l++){if(this._sceneRootBag.children[l].name!=="annotGroupNode"){m=this._sceneRootBag.children[l]}}if(m){this._generateChildren(m)}this._specTreeModel.pushUpdate()},_generateChildren:function(q,s){if(!q){f.log("3DPlay : Error - Could not resolve parentModel3DNode",q);return false}if(!s){var r=this._specTreeModel.createModelNode({nodeType:"model-node",label:q.name});var m="";if(q.getPersistentId){m+=q.getPersistentId()}r.play3DData={id:m};this._specTreeModel.addChild(r);this._generateChildren(q,r);return r}for(var n=0;n<q.children.length;n++){var o=q.children[n];var p=null;if(o.productType==="Instance3D"&&o.children.length===1&&o.children[0].productType==="Reference3D"){var t=""+o.name;var l=""+o.children[0].name;var u="Node-"+n;if(l!==""){u=l}if(t!==""){u+=" ("+t+")"}p=this._specTreeModel.createModelNode({nodeType:"model-node",label:u});var v=s.play3DData.id+"/"+o.getPersistentId();p.play3DData={id:v};s.addChild(p);this._generateChildren(o,p)}else{if(o.productType==="Reference3D"){p=s;this._generateChildren(o,p)}else{return true}}}return true}})});