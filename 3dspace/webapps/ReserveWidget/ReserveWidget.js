define("DS/ReserveWidget/ReserveWidget",["UWA/Core","UWA/Controls/Abstract","DS/LifecycleControls/CommandDialog","DS/LifecycleServices/LifecycleServices","DS/WidgetServices/WidgetServices","DS/WidgetServices/securityContextServices/SecurityContextServices","DS/WAFData/WAFData","DS/Controls/Toggle","UWA/Utils/Cookie","css!DS/ReserveWidget/ReserveWidget","i18n!DS/ReserveWidget/assets/nls/ReserveWidgetNls","DS/LifecycleServices/LifecycleServicesSettings"],function(h,f,g,e,c,l,j,k,a,b,m,d){var i=f.extend({TYPE_ROOT_FOLDER_1:"Workspace",TYPE_ROOT_FOLDER_2:"RootFolder",TYPE_FOLDER_1:"Workspace Vault",TYPE_FOLDER_2:"Folder",TYPE_FOLDER_3:"Workspace Folder",TYPE_PERSONAL_FOLDER_1:"Personal Workspace",instToggleCookieName:"ReserveWidget.Instance.Toggled",refToggleCookieName:"ReserveWidget.Reference.Toggled",CAD_ORIGIN_ATTR_NAME:"attribute[XCADExtension.V_CADOrigin]",defaultOptions:{serverName:"",serverUri:"",operation:"",currentUser:"",localContext:""},init:function(n){var p=this;this._parent(n);this.SelectedItems=[];this.labelWaitingOperation="";this.localContext=this.options.localContext;var o={context:this.localContext};l.getInstance(o).getSecurityContext()},isRootFolder:function(n){return n===this.TYPE_ROOT_FOLDER_1||n===this.TYPE_ROOT_FOLDER_2},isFolder:function(n){return(n===this.TYPE_FOLDER_1||n===this.TYPE_FOLDER_2||n===this.TYPE_FOLDER_3)},isPersonalFolder:function(n){return n===this.TYPE_PERSONAL_FOLDER_1},inFamilyFolder:function(n){return(this.isRootFolder(n)||this.isFolder(n)||this.isPersonalFolder(n))},setObjects:function(n){console.log("reserveWidget::SetObjects");console.log(n);if(n.length===0){throw m.noObject}var o=this;c.removeDuplicate(n,function(p){console.log("removing duplicates");return p.physicalId});n.forEach(function(p){if(p.hasOwnProperty("physicalId")&&p.physicalId!=""){console.log("adding an element in SelectedItems");o.SelectedItems.push(p)}else{console.log("the element has no physicalid")}})},updateDlg:function(){var o=this.instToggle.checkFlag;var n=this.refToggle.checkFlag;if(!o&&!n){this.cmdDlg._okButton.setDisabled(true)}else{this.cmdDlg._okButton.setDisabled(false)}},getDefaultToggles:function(){var p=a.get(this.instToggleCookieName);var o=a.get(this.refToggleCookieName);var q=p==="false"?false:true;var n=o==="false"?false:true;return[q,n]},saveDefaultToggles:function(){a.set(this.instToggleCookieName,this.instToggle.checkFlag);a.set(this.refToggleCookieName,this.refToggle.checkFlag)},onToggle:function(){this.updateDlg();this.saveDefaultToggles()},renderDlgContent:function(){var p=document.createElement("div");var n=this.getDefaultToggles();this.instToggle=new k({type:"checkbox",label:m.instance,checkFlag:n[0]});this.refToggle=new k({type:"checkbox",label:m.reference,checkFlag:n[1]});var o=this;this.instToggle.addEventListener("buttonclick",function(q){o.onToggle()});this.refToggle.addEventListener("buttonclick",function(q){o.onToggle()});this.instToggle.inject(p);this.refToggle.inject(p);return p},requestCADOrigins:function(r,n,o){var q=c.getTenantID();var p=["physicalid",this.CAD_ORIGIN_ATTR_NAME,"baseType"];e.listAttributes(q,r,p,n,o)},requestInstanceNames:function(q,n,p){var s=c.getTenantID();var o="/resources/v1/collabServices/reservation/op/getInstanceNames";var r=q.toString();e.post(s,o,r,n,p)},checkIfAllRoots:function(){var q=0;var n=this.SelectedItems.length;for(var p=0;p<n;p++){var r=this.SelectedItems[p];if(r.relID==""){q++}}var o=false;if(q==n){o=true}return o},checkIfAnyV6Instance:function(){var o=this.SelectedItems.length;for(var n=0;n<o;n++){if(this.SelectedItems[n].isV6Rel){return true}}return false},loadInstanceCADOrig:function(n,o){var r=this;var q=[];var s=this.SelectedItems.length;for(var p=0;p<s;p++){var t=this.SelectedItems[p].parentID;if(t!=""){q.push(t)}}if(q.length==0){n()}else{r.requestCADOrigins(q,function u(y){var z=y.results;var w=z.length;for(var A=0;A<w;A++){var E=z[A];var D=E.physicalid;var B=E.baseType;var C=true;if(B=="PLMEntity"&&E[r.CAD_ORIGIN_ATTR_NAME]){C=false}for(var x=0;x<s;x++){var v=r.SelectedItems[x];v.baseType=B;if((v.parentID==D)&&B=="PLMEntity"){v.isV6Rel=C}else{if(B!="PLMEntity"){v.isV6Rel=false}}}}n()},o)}},checkInputs:function(n,o){var p=this;this.loadInstanceCADOrig(function(){if(p.checkIfAllRoots()){n(false)}else{if(p.checkIfAnyV6Instance()){n(true)}else{n(false)}}},o)},launchCmd:function(){var p=this;p.checkInputs(function n(s){if(s){var r=p.renderDlgContent();var q=p.options.operation=="reserve"?m.reserveTitle:m.unreserveTitle;p.cmdDlg=new g();var t=p.cmdDlg.create(r,{title:q,closeButton:true,onOk:function(){p.execute();p.cmdDlg.destroy()}});t.inject(widget.body);t.setNewSize({});p.updateDlg()}else{p.execute()}},function o(q){console.log(q)})},reportV5Instances:function(n){if(n.length>0){var o=this;o.requestInstanceNames(n,function(q){var r=m.v5InstancesExcluded+"<br>";for(var p=0;p<q.length;p++){r+=q[p].name+"<br>"}o.showError(r)},function(p){o.showError(p)})}},execute:function(){var r=(this.instToggle!=null)?this.instToggle.checkFlag:false;var o=(this.instToggle!=null)?this.refToggle.checkFlag:true;var s=this.options.operation;console.log("reserveWidget::launchCmd "+s);var u=this;var t=false;var p=[];var v=0;var y=[];var x=[];this.SelectedItems.forEach(function(B){if(o){p.push("model/"+B.getCategoryM1()+"/"+B.getPhysicalId());if(B.cadMaster!="3DEXPERIENCE"){x.push(B.physicalId)}v++}if(r&&B.baseType=="PLMEntity"){var A=B.relID;if(A!=""){if(B.isV6Rel){p.push("model/rel/"+B.relID);v++}else{y.push(A)}}}});if(v>1){t=true}var z=JSON.stringify(this.SelectedItems);if(x.length>0){var q=x.join();c.get3DSpaceUrlAsync({onComplete:function(D){var B="?";var C=c.getTenantID();if(C){B+="tenant="+C}var A=D+"/resources/v1/collabServices/reservation/op/getV5Instances"+B;j.authenticatedRequest(A,{method:"POST",type:"json",timeout:1000*60*60*3,data:q,headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:function(J){for(var E=0;E<J.length;E++){var K=J[E]["rel"];var H=K.split(",");for(var G=0;G<H.length;G++){if(H[G]&&H[G].length>0){p.push("model/rel/"+H[G])}}}var I={urls:p};var F=JSON.stringify(I);console.log("jsonSelectedItems = "+z);l.getInstance().getSecurityContext({onSuccess:function(L){if(s=="reserve"){u.labelWaitingOperation=UWA.i18n("reserving");if(u.localContext.widgetType==undefined){u.localContext.beginBlockingTransaction(u.labelWaitingOperation)}u.ReserveServiceRequest(F,L,t)}else{if(s=="unreserve"){u.labelWaitingOperation=UWA.i18n("unreserving");if(u.localContext.widgetType==undefined){u.localContext.beginBlockingTransaction(u.labelWaitingOperation)}u.UnReserveServiceRequest(F,L,t)}}u.reportV5Instances(y)},onFailure:function(L){console.log("securityContext is null")}})}})}})}else{var w={urls:p};var n=JSON.stringify(w);console.log("jsonSelectedItems = "+z);l.getInstance().getSecurityContext({onSuccess:function(A){if(s=="reserve"){u.labelWaitingOperation=UWA.i18n("reserving");if(u.localContext.widgetType==undefined){u.localContext.beginBlockingTransaction(u.labelWaitingOperation)}u.ReserveServiceRequest(n,A,t)}else{if(s=="unreserve"){u.labelWaitingOperation=UWA.i18n("unreserving");if(u.localContext.widgetType==undefined){u.localContext.beginBlockingTransaction(u.labelWaitingOperation)}u.UnReserveServiceRequest(n,A,t)}}u.reportV5Instances(y)},onFailure:function(A){console.log("securityContext is null")}})}},onRefresh:function(){console.log("onRefresh->")},showNotification:function(n){var o={eventID:"primary",msg:n};this.dispatchEvent("onNotification",o)},showError:function(o){console.log("showError "+o);var n={eventID:"error",msg:o};this.dispatchEvent("onNotification",n)},ReserveServiceRequest:function(w,v,s){console.log("RESERVE:");console.log(w);var t=this;var x=function(B){console.log("reserve: COMPLETED");var A=[];var D=[];if(B.results){A=B.results}console.log(B.results);var z=true;var C={modified:[]};require(["DS/PADUtils/PADCommandProxy"],function(E){var N=[];var H=A.length;A.forEach(function(P){if(P.errors){z=false;var O=P.errors.length;if(O>0){var Q=P.errors[O-1].message;t.showError(Q);console.log("RESERVE ERROR "+Q)}}else{console.log("RESERVE SUCCESS");var R="";if(typeof P.reservedby!=="undefined"){R=P.reservedby}if(typeof P.locker!=="undefined"){R=P.locker}console.log("&&&& locker ="+R);C.modified.push({physicalid:P.physicalid,attributes:[{name:"ds6w:reserved",value:"TRUE"},{name:"ds6w:reservedBy",value:P.lockerName},{name:"ds6w:displayName",value:P.lockerName}]});D.push(P)}});var K=UWA.i18n("reservationSucceeded");var I=UWA.i18n("instance");var G=UWA.i18n("reference");if(D.length!=A.length){var J=[];D.forEach(function(O){var P=O.url.includes("model/rel/")?I:G;P+=" "+O.title;if(J.indexOf(P)==-1){J.push(P);K+="<br>"+P}})}if(D.length!=0){t.showNotification(K)}console.log("******* refreshing PADCommandProxy *************");var M={authored:true};var F={authored:C};var L=E.create();L.authored(M);L.refresh(F);L.destroy()});if(t.localContext&&typeof t.localContext.endBlockingTransaction==="function"){t.localContext.endBlockingTransaction(t.labelWaitingOperation)}};var p=function(z){if(z.hasOwnProperty("error")){t.showError(z.error)}else{if(z.hasOwnProperty("message")){t.showError(z.message)}}if(t.localContext&&typeof t.localContext.endBlockingTransaction==="function"){t.localContext.endBlockingTransaction(t.labelWaitingOperation)}console.log("Failed to reserve data")};var y=function(z){console.log("Timeout error")};var u;if(v!=null&&v!=""&&v.hasOwnProperty("SecurityContext")){var r="";if(v.SecurityContext.indexOf("ctx::")!=0){r="ctx::"}u=r+v.SecurityContext;console.log("SecurityContext=");console.log(u)}else{var q={message:UWA.i18n("ErrorSecurityContextEmpty"),code:"ERROR"};this.showError(q);console.log("***** Empty security context *****");return}var n=this.options.serverName;var o=this.options.serverUri;c.get3DSpaceUrlAsync({onComplete:function(F){var z=t.options.currentUser;z=null;var D="?";var E=c.getTenantID();if(E){D+="tenant="+E+"&"}if(z){console.log("user = "+z);D+="user="+z+"&"}if(s){D+="isMultiSel=1&"}else{D+="isMultiSel=0&"}var B=["physicalid"];B.forEach(function(G){D+="select="+G+"&"});var A=F+"/resources/v1/collabServices/reservation/op/reserve"+D;console.log("url="+A);var C=d.getHeaders(u);j.authenticatedRequest(A,{method:"POST",type:"json",timeout:1000*60*60*3,headers:C,cache:-1,proxy:"passport",onComplete:x,data:w,onFailure:p,onTimeout:y})}})},UnReserveServiceRequest:function(w,v,s){console.log("UNRESERVE:");console.log(w);var t=this;var x=function(C){console.log("unreserve: COMPLETED");var B=[];var D=[];if(C.results){B=C.results}console.log(C.results);var A=true;var z={created:[],deleted:[],modified:[]};require(["DS/PADUtils/PADCommandProxy"],function(H){var I=[];B.forEach(function(M){if(M.errors){A=false;var L=M.errors.length;if(L>0){var N=M.errors[L-1].message;t.showError(N)}}else{I.push(M.physicalid);z.modified.push({physicalid:M.physicalid,operation:"update",attributes:[{name:"ds6w:reserved",value:"FALSE"},{name:"ds6w:reservedBy",value:""}]});D.push(M)}});var G=UWA.i18n("unreservationSucceeded");if(D.length!=B.length){var K=[];D.forEach(function(L){var M=L.title;if(K.indexOf(M)==-1){K.push(M);G+="<br>"+M}})}if(D.length!=0){t.showNotification(G)}console.log("******* refreshing PADCommandProxy *************");var F={authored:true};var E={authored:{modified:I}};var J=H.create();J.authored(F);J.refresh(E);if(typeof t.localContext.refreshView!=="undefined"){console.log("$$$ calling refreshView - Product Editor case $$$");t.localContext.refreshView(z)}else{if(z.modified.length>0){console.log("$$$ Folder Editor - RefreshView $$$");if(typeof t.localContext.RefreshView!=="undefined"){t.localContext.RefreshView(z)}}}J.destroy()});if(t.localContext&&typeof t.localContext.endBlockingTransaction==="function"){t.localContext.endBlockingTransaction(t.labelWaitingOperation)}};var p=function(z){console.log("myOnFailure");if(z.hasOwnProperty("error")){t.showError(z.error)}else{if(z.hasOwnProperty("message")){t.showError(z.message)}}if(t.localContext&&typeof t.localContext.endBlockingTransaction==="function"){t.localContext.endBlockingTransaction(t.labelWaitingOperation)}console.log("Failed to unreserve data")};var y=function(z){console.log("Timeout error")};var u;if(v!=null&&v!=""&&v.hasOwnProperty("SecurityContext")){var r="";if(v.SecurityContext.indexOf("ctx::")!=0){r="ctx::"}u=r+v.SecurityContext;console.log("SecurityContext=");console.log(u)}else{var q={message:UWA.i18n("ErrorSecurityContextEmpty"),code:"ERROR"};this.showError(q);console.log("***** Empty security context *****");return}var n=this.options.serverName;var o=this.options.serverUri;c.get3DSpaceUrlAsync({onComplete:function(E){var C="?";var D=c.getTenantID();if(D){C+="tenant="+D+"&"}if(s){C+="isMultiSel=1&"}else{C+="isMultiSel=0&"}var A=["physicalid"];A.forEach(function(F){C+="select="+F+"&"});var z=E+"/resources/v1/collabServices/reservation/op/unreserve"+C;console.log("url="+z);var B=d.getHeaders(u);j.authenticatedRequest(z,{method:"POST",type:"json",timeout:1000*60*60*3,headers:B,cache:-1,proxy:"passport",onComplete:x,data:w,onFailure:p,onTimeout:y})}})},});return i});