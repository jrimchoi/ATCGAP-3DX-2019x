define("DS/IVBehaviours/TeleportBehaviour",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils"],function(f,c,e,a,d){var b=f.Class.extend({init:function(){this._viewer=null},teleport:function(q,i){if(q.intersection!==null&&q.intersection.valid){var n=q.intersection.point;var r=i.getUser().head;if(!r){return}var j=i.getPosition().z;var p=q.matrix.decompose();var o=new c.Vector3(1,0,0).applyQuaternion(p[1]);var m=r.getVirtualGlobalMatrix().decompose();var t=new c.Vector3(1,0,0).applyQuaternion(m[1]);var h=t.x*o.x+t.y*o.y;var s=t.x*o.y-t.y*o.x;var k=Math.atan2(h,s);var l=new c.Quaternion().setFromAxisAngle(new c.Vector3(0,1,0),-k);i.multiplyQuaternion(l);m=r.getVirtualGlobalMatrix().decompose();var g=new c.Vector3(n.x-m[0].x,n.y-m[0].y,n.z-j);i.translate(g)}},createLine:function(j){var h=[];h.push(new c.Vector3(0,0,0));h.push(new c.Vector3(0,0,-5000));var g=new c.LineBasicMaterial({color:8961493,force:true});var i=a.createLineNode({points:h,material:g,editable:true,drawMode:d.ConnectivityTypeEnum.LINES});i.intersectable=false;i.setName("selectionLine");i.setVisibility(false);i.exludeFromBounding(true);j.addChild(i);return i},createHitModel:function(n){var j=new e();j.setVisibility(false);j.intersectable=false;j.exludeFromBounding(true);j.setName("hitEntity");var q=16;var h=document.createElement("canvas");h.width=1;h.height=q;var p=h.getContext("2d");var l=p.createLinearGradient(0,1,0,q-1);l.addColorStop(0,"rgba(255, 255, 255, 1)");l.addColorStop(1,"rgba(255, 255, 255, 0)");p.fillStyle=l;p.fillRect(0,0,h.width,q);j.removeChildren();var k=new c.Texture(h);k.needsUpdate=true;var o=new c.MeshBasicMaterial({color:6925514,side:c.DoubleSide,map:k,transparent:true,force:true});var i=a.createTubeNode({bottomCenterPoint:new c.Vector3(0,0,0),extrusionVector:new c.Vector3(0,0,50),internalRadius:80,externalRadius:81,sag:30,material:o});i.intersectable=false;i.exludeFromBounding(true);i.setShadow(false,true);j.addChild(i);var g=new c.LineBasicMaterial({color:2314597,force:true});var m=a.createLineNode({points:[new c.Vector3(0,0,0),new c.Vector3(80,0,0)],material:g});m.intersectable=false;m.exludeFromBounding(true);j.addChild(m);n.addChild(j);return j},update:function(j,p){var m=j.controller;var h=m.getNode().getChildByName("selectionLine");var o=j.hitEntity;if(h.isVisible()){var g=m.picking3d({type:"line",intersectFloor:true,viewer:this._viewer});p.intersection=g;var r=h.getBuffer(d.VertexComponentEnum.POSITION);if(g!==null&&g.valid){r[5]=-g.distance;var s=new c.Vector3(0,0,-g.distance);var q=m.getNode().getMatrix();s.applyMatrix4(q);var l=q.decompose();var n=new c.Vector3(0,1,0).applyQuaternion(l[1]);n.z=0;n.normalize();var i=Math.atan2(n.y,n.x);var k=new c.Quaternion().setFromAxisAngle(new c.Vector3(0,0,1),i);p.matrix=new c.Matrix4().compose(s,k,new c.Vector3(1,1,1));o.setMatrix(p.matrix);o.setVisibility(true)}else{if(o){o.setVisibility(false)}r[5]=-g.distance||-5000}h.updateBuffer(d.VertexComponentEnum.POSITION,0,2)}else{o.setVisibility(false);this.teleportTarget={matrix:null,intersection:{}}}},bindToScenario:function(p){this._viewer=p.getViewer();var g=p.getContext();var s=p._vrNode;var j=p.getControllers();var o=this;var n;var q={};for(var m=0;m<j.length;++m){n=j[m];this.createLine(n.getNode());var h=this.createHitModel(s);q={intersection:null,matrix:null};n.addControllerAction({type:"pressed",buttonIdx:0,onDeactivate:function(){o.teleport(q,g)}});var k=function(i){return function(){i.getNode().getChildByName("selectionLine").setVisibility(true)}};var l=function(i){return function(){i.getNode().getChildByName("selectionLine").setVisibility(false)}};n.addControllerAction({type:"touched",buttonIdx:0,onActivate:k(n),onDeactivate:l(n)});var r=function(i,t){return function(){o.update({controller:i,hitEntity:t},q)}};n.addControllerAction({onFrameUpdate:r(j[m],h)})}}});return b});