define("DS/RTCollaborateAPI/RTCollaborateAPI",["UWA/Class","UWA/Class/Events","DS/PlatformAPI/PlatformAPI","i18n!DS/RTCollaborateAPI/assets/nls/feed"],function(d,b,c,f){UWA.log("3DIM - RTCollaborateAPI load");var a=function(g){if(typeof g=="string"){return UWA.log("RTCollaborateAPIlogger - "+g)}return UWA.log(g)};var e=d.extend(b,{init:function(g){if(!g){return a("no arg provided")}g.collabType="coreview";if(!g.onCollabStart){return a("onCollabStart not defined")}if(typeof g.onCollabStart!="function"){return a("onCollabStart must be a function")}if(!g.onCollabStop){return a("onCollabStop not defined")}if(typeof g.onCollabStop!="function"){return a("onCollabStop must be a function")}if(!g.onDataReceived){return a("onDataReceived not defined")}if(typeof g.onDataReceived!="function"){return a("onDataReceived must be a function")}this.channel="collab.im.3ds.com";this.id=this.channel;this.isCollabStarted=false;this.isMaster=false;this.onCollabStart=function(h){if(this.isCollabStarted){return a("onCollabStart has been called but the collab is already started")}this.isCollabStarted=true;this.isMaster=h.isMaster;return g.onCollabStart(h)};this.onCollabStop=function(h){if(!this.isCollabStarted){a("onCollabStop has been called but the collab is not started")}this.isCollabStarted=false;return g.onCollabStop(h)};this.onDataReceived=function(i){if(!i||!i.data){return a("onDataReceived bad data format")}if(!this.isCollabStarted){return a("onDataReceived has been called but the collab is not started")}var h;try{h=JSON.parse(atob(i.data))}catch(j){return a("onDataReceived failed to decode and parse received data")}return g.onDataReceived(h.data)};this.onChangeMasterReceived=function(h){if(!this.isCollabStarted){a("onChangeMasterReceived has been called but the collab is not started")}if(g.onChangeMasterReceived&&typeof g.onChangeMasterReceived=="function"){return g.onChangeMasterReceived(h)}a("onChangeMasterReceived but no function to launch with")};this.platformListenner=(function(h){return function(i){switch(i.action){case"startCollab":h.onCollabStart(i);break;case"stopCollab":h.onCollabStop(i);break;case"dataCollabReceived":h.onDataReceived(i);break;case"changeMaster":h.onChangeMasterReceived(i);break;default:a("received an unknown action : "+i.action)}}})(this);this.subscribeToChannel=function(h){if(!h||!this.onDataReceived||!this.onCollabStop||!this.onCollabStart){return a("subscribeToChannel bad args")}c.subscribe(this.channel,this.platformListenner);return true};this.subscribeToChannel(this.channel)},stop:function(){c.publish(this.channel,{action:"stopCollab",data:null})},sendData:function(g){if(!this.isCollabStarted){return a("sendData raised but the collab has not been started yet")}if(!g){return a("sendData raised without data")}if(!this.channel){return a("sendData raised but the PlatformAPI channel is not set")}var h=UWA.Json.prune(g,{fallback:function(j,i){if(i=="circular"){return null}return j}});c.publish(this.channel,{action:"dataCollab",data:h})}});return e});