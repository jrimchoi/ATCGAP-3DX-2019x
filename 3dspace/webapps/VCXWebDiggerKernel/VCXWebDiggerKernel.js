var VCXGlobalDiggerCompare=function(d,c){return d.key-c.key};var VCXGlobalDiggerCompareOpposite=function(d,c){return c.key-d.key};define("DS/VCXWebDiggerKernel/VCXDiggerKernel",["DS/Core/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/WebRBTree/WebRBTree","DS/WebRBTree/WebRBIterator","DS/VCXWebExperienceBase/VCXOverridesChangeServices","DS/VCXWebExperienceBase/VCXSceneGraphOverridesServices","DS/VCXWebVisibility/VCXIVisibility"],function(g,b,j,d,e,h,a,c,f){var i=b.extend({init:function(){this._depth=0;this._zoomFactor=0.5;this._zoomNavigation=0;this._mode=i.EMode.Zoom;this._attach=true;this._attachP=null;this._lockViewpoint=false;this._lockPlanes=false;this._target=null;this._position=null;this._lockSynchronizeDiggerViewpoint=false;this._previousVPTarget=new j.Vector3(0,0,0);this._previousVPOrientation=new j.Quaternion(0,0,0,0);this._lockCenter=false;this._sphereCenter=null;this._doubleDirection=false;this._lockPickability=false;this._lockOpacity=false;this._diggMode=i.EDigMode.Linear;this.distanceType=i.EDigDistance.Plan;this.boundingType=i.EDigBounding.Box;this._invertDirection=false;this._lockUpdateDigger=false;this.resetArray();this._positionPx=null;this._radiusPx=null;this._torchFilter=true;this._experienceBase=null;this._viewer=null;this._SceneGraphOverrideSet=null;this._SortTimer=null;this._updatePickabilityTimer=null;var k=this;this.onChangeViewpoint=function(m){if(m.eventType==="@onViewpointChange"){if(!k.isFullViewer()){return}if(k._lockSynchronizeDiggerViewpoint){return}if(k._viewer&&k._viewer.currentViewpoint&&k._viewer.currentViewpoint.getControl()&&m.viewpoint){}else{return}if(k._diggMode!==i.EDigMode.Linear){return}if(k.getLockViewpoint()){return}var n=k._viewer.currentViewpoint.target;var l=k._viewer.currentViewpoint.getControl().orientation;if(l.equals(k._previousVPOrientation)&&n.equals(k._previousVPTarget)){return}k._previousVPTarget.copy(n);k._previousVPOrientation.copy(l);if(k._mode!==i.EMode.Onion&&k._mode!==i.EMode.XRay){return}if(k.getLockPlanes()){return}if(k._lockUpdateDigger){return}k._lockPickability=true;k.updateDigger();if(k._updatePickabilityTimer){window.clearTimeout(k._updatePickabilityTimer);k._updatePickabilityTimer=null}k._updatePickabilityTimer=window.setTimeout(function(){window.clearTimeout(k._updatePickabilityTimer);k._updatePickabilityTimer=null;k._lockPickability=false;k._lockOpacity=true;k.updateDiggerContent();k._lockOpacity=false},500)}};this.onPropertiesChanged=function(q){if(q===undefined||q===null){return}var m=false;var l=q;for(var o in l._map){if(l._map.hasOwnProperty(o)){var n=l.GetPropertySet(o);for(var r in n._map){if(n._map.hasOwnProperty(r)){var p=n._map[r];if(p==="Actor.Opacity"){m=true}}}}}if(m){k._opacityObj=[]}};this.onScenarioChanged=function(){if(k._viewer===undefined||k._viewer===null){return}k.resetArray();if(k._SceneGraphOverrideSet){k.removeOverrides();k._SceneGraphOverrideSet=c.createAndPushSceneGraphOverrideSet(k._experienceBase,k._viewer)}k.updateDigger()};this._tokenChangeViewpoint=d.subscribe({event:"/VISU/"},this.onChangeViewpoint);this._tokenPropertiesChanged=d.subscribe({event:"VCX_PROPERTIES_CHANGED"},this.onPropertiesChanged);this._tokenScenarioChanged=d.subscribe({event:"VCX_CURRENT_SCENARIO_CHANGED"},this.onScenarioChanged);this._tokenSelectionAdd=d.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_ADD"},function(){k.onChangeCSO()});this._tokenSelectionRemove=d.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_REMOVE"},function(){k.onChangeCSO()})},resetTorchInfo:function(){this._torchInfo={};this._torchInfo._isInTorchArray=[];this._torchInfo._pathElementArray=[];this._torchInfo._nbModifiableInTorch=0},resetArray:function(k){if(k===undefined){k=true}this._zOrder=[];this._zOppositeOrder=[];if(k){this._opacityObj=[];this._modifiableBBoxInWCS=[]}this._modifiableProjectMinMax={};this.resetTorchInfo()},dispose:function(){if(this._tokenChangeViewpoint!==null){d.unsubscribe(this._tokenChangeViewpoint);this._tokenChangeViewpoint=null}if(this._tokenPropertiesChanged!==null){d.unsubscribe(this._tokenPropertiesChanged);this._tokenPropertiesChanged=null}if(this._tokenScenarioChanged!==null){d.unsubscribe(this._tokenScenarioChanged);this._tokenScenarioChanged=null}if(this._tokenSelectionAdd){d.unsubscribe(this._tokenSelectionAdd);this._tokenSelectionAdd=null}if(this._tokenSelectionRemove){d.unsubscribe(this._tokenSelectionRemove);this._tokenSelectionRemove=null}this.resetArray()},isFullViewer:function(){return this._radiusPx===null},setMode:function(k){this._mode=k},getMode:function(){return this._mode},setAttach:function(k){this._attach=k},getAttach:function(){return this._attach},lockViewpoint:function(k){this._lockViewpoint=k},getLockViewpoint:function(){return this._lockViewpoint},lockPlanes:function(k){this._lockPlanes=k},getLockPlanes:function(){return this._lockPlanes},invertDirection:function(k){this._invertDirection=k},getInvertDirection:function(){return this._invertDirection},setDepth:function(k){this._depth=k},getDepth:function(){return this._depth},resetDepth:function(){this._depth=0},resetZoom:function(){this._zoomFactor=0},setZoom:function(k){this._zoomFactor=k},getZoom:function(){return this._zoomFactor},setDepthZoom:function(k){this._zoomNavigation=k},getDepthZoom:function(){return this._zoomNavigation},onChangeCSO:function(k){if(this._diggMode===i.EDigMode.Spherical&&!this._lockCenter){this.sortFrontToBack();this.updateDiggerContent(true)}},getPositionPx:function(){return this._positionPx},getRadiusPx:function(){return this._radiusPx},setTorchFilter:function(k){this._torchFilter=k},getTorchFilter:function(){return this._torchFilter},removeOverrides:function(){if(this._SceneGraphOverrideSet){c.removeSceneGraphOverrideSet(this._experienceBase,this._SceneGraphOverrideSet,this._viewer);this._SceneGraphOverrideSet=null}},getBBoxInWCS:function(l){var k=l.getBoundingBox(null,this._viewer);if(k.min.x===Infinity||k.min.y===Infinity||k.min.z===Infinity||k.max.x===-Infinity||k.max.y===-Infinity||k.max.z===-Infinity){return null}k.applyMatrix4(l.getWorldMatrix(this._viewer));return k},projectBBox:function(k){},calcSphereCenterSelection:function(){var k=g.Selection.CSOManager.get();return this.calcSphereCenterArray(k)},calcSphereCenterArray:function(t){var m=null;if(t&&t.length){var n=0;for(var p=0;p<t.length;p++){var o=t[p];if(o){var q=o.pathElement;if(q){var r=this.getBBoxInWCS(q);if(r){if(m){m.add(r.center())}else{m=r.center()}n++}}}}if(n>1){m.divideScalar(n)}}if(m===null){var l=this._experienceBase.getManager("VCXContextManager");if(l){var k=l.getRootPathElement();if(k){var s=k.getBoundingBox(null,this._viewer);m=s.center()}}}return m},calcProjection:function(o,p){var l=null;var n=this._experienceBase.getManager("VCXContextManager").getMainViewer();if(n){l=n.currentViewpoint}if(l===null){return false}var u=this.getRadiusPx();var r=new j.Vector2();var k=new j.Vector2();for(var m=0;m<p.length;m++){var q=p[m];var t=l.project(q);if(m==0){r.x=t.x;r.y=t.y;k.x=t.x;k.y=t.y}else{r.x=Math.min(r.x,t.x);r.y=Math.min(r.y,t.y);k.x=Math.max(k.x,t.x);k.y=Math.max(k.y,t.y)}}var s=o.QueryInterface("VCXIModifiable");if(s){this._modifiableProjectMinMax[s.GetHashing()]={pntMin:r,pntMax:k}}return true},isInTorch:function(p){var m;var r=p in this._modifiableProjectMinMax;if(r){m=this._modifiableProjectMinMax[p]}else{return false}var o=m.pntMin.clone();var k=m.pntMax.clone();if(this._attach){var n=this._attachP;if(n){o.x-=n.x;o.y-=n.y;k.x-=n.x;k.y-=n.y}}else{var q=this.getPositionPx();if(q){o.x-=q.x;o.y-=q.y;k.x-=q.x;k.y-=q.y}}var l=this.getRadiusPx();if(o.x<=l&&k.x>=-l&&o.y<=l&&k.y>=-l){return true}return false},GetListComponent:function(){var q=this._experienceBase.ComponentsMap.GetComponentFromType("VCXWebComponentOccurrence");var m=[];for(var p=0;p<q.length;p++){var t=q[p];var n=["VCXComponentMesh","VCXComponentPoint","VCXComponentCurveWire","VCXComponentCompositePmi"];if(t.IsKindOf(n)){m.push(t)}}var v=this._experienceBase.ComponentsMap.GetComponentFromType("VCXComponentDressup");var o=[];for(var p=0;p<v.length;p++){var t=v[p];var u=["VCXComponentDigger","VCXComponentViewport","VCXComponentCamera"];if(!t.IsKindOf(u)){var s=t.QueryInterface("W3AISGNodeHolder");if(s){var l=1;var k=t.QueryInterface("VCXIVisibility");if(k){l=k.GetVisibility()}if(l!==f.EVisState.Hidden){o.push(t)}}}}var r=m.concat(o);return r},calcDistanceMinMax:function(q,p,n,o,m,l){var r=0;if(this._diggMode===i.EDigMode.Linear){if(this.distanceType===i.EDigDistance.Plan){var k=new j.Vector3().subVectors(q,this._position);r=p.dot(k)}else{if(this.distanceType===i.EDigDistance.Object){var k=new j.Vector3().subVectors(q,this._position);if(p.dot(k)>0){r=k.length()}else{r=-k.length()}}}}else{if(this._diggMode===i.EDigMode.Spherical){r=this._sphereCenter.distanceTo(q)}}if(o){if(!l.zmin){l.zmin=r}l.zmin=Math.min(r,l.zmin);if(this._diggMode===i.EDigMode.Spherical&&this.getInvertDirection()){if(n.containsPoint(this._sphereCenter)){l.zmin=0}}}if(m){if(!l.zmax){l.zmax=r}l.zmax=Math.max(r,l.zmax)}},pushZOrder:function(p,o,k){var n=new Object();n.key=o;var m=p.findIter(n);if(m){n=null;var l=m.data();if(l.list===undefined){l.list=[]}l.list.push(k)}else{n.value=k;p.insert(n)}},RBTreeToArray:function(n,m){var k=new h(n);var l=k.next();while(l!==null){m.push(l.value);if(l.list){l.list.forEach(function(o){m.push(o)})}l=k.next()}},RBTreeDataToArray:function(k,m,l){if(!k.hasOwnProperty(m.value._ID)){k[m.value._ID]=1;l.push(m.value)}if(m.list){m.list.forEach(function(n){if(!k.hasOwnProperty(n._ID)){k[n._ID]=1;l.push(n)}})}},needForwardOrder:function(){return(this._diggMode===i.EDigMode.Linear&&!this.getInvertDirection())||(this._diggMode===i.EDigMode.Spherical&&this.getInvertDirection())},needBackwardOrder:function(){return(this._diggMode===i.EDigMode.Spherical&&!this.getInvertDirection())||(this._diggMode===i.EDigMode.Linear&&this.getInvertDirection())},computeInTorchInfo:function(q,p){var o={};o._isInTorchArray=[];o._pathElementArray=[];o._nbModifiableInTorch=0;for(var m=0;m<q.length;m++){var l=q[m];var k=l.QueryInterface("VCXIModifiable");if(k){o._isInTorchArray[m]=this.isInTorch(k.GetHashing());if(o._isInTorchArray[m]){o._nbModifiableInTorch++;if(p){var n=l.QueryInterface("W3AISGNodeHolder").getPathElement();if(n){o._pathElementArray.push(n)}}}}}return o},sortMapDistance:function(m,o){var q=this;this._zOrder=[];var n=new Date().getTime();if(!this._doubleDirection){if(this.needForwardOrder()){this.RBTreeToArray(m,this._zOrder)}else{this.RBTreeToArray(o,this._zOrder)}}else{var k={};var s=new h(m);var r=new h(o);var p=s.next();var l=r.next();while(p!==null&&l!==null){this.RBTreeDataToArray(k,p,this._zOrder);this.RBTreeDataToArray(k,l,this._zOrder);p=s.next();l=r.next()}}},sortFrontToBack:function(){if((this._mode!==i.EMode.XRay)&&(this._mode!==i.EMode.Onion)){console.log("sortFrontToBack call not wanted!");return}var x=new Date().getTime();this._zOrder=[];this._zOppositeOrder=[];this._opacityObj=[];var r=new e(VCXGlobalDiggerCompare);var v=new e(VCXGlobalDiggerCompareOpposite);if(this._experienceBase==undefined){return}if(this._viewer.currentViewpoint==undefined){return}if(!this.getLockPlanes()||!this._target||!this._position){var G=this._viewer.currentViewpoint.target;this._target=new j.Vector3(G.x,G.y,G.z);var H=this._viewer.currentViewpoint.position;this._position=new j.Vector3(H.x,H.y,H.z)}if(this._diggMode===i.EDigMode.Spherical){if(!this._lockCenter||!this._sphereCenter){this._sphereCenter=this.calcSphereCenterSelection()}}var q=true;if(!this.isFullViewer()){q=!this.getTorchFilter()}var l=this._doubleDirection||this.needForwardOrder();var o=this._doubleDirection||this.needBackwardOrder();var n=new j.Vector3().subVectors(this._target,this._position);n.normalize();var s=this.GetListComponent();for(var B=0;B<s.length;B++){var D=s[B];var t=D.QueryInterface("VCXIVisibility");if(t){if(t.GetVisibility()===f.EVisState.Hidden){continue}}var w=D.QueryInterface("W3AISGNodeHolder").getPathElement();if(w){var y=w;if(this._modifiableBBoxInWCS[B]===undefined){var A=y.getBoundingBox(null,this._viewer);if(A.min.x===Infinity||A.min.y===Infinity||A.min.z===Infinity||A.max.x===-Infinity||A.max.y===-Infinity||A.max.z===-Infinity){this._modifiableBBoxInWCS[B]=Infinity}else{var k=y.getWorldMatrix(this._viewer);var C=A.clone();C.applyMatrix4(k);this._modifiableBBoxInWCS[B]=C}}var C=this._modifiableBBoxInWCS[B];if(C===Infinity){}else{var E=C.min;var F=C.max;var m=[];m.push(E);m.push(new j.Vector3(F.x,E.y,E.z));m.push(new j.Vector3(F.x,F.y,E.z));m.push(new j.Vector3(E.x,F.y,E.z));m.push(F);m.push(new j.Vector3(E.x,F.y,F.z));m.push(new j.Vector3(E.x,E.y,F.z));m.push(new j.Vector3(F.x,E.y,F.z));var p=null;if(this._diggMode===i.EDigMode.Spherical&&this.getInvertDirection()){p=C.center();m.push(p)}this.calcProjection(D,m);var u={zmin:null,zmax:null};for(var z=0;z<m.length;z++){this.calcDistanceMinMax(m[z],n,C,l,o,u)}if(l){this.pushZOrder(r,u.zmin,D)}if(o){this.pushZOrder(v,u.zmax,D)}}}}this.sortMapDistance(r,v)},_updateDiggerXRayContent:function(q){if(q.length===0){return}if(!this._SceneGraphOverrideSet){this._SceneGraphOverrideSet=c.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer);if(!this._SceneGraphOverrideSet){return}}var l=q.length;if(!this.isFullViewer()&&this.getTorchFilter()&&this._torchInfo._isInTorchArray[0]===undefined){this._torchInfo=this.computeInTorchInfo(q)}var u;if(this.isFullViewer()||!this.getTorchFilter()){u=l}else{u=this._torchInfo._nbModifiableInTorch}var z=0;var m=this._depth*u;for(var r=0;r<l;r++){var v=this.isFullViewer()||!this.getTorchFilter()||this._torchInfo._isInTorchArray[r];if(v){z++}var s=q[r];if(!s){console.log("_updateDiggerXRayContent: component null");continue}var k=s.QueryInterface("W3AISGNodeHolder").getPathElement();if(!k){console.log("_updateDiggerXRayContent: pathElement null");continue}if(!this._lockPickability){var y=!(v&&z<m);a.Ghost(this._SceneGraphOverrideSet,k,false,null,y?1:2)}if(!this._lockOpacity){var t=1;var x=0.125;if(v&&z<m){if(this._mode===i.EMode.XRay){var p=z/m;p*=p;t=x*p}else{if(this._mode===i.EMode.Onion){t=0}}}if((this._opacityObj[r]===undefined)||(this._opacityObj[r]!==t)){var o=null;if(k){var A=s.QueryInterface("VCXIModifiable");if(A){o=s.globalAlpha;if(o===null||o===undefined){var w=A.GetProperty("Actor.Opacity");if(w){o=w.GetPropertyValue().Value}}}}if(o){t*=o}a.Ghost(this._SceneGraphOverrideSet,k,true,t,0);this._opacityObj[r]=t}}}},updateDigger:function(){if((this._mode!==i.EMode.XRay)&&(this._mode!==i.EMode.Onion)){return}var k=false;if(k&&this._SortTimer===null){var l=this;l._SortTimer=window.setTimeout(function(){if(true){window.clearTimeout(l._SortTimer);l._SortTimer=null;l.sortFrontToBack();l.updateDiggerContent()}},250)}else{this.sortFrontToBack();this.updateDiggerContent()}},updateDiggerContent:function(l){if((this._mode===i.EMode.XRay)||(this._mode===i.EMode.Onion)){var k=new Date().getTime();if(this._zOrder.length===0){this.sortFrontToBack()}this._updateDiggerXRayContent(this._zOrder)}if(l){this._viewer.render()}},});i.EMode={Zoom:0,Onion:1,XRay:2,Detail:3};i.EDigMode={Linear:0,Cylindrical:1,Spherical:2};i.EDigDistance={Object:0,Plan:1};i.EDigBounding={Box:0,Sphere:1};return i});