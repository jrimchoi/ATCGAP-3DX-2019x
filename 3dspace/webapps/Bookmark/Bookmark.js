define("DS/Bookmark/script/Model/BaseModel",["UWA/Core","UWA/Json","UWA/Utils","UWA/Class/Model","DS/Logger/Logger","DS/WAFData/WAFData"],function(e,d,c,b,a,f){function i(j,l){var k=undefined;if(j){k=j[l];if(e.is(k,"function")){k=k.call(j)}}return k}function h(j){return(!j.contains("?")?"?":(j.endsWith("?")?"":"&"))}var g=b.extend({_getResponseHeader:function(k,j){var m=null,l=k.request;if(e.is(l&&l.getResponseHeader,"function")){m=l.getResponseHeader(j)}else{if(e.is(l&&l.xhr&&l.xhr.getResponseHeader,"function")){m=l.xhr.getResponseHeader(j)}else{if(k.responseHeaders){m=k.responseHeaders[j]}}}return m},sync:function(q,k,j){var m=j||{},o=this,p=m.onComplete,n=m.onFailure,l=e.is(this.getSubject,"function")?this.getSubject():this;m.ajax=f.authenticatedRequest;m.headers=m.headers||{};if(e.is(m.data,"object")&&(q==="read"||(m.method&&m.method.toLowerCase()==="get"))){m.url+=h(m.url)+c.toQueryString(m.data);m.data=null}else{if(!m.headers["Content-Type"]){m.headers["Content-Type"]="application/json;charset=utf-8"}}if(!m.url){m.url=(i(k,"url"))}if(m.url&&m.url.indexOf("tenant=")===-1){if(e.is(l.getSharedOptions,"function")){m.url+=h(m.url)+"tenant="+l.getSharedOptions().getOption("tenantId")}else{a.warn("Tenant Id is missing")}}if(p){m.onComplete=function(r,t){var s=!e.is(r,"string")?r:d.decode(r);o._totalRecords=e.is(s&&s.totalRecords)?s.totalRecords:0;return p.call(this,e.is(s&&s.result)?s.result:s,t)}}if(n){m.onFailure=function(s,r,u){var t=!e.is(r,"string")?r:d.decode(r);return n.call(this,s,e.is(t&&t.result)?t.result:t,u)}}this._parent.call(this,q,k,m)}});return g});define("DS/Bookmark/script/Request/BookmarkRequest",["UWA/Core","UWA/Class"],function(b,a){return a.singleton({_serviceUrl:null,_csrfToken:null,setConfig:function(c){if(c.serviceUrl){this._serviceUrl=c.serviceUrl}else{console.error("Option serviceUrl must be send to initialize Bookmark requests")}if(c.csrfToken){this._csrfToken=c.csrfToken}else{console.error("Option csrfToken must be send to initialize Bookmark requests")}},updateRequest:function(e,d,c){b.merge(c,{headers:{}});if(this._serviceUrl){c.url=this._serviceUrl+c.url}if(this._csrfToken){c.headers={"X-DS-CSRFTOKEN":this._csrfToken}}if(e&&d){if(e==="update"||e==="delete"){c.url+="/"+d.get("id")}if(e==="read"&&d.get("subjectUri")){c.url+="/subjects/"+d.get("subjectUri")}}return c}})});define("DS/Bookmark/script/Model/BookmarkModel",["UWA/Core","UWA/Promise","DS/Bookmark/script/Model/BaseModel","DS/Bookmark/script/Request/BookmarkRequest"],function(d,c,a,b){return a.extend({name:"bookmark",url:"/api/bookmarks/me",defaults:{subjectUri:null,title:null,serviceName:null,linkServiceName:null,linkUri:null},_thumbnailUrl:null,sync:function(g,f,e){e.url=this.url;e=b.updateRequest(g,f,e);return this._parent.apply(this,arguments)},getThumbnailUrl:function(){return this._thumbnailUrl},getModelName:function(){return this.name},_setThumbnailUrl:function(e){var f=this;f.platformId=e.hasOwnProperty("platformId")&&e.platformId;return new c(function(h,g){require(["DS/BookmarkCustomization/script/source/"+f.get("serviceName")],function(i){i.getThumbnailUrlFromContentUri(f.toJSON(),f.platformId,function(j){f._thumbnailUrl=j;h()})},function(){console.error("No customization module for this serviceName: "+f.get("serviceName"))})})}})});define("DS/Bookmark/script/Collection/BaseCollection",["UWA/Core","UWA/Json","DS/WebAppsFoundations/Collections/PageableCollection","UWA/Class/Model","DS/Bookmark/script/Model/BaseModel"],function(g,e,c,f,a){var b=function(i,h){if(typeof i==="function"){return(function(){var l=null,m=null,n=h||30,o=null,k=function(){i.apply(m,l)},j=function(){m=this;l=arguments;if(o){clearTimeout(o)}o=setTimeout(k,n)};return j})()}else{throw new Error("First argument is supposed to be a function")}};var d=c.extend({_mainRangeName:null,_stateModel:null,_fetched:false,_beingFetched:false,ranges:null,defaultOptions:{stateParseMode:"headers",state:{baseOffset:0,firstPage:0,currentPage:0},queryParams:{currentPage:"page_number",pageSize:"page_size"}},_executePostInitInstructions:function(){var h=this,i=b(function(){var j=[];if(arguments.length>=2){j=[].concat(arguments).slice(arguments.length-2)}h.dispatchEvent("onCollectionChange",j)});this.addEventOnce("onSync",function(j){if(j===this){this._fetched=true}});this.addEvents({onAdd:i,onRemove:i,onSort:i,onReset:i,onRequest:function(j){if(this===j){this._beingFetched=true}},onSync:function(j){if(this===j){this._beingFetched=false}},onError:function(j){if(this===j){this._beingFetched=false}}})},_computeTotalPages:function(i,h){if(this.state&&(this.state.baseOffset>0)&&(i>=this.state.baseOffset)){return Math.ceil((i-this.state.baseOffset)/h)}else{return this._parent.apply(this,arguments)}},_getPageValueConsistentWithCurrentState:function(h){if(!h){h={}}var l=this.state||{},m=g.is(h.totalRecords,"number")?h.totalRecords:l.totalRecords,i=g.is(h.collectionSize,"number")?h.collectionSize:this.length,k=this._computeTotalPages(m,l.pageSize),j=(k?Math.max(l.firstPage,Math.ceil((i-this.state.baseOffset)/l.pageSize)-(l.firstPage===0?1:0)):l.firstPage);return j},_updateCurrentPageState:function(){this.state=this._checkState(g.extend(this.state||{},{currentPage:this._getPageValueConsistentWithCurrentState()}))},_updateStateModel:function(){if(!this._stateModel){this._stateModel=new f();this.listenTo(this._stateModel,{onAnyEvent:function(k,j,i,h){this.dispatchEvent(k+"State",[j,i,h])}})}this._stateModel.set(this.state)},_checkState:function(){var h=this._parent.apply(this,arguments);setTimeout(this._updateStateModel,0);return h},_getResponseHeader:function(i,h){var j=null;if(g.is(i.request&&i.request.getResponseHeader,"function")){j=i.request.getResponseHeader(h)}else{if(i.responseHeaders){j=i.responseHeaders[h]}}return j},init:function(){this.ranges={};this._updateStateModel=this._updateStateModel.bind(this);this._parent.apply(this,arguments);this._executePostInitInstructions()},parseRanges:function(i,h){return{}},parseHeadersForStateUpdate:function(l,i,j,h){var k={};g.extend(this.ranges,this.parseRanges(l,h));return k},setTotalRecords:function(h){this._totalRecords=h;return this},getTotalRecords:function(){return this._totalRecords},sync:function(j,i,h){return a.prototype.sync.apply(this,arguments)},hasBeenFetched:function(){return this._fetched},isBeingFetched:function(){return this._beingFetched},onAdd:function(){this._updateCurrentPageState()},onRemove:function(){this._updateCurrentPageState()},onReset:function(){this._updateCurrentPageState()},onCollectionChange:function(i,h){if(!this._beingFetched&&(!this.state.totalRecords||this.length>this.state.totalRecords)){this.setTotalRecords(this.length)}},clean:function(){this.reset([])}});return d});define("DS/Bookmark/script/Collection/BookmarkCollection",["UWA/Core","DS/Logger/Logger","DS/Bookmark/script/Collection/BaseCollection","DS/Bookmark/script/Model/BookmarkModel","DS/Bookmark/script/Request/BookmarkRequest"],function(e,b,d,f,c){var a=d.extend({name:"bookmark-collection",url:"/api/bookmarks/me",model:f,defaultOptions:{state:{pageSize:10}},_executePostInitInstructions:function(){},parseRecords:function(i,h){var g=i;return g},setup:function(g){return this._parent.apply(this,arguments)},fetch:function(g){var h=g||{};if(!h.onFailure){h.onFailure=function(){b.error("Failed to retrieve bookmarks")}}h.url=this.url;if(g.service_name){h.url=h.url+"/"+g.service_name}h=c.updateRequest(null,null,h);return this._parent.call(this,h)},hasNext:function(){if(parseInt(this._totalRecords)===parseInt(this.length)){return false}else{return true}}});return a});define("DS/Bookmark/script/BookmarkManager",["UWA/Core","UWA/Class","UWA/Promise","DS/Bookmark/script/Model/BookmarkModel","DS/Bookmark/script/Collection/BookmarkCollection","DS/Bookmark/script/Request/BookmarkRequest","DS/WAFData/WAFData","DS/UWPClientControls/PlatformNotify","UWA/Class/Events","i18n!DS/Bookmark/assets/nls/bookmark-manager"],function(d,h,e,a,b,i,f,g,j,c){return j.singleton({_serviceUrl:null,_csrfToken:null,_isReady:false,_isFailed:false,_getThumbnails:function(o,p){var l=[],m=this.platformId?{platformId:this.platformId}:{};o.map(function(q){l.push(q._setThumbnailUrl(m))});e.all(l).then(function n(){p&&p(o)},function k(){console.log("getThumbnail failed",arguments)})},init:function(k){this.setConfig(k)},setConfig:function(k){var l=this;l._isReady=false;if(k&&k.hasOwnProperty("csrfToken")&&k.hasOwnProperty("serviceUrl")){i.init({csrfToken:k.csrfToken,serviceUrl:l.serviceUrl});l.dispatchEvent("onReady")}else{l.platformId=k.platformId;require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(m){m.getServiceUrl({platformId:l.platformId,serviceName:"comment",onComplete:function(n){l._serviceUrl=n;f.authenticatedRequest(l._serviceUrl+"/api/session/info",{method:"GET",type:"json",headers:{Accept:"application/json;charset=UTF-8","Content-Type":"application/json;charset=UTF-8"},onComplete:function(o,q,p){l._csrfToken=o.csrfToken;l._isReady=true;i.setConfig({csrfToken:l._csrfToken,serviceUrl:l._serviceUrl});l.dispatchEvent("onReady")},onFailure:function(){l._isFailed=true;l.dispatchEvent("onFailure");console.error("Failed to get CSRF token from comment service")}})},onFailure:function(){l._isFailed=true;l.dispatchEvent("onFailure");console.error("Failed to get bookmark (comment) service url")}})})}},get:function(m,n){var l=this,k;if(l._isReady){k=new b([],{state:{currentPage:m.page_number?m.page_number:0,pageSize:m.page_size?m.page_size:25},serviceName:m.service_name?m.service_name:null});k.fetch(d.extend(m,{onComplete:function(o){l._getThumbnails(o,n)}}))}else{l._waitInitialization(l.get,arguments)}},getNextPage:function(l,m){var k=this;if(k._isReady&&l){l.getNextPage({add:true,remove:false,reset:false,onComplete:function(n){k._getThumbnails(n,m)}})}},add:function(n){var l=this,k,m=l.platformId?{platformId:l.platformId}:{};if(l._isReady){k=new a();k.save(n,{onComplete:function(){k._setThumbnailUrl(m).then(function(){l.dispatchEvent("onBookmarkAdded",k);g.success(c.SuccessfullyAddedToYourBookmarks)})}})}else{l._waitInitialization(l.add,arguments)}},remove:function(k){var l=this;k.destroy({onComplete:function(){l.dispatchEvent("onBookmarkRemoved",k);g.success(c.SuccessfullyRemovedFromYourBookmarks)}})},update:function(k,m){var l=this;k.save(m,{onComplete:function(n){l.dispatchEvent("onBookmarkUpdated",n);g.success(c.BookmarkSuccessfullyUpdated)}})},isContentBookmarked:function(m,o){var k=this,l=null,n;if(k._isReady){n=new a({subjectUri:m});n.fetch({onComplete:function(p,q){var r;if(q.length>0){r=new a(q[0]);o(r)}else{o(false)}},onFailure:function(p){console.log(p);o(new Error("Bookmark service down"))}})}else{k._waitInitialization(k.isContentBookmarked,arguments)}},_waitInitialization:function(k,m){var l=this;if(!l._isFailed){l.addEventOnce("onReady",function(){k.apply(l,m)});l.addEventOnce("onFailure",function(){if(m.hasOwnProperty("1")&&typeof m[1]==="function"){m[1](new Error("Failed to reach Bookmark service"))}})}else{if(m.hasOwnProperty("1")&&typeof m[1]==="function"){m[1](new Error("Failed to reach Bookmark service"))}}}})});define("DS/Bookmark/script/View/BookmarkItemView",["UWA/Core","UWA/Class/View","UWA/String","UWA/Event","DS/UIKIT/SuperModal","DS/Bookmark/script/BookmarkManager","DS/UIKIT/DropdownMenu","DS/UIKIT/Input/Text","DS/UIKIT/Tooltip","i18n!DS/Bookmark/assets/nls/View/bookmark-item-view"],function(h,c,e,i,d,k,a,f,j,g){var b=c.extend({className:"bookmark-item-view",_superModal:null,_editMode:false,_actionTooltip:null,_cancelTooltip:null,setup:function(){this.clickCallback=this.options.clickCallback;this.listenTo(this.model,"onChange",this.render)},render:function(){var m=this,l;if(window.ds&&(ds.env!=="3DD")){l=window.document&&window.document.body}else{l=window.widget&&window.widget.body}this.editInput=new f({placeholder:g.BookmarkTitle+"...",value:this.model.get("title")?e.unescapeHTML(this.model.get("title")):"",className:"bookmark-title-input",events:{onKeyDown:function(o){var n=i.whichKey(o);if(n==="return"){if(this.getValue()!==m.model.get("title")&&this.getValue()!==""){k.update(m.model,{title:this.getValue()})}m._closeEditMode()}else{if(n==="esc"){this.setValue(m.model.get("title"));m._closeEditMode()}}}}}).hide();this.titleElt=h.createElement("h4",{"class":"card-title",text:this.model.get("title")?e.unescapeHTML(this.model.get("title",{escapeHTML:true})):""});this.cancelElt=h.createElement("span",{"class":"bookmark-edit-cancel fonticon fonticon-2x fonticon-wrong",events:{click:function(){m.editInput.setValue(m.model.get("title")?e.unescapeHTML(m.model.get("title")):"");m._closeEditMode()}}}).hide();this._superModal=new d({renderTo:l});this.actionsElt=h.createElement("div",{tag:"div","class":"bookmark-available-actions",html:{tag:"span","class":"fonticon fonticon-2x fonticon-down-open"}});this._actionTooltip=new j({target:this.actionsElt,body:g.Menu});this._cancelTooltip=new j({target:this.cancelElt,body:g.Cancel});this._actionMenu=new a({target:this.actionsElt,position:"bottom left",items:[{name:"edit",fonticon:"pencil",text:g.EditTitle,handler:function(n){n.stopPropagation();m._editTitle()}},{name:"remove",fonticon:"bookmark-delete",text:g.Remove,handler:function(){m._deleteBookmark()}}],className:"bookmark-contextual-actions"});this.container.setContent({tag:"div","class":"bookmark-card",events:{click:function(n){if(n.target!==m.actionsElt.firstChild&&n.target!==m.actionsElt&&n.target!==m.cancelElt&&!m._editMode){m.clickCallback(m.model)}}},html:[{tag:"img","class":"bookmark-card-img",src:this.model.getThumbnailUrl().small},{tag:"div","class":"bookmark-card-block",html:[this.titleElt,this.editInput]},this.actionsElt,this.cancelElt]});return this},_deleteBookmark:function(){var l=this;this._superModal.confirm({title:g.RemoveBookmark,message:g.DoYouReallyWantToRemoveThisContentFromYourBookmarks,callback:function(m){if(m===true){k.remove(l.model);l.container.addClassName("fadeout");setTimeout(function(){l.destroy()},500)}}})},_editTitle:function(){this.titleElt.hide();this.actionsElt.hide();this.editInput.show();this.cancelElt.show();this._editMode=true;this.container.addClassName("edit-mode");this.editInput.focus();this._listenClickOutsideBound=this._listenClickOutside.bind(this);window.addEventListener("click",this._listenClickOutsideBound)},_closeEditMode:function(){this.titleElt.show();this.actionsElt.show();this.editInput.hide();this.cancelElt.hide();this._editMode=false;this.container.removeClassName("edit-mode")},_listenClickOutside:function(l){var m=this.editInput.elements.container.contains(l.target);if(!m){if(this.editInput.getValue()!==""){if(this.editInput.getValue()!==this.model.get("title")){k.update(this.model,{title:this.editInput.getValue()})}this._closeEditMode();window.removeEventListener("click",this._listenClickOutsideBound)}}},destroy:function(){this._cancelTooltip.destroy();this._actionTooltip.destroy();this._actionMenu.destroy();return this._parent.apply(this,arguments)}});return b});define("DS/Bookmark/script/View/BookmarkCollectionView",["UWA/Core","UWA/Class/View","DS/Bookmark/script/BookmarkManager","DS/Bookmark/script/View/BookmarkItemView","css!DS/UIKIT/UIKIT","css!DS/Bookmark/Bookmark"],function(e,d,b,a){var c=d.extend({className:"bookmark-collection-view",_collection:null,setup:function(f,i,h){var g=this;b.get({service_name:f.serviceName?f.serviceName:"",page_size:f.pageSize?f.pageSize:20,page_number:f.pageNumber?f.pageNumber:0},function(j){g._collection=j;g.render();h(g._collection)});b.addEvent("onBookmarkAdded",function(j){g._collection.unshift(j);g._collection.setTotalRecords(parseInt(g._collection.getTotalRecords())+1);g.render();h(g._collection)});b.addEvent("onBookmarkRemoved",function(j){if(g._collection.get(j)){g._collection.remove(j)}g._collection.setTotalRecords(parseInt(g._collection.getTotalRecords())-1);g.render();h(g._collection)});this.itemClick=i;this._parent.apply(this,arguments);return this.render()},render:function(){var f=this;if(f._collection){if(f._collection.length>0){f.container.setContent();f._collection.map(function(g){f.container.addContent(new a({model:g,clickCallback:f.itemClick}).render())})}else{f.container.setContent({tag:"div","class":"dsi-noresult",styles:{margin:"10% 0","text-align":"center",width:"100%"},html:[{"class":"fonticon fonticon-5x fonticon-bookmark"},{html:"You don't have any bookmark"}]})}}return this},onInfiniteScroll:function(g){var f=this;b.getNextPage(this._collection,function(h){f._collection=h;f.render();g&&g(h)})}});return c});