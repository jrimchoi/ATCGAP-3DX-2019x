define("DS/3DXMTiles/OOCPath",[],function(){var a=function(c,b){this.ids=[].concat(c);this._ldhReference=b};a.prototype.isLeaf=function(b){var c=this.getLastId();return b.isLeaf(c)};a.prototype.isRoot=function(){return this.ids.length<=1};a.prototype.getLastId=function(){return this.ids[this.ids.length-1]};a.prototype.expandReference=function(b){var c=b.getInstRefJSON(this.getLastId());if(c.representation){this.ids.push(c.instanceId);this.ids.push(c.representation)}};a.prototype.getLastInstanceId=function(){if(this.ids.length>=3){return this.ids[this.ids.length-2]}return null};a.prototype.getParentReferenceId=function(){if(this.ids.length>=3){return this.ids[this.ids.length-3]}return null};a.prototype.isCGR=function(){if(this.ids[this.ids.length-1].indexOf(".cgr")!==-1){return true}return false};a.prototype.buildSubPath=function(b,d){var c=new a(this.ids,null);c.ids.push(b);c.ids.push(d);return c};a.buildFromReference=function(b,f){var g=null;var e=-1;var c=b.manager;var d;for(d=0;d<b._occurrences.length;d++){var h=b._occurrences[d];if(h.viewpointTag!==c.viewpointTag&&(h._screenRadius>e||g===null)){e=h._screenRadius;g=h}}if(!g){console.log("Could not find an occurrence for reference '"+b.referenceId+"'");return null}var j=g.getIdPath();if(f){g.viewpointTag=c.viewpointTag}var k=new a(j,b);if(b.children.length>0){k.approximate=true}return k};return a});define("DS/3DXMTiles/PriorityQueue",[],function(){var a=function(){this.reset()};a.prototype.reset=function(){this.tileNode=null;this.parent=null;this.less=null;this.more=null};a.prototype.check=function(){var e=[];function d(f){if(e.indexOf(f)>-1){console.log("argl")}else{e.push(f);if(f.less){d(f.less)}if(f.more){d(f.more)}}}d(this)};a.prototype.checkMinMax=function(e,d){var f=true;if(this.tileNode&&(this.tileNode.getScore()<e||this.tileNode.getScore()>d)){console.log("ERRRRRRRRRRREUUUUUUR");f=false}if(this.less&&!this.less.checkMinMax(e,d)){f=false}if(this.more&&!this.more.checkMinMax(e,d)){f=false}return f};a.prototype.removeMin=function(e){var d=this.less;if(d!==null){if(d.less===null){this.less=d.more;if(this.less!==null){this.less.parent=this}e.releaseHeapNode(d)}else{d.removeMin(e)}}};a.prototype.removeMax=function(e){var d=this.more;if(d!==null){if(d.more===null){this.more=d.less;if(this.more!==null){this.more.parent=this}e.releaseHeapNode(d)}else{d.removeMax(e)}}};a.prototype.insert=function(d){if(d.tileNode.getScore()<this.tileNode.getScore()){if(this.less!==null){this.less.insert(d)}else{this.less=d;d.parent=this}}else{if(this.more!==null){this.more.insert(d)}else{this.more=d;d.parent=this}}};a.prototype.getMin=function(){if(this.less===null){return this}else{return this.less.getMin()}};a.prototype.getMax=function(){if(this.more===null){return this}else{return this.more.getMax()}};a.prototype.getTileNodes=function(d){if(this.tileNode!==null){d.push(this.tileNode)}this.more&&this.more.getTileNodes(d);this.less&&this.less.getTileNodes(d)};var c=function(d){this.size=0;this.sizeLimit=d;this.root=null;this.firstFreeHeapNode=null;this.minHeapValue=-Infinity;this.maxHeapValue=+Infinity};c.prototype.getTileNodes=function(){var d=[];if(this.root!==null){this.root.getTileNodes(d)}return d};c.prototype.tryToInsertTileNodeMax=function(h,g,f){if(this.size<this.sizeLimit){if(!f||this.minHeapValue<h.getScore()){this.insert(h);g.min=null;var e=this.root.getMin();this.minHeapValue=e.tileNode.getScore();return true}else{return false}}else{if(this.minHeapValue<h.getScore()){var e=this.root.getMin();g.min=e.tileNode;this.insert(h);if(e.parent!==null){e.parent.removeMin(this)}else{this.setRoot(e.more)}this.size--;var d=this.root.getMin();this.minHeapValue=d.tileNode.getScore();return true}}return false};c.prototype.tryToInsertTileNodeMin=function(g,e,d){if(this.size<this.sizeLimit){if(!d||this.maxHeapValue>g.getScore()){this.insert(g);e.max=null;var h=this.root.getMax();this.maxHeapValue=h.tileNode.getScore();return true}else{return false}}else{if(this.maxHeapValue>g.getScore()){var h=this.root.getMax();e.max=h.tileNode;this.insert(g);if(h.parent!==null){h.parent.removeMax(this)}else{this.setRoot(h.less)}this.size--;var f=this.root.getMax();this.maxHeapValue=f.tileNode.getScore();return true}}return false};c.prototype.setRoot=function(d){if(this.root!==null){this.releaseHeapNode(this.root)}this.root=d;if(d!==null){d.parent=null}};c.prototype.getAndRemoveMaxTileNode=function(){var e=this.root.getMax();var d=e.tileNode;this.removeMaxHeapNode(e);return d};c.prototype.removeMaxHeapNode=function(d){if(d.parent!==null){d.parent.removeMax(this)}else{this.setRoot(d.less)}this.size--};c.prototype.removeMinHeapNode=function(d){if(d.parent!==null){d.parent.removeMin(this)}else{this.setRoot(d.more)}this.size--};c.prototype.getAndRemoveMinTileNode=function(){var d=this.root.getMin();var e=d.tileNode;this.removeMinHeapNode(d);return e};c.prototype.getMinHeapNode=function(){if(this.root!==null){return this.root.getMin()}return null};c.prototype.getMaxHeapNode=function(){if(this.root!==null){return this.root.getMax()}return null};c.prototype.insert=function(e){var d=this.getHeapNode(e);if(this.root===null){this.setRoot(d)}else{this.root.insert(d)}this.size++};c.prototype.getHeapNode=function(e){var d;if(!this.firstFreeHeapNode){d=new a()}else{d=this.firstFreeHeapNode;this.firstFreeHeapNode=d.more;d.reset()}d.tileNode=e;return d};c.prototype.releaseHeapNode=function(d,e){d.less=null;if(e){e(d.tileNode)}d.tileNode=null;d.more=this.firstFreeHeapNode;this.firstFreeHeapNode=d};c.prototype.releaseHeapNodeTree=function(d,f,e){if(d.less!==null){this.releaseHeapNodeTree(d.less,f+1,e);d.less=null}if(d.more!==null){this.releaseHeapNodeTree(d.more,f+1,e);d.more=null}this.releaseHeapNode(d,e)};c.prototype.reset=function(d){if(this.root!==null){this.releaseHeapNodeTree(this.root,0,d);this.root=null;this.minHeapValue=-Infinity}this.size=0};var b=function(d){this.nodeList=[];this.nbProcessedNodes=0;this.nodeListLength=0;this.listWasUpdated=false;this.maxHeapNode=null;this.minHeapNode=null;this.heap=new c(d||100)};b.prototype.fillHeapMax=function(h){var m={min:null};var k=this.nodeListLength,e,l;var f=this.heap;var j,g=0;var d=h?0:this.nbProcessedNodes;for(j=d;j<k;j++){e=this.nodeList[j];if(e===null||!e.isAlive()){g++}else{if(f.tryToInsertTileNodeMax(e,m,d!==0)){l=m.min;this.nodeList[j]=l;if(l===null){g++}}}}this.nbProcessedNodes=j;if(g>=this.nodeListLength){this.nodeListLength=0}else{if(g>200){this.cleanNulls(true)}}};b.prototype.fillHeapMin=function(h){var m={max:null};var k=this.nodeListLength,e,l;var f=this.heap;var j,g=0;var d=h?0:this.nbProcessedNodes;for(j=d;j<k;j++){e=this.nodeList[j];if(e===null||!e.isAlive()){g++}else{if(f.tryToInsertTileNodeMin(e,m,d!==0)){l=m.max;this.nodeList[j]=l;if(l===null){g++}}}}this.nbProcessedNodes=j;if(g>=this.nodeListLength){this.nodeListLength=0}else{if(g>200){this.cleanNulls(true)}}};b.prototype.getMaxNodeWithNoHeap=function(){if(this.heap.root!==null){throw new Error("Heap not empty")}var e,g=this.nodeListLength,j=-1,d=-Infinity,f=null,h=0;for(e=0;e<g;e++){f=this.nodeList[e];if(f!==null&&f.isAlive()){if(f.getScore()>d){j=e;d=f.getScore()}}else{h++}}if(j>-1){f=this.nodeList[j];this.nodeList[j]=null}else{f=null}if(h>=this.nodeListLength){this.nodeListLength=0}else{if(h>200){this.cleanNulls(false)}}return f};b.prototype.peekMaxNode=function(){if(!this.maxHeapNode){if(this.heap.size===0||this.listWasUpdated){this.fillHeapMax(this.heap.size===0);this.listWasUpdated=false}var d=null;if(this.heap.size>0){d=this.heap.root.getMax()}this.maxHeapNode=d}return this.maxHeapNode?this.maxHeapNode.tileNode:null};b.prototype.peekMinNode=function(){if(!this.minHeapNode){if(this.heap.size===0||this.listWasUpdated){this.fillHeapMin(this.heap.size===0);this.listWasUpdated=false}var d=null;if(this.heap.size>0){d=this.heap.root.getMin()}this.minHeapNode=d}return this.minHeapNode?this.minHeapNode.tileNode:null};b.prototype.removeMaxHeapNode=function(d){this.heap.removeMaxHeapNode(d)};b.prototype.getMaxNode=function(e){if(this.heap.size===0||this.listWasUpdated){this.fillHeapMax(this.heap.size===0);this.listWasUpdated=false}var d=null;if(this.heap.size>0){if(e){d=this.heap.getAndRemoveMaxTileNode()}else{d=this.heap.getMaxNode()}}return d};b.prototype.getMinNode=function(d){if(this.heap.size===0||this.listWasUpdated){this.fillHeapMin(this.heap.size===0);this.listWasUpdated=false}var e=null;if(this.heap.size>0){if(d){e=this.heap.getAndRemoveMinTileNode()}else{e=this.heap.getMinNode()}}return e};b.prototype.checkIntegrity=function(e){var g=-Infinity,d=+Infinity;if(this.heap.size>0){g=this.heap.root.getMin().tileNode.getScore();d=this.heap.root.getMax().tileNode.getScore();if(!this.heap.root.checkMinMax(g,d)){console.log("checkMinMax has failed!!!")}var f;for(f=0;f<(e!==undefined?e:this.nodeListLength);f++){if(this.nodeList[f]&&this.nodeList[f].getScore()>g){console.log("found probleme!!!")}}}};b.prototype.getMinNodeWithNoHeap=function(){if(this.heap.root!==null){throw new Error("Heap not empty")}var e,g=this.nodeListLength,j=-1,d=Infinity,f=null,h=0;for(e=0;e<g;e++){f=this.nodeList[e];if(f!==null&&f.isAlive()){if(f.getScore()<d){j=e;d=f.getScore()}}else{h++}}if(j>-1){f=this.nodeList[j];this.nodeList[j]=null}else{f=null}if(h>=this.nodeListLength){this.nodeListLength=0}else{if(h>200){this.cleanNulls(false)}}return f};b.prototype.cleanNulls=function(e){var d,h=this.nodeListLength,g=null,f=0;for(d=0;d<h;d++){g=this.nodeList[d];if(g!==null&&g.isAlive()){this.nodeList[f]=g;f++}else{if(e&&d<this.nbProcessedNodes){this.nbProcessedNodes--}}}this.nodeListLength=f;this.nodeList.length=this.nodeListLength};b.prototype.isEmpty=function(){return this.heap.size===0&&this.nodeListLength===0};b.prototype.clear=function(f){this.heap.reset(f);if(f){var d,e;for(d=0;d<this.nodeListLength;d++){e=this.nodeList[d];if(e){f(this.nodeList[d])}}}this.nodeListLength=0;this.nbProcessedNodes=0;this.maxHeapNode=null;this.minHeapNode=null};b.prototype.resetOrder=function(d){var h=this.heap.getTileNodes();this.heap.reset();var e;for(e=0;e<h.length;e++){this.addNode(h[e])}if(d){var g=0,f;for(e=0;e<this.nodeListLength;e++){f=this.nodeList[e];if(f&&d(f)){this.nodeList[g]=f;g++}}this.nodeListLength=g}};b.prototype.addNode=function(d){if(this.nodeListLength>=this.nodeList.length){this.nodeList.push(d);this.nodeListLength=this.nodeList.length}else{this.nodeList[this.nodeListLength++]=d}this.listWasUpdated=true};b.prototype.peekMinHeapNode=function(){if(this.heap.size===0||this.listWasUpdated){this.fillHeapMin(this.heap.size===0);this.listWasUpdated=false}return this.heap.getMinHeapNode()};b.prototype.peekMaxHeapNode=function(){if(this.heap.size===0||this.listWasUpdated){this.fillHeapMax(this.heap.size===0);this.listWasUpdated=false}return this.heap.getMaxHeapNode()};b.prototype.traverseMin=function(f){var d,e;do{e=true;d=this.peekMinHeapNode();if(d!==null&&f(d.tileNode)){this.heap.removeMinHeapNode(d);e=false}}while(!e)};b.prototype.traverseMinPlus=function(l){var d,h,g,k=[];function j(){g=true}function e(){h=true}do{h=false;g=false;d=this.peekMinHeapNode();if(d!==null){l(d.tileNode,e,j);if(h&&g){}else{if(g){k.push(d.tileNode)}this.heap.removeMinHeapNode(d)}}else{h=true}}while(!h);var f;for(f=0;f<k.length;f++){this.addNode(k[f])}};b.prototype.traverseMax=function(f){var d,e;do{e=true;d=this.peekMaxHeapNode();if(d!==null&&f(d.tileNode)){this.heap.removeMaxHeapNode(d);e=false}}while(!e)};b.prototype.traverseMaxPlus=function(l){var d,h,g,k=[];function j(){g=true}function e(){h=true}do{h=false;g=false;d=this.peekMaxHeapNode();if(d!==null){l(d.tileNode,e,j);if(h&&g){}else{if(g){k.push(d.tileNode)}this.heap.removeMaxHeapNode(d)}}else{h=true}}while(!h);var f;for(f=0;f<k.length;f++){this.addNode(k[f])}};b.prototype.removeNode=function(e){this.resetOrder();var d;for(d=0;d<this.nodeListLength;d++){if(this.nodeList[d]===e){this.nodeList[d]=null}}};b.prototype.getAllNodes=function(){var d=[],f,e;for(e=0;e<this.nodeListLength;e++){f=this.nodeList[e];if(f){d.push(f)}}var g=this.heap.getTileNodes();return d.concat(g)};b.prototype.getSize=function(){this.cleanNulls();var d=this.nodeListLength+this.heap.size;return d};return b});define("DS/3DXMTiles/ModelLoaderPoolParams",[],function(){var a=function(b){this.urlArray=[];this.targetArray=[];this.lod=b;this.loading=false;this.error=false};a.prototype.addFromNode=function(b,c){this.urlArray.push(b.url?this.buildURL(b.url,c):null);this.targetArray.push(b)};a.prototype.isEmpty=function(){return this.urlArray.length===0};a.prototype.buildURL=function(b,c){if(b.indexOf("://")>0||b.startsWith("//")){return b}else{if(b.indexOf("/")===0){b=b.substring(1)}return c+b}};return a});define("DS/3DXMTiles/OOCInstanceIterator",[],function(){var a=function(b,c){this._referenceIterator=b;this._childData=c};a.prototype.getReferenceIterator=function(){return this._referenceIterator};a.prototype.getInstanceId=function(){return this._childData.instanceId};a.prototype.getMatrix=function(){var b=this._childData.matrix;return b&&b.clone()};a.prototype.getNode=function(){return this._childData.node};return a});define("DS/3DXMTiles/Debug3DXMTiles",[],function(){var a=-1;return{setSceneGraphMode:function(b){if(b==="flat"){this.sceneGraphMode=0}else{if(b==="dual"){this.sceneGraphMode=1}else{throw new Error("Unknown mode")}}},sceneGraphMode:1,configs:{1:{modelDir:"../airbus/assets/airbusnew4/",instrefDir:"../airbus/assets/instref2/",assetsDir:"../airbus/assets/",toReplace:[],root:"XWB-A350-900-RR.instref"},2:{modelDir:"../airbus2/assets/3DXM/",instrefDir:"../airbus2/assets/InstRef/",assetsDir:"../airbus2/assets/",toReplace:["../airbus2/assets/NewCGRs/"],root:"XWB-A350-900-RR.instref"},3:{modelDir:"../airbus3/3dxm/",instrefDir:"../airbus3/instref216/",assetsDir:"../airbus3/",toReplace:["../airbus3/CGR/A350DEVP/","../airbus3/CGR/COMEQLIB/","../airbus3/CGR/A350DEFN/","../airbus3/CGR/COMSTLIB/"],root:"A350.instref"},4:{modelDir:"../airbus3/CGR/",instrefDir:"../airbus3/instref216/",assetsDir:"../airbus3/",toReplace:["../airbus3/CGR/"],root:"A350.instref",cgr:true}},probePrefix:"WebVisuOOC_",probeMap:new Map(),probeIndex:0,startProbe:function(c){if(window.OOCProbes===-1){a=window.OOCProbes?1:0}if(a===1){var b=this.probePrefix+c+"_"+this.probeIndex;this.probeIndex++;this.probeMap.set(c,b);window.top.performance.mark(b+"_begin")}},endProbe:function(e){if(a===1){var d=this.probeMap.get(e);this.probeMap["delete"](e);var c=d+"_end";window.top.performance.mark(c);var b=d+"_begin";window.top.performance.measure(this.probePrefix+e,b,c)}}}});define("DS/3DXMTiles/LDHReferenceUnloadStatus",[],function(){return{frozen:"frozen",unloadable:"unloadable",unloaded:"unloaded"}});define("DS/3DXMTiles/UnloadManager",[],function(){var a=-2;var c={v0:{memoryLimitMb:512,memoryLimitGPUMb:512},full:{memoryLimitMb:256,memoryLimitGPUMb:256+128},medium:{memoryLimitMb:64,memoryLimitGPUMb:64},medium_plus:{memoryLimitMb:64,memoryLimitGPUMb:128},restricted:{memoryLimitMb:48,memoryLimitGPUMb:32}};var b=function(e){this.oldVersion=(e==="v0");var f;if(!(typeof(e)==="string")){f=e}else{f=c[e]}var d=f.memoryLimitMb;var g=f.memoryLimitGPUMb;this.isRestricted=(e==="restricted");if(this.oldVersion&&(navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i))){window.OOCUnloadMemoryLimit=32;this.isRestricted=true}if(a===-2){if(this.oldVersion&&window.OOCUnloadMemoryLimit!==undefined){a=window.OOCUnloadMemoryLimit}else{a=-1}}this.config=e;this.unloadAlwaysTab=[false,false];this.hasUnloadAlways=false;if(window.OOCUnloadAlways){this.setUnloadAlwaysTab([true,true])}if(a>=0){d=a;g=a}this.memoryUsage=0;this.memoryUsageGPU=0;this.memoryLimit=d*1024*1024;this.memoryLimitGPU=g*1024*1024;this.usage=0;this.usageGPU=0;this.memoryPeak=0;this.memoryPeakGPU=0;this.flashTime=-1;this.flashMode=false;this.flashElapsed=-1;this.flashMemoryLimit=-1;this.unloadThreshold=0.95;this.emergencyUnloadThreshold=1.1;window.debugUnloadManager=this};b.prototype.setFlashMode=function(d){this.flashMode=d};b.prototype.onReferenceMemoryChange=function(e,d){this.memoryUsage+=e;this.memoryUsageGPU+=d;this.updateUsage()};b.prototype.beforeLoadedNodesQueueTraversal=function(){var e=this.memoryUsage>this.unloadThreshold*this.memoryLimit||this.memoryUsageGPU>this.unloadThreshold*this.memoryLimitGPU;var d=Date.now();if(e&&this.flashTime===-1){this.flashTime=d}var f;if(this.flashTime!==-1){if(this.flashElapsed>0){f=(d-this.flashTime)/this.flashElapsed}else{f=1}if(f>=1){f=1;this.flashTime=-1}this.flashMemoryLimit=0.75*(1-f)*this.memoryLimit}else{this.flashMemoryLimit=-1}};b.prototype.isLoadingAllowed=function(){return this.memoryUsage<this.memoryLimit&&this.memoryUsageGPU<this.memoryLimitGPU};b.prototype.isUnloadSmalNodesRequired=function(){return this.memoryUsage>0.9*this.memoryLimit||this.memoryUsageGPU>0.9*this.memoryLimitGPU};b.prototype.isEmergencyUnloadRequired=function(d){d=d||0;return this.memoryUsage+d>=this.emergencyUnloadThreshold*this.memoryLimit||(!this.oldVersion&&this.memoryUsageGPU+d>=this.emergencyUnloadThreshold*this.memoryLimitGPU)};b.prototype.isUnloadNeeded=function(d){if(d===undefined){return this.isUnloadNeeded(0)||this.isUnloadNeeded(1)}if(this.unloadAlwaysTab[d]){return true}if(this.flashMode){if(this.flashMemoryLimit>=0){return this.memoryUsage>this.flashMemoryLimit||this.memoryUsageGPU>this.flashMemoryLimit}}else{return this.memoryUsage>0.8*this.memoryLimit||this.memoryUsageGPU>0.8*this.memoryLimitGPU}return false};b.prototype.updateUsage=function(){this.usage=100*this.memoryUsage/this.memoryLimit;this.usageGPU=100*this.memoryUsageGPU/this.memoryLimitGPU;this.memoryPeak=this.memoryUsage>this.memoryPeak?this.memoryUsage:this.memoryPeak;this.memoryPeakGPU=this.memoryUsageGPU>this.memoryPeakGPU?this.memoryUsageGPU:this.memoryPeakGPU};b.prototype.setUnloadAlwaysTab=function(d){this.unloadAlwaysTab=d;this.hasUnloadAlways=d[0]||d[1]};b.prototype.wouldDownloadCauseEmergencyUnload=function(f,d){if(!this.isRestricted){return false}else{var e=d.getMemorizedReferenceSize(f);if(e>=0){return this.isEmergencyUnloadRequired(e)}else{return false}}};return b});define("DS/3DXMTiles/3DXMTilesUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory"],function(f,e){function j(l,k,m){this.center=l;this.radius=k;this.scale=m}function b(l,k,n,m){this.center=l;this.radius=k;this.scale=n;this.matrixPosition=new f.Vector3();this.matrixPosition.getPositionFromMatrix(m)}b.prototype.positionHasChanged=function(k){var l=k.elements;if(l[12]!==this.matrixPosition.x||l[13]!==this.matrixPosition.y||l[14]!==this.matrixPosition.z){return true}else{return false}};var c=new f.Matrix4();var i=new f.Vector3();var h=new f.Vector3();var g=new f.Matrix4();var a=new f.MeshPhongMaterial({color:"red",transparent:true,opacity:0.2,force:true});var d={computeScreenRadius:function(r,p,t,n){var u=r.center;var m=r.radius;var v=t.performFrustumCullingNoNearFar(m,u);if(!v){return -1}var s;if(p.isOrtho){s=m/n}else{var o=p.matrixWorldInverse.elements;var q=Math.abs(o[2]*u.x+o[6]*u.y+o[10]*u.z+o[14]);var l=n*q;s=m/l}return s},computeScreenRadiusCache:function(l,t,r,p,o){var n=l.getMaxScaleOnAxis();var q=r.radius*n;var s=new f.Vector3();s.copy(r.center);s.applyMatrix4(l);t&&s.applyMatrix4(t);if(p){var k=new f.Matrix4();k.setPosition(s);var m=e.createSphereNode({matrix:k,radius:q});m.setMaterial(a);debugWebGLV6Viewer.getRootNode().addChild(m)}if(!o){return new j(s,q,n)}else{return new b(s,q,n,l)}},computeScreenRadiusCacheWithTemporaryParent:function(r,q,o,n){if(q){g.copy(q)}else{g.copy(c)}var p=n;while(n){if(n._matrix){g.multiplyMatrices(n._matrix,g)}n=n.parents[0]}var m=r.matrix;g.multiplyMatrices(m,g);var l=o.radius*g.getMaxScaleOnAxis();var k=new f.Vector3();k.copy(o.center);k.applyMatrix4(g);return new j(k,l)},computeScreenRadiusCstComponent:function(l,m){if(l.isOrtho){return l.getCameraConstant(1,m.SCREEN_HEIGHT)}else{var k=0.5*m.SCREEN_HEIGHT;k/=Math.tan(0.5*l.fov*Math.PI/180);if(l.fullWidth){k*=(l.fullWidth/l.width)}k=1/k;return k}},computeDistanceToViewpoint:function(s,m,r,l){var k=s.matrix;if(!l){g.copy(k)}else{g.multiplyMatrices(k,l)}var n=r.radius*g.getMaxScaleOnAxis();var p=m.camera;i.copy(r.center);i.applyMatrix4(g);var o=p.matrixWorldInverse.elements;var q=Math.abs(o[2]*i.x+o[6]*i.y+o[10]*i.z+o[14]);q-=n;return -q},computeSubScreenRadius:function(q,u,s,w,o){var x=u.center;var l=s.position;if(l.distanceToSquared(x)<u.radius*u.radius){return this.infinity(q)}h.subVectors(s.position,x);h.normalize();var n=q*u.scale;var p=u.radius-n;i.x=x.x+p*h.x;i.y=x.y+p*h.y;i.z=x.z+p*h.z;var r=s.matrixWorldInverse.elements;var t=Math.abs(r[2]*i.x+r[6]*i.y+r[10]*i.z+r[14]);var m=o*t;var v=n/m;return v},computeScreenRadiusMajorate:function(l,v,s,p){var w=l.center;var m=s.position;if(m.distanceToSquared(w)<l.radius*l.radius){return this.infinity(v)}h.subVectors(s.position,l.center);h.normalize();var o=v;var q=l.radius-o;i.x=w.x+q*h.x;i.y=w.y+q*h.y;i.z=w.z+q*h.z;var r=s.matrixWorldInverse.elements;var t=Math.abs(r[2]*i.x+r[6]*i.y+r[10]*i.z+r[14]);var n=p*t;var u=o/n;return u},infinity:function(k){return 1000000000+k}};return d});define("DS/3DXMTiles/LDHReferenceStatus",[],function(){return{incomplete:"incomplete",complete:"complete",dead:"dead",locked:"locked",error:"error"}});define("DS/3DXMTiles/LDHHandler",[],function(a){var a=function(b){this.type=b};a.prototype.handleReferences=function(c,b){};a.prototype.getBatchSize=function(){return 1};a.prototype.setRestricted=function(){};a.Model3DHandler=0;a.InstRefHander=1;return a});define("DS/3DXMTiles/LODSelector",["DS/Visualization/ThreeJS_DS","UWA/Class"],function(b,a){var c=a.extend({init:function(){this.type=null;this.disableDowngrade=false},setDisableDowngrade:function(d){this.disableDowngrade=d?true:false},getMaxLOD:function(){return 1},createJSON:function(d){d=d||{};d.type=this.type;if(this.disableDowngrade){d.disableDowngrade=true}return d}});return c});define("DS/3DXMTiles/LDHInstRefHandler",["DS/3DXMTiles/LDHHandler"],function(b){var a=function(){b.call(this,b.InstRefHander)};a.prototype=Object.create(b.prototype);return a});define("DS/3DXMTiles/LDHOccurrence",["DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/3DXMTiles/Debug3DXMTiles","DS/3DXMTiles/LDHReferenceStatus","DS/Visualization/PathElement"],function(f,d,a,c,g,e){var h=new d.Matrix4();var b=function(p,n){var j=p.reference;this.reference=j||null;if(j._occurrences.length>0){j.manager.forceUpdateNode(j)}j._occurrences.push(this);this.node=p.node||null;this.matrix=p.matrix||h;this.parent=p.parent||null;this.instanceId=p.instanceId||null;this.counter=0;for(var l=0;l<j.children.length;++l){var q=j.children[l];var k=b.getOccurrenceMatrix(this.matrix,q.matrix);var m=new b({reference:q.reference,matrix:k,boundingSphere:q.reference.boundingSphere,node:(c.sceneGraphMode===0?this.node:null),manager:p.manager,parent:this,instanceId:q.instanceId},n)}if(c.sceneGraphMode===0){if(j._status>=g.loading){if(j.node){var o=new f();o.setMatrix(this.matrix);o.addChild(j.node);this.node.addChild(o)}}}else{this.reference.requestBuildSceneGraphHierarchy()}this.viewpointTag=-1;this.reference.updateMemorySize();if(this.reference._optional&&this.reference._optional.hasOverride()&&n){n.add(this.reference)}};b.getOccurrenceMatrix=function(i,j){if(j===null){return i}else{return new d.Matrix4().multiplyMatrices(i,j)}};b.prototype.getChildren=function(){var k=[],o,p,n=[];var m,l;for(m=0;m<this.reference.children.length;m++){o=this.reference.children[m].reference;if(n.indexOf(o)===-1){for(l=0;l<o._occurrences.length;l++){p=o._occurrences[l];if(p!==null&&p.parent===this){k.push(p)}}n.push(o)}}return k};b.prototype.getIdPath=function(){if(this.parent){var i=this.parent.getIdPath();i.push(this.instanceId);i.push(this.reference.referenceId);return i}else{return[this.reference.referenceId]}};b.prototype.removeFromSceneGraph=function(){if(!this.node){return}if(this.reference.node){this.reference.node.removeChild(this.node)}var k=this.getChildren();var j,l;for(j=0;j<k.length;j++){}};b.prototype.detach=function(){var k=this.getChildren();this.reference._removeOccurrenceFromList(this);var j;for(j=0;j<k.length;j++){k[j].detach()}};b.prototype.buildPathElement=function(){if(this.reference.node){var k=[];var l,m,n=this,j;while(n){k.unshift(n.reference.node);j=null;if(n.parent){j=n.parent.reference.getChildInstanceNode(n.instanceId);if(!j){return null}k.unshift(j)}n=n.parent}return new e(k)}return null};return b});define("DS/3DXMTiles/BSScreenSizeLODSelector",["DS/3DXMTiles/LODSelector","DS/Visualization/ThreeJS_DS"],function(d,c){var e=new c.Vector3();var b=new c.Matrix4();var a=d.extend({init:function(f){this._parent();this.type="BSScreenSize";this.screenSize=f},computeLOD:function(f,g){f.computeScreenRadius(g);if(f._screenRadius>=this.screenSize){return 1}else{return 0}},getLOD:function(f){if(f>=this.screenSize){return 1}else{return 0}},createJSON:function(f){f=f||{};f.screenSize=this.screenSize;return this._parent(f)}});a.createFromJSON=function(f){var g=f.screenSize;return new a(parseFloat(g))};return a});define("DS/3DXMTiles/LDHReference",["DS/3DXMTiles/BSScreenSizeLODSelector","DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/Mesh3D","DS/3DXMTiles/LDHOccurrence","DS/Visualization/ThreeJS_R57","DS/Visualization/Node3D","DS/3DXMTiles/Debug3DXMTiles","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/LDHHandler","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/3DXMTiles/LDHReferenceUnloadStatus"],function(h,D,c,o,A,n,s,B,i,k,r,y,z){var p=1;var d={inList:1,inToBeLoaded:2,inLoaded:4,inForced:8,inUnknown:16,inHighPriority:24};var f={regular:0,hasWrapChild:1,wrap:2};var t={requested:"requested",none:"none",slave:"slave"};var m=new h(10);var q=function(E,F,G){this.reference=E;this.node=null;this.matrix=F;this.instanceId=G;this.userData=null};var g=-1;var l=function(E){if(g===-1){g=window.OOCForceBoundingSphere?1:0}this.id=p++;this._occurrences=[];this.url=E.urlOrId;this._boundingSphere=E.boundingSphere;this._boundingBox=E.boundingBox;this.updateBoundingSphere();this.handler=E.handler;this.manager=E.manager;this._lodSelector=m;this._screenRadiusCache=[];this._screenRadius=0;this._loadingPriority=0;this.node=E.leaf?E.node:null;this.children=[];this._status=B.incomplete;this._unloadStatus=z.unloaded;this._optional=null;this.parents=[];this.memorySize=0;this.memorySizeGPU=-1;this.referenceId=E.referenceId;this.userData=null;this.unloadLockCounter=0;this.loading=false;this.toUnload=false;this.wrapStatus=f.regular;this.inListStatus=0;this.isRoot=false;this.biggestUnloadedChildRadius=-2;this.expectedNbChildren=-1;this.unloadViewpointTag=-1;this.sgFlag=E.leaf?t.slave:t.none};l.prototype.setNode=function(F){if(s.sceneGraphMode===1){this.node=F}if(s.sceneGraphMode===0){var E;for(E=0;E<this._occurrences.length;E++){this._occurrences[E].node=F}}};l.prototype.setIsRoot=function(E){if(E!==this.isRoot){this.isRoot=E;if(E){if(this.node){this.manager.targetNode.addChild(this.node)}}else{if(this.node){this.manager.targetNode.removeChild(this.node)}}}};l.prototype.getOccurrences=function(){if(this.isSlave()){return this.node?this.node._occurrences:null}else{return this._occurrences}};l.prototype.isLocked=function(){return this._status===B.locked};l.prototype.isLoaded=function(){return this._status===B.complete};l.prototype.forceLoad=function(E,F){var G=this.isForced();if(!this._optional){this._optional=new b()}if(E){if(!this._optional._force){this._optional._force=new w()}if(this.isLoaded()){setTimeout(F,0);this._optional._force=new w()}else{this._optional._force.onForce(F)}}else{this._optional._force=null}var H=this.isForced();if(G!==H){if(H){this.lockUnload(undefined,undefined,true)}else{this.unlockUnload(undefined,undefined,undefined,true)}this.manager.registerTilesNode(this)}};l.prototype.setOverrideCB=function(F,E){if(E&&!this._optional){this._optional=new b()}if(this._optional){this._optional.setOverride(F,E);this.updateOverride()}};l.prototype.hasOverrideCB=function(E){if(this._optional){return this._optional.hasOverride(E)}return false};l.prototype.removeParent=function(F){var E,H=0;for(E=0;E<this.parents.length;E++){if(this.parents[E]!==F){this.parents[H]=this.parents[E];H++}else{}}this.parents.length=H;var G;H=0;for(E=0;E<this._occurrences.length;E++){G=this._occurrences[E];if(G.parent&&G.parent.reference!==F){this._occurrences[H]=G;H++}else{G.parent=null}}this._occurrences.length=H;if(this.unloadLockCounter>0){this.unlockUnload(this.unloadLockCounter,F)}};l.prototype.setStatus=function(F){if(this._status===B.dead){return}var E=this._status!==F;this._status=F;if(E){this.manager.registerTilesNode(this)}};l.prototype.setUnloadStatus=function(H){var E=this._unloadStatus!==H;this._unloadStatus=H;if(E){this.manager.registerTilesNode(this)}var F,G;for(F=0;F<this.parents.length;F++){G=this.parents[F];if(!G.isFrozen()){G.setUnloadStatus(z.frozen)}}};l.prototype.updateUnloadStatus=function(){var F,E,H=false;for(F=0;F<this.children.length&&!H;F++){E=this.children[F].reference;if(!E.isUnloaded()||E.isLocked()||E.loading){H=true}}if(H||this.loading){this.setUnloadStatus(z.frozen)}else{this.setUnloadStatus(z.unloadable);var G;for(F=0;F<this.parents.length;F++){G=this.parents[F]}}};l.prototype.lockChildren=function(){if(this.isAlive()&&!this.isError()){this.setStatus(B.locked);var E;for(E=0;E<this.parents.length;E++){this.parents[E].updateUnloadStatus()}}};l.prototype.unlockChildren=function(){if(this.isLocked()){this.updateStatusFromChildren(true);var E;for(E=0;E<this.parents.length;E++){this.parents[E].updateUnloadStatus()}}};l.prototype.buildFlatList=function(){var G=[];this.traverse(function F(H){if(H.id>0){H.id*=-1;G.push(H);return false}else{return true}});var E=0;for(E=0;E<G.length;E++){G[E].id*=-1}return G};l.prototype.addReferenceChild=function(E,F,J,I){var G,L,H,K;for(G=0;G<this._occurrences.length;G++){L=this._occurrences[G];H=o.getOccurrenceMatrix(L.matrix,F);K=new o({reference:E,matrix:H,node:(s.sceneGraphMode===0?L.node:null),parent:L,instanceId:J},I)}this.children.push(new q(E,F,J));if(E.unloadLockCounter>0){E.lockUnload(E.unloadLockCounter)}if(E.parents.indexOf(this)===-1){E.parents.push(this)}if(E.node!==null){this.requestBuildSceneGraphHierarchy(true)}this.updateMemorySize()};l.prototype.addOnLoadedCB=function(E){if(!this._optional){this._optional=new b()}this._optional.addOnLoadedCB(E)};l.prototype._onLoaded=function(){if(this._optional&&this._optional._force){this._optional._force.onLoaded()}if(this._optional){this._optional.onLoaded()}};l.prototype.computeLODValue=function(H){var F=H.viewpoint;var E=H.cst;var G=this._lodSelector.computeLOD(this,H);if(this._boundingSphere===null){G=1}return G};l.prototype.getLODValue=function(){return this._lodSelector.getLOD(this._screenRadius)};l.prototype.computeScreenRadius=function(J){var K=J.cst;var M=J.viewpoint;var T=this.isSlave();if(this._topLoadPriority){this._screenRadius=Infinity;return this._screenRadius}else{if(this._boundingSphere){var N=-Infinity,V,U,R=-Infinity,F,P;var S=this,X,F;var H=0;var L=this._screenRadiusCache,O;if(!T){X=this._occurrences}else{X=this.node._occurrences;if(L){var I=false;if(L.length!==X.length){I=true}for(V=0;!I&&V<X.length;V++){O=L[V];if(O.positionHasChanged(X[V].matrix)){I=true}}}if(I){L=[];this._screenRadiusCache=L}}for(V=0;V<X.length;V++){var E=X[V];if(H>=L.length){O=D.computeScreenRadiusCache(E.matrix,null,this._boundingSphere,undefined,T);L.push(O)}else{O=L[H]}H++;F=D.computeScreenRadius(O,M.camera,M._frustum,K);if(N<F){N=F}var W=M.camera,G=O.center,Q=O.radius;var Y=W.position.distanceTo(G)-Q;if(Y<0){Y=0}P=F*Math.pow(0.9,Y/100);if(R<P){R=P}}this._screenRadius=N;this._loadingPriority=P;return N}}this._screenRadius=1;return 1};l.prototype.updateNodeLOD=function(F){var E;if(this.isForced()){E=1;this._screenRadius=Infinity}else{E=this.computeLODValue(F)}return E};l.prototype.dumpAnyPath=function(){console.log(this.url);this.father[0]&&this.father[0].dumpAnyPath()};function C(F,I){var G=0;if(!F.noMeshInRAM||I){var H=[F.vertexIndexArray,F.vertexNormalArray,F.vertexPositionArray],E;for(E=0;E<H.length;E++){if(H[E]){G+=H[E].byteLength}}}return G}function a(F){var G=0;var H=[F.vertexIndexArray,F.vertexPositionArray,F.vertexNormalArray,F.vertexUvArray,F.vertexUv2Array,F.vertexTangentArray,F.vertexBinormalArray,F.vertexColorArray,F.vertexPreviousPositionArray,F.vertexNextPositionArray,F.vertexSideExtrusionArray,F.vertexLineDistancesArray,F.vertexSkinIndexArray,F.vertexSkinWeightArray],E;for(E=0;E<H.length;E++){if(H[E]){G+=H[E].byteLength}}return G}l.prototype.getMemorySizeGPU=function(){return this.memorySizeGPU>=0?this.memorySizeGPU:0};l.prototype.computeMemorySizeGPU=function(){var E=-1;if(this.node){if(this.node.children.length>0){if(this.memorySizeGPU===-1){if(this.handler.type===i.Model3DHandler){this.node.traverse(function(G){var F;if(G instanceof c){var H=G.mesh3js.geometry;for(F=0;F<H.length;F++){E+=a(H[F])}}})}}else{E=this.memorySizeGPU}}else{E=0}}return E};l.prototype.computeMemorySize=function(E){var F=0;if(this.node){if(this.handler.type===i.Model3DHandler){this.node.traverse(function(H){var G;if(H instanceof c){var I=H.mesh3js.geometry;for(G=0;G<I.length;G++){F+=C(I[G],E)}}})}F+=824+(this.node._occurrences.length-1)*280}F+=232+this._occurrences.length*(128+208);F+=this.children.length*(128+208);return F};l.prototype.getMemorySize=function(){this.memorySize=this.getMemorySize();return this.memorySize};l.prototype.updateMemorySize=function(){var E=this.manager.unloadManager.oldVersion;var J=E?0:this.computeMemorySizeGPU();var I=this.computeMemorySize(E);var H=J<I?I:J;if(this.handler.type===0){var G=this.getLDHNodeManagerQueue();G.memorizeReferenceSize(this.referenceId,H)}var F=false;if(I!==this.memorySize){F=true}if(J!==this.memorySizeGPU){F=true}if(F){this.manager.unloadManager.onReferenceMemoryChange(I-this.memorySize,J-this.memorySizeGPU);this.memorySize=I;if(E){this.memorySizeGPU=J}else{this.memorySizeGPU=J>0?J:-1}}};l.prototype.requestBuildSceneGraphHierarchy=function(G){if(this.sgFlag===t.none){var E,H=G||false,I;for(E=0;E<this.children.length&&!H;E++){I=this.children[E];if(I.reference.sgFlag!==t.none){H=true}}if(H){this.setSGFlag(t.requested);var F;for(E=0;E<this.parents.length;E++){F=this.parents[E];F.requestBuildSceneGraphHierarchy(true)}}}};l.prototype.setSGFlag=function(E){this.sgFlag=E};l.prototype.tryBuildSceneGraphHierarchy=function(H){var G,I,E;if(this.sgFlag===t.requested){var F=this.node?true:false;if(!this.node){this.node=new n();if(this.userData){this.node.setUserData(this.userData)}this.node.setModelIdentification(this.referenceId);this.node.setNodeUsage(this.handler.type===i.Model3DHandler?n.REPRESENTATION_NODE:n.REFERENCE_NODE);if(this._boundingSphere&&g){this.node.forceBoundingElements(true,{sphere:this._boundingSphere},null)}if(this.isRoot){this.manager.targetNode.addChild(this.node)}if(this._optional&&this._optional.hasOverride()){H.push(this)}}for(G=0;G<this.children.length;G++){I=this.children[G];E=I.reference;E.tryBuildSceneGraphHierarchy(H);if(!I.node&&E.node){I.node=new n();if(I.userData){I.node.setUserData(I.userData)}I.node.setModelIdentification(I.instanceId);I.node.setNodeUsage(n.INSTANCE_NODE);I.node.setMatrix(I.matrix);I.node.addChild(E.node);this.node.addChild(I.node)}}this.setSGFlag(t.none);if(this.node&&!F&&this._optional&&this._optional.onAddedToSceneGraphCB){this._optional.onAddedToSceneGraphCB.call(undefined,this.referenceId)}this.updateMemorySize()}};l.prototype.updateOverride=function(){var E=this._optional;if(E&&E.overrideData){E.overrideData.updateOverride(this.manager,this.node,this.referenceId);if(E.overrideData.isEmpty()){E.overrideData=null}}};l.prototype.removeFromSceneGraph=function(H){if(this.isSlave()){this.manager.unloadLeafReferenceCB(this.referenceId)}else{if(this.parents.length===0){return}if(this.node!==null&&(!this.isUnloadLocked()||H)){var F,E=this.node.parents.concat([]),I,G;for(F=0;F<E.length;F++){I=E[F];G=I.parents[0];I.removeChild(this.node);G.removeChild(I)}for(F=0;F<this.parents.length;F++){this.parents[F].removeChildNode(this);if(this.parents[F].node&&this.parents[F].node.children.length===0){this.parents[F].removeFromSceneGraph()}}this.node=null;if(this._optional&&this._optional.onRemovedFromSceneGraphCB){this._optional.onRemovedFromSceneGraphCB.call(undefined,this.referenceId)}}}this.updateMemorySize();this.updateOverride()};l.prototype.removeChildNode=function(E){var F,G;for(F=0;F<this.children.length;F++){G=this.children[F];if(G.reference===E){G.node=null}}this.updateMemorySize()};l.prototype.getChildInstanceNode=function(F){var E,G;for(E=0;E<this.children.length;E++){G=this.children[E];if(G.instanceId===F){return G.node}}return null};l.prototype.traverse=function(G){var F=G(this);if(!F){var E;for(E=0;E<this.children.length;E++){this.children[E].reference.traverse(G)}}};l.prototype.traverseParents=function(G,E){if(!E.has(this)){var F=new Set();F.add(this);this.traverseParents_internal(G,E,F)}};l.prototype.traverseParents_internal=function(I,E,H){I(this);var F,G;for(F=0;F<this.parents.length;F++){G=this.parents[F];if(!H.has(G)&&(!E||!E.has(G))){H.add(G);G.traverseParents_internal(I,E,H)}}};l.prototype.createJSON=function(){var H={references:[]};this.traverse(function(K){K.visited=false});var F=0;this.traverse(function(K){if(!K.visited){K.visited=true;K.jsonIndex=F++;var L=K.createJSON_internal();H.references.push(L)}});var G,E,I,J;for(G=0;G<H.references.length;G++){I=H.references[G];for(E=0;E<I.c.length;E++){J=I.c[E];J.r=J.r.jsonIndex}}return H};l.prototype.createJSON_internal=function(){var G={url:this.url,bs:this._boundingSphere?this._boundingSphere.createJSON():null,i:this.node?true:false,c:[]};var F,H,E;for(F=0;F<this.children.length;F++){H=this.children[F];E={};E.m=H.matrix.createJSON();E.r=H.reference;E.i=H.node?true:false;G.c.push(E)}return G};l.prototype._removeOccurrenceFromList=function(F){var E=this._occurrences.indexOf(F);if(E<0){console.log("Internal inconsistency")}else{this._occurrences[E]=null}};l.prototype._removeNullsFromOccurrenceList=function(){var E,F=0;for(E=0;E<this._occurrences.length;E++){var G=this._occurrences[E];if(G){this._occurrences[F]=G;F++}}this._occurrences.length=F};l.prototype._isDetachPossible=function(){return this._occurrences.length===0};l.prototype._detach=function(){if(this.node){var F=this.node.parents;var G;for(G=0;G<F.length;G++){var E=F[G];E.removeChild(this.node)}this.node.removeChildren();this.node=null}this.children=[];this.parents=[];this.setStatus(B.removeRequested)};l.prototype.isUnknown=function(){return this._boundingSphere?false:!this.isLoaded()};l.prototype.isForced=function(){return(this._optional&&this._optional._force)?true:false};l.prototype.setOnRemovedFromSceneGraphCB=function(E){if(!this._optional){this._optional=new b()}this._optional.onRemovedFromSceneGraphCB=E;if(!this.node&&E){E.call(undefined,this.referenceId)}};l.prototype.setOnAddedToSceneGraphCB=function(E){if(!this._optional){this._optional=new b()}this._optional.onAddedToSceneGraphCB=E;if(this.node&&E){E.call(undefined,this.referenceId)}};l.prototype.isInList=function(){return(this.inListStatus&d.inList)?true:false};l.prototype.setInList=function(E){if(E){this.inListStatus=this.inListStatus|d.inList}else{this.inListStatus=this.inListStatus&30}};l.prototype.isInToBeLoaded=function(){return(this.inListStatus&d.inToBeLoaded)?true:false};l.prototype.setInToBeLoaded=function(E){if(E){this.inListStatus=this.inListStatus|d.inToBeLoaded}else{this.inListStatus=this.inListStatus&29}};l.prototype.isInLoaded=function(){return(this.inListStatus&d.inLoaded)?true:false};l.prototype.setInLoaded=function(E){if(E){this.inListStatus=this.inListStatus|d.inLoaded}else{this.inListStatus=this.inListStatus&27}};l.prototype.isInForced=function(){return(this.inListStatus&d.inForced)?true:false};l.prototype.setInForced=function(E){if(E){this.inListStatus=this.inListStatus|d.inForced}else{this.inListStatus=this.inListStatus&23}};l.prototype.isInUnknown=function(){return(this.inListStatus&d.inUnknown)?true:false};l.prototype.isInHighPriority=function(){return(this.inListStatus&d.inHighPriority)?true:false};l.prototype.setInUnknown=function(E){if(E){this.inListStatus=this.inListStatus|d.inUnknown}else{this.inListStatus=this.inListStatus&15}};l.setScreenSize=function(E){m.screenSize=E};l.getScreenSize=function(){return m.screenSize};l.prototype.isAlive=function(){return this._status!==B.dead};l.prototype.isError=function(){return this._status===B.error};l.prototype.lockUnload=function(I,H,F){I=I||1;this.unloadLockCounter+=I;if(!H||F){var E,G;for(E=0;E<this._occurrences.length;E++){G=this._occurrences[E].parent;if(G){G.reference.lockUnload(I,true,F)}}}};l.prototype.unlockUnload=function(J,G,I,F){J=J||1;this.unloadLockCounter-=J;if(!I||F){var E,H;for(E=0;E<this._occurrences.length;E++){H=this._occurrences[E].parent;if(H&&(!G||G.reference===G)){H.reference.unlockUnload(J,undefined,true,F)}}}};l.prototype.isUnloadLocked=function(){return this.isForced()||this.unloadLockCounter>0};l.prototype.hasGrandChildren=function(){var E=0;for(E=0;E<this.children.length;E++){if(this.children[E].reference.children.length>0){return true}}return false};l.prototype.updateParentsStatus=function(){var E,F;for(E=0;E<this.parents.length;E++){F=this.parents[E];F.updateStatusFromChildren();F.updateUnloadStatus()}};l.prototype.updateStatusFromChildren=function(E){if(E||!this.isLocked()){if(this.children.length===0||this.children.length<this.expectedNbChildren){this.setStatus(B.incomplete)}else{this.setStatus(B.complete)}}};l.prototype.checkConsistency=function(H){var I=this;var G,L,E,K;function M(){for(G=0;G<I.parents.length;G++){L=I.parents[G];if(!L.isFrozen()){throw new Error("inconsistency")}}}function J(N){for(G=0;G<I.children.length;G++){E=I.children[G];if(E.reference._status!==N){throw new Error("inconsistency")}}}if(this.isFrozen()){M();K=false;for(G=0;G<this.children.length;G++){E=this.children[G];if(E.reference.children.length>0){K=true}}if(!K){throw new Error("inconsistency")}}if(this._unloadStatus===z.unloadable){for(G=0;G<this.children.length;G++){E=this.children[G];if(E.reference.children.length>0){throw new Error("inconsistency")}}}if(this.children.length>0){M()}if(H){var F;for(F=0;F<this.parents.length;F++){this.parents[F].checkConsistency(false)}for(F=0;F<this.children.length;F++){this.children[F].reference.checkConsistency(false)}}};l.prototype.getChild=function(F){var E;for(E=0;E<this.children.length;E++){if(this.children[E].instanceId===F){return this.children[E]}}return null};l.prototype.isSlave=function(){return this.sgFlag===t.slave};function e(E,J){if(!E.isEmpty()){var K=E.get();var G,F;for(G=0;G<K.length;G++){var H=K[G].pathElement;var I=H&&H.externalPath;if(H){for(F=I.length-1;F>=0;F--){if(I[F]===J){return true}}}}}return false}l.prototype.isUnloadable=function(F){if(this._unloadStatus!==z.unloadable){return false}if(F){var E=this.node;if(E&&(e(k,E)||e(r,E)||e(y,E))){return false}}return true};l.prototype.isUnloaded=function(){return this._unloadStatus===z.unloaded};l.prototype.shouldBeExpanded=function(){return this._status!==B.complete||(this.handler.type===1&&this.wrapStatus===f.hasWrapChild)};l.prototype.isComplete=function(){return this._status===B.complete};l.prototype.isIncomplete=function(){return this._status===B.complete};l.prototype.isFrozen=function(){return this._unloadStatus===z.frozen};l.prototype.setExpectedNbChildren=function(F){var E=false;if(F!==this.expectedNbChildren&&this.expectedNbChildren!==-1){E=true}this.expectedNbChildren=F;if(E){this.clearViewpointTags();this.manager.forceUpdateNode(this);this.updateStatusFromChildren()}};l.prototype.clearViewpointTags=function(){var E;for(E=0;E<this._occurrences.length;E++){this._occurrences[E].viewpointTag=-1}};l.prototype.getLDHNodeManagerQueue=function(){return this.manager.queues[this.handler.type]};l.prototype.updateBoundingSphereFromNode=function(){if(this.node){var E=this.node.getBoundingSphere();if(E){this._boundingSphere=E.clone()}}};l.prototype.hasDifferentViewpointTag=function(F){if(this._occurrences.length>0){var E,G;for(E=0;E<this._occurrences.length;E++){G=this._occurrences[E];if(G.viewpointTag!==F){return true}}return false}else{return true}};l.prototype.buildDebugJSON=function(I){var E=this,F;var J={screenRadius:E._screenRadius,status:E._status,unloadStatus:E._unloadStatus,handlerType:this.handler.type,parents:[]};if(!I){J.referenceId=E.referenceId}var H;for(H=0;H<this.parents.length;H++){J.parents.push(this.parents[H].referenceId)}if(E.expectedNbChildren!==0||E.children.length>0){J.expectedNbChildren=E.expectedNbChildren;J.nbChildren=E.children.length;if(E.children.length>0){var G=[],K;for(F=0;F<E.children.length;F++){K=E.children[F];G.push({ref:K.reference.referenceId,inst:K.instanceId})}J.children=G}}if(E.toUnload){J.toUnload=true}if(E.loading){J.loading=true}if(E.unloadLockCounter>0){J.unloadLockCounter=E.unloadLockCounter}if(E.node){J.inSceneGraph=true}return J};l.prototype.setLoadModelOptions=function(E){if(!this._optional){this._optional=new b()}this._optional.setLoadModelOptions(E)};l.prototype.getLoadModelOptions=function(){if(this._optional){return this._optional.loadModelOptions}return null};l.prototype.userLockUnload=function(){if(!this._optional){this._optional=new b()}this.lockUnload();this._optional.addUserLockUnload()};l.prototype.userUnlockUnload=function(){if(this._optional&&this._optional.userLockUnload>0){this.unlockUnload();this._optional.removeUserLockUnload()}};l.prototype.needScreenRadiusSizeComputation=function(){if((this._status===B.incomplete||this._status===B.complete)&&!this.loading){return true}else{return false}};l.prototype.setUnloadViewpointTag=function(E){this.unloadViewpointTag=E};l.prototype.getUnloadViewpointTag=function(){return this.unloadViewpointTag};l.prototype.updateBoundingSphere=function(){if(!this._boundingSphere&&this._boundingBox){this._boundinSphere=this._boundingBox.getBoundingSphere()}};l.prototype.getBoundingBox=function(){if(!this._boundingBox){var E=this._boundingSphere;if(!E){return null}var F=new A.Box3();F.min.x=E.center.x-E.radius;F.min.y=E.center.y-E.radius;F.min.z=E.center.z-E.radius;F.max.x=E.center.x+E.radius;F.max.y=E.center.y+E.radius;F.max.z=E.center.z+E.radius;this._boundingBox=F}return this._boundingBox};var x=new A.Sphere();l.prototype.getBoundingSphere=function(E){if(this._boundingSphere){return this._boundingSphere}else{if(this._boundingBox){this._boundingBox.getBoundingSphere(x);return x}}if(E){return new A.Sphere()}else{return null}};l.prototype.setWrapStatus=function(E){this.wrapStatus=E};l.prototype.updateWrapStatusFromChildren=function(I){if(!this.comesFromWrap()){var F;var E=this.children,H,G=false;for(F=0;F<E.length&&(!I||!G);F++){H=E[F].reference;if(H.comesFromWrap()){G=true;if(!I){H.setParentDoesNotComeFromWrap()}}}if(G){this.setWrapStatus(f.hasWrapChild)}}};l.prototype.setParentDoesNotComeFromWrap=function(){if(this.comesFromWrap()){this.setComesFromWrap(false);this.updateWrapStatusFromChildren(true)}};l.prototype.setComesFromWrap=function(E){this.setWrapStatus(E?f.wrap:f.regular)};l.prototype.comesFromWrap=function(){return this.wrapStatus===f.wrap};var j=-1;l.prototype.getScore=function(){if(j===-1){j=window.OOCNewPriorityPrototype?1:0}return j===1?this._loadingPriority:this._screenRadius};l.lodSelector=m;var b=function(){this._force=null;this.onAddedToSceneGraphCB=null;this.onRemovedFromSceneGraphCB=null;this.onLoadedCallbacks=null;this.loadModelOptions=null;this.userLockUnload=0;this.overrideData=null};b.prototype.setOverride=function(F,E){if(!this.overrideData){this.overrideData=new u()}this.overrideData.setOverride(F,E);if(this.overrideData.isEmpty()){this.overrideData=null}};b.prototype.hasOverride=function(E){if(E===undefined){return this.overrideData!==null}else{return this.overrideData&&this.overrideData.hasOverride(E)}};b.prototype.addUserLockUnload=function(){this.userLockUnload++};b.prototype.removeUserLockUnload=function(){this.userLockUnload--};b.prototype.addOnLoadedCB=function(E){if(!this.onLoadedCallbacks){this.onLoadedCallbacks=[]}this.onLoadedCallbacks.push(E)};b.prototype.onLoaded=function(){if(this.onLoadedCallbacks){var E;for(E=0;E<this.onLoadedCallbacks.length;E++){this.onLoadedCallbacks[E]()}this.onLoadedCallbacks=null}};b.prototype.setLoadModelOptions=function(E){this.loadModelOptions=E};var w=function(){this.callbacks=[]};w.prototype.onForce=function(E){if(E){this.callbacks.push(E)}};w.prototype.onLoaded=function(){var E;for(E=0;E<this.callbacks.length;E++){this.callbacks[E]()}this.callbacks.length=0};w.prototype.clear=function(){this.callbacks.length=0};var v=function(){this.override=null;this.overrideCB=null};var u=function(){this.count=0;this.overrideMap={}};u.prototype.setOverride=function(G,E){var F=this.overrideMap[G];if(F){F.overrideCB=E}else{if(E){F=new v();F.overrideCB=E;this.overrideMap[G]=F;this.count++}}};u.prototype.hasOverride=function(F){var E=this.overrideMap[F];return(E&&E.overrideCB)?true:false};u.prototype.isEmpty=function(){return this.count===0};u.prototype.updateOverride=function(I,G,F){var L,M,E,N,J,H=null;for(L in this.overrideMap){M=I.getOverrideSet(L);J=this.overrideMap[L];E=J.override;N=J.overrideCB;if(G&&N){if(!E){E=M._createNodeOverride(G);J.override=E}else{E._forceOverrideUpdate()}N(F,E)}else{if(E){M.deleteOverride(E);J.override=null;if(!N){H=H||[];H.push(L)}}}}var K;for(K=0;H&&K<H.length;K++){delete (this.overrideMap[H[K]]);this.count--}};return l});define("DS/3DXMTiles/ModelLoaderPool",["DS/Visualization/ModelLoader","DS/Visualization/LoaderUtils","DS/Visualization/Node3D","DS/3DXMTiles/Debug3DXMTiles"],function(d,b,f,e){var c={nbLoadedModels:0,startTime:0,onLoadedCB:null,steps:[{value:250,name:"250",delta:-1},{value:500,name:"500",delta:-1},{value:1000,name:"1k",delta:-1},{value:2000,name:"2k",delta:-1},{value:5000,name:"5k",delta:-1},{value:10000,name:"10k",delta:-1},{value:Infinity,name:"impossible",delta:-1}],nextStep:0,init:function(){if(this.startTime===0){this.startTime=Date.now()}},onLoadedModel:function(){this.nbLoadedModels++;if(this.onLoadedCB){this.onLoadedCB(this.nbLoadedModels)}if(this.nbLoadedModels>this.steps[this.nextStep].value){this.steps[this.nextStep].delta=Date.now()-this.startTime;this.nextStep++}},setOnLoadedCallback:function(g){this.onLoadedCB=g},clearOnLoadedCallback:function(){this.onLoadedCB=null},};window.modelLoaderPoolStats=c;var a={modelLoader:new d(),nbTickets:20,_index:1,beforeLoadParams:function(i){var g=i.urlArray.concat([]);var h=g.length;a.nbTickets-=h},loadParams:function(v,w,t,g,h,u){var q=0,l=v.urlArray.concat([]),j,x=v.targetArray.concat([]);var m=l.length;var p=[];var s=false;var k=this._index++;function i(){if(s){t&&t()}else{w&&w(v,p)}x=[];v=[];w=null;t=null}function o(y){m--;y=y||[];p=p.concat(y);if(m===0){i()}else{r()}}function n(){m--;s=true;if(m===0){i()}else{r()}}function r(){var y,z;while(l.length>0){y=l.pop();z=x.pop();if(y){a._loadModel(y,z,o,n,g,h,u)}else{setTimeout(n,0)}}}r()},debug:false,setDebug:function(g){this.debug=g},_loadModel:function(l,y,x,r,h,i,v){function s(){if(g){c.onLoadedModel()}a.nbTickets++;y=null;u.setTargetNode(null);r()}if(this.debug){l=this.removeTag(l)}var g=false;b.__storeCGRNames=0;var u=this.modelLoader;u.setKeepLoaderMode(true);var m=y.manager;if(!l.endsWith(".instref")){g=true;if(e.sceneGraphMode===0){y.node=new f();for(var t=0;t<y._occurrences.length;++t){var k=y._occurrences[t];var p=new f();p.setMatrix(k.matrix);p.addChild(y.node);k.node.addChild(p)}}else{y.requestBuildSceneGraphHierarchy(true);m.tryBuildSceneGraphHierarchy()}if(!y.node){setTimeout(s,1);return}u.setSceneGraph(y.node)}else{u.setSceneGraph(y)}if(h){u.activateSmartLoading(h.getRenderer());u.setRenderCallback(h.render,1000)}u.setFileType(i||"xmlv43");var o=l.endsWith(".cgr")||i==="cgr"?u.setOnLoadedProductStructureCallback:u.setOnLoadedCallback;o.call(u,function(j){if(g){c.onLoadedModel()}a.nbTickets++;if(y.isSlave()&&m.onLeafReferenceLoadedCB){m.onLeafReferenceLoadedCB(y.referenceId,j)}u.setTargetNode(null);y=null;x(j)});u.setOnErrorCallback(s);if(g){c.init()}var w={filename:l,format:i||undefined,loaderSettings:{gasSharing:true}};if(v){var z;for(z in v){w[z]=v[z]}}var q=y.getLoadModelOptions();var n=false;if(q){var z;for(z in q){if(z==="noMeshInRAM"){n=q[z]?true:false}else{w[z]=q[z]}}}u.setNoMeshInRAM(n);u.loadModel(w)},removeTag:function(g){var j=g.indexOf("#");if(j>=0){var h=g.lastIndexOf(".");var i=g.substring(0,j)+g.substring(h);return i}return g}};a.modelLoader.sharedBuffers=false;return a});define("DS/3DXMTiles/LODData",["DS/3DXMTiles/ModelLoaderPoolParams"],function(a){var b=function(c,d){this.nodes=c.concat([]);this.lod=d};b.prototype.buildParams=function(e,c){var d,f=new a(this.lod);for(d=0;d<this.nodes.length;d++){this.nodes[d].traverse(function(g){if(g.hasOwnProperty("url")&&!g._loaded){f.addFromNode(g,e);g.setTemporaryParents(c)}})}return f};b.empty=new b([]);return b});define("DS/3DXMTiles/LDHReferenceBank",["DS/3DXMTiles/LDHReference"],function(b){var a=function(d){this.reference=d;this.useCount=0};var c=function(){this.tos={}};c.prototype.getLDHReference=function(e,h,f,g){var d,i=this.tos[e];if(i){d=i.reference;i.useCount++}else{d=new b({urlOrId:e,boundingSphere:h,manager:f,referenceId:e,handler:g});i=new a(d);i.useCount++;this.tos[e]=i}return d};return c});define("DS/3DXMTiles/LDHReferenceBankSingleton",["DS/3DXMTiles/LDHReferenceBank"],function(a){return new a()});define("DS/3DXMTiles/OOCManagerEntry",["DS/3DXMTiles/LDHReference"],function(a){var b=function(d,c){this.id=d;this.reference=new a({handler:c.handler,manager:c.manager._ldhNodeManager,boundingSphere:c.boundingSphere&&c.boundingSphere.clone(),boundingBox:c.boundingBox&&c.boundingBox.clone(),urlOrId:c.url,referenceId:d,leaf:c.leaf?true:false,node:c.node||null});if(c.loadModelOptions){this.reference.setLoadModelOptions(c.loadModelOptions)}};return b});define("DS/3DXMTiles/OOCReferenceIterator",["DS/3DXMTiles/OOCInstanceIterator"],function(a){var b=function(c){this._reference=c};b.prototype.getReferenceId=function(){return this._reference.referenceId};b.prototype.getParents=function(){var c=[];var d;for(d=0;d<this._reference.parents.length;d++){c.push(new b(this._reference.parents[d]))}return c};b.prototype.getChildren=function(){var c=[],e;var d;for(d=0;d<this._reference.children.length;d++){e=this._reference.children[d];c.push(new a(new b(e.reference),e))}return c};b.prototype.getNode=function(){return this._reference.node};b.prototype.equals=function(c){if(!c){return false}return this._reference===c._reference};return b});define("DS/3DXMTiles/LDHCandidateListRenderer",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/Visualization/PathElement","DS/Mesh/MeshUtils","DS/3DXMTiles/LDHOccurrence","DS/3DXMTiles/PriorityQueue"],function(s,d,i,o,q,p,e,l,u){var r=function(v){this.references=[];this.node=null;this.root=v;this.occurrences=[];this.preserveReferences=null;this.material=null;this.previousDimension=-1;this.lastClusters=null;this.priorityQueue=null};r.prototype.createMesh=function(w){if(w.dimension===2){return d.createCuboidNode({cornerPoint:new s.Vector3(0,0,0),firstAxis:new s.Vector3(1,0,0),secondAxis:new s.Vector3(0,1,0),thirdAxis:new s.Vector3(0,0,1)})}if(w.dimension===1){var y=[new s.Vector3(0,0,0),new s.Vector3(1,0,0),new s.Vector3(0,0,0),new s.Vector3(0,1,0),new s.Vector3(0,0,0),new s.Vector3(0,0,1),new s.Vector3(1,0,0),new s.Vector3(1,1,0),new s.Vector3(1,0,0),new s.Vector3(1,0,1),new s.Vector3(0,1,0),new s.Vector3(0,1,1),new s.Vector3(0,1,0),new s.Vector3(1,1,0),new s.Vector3(0,0,1),new s.Vector3(0,1,1),new s.Vector3(0,0,1),new s.Vector3(1,0,1),new s.Vector3(1,1,1),new s.Vector3(0,1,1),new s.Vector3(1,1,1),new s.Vector3(1,0,1),new s.Vector3(1,1,1),new s.Vector3(1,1,0)];var x,v=[];for(x=0;x<y.length;x++){v.push(x)}return d.createLineNode({points:y,drawMode:e.ConnectivityTypeEnum.LINES,idx:v})}};r.prototype.clearRepresentation=function(){if(this.node){this.root.removeChild(this.node);this.node=null}};r.prototype.dispose=function(){this.clearRepresentation();this.material&&this.material.dispose()};var t=true;r.prototype.updateRepresentation=function(w,y){if(this.previousDimension!==w.dimension){if(this.material){this.material.dispose();this.material=null}}if(!this.material){this.material=this.buildMaterial(w)}this.clearRepresentation();var v=this.createMesh(w);this.occurrences=[];v.setMaterial(this.material);var x=null;if(w.clusters===-1){x=this.createInstancingData(w)}else{x=this.createInstancingData_cluster(w,y)}this.setUpMeshInstancingParameters(v,x.nbInstances,x.sizes,x.matrices,x.colors);v.forceBoundingElements(true,{box:x.boundingBox});this.node=v;this.root.addChild(v)};r.prototype.createInstancingData=function(B){B=B||{};var z=new s.Box3();var D=this.computeNbInstances();var F=new Float32Array(D*16),v=new Float32Array(D*3),H=new Float32Array(D*3);var C,A,x,y=0,w;var G=this.references;var E=B.count;if(E){if(!this.priorityQueue){this.priorityQueue=new u()}this.priorityQueue.clear();for(C=0;C<this.references.length;C++){this.priorityQueue.addNode(this.references[C])}G=[];this.priorityQueue.traverseMax(function(K,J,I){G.push(K);if(G.length>=E){return false}else{return true}})}for(C=0;C<G.length;C++){x=G[C];if(x.isAlive()){w=x.getOccurrences();for(A=0;w!==null&&A<w.length;A++){if(this.fillInstancingData(x,w[A],y,H,F,v,z,B)){this.occurrences.push(w[A]);y++}}}}return{boundingBox:z,nbInstances:D,matrices:F,colors:v,sizes:H}};r.prototype.computeNbInstances=function(){var x,v;var w=0,y;for(x=0;x<this.references.length;x++){v=this.references[x];y=v.getOccurrences();if(v.isAlive()&&y!==null){w+=y.length}}return w};r.prototype.buildMaterial=function(v){var z=v.dimension===1?new s.LineBasicMaterial({force:true,opacity:v.opacity}):new s.MeshBasicMaterial({force:true,opacity:v.opacity});z.activatePDSFX();var x={vColor:{type:"v3"}};z.setPDSFXVaryings(x);var w={ComputeObjectPosition:["vec3 ComputeObjectPosition() {","vec4 localPosition = vec4(vGetAttribPosition(), 1.0);","vec4 newPosition = instanceMatrix*localPosition;","return newPosition.xyz;","}"].join("\n"),ComputeVaryingValues:["void ComputeVaryingValues() {","vColor = instanceColor;","}"].join("\n")};var y={ComputeAlbedo:["vec3 ComputeAlbedo() {","return vColor;","}"].join("\n"),ComputeSpecularReflectance:["vec3 ComputeSpecularReflectance() {","return vec3(1.0,1.0,1.0);","}"].join("\n")};z.setPDSFXOverridableFunctions(w,y);return z};r.prototype.getOccurrencesInXSO=function(w){var z=w.get();var x,y,A=null,B;for(x=0;x<z.length;x++){y=z[x].pathElement;if(y.instanceId!==undefined&&y.getLastElement()===this.node){if(!A){A=[]}var B=this.getOccurrenceFromInstanceId(y.instanceId);if(B){var v=B.reference;A.push(B);if(!this.preserveReferences){this.preserveReferences=[]}if(this.preserveReferences.indexOf(v)===-1){this.preserveReferences.push(v)}}}}return A};r.prototype.getOccurrenceFromInstanceId=function(w){var v=w/5-1;return this.occurrences[v]};r.prototype.getInstanceId=function(w){var v=this.occurrences.indexOf(w);return 5*(v+1)};r.prototype.createSelectionRestoringData=function(){this.preserveReferences=null;return[{xso:i,occurrences:this.getOccurrencesInXSO(i)},{xso:o,occurrences:this.getOccurrencesInXSO(o)},{xso:q,occurrences:this.getOccurrencesInXSO(q)}]};r.prototype.restoreSelection=function(x){var w;for(w=0;w<x.length;w++){var v=x[w].xso;var y=x[w].occurrences;if(y){this.addOccurrencesToXSO(v,y)}}};r.prototype.addOccurrencesToXSO=function(v,z){var w,A,y,x;for(w=0;w<z.length;w++){x=null;A=z[w];y=this.getInstanceId(A);if(y>0){x=new p([this.root,this.node]);x.instanceId=y}else{if(A instanceof l){if(A.reference.node){x=A.buildPathElement()}}else{x=new p();x.setFromOccurrence(A)}}if(x){v.add({pathElement:x})}}};var n=new s.Matrix4();var m=new s.Matrix4();var j=new s.Matrix4();var c=new s.Matrix4();var a=new s.Vector3();r.prototype.fillInstancingData=function(y,J,E,L,I,x,A,B){var K=y.getBoundingBox();if(K){K=K.clone()}else{return false}var H=J.matrix;n.copy(H);a.set(K.max.x-K.min.x,K.max.y-K.min.y,K.max.z-K.min.z);j.identity();c.identity();j.translate(K.min);c.scale(a);n.multiplyMatrices(j,c);m.multiplyMatrices(H,n);var F=m;var z=E*16,w=F.elements;var C;for(C=0;C<16;C++){I[z+C]=w[C]}var v=B.color.r,D=B.color.g,G=B.color.b;z=E*3;x[z]=v;x[z+1]=D;x[z+2]=G;L[z]=a.x;L[z+1]=a.y;L[z+2]=a.z;K.applyMatrix4(H);A.expandByPoint(K.min);A.expandByPoint(K.max);return true};r.prototype.getReferenceFromOccurrence=function(A){var y,x,v,w=0,z;for(y=0;y<this.references.length;y++){v=this.references[y];if(v.isAlive()){z=v.getOccurrences();for(x=0;z!==null&&x<z.length;x++){if(this.occurrences[w]===A){return v.referenceId}w++}}}};r.prototype.setUpMeshInstancingParameters=function(B,w,y,x,v){var A={data:x,type:"m4",attribName:"instanceMatrix",isFlattened:true};var z={data:v,type:"v3",attribName:"instanceColor",isFlattened:true};B.setInstancingParameters(w,[A,z])};function k(w,v){this.center=w.center();this.bbox=w;this.bbox.applyMatrix4(v);this.matrix=v;this.center.applyMatrix4(v);this.clusterIndex=-1}k.prototype.selectCluster=function(z){var w=Infinity,y,x=-1,v,A;for(y=0;y<z.length;y++){v=z[y];A=v.center.distanceTo(this.center);if(A<w){x=y;w=A}}return x};function f(){this.center=new s.Vector3();this.nodes=[]}window.myRnd=[];var b=undefined,h=0;function g(){if(b===undefined){if(window.WUXLDH_RndTable){b=window.WUXLDH_RndTable}else{b=null}}var v;if(b){v=b[h];h=(h+1)%b.length;return v}else{v=Math.random();window.myRnd.push(v);return v}}f.prototype.randomize=function(v){this.center.set(v.min.x+g()*(v.max.x-v.min.x),v.min.y+g()*(v.max.y-v.min.y),v.min.z+g()*(v.max.z-v.min.z))};f.prototype.resetNodes=function(){this.nodes=[]};f.prototype.updateCenter=function(){var x,w=this.nodes;var v=this.center;if(w.length>0){v.set(0,0,0);for(x=0;x<w.length;x++){v.addVectors(v,w[x].center)}v.multiplyScalar(1/w.length)}};f.prototype.buildBoundingBox=function(){var v=new s.Box3();var x,w,y;for(x=0;x<this.nodes.length;x++){w=this.nodes[x];v.union(w.bbox)}return v};r.prototype.createClusterData=function(v,A,z){var y=v.getBoundingBox();var x=A.matrix;var w=new k(y.clone(),x);if(w&&!w.bbox.containsPoint(z)){return w}return null};r.prototype.fillInstancingData_cluster=function(H,L,D,K,G,x,A,J,y){m.identity();var I=H.buildBoundingBox();if(I.containsPoint(y)){return 0}J.union(I);I.size(L);m.scale(L);m.setPosition(I.min);var E=m;var z=D*16,w=E.elements;var B;for(B=0;B<16;B++){G[z+B]=w[B]}var v=A.color.r,C=A.color.g,F=A.color.b;z=D*3;x[z]=v;x[z+1]=C;x[z+2]=F;K[z]=L.x;K[z+1]=L.y;K[z+2]=L.z;return 1};r.prototype.createInstancingData_cluster=function(y,w){var B=this.createClusters(y,w);var E=new s.Box3();var A=B.length,x=0;var D=new Float32Array(A*16),v=new Float32Array(A*3),G=new Float32Array(A*3);var z,C;var F=new s.Vector3(E.max.x-E.min.x,E.max.y-E.min.y,E.max.z-E.min.z);F.multiplyScalar(1/50);F.set(100,100,100);for(z=0;z<B.length;z++){C=B[z];x+=this.fillInstancingData_cluster(C,F,x,G,D,v,y,E,w)}A=x;return{boundingBox:E,nbInstances:A,matrices:D,colors:v,sizes:G}};r.prototype.createClusters=function(E,B){var w=[];var F,D,C,z,A;for(F=0;F<this.references.length;F++){C=this.references[F];if(C.isAlive()){z=C.isSlave()?C.node._occurrences:C._occurrences;for(D=0;D<z.length;D++){A=this.createClusterData(C,z[D],B);if(A){w.push(A)}}}}var v=new s.Box3();for(F=0;F<w.length;F++){v.expandByPoint(w[F].center)}var y=E.clusters;var I=this.lastClusters;var J;if(!I||(I.length===0&&w.length>0)){I=[];for(F=0;F<y;F++){J=new f();J.randomize(v);I.push(J)}}else{for(F=0;F<I.length;F++){J=I[F];J.resetNodes()}}var G,A;for(F=0;F<w.length;F++){A=w[F];G=A.selectCluster(I);I[G].nodes.push(A);A.clusterIndex=G}var H=this.lastClusters?true:false;while(!H){H=true;for(F=0;F<I.length;F++){J=I[F];J.updateCenter();J.nodes.length=0}for(F=0;F<w.length;F++){A=w[F];G=A.selectCluster(I);I[G].nodes.push(A);if(A.clusterIndex!==G){H=false;A.clusterIndex=G}}}var x=[];for(F=0;F<I.length;F++){if(I[F].nodes.length>0){x.push(I[F])}}this.lastClusters=x;return x};r.prototype.clearClusters=function(){this.lastClusters=null};return r});define("DS/3DXMTiles/BBDistanceToVptLODSelector",["DS/3DXMTiles/LODSelector","DS/Visualization/ThreeJS_DS"],function(c,b){var d=new b.Vector3();var a=new b.Matrix4();var e=c.extend({init:function(f){this._parent();this.type="BBDistanceToVpt";this.distance=f},computeLOD:function(h,m){var j=m.viewpoint;if(this.disableDowngrade&&h._lod===1){return 1}var k;var f=h._occurrences;var l,p=0;for(l=0;p<1&&l<f.length;l++){var g=f[l].matrix;if(h._boundingBox){k=h._boundingBox;a.copy(g)}else{var h=h._representationNodes[0];k=h.getBoundingBox();if(h._matrix){a.multiplyMatrices(g,h._matrix)}else{a.copy(occurenceMatrix)}}var n=j.camera;k.center(d);d.applyMatrix4(a);var o=n.position.distanceTo(d);if(o<this.distance){p=1}}return p},createJSON:function(f){f=f||{};f.distance=this.distance;return this._parent(f)}});e.createFromJSON=function(f){var g=f.distance;return new e(parseFloat(g))};return e});define("DS/3DXMTiles/JSONToLODSelector",["DS/3DXMTiles/BSScreenSizeLODSelector","DS/3DXMTiles/BBDistanceToVptLODSelector"],function(a,d){var b={BSScreenSize:a,BBDistanceToVpt:d,};var c={createFromJSON:function(f){var g=f.type;var h=b[g];if(h){var e=h.createFromJSON(f);if(f.disableDowngrade){e.setDisableDowngrade(true)}return e}else{console.log("Unknown LODSelector: '"+g+"'");return null}}};return c});define("DS/3DXMTiles/LDHNodeManagerQueue",["DS/3DXMTiles/PriorityQueue","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHReferenceStatus"],function(b,a,e){var d=function(g,f){this.type=g;this.handler=null;this.manager=f;this.newNodes=[];this.nodes=[];this.pendingNodes=[];this.nbNodesToRemoveFromList=0;this.viewpointData=null;this.nodesToLoadQueue=new b();this.nodesToUpdate=[];this.forcedReferences=[];this.unknownReferences=[];this.referenceSizeMap=new Map();this.nbLoading=0};d.prototype.registerNode=function(g){if(this.handler==null){this.handler=g.handler;if(this.manager.unloadManager.isRestricted){this.handler.setRestricted()}}else{if(this.handler!==g.handler){throw new Error("different handler found")}}var f=false;if(g.isForced()&&!g.isLoaded()){if(!g.isInForced()){f=true;g.setInForced(true);this.forcedReferences.push(g)}}else{if(g.isInForced()){this.removeForcedNode(g);g.setInForced(false)}}if(g.isUnknown()){if(!g.isInUnknown()&&!f){f=true;g.setInUnknown(true);this.unknownReferences.push(g)}}else{if(g.isInUnknown()){this.removeUnknownNode(g);g.setInUnknown(false)}}if(!g.isInList()){g.setInList(true);this.newNodes.push(g)}else{this.forceUpdateNode(g)}};d.prototype.unregisterNode=function(f){if(f.isInUnknown()){this.removeUnknownNode(f);f.setInUnknown(false)}if(f.isInForced()){this.removeForcedNode(f);f.setInForced(false)}};d.prototype.onReferenceUnloaded=function(){this.nodesToLoadQueue.cleanNulls()};d.prototype.removeUnknownNode=function(g){var f=this.unknownReferences.indexOf(g);if(f>=0){this.unknownReferences.splice(f,1)}};d.prototype.removeForcedNode=function(g){var f=this.forcedReferences.indexOf(g);if(f>=0){this.forcedReferences.splice(f,1)}};d.prototype.forceUpdateNode=function(f){if(this.nodesToUpdate.indexOf(f)===-1){this.nodesToUpdate.push(f)}};d.prototype.updateNodes=function(i,j){if(this.handler===null){return}if(j){this.viewpointData=j}else{j=this.viewpointData}var f=i;var h=this.handler.isReady();if(!f){this.updateNodesToLoad(this.newNodes,j);this.updateNodesToLoad(this.nodesToUpdate,j)}var g=this.newNodes.length>0;c(this.nodes,this.newNodes);this.newNodes.length=0;this.nodesToUpdate.length=0;this.removeUselessNodesFromList(this.nodes,i);if(f){this.resetNodesToLoad()}if(f){this.updateNodesToLoad(this.nodes,j)}};d.prototype.updateNodesToLoad=function(g,n){var h,k,m,l,f;var j=this.manager.enableUnload;for(h=0;h<g.length;h++){k=g[h];if(k.needScreenRadiusSizeComputation()){m=k.updateNodeLOD(n);if(m===1){if(k.getUnloadViewpointTag()!==this.manager.viewpointTag){if(k.shouldBeExpanded()&&!k.isInToBeLoaded(true)&&!k.isInHighPriority()){k.setInToBeLoaded(true);this.nodesToLoadQueue.addNode(k)}k.toUnload=false}}else{if(j){k.toUnload=true}}}}};d.prototype.resetNodesToLoad=function(){this.nodesToLoadQueue.clear(function(f){f.setInToBeLoaded(false)})};d.prototype.loadHighPriorityNodes=function(l){var k=[];var h=this.manager.unloadManager;var o=this.handler,n=[this.forcedReferences,this.unknownReferences],j,f,m,g;var i;if(o&&o.isReady()&&(n[0].length>0||n[1].length>0)){for(j=0;j<n.length;j++){m=n[j];for(f=0;f<m.length&&o.isReady();f++){g=m[f];if(!g.loading){i=h.isLoadingAllowed();if(!i){this.manager.unloadSmallNodes(Infinity,l);i=h.isLoadingAllowed()}if(i){k.push(g);if(k.length>=o.getBatchSize()){this.loadBatch(k);k=[]}}}}}}return k};d.prototype.loadNodes=function(g,m){var k=this.loadHighPriorityNodes(m);var h=this.manager;var o=h.enableUnload;var j=!o||h.unloadManager.isLoadingAllowed();var i=h.unloadManager;var p=this.handler;var l=this;if(p){var n=p.type===a.InstRefHander?h.maxNbExpectedChildrenPerRequest:0;var f=0;this.nodesToLoadQueue.traverseMaxPlus(function(s,r,q){if(!s.isAlive()){return}if(s.comesFromWrap()){q();return}if(i.wouldDownloadCauseEmergencyUnload(s.referenceId,l)){h.emergencyUnloadAvoided=true;q();r();return}if(p.isReady()){if(!j&&h.unloadSmallNodesEnabled){h.unloadSmallNodes(s._screenRadius,m);j=i.isLoadingAllowed()}if(j){if(s.hasDifferentViewpointTag(h.viewpointTag)&&(s._occurrences.length>0||s.isSlave())&&!s.isInHighPriority()){k.push(s);if(s.expectedNbChildren>=0){f+=s.expectedNbChildren}if(k.length>=p.getBatchSize()||(n>0&&f>=n)){l.loadBatch(k);k=[];f=0}}s.setInToBeLoaded(false);return}}r();q();return})}if(k.length>0){this.loadBatch(k)}};d.prototype.addNextNodeToBatch=function(f){var g=this.removeMaxNodeFromQueue();if(g){f.push(g);return true}return false};d.prototype.loadBatch=function(g){if(g.length>0){var k=g.concat([]);var l=g[g.length-1];var j={viewpointTag:this.manager.viewpointTag,manager:this.manager.oocManager,doneCB:this.onHandlerDone.bind(this),screenRadius:l._screenRadius};var h,f;for(h=0;h<k.length;h++){f=k[h];if(!f.loading){f.loading=true;f.updateUnloadStatus();f.updateParentsStatus()}}if(this.handler.type===0){this.nbLoading+=g.length}else{this.nbLoading++}this.handler.handleReferences(k,j)}};d.prototype.onHandlerDone=function(h,m){m=m||[];h=h||[];if(this.handler.type===0){this.nbLoading-=m.length+h.length}else{this.nbLoading--}var l=this.manager.enableUnload;var f=h.concat(m);var j,k,g=this.manager.unloadManager,n;for(j=0;j<f.length;j++){k=f[j];if(k.loading){k.loading=false;k.updateUnloadStatus();k.updateParentsStatus()}if(!k._boundingSphere&&!k._boundingBox&&this.handler.type===a.Model3DHandler){k.updateBoundingSphereFromNode();n=true}if(k.isForced()||n){this.manager.registerTilesNode(k)}}for(j=0;j<m.length;j++){if(this.handler.type===a.Model3DHandler){m[j].setStatus(e.error);this.onNodeToRemoveFromList()}else{this.forceUpdateNode(m[j])}}this.manager._updateNodes();if(this.handler.type===a.Model3DHandler){if(this.manager.isForceSceneMinEnabled()){this.manager.viewer.render({budgeted:true})}else{this.manager.viewer.render({budgeted:true,updateInfinitePlane:true})}}};d.prototype.onNodeToRemoveFromList=function(){this.nbNodesToRemoveFromList++};d.prototype.removeMaxNodeFromQueue=function(){var f=this.nodesToLoadQueue.getMaxNode(true);f.setInToBeLoaded(false);return f};d.prototype.removeUselessNodesFromList=function(f,k){if(this.nbNodesToRemoveFromList>200||k){var g,j;for(g=0;g<f.length;g++){j=f[g];if(!j.isAlive()){f[g]=null}else{if(j.isFrozen()&&!j.shouldBeExpanded()){j.setInList(false);f[g]=null}}}var h=0;for(g=0;g<f.length;g++){j=f[g];if(j!==null){f[h]=j;h++}}f.length=h;this.nbNodesToRemoveFromList=0}};d.prototype.isLoading=function(){return this.nbLoading>0};d.prototype.hasMoreToLoad=function(){return !this.nodesToLoadQueue.isEmpty()};d.prototype.forceClean=function(){this.removeUselessNodesFromList(this.nodes,true);this.nodesToLoadQueue.traverseMaxPlus(function(h,g,f){if(h.isAlive()){f()}});this.nodesToLoadQueue.cleanNulls(true)};d.prototype.fillDebugArray=function(l){this.removeUselessNodesFromList(this.nodes,true);var k,f,n,h;for(k=0;k<this.nodes.length;k++){f=this.nodes[k];n={id:f.referenceId,screenRadius:f._screenRadius,status:f._status,unloadStatus:f._unloadStatus};if(f.expectedNbChildren!==0||f.children.length>0){n.expectedNbChildren=f.expectedNbChildren;n.nbChildren=f.children.length;if(f.children.length>0){var g=[];var m=[];for(h=0;h<f.children.length;h++){g.push(f.children[h].reference.referenceId);m.push(f.children[h].instanceId)}n.children=g;n.instances=m}}if(f.toUnload){n.toUnload=true}if(f.loading){n.loading=true}if(f.unloadLockCounter>0){n.unloadLockCounter=f.unloadLockCounter}l.push(n)}};d.prototype.memorizeReferenceSize=function(g,f){if(!this.referenceSizeMap.has(g)||this.referenceSizeMap.get(g)<f){this.referenceSizeMap.set(g,f)}};d.prototype.getMemorizedReferenceSize=function(f){if(this.referenceSizeMap.has(f)){return this.referenceSizeMap.get(f)}return -1};function c(h,g){var f;for(f=0;f<g.length;f++){h.push(g[f])}}return d});define("DS/3DXMTiles/LDHCandidateQueueRenderer",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/3DXMTiles/LDHCandidateListRenderer","DS/3DXMTiles/LDHOccurrence","DS/Mesh/MeshUtils"],function(f,e,d,b,a,i,c){var g=function(k,j){this.manager=k;this.viewer=k.viewer;this.root=j||new d("CandidateQueueRenderer");this.viewer.addNode(this.root);this.displayIntermediateReferences=false;this.preserveReferences=null;this.preserveSelection=false;this.pickable=c.PICKABLE;this.attributes=[new h({dimension:2,color:new f.Color("red"),opacity:0.1}),new h({dimension:1,color:new f.Color("black"),opacity:1})];this.candidateListRenderers=[new a(this.root),new a(this.root)]};g.prototype.setPickable=function(j){this.root.setPickable(j)};g.prototype.setParams=function(j){j=j||{};this.displayIntermediateReferences=j.displayIntermediateReferences?true:false;if(j.repRefAttributes){this.attributes[0].setParams(j.repRefAttributes)}if(j.refAttributes){this.attributes[1].setParams(j.refAttributes)}};g.prototype.dispose=function(){var j;for(j=0;j<this.candidateListRenderers.length;j++){this.candidateListRenderers[j].dispose()}this.root=null};g.prototype.addNodeList=function(k,m){var l,j;for(l=0;l<k.length;l++){j=k[l];if(this.shouldDisplayReference(j)){m.references.push(j)}}};g.prototype.shouldDisplayReference=function(j){if((!j.node||(j.isSlave()&&j.node.children.length===0))&&j.getLODValue()>0){return true}if(this.preserveReferences&&this.preserveReferences.indexOf(j)>=0){return true}return false};g.prototype.getNodesFromQueue=function(j,l){var k=[];var m,n;for(m=0;m<j.nodes.length;m++){n=j.nodes[m];if(l){if(n.children.length===0&&n.expectedNbChildren>0){k.push(n)}}else{if(!n.isLoaded()){k.push(n)}}}return k};g.prototype.updateRepresentation=function(q){var n=this.manager;var m;var p=[],o,l;for(m=0;m<this.candidateListRenderers.length;m++){l=this.attributes[m];if(l.clusters===-1){o=this.candidateListRenderers[m];if(this.preserveSelection){p.push(o.createSelectionRestoringData())}else{p.push(null)}o.references=[]}}for(m=0;m<n.queues.length;m++){l=this.attributes[m];o=this.candidateListRenderers[m];if(this.displayIntermediateReferences||m===0){var j=n.queues[m];var k=this.getNodesFromQueue(j,m===1);this.addNodeList(k,o);o.updateRepresentation(l,q)}if(l.clusters===-1&&p[m]){o.restoreSelection(p[m])}}};g.prototype.getPathFromPathElement=function(m){var k,l;for(k=0;k<this.candidateListRenderers.length;k++){l=this.candidateListRenderers[k];if(m.externalPath.indexOf(l.node)>=0){var o=l.getOccurrenceFromInstanceId(m.instanceId);var n=null,j;if(o){if(o instanceof i){n=[];while(o){n.unshift(o.reference.referenceId);if(o.parent){n.unshift(o.instanceId)}o=o.parent}}}return n}}return null};g.prototype.getReferenceFromPathElement=function(m){var k,l;for(k=0;k<this.candidateListRenderers.length;k++){l=this.candidateListRenderers[k];if(m.externalPath.indexOf(l.node)>=0){var o=l.getOccurrenceFromInstanceId(m.instanceId);var n=null,j;if(o){if(o instanceof i){return o.reference.referenceId}else{return l.getReferenceFromOccurrence(o)}}}}return null};g.prototype.clearClusters=function(){var j,k;for(j=0;j<this.candidateListRenderers.length;j++){k=this.candidateListRenderers[j];k.clearClusters()}};var h=function(j){this.color=j.color.clone();this.opacity=j.opacity;this.dimension=j.dimension;this.clusters=j.clusters||-1;this.count=j.count||0};h.prototype.setParams=function(j){if(j.color){this.color=j.color.clone()}if(j.opacity!==undefined){this.opacity=j.opacity}if(j.dimension!==undefined){this.dimension=j.dimension}if(j.clusters!==undefined){this.clusters=j.clusters||-1}if(j.count!==undefined){this.count=j.count||0}};return g});define("DS/3DXMTiles/OOCManagerRootEntry",["DS/3DXMTiles/LDHReference"],function(b){var a=function(d,c){this.occurrence=d;this.boundingBox=c&&c.clone()};a.prototype.computeSceneMin=function(){var c=this.boundingBox.clone();c.applyMatrix4(this.occurrence.matrix);return c.min.z};return a});define("DS/3DXMTiles/LDHHandlerOOCAdapter",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/OOCPath"],function(b,a){var c=function(d){b.call(this,d.type);this.oocHandler=d};c.prototype=Object.create(b.prototype);c.prototype.handleReferences=function(h,g){var f,k,d,e=[];for(f=0;f<h.length;f++){var d=h[f];k=a.buildFromReference(d,true);if(k){e.push(k)}}var j={viewpointTag:g.viewpointTag,doneCB:this.adapterDoneCB.bind(this,g),screenRadius:g.screenRadius};this.oocHandler.handlePathes(e,j)};c.prototype.isReady=function(){return this.oocHandler.isReady()};c.prototype.getBatchSize=function(){return this.oocHandler.getBatchSize()};c.prototype.adapterDoneCB=function(g,e,k){var d=[],j=[];var f,h;for(f=0;f<e.length;f++){if(typeof(e[f])==="string"){h=this.oocHandler.manager._getLDHReference(e[f],true)}else{h=e[f]._ldhReference}if(h){d.push(h)}}for(f=0;f<k.length;f++){if(typeof(k[f])==="string"){h=this.oocHandler.manager._getLDHReference(k[f])}else{h=k[f]._ldhReference}j.push(h)}g.doneCB(d,j)};return c});define("DS/3DXMTiles/LDHModel3DHandler2",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/ModelLoaderPool","DS/3DXMTiles/ModelLoaderPoolParams","DS/3DXMTiles/LDHReferenceStatus"],function(b,a,c,e){var f=function(i,h){this.references=i;this.nbRedirected=0;this.context=h;this.okReferences=[];this.koReferences=[]};f.prototype.addOkReference=function(i){var h=i.getReference();this.okReferences.push(h)};f.prototype.addKoReference=function(i){var h=i.getReference();this.koReferences.push(h)};f.prototype.isComplete=function(){return this.okReferences.length+this.koReferences.length>=this.references.length};var g=function(i,h,j){this.batch=i;this.index=h;this.newURL=j};g.prototype.getUrl=function(){return this.batch.references[this.index].url};g.prototype.getReference=function(){return this.batch.references[this.index]};var d=function(h){b.call(this,b.Model3DHandler);this.fileType=null;this.redirectUrlCB=null;this.loadModelOptions=null;this.batches=[];this.toLoad=[];this.debug=h.debug?true:false;this.minBatchSize=40;this.maxTickets=h.batchSize||100;this.maxRedirectTickets=h.redirectBatchSize||40;this.tickets=this.maxTickets;this.redirectTickets=this.maxRedirectTickets};d.prototype=Object.create(b.prototype);d.prototype.setFileType=function(h){this.fileType=h};d.prototype.setRestricted=function(){this.minBatchSize=2;this.maxTickets=2;this.maxRedirectTickets=2;this.tickets=this.maxTickets;this.redirectTickets=this.maxRedirectTickets};d.prototype.isReady=function(){return this.tickets>=this.minBatchSize};d.prototype.setLoadModelOptions=function(h){this.loadModelOptions=h};d.prototype.handleReferences=function(m,l){var j=new f(m,l),k,h;this.batches.push(j);this.incTickets(-m.length);if(!this.redirectUrlCB){for(k=0;k<j.references.length;k++){h=j.references[k];this.toLoad.push(new g(j,k,h.url))}this.loadModels()}else{this.redirectUrls()}};d.prototype.redirectUrls=function(){if(this.redirectTickets>0){var m,l,o,p=[],h=[],k;for(m=0;m<this.batches.length;m++){l=this.batches[m];for(k=l.nbRedirected;this.redirectTickets>0&&k<l.references.length;k++){l.nbRedirected++;o=new g(l,k,null);if(o.getUrl()){p.push(o);h.push(o.getUrl());this.incRedirectTickets(-1)}else{this.toLoad.push(o)}}}if(p.length>0){var n=this;this.incRedirectTickets(-this.redirectTickets);this.redirectUrlCB(h,function(j){n.incRedirectTickets(-n.redirectTickets+n.maxRedirectTickets);var q;for(q=0;q<j.length;q++){p[q].newURL=j[q];n.toLoad.push(p[q])}n.redirectUrls();n.loadModels()})}}};d.prototype.loadModels=function(){var h;if(this.debug){a.setDebug(true)}while(a.nbTickets>0&&this.toLoad.length>0){h=this.toLoad.shift();if(h.newURL){a.nbTickets--;a._loadModel(h.newURL,h.getReference(),this.onModelLoaded.bind(this,h),this.onModelError.bind(this,h),null,this.fileType,this.loadModelOptions)}else{setTimeout(this.onModelError.bind(this,h),1)}}};d.prototype.onModelLoaded=function(m){this.incTickets(+1);var j=m.batch;var l=j.context;var k,h;h=m.getReference();l.manager.startInstRefGraphTransaction();l.manager._onRepLoaded(h.referenceId);l.manager.endInstRefGraphTransaction();l.doneCB([h],[]);if(j.isComplete()){this.onBatchComplete(j)}this.loadModels()};d.prototype.onModelError=function(m){this.incTickets(+1);var j=m.batch;var l=j.context;var k,h;h=m.getReference();l.manager.startInstRefGraphTransaction();l.manager._onRepLoaded(h.referenceId);l.manager.endInstRefGraphTransaction();l.doneCB([],[h]);if(j.isComplete()){this.onBatchComplete(j)}this.loadModels()};d.prototype.onBatchComplete=function(k){var j=this.batches.indexOf(k);this.batches.splice(j,1);var n=k.context;var m,h,l=k.okReferences;k.references=[];k.okReferences=[];k.koReferences=[]};d.prototype.loadParams=function(i,j,h){a.loadParams(j,this.onLoadedModel.bind(this,i,h),this.onErrorModel.bind(this,i,h),null,this.fileType,this.loadModelOptions)};d.prototype.onLoadedModel=function(l,k){k.manager.startInstRefGraphTransaction();var j,h;for(j=0;j<l.length;j++){h=l[j];k.manager._onRepLoaded(h.referenceId)}k.manager.endInstRefGraphTransaction();k.doneCB(l)};d.prototype.onErrorModel=function(i,h){h.doneCB(null,i)};d.prototype.getModelLoader=function(){return a.modelLoader};d.prototype.getBatchSize=function(){return this.tickets};d.prototype.setRedirectUrlCB=function(h){this.redirectUrlCB=h};d.prototype.incTickets=function(h){this.tickets+=h};d.prototype.incRedirectTickets=function(h){this.redirectTickets+=h};return d});define("DS/3DXMTiles/LDHUserQueue",["DS/3DXMTiles/PriorityQueue"],function(a){var b=function(d,c){this.queue=new a();this.handler=d;this.manager=c};b.prototype.addNode=function(c){this.queue.addNode(c)};b.prototype.computeOrder=function(e){this.queue.resetOrder();var c,d;for(c=0;c<this.queue.nodeListLength;c++){d=this.queue.nodeList[c];if(d&&d.isAlive()&&(!d.isInList()||!d.needScreenRadiusSizeComputation())){d.updateNodeLOD(e)}}};b.prototype.handleViewpointChange=function(c){this.computeOrder(c)};b.prototype.traverseQueue=function(){var e=this.handler;var c=[];var d={doneCB:this.onHandlerDone.bind(this)};this.queue.traverseMax(function(f){if(!f.isAlive()){return true}if(f._screenRadius>=0&&e.isReady()){c.push(f.referenceId);if(c.length>=e.getBatchSize()){e.handleReferences(c,d);c=[]}return true}return false});if(c.length>0){e.handleReferences(c,d,this.queue.isEmpty());c=[]}if(this.queue.isEmpty()){this.manager.removeUserQueue(this.handler)}};b.prototype.onHandlerDone=function(){this.manager.requestUpdate(false,false)};return b});define("DS/3DXMTiles/OOCHandler",["DS/3DXMTiles/LDHHandlerOOCAdapter"],function(a){var c=0;var b=function(e,d){this.type=e;this.id=c++;this.ldhHandler=d||new a(this)};b.prototype.handlePathes=function(e,d){};b.prototype.getBatchSize=function(){return 1};b.Model3DHandler=0;b.InstRefHander=1;return b});define("DS/3DXMTiles/LDHNodeManager",["DS/3DXMTiles/LDHNodeManagerQueue","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/3DXMTilesUtils","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/UnloadManager","DS/3DXMTiles/PriorityQueue","DS/3DXMTiles/LDHReferenceUnloadStatus","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/3DXMTiles/LDHUserQueue","DS/3DXMTiles/LDHCandidateQueueRenderer","DS/3DXMTiles/Debug3DXMTiles"],function(c,e,l,i,g,d,m,h,f,j,a){var k=function(q,n,o){this.enableUnload=(window.OOCEnableUnload!==undefined)?window.OOCEnableUnload:true;this.viewer=q;var p=this;q.currentViewpoint.onMove(function(){p.requestUpdate(true,false);p.startLoadTime=(new Date()).getTime()});this.queues=[new c(e.Model3DHandler,this),new c(e.InstRefHander,this)];this.requestUpdateToken=null;this.updateOptions={viewpointChanged:false,modelLoaded:false};this.viewpointHasChanged=true;this.targetNode=null;this.requestUpdate(true,true);this.unloadManager=new g(o);this.loadedNodesQueue=new d();this.previousIsLoading=false;this.onStartLoadingCB=null;this.onEndLoadingCB=null;this.suspendedReferenceActions=[];this.debugThrottle=0;this.pauseLoading=false;this.oocManager=n;this.viewpointTag=0;this.debugMissingExpectedNbChildren=window.debugMissingExpectedNbChildren?true:false;this.unloadSmallNodesEnabled=true;this.unloadLeafReferenceCB=null;this.onLeafReferenceLoadedCB=null;this.pauseLoadingDuringViewpointMove=false;this._dbg_freezeViewpointTag=false;this.overrideSetManager=null;this.overrideSetMap={};this.lastQueueRendererUpdateTime=0;this.queueRenderer=null;this.maxNbExpectedChildrenPerRequest=0;this.userQueues=[];this.lastDeltaTime=-1;this.startLoadTime=null;this.wrapStatusToUpdate=null;this.hasUnloadedSmallNodes=false;this.emergencyUnloadOccured=false;this.emergencyUnloadAvoided=false;window.oocLDHNodeManager=this};var b=function(n,o){this.references=n;this.callback=o};k.prototype.setUnloadSmallNodesEnabled=function(n){this.unloadSmallNodesEnabled=n};k.prototype.setMaxNbExpectedChildrenPerRequest=function(n){this.maxNbExpectedChildrenPerRequest=n};k.prototype.addWrapStatusToUpdate=function(n){if(this.wrapStatusToUpdate===null){this.wrapStatusToUpdate=new Set()}this.wrapStatusToUpdate.add(n)};k.prototype.updateAllWrapStatuses=function(){if(this.wrapStatusToUpdate!==null){this.wrapStatusToUpdate.forEach(function(n){n.updateWrapStatusFromChildren(false)});this.wrapStatusToUpdate=null}};k.prototype.tryBuildSceneGraphHierarchy=function(){var p=this.oocManager.getRootOccurrences();var o=[];p.forEach(function(s,r,t){var u=s.occurrence;var q=u.reference;q.tryBuildSceneGraphHierarchy(o)});var n;for(n=0;n<o.length;n++){o[n].updateOverride()}};k.prototype.setPauseLoadingDuringViewpointMove=function(n){this.pauseLoadingDuringViewpointMove=n};k.prototype.tryToPerformReferenceAction=function(o,r){var n,p=true;for(n=0;n<o.length;n++){if(o[n].loading){p=false}}if(p){var q=this;r.call(undefined,o,function(){q.requestUpdate(true,true)});return true}else{return false}};k.prototype.executeReferenceAction=function(n,o){if(!this.tryToPerformReferenceAction(n,o)){this.suspendedReferenceActions.push(new b(n,o))}};k.prototype.setTargetNode=function(n){this.targetNode=n};k.prototype.registerTilesNode=function(p){if(p._status!==i.complete&&p._status!==i.incomplete){return}if(p.isUnloadable()&&!p.isInLoaded()){this.addToLoadedNodesQueue(p)}var o=p.handler;var n=this.queues[o.type];n.registerNode(p);this.requestUpdate(false,false)};k.prototype.unregisterNode=function(p){if(!p.isAlive()){var o=p.handler;var n=this.queues[o.type];n.unregisterNode(p)}};k.prototype.forceUpdateNode=function(p){var o=p.handler;var n=this.queues[o.type];n.forceUpdateNode(p);this.requestUpdate(false,false)};k.prototype.requestUpdate=function(n,o){this.updateOptions.viewpointChanged=this.updateOptions.viewpointChanged||n;this.updateOptions.modelLoaded=this.updateOptions.modelLoaded||o;if(this.requestUpdateToken===null){this.requestUpdateToken=setTimeout(this._updateNodes.bind(this),0)}};k.prototype._updateNodes=function(){a.startProbe("updateNodes");var q=this.createViewpointData(this.viewer.currentViewpoint);var o,n;var p;if(this.suspendedReferenceActions.length>0){for(o=0;o<this.suspendedReferenceActions.length;o++){p=this.suspendedReferenceActions[o];if(this.tryToPerformReferenceAction(p.references,p.callback)){this.suspendedReferenceActions[o]=null}}this.suspendedReferenceActions=this.suspendedReferenceActions.filter(function(r){return r!==null})}this.updateAllWrapStatuses();if(this.requestUpdateToken!==null){clearTimeout(this.requestUpdateToken);this.requestUpdateToken=null}if(this.pauseLoadingDuringViewpointMove&&this.viewer.currentViewpoint.isMoving()){this.emergencyUnloadNodes(q);this.requestUpdate(false,false);a.endProbe("updateNodes");return}this.viewpointHasChanged=this.viewpointHasChanged||this.updateOptions.viewpointChanged;if(this.viewpointHasChanged){this.hasUnloadedSmallNodes=false;this.emergencyUnloadOccured=false;this.emergencyUnloadAvoided=false}if(this.pauseLoading||this.debugThrottle===2){this.updateUserQueues(this.viewpointHasChanged,q);this.emergencyUnloadNodes(q);this.updateLoadingStatus();a.endProbe("updateNodes");return}if(this.viewpointHasChanged&&!this._dbg_freezeViewpointTag){this.viewpointTag++}if(this.viewpointHasChanged&&this.queueRenderer){this.queueRenderer.clearClusters()}for(o=0;o<this.queues.length;o++){n=this.queues[o];n.updateNodes(this.viewpointHasChanged,q)}this.updateUserQueues(this.viewpointHasChanged,q);if(this.enableUnload){this.updateLoadedNodes(this.viewpointHasChanged,q);this.emergencyUnloadNodes(q)}if(this.debugThrottle<1){this.loadNodes(this.viewpointHasChanged,q)}this.viewpointHasChanged=false;this.updateOptions.viewpointChanged=false;this.updateOptions.modelLoaded=false;this.updateLoadingStatus();this.updateCandidateQueueRenderer();a.endProbe("updateNodes")};k.prototype.updateUserQueues=function(p,q){var o;for(o=0;o<this.userQueues.length;o++){var n=this.userQueues[o];if(!this.pauseLoading||!n.pauseSensitive){if(p){n.handleViewpointChange(q)}n.traverseQueue()}}};k.prototype.loadNodes=function(n,o){if(this.debugThrottle<0.5){this.queues[0].loadNodes(n,o)}this.queues[1].loadNodes(n,o)};k.prototype.createViewpointData=function(n){var o={viewpoint:n,cst:l.computeScreenRadiusCstComponent(n.camera,this.viewer)};return o};k.prototype.removeRemovedNodes=function(){var n;for(n=0;n<this.queues.length;n++){this.queues[n].removeUselessNodesFromList(this.queues[n].nodes)}};k.prototype.updateLoadingStatus=function(){var o=false,s=this.hasUnloadedSmallNodes,p;var q;for(q=0;q<this.queues.length;q++){o=o||this.queues[q].isLoading();s=s||this.queues[q].hasMoreToLoad()}var r=!this.unloadManager.isLoadingAllowed();if(o!==this.previousIsLoading){var n={isLoading:o,memoryFull:r||this.emergencyUnloadOccured||this.emergencyUnloadAvoided,moreToLoad:s||this.emergencyUnloadOccured||this.emergencyUnloadAvoided,emergencyUnload:this.emergencyUnloadOccured,emergencyUnloadAvoided:this.emergencyUnloadAvoided};if(o){this.startLoadTime=(new Date()).getTime();if(this.onStartLoadingCB){this.onStartLoadingCB.call(undefined,n)}}else{p=(new Date()).getTime();this.lastDeltaTime=p-this.startLoadTime;this.updateCandidateQueueRenderer(true);this.viewer.render();if(this.onEndLoadingCB){this.onEndLoadingCB.call(undefined,n)}}this.previousIsLoading=o}};k.prototype.addToLoadedNodesQueue=function(n){if(!n.isInLoaded()){n.setInLoaded(true);this.loadedNodesQueue.addNode(n)}};k.prototype.addLoadedNode=function(n){if(!n.isUnloadable()){console.log("inconsistency")}this.addToLoadedNodesQueue(n)};k.prototype.unloadSmallNodes=function(n,s){var p=this.unloadManager,q=false;var o=this.loadedNodesQueue;var r=this;o.traverseMinPlus(function(w,v,u){var t=false;if((!p.isLoadingAllowed()&&w._screenRadius<n)){if(!w.isUnloadLocked()){if(!r.unloadNode(w,s)){t=true}else{r.hasUnloadedSmallNodes=true}}else{t=true}}else{v();t=true}if(t){u()}else{w.setInLoaded(false)}})};k.prototype.updateLoadedNodes=function(q,s){var o=this.unloadManager;o.beforeLoadedNodesQueueTraversal();if(o.isUnloadNeeded()){this.loadedNodesQueue.resetOrder(function(u){var t=u.isAlive()&&u.isUnloadable();if(!t){u.setInLoaded(false)}return t});var p=false;var r=this;this.loadedNodesQueue.traverseMinPlus(function n(x,v,u){var t=false,w=x.handler;if(x.isLocked()){t=true}else{if(x.isAlive()&&!x.isUnloaded()){if(o.isUnloadNeeded(w.type)&&x.toUnload){if(!x.isUnloadLocked()){p=true;if(!r.unloadNode(x,s)){t=true}}else{t=true}}else{if(x.toUnload&&!o.hasUnloadAlways){v()}t=true}}}if(t){u()}else{x.setInLoaded(false)}});if(p){this.onReferenceUnloaded()}}if(q){this.loadedNodesQueue.cleanNulls()}};k.prototype.onReferenceUnloaded=function(){this.queues[0].onReferenceUnloaded();this.queues[1].onReferenceUnloaded()};k.prototype.unloadNode=function(o,p){if(!o.isUnloadable(true)){return false}o.removeFromSceneGraph();if(o.isInList()){var n=o.getLDHNodeManagerQueue();n.onNodeToRemoveFromList()}o.setStatus(i.incomplete);this.unexpandNode(o);o.toUnload=false;o.setUnloadViewpointTag(this.viewpointTag);this.handleUnloadedNodeParents(o,p);return true};k.prototype.handleUnloadedNodeParents=function(o,p){var n;for(n=0;n<o.parents.length;n++){this.unloadNodeParentIfPossible(o.parents[n],p)}};k.prototype.unloadNodeParentIfPossible=function(n,p){if(!n.isUnloadLocked()&&n._status===i.complete){var o=1;if(!n.isForced()){o=n.computeLODValue(p)}if(o===0){this.unloadNode(n,p)}}};k.prototype.unexpandNode=function(q){var o,r,p,n;for(o=0;o<q.children.length;o++){n=q.children[o];r=n.reference;p=n.instanceId;r.removeParent(q);this.oocManager._unregisterInstance(p);if(r.parents.length===0&&r.isAlive()){this.oocManager._unregisterReference(r.referenceId)}}q.setStatus(i.incomplete);q.setUnloadStatus(m.unloaded);q.children=[];q.updateParentsStatus();q.updateMemorySize()};k.prototype.setOnStartLoadingCB=function(n){this.onStartLoadingCB=n};k.prototype.setOnEndLoadingCB=function(n){this.onEndLoadingCB=n};k.prototype.forceClean=function(){var n;for(n=0;n<this.queues.length;n++){this.queues[n].forceClean()}this.loadedNodesQueue.traverseMinPlus(function(q,p,o){if(q.isAlive()){o()}});this.loadedNodesQueue.cleanNulls(true)};k.prototype.onInstRefGraphTransactionEnd=function(r){var q,o,p,t;for(q=0;q<r.length;q++){o=r[q];if(o.expectedNbChildren!==-1){if(o.children.length===o.expectedNbChildren){o.setStatus(i.complete)}else{if(o.children.length>o.expectedNbChildren){console.log("Nb expected children inconsistency")}}}}var n=null,s;for(q=0;q<r.length;q++){o=r[q];s=o.isFrozen();o.updateUnloadStatus();o.updateParentsStatus();o.updateMemorySize();o._onLoaded();if(o.isFrozen()&&!s&&o.isInList()){n=this.queues[o.handler.type];n.onNodeToRemoveFromList()}if(o.isUnloadable()){this.addLoadedNode(o)}}this.tryBuildSceneGraphHierarchy()};k.prototype.fillDebugJSON=function(n){n.references={Model3DHandler:[],InstRefHandler:[]};this.queues[0].fillDebugArray(n.references.Model3DHandler);this.queues[1].fillDebugArray(n.references.InstRefHandler);return n};k.prototype.setPauseLoading=function(n){this.pauseLoading=n};k.prototype.registerOverrideSet=function(n){if(!this.overrideSetManager){this.overrideSetManager=this.viewer.getSceneGraphOverrideSetManager()}if(!this.overrideSetMap[n]){this.overrideSetMap[n]=new h(this.targetNode);this.overrideSetManager.pushSceneGraphOverrideSet(this.overrideSetMap[n])}};k.prototype.removeOverrideSet=function(o){var n=this.overrideSetMap[o];if(n){this.overrideSetManager.removeSceneGraphOverrideSet(n);delete this.overrideSetMap[o]}};k.prototype.getOverrideSet=function(n){return this.overrideSetMap[n]};k.prototype.getOverrideSetManager=function(){return this.overrideSetManager};k.prototype.addUserQueue=function(r){var q;for(q=0;q<this.userQueues.length;q++){if(this.userQueues[q].handler===r){throw new Error("duplicate handler")}}var o=r.getParams?r.getParams():{};var x=o.addLeaves===undefined?true:o.addLeaves;var v=o.addIntermediateNodes===undefined?false:o.addIntermediateNodes;var n=new f(r,this);var u=new Set();var s=this.queues[0];var p,w;for(q=0;q<s.nodes.length;q++){p=s.nodes[q];if(p){if(v){if(!u.has(p)){p.traverseParents(function(y){u.add(y);n.addNode(y)},u)}}else{n.addNode(p)}}}var t=this.createViewpointData(this.viewer.currentViewpoint);n.computeOrder(t);this.requestUpdate(false,false);this.userQueues.push(n)};k.prototype.removeUserQueue=function(n){var o;for(o=this.userQueues.length-1;o>=0;o--){if(this.userQueues[o].handler===n){this.userQueues.splice(o,1)}}};k.prototype.setCandidateQueueRendererParams=function(n,p){if(!n){if(this.queueRenderer){this.queueRenderer.dispose();this.queueRenderer=null;this.viewer.render({budgeted:true})}}else{var o=this.queueRenderer;if(!o){o=new j(this,p.rootNode);this.queueRenderer=o;this.queueRenderer.setPickable(this.oocManager._loadingBoxesPickable)}if(p.preserveSelection!==undefined){this.queueRenderer.preserveSelection=p.preserveSelection}o.setParams(p)}this.requestUpdate(false,false)};k.prototype.updateCandidateQueueRenderer=function(o){var n=this.queueRenderer;var q=this.viewer.currentViewpoint.camera.position;if(n){var p=Date.now();if(p-this.lastQueueRendererUpdateTime>500||o){this.lastQueueRendererUpdateTime=p;n.updateRepresentation(q);this.viewer.render({budgeted:true})}}};k.prototype.isForceSceneMinEnabled=function(){return this.viewer._forceSceneMinValue!==null};k.prototype.emergencyUnloadNodes=function(q){if(this.unloadManager.isEmergencyUnloadRequired()){this.emergencyUnloadOccured=true;var p=this,o=false;this.loadedNodesQueue.traverseMinPlus(function n(v,t,s){if(p.unloadManager.isEmergencyUnloadRequired()){var r=false,u=v.handler;if(u.type===0){if(v.isLocked()){r=true}else{if(v.isAlive()&&!v.isUnloaded()){if(!v.isUnloadLocked()){o=true;if(!p.unloadNode(v,q)){r=true}}else{r=true}}}}else{r=true}if(r){s()}else{v.setInLoaded(false)}}else{s();t()}});if(o){this.onReferenceUnloaded()}}};return k});define("DS/3DXMTiles/OOCManager",["DS/3DXMTiles/LDHNodeManager","DS/3DXMTiles/OOCManagerEntry","DS/3DXMTiles/LDHOccurrence","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/UnloadManager","DS/3DXMTiles/OOCReferenceIterator","DS/3DXMTiles/OOCManagerRootEntry","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/VisuTools/FPSCounter","DS/Mesh/MeshUtils"],function(i,a,k,r,n,e,b,g,l,o,q,j,d){var m=1;var p=function(t,s){s=s||{};c();this._config=s.config||"v0";this._ldhNodeManager=new i(t,this,this._config);this._ldhNodeManager.unloadManager.setFlashMode(true);if(s.unloadSmallNodes!==undefined){this._ldhNodeManager.setUnloadSmallNodesEnabled(s.unloadSmallNodes?true:false)}this._referenceTos=new Map();this._instanceTos=new Map();this._rootOccurrenceTos=new Map();this._instRefGraphTransaction=null;this._forceSceneMin=s.forceSceneMin?true:false;this._loadingBoxesPickable=d.PICKABLE;this._overrideSetMap=new Map()};p.prototype.setTargetNode=function(s){this._ldhNodeManager.setTargetNode(s)};p.prototype.registerReference=function(u,t){var s=this._getOOCEntry(u,true);if(!s){s=new a(u,{manager:this,handler:t.handler.ldhHandler,boundingSphere:t.boundingSphere||null,boundingBox:t.boundingBox||null,url:t.url,loadModelOptions:t.loadModelOptions});this._ldhNodeManager.registerTilesNode(s.reference);this._referenceTos.set(u,s)}else{}};p.prototype.setOverrideCB=function(w,t,v){if(v===undefined){console.warn("Calling setOverrideCB(...) without 3rd argument is deprecated");v="#undefined#";this.registerOverrideSet(v)}var u=this._overrideSetMap.get(v);if(u){var s=this._getLDHReference(w);s.setOverrideCB(v,t);u.add(w)}};p.prototype.hasOverrideCB=function(v,u){var t=this._overrideSetMap.get(u);if(t){var s=this._getLDHReference(v);return(s.hasOverrideCB(u)?true:false)}return false};p.prototype.registerOverrideSet=function(s){if(s!=="#undefined#"){this._ldhNodeManager.registerOverrideSet(s);if(!this._overrideSetMap.has(s)){this._overrideSetMap.set(s,new Set())}}};p.prototype.clearOverrideSet=function(u){if(u!=="#undefined#"){var t=this._overrideSetMap.get(u);var s=this;if(t){t.forEach(function(w){var v=s._getLDHReference(w,true);if(v){v.setOverrideCB(u,null)}})}}};p.prototype.removeOverrideSet=function(s){if(s!=="#undefined#"){this.clearOverrideSet(s);this._ldhNodeManager.removeOverrideSet(s);this._overrideSetMap["delete"](s)}};p.prototype.registerLeafReference=function(u,t){var s=this._getOOCEntry(u,true);if(!s){var v=t.node.getModelIdentification();if(v&&this.isRegistered(v)){throw new Error("illegal node: used for another OOC reference")}s=new a(u,{manager:this,handler:t.handler.ldhHandler,boundingSphere:t.boundingSphere||null,boundingBox:t.boundingBox||null,node:t.node,url:t.url,leaf:true});s.reference.setExpectedNbChildren(0);this._ldhNodeManager.registerTilesNode(s.reference);this._referenceTos.set(u,s)}};p.prototype.unregisterLeafReference=function(v){var u=this._getOOCEntry(v);var s=u.reference;if(s.isSlave()){var t=s.getLDHNodeManagerQueue();t.onNodeToRemoveFromList();this._ldhNodeManager.unloadLeafReferenceCB&&this._ldhNodeManager.unloadLeafReferenceCB(v);s.node=null;this._unregisterReference(v)}};p.prototype.setUnloadLeafReferenceCB=function(s){this._ldhNodeManager.unloadLeafReferenceCB=s};p.prototype.setOnLeafReferenceLoadedCB=function(s){this._ldhNodeManager.onLeafReferenceLoadedCB=s};p.prototype.isRegistered=function(v,u){var t=this._getOOCEntry(v,true)===null?false:true;var s=s=(this._instanceTos.get(v)?true:false);return t||(!u&&s)};p.prototype.addRoot=function(v,w){this._rootOccurrenceTos.forEach(function(A,z,B){if(A.occurrence.reference.referenceId===v){throw new Error("Multiple occurrences for root are unsupported")}});var s=this._getLDHReference(v);var u=new Set();var y=new k({reference:s,manager:s.manager,instanceId:w.instanceId},u);u.forEach(function(z){z.updateOverride()});var x=m;var t=new b(y,w.boundingBox);this._rootOccurrenceTos.set(x,t);m++;if(this._forceSceneMin){this._updateSceneMin()}s.setIsRoot(true);return x};p.prototype.getReframeBoundingSphere=function(){var t=this.getRootOccurrences();var s=new q.Sphere();t.forEach(function(y,x,z){var A=y.occurrence;var u=A.reference;var w=u.getBoundingSphere(true).clone();w.applyMatrix4(A.matrix);var v=s.clone();w.mergeWithSphere(s,v);s=v});return s};p.prototype.removeRoot=function(z){var y=this._rootOccurrenceTos.get(z);var s=y&&y.occurrence;var B=s.reference;B.setIsRoot(false);var A=B.buildFlatList();s.detach();var x,w,t;for(x=0;x<A.length;x++){var u=A[x];u._removeNullsFromOccurrenceList();if(u._isDetachPossible()){for(w=0;w<u.children.length;w++){t=u.children[w];this._instanceTos["delete"](t.instanceId)}u._detach();this._unregisterReference(u.referenceId)}}this._ldhNodeManager.removeRemovedNodes();this._ldhNodeManager.requestUpdate(true,true);this._rootOccurrenceTos["delete"](z);if(this._forceSceneMin){this._updateSceneMin()}var v=this;this._overrideSetMap.forEach(function(D,F,G){var E=[];D.forEach(function(I){var H=v._getLDHReference(I,true);if(!H){E.push(I)}});var C;for(C=0;C<E.length;C++){D["delete"](E[C])}})};p.prototype.createReferenceIterator=function(u){var s=this._getLDHReference(u,true);var t=s&&new e(s);return t};p.prototype._unregisterReference=function(t){var s=this._getLDHReference(t,true);if(s){if(s.children.length>0){console.log("_unregisterReference internal error")}if(s){s.setStatus(r.dead);this._ldhNodeManager.unregisterNode(s);s.updateMemorySize();this._ldhNodeManager.unloadManager.onReferenceMemoryChange(-s.memorySize,-s.memorySizeGPU)}this._referenceTos["delete"](t)}};p.prototype._unregisterInstance=function(s){this._instanceTos["delete"](s)};p.prototype.addChild=function(w,y,x){var s=this._getLDHReference(w,true);if(s){var v=this._getLDHReference(y);var u=x.instanceId;var t=new Set();if(!this._instanceTos.get(u)){s.addReferenceChild(v,x.matrix||null,u,t);if(u){this._instanceTos.set(u,s)}}if(this._instRefGraphTransaction!==null){this._instRefGraphTransaction.onAddChild(w)}this._ldhNodeManager.tryBuildSceneGraphHierarchy();t.forEach(function(z){z.updateOverride()});if(v.comesFromWrap()){this._ldhNodeManager.addWrapStatusToUpdate(v)}}};p.prototype._onRepLoaded=function(s){if(this._instRefGraphTransaction!==null){this._instRefGraphTransaction.onAddChild(s)}};p.prototype.getReferenceUrl=function(t){var s=this._getLDHReference(t);return s.url};p.prototype.getReferenceBoundingSphere=function(t){var s=this._getLDHReference(t);return s._boundingSphere&&s._boundingSphere.clone()};p.prototype._getOOCEntry=function(u,s){var t=this._referenceTos.get(u);if(!s&&!t){throw new Error("Unknown OOC referenceId: '"+u+"'")}return t||null};p.prototype._getLDHReference=function(u,s){var t=this._getOOCEntry(u,s);return t?t.reference:null};p.prototype.getSceneGraphNode=function(v){var s=this._getLDHReference(v,true);if(s){return s.node}else{s=this._instanceTos.get(v);if(s){var t;for(t=0;t<s.children.length;t++){var u=s.children[t];if(u.instanceId===v){return u.node}}}}return null};p.prototype.forceReferenceLoad=function(v,u){var t=this;var s=t._getLDHReference(v,true);if(s){t._ldhNodeManager.requestUpdate(true,true);s.forceLoad(true,u)}};p.prototype.setForceReferenceLoad=function(w,t,v){var u=this;var s=u._getLDHReference(w,true);if(s){s.forceLoad(w,t?true:false,v);u._ldhNodeManager.forceUpdateNode(s)}};p.prototype.setUserData=function(x,t){var v=false;var s=this._getLDHReference(x,true);if(s){s.userData=t;v=true;if(s.node){s.node.setUserData(t)}}else{s=this._instanceTos.get(x);if(s){var u;for(u=0;u<s.children.length;u++){var w=s.children[u];if(w.instanceId===x){w.userData=t;v=true;if(w.node){w.node.setUserData(t)}}}}}if(!v){throw new Error("unknown id")}};p.prototype.getUserData=function(v){var s=this._getLDHReference(v,true);if(s){return s.userData}else{s=this._instanceTos.get(v);if(s){var t;for(t=0;t<s.children.length;t++){var u=s.children[t];if(u.instanceId===v){return u.userData}}}}throw new Error("unknown id")};p.prototype.setOnStartLoadingCB=function(s){this._ldhNodeManager.setOnStartLoadingCB(s)};p.prototype.setOnEndLoadingCB=function(s){this._ldhNodeManager.setOnEndLoadingCB(s)};p.prototype.setOnAddedToSceneGraphCB=function(u,t){var s=this._getLDHReference(u);s.setOnAddedToSceneGraphCB(t)};p.prototype.setOnRemovedFromSceneGraphCB=function(u,t){var s=this._getLDHReference(u);s.setOnRemovedFromSceneGraphCB(t)};p.prototype.getAllReferences=function(){var s=[];this._referenceTos.forEach(function(u,t,v){s.push(t)});return s};p.prototype.switchLOD=function(w,t,u){var s=this._getLDHReference(w);var v=this._ldhNodeManager;this._ldhNodeManager.executeReferenceAction([s],function(z,B){var A,y,x=0;function C(){x--;if(x===0&&u){u();u=null}}for(y=0;y<z.length;y++){var A=z[y];if(!A.toUnload&&!A.shouldBeExpanded()){x++;A.addOnLoadedCB(C)}A.url=t;A.removeFromSceneGraph(true);A.updateMemorySize();A.setStatus(r.incomplete);v.registerTilesNode(A)}if(x===0){setTimeout(u,1)}B()})};p.prototype.setExpectedNbChildren=function(t,u){var s=this._getLDHReference(t,true);if(s){s.setExpectedNbChildren(u)}};p.prototype.getExpectedNbChildren=function(t){var s=this._getLDHReference(t,true);if(s){return s.expectedNbChildren}else{return -1}};p.prototype.getNbChildren=function(t){var s=this._getLDHReference(t);return s.children.length};p.prototype.isReferenceComplete=function(t){var s=this._getLDHReference(t,true);return s!==null&&s.isComplete()};p.prototype.dumpAllMemorySize=function(s){this._referenceTos.forEach(function(u,w,v){var t=u.reference;if(s){t.updateMemorySize()}console.log(w+" "+t.memorySize)});console.log("TOTAL "+this._ldhNodeManager.unloadManager.memoryUsage)};p.prototype.lockChildren=function(t){var s=this._getLDHReference(t);s.lockChildren()};p.prototype.unlockChildren=function(t){var s=this._getLDHReference(t);s.unlockChildren();this._ldhNodeManager.requestUpdate(true,true)};p.prototype.startInstRefGraphTransaction=function(){if(this._instRefGraphTransaction){console.log("ERROR - A transaction already exists")}this._instRefGraphTransaction=new h()};p.prototype.endInstRefGraphTransaction=function(){this._instRefGraphTransaction.endTransaction(this);this._instRefGraphTransaction=null};p.prototype.addSceneGraphLock=function(t){var s=this._getLDHReference(t,true);s.requestBuildSceneGraphHierarchy(true);s.userLockUnload();this._ldhNodeManager.tryBuildSceneGraphHierarchy()};p.prototype.removeSceneGraphLock=function(t){var s=this._getLDHReference(t,true);s.userUnlockUnload()};p.prototype.isSceneGraphLocked=function(t){var s=this.getSceneGraphLockCounter(t);return s>0};p.prototype.getSceneGraphLockCounter=function(t){var s=this._getLDHReference(t,false);if(s._optional){return s._optional.userLockUnload}else{return 0}};p.prototype.getRootOccurrences=function(){return this._rootOccurrenceTos};p.prototype._checkConsistency=function(){var s=this.getRootOccurrences();s.forEach(function(v,u,w){var t=v.occurrence.reference;t.checkConsistency(true)})};p.prototype._getDebugJSON=function(){var s={references:{},roots:[]};this._referenceTos.forEach(function(u,t,v){s.references[t]=u.reference.buildDebugJSON(true)});this._rootOccurrenceTos.forEach(function(u,t,v){var w=u.occurrence;s.roots.push(w.reference.referenceId)});return s};p.prototype._getReferenceDebugJSON=function(t){var s=this._getLDHReference(t,true);if(s){return s.buildDebugJSON()}return null};p.prototype._getAllInstancesDebugJSON=function(){var t={};var s=this;this._instanceTos.forEach(function(u,w,x){var v,y;for(v=0;v<u.children.length;v++){y=u.children[v];if(y.instanceId===w){t[w]={parent:u.referenceId,child:y.reference.referenceId}}}});return t};p.prototype._getSingleInstanceDebugJSON=function(v){var u={};var s=this._instanceTos.get(v);if(s){var t,w;for(t=0;t<s.children.length;t++){w=s.children[t];if(w.instanceId===v){return{instanceId:v,parent:s.referenceId,child:w.reference.referenceId}}}}return null};p.prototype.setPauseLoading=function(s){this._ldhNodeManager.setPauseLoading(s);if(!s){this._ldhNodeManager.requestUpdate(true,true)}};p.prototype.setReferenceLoadModelOptions=function(u,t){var s=this._getLDHReference(u);s.setLoadModelOptions(t)};p.prototype.getReferenceLoadModelOptions=function(t){var s=this._getLDHReference(t);return s._optional&&s._optional.loadModelOptions};p.prototype.setPerformancesOptions=function(s){if(s.fullAlwaysUnload){this._ldhNodeManager.unloadManager.setUnloadAlwaysTab([true,true])}if(s.repAlwaysUnload){this._ldhNodeManager.unloadManager.setUnloadAlwaysTab([true,false])}if(s.noAlwaysUnload){this._ldhNodeManager.unloadManager.setUnloadAlwaysTab([false,false])}if(s.pauseLoadingDuringViewpointMove!==undefined){this._ldhNodeManager.setPauseLoadingDuringViewpointMove(s.pauseLoadingDuringViewpointMove?true:false)}};p.prototype.getWorldMatrix=function(A,D){var B=this._rootOccurrenceTos.get(A).occurrence,w=B.reference;var y,t;var y,w,z,x,v,s,u;for(y=1;y<D.length;y+=2){u=B.getChildren();var x,C=false;for(x=0;x<u.length;x++){if(u[x].instanceId===D[y]){B=u[x];C=true}}if(!C){throw new Error("inconsistent path")}}return B.matrix.clone()};p.prototype.addUserQueue=function(s){this._ldhNodeManager.addUserQueue(s)};p.prototype.removeUserQueue=function(s){this._ldhNodeManager.removeUserQueue(s)};p.prototype.setCandidateQueueRendererParams=function(s,t){this._ldhNodeManager.setCandidateQueueRendererParams(s,t)};p.prototype.setExpandAllowed=function(t,s){this.setComesFromWrap(t,!s)};p.prototype.setComesFromWrap=function(v,t){var s=this._getLDHReference(v);s.setComesFromWrap(t);if(!t){this._ldhNodeManager.addWrapStatusToUpdate(s)}var u;for(u=0;u<s.parents.length;u++){this._ldhNodeManager.addWrapStatusToUpdate(s.parents[u])}if(!t){this._ldhNodeManager.requestUpdate(false,false)}};p.prototype._updateSceneMin=function(){var u=0;var s=false;this._rootOccurrenceTos.forEach(function(w,v,y){if(w.boundingBox){var x=w.computeSceneMin();if(!s||x<u){u=x;s=true}}});if(s){var t=this._ldhNodeManager.viewer;t._forceSceneMin(u);t.render({updateInfinitePlane:true})}};p.prototype.getSelectedPath=function(w){w=w||"hso";var A={hso:g,pso:l,cso:o};var x=A[w];var s=x.get();var C=[],y,t,v,B,u=[],z;for(y=0;y<s.length;y++){t=s[y].pathElement;if(t.instanceId!==undefined&&this._ldhNodeManager.queueRenderer){C=this._ldhNodeManager.queueRenderer.getPathFromPathElement(t)}else{C=f(t)}u.push(C)}if(u&&u.length===1){return u[0]}else{return u}};p.prototype.getSelectedReference=function(w){w=w||"hso";var A={hso:g,pso:l,cso:o};var x=A[w];var s=x.get();var y,t,v,B,u=[],z,C,D;for(y=0;y<s.length;y++){t=s[y].pathElement;if(t.instanceId!==undefined&&this._ldhNodeManager.queueRenderer){D=this._ldhNodeManager.queueRenderer.getReferenceFromPathElement(t)}else{C=f(t);D=C[C.length-1];if(!this.isRegistered(D,true)){D=null}}u.push(D)}if(u&&u.length===1){return u[0]}else{return u}};p.prototype.setMaxNbExpectedChildrenPerRequest=function(s){this._ldhNodeManager.setMaxNbExpectedChildrenPerRequest(s)};p.prototype.setLoadingBoxesPickable=function(s){this._loadingBoxesPickable=s;if(this._ldhNodeManager.queueRenderer){this._ldhNodeManager.queueRenderer.setPickable(s)}};function f(u){var t,s=[],v,w;for(t=0;t<u.externalPath.length;t++){v=u.externalPath[t];w=v.getModelIdentification();if(w){s.push(w)}}return s}var h=function(){this.updatedRefencesMap=new Map()};h.prototype.onAddChild=function(s){this.updatedRefencesMap.set(s,true)};h.prototype.endTransaction=function(t){var s=[];this.updatedRefencesMap.forEach(function(w,v,x){var u=t._getLDHReference(v,true);if(u){s.push(u)}});t._ldhNodeManager.onInstRefGraphTransactionEnd(s)};function c(){var s=window.localStorage.getItem("OOCDebug");if(s){var u=JSON.parse(s);var t;for(t in u){window[t]=u[t]}}}return p});define("DS/3DXMTiles/LDHModel3DHandler",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/ModelLoaderPool","DS/3DXMTiles/ModelLoaderPoolParams","DS/3DXMTiles/LDHReferenceStatus"],function(b,a,c,e){var d=function(){b.call(this,b.Model3DHandler);this.fileType=null;this.redirectUrlCB=null;this.loadModelOptions=null};d.prototype=Object.create(b.prototype);d.prototype.setFileType=function(f){this.fileType=f};d.prototype.isReady=function(){return a.nbTickets>=20};d.prototype.setLoadModelOptions=function(f){this.loadModelOptions=f};d.prototype.handleReferences=function(h,g){var k=new c();var f;for(f=0;f<h.length;f++){k.addFromNode(h[f],"")}if(this.redirectUrlCB){var j=this;a.beforeLoadParams(k);this.redirectUrlCB(k.urlArray,function(i){k.urlArray=i.concat([]);j.loadParams(h,k,g)})}else{a.beforeLoadParams(k);this.loadParams(h,k,g)}};d.prototype.loadParams=function(g,h,f){a.loadParams(h,this.onLoadedModel.bind(this,g,f),this.onErrorModel.bind(this,g,f),null,this.fileType,this.loadModelOptions)};d.prototype.onLoadedModel=function(j,h){h.manager.startInstRefGraphTransaction();var g,f;for(g=0;g<j.length;g++){f=j[g];h.manager._onRepLoaded(f.referenceId)}h.manager.endInstRefGraphTransaction();h.doneCB(j)};d.prototype.onErrorModel=function(g,f){f.doneCB(null,g)};d.prototype.getModelLoader=function(){return a.modelLoader};d.prototype.getBatchSize=function(){return a.nbTickets};d.prototype.setRedirectUrlCB=function(f){this.redirectUrlCB=f};return d});define("DS/3DXMTiles/OOCModel3DHandler",["DS/3DXMTiles/OOCHandler","DS/3DXMTiles/LDHModel3DHandler","DS/3DXMTiles/LDHModel3DHandler2"],function(d,c,b){var a=function(e){e=e||{};d.call(this,d.Model3DHandler,e.v1?new c():new b(e))};a.prototype=Object.create(d.prototype);a.prototype.setFileType=function(e){this.ldhHandler.setFileType(e)};a.prototype.setLoadModelOptions=function(e){this.ldhHandler.setLoadModelOptions(e)};a.prototype.getModelLoader=function(){return this.ldhHandler.getModelLoader()};a.prototype.setRedirectUrlCB=function(e){this.ldhHandler.setRedirectUrlCB(e)};return a});