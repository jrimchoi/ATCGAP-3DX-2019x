define("DS/GEONavDriveAPI/GEOdriveServices",["UWA/Core","DS/VisuDataAccess/ProxyAbstraction","DS/Visualization/Utils","DS/WAFData/WAFData","DS/GEONavCommonAPI/GEONavCommonServices"],function(f,e,d,a,c){var b={callDriveService:function(h,j,i){var g=UWA.clone(h);g.serviceName="3DDrive";c.callService(g,j,i)},getObject:function(g,j,h){var i=this;i.callDriveService({URI:"/resources/3ddrive/v1/bos/"+g.objectId,envId:g.envId},j,function(l){console.log(l.message);var k={message:"GEOdriveServices: Impossible to retrieve the object from the PhysicalID : "+g.objectId};h(k)})},getObjectIDFromPath:function(g,i,l,h){var k=this;var j=new RegExp("[\\\\\\/]+","g");var m=i.split(j);if(m.length){if(m[0]!="."){m.unshift(".")}}return k.getObjectIDFromPathArray(g,m,l,function(o){console.log(o.message);var n={message:"GEOdriveServices: Impossible to retrieve the object from the target path : "+i};h(n)})},getObjectIDFromPathArray:function(g,j,l,i){var k=this;if(j.length){var h=j[0];if(h==".."||h=="."){k.getParent(g,function(n){var m=j.slice(1);if(m.length){k.getObjectIDFromPathArray({objectId:n,envId:g.envId},m,l,i)}else{l(n)}},i)}else{k.searchInContent(g,{title:h},function(m){var n=j.slice(1);if(n.length){k.getObjectIDFromPathArray({objectId:m,envId:g.envId},n,l,i)}else{l(m)}},i)}}},getContent:function(g,j,h){var i=this;i.callDriveService({URI:"/resources/3ddrive/v1/bos/"+g.objectId+"/contents",envId:g.envId},j,function(l){console.log(l.message);var k={message:"GEOdriveServices: Impossible to get the content of the directory : "+g.objectId};h(k)})},getDownloadURL:function(g,j,h){var i=this;i.callDriveService({URI:"/resources/3ddrive/v1/bos/"+g.objectId+"/fileurl",envId:g.envId},j,function(l){console.log(l.message);var k={message:"GEOdriveServices: Impossible to get the URL to download the file linked to item : "+g.objectId};h(k)})},getParent:function(g,j,h){var i=this;i.getObject(g,function(l){if(l&&l.parentid){j(l.parentid)}else{var k={message:"GEOdriveServices: No Parent directory has been found for the item : "+g.id};h(k)}},h)},searchInContent:function(i,h,l,j){var k=this;var g={message:"GEOdriveServices: The searched criteria has not been found in directory : "+i.objectId,criteria:h};k.getContent(i,function(n){if(n.items){var m;m=n.items.filter(function(o){var q=true;for(var p in h){var r=h[p];if(!o[p]||o[p]!=r){q=false;break}}return q});if(m&&m.length){l(m[0].id)}else{j(g)}}},function(m){console.log(m.message);j(g)})},getURLFromPath:function(h,j,l,i){var k=this;var g={message:"GEOdriveServices: Impossible to get the URL to download the file :"+j+" linked to item : "+h.objectId};k.getObjectIDFromPath(h,j,function(m){k.getDownloadURL({objectId:m,envId:h.envId},function(n){l(n)},function(n){console.log(n.message);i(g)})},function(m){console.log(m.message);i(g)})},findFileURL:function(i,q,g,h){var k=this;var o=q.serverurl?q.serverurl:"";o+=q.filename?q.filename:"";var m;if(q!==undefined&&q.physicalid!==undefined){m=q.physicalid}if(m===undefined&&q.originalAsset!==undefined){if(q.originalAsset.provider==="3DDRIVE"){m=q.originalAsset.physicalid}}if(m!==undefined){k.getURLFromPath({objectId:m,envId:q.tenant},i,function(r){g(r.url)},h)}else{var l=(q.serverurl?q.serverurl:"")+(q.filename?q.filename:"");var j=l.slice(0,l.lastIndexOf("/")+1)+i;var n=JSON.stringify(q);var p=JSON.parse(n);p.serverurl="";p.filename=j;g(p)}return},getTicket:function(g,k,h){var j=this;var i="/resources/3ddrive/v1/bos/ticket?tenant="+j.getTenant();j.callDriveService({URI:i,envId:g.envId},k,function(m){console.log(m.message);var l={message:"GEOdriveServices: Impossible to get fcsTicket : "};h(l)})},uploadDocument:function(i,n,k){var l=this;var j;if(i.file){j=i.file}else{if(i.blob){try{j=new File([i.blob],i.filename,{type:i.blob.type,lastModified:Date.now()})}catch(m){var h=new Blob([i.blob],{type:i.blob.type});h.name=i.filename;h.lastModified=Date.now();h.lastModifiedDate=new Date(h.lastModified).toString();j=h}}}if(j){l.getTicket(i,function(o){var p=new FormData();p.append(o.jobticket,o.ticket);p.append("file_0",j);p.append("file-name",j.name);p.append("file-title",j.name);p.append("file-description",j.name);c.callFCSService({actionurl:o.actionurl,requestOptions:{method:"POST",data:p}},function(r){var u,t;var x=new DOMParser();var w=x.parseFromString(r,"text/html");t=w.querySelectorAll('[name="__fcs__jobReceipt"]')[0].attributes.value;var q={description:"",file:j.name,receipt:t.value,title:j.name,type:"Document"};var s=JSON.stringify(q);var v="/resources/3ddrive/v1/bos/DSROOT/contents?tenant="+l.getTenant();l.callDriveService({URI:v,envId:i.envId,requestOptions:{method:"POST",data:s,headers:{"Content-Type":"application/json;charset=UTF-8"}}},n,function(z){console.log(z.message);var y={message:"GEOdriveServices: Impossible to create document "};k(y)})},function(r){console.log(r.message);var q={message:"GEOdriveServices: Impossible to get fcsTicket "};k(q)})},function(p){console.log(p.message);var o={message:"GEOdriveServices: Impossible to upload Document "};k(o)})}else{var g={message:"GEOdriveServices: bad arguments "};k(g)}},load:function(g,k,j,h){var i=this;i.loadUrl=function(m,p,o){var l=m.serverurl?m.serverurl:"";l+=m.filename?m.filename:"";if(m.provider&&m.provider=="FILE"){a.handleRequest(l,{method:"GET",withCredentials:true,type:"arraybuffer",timeout:250000,onComplete:p,onFailure:o,onTimeout:o,proxy:"none"})}else{var n=new e();d.setProxyFromSpec(m,n);n.executeGetHttpRequest(l,"arraybuffer",null,p,o)}};if(k.length){if(k[0]=="\\"||k[0]=="/"){k="."+k}i.findFileURL(k,g,function(l){var m;if(g){m=g.physicalid;if(m===undefined&&g.originalAsset!==undefined){m=g.originalAsset.physicalid}}if(m!==undefined){a.handleRequest(l,{method:"GET",withCredentials:true,type:"arraybuffer",timeout:250000,onComplete:j,onFailure:h,onTimeout:h,proxy:"none"})}else{i.loadUrl(l,j,h)}},h)}else{i.loadUrl(g,j,h)}},getTenant:function(){return widget.getValue("x3dPlatformId")}};return b});