define("DS/3DPlayExperienceModule/VisuDataAccess/Ox4PlanRunner",["DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(a){var b=function(i,d,g,h,q,o){var l=function(){this.SetName=g;this.executePostHttpRequest=function(t,r,w,v){var s=new a();var u="application/xml";if(typeof(r)==="boolean"&&r){u="application/xmql"}s.executePostHttpRequest(t,u,w,v)}};var f=d;var n=i;var k=new l(g);var j=q;var p=o;var c=function(r){if(h!==null){var s=(i.currentTaskIndex()/i.tasksCount())*100;h(s)}var t=i.next();if(t==null){e()}else{t[0].run(f,k,h,c,o)}};var e=function(){};this.executePlan=function(){var r=n.next();r[0].run(f,k,null,c,null)}};return b});define("DS/3DPlayExperienceModule/Ox4PlanRunner",["DS/3DPlayExperienceModule/VisuDataAccess/Ox4PlanRunner"],function(a){return a});define("DS/3DPlayExperienceModule/VisuDataAccess/Ox4TreeTarget",[],function(){var a=function(e,c){var b={};var d=e;c[d.physicalid].id=d.physicalid;var f=c[d.physicalid];f.ident=d.physicalid;f.isrel=false;if(d.dtype!=null){f.plmtype=d.dtype}this.FindRootNodeWorkType=function(){if(d.typeHelper.IsBusA(f.plmtype,d.shapeType)){f.worktype=d.shapeType}else{if(d.typeHelper.IsBusA(f.plmtype,"VPMReference")){f.worktype="VPMReference"}}b[f.plmtype]=[f];if(f.worktype!==f.plmtype){b[f.worktype]=[f]}};this.rootNode=function(){return f};this.registerRelationship=function(i){var h=this.findNodeByPhysicalId(i.phyid);if(h){h.boid=i.ident;h.id=i.phyid;h.plmtype=i.plmtype;h.worktype=i.plmtype;h.title=i.title;h.plmexternalId=i.realName;h.owner=i.owner;h.isrel=true;var g=this.findNodeByPhysicalId(i.to.phyid);if(g){g.boid=i.to.ident;g.id=i.to.phyid;g.plmtype=i.to.plmtype;g.worktype=g.plmtype;g.title=i.to.title;g.plmexternalId=i.to.realName;g.owner=i.to.owner;g.isrel=false;i.from.add(h)}h.add(g)}};this.countObjects=function(){var h=0;for(var g in c){if(c.hasOwnProperty(g)){h++}}return h};this.dumpObjects=function(){var h=0;for(var g in c){if(c.hasOwnProperty(g)){console.log(c[g])}}return h};this.FindWorkTypes=function(g,h){d.typeHelper.RegisterParentsTypes(g,function(){for(var k in c){if(c[k]){if(c[k].isrel){if(d.typeHelper.IsRelA(c[k].plmtype,d.instanceType)){c[k].worktype=d.instanceType}}else{if(d.referenceType&&d.typeHelper.IsBusA(c[k].plmtype,d.referenceType)){c[k].worktype=d.referenceType}else{if(d.typeHelper.IsBusA(c[k].plmtype,d.shapeType)){c[k].worktype=d.shapeType}}}var i=c[k].plmtype;var j=c[k].worktype;if(!b.hasOwnProperty(i)){b[i]=[]}b[i].push(c[k]);if(j!==i){if(!b.hasOwnProperty(j)){b[j]=[]}b[j].push(c[k])}}}h()})};this.findNodeByPhysicalId=function(g){return c[g]};this.findNodeByType=function(g){var h=[];if(b.hasOwnProperty(g)){h=b[g]}return h};this.findNodeByPLMTypeExpressedAsPhyIdSeparatedByComma=function(g){var h=[];if(b.hasOwnProperty(g)){h=b[g]}var i="";h.forEach(function(k,j){i+=k.id;if(j<h.length-1){i+=","}});return i};this.findNodeByPLMTypeExpressedAsPhyIdAsJSON=function(h){var i=this.findNodeByType(h);var g=[];if(i.length>0){i.forEach(function(k,j){g.push(k.id)});return JSON.stringify(g)}else{return[]}}};return a});define("DS/3DPlayExperienceModule/Ox4TreeTarget",["DS/3DPlayExperienceModule/VisuDataAccess/Ox4TreeTarget"],function(a){return a});define("DS/3DPlayExperienceModule/VisuDataAccess/Ox4StreamUnStreamerTask",["DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(a){var b=function(g,c,d){var f=g;var e=c;this.run=function(p,h,l,r,q){var o=new a();var n=p.findNodeByType(f.typeRequested());var k=0;for(var j=0;j<n.length;j++){(function(w){var v=new Array();if(w.ticketRequest!=null){v.push(w.ticketRequest);delete w.ticketRequest}else{if(w.ticketRequests!=null){var s=w.ticketRequests;for(var u=0;u<s.length;u++){v.push(s[u])}}}f.streamsNumber(v.length);k+=v.length;for(var i=0;i<v.length;i++){if(!window.hasOwnProperty("ODTNoFCSCalls")||!window.ODTNoFCSCalls){var t=v[i].generateRequest();o.asyncTransformFCSUrlIntoRealUrl(t,e.rawmode,function(z,A){if(A.slice(0,8)=="posthttp"){var x=A.indexOf(":postparams:");var C=A.slice(9,x);var B=A.slice(x+12,A.length);var y=new Object();if(f.responseType!=null){console.log("registering otherParams reponsetype "+f.responseType);y.responseType=f.responseType}o.executePostHttpRequest2(C,"application/x-www-form-urlencoded",B,function(D){f.streamReceived(w,D,p,function(){if(--k==0){r(this)}})},y)}})}else{k--;f.streamReceived(w,null,p)}}})(n[j])}if(k==0){r(this);d()}}};return b});define("DS/3DPlayExperienceModule/Documents/CellViewDoc",["UWA/Core","DS/Layouts/GridEngineCellAbstract","DS/WebUtils/StringUtils","DS/UIKIT/Spinner"],function(d,c,b,a){return c.extend({defaultOptions:{},init:function(e){this._parent(e);var f=this;this._cellContent=new d.Element("div",{"class":"thumbnail"});this.callbk=function(g){if(f.clickAction){f.clickAction()}};this._cellContent.addEvent("click",this.callbk);this._thumbnail=new d.Element("div",{"class":"display"}).inject(this._cellContent);this._title=new d.Element("span",{"class":"title"}).inject(this._cellContent);this._cellContent.inject(this.elements.container);this.elements.container.setStyles({padding:10,border:"none"})},private_destroy:function(){this._cachedCellInfos=null;this._thumbnail.parentNode.removeChild(this._thumbnail);this._thumbnail.destroy&&this._thumbnail.destroy();this._thumbnail=null;this._cellContent.parentNode.removeChild(this._cellContent);this._cellContent.removeEvent("click",this.callbk);this._cellContent.destroy&&this._cellContent.destroy();this._cellContent=null;this.callbk=null;this._title.destroy&&this._title.destroy();this._title=null},reset:function(e){this._thumbnail.style.transition="none";this._cellContent.className="thumbnail";this.setFocus(e.focus);this.setTitle(e.title||"");this._thumbnail.innerHTML="";this._thumbnail.style.backgroundImage="";if(this.setError(e.error)===false){this.setThumbnail(e.thumbnail)}this._thumbnail.style.transition=""},setCallback:function(e){this.clickAction=e},setThumbnail:function(e){if(e===null||e===undefined||typeof e!=="string"||e===""){this._cellContent.addClassName("defaultThumbnail")}else{if(e==="AssetLoading"){if(this._spin===undefined){this._spin=new a();this._spin.inject(this._thumbnail);this._spin.show()}}else{if(this._spin){this._spin.remove();this._spin=undefined}var f=b.getExtension(this._title.getText());if(f==="mp4"||f==="webm"||f==="ogg"||f==="ogv"){this._thumbnail.outerHTML=e}else{this._thumbnail.style.backgroundImage="url('"+e+"')"}}}},setTitle:function(e){this._title.innerHTML=e},setFocus:function(e){if(e){this._cellContent.addClassName("focus")}else{this._cellContent.removeClassName("focus")}},setError:function(e){if(e&&typeof e==="string"){this._cellContent.addClassName(e);return true}return false}})});define("DS/3DPlayExperienceModule/PlayExperience3DScriptingPlugin",["DS/Visualization/PathElement","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/3DPlayUtils/VisibilityUtils","DS/Visualization/ThreeJS_DS","DS/ApplicationFrame/CommandsManager","DS/3DPlaySupport/SupportList"],function(f,d,b,e,j,a,i){var k={VPMReference:1,VPMInstance:1,VPMRepInstance:1,VPMRepReference:1,"3DShape":1,CATProduct:1,CATPart:1,Viewable:1,CgrViewable:1,Reference3D:1,Instance3D:1};var g=function(q){var n=q.getNodes();var o=q.getBagNode?q.getBagNode():null;var p=[];n.forEach(function(r){var s=new f();s.addElement(r);p.push(s)});return p};var h=function(s,r){var q=g(r);var o;var n=s.split("/");var p=function(u,t){if(u.length>0){u.forEach(function(z){var x=z.getLastElement();var y;if(x.getPersistentId!==undefined){if(x.productType=="Instance3D"||x.getPersistentId()==1){y=x.getPersistentId();if(y==t[0]){t.splice(0,1);o=z}}}else{if(x.id!==undefined){var v;if(x.worktype!==undefined){v=x.worktype}else{v=x.plmtype}if(v!=undefined&&i.CROSSHIGHLIGHT[v]==1){y=x.id;if(y==t[0]){t.splice(0,1);o=z}}}}var w=z.getChildrenOccurrencePathes();if(w!==undefined&&w!==null){p(w,t)}})}};p(q,n);return o};var l=function(n){var s=n.pathElement;var q="";while(s!==undefined&&s!==null){var p=s.getLastElement(true);if(p.getPersistentId!==undefined){if(p.productType=="Instance3D"||p.getPersistentId()==1){if(q.length!==0){q="/"+q}q=p.getPersistentId()+q}}else{if(p.id!==undefined&&p.id!==0){var o;if(p.worktype!==undefined){o=p.worktype}else{o=p.plmtype}if(o!=undefined&&i.CROSSHIGHLIGHT[o]==1){if(q.length!==0){q="/"+q}var r=p.id;q=r+q}}}s=s.getParentOccurrencePath()}return q};var c=function(Y,af){af.addScriptingFunction("registerAction",af.addScriptingFunction.bind(af),"",Y);af.addScriptingFunction("performAction",af.executeScriptingFunction.bind(af),"",Y);af.addScriptingFunction("getAvailableActions",af.getScriptingFunctions.bind(af),"",Y);af.addScriptingFunction("isActionSupported",af.hasScriptingFunction.bind(af),"",Y);af.addScriptingFunction("unregisterAction",af.removeScriptingFunction.bind(af),"",Y);af.addScriptingFunction("unregisterAllActions",af.disposeAllScriptingFunctions.bind(af),"",Y);af.addScriptingFunction("notifyAction",af.notifyScriptingFunction.bind(af),"",[Y,af]);af.addScriptingFunction("subscribeAction",af.subscribeScriptingFunction.bind(af),"",Y);af.addScriptingFunction("unsubscribeAction",af.unsubscribeScriptingFunction.bind(af),"",Y);af.addScriptingFunction("subscribeAllActions",af.subscribeAllScriptingFunctions.bind(af),"",Y);af.addScriptingFunction("unsubscribeAllActions",af.unsubscribeAllScriptingFunctions.bind(af),"",Y);af.createPathFromId=function(){console.error("Empty Function")};af.addScriptingFunction("createPathFromId",af.createPathFromId.bind(af),"",Y);af.createIdFromPath=function(){console.error("Empty Function")};af.addScriptingFunction("createIdFromPath",af.createIdFromPath.bind(af),"",Y);var t=function(){var ak=this.instance.frmWindow.getViewer();var ai=g(ak);var aj=[];var ah=function(al){if(al.length>0){al.forEach(function(ap){var ao=ap.getLastElement();var am,an;if(ao.id!==undefined&&ao.id!==0){am=ao.worktype||ao.plmtype}if(am!==undefined&&i.CROSSHIGHLIGHT[am]==undefined){i.CROSSHIGHLIGHT.resolveParenting({type:am},function(aq){if(aq!==undefined){i.CROSSHIGHLIGHT[aq]=1}else{i.CROSSHIGHLIGHT[aq]=0}})}an=ap.getChildrenOccurrencePathes();if(an!==undefined&&an!==null){ah(an)}else{console.log("FINISHED CUSTOM TYPES PARSING")}})}};ah(ai)};af.addScriptingFunction("initCustomTypes",t.bind(Y),"",Y);var V=function(al){var ak=this.instance.frmWindow.getViewer();var ai=g(ak);var aj=[];var ah=function(am,ao,an){if(am.length>0){am.forEach(function(aw){var au=aw.getLastElement();var av,ap,ar,aq,at;if(au.getPersistentId!==undefined){av=au.getPersistentId();ap=au.getName();ar=au.productType}else{if(au.id!==undefined&&au.id!==0){ap=au.title||au.name;ar=au.worktype||au.plmtype;av=au.id}}if(ar!=undefined&&i.CROSSHIGHLIGHT[ar]==1){av=ao+av;aq={name:ap,id:av,type:ar};an.push(aq)}else{av=ao}at=aw.getChildrenOccurrencePathes();if(at!==undefined&&at!==null){ah(at,av?av+"/":av,(aq&&al)?(aq.children=[]):an)}else{if(aq){aq.id=aq.slice(0,-1)}}})}};ah(ai,"",aj);return aj};af.addScriptingFunction("getSceneContent",V.bind(Y),"",Y);var M=function(ah){if(this._check()){this.instance.getScreenShot(ah)}};af.addScriptingFunction("getScreenshot",M.bind(Y),"",Y);var D=function(am,ah){if(this._check()){var ak=this.instance.frmWindow.getViewer();var ai=[];var aj=[];if(!Array.isArray(am)){aj.push(am)}else{aj=am}var al;if(ah){if(ah.highlightColor){al={color:new j.Color(0),outlineColor:new j.Color(0),intensity:ah.highlightColor.intensity};al.color.set(ah.highlightColor.color);al.outlineColor.set(ah.highlightColor.outlineColor);ak.createHighlightSet(al,true)}}aj.forEach(function(an){ai.push({pathElement:h(an,ak),parameters:{highlightColor:al}})});d.add(ai);b.add(ai)}};af.addScriptingFunction("selectNode",D.bind(Y),"",Y);var I=function(am,ah){if(this._check()){var al=d.get();var ak=[];al.forEach(function(an){ak.push(l(an))});var aj=[];if(!Array.isArray(am)){aj.push(am)}else{aj=am}var ai=[];aj.forEach(function(ao){for(var an=0;an<ak.length;an++){if(ak[an].indexOf(ao)>-1){ai.push(al[an])}}});ai.forEach(function(an){d.remove(an);b.remove(an)})}};af.addScriptingFunction("unselectNode",I.bind(Y),"",Y);var ad=function(){if(this._check()){var ai=this.getSceneContent();var ah=[];var aj=this.instance.frmWindow.getViewer();ai.forEach(function(ak){ah.push({pathelement:h(ak.id,aj)})});d.add(ah);b.add(ah)}};af.addScriptingFunction("selectAll",ad.bind(Y),"",Y);var X=function(){if(this._check()){d.empty();b.empty()}};af.addScriptingFunction("emptySelection",X.bind(Y),"",Y);var v=function(){if(this._check()){var ah=[];var ai=d.get();ai.forEach(function(aj){ah.push(l(aj))});return ah}};af.addScriptingFunction("getCurrentSelection",v.bind(Y),"",Y);var G=function(ah){if(ah!==undefined){ah.onAddToken=d.onAdd(function(ai){if(!Array.isArray(ai)){ai=[ai]}var aj=[];ai.forEach(function(ak){aj.push(l(ak))});ah("ADD",aj)});ah.onRemoveToken=d.onRemove(function(ai){if(!Array.isArray(ai)){ai=[ai]}var aj=[];ai.forEach(function(ak){aj.push(l(ak))});ah("REMOVE",aj)})}};af.addScriptingFunction("addSelectionCB",G.bind(Y),"",Y);var E=function(ah){if(ah!==undefined){if(ah.onAddToken!==undefined){d.unsubscribe(ah.onAddToken)}if(ah.onRemoveToken!==undefined){d.unsubscribe(ah.onRemoveToken)}}};af.addScriptingFunction("removeSelectionCB",E.bind(Y),"",Y);var W=function(ak,ah){if(this._check()){var aj=this.instance.frmWindow.getViewer();var ai=e.getCurrentSceneGraphState(aj);if(Array.isArray(ak)){ak.forEach(function(al){e.reallyApplyVisibilityToAll(ai,h(al,aj),0)})}else{e.reallyApplyVisibilityToAll(ai,h(ak,aj),0)}this.instance.frmWindow.getViewer().render()}};af.addScriptingFunction("hideNode",W.bind(Y),"",Y);var C=function(ak,ah){if(this._check()){var aj=this.instance.frmWindow.getViewer();var ai=e.getCurrentSceneGraphState(this.instance.frmWindow.getViewer());if(Array.isArray(ak)){ak.forEach(function(al){e.reallyApplyVisibilityToAll(ai,h(al,aj),1)})}else{e.reallyApplyVisibilityToAll(ai,h(ak,aj),1)}this.instance.frmWindow.getViewer().render()}};af.addScriptingFunction("showNode",C.bind(Y),"",Y);var O=function(){if(this._check()){var aj=this.instance.frmWindow.getViewer();var ai=e.getCurrentSceneGraphState(aj);var ah=g(aj);e.reallyApplyVisibilityToAll(ai,ah,0);aj.render()}};af.addScriptingFunction("hideAll",O.bind(Y),"",Y);var H=function(){if(this._check()){var aj=this.instance.frmWindow.getViewer();var ai=e.getCurrentSceneGraphState(aj);var ah=g(aj);e.reallyApplyVisibilityToAll(ai,ah,1);aj.render()}};af.addScriptingFunction("showAll",H.bind(Y),"",Y);var p=function(){};af.addScriptingFunction("getCurrentHiddenSet",p.bind(Y),"",Y);var n=function(){};af.addScriptingFunction("getCurrentShownSet",n.bind(Y),"",Y);var P=[];var ab=function(ah){if(ah!==undefined){P[WUX.Events.subscribe({event:"/"+af.ctx+"/3DPLAY/HIDE/"},function(ai){if(ai.data.length!=0){ah("HIDE",[l(ai.data[0])])}})]=ah;P[WUX.Events.subscribe({event:"/"+af.ctx+"/3DPLAY/SHOW_ALL/"},function(ai){ah("SHOW_ALL")})]=ah}};af.addScriptingFunction("addHideShowCB",ab.bind(Y),"",Y);var Q=function(ai){var ah=P.indexOf(ai);while(ah>-1){P[ah]=undefined;WUX.Events.unsubscribe(ah.toString());ah=P.indexOf(ai)}};af.addScriptingFunction("removeHideShowCB",Q.bind(Y),"",Y);var q=[];var Z=function(ah){if(ah!==undefined){q[WUX.Events.subscribe({event:"/VISU/"},function(aj){if(aj.eventType=="@onViewpointChange"){var ai={position:aj.cameraEye.clone(),target:aj.cameraTarget.clone(),upDirection:aj.cameraUp.clone()};ah(ai)}})]=ah}};af.addScriptingFunction("addViewpointChangeCB",Z.bind(Y),"",Y);var L=function(ah){var ai=q.indexOf(ah);while(ai>-1){WUX.Events.unsubscribe(ai.toString());q[ai]=undefined;ai=q.indexOf(ah)}};af.addScriptingFunction("removeViewpointChangeCB",L.bind(Y),"",Y);var U=function(){var ai=this.instance.frmWindow.getViewer();var aj=ai.currentViewpoint;var ah={position:aj.getEyePosition().clone(),target:aj.getTarget().clone(),upDirection:aj.getUpDirection().clone()};return ah};af.addScriptingFunction("getCurrentViewpoint",U.bind(Y),"",Y);var T=function(ai){var ah=this.getCurrentViewpoint();ah.position.x=ai.position.x;ah.position.y=ai.position.y;ah.position.z=ai.position.z;ah.target.x=ai.target.x;ah.target.y=ai.target.y;ah.target.z=ai.target.z;ah.upDirection.x=ai.upDirection.x;ah.upDirection.y=ai.upDirection.y;ah.upDirection.z=ai.upDirection.z;var am=this.instance.frmWindow.getViewer();var aj=am.currentViewpoint.camera.matrix.clone();var al=am.currentViewpoint.camera.quaternion.clone();aj.lookAt(ah.position,ah.target,ah.upDirection);al.setFromRotationMatrix(aj);var ak={position:ah.position,orientation:al,distanceToTarget:ah.target.distanceTo(ah.position),duration:ah.duration!==undefined?ah.duration:0};am.currentViewpoint.getControl().moveTo(ak)};af.addScriptingFunction("setCurrentViewpoint",T.bind(Y),"",Y);var ag=function(aj){var ah=af.ctx;function ak(am,al){return a.getCommand(am,al)||a.getCommand(am)}var ai=ak(aj,ah);if(ai){ai.beginExecute()}};af.addScriptingFunction("setVisuMode",ag.bind(Y),"",Y);var r=[];var R=["VisuNoShadingEdges","VisuShading","VisuShadingEdges","VisuShadingEdgesNoSmoothEdges","VisuShadingEdgesHiddenEdges","VisuShadingMaterial","VisuShadingMaterialEdges","VisuShadingIllustration","VisuOrthographicView","VisuPerspectiveView"];var J=function(ah){if(ah!==undefined){R.forEach(function(ai){r[WUX.Events.subscribe({event:"/WUX/AFR/CMD/"+af.ctx+"/"+ai+"/"},function(aj){ah("VISU_MODE",[ai])})]=ah})}};af.addScriptingFunction("addVisuModeCB",J.bind(Y),"",Y);var z=function(ah){var ai=r.indexOf(ah);while(ai>-1){WUX.Events.unsubscribe(ai.toString());r[ai]=undefined;ai=r.indexOf(ah)}};af.addScriptingFunction("removeVisuModeCB",z.bind(Y),"",Y);var F=function(){return af.collabMode};af.addScriptingFunction("getCollabMode",F.bind(Y),"",Y);var aa=function(ah){af.collabMode=ah};af.addScriptingFunction("setCollabMode",aa.bind(Y),"",Y);var A=[];var N=["selectNode","unselectNode","setCurrentViewpoint","hideNode","showNode","showAll","hideAll","setVisuMode"];var x=function(ah){if(ah!==undefined){A.push(ah);ah.collabNotif=function(aj,ai){if(aj=="ADD"){af.notifyScriptingFunction("selectNode",ai)}else{if(aj=="REMOVE"){af.notifyScriptingFunction("unselectNode",ai)}else{if(aj=="HIDE"){af.notifyScriptingFunction("hideNode",ai)}else{if(aj=="SHOW_ALL"){af.notifyScriptingFunction("showAll")}else{if(aj=="VISU_MODE"){af.notifyScriptingFunction("setVisuMode",ai)}else{if(ai===undefined){af.notifyScriptingFunction("setCurrentViewpoint",[aj])}}}}}}};G(ah.collabNotif);Z(ah.collabNotif);ab(ah.collabNotif);J(ah.collabNotif);N.forEach(function(ai){af.subscribeScriptingFunction(ai,ah)})}};af.addScriptingFunction("addCollabCB",x.bind(Y),"",Y);var u=function(ai){if(ai!==undefined){var ah=A.indexOf(ai);while(ah>-1){A[ah]=undefined;ah=A.indexOf(ai)}E(ai.sCB);L(sCB);Q(ai.collabNotif);z(ai.collabNotif)}};af.addScriptingFunction("removeCollabCB",u.bind(Y),"",Y);var o=function(ah,ai){af.addScriptingFunction(ah,ai,"",[Y,af]);N.push(ah);A.forEach(function(aj){af.subscribeScriptingFunction(ah,aj)})};af.addScriptingFunction("registerCollabAction",o.bind(af),"",[Y,af]);var y=function(ah){if(N!==undefined){var ai=N.indexOf(ah);while(ai>-1){N[ai]=undefined;ai=N.indexOf(ah)}}af.removeScriptingFunction(ah);A.forEach(function(aj){af.unSubscribeScriptingFunction(ah,aj)})};af.addScriptingFunction("unRegisterCollabAction",y.bind(af),"",[Y,af]);var S=function(aj,ah){if(this._check()){var ak=this.instance.frmWindow.getViewer();if(aj){var ai=e.getCurrentSceneGraphState(ak);if(ai){if(ah.opacity){ai.setOpacity(aj,ah.opacity)}if(ah.color){}if(ah.position){}if(ah.visibility!==undefined){if(ah.visibility===true){}else{}}}}}};af.addScriptingFunction("setNodeProperties",S.bind(Y),"",Y);var K,w=-1,ae=[],s=[];var B="";var ac=function(ao,aq){if(this._check()){if(ao){if(ao!==B){ae=[],s=[];B=ao;aq=aq||function(at){return{opacity:0.1}};if(0){var an=this.getSceneContent();for(var al=an.length;al--;){var aj=an[al];if(aj.type==="Reference3D"){if(aj.name.indexOf(ao)>-1){ae.push(aj.id)}else{s.push(aj.id);this.setNodeProperties(aj.id,aq(aj))}}}}else{var ap=this.instance.getRootBag();function ai(at,au){if(!au){au=new f()}if(at!=ap){au=ai(at.parents[0],au)}au.addElement(at);return au}if(1){ap.traverse(function(au,at){var av=ai(au);if(au.name.indexOf(ao)>-1&&au.getPersistentId!==undefined&&au.productType==="InstanceRep"){ae.push(av);if(au.getPersistentId!==undefined&&au.productType){console.log("3DXML",au.name,au.productType)}else{if(au.id!==undefined&&au.id!==0){console.log("EV6",au.title||au.name,au.worktype||au.plmtype)}else{console.log("?",au.name)}}}else{s.push(av);at.setNodeProperties(av,aq(au))}},this)}else{var ah=[],ak=function(at,av,au){if(at.length>0){at.forEach(function(aC){var aA=aC.getLastElement();var aB,aw,ay,ax,az;if(aA.getPersistentId!==undefined){aB=aA.getPersistentId();aw=aA.getName();ay=aA.productType}else{if(aA.id!==undefined&&aA.id!==0){aw=aA.title||aA.name;ay=aA.worktype||aA.plmtype;aB=aA.id}}if(k[ay]){aB=av+aB;ax={name:aw,id:aB,type:ay};au.push(ax)}else{aB=av}az=aC.getChildrenOccurrencePathes();if(az!==undefined&&az!==null){ak(az,aB?aB+"/":aB,(ax&&asTree)?(ax.children=[]):au)}else{if(ax){ax.id=ax.slice(0,-1)}}})}};ak(g(ap),undefined,ah)}}if(ae.length>0){var am=this.instance.frmWindow.getViewer();var ar=function(aw){if(aw==="left"){w--;if(w<0){w=ae.length-1}}else{w++;if(w===ae.length){w=0}}var av=ae[w];var au=av.externalPath[av.externalPath.length-1];if(au){var at=au.getBoundingSphere();if(at){var ax=av.getWorldMatrix();if(ax){at.center.applyProjection(m);am.currentViewpoint.reframe(undefined,0,at)}}}};w=-1;if(!K){K=new NavigationArrows({arrowCB:{left:function(){ar("left")},right:function(){ar("right")}}},{container:this.instance.frmWindow.getUIFrame(),frmWindow:this.instance.frmWindow})}this.instance.frmWindow.getViewer().render()}else{if(K){K.dispose();K=null}}}}else{if(K){K.dispose();K=null}for(var al=s.length;al--;){this.setNodeProperties(s[al],function(){return{opacity:1}})}this.instance.frmWindow.getViewer().render();w=-1;ae=[];s=[]}}};af.addScriptingFunction("search",ac.bind(Y),"",Y)};return c});define("DS/3DPlayExperienceModule/PlayExperience2D",["DS/3DPlay/3DPlay","UWA/Core","DS/3DPlayExperienceModule/3DPlayExperience","DS/3DPlayExperienceModule/Documents/MultiDocManager","DS/ApplicationFrame/FrameWindow","DS/WebSystem/Environment","DS/WebSystem/DetectBrowser","DS/WebUtils/ContextedSingleton","DS/WebSystem/Settings","DS/WebSystem/Nls","DS/WebInfraUI/Notification","DS/WebRunloop/Runloop"],function(f,d,n,k,e,h,g,b,a,j,i,c){var l=n.extend({init:function(o){o=o||{};o.mode="2D";o.FrameWindow=e;o.workbenchs=o.workbenchs||[];if(o.commandApplication===undefined||o.commandApplication===true){o.workbenchs.unshift({name:"3DPlayExperience2D",module:"3DPlay"})}this._parent(o)},computeViewerStats:function(){if(this.frmWindow._3dViewer&&this.frmWindow._3dViewer._loader){return this.frmWindow._3dViewer._loader.stats}return{}},preCreate:function(){var r={visu:{},ui:{displayActionBar:true}};var o=this.args.ctx;var q=this;var p=this.getPhaseProgress();this.onModelLoadingProgression=function(u){if(u.loaded!==undefined&&u.total!==undefined&&u.total!==0){if(u.total===-1){p.setIndeterminateState()}else{p.setAbsoluteProgress(q.subProgressID,Math.round(u.loaded*100/u.total));q.publish("ASSET/LOADINGPROGRESS",{model:q.modelName,progress:u,ctx:q.args.ctx});if(u.loaded===u.total){q.onModelLoadingCompleted();if(g&&g().browser.name==="ie"){if(q.frmWindow._3dViewer!==undefined&&q.frmWindow._3dViewer!==null){if(q.frmWindow._3dViewer.docs!==undefined&&q.frmWindow._3dViewer.docs!==null){var w=q.frmWindow._3dViewer.docs;var t=false;var s=w[0];if(s[0].svg!==undefined&&s[0].svg!==null){t=true}var v=false;if(q.args.options.showBubbleMenu||h.isSet("3DPlay.ShowBubbleMenu")){v=true}q.PanelManager.dispose();q.PanelManager.generated=undefined;q.PanelManager.setTopBarId(q.args.options);q.PanelManager.createTopMenu({ctx:o,container:q.frmWindow.getUIFrame(),experience:q,showBubbleMenu:v,skipSave:t});q.PanelManager.createDefaultHelp()}}}}}}};this.onModelLoadingError=function(s){if(s.rsc!==undefined){if(q.hasConvertFailed){j.nls("3DPlay/Core","Convert_SERVICE_NOT_FOUND",function(t){f.sendEvent(o,eventType.notif,i.fatal,{msg:t});p.hideProgressBar()})}else{if(s.type==="Convert_SERVICE_NOT_FOUND"){q.hasConvertFailed=true}j.nls(s.rsc,s.type,function(t){var u=t;if(s.txt){u=u+s.txt}f.sendEvent(o,eventType.notif,s.level,{msg:u});if(s.abort){p.hideProgressBar()}})}}q.publish("ASSET/LOADINGERROR",d.extend({ctx:o},s))};this.args=d.extend(r,this.args,true)},postCreate:function(){var o=this.args;var p=false;if(this.args.options.showBubbleMenu||h.isSet("3DPlay.ShowBubbleMenu")){p=true}this.PanelManager.createTopMenu({ctx:o.ctx,container:this.frmWindow.getUIFrame(),experience:this,showBubbleMenu:p});this.PanelManager.createDefaultHelp();this.frmWindow._3dViewer=new k({phaseProgress:this.getPhaseProgress(),frmWnd:this.frmWindow,exp:this});this.frmWindow._3dViewer.animate=function(){};this.frmWindow._3dViewer.addNode=function(){};this.frmWindow._3dViewer.render=function(){};this.frmWindow.getViewer=function(){return this._3dViewer};this.runloopFunc=function(){this._step.apply(this,[arguments[0].time,arguments[0].profiler])};this.runloop=new c({data:this,func:this.runloopFunc});this.runloop.start()},clearView:function(){this._parent();var o=this.frmWindow.getViewer();if(o){o.clearScene()}},loadAsset:function(o,p){this._loadAssets(o,p)},loadAssets:function(o,p){this._loadAssets(o,p)},_loadAssets:function(p,q){if(this.args&&this.args.ctx){var o=this.args.ctx;this.modelName="Doc2D";this.frmWindow._3dViewer.loadDocuments(p,{loadProgress:this.onModelLoadingProgression,loadStart:this.onModelLoadingStarted,clearScene:true});this.publish("ASSET/LOADINGSTARTED",{data:name,ctx:o})}},dispose:function(){f.endAllCommands({ctx:this.ctx,resetDefaultCmd:true});if(this.frmWindow!==undefined){var q=this.frmWindow.getViewer();if(q!==undefined&&q.dispose!==undefined){q.dispose()}}if(a.get("3DPlay.Video.Enabled")){var p=b.get(this.args.ctx,"3DP_Video_Controls");if(p){p.destroyUI();b.remove(this.args.ctx,"3DP_Video_Controls")}var o=b.get(this.args.ctx,"3DP_Video_Viewer");if(o){b.remove(this.args.ctx,"3DP_Video_Viewer")}}this.publish("3DPLAY/EXPERIENCE2D/DISPOSE",{ctx:this.args.ctx});this._parent()},getScreenShot:function(o){return this.frmWindow.getViewer().getScreenShot(o)},_setScreenshotUI:function(o){}});return l});define("3DPlay/PlayExperience2D",["DS/3DPlay/PlayExperience2D"],function(a){console.error("AMDLoader migration : please don t call 3DPlay/PlayExperience2D but DS/3DPlay/PlayExperience2D");console.error("AMDLoader migration : please don t call 3DPlay/PlayExperience2D but DS/3DPlay/PlayExperience2D");console.error("AMDLoader migration : please don t call 3DPlay/PlayExperience2D but DS/3DPlay/PlayExperience2D");return a});define("DS/3DPlayExperienceModule/Documents/CollectionView3DPlayDocLayout",["DS/CollectionView/layouts/CollectionViewGridLayout"],function(a){return a.inherit({getContentDimensions:function(){var b=this._parent();if((typeof this.columnMaxWidth)==="string"){b.width=this.columnMaxWidth}else{b.width=Math.max(this.columnMaxWidth,b.width)}return b},_getPositionForCellAt:function(d){var c=this._parent(d);var b=this.collectionView.getViewportDimensions();var e=this._getRowHeight();if(this.isMonosheet&&e<b.height){c.top=(b.height-e)/2}return c}})});define("DS/3DPlayExperienceModule/Documents/3DPlayDocumentTileView",["UWA/Core","DS/Controls/Abstract"],function(c,a){var b=a.inherit({name:"3DPlayDocumentTileView",markForRecordFlag:true,publishedProperties:{content:{defaultValue:{},type:"object",category:"Appearance"},tileScale:{defaultValue:1,type:"float",category:"Appearance"},realSizeWidth:{defaultValue:250,type:"float",category:"Appearance"},realSizeHeight:{defaultValue:250,type:"float",category:"Appearance"},format:{defaultValue:"none",type:"string",category:"Behavior"},thumbnail:{defaultValue:null,type:"string",category:"Appearance"},status:{defaultValue:{loaded:false,failed:false},type:"object",category:"Appearance"},useLOD:{defaultValue:false,type:"boolean",category:"Appearance"},annotations:{defaultValue:{},type:"object",category:"Appearance"}},viewerID:{pdf:"DS/WebViewer2D/ViewerPDF",jpeg:"DS/WebViewer2D/ViewerImage",jpg:"DS/WebViewer2D/ViewerImage",png:"DS/WebViewer2D/ViewerImage",bmp:"DS/WebViewer2D/ViewerImage",svg:"DS/WebViewer2D/ViewerSvg"},buildView:function(){this.elements.container=new c.Element("div",{"class":"PlayWeb-Tile",styles:{width:"100%",height:"100%"}});this.elements.container.setAttribute("has-content","false")},_applyProperties:function(d){this.elements.container.style.display="none";this._parent(d);if(!this.viewer||this.isDirty("format")){this._applyFormat(d)}else{if(this.isDirty("useLOD")){this._applyUseLOD(d.useLOD)}if(this.isDirty("realSizeWidth")||this.isDirty("realSizeHeight")){this._applyRealDimension()}if(this.isDirty("status")){this._applyStatus(d.status)}if(this.isDirty("thumbnail")){this._applyThumbnail(d.thumbnail)}if(this.isDirty("content")){this._applyContent(d.content)}else{if(this.isDirty("tileScale")){this._applyTileScale(d.tileScale)}}if(this.isDirty("annotations")){this._createAnnotations(d.annotations)}}this.elements.container.style.display=""},_createAnnotations:function(d){var e=this;this.viewer.updateView({asset:this.content,status:this.status,scale:this.tileScale,annotations:this.annotations,doneCB:function(f){if(e.thumbnailCallback){e.thumbnailCallback()}}})},_applyFormat:function(d){if(this.viewer){this.elements.container.removeChild(this.elements.container.firstChild);this.viewer.dispose();this.viewer=null}if(this.viewerID[this.format]){var e=this;require([this.viewerID[this.format]],function(f){if(e.viewer===null||e.viewer===undefined){e.viewer=new f({viewer:e.elements.container,typeOfDoc:e.format,thumbnail:e.thumbnail,realSizeWidth:e.realSizeWidth,realSizeHeight:e.realSizeHeight})}if(e.content){e.viewer.updateView({asset:e.content,status:e.status,title:e.title,scale:e.tileScale,useLOD:e.useLOD,annotations:e.annotations,doneCB:function(){if(e.thumbnailCallback){e.thumbnailCallback()}}})}},function(f){})}},_applyContent:function(d){if(this.viewer){this.viewer.specialViews.show.thumbnail();this.viewer.updateView({asset:this.content,status:this.status,scale:this.tileScale,useLOD:this.useLOD})}},_applyStatus:function(d){if(this.viewer){this.viewer.status=this.status;if(this.status.loaded===false){this.viewer.specialViews.show.loading()}else{if(this.status.failed===true){this.viewer.specialViews.show.failed()}}}},_applyUseLOD:function(d){if(this.useLOD!==d&&this.viewer){this.viewer.useLOD=this.useLOD}},_applyTileScale:function(d){if(this.tileScale!==d&&this.viewer){this.viewer.setScale(this.tileScale)}},_applyThumbnail:function(d){if(this.thumbnail!==d&&this.viewer){this.viewer._setThumbnail(this.thumbnail)}},_applyRealDimension:function(d){if(this.viewer){this.viewer.setRealDimension({realSizeWidt:this.realSizeWidt,realSizeHeight:this.realSizeHeight});this._applyStatus({})}},handleEvents:function(){},});return b});define("DS/3DPlayExperienceModule/VisuDataAccess/Ox4DOSRunner",["DS/3DPlayExperienceModule/VisuDataAccess/Ox4TreeTarget","DS/3DPlayExperienceModule/VisuDataAccess/Ox4PlanRunner","DS/VisuDataAccess/Ox4TaskPlanner","DS/VisuDataAccess/Ox4SetTask","DS/VisuDataAccess/Ox4ExpandTask","DS/VisuDataAccess/Ox4xMQLSelectTaskDefinition","DS/VisuDataAccess/Ox4SelectTask","DS/VisuDataAccess/Ox4PLMDataHelper","DS/VisuDataAccess/Ox4TicketGeneratorTask","DS/VisuDataAccess/Ox4FeatureModeler","DS/VisuDataAccess/Ox4StreamUnStreamerTaskDefinition","DS/3DPlayExperienceModule/VisuDataAccess/Ox4StreamUnStreamerTask","DS/VisuDataAccess/Ox4TypeHelper","DS/Visualization/PathElement"],function(k,a,c,l,n,d,b,e,i,h,q,o,p,j){function g(s){var r=new Object();if(typeof(s.serverdefinition.hostname)==="undefined"){console.log("checkAndEnrichSpecification:No Hostname in CreateServerDefinition");return null}r.hostname=s.serverdefinition.hostname;if(typeof(s.serverdefinition.rooturi)==="undefined"){console.log("checkAndEnrichSpecification:No RootUri in CreateServerDefinition");return null}r.rooturi=s.serverdefinition.rooturi;r.isSecure=false;if(typeof(s.serverdefinition.protocol)!="undefined"){if(s.serverdefinition.protocol==="https"){r.isSecure=true}}r.port=-1;if(typeof(s.serverdefinition.port)!="undefined"){r.port=s.serverdefinition.port}r.rawmode=s.rawmode;r.xmqlServiceUri=function(){var u="http://";if(this.isSecure){u="https://"}var t=u+this.hostname;if(this.port!=-1){t+=":"+this.port}t+="/"+this.rooturi+"/i3dx/services/xmql";if(typeof s.tenant==="string"){t+="?tenant="+s.tenant}if(typeof(r.rawmode)==="boolean"&&r.rawmode){t+="?raw=true"}return t};r.threedexpServiceUri=function(){var u="http://";if(this.isSecure){u="https://"}var t=u+this.hostname;if(this.port!=-1){t+=":"+this.port}t+="/"+this.rooturi;return t};s.serverdefinition=r;s.typeHelper=p;s.referenceType="VPMReference";s.shapeType="VPMRepReference";s.instanceType="VPMInstance";return s}var f=function(y,s){if(!p.IsInit()){p.Init(y.serverdefinition,y.requiredAuth,y.proxyurl)}var v=g(y);var x=new k(v,s);var w=null;var r=null;var t=null;this.run=function(B,z,C){w=B;r=z;t=C;h.init();var A=new u();A.buildPlan(v,function(E){x.FindRootNodeWorkType();var D=new a(E,x,v.physicalid+"_set",w,r,t);D.executePlan()})};var u=function(){this.buildPlan=function(z,B){var A=false;if(z.dtype!=null){p.IsBusA(z.dtype,z.shapeType,function(O){var K=new c();var G=new l(false,z.serverdefinition);K.addSequentialTask(G);var H=new n(z.physicalid,z.serverdefinition,"PLMInstance");K.addSequentialTask(H);var L=new e(z.serverdefinition);var J=function(S,T){var Q=h.listRootFeatures(S.id);S.AnimFeatures=Q;var R=T.rootNode();if(!R.hasOwnProperty("AnimFeaturesList")){R.AnimFeaturesList=[]}Array.prototype.push.apply(R.AnimFeaturesList,S.AnimFeatures);r()};var P={Fetch:new Array(),Path:new Array()};P.Fetch.push("physicalid");P.Fetch.push("attribute[StreamDescriptors]");P.Fetch.push("format.file.store");P.Path.push("owner.physicalid");P.Path.push("element.order");P.Path.push("element");P.Path.push("attribute[IDRel]");var C=function(X,V,R){if("fetch"===X){var S=R.findNodeByPhysicalId(V[3]);if(h.containFeatures(S.id)){J(S,R)}else{var T=L.transformSelectedSDByRoleAndFormatIntoTicketRequest(V[3],V[4],"CATNonCATIADocument","'WebFormat'",["1","7"],V[5]);if(T!==null){S.ticketRequest=new i(T,z.serverdefinition)}}}else{if("path"===X){var Z=(V.length-3)/2;var S=R.findNodeByPhysicalId(V[1]);if(S){if(!S.hasOwnProperty("SemanticRelations")){S.SemanticRelations={}}var Q=new j();Q.addElement(R.rootNode());var W=[];var U;for(U=0;U<Z;U++){W.push({order:V[2+U],instance:V[2+Z+U].split(",")[2]})}W.sort(function(aa,ab){return aa.order-ab.order});for(U=0;U<W.length;U++){var Y=R.findNodeByPhysicalId(W[U].instance);Q.addElement(Y);if(U<W.length-1&&Y.children.length==1){Q.addElement(Y.children[0])}}S.SemanticRelations[V[2+2*Z]]=Q}}}};var M=new d("CATANIMDISCIPLINE",P,C,1);var F=new b(M,z.serverdefinition);K.addSequentialTask(F);var I=new q("CATANIMDISCIPLINE",function(R,T,S,U){if(T!==null){h.loadRepresentation(R,R.id,T,function(){J(R,S);U()})}else{var Q=S.rootNode();if(!Q.hasOwnProperty("AnimFeaturesList")){Q.AnimFeaturesList=[]}Q.AnimFeaturesList.push("feature")}},function(){});I.responseType="blob";var D=new o(I,z.serverdefinition,r);K.addSequentialTask(D);var E=new l(true,z.serverdefinition);K.addSequentialTask(E);var N=function(T){var R=T.rootNode();var Q=T.findNodeByType(z.shapeType);var S=[];return{rootNode:R,geometryNodes:S}};K.addEndingTask(N);B(K)})}}}};return f});define("DS/3DPlayExperienceModule/Ox4DOSRunner",["DS/3DPlayExperienceModule/VisuDataAccess/Ox4DOSRunner"],function(a){return a});define("DS/3DPlayExperienceModule/VisuDataAccess/Ox4MQLV6Loader2",["DS/3DPlayExperienceModule/VisuDataAccess/Ox4DOSRunner","DS/VisuDataAccess/Ox4TypeHelper"],function(b,g){var h={};var f=null;var c=null;var e=null;var a=null;var d=undefined;var i=function(x,p,k,t){var A=x;var w=(typeof k=="undefined")?false:k;var H=(p!==undefined)?p:null;var n;var I=null;var s=false;var v=0;var G=0;var D=0;var F=[];var B=[];var r=[];var J=[];var u=[];var o=[];var z=[];var q=[];var C;var l=null;var y=[];var E;var j=t;this.setGeometryMode=function(K){j=K};d=function(){if(I!=null){I.terminate();I=null;s=false}f=null;c=null;e=null;n="";v=0;G=0;D=0;F=[];B=[];r=[];J=[];u=[];o=[];z=[];q=[];C="";l=null;y=[];E=null;a=null;h={}};this.abort=function(){if(a!==null){a.value=true;d()}}};i.prototype={constructor:i,load:function(q,s,o,k,r,u){function l(v,w){g.IsBusA(v,"VPMReference",function(x){if(!x){g.IsBusA(v,"VPMRepReference",w)}else{w(true)}})}function n(v){if(v==="SW Assembly Family"){return true}if(v==="SW Component Family"){return true}if(v==="SW Assembly Instance"){return true}if(v==="SW Component Instance"){return true}if(v==="CATPart"){return true}if(v==="CATProduct"){return true}return false}h=u;a={value:false};f=s;e=o;c=function(){d();if(k){k()}};var j={};if(!u.productNode){k();return}u.productNode.traverse(function(w,v){var x;if(w.getID){x=w.getID()}if(x){w.id=x;j[x]=w}},undefined,false);if(q.dtype==null){q.dtype="VPMReference"}var p=q.dtype;var t=null;g.InitWithUrl(q.serverurl,q.tenant,q.requiredAuth,q.proxyurl);l(p,function(x){if(x){t=new b(q,j)}else{r({type:"LOAD",url:"type "+p})}if(t==null){return}var w=null;var v=r;var y=a;var z=function(A){if(!y.value){if(f){f()}if(c){c()}j={}}};t.run(w,z,v)})}};return i});define("DS/3DPlayExperienceModule/Documents/CollectionView3DPlayDoc",["DS/CollectionView/CollectionView","DS/3DPlayExperienceModule/Documents/3DPlayDocumentTileView"],function(a,b){return a.inherit({init:function(c){this._parent(c);this.onResizeCB=c.onResizeCB;this.defaultCellProperties={content:{},format:"none",thumbnail:null,status:{loaded:false,failed:false}};this.multiDocMgr=c.multiDocMgr;this.thumbnailCallback=c.thumbnailCallback},_updateViewportDimensions:function(){this._parent();if(this.onResizeCB){this.onResizeCB()}},_renderViewport:function(c){if(this.model&&this.model.length){this._parent(c)}},_postBuildView:function(){this._parent();var c=this;c.registerReusableCellContent({id:"Tile",buildContent:function(){var d=new b();d.layoutingCollection=c;return d}});c.onCellRequest(function(f){if(f.cellID!==f.cellView.__cachedAttributes["cell-id"]){var e=c.reuseCellContent("Tile");f.cellView.collectionView=c;f.cellView.contentView=e;f.cellView._setReusableContent(e);e.thumbnailCallback=function(){c.thumbnailCallback(f.cellID)}}if(f.cellModel&&f.cellModel.status&&f.cellModel.status.loaded&&f.cellModel.content&&(f.cellModel.thumbnail===null||f.cellModel.thumbnail===undefined)&&this.layout.useLOD){this.multiDocMgr._generateThumbnail(f.cellID,f.cellModel.content,true)}var d=f.cellModel||c.defaultCellProperties;d.tileWidth=this.layout.columnMaxWidth;d.tileHeight=this.layout.rowMaxHeight;d.tileScale=this.layout.tileScale;d.content=d.content||{};d.useLOD=this.layout.useLOD;d.annotations=f.cellModel.annotations;d.getSheetViewer=function(){return f.cellView.contentView.viewer};f.cellView.contentView.setProperties(d)})}})});define("DS/3DPlayExperienceModule/3DPlayAbstractExperience",["UWA/Core","DS/WebSystem/Scripting","DS/3DPlay/3DPlay","DS/3DPlayUtils/PanelManager","DS/3DPlayUtils/UIManager","DS/WebSystem/Settings","DS/ApplicationFrame/CommandsManager","DS/WebInfraUI/Notification","DS/WebInfraUI/NotificationScreen","DS/WebSystem/Environment","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/WebUtils/EventDisposer","DS/WebSystem/Nls","DS/WebUtils/FunctionDisposer","DS/3DPlayUtils/XCADSpatialSupport","DS/3DPlayConnectors/3DPlayInputPreProcessor","DS/WebUtils/ContextedSingleton","DS/CoreEvents/Events","DS/WebUtils/ProbesManager","DS/WebInfraUI/MobileActionBar","DS/3DPlayExperienceModule/PlayExperience3DScriptingPlugin","DS/WebUtils/PhaseProgress","DS/WebUtils/Tracker"],function(g,o,w,s,x,u,a,j,v,l,k,i,d,f,h,n,y,b,p,e,c,q,r,t){return o.extend({name:"3DPlayAbstractExperience",init:function(z){this._parent();this.args=z;this._name=z.input.experience.filename||"Default";this.EventDisposer=new d();this.addOnPauseCB(this.onPause);this.addOnPlayCB(this.onPlay);this.addOnStopCB(this.onStop);this.addOnScenarioChangeCB(this.onScenarioChange);this.addOnLoadingFinishedCB(this.onLoadingFinished);this.createScriptingAPI();this.addScriptingInitCB();this.disposeFunctions=new h();this.xcadSupport=new n(this);this._isReady=false;this._enableCMenu=true;this.playerSplashScreen=undefined;this.showSplashBetweenLoad=true;this.modelLoadComplete=false;this.phaseProgress=new r();var A=z.container.getElementsByClassName("Landing-Page_container")[0];if(A){A.hide()}var B=this;this.progress={};this.progress.hide=function(){if(B.getPhaseProgress()){B.getPhaseProgress().hideProgressBar()}};this.progress.updateProgression=function(C){if(B.getPhaseProgress()){B.getPhaseProgress().setAbsoluteProgress(this.subProgressID,C);B.progress.state.value=C}};this.progress.visible=function(){if(B.getPhaseProgress()){B.getPhaseProgress().showProgressBar();B.progress.state.visible=true}};this.progress.state={visible:false,value:0};this.progress.spinnerContainer={style:{overflow:""}}},registerCollabAction:function(){},createScriptingAPI:function(){var z=this.args.options.helper||b.get(this.args.ctx,"helper");if(z){q(z,this)}},addScriptingInitCB:function(){var z=this;this.EventDisposer.add(WUX.Events.subscribe({origin:this,event:"/"+this.args.ctx+"/ASSET/LOADINGFINISHED"},function(){var A=z.args.options.helper||b.get(z.args.ctx,"helper");if(A){if(z.args.options.collabmode){A.setCollabMode(z.args.options.collabmode==="true")}A.initCustomTypes()}}))},addOnLoadingFinishedCB:function(z){this.EventDisposer.add(WUX.Events.subscribe({origin:this,event:"/"+this.args.ctx+"/ASSET/LOADINGFINISHED"},z))},onLoadingFinished:function(){},addOnPlayCB:function(z){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/EXPERIENCE/PLAY"},z))},onPlay:function(){},addOnPauseCB:function(z){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/EXPERIENCE/PAUSED"},z))},onPause:function(){},addOnStopCB:function(z){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/EXPERIENCE/STOP"},z))},onStop:function(){},addOnScenarioChangeCB:function(z){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/SCENARIO/CHANGE"},z))},onScenarioChange:function(){},dispose:function(A){if(this.notifScreen){if(this.notifScreen.dispose){this.notifScreen.dispose()}this.notifScreen=null}A=A||{};if(this.playerSplashScreen){this.playerSplashScreen=null}if(this.notifTimeoutID){clearTimeout(this.notifTimeoutID);this.notifTimeoutID=null}this.EventDisposer.dispose();this.EventDisposer=null;this.disposeFunctions.dispose();this.disposeFunctions=null;w.removeCallbacks(this.args.ctx);if(this.args.iWebApplication){this.args.iWebApplication.dispose(A);this.args.iWebApplication=null}if(A.disposeFrameWindow===undefined||A.disposeFrameWindow===true){if(undefined!==this.frmWindow&&null!==this.frmWindow){if(undefined!==this.frmWindow.dispose&&null!==this.frmWindow.dispose){this.frmWindow.dispose()}this.frmWindow.experience=null;this.frmWindow=null}}else{var z=this.args.ctx;a._commandsState[z]={lastCommand:[],currentCommand:null,defaultCommand:null};a.resetDefaultCommand(z);a._isCommandEnding=false;a._ignoreCommandBeginWhileEndingCommand=false;["_commands","_cmdCheckHeader"].forEach(function(C){if(a[C]){var B=a[C][z];if(B){Object.keys(B).forEach(function(D){var E=B[D];if(E&&E._destroy){E._destroy()}})}}})}if(undefined!==this.PanelManager&&null!==this.PanelManager){if(undefined!==this.PanelManager.dispose&&null!==this.PanelManager.dispose){this.PanelManager.dispose()}this.PanelManager=null}if(this.UIManager){if(this.UIManager.dispose){this.UIManager.dispose()}this.UIManager=null}if(this.phaseProgress&&this.phaseProgress.dispose){this.phaseProgress.dispose();this.phaseProgress=null}if(this.xcadSupport){if(this.xcadSupport.dispose){this.xcadSupport.dispose()}this.xcadSupport=null}this._parent(A);this.args=null;if(this.actionBarProfile){if(this.actionBarProfile.dispose){this.actionBarProfile.dispose()}this.actionBarProfile=null}},informActiveState:function(z){this.PanelManager.setVisibility(z);if(!z){p.publish({event:"3DPLAY/3DPLAYPREVIEW/DISABLE",data:{}})}else{p.publish({event:"3DPLAY/3DPLAYPREVIEW/ENABLE",data:{}})}},play:function(){if(this.pausetime===undefined){this.pausetime=this.first}if(this.paused===true||this.stoped===true){var z=new Date().getTime()-this.pausetime;this.first+=z;this.paused=this.stoped=false;this.publish("EXPERIENCE/PLAY",{experience:this,ctx:this.args.ctx})}},pause:function(){if(this.paused===false){this.pausetime=new Date().getTime();this.paused=true;this.stoped=false;this.publish("EXPERIENCE/PAUSED",{experience:this,ctx:this.args.ctx})}},stop:function(){this.stoped=true;this.paused=false;this.publish("EXPERIENCE/STOP",{experience:this,ctx:this.args.ctx})},_testBrowser:function(){return BrowserSupport.ok},testBrowser:function(){return BrowserSupport.ok},getScreenShot:function(z){return undefined},start:function(){if(this.playerSplashScreen){this.playerSplashScreen.removeOnClick()}if(this.args.options.loading===loadingMode.preload){if(this.isLoaded){this.toggleSplash(false)}else{if(!this.args.options.splashscreen||!this.args.options.splashscreen.waitloading){this.toggleSplash(false)}else{this.toggleSplash(true)}}}else{this.initExperience()}},toggleSplash:function(z){if(this.playerSplashScreen){if(z){this.playerSplashScreen.show()}else{this.playerSplashScreen.hide()}}},initExperience:function(){},fromTransition:function(){return false},createUIComponents:function(z){var D=this;this.paused=true;z.experience=this;this.UIManager=new x({frameWindow:z,ctx:this.args.ctx});this.PanelManager=new s({frameWindow:z,ctx:this.args.ctx});this.PanelManager.setTopBarId(this.args.options);var C=z.getActionBar();if((!window.__karma__||l.isSet("ODT_MAB"))&&this.mabModel){if(C.MAB){C.MAB.dispose()}var B=new c({ctx:this.ctx,frameWnd:z,exp:this,actionBar:C,model:this.mabModel,panelManager:this.PanelManager,alwaysOn:this._iOS||this._android,ios:this._iOS,pdf:this.isCurrentDocumentPDF});C.MAB=B;D.disposeFunctions.add(function(){var E=D.frmWindow.getActionBar();if(E){if(E.MAB){E.MAB.dispose()}}D=null})}var A=(this.args.options.showBubbleMenu===true||this.args.commandFullscreen||this.PanelManager.isTopBarAvailable()!==true)?"36px":"0";if(l.isBoolActive("3DPlay.WUXNotifs")){if(this.WUX_NotifScreens===undefined||this.WUX_NotifScreens===null){this.WUX_NotifScreens=k;i.setNotificationManager(this.WUX_NotifScreens)}}else{this.notifScreen=new v({marginTop:A});this.notifScreen.getContent().setStyle("transition","right 0.2s ease-in-out");this.notifScreen.inject(z.getUIFrame())}this.manageWorkBenchs({createActionBar:this.args.options.pad3DViewer!==undefined,frameWindow:z,finishCallBack:function(){var E=a.getCommands(D.ctx);if(E){var H=u.get("RenderPreference."+D._name+".Ambiance","none");if(H!=="none"&&E[H]){E[H].begin()}var F=u.get("RenderPreference."+D._name+".Shading","none");if(F!=="none"&&E[F]){E[F].begin()}var G=["VisuNoEnv","VisuV6Env","VisuCleanSpaceEnv","VisuDarkBlueEnv","VisuDarkGreyEnv","VisuShinyEnv"];G.forEach(function(I){if(E[I]){D.EventDisposer.add(WUX.Events.subscribe({event:"/WUX/AFR/CMD/"+D.ctx+"/"+I+"/END"},function(){u.set("RenderPreference."+D._name+".Ambiance",I)}))}})}D.publish("EXPERIENCE/EXPERIENCEREADY",D)}});if(this.notifScreen){this.UIManager.addToPanelEvent(this.notifScreen,function(E){D.notifScreen.restorePosition();if(E.visible){D.notifScreen.slide({left:E.size+10})}})}},updateConnection:function(z,A){if(A){A()}},createDom:function(B,z){if(!this.frmWindow){this.args.ui=this.args.ui||{displayTree:true};var A={context:this.args.ctx,height:"100%",minHeight:this.args.minHeight!==undefined?this.args.minHeight:0,viewerOptions:this.args.viewerOptions||this.args.visu||{},uiOptions:this.args.ui,onModelLoaded:this.onModelLoadingCompleted,language:this.args.lang};if(this.args.workbenchs&&this.args.workbenchs.length>0){this.workbenchIndex=0;var C=this.args.workbenchs[this.workbenchIndex];this.workbenchIndex++;A.workbenchModule=C.module;A.workbench=C.name+".xml";A.defaultCommand=C.defaultCommand!==undefined?C.defaultCommand:{ID:"",className:"DS.3DPlayCommands.EmptyCmd"};this.actionBarProfile=e.createProbe("ActionBar"+C.name);this.actionBarProfile.begin()}this.frmWindow=new B(A);this.frmWindow.inject(this.args.container)}if(this.args.iWebApplication){this.frmWindow=this.args.iWebApplication.createDom({frmWindow:this.frmWindow})}if(z){z.apply(this)}},getPhaseProgress:function(){return this.phaseProgress},_loadAssets:function(A,B){var F=this;if(this.frmWindow&&this.frmWindow.getModelLoader){var z=this.frmWindow.getModelLoader();if(B.convert===null||B.convert===undefined){B.convert={}}var E=[];if(B.convert.progressArray){E=E.concat(B.convert.progressArray)}else{var D=B.convert.progressDivisions||A.asset.length;E=F.getPhaseProgress().registerMultipleSubProgress(D)}var C={modelLoaderonLoadedCB:z.onLoadedCB,proportion:B.convert.progressProportion||1/A.asset.length,array:[].concat(A.asset),experience:this,phaseprogress:B.convert.progress||F.getPhaseProgress(),progressArray:[].concat(E),currentProgressID:undefined,ctx:this.args.ctx,currentmodel:undefined,options:g.extend({},B),nbAssetDelayed:B.convert.nbAssetToConvert||0,isWaiting:false,addNewFile:function(G){if(G!==null){C.array.push(G)}C.nbAssetDelayed=C.nbAssetDelayed-1;if(C.isWaiting){C.isWaiting=false;C.processNextFile()}},processNextFile:function(){if(this.currentmodel===undefined){if(this.options.clearSceneGraph===undefined||this.options.clearSceneGraph===null){this.options.clearSceneGraph=true}}else{this.options.clearSceneGraph=false;if(this.array.length>0){}}if(this.array.length>0){this.currentmodel=this.array.shift();this.currentProgressID=this.progressArray.shift();var G=this.experience;G.updateConnection({asset:this.currentmodel},function(){G.loadAsset({asset:this.currentmodel},this.options,false,this.profile);G=null}.bind(this));return}if(C.nbAssetDelayed===0){F.setOnLoadedCallback(this.experience.onModelLoadingCompleted);F.setOnProgressCallback(this.experience.onModelLoadingProgression);this.modelLoaderonLoadedCB()}else{C.isWaiting=true}},progress:function(G){G.currentProgressID=C.currentProgressID;this.experience.onModelLoadingProgression(G)}};this.setOnLoadedCallback(function(){C.phaseprogress.advanceToMax(C.currentProgressID);C.processNextFile()});this.setOnProgressCallback(function(G){C.progress(G)});C.processNextFile();return C}},load:function(F,C){var E=this;E.hasConvertFailed=false;if(C&&C.newAsset){w.endAllCommands({ctx:this.args.ctx,resetDefaultCmd:false});if(u.get("3DPlay.Video.Enabled")){var D=b.get(this.args.ctx,"3DP_Video_Controls");if(D){D.destroyUI();b.remove(this.args.ctx,"3DP_Video_Controls")}var z=b.get(this.args.ctx,"3DP_Video_Viewer");if(z){b.remove(this.args.ctx,"3DP_Video_Viewer")}}w.publish(this.args.ctx,"ASSET/CHANGE",{model:"clear",ctx:this.args.ctx})}if(C===undefined||C===null){C={}}if(this.playerSplashScreen){var B=(C)?C.splashscreen:null;this.playerSplashScreen.refreshOptions(B)}if(F.preProcessed!==true){console.error("3DPlayWeb: inputs should have been pre processed before call.");console.error("3DPlayWeb: Please consider using 3DPlayHelper or InputPreProcessor.")}var A=new y();A.run(F,function(K){var T=K;F=K;E._isReady=true;if(E._isReady!==true){E.args.input=F;E.args.options=C;return}if(E.frmWindow===undefined){return}if(T&&T.asset!==undefined&&Array.isArray(T.asset)===false){T.asset=[T.asset]}if(T&&T.asset!==undefined&&T.asset[0]!==undefined){var U=false;var H=true;if(C){U=(T===undefined||T.asset===undefined||T.asset[0]===undefined)&&C.clearSceneGraph===true;if(C.clearSceneGraph!==undefined&&C.clearSceneGraph!==null){H=C.clearSceneGraph}}if(E.notifTimeoutID){clearTimeout(E.notifTimeoutID);E.notifTimeoutID=null}if(U||H){if(E.showSplashBetweenLoad&&E.playerSplashScreen){E.playerSplashScreen.showView(E.playerSplashScreen.views.loading);E.toggleSplash(true)}E.clearView();E.getPhaseProgress().setIndeterminateState();E.xcadSupport.clearQueue()}else{E.autoReframe=false}if(U){E.publish("ASSET/LOADINGFINISHED",{model:"clear",ctx:this.args.ctx})}var Q=null,M={};var I=function(V){if(E.onModelLoadingError){E.onModelLoadingError(V)}t.inc("conversion-error-"+V.type);console.error("Conversion fails, see logs below :");console.error(V)};if(T.asset.length>1){var R=[],N=[];for(var L=0;L<T.asset.length;L++){if(T.asset[L]&&T.asset[L].useConvertors!==false){if(C&&C.tenant&&(T.asset[L].tenant===undefined||T.asset[L].tenant===null)){T.asset[L].tenant=C.tenant}Q=E.xcadSupport.getConversionFormat(T.asset[L].mimetype||T.asset[L].format);if(Q!==null){T.asset[L].dataFormat=Q;R.push(T.asset[L])}else{N.push(T.asset[L])}}}if(R.length>0){M.nbAssetToConvert=R.length;M.progress=E.getPhaseProgress();M.progressDivisions=N.length+R.length}var J=T;J.asset=N;var P=E._loadAssets(J,g.extend(C,{convert:M}));if(P&&R.length>0){this.notifTimeoutID=M.notifTimeoutID=setTimeout(function(){f.nls("3DPlay/Core","ConversionNeeded",function(V){w.sendEvent(E.args.ctx,eventType.notif,notification.info,{msg:V})})},6000);if(R.length>0){E.xcadSupport.convert(R,M,function(V,W){I(V);P.addNewFile(W)},function(W,V){E.playerSplashScreen.showView(E.playerSplashScreen.views.loading);P.addNewFile(W)},function(V){P.addNewFile(V)})}}}else{if(T.asset[0]===null||T.asset[0]===undefined){E.loadAsset(undefined,C);return}if(C&&C.tenant&&(T.asset[0].tenant===undefined||T.asset[0].tenant===null)){T.asset[0].tenant=C.tenant}var O=null;if(T.asset[0].useConvertors!==false&&E.xcadSupport.getConversionFormat(T.asset[0].mimetype||T.asset[0].format)!==null){Q=E.xcadSupport.getConversionFormat(T.asset[0].mimetype||T.asset[0].format);O=E.xcadSupport}if(Q===null){T.asset=T.asset[0];if(T.asset.plateformServices){E.updateConnection(T,function(){E.loadAsset(T,C)})}else{E.loadAsset(T,C)}}else{E.subProgressID=E.getPhaseProgress().registerSubProgress();E.getPhaseProgress().showProgressBar();T.asset[0].dataFormat=Q;var G=g.extend(C,{clearSceneGraph:true,convert:{progress:E.getPhaseProgress(),progressArray:[].push(E.subProgressID)},});E.notifTimeoutID=G.convert.notifTimeoutID=setTimeout(function(){f.nls("3DPlay/Core","ConversionNeeded",function(V){w.sendEvent(E.args.ctx,eventType.notif,notification.info,{msg:V})})},6000);var S=e.createProbe("Convert");S.begin();O.convert(T.asset[0],G.convert,function(W,X){S.end();var V={step:true,stp:true};if(X&&X.format&&V[X.format.toLowerCase()]){if(E.playerSplashScreen){E.playerSplashScreen.showView(E.playerSplashScreen.views.loading)}if(X){E._loadAssets({asset:X},G)}}else{I(W)}},function(V){S.end();if(E.playerSplashScreen){E.playerSplashScreen.showView(E.playerSplashScreen.views.loading)}E._loadAssets({asset:V},G)})}}}else{E.load(T,C)}g.extend(E.args.input,T);g.extend(E.args.options,C)})},loadAssets:function(z,A){console.error("Function not implemented - loadAsset")},_handleNotification:function(z){if(z.eventID===j.fatal){w.displayFatalError({ctx:z.ctx,msg:z.msg})}else{if(z.eventID===j.warning||z.eventID===j.info||z.eventID===j.success||z.eventID===j.error||z.eventID===j.assistance){if(this.WUX_NotifScreens){this.WUX_NotifScreens.addNotif({level:z.eventID,title:z.title||"Title",subtitle:z.subtitle||"Subtitle",message:z.msg,category:z.category||"3DPlay - "+this.ctx,sticky:false})}else{this.notifScreen.addNew(z)}this.publish("EXPERIENCE/NOTIF",{ctx:z.ctx,event:z.eventID,msg:z.msg})}else{f.nls("3DPlay/Core","IncorectNotif",function(A){console.error("3DPlay: "+A)})}}},setOnLoadedCallback:function(z){console.error("Function not implemented - AbstractExp")},setOnProgressCallback:function(z){console.error("Function not implemented - AbstractExp")},_step:function(){console.error("Function not implemented - AbstractExp")},step:function(){console.error("Function not implemented - AbstractExp")},preRenderCB:function(){console.error("Function not implemented - AbstractExp")},postRenderCB:function(){console.error("Function not implemented - AbstractExp")},preCreate:function(){console.error("Function not implemented - AbstractExp")},postCreate:function(){console.error("Function not implemented - AbstractExp")},onPreCreate:function(){console.error("Function not implemented - AbstractExp")},onPostCreate:function(){console.error("Function not implemented - AbstractExp")},addScenario:function(z){console.error("Function not implemented - AbstractExp")},getScenarioNumber:function(){console.error("Function not implemented - AbstractExp")},getScenario:function(z){console.error("Function not implemented - AbstractExp")},loadWorkbench:function(A,z){console.error("Function not implemented - AbstractExp")},changeScenario:function(A,z){console.error("Function not implemented - AbstractExp")},getDefaultScenario:function(){console.error("Function not implemented - AbstractExp")},manageScenario:function(){console.error("Function not implemented - AbstractExp")},getModelLoader:function(){console.error("Function not implemented - AbstractExp")},getScenarioManager:function(){console.error("Function not implemented - AbstractExp")},clearView:function(){if(this.notifScreen){this.notifScreen.clearAll()}},showContextualMenu:function(z){this._enableCMenu=z},addCallbacks:function(z){w.addCallbacks(this.args.ctx,z)},publish:function(z,A){p.publish({event:"/"+this.args.ctx+"/"+z+"/",data:A})},subscribe:function(C,A,z){var B=p.subscribe({event:"/"+this.args.ctx+"/"+C+"/"},A);if(z){this.EventDisposer.add(B)}return B},subscribeOnce:function(B,z){var A=p.subscribe({event:"/"+this.args.ctx+"/"+B+"/"},function(){p.unsubscribe(A);z.apply(undefined,arguments)})},unsubscribe:function(z){return p.unsubscribe(z)}})});define("DS/3DPlayExperienceModule/3DPlayExperience",["DS/3DPlay/3DPlay","DS/WebSystem/Environment","UWA/Core","DS/3DPlayExperienceModule/3DPlayAbstractExperience","DS/ApplicationFrame/CommandsManager","DS/3DPlay/3DPlayScenarioManager","DS/WebInfraUI/Notification","DS/WebUtils/StringUtils","DS/WebUtils/ContextedSingleton","DS/3DPlaySupport/SupportList","DS/3DPlaySupport/ExperiencesList","DS/3DPlaySupport/AssetSupport","DS/WebUtils/ProbesManager","DS/WebUtils/Statistics","DS/WebUtils/Tracker","DS/3DPlaySocialPanel/3DPlaySocialPanelManager","text!DS/3DPlayExperienceModule/assets/Tracker_Translation.json"],function(r,k,h,e,a,f,n,s,c,q,p,j,g,d,o,i,l){var b=1000;return e.extend({init:function(t){this.detectPlatform();this._parent(t);if(t.options.callback){this.setOnAnnotationShared(t.options.callback.onAnnotationShared)}if(t.commandApplication===undefined||t.commandApplication===true){t.workbenchs=t.workbenchs||[];t.workbenchs.unshift({name:"3DPlay",module:"3DPlay"});if(this._iOS){t.workbenchs.push({name:"3DPlayShare_iOS",module:"3DPlay"})}else{if(k.isSet("3DPlay.publishToMakeCmdTest")){t.workbenchs.push({name:"3DPlaySharePublishToMake",module:"3DPlay"})}else{t.workbenchs.push({name:"3DPlayShare",module:"3DPlay"})}}}if(k.isSet("3DPlay.Activate3DComment")){t.workbenchs.push({name:"3DPlayComment",module:"3DPlay"})}f.loadManager(this);this.ctx=this.args.ctx;this.modelLoadCount=0;this.modelTotalCount=0;this.modelLoadComplete=undefined;this.getPhaseProgress().setIndeterminateState();this.getPhaseProgress().addProgressBarIntoUI(t.container);var u=this;this.disposeFunctions.add(function(){u=null});this.onModelLoadingStarted=function(w){var y=u.loadAssetInfo||u.args.input.asset;if(!u.onAnnotationShared&&y){var A=(y.originalAsset)?y.originalAsset.physicalid:y.physicalid;var v=(y.originalAsset)?y.originalAsset.tenant:y.tenant;var z=y.serviceURL;var x=(y.originalAsset)?y.originalAsset.provider:y.provider;if(A&&v&&z){u.createSocialPanel(A,v,z,x)}}u.modelLoadComplete=false;u.publish("ASSET/LOADINGSTARTED",{data:u.modelName,ctx:u.args.ctx});r.endAllCommands({ctx:u.args.ctx,resetDefaultCmd:false});var B=(w!==undefined?w:true);if(B===true){u.getPhaseProgress().setIndeterminateState()}if(u.getPhaseProgress().getSubProgressDivisions()===0){u.subProgressID=u.getPhaseProgress().registerSubProgress()}u.getPhaseProgress().showProgressBar();if(u.useExperienceBase){if(true){u.experienceBase=this.requestNewExperienceBase();u.publish("EXPERIENCEBASE/NEW",{data:u.experienceBase})}else{u.experienceBase.webApplication.requestNewExperienceBaseAsync().then(function(){u.publish("EXPERIENCEBASE/NEW",{data:this.experienceBase})})}}u.modelLoadComplete=false};this.onModelLoadingProgression=function(w){if(u){var v=w.currentProgressID||u.subProgressID;if(v===null){v=u.subProgressID=u.getPhaseProgress().registerSubProgress()}else{if(u.subProgressID!==v){u.subProgressID=v}}if(w.loaded!==undefined&&w.total!==undefined&&w.total!==0){u.newPart=true;u.modelLoadCount=w.loaded;u.modelTotalCount=w.total;u.getPhaseProgress().setAbsoluteProgress(v,Math.round(w.loaded*100/w.total));u.publish("ASSET/LOADINGPROGRESS",{model:u.modelName,progress:w,ctx:u.ctx})}}};this.onModelLoadingCompleted=function(){if(u){if(u.getPhaseProgress()){u.getPhaseProgress().advanceToMax(u.subProgressID);u.getPhaseProgress().resetProgress();u.getPhaseProgress().hideProgressBar()}if(u.args.options.loading===loadingMode.preload){u.isLoaded=true}u.toggleSplash(false);u.modelLoadComplete=true;if(u.totalLoadingAssetProfiler){u.totalLoadingAssetProfiler.end()}var y=u.totalLoadingAssetProfile?y=Math.floor(u.totalLoadingAssetProfiler.getTime()):0;u.publish("ASSET/LOADINGFINISHED",{model:u.modelName,time:y,ctx:u.args.ctx,loadAssetInfo:u.loadAssetInfo});if(k.isSet("3DPlay.zzPCS")){var w=window.top.document.createEvent("CustomEvent");w.initCustomEvent("3DPlay.zzPCS",true,false,require("DS/WebUtils/ProbesManager").GetProcessedData());window.top.document.dispatchEvent(w)}if(k.isSet("3DPlay.ConsolePCS")){var x=g.GetProcessedData(true,true);var v={Timings:{},Memory:{},FIleStats:u.computeViewerStats()};x.sort(function(B,z){var C=B.startTime;var A=z.startTime;if(C<A){return -1}if(C>A){return 1}return 0});x.forEach(function(z){v.Timings[z.name]={startTime:z.startTime,duration:z.duration}});require("DS/WebSystem/Downloader")("3DPlay.QAPCS.json",new Blob([JSON.stringify(v)],{type:"text/plain"}))}if(u.args.input.annotation){u.loadAnnotations(u.args.input.annotation)}}};if(k.isSet("3DPlay.Statistics")){this.stats=new d();this.stats.set({container:this.args.container})}},detectPlatform:function(){this._iOS=Boolean(navigator.platform)&&/iPad|iPhone|iPod/.test(navigator.platform)||Boolean(navigator.userAgent)&&/iPad|iPhone|iPod/.test(navigator.userAgent);this._android=Boolean(navigator.userAgent)&&/Android/.test(navigator.userAgent)},comuteViewerStats:function(){return{}},getExperienceBase:function(){return this.experienceBase},getScenarioManager:function(){return f},loadScenario:function(){console.error("3DPlayExperience : Method Deprecated -> Use getScenarioManager Instead")},dispose:function(u){var t=c.get(this.args.ctx,"ANNOTATION_MANAGER");if(t){t.deleteAllAnnotations();c.remove(this.args.ctx,"ANNOTATION_MANAGER")}if(this.stats){if(this.stats.dispose){this.stats.dispose()}this.stats=null}f.dispose();if(this.currentLoadingAssetProfiler){if(this.currentLoadingAssetProfiler.dispose){this.currentLoadingAssetProfiler.dispose()}this.currentLoadingAssetProfiler=null}var v=require("DS/ApplicationFrame/AfrPlayerService");if(v){v._playerView={};v.hidePlayer();v.registerPlayerContainer(undefined)}if(this._3dCommentPanel){this._3dCommentPanel.dispose()}this._3dCommentPanel=undefined;this._parent(u);if(this.frmWindow){this.frmWindow.experience=null;this.frmWindow=null}},setOnLoadedCallback:function(){},setOnProgressCallback:function(){},step:function(){},_step:function(){if(this.stats){this.stats.postProcess()}},onPreCreate:function(){},onPostCreate:function(){},manageWorkBenchs:function(t){var y=t&&t.frameWindow?t.frameWindow:this.frmWindow;var x=t.finishCallBack;this.actionBarReady=false;if(y&&y.getActionBar()){var v,u;var w=function(){if(y.experience.workbenchIndex>0){if(this.actionBarProfile){this.actionBarProfile.end()}}var A;var z=this;if(z.workbenchIndex===undefined){z.workbenchIndex=0}if(z.workbenchIndex<z.args.workbenchs.length){A=z.args.workbenchs[z.workbenchIndex];z.actionBarProfile=g.createProbe("ActionBar_"+A.name);z.actionBarProfile.begin();z.loadWorkbench(A,z.workbenchIndex!==0);z.workbenchIndex++}else{A=z.args.workbenchs[z.args.workbenchs.length-1];if(A&&A.defaultCommand){A.defaultCommand.context=z.args.ctx;a.setDefaultCommand(A.defaultCommand)}z.actionBarReady=true;if(z.args.ui.onActionBarReady!==undefined){z.args.ui.onActionBarReady()}z.play();v=null;y._actionBar.removeCallback(u);if(x){x()}}};v=w.bind(this);u=y.onActionBarReady(v);if((t.createActionBar||this.enopadInited)&&v){v()}}},updateMAB:function(t){var u=this.frmWindow.getActionBar();if(u&&u.MAB){u.MAB.update(t)}},resetScenarioMAB:function(t){var v=t&&t.frameWindow?t.frameWindow:this.frmWindow;var u=v.getActionBar();if(u&&u.MAB){u.MAB.resetScenario()}},loadWorkbench:function(y,u,w){if(this.frmWindow){var z=(u!==undefined)?u:false;if(y.name!==undefined){var v=y.name;var t=this.args.ctx;if(s.getExtension(y.name)!=="xml"){v+=".xml"}var x=this.frmWindow.getActionBar();if(x){x.loadModel({context:t,file:v,module:y.module,merge:z===true});if(w&&x.MAB){x.MAB.loadScenarioWb(w,u)}}}}},initExperienceBase:function(t,u){if(u){u(0)}},disposeExperienceBase:function(t){if(t){t(0)}},initExperience:function(){this.onPreCreate();this.preCreate();this._postcreate=function(){this.createUIComponents(this.frmWindow);if(this.args.helpercb){this.args.helpercb(this,this.args.ctx)}var u=this.args.options.helper;if(!u){u=c.get(this.args.ctx,"helper")}if(u){u.instance=this;u.loaded=true;u.SupportList=q;u.ExperiencesList=p;u.AssetSupport=j}this.postCreate();this.onPostCreate();if(this.args.endDom){this.args.endDom(0)}this.initExperience2()};if(!this.frmWindow){var t=this.args.input.experience.filename||this.args.input.experience;this.subscribeOnce("EXPERIENCE/EXPERIENCEREADY",function(){setTimeout(function(){var x="ExperienceReady";g.end(x);var y=true,v={},u=g.GetProcessedData(false);for(var w=u.length;w--;){if(y&&u[w].name.indexOf("Pre-i")>-1){v[u[w].name]=u[w].startTime;y=false}else{v[u[w].name]=u[w].duration}}v.Experience=t;o.trackPageEvent("Timings",x,undefined,undefined,v,JSON.parse(l).Initialization)},500)});this.subscribe("ASSET/LOADINGFINISHED",function(w){if(this.skipLoadingStatistics){this.skipLoadingStatistics=false;return}var v=w.loadAssetInfo||this.args.input&&this.args.input.asset;if(v){if(this.modelName&&this.modelName!=="3DS_emblem.cgr"){var C={},y=g.GetSubProbesFrom(this.totalLoadingAssetProfiler,true);for(var x=y.length;x--;){C[y[x].name]=y[x].duration}if(Array.isArray(v)){v=v[0]}var A=v.provider,z=v.type,u=v.source,B=v.tenant;if(v.originalType){z=v.originalType}if(v.originalAsset){A=v.originalAsset.provider||A;z=z||v.originalAsset.format||v.originalAsset.dtype||v.originalAsset.type;u=u||v.originalAsset.source;B=B||v.originalAsset.tenant}if(B){o.setTenant(B)}if(u){o.trackPageEvent("drop",u,z)}o.trackPageEvent(o.getEmbederName(),A,z);C=h.extend(C,this.computeViewerStats());o.trackPageEvent("Timings","Loading",A+"-"+z,w.time?w.time:0,C,JSON.parse(l).Loading)}}}.bind(this),true);this.createDom(this.args.FrameWindow,this._postcreate);if(this.frmWindow){this.frmWindow.experience=this}}else{this.createDom(undefined,this._postcreate);this._postcreate()}},initExperience2:function(){if(this.args.options.loading===loadingMode.preload){}else{if(!this.args.options.splashscreen||!this.args.options.splashscreen.waitloading){this.toggleSplash(false)}}this.first=new Date().getTime();if(!this.frmWindow.getActionBar()){this.publish("EXPERIENCE/EXPERIENCEREADY",this)}if(!this.fromTransition()){this.totalLoadingAssetProfiler=g.createProbe("_Load_");this.totalLoadingAssetProfiler.begin();this.load(this.args.input,this.args.options)}},loadAnnotations:function(w,t){var u=c.get(this.args.ctx,"ANNOTATION_MANAGER");if(u){var v=new FileReader();v.addEventListener("loadend",function(x){setTimeout(function(){u.drawAnnotationsFromJSON(x.srcElement.result,t)},1000)});v.readAsText(w)}},createSocialPanel:function(w,t,v,u){if(!k.isSet("3DPlay.Activate3DComment")){return}if(this._3dCommentPanel){this._3dCommentPanel.dispose()}this._3dCommentPanel=undefined;if(w&&w&&v){this._3dCommentPanel=new i({frameWindow:this.frmWindow,assetId:w,tenantId:t,serviceUrl:v,assetProvider:u,onCommentClick:function(x){if(x.data&&x.data.annotationFile){this.loadAnnotations(x.data.annotationFile,true)}}.bind(this)})}},createComment:function(t){if(this._3dCommentPanel){this._3dCommentPanel.postComment(t.annotation,t.screenshot);return this._3dCommentPanel.show()}else{return false}},hideSocialPanel:function(){if(this._3dCommentPanel){return this._3dCommentPanel.hide()}else{return false}},setOnAnnotationShared:function(t){if(this._3dCommentPanel){this._3dCommentPanel.dispose()}this._3dCommentPanel=undefined;this.onAnnotationShared=t}})});var enopad=[];if(window.localStorage["3DPlay.pad3DViewer"]!=="false"){enopad.push("DS/ENOPAD3DViewer/PAD3DViewer");enopad.push("DS/PADUtils/PADUtilsServices")}define("DS/3DPlayExperienceModule/PlayExperience3D",["DS/WebappsUtils/WebappsUtils","DS/3DPlay/3DPlay","DS/WebSystem/Environment","UWA/Core","DS/3DPlayExperienceModule/3DPlayExperience","DS/ApplicationFrame/FrameWindow3D","DS/ApplicationFrame/CommandsManager","DS/WebUtils/Profiler","DS/3DPlayUtils/PanelManager","DS/3DPlayUtils/TestBrowser","DS/Visualization/Node3D","DS/WebUtils/StringUtils","DS/WebUtils/ContextedSingleton","DS/WebSystem/Nls","DS/Visualization/ModelLoader","DS/WebSystem/Settings","DS/Visualization/ThreeJS_DS","DS/WebInfraUI/Notification","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/WebViewer/SceneGraphHelper","css!DS/3DPlayExperienceModule/assets/PlayExperience3D","DS/WebUtils/ProbesManager","i18n!DS/3DPlayHelper/assets/nls/SplashScreen","DS/VCXWebExperienceBase/VCXExperienceBase","UWA/Promise","DS/WebRunloop/Runloop","DS/WebUtils/Tracker","DS/WAFData/WAFData","DS/VisuTools/StatsComputer","i18n!DS/3DPlayExperienceModule/assets/nls/3DPlayExperienceModule","DS/VisuEvents/EventsManager","DS/CoreEvents/Events"].concat(enopad),function(WebappsUtils,_3DPlay,Environment,UWA,EXPERIENCE,FrameWindow3D,CommandsManager,Profiler,PanelManager,TestBrowser,Node3D,StringUtils,ContextedSingleton,NLS,ModelLoader,Settings,THREE,Notification,SceneGraphOverrideSet,SceneGraphHelper,Css,ProbesManager,SplashScreenNLS,VCXExperienceBase,UWAPromise,Runloop,Tracker,WAFData,StatsComputer,prefs,VisuEventsManager,WUXEvent,ENOPAD3DViewer,PADUtilsServices){var endEdit;var Experience=EXPERIENCE.extend({name:"PlayExperience3D",refresh:function(){this.onModelLoadingStarted();if(this.pad3DViewer&&this.rootLoaded&&this.rootLoaded.length>0){this.pad3DViewer.refresh()}else{var asset=this.args.input.asset;if(asset&&asset.originalAsset){this.args.input.asset=asset.originalAsset}delete this.args.input.preProcessed;this.clearView();this.load(this.args.input,this.args.options)}return true},computeViewerStats:function(){var statsComputer=new StatsComputer(this.frmWindow.getViewer());var stats=statsComputer.computeStats();var values={};if(stats){stats.DownloadSize=this.loadingAsset.size;stats.DownloadTime=this.loadingAsset.download;for(var o in stats){if(stats.hasOwnProperty(o)){values[o]=stats[o]}}statsComputer.viewer=null;stats=statsComputer=null}return values},init:function(options){this.detectPlatform();this.evtTokenMouse=[];if(VisuEventsManager._isInit===undefined){VisuEventsManager.init()}this.loadingAsset={size:0,download:0};this.pad3DViewerTokens=[];options=options||{};options.FrameWindow=FrameWindow3D;this.useExperienceBase=true;if(options.input&&options.input.experience&&options.input.experience.filename==="DS/VCXWebComposer3DPlayExperience/VCXWebPlayerIn3DPlayExperience"){this.useExperienceBase=false}options.workbenchs=options.workbenchs||[];if(options.commandApplication===undefined||options.commandApplication===true){var wkbName;if(this._iOS||this._android){wkbName="3DPlayExperience3D_mobile"}else{wkbName=ENOPAD3DViewer&&Environment.get("3DPlay.VisuHack")==="haveHDCmd"?"3DPlayExperience3D_SwitchHD":"3DPlayExperience3D"}options.workbenchs.unshift({name:wkbName,module:"3DPlay"})}function isLoadAnimationValid(val){if(val==="Full"||val==="None"||val==="Optimized"||(!isNaN(val)&&(eval(val)>=0)&&(eval(val)%1===0))){return true}return false}var EnvLoadAnimation=Settings.get("3DPlay.LoadAnimation");if(!isNaN(EnvLoadAnimation)){EnvLoadAnimation=eval(EnvLoadAnimation)}if(isLoadAnimationValid(EnvLoadAnimation)){options.options.loadAnimation=EnvLoadAnimation}else{if(false===isLoadAnimationValid(options.options.loadAnimation)){options.options.loadAnimation="Optimized"}}this._parent(options);this.modelLoadCount=0;this.modelTotalCount=0;this.modelLoadComplete=undefined;this.showSplashBetweenLoad=false;NLS.loadNls("Visualization/3DXML_errors");var _this=this;var hideRefAxisCount=0;this.hideRefAxis=function(){hideRefAxisCount++;if(hideRefAxisCount>0){if(_this&&_this.frmWindow){var viewer=_this.frmWindow.getViewer();if(viewer&&viewer.setReferenceAxisSystem){viewer.setReferenceAxisSystem(false);viewer.render()}}}};this.showRefAxis=function(){hideRefAxisCount=Math.max(0,hideRefAxisCount-1);if(hideRefAxisCount===0){if(_this&&_this.frmWindow){var viewer=_this.frmWindow.getViewer();if(viewer&&viewer.setReferenceAxisSystem){viewer.setReferenceAxisSystem(true);viewer.render()}}}};var phaseProgress=this.getPhaseProgress();var ctx=_this.args.ctx;this.onModelLoadingError=function(e){if(e.rsc!==undefined){if(e.type==="Convert_SERVICE_NOT_FOUND"){_this.hasConvertFailed=true}NLS.nls(e.rsc,e.type,function(txtNls){if(e.text){txtNls+=e.text}_3DPlay.sendEvent(ctx,eventType.notif,e.level,{msg:txtNls});if(e.abort){phaseProgress.hideProgressBar()}})}else{if(_this.hasConvertFailed){NLS.nls("3DPlay/Core","Convert_SERVICE_NOT_FOUND",function(txtNls){_3DPlay.sendEvent(ctx,eventType.notif,Notification.fatal,{msg:txtNls});phaseProgress.hideProgressBar()})}else{NLS.nls("Visualization/3DXML_errors","ERROR_"+e.type,function(txtNls){var msg;if(e.type==="FORMAT"){NLS.nls("3DPlay/Core","LoadingError_"+e.type,function(txtNls){msg=txtNls+":"+StringUtils.getExtension(e.url);_this=false;_3DPlay.displayFatalError({ctx:ctx,msg:msg})})}else{if(e.type==="NO_GEOMETRY"){_3DPlay.displayNotification({ctx:ctx,msg:txtNls});phaseProgress.hideProgressBar()}else{msg=txtNls+" : "+e.url;_3DPlay.sendEvent(ctx,eventType.notif,Notification.error,{msg:txtNls});phaseProgress.hideProgressBar()}}if(msg!==undefined){console.error(msg)}})}}if(_this){_this.publish("ASSET/LOADINGERROR",UWA.extend({ctx:ctx},e))}};this.countRender=0;this.countBeforeRender=1;this.modelPrevLoadCount=0;this.renderTime=0;var viewpoint,canvas,frmWindow;this.postCreate=function(){var viewer;var options=this.args;if(options&&options.visu&&options.visu.showReferenceAxisSystem!==true){hideRefAxisCount++}viewpoint=this.frmWindow.getViewpoint();if(viewpoint){viewpoint.setDefaultController(true,options.visu.control);viewpoint.control.lockZ=true;viewpoint.control.setRotationSpeed(3.5)}viewer=this.frmWindow.getViewer();var node=this.pad3DViewer?this.getRootBag():null;if(node===null){this.rootbag=new Node3D("RootBag");viewer.addNode(this.rootbag);node=this.rootbag}this.modelLoader=new ModelLoader({node:node,viewer:this.frmWindow.getViewer()});if(this.modelLoader){if(options.modelLoader&&options.modelLoader.readDecoration!==undefined){this.modelLoader.readDecoration=options.modelLoader.readDecoration}this.modelLoader.setOnProgressCallback(this.onModelLoadingProgression);this.modelLoader.setOnLoadedCallback(this.onModelLoadingCompleted);this.modelLoader.setOnErrorCallback(this.onModelLoadingError)}viewer=this.frmWindow.getViewer();frmWindow=this.frmWindow;viewer.restoreAmbiance();viewer.restoreProjectionMode();viewer.restoreVisualizationMode({materialMode:true,renderFaceMode:THREE.ShowAllFaces,renderLineMode:THREE.ShowAllRenderLineMode,displayHiddenEdges:0});viewer.setMaterialMode(true);viewer.setRenderMode("BoundaryPoint",true);viewer.setRenderMode("SharpPoint",true);viewer.setRenderMode("FreePoint",true);viewer.setRenderMode("SurfacicPoint",false);viewer.setRenderMode("@InternalEdge",true);viewer.setRenderMode("@Edge",true);viewer=this.frmWindow.getViewer();viewer.getBagNode=function(){console.error("Please use 3DPlayExperience.getRootBag() rathen the Viewer.getBagNode()");return this.getRootBag()}.bind(this);viewer.deleteSceneGraphState=function(sceneName){var sceneGraphOverrideSetManager=this.getSceneGraphOverrideSetManager();if(sceneGraphOverrideSetManager){for(var i=sceneGraphOverrideSetManager.getNumberOfSceneGraphOverrideSets();i--;){var sgos=sceneGraphOverrideSetManager.getSceneGraphOverrideSetAt(i);if(sgos&&sgos.privateName===sceneName){sceneGraphOverrideSetManager.removeSceneGraphOverrideSetAt(i);if(sgos.helper){sgos.helper.dispose();sgos.helper=null}if(sgos.dispose){sgos.dispose()}}}}};viewer.getSceneGraph=function(sceneName){var sceneGraphOverrideSetManager=this.getSceneGraphOverrideSetManager();if(sceneGraphOverrideSetManager){for(var i=sceneGraphOverrideSetManager.getNumberOfSceneGraphOverrideSets();i--;){var sgos=sceneGraphOverrideSetManager.getSceneGraphOverrideSetAt(i);if(sgos&&sgos.helper&&sgos.helper.name===sceneName){return sgos.helper}}}return null};viewer.createSceneGraph=function(sgName,node){var sg=this.getSceneGraph(sgName);if(node===undefined){node=this.getBagNode()}if(!sg&&node){var sceneGraphOverrideSet=new SceneGraphOverrideSet(node);var sceneGraphOverrideSetManager=this.getSceneGraphOverrideSetManager();if(sceneGraphOverrideSetManager){if(sceneGraphOverrideSetManager.pushSceneGraphOverrideSet(sceneGraphOverrideSet)){sg=sceneGraphOverrideSet.helper=new SceneGraphHelper(sceneGraphOverrideSet,sgName)}}}return sg};viewer.displayPoints(true);this.EventDisposer.add(this.subscribe("ASSET/LOADINGFINISHED",function(data){this.oldradius=0;var node=viewer.getRootNode();if(node&&frmWindow&&frmWindow.experience){var exp=frmWindow.experience;var _3DPlayExperience=["DS/3DPlayModelViewer/3DPlayModelViewer","DS/3DPlayDefaultExperience/3DPlayDefaultExperience","DS/3DPlaySwymExperiences/3DPlaySwymExperience"];exp=exp.args.input.experience;if(exp&&_3DPlayExperience.indexOf(exp.filename)>-1){var bSphereRadius=node.getBoundingSphere().radius;if(bSphereRadius===0){Tracker.inc("input-no_geometry");NLS.nls("3DPlay/Core","LoadingError_NO_GEOMETRY",function(txtNls){_3DPlay.displayNotification({ctx:ctx,msg:txtNls})})}else{var axisNodes=node.getChildByName("AxisSystems");if(axisNodes){if(frmWindow.hello===undefined){frmWindow.hello=true;axisNodes.setVisibility(true)}else{axisNodes.setVisibility(frmWindow.hello)}}var annotData=_this.args.input.asset.annotData;if(Settings.get("3DPlay.PersistedAnnotationsEnabled")&&annotData){setTimeout(function(){_this._annotationManager=ContextedSingleton.get(ctx,"ANNOTATION_MANAGER");if(_this._annotationManager){_this._annotationManager.drawAnnotationsFromJSON(annotData)}},200)}}}if(typeof data.model!=="undefined"&&data.model&&data.model==="3DS_emblem.cgr"){_this.initialModel=true}else{_this.initialModel=false}}}));viewer.setPicking({activated:options.visu.picking||false,displayHL:options.visu.displayPicking||true,gpu:true,computeNormalDepth:false,primitive:false});viewer.setPrePicking({activated:options.visu.prePicking||false,displayHL:options.visu.displayPrePicking||true,gpu:true,computeNormalDepth:false,primitive:false});this.autoReframe=true;this.EventDisposer.add(this.subscribe("ASSET/LOADINGSTARTED",function(){_this.autoReframe=true;_this.userclicked=false;if(_this.pad3DViewer){var frmWindow_review=_this.pad3DViewer.getFrameWindow();if(frmWindow_review&&frmWindow_review.removeReviewModel){frmWindow_review.removeReviewModel()}}}));var modelcb=function(){if(_this.autoReframe){viewpoint.reframe(undefined,0)}viewer.render({updateInfinitePlane:true})};this.addCallbacks({asset:{LoadingFinished:modelcb}});var autoRefreshCB=function(){_this.autoReframe=false;_this.userclicked=true};this.evtTokenMouse.push(VisuEventsManager.addEvent(this.frmWindow.getViewerFrame(),"onLeftMouseDown",autoRefreshCB));this.evtTokenMouse.push(VisuEventsManager.addEvent(this.frmWindow.getViewerFrame(),"onRightMouseDown",autoRefreshCB));this.evtTokenMouse.push(VisuEventsManager.addEvent(this.frmWindow.getViewerFrame(),"onMiddleMouseDown",autoRefreshCB));this.evtTokenMouse.push(VisuEventsManager.addEvent(this.frmWindow.getViewerFrame(),"onMouseWheel",autoRefreshCB));this.evtTokenMouse.push(VisuEventsManager.addEvent(this.frmWindow.getViewerFrame(),"onTouch",autoRefreshCB));this.PanelManager.createTopMenu({ctx:options.ctx,container:this.frmWindow.getUIFrame(),experience:this,showBubbleMenu:this.args.options.showBubbleMenu});this.PanelManager.createDefaultHelp();this.disposeFunctions.add(function(){autoRefreshCB=null})};this.disposeFunctions.add(function(){frmWindow=null;viewpoint=null;canvas=null;_this=null})},initExperienceBase:function(iexperience,endcallback){var ctxmanager=this.experienceBase._ManagerSet.getManager("VCXContextManager");var node=this.getRootBag();this.frmWindow.getViewer().addNode(node);ctxmanager.setRootNode(node);if(endcallback){endcallback(0)}},requestNewExperienceBase:function(){if(this.runloop){this.runloop.stop();this.runloop.dispose();this.runloop=null}if(this.experienceBase){this.disposeExperienceBase();this.experienceBase._ManagerSet.unInitialize();this.experienceBase.Clean();this.frmWindow._experienceBase=null;this.experienceBase.webApplication=null;this.experienceBase.modelLoader=null;this.experienceBase=null}this.experienceBase=new VCXExperienceBase(null);this.experienceBase.webApplication=this;this.frmWindow._experienceBase=this.experienceBase;this.initExperienceBase(this.experienceBase);this.experienceBase._ManagerSet.initialize();var ctxmanager=this.experienceBase._ManagerSet.getManager("VCXContextManager");if(ctxmanager){ctxmanager.setFrameWindow(this.frmWindow)}this.experienceBase._ManagerSet.postInitialize();this.profileFrame=Profiler.start("Runloop");this.runloop=new Runloop({data:this,func:this.runloopFunc});this.runloop.start();this.experienceBase.webApplication=this;return this.experienceBase},requestNewExperienceBaseAsync:function(){var _this=this;return new UWAPromise(function(resolve){if(_this.runloop){_this.runloop.stop();_this.runloop.dispose();_this.runloop=null}var promiseDispose=_this.experienceBase&&_this.disposeExperienceBase();if(!promiseDispose){promiseDispose=new UWAPromise(function(resolve){resolve()})}promiseDispose.then(function(){var uninitPromise=_this.experienceBase&&_this.experienceBase._ManagerSet&&_this.experienceBase._ManagerSet.unInitialize();if(!uninitPromise){uninitPromise=new UWAPromise(function(resolve){resolve()})}uninitPromise.then(function(){if(_this.experienceBase){_this.experienceBase.Clean();_this.frmWindow._experienceBase=null;_this.experienceBase.webApplication=null;_this.experienceBase.modelLoader=null;_this.experienceBase=null}_this.experienceBase=new VCXExperienceBase(null);_this.frmWindow._experienceBase=_this.experienceBase;_this.experienceBase.webApplication=_this;_this.initExperienceBase(_this.experienceBase,function(){});var promiseInitialize=_this.experienceBase._ManagerSet.initialize();promiseInitialize.then(function(){var ctxmanager=_this.experienceBase._ManagerSet.getManager("VCXContextManager");if(ctxmanager){ctxmanager.setFrameWindow(_this.frmWindow)}_this.frmWindow._experienceBase=_this.experienceBase;_this.experienceBase._ManagerSet.postInitialize().then(function(){_this.profileFrame=Profiler.start("webApplication::frame");_this.runloop=new Runloop({data:_this,func:_this.runloopFunc});_this.runloop.start();resolve(_this.experienceBase)})})})})})},runloopFunc:function(iOptions){this.profileFrame.start();var ctxmanager=this.experienceBase._ManagerSet.getManager("VCXContextManager");var options=UWA.extend({viewer:this.frmWindow.getViewer()},iOptions,true);var stepProfile=this.profileFrame.addProfile("3DPlay::Step");this.skipRender=false;this._step.apply(this,[arguments[0].time,arguments[0].profiler]);stepProfile.stop();options.profiler=this.profileFrame.addProfile("managerSet::update");this.experienceBase._ManagerSet.update(options);if(this.skipRender){this.skipRender=false}else{var _this=this;ctxmanager.applyToViewers(function(currentViewer){if(currentViewer._modelEvent&&!currentViewer.registredCBs){currentViewer.registredCBs={preToken:currentViewer._modelEvent.subscribe({event:"PreRender"},function(data){data.profiler=_this.profile_animate.addProfile("preRender");_this.experienceBase._ManagerSet.preRender(data);_this.profile_render=_this.profile_animate.addProfile("render")}),postToken:currentViewer._modelEvent.subscribe({event:"PostRender"},function(data){data.renderingTime=_this.profile_render.stop();data.profiler=_this.profile_animate.addProfile("postRender");_this.experienceBase._ManagerSet.postRender(data)})};currentViewer.defaultAnimationLoop=false;_this.disposeFunctions.add(function(){_this=null})}_this.profile_animate=_this.profileFrame.addProfile("viewer["+currentViewer.id+"]::animate");currentViewer.animate();_this.profile_animate.stop()});this.nbrender=this.nbrender||0;this.nbrender++}options.viewer=this.viewer?ctxmanager.getMainViewer():null;options.profiler=this.profileFrame.addProfile("managerSet::postUpdate");this.experienceBase._ManagerSet.postUpdate(options);this.profileFrame.stop()},dispose:function(options){this.args.options.pad3DViewer=null;if(this.evtTokenMouse){this.evtTokenMouse.forEach(function(token){VisuEventsManager.removeEventFromToken(token)});this.evtTokenMouse=undefined}if(endEdit&&typeof widget!=="undefined"){widget.removeEvent("endEdit",endEdit)}_3DPlay.endAllCommands({ctx:this.ctx,resetDefaultCmd:true});this.publish("EXPERIENCE/DISPOSE",{exprience:this});if(this.intervalTimer){clearInterval(this.intervalTimer)}this.modelLoader.abort();if(this.modelLoader.dispose){this.modelLoader.dispose()}this.modelLoader=null;var landingPage=window.document.getElementById("landing-page_container");if(landingPage){landingPage.remove()}if(this.pad3DViewer){this.pad3DViewer.show()}if(this.pad3DViewer){this.deletePad3DViewerCBs();options=options||{};var disposePAD=false;if(options.disposeFrameWindow===true||options.disposeFrameWindow===undefined){disposePAD=true;options.disposeFrameWindow=false}if(options.disposeFrameWindow===false){if(this.experienceBase&&this.experienceBase._ManagerSet){var vcxContextManager=this.experienceBase._ManagerSet.getManager("VCXContextManager");if(vcxContextManager){vcxContextManager._nRootNode=null}}}var viewer=this.frmWindow.getViewer();viewer.deleteSceneGraphState=null;viewer.getSceneGraph=null;viewer.createSceneGraph=null;viewer.getBagNode=null;if(this.experienceBase){this.frmWindow._experienceBase=null;var _this=this;this.disposeExperienceBase(function(){if(_this.runloop){_this.runloop.stop();_this.runloop.dispose();_this.runloop=null}var uninitPromise=_this.experienceBase&&_this.experienceBase._ManagerSet&&_this.experienceBase._ManagerSet.unInitialize();if(!uninitPromise){uninitPromise=new UWAPromise(function(resolve){resolve()})}uninitPromise.then(function(){var ctxmanager=_this.experienceBase._ManagerSet.getManager("VCXContextManager");ctxmanager.applyToViewers(function(currentViewer){if(currentViewer.registredCBs){currentViewer.defaultAnimationLoop=true;if(!currentViewer.disposed){currentViewer._modelEvent.unsubscribe(currentViewer.registredCBs.preToken);currentViewer._modelEvent.unsubscribe(currentViewer.registredCBs.postToken)}delete currentViewer.registredCBs;currentViewer.animate()}});if(_this.experienceBase){_this.experienceBase.Clean();_this.experienceBase.webApplication=null;_this.experienceBase=null}_this=null})})}if(this.pad3DViewerConfig.changeVisuModeCmdAvailability){this.pad3DViewer.changeVisuModeCmdAvailability=null;this.pad3DViewer.changeVisuModeCmdAvailability=this.pad3DViewerConfig.changeVisuModeCmdAvailability;this.pad3DViewerConfig.changeVisuModeCmdAvailability=null}if(disposePAD){this.pad3DViewer.destroy();this.frmWindow._viewpoint=null;this.frmWindow._sceneGraphTree=null;this.frmWindow._private_sceneGraph=null;CommandsManager._cmdCheckHeader={};CommandsManager._commands={}}else{this.frmWindow.getViewpoint().setDefaultController(true,this.pad3DViewerConfig.ControlMode);this.pad3DViewer.setRobotVisibility(this.pad3DViewerConfig.Robot);this.pad3DViewer.setDefaultProgressBarVisibility(this.pad3DViewerConfig.Progress);this.pad3DViewer.setAutomaticReframePolicy(this.pad3DViewerConfig.Reframe);this.pad3DViewer.setDefaultContextualMenuVisibility(this.pad3DViewerConfig.Menu);this.pad3DViewer.setDefaultContextualBarVisibility(this.pad3DViewerConfig.Bar);this.pad3DViewer.elements.container.addEventListener("dragenter",this.pad3DViewer._dndCB[0]);this.pad3DViewer.elements.container.addEventListener("dragover",this.pad3DViewer._dndCB[0]);this.pad3DViewer.elements.container.addEventListener("dragleave",this.pad3DViewer._dndCB[1]);this.pad3DViewer.elements.container.addEventListener("dragend",this.pad3DViewer._dndCB[1]);this.pad3DViewer.elements.container.addEventListener("drop",this.pad3DViewer._dndCB[2]);this.pad3DViewerConfig.toShow();var node=this.getRootBag();if((node&&node.children&&node.children.length>0)||(this.rootLoaded&&this.rootLoaded.length>0)){this.pad3DViewer._dropZoneContainer.elements.container.hide()}this.pad3DViewer._dropZoneContainer.options.mode=this.pad3DViewerConfig.DropMode}this._parent(options);this.pad3DViewerConfig=null;this.pad3DViewer=null}else{this._parent(options)}},preCreate:function(){var defaultValues={visu:{antiAliasing:true,useShadowMap:true,infinitePlane:true,displayGrid:false,displayLines:false,debugShadowLight:false,debugBSphere:false,debugBBox:false,control:"COMBINED",picking:true,displayPicking:true,prePicking:false,displayprePicking:false,autoUpdatePlane:true,useMirror:true,defaultAnimationLoop:false,multiViewerFix:true},ui:{displayTree:Environment.isBoolActive("3DPlay.Debug.DisplayTree"),displayActionBar:true}};window.nearFarBigScale=true;this.args=UWA.extend(defaultValues,this.args,true);this.args.touch=(("ontouchstart" in window)||(navigator.MaxTouchPoints>0)||(navigator.msMaxTouchPoints>0))},_step:function(){if(this.modelLoadComplete===undefined){}else{if(this.modelLoadComplete===false){this.skipRender=true;var needReframe=false,needRender=false,viewer=this.frmWindow.getViewer();if(this.forceRender){this.forceRender=false;needReframe=needRender=true}else{if(this.newPart){this.newPart=false;if(this.args.options.loadAnimation==="Optimized"){if(this.autoReframe){var radius_change=1.3;var node=viewer.getRootNode();var radius=node.getBoundingSphere().radius;if((this.oldradius*radius_change)<radius){needRender=true;needReframe=true;this.oldradius=radius;this.modelPrevLoadCount=this.modelLoadCount}}if(!needRender){var nextstep=this.userclicked?this.modelPrevLoadCount+1:this.modelPrevLoadCount+Math.max(1,this.modelTotalCount*0.08);if(this.modelLoadCount>nextstep){this.modelPrevLoadCount=nextstep;needRender=true}}}else{if(this.args.options.loadAnimation==="Full"){needReframe=true;needRender=true}else{if(this.args.options.loadAnimation==="None"){}else{if(this.modelLoadCount>this.modelPrevLoadCount+this.args.options.loadAnimation){this.modelPrevLoadCount=this.modelLoadCount;needReframe=true;needRender=true}}}}}}if(needReframe&&this.autoReframe){var viewpoint=viewer.currentViewpoint;viewpoint.reframe(undefined,0)}if(needRender||this.userclicked){this.skipRender=false;viewer.render()}}else{if(this.ProfileFrame!==true&&Environment.isBoolActive("3DPlay.ProfileFrame")){this.ProfileFrame=true;this.renderTime+=this.lastRender;console.log("AllRenderTime: ",this.renderTime," for",this.nbrender,"frames ");console.log("LastRender: ",this.lastRender)}if(Environment.isBoolActive("3DPlay.PCS")){var res=ContextedSingleton.get(this.args.ctx,"3DPlay.PCS");if(!res){var PCSresult=ProbesManager.GetProcessedData({topWindow:false});var event=window.top.document.createEvent("CustomEvent");event.initCustomEvent("PCSDONE",true,false,PCSresult);setTimeout(function(){window.top.document.dispatchEvent(event)},1000);PCSresult.Render={LastRenderedFrame:this.lastRender,TimeRenderedLoadingFrames:this.renderTime,NumberLoadingFrames:this.nbrender};ContextedSingleton.add(this.args.ctx,"3DPlay.PCS",PCSresult)}}}}this._parent()},preRenderCB:function(){},postRenderCB:function(){},setOnLoadedCallback:function(func){if(this.modelLoader){this.modelLoader.setOnLoadedCallback(func)}},setOnProgressCallback:function(func){if(this.modelLoader){this.modelLoader.setOnProgressCallback(func)}},getModelLoader:function(){return this.modelLoader},getRootBag:function(){if(this.pad3DViewer){var rootbagPath=this.pad3DViewer.getRootBagPath();if(rootbagPath){return rootbagPath.getLastElement()}}if(this.rootbag){return this.rootbag}var viewer=this.frmWindow.getViewer();if(viewer.getBagNode){return viewer.getBagNode()}return viewer.getRootNode()},manageKinematicsDatas:function(){this.hook=false;var tab=["CATPart","CATProduct","SW Assembly Family","SW Assembly Instance","SW Component Family","SW Component Instance"];var asset=this.args.lastLoad;if(asset&&asset.dtype&&tab.indexOf(asset.dtype)===-1&&this.getRootBag().children!==undefined&&this.getRootBag().children[0]!==undefined&&this.args.input.experience){var that=this;if(Environment.isBoolActive("3DPlay.Debug.SkipKinematics")){that.onModelLoadingCompleted()}else{var p=ProbesManager.createProbe("Kinematics");p.begin();var depends=["DS/3DPlayExperienceModule/VisuDataAccess/Ox4MQLV6Loader2","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/Visualization/Utils"];require(depends,function(Ox4MQLV6Loader,Ox4ProxyAbstraction,VisuUtils){var Ox4MQLV6LoaderInst=new Ox4MQLV6Loader(that.modelLoader.glContext,that.modelLoader.renderCB,that.modelLoader.debugBBox,that.modelLoader.geometryMode);that.modelLoader.buildPath(asset);VisuUtils.setProxyFromSpec(asset,Ox4ProxyAbstraction);Ox4MQLV6LoaderInst.load(asset,function(){p.end();p=null;that.onModelLoadingCompleted();that=null},function(){},function(){},function(){that.onModelLoadingCompleted()},{productNode:that.getRootBag().children[0]})},function(){that.onModelLoadingCompleted();that=null})}}else{this.onModelLoadingCompleted()}},createPad3DViewerCBs:function(){var that=this;this.pad3DViewerTokens=this.pad3DViewerTokens||[];var enopad=(this.args.options.callbacks!==undefined)?this.args.options.callbacks.enopad:undefined;if(enopad){for(var i in enopad){var token=this.pad3DViewer.subscribe({event:i},enopad[i]);this.pad3DViewerTokens.push(token)}}this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onUrlLoaded"},function(a){that.enopadStatistics=a}));this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onRootRemoved"},function(){if(that.pad3DViewer._dropZoneContainer){var dropInvite=that.pad3DViewer._dropZoneContainer.elements.container;if(!dropInvite.isHidden()){dropInvite.hide()}}}));this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onProgress"},function(a){var data={},str=a.message;try{if(str){var idx=str.indexOf("3D: ");if(idx>-1){var idx2=str.indexOf(" part");if(idx2>-1){str=str.substring(idx+4,idx2);var temp=str.split(" of ");if(temp&&temp.length===2){data.loaded=parseInt(temp[0]);data.total=parseInt(temp[1])}}}}}catch(e){}if(data.loaded===undefined){data.loaded=a.progression}that.onModelLoadingProgression(data)}));this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLoadingComplete"},function(){that.enopadLoading=false;if(that.canceled){that.canceled=false}else{that.manageKinematicsDatas()}}));this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onStartAsync"},function(){that.frmWindow.getActionBar()._afr.elements.container.removeClassName("enopad3Dviewer_actionbar_disabled")}));this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLoadingFailure"},function(){that.canceled=that.enopadLoading=false;that.phaseProgress.hideProgressBar()}));this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLoadingCanceled"},function(){that.enopadLoading=false;that.canceled=true;that.phaseProgress.hideProgressBar()}));this.disposeFunctions.add(function(){that=null})},deletePad3DViewerCBs:function(){if(this.pad3DViewerTokens){for(var i=this.pad3DViewerTokens.length;i--;){this.pad3DViewer.unsubscribe(this.pad3DViewerTokens[i])}this.pad3DViewerTokens=[]}},createDom:function(iOptions,callbackwiththistocall){if(this.args.options.pad3DViewer){this.pad3DViewer=this.args.options.pad3DViewer;this.frmWindow=this.pad3DViewer.getFrameWindow();this.customizePad3DViewer();this._parent(iOptions);callbackwiththistocall.apply(this)}else{if(ENOPAD3DViewer){var frmWndOptions={context:this.args.ctx,height:"100%",minHeight:this.args.minHeight!==undefined?this.args.minHeight:0,viewerOptions:this.args.visu||{},uiOptions:this.args.ui||{},onModelLoaded:this.onModelLoadingCompleted,language:this.args.lang};frmWndOptions.viewerOptions.highlight={activated:this.args.visu.picking,displayHL:this.args.visu.displayPicking};frmWndOptions.viewerOptions.pHighlight={activated:this.args.visu.prePicking,displayHL:this.args.visu.displayprePicking};if(this.args.workbenchs&&this.args.workbenchs.length>0){this.workbenchIndex=0;var wk=this.args.workbenchs[this.workbenchIndex];this.workbenchIndex++;frmWndOptions.workbenchModule=wk.module;frmWndOptions.workbench=wk.name+".xml";frmWndOptions.defaultCommand=wk.defaultCommand!==undefined?wk.defaultCommand:{ID:"",className:"DS.3DPlayCommands.EmptyCmd"};this.actionBarProfile=ProbesManager.createProbe("ActionBar_"+wk.name);this.actionBarProfile.begin()}else{frmWndOptions.workbench=false;frmWndOptions.defaultCommand={ID:"",className:"DS.3DPlayCommands.EmptyCmd"}}var enopadoptions={widget:window.widget?window.widget:frmWndOptions.widget,windowOptions:frmWndOptions};if(this.args.options.enopad){enopadoptions=UWA.extend(enopadoptions,this.args.options.enopad,true)}if(enopadoptions.allowAuthoring===undefined){enopadoptions.allowAuthoring=true}enopadoptions.authorizeSet3DStructure=false;if(this.args.options.platformServices){enopadoptions.plateformServices=this.args.options.platformServices}enopadoptions.getPlatformServicesInBackground=true;if(undefined===window.HybridApp&&this.args.input&&this.args.input.asset&&((this.args.input.asset.provider&&this.args.input.asset.provider==="EV6")||this.args.input.asset.dtype!==undefined)){enopadoptions.getPlatformServicesInBackground=false}enopadoptions.windowOptions.robotVisibility=false;enopadoptions.interwidgetComAvailability=true;this.ENOPADConnectorPolicy="cgr";enopadoptions.loadCGRAsDefaultStream=this.ENOPADConnectorPolicy;if(Environment.isSet("3DPlay.ENOPAD.dynamicRepLoading")){enopadoptions.dynamicRepLoading=true}this.pad3DViewer=new ENOPAD3DViewer(enopadoptions);this.frmWindow=this.pad3DViewer.getFrameWindow();this.pad3DViewer.inject(this.args.container);var _that=this;_that.disposeFunctions.add(function(){_that=null});if(Environment.isSet("3DPlay.FUN088072.Disable")){}else{if(this.args.CGRPolicy===true){var prefName="3DPlay.CGRPolicy";var update=function(){if((Environment.get(prefName)||"index")==="base"){this.ENOPADConnectorPolicy="cgr"}else{this.ENOPADConnectorPolicy="thumbnail";if(!this.frmWindow){console.error("this.frmWindow",this.frmWindow)}else{var viewer=this.frmWindow.getViewer();viewer.setMaterialMode(false);viewer.setRenderMode("Face",true);viewer.setRenderMode("@Edge",true);viewer.setRenderMode("@InternalEdge",false);viewer.setRenderMode("Outline",false);viewer.displayHiddenEdges(0)}}this.pad3DViewer.getController()._setDefaultStreamToLoad(this.ENOPADConnectorPolicy)};var widget=window.widget;if(widget){var appid=widget.getValue("appId");if((appid==="X3DPLAW_AP"||appid==="X3DCSMA_AP")&&widget.hasPreference&&!widget.hasPreference(prefName)){var CGRPolicy=Environment.get(prefName)||"index";widget.addPreference({name:prefName,defaultValue:prefs[CGRPolicy],type:"list",label:appid==="X3DPLAW_AP"?prefs.Label:prefs.Label_External_App,options:[{label:prefs.index,value:"index"},{label:prefs.base,value:"base"},{label:prefs.auto,value:"auto"}]});var endEdit=function(saved){if(_that&&saved&&saved.submitted){update.apply(_that)}};widget.addEvent("endEdit",endEdit)}}update.apply(this)}}var func=_that._parent;this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onReady"},function(){if(_that.enopadInited){return}_that.enopadInited=true;_that.experienceBase=_that.requestNewExperienceBase();func.apply(_that,[iOptions]);_that.customizePad3DViewer();callbackwiththistocall.apply(_that);func=null}))}else{this._parent(iOptions,callbackwiththistocall)}}},customizePad3DViewer:function(){this.createPad3DViewerCBs();var trans=["CATIA","SIMPLE","COMBINED"];this.pad3DViewerConfig={ControlMode:trans[this.frmWindow.getViewpoint().control._mode],Robot:this.pad3DViewer.isRobotVisible(),Progress:this.pad3DViewer.getDefaultProgressBarVisibility(),Reframe:this.pad3DViewer.getAutomaticReframePolicy(),Menu:this.pad3DViewer.isDefaultContextualMenuVisible(),Bar:this.pad3DViewer.isDefaultContextualBarVisible(),toHide:function(elem){elem.hide();this.hideshowElem=this.hideshowElem||[];this.hideshowElem.push(elem)},toShow:function(){if(this.hideshowElem){for(var i=0;i<this.hideshowElem.length;i++){this.hideshowElem[i].show()}this.hideshowElem=null}}};this.pad3DViewerConfig.changeVisuModeCmdAvailability=this.pad3DViewer.changeVisuModeCmdAvailability;this.pad3DViewer.changeVisuModeCmdAvailability=function(v){console.log("changeVisuModeCmdAvailability",v)};if(Environment.isBoolActive("3DPlay.UseBase")){this.pad3DViewer.getController().switchAuthoringMode(true)}var that=this;this.intervalTimer=undefined;var hideDragNDrop=function(){try{if(that.pad3DViewer._dropZoneContainer&&that.pad3DViewer._dropZoneContainer.elements.container){that.pad3DViewerConfig.DropMode=that.pad3DViewer._dropZoneContainer.options.mode;that.pad3DViewer._dropZoneContainer.options.mode="none";that.pad3DViewer.elements.container.removeEventListener("dragenter",that.pad3DViewer._dndCB[0]);that.pad3DViewer.elements.container.removeEventListener("dragover",that.pad3DViewer._dndCB[0]);that.pad3DViewer.elements.container.removeEventListener("dragleave",that.pad3DViewer._dndCB[1]);that.pad3DViewer.elements.container.removeEventListener("dragend",that.pad3DViewer._dndCB[1]);that.pad3DViewer.elements.container.removeEventListener("drop",that.pad3DViewer._dndCB[2]);var dropInvite=that.pad3DViewer._dropZoneContainer.elements.container;if(!dropInvite.isHidden()){that.pad3DViewerConfig.toHide(dropInvite)}if(that.intervalTimer!==undefined){clearInterval(that.intervalTimer);that=null}}else{if(that.intervalTimer===undefined){that.intervalTimer=setInterval(hideDragNDrop,2)}}}catch(err){if(that.intervalTimer===undefined){that.intervalTimer=setInterval(hideDragNDrop,2)}}};hideDragNDrop();var elem=window.document.getElementById("BubbleContainer");if(elem&&!elem.isHidden()){this.pad3DViewerConfig.toHide(elem)}var _that2=this;var hidepad_status=function(){var i=window.document.getElementsByClassName("pad_status");if(i){i=i[0];if(i){_that2.pad3DViewerConfig.toHide(i);_that2=null}else{setTimeout(hidepad_status,50)}}};hidepad_status();this.pad3DViewer.setRobotVisibility(false);this.pad3DViewer.setDefaultProgressBarVisibility(false);this.pad3DViewer.setAutomaticReframePolicy(false);this.pad3DViewer.setDefaultContextualMenuVisibility(false);this.pad3DViewer.setDefaultContextualBarVisibility(false);this.frmWindow=this.pad3DViewer.getFrameWindow()},clearView:function(){var viewer=this.frmWindow.getViewer();this.notifScreen.clearAll();var node=this.getRootBag();if(node&&node.children&&node.children.length>0){node.removeChildren()}this.modelLoader.setSceneGraph(node);viewer.render();this.autoReframe=true;if(this.pad3DViewer&&this.rootLoaded&&this.rootLoaded.length>0){if(this.modelLoadComplete===false){if(this.enopadLoading){var controler=this.pad3DViewer.getController();try{if(controler.abortLoading){controler.abortLoading()}}catch(err){}this.progress.hide()}else{this.pad3DViewer.removeRoots({pids:this.rootLoaded})}}else{this.pad3DViewer.removeRoots({pids:this.rootLoaded})}this.rootLoaded=[]}else{if(this.modelLoadComplete===false){this.modelLoader.abort()}}},fromTransition:function(){if(this.args.options.pad3DViewer!==undefined&&this.args.options.pad3DViewer!==null){this.modelName=this.loadAssetInfo=UWA.clone(this.args.input.asset);this.args.lastLoad=this.loadAssetInfo=this.args.input.asset;this.rootLoaded=this.loadAssetInfo?this.loadAssetInfo.physicalid:[];this.skipLoadingStatistics=true;this.onModelLoadingStarted();this.manageKinematicsDatas();return true}return false},updateConnection:function(input,cb){if(input.asset&&input.asset.plateformServices){this.pad3DViewer.connectToPlatform({plateformServices:input.asset.plateformServices,readyCB:cb,allowAuthoring:false})}else{cb()}},zLockExemptionList:["sldasm","sldprt"],loadModel:function(input,iOptions,iDisplayProgress){if(this.modelLoadComplete===false&&this.rootLoaded&&this.rootLoaded.length===1){this.loadingpending=arguments;return}var viewer=this.frmWindow.getViewer();var asset=input?input.asset:this.args.input?this.args.input.asset:null;var diplayEmblem=(asset===null||asset===undefined||asset===""||((typeof asset)!=="string")&&(asset.filename===undefined||asset.filename===null||asset.filename==="")&&(asset.physicalid===undefined||asset.physicalid===null||asset.physicalid===""));if(diplayEmblem===true&&!this.args.options.pad3DViewer){asset=WebappsUtils.getWebappsBaseUrl()+"3DPlay/assets/models3d/3DS_emblem.cgr"}var name="";var modelLink=asset;var viewpoint=this.frmWindow.getViewpoint();viewpoint.control.lockZ=true;if((typeof modelLink)==="string"){if(modelLink===""){return}name=modelLink;var ext=StringUtils.getExtension(modelLink);if(ext!==""){ext=ext.toLowerCase();if(ext!=="3dxml"){this.modelLoader.setFileType(ext)}}}else{if(modelLink.provider===undefined||modelLink.provider===null||modelLink.provider.toLowerCase()==="file"){name=modelLink.filename;if(name===undefined||name===null||name===""){return}}if(this.zLockExemptionList.indexOf(modelLink.originalType)!==-1){viewpoint.control.lockZ=false}}var _this=this;this.disposeFunctions.add(function(){_this=null;if(WAFData.handleRequest_HOOKED){WAFData.handleRequest=WAFData.handleRequest_HOOKED;WAFData.handleRequest_HOOKED=null}});this.hook=true;if(!WAFData.handleRequest_HOOKED){WAFData.handleRequest_HOOKED=WAFData.handleRequest;WAFData.handleRequest=function(url,options){if(_this&&_this.hook&&!url.endsWith(".js")){var probe=Profiler.start("DL");options.onProgress=options.onProgress||function(progressEvent){if(progressEvent.loaded===progressEvent.total){if(_this.enopadLoading===true){_this.loadingAsset.size+=progressEvent.total}else{_this.loadingAsset.size=progressEvent.total}}};var onComplete=options.onComplete;options.onComplete=function(a){var time=probe.stop();if(_this.enopadLoading===true){_this.loadingAsset.download+=time}else{_this.loadingAsset.download=time}onComplete(a);onComplete=null}}WAFData.handleRequest_HOOKED(url,options)}}this.rootLoadedStream=undefined;this.oldradius=0;if((Environment.isSet("3DPlay.ProtoSMM")||Environment.isSet("3DPlay.ProtoConvertSpatial"))&&modelLink.provider==="BUFFER"){this.modelLoader.setFileType("cgr");this.modelLoader.loadModelFromBuffer(modelLink.data)}else{if(this.pad3DViewer&&modelLink.provider&&modelLink.provider!=="FILE"){this.pad3DViewer._lockCSONotification=false;this.modelName=input.asset.id=input.asset.physicalid;asset=input.asset;var objects=[asset];this.args.lastLoad=asset;this.loadingAsset.size=0;this.loadingAsset.download=0;PADUtilsServices.updatePlatformId(asset.tenant);if(Environment.isBoolActive("3DPlay.UseBase")){this.pad3DViewer.getController().switchAuthoringMode(true)}else{this.pad3DViewer.getController()._setDefaultStreamToLoad(this.ENOPADConnectorPolicy)}if(this.ENOPADConnectorPolicy==="thumbnail"){viewer.setMaterialMode(false);viewer.setRenderMode("Face",true);viewer.setRenderMode("@Edge",true);viewer.setRenderMode("@InternalEdge",false);viewer.setRenderMode("Outline",false);viewer.displayHiddenEdges(0)}if(asset.rootsWithFilters){var input=Array.isArray(asset.rootsWithFilters)?asset.rootsWithFilters[0]:asset.rootsWithFilters;input.filter.filterRootIds=[input.rootId];this.pad3DViewer.getController().applyFilter(input.filter,false)}else{this.pad3DViewer.addRoots({objects:objects},false,false)}this.enopadLoading=true;this.rootLoaded=this.rootLoaded||[];this.rootLoaded.push(asset.id);this.rootLoadedStream=this.pad3DViewer.getController().getDefaultStreamToLoad();this.canceled=false}else{this.enopadLoading=false;if(this.pad3DViewer){this.pad3DViewer._lockCSONotification=false}if(name.indexOf("blob:")>-1){this.modelName="blob"}else{this.modelName=name.split("/").pop();if(this.modelName.length>128){this.modelName=this.modelName.substr(this.modelName.length-128,this.modelName.length)}}viewer.restoreVisualizationMode({materialMode:true,renderFaceMode:THREE.ShowAllFaces,renderLineMode:THREE.ShowAllRenderLineMode,displayHiddenEdges:0});viewer.setMaterialMode(true);viewer.setRenderMode("BoundaryPoint",true);viewer.setRenderMode("SharpPoint",true);viewer.setRenderMode("FreePoint",true);viewer.setRenderMode("SurfacicPoint",false);viewer.setRenderMode("@InternalEdge",true);viewer.setRenderMode("@Edge",true);if(this.args.applicativeContainers&&this.args.applicativeContainers.length>0){var applicativeContainers={};var exp=this;this.disposeFunctions.add(function(){exp=applicativeContainers=null});var createCallbacks=function(containerName){applicativeContainers[containerName]={errorCallBack:function(){console.log("error with",containerName)},doneCallback:function(a){exp.publish("ASSET/APPLICATIVECONTAINERS/"+containerName,a)}}};for(var i=this.args.applicativeContainers.length;i--;){createCallbacks(this.args.applicativeContainers[i])}this.modelLoader.loadModel(modelLink,undefined,undefined,{applicativeContainers:applicativeContainers})}else{this.modelLoader.loadModel(modelLink)}}}viewer.render({updateInfinitePlane:true});this.forceRender=true;this.loadAssetInfo=UWA.clone(modelLink);this.onModelLoadingStarted(iDisplayProgress);if(diplayEmblem&&!Environment.isSet("3DPlay.LandingPage.disable")){this.getPhaseProgress().progress.spinnerContainer.hide();this.pad3DViewer.hide();var that=this;var bgImgSrc="";this.parentElem=this.args.container;this.landingViewContainer=new UWA.Element("div",{id:"landing-page_container","class":"Landing-Page_container"});this.landingViewContainer.addEvent("resize",this._onResizeLandingView.bind(this));this.landingView=new UWA.Element("div",{"class":"Landing-Page",styles:{"background-image":bgImgSrc}}).inject(this.landingViewContainer);this.parentElem.insertBefore(this.landingViewContainer,this.parentElem.firstChild);this.landingView.addContent({tag:"div","class":"lp-txt-container",html:[{tag:"h4",id:"lp-msg","class":"lp-txt font-3dsregular",html:SplashScreenNLS.DROP_MSG_LP},{tag:"img","class":"lp-drop-img",src:WebappsUtils.getWebappsBaseUrl()+"3DPlayExperienceModule/assets/images/Drag_and_drop_lightgrey-04.png"}]});this._onResizeLandingView()}else{var landingPage=window.document.getElementById("landing-page_container");if(landingPage){landingPage.remove()}if(this.pad3DViewer){this.pad3DViewer.show()}}},_onResizeLandingView:function(){this.forceRender=true;if(this.landingViewContainer.offsetWidth>780&&this.landingViewContainer.offsetHeight>200){this.landingView.style.backgroundImage="url('"+WebappsUtils.getWebappsBaseUrl()+"3DPlayHelper/assets/images/3DPlayLandingPage.svg')";this.landingView.getElementsByTagName("h4")[0].show();this.landingView.getElementsByTagName("img")[0].show();this.landingView.getElementsByTagName("img")[0].removeClassName("lp-drop-img-small");this.landingView.getElementsByTagName("img")[0].addClassName("lp-drop-img")}else{if(this.landingViewContainer.offsetWidth<779&&this.landingViewContainer.offsetWidth>581&&this.landingViewContainer.offsetHeight>200){this.landingView.style.backgroundImage="url('"+WebappsUtils.getWebappsBaseUrl()+"3DPlayHelper/assets/images/3DPlayLandingPage.svg')";this.landingView.getElementsByTagName("h4")[0].show();this.landingView.getElementsByTagName("img")[0].show();this.landingView.getElementsByTagName("img")[0].removeClassName("lp-drop-img-small");this.landingView.getElementsByTagName("img")[0].addClassName("lp-drop-img")}else{if(this.landingViewContainer.offsetWidth<580&&this.landingViewContainer.offsetWidth>280&&this.landingViewContainer.offsetHeight>200){this.landingView.style.backgroundImage="url('"+WebappsUtils.getWebappsBaseUrl()+"3DPlayHelper/assets/images/Small-02.svg')";this.landingView.getElementsByTagName("h4")[0].hide();this.landingView.getElementsByTagName("img")[0].show();this.landingView.getElementsByTagName("img")[0].removeClassName("lp-drop-img");this.landingView.getElementsByTagName("img")[0].addClassName("lp-drop-img-small")}else{if(this.landingViewContainer.offsetWidth<280||this.landingViewContainer.offsetHeight<200){this.landingView.style.backgroundImage="url('"+WebappsUtils.getWebappsBaseUrl()+"3DPlayHelper/assets/images/Xsmall-03.svg')";this.landingView.getElementsByTagName("h4")[0].hide();this.landingView.getElementsByTagName("img")[0].hide();this.landingView.getElementsByTagName("img")[0].removeClassName("lp-drop-img");this.landingView.getElementsByTagName("img")[0].removeClassName("lp-drop-img-small")}else{this.landingView.style.backgroundImage="url('"+WebappsUtils.getWebappsBaseUrl()+"3DPlayHelper/assets/images/3DPlayLandingPage.svg')";this.landingView.getElementsByTagName("h4")[0].show();this.landingView.getElementsByTagName("img")[0].show();this.landingView.getElementsByTagName("img")[0].removeClassName("lp-drop-img-small");this.landingView.getElementsByTagName("img")[0].addClassName("lp-drop-img")}}}}},loadAsset:function(modelName,iOptions,idisplayprogress,profiler){this.loadModel(modelName,iOptions,idisplayprogress)},_testBrowser:function(){return TestBrowser()},getScreenShot:function(iOptions){var viewer=this.frmWindow.getViewer();if(viewer.save){viewer.save()}var viewpoint=viewer.currentViewpoint;var buffer={data:null,width:viewer.SCREEN_WIDTH,height:viewer.SCREEN_HEIGHT};var canvas=document.createElement("canvas");canvas.width=iOptions.width?iOptions.width:buffer.width;canvas.height=iOptions.height?iOptions.height:buffer.height;viewpoint.getControl().update();viewer.renderToTarget(buffer,viewpoint);var ctx=canvas.getContext("2d");var imgdata=ctx.getImageData(0,0,canvas.width,canvas.height);if(imgdata.width!==canvas.width){console.error("error");iOptions.onError("size error")}if(imgdata.height!==canvas.height){console.error("error");iOptions.onError("size error")}var ratioW=(buffer.width-1)/(imgdata.width-1);var ratioH=(buffer.height-1)/(imgdata.height-1);var bufferdata=buffer.data;var canvdata=imgdata.data;var i,j,canvIdx,buffIdx;if(ratioW===1&&ratioH===1){var h=imgdata.height;var w=imgdata.width;var w4=4*w;for(j=0;j<h;j++){canvIdx=4*(j*w);buffIdx=4*((h-j)*w);for(i=w4;i--;){canvdata[canvIdx+i]=bufferdata[buffIdx+i]}}}else{var getBufferIndex=function(i,j,w,h,invert){if(invert){j=h-j}return w*j+i};var ih=imgdata.height;var iw=imgdata.width;var bh=buffer.height;var bw=buffer.width;for(j=0;j<ih;j++){var jj=Math.floor(ratioH*j);for(i=0;i<iw;i++){canvIdx=4*getBufferIndex(i,j,iw,ih);buffIdx=4*getBufferIndex(Math.floor(ratioW*i),jj,bw,bh,true);canvdata[canvIdx]=bufferdata[buffIdx];canvdata[canvIdx+1]=bufferdata[buffIdx+1];canvdata[canvIdx+2]=bufferdata[buffIdx+2];canvdata[canvIdx+3]=bufferdata[buffIdx+3]}}}ctx.putImageData(imgdata,0,0,0,0,canvas.width,canvas.height);this._setScreenshotUI(canvas);var type=iOptions.type?"image/"+iOptions.type:"png";if(Settings.get("3DPlay.PersistedAnnotationsEnabled")){var exportImageUrl=this._getSvgScreenshot(canvas.toDataURL(type));iOptions.onSuccess(exportImageUrl)}else{if(iOptions.type==="jpeg"){canvas.toBlob(function(imgBlob){iOptions.onSuccess(imgBlob)},"image/jpeg")}else{iOptions.onSuccess(canvas.toDataURL(type))}}},_getSvgScreenshot:function(screenshotUrl){var root=this.frmWindow.getViewer().getBagNode();var dim=this.frmWindow.getViewerFrame().getDimensions();var annotManager=ContextedSingleton.get(this.ctx,"ANNOTATION_MANAGER");var modelInfo="<Model>"+JSON.stringify(this.args.input.asset)+"</Model>";var annotData="<Annotations>"+annotManager.saveAnnotationsToJSON()+"</Annotations>";var svgString="<svg width='"+dim.width+"' height='"+dim.height+"' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'> <image xlink:href='"+screenshotUrl+"' x='0' y='0' width='100%' height='100%'/>"+modelInfo+annotData+"</svg>";var blob=new Blob([svgString],{type:"image/svg+xml;charset=utf-8"});var blobUrl=(self.URL||self.webkitURL||self).createObjectURL(blob);return blobUrl},_setScreenshotUI:function(){}});return Experience});define("DS/3DPlayExperienceModule/Documents/MultiDocManager",["UWA/Core","UWA/Class","DS/Panels/SidePanel","UWA/Controls/TabView","DS/Layouts/ListView","DS/VisuEvents/EventsManager","DS/3DPlayExperienceModule/Documents/CellViewDoc","DS/ApplicationFrame/CommandsManager","DS/WebappsUtils/WebappsUtils","DS/WebInfraUI/Notification","DS/WebUtils/StringUtils","DS/WebSystem/Nls","DS/WebSystem/Environment","DS/CoreEvents/Events","DS/Logger/Logger","DS/3DPlayExperienceModule/Documents/CollectionView3DPlayDoc","DS/3DPlayExperienceModule/Documents/CollectionView3DPlayDocLayout","DS/WebSystem/DetectBrowser"],function(h,q,i,c,d,p,b,a,f,n,t,g,k,l,r,s,e,j){var o;return q.extend({getNodes:function(){return[]},getSceneGraphOverrideSetManager:function(){return{pushSceneGraphOverrideSet:function(){return undefined}}},addFakeRootNode:function(){return undefined},init:function(v){o=this;this.logger=r.getLogger("DS/3DPlay/Document");this.logger.debug=this.logger.log;this.iFrmWindow=v.frmWnd;this.gesture=-1;this.exp=v.exp;this.isNotODT=true;this.targetCellFromLOD=null;this.smoothPanFormats=["doc","docx","pdf"];if(this.iFrmWindow._actionBar===null||this.iFrmWindow._actionBar===undefined||""===this.iFrmWindow._actionBar.elements.container.style.height){this.actionBarHeight=0}else{this.actionBarHeight=this.iFrmWindow._actionBar.elements.container.style.height}this.ctx=this.iFrmWindow.options.context;this.phaseProgress=v.phaseProgress;this.viewerFrame=document.createElement("div");this.viewerFrame.setAttribute("id","PlayWebDocScreen");this.viewerFrame.setAttribute("style","width:100%;height:100%;");var u=this.iFrmWindow.getViewerFrame();if(!u){}u.appendChild(this.viewerFrame);this.sheets=[];this.sheetCollection=new s({layout:new e({useDynamicColumnWidth:false,useDynamicRowHeight:false,gutter:0,columnMaxWidth:this.viewerFrame.offsetWidth,rowMaxHeight:this.viewerFrame.offsetHeight,showScrollbarsOnHover:true}),height:"inherit",multiDocMgr:this,onResizeCB:this._onResize.bind(this),thumbnailCallback:this._updateSheetThumbnail});this.nbSheets=0;this.nbSheetsLoaded=0;this.sheetCollection.model=this.sheets;this.sheetCollection.getContent().inject(this.viewerFrame);this.formatLoader={bmp:"DS/WebConnector2D/LoaderImg",gif:"DS/WebConnector2D/LoaderImg",jpg:"DS/WebConnector2D/LoaderImg",jpeg:"DS/WebConnector2D/LoaderImg",png:"DS/WebConnector2D/LoaderImg",svg:"DS/WebConnector2D/LoaderSvg",pdf:"DS/WebConnector2D/LoaderPDF"};if(k.isSet("3DPlay.Video.Enabled")){h.extend(this.formatLoader,{mp4:"DS/WebConnector2D/LoaderVideo",webm:"DS/WebConnector2D/LoaderVideo",ogv:"DS/WebConnector2D/LoaderVideo",ogg:"DS/WebConnector2D/LoaderVideo"})}if(k.isSet("3DPlay.ProtoHTMLViewer")){h.extend(this.formatLoader,{html:"DS/WebConnector2D/LoaderHtml"})}this.navCmds=[];var w=function(x,y){if(!this.navCmds[x]){this.navCmds[x]=a.getCommand(x,this.ctx)}if(this.navCmds[x]){if(y){this.navCmds[x].enable()}else{this.navCmds[x].disable()}}}.bind(this);this.setCurrentSheet=function(x){this.currentSheet=x;if(x===0){w("Previous",false);w("Next",true)}else{if(x===this.nbSheets-1){w("Previous",true);w("Next",false)}else{w("Previous",true);w("Next",true)}}};this.exp.registerCollabAction("2DDocumentMouseDown",this.onMouseDown.bind(this));this.exp.registerCollabAction("2DDocumentMiddleClick",this.onMiddleClick.bind(this));this.exp.registerCollabAction("2DDocumentMouseScroll",this.onMouseScroll.bind(this));this.exp.registerCollabAction("2DDocumentMouseUp",this.onMouseUp.bind(this));this.exp.registerCollabAction("2DDocumentMouseMove",this.onMouseMove.bind(this));this.exp.registerCollabAction("2DDocumentSwipe",this.onSwipe.bind(this));this.exp.registerCollabAction("2DDocumentPinch",this.onPinch.bind(this));this.exp.registerCollabAction("2DDocumentGoToSheet",this.goToSheet.bind(this));this.exp.registerCollabAction("2DDocumentUpdateScale",this.setScale.bind(this))},convertMouseEvent:function(u){var v=(u.from&&u.from.length)?u.from[0].event:null;this._factorY=this.iFrmWindow.elements.container.clientHeight/u.collabHeight;this._factorX=this.iFrmWindow.elements.container.clientWidth/u.collabWidth;if(v){var w={clientX:v.clientX*this._factorX,clientY:v.clientY*this._factorY};u.from[0].event=w}return u},completeMouseEvent:function(u){u.collabWidth=this.iFrmWindow.elements.container.clientWidth;u.collabHeight=this.iFrmWindow.elements.container.clientHeight;return u},getVP:function(){var u=this.sheets[this.currentSheet];var v={curSheet:this.currentSheet,currentHeight:u.currentHeight,currentWidth:u.currentWidth,curPosH:u.curPosH,curPosV:curSheetcurPosV,clientHeight:this.iFrmWindow.elements.container.clientHeight,clientWidth:this.iFrmWindow.elements.container.clientWidth};return v},setVP:function(u){var v=this.sheets[this.currentSheet];var w={curSheet:this.currentSheet,currentHeight:v.currentHeight,currentWidth:v.currentWidth,curPosH:v.curPosH,curPosV:curSheetcurPosV,clientHeight:this.iFrmWindow.elements.container.clientHeight,clientWidth:this.iFrmWindow.elements.container.clientWidth};this._slide(u.curPosH-w.curPosH,u.curPosV-w.curPosV)},clearScene:function(){this._detachUserEvents();this.isSliding=false;this.dragging=-1;if(this.iFrmWindow&&this.iFrmWindow.experience){this.iFrmWindow.experience.notifScreen.clearAll()}if(this.leftPanel){this.leftPanel.remove();this.leftPanel=null}if(this.viewerFrame){this.iFrmWindow.getViewerFrame().removeChild(this.viewerFrame)}this.viewerFrame=document.createElement("div");this.viewerFrame.setAttribute("id","PlayWebDocScreen");this.viewerFrame.setAttribute("style","width:100%;height:100%;");this.iFrmWindow.getViewerFrame().appendChild(this.viewerFrame);if(this._loader){this._loader.abort()}this.sheets=[];this._loader=null;this.nbSheets=0;this.nbSheetsLoaded=0;this.setCurrentSheet(-1);this.firstOkDoc=0;this.sheetInfo=null;this.navCmds=[];this.sheetCollection.getContent().inject(this.viewerFrame)},loadDocuments:function(u,w){var v=u.asset;if(v===undefined||v===null){v={}}else{if(Array.isArray(v)===true){if(v.length>1){var y=this.ctx;g.nls("3DPlay/Core","NoMultiDoc",function(C){window.SHARE.Core.displayFatalError({ctx:y,msg:C,error:"NoMultiDoc"})});return}else{v=v[0]}}}this.progressCB=w.loadProgress;w.loadStart();var x=null;var B=v.format;if(v.provider==="FILE"){if(B===undefined||B===null){B=t.getExtension(v.filename)}}else{if(v.provider==="EV6"){if(v.dtype&&(v.dtype.toLowerCase()==="catdrawing"||v.dtype.toLowerCase()==="drawing")){B="svg"}else{x={rsc:"3DPlay/Core",type:"UnknownFileType",txt:v.provider,level:n.fatal}}}else{if(v.provider==="BUFFER"||v.provider==="STREAM"){if(v.dataFormat){B=v.dataFormat}else{x={rsc:"3DPlay/Core",type:"UnknownFileType",txt:B,level:n.fatal}}}else{x={rsc:"3DPlay/Core",type:"UnknownProvider",txt:v.provider,level:n.fatal}}}}if((typeof B)==="string"){B=B.toLowerCase()}var z=this.formatLoader[B];if(z===undefined||z===null){this.nbSheets=0;x={rsc:"3DPlay/Core",type:"FormatNotSupported",txt:B,level:n.fatal}}if(x!==null){this.exp.onModelLoadingError(x);this.phaseProgress.hideProgressBar()}else{if(!this.leftPanel){this._createLeftPanel(this.iFrmWindow);this.leftPanel.show();this.leftPanel.slideOut()}if(this.smoothPanFormats.indexOf(v.format)!==-1){this.panStyle="smooth"}else{this.panStyle="snap"}if(v.type==="pdf"){this.exp.updateMAB(this.exp.mabModelPDF)}else{this.exp.updateMAB(this.exp.mabModel2D)}var A=this;g.nls("3DPlay/Core","DefaultSheetName",function(C){A._defaultSheetName=C;require([z],function(D){A.keyDownCB=function(E){this.onKeyDown(E)}.bind(A);p.addEvent(document,"onKeyDown",A.keyDownCB);A.keyUpCB=function(E){this.onKeyUp(E)}.bind(A);p.addEvent(document,"onKeyUp",A.keyUpCB);A.nbSheets=0;A.iFrmWindow._3dViewer.type=D.getLoaderType();A._loader=D;A.sheetCollection.layout.tileScale=1;D.load(A.sheets,{asset:v,viewer:A.viewerFrame,loadCB:{setNbSheet:function(E){this.nbSheets=E;if(E===1){this.leftPanel.hide()}else{this.leftPanel.show();this.pageNumberDisplayTotal.innerHTML="/ "+E}this.sheetCollection.layout.isMonosheet=E===1}.bind(A),done:A._loadingDone.bind(A),failed:A._loadingFailed.bind(A)},actionbarHeight:A.actionBarHeight,format:v.format||B,phaseProgress:A.phaseProgress,ctx:A.ctx,frameWindow:A.iFrmWindow});A._attachUserEvents();A.isSliding=false;A.dragging=-1;A=null},function(D){A.logger.error("Unable to Load Module : ",z);A.logger.error(D);A.nbSheets=0;x={rsc:"3DPlay/Core",type:"LoadingDocumentError",txt:B};g.nls("3DPlay/Core",x.nlsId,function(E){A.exp.onModelLoadingError(E)});A.phaseProgress.hideProgressBar();A=null})})}},_loadingDone:function(u){if(this.sheets){if(u===0){this.sheetInfo={realSizeHeight:this.sheets[0].realSizeHeight,realSizeWidth:this.sheets[0].realSizeWidth,margin:10};for(var x=0;x<this.sheets.length;x++){if(this.sheets[x]){this.sheets[x].realSizeWidth=this.sheetInfo.realSizeWidth;this.sheets[x].realSizeHeight=this.sheetInfo.realSizeHeight}}this.setCurrentSheet(0);var w=this.viewerFrame.offsetWidth/(this.sheetInfo.realSizeWidth+2*this.sheetInfo.margin);var v=this.viewerFrame.offsetHeight/(this.sheetInfo.realSizeHeight+2*this.sheetInfo.margin);if(w>0&&v>0){this.sheetInfo.reframeScale=Math.min(w,v);this.reframe()}else{this.sheetInfo.reframeScale=-1}this.isSplashOff=true;if(this.exp){this.exp.toggleSplash(false)}}else{if(this.sheetInfo){this.sheets[u].realSizeWidth=this.sheetInfo.realSizeWidth;this.sheets[u].realSizeHeight=this.sheetInfo.realSizeHeight}}if(this.isSplashOff===true){this.sheetCollection.model=this.sheets;this.sheetCollection.invalidateLayout({freePool:true})}this.progressCB({loaded:++this.nbSheetsLoaded,total:this.nbSheets});this.sheets[u].thumbIsGenerated=this.sheets[u].thumbIsGenerated===true;this._refreshThumbList(true)}},_loadingFailed:function(u){this.sheets[u].status.failed=true;this._loadingDone(u)},_createLeftPanel:function(C){var y=this;var D;var z=C.getUIFrame();this.leftPanel=new i({side:"left"}).inject(z);this.leftPanel.hide();this.leftPanel.slideOut();var E=new c.Tab({id:"SheetTab",text:""});var v;v=new c({className:"PlayWeb-Left-Panel",tabs:[E],events:{onSelectTab:function(){}}});D=this.leftPanel.appendChild(v);v.tabs[0].elements.container.setStyle("display","none");v.elements.contentNode.setStyle("top","0");D.style.height="100%";var B=document.createElement("div");B.style.height="100%";E.setContent(B);this.thumbListContainer=new d({model:[],height:"calc(100% - 2em)",cellClass:b,defaultCellWidth:180,defaultCellHeight:155});this.thumbListContainer.addEventListener("click",function(F,G){if(G){l.publish({event:"3DPlay/2DLeftPanel/SheetChange",data:{currentSheet:y.currentSheet}});y.goToSheet(G.virtualCellID)}},true);this._generateThumbnail=function(F,H,G){y.sheets[F].thumbIsGenerated="onGoing";y._loader.generateThumb(H,function(J,I){y.sheets[F].thumbnail=J;y.sheets[F].thumbIsGenerated=true;if(G&&I){y.sheetCollection.updateView({updateCellContent:true})}y._refreshThumbList(true)})};this.thumbListContainer.onCellRequest(function(I){var F=I.virtualCellID;var H=this.getCellModel(F);if(H){var G=I.cellView;if(H.isGenerated===false&&H.loaded){G.reset({focus:F===y.currentSheet,error:H.error,title:H.title,thumbnail:H.thumbnail});y._generateThumbnail(F,H.content)}else{if(H.isGenerated!=="onGoing"){G.reset({focus:F===y.currentSheet,error:H.error,title:H.title,thumbnail:H.thumbnail})}}}});this.thumbListContainer.inject(B);var x=document.createElement("div");x.classList.add("footer");B.appendChild(x);var w=document.createElement("span");w.className="button left fonticon fonticon-expand-left";w.onclick=function(F){this.goToSheet(this.getPrevious());if(F&&F.preventDefault){F.preventDefault()}}.bind(this);x.appendChild(w);var A=document.createElement("span");A.appendChild(document.createTextNode("Page"));x.appendChild(A);this.pageNumberDisplayInput=document.createElement("input");this.pageNumberDisplayInput.setAttribute("inputmode","numeric");this.pageNumberDisplayInput.setAttribute("pattern",/\d/);this.pageNumberDisplayInput.classList.add("form-control");this.pageNumberDisplayInput.value=1;this.pageNumberDisplayInput.onclick=function(){this.select()};this.pageNumberDisplayInput.addEventListener("blur",function(){this.pageNumberDisplayInput.value=this.currentSheet+1}.bind(this));x.appendChild(this.pageNumberDisplayInput);this.pageNumberDisplayTotal=document.createElement("span");x.appendChild(this.pageNumberDisplayTotal);var u=document.createElement("span");u.className="button right fonticon fonticon-expand-right";u.onclick=function(F){this.goToSheet(this.getNext());if(F&&F.preventDefault){F.preventDefault()}}.bind(this);x.appendChild(u);this.updateCurrentSheet=function(){var F=y.sheetCollection.getScrollerPosition().y/this.sheetCollection.layout.rowMaxHeight;var G=false;if(F>y.currentSheet+0.8){y.setCurrentSheet(y.currentSheet+1);G=true}else{if(F<y.currentSheet-0.8){y.setCurrentSheet(y.currentSheet-1);G=true}}if(G){y._refreshThumbList();l.publish({event:"Sheet/ChangeCompleted",data:{currentSheet:this.currentSheet}})}};this.sheetCollection.onPostUpdateView(function(){this.updateCurrentSheet()}.bind(this))},_refreshThumbList:function(v){if(v&&this.thumbListContainer&&this.sheets){var w;var u=[];for(w=0;w<this.sheets.length;w++){u.push({isGenerated:(this.sheets[w])?this.sheets[w].thumbIsGenerated:null,loaded:(this.sheets[w]&&this.sheets[w].status)?this.sheets[w].status.loaded:null,content:(this.sheets[w]&&this.sheets[w].thumbIsGenerated===false)?this.sheets[w].content:null,title:(this.sheets[w]&&this.sheets[w].title)?this.sheets[w].title:this._defaultSheetName+(w+1),thumbnail:(this.sheets[w]&&this.sheets[w].thumbnail)?this.sheets[w].thumbnail:f.getWebappsBaseUrl()+"3DPlayDocumentViewer/assets/images/sheet_loading.gif"})}this.thumbListContainer.options.model=u}if(this&&this.thumbListContainer){this.thumbListContainer.updateView(v)}},_updateSheetThumbnail:function(w){var u=j().browser.name;if(u!=="ie"){if(o&&o.sheets[w]&&o.sheets[w].getSheetViewer&&o.sheets[w].getSheetViewer()!==undefined){var v=o.sheets[w].getSheetViewer().canvas.toDataURL("image/png");o.thumbListContainer.getCellModel(w).thumbnail=o.sheets[w].thumbnail=v;o.thumbListContainer.updateView()}}},goToSheet:function(u){if(u!==-1&&u!==this.currentSheet){this.sheetCollection.scrollToCellAt({cellID:u,animate:Math.abs(this.currentSheet-u)<10&&this.isNotODT});this.setCurrentSheet(u);this._refreshThumbList();l.publish({event:"Sheet/ChangeCompleted",data:{currentSheet:u}})}this.pageNumberDisplayInput.value=this.currentSheet+1;if(this.exp&&this.exp.notifyAction&&this.exp.collabMode===true){this.exp.notifyAction("2DDocumentGoToSheet",[u])}},_getSheetIdx:function(v){var u=this.currentSheet+v;while(u>=0&&u<this.sheets.length&&this.sheets[u]&&this.sheets[u].status&&this.sheets[u].status.failed){u+=v}if(u<0||u===this.sheets.length){u=this.currentSheet}return u},getNext:function(){return this._getSheetIdx(1)},getPrevious:function(){return this._getSheetIdx(-1)},_attachUserEvents:function(){var u=this;this.eventCBs={onLeftMouseDown:function(v){return u.onMouseDown(v)},onMiddleMouseDown:function(v){return u.onMouseDown(v)},onMiddleClick:function(v){return u.onMiddleClick(v)},onRightMouseDown:function(v){return u.onMouseDown(v)},onLeftDoubleClick:function(v){return u.onLeftDoubleClick(v)},mousewheel:function(v){return u.onMouseScroll(v)},DOMMouseScroll:function(v){return u.onMouseScroll(v)},onLeftMouseUp:function(v){return u.onMouseUp(v)},onMiddleMouseUp:function(v){return u.onMouseUp(v)},onRightMouseUp:function(v){return u.onMouseUp(v)},onMouseOut:function(v){return u.onMouseUp(v)},onSwipe:function(v){return u.onSwipe(v)},onPinch:function(v){return u.onPinch(v)},onDoubleTap:function(v){return u.onLeftDoubleClick(v)}};p.addEvent(this.viewerFrame,"onLeftMouseDown",this.eventCBs.onLeftMouseDown);p.addEvent(this.viewerFrame,"onMiddleMouseDown",this.eventCBs.onMiddleMouseDown);p.addEvent(this.viewerFrame,"onMiddleClick",this.eventCBs.onMiddleClick);p.addEvent(this.viewerFrame,"onRightMouseDown",this.eventCBs.onRightMouseDown);p.addEvent(this.viewerFrame,"onLeftDoubleClick",this.eventCBs.onLeftDoubleClick);this.viewerFrame.addEventListener("mousewheel",this.eventCBs.mousewheel,true);this.viewerFrame.addEventListener("DOMMouseScroll",this.eventCBs.DOMMouseScroll,true);p.addEvent(document,"onLeftMouseUp",this.eventCBs.onLeftMouseUp);p.addEvent(document,"onMiddleMouseUp",this.eventCBs.onMiddleMouseUp);p.addEvent(document,"onRightMouseUp",this.eventCBs.onRightMouseUp);p.addEvent(document,"onMouseOut",this.eventCBs.onMouseOut);p.addEvent(this.viewerFrame,"onSwipe",this.eventCBs.onSwipe);p.addEvent(document,"onPinch",this.eventCBs.onPinch);p.addEvent(document,"onDoubleTap",this.eventCBs.onDoubleTap)},dispose:function(){this._detachUserEvents();this.sheets=null;this.exp=null;this._loader=null;if(this.thumbListContainer){for(var u in this.thumbListContainer._listOfRenderedCells){var v=this.thumbListContainer._listOfRenderedCells[u];v.private_destroy()}if(this.thumbListContainer.destroy){this.thumbListContainer.destroy()}this.thumbListContainer=null;p.removeEvent(document,"onKeyDown",this.keyDownCB);p.removeEvent(document,"onKeyUp",this.keyUpCB)}},_detachUserEvents:function(){p.removeEvent(document,"onMouseMove",this.mouseMove);p.removeEvent(document,"onMouseMove",this.mouseMoveZoom);if(this.eventCBs){p.removeEvent(this.viewerFrame,"onLeftMouseDown",this.eventCBs.onLeftMouseDown);p.removeEvent(this.viewerFrame,"onMiddleMouseDown",this.eventCBs.onMiddleMouseDown);p.removeEvent(this.viewerFrame,"onMiddleClick",this.eventCBs.onMiddleClick);p.removeEvent(this.viewerFrame,"onRightMouseDown",this.eventCBs.onRightMouseDown);p.removeEvent(this.viewerFrame,"onLeftDoubleClick",this.eventCBs.onLeftDoubleClick);this.viewerFrame.removeEventListener("mousewheel",this.eventCBs.mousewheel,true);this.viewerFrame.removeEventListener("DOMMouseScroll",this.eventCBs.DOMMouseScroll,true);p.removeEvent(this.viewerFrame,"onSwipe",this.eventCBs.onSwipe);p.removeEvent(document,"onPinch",this.eventCBs.onPinch);p.removeEvent(document,"onDoubleTap",this.eventCBs.onDoubleTap);p.removeEvent(document,"onLeftMouseUp",this.eventCBs.onLeftMouseUp);p.removeEvent(document,"onMiddleMouseUp",this.eventCBs.onMiddleMouseUp);p.removeEvent(document,"onRightMouseUp",this.eventCBs.onRightMouseUp);p.removeEvent(document,"onMouseOut",this.eventCBs.onMouseOut)}},togglePanCursor:function(u){if(u===true){var w=f.getWebappsAssetUrl("Visualization","")+"icons/";var v="url('"+w+"WebViewerPan.png'), url('"+w+"WebViewerPan.cur'), auto";this.viewerFrame.style.cursor=v}else{this.viewerFrame.style.cursor="auto"}},toggleZoomCursor:function(u){if(u===true){var w=f.getWebappsAssetUrl("Visualization","")+"icons/";var v="url('"+w+"WebViewerZoom.png'), url('"+w+"WebViewerZoom.cur'), auto";this.viewerFrame.style.cursor=v}else{this.viewerFrame.style.cursor="auto"}},onMouseScroll:function(u){u=(u.from&&u.from.length)?u.from[0].event:u;if(u){if(u.collabWidth){u=this.convertMouseEvent(u)}}if(u.shiftKey===true){u=u||window.event;var v=this.getScale();if((u.wheelDelta||-u.detail)>0){v*=1.1}else{v*=(10/11)}this.setScale(v);if(u.preventDefault){u.preventDefault()}if(u.stopImmediatePropagation){u.stopImmediatePropagation()}if(u.stopPropagation){u.stopPropagation()}return false}if(this.exp&&this.exp.notifyAction&&this.exp.collabMode===true){this.exp.notifyAction("2DDocumentMouseScroll",[this.completeMouseEvent(u)])}},onMouseDown:function(u){if(u){if(u.collabWidth){u=this.convertMouseEvent(u)}}var y=a._getCurrent(this.ctx);var x;if(a._commandsState&&a._commandsState[this.ctx]){x=a._commandsState[this.ctx].defaultCommand}else{if(a[this.ctx]){x=a[this.ctx].currentCommand}else{y="Pan"}}x=x?x._id:"";if(y===x||y==="Pan"){var v;if(this.isSliding===false&&this.dragging===-1){this.dragging=1;v=(u.from&&u.from.length)?u.from[0].event:null;if(u.eventType==="@onLeftMouseDownEvent"){this._startPan(v.clientX,v.clientY)}else{if(u.eventType==="@onMiddleMouseDownEvent"){this._startPan(v.clientX,v.clientY);this.middleClick=true}else{if(u.eventType==="@onRightMouseDownEvent"){this._startZoom(v.clientX,v.clientY)}}}this.viewerFrame.onselectstart=function(){return false};var w=window.getSelection?window.getSelection():this.document.selection;if(w){if(w.removeAllRanges){w.removeAllRanges()}else{if(w.empty){w.empty()}}}}else{if(this.middleClick===true&&(u.eventType==="@onRightMouseDownEvent"||u.eventType==="@onLeftMouseDownEvent")){if(this.pan){v=(u.from&&u.from.length)?u.from[0].event:null;this._stopPan(v.clientX,v.clientY);this.middleZoom=true}else{if(this.middleZoom){this._stopZoom()}}}}if(u.from&&u.from[0]&&u.from[0].event&&u.from[0].event.preventDefault){u.from[0].event.preventDefault()}}if(this.exp&&this.exp.notifyAction&&this.exp.collabMode===true){this.exp.notifyAction("2DDocumentMouseDown",[this.completeMouseEvent(u)])}},onMouseMove:function(u){var v=(u.from&&u.from.length)?u.from[0].event:null;if(v.collabWidth){v=this.convertMouseEvent(v)}if(v){u.from[0].event.preventDefault();u.from[0].event.stopImmediatePropagation();u.from[0].event.stopPropagation();if(this.dragging===1&&this.pan){this._pan(v.clientX,v.clientY)}else{if(this.zoom){this._zoom(v.clientX,v.clientY)}}}if(this.exp&&this.exp.notifyAction&&this.exp.collabMode===true){this.exp.notifyAction("2DDocumentMouseMove",[v,true,this.iFrmWindow.elements.container.clientWidth,this.iFrmWindow.elements.container.clientWidth])}return false},onMouseUp:function(u){if(this.pageNumberDisplayInput){this.pageNumberDisplayInput.value=this.currentSheet+1}if(this.dragging===1){var v=(u.from&&u.from.length)?u.from[0].event:null;if(v.collabWidth){v=this.convertMouseEvent(v)}if(this.middleZoom&&(u.eventType==="@onRightMouseUpEvent"||u.eventType==="@onLeftMouseUpEvent")){this._startZoom(v.clientX,v.clientY)}else{if(this.zoom===true){this._stopZoom();this.middleZoom=false}else{this._stopPan(v.clientX,v.clientY)}this.dragging=-1;this.middleClick=false;document.onselectstart=null}if(this.exp&&this.exp.notifyAction&&this.exp.collabMode===true){this.exp.notifyAction("2DDocumentMouseUp",[this.completeMouseEvent(v)])}if(u.from&&u.from[0]&&u.from[0].event&&u.from[0].event.preventDefault){u.from[0].event.preventDefault();u.from[0].event.stopImmediatePropagation();u.from[0].event.stopPropagation();return false}}if(this.pageNumberDisplayInput){this.pageNumberDisplayInput.value=this.currentSheet+1}return true},onMiddleClick:function(u){if(u.from&&u.from[0]&&u.from[0].event&&u.from[0].event.preventDefault){u.from[0].event.preventDefault()}var w=(u.from&&u.from.length)?u.from[0].event:null;if(w.collabWidth){w=this.convertMouseEvent(w)}var v=this.sheetCollection.getScrollerPosition();this.sheetCollection.setScrollerPosition({x:v.x+w.clientX-(this.viewerFrame.offsetWidth/2),y:v.y+w.clientY-(this.viewerFrame.offsetHeight/2),animate:true});if(this.exp&&this.exp.notifyAction&&this.exp.collabMode===true){this.exp.notifyAction("2DDocumentMiddleClick",[this.completeMouseEvent(u)])}},onLeftDoubleClick:function(u){if(u&&u.from&&u.from[0]&&u.from[0].path){for(var v=0;v<u.from[0].path.length;v++){if(u.from[0].path[v].className==="PlayWeb-Tile"){this.targetCellFromLOD=u.from[0].path[v+1].getAttribute("cell-id")}}}if(this.sheetCollection.layout.zoomScale===this.sheetInfo.reframeScale){this.fitWidth()}else{this.reframe()}if(u.from&&u.from[0]&&u.from[0].event&&u.from[0].event.preventDefault){u.from[0].event.preventDefault();u.from[0].event.stopImmediatePropagation();u.from[0].event.stopPropagation();return false}return true},_startPan:function(u,w){var v=this;if(!this.mouseMove){this.mouseMove=function(x){v.onMouseMove(x,v.ctx)}}this.panStart={x:u,y:w};this.panStartScroller=this.sheetCollection.getScrollerPosition();p.addEvent(document,"onMouseMove",this.mouseMove);this.togglePanCursor(true);this.pan=true},_pan:function(u,w){var v={x:this.panStartScroller.x+this.panStart.x-u,y:this.panStartScroller.y+this.panStart.y-w};this.sheetCollection.setScrollerPosition(v)},_stopPan:function(){p.removeEvent(document,"onMouseMove",this.mouseMove);this.togglePanCursor(false);this.pan=false},onPinch:function(D){if(this.type==="pdf"){if(D.preventDefault){D.preventDefault()}return}if(D.collabWidth){D=this.convertMouseEvent(D)}var C;if(a._commandsState){C=a._commandsState[this.ctx].defaultCommand}else{C=a[this.ctx].currentCommand}C=C?C._id:"";var x=a._getCurrent(this.ctx);if(x===C||x==="Zoom"){if(D&&D.gesture&&(this.gesture===-1||this.gesture==="pinch")){var z=D.gesture.getEvents();var v=z[0].getCurrentPosition();var u=z[1].getCurrentPosition();if(D.state==="begin"){this.gesture="pinch";this._startZoomGesture(v,u)}else{if(D.state==="end"){this._stopZoomGesture();this.gesture=-1}else{var B=Math.pow((u.x-v.x),2);var A=Math.pow((u.y-v.y),2);var w=Math.sqrt(B+A);this.zoomStart.previousDist=this.zoomStart.newDist;this.zoomStart.newDist=w;this._zoom()}}for(var y=0;y<2;y++){z[y].event.preventDefault()}}}if(this.exp&&this.exp.notifyAction&&this.exp.collabMode===true){this.exp.notifyAction("2DDocumentPinch",[this.completeMouseEvent(D)])}},_startZoom:function(u,v){if(!this.mouseMoveZoom){this.mouseMoveZoom=this.onMouseMove.bind(this)}this.zoomStart={x:u,y:v,scale:this.getScale()};p.addEvent(document,"onMouseMove",this.mouseMoveZoom);this.toggleZoomCursor(true);this.zoom=true},_zoom:function(u,w){var v=1;if(this.gesture==="pinch"){v=this.zoomStart.newDist/this.zoomStart.previousDist;this.zoomStart.scale=v*this.zoomStart.scale;this.setScale(this.zoomStart.scale)}else{v=1+((this.zoomStart.y-w)/100);this.setScale(v*this.zoomStart.scale)}},_stopZoom:function(){p.removeEvent(document,"onMouseMove",this.mouseMoveZoom);this.toggleZoomCursor(false);this.zoom=false;this.sheetCollection.updateView({updateCellContent:true})},_startZoomGesture:function(w,v){var u=Math.pow((v.x-w.x),2);var x=Math.pow((v.y-w.y),2);this.zoomStart={previousDist:0,newDist:Math.sqrt(u+x),center:{x:(w.x+v.x)/2,y:(w.y+v.y)/2},scale:this.getScale()};this.zoom=true},_stopZoomGesture:function(){this.zoomStart=null;this.zoom=false;this.sheetCollection.updateView({updateCellContent:true})},onSwipe:function(u){if(u.collabWidth){u=this.convertMouseEvent(u)}var x;if(a._commandsState){x=a._commandsState[this.ctx].defaultCommand}else{x=a[this.ctx].currentCommand}x=x?x._id:"";var z=a._getCurrent(this.ctx);if(z===x||z==="Pan"){if(this.gesture===-1||this.gesture==="swipe"){var y=u.gesture.getEvents();if(y[0].event.preventDefault){y[0].event.preventDefault()}else{y[0].event.returnValue=false}var w=y[0].getCurrentPosition(document);if(u.state==="begin"){this.gesture="swipe";this._startPan(w.x,w.y)}else{if(u.state==="end"){if(this.pan){this._stopPan(u)}else{if(this.slide){this._stopSlide()}}this.gesture=-1}else{if(this.slide){this._slide(w.x,w.y)}else{if(this.pan){var v=this._pan(w.x,w.y);if(v){this._stopPan();this._startSliding(w.x,w.y)}}}}}}}if(this.exp&&this.exp.notifyAction&&this.exp.collabMode===true){this.exp.notifyAction("2DDocumentSwipe",[this.completeMouseEvent(u)])}},onKeyDown:function(x){var v=x.gesture.key;var w=null;var u=100;var y=false;if(x&&x.from&&x.from[0]&&x.from[0].view!==this.pageNumberDisplayInput){switch(v){default:break;case 36:y=true;this.goToSheet(0);break;case 33:y=true;w=function(){this.goToSheet(this.getPrevious())}.bind(this);u=500;break;case 38:y=true;w=function(){var z=this.sheetCollection.getScrollerPosition();z.y-=55;this.sheetCollection.setScrollerPosition(z)}.bind(this);break;case 37:y=true;w=function(){var z=this.sheetCollection.getScrollerPosition();z.x-=55;this.sheetCollection.setScrollerPosition(z)}.bind(this);break;case 39:y=true;w=function(){var z=this.sheetCollection.getScrollerPosition();z.x+=55;this.sheetCollection.setScrollerPosition(z)}.bind(this);break;case 40:y=true;w=function(){var z=this.sheetCollection.getScrollerPosition();z.y+=55;this.sheetCollection.setScrollerPosition(z)}.bind(this);break;case 34:y=true;w=function(){this.goToSheet(this.getNext())}.bind(this);u=500;break;case 35:y=true;this.goToSheet(this.nbSheets-1);break;case 109:y=true;w=function(){this.setScale(this.getScale()-0.1)}.bind(this);u=200;break;case 107:y=true;w=function(){this.setScale(this.getScale()+0.1)}.bind(this);u=200;break;case 106:y=true;this.reframe();break}if(w){if(this.holdKeyID){window.clearInterval(this.holdKeyID);this.holdKeyID=null}w();this.holdKeyID=window.setInterval(w,u)}if(y){x.from[0].event.preventDefault();x.from[0].event.stopImmediatePropagation();x.from[0].event.stopPropagation();return false}}},onKeyUp:function(v){if(v&&v.from&&v.from[0]&&v.from[0].view===this.pageNumberDisplayInput){var u=t.filterInt(this.pageNumberDisplayInput.value);if(isNaN(u)&&(this.pageNumberDisplayInput.value!==""||v.gesture.key===13)){this.pageNumberDisplayInput.value=this.currentSheet+1;u=this.currentSheet}if(v.gesture.key===13){this.goToSheet(Math.max(0,Math.min(u-1,this.nbSheets-1)));this.pageNumberDisplayInput.blur()}}if(this.holdKeyID){window.clearInterval(this.holdKeyID);this.holdKeyID=null}},_onResize:function(){if(this.sheetInfo){var y=this.getScale()*(this.sheetInfo.realSizeHeight+2*this.sheetInfo.margin);this.sheetCollection.layout.rowMaxHeight=y;var x=this.getScale()*(this.sheetInfo.realSizeWidth+2*this.sheetInfo.margin);var z=(this.viewerFrame.offsetWidth/x)-0.5;var A=(this.viewerFrame.offsetHeight/y)-0.1;if(x>this.viewerFrame.offsetWidth){this.sheetCollection.layout.columnMaxWidth=x}else{if(z<2||A<3){this.sheetCollection.layout.columnMaxWidth=this.viewerFrame.offsetWidth}}var v=this.sheetInfo.reframeScale;var w=this.viewerFrame.offsetWidth/(this.sheetInfo.realSizeWidth+2*this.sheetInfo.margin);var u=this.viewerFrame.offsetHeight/(this.sheetInfo.realSizeHeight+2*this.sheetInfo.margin);this.sheetInfo.reframeScale=Math.min(w,u);if(v===this.getScale()||v===-1){this.reframe()}}},reframe:function(){this.setScale(this.sheetInfo.reframeScale,true)},fitWidth:function(){this.setScale((this.viewerFrame.offsetWidth)/(this.sheetInfo.realSizeWidth+2*this.sheetInfo.margin),true)},realSize:function(){this.setScale(1,true)},getScale:function(){return this.sheetCollection.layout.tileScale},setScale:function(y,B){if(this.sheetCollection.layout.zoomScale===y){return}this.sheetCollection.layout.zoomScale=y;if(this.sheets[this.currentSheet]&&this.sheets[this.currentSheet].getSheetViewer){try{this.currentSheetWidth=this.sheets[this.currentSheet].getSheetViewer().canvas.clientWidth;this.currentSheetHeight=this.sheets[this.currentSheet].getSheetViewer().canvas.clientHeight}catch(z){}}var D=Math.min(Math.max(0.1,y),5);var w=D/this.sheetCollection.layout.tileScale;if(this.targetCellFromLOD===null){var x=this.sheetCollection.getScrollerPosition();if(this.currentSheetWidth&&this.currentSheetWidth>this.sheetCollection.getContent().clientWidth){x.x=(this.currentSheetWidth-this.sheetCollection.getContent().clientWidth)/2}else{x.x=x.x*w}x.y=x.y*w;this.sheetCollection.setScrollerPosition(x)}var v=D*(this.sheetInfo.realSizeWidth+2*this.sheetInfo.margin);var E=D*(this.sheetInfo.realSizeHeight+2*this.sheetInfo.margin);this.sheetCollection.layout.rowMaxHeight=E;var A=(this.viewerFrame.offsetWidth/v)-0.5;var C=(this.viewerFrame.offsetHeight/E)-0.1;if(v>this.viewerFrame.offsetWidth){if(this.sheets.length!==1){this.leftPanel.show()}this.sheetCollection.layout.useLOD=false;this.sheetCollection.layout.columnMaxWidth=D*(this.sheetInfo.realSizeWidth+2*this.sheetInfo.margin)}else{if(A>=2&&C>=3&&this.sheets.length!==1){this.sheetCollection.layout.useLOD=true;if(this.targetCellFromLOD===null){this.targetCellFromLOD=this.currentSheet}this.sheetCollection.layout.columnMaxWidth=this.viewerFrame.offsetWidth/Math.floor(A);this.leftPanel.hide()}else{if(this.sheets.length!==1){this.leftPanel.show()}this.sheetCollection.layout.useLOD=false;this.sheetCollection.layout.columnMaxWidth=this.viewerFrame.offsetWidth}}this.sheetCollection.layout.tileScale=parseInt(this.sheetCollection.layout.rowMaxHeight-10)/this.sheetInfo.realSizeHeight;var u=a.getCommands(this.ctx);if(u!==undefined&&u.AnnotationCommands2D){if(this.sheetCollection.layout.useLOD){u.AnnotationCommands2D.disable()}else{u.AnnotationCommands2D.enable()}}if(u!==undefined&&u.ScaleP&&u.ScaleM){if(D===0.1){u.ScaleP.enable();u.ScaleM.disable()}else{if(D==5){u.ScaleP.disable();u.ScaleM.enable()}else{u.ScaleP.enable();u.ScaleM.enable()}}}if(this.targetCellFromLOD!==null&&this.sheetCollection.layout.useLOD===false){this.isNotODT=false;this.goToSheet(this.targetCellFromLOD);this.targetCellFromLOD=null;this.isNotODT=true}else{this.sheetCollection.setScrollerPosition(x)}this.sheetCollection.invalidateLayout({updateCellContent:B})},rotate:function(u){this.sheets[this.currentSheet].rotate(u)},getScreenShot:function(y){var C=this.iFrmWindow.getViewerFrame().getBoundingClientRect();var x=this.sheetCollection.getContent().getBoundingClientRect();var w=this.sheetCollection.getVisibleCellsInViewport();var v=document.createElement("canvas");v.width=x.width;v.height=x.height;var u=v.getContext("2d");u.beginPath();u.rect(0,0,v.width,v.height);u.fillStyle="#f4f5f6";u.fill();for(var A in w){this.sheets[A].getSheetViewer().getScreenShot({context:u,containerBB:x,viewerFrameBB:C})}u.closePath();if(y.type){var z=new h.Element("canvas",{width:240,height:180,styles:{width:"240px",height:"180px"}});var B=z.getContext("2d");B.drawImage(v,0,0,v.width,v.height,0,0,z.width,z.height);z.toBlob(function(D){y.onSuccess(D)},"image/jpeg")}else{y.onSuccess(v.toDataURL("image/png"))}},saveAnnotData:function(u){this.savedAnnotdata=u.annotations;for(var w=0;w<this.sheets.length;w++){if(this.sheets[w]&&this.savedAnnotdata[w]&&this.sheets[w].status.loaded){var y=Object.keys(this.savedAnnotdata[w]);for(var x=0;x<y.length;x++){if(this.sheets[w].getSheetViewer){var z=this.sheets[w].getSheetViewer();z.reloadShape(this.savedAnnotdata[w][y[x]]);var v=z.getShapeList();this.sheets[w].annotations=v}else{if(this.sheets[w].annotations==undefined){this.sheets[w].annotations=[]}this.sheets[w].annotations[y[x]]=this.savedAnnotdata[w][y[x]]}}}}for(var w=0;w<this.sheets.length;w++){this._updateSheetThumbnail(w)}}})});