/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Web3DUXAssistantTools/Web3DUXAssistantTools",["UWA/Core","UWA/Controls/Abstract","DS/Core/PointerEvents","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","css!DS/Web3DUXAssistantTools/Web3DUXAssistantTools.css"],function(f,e,c,a,d){var b=e.extend({defaultOptions:{body:null,viewer:null,frmWindow:null,heightElem:"32px",widthElem:"32px",offset:null,mode:"vertical",dir:"right",lJsonElement:[]},init:function(j){this._parent(j);var v=this,s=this.options;var p=null,k=null;var x=[];var g=null;var u,w;var i=s.position&&s.position.clone?s.position.clone():new d.Vector3();var m=s.offset&&!isNaN(s.offset.x)?s.offset.x:0,l=s.offset&&!isNaN(s.offset.y)?s.offset.y:0;var t=s.lJsonElement;var n=s.viewer,q=s.frmWindow;function r(C,y,z,B){var A=f.createElement("div",{"class":"Web3DUXAssToolsBtn",id:C.id,title:C.nls,styles:{top:z,left:B,height:s.heightElem,width:s.widthElem}}).inject(y);if(C.bstateActif){A.addClassName("Web3DUXAssToolsActiveState")}var D=new f.Controls.Img({url:C.url}).inject(A);D.elements.container.setStyles({width:"calc(100% - 6px)",height:"calc(100% - 6px)",margin:"3px 0px 0px 3px"});x.push(A);if(C.callback){A.addEvent(c.POINTERUP,function(E){if(typeof C.bstateActif==="boolean"){if(!this.hasClassName("Web3DUXAssToolsActiveState")){this.addClassName("Web3DUXAssToolsActiveState")}else{this.removeClassName("Web3DUXAssToolsActiveState")}}if(C.callback){C.callback.call(E)}})}}function h(A){var y={top:A.top,left:A.left};var z=((parseInt(s.widthElem,10)+u)*x.length)/2;if(s.mode==="horizontal"||(s.mode==="curve"&&s.dir==="bottom")||(s.mode==="curve"&&s.dir==="top")){if((s.mode==="curve"&&s.dir==="top")&&t.length>=3){y.top=parseInt(y.top,10)-u*2-parseInt(s.widthElem,10)}else{if((s.mode==="curve"&&s.dir==="bottom")&&t.length>=3){y.top=parseInt(y.top,10)+u}}y.left=y.left-z}else{if(s.mode==="vertical"||(s.mode==="curve"&&s.dir==="right")||(s.mode==="curve"&&s.dir==="left")){y.top=parseInt(y.top,10)-parseInt(z,10);if((s.mode==="curve"&&s.dir==="left")&&t.length>=3){y.left=y.left-w}else{if((s.mode==="curve"&&s.dir==="right")&&t.length>=3){y.left=y.left+w}}}}if(m){y.left+=m}if(l){y.top+=l}return y}function o(z){var y=z.length,A=[],C={};for(var B=0;B<y;B++){C[z[B]]=C[z[B]]>=1?C[z[B]]+1:1}for(var D in C){if(C[D]>1){A.push(D)}}return A}this.updatePosition=function(G){if(!G||!g){return}if(i!==G){i=G}var I=n.canvas.offsetHeight,A=n.canvas.offsetWidth,z=0,F=0;if(q){var D=q.getImmersiveFrame().getFreeZone().getBoundingClientRect();I=D.height;A=D.width;var E=typeof D.x==="number"&&typeof D.y==="number"?{x:D.x,y:D.y}:q.getImmersiveFrame().getFreeZone().getPosition();z=D.left-E.x;F=D.top-E.y}var C;if(!isNaN(i.x)&&!isNaN(i.y)&&!isNaN(i.z)){var H=n.currentViewpoint.project(i);C=h({left:H.x,top:H.y})}else{C=h(i)}var B=Math.abs(u)+parseInt(s.heightElem,10),y=Math.abs(w)+parseInt(s.widthElem,10);if(C.top<F+5){C.top=F+5}else{if(C.top+B+5>F+I){C.top=F+I-B-5}}if(C.left<z+5){C.left=z+5}else{if(C.left+y+5>z+A){C.left=z+A-y-5}}g.style.top=Math.round(C.top)+"px";g.style.left=Math.round(C.left)+"px"};this.build=function(){v.clear();t=s.lJsonElement;var A=t.length,y,z=12;var D=[];for(var C=0;C<s.lJsonElement.length;C++){if(s.lJsonElement[C].type!=="separator"){D.push(s.lJsonElement[C].id)}}var B=o(D);if((!B||B.length===0)&&A&&n&&q&&s.body){g=f.createElement("div",{"class":"Web3DUXAssToolsMainDiv"}).inject(s.body);g.addEvent("dragstart",function(E){E.preventDefault()});w=0;u=0;for(var C=0;C<A;C++){if(s.mode==="vertical"){w=0;u=(-(((A/2)-1)*2)+(2*C)+((parseInt(s.heightElem,10)+8)*C))}else{if(s.mode==="horizontal"){w=(-(((A/2)-1)*2)+(2*C)+((parseInt(s.widthElem,10)+8)*C));u=0}else{if(s.mode==="curve"&&s.dir==="right"||s.mode==="curve"&&s.dir==="left"){u=((parseInt(s.heightElem,10)+8)*C);if(C===0&&A!==3){y=-(((A/2)+C)*z+((A/2)+C)*(z/4))}else{if(C===(A-1)&&A!==3){y=-(z*(C-(A/2-1))+(z/4)*(C-(A/2-1)))}}if(C===0&&A===3){y=-z}else{if(C===(A-1)&&A===3){y=-z}else{if(C>(A/2)){y=-(z*(C-(A/2))+z*0.5*((C-(A/2))-1))}else{y=-((((A/2)-1)-C)*z+((((A/2)-1)-C)-1)*0.5*z)}}}if(s.dir==="left"){y=-y}if(A<3){w=0}else{if((A%2)===0){if(C===(A/2)||C===((A/2)-1)){w=0}else{w=y}}else{if(C===(A/2-0.5)){w=0}else{w=y}}}}else{if(s.mode==="curve"&&s.dir==="bottom"||s.mode==="curve"&&s.dir==="top"){z=8;w=(-(((A/2)-1)*2)+(2*C)+((parseInt(s.widthElem,10)+8)*C));if(C===0&&A!==3){y=-(((A/2)+C)*z+((A/2)+C)*(z/4))}else{if(C===(A-1)&&A!==3){y=-(z*(C-(A/2-1))+(z/4)*(C-(A/2-1)))}}if(C===0&&A===3){y=-z}else{if(C===(A-1)&&A===3){y=-z}else{if(C>(A/2)){y=-(z*(C-(A/2))+z*0.5*((C-(A/2))-1))}else{y=-((((A/2)-1)-C)*z+((((A/2)-1)-C)-1)*0.5*z)}}}if(s.dir==="top"){y=(-y)}if(A<3){u=0}else{if((A%2)===0){if(C===(A/2)||C===((A/2)-1)){u=0}else{u=y}}else{if(C===(A/2-0.5)){u=0}else{u=y}}}}}}}r(t[C],g,u+"px",w+"px")}v.updatePosition(i);v.setVisibleFlag(true);if(!p){p=a.subscribe({event:"/VISU/onWindowResized"},function(E){if(E.eventType==="@onWindowResized"){v.updatePosition(i)}})}if(!k){k=a.subscribe({event:"/VISU/"},function(E){if(E.eventType==="@onViewpointChange"){v.updatePosition(i)}})}}};this.addButton=function(y){if(!y.id){return}t.push(y)};this.removeButtons=function(z){if(!Array.isArray(z)){return}var A=z.slice();A.sort(function(C,B){return C-B});for(var y=A.length-1;y>=0;y--){if(A[y]>=0&&A[y]<t.length){t.splice(A[y],1)}}};this.setOffset=function(y){if(y&&!isNaN(y.x)&&!isNaN(y.y)){m=y.x;l=y.y;v.updatePosition(i)}};this.setVisibleFlag=function(y){if(g){g.style.display=y?"block":"none"}};this.getVisibleFlag=function(){if(g){return g.style.display==="block"}return false};this.clear=function(){x=[];if(g){if(s.body){s.body.removeChild(g)}g.destroy()}if(p){a.unsubscribe(p)}if(k){a.unsubscribe(k)}p=k=g=null}}});return b});