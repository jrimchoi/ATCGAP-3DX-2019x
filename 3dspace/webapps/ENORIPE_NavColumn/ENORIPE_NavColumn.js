/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/ENORIPE_NavColumn/NavWSProxy",["UWA/Core","DS/WAFData/WAFData","DS/PADUtils/PADUtilsServices","UWA/Promise","DS/ENORIPE_Relations/RelationsTabSettings"],function(e,g,c,f,a){var h=function(j){return typeof j==="string"?JSON.parse(j):j};var d=function(k,j,m){var l=null;l=g.authenticatedRequest(k,j);return l};var i=function(k,j,l){return new f(function(n,m){j.onComplete=function(q){var p=h(q);var o=p;if(l){o=l(p)}n(o)};j.onFailure=function(o){m(o)};if(j.data){j.data=JSON.stringify(j.data)}d(k,j,false)})};var b={getrelationprofiles:function(l,j){var k=c.get3DSpaceUrl(),m={};k=k+"/resources/enorelnav/navigate/getProfiles?tenant="+c.getPlatformId();m.method="POST";m.headers={Accept:"application/json","Content-Type":"application/json"};m.data={widgetId:c.getWidgetId(),roles:l,profileVersion:2};return i(k,m,false)},setpreferences:function(k){var l=c.get3DSpaceUrl(),m={};l=l+"/resources/enorelnav/navigate/setpreferences?tenant="+c.getPlatformId();m.method="POST";m.headers={Accept:"application/json","Content-Type":"application/json"};var j=[];j=j.concat(a.getOption("displayNameAttributes"));j=j.concat(a.getOption("detailAttributesLevel1"));j=j.concat(a.getOption("detailAttributesLevel2"));m.data={widgetId:c.getWidgetId(),relations:k,attributes_for_detailview:j,countmanagement:true};return i(l,m)},getDetail:function(m){var j=c.get3DSpaceUrl(),l={};j=j+"/resources/enorelnav/navigate/getecosystem?tenant="+c.getPlatformId();l.method="POST";l.headers={Accept:"application/json","Content-Type":"application/json"};var k=c.getWidgetId();l.data={widgetId:k,ids:m,debug:false};return i(j,l)},getRelationCount:function(l){var j=c.get3DSpaceUrl(),m={};j=j+"/resources/enorelnav/navigate/getrelationcount?tenant="+c.getPlatformId();m.method="POST";m.headers={Accept:"application/json","Content-Type":"application/json"};var k=c.getWidgetId();m.data={widgetId:k,ids:l.ids,relations:l.relations};return i(j,m)}};return b});define("DS/ENORIPE_NavColumn/RelationProfiles",["DS/ENORIPE_NavColumn/NavWSProxy","DS/Core/ModelEvents","DS/PlatformAPI/PlatformAPI","i18n!DS/ENORIPE_Relations/assets/nls/Relations"],function(d,e,b,c){var c;var a={fetchandStoreProfiles:function(f){var g=this;d.getrelationprofiles(f).then(function(h){var h=typeof h==="string"?JSON.parse(h):h;var k=g._getRelationsSet();if(k){for(var j=0;j<k.length;j++){h.profiles.splice(j+1,0,k[j])}}g.storeProfiles(h.profiles)})},storeProfiles:function(f){var k=this._fetchLastStoredProfile();this._profiles=f;this._profileNames=[];var j=false;for(var h=0;h<this._profiles.length;h++){var l=this._profiles[h];if(k){if(k===l.name){this.setCurrentProfile(l.name);j=true}}this._profileNames.push(l.name)}if(!j&&this._profileNames.length){var g=false;for(h=0;h<this._profileNames.length;h++){if(this._profileNames[h]==="Designer"){this.setCurrentProfile(this._profileNames[h]);g=true;break}}if(g===false){this.setCurrentProfile(this._profileNames[0])}}},getProfileNames:function(){return this._profileNames},getNlsForProfileNames:function(k){var j=[];for(var h=0;this._profileNames&&h<this._profileNames.length;h++){var g=this._profileNames[h];var f=c[g]||g;j.push({name:g,nls:f})}return j},getNlsForMenu:function(){return c["Manage-Relations"]},setCurrentProfile:function(f){if(this._currentProfile!==f||typeof this._currentProfile==="undefined"){this._currentProfile=f;this.publish("CurrentProfileChanged")}},getCurrentProfile:function(){return this._currentProfile},getCurrentProfileNls:function(){var f=c[this._currentProfile]||this._currentProfile;return f},getCurrentProfileRelations:function(){relations=[];var h=this._getCurrentProfileData();for(var f=0;h&&f<h.relations.length;f++){var g=h.relations[f];relations.push(g.name)}return relations},publish:function(f){this._ensureModelEvents();this._modelEvents.publish({event:f})},subscribe:function(f,g){this._ensureModelEvents();return this._modelEvents.subscribe({event:f},g)},_getCurrentProfileData:function(){for(var f=0;this._profiles&&f<this._profiles.length;f++){var g=this._profiles[f];if(g.name===this._currentProfile){return g}}return null},_ensureModelEvents:function(){if(!this._modelEvents){this._modelEvents=new e()}},_getRelationsSet:function(){var f=localStorage.getItem(this.getUserID()+"_ENORIPE_CustomRelationsSet");if(f){return JSON.parse(f)}},getUserID:function(){var f=b.getUser(),g=(f!==null&&f!==undefined&&f.login!==undefined)?b.getUser().login:"";return g},_fetchLastStoredProfile:function(){var f="LastUsedProfile-defaultID";if(typeof widget!=="undefined"&&widget!==null){return widget.getValue(f)}else{return localStorage.getItem(f)}}};return a});define("DS/ENORIPE_NavColumn/AdditionalColumns",["css!DS/ENORIPE_NavColumn/ENORIPE_NavColumn","i18n!DS/ENORIPE_NavColumn/assets/nls/ENORIPE_NavColumn.json","UWA/Core","UWA/Class","DS/PADUtils/PADContext","DS/ENORIPE_NavColumn/RelationProfiles","DS/ENORIPE_NavColumn/NavWSProxy","DS/Utilities/Dom","DS/ENORIPE_Relations/RelationsTabSettings","DS/PADUtils/PADUtilsServices"],function(j,l,f,c,i,g,k,a,d,e){function h(o,n,m){if(o[n]){o[n].hasNONPS+=m}else{o[n]={hasNONPS:m}}}var b=c.singleton({_columnDataIndex:["hasNONPS"],_columnDef:{hasNONPS:{dataIndex:"hasNONPS",text:l.hasNONPS,isDraggable:true,width:50,minWidth:50,isHidden:true,onCellRequest:function(q){if(q.manager.getColumnOptions("hasNONPS").isHidden===false){if(q.isHeader){var p=l.hasNONPS+"["+g.getCurrentProfileNls()+"]";q.model.setCellContent(p);q.cellView.getContent().setHTML(p);q.cellView._updateToolTip()}else{var m=false,o=q.nodeModel.options.grid.hasNONPS;if(o!==undefined&&o!==""){var n=""+o;if(o>0){q.cellView.reuseCellContent("padCheck")}else{q.cellView.getContent().setContent(" ")}}else{q.cellView.reuseCellContent("padLoaderCol")}}}},xnav_options:{dataIndex:"hasNONPS",exportable:{lock:false,value:true},layout:{hidden:true,width:50}}}},init:function(m){this._parent(m);var n=this;g.subscribe("CurrentProfileChanged",function(p){function t(x){if(x.options&&x.options.grid){x.options.grid.hasNONPS=0}}var u=i.get();if(u){var s=u.getPADTreeDocument();var w=s.getRoots();for(var r=0;r<w.length;r++){var v=w[r];t(v);v.processDescendants({processNode:t})}var q=u.getPADTreeListView();if(q&&q._datagrid){var o=q.getManager();if(!o.isColumnHidden("hasNONPS")){o.hideColumn("hasNONPS");o.showColumn("hasNONPS")}}d.setProfile(g.getCurrentProfile())}})},isAdditionalColumnsAvailable:function(o){if(f.is(o,"function")===false){throw new Error("A callback function should be defined")}var n={getPlatformID:function(){return e.getPlatformId()},getServiceID:function(){return"3DSpace"}};var m={isDraggable:true};d.isAvailable(n,m).then(function(p){if(f.is(p,"object")){e.app_initialization(function(){g.fetchandStoreProfiles(p.roles);o(true)})}else{o(false)}},function(){o(false)})},getName:function(){return l.hasNONPS},getManagedColumnNames:function(){return this._columnDataIndex},toBeUpdated:function(m){return true},updateAttributes:function(p,o){if(f.is(p,"object")===false){throw new Error("The object ids to modify must be specify")}if(f.is(o,"function")===false){throw new Error("A callback function should be defined")}var n={pids:{},relids:{}};p.pids.forEach(function(q){n.pids[q]={hasNONPS:undefined}});var m=g.getCurrentProfileRelations();k.getRelationCount({relations:m,ids:p.pids}).then(function(s){p.pids.forEach(function(u){n.pids[u]={hasNONPS:0}});var r=s.New&&s.New.Counts?s.New.Counts:[];for(var q=0;q<r.length;q++){var t=r[q];if(p.pids.indexOf(t.source)!==-1){h(n.pids,t.source,parseInt(t.count))}}o(n)})["catch"](function(q){console.error(q);p.pids.forEach(function(r){n.pids[r]={hasNONPS:0}});o(n)})},getAdditionalColumnsUX:function(p){var o=[];for(var n=0;n<p.length;n++){o.push(p[n].dataIndex)}for(var r=0;r<this._columnDataIndex.length;r++){var s=this._columnDataIndex[r];var q=f.clone(this._columnDef[s]);var m=o.indexOf(s);if(m===-1){p.push(q)}else{p[m]=f.extend(q,p[m],true);p[m].text=l[p[m].dataIndex]}}},registerReusableCellContent:function(m){m.getManager().registerReusableCellContent({id:"padCheck",buildContent:function(){return a.createElement("div",{"class":"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-check"})}});m.getManager().registerReusableCellContent({id:"padLoaderCol",buildContent:function(){return a.createElement("div",{"class":"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-reload wux-ui-3ds-spin"})}})},getOnCellClickCB:function(m){var n=this;if(this._columnDataIndex.indexOf(m)===0){return function(o){require(["DS/ApplicationFrame/CommandsManager"],function(p){var q=p.getCommandCheckHeader("RightSidePanel");if(q){if(q.getState()===false){q.setState(true,false)}q._propertiesWdg.selectFacet("relations")}})}}},getAdditionalCtxMenu:function(q){var r=false,o;if(q.ctxParams.treeview){r=q.ctxParams.treeview.isHeader;o=q.ctxParams.treeview.dataIndex}var p=[];if(r===true&&o==="hasNONPS"){p={type:"PushItem",title:g.getNlsForMenu(),fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-object-related-cog",family:WUXManagedFontIcons.Font3DS},submenu:[]};var s=g.getNlsForProfileNames();for(var n=0;n<s.length;n++){var m=s[n];p.submenu.push({type:"RadioItem",title:m.nls,state:g.getCurrentProfile()===m.name?"selected":"",action:{context:m.name,callback:function(t){g.setCurrentProfile(t.context)}}})}q.callback(g.getNlsForMenu(),p)}else{q.callback(null)}}});return b});