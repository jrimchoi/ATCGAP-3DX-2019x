/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/FlagPanel/FlagPanelEnums",[],function(){var a={};a.fieldsTypeEnum={STRING:1,INTEGER:2,DOUBLE:3,BUTTON:4,BOOLEAN:5,RADIO:6};return a});
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/FlagPanel/FlagPanel",["UWA/Core","DS/FlagPanel/FlagPanelEnums","UWA/Class","DS/Visualization/Node3D","DS/SceneGraphNodes/CSS2DNode","DS/Visualization/ThreeJS_DS","DS/Controls/LineEditor","DS/Core/Events","DS/VisuEvents/EventsManager","DS/Mesh/MeshUtils","DS/Manipulators/ScreenPlaneManipulator","UWA/Utils/Client","css!DS/UIKIT/UIKIT","css!DS/FlagPanel/FlagPanel.css"],function(f,k,a,g,l,j,e,m,b,d,h,i){var c={},n=a.extend({init:function(u,x){var B=this,p,A=0,s=10,o=1000,C=x||{},z,r,w,y,t,q,v;if(typeof u!=="object"){return}C.className=C.className||"";this._parent();this._viewer=u;this.options=C;this.screenPlaneManipulator=new h();this.screenPlaneManipulator.setExclusive(true);this.flagRoot=new g("FlagPanelRoot");this.flagRoot.setVisibilityInTree(false);this.flagRoot._getExcludeFromCSO=function(){return true};this._viewer.addNode(this.flagRoot);l._zIndexManager=function(){};B.canvas=f.createElement("canvas",{"class":"WUXFlagLeader"});B.flagLeader=new l({name:"FlagPanel2DLeader",html:B.canvas});B.flagLeader.getElement().getParent().style["line-height"]="0";B.flagLeader.setPickability(false);B.flagRoot.addChild(B.flagLeader);if(typeof C.position==="object"&&C.position instanceof j.Matrix4){this.flagRoot.setMatrix(C.position)}r=function(O,N){var P,K,F,D,R,E,J,M,Q,L,H,I=null,G=c[O.type];switch(O.type){case k.fieldsTypeEnum.BOOLEAN:L=f.createElement("div",{"class":"WUXFlagPanelDialog WUXFlagPanelBtnDialog",events:{click:function(S){S.stopPropagation();L.toggleClassName("activated");M=!M;if(typeof O.fnCallback==="function"){O.fnCallback(M)}}}}).inject(N);M=(typeof O.value==="boolean")?O.value:false;f.createElement("img",{"class":"WUXFlagPanelImgBtn",src:O.iconUrl}).inject(L);if(M===true){L.addClassName("activated")}break;case k.fieldsTypeEnum.RADIO:if(O.radios&&Array.isArray(O.radios)){K=O.radios.length;D=f.Utils.getUUID();L=f.createElement("div",{"class":"WUXFlagPanelDialog WUXFlagPanelBtnDialog WUXFlagPanelDropDown",events:{click:function(S){S.stopPropagation();if(R.isHidden()){R.show();b.addEvent(B._viewer.canvas,"onPrimaryPointerClick",R.hideMe)}else{R.hideMe()}}}}).inject(N);R=f.createElement("div",{"class":"WUXFlagPanelRadios",styles:{top:"-"+((K*34+12)+"px")}}).inject(L);R.hideMe=function(){b.removeEvent(B._viewer.canvas,"onPrimaryPointerClick",R.hideMe);R.hide()};R.hide();E=f.createElement("img",{"class":"WUXFlagPanelImgBtn"}).inject(L);f.createElement("div",{"class":"WUXFlagPanelDropDownBtn wux-afr-dropdown-arrow",html:'<span class="fonticon fonticon-expand-down"></span>'}).inject(L);H=function(S){E.set("src",S.target.parentElement.getElement("img").src);R.hideMe();b.removeEvent(B._viewer.canvas,"onPrimaryPointerClick",R.hideMe);R.getElement(".checked").removeClassName("checked");this.addClassName("checked");if(typeof O.fnCallback==="function"){O.fnCallback(S.target.value)}};for(P=0;P<K;++P){F=f.createElement("label",{"class":"WUXFlagPanelRadio",events:{change:H}}).inject(R);b.addEvent(B._viewer.canvas,"onPrimaryPointerClick",R.hideMe);f.createElement("input",{type:"radio",name:D,value:O.radios[P].value}).inject(F);f.createElement("img",{src:O.radios[P].iconUrl}).inject(F);f.createElement("span",{html:(O.radios[P].label)?O.radios[P].label:""}).inject(F);if(O.radios[P].isdefault){F.addClassName("checked");F.getChildren()[0].set("checked","true");E.set("src",O.radios[P].iconUrl)}}}break;default:J=O.prefix||"";M=O.value||c[O.type].defaultValue;Q=O.suffix||"";L=f.createElement("div",{"class":"WUXFlagPanelDialog btn-link",events:{click:function(V){var S,U,T=function(){N.closeActiveEditor=null;S.elements.container.childNodes[0].removeEventListener("keydown",U);b.removeEvent(B._viewer.canvas,"onPrimaryPointerClick",T);S.elements.container.removeClassName("error");I.hide();L.removeClassName("active");if(typeof O.fnCallback==="function"){O.fnCallback(M)}I.destroy();I=null},W=function(){if(typeof G.fnValid==="function"&&!G.fnValid(S.value)){S.elements.container.addClassName("error");return}M=S.value;L.setHTML(J+" "+M+" "+Q);T()};U=function(Z){var aa=Z.which||Z.keyCode,ab=N.getElementsByClassName("WUXFlagPanelDialog btn-link"),Y=[].indexOf.call(ab,L),X=ab.length;if(aa&&[9,13,27].indexOf(aa)!==-1){Z.preventDefault();Z.stopPropagation();Z.stopImmediatePropagation();switch(aa){case 9:setTimeout(function(){if(Z.shiftKey){if(Y>0){ab[Y-1].click()}else{ab[X-1].click()}}else{if(Y<X-1){ab[Y+1].click()}else{ab[0].click()}}},10);W();break;case 13:W();break;case 27:T();break;default:break}}};if(typeof N.closeActiveEditor==="function"){N.closeActiveEditor()}f.Event.stop(V);S=new e({disabled:false,value:M,selectAllOnFocus:true,autoCommitFlag:true,pattern:(G.pattern)?G.pattern:null});I=f.createElement("div",{"class":"WUXFlagPanelEdition",html:[{tag:"span","class":"WUXFlagPanelCancelBtn WUXFlagPaneleditor",html:'<span class="fonticon fonticon-close"></span>',events:{click:function(){T()}}},{tag:"div","class":"WUXFlagPanelCloseBtn WUXFlagPaneleditor btn-primary",html:[{tag:"span","class":"fonticon fonticon-check"}],events:{click:function(){W()}}}]}).inject(N);S.inject(I,"top");S.elements.container.addClassName("WUXFlagPanelInput");S.elements.container.childNodes[0].select();S.elements.container.childNodes[0].focus();S.elements.container.childNodes[0].addEventListener("keydown",U,true);b.addEvent(B._viewer.canvas,"onPrimaryPointerClick",T);L.addClassName("active");N.closeActiveEditor=T}},html:J+" "+M+" "+Q}).inject(N)}return I};w=function(){var D,G=10,H=B.flagPanel.getElement().getBoundingClientRect(),I=H.height,K=H.width,N,L,F={},O={},J,M=0,E=[{id:0,x:B.flagPanel.css2DNode.offset.x,y:B.flagPanel.css2DNode.offset.y+(I/2),len:0},{id:1,x:B.flagPanel.css2DNode.offset.x+(K/2),y:B.flagPanel.css2DNode.offset.y,len:0},{id:2,x:B.flagPanel.css2DNode.offset.x+K,y:B.flagPanel.css2DNode.offset.y+(I/2),len:0},{id:3,x:B.flagPanel.css2DNode.offset.x+(K/2),y:B.flagPanel.css2DNode.offset.y+I,len:0}];for(J=0;J<4;++J){E[J].len=new j.Vector2(E[J].x,E[J].y).length()}E.sort(function(Q,P){return Q.len-P.len});M=0;if((E[M].x<(G+1)&&E[M].id===0)||(E[M].x>(G+1)&&E[M].id===2)||(E[M].y<(G+1)&&E[M].id===1)||(E[M].y>(G+1)&&E[M].id===3)){L=E.filter(function(P){if(E[M].id===0||E[M].id===2){return(P.id===1||P.id===3)}else{return(P.id===0||P.id===2)}})}if(L){M=E.indexOf(((L[0].len<L[1].len)?L[0]:L[1]));L=null}if((Math.abs(E[M].x)<(G+1)&&(E[M].id===0||E[M].id===2))||(Math.abs(E[M].y)<(G+1)&&(E[M].id===1||E[M].id===3))){M=0;G=0}if(E[M].x>0){F.x=0;O.x=E[M].x-1}else{F.x=-E[M].x;O.x=1}if(E[M].y>0){F.y=0;O.y=E[M].y-1}else{F.y=-E[M].y;O.y=1}N=new j.Vector2(((E[M].x>0)?0:E[M].x),((E[M].y>0)?0:E[M].y));D=B.canvas.getContext("2d");B.canvas.width=Math.abs(F.x-O.x)+1;B.canvas.height=Math.abs(F.y-O.y)+1;D.clearRect(0,0,B.canvas.width,B.canvas.height);D.beginPath();D.moveTo(O.x,O.y);switch(E[M].id){case 1:D.lineTo(O.x,(O.y-G));break;case 2:D.lineTo((O.x+G),O.y);break;case 3:D.lineTo(O.x,(O.y+G));break;default:D.lineTo((O.x-G),O.y)}D.lineTo(F.x,F.y);D.lineWidth=1;D.strokeStyle="#000000";D.stroke();B.flagLeader.setOffset(N);B._viewer.render()};v=function(E,D,F){var G=new j.Vector2(E.event.from[0].event.clientX,E.event.from[0].event.clientY).sub(D).sub(F);B.flagPanel.setOffset(G);w();B._viewer.render();m.publish({event:"FlagPanel_Moved",data:{id:B.flagPanel.id}})};z=function(){var F,E,H,G,D=f.createElement("div",{"class":"WUXFlagPanel "+B.options.className});if(typeof B.options.iconUrl==="string"){B._icon=f.createElement("div",{"class":"WUXFlagPanelTypeIcon"});B._icon.inject(D);B.setIcon(B.options.iconUrl)}if(typeof B.options.label==="string"){f.createElement("div",{"class":"WUXFlagPanelLabel",html:B.options.label}).inject(D)}if(typeof B.options.dialogs!=="undefined"&&Array.isArray(B.options.dialogs)&&B.options.dialogs.length>0){G=f.createElement("section",{"class":"WUXFlagPanelDialogs"}).inject(D);E=B.options.dialogs.length;for(F=0;F<E;++F){if(c.hasOwnProperty(B.options.dialogs[F].type)){r(B.options.dialogs[F],G)}}}if(B.options.closeButton===true||typeof B.options.closeButton==="undefined"){f.createElement("div",{"class":"WUXFlagPanelCloseBtn btn-default",html:'<span class="fonticon fonticon-close"></span>',events:{click:function(){if(typeof B.options.closeCB==="function"){B.options.closeCB()}B.destroy()}}}).inject(D)}H=B.options.offset?B.options.offset:new j.Vector2(50,-50);B.flagRoot.removeChild(B.flagPanel);B.flagPanel=new l({html:D,"class":"WUXFlagPanel "+B.options.className,name:"FlagPanel2D",offset:H});B.flagPanel.setAlwaysOnTopIndex(999);B.flagPanel._getExcludeFromCSO=function(){return true};B.flagPanel.css2DNode.primitive=true;B.flagRoot.addChild(B.flagPanel)};z();p=setInterval(function(){var E,F,D=B.flagPanel.getElement().getBoundingClientRect();if((D.height===0||D.width===0)&&A<o){A+=s}else{clearInterval(p);w();y=function(I){var G,H=B._viewer.currentViewpoint.project(new j.Vector3().getPositionFromMatrix(B.flagRoot.getMatrixWorld()));E=new j.Vector2(H.x,H.y);G={x:H.x+B.flagPanel.getOffset().x,y:H.y+B.flagPanel.getOffset().y};F=new j.Vector2(I.event.from[0].event.clientX,I.event.from[0].event.clientY).sub(G)};t=function(G){if(typeof i.Engine.ie!=="undefined"){window.requestAnimationFrame(function(){v(G,E,F)})}else{v(G,E,F)}};q=function(G){B._viewer.setCursor("auto");t(G)};B._tokenBeginManipulate=B.screenPlaneManipulator.subscribe("BeginManipulate",y);B._tokenManipulate=B.screenPlaneManipulator.subscribe("Manipulate",t);B._tokenEndManipulate=B.screenPlaneManipulator.subscribe("EndManipulate",q);B.manipToken=B.screenPlaneManipulator.linkToNode(B.flagPanel);B.refresh=function(){w()}}},s)},setIcon:function(o){this.options.iconUrl=o;if(this._icon){this._icon.setStyle("background-image","url('"+o+"')")}},getOffset:function(){return this.flagPanel.getOffset()},setOffset:function(o){this.flagPanel.setOffset(o);if(typeof this.refresh==="function"){this.refresh()}},destroy:function(){if(this.manipToken){this.screenPlaneManipulator.unsubscribe(this._tokenBeginManipulate);this.screenPlaneManipulator.unsubscribe(this._tokenManipulate);this.screenPlaneManipulator.unsubscribe(this._tokenEndManipulate);this.screenPlaneManipulator.unlink(this.manipToken);this.manipToken=null;this.screenPlaneManipulator=null}if(this.flagRoot){this._viewer.removeNode(this.flagRoot);this.flagRoot=null}}});c[k.fieldsTypeEnum.STRING]={defaultValue:"",fnValid:function(o){if(typeof o==="string"&&o.length>0){return true}return false}};c[k.fieldsTypeEnum.INTEGER]={defaultValue:"1",pattern:"^[+-]?[0-9]*$",fnValid:function(o){if(typeof o==="number"){return true}if(typeof o==="string"&&o.length>0&&o.match(c[k.fieldsTypeEnum.INTEGER].pattern)){return true}return false}};c[k.fieldsTypeEnum.DOUBLE]={defaultValue:"1.0",pattern:"^[+-]?[0-9]*.?[0-9]+$",fnValid:function(o){if(typeof o==="number"){return true}if(typeof o==="string"&&o.length>0&&o.match(c[k.fieldsTypeEnum.DOUBLE].pattern)){return true}return false}};c[k.fieldsTypeEnum.BUTTON]={title:"",iconUrl:"",fnCallback:null};c[k.fieldsTypeEnum.BOOLEAN]={title:"",iconUrl:"",defaultValue:false,fnCallback:null};c[k.fieldsTypeEnum.RADIO]={title:"",iconUrl:"",fnCallback:null};return n});
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/FlagPanel/FlagPanelManager",["UWA/Core","UWA/Class","DS/FlagPanel/FlagPanel","DS/Visualization/ThreeJS_DS","DS/Core/Events"],function(f,b,c,d,a){var e=b.extend({init:function(l,p){var o=this,j={},n=5,i,g,k,m,h;this._onViewpointToken=a.subscribe({event:"/VISU/"},function(r){var q;if(r.eventType==="@onViewpointEndMove"){for(q in j){if(j.hasOwnProperty(q)){i(j[q])}}}});this.destroy=function(){if(o._onViewpointToken){a.unsubscribe(o._onViewpointToken)}};if(typeof l!=="object"){return}this._parent();this._viewer=l;this.options=p;g=function(q){var s=false,r;if(!q){return null}r=q.item.getOffset();k(q.id);if(q.boundingRect.left<n){r.x+=n-q.boundingRect.left;q.item.setOffset(r);s=true;k(q.id)}if(q.boundingRect.right>(o._viewer.SCREEN_WIDTH-n)){r.x+=(o._viewer.SCREEN_WIDTH-n)-q.boundingRect.right;q.item.setOffset(r);s=true;k(q.id)}if(q.boundingRect.top<n){r.y+=n-q.boundingRect.top;q.item.setOffset(r);s=true;k(q.id)}if(q.boundingRect.bottom>(o._viewer.SCREEN_HEIGHT-n)){r.y+=(o._viewer.SCREEN_HEIGHT-n)-q.boundingRect.bottom;q.item.setOffset(r);s=true;k(q.id)}return s};h=function(s,t){var r,q=g(s),u;t=t||0;if(t>1000||!s){return}for(r in j){if(j.hasOwnProperty(r)&&r!==s.id.toString()){k(s.id);s.boundingRect.left=(s.boundingRect.left>0)?s.boundingRect.left:0;s.boundingRect.right=(s.boundingRect.right<o._viewer.SCREEN_WIDTH)?s.boundingRect.right:o._viewer.SCREEN_WIDTH;s.boundingRect.top=(s.boundingRect.top>0)?s.boundingRect.top:0;s.boundingRect.bottom=(s.boundingRect.bottom<o._viewer.SCREEN_HEIGHT)?s.boundingRect.bottom:o._viewer.SCREEN_HEIGHT;if(!(s.boundingRect.top>(j[r].boundingRect.bottom+n)||s.boundingRect.bottom<(j[r].boundingRect.top-n)||s.boundingRect.left>(j[r].boundingRect.right+n)||s.boundingRect.right<(j[r].boundingRect.left-n))){u=s.item.getOffset().clone();if(!q&&s.boundingRect.top<(j[r].boundingRect.bottom+n)&&s.boundingRect.top>(j[r].boundingRect.top-n)){u.y=m(r).y+j[r].item.getOffset().y+j[r].boundingRect.height+n-m(s.id).y;q=true}if(!q&&s.boundingRect.bottom<(j[r].boundingRect.bottom+n)&&s.boundingRect.bottom>(j[r].boundingRect.top-n)){u.y=m(r).y+j[r].item.getOffset().y-s.boundingRect.height-n-m(s.id).y;q=true}if(q){t++;s.item.setOffset(u);h(s,t);break}}}}};i=function(q){g(q)};m=function(q){if(j.hasOwnProperty(q)){return o._viewer.currentViewpoint.project(new d.Vector3().getPositionFromMatrix(j[q].item.flagPanel.getMatrixWorld()))}return null};k=function(s){var t,q,r;if(j.hasOwnProperty(s)){t=m(s);q=j[s].item.flagPanel.getElement().getBoundingClientRect();r=j[s].item.getOffset();t.x+=r.x;t.y+=r.y;j[s].boundingRect={bottom:t.y+q.height,height:q.height,left:t.x,right:t.x+q.width,top:t.y,width:q.width}}};o.addFlag=function(q){var r=q.flagPanel.id;j[r]={id:r,item:q,boundingRect:{},listener:a.subscribe({event:"FlagPanel_Moved"},function(s){i(j[s.id])})};setTimeout(function(){k(r);h(j[r]);i(j[r])},25)};o.removeFlag=function(q){if(q.flagPanel.id&&typeof j[q.flagPanel.id]!=="undefined"){a.unsubscribe(j[q.flagPanel.id].listener);delete j[q.flagPanel.id]}};o.removeAll=function(){j={}}}});return e});