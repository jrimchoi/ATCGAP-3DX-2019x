define("DS/3DPlayAnnotation3D/Annotation3DCommand",["UWA/Class","DS/Mesh/MeshUtils"],function(a,b){return(a.extend({init:function(c){this._parent(c);this.frameWindow=c.frameWindow;this.annotationManager=c.annotationManager;this.hideTools=c.hideTools;this.viewer=this.frameWindow.getViewer();this._isRunning=false;this._pickingTrapSelection=this.viewer.picking.trapSelection;this._pickingActivate=this.viewer.picking.activated;this._pickingHL=this.viewer.picking.displayHL},begin:function(c){this._isRunning=true},end:function(c){this._isRunning=false},isRunning:function(){return this._isRunning},destroy:function(){this.annotationManager=undefined;this.viewer=undefined;this.frameWindow=undefined;this.hideTools=undefined;this._isRunning=undefined;this._pickingTrapSelection=undefined;this._pickingActivate=undefined;this._pickingHL=undefined;this._pickingSmallTarget=false},hideUI:function(){if(this.hideTools){this.hideTools()}},setViewer:function(e){if(!this.viewer){return}this._pickingSmallTarget=this.viewer.renderer.smallTargetPicking;this.viewer.setSmallRenderTargetPicking(false);if(!e.control){this.savedControl=this.viewer.currentViewpoint.control._mode;this.viewer.currentViewpoint.setDefaultController(true,"CATIA");this.touchRotationState=false;if(this.viewer.currentViewpoint.control.getTouchRotationActive){this.touchRotationState=this.viewer.currentViewpoint.control.getTouchRotationActive()}if(this.viewer.currentViewpoint.control.setTouchRotationActive){this.viewer.currentViewpoint.control.setTouchRotationActive(false)}}if(!e.highlight){this._pickingActivate=this.viewer.picking.activated;this._pickingTrapSelection=this.viewer.picking.trapSelection;this._pickingHL=this.viewer.picking.displayHL;this.viewer.setPicking({activated:false,trapSelection:false,displayHL:false});this.viewer.setPrePicking({activated:false,displayHL:false})}if(!e.pickable){var d=this.annotationManager.getAnnotationBag();for(var f=0;f<d.children.length;f++){var c=d.children[f];var g=c.getChildByName("Annotation_Representation");g.setPickable(b.NOPICKABLE)}}},unsetViewer:function(){if(!this.viewer){return}var d=this.annotationManager.getAnnotationBag();for(var e=0;e<d.children.length;e++){var c=d.children[e];var f=c.getChildByName("Annotation_Representation");f.setPickable(b.PICKABLE)}if(this.viewer.setPicking){this.viewer.setPicking({activated:this._pickingActivate,trapSelection:this._pickingTrapSelection,displayHL:this._pickingHL})}if(this.viewer.setPrePicking){this.viewer.setPrePicking({activated:this._pickingActivate,displayHL:this._pickingHL})}if(this.viewer.currentViewpoint&&this.viewer.currentViewpoint.control){this.viewer.currentViewpoint.control.setMode(this.savedControl);if(this.viewer.currentViewpoint.control.setTouchRotationActive){this.viewer.currentViewpoint.control.setTouchRotationActive(!this.touchRotationState)}}this.viewer.setSmallRenderTargetPicking(this._pickingSmallTarget);this.viewer.render()}}))});define("DS/3DPlayAnnotation3D/Annotation3DDrawPreview",["UWA/Class","UWA/Core","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/3DPlayAnnotationUtils/CursorManager","DS/Core/PointerEvents","DS/WebUtils/Vector2","DS/CoreEvents/Events","DS/VisuEvents/EventsManager"],function(a,e,c,d,f,i,h,b){var g;return(a.extend({init:function(j){this._parent(j);g=this;this.frameWindow=j.frameWindow;this.hideUICB=j.hideUICB;this.strokeCompleteCB=j.strokeCompleteCB;this.drawSettings=new c();this.viewerPoints=[];var k=this.frameWindow.experience;if(k&&k.registerCollabAction){this.exp=k;k.registerCollabAction("annotBeginManipulate",g._beginManipulate.bind(g));k.registerCollabAction("annotManipulate",g._manipulate.bind(g));k.registerCollabAction("annotEndManipulate",g._endManipulate.bind(g))}},begin:function(j){this._createCanvas();this.viewer=this.frameWindow.getViewer();this.cursorContainer=this.viewer.canvas;this.cursorManager=new d();this._setMouseCursor("custom");this.tokenSettingsChanged=h.subscribe({event:"3DPlay.Annotation.SettingsChanged"},function(k){if(g.exp&&g.exp.collabMode===true&&g.exp.notifyAction){g.exp.notifyAction("annotChangeSettings",[k])}g._setMouseCursor("custom")});this._activateManipulators()},end:function(j){h.unsubscribe(this.tokenSettingsChanged);this._disableManipulators();this.viewer=undefined;if(this.cursorManager){this._setMouseCursor("auto");this.cursorManager.dispose();this.cursorManager=null}this._destroyCanvas();this.drawSettings=undefined;this.cursorContainer=undefined},destroy:function(){this.viewerPoints=[];this.frameWindow=undefined;this.hideUICB=undefined;this.strokeCompleteCB=undefined;g=null;this.exp=null},_setMouseCursor:function(j){if(this.cursorManager){this.cursorManager.setMouseCursor({container:this.cursorContainer,caller:"3D",type:j,drawSettings:this.drawSettings})}},_createCanvas:function(){var j=this.frameWindow.getUIFrame();this.canvas=new e.Element("canvas",{id:"annotPreviewCanvas",styles:{zindex:"2000",pointerEvents:"none"}}).inject(j);var k=this.frameWindow.getViewerFrame();var l=k.getDimensions();this.canvas.width=l.width;this.canvas.height=l.height;this.canvasContext=this.canvas.getContext("2d")},_destroyCanvas:function(){this.canvasContext=undefined;this.canvas.remove();this.canvas=undefined},_setStrokeStyle:function(){this.canvasContext.strokeStyle=""+this.drawSettings.getColor();this.canvasContext.fillStyle=""+this.drawSettings.getColor();this.canvasContext.globalAlpha=1;this.canvasContext.lineCap="round";this.canvasContext.lineJoin="round";this.canvasContext.lineWidth=this.drawSettings.getThickness()},_getPosition:function(l){var j=this.canvas.getBoundingClientRect();var m=this.viewer.getMousePosition(new i(l.clientX,l.clientY));var k=new i((m.xPix/window.devicePixelRatio)-j.left,(m.yPix/window.devicePixelRatio)-j.top);if(this.exp&&this.exp.collabMode===false){if(j.height!==origin.height||j.width!==origin.width){k.x=k.x*j.height/l.height-(j.height/l.height*l.width-j.width)/2;k.y=k.y*j.height/l.height-(j.height/l.height*l.height-j.height)/2}}return k},_beginManipulate:function(m){this.viewerPoints=[];var j=this._getPosition(m);this.viewerPoints.push(j);this.hideUICB();this._setStrokeStyle();this.canvasContext.beginPath();this.canvasContext.moveTo(j.x,j.y);if(this.exp&&this.exp.collabMode===true){var k=m.target?m.target:m.srcElement;var l=k.getBoundingClientRect();this.exp.notifyScriptingFunction("annotBeginManipulate",[{clientX:m.clientX,clientY:m.clientY,width:l.width,height:l.height}])}},_manipulate:function(m){var j=this._getPosition(m);this.viewerPoints.push(j);this.canvasContext.lineTo(j.x,j.y);this.canvasContext.stroke();this.canvasContext.beginPath();this.canvasContext.moveTo(j.x,j.y);if(this.exp&&this.exp.collabMode===true){var k=m.target?m.target:m.srcElement;var l=k.getBoundingClientRect();this.exp.notifyScriptingFunction("annotManipulate",[{clientX:m.clientX,clientY:m.clientY,width:l.width,height:l.height}])}},_endManipulate:function(m){var j=this._getPosition(m);this.viewerPoints.push(j);this.strokeCompleteCB(this.viewerPoints);this.viewerPoints=[];this.canvasContext.clearRect(0,0,this.canvas.width,this.canvas.height);if(this.exp&&this.exp.collabMode===true){var k=m.target?m.target:m.srcElement;var l=k.getBoundingClientRect();this.exp.notifyScriptingFunction("annotEndManipulate",[{clientX:m.clientX,clientY:m.clientY,width:l.width,height:l.height}])}},_activateManipulators:function(){if(this.exp&&this.exp.collabMode!==undefined&&this.exp.collabMode===false){return}else{this.draw=false;this.gesture=false;this.proxyEventTarget=this.frameWindow.getViewerFrame();this.pointerOut=function(j){if(j.button==0&&g.draw==true&&g.viewer.currentViewpoint.isMoving()!==true){console.log("Outside the border");g.draw=false;g.gesture=false;g.canvasContext.clearRect(0,0,g.canvas.width,g.canvas.height);g.viewerPoints=[];if(g.cursorManager){g._setMouseCursor("auto")}}};this.onPinch=function(j){if(j.state==="begin"){console.log("pinch is started");g.gesture=true}};this.proxyEventTarget.addEventListener("mouseout",this.pointerOut,true);this.proxyEventTarget.addEventListener("touchcancel",this.pointerOut,true);b.addEvent(document,"onPinch",this.onPinch);this.proxyEventTarget.addEvent(f.POINTERDOWN,function(j){console.log("this.canvas.height"+g.canvas.height);console.log("this.canvas.width"+g.canvas.width);if(j.button==0&&g.viewer.currentViewpoint.isMoving()!==true){g.draw=true;g._beginManipulate(j)}});this.proxyEventTarget.addEvent(f.POINTERMOVE,function(j){if(g.gesture==true){g.draw=false}if(j.button==0&&g.draw==true&&g.viewer.currentViewpoint.isMoving()!==true){g._manipulate(j)}});this.proxyEventTarget.addEvent(f.POINTERUP,function(j){if(j.button==0&&g.draw==true&&g.gesture==false&&g.viewer.currentViewpoint.isMoving()!==true){g._endManipulate(j)}g.draw=false;g.gesture=false})}},_disableManipulators:function(){if(!this.exp||this.exp.collabMode!==false){this.proxyEventTarget.removeEvent(f.POINTERDOWN);this.proxyEventTarget.removeEvent(f.POINTERMOVE);this.proxyEventTarget.removeEvent(f.POINTERUP);this.proxyEventTarget.removeEventListener("mouseout",this.pointerOut,true);this.proxyEventTarget.removeEventListener("touchcancel",this.pointerOut,true);b.removeEvent(document,"onPinch",this.onPinch);this.proxyEventTarget=undefined}}}))});define("DS/3DPlayAnnotation3D/AnnotationTour",["DS/ApplicationFrame/Command","DS/WebInfraUI/NavigationArrows","DS/WebUtils/ContextedSingleton","DS/CoreEvents/Events","DS/WebUtils/Tracker"],function(f,e,d,a,c){var b=f.extend({init:function(g){this._parent(g,{isAsynchronous:true,mode:"exclusive"});this._exp=this.getFrameWindow().experience;this.disable();this.enableCommand=function(){this.enable()};this.disableCommand=function(){this.disable()};this.AnnotationTourEnableSubscribe=a.subscribe({event:"3DPLAY/ANNONATIONTOUR/ENABLE"},this.enableCommand.bind(this));this.AnnotationTourDisableSubscribe=a.subscribe({event:"3DPLAY/ANNONATIONTOUR/DISABLE"},this.disableCommand.bind(this));if(this._exp.registerCollabAction){this._exp.registerCollabAction("StartAnnotationTour",this.beginExecute.bind(this));this._exp.registerCollabAction("StopAnnotationTour",this.endExecute.bind(this))}},beginExecute:function(){c.inc("command-"+this.getId());var g=d.get(this._ctx,"ANNOTATION_MANAGER");this.navigationArrows=new e({arrowCB:{left:function(){if(g){g.updateViewPoint({direction:"left"})}},right:function(){if(g){g.updateViewPoint({direction:"right"})}}}},{container:this.getFrameWindow().getUIFrame(),frmWindow:this.getFrameWindow()});if(this._exp&&this._exp.notifyAction&&this._exp.collabMode===true){this._exp.notifyAction("StartAnnotationTour")}a.publish({event:"3DPLAY/SPECTREE/DISABLE",data:{}})},endExecute:function(){this.navigationArrows.dispose();this.navigationArrows=null;if(this._exp&&this._exp.notifyAction&&this._exp.collabMode===true){this._exp.notifyAction("StopAnnotationTour")}var g=this.getFrameWindow();if(g){var h=g.getActionBar();if(h){if(h.MAB&&h.MAB.state.visible===false){a.publish({event:"3DPLAY/SPECTREE/ENABLE",data:{}})}}}},_destroy:function(){this._exp=undefined;if(this.AnnotationTourEnableSubscribe){a.unsubscribe(this.AnnotationTourEnableSubscribe)}if(this.AnnotationTourDisableSubscribe){a.unsubscribe(this.AnnotationTourDisableSubscribe)}this._parent()}});return b});define("DS/3DPlayAnnotation3D/AnnotationUtils",["DS/Visualization/ThreeJS_DS","DS/WebUtils/GeometryUtils","DS/Mesh/MeshUtils","DS/3DPlayAnnotationUtils/ShapeUtils"],function(a,c,d,b){return{getBarycenter2DPixel:function(g){var f=new a.Vector2();for(var e=0;e<g.length;e++){f.x+=g[e].xPix;f.y+=g[e].yPix}f.x/=e;f.y/=e;return f},scaleMousePositions:function(g,m){function f(){this.x=0,this.y=0,this.xPix=0,this.yPix=0}var l=c.getBarycenter2D(g);var j=new a.Vector2(l.x,l.y);var k=this.getBarycenter2DPixel(g);var p=[];var e;var o,n;for(var h=0;h<g.length;h++){e=new f();o=new a.Vector2();o.x=g[h].x;o.y=g[h].y;o.sub(j);o.multiplyScalar(m);o.add(j);n=new a.Vector2();n.x=g[h].xPix;n.y=g[h].yPix;n.sub(k);n.multiplyScalar(m);n.add(k);e.x=Math.round(o.x);e.y=Math.round(o.y);e.xPix=Math.round(n.x);e.yPix=Math.round(n.y);p.push(e)}return p},pixelToNormalizedCoord:function(j,e,f){var h=[];for(var g=0;g<j.length;g++){h.push({x:(j[g].x-e/2)/(e/2),y:-(j[g].y-f/2)/(f/2),xPix:j[g].x*window.devicePixelRatio,yPix:j[g].y*window.devicePixelRatio})}return h},areSameNormals:function(f){var e=true;var j,g;var k;for(var h=0;h<f.length-1;h++){j=f[h].clone().normalize();g=f[h+1].clone().normalize();k=j.cross(g);if(k.length()>0.35){e=false}}return e},isHeightDifferenceOK:function(e){var f=true;var m,l,k;var j,h;for(var g=0;g<e.length-2;g++){m=e[g];l=e[g+1];k=e[g+2];j=m.distanceTo(l);h=l.distanceTo(k);if(j!=0&&h!=0&&h>20*j){f=false}}return f},onScreenProjection:function(m,j){var e=[];var l=j.currentViewpoint.getCamera();var g=l.matrixWorldInverse;var k=l.projectionMatrix;var o;var f=j.SCREEN_WIDTH;var n=j.SCREEN_HEIGHT;for(var h=0;h<m.length;h++){o=m[h].clone();o=new a.Vector4(o.x,o.y,o.z,1);o.applyMatrix4(g);o.applyMatrix4(k);o.divideScalar(o.w);o.x=f/2+o.x*f/2;o.y=n/2-o.y*n/2;e.push(new a.Vector2(Math.round(o.x),Math.round(o.y)))}return e},compute2DBoundingboxFrom3D:function(l,k,i,h){var f=this.onScreenProjection(l,k);var e=c.boundingBoxCompute(c.convexHullCompute(f));if(h!=undefined&&h>1){e=this.scaleShape2D(e,h)}if(i!="line"&&i!="unknownOpen"){var j=c.getBarycenter2D(e);var g=new a.Vector2(j.x,j.y);e=this.createCirclePointArray(g,e[0].distanceTo(e[2])/2)}else{if(i=="unknownOpen"){}}return e},screenToWorldPlaneProjection:function(l,g,j,e){var k=j.projectionMatrix;var h=new a.Matrix4().getInverse(k);if(e===true){l=b._interpolate2D(l)}for(var f=0;f<l.length;f++){if(j instanceof a.PerspectiveCamera){l[f].x*=-g;l[f].y*=-g;if(l[f].z){l[f].z*=-g}else{l[f].z=0}}l[f]=new a.Vector4(l[f].x,l[f].y,l[f].z,-g).applyMatrix4(h);l[f].z=g;l[f]=new a.Vector4(l[f].x,l[f].y,l[f].z,1).applyMatrix4(j.matrixWorld);l[f]=new a.Vector3(l[f].x,l[f].y,l[f].z)}return l},getCameraNearestZPoint:function(h,f){var j=new a.Vector3(0,0,-9999999);var g;for(var e=0;e<h.length;e++){g=h[e].clone().applyMatrix4(f.matrixWorldInverse);if(g.z>j.z){j=g.clone()}}return j},isWireframe:function(h){var g=h.getRenderer();var f=g.getRenderLineMode();var e=(g.renderFaceMode===0)?true:false;return e},nearestAnnotToText:function(i,p,h,k){var r;var g=false;var h=h||1;var s=i;if(h!==1){var m=(i[3].y-i[2].y)/2;var j=(i[2].x-i[1].x)/2;var o={x:i[1].x+j,y:i[1].y+m};var f=j*h;var n=m*h;s=[new a.Vector2(o.x-f,o.y+n),new a.Vector2(o.x-f,o.y-n),new a.Vector2(o.x+f,o.y-n),new a.Vector2(o.x+f,o.y+n)]}for(var q=0;q<p.length;q++){if(p[q].points.length>0&&p[q].onModel!==true){var l=c.boundingBoxCompute(c.convexHullCompute(this.onScreenProjection(p[q].points,k)));var t=c.isIntersect(l,s);if(t){if(g===true&&h!==1){var e=c.isIntersect(l,i);if(e===true){r=p[q].repBag.children[0];g=true}}else{r=p[q].repBag.children[0];g=true}}}}return r},setNodePickable:function(f,e){if(f&&f.setPickable){if(true===e){f.setPickable(d.PICKABLE)}else{f.setPickable(d.NOPICKABLE)}}},getUniquePointsFromPointsArray:function(h,l){var e=[];for(var g=0;g<h.length;g++){var k=true;for(var f=0;f<e.length;f++){if(h[g].equals(e[f])){k=false;break}}if(k){e.push(h[g]);if(l&&e.length===l){break}}}return e},_areAlmostSameViewpoints:function(l,j){var g=l.eyePosition.equals(j.eyePosition);var f=l.eyePosition.distanceTo(j.eyePosition);var k=l.upDirection.equals(j.upDirection);var i=l.upDirection.angleTo(j.upDirection)*(180/Math.PI);var h=l.sightDirection.equals(j.sightDirection);var e=l.sightDirection.angleTo(j.sightDirection)*(180/Math.PI);if(f<0.1&&i<0.001&&e<0.001){return true}else{return false}}}});define("DS/3DPlayAnnotation3D/AnnotationShapes",["UWA/Class","DS/WebUtils/GeometryUtils","DS/3DPlayAnnotation3D/AnnotationUtils","DS/Visualization/ThreeJS_DS","DS/CATCreaDesWebUIServices/CATCrDWebUIServices","DS/Visualization/Node3D","DS/3DPlayAnnotationUtils/ShapeUtils","DS/Visualization/SceneGraphFactory","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/WebSystem/Settings"],function(d,b,n,m,e,i,c,l,f,a){var h=10;var o=a.get("3DPlay.Annotation.PerformanceMode");var k=d.extend({init:function(p,q){this.drawSettings=new f();this.frameWindow=p.frameWindow;this.viewer=this.frameWindow.getViewer();this.annotationManager=p.annotationManager;this.id=Date.now();this.type=q;this.geometry={};this.graphicalProp={color:null,opacity:null,thickness:null};this.points=[];this.normals=[];this.onModel=false;this.vpOrient=new m.Vector3;this.model=this.annotationManager.getModel();this.onSectionPlane=false},dispose:function(){this.drawSettings=null;this.frameWindow=null;this.viewer=null;this.annotationManager=null;this.id=null;this.type=null;this.geometry=null;this.graphicalProp=null;this.points=null;this.normals=null;this.onModel=null;this.vpOrient=null;this.model=null;this.onSectionPlane=null},_checkSectionPlane:function(t){var r=t.path;for(var s=0;s<r.length;s++){var u=r[s];if(u.getLastElement&&u.getLastElement().getParents){var q=u.getLastElement().getParents();for(var p=0;p<q.length;p++){if(q[p].name&&q[p].name==="Section plane"){this.onSectionPlane=true;break}}}}},_getPickPointsAndNormals:function(r,u,q){var t=this.frameWindow.getViewer();var x=[];var y=[];var w=[];var v=[];n.setNodePickable(this.model,true);for(var s=0;s<r.length;s++){var p=t.pick(r[s],u,true);if(p.path.length>0){if(!this.onSectionPlane&&q){this._checkSectionPlane(p)}w.push(p.position.clone());v.push(p.normal.clone())}x.push(p.position.clone());y.push(p.normal.clone())}n.setNodePickable(this.model,false);return{pickPoints:x,pickNormals:y,onModel:{points:w,normals:v}}},_getIntermediatePointsOfLineOnModel:function(u,p,x,v){var D=[];var y=[];var F=(new m.Vector3).subVectors(x,p);var A=F.length()/v;var r=F.clone().normalize();var E=this.frameWindow.getViewpoint().getEyePosition();var C=[];for(var t=0;t<v;t++){var z=(new m.Vector3).addVectors(p,r.clone().multiplyScalar(A*t));C.push(z)}var q=n.onScreenProjection(C,this.viewer);var w=[];for(var s=0;s<q.length;s++){w.push(this.viewer.getMousePosition(q[s]))}var B=this._getPickPointsAndNormals(w,"mesh",true);D=[].concat(B.onModel.points);y=[].concat(B.onModel.normals);return{points:D,normals:y}},_getThickness:function(B,s,u){var v=new m.Box2;v.setFromPoints(B);var z=v.max.distanceTo(v.min);var x=new m.Box3;var E=Infinity;var t=new m.Vector3;for(var D=0;D<s.length;D++){var C=u.distanceTo(s[D]);if(C<E){E=C;t.copy(s[D])}}var q=t.clone();var G=u.clone().sub(q).normalize();var A=new m.Plane();A.setFromNormalAndCoplanarPoint(G,q);var r=[];for(var D=0;D<s.length;D++){var F=((new m.Vector3).subVectors(s[D],u)).normalize();var w=new m.Ray(u,F);r.push(w.intersectPlane(A))}x.setFromPoints(r);var y=x.max.distanceTo(x.min);var p=this.drawSettings.getThickness();p*=(y/z);p*=window.devicePixelRatio;return p},_saveLastPos:function(C){var z;var v=this.frameWindow.getViewerFrame().getDimensions();var x=v.height;var s=v.width;var B=C.path;var u=C.shapeType;if(u=="line"||u==="unknownOpen"){var r=B.length;if(B[r-1].x-B[r-3].x>=0){z={y:((B[r-1].y)/x),x:((B[r-1].x)/s)}}else{if(B[r-1].x-B[r-3].x<0){z={y:((B[r-1].y)/x),x:((B[r-1].x-90)/s)}}}}else{if(u==="arrow"){var q=C.arrowType;var r=B.length;var w=C.vertices;if((B[r-1].x-B[r-3].x>=0)||(B[r-1].x-B[r-3].x<0)){z={y:((w[1].y)/x),x:((w[1].x-125)/s)}}else{z={y:((w[1].y)/x),x:((w[1].x)/s)}}}else{var t=b.boundingBoxCompute(b.convexHullCompute(B));var p=t[0].x;var y=t[0].y;for(var A=1;A<t.length;A++){if(t[A].x<=p){p=t[A].x}if(t[A].y>=y){y=t[A].y}}z={y:((y)/x),x:((p)/s)}}}this.drawSettings.setLastPosition(z)},createFromMousePositions:function(L){var t=this.frameWindow.getViewer();var G=this.frameWindow.getViewpoint();var P=G.getCamera();var F=(P instanceof m.OrthographicCamera)?"THREE.OrthographicCamera":"THREE.PerspectiveCamera";var p=new m.Vector3(0,0,-1).applyQuaternion(P.quaternion).normalize();var D=G.getEyePosition();var u=n.isWireframe(t);var K=[];var A=[];var z=[];for(var M=0;M<L.length;M++){z.push(new m.Vector2(L[M].xPix,L[M].yPix))}var w=this._getPickPointsAndNormals(L,"mesh",true);var N=false;var C=w.onModel.points.length;var J=n.areSameNormals(w.onModel.normals);var s=n.isHeightDifferenceOK(w.onModel.points);if((L.length===C)&&!u&&J&&s&&!this.onSectionPlane){N=true}if(N){for(var M=0;M<w.onModel.points.length;M++){K.push(w.onModel.points[M].add(w.onModel.normals[M].clone().normalize().multiplyScalar(0.5)))}A=w.onModel.normals.slice(0)}else{var O=1;if(0<C){O=n.getCameraNearestZPoint(w.onModel.points,P).z}else{var E=n.scaleMousePositions(L,0.35);var H=this._getPickPointsAndNormals(E,"mesh");if(H.onModel.points.length>0){O=n.getCameraNearestZPoint(H.pickPoints,P).z}else{var Q=this.annotationManager.getCurrentAnnotViewpoint();if(Q&&Q.annotList.length>0){var y;var r;var v=b.getBarycenter2D(b.boundingBoxCompute(b.convexHullCompute(z)));var q=Infinity;var I;for(var M=0;M<Q.annotList.length;M++){r=n.compute2DBoundingboxFrom3D(Q.annotList[M].points,t,"line");y=b.getBarycenter2D(r);I=v.distanceTo(y);if(I<q){q=I;var x=b.getBarycenter(Q.annotList[M].points);var y=new m.Vector3(x.x,x.y,x.z);O=y.applyMatrix4(P.matrixWorldInverse).z}}}else{O=this.model.getBoundingBox().center().clone().applyMatrix4(P.matrixWorldInverse).z}}}var B=false;if(o){if(this.type==="circle"||this.type==="ellipse"){B=true}}K=n.screenToWorldPlaneProjection(L.slice(0),O,P,B);for(var M=0;M<K.length;M++){A.push(p.clone().negate())}}this.points=K.slice(0);this.normals=A.slice(0);this.onModel=N;this.vpOrient.copy(p);this.graphicalProp={color:this.drawSettings.getColor(),opacity:this.drawSettings.getOpacity(),thickness:this._getThickness(z,K,D)};this._saveLastPos({shapeType:this.type,path:z})},draw:function(){var s=this.frameWindow.getViewpoint();var r=s.getCamera();var q=e.createMaterial(new m.Color(this.graphicalProp.color),this.graphicalProp.opacity,1);var p=e.createPencilGP(this.points,this.normals,this.graphicalProp.thickness,q);p.setShadow(false);p.name="Annotation_Representation";p.annotID=this.id;this.repBag=new i("3DPlay_Sketch_Annotation");this.repBag.add(p);if(!this.onModel){this.repBag.setNoZ(true)}else{this.repBag.setNoZ(false)}},drawOnModel:function(t){var r=[];var s=[];for(var q=0;q<t.geometry.points.length;q++){var u=t.geometry.points[q];var v=t.geometry.normals[q];r.push(new m.Vector3(u.x,u.y,u.z));s.push(new m.Vector3(v.x,v.y,v.z))}this.points=r;this.normals=s},getJSON:function(){if(this.json){return this.json}else{var p=(this.onModel)?{points:this.points,normals:this.normals}:this.get3DGeometry(this.points);return{id:this.id,type:this.type,onModel:this.onModel,geometry:p,graphicalProp:this.graphicalProp,pointsCount:this.points.length,annotPlaneNormal:this.normals[0],annotStartPoint:this.points[0]}}},setJSON:function(p){this.id=p.id;this.type=p.type;this.onModel=p.onModel;this.graphicalProp=p.graphicalProp;this.json=p},get3DGeometry:function(p){console.log("To be implemented by derived class")},createFromJSON:function(p){console.log("To be implemented by the derived class")}});var j=k.extend({init:function(p,q){this._parent(p,q)},dispose:function(){this.extremityBegin=null;this.extremityEnd=null;this.shapeStartPoint=null;this.shapeEndPoint=null;this.shapePoints=null;this.arrowHeadEnd=null;this._parent()},_isShapeCloseToModel:function(v){var A=1;var y=this.frameWindow.getViewpoint().getCamera();var D=[];for(var w=0;w<v.length;w++){D.push(this.viewer.getMousePosition(v[w]))}var z={x:D[0].x-D[2].x,y:D[0].y-D[2].y,xPix:D[0].xPix-D[2].xPix,yPix:D[0].yPix-D[2].yPix};var x={x:D[D.length-1].x-D[D.length-3].x,y:D[D.length-1].y-D[D.length-3].y,xPix:D[D.length-1].xPix-D[D.length-3].xPix,yPix:D[D.length-1].yPix-D[D.length-3].yPix};var C=[];var B=[];for(var w=0;w<Math.round(D.length/2);w++){C.push({x:D[0].x+z.x*(w+1),y:D[0].y+z.y*(w+1),xPix:D[0].xPix+z.xPix*(w+1),yPix:D[0].yPix+z.yPix*(w+1)})}var s=this._getPickPointsAndNormals(C,"mesh");var u=s.onModel.points;for(var w=0;w<Math.round(D.length/2);w++){B.push({x:D[D.length-1].x+x.x*(w+1),y:D[D.length-1].y+x.y*(w+1),xPix:D[D.length-1].xPix+x.xPix*(w+1),yPix:D[D.length-1].yPix+x.yPix*(w+1)})}var r=this._getPickPointsAndNormals(B,"mesh");var t=r.onModel.points;if(u.length!=0||t.length!=0){var q=n.getCameraNearestZPoint(u,y);var p=n.getCameraNearestZPoint(t,y);q.z>-9999999?this.extremityBegin=q:this.extremityBegin=undefined;p.z>-9999999?this.extremityEnd=p:this.extremityEnd=undefined;if(this.extremityBegin!==undefined&&this.extremityEnd===undefined){A=this.extremityBegin.z;this.points=n.screenToWorldPlaneProjection(D,A,y)}else{if(this.extremityBegin===undefined&&this.extremityEnd!==undefined){A=this.extremityEnd.z;this.points=n.screenToWorldPlaneProjection(D,A,y)}}}},createFromMousePositions:function(B){if(B.onModel){this.onModel=true}this.shapeStartPoint=(this.points.length>0)?this.points[0]:B.shapePoints3D[0].clone();this.shapeEndPoint=(this.points.length>0)?this.points[this.points.length-1]:B.shapePoints3D[B.shapePoints3D.length-1].clone();var y=B.shapePoints2D[0].clone();var s=B.shapePoints2D[B.shapePoints2D.length-1].clone();var F=B.arrowhead[1];var t=y.distanceTo(F);var v=s.distanceTo(F);var E=new m.Vector3;this.shapePoints=(this.points.length>0)?this.points:B.shapePoints3D.slice(0);var r=new m.Vector3;var z=[];if(t<v){this.arrowHeadEnd="start";E.copy(this.shapeStartPoint);r.subVectors(this.shapePoints[2],E).normalize();z=z.concat(this.shapePoints)}else{this.arrowHeadEnd="end";E.copy(this.shapeEndPoint);r.subVectors(this.shapePoints[this.shapePoints.length-2],E).normalize();z=z.concat(this.shapePoints.slice(0).reverse())}var q=(this.type==="arrow")?b.getCurveLength(this.shapePoints)*0.2:b.getCurveLength(this.shapePoints)*0.1;var x=(new m.Vector3).crossVectors(r,B.normal).add(r).normalize().multiplyScalar(q);var w=(new m.Vector3).crossVectors(B.normal,r).add(r).normalize().multiplyScalar(q);var p=new m.Vector3(E.x+x.x,E.y+x.y,E.z+x.z);var G=new m.Vector3(E.x+w.x,E.y+w.y,E.z+w.z);if(this.onModel){var D=this._getIntermediatePointsOfLineOnModel(this.model,p,E,h);var C=this._getIntermediatePointsOfLineOnModel(this.model,E,G,h);this.points=[].concat(D.points.slice(0).reverse(),D.points,C.points,C.points.slice(0).reverse(),z);this.normals=[].concat(D.normals.slice(0).reverse(),D.normals,C.normals,C.normals.slice(0).reverse());for(var A=0;A<z.length;A++){this.normals.push(B.normal)}}else{if(this.points.length===0){this.points=[E,p,E,G,E].concat(z);for(var A=0;A<this.points.length;A++){this.normals.push(B.normal)}}else{if(this.arrowHeadEnd==="end"){this.points=this.points.slice(0).reverse()}this.points.unshift(E,p,E,G,E);for(var A=0;A<this.points.length;A++){this.normals.push(B.normal)}}}this.arrowHeadPoints=[p,G];var u=this.frameWindow.getViewpoint().getEyePosition();this.graphicalProp={thickness:this._getThickness(B.shapePoints2D,this.points,u),color:this.drawSettings.getColor(),opacity:this.drawSettings.getOpacity()};this._saveLastPos({shapeType:this.type,path:B.shapePoints2D,vertices:B.arrowhead})}});var g=k.extend({init:function(p,q){this._parent(p,q)},dispose:function(){this.extremityBegin=null;this.extremityEnd=null;this.shapeStartPoint=null;this.shapeEndPoint=null;this.shapePoints=null;this.arrowHeadEnd=null;this.startArrowHead=null;this.endArrowHead=null;this._parent()},createFromMousePositions:function(z){if(z.onModel){this.onModel=true}this.shapeStartPoint=z.arrowShapePoints3D[0].clone();this.shapeEndPoint=z.arrowShapePoints3D[z.arrowShapePoints3D.length-1].clone();var x=z.arrowShapePoints2D[0].clone();var s=z.arrowShapePoints2D[z.arrowShapePoints2D.length-1].clone();var E=z.newArrowHeadPoints2D[1];var t=x.distanceTo(E);var B=s.distanceTo(E);var D=new m.Vector3;var F=new m.Vector3;this.shapePoints=z.arrowShapePoints3D.slice(0);var r=new m.Vector3;if(t<B&&(z.oldArrowHeadEnd==="end")){D.copy(this.shapeStartPoint);r.subVectors(z.arrowShapePoints3D[2],D).normalize();this.endArrowHead=z.oldArrowHeadPoints3D}else{if(t>B&&(z.oldArrowHeadEnd==="start")){D.copy(this.shapeEndPoint);r.subVectors(z.arrowShapePoints3D[z.arrowShapePoints3D.length-2],D).normalize();this.startArrowHead=z.oldArrowHeadPoints3D}else{console.log("arrowHead wrong side");return}}var q=(this.type==="doubleHeadedArrow")?b.getCurveLength(this.shapePoints)*0.2:b.getCurveLength(this.shapePoints)*0.1;var w=(new m.Vector3).crossVectors(r,z.normal).add(r).normalize().multiplyScalar(q);var v=(new m.Vector3).crossVectors(z.normal,r).add(r).normalize().multiplyScalar(q);var p=new m.Vector3(D.x+w.x,D.y+w.y,D.z+w.z);var G=new m.Vector3(D.x+v.x,D.y+v.y,D.z+v.z);if(this.startArrowHead){this.endArrowHead=[p,G]}else{this.startArrowHead=[p,G]}this.points=this.points.concat(z.annotPoints);if(this.onModel){var C=this._getIntermediatePointsOfLineOnModel(this.model,p,D,10);var A=this._getIntermediatePointsOfLineOnModel(this.model,D,G,10);this.points=this.points.concat(A.points,A.points.slice(0).reverse(),C.points.slice(0).reverse(),C.points)}else{this.points.push(p,D,G,D)}for(var y=0;y<this.points.length;y++){this.normals.push(z.normal)}var u=this.frameWindow.getViewpoint().getEyePosition();this.graphicalProp={thickness:this._getThickness(z.arrowShapePoints2D,this.points,u),color:this.drawSettings.getColor(),opacity:this.drawSettings.getOpacity()};this._saveLastPos({shapeType:this.type,path:z.arrowShapePoints2D,vertices:z.newArrowHeadPoints2D})}});return{line:k.extend({init:function(p){this._parent(p,"line")},createFromJSON:function(u){this.setJSON(u);if(u.onModel){this.drawOnModel(u)}else{var v=this.frameWindow.getViewpoint().getEyePosition();var w=[];var t=[];var q=new m.Vector3(u.annotPlaneNormal.x,u.annotPlaneNormal.y,u.annotPlaneNormal.z);var p=u.geometry.length/u.pointsCount;var s=new m.Vector3(u.geometry.startPoint.x,u.geometry.startPoint.y,u.geometry.startPoint.z);var r=new m.Vector3(u.geometry.endPoint.x,u.geometry.endPoint.y,u.geometry.endPoint.z);w.push(s,r);t.push(q,q);this.points=w;this.normals=t}},get3DGeometry:function(p){return{startPoint:p[0],endPoint:p[p.length-1],length:p[0].distanceTo(p[p.length-1])}}}),circle:k.extend({init:function(p){this._parent(p,"circle")},createFromJSON:function(w){this.setJSON(w);var s=[];var D=[];if(w.onModel){this.drawOnModel(w)}else{var C=new m.Vector3(w.annotPlaneNormal.x,w.annotPlaneNormal.y,w.annotPlaneNormal.z);var q=new m.Vector3(w.annotStartPoint.x,w.annotStartPoint.y,w.annotStartPoint.z);var p=new m.Vector3(w.geometry.center.x,w.geometry.center.y,w.geometry.center.z);var u=w.geometry.radius;var G=((new m.Vector3).subVectors(q,p)).normalize();var E=((new m.Vector3).crossVectors(G,C)).normalize();var F=this.frameWindow.getViewpoint().getEyePosition();var t=(2*Math.PI)/w.pointsCount;for(var r=0;r<2*Math.PI;r+=t){var B=p.x+(u*Math.cos(r)*G.x)+(u*Math.sin(r)*E.x);var A=p.y+(u*Math.cos(r)*G.y)+(u*Math.sin(r)*E.y);var v=p.z+(u*Math.cos(r)*G.z)+(u*Math.sin(r)*E.z);s.push(new m.Vector3(B,A,v));D.push(C)}this.points=s;this.normals=D}},get3DGeometry:function(t){var r=0;var u=new m.Vector3;for(var s=1;s<t.length-1;s++){var q=t[0].distanceTo(t[s]);if(q>r){r=q;u.copy(t[s])}}var p=((new m.Vector3).addVectors(t[0],u)).multiplyScalar(0.5);return{center:p,radius:r/2}}}),ellipse:k.extend({init:function(p){this._parent(p,"ellipse")},createFromJSON:function(v){this.setJSON(v);if(v.onModel){this.drawOnModel(v)}else{var E=[];var D=[];var B=new m.Vector3(v.annotPlaneNormal.x,v.annotPlaneNormal.y,v.annotPlaneNormal.z);var r=new m.Vector3(v.annotStartPoint.x,v.annotStartPoint.y,v.annotStartPoint.z);var p=new m.Vector3(v.geometry.center.x,v.geometry.center.y,v.geometry.center.z);var H=new m.Vector3(v.geometry.majorAxis.dir.x,v.geometry.majorAxis.dir.y,v.geometry.majorAxis.dir.z);var F=new m.Vector3(v.geometry.minorAxis.dir.x,v.geometry.minorAxis.dir.y,v.geometry.minorAxis.dir.z);var G=this.frameWindow.getViewpoint().getEyePosition();var A=v.geometry.majorAxis.length;var q=v.geometry.minorAxis.length;var t=(2*Math.PI)/v.pointsCount;for(var s=0;s<2*Math.PI;s+=t){var C=p.x+(A*Math.cos(s)*H.x)+(q*Math.sin(s)*F.x);var w=p.y+(A*Math.cos(s)*H.y)+(q*Math.sin(s)*F.y);var u=p.z+(A*Math.cos(s)*H.z)+(q*Math.sin(s)*F.z);E.push(new m.Vector3(C,w,u));D.push(B)}this.points=E;this.normals=D}},get3DGeometry:function(B){var u=[];var w=[];for(var v=0;v<B.length-1;v++){var E=0;var A;for(var t=1;t<B.length;t++){var C=B[v].distanceTo(B[t]);if(C>E){E=C;A=B[t]}}u.push(E);w.push(A)}var D=u.indexOf(Math.max.apply(null,u));var r=B[D];var F=w[D];var q=((new m.Vector3).addVectors(r,F)).multiplyScalar(0.5);var p=(new m.Vector3).subVectors(F,r);var z=(new m.Vector3).crossVectors(p,((new m.Plane()).setFromCoplanarPoints(B[0],B[1],B[2])).normal);var x=Infinity;for(var s=0;s<B.length;s++){var y=B[s].distanceTo(q);if(y<x){x=y}}return{center:q,majorAxis:{length:p.length()/2,dir:p.normalize()},minorAxis:{length:x,dir:z.normalize()}}}}),rectangle:k.extend({init:function(p){this._parent(p,"rectangle");this.frameWindow=p.frameWindow},createFromJSON:function(t){this.setJSON(t);if(t.onModel){this.drawOnModel(t)}else{var p=[];var s=[];var u=this.frameWindow.getViewpoint().getEyePosition();var r={A:new m.Vector3(t.geometry.vertices[0].x,t.geometry.vertices[0].y,t.geometry.vertices[0].z),B:new m.Vector3(t.geometry.vertices[1].x,t.geometry.vertices[1].y,t.geometry.vertices[1].z),C:new m.Vector3(t.geometry.vertices[2].x,t.geometry.vertices[2].y,t.geometry.vertices[2].z),D:new m.Vector3(t.geometry.vertices[3].x,t.geometry.vertices[3].y,t.geometry.vertices[3].z),};var q=new m.Vector3(t.annotPlaneNormal.x,t.annotPlaneNormal.y,t.annotPlaneNormal.z);p.push(r.A,r.B,r.C,r.D,r.A);s.push(q,q,q,q,q);this.points=p;this.normals=s}},get3DGeometry:function(H){var u=0;var y=new m.Vector3;var F=0;for(var z=0;z<H.length;z++){var I=H[0].distanceTo(H[z]);if(I>u){u=I;y.copy(H[z]);F=z}}var G=H.slice(F);var t=H[0].clone();var r=y.clone();var q=((new m.Vector3).addVectors(t,r)).multiplyScalar(0.5);var x=t.distanceTo(q);var w=(new m.Vector3).subVectors(t,r).normalize();var s=new m.Vector3;var E=0;for(var z=0;z<H.length/2;z++){var v=(new m.Vector3).subVectors(H[z],r);var I=(new m.Vector3).crossVectors(w,v).length();if(I>E){s.copy(H[z]);E=I}}var p=(new m.Vector3).subVectors(q.multiplyScalar(2),s);return{vertices:[t,s,r,p],}}}),triangle:k.extend({init:function(p){this._parent(p,"triangle")},createFromJSON:function(v){this.setJSON(v);if(v.onModel){this.drawOnModel(v)}else{var y=[];var w=[];var z=this.frameWindow.getViewpoint().getEyePosition();var p=new m.Vector3(v.annotPlaneNormal.x,v.annotPlaneNormal.y,v.annotPlaneNormal.z);var t=new m.Vector3(v.geometry.vertexA.x,v.geometry.vertexA.y,v.geometry.vertexA.z);var s=new m.Vector3(v.geometry.vertexB.x,v.geometry.vertexB.y,v.geometry.vertexB.z);var r=new m.Vector3(v.geometry.vertexC.x,v.geometry.vertexC.y,v.geometry.vertexC.z);var u=(new m.Vector3).subVectors(s,t);var q=(new m.Vector3).subVectors(r,s);var x=(new m.Vector3).subVectors(t,r);y.push(t,s,r,t);w.push(p,p,p,p);this.points=y;this.normals=w}},get3DGeometry:function(z){var q=0;var p={};var t=[];for(var u=1;u<z.length;u++){var v=z[0].distanceTo(z[u]);if(v>q){q=v;p={A:z[0],B:z[u]}}}var y=(new m.Vector3).subVectors(p.B,p.A).normalize();var x=(new m.Vector3).addVectors(p.B,p.A).multiplyScalar(0.5);for(var u=1;u<z.length;u++){var r=(new m.Vector3).subVectors(z[u],z[0]).normalize();if(!r.equals(y)){t.push(z[u])}}var w=0;var s=new m.Vector3;for(var u=0;u<t.length;u++){var v=x.distanceTo(t[u]);if(v>w){w=v;s.copy(t[u])}}return{vertexA:p.A,vertexB:p.B,vertexC:s}}}),unknownOpen:k.extend({init:function(p){this._parent(p,"unknownOpen");this.frameWindow=p.frameWindow},createFromJSON:function(v){this.setJSON(v);if(v.onModel){this.drawOnModel(v)}else{var r=[];var u=[];var t=new m.Vector3(v.annotStartPoint.x,v.annotStartPoint.y,v.annotStartPoint.z);var w=this.frameWindow.getViewpoint().getEyePosition();var s=new m.Vector3(v.annotPlaneNormal.x,v.annotPlaneNormal.y,v.annotPlaneNormal.z);for(var q=0;q<v.geometry.points.length;q++){var p=new m.Vector3(v.geometry.points[q].x,v.geometry.points[q].y,v.geometry.points[q].z);r.push(p);u.push(s)}this.points=r;this.normals=u}},get3DGeometry:function(p){return{points:p}}}),text:k.extend({init:function(p){this._parent(p,"text")},dispose:function(){this.text=null;this.width=null;this.height=null;this.scale=null;this.shapePoints=null;this.offsetHeight=null;this._parent()},getJSON:function(){return{id:this.id,type:this.type,onModel:this.onModel,geometry:this.get3DGeometry(),graphicalProp:this.graphicalProp,text:this.text}},get3DGeometry:function(){return{scale:this.scale,width:this.width,height:this.height,vertices:this.points,offsetHeight:this.offsetHeight}},createFromMousePositions:function(W){this.text=W.text;this.width=parseInt(W.w);this.height=parseInt(W.h);this.scale=W.scale;this.offsetHeight=W.offsetHeight;var F=W.x;var D=W.y;if(this.text!==""){var S=-Infinity;var v=false;var B=[new m.Vector2(W.x,W.y),new m.Vector2(W.x+W.w,W.y),new m.Vector2(W.x+W.w,W.y+W.h),new m.Vector2(W.x,W.y+W.h)];var q=this.annotationManager.getCurrentAnnotViewpoint();if(q){var Q=q.annotList;if(Q){var p=b.boundingBoxCompute(b.convexHullCompute(B));var O=n.nearestAnnotToText(p,Q,1.2,this.viewer);if(O&&O.localNearestZ){S=O.localNearestZ;v=true}}}var G=this.frameWindow.getViewpoint();var T=G.getCamera();var H=this.frameWindow.getViewerFrame().getDimensions();var E=H.width;var J=H.height;var R=c._interpolateStraightLineLow([new m.Vector2(F,D),new m.Vector2(F+this.width,D)]);var P=c._interpolateStraightLineLow([new m.Vector2(F+this.width,D),new m.Vector2(F+this.width,D+this.height)]);var L=c._interpolateStraightLineLow([new m.Vector2(F+this.width,D+this.height),new m.Vector2(F,D+this.height)]);var K=c._interpolateStraightLineLow([new m.Vector2(F,D+this.height),new m.Vector2(F,D)]);var t=c._interpolateStraightLineLow([new m.Vector2(F,D),new m.Vector2(F+this.width,D+this.height)]);var r=c._interpolateStraightLineLow([new m.Vector2(F,D+this.height),new m.Vector2(F+this.width,D)]);var U=[].concat(R,P,L,K,t,r);var I=n.pixelToNormalizedCoord(U,E,J);var V=this._getPickPointsAndNormals(I,"mesh",true);var N=false;if(V.onModel.points.length>0){N=true}if(N){for(var M=0;M<V.onModel.points.length;M++){var C=V.onModel.points[M].clone().applyMatrix4(T.matrixWorldInverse).z;if(C>S){S=C}}}else{if(S===-Infinity&&v===false){S=this.model.getBoundingBox().center().clone().applyMatrix4(T.matrixWorldInverse).z}}var A=n.pixelToNormalizedCoord([new m.Vector2(F,D+this.height)],E,J)[0];var w=n.pixelToNormalizedCoord([new m.Vector2(F,D)],E,J)[0];var u=n.pixelToNormalizedCoord([new m.Vector2(F+this.width,D)],E,J)[0];var s=n.pixelToNormalizedCoord([new m.Vector2(F+this.width,D+this.height)],E,J)[0];this.points.push(n.screenToWorldPlaneProjection([A],S,T)[0]);this.points.push(n.screenToWorldPlaneProjection([w],S,T)[0]);this.points.push(n.screenToWorldPlaneProjection([u],S,T)[0]);this.points.push(n.screenToWorldPlaneProjection([s],S,T)[0]);this.graphicalProp={fontSize:W.fontSize,fontWeight:(this.drawSettings.getThickness()-3)*100,color:this.drawSettings.getColor()}}},draw:function(){var r=this.frameWindow.getViewpoint();var u=r.getCamera();var p=new m.Vector3(0,0,-1).applyQuaternion(u.quaternion).normalize();var x=this.graphicalProp.fontWeight;var w=b.wrapText({text:this.text,width:this.width,height:this.height,font:x+" "+(this.graphicalProp.fontSize*this.scale)+'px "3ds"'});var q=document.createElement("canvas");var z=q.getContext("2d");q.width=this.width;q.height=this.height;z.font=x+" "+(this.graphicalProp.fontSize*this.scale)+'px "3ds"';z.fillStyle=this.graphicalProp.color;var A=w.wrappedLines;for(var y=0;y<A.length;y++){z.fillText(A[y],0,((this.offsetHeight-4)*this.scale)+(this.offsetHeight*this.scale*y))}var v=new m.Texture(q);v.needsUpdate=true;if(q.remove){q.remove()}q=undefined;var t=new m.MeshBasicMaterial({color:this.graphicalProp.color,map:v,side:m.DoubleSide,transparent:true});t.force=true;var s=l.createRectangleNode({height:this.points[0].distanceTo(this.points[1]),width:this.points[1].distanceTo(this.points[3]),fill:true,layerNb:1,material:t,});s.setMatrix(new m.Matrix4().lookAt(this.points[0],this.points[0].clone().add(p),u.up.clone()).setPosition(this.points[0]));s.setShadow(false);s.name="Annotation_Representation";s.annotID=this.id;this.repBag=new i("3DPlay_Text_Annotation");this.repBag.add(s)},createFromJSON:function(r){this.id=r.id;this.text=r.text;this.scale=parseFloat(r.geometry.scale);this.width=parseInt(r.geometry.width);this.height=parseInt(r.geometry.height);this.points=[];var p=r.geometry.vertices;for(var q=0;q<p.length;q++){this.points.push(new m.Vector3(p[q].x,p[q].y,p[q].z))}this.offsetHeight=r.geometry.offsetHeight;this.graphicalProp=r.graphicalProp}}),arrow:j.extend({init:function(p){this._parent(p,"arrow");this.frameWindow=p.frameWindow;this.drawSettings=new f();this.annotationManager=p.annotationManager},get3DGeometry:function(p){var q={lineStart:{point:this.shapeStartPoint},lineEnd:{point:this.shapeEndPoint}};q.arrowHeadEnd=this.arrowHeadEnd;if(this.arrowHeadEnd==="start"){q.lineStart.arrowhead=this.arrowHeadPoints}else{q.lineEnd.arrowhead=this.arrowHeadPoints}return q},createFromJSON:function(v){this.setJSON(v);if(this.onModel){this.drawOnModel(v)}else{var t=new m.Vector3;var w=new m.Vector3;var u=[];this.shapeStartPoint=new m.Vector3(v.geometry.lineStart.point.x,v.geometry.lineStart.point.y,v.geometry.lineStart.point.z);this.shapeEndPoint=new m.Vector3(v.geometry.lineEnd.point.x,v.geometry.lineEnd.point.y,v.geometry.lineEnd.point.z);if(v.geometry.lineStart.arrowhead){this.arrowHeadEnd="start";t.set(v.geometry.lineStart.point.x,v.geometry.lineStart.point.y,v.geometry.lineStart.point.z);w.set(v.geometry.lineEnd.point.x,v.geometry.lineEnd.point.y,v.geometry.lineEnd.point.z);u=v.geometry.lineStart.arrowhead}else{t.set(v.geometry.lineEnd.point.x,v.geometry.lineEnd.point.y,v.geometry.lineEnd.point.z);w.set(v.geometry.lineStart.point.x,v.geometry.lineStart.point.y,v.geometry.lineStart.point.z);u=v.geometry.lineEnd.arrowhead}var s=new m.Vector3(u[0].x,u[0].y,u[0].z);var r=new m.Vector3(u[1].x,u[1].y,u[1].z);var y=this.frameWindow.getViewpoint().getEyePosition();var p=new m.Vector3(v.annotPlaneNormal.x,v.annotPlaneNormal.y,v.annotPlaneNormal.z);this.arrowHeadPoints=[s,r];if(this.onModel){var x=this._getIntermediatePointsOfLineOnModel(this.model,s,t,h);var q=this._getIntermediatePointsOfLineOnModel(this.model,t,r,h);this.shapePoints=this._getIntermediatePointsOfLineOnModel(this.model,t,w,v.pointsCount-(4*h));this.points=this.points.concat(x.points.slice(0).reverse(),x.points,q.points,q.points.slice(0).reverse(),this.shapePoints.points);this.normals=this.normals.concat(x.normals.slice(0).reverse(),x.normals,q.normals,q.normals.slice(0).reverse(),this.shapePoints.normals)}else{this.shapePoints=[t,w];this.points.push(s,t,r,t,w);this.normals.push(p,p,p,p,p)}}}}),curvedArrow:j.extend({init:function(p){this._parent(p,"curvedArrow");this.drawSettings=new f()},get3DGeometry:function(p){var q={curveStart:{point:this.shapeStartPoint},curveEnd:{point:this.shapeEndPoint},curvePoints:this.shapePoints};q.arrowHeadEnd=this.arrowHeadEnd;if(this.arrowHeadEnd==="start"){q.curveStart.arrowhead=this.arrowHeadPoints}else{q.curveEnd.arrowhead=this.arrowHeadPoints}return q},createFromJSON:function(F){this.setJSON(F);if(this.onModel){this.drawOnModel(F)}else{var I=new m.Vector3;var K=new m.Vector3;var C=[];var r=false;this.shapeStartPoint=new m.Vector3(F.geometry.curveStart.point.x,F.geometry.curveStart.point.y,F.geometry.curveStart.point.z);this.shapeEndPoint=new m.Vector3(F.geometry.curveEnd.point.x,F.geometry.curveEnd.point.y,F.geometry.curveEnd.point.z);if(F.geometry.curveStart.arrowhead){this.arrowHeadEnd="start";I.set(F.geometry.curveStart.point.x,F.geometry.curveStart.point.y,F.geometry.curveStart.point.z);K.set(F.geometry.curveEnd.point.x,F.geometry.curveEnd.point.y,F.geometry.curveEnd.point.z);C=F.geometry.curveStart.arrowhead}else{I.set(F.geometry.curveEnd.point.x,F.geometry.curveEnd.point.y,F.geometry.curveEnd.point.z);K.set(F.geometry.curveStart.point.x,F.geometry.curveStart.point.y,F.geometry.curveStart.point.z);C=F.geometry.curveEnd.arrowhead;r=true}var p=new m.Vector3(C[0].x,C[0].y,C[0].z);var L=new m.Vector3(C[1].x,C[1].y,C[1].z);this.arrowHeadPoints=[p,L];var D=this.frameWindow.getViewpoint().getEyePosition();var q=new m.Vector3(F.annotPlaneNormal.x,F.annotPlaneNormal.y,F.annotPlaneNormal.z);this.shapePoints=[];if(this.onModel){var H=this._getIntermediatePointsOfLineOnModel(this.model,p,I,h);var G=this._getIntermediatePointsOfLineOnModel(this.model,I,L,h);var t=[];var B=[];for(var E=0;E<F.geometry.curvePoints.length;E++){var A=F.geometry.curvePoints[E].x;var w=F.geometry.curvePoints[E].y;var v=F.geometry.curvePoints[E].z;var s=n.onScreenProjection(new m.Vector3(A,w,v),this.viewer);var J=this.viewer.pick(s,"mesh",true);if(J.path.length>0){t.push(J.position.clone());B.push(J.normal.clone())}}if(r){this.shapePoints=t.reverse()}else{this.shapePoints=t}this.points=this.points.concat(H.points.slice(0).reverse(),H.points,G.points,G.points.slice(0).reverse(),this.shapePoints);this.normals=this.normals.concat(H.normals.slice(0).reverse(),H.normals,G.normals,G.normals.slice(0).reverse(),B)}else{var u=F.geometry.curvePoints;for(var E=0;E<u.length;E++){this.shapePoints.push(new m.Vector3(u[E].x,u[E].y,u[E].z))}this.points.push(I,p,I,L,I);if(r){this.shapePoints=this.shapePoints.reverse()}this.points=this.points.concat(this.shapePoints);for(var E=0;E<this.points.length;E++){this.normals.push(q)}}}}}),doubleHeadedArrow:g.extend({init:function(p){this._parent(p,"doubleHeadedArrow");this.drawSettings=new f()},get3DGeometry:function(){var p={start:{point:this.shapeStartPoint,arrowhead:this.startArrowHead},end:{point:this.shapeEndPoint,arrowhead:this.endArrowHead}};return p},createFromJSON:function(u){this.setJSON(u);if(this.onModel){this.drawOnModel(u)}else{var s=u.geometry.start.arrowhead;var p=u.geometry.end.arrowhead;this.shapeStartPoint=new m.Vector3(u.geometry.start.point.x,u.geometry.start.point.y,u.geometry.start.point.z);this.shapeEndPoint=new m.Vector3(u.geometry.end.point.x,u.geometry.end.point.y,u.geometry.end.point.z);this.startArrowHead=[new m.Vector3(s[0].x,s[0].y,s[0].z),new m.Vector3(s[1].x,s[1].y,s[1].z)];this.endArrowHead=[new m.Vector3(p[0].x,p[0].y,p[0].z),new m.Vector3(p[1].x,p[1].y,p[1].z)];var x=this.frameWindow.getViewpoint().getEyePosition();var q=new m.Vector3(u.annotPlaneNormal.x,u.annotPlaneNormal.y,u.annotPlaneNormal.z);if(this.onModel){var w=this._getIntermediatePointsOfLineOnModel(this.model,this.startArrowHead[0],this.shapeStartPoint,h);var t=this._getIntermediatePointsOfLineOnModel(this.model,this.startArrowHead[1],this.shapeStartPoint,h);var v=this._getIntermediatePointsOfLineOnModel(this.model,this.endArrowHead[0],this.shapeEndPoint,h);var r=this._getIntermediatePointsOfLineOnModel(this.model,this.endArrowHead[1],this.shapeEndPoint,h);this.shapePoints=this._getIntermediatePointsOfLineOnModel(this.model,this.shapeStartPoint,this.shapeEndPoint);this.points=this.points.concat(w.points.slice(0).reverse(),w.points,t.points.slice(0).reverse(),t.points,this.shapePoints.points,v.points.slice(0).reverse(),v.points,r.points.slice(0).reverse(),r.points);this.normals=this.normals.concat(w.normals.slice(0).reverse(),w.normals,t.normals.slice(0).reverse(),t.normals,this.shapePoints.normals,v.normals.slice(0).reverse(),v.normals,r.normals.slice(0).reverse(),r.normals)}else{this.shapePoints=[this.shapeStartPoint,this.shapeEndPoint];this.points.push(this.shapeStartPoint,this.startArrowHead[0],this.shapeStartPoint,this.startArrowHead[1],this.shapeStartPoint,this.shapeEndPoint,this.endArrowHead[0],this.shapeEndPoint,this.endArrowHead[1],this.shapeEndPoint);this.normals.push(q,q,q,q,q,q,q,q,q,q)}}}}),curvedDoubleHeadedArrow:g.extend({init:function(p){this._parent(p,"curvedDoubleHeadedArrow");this.drawSettings=new f()},get3DGeometry:function(){var p={start:{point:this.shapeStartPoint,arrowhead:this.startArrowHead},end:{point:this.shapeEndPoint,arrowhead:this.endArrowHead},curvePoints:this.shapePoints};return p},createFromJSON:function(H){this.setJSON(H);if(this.onModel){this.drawOnModel(H)}else{var D=H.geometry.start.arrowhead;var E=H.geometry.end.arrowhead;this.shapeStartPoint=new m.Vector3(H.geometry.start.point.x,H.geometry.start.point.y,H.geometry.start.point.z);this.shapeEndPoint=new m.Vector3(H.geometry.end.point.x,H.geometry.end.point.y,H.geometry.end.point.z);this.startArrowHead=[new m.Vector3(D[0].x,D[0].y,D[0].z),new m.Vector3(D[1].x,D[1].y,D[1].z)];this.endArrowHead=[new m.Vector3(E[0].x,E[0].y,E[0].z),new m.Vector3(E[1].x,E[1].y,E[1].z)];var F=this.frameWindow.getViewpoint().getEyePosition();var r=new m.Vector3(H.annotPlaneNormal.x,H.annotPlaneNormal.y,H.annotPlaneNormal.z);this.shapePoints=[];if(this.onModel){var q=this._getIntermediatePointsOfLineOnModel(this.model,this.startArrowHead[0],this.shapeStartPoint,h);var B=this._getIntermediatePointsOfLineOnModel(this.model,this.startArrowHead[1],this.shapeStartPoint,h);var p=this._getIntermediatePointsOfLineOnModel(this.model,this.endArrowHead[0],this.shapeEndPoint,h);var J=this._getIntermediatePointsOfLineOnModel(this.model,this.endArrowHead[1],this.shapeEndPoint,h);var t=[];var C=[];for(var G=0;G<H.geometry.curvePoints.length;G++){var A=H.geometry.curvePoints[G].x;var w=H.geometry.curvePoints[G].y;var v=H.geometry.curvePoints[G].z;var s=n.onScreenProjection(new m.Vector3(A,w,v),this.viewer);var I=this.viewer.pick(s,"mesh",true);if(I.path.length>0){t.push(I.position.clone());C.push(I.normal.clone())}}this.shapePoints=t;this.points=this.points.concat(q.points.slice(0).reverse(),q.points,B.points.slice(0).reverse(),B.points,this.shapePoints,p.points.slice(0).reverse(),p.points,J.points.slice(0).reverse(),J.points);this.normals=this.normals.concat(q.normals.slice(0).reverse(),q.normals,B.normals.slice(0).reverse(),B.normals,this.shapePoints,p.normals.slice(0).reverse(),p.normals,J.normals.slice(0).reverse(),J.normals)}else{var u=H.geometry.curvePoints;for(var G=0;G<u.length;G++){this.shapePoints.push(new m.Vector3(u[G].x,u[G].y,u[G].z))}this.points.push(this.shapeStartPoint,this.startArrowHead[0],this.shapeStartPoint,this.startArrowHead[1],this.shapeStartPoint);this.normals.push(r,r,r,r,r);this.points=this.points.concat(this.shapePoints);for(var G=0;G<this.points.length;G++){this.normals.push(r)}this.points.push(this.endArrowHead[0],this.shapeEndPoint,this.endArrowHead[1],this.shapeEndPoint);this.normals.push(r,r,r,r)}}}})}});define("DS/3DPlayAnnotation3D/AnnotationExplodeManager",["UWA/Core","UWA/Class","DS/CoreEvents/Events","DS/WebSystem/Settings","DS/3DPlayAnnotation3D/AnnotationShapes","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CATCreaDesWebUIServices/CATCrDWebUIServices","DS/Mesh/MeshUtils","DS/3DPlayAnnotation3D/AnnotationUtils"],function(f,q,o,s,i,t,n,c,h,d){var b=null;var k=null;var a=null;var g=null;var j=function(){var u=b.getViewpoint();return{eyePosition:u.getEyePosition(),upDirection:u.getUpDirection(),sightDirection:u.getSightDirection(),targetDistance:u.getTargetDistance()}};var r=function(u,y,w){var x=y||Date.now();var v=u||j();return{id:x,eyePosition:(v.eyePosition instanceof t.Vector3)?v.eyePosition:new t.Vector3(v.eyePosition.x,v.eyePosition.y,v.eyePosition.z),upDirection:(v.upDirection instanceof t.Vector3)?v.upDirection:new t.Vector3(v.upDirection.x,v.upDirection.y,v.upDirection.z),sightDirection:(v.sightDirection instanceof t.Vector3)?v.sightDirection:new t.Vector3(v.sightDirection.x,v.sightDirection.y,v.sightDirection.z),targetDistance:v.targetDistance,annotList:v.annotList||[]}};var p=function(w){var B=a.experienceBase.getManager("VCXLevelExploderManager");var F=B.getExplodeLevelState();var I=j();for(var C=0;C<w.length;C++){var K=w[C];var v=0;if(K.isSameAs(F,B)){v=1}var H=K.getAllAnnotationViewpoints();for(var A=0;A<H.length;A++){var E=0;var z=H[A];if(v===0){E=0}else{if(d._areAlmostSameViewpoints(I,z)){E=1}else{var y=I.eyePosition.distanceTo(z.eyePosition);var D=(z.targetDistance*(2/3));if(y<=D){E=(Math.abs(D-y)/D)}}}z.opacity=E;for(var x=0;x<z.annotList.length;x++){var J=z.annotList[x];if(E>0){if(J.type==="text"){J.repBag.children[0].mesh3js.material.setValues({opacity:E})}else{var u=J.repBag.children[0].mesh3js.material.getPDSFXUniform("Color");var G=c.createMaterial(u.value,E,1);G.force=true;J.repBag.children[0].setMaterial(G)}J.repBag.children[0].setPickable(h.PICKABLE);J.repBag.children[0].setVisibility(true)}else{J.repBag.children[0].setPickable(h.NOPICKABLE);J.repBag.children[0].setVisibility(false);J.repBag.children[0].setNoZ(true)}}}}k.render()};var m=function(u,w){var v=u;if(w){v.duration=w}b.getViewpoint().moveTo(v);k.render()};var l=function(B,z){var w=[];var v=z.basicInfos.level;var u=z.basicInfos.cursorPosition;var A=z.basicInfos.nodeRoot;var y=z;var x=B;this.isSameAs=function(E,C){var D=C.bothStatesShareCurrentSubExplode(E,y);return D};this.getId=function(){return x};this.getAllAnnotationViewpoints=function(){return w};this.addViewpoint=function(C){w.push(C)};this.removeViewpoint=function(C){if(C>=0&&C<w.length){w.splice(C,1)}else{console.log("Invalid viewpoint index.")}};this.getAnnotationViewpoint=function(C){if(C>=0&&C<w.length){return w[C]}else{console.log("Invalid viewpoint index.");return null}};this.getExplodeRootPath=function(){return _explodeRootPath};this.getExplodeLevel=function(){return v};this.getExplodeStateInfo=function(){return y};this.setExplodeStateInfo=function(C){y=C};this.dispose=function(){w=undefined;v=undefined;u=undefined;A=undefined;y=undefined;x=undefined}};var e=q.extend({init:function(u){var w=this;b=u.frameWindow;k=b.getViewer();a=b.experience;if(a){this._rootNode=a.getRootBag()}else{this._rootNode=k.getRootNode()}g=this._rootNode;this._model=this._rootNode.children[0];this._explodeStateList=[];this._explodeStateManager=a.experienceBase.getManager("VCXLevelExploderManager");this._explodeStateChangeToken=this._explodeStateManager.subscribeToStateChanges(function(){p(w._explodeStateList)});this._annotGroupNode=new n("annotGroupNode");this._rootNode.add(this._annotGroupNode);this.viewpointChangedToken=o.subscribe({event:"/VISU/"},function(x){if(x.eventType=="@onViewpointEndMove"||x.eventType=="@onViewpointChange"){p(w._explodeStateList)}});var v=function(x){w.drawAnnotationsFromJSON(x)};if(a&&a.registerCollabAction){a.registerCollabAction("annot3DDraw",v.bind(w));a.registerCollabAction("annot3DDelete",w.deleteAnnotationWithID.bind(w))}},getVisibleAnnotationGroups:function(){var w=[];for(var v=0;v<this._explodeStateList.length;v++){var x=this._explodeStateList[v].getAllAnnotationViewpoints();for(var u=0;u<x.length;u++){if(x[u].opacity>0.1){w.push(x[u])}}}return w},getAnnotationBag:function(){return this._annotGroupNode},getModel:function(){return this._model},deleteAllAnnotations:function(){for(var w=0;w<this._explodeStateList.length;w++){var y=this._explodeStateList[w].getAllAnnotationViewpoints();for(var v=0;v<y.length;v++){var x=y[v].annotList;for(var u=0;u<x.length;u++){x[u].dispose()}}}this._explodeStateList=[]},dispose:function(){o.unsubscribe(this.viewpointChangedToken);this.deleteAllAnnotations();this._rootNode.remove(this._annotGroupNode);this._annotGroupNode=undefined;this._model=undefined;this._rootNode=undefined;this.viewpointChangedToken=null;if(this._explodeStateChangeToken){this._explodeStateManager.unsubscribeFromStateChanges(this._explodeStateChangeToken);this._explodeStateChangeToken=undefined}b=null;k=null},updateViewPoint:function(E){var v=this._explodeStateList.length;var B=-1;if(v>0){var z=this._explodeStateManager.getExplodeLevelState();for(var x=0;x<this._explodeStateList.length;x++){if(this._explodeStateList[x].isSameAs(z,this._explodeStateManager)){B=x;break}}if(B===-1){B=0}var A=this._explodeStateList[B];var C=A.getAllAnnotationViewpoints();var D=j();var y=-1;for(var w=0;w<C.length;w++){var u=C[w];if(d._areAlmostSameViewpoints(u,D)){y=w;break}}if(E.direction=="right"){if(y<C.length-1){y++}else{y=0;if(B<this._explodeStateList.length-1){B++}else{B=0}}}else{if(E.direction=="left"){if(y>0){y--}else{y=0;if(B>0){B--}else{B=0}}}}this._explodeStateManager.setExplodeLevelState(this._explodeStateList[B].getExplodeStateInfo());m(this._explodeStateList[B].getAnnotationViewpoint(y),400)}},deleteAnnotationWithID:function(A){var u=false;for(var y=0;y<this._explodeStateList.length;y++){var B=this._explodeStateList[y].getAllAnnotationViewpoints();for(var x=0;x<B.length;x++){var w=B[x];for(var v=0;v<w.annotList.length;v++){var z=w.annotList[v];if(z.id==A){this._annotGroupNode.remove(z.repBag);w.annotList.splice(v,1);u=true;z.dispose();break}}if(w.annotList.length==0){B.splice(x,1);this._explodeStateList[y].removeViewpoint(x)}if(u){break}}if(B.length===0){this._explodeStateList.splice(y,1)}if(u){return}}},addToAnnotGroupNode:function(x){var A=false;var z=null;var u=this._explodeStateManager.getExplodeLevelState();for(var v=0;v<this._explodeStateList.length;v++){if(this._explodeStateList[v].isSameAs(u,this._explodeStateManager)){z=this._explodeStateList[v];break}}if(!z){z=new l(Date.now(),u);this._explodeStateList.push(z)}var B=z.getAllAnnotationViewpoints();var y=j();for(var v=0;v<B.length;v++){if(d._areAlmostSameViewpoints(B[v],y)){this._annotGroupNode.addChild(x.repBag);B[v].annotList.push(x);A=true;break}}if(!A){var w=r();w.annotList.push(x);z.addViewpoint(w);this._annotGroupNode.addChild(x.repBag)}if(this._explodeStateList.length===1&&B[v].annotList&&B[v].annotList.length===1){o.publish({event:"3DPLAY/ANNONATIONTOUR/ENABLE",data:{}})}p(this._explodeStateList)},getCurrentAnnotViewpoint:function(){var y=j();var z=null;var v=false;var u=this._explodeStateManager.getExplodeLevelState();for(var x=0;x<this._explodeStateList.length;x++){if(this._explodeStateList[x].isSameAs(u,this._explodeStateManager)){v=true;u=this._explodeStateList[x];break}}if(v){var A=u.getAllAnnotationViewpoints();for(var w=0;w<A.length;w++){if(d._areAlmostSameViewpoints(A[w],y)){z=A[x];break}}}else{u=new l(Date.now(),u);this._explodeStateList.push(u)}if(!z){z=r();u.addViewpoint(z)}return z},saveAnnotationsToJSON:function(u){var C={};var E=[];for(var y=0;y<this._explodeStateList.length;y++){var D=this._explodeStateList[y];var z=D.getAllAnnotationViewpoints();var v=[];for(var x=0;x<z.length;x++){var B=[];z[x].annotList.forEach(function(F){if(!u||u===F.id){B.push(F.getJSON())}});if(B.length>0){v.push({id:z[x].id,annotList:B,viewpointInfo:{eyePosition:z[x].eyePosition.clone(),upDirection:z[x].upDirection.clone(),sightDirection:z[x].sightDirection.clone(),targetDistance:z[x].targetDistance}})}}var w={id:D.getId(),explode_level:D.getExplodeLevel(),annotation_viewpoints:v};E.push(w)}C.Annotations=E;var A=JSON.stringify(C);if("3DPlay.PersistedAnnotationsEnabled"){s.set("3DPlayAnnot",A)}return A},drawAnnotationsFromJSON:function(w){var E=JSON.parse(w);var x=E.Annotations;for(var D=0;D<x.length;D++){var F=x[D].annotation_viewpoints;for(var y=0;y<F.length;y++){var C=F[y];var v=C.id;var A=C.viewpointInfo;var G=C.annotList;var I={frameWindow:b,annotationManager:this};var u;for(var z=0;z<F.length;z++){if(F[z].id===v){u=F[z];break}}if(u===undefined){u=r(A,v,G);F.push(u)}m(u);u=undefined;var H=null;for(var B=0;B<G.length;B++){switch(G[B].type){case"circle":H=new i.circle(I);break;case"ellipse":H=new i.ellipse(I);break;case"line":H=new i.line(I);break;case"rectangle":H=new i.rectangle(I);break;case"square":H=new i.rectangle(I);break;case"triangle":H=new i.triangle(I);break;case"unknownOpen":H=new i.unknownOpen(I);break;case"text":H=new i.text(I);break;case"arrow":H=new i.arrow(I);break;case"curvedArrow":H=new i.curvedArrow(I);break;case"doubleHeadedArrow":H=new i.doubleHeadedArrow(I);break;case"curvedDoubleHeadedArrow":H=new i.curvedDoubleHeadedArrow(I);break;default:H=new i.unknownOpen(I);break}H.createFromJSON(G[B]);H.draw();this.addToAnnotGroupNode(H)}}}}});return e});define("DS/3DPlayAnnotation3D/AnnotationManager",["UWA/Class","DS/CoreEvents/Events","DS/3DPlayAnnotation3D/AnnotationShapes","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/3DPlayAnnotation3D/AnnotationUtils","DS/3DPlayAnnotationUtils/AnnotationAbbreviations"],function(a,e,m,n,j,i,p,b){var d=null;var q=null;var o=null;var f="#A9A9A9";var l=function(){var r=d.getViewpoint();if(r){return{eyePosition:r.getEyePosition(),upDirection:r.getUpDirection(),sightDirection:r.getSightDirection(),targetDistance:r.getTargetDistance()}}};var k=function(r,v,t){var u=v||Date.now();var s=r||l();return{id:u,eyePosition:(s.eyePosition instanceof n.Vector3)?s.eyePosition:new n.Vector3(s.eyePosition.x,s.eyePosition.y,s.eyePosition.z),upDirection:(s.upDirection instanceof n.Vector3)?s.upDirection:new n.Vector3(s.upDirection.x,s.upDirection.y,s.upDirection.z),sightDirection:(s.sightDirection instanceof n.Vector3)?s.sightDirection:new n.Vector3(s.sightDirection.x,s.sightDirection.y,s.sightDirection.z),targetDistance:s.targetDistance,annotList:s.annotList||[]}};var c=function(t){var r=d.getViewpoint();var s=l();t.forEach(function(w){var y=1;var v=w.opacity||y;if(p._areAlmostSameViewpoints(s,w)){v=1}else{var u=s.eyePosition.distanceTo(w.eyePosition);var x=(w.targetDistance*(2/3));if(u>x){v=0.1}else{v=(Math.abs(x-u)/x)}}w.opacity=v;w.annotList.forEach(function(z){if(!z.onModel){if(v>0.1){if(z.type==="text"){z.repBag.children[0].mesh3js.material.setValues({opacity:v})}else{z.repBag.children[0].mesh3js.material.updatePDSFXUniform("Opacity",v)}z.repBag.children[0].setPickable(i.PICKABLE);z.repBag.children[0].setVisibility(true)}else{z.repBag.children[0].setPickable(i.NOPICKABLE);z.repBag.children[0].setVisibility(false);z.repBag.children[0].setNoZ(true)}}})});q.render()};var h=function(r,t){var s=r;if(t){s.duration=t}d.getViewpoint().moveTo(s);q.render()};var g=a.extend({init:function(r){var t=this;d=r.frameWindow;q=d.getViewer();o=d.experience;if(o){this._rootNode=o.getRootBag()}else{this._rootNode=q.getRootNode()}this.AnnotationAbbreviations=new b();this._annotViewpointList=[];this.viewpointChangedToken=e.subscribe({event:"/VISU/"},function(u){if(u.eventType=="@onViewpointEndMove"||u.eventType=="@onViewpointChange"){c(t._annotViewpointList)}});var s=function(u){t.drawAnnotationsFromJSON(u)};if(o&&o.registerCollabAction){o.registerCollabAction("annot3DDraw",s.bind(t));o.registerCollabAction("annot3DDelete",t.deleteAnnotationWithID.bind(t))}},getVisibleAnnotationGroups:function(){var s=[];for(var r=0;r<this._annotViewpointList.length;r++){if(this._annotViewpointList[r].opacity>0.1){s.push(this._annotViewpointList[r])}}return s},getAnnotationBag:function(){if(this._annotGroupNode==undefined||this._annotGroupNode==null){this._annotGroupNode=new j("annotGroupNode");if(this._rootNode&&this._rootNode.add){this._rootNode.add(this._annotGroupNode)}}return this._annotGroupNode},getModel:function(){if(this._rootNode&&this._rootNode.children){return this._rootNode.children[0]}},deleteAllAnnotations:function(){for(var s=0;s<this._annotViewpointList.length;s++){var u=this._annotViewpointList[s].annotList;for(var r=0;r<u.length;r++){var t=this.getAnnotationBag();if(t){t.remove(u[r].repBag)}u[r].dispose()}}this._annotViewpointList=[]},dispose:function(){e.unsubscribe(this.viewpointChangedToken);this.deleteAllAnnotations();if(this._annotGroupNode&&this._rootNode&&this._rootNode.remove){this._rootNode.remove(this._annotGroupNode)}this._annotGroupNode=undefined;this._rootNode=undefined;this.viewpointChangedToken=null;d=null;q=null},addAnnotViewpointToList:function(s){var t=0;for(var u=0;u<this._annotViewpointList.length;u++){if(p._areAlmostSameViewpoints(this._annotViewpointList[u],s)){t=this._annotViewpointList[u].id;break}}if(0===t){var r=k(s);t=r.id;this._annotViewpointList.push(r)}return t},updateViewPoint:function(u){var t=-1;var w=this._annotViewpointList.length;if(w>0){var r=d.getViewpoint();var x=l();for(var v=0;v<w;++v){var s=this._annotViewpointList[v];if(p._areAlmostSameViewpoints(s,x)){if(u.direction=="right"){t=v+1;if(t==w){t=0}break}else{if(u.direction=="left"){t=v-1;if(t<0){t=w-1}break}}}}if(t===-1){if(u.direction=="right"){t=0}else{if(u.direction=="left"){t=w-1}}}h(this._annotViewpointList[t],400)}},setLowlightAnnotationID:function(w){var r=false;for(var u=0;u<this._annotViewpointList.length;u++){var s=this._annotViewpointList[u];for(var t=0;t<s.annotList.length;t++){var v=s.annotList[t];if(v.id==w){if(v.type==="text"){v.repBag.children[0].mesh3js.material.setValues({color:f})}else{v.repBag.children[0].mesh3js.material.updatePDSFXUniform("Color",new n.Color(f))}return}}}},deleteAnnotationWithID:function(w){var r=false;for(var u=0;u<this._annotViewpointList.length;u++){var s=this._annotViewpointList[u];for(var t=0;t<s.annotList.length;t++){var v=s.annotList[t];if(v.id==w){this.getAnnotationBag().remove(v.repBag);s.annotList.splice(t,1);r=true;v.dispose();break}}if(s.annotList.length==0){this._annotViewpointList.splice(u,1)}if(this._annotViewpointList.length===0){e.publish({event:"3DPLAY/ANNONATIONTOUR/DISABLE",data:{}})}if(r){return}}},addToAnnotGroupNode:function(t){var u=false;for(var r=0;r<this._annotViewpointList.length;r++){if(t.viewpointId===this._annotViewpointList[r].id){this.getAnnotationBag().addChild(t.repBag);this._annotViewpointList[r].annotList.push(t);u=true;break}}if(!u){var s=this.getCurrentAnnotViewpoint();s.annotList.push(t);this.getAnnotationBag().addChild(t.repBag)}if(this._annotViewpointList.length===1&&this._annotViewpointList[0].annotList&&this._annotViewpointList[0].annotList.length===1){e.publish({event:"3DPLAY/ANNONATIONTOUR/ENABLE",data:{}})}c(this._annotViewpointList)},getCurrentAnnotViewpoint:function(){var s=l();var t=null;for(var r=0;r<this._annotViewpointList.length;r++){if(p._areAlmostSameViewpoints(this._annotViewpointList[r],s)){t=this._annotViewpointList[r];break}}if(!t){t=k();this.addAnnotViewpointToList(t)}return t},saveAnnotationsToJSON:function(x){var w={ver:"1.0",explodeStates:[{id:0,viewpoints:[]}]};var u=w.explodeStates[0].viewpoints;for(var t=0;t<this._annotViewpointList.length;t++){var r=[];this._annotViewpointList[t].annotList.forEach(function(y){if(!x||x===y.id){r.push(y.getJSON())}});if(r.length>0){u.push({id:this._annotViewpointList[t].id,annotList:r,viewpointInfo:{eyePosition:this._annotViewpointList[t].eyePosition.clone(),upDirection:this._annotViewpointList[t].upDirection.clone(),sightDirection:this._annotViewpointList[t].sightDirection.clone(),targetDistance:this._annotViewpointList[t].targetDistance}})}}var v=this.AnnotationAbbreviations.processJSON(w,"minify");var s=JSON.stringify(v);return s},drawAnnotationsFromJSON:function(s,r){if(r){this.deleteAllAnnotations()}var E=JSON.parse(s);if(E.ver){var y=this.AnnotationAbbreviations.processJSON(E,"expand");var t=y.explodeStates;for(var G=0;G<t.length;G++){if(t[G].id===0){var v=t[G].viewpoints;for(var D=0;D<v.length;D++){var x=v[D];var I=x.id;var w=x.viewpointInfo;var C=x.annotList;var u={frameWindow:d,annotationManager:this,viewpointId:I};var H;for(var A=0;A<this._annotViewpointList.length;A++){if(this._annotViewpointList[A].id===I){H=this._annotViewpointList[A];break}}if(H===undefined){H=k(w,I,C);this._annotViewpointList.push(H)}h(H);H=undefined;var F=null;for(var B=0;B<C.length;B++){switch(C[B].type){case"circle":F=new m.circle(u);break;case"ellipse":F=new m.ellipse(u);break;case"line":F=new m.line(u);break;case"rectangle":F=new m.rectangle(u);break;case"square":F=new m.rectangle(u);break;case"triangle":F=new m.triangle(u);break;case"unknownOpen":F=new m.unknownOpen(u);break;case"text":F=new m.text(u);break;case"arrow":F=new m.arrow(u);break;case"curvedArrow":F=new m.curvedArrow(u);break;case"doubleHeadedArrow":F=new m.doubleHeadedArrow(u);break;case"curvedDoubleHeadedArrow":F=new m.curvedDoubleHeadedArrow(u);break;default:F=new m.unknownOpen(u);break}F.createFromJSON(C[B]);F.draw();this.addToAnnotGroupNode(F)}}}}}else{if(E.Annotations){var z=s.replace(/arrowHead/g,"arrowhead");E=JSON.parse(z);var v=E.Annotations;for(var D=0;D<v.length;D++){var x=v[D];var I=x.id;var w=x.viewpointInfo;var C=x.annotList;var u={frameWindow:d,annotationManager:this,viewpointId:I};var H;for(var A=0;A<this._annotViewpointList.length;A++){if(this._annotViewpointList[A].id===I){H=this._annotViewpointList[A];break}}if(H===undefined){H=k(w,I,C);this._annotViewpointList.push(H)}h(H);H=undefined;var F=null;for(var B=0;B<C.length;B++){switch(C[B].type){case"circle":F=new m.circle(u);break;case"ellipse":F=new m.ellipse(u);break;case"line":F=new m.line(u);break;case"rectangle":F=new m.rectangle(u);break;case"square":F=new m.rectangle(u);break;case"triangle":F=new m.triangle(u);break;case"unknownOpen":F=new m.unknownOpen(u);break;case"text":F=new m.text(u);break;case"arrow":F=new m.arrow(u);break;case"curvedArrow":F=new m.curvedArrow(u);break;case"doubleHeadedArrow":F=new m.doubleHeadedArrow(u);break;case"curvedDoubleHeadedArrow":F=new m.curvedDoubleHeadedArrow(u);break;default:F=new m.unknownOpen(u);break}F.createFromJSON(C[B]);F.draw();this.addToAnnotGroupNode(F)}}}else{console.log("3DPlay: Invalid annotation JSON!")}}}});return g});define("DS/3DPlayAnnotation3D/Annotation3DText",["DS/3DPlayAnnotation3D/Annotation3DCommand","DS/3DPlayAnnotationUtils/AnnotationTextControl","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/3DPlayAnnotation3D/AnnotationShapes","DS/3DPlayAnnotationUtils/AnnotationTextPreview","DS/WebSystem/Environment","DS/Core/PointerEvents"],function(e,h,d,f,a,c,b){var g;return(e.extend({init:function(i){this._parent(i);g=this;this._exp=this.frameWindow.experience;this.drawSettings=new d();if(this._exp&&this._exp.registerCollabAction){this._exp.registerCollabAction("annotTextEnd",this.end.bind(this));this._exp.registerCollabAction("annotTextOnTap",this._onTap.bind(this))}},begin:function(i){this._parent(i);this.setViewer({control:false,highlight:false,pickable:true});this._createPreview();this.viewerFrame=this.frameWindow.getViewerFrame();this._createTextControl();this.textControl.disable();this.textControl.hideControls();this.tapEvent=function(j){g._onTap(j)};this.viewerFrame.addEvent(b.POINTERDOWN,this.tapEvent);this.viewerFrame.addEvent("resize",this._onWidgetResize)},end:function(i){this.viewerFrame.removeEvent("resize",this._onWidgetResize);this._exp&&this._exp.registerCollabAction("annotTextEnd");this._refresh=undefined;this.viewerFrame.removeEvent(b.POINTERDOWN,this.tapEvent);this._destroyPreview();this._destroyTextControl();this.unsetViewer();this._parent(i)},destroy:function(){this.drawSettings=undefined;g=null;this._parent()},_onWidgetResize:function(){setTimeout(function(){var j=g.textControl.getFieldText();var i=g.textPreview.isEnabled();g._destroyPreview();g._destroyTextControl();g._createPreview();g._createTextControl();g.viewerFrame=g.frameWindow.getViewerFrame();var k=g.viewerFrame.getDimensions();g.textControl.setBoundingLimits(k.width,k.height,1,0);g.textControl.setBoundingLimits(k.width,k.height,1,0);if(i){g.textControl.disable();g.textControl.hideControls()}else{if(j){g.textControl.setFieldText(j)}g.textPreview.hidePreview();g.textPreview.disable();g.textControl.enable();g.textControl.setFocus();g.textControl.showControls()}},100)},_onTap:function(n){if(n.originalEvent&&n.originalEvent.type&&(n.originalEvent.type.contains("touch")||n.originalEvent.type.contains("pointer"))){var m;var i=g.viewerFrame.getBoundingClientRect();if(g._exp&&g._exp.collabMode===false){var l=n.originFrame;var k=n.x;var j=n.y;var p=i.height/l.height;m={x:(k-l.left)*p,y:(j-l.top)*p}}else{m={x:(n.clientX?n.clientX:n.x)-i.left,y:(n.clientY?n.clientY:n.y)-i.top}}if(!g.textPreview.isEnabled()){var o=g.textControl.getFieldText();if(o){g.textControl.validate()}}g.textPreview.hidePreview();g.textPreview.disable();g.textControl.setFocus();g.textControl.enable();if(g._exp&&g._exp.collabMode===false){g.textControl.elements.textField.setAttributes({readonly:"readonly"});g.textPreview.container.setAttributes({visibility:"hidden"})}g.textControl.setFocus();g.textControl.showControls(m.x,m.y);if(g._exp&&g._exp.collabMode===true&&this._exp.notifyAction){this._exp.notifyAction("annotTextOnTap",[{which:n.which,x:n.x,y:n.y,originFrame:i}])}}else{if((n.which===1)){var m;var i=g.viewerFrame.getBoundingClientRect();if(g._exp&&g._exp.collabMode===false){var l=n.originFrame;var k=n.x;var j=n.y;var p=i.height/l.height;m={x:(k-l.left)*p,y:(j-l.top)*p}}else{m={x:(n.clientX?n.clientX:n.x)-i.left,y:(n.clientY?n.clientY:n.y)-i.top}}if(g.textPreview.isEnabled()){g.textPreview.hidePreview();g.textPreview.disable();g.textControl.enable();if(g._exp&&g._exp.collabMode===false){g.textControl.elements.textField.setAttributes({readonly:"readonly"});g.textPreview.container.setAttributes({visibility:"hidden"})}g.textControl.setFocus();g.textControl.showControls(m.x,m.y)}else{var o=g.textControl.getFieldText();if(o){g.textControl.validate();g.textControl.hideControls();g.textPreview.enable();if(g._exp&&g._exp.collabMode!==undefined&&g._exp.collabMode!==false){g.textPreview.showPreview(m)}else{g.textPreview.showPreview(m);g.textControl.hideControls()}}else{if(g._exp&&g._exp.collabMode!==undefined&&g._exp.collabMode!==false){g.textControl.showControls(m.x,m.y)}else{g.textControl.showControls(m.x,m.y);g.textPreview.hidePreview()}}}if(g._exp&&g._exp.collabMode===true&&this._exp.notifyAction){this._exp.notifyAction("annotTextOnTap",[{which:n.which,x:n.x,y:n.y,originFrame:i}])}}}},_onValidate:function(i){this._createAnnotation(i);this.textControl.clearTextField();this.textControl.hideControls();this.textPreview.enable();this.textControl.container.style.cursor="pointer"},_createAnnotation:function(j){if(this._exp&&this._exp.collabMode===false){return}var i=new f.text({frameWindow:this.frameWindow,drawSettings:this.drawSettings,annotationManager:this.annotationManager});i.createFromMousePositions(j);i.draw();this.annotationManager.addToAnnotGroupNode(i);var k=this.frameWindow.experience;if(k&&k.collabMode===true&&k.notifyAction){this.frameWindow.experience.notifyAction("annot3DDraw",[this.annotationManager.saveAnnotationsToJSON(i.id)])}},_createTextControl:function(){var j=this.frameWindow.getViewerFrame();this.textControl=new h({mode:"3D",viewerFrame:j,experience:this._exp,viewer:this.viewer,onOk:function(l){g._onValidate(l)},onCancel:function(){g.textControl.clearTextField()},onTypeStartCB:function(l){g.hideUI()}});this.textControl.inject(this.frameWindow.getUIFrame());var k=j.getDimensions();this.textControl.setBoundingLimits(k.width,k.height,1,0);this.textControl.updateDimensions();this.textControl.enable();this.textControl.setFocus();var i=this.drawSettings.getLastPosition();i.x*=k.width;i.y*=k.height;if(this._exp&&this._exp.collabMode!==false){this.textControl.showControls(i.x,i.y)}},_createPreview:function(){var i=this.frameWindow.getViewerFrame();this.textPreview=new a({mode:"3D",viewerFrame:i,viewer:this.viewer,onTypeStartCB:function(k){g.hideUI()},tapEvent:function(k){g._onTap(k)}});this.textPreview.inject(this.frameWindow.getUIFrame());var j=i.getDimensions();this.textPreview.setBoundingLimits(j.width,j.height,1,0);this.textPreview.enable();this.textPreview.hidePreview()},_destroyPreview:function(){if(this.textPreview){this.textPreview.hidePreview();this.textPreview.disable();this.textPreview.destroy();this.textPreview=undefined}},_destroyTextControl:function(){if(this.textControl){this.textControl.destroy();this.textControl=undefined}this.canvasViewer=undefined;this.viewerFrame=undefined}}))});define("DS/3DPlayAnnotation3D/Annotation3DErase",["DS/3DPlayAnnotation3D/Annotation3DCommand","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/WebUtils/GeometryUtils","DS/3DPlayAnnotation3D/AnnotationUtils","DS/Core/PointerEvents","DS/WebUtils/Vector2","DS/WebappsUtils/WebappsUtils"],function(h,d,g,b,a,i,e,j,c){var f;return(h.extend({init:function(k){this._parent(k);this.exp=k.frameWindow.experience;f=this;this._hideTools=k.hideTools},begin:function(k){this._parent(k);d.empty();g.empty();b.empty();this.setViewer({control:false,highlight:false,pickable:false});this._prevMousePos=null;this._currMousePos=null;this._annot2D=[];this._erase=function(p){var o=undefined;if(f.exp&&f.exp.collabMode!==false){var n=p.pathElement.externalPath;if(n.length>0){var l=n[n.length-1];if(l.name=="Annotation_Representation"){o=l.annotID}}}else{if(f.exp&&f.exp.collabMode===false){o=p}}if(o!==undefined){f.annotationManager.deleteAnnotationWithID(o);for(var m=0;m<f._annot2D.length;m++){if(f._annot2D[m].id===o){f._annot2D.splice(m,1)}}console.log("Annot: "+o+" deleted by pick");if(f.exp&&f.exp.collabMode===true){f.exp.notifyAction&&f.exp.notifyAction("annot3DErase",[o])}else{if(f.exp&&f.exp.collabMode===false){f.viewer.render()}}}};this.exp&&this.exp.registerCollabAction&&this.exp.registerCollabAction("annot3DErase",this._erase.bind(this));this._CSOAddToken=d.onAdd(this._erase);this._build2DBB();this._activateManipulators()},end:function(k){d.unsubscribe(this._CSOAddToken);this._CSOAddToken=null;this._disableManipulators();this._prevMousePos=null;this._currMousePos=null;this._annot2D=null;this._setCursor(false);this.unsetViewer();d.empty();this._parent(k)},destroy:function(){f=null;this._parent()},_getSmallerBoundingBoxes:function(o){var k=[];var m=1;var n=[];for(var l=0;l<o.length;l++){m++;if(m>10){k.push(a.boundingBoxCompute(a.convexHullCompute(n)));m=1;n=[]}n.push(o[l])}k.push(a.boundingBoxCompute(a.convexHullCompute(n)));return k},_build2DBB:function(){var r=this.annotationManager.getVisibleAnnotationGroups();for(var p=0;p<r.length;p++){var n=r[p];var u=n.annotList;for(var o=0;o<u.length;o++){var k=u[o];var m=[];var l=[];switch(k.type){case"circle":case"ellipse":case"unknownOpen":m=i.onScreenProjection(k.points,f.viewer);l=f._getSmallerBoundingBoxes(m);break;case"line":var s=k.get3DGeometry(k.points);m=i.onScreenProjection([s.startPoint,s.endPoint],f.viewer);l.push(a.boundingBoxCompute(a.convexHullCompute(m)));break;case"rectangle":case"square":var s=k.get3DGeometry(k.points);m=i.onScreenProjection(s.vertices,f.viewer);l.push(a.boundingBoxCompute(a.convexHullCompute([m[0],m[1]])));l.push(a.boundingBoxCompute(a.convexHullCompute([m[1],m[2]])));l.push(a.boundingBoxCompute(a.convexHullCompute([m[2],m[3]])));l.push(a.boundingBoxCompute(a.convexHullCompute([m[3],m[0]])));break;case"triangle":var s=k.get3DGeometry(k.points);m=i.onScreenProjection([s.vertexA,s.vertexB,s.vertexC],f.viewer);l.push(a.boundingBoxCompute(a.convexHullCompute([m[0],m[1]])));l.push(a.boundingBoxCompute(a.convexHullCompute([m[1],m[2]])));l.push(a.boundingBoxCompute(a.convexHullCompute([m[2],m[0]])));break;case"arrow":var s=k.get3DGeometry(k.points);var t=(s.arrowHeadEnd==="start")?s.lineStart.arrowhead:s.lineEnd.arrowhead;m=i.onScreenProjection([s.lineStart.point,s.lineEnd.point,t[0],t[1]],f.viewer);var q=(s.arrowHeadEnd==="start")?m[0]:m[1];l.push(a.boundingBoxCompute(a.convexHullCompute([m[0],m[1]])));l.push(a.boundingBoxCompute(a.convexHullCompute([m[2],q])));l.push(a.boundingBoxCompute(a.convexHullCompute([m[3],q])));break;case"doubleHeadedArrow":var s=k.get3DGeometry(k.points);m=i.onScreenProjection([s.start.point,s.end.point].concat(s.start.arrowhead,s.end.arrowhead),f.viewer);l.push(a.boundingBoxCompute(a.convexHullCompute([m[0],m[1]])));l.push(a.boundingBoxCompute(a.convexHullCompute([m[0],m[2]])));l.push(a.boundingBoxCompute(a.convexHullCompute([m[0],m[3]])));l.push(a.boundingBoxCompute(a.convexHullCompute([m[1],m[4]])));l.push(a.boundingBoxCompute(a.convexHullCompute([m[1],m[5]])));break;case"curvedArrow":var s=k.get3DGeometry(k.points);m=i.onScreenProjection(s.curvePoints,f.viewer);l=[].concat(f._getSmallerBoundingBoxes(m));var t=(s.arrowHeadEnd==="start")?s.curveStart.arrowhead:s.curveEnd.arrowhead;m=i.onScreenProjection([s.curveStart.point,s.curveEnd.point,t[0],t[1]],f.viewer);var q=(s.arrowHeadEnd==="start")?m[0]:m[1];l.push(a.boundingBoxCompute(a.convexHullCompute([m[2],q])));l.push(a.boundingBoxCompute(a.convexHullCompute([m[3],q])));break;case"curvedDoubleHeadedArrow":var s=k.get3DGeometry(k.points);m=i.onScreenProjection(s.curvePoints,f.viewer);l=[].concat(f._getSmallerBoundingBoxes(m));m=i.onScreenProjection([s.start.point,s.end.point,s.start.arrowhead[0],s.start.arrowhead[1],s.end.arrowhead[0],s.end.arrowhead[1]],f.viewer);l.push(a.boundingBoxCompute(a.convexHullCompute([m[0],m[2]])));l.push(a.boundingBoxCompute(a.convexHullCompute([m[0],m[3]])));l.push(a.boundingBoxCompute(a.convexHullCompute([m[1],m[4]])));l.push(a.boundingBoxCompute(a.convexHullCompute([m[1],m[5]])));break;case"text":var s=k.get3DGeometry(k.points);m=i.onScreenProjection(s.vertices,f.viewer);l.push(a.boundingBoxCompute(a.convexHullCompute(m)));break}f._annot2D.push({id:k.id,boundingBoxes:l})}}},_setCursor:function(k){if(k){var l="url("+c.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_AnnotationRubber.png), auto";this.viewer.canvas.style.setProperty("cursor",l)}else{this.viewer.canvas.style.setProperty("cursor","auto")}},_activateManipulators:function(){this.draw=false;this.proxyEventTarget=this.frameWindow.getViewerFrame();this.proxyEventTarget.addEvent(e.POINTERDOWN,function(k){if(k.button==0&&f.viewer.currentViewpoint.isMoving()!==true){if(f._hideTools){f._hideTools()}f.draw=true;f._setCursor(true);f._deleteRepFromPick(k)}});this.proxyEventTarget.addEvent(e.POINTERMOVE,function(k){if(k.button==0&&f.draw==true&&f.viewer.currentViewpoint.isMoving()!==true){f._setCursor(true);f._deleteRepFromPick(k)}});this.proxyEventTarget.addEvent(e.POINTERUP,function(k){if(k.button==0&&f.draw==true&&f.viewer.currentViewpoint.isMoving()!==true){f._setCursor(false);f._deleteRepFromPick(k);f.draw=false;f._prevMousePos=null;f._currMousePos=null}})},_disableManipulators:function(){this.proxyEventTarget.removeEvent(e.POINTERDOWN);this.proxyEventTarget.removeEvent(e.POINTERMOVE);this.proxyEventTarget.removeEvent(e.POINTERUP);this.proxyEventTarget=undefined},_deleteRepFromPick:function(n){var l=this.viewer.canvas.getBoundingClientRect();var o=new j(n.clientX-l.left,n.clientY-l.top);if(!this._currMousePos){this._currMousePos=new j(o.x,o.y)}else{this._prevMousePos=this._currMousePos;this._currMousePos=new j(o.x,o.y);var k=a.boundingBoxCompute(a.convexHullCompute([this._prevMousePos,this._currMousePos]));var m=this._annot2D.filter(function(s,r,q){var t=false;for(var p=0;p<s.boundingBoxes.length;p++){if(a.isIntersect(k,s.boundingBoxes[p])){f.annotationManager.deleteAnnotationWithID(s.id);console.log("Annot: "+s.id+" deleted by gesture");t=true;if(f.exp&&f.exp.collabMode===true){f.exp.notifyAction&&f.exp.notifyAction("annot3DErase",[s.id])}break}}return !t});this._annot2D=m}this.viewer.render()}}))});define("DS/3DPlayAnnotation3D/Annotation3DDraw",["DS/3DPlayAnnotation3D/Annotation3DCommand","DS/3DPlayAnnotation3D/Annotation3DDrawPreview","DS/3DPlayAnnotation3D/AnnotationShapes","DS/WebUtils/GeometryUtils","DS/3DPlayAnnotationUtils/ShapeUtils","DS/3DPlayAnnotation3D/AnnotationUtils","DS/Visualization/ThreeJS_DS"],function(c,a,g,f,e,d,b){var h;return(c.extend({init:function(i){this._parent(i);h=this},begin:function(i){this._parent(i);this.setViewer({control:false,highlight:false,pickable:false});this._createPreview();this.frameWindow.getViewerFrame().addEvent("resize",this._onWidgetResize)},end:function(i){this.frameWindow.getViewerFrame().removeEvent("resize",this._onWidgetResize);this._destroyPreview();this.unsetViewer();this._parent(i)},destroy:function(){h=null;this._parent()},_onWidgetResize:function(){h._destroyPreview();h._createPreview()},_createPreview:function(){this.drawPreview=new a({frameWindow:this.frameWindow,hideUICB:function(){h.hideUI()},strokeCompleteCB:function(i){h._strokeComplete(i)}});this.drawPreview.begin()},_destroyPreview:function(){if(this.drawPreview){this.drawPreview.end();this.drawPreview.destroy();this.drawPreview=undefined}},_strokeComplete:function(y){var p=this.frameWindow.experience;if(p&&p.collabMode===false){return}var r=e.shapeEval(y);if(r&&r.shape){var w=this.frameWindow.getViewerFrame().getDimensions();var x=d.pixelToNormalizedCoord(r.shape,w.width,w.height);var C=null;var m={frameWindow:this.frameWindow,annotationManager:this.annotationManager};var j=d.getUniquePointsFromPointsArray(r.shape);if(j.length<3){console.log("Not enough points to recoginize the shape")}else{switch(r.shape.type){case"circle":C=new g.circle(m);break;case"ellipse":C=new g.ellipse(m);break;case"line":C=new g.line(m);break;case"rectangle":C=new g.rectangle(m);break;case"square":C=new g.rectangle(m);break;case"triangle":C=new g.triangle(m);break;case"unknownOpen":C=new g.unknownOpen(m);break;case"text":C=new g.text(m);break;case"arrowhead":var A=this.annotationManager.getVisibleAnnotationGroups();for(var s=0;s<A.length;s++){var l=A[s];for(var z=0;z<l.annotList.length;z++){var q=l.annotList[z];var t=[];for(var v=0;v<r.shape.length;v++){var u=r.shape[v];t.push(new b.Vector2(u.x,u.y))}var n=f.boundingBoxCompute(f.convexHullCompute(t));switch(q.type){case"line":if(q.points.length==2){var o=(new b.Vector3).addVectors(q.points[0],q.points[1]).multiplyScalar(0.5);q.points=[q.points[0],o,q.points[1]]}var D=d.getUniquePointsFromPointsArray(d.onScreenProjection(q.points,this.viewer));var B=f.boundingBoxCompute(f.convexHullCompute(D));if(e.isArrow3(D,t,B,n)){x={shapePoints2D:D,shapePoints3D:q.points,arrowhead:t,normal:q.normals[0].clone(),onModel:q.onModel};var p=this.frameWindow.experience;if(p&&p.collabMode===true&&p.notifyAction){p.notifyAction("annot3DDelete",[q.id])}this.annotationManager.deleteAnnotationWithID(q.id);C=new g.arrow(m)}break;case"unknownOpen":var D=d.getUniquePointsFromPointsArray(d.onScreenProjection(q.points,this.viewer));var B=f.boundingBoxCompute(f.convexHullCompute(D));if(e.isCurvedArrow3(D,t,B,n)){x={shapePoints2D:D,shapePoints3D:q.points,arrowhead:t,normal:q.normals[0].clone(),onModel:q.onModel};var p=this.frameWindow.experience;if(p&&p.collabMode===true&&p.notifyAction){p.notifyAction("annot3DDelete",[q.id])}this.annotationManager.deleteAnnotationWithID(q.id);C=new g.curvedArrow(m)}break;case"arrow":if(q.shapePoints.length==2){var o=(new b.Vector3).addVectors(q.shapePoints[0],q.shapePoints[1]).multiplyScalar(0.5);q.shapePoints=[q.shapePoints[0],o,q.shapePoints[1]]}var D=d.getUniquePointsFromPointsArray(d.onScreenProjection(q.shapePoints,this.viewer));var B=f.boundingBoxCompute(f.convexHullCompute(D));if(e.isArrow3(D,t,B,n)){x={arrowShapePoints2D:D,arrowShapePoints3D:q.shapePoints,oldArrowHeadEnd:q.arrowHeadEnd,oldArrowHeadPoints3D:q.arrowHeadPoints,newArrowHeadPoints2D:t,annotPoints:q.points,normal:q.normals[0].clone(),onModel:q.onModel};var p=this.frameWindow.experience;if(p&&p.collabMode===true&&p.notifyAction){p.notifyAction("annot3DDelete",[q.id])}this.annotationManager.deleteAnnotationWithID(q.id);C=new g.doubleHeadedArrow(m)}break;case"curvedArrow":var D=d.getUniquePointsFromPointsArray(d.onScreenProjection(q.shapePoints,this.viewer));var B=f.boundingBoxCompute(f.convexHullCompute(D));if(e.isCurvedArrow3(D,t,B,n)){x={arrowShapePoints2D:D,arrowShapePoints3D:q.shapePoints,oldArrowHeadEnd:q.arrowHeadEnd,oldArrowHeadPoints3D:q.arrowHeadPoints,newArrowHeadPoints2D:t,annotPoints:q.points,normal:q.normals[0].clone(),onModel:q.onModel};var p=this.frameWindow.experience;if(p&&p.collabMode===true&&p.notifyAction){p.notifyAction("annot3DDelete",[q.id])}this.annotationManager.deleteAnnotationWithID(q.id);C=new g.curvedDoubleHeadedArrow(m)}break}if(C){break}}if(C){break}}break}console.log("SHAPE = "+r.shape.type);if(!C){C=new g.unknownOpen(m)}C.createFromMousePositions(x);C.draw();this.annotationManager.addToAnnotGroupNode(C);var p=this.frameWindow.experience;if(p&&p.collabMode===true&&p.notifyAction){p.notifyAction("annot3DDraw",[this.annotationManager.saveAnnotationsToJSON(C.id)])}}}}}))});var annotationManager=[];if(window.localStorage["3DPlay.UseExplodeCompatibleAnnotationManager"]){annotationManager.push("DS/3DPlayAnnotation3D/AnnotationExplodeManager")}else{annotationManager.push("DS/3DPlayAnnotation3D/AnnotationManager")}define("DS/3DPlayAnnotation3D/AnnotationCommands",["DS/ApplicationFrame/Command","DS/WebUtils/ContextedSingleton","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/WebInfraUI/ContextualBarManager","DS/3DPlayAnnotationUtils/AnnotationToolsMenu","DS/3DPlayAnnotation3D/AnnotationUtils","DS/CoreEvents/Events","DS/3DPlayAnnotation3D/Annotation3DDraw","DS/3DPlayAnnotation3D/Annotation3DText","DS/3DPlayAnnotation3D/Annotation3DErase","DS/WebUtils/Tracker","DS/WebSystem/Environment"].concat(annotationManager),function(b,e,f,l,d,g,j,o,n,a,c,i,h,m,p){var k;return(b.extend({init:function(q){this._parent(q,{isAsynchronous:true,mode:"exclusive"});k=this;this._exp=this.getFrameWindow().experience;if(this._exp){if(this._exp.registerCollabAction){this._exp.registerCollabAction("annotBeginExecute",this.beginExecute.bind(this));this._exp.registerCollabAction("annotExecute",this.execute.bind(this));this._exp.registerCollabAction("annotEndExecute",this.endExecute.bind(this));this._exp.registerCollabAction("annotStartCommand",this._startCommand.bind(this))}}if(m.isSet("3DPlay.OldAnnotMenu")){this.newToolsUI=false}else{this.newToolsUI=true}},beginExecute:function(){f.empty();l.empty();d.empty();this.frameWindow=this.getFrameWindow();var r=this.frameWindow.getActionBar();r.close();var q=r.onActionBarOpen(function(){r.removeCallback(q);k.end()});this.annotationManager=e.get(this._ctx,"ANNOTATION_MANAGER");if(!this.annotationManager){this.annotationManager=new p({frameWindow:this.frameWindow,context:this._ctx});e.add(this._ctx,"ANNOTATION_MANAGER",this.annotationManager)}o.setNodePickable(this.annotationManager.getModel(),false);if(k._exp&&k._exp.notifyAction&&k._exp.collabMode===true){k._exp.notifyAction("annotBeginExecute")}this.MBAShow=n.subscribe({event:"3DPlay.MAB.Show"},function(){if(k&&k.frameWindow){k.frameWindow.getActionBar().open()}});this.MBAHide=n.subscribe({event:"3DPlay.MAB.Hide"},function(){if(k&&k.frameWindow){k.frameWindow.getActionBar().open()}});k.frameWindow.getViewerFrame().addEvent("resize",this._onWidgetResize)},execute:function(){h.inc("command-"+this.getId());this.Draw3D=new a({frameWindow:this.frameWindow,annotationManager:this.annotationManager,hideTools:function(){k._removeTools()}});this.Text3D=new c({frameWindow:this.frameWindow,annotationManager:this.annotationManager,hideTools:function(){k._removeTools()}});this.Erase3D=new i({frameWindow:this.frameWindow,annotationManager:this.annotationManager,hideTools:function(){k._removeTools()}});this._buildUI();if(k._exp&&k._exp.collabMode===true&&k._exp.notifyAction){k._exp.notifyAction("annotExecute")}},endExecute:function(){n.unsubscribe(this.MBAShow);n.unsubscribe(this.MBAHide);this.frameWindow.getViewerFrame().removeEvent("resize",this._onWidgetResize);this._endCommands();if(this.annotationToolsMenu){this.annotationToolsMenu.dispose();this.annotationToolsMenu=undefined}if(this.contextualMenu&&this.contextualMenuToken){this.contextualMenu.removeButtons(this.contextualMenuToken);this.contextualMenu.dispose();this.contextualMenuToken=undefined;this.contextualMenu=undefined}if(this.Draw3D){this.Draw3D.destroy();this.Draw3D=undefined}if(this.Erase3D){this.Erase3D.destroy();this.Erase3D=undefined}if(this.Text3D){this.Text3D.destroy();this.Text3D=undefined}f.empty();l.empty();d.empty();o.setNodePickable(this.annotationManager.getModel(),true);var q=this.frameWindow.getActionBar();if(q){if(q.MAB){q.MAB.showFlyout(0)}q.open()}this.frameWindow=undefined;if(this._exp&&this._exp.collabMode===true&&this._exp.notifyAction){this._exp.notifyAction("annotEndExecute")}},_endCommands:function(){if(this.annotationToolsMenu&&this.annotationToolsMenu.colorPaletteVisible){this._hideColorPalette()}if(this.Draw3D&&this.Draw3D.isRunning()){this.Draw3D.end()}if(this.Erase3D&&this.Erase3D.isRunning()){this.Erase3D.end()}if(this.Text3D&&this.Text3D.isRunning()){this.Text3D.end()}},_startCommand:function(q){if(this.newToolsUI){this._newMenuStartCommand(q)}else{this._oldMenuStartCommand(q)}},_newMenuStartCommand:function(q){this._hideColorPalette();if(q.id==="3DDrawing"){this.Draw3D.begin()}else{if(q.id==="3DErase"){this.Erase3D.begin()}else{if(q.id==="3DText"){this.Text3D.begin()}}}if(this._exp&&this._exp.collabMode===true&&this._exp.notifyAction){this._exp.notifyAction("annotStartCommand",[q])}},_oldMenuStartCommand:function(q){this._endCommands();this.annotationToolsMenu.removeToolsButton();if(q.id==="3DDrawing"){this.Draw3D.begin();this.annotationToolsMenu.addToolsButton()}else{if(q.id==="3DErase"){this.Erase3D.begin();this.annotationToolsMenu.removeToolsButton()}else{if(q.id==="3DText"){this.Text3D.begin();this.annotationToolsMenu.addToolsButton()}}}if(this._exp&&this._exp.collabMode===true&&this._exp.notifyAction){this._exp.notifyAction("annotStartCommand",[q])}},_buildUI:function(){var s=this.frameWindow.getActionBar();var r;if((s.MAB&&s.MAB.state.visible===true)){r=[{id:"3DDrawing",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",selected:true},{id:"3DErase",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation"}]}else{r=[{id:"3DDrawing",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",selected:true},{id:"3DText",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation"},{id:"3DErase",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation"}]}this.contextualMenu=new g({frameWindow:this.frameWindow});var q=[{type:this.contextualMenu.Button.Radio,content:r,onclickCB:function(t){k._endCommands();if(!k.newToolsUI){k.annotationToolsMenu.removeToolsButton()}k._startCommand(t)}},{type:this.contextualMenu.Button.Master,id:"ExitAnnotation",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",onclickCB:function(){k.getFrameWindow().getActionBar().open()}}];this.contextualMenuToken=this.contextualMenu.addButtons(q,{barType:this.contextualMenu.Toolbar.New,showContextBarBackground:true});this.annotationToolsMenu=new j({contextualMenu:this.contextualMenu,frameWindow:this.frameWindow,newToolsUI:this.newToolsUI});this.annotationToolsMenu.addToolsButton();if(this.newToolsUI){this.contextualMenu.panel.container.style.cursor="pointer";this._hideColorPalette()}this.Draw3D.begin()},_removeTools:function(){if(this.newToolsUI){this._hideColorPalette()}else{if(this.annotationToolsMenu){this.annotationToolsMenu.removeTools()}}},_hideColorPalette:function(){if(this.annotationToolsMenu&&this.annotationToolsMenu.hideColorPalette){this.annotationToolsMenu.hideColorPalette()}},_onWidgetResize:function(){if(k&&k.frameWindow){var q=k.frameWindow.getActionBar();if(q){if(!q.MAB){q.open()}}}},_destroy:function(){if(this._exp){this._exp=undefined}k=undefined;this._parent()}}))});