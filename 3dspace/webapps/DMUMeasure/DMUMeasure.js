define("DS/DMUMeasure/DMUCreateMeasureCmd",["DS/DMUBaseCommands/EXPStateCommand"],function(f){var j,r,d,s,n,t,l,u,o,x,a,m,y,w,q,v,g,i,k,p,z,b,h,e;var c=f.extend({init:function(A){this._parent(A,"exclusive",true);this._bEnablePrevisualization=(this._arguments[0].ID==="Thickness");this._notPickableList=[];if(this._arguments[0].ID==="ProgressiveVisuLoading"){this._measureCommandMode="ProgressiveVisuLoading"}var B=this;require(["DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/EXPNls","DS/DMUBaseExperience/EXPUtils","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUMeasurable/DMUMeasurableElementAgent","DS/DMUBaseUI/DMUInitialization","DS/DMUMeasurable/DMUMeasurable","DS/Web3DUXFilterBar/Web3DUXFilterBar","DS/Web3DUXAssistantTools/Web3DUXAssistantTools","DS/DMUPlayMeasure/DMUMeasure","DS/DMUMeasurable/DMUMeasureEnums","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/LevelSelector/LevelSelector","DS/Core/Events","DS/WebappsUtils/WebappsUtils","DS/Mesh/Mesh","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/Mesh/MeshUtils","DS/DMUBaseExperience/DMUContextManager","DS/ApplicationFrame/CommandsManager","UWA/Core","UWA/Utils",],function(C,P,E,I,V,G,M,T,F,L,R,K,U,S,O,N,W,D,Y,J,Q,H,Z,aa){j=C;r=P;d=E;s=I;n=V;t=G;l=M;u=T;o=F;x=L;a=R;m=K;y=U;w=S;q=O;v=N;g=W;i=D;k=Y;p=J;z=Q;b=H;h=Z;e=aa;if(!r.getLocalResource("DMUBaseUI/CAT3DPlayProReview")){r.setLocalResource("DMUBaseUI/CAT3DPlayProReview",function(){})}B._iconDir=g.getWebappsAssetUrl("DMUBaseCommands","icons/32/");if(!B._bEnablePrevisualization&&d.isEnvActivated("measurepreview",true)){B._bEnablePrevisualization=true}var X={};if(window.location.search!==""){h.extend(X,e.parseQuery(window.location.search));if(X.widgetDomain){h.extend(X,e.parseQuery(X.widgetDomain))}}if("MPVLOD" in X){B._mPVLOD=true}z.setAuthoringFeatureTypes("Measure")});this._initPref()},_destroy:function(){if(this._filterUI){this._filterUI.clear()}this._parent()},_initPref:function(){localStorage.setItem("DMUMeasureCircleRadiusPreferences","DisplayDiameter");localStorage.setItem("DMUMeasureCylinderRadiusPreferences","DisplayDiameter");localStorage.setItem("DMUMeasureSphereRadiusPreferences","DisplayDiameter")},BuildNls:function(B){var A={};if(r.getProxy(B)!==undefined){A=r.getProxy(B)}else{A.measureitemname=r.getNls("DMUBaseUI.CAT3DPlayProReview.measureitemname");A.measurebetweenname=r.getNls("DMUBaseUI.CAT3DPlayProReview.measurebetweenname");A.measurethreepointsname=r.getNls("DMUBaseUI.CAT3DPlayProReview.measurethreepointsname");A.measurethickness=r.getNls("DMUBaseUI.CAT3DPlayProReview.measurethicknessname");A.point=r.getNls("DMUBaseUI.CAT3DPlayProReview.point");A.axis=r.getNls("DMUBaseUI.CAT3DPlayProReview.axis");A.curve=r.getNls("DMUBaseUI.CAT3DPlayProReview.curve");A.plane=r.getNls("DMUBaseUI.CAT3DPlayProReview.plane");A.surface=r.getNls("DMUBaseUI.CAT3DPlayProReview.surface");A.product=r.getNls("DMUBaseUI.CAT3DPlayProReview.product");A.center=r.getNls("DMUBaseUI.CAT3DPlayProReview.center");A.line=r.getNls("DMUBaseUI.CAT3DPlayProReview.line");A.infiniteline=r.getNls("DMUBaseUI.CAT3DPlayProReview.infiniteline");A.circle=r.getNls("DMUBaseUI.CAT3DPlayProReview.circle");A.cylinder=r.getNls("DMUBaseUI.CAT3DPlayProReview.cylinder");A.cone=r.getNls("DMUBaseUI.CAT3DPlayProReview.cone");A.sphere=r.getNls("DMUBaseUI.CAT3DPlayProReview.sphere");A.measuretype=r.getNls("DMUBaseUI.CAT3DPlayProReview.measuretype");A.geometrytype=r.getNls("DMUBaseUI.CAT3DPlayProReview.geometrytype");A.ok=r.getNls("DMUBaseUI.CAT3DPlayProReview.ok");A.notifyinitial=r.getNls("DMUBaseUI.CAT3DPlayProReview.notifyinitial");A.notifyinitialpt=r.getNls("DMUBaseUI.CAT3DPlayProReview.notifyinitialpt");A.notifyinitialptauth=r.getNls("DMUBaseUI.CAT3DPlayProReview.notifyinitialptauth");A.notifyrepeatitem=r.getNls("DMUBaseUI.CAT3DPlayProReview.notifyrepeatitem");A.notifyrepeatitempt=r.getNls("DMUBaseUI.CAT3DPlayProReview.notifyrepeatitempt");A.notifyitem=r.getNls("DMUBaseUI.CAT3DPlayProReview.notifyitem");A.notifyitempt=r.getNls("DMUBaseUI.CAT3DPlayProReview.notifyitempt");A.notifyrepeatbetween=r.getNls("DMUBaseUI.CAT3DPlayProReview.notifyrepeatbetween");A.notifyrepeatbetweenpt=r.getNls("DMUBaseUI.CAT3DPlayProReview.notifyrepeatbetweenpt");A.notifybetween=r.getNls("DMUBaseUI.CAT3DPlayProReview.notifybetween");A.notify3pointsangle=r.getNls("DMUBaseUI.CAT3DPlayProReview.notify3pointsangle");A.notify3pointscircle=r.getNls("DMUBaseUI.CAT3DPlayProReview.notify3pointscircle");A.notifythickness=r.getNls("DMUBaseUI.CAT3DPlayProReview.notifythickness");A.repeatitem=r.getNls("DMUBaseUI.CAT3DPlayProReview.repeatitem");A.repeatchain=r.getNls("DMUBaseUI.CAT3DPlayProReview.repeatchain");A.repeatfan=r.getNls("DMUBaseUI.CAT3DPlayProReview.repeatfan");A.keepprevious=r.getNls("DMUBaseUI.CAT3DPlayProReview.keepprevious");A.anglethreepoints=r.getNls("DMUBaseUI.CAT3DPlayProReview.anglethreepoints");A.circlethreepoints=r.getNls("DMUBaseUI.CAT3DPlayProReview.circlethreepoints");A.thickness=r.getNls("DMUBaseUI.CAT3DPlayProReview.thickness");r.setProxy(B,A)}return A},begin:function(){if(!this._isRunning){var B=b.getCommand(b.getCurrentCmdId(this._ctx),this._ctx);var A=(B&&B.getRequestedCommandMode)?B.getRequestedCommandMode({cmd:"Measure"}):"exclusive";this._mode=A==="shared"?"shared":"exclusive"}this._parent.apply(this,arguments)},setCommandMode:function(A){this._measureCommandMode=undefined;if(A==="PickingPointOnly"){this._measureCommandMode="3dAuthoringPickPoint"}else{if(A==="ProgressiveVisuLoading"){this._measureCommandMode="ProgressiveVisuLoading"}}if(this._filterUI){this._filterUI.clear();this._filterUI=null}},beginExecute:function(){var E=z.getReviewContext({viewer:this.getFrameWindow().getViewer()});if(E&&E.getCurrentReview()&&E.isSwitchedReviewCtx&&(this._arguments[0].ID==="3dPlay"||this._arguments[0].ID==="3dAuthoring"||this._arguments[0].ID==="Geovia"||this._arguments[0].ID==="ProgressiveVisuLoading")){var D=E.getCurrentReview().getChildren("DMUMeasure");for(var C=D.length-1;C>=0;C--){D[C].remove()}}this._bKeepall=true;var B=z.getContextViewer({viewer:this.getFrameWindow().getViewer()});if(this._arguments[0].ID==="3dPlay"||this._arguments[0].ID==="3dAuthoring"||this._arguments[0].ID==="Geovia"||this._arguments[0].ID==="ProgressiveVisuLoading"){l.startSwitchExperience({context:B});this._bKeepall=false}else{l.createReviewContext({context:B})}if(B.getController){this._viewerController=B.getController()}var A="primHybrid";this._pathElementAgentWithCSO=new t({agentId:"_pathElementAgentWithCSO",frameWindow:this._frmWindow,engWithPSOHSO:true,multiAcquisition:false,multiAcquisitionCtrl:false,pickingMode:A,prePickingMode:A,valuedFromCSO:true,saveToCSO:false,activatePrePicking:true,acceptedGeometries:[],appli:this,checkAppli:this._checkPicking,displayAppli:this._bEnablePrevisualization?this._previsualize:undefined});this._pathElementAgentWithoutCSO=new t({agentId:"_pathElementAgentWithoutCSO",frameWindow:this._frmWindow,engWithPSOHSO:true,multiAcquisition:false,multiAcquisitionCtrl:false,pickingMode:A,prePickingMode:A,valuedFromCSO:false,saveToCSO:false,activatePrePicking:true,acceptedGeometries:[],appli:this,checkAppli:this._checkPicking,displayAppli:this._bEnablePrevisualization?this._previsualize:undefined});if("ontouchstart" in window){this._viewer.setMagnifier({activated:true,dim:83,shiftVector:{x:-50,y:120}})}this._sExpType="DMUMeasureCB";this._measurable=[];this._nlscmd=this.BuildNls(this._sExpType);this._measure=null;this._repeatType="None";if(!this._filterUI){this._createFilter()}this._filteredGeometries=this._updateFilter(this._filterUI);if((this._arguments[0].ID==="3dPlay")||(this._arguments[0].ID==="Thickness")||(this._arguments[0].ID==="Geovia")||(this._measureCommandMode==="3dAuthoringPickPoint")||(this._measureCommandMode==="ProgressiveVisuLoading")){this._filterUI.setVisibleFlag(false)}if(this._measureCommandMode==="3dAuthoringPickPoint"){this._activeFilter="pointOnly"}this._previousLinePickingMode=this._viewer.renderer.renderer.pickLinesMode;this._previousPointPickingMode=this._viewer.renderer.renderer.pickPointsMode;this._previousForcePickingPoints=this._viewer.renderer.renderer.pickPointsMode;this._viewer.setLinePickingMode(i.PICK_ALWAYS);this._viewer.setPointPickingMode(i.PICK_ALWAYS);this._viewer.setForcePickingPoints(true);this._viewer.render({onlyPostProcess:false});this._parent()},endExecute:function(){this.cleanNotify(this._notify);this._notify=null;this._parent();this._pathElementAgentWithCSO=null;this._pathElementAgentWithoutCSO=null;this._sExpType=null;this._measurable=null;this._nlscmd=null;if(this._bVisibleMagnifier==="true"){this._viewer.setMagnifier({activated:false})}if(this._filterUI){this._filterUI.setVisibleFlag(false)}this._removeAssistantTools();this._cleanLevelSelector();if(this._measure){if(this._measure._bPrevisualized){this._measure.remove();this._measure=this._lastMeasure;this._lastMeasure=null}else{if(this._bEnablePrevisualization){this._unprevisualize()}}if(this._measure){this._measure.refreshNode(false,false,false);if(((this._arguments[0].ID==="3dPlay")||(this._arguments[0].ID==="Geovia"))&&(this._measure.getAttribute("sType")!=="MeasureBetween")){this._measure.remove();this._measure=null;this._viewer.render()}else{this._measure.setInEdition(false);var C=z.getReviewContext({viewer:this.getFrameWindow().getViewer()});if(C){var D=this;setTimeout(function(){if(D._measure&&D._measure._nNode){D.addInCSO(D._measure);D._measure=null}},10)}}}}for(var A=0;A<this._notPickableList.length;A++){var B=this._notPickableList[A];if(B&&B._nNode){this._notPickableList[A]._nNode.setPickable(p.PICKABLE)}}this._viewer.setLinePickingMode(this._previousLinePickingMode);this._viewer.setPointPickingMode(this._previousPointPickingMode);this._viewer.setForcePickingPoints(this._previousForcePickingPoints);this._viewer.render({onlyPostProcess:false})},_onSessionReduced:function(){this._measure=null},buildGraph:function(){var P=this.createInitialState("initialState");this.setEnterStateAction(P,this._enterInitialCallback);this.setExitStateAction(P,this._exitInitialCallback);var B=this.getFinalState();var N=this.createState("itemState");this.setEnterStateAction(N,this._enterItemCallback);this.setExitStateAction(N,this._exitItemCallback);var I=this.createState("repeatitemState");this.setEnterStateAction(I,this._enterInitialCallback);this.setExitStateAction(I,this._exitInitialCallback);var Q=this.createState("betweenState");this.setEnterStateAction(Q,this._enterBetweenCallback);this.setExitStateAction(Q,this._exitBetweenCallback);var K=this.createState("repeatbetweenState");this.setEnterStateAction(K,this._enterItemCallback);this.setExitStateAction(K,this._exitItemCallback);var A=this.createState("threepointsState");this.setEnterStateAction(A,this._enterThreepointsCallback);this.setExitStateAction(A,this._exitThreepointsCallback);var L={iEvent:this._pathElementAgentWithCSO,iInitialState:P,iFinalState:N,iAction:this._computeItemCallback};this.addTransition(L);if((this._arguments[0].ID==="3dPlay")||(this._arguments[0].ID==="Geovia")){var S={iEvent:this._pathElementAgentWithoutCSO,iInitialState:N,iFinalState:B,iAction:this._computeBetweenCallback};this.addTransition(S)}else{if(this._arguments[0].ID!=="Thickness"){var F={iEvent:this._pathElementAgentWithoutCSO,iInitialState:N,iFinalState:Q,iAction:this._computeBetweenCallback};this.addTransition(F)}}var T={iSender:this,iEvent:"OK",iInitialState:N,iFinalState:B};this.addTransition(T);if((this._arguments[0].ID!=="3dPlay")&&(this._arguments[0].ID!=="Geovia")){this.addEmptySelectionTransition(N,B)}var M={iSender:this,iEvent:"repeatitem",iInitialState:N,iFinalState:I};this.addTransition(M);var O={iSender:this,iEvent:"OK",iInitialState:Q,iFinalState:B};this.addTransition(O);this.addEmptySelectionTransition(Q,B);var G={iSender:this,iEvent:"repeatbetween",iInitialState:Q,iFinalState:K};this.addTransition(G);var J={iSender:this,iEvent:"threepoints",iInitialState:Q,iFinalState:A};this.addTransition(J);var E={iEvent:this._pathElementAgentWithoutCSO,iInitialState:I,iFinalState:I,iAction:this._computeItemCallback};this.addTransition(E);var H={iSender:this,iEvent:"OK",iInitialState:I,iFinalState:B};this.addTransition(H);this.addEmptySelectionTransition(I,B);var D={iEvent:this._pathElementAgentWithoutCSO,iInitialState:K,iFinalState:K,iAction:this._computeBetweenCallback};this.addTransition(D);var R={iSender:this,iEvent:"OK",iInitialState:K,iFinalState:B};this.addTransition(R);this.addEmptySelectionTransition(K,B);var C={iEvent:this._pathElementAgentWithoutCSO,iInitialState:A,iFinalState:B,iAction:this._computeThreepointsCallback};this.addTransition(C)},_checkPicking:function(A,B){var C=false;if(A!==undefined){C=B._isItMeasurable(A)}return C},_treatSelection:function(L){var F;var J=this;var I=L.data[0];var C=L.callback;var A=I.pathElement.getLastElement().sgNode;if(A!==undefined){F=new u({primitive:A,pathElement:I.pathElement,selpoint:I.position,selnormal:I.normal});if(C){C(F)}}else{if(this._measureCommandMode==="ProgressiveVisuLoading"||this._mPVLOD){if(L.load===true){if(this._viewerController){var H=[];var K=n.getLastRepReference(I.pathElement);var B=K.getLastElement();var D=(n.getLastReference(I.pathElement)).getLastElement();H.push({node:B,stream:"cgr",});this._viewerController.switchNodeVisuStreamOnDemand({data:H,noMeshInRAM:false,callbacks:{onComplete:function(P){var M=J._viewer.castRay(I.ray,D,"prim");var Q=false;if(M){Q=J._pathElementAgentWithCSO._filter(M[0].pathElement)}if(Q===true){var N=[{pathElement:M[0].pathElement,normal:M[0].normal,position:M[0].point}];J._treatSelection({data:N,load:false,callback:C})}else{var O=[];O.push(I);J._treatSelection({data:O,load:false,callback:C})}},onFailure:function(){var M=[];M.push(I);J._treatSelection({data:M,load:false,callback:C})}}})}}else{var G=I.position.clone();var E=new y.Matrix4().getInverse(I.pathElement.getWorldMatrix());G=G.applyMatrix4(E);F=new u({canonic:{type:s.GeometryType.POINT,position:G},pathElement:I.pathElement,selpoint:I.position,selnormal:I.normal});if(C){C(F)}}}else{var G=I.position.clone();F=new u({canonic:{type:s.GeometryType.POINT,position:G},pathElement:I.pathElement,selpoint:I.position,selnormal:I.normal});if(C){C(F)}}}},_selectBestType:function(H,G){var F;var B=H.retrievePossibleSelectedType(G);if(H._activeFilter==="pointOnly"){F=m.ViewedType.POINT}else{if(H._activeFilter==="productOnly"){F=m.ViewedType.PRODUCT}else{F=B[0];var I=false;var D=B.length;for(var E=0;!I&&(E<D);E++){var A=H._filteredGeometries.viewedGeometries.length;for(var C=0;!I&&(C<A);C++){if(H._filteredGeometries.viewedGeometries[C]===B[E]){F=B[E];I=true}}}}}return F},_previsualize:function(B,C){var F=true;var E=this;if(C._bStartPrevisualize){C._bStartPrevisualize=false;if(C._measure&&C._stateId!=="threepointsState"){C._measure.setInEdition(false);if(!C._bKeepall){C._measure.remove()}C._lastMeasure=C._measure;C._lastMeasure._bPrevisualized=false;C._duplicateMeasureForRepeat(C._repeatType);C._measure._bPrevisualized=true}}if(!C._measure){C._treatSelection({data:[B],load:false,callback:function(G){if(G){C._measurable[0]=G;var H=C._selectBestType(C,C._measurable[0]);C._createMeasure(H);C._measure._bPrevisualized=true;C._measure._nNode.setPickable(p.NODRAWHL);C._notPickableList.push(C._measure)}return F}})}else{var D=z.getReviewContext({viewer:C.getFrameWindow().getViewer()});var A=D?D.getCurrentReview():null;if((C._stateId==="initialState")||(C._stateId==="repeatitemState")){C._treatSelection({data:[B],load:false,callback:function(G){if(G){var N=C._selectBestType(C,G);C._measure.setMeasurable(1,G);C._measure.setAttribute("sSelectedType1",N);C._measure.setAttribute("sResultingType1",C.retrieveItemResultType(C._measure.getMeasurable(1).getType(),N));C._measure.update();if(C._measure._sType==="MeasureThickness"){var K=C._measure.getMeasurable(1);var I=C._measure.getMeasurable(2);if(K&&I){var H=I.getPrimitive();if(H){var M=new w();var J=[];var L=THREEDS.SubElement.getFromSGNode(H);while(L!==null){J.unshift(L);L=L.getParent()}M.setFromArray(K.getPathElement().externalPath,J);C.addInHSO({path:M},false)}}}C._measure._nNode.setPickable(p.NODRAWHL);C._notPickableList.push(C._measure)}return F}})}else{if(C._stateId==="itemState"){C._treatSelection({data:[B],load:false,callback:function(G){if(G){C._measure.setMeasurable(2,G);var H=C._selectBestType(C,G);C._measure._sType="MeasureBetween";C._measure._sName=A.computeNewName(C._nlscmd.measurebetweenname);C._measure.setAttribute("sSelectedType2",H);var I=C._measure.getAttribute("sSelectedType1");C._measure.setAttribute("sResultingType1",C.retrieveBetweenResultType(I,H));C._measure.setAttribute("sResultingType2",C.retrieveBetweenResultType(H,I));C._measure.update();C._measure._nNode.setPickable(p.NODRAWHL);C._notPickableList.push(C._measure)}return F}})}else{if(C._stateId==="threepointsState"){C._treatSelection({data:[B],load:false,callback:function(G){if(G){C._measure.setMeasurable(3,G);C._measure.setAttribute("sType",(C._threepoints==="Circle")?"Measure3PointsCircle":"Measure3PointsAngle");C._measure.setAttribute("sName",A.computeNewName(C._nlscmd.measurethreepointsname));C._measure.update();C._measure._nNode.setPickable(p.NODRAWHL);C._notPickableList.push(C._measure)}return F}})}}}}},_unprevisualize:function(){this._measure._nNode.setPickable(p.PICKABLE)},_enterInitialCallback:function(){var A=this._nlscmd.notifyinitial;if((this._arguments[0].ID==="3dPlay")||(this._arguments[0].ID==="Geovia")){A=this._nlscmd.notifyinitialpt}else{if(this._arguments[0].ID==="Thickness"){A=this._nlscmd.notifythickness}else{if(this._measureCommandMode==="3dAuthoringPickPoint"){A=this._nlscmd.notifyinitialptauth}}}if(this._repeatType==="Item"){A=this._nlscmd.notifyrepeatitem;if((this._arguments[0].ID==="3dPlay")||(this._arguments[0].ID==="Geovia")){A=this._nlscmd.notifyrepeatitempt}this._createAssistantTools({bOK:((this._arguments[0].ID!=="3dPlay")&&(this._arguments[0].ID!=="Geovia")),bKeeponlylast:((this._arguments[0].ID!=="3dPlay")&&(this._arguments[0].ID!=="3dAuthoring")&&(this._arguments[0].ID!=="Geovia"))});if(this._activeFilter==="productOnly"&&this._measureCommandMode!=="ProgressiveVisuLoading"){this._createLevelSelector(true)}}this._notify=this.sendNotify("info",A);if((this._filterUI)&&((this._arguments[0].ID!=="3dPlay")&&(this._arguments[0].ID!=="Thickness")&&(this._arguments[0].ID!=="Geovia")&&(this._measureCommandMode!=="3dAuthoringPickPoint"))){this._filterUI.setVisibleFlag(true)}this._bStartPrevisualize=this._bEnablePrevisualization},_exitInitialCallback:function(){this.cleanNotify(this._notify);this._notify=null;if(this._repeatType==="Item"){this._removeAssistantTools();this._cleanLevelSelector()}if(this._filterUI){this._filterUI.setVisibleFlag(false)}},_computeItemCallback:function(B,A){if(this._measure&&this._measure._bPrevisualized){this._measure.remove();this._measure=undefined}if(this._repeatType==="Item"){if(this._measure){this._measure.setInEdition(false);if(!this._bKeepall){this._measure.remove()}this._measure=undefined}}var C=this;this._treatSelection({data:A,load:true,callback:function(D){if(D){C._measurable[0]=D;var E=C._selectBestType(C,C._measurable[0]);if(C._arguments[0].ID==="Geovia"){C._measurable[0]=C._transformMeasureToPoint(C._measurable[0])}if(!C._measure){C._createMeasure(E)}C._lockNode(C._measurable[0]);if((C._arguments[0].ID==="3dPlay")||(C._arguments[0].ID==="Geovia")){C._measure.setAttribute("bCollapsedDisplay",true);C._measure.refreshNode()}C._viewer.render();if(C.assistantTools){C.assistantTools.updatePosition(C._measure.getAttribute("vFirstExtensionPoint3D"))}C._bStartPrevisualize=C._bEnablePrevisualization;B()}}})},_createMeasure:function(B){var D=z.getReviewContext({viewer:this.getFrameWindow().getViewer()});var A=D.getCurrentReview();var C=this._arguments[0].ID;this._measure=new a(this._viewer,D);this._measure.initComponent({context:A,appType:C});if(this._arguments[0].ID==="Thickness"){this._measure.setAttribute("sType","MeasureThickness");this._measure.setAttribute("sName",A.computeNewName(this._nlscmd.measurethickness))}else{this._measure.setAttribute("sType","MeasureItem");this._measure.setAttribute("sName",A.computeNewName(this._nlscmd.measureitemname))}this._measure.setAttribute("sID",D.computeNewID());this._measure.setInEdition(true);this._measure.setAttribute("sSelectedType1",B);this._measureItem();this._measure.setAttributes([{name:"sLeaderStylePattern",value:"1"},{name:"fLeaderStyleThickness",value:1},{name:"cLeaderStyleColor",value:new y.Color("#3d3d3d")}]);this._measure.buildNode(true);this._measure.setInEdition(false);this._measure.setClippingControlPoints()},_transformMeasureToPoint:function(F){var B=F;var E=F.getType();if((E===s.GeometryType.CYLINDER)||(E===s.GeometryType.CONE)){var G=F.getSelPoint();var H=F.getPoints();var C=F.getAxis();var I=k.computePointLineDistance(G.toArray(),H.beginPoint.toArray(),C.toArray());var D=I.aPosition;var A={type:s.GeometryType.POINT,position:new y.Vector3(D[0],D[1],D[2])};B=new u({canonic:A,pathElement:F.getPathElement()})}else{if((E===s.GeometryType.CIRCLE)||(E===s.GeometryType.SPHERE)){var A={type:s.GeometryType.POINT,position:F.getCenter()};B=new u({canonic:A,pathElement:F.getPathElement()})}}return B},_enterItemCallback:function(){var A=this._nlscmd.notifyitem;if((this._arguments[0].ID==="3dPlay")||(this._arguments[0].ID==="Geovia")){A=this._nlscmd.notifyitempt}else{if(this._measureCommandMode==="3dAuthoringPickPoint"){A=this._nlscmd.notifyrepeatbetweenpt}}if(this._repeatType!=="None"){A=((this._arguments[0].ID==="3dPlay")||(this._arguments[0].ID==="Geovia"))?this._nlscmd.notifyrepeatbetweenpt:this._nlscmd.notifyrepeatbetween}this._notify=this.sendNotify("info",A);this._createAssistantTools({bOK:((this._arguments[0].ID!=="3dPlay")&&(this._arguments[0].ID!=="Geovia")),bRepeatitem:(this._repeatType==="None")&&(this._arguments[0].ID!=="3dPlay")&&(this._arguments[0].ID!=="Geovia"),bKeeponlylast:(this._repeatType!=="None")&&((this._arguments[0].ID!=="3dPlay")&&(this._arguments[0].ID!=="3dAuthoring")&&(this._arguments[0].ID!=="Geovia"))});if(this._activeFilter==="productOnly"&&this._measureCommandMode!=="ProgressiveVisuLoading"){this._createLevelSelector(true)}if((this._filterUI)&&((this._arguments[0].ID!=="3dPlay")&&(this._arguments[0].ID!=="Thickness")&&(this._arguments[0].ID!=="Geovia")&&(this._measureCommandMode!=="3dAuthoringPickPoint"))){this._filterUI.setVisibleFlag(true)}},_exitItemCallback:function(){this.cleanNotify(this._notify);this._notify=null;this._cleanLevelSelector();if(this._measure._bPrevisualized){this._measure.remove();this._measure=this._lastMeasure;this._lastMeasure=null}if(this._filterUI){this._filterUI.setVisibleFlag(false)}this._removeAssistantTools()},_computeBetweenCallback:function(C,B){var D=z.getReviewContext({viewer:this.getFrameWindow().getViewer()});var A=D.getCurrentReview();var E=this;if(this._lastMeasure){this._lastMeasure.remove();this._measure._bPrevisualized=false}if((this._repeatType==="Chain")||(this._repeatType==="Fan")){this._measure.setInEdition(false);if(!this._bKeepall){this._measure.remove()}this._duplicateMeasureForRepeat(this._repeatType)}this._treatSelection({data:B,load:true,callback:function(F){if(F){E._measurable[1]=F;if(E._arguments[0].ID==="Geovia"){E._measurable[1]=E._transformMeasureToPoint(E._measurable[1])}E._measure.setAttribute("sType","MeasureBetween");E._measure.setAttribute("sName",A.computeNewName(E._nlscmd.measurebetweenname));E._measure.setAttribute("sSelectedType2",E._selectBestType(E,E._measurable[1]));if((E._arguments[0].ID==="3dPlay")||(E._arguments[0].ID==="Geovia")){E._measure.setAttribute("bCollapsedDisplay",false)}E._measureBetween();E._lockNode(E._measurable[1]);if(E.assistantTools){E.assistantTools.updatePosition(E._vAssistantPosition)}C()}}})},_duplicateMeasureForRepeat:function(B){var A;if(B==="Chain"){this._measurable[0]=this._measurable[1].clone();A=this._measure.getAttribute("sSelectedType2")}else{this._measurable[0]=this._measurable[0].clone();A=this._measure.getAttribute("sSelectedType1")}this._createMeasure(A)},_enterBetweenCallback:function(){this._notify=this.sendNotify("info",this._nlscmd.notifybetween);var A=(this._measure.getAttribute("sSelectedType1")===m.ViewedType.POINT)&&(this._measure.getAttribute("sSelectedType2")===m.ViewedType.POINT);this._createAssistantTools({bOK:true,bRepeatbetweenChain:(this._repeatType!=="Chain")&&((this._arguments[0].ID!=="3dPlay")&&(this._arguments[0].ID!=="Geovia")),bRepeatbetweenFan:(this._repeatType!=="Fan")&&((this._arguments[0].ID!=="3dPlay")&&(this._arguments[0].ID!=="Geovia")),bAnglethreepoints:A&&((this._arguments[0].ID!=="3dPlay")&&(this._arguments[0].ID!=="Geovia")),bCirclethreepoints:A&&((this._arguments[0].ID!=="3dPlay")&&(this._arguments[0].ID!=="Geovia"))});if(this._activeFilter==="productOnly"&&this._measureCommandMode!=="ProgressiveVisuLoading"){this._createLevelSelector(false)}},_exitBetweenCallback:function(){this.cleanNotify(this._notify);this._notify=null;this._cleanLevelSelector();this._removeAssistantTools()},_enterThreepointsCallback:function(){var A=(this._threepoints==="Angle")?this._nlscmd.notify3pointsangle:this._nlscmd.notify3pointscircle;this._notify=this.sendNotify("info",A)},_exitThreepointsCallback:function(){this.cleanNotify(this._notify);this._notify=null},_computeThreepointsCallback:function(B,A){var C=this;this._treatSelection({data:A,load:true,callback:function(D){if(D){C._measurable[2]=D;var E=z.getReviewContext({viewer:C.getFrameWindow().getViewer()});C._measure.setAttribute("sType",(C._threepoints==="Circle")?"Measure3PointsCircle":"Measure3PointsAngle");C._measure.setAttribute("sName",E.getCurrentReview().computeNewName(C._nlscmd.measurethreepointsname));C._measureThreePoints();C._lockNode(C._measurable[2]);B()}}})},_createLevelSelector:function(C){var E=this;var D=(C)?0:1;this.dataLevels=[];this._getLevels=function(F){E.dataLevels=[];var K=E._measurable[D].getPathElement();var M=n.getLastReference(K);var L=[];var J=M.externalPath.length;for(var I=0;I<J;++I){var H=M.getLastElement(true);if(n.isReference(H)){E.dataLevels.push({pathElement:M.clone(),name:H.name,internalLevel:J-I});L.push(H)}M=M.getParentPath()}var G=z.getContextViewer({reviewContext:z.getReviewContext({viewer:E.getFrameWindow().getViewer()})});n.getName(L,function(P){var O=P.length;for(var N=0;N<O;++N){E.dataLevels[N].name=P[N]}F()},G,"");return E.dataLevels};this._onLevelHover=function(){};this._onLevelSelect=function(J){var F=0;for(var I=0;(F===0)&&(I<E.dataLevels.length);++I){if(E.dataLevels[I].pathElement.getLength()===J.pathElement.getLength()){F=E.dataLevels[I].internalLevel}}E._measurable[D].setLevel(F);if(C){E._measure.setAttribute("sSelectedType1",m.ViewedType.PRODUCT);E._measureItem()}else{E._measure.setAttribute("sSelectedType2",m.ViewedType.PRODUCT);E._measureBetween()}var H=j.getWindowPositionFromPoint(E._viewer,E._measure.getAttribute("vLeaderBreakPoint3D"),E._frmWindow);var G={positionX:H.left,positionY:H.top-110,uiFrame:E._frmWindow.getUIFrame(),selectedPath:E._getLevels,getLevels:E._getLevels,onHover:E._onLevelHover,onSelect:E._onLevelSelect};E._cleanLevelSelector();q.createView(G);E.assistantTools.updatePosition(E._vAssistantPosition);E._measure.refreshNode();E._viewer.render()};var B=j.getWindowPositionFromPoint(this._viewer,this._measure.getAttribute("vLeaderBreakPoint3D"),this._frmWindow);var A={positionX:B.left,positionY:B.top-110,uiFrame:this._frmWindow.getUIFrame(),selectedPath:this._getLevels,getLevels:this._getLevels,onHover:this._onLevelHover,onSelect:this._onLevelSelect};this._cleanLevelSelector();q.createView(A)},_cleanLevelSelector:function(){var A=q._noAnim;q._noAnim=true;q.destroyView();q._noAnim=A},_measureItem:function(){this._measure.setMeasurable(1,this._measurable[0]);this._measure.setAttribute("sResultingType1",this.retrieveItemResultType(this._measure.getMeasurable(1).getType(),this._measure.getAttribute("sSelectedType1")));this._measure.update();switch(this._measure.getAttribute("sResultingType1")){case m.ResultType.POINT:case m.ResultType.PICKINGPT:case m.ResultType.CENTER:case m.ResultType.PLANE:case m.ResultType.CURVE:case m.ResultType.SURFACE:this._vAssistantPosition=this._measure.getAttribute("vFirstExtensionPoint3D").clone();break;case m.ResultType.LINE:this._vAssistantPosition=this._measure.getAttribute("vFirstExtensionPoint3D").clone().add(this._measure.getAttribute("vSecondExtensionPoint3D")).multiplyScalar(0.5);break;case m.ResultType.AXIS:this._vAssistantPosition=this._measure.getAttribute("vLeaderPointingPoint3D").clone();break;case m.ResultType.CIRCLE:var C=j.getViewpointInfo(this._viewer.currentViewpoint);var D=Math.abs(this._measure.getAttribute("vNormal").angleTo(C.sight)-Math.PI/2)<Math.PI/10;var B=localStorage.getItem("DMUMeasureCircleRadiusPreferences");var A=(B=="DisplayRadius"?true:false);if(this._measure.getAttribute("bRadiusDisplay")!=A){this._measure.setAttribute("bRadiusDisplay",A)}this._vAssistantPosition=(D)?this._measure.getAttribute("vCenter").clone():this._measure.getAttribute("vLeaderPointingPoint3D").clone();break;case m.ResultType.CYLINDER:var B=localStorage.getItem("DMUMeasureCylinderRadiusPreferences");var A=(B=="DisplayRadius"?true:false);this._vAssistantPosition=this._measure.getAttribute("vPoint1").clone().add(this._measure.getAttribute("vPoint2")).multiplyScalar(0.5);if(this._measure.getAttribute("bRadiusDisplay")!=A){this._measure.setAttribute("bRadiusDisplay",A)}break;case m.ResultType.CONE:this._vAssistantPosition=this._measure.getAttribute("vPoint2").clone();break;case m.ResultType.SPHERE:var B=localStorage.getItem("DMUMeasureSphereRadiusPreferences");var A=(B=="DisplayRadius"?true:false);this._vAssistantPosition=this._measure.getAttribute("vCenter").clone();if(this._measure.getAttribute("bRadiusDisplay")!=A){this._measure.setAttribute("bRadiusDisplay",A)}break;case m.ResultType.PRODUCT:this._vAssistantPosition=this._measure.getAttribute("vCog").clone();break}this._setCreationState()},_measureBetween:function(){this._measure.setMeasurable(2,this._measurable[1]);this._measure.setAttribute("sResultingType1",this.retrieveBetweenResultType(this._measure.getAttribute("sSelectedType1"),this._measure.getAttribute("sSelectedType2")));this._measure.setAttribute("sResultingType2",this.retrieveBetweenResultType(this._measure.getAttribute("sSelectedType2"),this._measure.getAttribute("sSelectedType1")));this._measure.update();this._vAssistantPosition=this._measure.getAttribute("vSecondExtensionPoint3D").clone();this._setCreationState();this._measure.setClippingControlPoints()},_measureThreePoints:function(){this._measure.setMeasurable(3,this._measurable[2]);this._measure.update();this._setCreationState()},_setCreationState:function(){var A={};var B=this._measure._parameters.length;for(var C=0;C<B;C++){var D=this._measure._parameters[C];if(D.isOverloadable){A[D.name]=this._measure.getAttribute(D.name)}}this._measure.setCreationState(A)},retrievePossibleSelectedType:function(A){var C=[];var B=A.getType();if((B===s.GeometryType.POINT)||(B===s.GeometryType.PICKINGPT)){C.push(m.ViewedType.POINT)}else{if(B===s.GeometryType.PLANE){C.push(m.ViewedType.INFPLANE);C.push(m.ViewedType.POINT);C.push(m.ViewedType.SURFACE)}else{if(B===s.GeometryType.CYLINDER){C.push(m.ViewedType.CYCOSP);C.push(m.ViewedType.AXIS);C.push(m.ViewedType.POINT);C.push(m.ViewedType.SURFACE)}else{if(B===s.GeometryType.CONE){C.push(m.ViewedType.CYCOSP);C.push(m.ViewedType.AXIS);C.push(m.ViewedType.POINT);C.push(m.ViewedType.SURFACE)}else{if(B===s.GeometryType.SPHERE){C.push(m.ViewedType.CYCOSP);C.push(m.ViewedType.CENTER);C.push(m.ViewedType.POINT);C.push(m.ViewedType.SURFACE)}else{if(B===s.GeometryType.LINE){C.push(m.ViewedType.CURVE);C.push(m.ViewedType.AXIS);C.push(m.ViewedType.POINT)}else{if(B===s.GeometryType.CIRCLE){C.push(m.ViewedType.CIRCLE);C.push(m.ViewedType.CENTER);C.push(m.ViewedType.POINT);C.push(m.ViewedType.CURVE)}else{if(B===s.GeometryType.CURVE){C.push(m.ViewedType.CURVE);C.push(m.ViewedType.POINT)}else{if(B===s.GeometryType.SURFACE){C.push(m.ViewedType.SURFACE);C.push(m.ViewedType.POINT)}}}}}}}}}C.push(m.ViewedType.PRODUCT);return C},retrieveItemResultType:function(A,C){var B=m.ResultType.POINT;if(C===m.ViewedType.POINT){B=m.ResultType.POINT}else{if(C===m.ViewedType.PRODUCT){B=m.ResultType.PRODUCT}else{switch(A){case s.GeometryType.POINT:B=m.ResultType.POINT;break;case s.GeometryType.PICKINGPT:B=m.ResultType.POINT;break;case s.GeometryType.LINE:if(C===m.ViewedType.AXIS){B=m.ResultType.AXIS}else{B=m.ResultType.LINE}break;case s.GeometryType.CIRCLE:if(C===m.ViewedType.CENTER){B=m.ResultType.CENTER}else{if(C===m.ViewedType.CURVE){B=m.ResultType.CURVE}else{B=m.ResultType.CIRCLE}}break;case s.GeometryType.CURVE:B=m.ResultType.CURVE;break;case s.GeometryType.PLANE:if(C===m.ViewedType.SURFACE){B=m.ResultType.SURFACE}else{B=m.ResultType.PLANE}break;case s.GeometryType.CYLINDER:if(C===m.ViewedType.AXIS){B=m.ResultType.AXIS}else{if(C===m.ViewedType.SURFACE){B=m.ResultType.SURFACE}else{B=m.ResultType.CYLINDER}}break;case s.GeometryType.CONE:if(C===m.ViewedType.AXIS){B=m.ResultType.AXIS}else{if(C===m.ViewedType.SURFACE){B=m.ResultType.SURFACE}else{B=m.ResultType.CONE}}break;case s.GeometryType.SPHERE:if(C===m.ViewedType.CENTER){B=m.ResultType.CENTER}else{if(C===m.ViewedType.SURFACE){B=m.ResultType.SURFACE}else{B=m.ResultType.SPHERE}}break;case s.GeometryType.SURFACE:B=m.ResultType.SURFACE;break}}}return B},retrieveBetweenResultType:function(C,A){var B=m.ResultType.POINT;switch(C){case m.ViewedType.POINT:B=m.ResultType.POINT;break;case m.ViewedType.CENTER:B=m.ResultType.POINT;break;case m.ViewedType.AXIS:if((A===m.ViewedType.POINT)||(A===m.ViewedType.CENTER)||(A===m.ViewedType.AXIS)||(A===m.ViewedType.INFPLANE)){B=m.ResultType.AXIS}else{B=m.ResultType.CURVE}break;case m.ViewedType.CURVE:B=m.ResultType.CURVE;break;case m.ViewedType.INFPLANE:if((A===m.ViewedType.POINT)||(A===m.ViewedType.CENTER)||(A===m.ViewedType.AXIS)||(A===m.ViewedType.INFPLANE)){B=m.ResultType.PLANE}else{B=m.ResultType.SURFACE}break;case m.ViewedType.SURFACE:B=m.ResultType.SURFACE;break;case m.ViewedType.PRODUCT:B=m.ResultType.PRODUCT;break;case m.ViewedType.CIRCLE:B=m.ResultType.CURVE;break;case m.ViewedType.CYCOSP:B=m.ResultType.SURFACE;break}return B},_createFilter:function(){var A=this;this._filterUI=new o({body:this._frmWindow.getUIFrame(),frmWindow:this._frmWindow,title:"Filter Control",typeSeparator:"bubble",actionBar:this._frmWindow.getActionBar(),lJsonElement:[{nls:this._nlscmd.point,url:this._iconDir+"I_Meas_Point.png",id:"pickpoint",type:"element",callback:function(){if(A._filterUI.getActiveState("pickpoint")){A._activeFilter="pointOnly"}else{A._activeFilter="SeveralGeometries"}A._filteredGeometries=A._updateFilter(A._filterUI)},bexclude:true,bstateActif:((this._arguments[0].ID==="3dPlay")||(this._arguments[0].ID==="Geovia"))},{type:"separator"},{nls:this._nlscmd.center+"/"+this._nlscmd.point,url:this._iconDir+"I_Meas_PointCircle.png",id:"center",type:"element",callback:function(){A._activeFilter="SeveralGeometries";A._filteredGeometries=A._updateFilter(A._filterUI)},bexclude:false,bstateActif:false},{nls:this._nlscmd.line+"/"+this._nlscmd.curve,url:this._iconDir+"I_Meas_LineCurve.png",id:"linecurve",type:"element",callback:function(){A._activeFilter="SeveralGeometries";A._filteredGeometries=A._updateFilter(A._filterUI)},bexclude:false,bstateActif:false},{nls:this._nlscmd.axis+"/"+this._nlscmd.infiniteline,url:this._iconDir+"I_Meas_AxisInfiniteLine.png",id:"axis",type:"element",callback:function(){A._activeFilter="SeveralGeometries";A._filteredGeometries=A._updateFilter(A._filterUI)},bexclude:false,bstateActif:false},{nls:this._nlscmd.circle,url:this._iconDir+"I_WebMarkerCircle.png",id:"circle",type:"element",callback:function(){A._activeFilter="SeveralGeometries";A._filteredGeometries=A._updateFilter(A._filterUI)},bexclude:false,bstateActif:false},{nls:this._nlscmd.surface,url:this._iconDir+"I_Meas_Surface.png",id:"surface",type:"element",callback:function(){A._activeFilter="SeveralGeometries";A._filteredGeometries=A._updateFilter(A._filterUI)},bexclude:false,bstateActif:(this._arguments[0].ID==="Thickness")},{nls:this._nlscmd.plane,url:this._iconDir+"I_Meas_Plane.png",id:"plane",type:"element",callback:function(){A._activeFilter="SeveralGeometries";A._filteredGeometries=A._updateFilter(A._filterUI)},bexclude:false,bstateActif:false},{nls:this._nlscmd.cylinder+"/"+this._nlscmd.cone+"/"+this._nlscmd.sphere,url:this._iconDir+"I_Meas_Cylinder.png",id:"cylinder",type:"element",callback:function(){A._activeFilter="SeveralGeometries";A._filteredGeometries=A._updateFilter(A._filterUI)},bexclude:false,bstateActif:false},{type:"separator"},{nls:this._nlscmd.product,url:this._iconDir+"I_Meas_Product.png",id:"product",type:"element",callback:function(){if(A._filterUI.getActiveState("product")){A._activeFilter="productOnly"}else{A._activeFilter="SeveralGeometries"}A._filteredGeometries=A._updateFilter(A._filterUI)},bexclude:true,bstateActif:false}]});this._filterUI.build()},_updateFilter:function(B){var A={acceptedGeometries:[],viewedGeometries:[]};if(B.getActiveState("pickpoint")){A.viewedGeometries.push(m.ViewedType.POINT)}else{if(B.getActiveState("product")){A.viewedGeometries.push(m.ViewedType.PRODUCT)}else{if(B.getActiveState("center")){A.acceptedGeometries.push(s.GeometryType.CIRCLE);A.acceptedGeometries.push(s.GeometryType.SPHERE);A.viewedGeometries.push(m.ViewedType.CENTER)}if(B.getActiveState("linecurve")){A.acceptedGeometries.push(s.GeometryType.LINE);A.acceptedGeometries.push(s.GeometryType.CIRCLE);A.acceptedGeometries.push(s.GeometryType.CURVE);A.viewedGeometries.push(m.ViewedType.CURVE)}if(B.getActiveState("axis")){A.acceptedGeometries.push(s.GeometryType.LINE);A.acceptedGeometries.push(s.GeometryType.CYLINDER);A.acceptedGeometries.push(s.GeometryType.CONE);A.viewedGeometries.push(m.ViewedType.AXIS)}if(B.getActiveState("circle")){A.acceptedGeometries.push(s.GeometryType.CIRCLE);A.viewedGeometries.push(m.ViewedType.CIRCLE)}if(B.getActiveState("surface")){A.acceptedGeometries.push(s.GeometryType.CYLINDER);A.acceptedGeometries.push(s.GeometryType.CONE);A.acceptedGeometries.push(s.GeometryType.SPHERE);A.acceptedGeometries.push(s.GeometryType.PLANE);A.acceptedGeometries.push(s.GeometryType.SURFACE);A.viewedGeometries.push(m.ViewedType.SURFACE)}if(B.getActiveState("plane")){A.acceptedGeometries.push(s.GeometryType.PLANE);A.viewedGeometries.push(m.ViewedType.INFPLANE)}if(B.getActiveState("cylinder")){A.acceptedGeometries.push(s.GeometryType.CYLINDER);A.acceptedGeometries.push(s.GeometryType.CONE);A.acceptedGeometries.push(s.GeometryType.SPHERE);A.viewedGeometries.push(m.ViewedType.CYCOSP)}}}this._pathElementAgentWithCSO.options.acceptedGeometries=A.acceptedGeometries;this._pathElementAgentWithCSO.options.viewedGeometries=A.viewedGeometries;this._pathElementAgentWithoutCSO.options.acceptedGeometries=A.acceptedGeometries;this._pathElementAgentWithoutCSO.options.viewedGeometries=A.viewedGeometries;return A},_createAssistantTools:function(J){var G=this;function E(){G.publish({event:"OK",data:null})}function H(){G._repeatType="Item";G.publish({event:"repeatitem",data:null})}function C(){G._repeatType="Chain";G.publish({event:"repeatbetween",data:null})}function I(){G._repeatType="Fan";G.publish({event:"repeatbetween",data:null})}function D(){G._bKeepall=!G._bKeepall}function B(){G._threepoints="Angle";G.publish({event:"threepoints",data:null})}function A(){G._threepoints="Circle";G.publish({event:"threepoints",data:null})}var F=[];if((J.bOK!==undefined)&&J.bOK){F.push({nls:this._nlscmd.ok,url:this._iconDir+"I_Validate.png",id:"OK",callback:E,bstateActif:false})}if((J.bRepeatitem!==undefined)&&J.bRepeatitem){F.push({nls:this._nlscmd.repeatitem,url:this._iconDir+"I_Repeat.png",id:"Repeat",callback:H,bstateActif:false})}if((J.bRepeatbetweenChain!==undefined)&&J.bRepeatbetweenChain){F.push({nls:this._nlscmd.repeatchain,url:this._iconDir+"I_ChainedMeasure.png",id:"Chain",callback:C})}if((J.bRepeatbetweenFan!==undefined)&&J.bRepeatbetweenFan){F.push({nls:this._nlscmd.repeatfan,url:this._iconDir+"I_FanMeasure.png",id:"Fan",callback:I})}if((J.bKeeponlylast!==undefined)&&J.bKeeponlylast){F.push({nls:this._nlscmd.keepprevious,url:this._iconDir+"I_KeepOnlyLast.png",id:"Keep",callback:D,bstateActif:this._bKeepall})}if((J.bAnglethreepoints!==undefined)&&J.bAnglethreepoints){F.push({nls:this._nlscmd.anglethreepoints,url:this._iconDir+"I_MeasureAngle3Points.png",id:"Angle3Points",callback:B})}if((J.bCirclethreepoints!==undefined)&&J.bCirclethreepoints){F.push({nls:this._nlscmd.circlethreepoints,url:this._iconDir+"I_MeasureArc3Points.png",id:"Arc3Points",callback:A})}this.assistantTools=new x({body:this._frmWindow.getUIFrame(),viewer:this._viewer,frmWindow:this._frmWindow,title:"Assistant tools Control",position:this._vAssistantPosition,mode:"curve",dir:"bottom",lJsonElement:F});this.assistantTools.build()},_removeAssistantTools:function(){if(this.assistantTools){this.assistantTools.clear();this.assistantTools=undefined}if(this._tokenVISUEvent){v.unsubscribe(this._tokenVISUEvent);this._tokenVISUEvent=null}},_isItMeasurable:function(B){var D=false;if(B!==undefined){var C=n.getFirstReference(B);if(C.externalPath.length>0){D=true}else{var A=z.getReviewContext({viewer:this.getFrameWindow().getViewer()}).getCurrentReview().getDMUObjectFromPathElement(B,true);D=(A&&B.getLastElement(true).measurable===true)}}return D},_lockNode:function(A){if(this._viewerController&&A){var B=n.getLastRepReference(A.getPathElement());if(null===B){B=n.getLastReference(A.getPathElement())}if(B){var C=B.getLastElement();if(C){var D=n.getNodeID(C);if(!this._measure.isNodeLocked(D)){this._viewerController.lockNodes({ids:[D]});this._measure.addLockedNode(D)}}}}}});return c});define("DS/DMUMeasure/DMUMeasureExport",["UWA/Class","DS/DMUBaseExperience/EXPUtils"],function(a,b){return a.extend({init:function(c){this.exportData=function(e,f){if(e&&c){e.writeObjectAttributes(c,f);f.measurables=[];for(var d=1;d<=3;d++){if(c.getMeasurable(d)){f.measurables.push(c.getMeasurable(d).exportData(b.typeToStr))}}}}}})});define("DS/DMUMeasure/DMUMeasureContextualBar",["DS/DMUBaseUI/DMUContextualBarAdapter","DS/DMUBaseExperience/DMUContextManager","DS/DMUMeasurable/DMUMeasureEnums","DS/Visualization/ThreeJS_DS"],function(a,d,b,c){return a.extend({getSharedContextualCommandList:function(f){var e=[];if(f&&f.length){f.forEach(function(g){if(e.indexOf(g.GetType())===-1){e.push(g.GetType())}})}if(e.length===1&&e[0].indexOf("DMUMeasure")!==-1){return this.getContextualCommandList(f[0])}return[]},getContextualCommandList:function(g){var f=null;if(g&&!g.isReadOnly()&&g.isInEdition()){var m="Measure_DMUDefaultStyleHdr";if(g.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new c.Color("#000000")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new c.Color("#ffffff")},{name:"bIsFilled",value:false},{name:"bHasBorder",value:false},{name:"fLineStyleThickness",value:1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new c.Color("#3d3d3d")},{name:"fLeaderStyleThickness",value:1},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new c.Color("#3d3d3d")}])){m="Measure_DMULightStyleHdr"}else{if(g.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new c.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new c.Color("#368ec4")},{name:"bIsFilled",value:true},{name:"bHasBorder",value:false},{name:"fLineStyleThickness",value:1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new c.Color("#3d3d3d")},{name:"fLeaderStyleThickness",value:1},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new c.Color("#3d3d3d")}])){m="Measure_DMUMeasureStyleHdr"}else{if(g.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new c.Color("#000000")},{name:"sFontStyle",value:"italic"},{name:"cFillStyleColor",value:new c.Color("#fee000")},{name:"bIsFilled",value:true},{name:"bHasBorder",value:false},{name:"fLineStyleThickness",value:1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new c.Color("#ff8a2e")},{name:"fLeaderStyleThickness",value:1},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new c.Color("#ff8a2e")}])){m="Measure_DMUPostitStyleHdr"}else{if(g.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new c.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new c.Color("#57b847")},{name:"bIsFilled",value:true},{name:"bHasBorder",value:false},{name:"fLineStyleThickness",value:1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new c.Color("#477738")},{name:"fLeaderStyleThickness",value:1},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new c.Color("#477738")}])){m="Measure_DMUValidateStyleHdr"}else{if(g.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new c.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new c.Color("#ff8a2e")},{name:"bIsFilled",value:true},{name:"bHasBorder",value:false},{name:"fLineStyleThickness",value:1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new c.Color("#8f4c00")},{name:"fLeaderStyleThickness",value:1},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new c.Color("#8f4c00")}])){m="Measure_DMUWarningStyleHdr"}else{if(g.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new c.Color("#ffffff")},{name:"sFontStyle",value:"bold"},{name:"cFillStyleColor",value:new c.Color("#cc092f")},{name:"bIsFilled",value:true},{name:"bHasBorder",value:false},{name:"fLineStyleThickness",value:1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new c.Color("#6d2828")},{name:"fLeaderStyleThickness",value:1},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new c.Color("#6d2828")}])){m="Measure_DMUCautionStyleHdr"}}}}}}var o="Measure_DMUNoBorderTypeHdr";if(g.compareAttributes([{name:"bHasBorder",value:true},{name:"sLineStylePattern",value:"1"}])){o="Measure_DMUBorder1TypeHdr"}else{if(g.compareAttributes([{name:"bHasBorder",value:true},{name:"sLineStylePattern",value:"2"}])){o="Measure_DMUBorder2TypeHdr"}else{if(g.compareAttributes([{name:"bHasBorder",value:true},{name:"sLineStylePattern",value:"3"}])){o="Measure_DMUBorder3TypeHdr"}else{if(g.compareAttributes([{name:"bHasBorder",value:true},{name:"sLineStylePattern",value:"4"}])){o="Measure_DMUBorder4TypeHdr"}else{if(g.compareAttributes([{name:"bHasBorder",value:true},{name:"sLineStylePattern",value:"5"}])){o="Measure_DMUBorder5TypeHdr"}else{if(g.compareAttributes([{name:"bHasBorder",value:true},{name:"sLineStylePattern",value:"6"}])){o="Measure_DMUBorder6TypeHdr"}else{if(g.compareAttributes([{name:"bHasBorder",value:true},{name:"sLineStylePattern",value:"7"}])){o="Measure_DMUBorder7TypeHdr"}}}}}}}var j="Measure_DMUBorder1SizeHdr";if(g.compareAttributes([{name:"fLineStyleThickness",value:2},{name:"fLeaderStyleThickness",value:2}])){j="Measure_DMUBorder2SizeHdr"}else{if(g.compareAttributes([{name:"fLineStyleThickness",value:3},{name:"fLeaderStyleThickness",value:3}])){j="Measure_DMUBorder3SizeHdr"}else{if(g.compareAttributes([{name:"fLineStyleThickness",value:4},{name:"fLeaderStyleThickness",value:4}])){j="Measure_DMUBorder4SizeHdr"}else{if(g.compareAttributes([{name:"fLineStyleThickness",value:5},{name:"fLeaderStyleThickness",value:5}])){j="Measure_DMUBorder5SizeHdr"}else{if(g.compareAttributes([{name:"fLineStyleThickness",value:6},{name:"fLeaderStyleThickness",value:6}])){j="Measure_DMUBorder6SizeHdr"}else{if(g.compareAttributes([{name:"fLineStyleThickness",value:7},{name:"fLeaderStyleThickness",value:7}])){j="Measure_DMUBorder7SizeHdr"}else{if(g.compareAttributes([{name:"fLineStyleThickness",value:8},{name:"fLeaderStyleThickness",value:8}])){j="Measure_DMUBorder8SizeHdr"}}}}}}}if(g._typeApps==="3dPlay"||g._typeApps==="Geovia"){return[{name:"DMUMeasureDeleteStr",line:1,hdr_list:["DMUMeasureDeleteHdr"]}]}var k=[{name:"Measure_DMUStylesStr",line:1,hdr_list:["Measure_DMUDefaultStyleHdr","Measure_DMULightStyleHdr","Measure_DMUMeasureStyleHdr","Measure_DMUPostitStyleHdr","Measure_DMUValidateStyleHdr","Measure_DMUWarningStyleHdr","Measure_DMUCautionStyleHdr"],selectedHdr:m},{name:"Measure_DMUIncreaseFontSizeStr",line:1,hdr_list:["Measure_DMUIncreaseFontSizeHdr"]},{name:"Measure_DMUDecreaseFontSizeStr",line:1,hdr_list:["Measure_DMUDecreaseFontSizeHdr"]},{name:"fillGraphicProperties",line:1,hdr_list:["Measure_DMUFillGraphicPropHdr"]},{name:"borderLineTypes",line:1,hdr_list:["Measure_DMUNoBorderTypeHdr","Measure_DMUBorder1TypeHdr","Measure_DMUBorder2TypeHdr","Measure_DMUBorder3TypeHdr","Measure_DMUBorder4TypeHdr","Measure_DMUBorder5TypeHdr","Measure_DMUBorder6TypeHdr","Measure_DMUBorder7TypeHdr"],selectedHdr:o},{name:"borderSizes",line:1,hdr_list:["Measure_DMUBorder1SizeHdr","Measure_DMUBorder2SizeHdr","Measure_DMUBorder3SizeHdr","Measure_DMUBorder4SizeHdr","Measure_DMUBorder5SizeHdr","Measure_DMUBorder6SizeHdr","Measure_DMUBorder7SizeHdr","Measure_DMUBorder8SizeHdr"],selectedHdr:j},{name:"borderColor",line:1,hdr_list:["Measure_DMUBorderGraphicPropHdr"]}];var i=[{name:"DMUMeasureDisplayStr",line:1,hdr_list:["DMUMeasureDisplayHdr"]}];var h=d.getReviewContext({viewer:g._viewer});var l=h.getUIManager().getSelectedObjects();var e=true;for(var n=0;n<l.length;n++){if((l[n]._sResultingType1!==b.ResultType.CIRCLE)&&(l[n]._sResultingType1!==b.ResultType.CYLINDER)&&(l[n]._sResultingType1!==b.ResultType.SPHERE)&&(l[n]._sType!=="Measure3PointsCircle")){e=false;break}}if(e){i.push({name:"DMUMeasureDiameterOrRadiusStr",line:1,hdr_list:["DMUMeasureDiameterHdr","DMUMeasureRadiusHdr"],selectedHdr:g.compareAttributes([{name:"bRadiusDisplay",value:true}])?"DMUMeasureRadiusHdr":"DMUMeasureDiameterHdr"})}f=i.concat(k);if(g._typeApps==="3dAuthoring"){f=f.concat([{name:"DMUMeasureDeleteStr",line:1,hdr_list:["DMUMeasureDeleteHdr"]}])}}return f},getSharedHeaderTypes:function(){return{fontProperties:true}},register:function(e){this._parent({type:"DMUMeasure",module:"DMUMeasure",workbenchName:"DMUMeasure",frmWindow:e.frmWindow})}})});define("DS/DMUMeasure/DMUMeasureContextCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/DMUBaseExperience/DMUContextManager"],function(c,a,b){return c.extend({init:function(e){var d=e||{};d.mode=d.ID!=="DMUMeasureDeleteHdr"?"shared":"exclusive";this._parent(d)},beginExecute:function(){var e=a.get();if(e.length===1){var f=b.getReviewContext({viewer:this.getFrameWindow().getViewer()});if(f){var d=f.getCurrentReview().getDMUObjectFromPathElement(e[0].pathElement);if(d){switch(this._id){case"DMUMeasureDiameterHdr":d.setAttribute("bRadiusDisplay",false);d.updateGlobalRadiusPreference(false);break;case"DMUMeasureRadiusHdr":d.setAttribute("bRadiusDisplay",true);d.updateGlobalRadiusPreference(true);break;case"DMUMeasureDisplayHdr":d.setAttribute("bShortDisplay",!d.getAttribute("bShortDisplay"));d.showContextualBar();break;case"DMUMeasureDeleteHdr":d.measureCancel();break}}d.refreshNode()}}}})});