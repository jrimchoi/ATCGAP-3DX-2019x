/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtx",[],function(){});define("DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager",["UWA/Class","DS/PADUtils/PADTypesMgt","DS/DibWebUtils/DibFavoriteContextAccess","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/UIKIT/Modal","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Button","DS/PADUtils/PADUtilsServices","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(s,i,l,n,f,c,m,k,j,g){var q=["3DShape"],e,t,d,b,a,p,o;require(["i18n!DS/CAT3DAnnotationFavoriteCtx/assets/nls/CAT3DAnnotationFavoriteCtx"],function(u){e=u.rootInSession;t=u.noFavoriteContext;d=u.checkTitle;b=u.checkConfirm;a=u.checkButton;p=u.checkYes;o=u.checkNo});var r=s.extend({init:function(D){var u=D.context,y=0,z;function C(H,F){var G={other:[],favCtxt:[]};try{i.retrieveAuthorizedObjects({displayNotif:false,X3DContentId:H.x3dContent,dnd_event:H.event,version:"2.0",callback:function(I){(I.unauthorized_objects||[]).forEach(function(J){G.other.push(J)});Object.keys(I.authorizedWithKind).forEach(function(J){if(J==="Product"){I.authorizedWithKind.Product.forEach(function(K){if(q.indexOf(K.objectType)===-1){G.other.push(K)}else{G.favCtxt.push(K)}})}else{I.authorizedWithKind[J].forEach(function(K){G.other.push(K)})}});if(I.authorized_objects&&I.authorized_objects.length){j.multiTenantMgt(I.authorized_objects,g.getRoots(u),function(J){if(!J.isMultiTenant){F(G)}})}else{F(G)}}})}catch(E){F(G)}}function B(H,E){y++;var G=[],F=H.length;if(!H.length){E(G);return}H.forEach(function(J){var I={data:J,rootID:null,instances:null,filters:null};G.push(I);l.getFavoriteContextInfos({ObjectPhysicalid:J.objectId,onComplete:function(K){F--;if(!K.Error&&K.RootObject){I.rootID=K.RootObject.physicalid;I.instances=K.PathOfInstances.map(function(L){return L.physicalid})}if(F===0){E(G)}},onFailure:function(){F--;if(F===0){E(G)}}})})}function x(H){var G;var F=false,E=[],I=[];E.push("<p>"+b+"</p>");E.push(new m({name:"fcCheckBox",label:a,value:"value",type:"checkbox",className:"primary"}));I.push(new k({className:"primary",value:p,events:{onClick:function(){if(E[1].isChecked()){f.setPreference("FavoriteContextLoadMode","0")}G.hide();F=true;if(H.onOkCB){H.onOkCB()}}}}));I.push(new k({className:"default",value:o,events:{onClick:function(){if(E[1].isChecked()){f.setPreference("FavoriteContextLoadMode","0")}G.hide();F=true;if(H.onCancelCB){H.onCancelCB()}}}}));G=new c({closable:true,escapeToClose:true,visible:true,overlay:true,renderTo:document.body,header:d,body:E,footer:I,events:{onHide:function(){if(!F&&H.onHideCB){H.onHideCB()}G.destroy();G=null}}});G.getHeader().setStyle("text-align","left");G.getBody().setStyle("text-align","left")}function w(G){var E=Boolean(G.event),H=G.event?!G.event.shiftKey:true,F=g.getRoots(u).map(function(I){return g.getNodeID(I)?g.getNodeID(I):undefined});C(G,function(I){if(I.other.length){D.addRootNodesFromContent?D.addRootNodesFromContent(I.other):u.addRootNodesFromContent({json3DXContent:{data:{items:I.other}},dispatch:true,inContext:H})}B(I.favCtxt,function(O){var M=[],N=[],J=false,K=false,L=[];O.forEach(function(Q,P){if(!Q.rootID){K=true;O.splice(P,1);M.push({path:Q.data.path&&H?Q.data.path.map(function(R){return R.resourceid}):[Q.data.objectId]});return}L.push({origin:Q.data.objectId,root:Q.rootID,instances:Q.instances});if(F.indexOf(Q.rootID)>-1){O.splice(P,1);J=true;return}else{if(N.indexOf(Q.rootID)===-1&&!M.some(function(R){return R[0]===Q.rootID})){N.push(Q.rootID)}}});if(K){u.displayNotification({msg:t,eventID:"info"})}if(J){u.displayNotification({msg:e,eventID:"info"})}if(N.length&&f.getPreference("FavoriteContextLoadMode")==="1"){x({onOkCB:function(){if(L.length&&z){z.publish({event:"onFavoriteContextLoading",data:L})}D.addRoots?D.addRoots(N.map(function(P){return{path:[P]}})):u.addRoots({objects:N.map(function(P){return{path:[P]}})},E)},onCancelCB:function(){D.addRoots?D.addRoots(O.map(function(Q){var P=Q.data.path&&H?Q.data.path.map(function(R){return R.resourceid}):[Q.data.objectId];return{path:P}})):u.addRoots({objects:O.map(function(Q){var P=Q.data.path&&H?Q.data.path.map(function(R){return R.resourceid}):[Q.data.objectId];return{path:P}})},E)},onHideCB:function(){if(M.length===0&&g.getRoots(u).length===0&&u._dropZoneContainer){u._dropZoneContainer.show("drop")}}})}else{N.forEach(function(P){M.push({path:[P]})});if(L.length&&z){z.publish({event:"onFavoriteContextLoading",data:L})}}if(M.length){D.addRoots?D.addRoots(M):u.addRoots({objects:M},E)}else{if(N.length===0&&g.getRoots(u).length===0&&u._dropZoneContainer){u._dropZoneContainer.show("drop")}}})})}function A(H){if(f.getPreference("FavoriteContextLoadMode")==="2"){return}var F=j.deserializeDroppedData(H);if(F&&F.data&&F.data.items.length===1&&F.data.items[0].objectType==="Document"){return}H.preventDefault();H.stopPropagation();if(u._dropZoneContainer){u._dropZoneContainer.hide()}u.elements.container.removeClassName("bordered");var E=document.getElementById("pad_invite");if(E){E.setStyle("display","none")}E=document.getElementById("background_container");if(E){E.setStyle("display","none")}var G=document.getElementById("canvas-div");if(G){G.removeClassName("drag_over_class")}w({event:H})}this.managePath=function(J,I){if(I&&f.getPreference("FavoriteContextLoadMode")==="2"){return undefined}var F=J.path.getLastElement(true),G=g.getNodeType(F)?g.getNodeType(F):null;if(q.indexOf(G)>-1){var K=g.getNodeID(F),H=y+1,E=false;B([{objectId:K}],function(M){if(H===y){if(M[0].rootID){var L=function(){var N=M[0].rootID;if(!J.path.externalPath.some(function(O){return O&&g.getNodeID(O)===N})){if(g.getRoots(u).map(function(O){return g.getNodeID(O)}).indexOf(N)===-1){if(g.getNodeID(J.path.externalPath[1])===K){u.removeRoots({pids:[K]})}if(z){z.publish({event:"onFavoriteContextLoading",data:[{origin:K,root:M[0].rootID,instances:M[0].instances}]})}D.addRoots?D.addRoots([{path:[N]}]):u.addRoots({objects:[{path:[N]}]},true)}else{u.displayNotification({msg:e,eventID:"info"})}}else{u.displayNotification({msg:e,eventID:"info"})}};if(I&&f.getPreference("FavoriteContextLoadMode")==="1"){x({onOkCB:L})}else{L()}}else{u.displayNotification({msg:t,eventID:"info"})}}if(J.onComplete){J.onComplete()}E=true});return{cancel:E?null:function(){H=null}}}else{if(J.onComplete){J.onComplete()}}return{}};this.manageX3DContentId=function(E){if(f.getPreference("FavoriteContextLoadMode")==="2"){return u.addRootNodesFromContent({json3DXContent:E.x3dContentId,dispatch:false})}w({x3dContent:E.x3dContentId});return null};var v=false;this.activateDrop=function(){if(!v&&u.getViewer()){u.getViewer().canvas.addEventListener("drop",A);v=true}};this.subscribe=function(E,F){if(!z){z=new n()}return z.subscribe(E,F)};this.unsubscribe=function(E){if(z){return z.unsubscribe(E)}return 0};this.unreference=function(){if(v){u.getViewer().canvas.removeEventListener("drop",A)}if(z){z.destroy()}u=z=null;v=false}}});var h=[];return s.singleton({init:function(){},getFavoriteContextManager:function(w){var y;if(w&&w.context&&w.context.name==="ENOPAD3DViewer"){for(var u=0;u<h.length;u++){if(h[u].context===w.context){y=h[u].favoriteCtxManager;break}}if(!y){var x=new r(w);var v={unreference:function(){if(!x){return}x.unreference();v=x=null},manageFavoriteContext:function(z,A){if(!x){return undefined}if(z.path){return x.managePath(z,A)}else{if(z.x3dContentId){return x.manageX3DContentId(z)}}return undefined},activateDrop:function(){if(!x){return undefined}return x.activateDrop()},subscribe:function(z,A){if(!x){return undefined}return x.subscribe(z,A)},unsubscribe:function(z){if(!x){return undefined}return x.unsubscribe(z)}};h.push({context:w.context,favoriteCtxManager:v});y=v}}return y},giveFavoriteContextManager:function(v){if(v&&v.context&&v.context.name==="ENOPAD3DViewer"){for(var u=0;u<h.length;u++){if(h[u].context===v.context){return h[u].favoriteCtxManager}}}return undefined},unreferenceFavoriteContextManager:function(v){if(v&&v.context&&v.context.name==="ENOPAD3DViewer"){for(var u=0;u<h.length;u++){if(h[u].context===v.context){h[u].favoriteCtxManager.unreference();h.splice(u,1);return}}}}})});