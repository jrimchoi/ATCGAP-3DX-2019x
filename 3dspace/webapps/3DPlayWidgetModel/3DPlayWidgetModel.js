define("DS/3DPlayWidgetModel/W3DPlayModel",["UWA/Class","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/CoreEvents/Events","DS/WebSystem/Environment","i18n!DS/3DPlayWidget/assets/nls/3DPlayWidget"],function(b,f,c,e,g){var a;var d=b.extend({init:function(i){var h=this;a=i;this.allWidgetMessage=g;this.boxMessage=this.constructBoxMessageData();this.setBoxMessageText();this.objIdx=0;this.availableExperiences=[];this.availableServices=[];this.currentContent;this.emptyOrDefaultModel=true;this.curAsset;this.curProvider;this.canvasDivRef;this.x3d;this.currentCSO;this.plateformPromise=this.getAllPlatformServices();this.plateformPromise.then(function(j){h.availableServices=j},function(j){console.error("getAllPlatformServices Error!");console.dir(j)})},dispose:function(){},getPreferencesFromSwitchApp:function(){var l=a.getValue("afrExecutionContexts");var h=a.getValue("pad_tenant");var k=a.getValue("pad_security_ctx");var i=a.getValue("PAD3DViewerPathsInSession");var j={afrExecutionContexts:l,pad_tenant:h,pad_security_ctx:k,PAD3DViewerPathsInSession:i};return j},getCollabSpacePref:function(){var h=a.getValue("CollabSpacePref");return h},getX3dContentPref:function(){var h=a.getValue("X3DContentId");return h},getSelectedExperiencePref:function(){var j=a.getValue("selectedExperience");var i=e.get("3DPlay.OverrideSettings");if(i){var h=JSON.parse(i);if(h.hasOwnProperty("input")){if(h.input.hasOwnProperty("experience")){console.log("-----  OverrideSettings ---- ",h.input["experience"]["filename"])}j=h.input["experience"]["filename"];return j}}if(j==undefined){return false}return j},getCurrentExperience:function(){return this.getCurrentData(0).selectedExperience},getSwymModelIdPref:function(){var h=a.getValue("MODELID");return h},getSwymTenantIdPref:function(){var h=a.getValue("swymTenantId");return h},getW3DPlayContentPref:function(){var h=a.getValue("W3DPlayContent");return h},getCurrentContent:function(){return this.currentContent},getCurrentData:function(h){if(this.currentContent===undefined){return false}else{if(!UWA.is(h)){h=0}return this.currentContent.data["items"][h]}},getCurrentProvider:function(){if(this.currentContent){return this.currentContent.data["items"][0]["serviceId"]}return""},getWidgetMessage:function(h){if(UWA.is(h,"string")){if(this.allWidgetMessage[h]){return this.allWidgetMessage[h]}else{console.error("Unable to find Nls key for :",h)}}else{console.error("Invalid nls key > ",h)}},getAllPlatformServices:function(){return new Promise(function(i,h){f.getServiceUrl({serviceName:"3DSpace",onComplete:function(j){i(j)},onFailure:function(j){h(j);console.error("Error in i3DXCompassServices.getPlatformServices :",j)}})})},get3DSpaceServiceUrl:function(i){var h=false;if(i&&UWA.is(i,"string")){this.availableServices.forEach(function(j){if(j.platformId===i){h=j.url}})}return h},constructBoxMessageData:function(){return{invite_msgDom:"",invite_imgDom:"",DEFAULT:{classIcon:"fonticon-block",msg:""},REPLACE:{classIcon:"fonticon-down-circled",msg:""},DROPIT:{classIcon:"fonticon-down-circled",msg:""},ERROR:{classIcon:"fonticon-block",msg:""}}},getBoxMessageData:function(){return this.boxMessage},getBoxClassIcon:function(h){return this.boxMessage[h].classIcon},getBoxMessageText:function(h){return this.boxMessage[h].msg},getCanvasDiv:function(){return this.canvasDivRef},getDefaultModelIsRunning:function(){return this.emptyOrDefaultModel},getCurrentCSO:function(){return this.currentCSO},setDefaultModelIsRunning:function(h){this.emptyOrDefaultModel=h},setInitialContent:function(h){this.currentContent=h},setCurrentContent:function(i){this.currentContent=i;this.update("Model.changeCurrent");var j=this.getCurrentContent();this.setW3DPlayContent(j);var h=this.getCurrentData();a.setValue("afrProductTitle",h.displayName)},setCurrentAsset:function(h){this.curAsset=h},setAvailableServices:function(h){this.availableServices=h},setCurrentProvider:function(h){this.curProvider=h},setCurrentExperience:function(h){var i=this.getCurrentContent();i.data["items"][0]["selectedExperience"]=h;a.setValue("W3DPlayContent",JSON.stringify(i))},setCurrentTitle:function(h){if(h!==""&&(typeof h!=="undefined")){this.currentContent.data["items"][0]["displayName"]=h;this.update("Model.changeTitle")}},setCanvasDiv:function(h){this.canvasDivRef=h},setW3DPlayContent:function(h){a.setValue("W3DPlayContent",JSON.stringify(h))},saveSwitchAppPreferences:function(k){var h=k.data["items"][0];var l=h.contextId;var i=h.envId;var j=JSON.stringify([[h.objectId]]);a.setValue("pad_tenant",i);a.setValue("pad_security_ctx",l);a.setValue("PAD3DViewerPathsInSession",j)},setCurrentCSO:function(h){this.currentCSO=h;this.update("Model.changeCSO",this.currentCSO)},setPlayerRef:function(h){this.playerRef=h},getPlayerRef:function(){return this.playerRef},setBoxMessageText:function(){this.boxMessage.REPLACE.msg=this.getWidgetMessage("REPLACE_IT_MSG");this.boxMessage.DROPIT.msg=this.getWidgetMessage("DROP_IT_MSG");this.boxMessage.ERROR.msg=this.getWidgetMessage("DROP_ERROR_MSG")},isSwymIdValid:function(h){if(UWA.is(h)&&h!=""&&h!="false"&&typeof h!="undefined"){this.emptyOrDefaultModel=false;return h}else{return false}},isX3DContentIdValid:function(i){if(i&&i!=="undefined"){var h=JSON.parse(i);if(UWA.is(h,"object")){if(h.hasOwnProperty("data")){this.emptyOrDefaultModel=false;return true}return false}}else{return false}},get3DPlayWebInputObject:function(i){var k=this;var j={input:{},options:{loading:"autoplay",callbacks:{experience:{dispose:function(){k=null}},asset:{LoadingFinished:function(){if(k){k.LoadingFinishedCB.apply(k,arguments)}}}}}};if(i){var n=this.getCurrentContent();this.setW3DPlayContent(n);var h=this.getCurrentData();a.setValue("afrProductTitle",h.displayName);var m=this.getAssetFromProvider(i);if(this.drag&&n.source){m.asset.source=n.source}this.drag=false;if(m!==undefined){this.setCurrentAsset(m);j.input=m}}return j},getAssetFromProvider:function(h){var j=h.serviceId.toUpperCase();var i;switch(j){case"3DSWYM":i=this.get3DSwymInput(h);break;case"3DSPACE":i=this.get3DSpaceInput(h);break;case"3DDRIVE":i=this.get3DDriveInput(h);break;case"2DLAYOUT":i=this.get2DLayoutInput(h);break;case"DROPBOX":i=this.getDropboxInput(h);break;case"ONEDRIVE":i=this.getOneDriveInput(h);break;case"FILE":i=h;break;default:console.warn("Missing provider, this must be set! ",j)}return i},getCurrentAsset:function(){return this.curAsset},isLoadingFInished:function(){var h=this.getPlayerRef();if(h&&h.instance&&h.instance.modelLoadComplete){return true}return false},LoadingFinishedCB:function(i){if(this.isPendingLoadingCozNotReady){this.isPendingLoadingCozNotReady=false;this.update("Model.changeCurrent");return}if(i.model!=="3DS_emblem.cgr"){var k=this.getCurrentContent();this.setW3DPlayContent(k);var h=this.getCurrentData();a.setValue("afrProductTitle",h.displayName);var j=this.getCurrentProvider().toUpperCase();if(j==="3DSWYM"){this.get3DSwymTitle(k)}else{if(j==="3DSPACE"){this.saveSwitchAppPreferences(k)}}}},get3DSwymTitle:function(h){var j=this;if(this.x3d){this.x3d.get3DSwymMetaData(h,function(k){j.setCurrentTitle(k.title);j=null},function(k){console.error(k)})}else{var i="DS/3DPlayConnectors/3DSwymConnector";require([i],function(k){j.x3d=new k();j.get3DSwymTitle(h)})}},get2DLayoutInput:function(i){var h={asset:i.asset};h.asset.originalAsset={provider:"3DSPACE",type:"2DLayout"};return h},get3DSwymInput:function(h){var i={asset:{objectId:h.objectId,provider:"3DSwym",envId:h.envId,type:"media",}};return i},get3DDriveInput:function(h){return{asset:{objectId:h.objectId,provider:h.serviceId.toUpperCase(),physicalid:h.objectId,type:h.objectType,dtype:h.objectType,tenant:h.envId}}},get3DSpaceInput:function(h){var i=this.get3DSpaceServiceUrl(h.envId);if(i){return{asset:{provider:"EV6",physicalid:h.objectId,serverurl:i,type:h.objectType,dtype:h.objectType,requiredAuth:"passport",tenant:h.envId,contextid:h.contextId}}}else{console.warn("3DPlay WIDGET : Unable to find 3DSpace Service for Tenant > ",h.envId);return false}},getDropboxInput:function(h){return{asset:{objectId:h.objectId,provider:h.serviceId.toUpperCase(),physicalid:h.objectId,requiredAuth:"passport",type:h.objectType,dtype:h.objectType,tenant:h.envId}}},getOneDriveInput:function(h){return{asset:{objectId:h.objectId,provider:h.serviceId.toUpperCase(),physicalid:h.objectId,requiredAuth:"passport",type:h.objectType,dtype:h.objectType,tenant:h.envId}}},update:function(i,h){c.publish({event:i,data:h})}});return d});