define("DS/VisuTools/CounterNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/TextNode","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/Visualization/SceneGraphFactory"],function(d,f,g,a,b,c){var e=f.extend({init:function(o,k,h){this._parent("FPSCounter");this.viewer=o;this.ratio=4;this.setColor("white");this.fixedSizeNode3D=new b({name:"fixedSizeNode3D",ratio:this.ratio});this.fixedSizeNode3D.setCameraName("robotCameraOrtho");this.addChild(this.fixedSizeNode3D);this.text="null";this.oldColor=null;this.getPosition=k;this.size=h||10;var j=new f("myRobot");var m={type:"Spherical",position:new d.Vector3()};var i=new a(m);var l=c.createCuboidNode({cornerPoint:new d.Vector3(-5,-5,-5),firstAxis:new d.Vector3(10,0,0),secondAxis:new d.Vector3(0,10,0),thirdAxis:new d.Vector3(0,0,10),material:new d.MeshPhongMaterial({color:"red",force:true})});this.textNode=new g();i.addChild(this.textNode);this.token=null;this.textNode.forceBoundingSphere(new d.Sphere(new d.Vector3(0,0,0),1000));j.addChild(this.textNode);this.fixedSizeNode3D.addChild(i);this.onViewpointChange();return this},setColor:function(h){this.color=h},setText:function(i){this.text=i;var h=this.textNode;if(this.token!==null){h.removeText(this.token)}this.token=h.addText({string:i,anchor:new d.Vector3(0,0,0),color:new d.Color(this.color),size:this.size,lineLength:500,up:new d.Vector3(0,1,0),right:new d.Vector3(1,0,0)})},onViewpointChange:function(){var j=this.viewer.currentViewpoint;if(!j){return}j._updateRobotCamera(this.viewer.internalSceneGraph);var l,m,h;h=this.getPosition(this.viewer.canvas.width,this.viewer.canvas.height);m=h.x;l=h.y;function k(o,v){var s=j.robotCameraOrtho;var r=new d.Vector3(o,v,0);var u=new d.Projector();u.unprojectVector(r,s);var t;if(s instanceof d.PerspectiveCamera){var q=new d.Ray(data.cameraEye,r.sub(data.cameraEye).normalize());var p=new d.Plane(this.viewer.currentViewpoint.camera.getLookAt(),0);t=q.intersectPlane(p)}else{t=r}return new d.Matrix4().setPosition(t)}var i;i=k(m,l);this.setMatrix(i)}});return e});define("DS/VisuTools/StatsComputer",["DS/Visualization/OccurrenceExplorer","DS/Visualization/PrimitiveIterator","DS/Mesh/MeshUtils","DS/Visualization/Mesh3D"],function(a,d,e,b){var c=function(g){this.viewer=g};c.prototype.computeStats=function(j){var l=this.viewer.getWebGLContext();var k=new a(this.viewer);var h=this;var i=new f();k.explore(function(m){var o=null;if(j){o=m.getOccurrenceItf(j)}else{o=m.getUserRootOccurrenceItf()}o.traverse(h._handleOccurrence.bind(h,i,l))});var g=j?j.getLastElement():this.viewer.getRootNode();if(g){g.traverseUnique(function(m){if(m instanceof b){i.nbMeshes++}else{i.nbNodes++}})}return i};c.prototype._handleOccurrence=function(h,j,i){if(i.getVisibility()){var k=i.getMesh3D();if(k){h.nbMeshOccurrences++;var g=this.computeMeshStats(k,j);h.addStats(g)}else{h.nbNodeOccurrences++}}};c.prototype.computeMeshStats=function(s,j){var k=new f();var g=s.mesh3js.geometry;var l=g.length;var i,r,m,o,q,p,h;for(i=0;i<l;i++){r=g[i];if(r.drawingGroups){o=r.drawingGroups.length;for(m=0;m<o;m++){q=r.drawingGroups[m];p=q.glType;h=q.count;switch(p){case j.POINTS:k.nbPoints+=h;break;case j.LINES:k.nbLines+=h/2;break;case j.LINE_STRIP:n=h/2-1;if(n>0){k.nbLines+=2}break;case j.LINE_LOOP:k.nbLines+=h/2;break;case j.TRIANGLES:k.nbTriangles+=h/3;break;case j.TRIANGLE_STRIP:n=h/3-2;if(n>0){k.nbTriangles+=n}break;case j.TRIANGLE_FAN:n=h/3-1;if(n>0){k.nbTriangles+=n}}}}}return k};var f=function(){this.nbPoints=0;this.nbLines=0;this.nbTriangles=0;this.nbNodes=0;this.nbNodeOccurrences=0;this.nbMeshes=0;this.nbMeshOccurrences=0};f.prototype.addStats=function(g){this.nbPoints+=g.nbPoints;this.nbLines+=g.nbLines;this.nbTriangles+=g.nbTriangles};return c});define("DS/VisuTools/FPSCounter",["DS/Visualization/ThreeJS_DS","DS/VisuTools/CounterNode"],function(i,d){var c=function(l,k){this.sampleSize=l||20;this.invertMaxMin=k?true:false;this.reset()};c.prototype.addSample=function(o,l){if(this.sampleSize>=0){if(l||this.nextSampleIndex===-1||this.lastFrame!==window.webVisuPerfo.frameCount){if(this.nextSampleIndex!==-1){this.min=this.min>this.currentValue?this.currentValue:this.min}this.nextSampleIndex=(this.nextSampleIndex+1)%this.sampleSize;this.nbSamples++;this.lastFrame=window.webVisuPerfo.frameCount;if(this.samples.length<this.sampleSize){this.samples.push(0)}else{this.samples[this.nextSampleIndex]=0}this.currentValue=0}this.samples[this.nextSampleIndex]+=o;this.sum+=o;var m=0,k;for(k=0;k<this.samples.length;k++){m+=this.samples[k]}m/=this.samples.length;this.currentValue+=o;this.window=m;this.global=this.sum/this.nbSamples;this.max=this.max<this.currentValue?this.currentValue:this.max}else{if(this.lastFrame===-1){this.window=o}else{this.window+=o}this.min=this.window;this.max=this.window;this.global=this.window}};c.prototype.reset=function(){this.sample=[];this.samples=[];this.sum=0;this.nbSamples=0;this.nextSampleIndex=-1;this.lastFrame=-1;this.currentValue=0;if(this.sampleSize<0){this.window=0;this.global=0;this.min=0;this.max=0}else{this.min=Infinity;this.max=-Infinity;this.window=undefined;this.global=undefined}};c.prototype.getValue=function(){var k=window.webVisuPerfo._mode;if(this.invertMaxMin){if(k==="min"){k="max"}else{if(k==="max"){k="min"}}}return this[k]};var f=function(l,k){this.name=l;this.measure=new c(k);this.startTime=null};f.prototype.startSample=function(){this.startTime=performance.now()};f.prototype.endSample=function(){if(this.startTime!==null){var l=performance.now();var k=l-this.startTime;if(window.fpsCounterODT){k=window.fpsCounterODT*2}this.measure.addSample(k)}this.startTime=null};var g=function(l){function k(o,m){var p=window.devicePixelRatio;return{x:2*(o-p*200)/o-1,y:0.65}}this.viewer=l;this.node=new d(l,k);this.node.setRenderPasses(["robotOrtho"]);this.activated=false;this.token=null;this.previousTime=new Date().getTime();this.frozen=false;this.color=null;this.ldhNodeManager=null;this.fpsMeasure=new c(30,true);this._measuresMap={fps:{measure:this.fpsMeasure}}};g.prototype.toggleFrozen=function(){this.frozen=!this.frozen;if(this.frozen){this.node.setColor("#aaffaa");this.node.setText(this.node.text);this.viewer.render()}else{this.node.setColor(this.color)}};g.prototype.onAnimate=function(){function m(D){if(D!==null&&D!==undefined&&D.toFixed){return D.toFixed(1)}return NaN}var k=window.webVisuPerfo;if(this.viewer===k._leadViewer){k.frameCount++}if(this.ldhNodeManager===null&&window.oocLDHNodeManager){this.ldhNodeManager=window.oocLDHNodeManager}if(this.activated){var v=new Date().getTime();var o=this.average;var z=window.webVisuPerfo;var A=z._enabled?z._measuresList:[];var B=v-this.previousTime;if(window.fpsCounterODT!==undefined){B=1000/window.fpsCounterODT}this.fpsMeasure.addSample(B,true);var u="";if(!window.webVisuPerfo.lastResults){window.webVisuPerfo.lastResults={}}var r=window.webVisuPerfo.lastResults;var w=window.modelLoaderPoolStats;if(A.length||(w&&w.startTime>0)){u+="fps: "}var t=1000/this.fpsMeasure.getValue();r.frameTime=this.fpsMeasure.getValue();u+=m(t);if(!b){u=""}var x,y,q;if(w&&w.startTime>0){t=1000*w.nbLoadedModels/(v-w.startTime);u+="\nmps: "+m(t);var l=window.debugUnloadManager;if(l){u+="\nmem: "+m(l.usage)+"%";u+="\ngpu: "+m(l.usageGPU)+"%"}u+="\nmtot: "+m(w.nbLoadedModels);if(this.ldhNodeManager){var p="---";if(this.ldhNodeManager.lastDeltaTime>=0){p=(this.ldhNodeManager.lastDeltaTime/1000)+"s"}if(this.ldhNodeManager.previousIsLoading){p="("+p+")"}u+="\nvp: "+p}}if(b){var s,C;for(x=0;x<A.length;x++){C=A[x];s=z._measuresMap[C];t=s.measure.getValue();r[C]=t;u+="\n"+C+": "+m(t)}}if(!this.frozen){this.node.setText(u)}this.previousTime=v;if(b){this.viewer.render()}}};g.prototype.setActivated=function(k){if(k){if(!this.activated){this.viewer.internalSceneGraph.robotRoot.addChild(this.node);this.token=this.viewer.currentViewpoint.onMove(this.node.onViewpointChange.bind(this.node))}}else{if(this.activated){this.viewer.internalSceneGraph.robotRoot.removeChild(this.node);this.viewer.currentViewpoint.unsubscribe(this.token);this.token=null}}this.activated=k?true:false};g.prototype.setColor=function(k){this.color=k;if(!this.frozen){this.node.setColor(this.color)}};window.webVisuPerfo=window.webVisuPerfo||{};function h(l){var k=window.webVisuPerfo;switch(l.key){case"+":k.setMode("max");break;case"-":k.setMode("min");break;case"w":k.setMode("window");break;case"g":k.setMode("global");break;case"r":k.reset();break;case"f":k.freeze();break}}var e={setEnabled:function(k){if((k&&!this._enabled)||(!k&&this._enabled)){this._enabled=k;if(k){document.addEventListener("keydown",h)}else{document.removeEventListener("keydown",h)}}this.setMode(k?"global":"window")},startPerfo:function(l,k){if(!this._enabled){return}var m=this._measuresMap[l];if(!m){m=new f(l,k);this._measuresMap[l]=m;this._measuresList.push(l)}m.startSample()},endPerfo:function(k){if(!this._enabled){return}var l=this._measuresMap[k];if(l){l.endSample()}},setMode:function(k){if(k==="window"||k==="global"||k==="min"||k==="max"){this._mode=k;console.log("perfo monitor: mode="+k)}else{throw new Error("Unknown mode (permitted values are 'window', 'global', 'min' or 'max')")}},reset:function(){var l,m=this._perfoManagers;for(l=0;l<m.length;l++){m[l].fpsMeasure.reset()}var k;for(k in this._measuresMap){this._measuresMap[k].measure.reset()}console.log("perfo monitor: reset")},freeze:function(){this._leadViewer.fpsCounter.toggleFrozen()},_perfoManagers:[],_measuresMap:{},_measuresList:[],_mode:"global",_enabled:false,_leadViewer:null,frameCount:0};var j;for(j in e){if(e.hasOwnProperty(j)){window.webVisuPerfo[j]=e[j]}}e=null;var b=true;var a={setActivated:function(m,l,k){if(!window.webVisuPerfo._leadViewer){window.webVisuPerfo._leadViewer=m}var o=m.fpsCounter;if(!o){o=new g(m);m.fpsCounter=o;window.webVisuPerfo._perfoManagers.push(o)}if(k!==undefined){o.setColor(k)}o.setActivated(l)},setAutoRefresh:function(k){b=k?true:false}};return a});define("DS/VisuTools/InfoCounter",["DS/VisuTools/CounterNode"],function(b){function a(e,c){function d(g,f){var h=window.devicePixelRatio;return{x:200*h/g-1,y:0}}this._activated=true;this.viewer=e;this.color=c;this.counterNode=new b(e,d,6);this.viewer.internalSceneGraph.robotRoot.addChild(this.counterNode);this.counterNode.setRenderPasses(["robotOrtho"]);this.token=e.currentViewpoint.onMove(this.counterNode.onViewpointChange.bind(this.counterNode));if(c){this.setColor(c)}this.text=null;this.updateText()}a.prototype.setColor=function(c){this.counterNode.setColor(c)};a.prototype.buildText=function(){var g=this.viewer.getInfos();var c,e,f="";for(c in g){if(g.hasOwnProperty(c)){e=g[c];var d;f+=c.toUpperCase()+"\n";for(d in e){if(e.hasOwnProperty(d)){f+="   "+d+": "+e[d]+"\n"}}}}return f};a.prototype.updateText=function(){requestAnimationFrame(this.updateText.bind(this));if(this._activated){var c=this.buildText();if(c!==this.text){this.counterNode.setText(c);this.text=c;this.viewer.render()}}};a.prototype.activate=function(c){c=c?true:false;this.counterNode.setVisibility(c);this._activated=c;this.viewer.render()};return a});define("DS/VisuTools/NodeCounter",["DS/VisuTools/CounterNode","DS/CoreEvents/Events"],function(c,b){function a(f,d){function e(i,h){var j=window.devicePixelRatio;return{x:200*j/i-1,y:0.9}}this._activated=true;this.viewer=f;this.color=d;this.counterNode=new c(f,e,6);this.viewer.internalSceneGraph.robotRoot.addChild(this.counterNode);this.counterNode.setRenderPasses(["robotOrtho"]);this.token=f.currentViewpoint.onMove(this.counterNode.onViewpointChange.bind(this.counterNode));if(d){this.setColor(d)}this.text=null;this.sceneGraphUpdated=true;var g=this;this.onSceneGraphUpdateEvent=b.subscribe({event:"/VISU/onSceneGraphUpdate"},function(h){g.sceneGraphUpdated=true});this.updateText()}a.prototype.setColor=function(d){this.counterNode.setColor(d)};a.prototype.countToString=function(h){var e=[];var g=0;for(key in h){if(key.indexOf("*")!==0){e.push(key+": "+h[key].nodes+" ("+h[key].occurrences+")");g+=h[key].nodes}}e.sort();var d=[];var f=0;for(key in h){if(key.indexOf("*")===0){d.push(key+": "+h[key].nodes);f+=h[key].nodes}}d.sort();var i="";i+=e.join("\n");i+="\n";i+="-- TOTAL: "+g+" --\n";if(d.length>0){i+="\n";i+=d.join("\n");i+="\n";i+="-- OVERALL TOTAL: "+(f+g)+" --\n"}return i};a.prototype.buildText=function(){var j={};var f={};var e;var d=this.viewer.internalSceneGraph.root;var h=0;function l(m){h++;var o;for(o=0;o<m.length;o++){m[o].traverse(g)}h--}function g(o){if(!j[o.id]){j[o.id]=true;var i=o.getNodeType();var m=(h>0?"*":"")+i;if(!f.hasOwnProperty(m)){f[m]={nodes:0,occurrences:0}}f[m].nodes++;f[m].occurrences+=o._occurrences.length;if(i==="LODNode3D"){if(o.refined===0||o.refined===-1){l(o._lodChildren)}if(o.refined===1||o.refined===-1){l(o._representationNodes)}}}}d.traverse(g);var k=this.countToString(f);return k};a.prototype.updateText=function(){requestAnimationFrame(this.updateText.bind(this));if(this.sceneGraphUpdated&&this._activated){var d=this.buildText();if(d!==this.text){this.counterNode.setText(d);this.text=d;this.viewer.render()}}this.sceneGraphUpdated=false};a.prototype.activate=function(d){d=d?true:false;this.counterNode.setVisibility(d);this._activated=d;this.viewer.render()};return a});