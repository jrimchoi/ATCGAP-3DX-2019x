/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/SMAMpwManagers/SMAMpwMatOverrideManager",["UWA/Core","UWA/Class","DS/WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/SceneGraphOverrides/SceneGraphOverrideSet"],function(e,j,c,k,d,h){var m="MPW_PASSFAILMAT_ID";var b=function(p,o){var r;if(p&&p.rootNode&&o){var n=[o];var q=o.parents[0];while(q&&q!==p.rootNode){n.unshift(q);q=q.parents[0]}n.unshift(p.rootNode);r=new d(n)}return r};var f=function(r,t,s){var n;if(r&&s){var u=r.getOverridesFromPathElement(s);if(u){var q;for(var p=0;p<u.length&&!q;p++){var o=u[p].getMaterial();q=(o&&o.mpwMatID===t);if(q){n=u[p]}}}}return n};var a=function(q,p,o,s){if(q&&q.rootNode&&p&&o){var r=b(q,p);var n=f(q,s,r);if(!n){n=q.createOverride(r)}if(n){n.setMaterial(o,true)}else{console.warn("SMAMpwMatOverrideManager - createOverride failed. check that the provided node is actually attached to SG")}}};var l=function(q,p,o,s){if(q&&q.rootNode&&p&&o){var r=b(q,p);var n=f(q,s,r);if(n){n.setMaterial(null,true)}}};var g=function(o,q){var p;if(o.length>0&&q){var n=0;while(o[n].id!==q&&n<o.length){n++}if(n<o.length){p={index:n,set:o[n]}}}return p};var i=j.extend({init:function(){this._parent();this._sets=[]},getOverrideSet:function(o){var n=g(this._sets,o);return(n&&n.set)?n.set.sgOverrideSet:undefined},createOverrideSet:function(n){if(n&&n.id&&n.viewer&&n.root){if(this.getOverrideSet(n.id)){console.error("SMAMpw SceneGraphOverrideSet is already defined for this viewer")}var p=n.viewer.getSceneGraphOverrideSetManager();if(p){var o=new h(n.root);this._sets.push({id:n.id,sgOverrideSet:o,viewer:n.viewer});p.pushSceneGraphOverrideSet(o)}}else{console.error("SMAMpwMatOverrideManager createOverrideSet :invalid args")}},cleanOverrideSet:function(p){var n=g(this._sets,p);if(n&&n.set){var o=n.set.sgOverrideSet.getOverrides();n.set.sgOverrideSet.deleteOverrides(o);this._sets.splice(n.index,1)}},applyMaterialOverride:function(r,o,n,q){var p=this.getOverrideSet(r);a(p,o,n,q)},removeMaterialOverride:function(r,o,n,q){var p=this.getOverrideSet(r);l(p,o,n,q)},getPassFailMaterial:function(){if(!this._passFailMat){var n=k.ImageUtils.loadTexture(c.getWebappsBaseUrl()+"SMAMpwManagers/assets/textures/SMAMpwPassFail.jpg");this._passFailMat=new k.PhysicalMaterial({color:16777215,map:n});this._passFailMat.mpwMatID=m}return this._passFailMat},updatePassFailMaterialMap:function(n,r,s,u){var t=this.getOverrideSet(n);if(t){var v=t.getOverridesTargetingNode(r);for(var q=0;q<v.length;q++){var p=v[q];var w=p?p.getMaterial():undefined;if(w&&w.mpwMatID===m){w.map.offset.x=s;w.map.repeat.x=u}}}},applyPassFailMaterial:function(p,n){var o=this.getOverrideSet(p);if(o&&n){a(o,n,this.getPassFailMaterial(),m)}},removePassFailMaterial:function(p,n){var o=this.getOverrideSet(p);if(o&&n){l(o,n,true,m)}},});return e.namespace("DS/SMAMpwManagers/SMAMpwMatOverrideManager",i)});define("DS/SMAMpwManagers/SMAMpwResultProbingManager",["css!DS/SMAMpwManagers/SMAMpwResultProbing.css","UWA/Core","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/SceneGraphNodes/CSS2DNode","DS/Visualization/ThreeJS_DS"],function(e,f,d,c,m,i){var j=-30;var h=-40;var b=window.devicePixelRatio||1;var k={L:5*b,R:100*b,T:5*b,TL:70*b,B:20*b};var l={nonTouch:{L:new i.Vector2(35*b,0),R:new i.Vector2(-65*b,0),T:new i.Vector2(0,40*b),TL:new i.Vector2(35,40*b),TR:new i.Vector2(-65,40*b)},touch:{L:new i.Vector2(50*b,0),R:new i.Vector2(-50*b,0),T:new i.Vector2(-70*b,70*b),TL:new i.Vector2(170*b,70*b),TR:new i.Vector2(-60*b,70*b)}};var g={L:new i.Vector2(30*b,0),R:new i.Vector2(-25*b,0),T:new i.Vector2(-35*b,-40*b),TL:new i.Vector2(90*b,-40*b),TR:new i.Vector2(-25*b,-40*b)};var a=f.Class.extend({init:function(n){this._isProbingActive=false;this._viewer=n.viewer;this._rootNode=n.rootNode;this._syncEvent=n.syncEvent;this._valueDisplayPrecision=n.valueDisplayPrecision?n.valueDisplayPrecision:3;this._probingDiv=f.createElement("div",{id:"probingField_"+this._viewer.id.toString(),"class":"simux-probing-field"});this._probingText=new f.Element("span",{"class":"simux-probing-value"}).inject(this._probingDiv);this._probingMarkerDiv=f.createElement("div",{id:"probingMarker"+this._viewer.id.toString(),"class":"simux-probing-marker"});var o=this;this.onSwipeProbing=function(p){var r=o._viewer.magnifier;if(r&&r.active){var s=r.getContent();var q=(typeof s.isHidden==="function")?s.isHidden():(s.style.display==="none");if(!q){o.onMoveProbing(p)}}};this.onMoveProbing=function(p){if(p&&o._viewer){var q=p.from[0].getCurrentPosition(o._viewer.canvas);if(o._syncEvent){var r={position2D:{x:q.x,y:q.y}};c.publish({event:o._syncEvent,data:r})}o.processProbingPosition(q)}};this.onReleaseProbing=function(){if(o._probingCSS2DNode){o._probingCSS2DNode.setVisibility(false)}if(o._probingMarker){o._probingMarker.setVisibility(false)}}},startProbing:function(q){this._textureMin=undefined;this._textureMax=undefined;if(q){if(undefined!==q.labels){this._labels=q.labels}else{this._textureMin=q.textureMin;this._textureMax=q.textureMax}if(d&&c){if(this._viewer){if(!this._probingCSS2DNode){var p=this._rootNode;if(p){this._probingCSS2DNode=new m({html:this._probingDiv,name:"SimNavProbingCSS2D"});this._probingCSS2DNode.setPickability(false);this._probingCSS2DNode.setVisibility(false);p.add(this._probingCSS2DNode);this._probingMarker=new m({html:this._probingMarkerDiv,name:"SimNavProbingMarker"});this._probingMarker.setPickability(false);this._probingMarker.setVisibility(false);p.add(this._probingMarker)}if(!this._probingPosMatrix){this._probingPosMatrix=new i.Matrix4()}var o=window.devicePixelRatio||1;this._magStateToRestore=this._viewer.magnifier&&this._viewer.magnifier.active;if(d.isTouch){this._viewer.setMagnifier({activated:true});if(this._viewer.magnifier){this._magShiftVector={x:this._viewer.magnifier.shiftVector.x,y:this._viewer.magnifier.shiftVector.y};d.addEvent(this._viewer.canvas,"onSwipe",this.onSwipeProbing);d.addEvent(this._viewer.canvas,"onRelease",this.onReleaseProbing)}}var n=(d.isTouch&&this._magShiftVector)?this._magShiftVector.x:j;var r=(d.isTouch&&this._magShiftVector)?h-this._magShiftVector.y:h;this._probingOffset=new i.Vector2(n*o,r*o)}d.addEvent(this._viewer.canvas,"onMouseMove",this.onMoveProbing);this._viewpointChangeCallback=c.subscribe({event:"/VISU/"},function(s){if(s.eventType==="@onViewpointBeginMove"){this._viewpointManipulation=true}else{if(s.eventType==="@onViewpointEndMove"){this._viewpointManipulation=false}}}.bind(this));this._isProbingActive=true}}}},stopProbing:function(){if(d&&c){d.removeEvent(this._viewer.canvas,"onMouseMove",this.onMoveProbing);d.removeEvent(this._viewer.canvas,"onSwipe",this.onSwipeProbing);d.removeEvent(this._viewer.canvas,"onRelease",this.onReleaseProbing);c.unsubscribe(this._viewpointChangeCallback)}this._isProbingActive=false;this._textureMin=undefined;this._textureMax=undefined;this._labels=undefined;if(this._viewer){var n=this._rootNode;if(n&&this._probingCSS2DNode){n.remove(this._probingCSS2DNode)}if(n&&this._probingMarker){n.remove(this._probingMarker)}this._probingCSS2DNode=undefined;this._probingMarker=undefined;if(this._viewer.magnifier){this._viewer.setMagnifier({activated:this._magStateToRestore})}}},isProbingActive:function(){return this._isProbingActive},processProbingPosition:function(r,n){if(this._probingCSS2DNode){this._probingCSS2DNode.setVisibility(false)}if(this._probingMarker){this._probingMarker.setVisibility(false)}if(this._viewer&&this._isProbingActive&&!this._viewpointManipulation&&((undefined!==this._textureMin&&undefined!==this._textureMax)||undefined!==this._labels)){n=n||this._viewer.pick(this._viewer.getMousePosition(r),"primHybrid",true);if(n){var w=n.path;if(w.length>0){var p=w[0].externalPath[0].name;var o=(w[0].externalPath[1].name==="annotGroupNode");if(p!=="Experience"&&p!=="root-bag-web"&&!o){var q=n.position;var v=n.uv;if(v&&undefined!==v.x){var t;if(undefined!==this._labels){var s=Math.round(this._labels.length*v.x+0.5);if(0<s&&s<=this._labels.length){t=this._labels[s-1];this.updateProbingToDisplay(t,q)}}else{var u=(this._textureMax-this._textureMin)*v.x+this._textureMin;t=u.toPrecision(this._valueDisplayPrecision);this.updateProbingToDisplay(t,q)}}}}}}},updateProbingToDisplay:function(o,u){if(this._viewer){this._probingPosMatrix.setPosition(u);if(this._probingCSS2DNode){this._probingText.setText(o);this._probingCSS2DNode.setMatrix(this._probingPosMatrix);var r=new i.Vector2(0,0);r=r.addVectors(r,this._probingOffset);this._probingCSS2DNode.setOffset(r);this._probingCSS2DNode.updatePosition();var v=new i.Vector2(0,0);var y={w:parseInt(this._probingCSS2DNode.css2DNode.element.parentElement.clientWidth),h:parseInt(this._probingCSS2DNode.css2DNode.element.parentElement.clientHeight)};var x=parseInt(this._probingCSS2DNode.css2DNode.element.style.top);var p=parseInt(this._probingCSS2DNode.css2DNode.element.style.left);var q=d.isTouch;var w=q?l.touch:l.nonTouch;var t=function(z){if(z.length>0){r=r.addVectors(r,w[z]);if(q){v=v.addVectors(v,g[z])}}};var n="";if(x<k.T){n="T"}t(n);if(p<k.L||(n==="T"&&p<k.TL)){n=(n==="T")?"TL":"L"}else{if(p>(y.w-k.R)||(n==="T"&&p>(y.w-k.R))){n=(n==="T")?"TR":"R"}}t(n);var s=this._viewer.magnifier;if(q&&s&&s.active){s.shiftVector.x=this._magShiftVector.x+v.x;s.shiftVector.y=this._magShiftVector.y+v.y}this._probingCSS2DNode.setOffset(r);this._probingCSS2DNode.updatePosition();this._probingCSS2DNode.setVisibility(true)}if(this._probingMarker){this._probingMarker.setMatrix(this._probingPosMatrix);this._probingMarker.setVisibility(true)}this._viewer.render()}}});return f.namespace("DS/SMAMpwManagers/SMAMpwResultProbingManager",a)});define("DS/SMAMpwManagers/SMAMpwTextureMapProcessor",["UWA/Core","UWA/Class"],function(c,i){var h=function(k,j){var m={uvOffset:0,uvScale:1};if(k&&k.from&&k.to){if(k.from.min!==k.to.min||k.from.max!==k.to.max){var l=isNaN(j)?3:j;m.uvScale=0;if(parseFloat(k.from.max.toPrecision(l))>parseFloat(k.from.min.toPrecision(l))){if(parseFloat(k.to.max.toPrecision(l))>parseFloat(k.to.min.toPrecision(l))){m.uvScale=(k.to.max-k.to.min)/(k.from.max-k.from.min)}m.uvOffset=(k.to.min-k.from.min)/(k.from.max-k.from.min)}}}return m};var a=function(j,l,k){if(j){j.offset.x=l;j.repeat.x=k}};var e="RetexturingScale";var d="RetexturingShift";var f=function(l,q,s){if(l){var r=l.getPrimitives();if(r){for(var k=0;k<r.length;k++){var n=r[k];if(n&&n.sgNode&&n.sgNode.group){var t=n.sgNode.group;if(t){var m=false;if(t.material){var o=t.material.getPDSFXUniform(e);var j=t.material.getPDSFXUniform(d);if(o&&j){t.material.updatePDSFXUniform(e,s);t.material.updatePDSFXUniform(d,q);m=true}else{if(t.material.map){a(t.material.map,q,s);m=true}}}if(!m){if(t.gas&&t.gas.map){a(t.gas.map,q,s)}}}}}}}};var g=function(w){if(w&&w.node){var o=w.uvOffset;var s=w.uvScale;if(Array.isArray(w.rangeTransformations)&&w.rangeTransformations.length>0){o=0;s=1;for(var u=0;u<w.rangeTransformations.length;u++){var p=w.rangeTransformations[u];if(p){var v=h(p,w.precision);o=o*v.uvScale+v.uvOffset;s=s*v.uvScale}}}if(!isNaN(o)&&!isNaN(s)){var l=w.node.children;for(var n=0;n<l.length;n++){var m=l[n];if(m&&(undefined===w.childCondition||w.childCondition(m))){if(m.children.length===0){f(m,o,s)}else{for(var q=0;q<m.children.length;q++){var r=m.children[q];if(w.frameCondition){if(!w.frameCondition(r,q)){r=null}}if(r){var k=r.children[0];if(k){f(k,o,s)}}}}if(w.childPostProcessing){w.childPostProcessing(m,o,s)}}}}}};var b=i.extend({init:function(){this._parent()},applyToNode:function(j){g(j)}});return c.namespace("DS/SMAMpwManagers/SMAMpwTextureMapProcessor",b)});