/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/ENOPAD3DViewer/mixins/PAD3DViewerDebugTileNodeModel",["UWA/Core","UWA/Class"],function(c,a){var b=a.extend({name:"PAD3DViewerDebugTileNodeModel",dump_representations_loaded_inViewpoint:function(){var f=this._OOCManager._getDebugJSON().references;var d=Object.keys(f);var g=[];for(var e=0;e<d.length;e++){if(f[d[e]].handlerType===0&&f[d[e]].status==="complete"&&f[d[e]].screenRadius>=0){g.push(d[e])}}console.group("Status about reps loaded in current viewpoint:");console.group("Number of reps:");console.log(g.length);console.groupEnd();console.group("List of rep ids:");console.log(JSON.stringify(g));if(typeof copy!="undefined"){copy(JSON.stringify(g));console.log("Content is copied in clipboard")}console.groupEnd();console.groupEnd()},dump_references_nbChildren:function(){var f=this._OOCManager._getDebugJSON().references;var d=Object.keys(f);var g=[];for(var e=0;e<d.length;e++){if(f[d[e]].expectedNbChildren){g.push(f[d[e]].expectedNbChildren)}}g.sort(function(i,h){if(i<h){return -1}if(i>h){return 1}return 0}).reverse();console.group("All nbChildren");console.log(JSON.stringify(g));if(typeof copy!="undefined"){copy(JSON.stringify(g));console.log("Content is copied in clipboard")}console.groupEnd()},dump_representations_loaded_outsideViewpoint:function(){var f=this._OOCManager._getDebugJSON().references;var d=Object.keys(f);var g=[];for(var e=0;e<d.length;e++){if(f[d[e]].handlerType===0&&f[d[e]].status==="complete"&&f[d[e]].screenRadius<0){g.push(d[e])}}console.group("Status about reps loaded outside current viewpoint:");console.group("Number of reps:");console.log(g.length);console.groupEnd();console.group("List of rep ids:");console.log(JSON.stringify(g));if(typeof copy!="undefined"){copy(JSON.stringify(g));console.log("Content is copied in clipboard")}console.groupEnd();console.groupEnd()},dump_representations_notLoaded_inViewpoint:function(){var f=this._OOCManager._getDebugJSON().references;var d=Object.keys(f);var g=[];for(var e=0;e<d.length;e++){if(f[d[e]].handlerType===0&&f[d[e]].status!=="complete"&&f[d[e]].screenRadius>=0){g.push(d[e])}}console.group("Status about reps not loaded in current viewpoint:");console.group("Number of reps:");console.log(g.length);console.groupEnd();console.group("List of rep ids:");console.log(JSON.stringify(g));if(typeof copy!="undefined"){copy(JSON.stringify(g));console.log("Content is copied in clipboard")}console.groupEnd();console.groupEnd()},dump_representations_notLoaded_outsideViewpoint:function(){var f=this._OOCManager._getDebugJSON().references;var d=Object.keys(f);var g=[];for(var e=0;e<d.length;e++){if(f[d[e]].handlerType===0&&f[d[e]].status!=="complete"&&f[d[e]].screenRadius<0){g.push(d[e])}}console.group("Status about reps not loaded outside current viewpoint:");console.group("Number of reps:");console.log(g.length);console.groupEnd();console.group("List of rep ids:");console.log(JSON.stringify(g));if(typeof copy!="undefined"){copy(JSON.stringify(g));console.log("Content is copied in clipboard")}console.groupEnd();console.groupEnd()},dump_references_locked:function(){var g=this._OOCManager._getDebugJSON().references;var d=Object.keys(g);var e=[];for(var f=0;f<d.length;f++){if(this.isNodeLocked(d[f])){e.push(d[f])}}console.group("Status about references locked:");console.group("Number of references:");console.log(e.length);console.groupEnd();console.group("List of reference ids:");console.log(JSON.stringify(e));if(typeof copy!="undefined"){copy(JSON.stringify(e));console.log("Content is copied in clipboard")}console.groupEnd();console.groupEnd()},dump_representations_withoutStream:function(){var f=this._OOCManager._getDebugJSON().references;var d=Object.keys(f);var g=[];for(var e=0;e<d.length;e++){if(f[d[e]].handlerType===0){if(!this._OOCManager._getLDHReference(d[e]).url){g.push(d[e])}}}console.group("Status about reps without stream:");console.group("Number of reps:");console.log(g.length);console.groupEnd();console.group("List of rep ids:");console.log(JSON.stringify(g));if(typeof copy!="undefined"){copy(JSON.stringify(g));console.log("Content is copied in clipboard")}console.groupEnd();console.groupEnd()},dump_debugJSON:function(){var d=this._OOCManager._getDebugJSON();console.group("Status OOC model:");console.log(JSON.stringify(d));if(typeof copy!="undefined"){copy(JSON.stringify(d));console.log("Content is copied in clipboard")}console.groupEnd()},dump_OOCModelStats:function(){var l=this._OOCManager._getDebugJSON().references,e=this._OOCManager._getAllInstancesDebugJSON(),d=[],o=[],n=[],h=0,g=0;var m=Object.keys(l);var k=Object.keys(e);for(h=0;h<m.length;h++){var f=l[m[h]];if(f.handlerType===1){n.push(m[h])}else{o.push(m[h])}}for(h=0;h<k.length;h++){d.push(k[h])}console.group("Stats about OOC model:");console.group("References");console.group("Number of references:");console.log(n.length);console.groupEnd();console.group("List of reference ids:");console.log(JSON.stringify(n));console.groupEnd();console.groupEnd();console.group("Instances");console.group("Number of instances:");console.log(d.length);console.groupEnd();console.group("List of instance ids:");console.log(JSON.stringify(d));console.groupEnd();console.groupEnd();console.group("Representations");console.group("Number of representations:");console.log(o.length);console.groupEnd();console.group("List of representation ids:");console.log(JSON.stringify(o));console.groupEnd();console.groupEnd();console.groupEnd()},dump_representations_projected_bbox:function(){var o=this._OOCManager._getDebugJSON().references;var j=[];var n=[];var d=[];var k=0;for(k=this._repList.length-1;k>=0;k--){var e=this._OOCManager._getLDHReference(this._repList[k].id,true);if(!e){this._repList.splice(k,1)}}if(this._repList.length){var h=this._repList[0].stamp;n.push("00:00:00.000");d.push(this._repList[0].parsingID);j.push(Math.min(this._OOCManager._getLDHReference(this._repList[0].id,true)._screenRadius,2000));for(k=1;k<this._repList.length;k++){j.push(Math.min(this._OOCManager._getLDHReference(this._repList[k].id,true)._screenRadius,2000));var l=this._repList[k].stamp.getTime()-h.getTime();var g=Math.floor(l/60000);var m=((l%60000)/1000).toFixed(0);var f=((((l%60000)/1000)-Math.floor(((l%60000)/1000)))*1000).toFixed(0);n.push("00:"+g+":"+m+"."+f);d.push(this._repList[k].parsingID)}}console.group("Projected BBox ordered as received:");console.group("Number of reps:");console.log(j.length);console.groupEnd();console.group("List of size:");console.log(JSON.stringify(j));console.groupEnd();console.group("List of dates:");console.log(JSON.stringify(n));console.groupEnd();console.group("List of query id:");console.log(JSON.stringify(d));console.groupEnd();console.groupEnd()}});return b});define("DS/ENOPAD3DViewer/commands/PAD3DViewerHideShowCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(d,a,c){var b=a.extend({name:"PAD3DViewerHideShowCmd",init:function(e){this._parent(e,{mode:"shared",isAsynchronous:true});this._context=c.get(this.options.context)},execute:function(){var e=this;require(["DS/Selection/CSOManager"],function(f){var h=f.get();var g=[];h.forEach(function(i){g.push(i.pathElement.clone())});e._context.getHideShowController().toggleHideShow({paths:g,dispatch:true});e.end()})},});return d.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerHideShowCmd",b)});define("DS/ENOPAD3DViewer/utils/PAD3DViewerChangeAction",["UWA/Class","DS/PADUtils/PADChangeActionHandler","DS/PADUtils/PADWSProxy","DS/PADUtils/views/PADAlert","DS/PADUtils/views/PADProgressBar","i18n!DS/PADUtils/assets/nls/PADUtils.json"],function(a,j,k,b,g,d){function i(o,m){var n=o.indexOf(m);if(n!==-1){o.splice(n,1)}}function f(q,n){var p=[];for(var m=0;m<n.length;m++){var o=q._controller.getNode({id:n[m]});if(o){p.push(o.path)}}return p}function l(n){var u=[],p,o,r={},m=[];for(p=0;p<n.results.length;p++){var v=n.results[p];if(v.attributes){var q="",t="";for(o=0;o<v.attributes.length;o++){if(v.attributes[o].name==="did"){q=v.attributes[o].value}else{if(v.attributes[o].name==="physicalid"){t=v.attributes[o].value}}if(q!==""&&t!==""){r[q]=t}}}else{if(v.path){m.push(v.path)}}}for(p=0;p<m.length;p++){var s=[];for(o=0;o<m[p].length;o++){s.push(r[m[p][o]])}u.push(s)}return u}function e(n){var v=[],p,o,r={},m=[],u=[];for(p=0;p<n.results.length;p++){var w=n.results[p];if(w.attributes){var q="",t="";for(o=0;o<w.attributes.length;o++){if(w.attributes[o].name==="did"){q=w.attributes[o].value}else{if(w.attributes[o].name==="physicalid"){t=w.attributes[o].value}}if(q!==""&&t!==""){r[q]=t}}}else{if(w.path){m.push(w.path)}}}for(p=0;p<m.length;p++){var s=[];for(o=0;o<m[p].length;o++){s.push(r[m[p][o]])}u.push({path:s,hidden:false})}return u}function c(n){var o=[];for(var m=0;m<n.length;m++){o.push({id:n[m],hidden:false})}return o}var h=a.extend({init:function(m){this._parent(m)},loadChange:function(n){var r=n.app;var q=this;var m=r._controller.getRoots();var o=r._controller.getHiddenRootIds();r._controller._startAsync();g.setText(d.retrieveChangeAction);var p=n.changes.map(function(s){return s.objectId});j.getInfos(p,function(t){r._controller._stopAsync();var s=-1;var u=function(){s++;if(s<t.length){var v=t[s];q._processCA(v,r,u)}};u()})},_processCA:function(n,o,m){j.determineExecution(n,{addAndFind:function(z){var p=j.extractIds(z.changeaction.context);var y=j.extractRealizedAndProposed(z);var r=o._controller.getRoots().map(function(A){return A.getID()});r=r.concat(o._controller.getHiddenRootIds());var t=p.filter(function(A){return r.indexOf(A)===-1});if(t.length!==p.length){b.displayNotification({msg:d.root_already_loaded});if(t.length===0&&m){m()}}if(t.length){var x=t.length;var w;var u;var q=function(A){x--;if(x===0){o._controller.unsubscribe(w);o._controller.unsubscribe(u);if(m){m()}}};w=o._controller.subscribe({event:"onLoadingFailure"},q);u=o._controller.subscribe({event:"onRootAdded"},q);for(var s=0;s<t.length;s++){var v=k.find_in_ctx({rootId:t[s],findids:y});v.then(function(B){var A=e(B.results);if(A.length){o.addRoots({objects:A,dispatch:false})}else{b.displayNotification({msg:d.find_in_context_no_result,eventID:"info"});o.addRoots({objects:[{path:[B.params.rootId]}],dispatch:false})}})["catch"](function(A){console.error(A)})}}},add:function(r){var w=o._controller.getRoots().map(function(x){return x.getID()});w=w.concat(o._controller.getHiddenRootIds());var v=r.filter(function(x){return w.indexOf(x)===-1});if(v.length===0){b.displayNotification({msg:d.root_already_loaded});if(m){m()}}else{var q=v.length;var p;var u;var t=function(x){q--;if(q===0){o._controller.unsubscribe(p);o._controller.unsubscribe(u);if(m){m()}}};p=o._controller.subscribe({event:"onLoadingFailure"},t);u=o._controller.subscribe({event:"onRootAdded"},t);var s=c(v);o.addRoots({objects:s})}},wasEmpty:function(){o._dropZoneContainer.show("drop");if(m){m()}}})}});return h});define("DS/ENOPAD3DViewer/utils/PAD3DViewerTypesDictionary",["UWA/Class","UWA/Class/Options","text!DS/ENOPAD3DViewer/assets/typesDictionary.json"],function(c,b,a){var d=c.singleton(b,{name:"PAD3DViewerTypesDictionary",_dictionary:null,init:function(){this._dictionary=JSON.parse(a)},get:function(){return this._dictionary},});return d});define("DS/ENOPAD3DViewer/commands/PAD3DViewerFocusOnCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(d,b,c){var a=b.extend({name:"PAD3DViewerFocusOnCmd",init:function(e){this._parent(e,{mode:"shared",isAsynchronous:true});this._context=c.get(this.options.context)},execute:function(){var e=this;require(["DS/Selection/CSOManager","DS/PADUtils/PADCommandProxy"],function(f,g){var j=g.create();if(j){var k=f.get();var i=[];if(k.length){k.forEach(function(m){var n=m.pathElement;var l=e._context.streamPath(n);i.push(l)});var h=require("DS/PADUtils/PADUtilsServices");j.focus({intent:"focus",paths:i,widget:"3D",sharedID:h.getSharedId(),appID:h.getAppId()})}}e.end()})}});return d.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerFocusOnCmd",a)});define("DS/ENOPAD3DViewer/commands/PAD3DViewerEditPropertiesCmd",["UWA/Class","DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/PADUtils/PADContext"],function(c,b,d,e){var a=b.extend({name:"PAD3DViewerEditPropertiesCmd",_propertiesCommandPath:"DS/ENOCollabSharingCmds/commands/EditPropCmd/EditPropCmdBase",init:function(f){var g=this;this._parent(f,{mode:"shared",isAsynchronous:false});require([this._propertiesCommandPath],function(h){d.onPostAdd(function(){if(d.get().length>0){g.enable()}else{g.disable()}});d.onEmpty(function(){g.disable()});d.onRemove(function(){if(d.get().length>0){g.enable()}else{g.disable()}});if(d.get().length>0){g.enable()}else{g.disable()}},function(){g.disable()})},execute:function(){require(["DS/PADUtils/PADSettingsMgt","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices",this._propertiesCommandPath],function(m,g,j){var k=new j();var o=d.get();var n=[],h=[];for(var l=0;l<o.length;l++){n.push(o[l].pathElement)}n.forEach(function(r){while(r&&!g.isPLMNode(r.getLastElement(true))){r=r.getParentPath()}if(!r&&e.get().isSelectiveLoadingActivated()){var q=e.get().getController().getOOCSelectedReferenceID();if(q){h.push({refID:q,instID:null})}}else{var p=r.getLastElement(true);var i=r.getParentPath().getLastElement(true);h.push({refID:g.getNodeID(p),instID:g.getNodeID(i)})}});var f={getSelectedNodes:function(){var i=[];h.forEach(function(p){var q={id:p.refID,tenant:m.getSetting("x3dPlatformId"),source:"3DSpace",getID:function(){return p.refID},getRelationID:function(){return p.instID}};i.push(q)});return i},getSecurityContext:function(){return{SecurityContext:m.getSetting("pad_security_ctx"),tenant:m.getSetting("x3dPlatformId")}}};k.launchProperties(f)})}});return a});define("DS/ENOPAD3DViewer/views/PAD3DRemoveFilterPanel",["i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","DS/PADUtils/PADSettingsMgt","UWA/Controls/Abstract","DS/PADUtils/PADContext","DS/Controls/Button","DS/Controls/Toggle"],function(a,d,b,e,g,h){var i="DS/ENOFloatingPanel/ENOFloatingPanel";var c=function(k){var j=false;if(UWA.is(k,"boolean")){j=k}else{if(UWA.is(k,"string")){j=k.toLowerCase()==="true"}}return j};"use strict";var f=b.extend({name:"padRemoveFilterPanel",widget:null,init:function(j){this._parent(j);this.container=this.options.container;this.widget=e.get().getWidget();this.options={displayRemoveFilterOpts:false,validateCB:j.events.onValidate};this.elements.container=UWA.createElement("div",{"class":this.getClassNames("-removeFilter")});if(c(this.widget.getValue("displayRemoveFilterOpt"))===true){require([i],function(k){this.elements.floatingpanel=new k({className:this.name,body:this._buildContainer(),footer:this._buildFooter(),title:a.removeFilterPanelTitle,overlay:true,closable:true,animate:true,resizable:false,visible:true,events:{onClose:function(){this.options.validateCB(c(this.widget.getValue("removeFilterFullReload")));this.elements.floatingpanel.destroy()}.bind(this)}});this.elements.floatingpanel.inject(this.container)}.bind(this),function(k){console.error("AMD loading failed : failed to load the module ENOFloatingPanel, "+k)})}else{e.get().displayNotification({eventID:"info",msg:c(this.widget.getValue("removeFilterFullReload"))===true?a.removeFilterAutoReload:a.removeFilterAutoIgnore});this.options.validateCB(c(this.widget.getValue("removeFilterFullReload")))}},_buildContainer:function(){var j=UWA.createElement("div",{"class":this.getClassNames("-bodyView")}).inject(this.elements.container);var l=UWA.createElement("p",{"class":this.getClassNames("-description")}).inject(j);l.innerText=a.removeFilterPanelDescription;var k=UWA.createElement("div",{"class":this.getClassNames("-footerView")}).inject(j);applyToggle=new h({label:a.removeFilterPanelAutoApply,checkFlag:!c(this.widget.getValue("displayRemoveFilterOpt"))});var m=UWA.createElement("div",{"class":this.getClassNames("-instruction applyToggle"),content:applyToggle});applyToggle.inject(m);m.inject(k);applyToggle.addEventListener("change",function(o){var n=o.dsModel;this.options.displayRemoveFilterOpts=!n.checkFlag;if(c(this.widget.getValue("displayRemoveFilterOpt"))!==this.options.displayRemoveFilterOpts){this.widget.setValue("displayRemoveFilterOpt",this.options.displayRemoveFilterOpts)}}.bind(this));return j},_buildFooter:function(){var l=UWA.createElement("div",{"class":this.getClassNames("-footerModal")});var k=new g({label:a.reload,emphasize:"primary",touchMode:true});var j=new g({label:a.ignore,touchMode:true});k.addEventListener("click",function(){if(c(this.widget.getValue("displayRemoveFilterOpt"))===false){this.widget.setValue("removeFilterFullReload",true)}this.options.validateCB(true);this.elements.floatingpanel.destroy()}.bind(this));j.addEventListener("click",function(){if(c(this.widget.getValue("displayRemoveFilterOpt"))===false){this.widget.setValue("removeFilterFullReload",false)}this.options.validateCB(false);this.elements.floatingpanel.destroy()}.bind(this));k.inject(l);j.inject(l);return l}});return f});define("DS/ENOPAD3DViewer/commands/PAD3DViewerRootInfoPanelCmd",["UWA/Core","DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext","DS/Core/ModelEvents"],function(e,d,c,b){var a=d.extend({_context:null,_callbackAdd:false,init:function(g){this._parent(g,{});this._context=c.get();var h=this;var f=false;if(h._context.elements.triptych&&h._context.elements.triptych._modelEvents){h._context.elements.triptych._modelEvents.subscribe({event:"triptych-hide-panel"},function(i){if(i==="left"){f=true;h.setState(false,false)}});h._callbackAdd=true}h=this;this.onStateChange(function(){if(f){f=false}else{h._context.elements.triptych.togglePanel("left")}})},addCallback:function(){if(that._callbackAdd===false){this._context.elements.triptych._modelEvents.subscribe({event:"triptych-hide-panel"},function(f){if(f==="left"){change_state_from_close=true;that.setState(false,false)}});that._callbackAdd=true}}});return a});define("DS/ENOPAD3DViewer/commands/PAD3DViewerRemoveAllCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(d,b,c){var a=b.extend({name:"PAD3DViewerRemoveAllCmd",init:function(e){var f=this;this._CBTokens=[];this._parent(e,{isAsynchronous:true});this._context=c.get(e.context);this._CBTokens.push(this._context.subscribe({event:"onRootAdded"},function(){f.enable()}));this._CBTokens.push(this._context.subscribe({event:"onRootRemoved"},function(){if(f._context.getRoots().length===0&&(!f._context._controller.getHiddenRootIds().length)){f.disable()}}));if(this._context.getRoots().length===0&&(!f._context._controller.getHiddenRootIds().length)){this.disable()}else{this.enable()}},destroy:function(){if(this._context){for(var e=0;e<this._CBTokens.length;e++){this._context.unsubscribe(this._CBTokens[e])}}this._CBTokens=null;this._context=null},execute:function(){var e=this;require(["DS/Selection/CSOManager","DS/Selection/HSOManager"],function(f,g){if(e._context&&e._context.name==="ENOPAD3DViewer"){e._context.getViewer().getSceneGraphOverrideSetManager().clear();e._context.empty()}f.empty();g.empty();e.end()})},});return d.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerRemoveAllCmd",a)});define("DS/ENOPAD3DViewer/commands/PAD3DViewerPrintCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/PADUtils/PADUtilsServices"],function(e,a,d,c){var b=a.extend({name:"PAD3DViewerPrintCmd",init:function(f){this._parent(f,{isAsynchronous:true,mode:"shared"});this._context=d.get(f.context);if(navigator.userAgent.match(/Android|iPhone|iPad|iPod|BlackBerry|Opera Mini|IEMobile/i)){this.disable()}},execute:function(){var r=1920;var k=this._context.getViewer();var A=k.SCREEN_WIDTH;var J=k.SCREEN_HEIGHT;var g=A/J;var f=g>1?r:Math.floor(r*g);var s=g>1?Math.floor(r/g):r;var o=document.createElement("canvas");o.width=f;o.height=s;var D={data:null,width:f,height:s,bufferWidth:0,bufferHeight:0,x:0,y:0};this._context.getViewer().renderToTarget(D,this._context.getViewpoint());var C=o.getContext("2d");var B=C.getImageData(0,0,o.width,o.height);if(B.width!=o.width){console.error("error");return undefined}if(B.height!=o.height){console.error("error");return undefined}var n=(D.width-1)/(B.width-1);var x=(D.height-1)/(B.height-1);var u=D.data;var L=B.data;var F,E,q,z;if(n==1&&x==1){var G=B.height;var v=B.width;var t=4*v;for(E=0;E<G;E++){q=4*(E*v);z=4*((G-E)*v);for(F=t;F--;){L[q+F]=u[z+F]}}}else{var K=function(O,N,M,P,Q){if(Q){N=P-N}return M*N+O};var y=B.height;var p=B.width;var m=D.height;var I=D.width;for(E=0;E<y;E++){var H=Math.floor(x*E);for(F=0;F<p;F++){q=4*K(F,E,p,y);z=4*K(Math.floor(n*F),H,I,m,true);L[q]=u[z];L[q+1]=u[z+1];L[q+2]=u[z+2];L[q+3]=u[z+3]}}}C.putImageData(B,0,0,0,0,o.width,o.height);var l=function(j){var i='style="max-width: 100%"';if(g<1){i='style="max-height: 95%; margin: 0px"'}var N=j.contentName;var w=o.toDataURL("image/png");var h="<!DOCTYPE html>";h+='<html style="height: 100vh; width: 100vw; margin: 0px">';h+="<head><title>"+N+"</title></head>";h+='<body style="height: 100vh; width: 100vw; margin: 0px">';h+='<img src="'+w+'" '+i+">";h+="</body>";h+="</html>";var M=window.open("","","width=800,height=600");M.document.open();M.document.addEventListener("load",function(){M.focus();M.print();M.document.close();M.close();this.end()}.bind(this),true);M.document.write(h)};this._context.getContentName({callbacks:{onComplete:l.bind(this),onFailure:l.bind(this)}})},});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerPrintCmd",b)});define("DS/ENOPAD3DViewer/commands/PAD3DLineLayoutCmd",["UWA/Core","DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext"],function(d,c,b){var a=c.extend({init:function(e){this._parent(e,{});var f=this;this._layout=null;this._context=b.get(f.options.context);this._layout=this._context.getCurrentLayout();if(this._layout){this.setState(true)}this.onStateChange(function(){f.disable();if(!f._layout){require(["DS/ENOPAD3DViewer/views/PAD3DLineLayout"],function(g){f._layout=new g({context:f._context});f._context.setCurrentLayout(f._layout);f._layout.activate()})}else{if(!f.getState()){f._context.setCurrentLayout(null);f._layout.deactivate()}else{f._context.setCurrentLayout(f._layout);f._layout.activate()}}setTimeout(function(){f.enable()},1000)})},destroy:function(){this._layout.destroy()}});return d.namespace("DS/ENOPAD3DViewer/commands/PAD3DLineLayoutCmd",a)});define("DS/ENOPAD3DViewer/commands/PAD3DViewerReframeOnCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(d,a,c){var b=a.extend({name:"PAD3DViewerReframeOnCmd",init:function(e){this._parent(e,{isAsynchronous:true,mode:"shared"});this._context=c.get(e.context)},execute:function(){var e=this;require(["DS/Selection/CSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices"],function(f,g){var i=f.get();var h=[];i.forEach(function(j){h.push(j.pathElement)});g.reframeOn({paths:h,viewpoint:e._context.getViewpoint()});e.end()})},});return d.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerReframeOnCmd",b)});define("DS/ENOPAD3DViewer/commands/PAD3DViewerCenterTreeCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(d,b,c){var a=b.extend({name:"PAD3DViewerCenterTreeCmd",init:function(e){this._parent(e,{mode:"shared",isAsynchronous:true});this._context=c.get(this.options.context)},execute:function(){var e=this;require(["DS/Selection/CSOManager"],function(f){var h=e._context.getCommandProxy();if(h){var i=f.get();var g=[];if(i.length){i.forEach(function(k){var l=k.pathElement;var j=e._context.streamPath(l);g.push(j)});h.focus({paths:g,intent:"centerTree"})}}e.end()})}});return d.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerCenterTreeCmd",a)});define("DS/ENOPAD3DViewer/mixins/PAD3DViewerDECSpecificController",["UWA/Core","UWA/Class","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADWSAccess","DS/PADUtils/PADSession","DS/PADUtils/views/PADProgressBar","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(h,b,d,g,a,f,e){var c=b.extend({name:"PAD3DViewerDECSpecificController",getAssociatedDrawingSVGs:function(k){if(!h.is(k,"object")){throw new Error("No parameter defined")}if(!h.is(k.ids,"array")){throw new Error("No input ids defined")}if(!h.is(k.callbacks,"object")){throw new Error("No callbacks function defined")}if(!h.is(k.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}if(!h.is(k.callbacks.onFailure,"function")){throw new Error("No onFailure callback function defined")}var j=this;function l(q){var r={};var w;try{w=h.is(q,"string")?JSON.parse(q):q}catch(m){k.callbacks.onFailure(m);return}var p={};var t={};for(var s=0;s<w.results.length;s++){var n=w.results[s];if(n.hasOwnProperty("nav_pattern")){if(!p[n.nav_pattern.physicalid]){p[n.nav_pattern.physicalid]=[]}for(var o=0;o<n.nav_pattern.linked_id.length;o++){var u=n.nav_pattern.linked_id[o];p[n.nav_pattern.physicalid].push(u);t[u]=""}}}var v=Object.getOwnPropertyNames(t);if(v.length>0){j.getAttributes({authored:true,ids:v,attributes:["ds6w:label","ds6w:modified","ds6w:created","svg"],callbacks:{onComplete:function(x){Object.getOwnPropertyNames(p).forEach(function(y){r[y]=[];p[y].forEach(function(z){r[y].push(x[z])})});k.callbacks.onComplete(r)},onFailure:function(x){k.callbacks.onFailure(x)}}})}else{k.callbacks.onComplete(p)}}var i={intent:"explore_3D",nav_pattern:[{name:"associated_drawing",direction:"to",physicalid:k.ids}],authored:true};g.navigateOnLinks({data:i,onComplete:l,onFailure:k.callbacks.onFailure})},storePositions:function(p){if(!h.is(p,"object")){throw new Error("No parameter defined")}if(!h.is(p.data,"array")){throw new Error("No input data defined")}if(!h.is(p.callbacks,"object")){throw new Error("No callbacks function defined")}if(!h.is(p.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}if(!h.is(p.callbacks.onFailure,"function")){throw new Error("No onFailure callback function defined")}var j=[];var k=p.userFeedback===undefined?false:true;for(var l=0;l<p.data.length;l++){var o=this.getNode({id:p.data[l].id});if(o!==undefined){p.data[l].attributes=[];var m="";m+=p.data[l].matrix.elements[0].toString()+",";m+=p.data[l].matrix.elements[1].toString()+",";m+=p.data[l].matrix.elements[2].toString()+",";m+=p.data[l].matrix.elements[4].toString()+",";m+=p.data[l].matrix.elements[5].toString()+",";m+=p.data[l].matrix.elements[6].toString()+",";m+=p.data[l].matrix.elements[8].toString()+",";m+=p.data[l].matrix.elements[9].toString()+",";m+=p.data[l].matrix.elements[10].toString()+",";m+=p.data[l].matrix.elements[12].toString()+",";m+=p.data[l].matrix.elements[13].toString()+",";m+=p.data[l].matrix.elements[14].toString();var q={name:"matrixtxt",value:m};p.data[l].attributes.push(q);delete p.data[l].matrix;j.push(o)}}var n=this;if(k){n._startAsync();f.setText(e.storePositions)}g.modify({enopad_webapis:d.getSetting("enopad_webapis"),data:p.data,onComplete:function(r){var i=h.is(r,"string")?JSON.parse(r):r;if(k){n._stopAsync()}if(i.status==="failure"){p.callbacks.onFailure(i)}else{a.setAuthoringState(true,"PADSession_enabling_authored_mode",true);n.publish({event:"onMove",data:{nodes:j}});p.callbacks.onComplete()}},onFailure:function(i){if(k){n._stopAsync()}p.callbacks.onFailure(i)}})},getEditability:function(k){if(!h.is(k,"object")){throw new Error("No parameter defined")}if(!h.is(k.data,"array")||!k.data.length){throw new Error("No input data defined")}if(!h.is(k.intent,"string")||k.intent!=="MOVE"){throw new Error("No input intent defined")}if(!h.is(k.callbacks,"object")){throw new Error("No callbacks function defined")}if(!h.is(k.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}if(!h.is(k.callbacks.onFailure,"function")){throw new Error("No onFailure callback function defined")}function i(p){var n={};var m;try{m=h.is(p,"string")?JSON.parse(p):p}catch(o){k.callbacks.onFailure(o);return}for(var l=0;l<m.results.length;l++){n[m.results[l].rel_physicalid]=m.results[l].value==="true"}k.callbacks.onComplete(n)}var j={ids:k.data,intent:"explore_3D",name:[k.intent.toLowerCase()],authored:true,lang:k.lang?k.lang:"en"};g.getEditability({data:j,onComplete:i,onFailure:k.callbacks.onFailure})},});return c});define("DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices",["UWA/Core","DS/Controls/Loader","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS"],function(g,b,c,d){function f(h){return{x:h.x,y:h.y,z:h.z}}function e(h){var k=h.camera;var j=k.getLookAt();var i={projection:h.getProjectionType()===c.PERSPECTIVE?"CONIC":"CYLINDRIC",focus:h.getTargetDistance(),near:k.near,far:k.far,up:[f(k.up)],eye:[f(k.position)],sight:[f(j)],fov:h.getAngle()};return i}var a={reframeOn:function(r){if(!UWA.is(r,"object")){throw new Error("No parameter defined")}if(!r.path&&!r.paths&&!r.BS){throw new Error("No paths or bounding sphere defined")}if(!r.viewpoint){throw new Error("No viewpoint defined")}if(r.BS){r.viewpoint.reframe(null,undefined,r.BS)}else{var s=[];if(r.path){s.push(r.path)}else{s=r.paths}var l=new d.Vector3(0,0,0),p=new d.Vector3(0,0,0),h=new d.Vector3(0,0,0);var m=0,n=0;s.forEach(function(w){var v=w.getLastElement(true).getBoundingBox().clone();var t=w.getWorldMatrix();v.applyMatrix4(t);var u=v.min,i=v.max;if(m===0){l.x=Math.min(u.x,i.x);l.y=Math.min(u.y,i.y);l.z=Math.min(u.z,i.z);p.x=Math.max(u.x,i.x);p.y=Math.max(u.y,i.y);p.z=Math.max(u.z,i.z)}else{l.x=Math.min(Math.min(u.x,i.x),l.x);l.y=Math.min(Math.min(u.y,i.y),l.y);l.z=Math.min(Math.min(u.z,i.z),l.z);p.x=Math.max(Math.max(u.x,i.x),p.x);p.y=Math.max(Math.max(u.y,i.y),p.y);p.z=Math.max(Math.max(u.z,i.z),p.z)}m++});n=Math.sqrt(Math.pow(p.x-l.x,2)+Math.pow(p.y-l.y,2)+Math.pow(p.z-l.z,2))/2;h.add(l).add(p);h.divideScalar(2);var k=r.viewpoint;var q=1.1*n/Math.tan(22.5*Math.PI/180);var o=h.clone();var j=k.control.orientation.clone();k.control.moveTo({target:o,orientation:j,distanceToTarget:q,duration:400})}},buildViewPoint:function(h){return e(h)},convertExponentialToDecimal:function(m){var q=m.toString();if(q.indexOf("e")!==-1){if(/\d+\.?\d*e[\+\-]*\d+/i.test(m)){var p="0",n=String(m).toLowerCase().split("e"),o=n.pop(),k=Math.abs(o),h=o/k,i=n[0].split(".");if(h===-1){i[0]=Math.abs(i[0]);m="-"+p+"."+new Array(k).join(p)+i.join("")}else{var j=i[1];if(j){k=k-j.length}m=i.join("")+new Array(k+1).join(p)}}return m}else{return q}}};return a});define("DS/ENOPAD3DViewer/views/PAD3DLayerView",["DS/Core/ModelEvents","DS/PADUtils/PADSettingsMgt"],function(c,b){function a(d){this._container=null;this._hideShowBtnDiv=null;this._labelDiv=null;this._deleteBtnDiv=null;this._controller=null;this._modelEvents=new c();this._buildSkeleton(d);this._bindEvents()}a.prototype.hide=function(){this._hideShowBtnDiv.classList.remove("fonticon-eye");this._hideShowBtnDiv.classList.add("fonticon-eye-off");this.publish({event:"hide"})};a.prototype.show=function(){this._hideShowBtnDiv.classList.remove("fonticon-eye-off");this._hideShowBtnDiv.classList.add("fonticon-eye");this.publish({event:"show"})};a.prototype.render=function(){return this._container};a.prototype.destroy=function(){delete this._container;delete this._hideShowBtnDiv;delete this._labelDiv;delete this._deleteBtnDiv;delete this._controller;delete this._modelEvents};a.prototype.getModelEvents=function(d){return this._modelEvents};a.prototype.publish=function(d){this.getModelEvents().publish(d)};a.prototype.subscribe=function(d,e){return this.getModelEvents().subscribe(d,e)};a.prototype.unsubscribe=function(d){this.getModelEvents().unsubscribe(d)};a.prototype._buildSkeleton=function(d){this._container=document.createElement("div");this._container.classList.add("PAD3DLayer-container");if(b.getSetting("enopad3dviewer_lightNodeModel")!==true){this._hideShowBtnDiv=document.createElement("div");this._hideShowBtnDiv.classList.add("PAD3DLayer-button");this._hideShowBtnDiv.classList.add("fonticon");this._hideShowBtnDiv.classList.add("fonticon-eye")}this._labelDiv=document.createElement("div");this._labelDiv.classList.add("PAD3DLayer-label");this._labelDiv.innerHTML=d.label;this._deleteBtnDiv=document.createElement("div");this._deleteBtnDiv.classList.add("PAD3DLayer-button");this._deleteBtnDiv.classList.add("fonticon");this._deleteBtnDiv.classList.add("fonticon-wrong");if(this._hideShowBtnDiv!==null){this._container.appendChild(this._hideShowBtnDiv)}this._container.appendChild(this._labelDiv);this._container.appendChild(this._deleteBtnDiv)};a.prototype._bindEvents=function(){if(this._hideShowBtnDiv!==null){this._hideShowBtnDiv.onclick=function(){if(this._hideShowBtnDiv.classList.contains("fonticon-eye")){this.hide()}else{this.show()}}.bind(this)}this._deleteBtnDiv.onclick=function(){this.publish({event:"delete"})}.bind(this)};return a});define("DS/ENOPAD3DViewer/views/PAD3DLineLayout",["UWA/Core","UWA/Controls/Abstract","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Animation/PropertyAnimation","DS/Logger/Logger","DS/Core/ModelEvents","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils"],function(f,h,j,e,g,c,b,i,a){var d=h.extend({name:"PAD3DLineLayout",_logger:null,_context:null,_roots:null,_isActive:false,_modelToken:[],_overloadedPaths:[],_modelEvents:null,init:function(k){this._parent(k);this._logger=c.getLogger(d);this._context=k.context;var l=this;this._modelEvents=new b()},isActive:function(){return this._isActive},activate:function(){var k=this;this._roots=this._context.getRoots().slice(0);this._sceneGraphOverrideSet=new i(this._context.getController().getRootBagPath().externalPath[0]);function l(){if(k.isActive()){k.compute()}}if(this._context){this._modelToken.push(this._context.subscribe({event:"onRootDetached"},l));this._modelToken.push(this._context.subscribe({event:"onRootAttached"},l));this._modelToken.push(this._context.subscribe({event:"onRootRemoved"},l));this._modelToken.push(this._context.subscribe({event:"onLoadingComplete"},l));this._modelToken.push(this._context.subscribe({event:"onModelUpdated"},l))}this._isActive=true;this.compute()},deactivate:function(l){var k=this;this._modelToken.forEach(function(m){k._context.unsubscribe(m)});this._modelToken=[];if(this._isActive){this.resetPositions(l);this._isActive=false}},compute:function(){var p=this;this._logger.log("compute");this.publish({event:"onLayoutComputationBegin"});var r=this._context.getViewer().getSceneGraphOverrideSetManager();if(r){r.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet)}var k=this._context.getRoots().slice(0);if(undefined!==k){var q=[];var n=0;var l=0;for(l=k.length-1;l>=0;l--){var m=k[l].getBoundingBox();var o=Math.abs(m.max.x-m.min.x);if(o===Infinity){k.splice(l,1)}}k.forEach(function(s){var t=s.getBoundingBox();var u=Math.abs(t.max.x-t.min.x);if(u!==Infinity){q.push({xSize:t.max.x-t.min.x,zMin:t.min.z,center:(t.min.clone().add(t.max)).divideScalar(2)});if(n<u){n=u}}});l=0;k.forEach(function(s){if(Math.round(s.getMatrix().elements[12])!=Math.round(-(q[l].center.x+n*l*1.2))||Math.round(s.getMatrix().elements[13])!=Math.round(-q[l].center.y)||Math.round(s.getMatrix().elements[14])!=Math.round(-q[l].zMin)){var v=new e();v.addElement(p._context.getController()._model.getRootBag());v.addElement(s);p._overloadedPaths.push(v);var t=r.computeAppliedPosition(v);if(t===null){t=v.getLastElement(true).getMatrix()}var w={_duration:1000,_startX:t.elements[12],_startY:t.elements[13],_startZ:t.elements[14],_endX:-(q[l].center.x+n*l*1.2),_endY:-q[l].center.y,_endZ:-q[l].zMin,_path:v,duration:function(){return this._duration},valueAt:function(C){var B=this._startX+(this._endX-this._startX)*(C/this._duration),A=this._startY+(this._endY-this._startY)*(C/this._duration),z=this._startZ+(this._endZ-this._startZ)*(C/this._duration);var x=new j.Matrix4().makeTranslation(B,A,z);var y=p._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(this._path);if(!y){y=p._sceneGraphOverrideSet.createOverride(this._path)}y.setPosition(x);p._context._viewer.render({updateInfinitePlane:true})}};var u=new g(s,"setMatrix",w);u.start()}l++});setTimeout(function(){p._context._viewer.render({updateInfinitePlane:true});p._context.reframe();p.publish({event:"onLayoutComputationEnd"})},1100)}},destroy:function(){this._logger.log("destroy");this.deactivate(false)},resetPositions:function(l){l=l===undefined?true:l;var k=this;var n=this._context.getViewer().getSceneGraphOverrideSetManager();if(n){n.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet)}if(this._overloadedPaths&&this._overloadedPaths.length>0){this.publish({event:"onLayoutComputationBegin"});var m=1000;if(!l){m=1}this._overloadedPaths.forEach(function(r){var o=n.computeAppliedPosition(r);n.removeSceneGraphOverrideSet(k._sceneGraphOverrideSet);var q=n.computeAppliedPosition(r);if(q===null){q=r.getLastElement(true).getMatrix()}n.pushSceneGraphOverrideSet(k._sceneGraphOverrideSet);if(o&&q){var s={_duration:m,_startX:o.elements[12],_endX:q.elements[12],_startY:o.elements[13],_endY:q.elements[13],_startZ:o.elements[14],_endZ:q.elements[14],_path:r,duration:function(){return this._duration},valueAt:function(y){var x=this._startX+(this._endX-this._startX)*(y/this._duration),w=this._startY+(this._endY-this._startY)*(y/this._duration),v=this._startZ+(this._endZ-this._startZ)*(y/this._duration);var t=new j.Matrix4().makeTranslation(x,w,v);if(y===this._duration){if(n){n.removeSceneGraphOverrideSet(k._sceneGraphOverrideSet);delete k._sceneGraphOverrideSet}}else{var u=k._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(this._path);if(!u){u=k._sceneGraphOverrideSet.createOverride(this._path)}else{u.setPosition(t)}}k._context._viewer.render({updateInfinitePlane:true})}};var p=new g(r.getLastElement(true),"setMatrix",s);p.start()}});setTimeout(function(){k._context._viewer.render({updateInfinitePlane:true});k._context.reframe();k.publish({event:"onLayoutComputationEnd"})},m+100)}},publish:function(k){this.getModelEvents().publish(k)},subscribe:function(k,l){return this.getModelEvents().subscribe(k,l)},unsubscribe:function(k){this.getModelEvents().unsubscribe(k)},getModelEvents:function(){return this._modelEvents}});return f.namespace("DS/ENOPAD3DViewer/views/PAD3DLineLayout",d)});define("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices",["UWA/Core","DS/PADUtils/PADSettingsMgt","DS/Visualization/Node3D"],function(d,b,c){var a={toUnique:function(f,e,g){e=f.length;if(e>1){while(g=--e){while(g--){if(f[e]===f[g]){f.splice(g,1)}}}}return f},equals:function(f,e){var g=false;if(this.isPLMNode(f)&&this.isPLMNode(e)){g=this.getNodeID(f)===this.getNodeID(e)}return g},isAModelPath:function(g){var f=false;if(g){for(var e=0;e<g.externalPath.length;e++){if(g.externalPath[e].name==="RootBag"){f=true;break}}}return f},isAPOIPath:function(g){var f=false;if(g){for(var e=0;e<g.externalPath.length;e++){if(g.externalPath[e].className==="PAD3DPOINode"){f=true;break}}}return f},getNodeID:function(e){var f=null;if(this.isPLMNode(e)){if(b.getSetting("enopad3dviewer_lightNodeModel")){f=e.getModelIdentification()}else{f=e.getID()}}return f},getNodeType:function(f){var e=null;if(this.isPLMNode(f)){if(b.getSetting("enopad3dviewer_lightNodeModel")){e=f.getUserData&&f.getUserData()?f.getUserData().type:null}else{e=f.getType()}}return e},getLoadedStream:function(e){var f=null;if(this.isPLMNode(e)&&this.isRepReference(e)){if(b.getSetting("enopad3dviewer_lightNodeModel")){f=e.getUserData&&e.getUserData()?e.getUserData().loadedStream:null}else{f=e.getLoadedStream()}}return f},isReference:function(f){var e=false;if(this.isPLMNode(f)){if(b.getSetting("enopad3dviewer_lightNodeModel")){e=f.isOOCReference()}else{e=f.isPLMReference()}}return e},isInstance:function(e){var f=false;if(this.isPLMNode(e)){if(b.getSetting("enopad3dviewer_lightNodeModel")){f=e.isOOCInstance()}else{f=e.isPLMInstance()}}return f},isRepReference:function(e){var f=false;if(this.isPLMNode(e)){if(b.getSetting("enopad3dviewer_lightNodeModel")){f=e.isOOCRepReference()}else{f=e.isPLMRepReference()}}return f},isRepInstance:function(e){var f=false;if(this.isPLMNode(e)){if(b.getSetting("enopad3dviewer_lightNodeModel")){f=e.isOOCRepInstance()}else{f=e.isPLMRepInstance()}}return f},is3DLeaf:function(f){var e=false;if(this.isPLMNode(f)){if(b.getSetting("enopad3dviewer_lightNodeModel")){e=f.isOOCRepReference()}else{e=f.is3DLeaf()}}return e},isPLMNode:function(e){var f=false;if(b.getSetting("enopad3dviewer_lightNodeModel")){f=e.modelIdentification!==null&&e.modelIdentification!==undefined?true:false}else{f=e.className==="PAD3DViewerNode"?true:false}return f},isFiltered:function(g,f){var e=g;if(b.getSetting("enopad3dviewer_lightNodeModel")===true){e=f.getController()._model.getRoot({id:this.getNodeID(g)})}if(e===undefined){return 0}return(e.getConfigFilter()||e.getSequenceFilter()||e.getCVFilterQuery())?1:0},getBIColor:function(f){var e=null;if(this.isPLMNode(f)){if(b.getSetting("enopad3dviewer_lightNodeModel")){e=f.getUserData&&f.getUserData()?f.getUserData().BIColor:null}else{e=f.getBIColor()}}return e},getRoots:function(f){var e=null;if(b.getSetting("enopad3dviewer_lightNodeModel")){e=f.getController().getRootBag().children}else{e=f.getController().getRoots()}return e},getSiblings:function(g){var h=[],e=g;var f=this;g.parents.forEach(function(i){i.children.forEach(function(j){if(!f.equals(j,e)){h.push(j)}})});return this.toUnique(h)},getReferences:function(f){var e=[];if(this.isRepInstance(f)){e=f.parents}else{if(this.isReference(f)){e.push(f)}else{if(this.isRepReference(f)){f.parents.forEach(function(g){e=e.concat(g.parents)})}else{if(this.isInstance(f)){e=f.children}}}}return this.toUnique(e)},isLeaf:function(f){var g=true;var e=this;f.children.forEach(function(h){if(!e.isRepInstance(h)){g=false}});return this.isReference(f)&&g},getRootReferences:function(g,e){if(!e){e=[]}var f=this;if(g.parents.length===1&&g.parents[0].name==="RootBag"){e.push(g);return f.toUnique(e)}else{g.parents.forEach(function(h){f.getRootReferences(h,e)});return f.toUnique(e)}}};return a});define("DS/ENOPAD3DViewer/mixins/PAD3DViewerQueryParser",["DS/PADUtils/PADProbes","DS/Visualization/ThreeJS_DS"],function(b,c){var a={name:"PAD3DViewerQueryParser",_buildFromJSONOcc:function(M){var E=this;var k=M.hidden!==undefined?M.hidden:false;var T=window.localStorage.getItem("TileModelDebug")==="ON";E.nbCgrLoaded=0;E.nbThbLoaded=0;var D=[];var w=[];var P=0;var d=[];var G=[];var A={};var f=null;var m=function(){var i=D.slice(0);var j=w.slice(0);M.callbacks.onComplete({id:M.rootIds[0],ids:M.rootIds,createdPaths:i,selectedPaths:j,BS:f});D=null;w=null;M=null;E=null};var g=function(){if(--P===0){m()}};this._parsingRunning=true;this.parsingProbe=b.createProbe("Parsing "+M.json.results.length+" results and building structure");var O=window.performance.now();var h=null;var B=new Map();var C=new Map();var x={};var u=0;var v=0;var R=0;var e=0;var K=M.json.results.length;var n=M.json.results;var N=0;this._OOCManager.startInstRefGraphTransaction();for(N=0;N<K;N++){var H=n[N];var z=null;var J=null;if(H.attributes!==undefined){u++;var F={};this._parseAttributes(H.attributes,F,M.extraAttribute);if(F.globalType!=="ds6w:Instance"&&F.type!=="VPMRepInstance"){if(F.thbUrl||F.cgrUrl){R++}if(!this._OOCManager.isRegistered(F.pid)){G.push(F.pid);if(H.boundingbox){var t=this._parseBoundingElements(H.boundingbox);J=t.boundingBox;z=t.boundingSphere}if((F.thbUrl||F.cgrUrl)){e++}var y=null;var S=null;if(F.globalType==="ds6w:Document"){if(M.streamToLoad==="thumbnail"&&F.thbUrl){y=F.thbUrl;S="thumbnail";E.nbThbLoaded++}else{y=F.cgrUrl;S="cgr";E.nbCgrLoaded++}if(!y){z.radius=0}if(T){this._repList.push({id:F.pid,stamp:new Date(Date.now()),parsingID:O})}}this._OOCManager.registerReference(F.pid,{handler:F.globalType==="ds6w:Document"?this._model3DHandler:this._refHandler,boundingBox:z&&z.radius>0?J:undefined,boundingSphere:z,url:y,loadModelOptions:F.globalType==="ds6w:Document"?{noMeshInRAM:true}:null});if(H.nbchildren!==undefined){if(M.partialOpen&&M.partialOpenPath.indexOf(F.pid)!=-1&&M.partialOpenPath.indexOf(F.pid)!=(M.partialOpenPath.length-1)){this._OOCManager.lockChildren(F.pid)}this._OOCManager.setExpectedNbChildren(F.pid,parseInt(H.nbchildren))}this._OOCManager.setUserData(F.pid,{type:F.type,loadedStream:S})}if(F.globalType==="ds6w:Document"){d.push(F.pid)}if(M.intent==="addRoot"){if(M.rootIds.indexOf(F.pid)!==-1){M.callbacks.onReframe({BS:z,rootBS:true});if(!this.getRoot({id:F.pid})){var Q=this._OOCManager.addRoot(F.pid,{handler:F.thbUrl?this._model3DHandler:F.cgrUrl?this._model3DHandler:this._refHandler,boundingBox:z&&z.radius>0?J:undefined,boundingSphere:z});this._OOCManager.addSceneGraphLock(F.pid);this._rootIndex[F.pid]={occId:Q,setSequenceFilter:function(i){this._sequenceFilter=i},setConfigFilter:function(i){this._configFilter=i},setCVFilterQuery:function(i){this._CVFilterQuery=i},getSequenceFilter:function(){return this._sequenceFilter},getConfigFilter:function(){return this._configFilter},getCVFilterQuery:function(){return this._CVFilterQuery}}}f=z}}if(M.extraAttribute){if(!A[F.pid]){A[F.pid]={};if(F[M.extraAttribute]){A[F.pid][M.extraAttribute]=F[M.extraAttribute]}}}C.set(F.did,F.pid)}else{B.set(F.did,F);C.set(F.did,F.pid)}}else{if(H.path!==undefined){v++;var o=""+H.path[0];var s=C.get(o);var I=[s];for(var L=1;L<H.path.length;L++){I.push(C.get(""+H.path[L]));if(L%2===1){var q=""+H.path[L];var r=C.get(q);var l=""+H.path[L+1];var p=C.get(l);if(!this._OOCManager.isRegistered(r)){this._OOCManager.addChild(s,p,{matrix:B.get(q).matrix,instanceId:r});this._OOCManager.setUserData(r,{type:B.get(q).type});B["delete"](q)}o=l;s=p}}if(M.forceLoad){this.lockNodes({ids:[I[I.length-1]]})}w.push(I)}}}E.publish({event:"onUrlLoaded",data:{nbCgrLoaded:E.nbCgrLoaded,nbThbLoaded:E.nbThbLoaded}});this._OOCManager.endInstRefGraphTransaction();E.parsingProbe.end();delete E.parsingProbe;this.statProb=b.createProbe("nbRef: "+u+" / nbUrl : "+R+" / nbNewUrl : "+e+" / nbPath : "+v);E.statProb.end();delete E.statProb;M.json=null;delete M.json;E._parsingRunning=false;if(d.length&&M.extraAttribute){E.publish({event:"colorOverridePostProcess",data:{leavesToColorize:d,hashMap:A}})}if(G.length){E.publish({event:"newNodes",data:{newNodes:G}})}if(P===0){m()}},_buildFromJSONInstRef:function(k){var l=this;var C=k.hidden!==undefined?k.hidden:false;var p=window.localStorage.getItem("TileModelDebug")==="ON";l.nbCgrLoaded=0;l.nbThbLoaded=0;var E=[];var r=[];var d=0;var y=[];var q=[];var F={};var D=null;var o=function(){var i=E.slice(0);var I=r.slice(0);k.callbacks.onComplete({id:k.rootIds[0],ids:k.rootIds,createdPaths:i,selectedPaths:I,BS:D});E=null;r=null;k=null;l=null};var v=function(){if(--d===0){o()}};this._parsingRunning=true;this.parsingProbe=b.createProbe("Parsing "+k.json.results.length+" results and building structure");var f=window.performance.now();var g=null;var H={nbRef:0,nbNewRef:0,nbRep:0,nbNewRep:0,nbInst:0,nbNewInst:0,nbUrl:0,nbNewUrl:0,nbObj:0,timing:0};var s=k.json.results.length;var x=k.json.results;var u=new Date();var B=0;this._OOCManager.startInstRefGraphTransaction();for(B=0;B<s;B++){H.nbObj++;var G=x[B];var n=null;var m=null;var e=null;var j=null;if(G["ds6w:globaltype"]==="ds6w:Document"){G.nbchildren="0";y.push(G.resourceid);if(!this._OOCManager.isRegistered(G.resourceid)){q.push(G.resourceid);if(G.boundingbox){var w=this._parseBoundingElements(G.boundingbox);m=w.boundingBox;n=w.boundingSphere}if(k.streamToLoad==="thumbnail"&&G.thumbnail_3d){e=G.thumbnail_3d;j="thumbnail";this.nbThbLoaded++}else{e=G.cgr;j="cgr";this.nbCgrLoaded++}if(!e&&n){n.radius=0;m=undefined}this._OOCManager.registerReference(G.resourceid,{handler:this._model3DHandler,boundingBox:m,boundingSphere:n,url:e,loadModelOptions:{noMeshInRAM:true}});if(G.nbchildren!==undefined){if(k.partialOpen&&k.partialOpenPath.indexOf(G.resourceid)!=-1&&k.partialOpenPath.indexOf(G.resourceid)!=(k.partialOpenPath.length-1)){this._OOCManager.lockChildren(G.resourceid)}this._OOCManager.setExpectedNbChildren(G.resourceid,parseInt(G.nbchildren))}this._OOCManager.setUserData(G.resourceid,{type:G["ds6w:type"],loadedStream:j});if(p){this._repList.push({id:G.resourceid,stamp:new Date(Date.now()),parsingID:f})}if(G.thumbnail_3d||G.cgr){H.nbNewUrl++}H.nbNewRep++}if(k.forceLoad){this.lockNodes({ids:[G.resourceid]})}if(G.thumbnail_3d||G.cgr){H.nbUrl++}H.nbRep++}else{if(G["ds6w:globaltype"]==="ds6w:Part"){if(!this._OOCManager.isRegistered(G.resourceid)){if(G.boundingbox){var w=this._parseBoundingElements(G.boundingbox);m=w.boundingBox;n=w.boundingSphere}this._OOCManager.registerReference(G.resourceid,{handler:this._refHandler,boundingBox:m,boundingSphere:n,url:null,loadModelOptions:null});if(G.nbchildren!==undefined){if(k.partialOpen&&k.partialOpenPath.indexOf(G.resourceid)!=-1&&k.partialOpenPath.indexOf(G.resourceid)!=(k.partialOpenPath.length-1)){this._OOCManager.lockChildren(G.resourceid)}this._OOCManager.setExpectedNbChildren(G.resourceid,parseInt(G.nbchildren))}this._OOCManager.setUserData(G.resourceid,{type:G["ds6w:type"],loadedStream:null});H.nbNewRef++}H.nbRef++}else{if(!this._OOCManager.isRegistered(G.resourceid)&&G.from!==undefined&&G.to!==undefined){var A=this._parseMatrix(G.matrixtxt);this._OOCManager.addChild(G.from,G.to,{matrix:A,instanceId:G.resourceid});this._OOCManager.setUserData(G.resourceid,{type:G["ds6w:type"]});H.nbNewInst++}H.nbInst++}}if(k.intent==="addRoot"){if(k.rootIds.indexOf(G.resourceid)!==-1){delete k.intent;k.callbacks.onReframe({BS:n,rootBS:true});if(!this.getRoot({id:G.resourceid})){var z=this._OOCManager.addRoot(G.resourceid,{handler:G["ds6w:globaltype"]==="ds6w:Document"?this._model3DHandler:this._refHandler,boundingBox:m,boundingSphere:n});this._OOCManager.addSceneGraphLock(G.resourceid);this._rootIndex[G.resourceid]={occId:z,setSequenceFilter:function(i){this._sequenceFilter=i},setConfigFilter:function(i){this._configFilter=i},setCVFilterQuery:function(i){this._CVFilterQuery=i},getSequenceFilter:function(){return this._sequenceFilter},getConfigFilter:function(){return this._configFilter},getCVFilterQuery:function(){return this._CVFilterQuery}}}}}if(k.extraAttribute){if(!F[G.resourceid]){F[G.resourceid]={};if(attributes[k.extraAttribute]){F[G.resourceid][k.extraAttribute]=G[k.extraAttribute]}}}}this._OOCManager.endInstRefGraphTransaction();this.parsingProbe.end();delete this.parsingProbe;var h=new Date();var t=h-u;t/=1000;H.timing=t+"s";this.statProb=b.createProbe(JSON.stringify(H));console.log(JSON.stringify(H));this.statProb.end();delete this.statProb;k.json=null;delete k.json;this._parsingRunning=false;if(y.length&&k.extraAttribute){this.publish({event:"colorOverridePostProcess",data:{leavesToColorize:y,hashMap:F}})}this.publish({event:"onUrlLoaded",data:{nbCgrLoaded:this.nbCgrLoaded,nbThbLoaded:this.nbThbLoaded}});if(q.length){l.publish({event:"newNodes",data:{newNodes:q}})}if(d===0){o()}},_parseBoundingElements:function(f){var d=new c.Box3(new c.Vector3(parseFloat(f.min[0]),parseFloat(f.min[1]),parseFloat(f.min[2])),new c.Vector3(parseFloat(f.max[0]),parseFloat(f.max[1]),parseFloat(f.max[2])));var e=d?d.getBoundingSphere():null;if(d.max.x<d.min.x){e.radius=0;d=undefined}return{boundingBox:d,boundingSphere:e}},_parseMatrix:function(d){var e=null;if(d!==undefined&&d!=="1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"&&d!=="1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"&&d!=="1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0"){e=new c.Matrix4();var f=d.split(/[,]/);e.elements[0]=parseFloat(f[0]);e.elements[1]=parseFloat(f[1]);e.elements[2]=parseFloat(f[2]);e.elements[4]=parseFloat(f[3]);e.elements[5]=parseFloat(f[4]);e.elements[6]=parseFloat(f[5]);e.elements[8]=parseFloat(f[6]);e.elements[9]=parseFloat(f[7]);e.elements[10]=parseFloat(f[8]);e.elements[12]=parseFloat(f[9]);e.elements[13]=parseFloat(f[10]);e.elements[14]=parseFloat(f[11])}return e},};return a});define("DS/ENOPAD3DViewer/utils/PAD3DViewerRestoreSession",[],function(){var d=false,e=false,h=false,g,a;function f(j){var k=a.getValue("PAD3DViewerRootsDetached");k=k?JSON.parse(k):undefined;if(!k){a.addPreference({name:"PAD3DViewerRootsDetached",type:"hidden"});k=[]}var i=k.filter(function(l){return j.id!==l});if(i.length!==k.length){a.setValue("PAD3DViewerRootsDetached",JSON.stringify(i))}}function c(i){var j=a.getValue("PAD3DViewerRootsDetached");j=j?JSON.parse(j):undefined;if(!j){a.addPreference({name:"PAD3DViewerRootsDetached",type:"hidden"});j=[]}if(!j.some(function(k){return k===i.id})){j.push(i.id);a.setValue("PAD3DViewerRootsDetached",JSON.stringify(j))}}function b(j){var i=a.getValue("PAD3DViewerPathsInSession");i=i?JSON.parse(i):undefined;if(!i){a.addPreference({name:"PAD3DViewerPathsInSession",type:"hidden"})}a.setValue("PAD3DViewerPathsInSession",JSON.stringify(j.rootLog));if(j.hidden===true){c(j)}}return{init:function(j){if(d){return}if(typeof j!=="object"){throw new Error("No parameter defined")}if(!j.pad3DViewer){throw new Error("No pad3DViewer defined")}if(!j.widget){throw new Error("No widget defined")}d=true;g=j.pad3DViewer;a=j.widget;a.addEventOnce("onDestroy",function(){d=e=h=false;g=a=undefined});var i=g.subscribe({event:"onReady"},function(){h=true;g.unsubscribe(i);i=null});g.subscribe({event:"onRootAdded"},b);g.subscribe({event:"onRootRemoved"},function(k){b(k);f(k)});g.subscribe({event:"onRootAttached"},f);g.subscribe({event:"onRootDetached"},c)},restoreSession:function(){var k={objectsLoading:false};if(!d||!g||!a||!h){throw new Error("init method must be called first")}if(e){return k}e=true;var i=a.getValue("PAD3DViewerPathsInSession");i=i?JSON.parse(i):undefined;var l=a.getValue("X3DContentId");a.deleteValue("X3DContentId");if(i&&i.length>0){var m=a.getValue("PAD3DViewerRootsDetached");m=m?JSON.parse(m):[];var j=[];i.forEach(function(o){if(!o||!o.length){return}var n=o[0];j.push({path:o,hidden:m.some(function(p){return n===p})})});g.addRoots({objects:j},false);k.objectsLoading=true}else{if(l){g.addRootNodesFromContent({json3DXContent:JSON.parse(l),dispatch:false});k.objectsLoading=true}}return k}}});define("DS/ENOPAD3DViewer/views/PAD3DLayerWindow",["DS/Windows/Panel"],function(a){function b(c){this._list=null;this._panel=null;this._parentContainer=c.renderTo;this._buildSkeleton()}b.prototype._buildSkeleton=function(){this._list=document.createElement("div");this._list.classList.add("PAD3DLayerWindow-container");this._panel=new a({title:"Layers",immersiveFrame:this._parentContainer,content:this._list,resizableFlag:false,width:200,height:"auto",currentDockArea:8,allowedDockAreas:12,collapsibleFlag:false,verticallyStretchableFlag:true,closeButtonFlag:false})};b.prototype.hide=function(){this._panel.hide()};b.prototype.show=function(){this._panel.show()};b.prototype.appendChild=function(c){this._list.appendChild(c)};b.prototype.removeChild=function(c){this._list.removeChild(c)};return b});define("DS/ENOPAD3DViewer/views/PAD3DPushpinCanvasNode",["DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/CanvasNodeTexture"],function(c,d,b){function a(e){this._fillColor=e.fillColor;this._borderColor=e.borderColor?e.borderColor:"black";this._width=20;this._height=32}a.prototype.render=function(){var e=new b({width:this._width,height:this._height,drawCB:this._draw.bind(this)});var f=c.createCanvas2DNode({canvasNodeTexture:e,hotspot:new d.Vector2(this._width/2,this._height/2)});f.setPickParent(true);f.rectangle.setPickParent(true);return f};a.prototype._draw=function(f,e){e.save();e.translate(this._width/2,this._height);e.beginPath();e.moveTo(0,0);e.bezierCurveTo(2,-10,-20,-25,0,-30);e.bezierCurveTo(20,-25,-2,-10,0,0);e.fillStyle=this._fillColor;e.fill();e.strokeStyle=this._borderColor;e.lineWidth=1.5;e.stroke();e.beginPath();e.arc(0,-21,3,0,Math.PI*2);e.closePath();e.fillStyle=this._borderColor;e.fill()};return a});define("DS/ENOPAD3DViewer/commands/PAD3DViewerRemoveRootCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADContext"],function(e,b,c,d){var a=b.extend({name:"PAD3DViewerRemoveRootCmd",init:function(f){this._parent(f,{isAsynchronous:true});this._context=d.get(f.context)},execute:function(){var f=this;require(["DS/Selection/CSOManager","DS/Selection/HSOManager"],function(g,h){var j=g.get();var i=[];j.forEach(function(l){var k=l.pathElement.getLastElement(true);if(c.isPLMNode(k)){i.push(c.getNodeID(k))}});g.empty();h.empty();if(i.length){f._context.removeRoots({pids:i},true);f._context.getViewer().render({updateInfinitePlane:true});f._context.reframe()}f.end()})},});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerRemoveRootCmd",a)});define("DS/ENOPAD3DViewer/commands/PAD3DViewerRightSidePanel",["DS/PADUtils/commands/RightSidePanel","DS/Selection/CSOManager","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADContext","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(f,a,b,e,c){var d=f.extend({getXSO:function(){return a},getID:function(i){var h;var j=i.pathElement;while(j&&!c.isPLMNode(j.getLastElement(true))){j=j.getParentPath()}if(!j&&e.get().isSelectiveLoadingActivated()){h=e.get().getController().getOOCSelectedReferenceID()}else{var g=j.getLastElement(true);h=c.getNodeID(g)}return h},getTriptych:function(){return e.get().elements.triptych},onTriptychReady:function(h){var g=e.get().subscribe({event:"on3DTriptychReady"},function(i){h.call(e.get().elements.triptych);PADModelEvents.unsubscribe(g)})}});return d});define("DS/ENOPAD3DViewer/commands/PAD3DViewerDefineFilterCmd",["DS/ENONextGenFilterCmd/commands/ENONextGenFilterCmd","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADContext","DS/PADUtils/PADSession","DS/Selection/CSOManager"],function(h,e,g,d,f,a,b){var c=h.extend({_hasCSV:false,_openFilterPanelNow:false,init:function(i){this._parent(i);f.get().getController().getModelEvents().subscribe({event:"onRootRemoved"},function(j){this.setAvailabilityFromRolesAndRoots()}.bind(this));f.get().getModelEvents().subscribe({event:"grantedRoleRetrieved"},function(j){this.checkRoles(j);this.setAvailabilityFromRolesAndRoots()}.bind(this));f.get().getController().getModelEvents().subscribe({event:"onRootAdded"},function(j){this.setAvailabilityFromRolesAndRoots()}.bind(this));a.subscribe({event:"authoringStateModified"},function(k){var j=this.getAvailability();if(j&&!k.authored){this.setAvailabilityFromRolesAndRoots()}else{this.disable()}}.bind(this));this.checkRoles(d.getSetting("enopad3dviewer_roles"));this.setAvailabilityFromRolesAndRoots()},setAppParams:function(i){this._widgetId=i.widgetId;this._appId=i.appId},setOpenFilterNow:function(i){this._openFilterPanelNow=true;this._SelectedID=i},getAppParams:function(){return{widgetId:g.getWidgetId(),appId:g.getSharedId()}},getRoots:function(){if(this._openFilterPanelNow!==false){this._openFilterPanelNow=false;var k=[];var m=f.get().getController().getRoot({id:this._SelectedID});k.push({id:this._SelectedID,filtered:e.isFiltered(m,f.get())});return k}else{var k=[];var j=f.get().getController().getRoots();for(var l=0;l<j.length;++l){k.push({id:e.getNodeID(j[l]),filtered:e.isFiltered(j[l],f.get())})}return k}},getSelection:function(){var k=b.get();var l=[];if(k.length>0){for(var j=0;j<k.length;++j){if(k[j].pathElement!==null){l.push(f.get().streamPath(k[j].pathElement))}}}return{path:l}},getSelectorManager:function(){return b||null},checkRoles:function(k){for(var j=0;j<k.length;++j){if(k[j].id==="CSV"||k[j].id==="InternalDS"){this._hasCSV=true;return}}this._hasCSV=false},setAvailabilityFromRolesAndRoots:function(){if(!this.isEnabled()&&this._hasCSV===true&&f.get().getController().getRoots().length>0){this.enable()}else{if(f.get().getController().getRoots().length===0){this.disable()}}}});return c});define("DS/ENOPAD3DViewer/commands/PAD3DViewerRelationalNavigatorCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(f,a,b,d,c){var e=a.extend({name:"PAD3DViewerRelationalNavigatorCmd",init:function(g){this._parent(g,{mode:"shared",isAsynchronous:true});var h=this;this._context=d.get(g.context);function j(k){var l=false;for(var m=0;m<k.length;m++){if(c.isAModelPath(k[m].pathElement)){l=true;break}}return l}function i(){if(j(b.get())){h.enable()}else{h.disable()}}this._CBTokens=[];this._CBTokens.push(b.onAdd(function(){i()}));this._CBTokens.push(b.onEmpty(function(){h.disable()}));this._CBTokens.push(b.onRemove(function(){i()}));i()},destroy:function(){for(var g=0;g<this._CBTokens.length;g++){b.unsubscribe(this._CBTokens[g])}this._CBTokens=null;this._context=null},execute:function(){var g=this;require(["DS/PADUtils/PADUtilsServices"],function(j){var i=b.get();var h=[];i.forEach(function(l){var m=l.pathElement;var k=m.getLastElement(true);while(!c.isPLMNode(k)){k=k.parents[0]}var o=g._context.streamPath(m);var n={options:{type:c.getNodeType(k),grid:{"ds6w:type":""}},getID:function(){return c.getNodeID(k)},getLabel:function(){return undefined},getOccurencePathWithType:function(){return o}};h.push(n)});j.setObject_on_compass({nodes_2_open:h});j.open_app({appId:"ENORIPE_AP"},function(){});g.end()})}});return f.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerRelationalNavigatorCmd",e)});define("DS/ENOPAD3DViewer/commands/PAD3DViewerFilterDropObjectsCmd",["i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/ApplicationFrame/Command","DS/PADUtils/PADSession","DS/PADUtils/PADContext","DS/PADUtils/views/PADAlert","DS/PADUtils/PADUtilsServices","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,c,a,h,b,g,d){var f=c.extend({name:"PAD3DViewerFilterDropObjectsCmd",context:h.get(),init:function(i){this._parent(i,{mode:"shared",isAsynchronous:false})},execute:function(i){if(!a.isAuthoring()){require(["DS/PADUtils/PADTypesMgt"],function(j){j.retrieveAuthorizedObjects({notifPerObjects:true,displayNotif:false,unserializedData:i,callback:this._handler.bind(this),version:"2.0"})}.bind(this))}},_handler:function(m){if((m.authorizedWithKind.Product&&m.authorizedWithKind.Product.length===0)&&(m.authorizedWithKind.Filter&&m.authorizedWithKind.Filter.length===0)){b.displayNotification({msg:e.msg_warning_dndnotsupported,eventID:"error"})}else{var k=this.context.subscribe({event:"onRootAdded"},function(i){this.context.unsubscribe(k);if(m.authorized_objects.length===1&&i.id){this._callDefineFilter(i.id)}}.bind(this));var l=[];if(m.authorizedWithKind.Product){for(var j=0;j<m.authorized_objects.length;++j){this.context.addRoots({objects:[{path:[m.authorized_objects[j].objectId]}],loadWithFilter:m.authorized_objects.length===1?true:false,tenant:g.getPlatformId()})}}else{if(m.authorizedWithKind.Filter){this.context.getController()._BIProxy.retrieveFilters({filterObjects:m.authorizedWithKind.Filter,callback:function(r){var o=function(i){if(i){this.context.addRoots({objects:[{path:[i]}],loadWithFilter:true,tenant:g.getPlatformId()})}else{this._callDefineFilter(m.authorized_objects[0].objectId)}}.bind(this);var n=this.context.getController().getRoots();for(var q=0;q<r.success.length;++q){if(n.length===0){o(r.success[q].rootId)}else{for(var p=0;p<n.length;++p){if(r.success[q].rootId!==d.getNodeID(n[p])){o(r.success[q].rootId)}}}}}.bind(this)})}}}},_callDefineFilter:function(i){require(["DS/ApplicationFrame/CommandsManager"],function(j){var k=j.getCommand("DefineFilterHdr",this.context.getCommandContext());if(k){k.setAppParams({widgetId:g.getWidgetId(),appId:g.getSharedId()});k.setOpenFilterNow(i);k.begin()}}.bind(this))}});return f});define("DS/ENOPAD3DViewer/commands/PAD3DViewerLevelSelectorCmd",["UWA/Core","DS/Core/Events","DS/ApplicationFrame/Command","DS/Logger/Logger","DS/LevelSelector/LevelSelector","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/PADUtils/PADContext","DS/PADUtils/PADSettingsMgt","DS/Visualization/ThreeJS_DS","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(h,f,c,e,j,g,d,m,l,k,n,i,b){var a=c.extend({name:"PAD3DViewerLevelSelectorCmd",init:function(o){this._logger=e.getLogger(a);this._parent(o,{isAsynchronous:true,isEnabled:true});this._labelsVisibility=false;this._context=l.get(o.context)},execute:function(){this.emptyCSOToken=g.onEmpty(function(){this.end()}.bind(this));var t=g.get();if(t.length===1){var s=t[0].pathElement;var q=t[0].event;this._levelSelectorContext=t[0].pathElement.clone();var p=this._context.getFrameWindow().getContextualUIManager().getContextualBar();p.hide();var r=[];var o={positionX:q?q.currentPosition.x+75:this._context.elements.view_container.offsetWidth/2,positionY:q?q.currentPosition.y-75:this._context.elements.view_container.offsetHeight/2,uiFrame:this._context.elements.view_container,getLevels:function(z){var y=[];var x=s;while(x){if(b.isPLMNode(x.externalPath[x.externalPath.length-1])&&(b.isReference(x.externalPath[x.externalPath.length-1])||b.is3DLeaf(x.externalPath[x.externalPath.length-1]))){var u=x.getLastElement(true);var w=b.getBIColor(u);if(w!==null){r.push({pathElement:x,canvasColor:w,event:q})}else{r.push({pathElement:x,event:q})}y.push(b.getNodeID(x.getLastElement(true)))}x=x.getParentPath()}if(this._labelsVisibility){var v=["ds6w:label","type_icon_url"];if(this._context.getController().isColorizeActivated()&&this._context.getController().isStandalone()){v.push(this._context.getController().getBIColorMap().predicate)}this._context.getController().getAttributes({ids:y,attributes:v,callbacks:{onComplete:function(A){r.forEach(function(E){var D=b.getNodeID(E.pathElement.getLastElement(true));if(A[D]){E.name=A[D]["ds6w:label"];E.icon=A[D].type_icon_url;if(this._context.getController().isColorizeActivated()&&this._context.getController().isStandalone()){var B=this._context.getController().getBIColorMap().predicate;var C=this._context.getController().getBIColorMap().map;E.canvasColor=C[A[D][B]]}}}.bind(this));z(r)}.bind(this),onFailure:function(A){console.error("Levele selector command: The getAttributes call failed.",A);z(r)}}})}return r}.bind(this),onHover:function(u){d.empty();m.empty();u.event=q;d.add(u)}.bind(this),onLeave:function(u){d.empty();m.empty();d.add({pathElement:this._levelSelectorContext,event:q})}.bind(this),onSelect:function(u){d.empty();g.empty();u.event=q;d.add(u);g.add(u);this.end()}.bind(this)};j.createView(o)}},endExecute:function(){g.unsubscribe(this.emptyCSOToken);j.destroyView()},displayLabels:function(o){this._labelsVisibility=o}});return h.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerLevelSelectorCmd",a)});define("DS/ENOPAD3DViewer/commands/PAD3DViewerSwitchVisuOnDemandCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/Selection/CSOManager","DS/PADUtils/PADSession","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(h,b,g,c,a,d,f){var e=b.extend({name:"PAD3DViewerSwitchVisuOnDemandCmd",_currentMode:"thumbnail",init:function(i){var k=this;this._parent(i,{});this._context=g.get(i.context);this._CBTokens=[];this._currentMode=this._context.getController().getDefaultStreamToLoad();this._CBTokens.push(this._context.subscribe({event:"onUrlLoaded"},function(l){if(l.nbCgrLoaded){k._context.changeVisuModeCmdAvailability(true)}}));this._CBTokens.push(this._context.subscribe({event:"onStreamSwitched"},function(){k.checkStream()}));this._CBTokens.push(this._context.subscribe({event:"onRootAdded"},function(){k.checkStream()}));this._CBTokens.push(this._context.subscribe({event:"onRootRemoved"},function(){k.checkStream()}));var j=false;if(typeof widget!=="undefined"){if(widget.getValue("x3dPlatformId")!=="OnPremise"){j=true}}if(j){console.warn("Switch HD command is disabled on cloud environment: no thumbnail available");k.disable()}if(this._currentMode==="cgr"){this._context.changeVisuModeCmdAvailability(true)}else{this._context.changeVisuModeCmdAvailability(false)}},destroy:function(){if(this._context){for(var j=0;j<this._CBTokens.length;j++){this._context.unsubscribe(this._CBTokens[j])}}this._CBTokens=null;this._context=null},checkStream:function(p){var l=this;var o=false;var n=[];if(p){l._context.changeVisuModeCmdAvailability(true);return}var m=function(i){i.forEach(function(q){if(d.is3DLeaf(q)){n.push(q)}else{m(q.children)}})};var j=d.getRoots(l._context);m(j);if(n.length){for(var k=0;k<n.length;k++){if(d.getLoadedStream(n[k])==="cgr"){o=true;break}}l._context.changeVisuModeCmdAvailability(o)}},execute:function(){var o=this;var m=null;var n=[];var l=c.get();var i=[],j=[];var r=function(s){s.forEach(function(t){if(d.is3DLeaf(t)){i.push(d.getNodeID(t))}else{r(t.children)}})};var k=function(s){return o._context.getController().getNode({id:s})};l.forEach(function(t){var s=o._context.streamPath(t.pathElement);j.push(k(s[s.length-1]))});r(j);if(i.length===1){if(d.is3DLeaf(k(i[0]))){m=d.getLoadedStream(k(i[0]))==="thumbnail"?"cgr":"thumbnail";if(a.isAuthoring()&&m==="thumbnail"){o._context.displayNotification({eventID:"info",msg:f.switchVisuNodeNoThumbnailOnAuthoring});return}n.push({node:k(i[0]),stream:m})}}if(i.length>1){var q=0,p=0;i.forEach(function(s){if(d.is3DLeaf(k(s))){if(d.getLoadedStream(k(s))==="thumbnail"){q++}else{if(d.getLoadedStream(k(s))==="cgr"){p++}}}});if(q>=p){m="cgr"}else{m="thumbnail";if(a.isAuthoring()&&m==="thumbnail"){o._context.displayNotification({eventID:"info",msg:f.switchVisuNodeNoThumbnailOnAuthoring});return}}i.forEach(function(s){n.push({node:k(s),stream:m})})}if(n.length){o._context.getController().switchNodeVisuStreamOnDemand({data:n,callbacks:{onComplete:function(s){if(s.nbUrlLoaded!==0){if(n[0].stream==="cgr"){var t=s.nbUrlLoaded;if(s.nbUrlLoaded>1){t+=f.switchVisuNodeToCGRsSuccess}else{t+=f.switchVisuNodeToCGRSuccess}o._context.displayNotification({eventID:"success",msg:t})}else{var t=s.nbUrlLoaded;if(s.nbUrlLoaded>1){t+=f.switchVisuNodeToThumbnailsSuccess}else{t+=f.switchVisuNodeToThumbnailSuccess}o._context.displayNotification({eventID:"success",msg:t})}}else{if(s.nbUrlLoaded===0&&n[0].stream==="thumbnail"){o._context.displayNotification({eventID:"info",msg:f.switchVisuNodeUrlnotFound})}}},onFailure:function(){o._context.displayNotification({eventID:"error",msg:f.switchVisuNodeFailure})}}})}},});return h.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerSwitchVisuOnDemandCmd",e)});define("DS/ENOPAD3DViewer/controller/PAD3DViewerHideShowController",["UWA/Core","UWA/Controls/Abstract","DS/Core/ModelEvents","DS/PADUtils/PADContext","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils","DS/PADUtils/PADSettingsMgt"],function(d,f,c,i,b,g,a,h){var e=f.extend({name:"PAD3DViewerHideShowController",init:function(j){this._parent(j);this._commandProxy=null;this._overloadedPaths=[];this._sceneGraphOverrideSet=null;this._context=j.context;this._viewer=j.viewer;this.createOverrideSet();this._modelEvents=new c();this._initInterwidgetCom()},destroy:function(){delete this._context;if(this._viewer){delete this._viewer}delete this._modelEvents;if(this._commandProxy){this._commandProxy.destroy();delete this._commandProxy}},publish:function(j){this.getModelEvents().publish(j)},subscribe:function(j,k){return this.getModelEvents().subscribe(j,k)},unsubscribe:function(j){this.getModelEvents().unsubscribe(j)},getModelEvents:function(){return this._modelEvents},_initInterwidgetCom:function(){var j=this;if(this._context.isInterwidgetComAvailable()){require(["DS/PADUtils/PADCommandProxy"],function(k){j._commandProxy=k.create({events:{onShow:function(l){l.action="Show";j._onHideShow(l)},onHide:function(l){l.action="Hide";j._onHideShow(l)}}})})}},hide:function(k){if(!d.is(k,"object")){console.error("Incorrect parameters type in hide()");return}var l=0;k.withLock=k.withLock!==undefined?k.withLock:true;if(k.paths&&this._sceneGraphOverrideSet){k.paths.forEach(function(p){var o=p.clone();if(b.isAModelPath(o)){while(o&&!b.isPLMNode(o.getLastElement(true))){o=o.getParentPath()}if(o){var n=this._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(o);if(!n||n===null){n=this._sceneGraphOverrideSet.createOverride(o)}n.setVisibility(false);if(h.getSetting("enopad3dviewer_lightNodeModel")===true&&k.withLock){this._context.getController().lockNodes({ids:[b.getNodeID(o.getLastElement(true))]})}}l++}}.bind(this));var m=this._viewer.getSceneGraphOverrideSetManager();if(m){m.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet)}}if(l){setTimeout(function(){this._viewer.render({updateInfinitePlane:true})}.bind(this))}if(k.dispatch){var j=[];k.paths.forEach(function(o){if(b.isAModelPath(o)){var n=this._context.streamPath(o);j.push(n)}}.bind(this));if(this._commandProxy){this._commandProxy.hide({paths:j})}}this.publish({event:"onHide",data:k})},show:function(m){if(!d.is(m,"object")){console.error("Incorrect parameters type in show()");return}var n=0;m.withLock=m.withLock!==undefined?m.withLock:true;var j=function(r){if(!d.is(r,"object")){console.error("Incorrect path type in show().override()");return}var q=r.clone();if(b.isAModelPath(q)){while(q&&!b.isPLMNode(q.getLastElement(true))){q=q.getParentPath()}if(q){var p=this._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(q);if(p&&p.getVisibility()===false){this._sceneGraphOverrideSet.deleteOverride(p);if(h.getSetting("enopad3dviewer_lightNodeModel")===true&&m.withLock){this._context.getController().unlockNodes({ids:[b.getNodeID(q.getLastElement(true))]})}}n++}}}.bind(this);if(m.paths&&this._sceneGraphOverrideSet){for(var l=0;l<m.paths.length;++l){j(m.paths[l])}var o=this._viewer.getSceneGraphOverrideSetManager();if(o){o.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet)}}if(n){setTimeout(function(){this._viewer.render({updateInfinitePlane:true})}.bind(this))}if(m.dispatch){var k=[];m.paths.forEach(function(p){if(b.isAModelPath(p)){k.push(this._context.streamPath(p))}}.bind(this));if(this._commandProxy){this._commandProxy.show({paths:k})}}this.publish({event:"onShow",data:m})},createOverrideSet:function(){this._sceneGraphOverrideSet=new g(this._context.getController().getRootBagPath().externalPath[0])},resetState:function(){var j=this;if(this._viewer&&this._sceneGraphOverrideSet){var k=this._viewer.getSceneGraphOverrideSetManager();if(k){k.removeSceneGraphOverrideSet(this._sceneGraphOverrideSet);delete this._sceneGraphOverrideSet;this.createOverrideSet()}setTimeout(function(){j._viewer.render({updateInfinitePlane:true})})}},exclusiveShow:function(m){if(!d.is(m,"object")){throw new Error("No parameter defined")}if(!d.is(m.paths,"array")){throw new Error("No paths to be shown defined")}var l=this;l.resetState();var j=l._context.getController()._model._nodeIndex;var n=Object.getOwnPropertyNames(j);var k=l._context.getController()._model.getRootBag();n.forEach(function(q){if(j[q].is3DLeaf&&j[q].is3DLeaf()){var p=a.buildPathesLeadingToNode(j[q],k);p.forEach(function(s){var r=l._sceneGraphOverrideSet.createOverride(s);r.setVisibility(false)})}});m.paths.forEach(function(r){if(b.isAModelPath(r)){var p=r.getLastElement(true);if(p.is3DLeaf&&p.is3DLeaf()){var q=l._sceneGraphOverrideSet.createOverride(r);q.setVisibility(true)}else{var t=[];var s={};p.traverse(function(v){if(v.is3DLeaf&&v.is3DLeaf()&&!s[v.getID()]){s[v.getID()]=true;var u=a.buildPathesLeadingToNode(v,k);u.forEach(function(w){if(r.isAParentOf(w)){t.push(w)}})}});t.forEach(function(v){var u=l._sceneGraphOverrideSet.createOverride(v);u.setVisibility(true)})}}});var o=l._viewer.getSceneGraphOverrideSetManager();if(o){o.pushSceneGraphOverrideSet(l._sceneGraphOverrideSet)}setTimeout(function(){l._viewer.render({updateInfinitePlane:true})});this.publish({event:"onExclusiveShow",data:m})},toggleHideShow:function(l){var k=this;if(l.paths){var m=[],j=[];l.paths.forEach(function(o){if(b.isAModelPath(o)){while(o&&!b.isPLMNode(o.getLastElement(true))){o=o.getParentPath()}var n=k._viewer.getSceneGraphOverrideSetManager().getCurrentVisibility(o);if(n===null||n){j.push(o)}else{m.push(o)}}});if(m.length){this.show({paths:m,dispatch:l.dispatch,withLock:true})}if(j.length){this.hide({paths:j,dispatch:l.dispatch,withLock:true})}}},_onHideShow:function(l){if(!d.is(l,"object")&&!d.is(l.paths,"array")){console.error("No path to hide/show defined");return}var n=[];var m=[];var k=function(p,o){p.forEach(function(r){if(r.length){var q=this._context.unstreamPath(r);if(q){m.push(q)}}}.bind(this));if(l.action==="Hide"){this.hide({paths:m,dispatch:false,withLock:o})}else{if(l.action==="Show"){this.show({paths:m,dispatch:false,withLock:o})}}}.bind(this);for(var j=0;j<l.paths.length;++j){if(this._context.unstreamPath(l.paths[j])===null){n.push(l.paths[j])}}if(n.length===0){k(l.paths,true)}else{this._context.getController().expand({paths:n,progressiveExpand:false,expand_iter:"0",forceLoad:true,singleAdd:false,onComplete:function(o){if(!d.is(o,"object")){console.error("Incorrect data type in expand onComplete()");return}if(!d.is(o.selectedPaths,"array")){console.error("Incorrect data.selectedPaths type in expand onComplete()");return}k(l.paths,false)}.bind(this),onFailure:function(){console.warn("Something went wrong when trying to expand those paths.");return},},false,false)}},isVisible:function(k){var j=false;if(k&&this._viewer){j=this._viewer.getSceneGraphOverrideSetManager().getCurrentVisibility(k)===null?true:this._viewer.getSceneGraphOverrideSetManager().getCurrentVisibility(k)}return j},applyPGPHideShow:function(o){var p=this;var D=p._context.getController().getRootBag();if(o.references&&o.references.length>0){var u=[],r=[];for(var B=0;B<o.references.length;B++){var C=a.buildPathesLeadingToNode(p._context.getController().getNode({id:o.references[B].id}),D);if(o.references[B].value===false){u=u.concat(C)}if(o.references[B].value===true){r=r.concat(C)}}if(u.length){p.hide({paths:u,dispatch:false})}if(r.length){p.show({paths:r,dispatch:false})}}if(o.instances&&o.instances.length>0){var E=[],A=[];for(var z=0;z<o.instances.length;z++){var l=a.buildPathesLeadingToNode(p._context.getController().getNode({id:o.instances[z].id}),D);for(var y=0;y<l.length;y++){l[y].addElement(b.getReferences(l[y].getLastElement(true))[0])}if(o.instances[z].value===false){E=E.concat(l)}if(o.instances[z].value===true){A=A.concat(l)}}if(E.length){p.hide({paths:E,dispatch:false})}if(A.length){p.show({paths:A,dispatch:false})}}if(o.occurrences&&o.occurrences.length>0){for(var x=0;x<o.occurrences.length;x++){var s=[],F=[],v,t,q;t=p._context.unstreamPath(o.occurrences[x].path);t.substractPath(p._context.unstreamPath([o.occurrences[x].path[0],o.occurrences[x].path[1]]),t);q=a.buildPathesLeadingToNode(p._context.getController().getNode({id:o.occurrences[x].path[0]}),D);for(var w=0;w<q.length;w++){q[w].concatenatePathes(q[w],t);v=q[w];if(o.occurrences[x].value===false){s.push(v)}if(o.occurrences[x].value===true){F.push(v)}}if(s.length){p.hide({paths:s,dispatch:false})}if(F.length){p.show({paths:F,dispatch:false})}}}}});return d.namespace("DS/ENOPAD3DViewer/controller/PAD3DViewerHideShowController",e)});define("DS/ENOPAD3DViewer/models/PAD3DViewerTileNodeModel",["UWA/Class","UWA/Promise","DS/ENOPAD3DViewer/mixins/PAD3DViewerDebugTileNodeModel","DS/ENOPAD3DViewer/mixins/PAD3DViewerQueryParser","DS/3DXMTiles/OOCManager","DS/3DXMTiles/OOCModel3DHandler","DS/3DXMTiles/OOCHandler","DS/3DXMTiles/LDHReference","DS/3DXMTiles/Debug3DXMTiles","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/Visualization/ModelLoader","DS/Core/ModelEvents","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/PADUtils/PADProbes","DS/PADUtils/PADSettingsMgt","DS/VisuTools/FPSCounter"],function(o,b,h,a,p,d,g,i,m,k,n,r,l,q,f,c,e,j){var s=o.extend(h,a,{className:"PAD3DViewerTileNodeModel",init:function(u){var w=this;this._parent(u);this._modelEvents=new l();this._nodeIndex={};this._rootIndex={};this._hiddenRootIds=[];this._repList=[];this._rootLog=[];this._OOCManager=null;this._parsingRunning=false;this._getFcsUrlsCB=u.getFcsUrlsCB;this._nodeIndex[this.getRootBagId()]=new k("RootBag");u.viewer.addNode(this._nodeIndex[this.getRootBagId()]);this._decorationBag=new k("DecorationBag");u.viewer.addNode(this._decorationBag);this._loadingBoxesBag=new k("LoadingBoxesBag");u.viewer.addNode(this._loadingBoxesBag);var v=new n();v.addElement(this._nodeIndex[this.getRootBagId()]);this._nodeIndex[this.getRootBagId()].path=v;var t="full";if(navigator.userAgent.match(/iPad/i)){u.viewer.setSmallRenderTargetPicking(true);t="medium"}else{if(navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i)){u.viewer.setSmallRenderTargetPicking(true);t="restricted"}}window.OOCNewPriorityPrototype=true;this._OOCManager=new p(u.viewer,{config:t,forceSceneMin:true});this._OOCManager.setTargetNode(this.getRootBag());this._OOCManager.setOnStartLoadingCB(u.startLoadingCB);this._OOCManager.setOnEndLoadingCB(u.endLoadingCB);this._OOCManager.setTargetNode(this.getRootBag());this._OOCManager.setPerformancesOptions({pauseLoadingDuringViewpointMove:true});if(this._OOCManager.setMaxNbExpectedChildrenPerRequest){this._OOCManager.setMaxNbExpectedChildrenPerRequest(30000)}u.viewer.budgetedRenderManager.setBudget(0.1);window._modelDebugger=this;this._initOOCHandlers(u);if(window.localStorage.getItem("TileModelPerf")==="ON"){j.setAutoRefresh(false);u.viewer.showPerfo(true,false)}},getRootBagId:function(){return"rootBag"},getRootLog:function(){return this._rootLog.slice(0)},addToRootLog:function(t){this._rootLog.push(t)},getHiddenRootIds:function(t){if(t!==undefined){return this._hiddenRootIds[t]}else{return this._hiddenRootIds}},getOOCManager:function(){if(this._OOCManager!==undefined){return this._OOCManager}},destroy:function(){delete this._modelLoader;delete this._nodeIndex;delete this._hiddenRootIds;delete this._viewer;delete this._rootLog;if(this._modelEvents){delete this._modelEvents}this._parent()},_initOOCHandlers:function(t){this._model3DHandler=new d();this._model3DHandler.setLoadModelOptions({proxyurl:"none"});this._model3DHandler.setFileType(!e.getSetting("enopad3dviewer_streamFileType")?"cgr":e.getSetting("enopad3dviewer_streamFileType"));if(this._model3DHandler.setRedirectUrlCB){this._model3DHandler.setRedirectUrlCB(function(w,x){this._getFcsUrlsCB({urls:w,callbacks:{onComplete:function(y){if(y.results){x(y.results)}},onFailure:function(A){var z=[];for(var y=0;y<w.length;y++){z.push(null)}x(z)}}})}.bind(this))}var u=this;var v=function(w){g.call(this,g.InstRefHander);this._processing=false;this._expandCB=w.expandCB;this.manager=u._OOCManager};v.prototype=Object.create(g.prototype);v.prototype.isReady=function(){return this._processing===false};v.prototype.getBatchSize=function(){return e.getSetting("enopad3dviewer_LDHBatchSize")?e.getSetting("enopad3dviewer_LDHBatchSize"):100};v.prototype.getData=function(D,w){this._processing=true;var A={};var z=0;var y=0;for(z=0;z<D.length;z++){var E=D[z];var C=E.ids[0];if(A[C]===undefined){A[C]={idPaths:[],treatedRef:[]}}A[C].idPaths.push(E.ids);A[C].treatedRef.push(E.getLastId())}var x=Object.keys(A);var B=[];for(z=0;z<x.length;z++){if(A[x[z]].idPaths.length){B.push(new b(function(G,F){this._expandCB({paths:A[x[z]].idPaths,pixelCulling:(w.screenRadius*0.3).toFixed(),onComplete:function(H,K,I){if(this.manager.getNbChildren){for(y=0;y<H.length;y++){var L=H[y][H[y].length-1];var J=this.manager.getNbChildren(L);this.manager.setExpectedNbChildren(L,J)}}this.done(K,[],w);G()}.bind(this,A[x[z]].idPaths,A[x[z]].treatedRef),onFailure:function(){this.done([],treatedRef,w);G()}.bind(this,A[x[z]].idPaths,A[x[z]].treatedRef),singleAdd:false,progressiveExpand:true},false,false)}.bind(this)))}}b.all(B).then(function(){this._processing=false}.bind(this))};v.prototype.done=function(w,y,x){x.doneCB(w,y)};v.prototype.handlePathes=function(x,w){this.getData(x,w)};this._refHandler=new v(t)},_parseAttributes:function(u,t,z){var x=null;var w=u.length;var v=0;t.did=null;t.globalType=null;t.type=null;t.pid=null;t.thbUrl=null;t.cgrUrl=null;t.matrix=null;for(v=0;v<w;v++){x=u[v];if(x.name==="did"){t.did=x.value}else{if(x.name.toLowerCase()==="ds6w:globaltype"){t.globalType=x.value}else{if(x.name==="type"){t.type=x.value}else{if(x.name==="ds6w:type"){t.type=x.value}else{if(x.name==="physicalid"){t.pid=x.value}else{if(x.name==="thumbnail_3d"){t.thbUrl=x.value}else{if(x.name==="cgr"){t.cgrUrl=x.value}else{if(x.name==="matrixtxt"&&x.value!==""){if(x.value!=="1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"&&x.value!=="1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"&&x.value!=="1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0"){t.matrix=new q.Matrix4();var y=x.value.split(/[,]/);t.matrix.elements[0]=parseFloat(y[0]);t.matrix.elements[1]=parseFloat(y[1]);t.matrix.elements[2]=parseFloat(y[2]);t.matrix.elements[4]=parseFloat(y[3]);t.matrix.elements[5]=parseFloat(y[4]);t.matrix.elements[6]=parseFloat(y[5]);t.matrix.elements[8]=parseFloat(y[6]);t.matrix.elements[9]=parseFloat(y[7]);t.matrix.elements[10]=parseFloat(y[8]);t.matrix.elements[12]=parseFloat(y[9]);t.matrix.elements[13]=parseFloat(y[10]);t.matrix.elements[14]=parseFloat(y[11])}}}}}}}}}if(z&&z===x.name){t[x.name]=x.value}}},buildFromJSON:function(t){if(t.json&&t.json.infos&&t.json.infos.kind&&t.json.infos.kind==="InstRef"){this._buildFromJSONInstRef(t)}else{this._buildFromJSONOcc(t)}},unlockChildren:function(t){this._OOCManager.unlockChildren(t.id)},reparentNode:function(t){},insertExistingNode:function(t){},createNode:function(t){},removeNode:function(t){if(!UWA.is(t,"object")){throw new Error("No parameter defined")}if(t.id===undefined){console.error("No id defined");return}},removeRoot:function(u){if(!UWA.is(u,"object")){throw new Error("No parameter defined")}if(u.id===undefined){console.error("No id defined");return}for(var t=this._rootLog.length-1;t>=0;t--){if(UWA.is(this._rootLog[t],"array")){if(this._rootLog[t][0]===u.id){this._rootLog.splice(t,1)}}}if(this._rootIndex[u.id]&&this._rootIndex[u.id].occId){this._OOCManager.removeRoot(this._rootIndex[u.id].occId);delete this._rootIndex[u.id]}},detachNode:function(v){if(!UWA.is(v,"object")){throw new Error("No parameter defined")}if(v.id===undefined){console.error("No id defined");return}if(v.parentId===undefined){console.error("No parentId defined");return}var u=this.getNode({id:v.id});var t=this.getNode({id:v.parentId});if(u&&t){t.remove(u)}},attachNode:function(v){if(!UWA.is(v,"object")){throw new Error("No parameter defined")}if(v.id===undefined){console.error("No id defined");return}if(v.parentId===undefined){console.error("No parentId defined");return}var u=this.getNode({id:v.id});var t=this.getNode({id:v.parentId});if(u&&t){t.add(u);u.path=t.path.clone();u.path.addElement(u)}},switchNodeVisuStreamOnDemand:function(v){if(!UWA.is(v,"object")){throw new Error("No parameter defined")}if(!UWA.is(v.data,"array")){throw new Error("No input data defined")}if(!UWA.is(v.callbacks.onURLLoad,"function")){throw new Error("No onURLLoad callback function defined")}if(!UWA.is(v.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}var u=this;u.nbCgrLoaded=0;u.nbThbLoaded=0;var t=function(){u._nbURLToLoad--;u._nbURLLoaded++;if(u._nbURLToLoad===0){v.callbacks.onComplete({nbUrlLoaded:u._nbURLLoaded})}};u._nbURLToLoad=v.data.length;u._nbURLLoaded=0;v.data.forEach(function(x){var y=x.url;if(y&&x.stream!==x.node.getUserData().loadedStream){u._OOCManager.setReferenceLoadModelOptions(x.node.getModelIdentification(),{applicativeContainer:undefined===v.applicativeContainers?undefined:v.applicativeContainers,noMeshInRAM:undefined===v.noMeshInRAM?true:v.noMeshInRAM});var w=x.node.getUserData();w.loadedStream=x.stream;x.node.setUserData(w);if(x.stream==="cgr"){u.nbCgrLoaded++}else{u.nbThbLoaded++}if(x.stream!==(e.getSetting("enopad3dviewer_CGRorTHB")?"cgr":"thumbnail")){u.lockNodes({ids:[x.node.getModelIdentification()]})}else{u.unlockNodes({ids:[x.node.getModelIdentification()]})}u._OOCManager.switchLOD(x.node.getModelIdentification(),y,t)}else{u._nbURLToLoad--}});u.publish({event:"onUrlLoaded",data:{nbCgrLoaded:u.nbCgrLoaded,nbThbLoaded:u.nbThbLoaded}});if(!u._nbURLToLoad){v.callbacks.onComplete({nbUrlLoaded:u._nbURLLoaded})}},refreshStream:function(v){if(!UWA.is(v,"object")){throw new Error("No parameter defined")}if(!UWA.is(v.data,"array")){throw new Error("No input data defined")}if(!UWA.is(v.callbacks.onURLLoad,"function")){throw new Error("No onURLLoad callback function defined")}if(!UWA.is(v.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}var u=this;var t=null;u._nbURLToLoad=v.data.length;u._nbURLLoaded=0;u.nbCgrLoaded=0;u.nbThbLoaded=0;t=function(){u._nbURLToLoad--;if(u._nbURLToLoad===0){v.callbacks.onComplete()}};v.data.forEach(function(w){var x=w.url;if(w.stream==="cgr"){u.nbCgrLoaded++}else{u.nbThbLoaded++}u._OOCManager.setReferenceLoadModelOptions(w.node.getModelIdentification(),{applicativeContainer:v.applicativeContainers,noMeshInRAM:undefined===v.noMeshInRAM?true:v.noMeshInRAM});u._OOCManager.switchLOD(w.node.getModelIdentification(),x,t)});u.publish({event:"onUrlLoaded",data:{nbCgrLoaded:u.nbCgrLoaded,nbThbLoaded:u.nbThbLoaded}});if(!u._nbURLToLoad){v.callbacks.onComplete()}},isNodeLocked:function(t){return(this._OOCManager.getSceneGraphLockCounter(t)>0)?true:false},lockNodes:function(t){if(!UWA.is(t,"object")){console.error("Incorrect options type in addSceneGraphLock()");return}for(var u=0;u<t.ids.length;++u){this._OOCManager.addSceneGraphLock(t.ids[u])}},unlockNodes:function(t){if(!UWA.is(t,"object")){console.error("Incorrect options type in removeSceneGraphLock()");return}for(var u=0;u<t.ids.length;++u){this._OOCManager.removeSceneGraphLock(t.ids[u])}},getRootBag:function(){return this._nodeIndex.rootBag},getNode:function(t){if(!UWA.is(t,"object")){throw new Error("No parameter defined")}if(!UWA.is(t.id,"string")){console.error("No id defined");return}if(t.id==="rootBag"){return this.getRootBag()}else{return this._OOCManager.getSceneGraphNode(t.id)}},getRoot:function(t){if(!UWA.is(t,"object")){throw new Error("No parameter defined")}if(!UWA.is(t.id,"string")){console.error("No id defined");return}return this._rootIndex[t.id]},abort:function(t){while(this._parsingRunning){}if(this._rootIndex[t]&&this._rootIndex[t].occId){this._OOCManager.removeRoot(this._rootIndex[t].occId)}},pause:function(){if(this._OOCManager){this._OOCManager.setPauseLoading(true)}},resume:function(){if(this._OOCManager){this._OOCManager.setPauseLoading(false)}},getDecorationBag:function(){return this._decorationBag},getLoadingBoxesBag:function(){return this._loadingBoxesBag},publish:function(t){this.getModelEvents().publish(t)},subscribe:function(t,u){return this.getModelEvents().subscribe(t,u)},unsubscribe:function(t){this.getModelEvents().unsubscribe(t)},getModelEvents:function(){return this._modelEvents},getReferenceBoundingSphere:function(t){return this._OOCManager.getReferenceBoundingSphere(t).clone()},enableProgressiveBI:function(t){this._OOCManager.addUserQueue(t)},disableProgressiveBI:function(t){this._OOCManager.removeUserQueue(t)},displayCandidateQueue:function(t){if(t){this._OOCManager.setCandidateQueueRendererParams(true,{displayIntermediateReferences:true,repRefAttributes:{color:new q.Color(e.getSetting("enopad3dviewer_displayCandidateQueue_rep_color")),opacity:0.3,dimension:2,},refAttributes:{color:new q.Color(e.getSetting("enopad3dviewer_displayCandidateQueue_assembly_color")),opacity:1,dimension:1},rootNode:this.getLoadingBoxesBag()})}else{this._OOCManager.setCandidateQueueRendererParams(false)}},registerOverrideSet:function(t){this._OOCManager.registerOverrideSet(t)},setOverrideCB:function(u,v,t){this._OOCManager.setOverrideCB(u,v,t)},hasOverrideCB:function(u,t){var v=false;if(this._OOCManager.hasOverrideCB){v=this._OOCManager.hasOverrideCB(u,t)}return v},removeOverrideSet:function(t){this._OOCManager.removeOverrideSet(t)},createReferenceIterator:function(t){return this._OOCManager.createReferenceIterator(t)},setLoadingBoxesPickable:function(t){if(this._OOCManager.setLoadingBoxesPickable){if(t){this._OOCManager.setLoadingBoxesPickable(f.PICKABLE)}else{this._OOCManager.setLoadingBoxesPickable(f.NODRAWHL)}}},getOOCSelectedReferenceID:function(){var t=null;if(this._OOCManager){t=this._OOCManager.getSelectedReference()}return t},getOOCReference:function(u){var t=null;if(this._OOCManager){t=this._OOCManager._getLDHReference(u)}return t},getWorldMatrix:function(u){var t=null;if(this._OOCManager){t=this._OOCManager.getWorldMatrix(this._rootIndex[u[0]].occId,u)}return t}});return s});define("DS/ENOPAD3DViewer/commands/PAD3DViewerNavigateOnSelectionCmd",["UWA/Core","UWA/Promise","DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/PADUtils/PADUtilsServices","DS/Selection/HSOManager","DS/PADUtils/PADCommandProxy","DS/PADUtils/PADContext","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADPager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(g,m,d,f,h,e,b,k,j,l,c,i,n){var a=d.extend({name:"PAD3DViewerNavigateOnSelectionCmd",init:function(o){var p=this;this._parent(o,{mode:"shared",isAsynchronous:true});this._CBTokens=[];this._view=null;this._selection=[];this._selectedIdx=null;this._previousCB=null;this._nextCB=null;this._closeCB=null;this._csoChangeCB=null;this._escapeCB=null;this._lockedNodes=[];this.useModelBoundingSphere=false;this._context=k.get(this.options.context);this._commandProxy=b.create();this._CBTokens.push(this._context.subscribe({event:"onClosePager"},function(){if(p._view!==null){p._view.hide()}}));this._CBTokens.push(this._context.subscribe({event:"onFocusChange"},function(q){p.focusChange(q)}));this._escapeCB=function(q){if(q.keyCode===27){this.end();this.restoreSelection();this._context.reframe();this._context.reframeSelection()}}.bind(this)},focusChange:function(p){var o=this;if(o._selection){if(p.event=="previous"){o._selectedIdx--;o.reframeOn(o.useModelBoundingSphere)}if(p.event=="next"){o._selectedIdx++;o.reframeOn(o.useModelBoundingSphere)}}},execute:function(o){return new m(function(q,p){this.prepareCSOData(o).then(function(t){document.addEventListener("keyup",this._escapeCB);this.useModelBoundingSphere=t;this._selectedIdx=0;var s=[];s=f.get().slice();this._internalCSOChange=false;var u=this;if(s.length>1){for(var r=0;r<s.length;r++){if(s[r].pathElement!==null){this._selection.push(s[r])}}if(null===this._view){this._view=new l({renderTo:this._context.elements.view_container});this._previousCB=this._view.subscribe({event:"previous"},function(){u.focusChange({event:"previous"});u._commandProxy.focusChange3D({sharedID:h.getSharedId(),event:"previous"})});this._nextCB=this._view.subscribe({event:"next"},function(){u.focusChange({event:"next"});u._commandProxy.focusChange3D({sharedID:h.getSharedId(),event:"next"})});this._closeCB=this._view.subscribe({event:"close"},function(){u.end();u.restoreSelection();u._context.reframe();u._context.reframeSelection()})}this.reframeOn(t);this._view.show();this._csoChangeCB=f.onRemove(function(){if(!u._internalCSOChange){u.end()}})}else{if(s.length===1){if(s[0].pathElement!==null){this._selection=s;this.reframeOn(t);this._csoChangeCB=f.onRemove(function(){if(!u._internalCSOChange){u.end()}})}}else{console.log("CSO selection is empty");u.end()}}q()}.bind(this))}.bind(this))},restoreSelection:function(){var o=this;o._context.lockSelectionBroadcast(false);if(o.originalSelection.length){o.originalSelection.forEach(function(q){var p=o._context.unstreamPath(q);if(p!==null){f.add({pathElement:p});e.add({pathElement:p})}})}},end:function(){this._context.getController().unlockNodes({ids:this._lockedNodes});this._context._reframeFocus=false;this._selection=[];this._selectedIdx=null;this._previousCB=null;this._nextCB=null;this._closeCB=null;this._lockedNodes=[];f.empty();e.empty();if(this._escapeCB){document.removeEventListener("keyup",this._escapeCB)}if(this._csoChangeCB){f.unsubscribe(this._csoChangeCB)}if(this._view){this._view.hide()}},prepareCSOData:function(o){return new m(function(r){var s=function(t){this._context.lockSelectionBroadcast(true);this.originalSelection=t;f.empty();e.empty();var u=this._context._controller.getHiddenRootIds();t.forEach(function(w){if(u.indexOf(w[0])===-1){var v=this._context.unstreamPath(w);f.add({pathElement:v});e.add({pathElement:v})}}.bind(this))}.bind(this);var q=[];if(j.getSetting("enopad3dviewer_lightNodeModel")===true){for(var p=0;p<o.length;++p){if(this._context.unstreamPath(o[p])===null){q.push(o[p])}}}if(q.length===0){s(o);if(j.getSetting("enopad3dviewer_lightNodeModel")===true){r(true)}else{r(false)}}else{this._context.getController().expand({paths:q,progressiveExpand:false,expand_iter:"0",singleAdd:false,onComplete:function(u){if(!g.is(u,"object")){console.error("Incorrect data type in expand onComplete()");return}for(var t=0;t<o.length;++t){this._lockedNodes.push(o[t][o[t].length-1])}this._context.getController().lockNodes({ids:this._lockedNodes});s(o);r(true)}.bind(this)})}}.bind(this))},reframeOn:function(r){if(this._selectedIdx===-1){this._selectedIdx=this._selection.length-1}var o=this._selectedIdx%this._selection.length;if(this._view){var q=(o+1)+"/"+this._selection.length;this._view.setLabel(q)}this._internalCSOChange=true;this._context._reframeFocus=true;this._context.lockSelectionBroadcast(true);f.empty();e.empty();f.add(this._selection[o]);e.add(this._selection[o]);this._internalCSOChange=false;this._context.lockSelectionBroadcast(false);if((this._context.getHideShowController()&&!this._context.getHideShowController().isVisible(this._selection[o].pathElement)&&this._context._viewer.getVisibleSpace()===1)||(this._context.getHideShowController()&&this._context.getHideShowController().isVisible(this._selection[o].pathElement)&&this._context._viewer.getVisibleSpace()===0)){this._context.displayNotification({eventID:"info",msg:n.swapToSeeSelection})}var s=this._context.getController().getReferenceBoundingSphere(c.getNodeID(this._selection[o].pathElement.externalPath[this._selection[o].pathElement.externalPath.length-1]));if(s&&r===true){var p=this._selection[o].pathElement.getWorldMatrix();p.multiplyVector3(s.center);i.reframeOn({BS:s,viewpoint:this._context.getViewpoint()})}else{i.reframeOn({paths:[this._selection[o].pathElement],viewpoint:this._context.getViewpoint()})}}});return g.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerNavigateOnSelectionCmd",a)});define("DS/ENOPAD3DViewer/mixins/PAD3DViewerLoadingBoxesEngine",["UWA/Core","UWA/Class","DS/CoreEvents/Events","DS/PADUtils/PADSettingsMgt","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(f,a,d,b,c){var e=a.extend({name:"PAD3DViewerLoadingBoxesEngine",_boxesDisplayToken:null,_visuEventToken:null,_realMove:false,_memoryLimitToken:null,_boxesRemovalToken:null,_expandToken:null,_enforceLoadingBoxesDisplay:false,setupLoadingBoxesEngine:function(){if(this.isSelectiveLoadingActivated()){if(b.getSetting("enopad3dviewer_displayCandidateQueue")){this._clearVisuEventCallback();this._visuEventToken=d.subscribe({event:"/VISU/"},function(g){switch(g.eventType){case"@onViewpointChange":this._realMove=true;break;case"@onViewpointBeginMove":case"@onViewpointBeginMove_bis":this._clearBoxesDisplayTimeout();this._clearBoxesRemovalTimeout();break;case"@onViewpointEndMove":case"@onViewpointEndMove_bis":if(this._realMove){this._realMove=false;this._clearBoxesDisplayTimeout();this._clearBoxesRemovalTimeout();if(!this._enforceLoadingBoxesDisplay){this._boxesRemovalToken=setTimeout(function(){this._boxesRemovalToken=null;this.toggleLoadingBoxesDisplay(false)}.bind(this),1000)}this._boxesDisplayToken=setTimeout(function(){this._boxesDisplayToken=null;this.toggleLoadingBoxesDisplay(true)}.bind(this),parseInt(b.getSetting("enopad3dviewer_displayCandidateQueueTimeout"))*1000)}break}}.bind(this));this._memoryLimitToken=this.subscribe({event:"onEndProgressiveLoad"},function(g){this.toggleLoadingBoxesDisplay(true);this.getController()._model.setLoadingBoxesPickable(true)}.bind(this));this._memoryLimitToken=this.subscribe({event:"onStartProgressiveLoad"},function(g){this.getController()._model.setLoadingBoxesPickable(false)}.bind(this))}else{this.toggleLoadingBoxesDisplay(false);this.disposeLoadingBoxesEngine()}}},toggleLoadingBoxesDisplay:function(g){if(this.isSelectiveLoadingActivated()&&this.getController()&&this.getController()._model&&g!==undefined){if(g&&b.getSetting("enopad3dviewer_displayCandidateQueue")){this.getController()._model.displayCandidateQueue(true)}else{if(!g){this.getController()._model.displayCandidateQueue(false)}}}},_clearBoxesDisplayTimeout:function(){if(this._boxesDisplayToken){clearTimeout(this._boxesDisplayToken);this._boxesDisplayToken=null}},_clearBoxesRemovalTimeout:function(){if(this._boxesRemovalToken){clearTimeout(this._boxesRemovalToken);this._boxesRemovalToken=null}},_clearVisuEventCallback:function(){if(this._visuEventToken){d.unsubscribe(this._visuEventToken);this._visuEventToken=null}},_clearMemoryLimitCallback:function(){if(this._memoryLimitToken){this.unsubscribe(this._memoryLimitToken);this._memoryLimitToken=null}},disposeLoadingBoxesEngine:function(){if(this.isSelectiveLoadingActivated()){this._clearVisuEventCallback();this._clearMemoryLimitCallback();this._clearBoxesDisplayTimeout()}}});return e});define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerBIController",["UWA/Core","UWA/Controls/Abstract","DS/PADUtils/PADPromise","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/PADUtils/PADSettingsMgt","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Visualization/SceneGraphUtils","DS/PADUtils/PADUtilsServices","DS/Utilities/Utils"],function(f,h,g,d,l,c,j,i,b,a,e,k){var m=h.extend({name:"PAD3DViewerBIController",_userQueueCallbacks:{},_overloadedNodes:[],_modelControllerTokens:[],_mode:null,_isColorizeActive:false,_refineOverrideSet:null,_biOverrideSet:null,_biCommandProxy:null,_overrideSetId:"biColorOverride",_biRootAddedEvents:-1,_biRootRemovedEvents:-1,_cbCounter:0,initBIController:function(){this._viewer=this._context.getViewer();this._refineOverrideSet=new i(this.getRootBagPath().externalPath[0]);this._biOverrideSet=new i(this.getRootBagPath().externalPath[0])},destroyBIController:function(){if(this._viewer){delete this._viewer}if(this._biCommandProxy){this._biCommandProxy.destroy();delete this._biCommandProxy}delete this._refineOverrideSet;delete this._biOverrideSet;this._parent()},onSetTagsWithExpandSynthesis:function(){if(this.isStandaloneFilterAvailable()===true){if(this._BIProxy){var o=[];this.getRoots().forEach(function(p){var q=b.getNodeID(p);if(q){o.push(q)}});if(this._BIProxy.setTagsWithExpandSynthesis){var n={no_type_filter_bo:["PLMPort","PLMConnection"],synthesis_mode:"flat",max_count_path:"1"};if(o.length){this._BIProxy.setTagsWithExpandSynthesis(o,n)}}else{console.warn("onSetTagsWithExpandSynthesis: The BIProxy doesn't implement the setTagsWithExpandSynthesis() method.")}}else{console.warn("onSetTagsWithExpandSynthesis: The PAD3DViewerController doesn't contains a BIProxy object.")}}},toggleBetweenStandaloneAndSlaveMode:function(n){if(n===this._biMode){return}if(n==="STANDALONE"){this._activateStandaloneMode()}else{if(n==="SLAVE"){this._activateSlaveMode()}}},_activateStandaloneMode:function(){this._biMode="STANDALONE";this._resetShading();this._resetFiltering();this._BIProxy.addEvent("FilterBIColorize",this._onFilterBIColorize,this);this._BIProxy.addEvent("FilterBIUnColorize",this._onFilterBIUnColorize,this);this._biRootAddedEvents=this.subscribe({event:"onRootAdded"},this.onSetTagsWithExpandSynthesis.bind(this));this._biRootRemovedEvents=this.subscribe({event:"onEndRootRemoved"},this._rootRemovedProxyEvent.bind(this));this.registerOverrideSet(this._overrideSetId)},_activateSlaveMode:function(){this._biMode="SLAVE";this._resetShading();this._resetFiltering();this._modelControllerTokens.forEach(function(n){this._context.unsubscribe(n)}.bind(this));this._modelControllerTokens=[];if(this._biRootAddedEvents!==-1){this._clearRootEvents()}if(this._context.isInterwidgetComAvailable()&&!this._biCommandProxy){require(["DS/PADUtils/PADCommandProxy"],function(o){var n=this;this._biCommandProxy=o.create({events:{onPadFilterBI:function(p){if(!n.isStandalone()){if(p.filterBIColorize){n._onFilterBIColorize(p.filterBIColorize)}else{if(p.filterBIUnColorize){n._onFilterBIUnColorize(p.filterBIUnColorize)}else{if(p.filterBIFilteringEvent){n._onFilterBIRefineEvent(p.filterBIFilteringEvent)}else{if(p.filterBIUnFilterEvent){n._onFilterBIUnFilter()}}}}}},onApplyFilter:function(p){n.applyFilter(p,false)},onPadDestroy:function(){if(!n.isStandalone()){n._resetShading();n._resetFiltering()}}}})}.bind(this))}},_rootRemovedProxyEvent:function(o){if(this.isStandaloneFilterAvailable()===true){if(o.ids){this._BIProxy.resetNGFilterUI({widgetId:e.getWidgetId(),appId:e.getSharedId(),rootIds:o.ids});for(var n=0;n<o.ids.length;n++){this._BIProxy.removeRoot(o.ids[n])}}}},_onFilterBIColorize:function(p){if(this.isColorizeAvailable()===true){var n=this;var o=g.getPromises().slice();g.createPromise(function(r,q){Promise.all(o).then(function(D){n._isColorizeActive=true;o=null;n._resetShading();function B(G,F){if(f.is(G.coloredSubjects,"array")){G.coloredSubjects.forEach(function(I){var H=I.color;var J=I.path.map(function(K){return G.nodes[K]});F(H,J)})}}function v(){var F=n._viewer.getSceneGraphOverrideSetManager();if(F){F.pushSceneGraphOverrideSet(n._biOverrideSet)}n._viewer.render();n.publish({event:"onBIColorize",});r()}function u(F,G){if(F.length===0){return}n.getAttributes({ids:F,attributes:[n._colorMap.predicate],callbacks:{onComplete:function(L){var K=Object.keys(L);if(j.getSetting("enopad3dviewer_lightNodeModel")===true){for(var H=0;H<K.length;++H){if(!n.hasOverrideCB(K[H],n._overrideSetId)&&L[K[H]]){n.setOverrideCB(K[H],function(P,O){var Q=true;var N=n._colorMap.map[L[P][n._colorMap.predicate]];if(!N){Q=false;N=!N?"#FFFFFF":N}O.setColor(N,Q)},n._overrideSetId)}}}else{for(var H=0;H<K.length;++H){var J=n._model._nodeIndex[K[H]];var I=new l.MeshPhongMaterial({color:y.map[L[K[H]][y.predicate]],side:l.DoubleSide});var M=a.buildPathesLeadingToNode(J,n.getRootBag());M.forEach(function(O){var N=n._biOverrideSet.createOverride(O);N.setMaterial(I,true)});J.setBIColor(y.map[L[K[H]][y.predicate]]);n._overloadedNodes.push(J)}v()}n._viewer.render({updateInfinitePlane:true});if(G){G()}r()},onFailure:function(H){console.log(H)}}})}if(n._viewer){var t=n._model.getRootBag();if(n.isStandalone()){if(f.is(p.tagColors,"array")){var y={map:{},predicate:undefined};p.tagColors.forEach(function(F){if(y.predicate===undefined){var H=F.predicate.split("/");var G=H[H.length-1];y.predicate=G.toLowerCase()}y.map[F.object]=F.color});n._colorMap=y;if(j.getSetting("enopad3dviewer_lightNodeModel")===false){var E=Object.keys(n._model._nodeIndex);var s=[];for(var A=0;A<E.length;++A){var x=n._model._nodeIndex[E[A]];if(b.is3DLeaf(x)){var C=b.getReferences(x);for(var z=0;z<C.length;++z){s.push(b.getNodeID(C[z]))}if(s.length===1000){u(s);s=[]}}}u(s)}else{var w=false;n._userQueueCallbacks={handleReferences:function(N,G){w=true;var P=[];var F=[];for(var K=0;K<N.length;++K){var L=n.createReferenceIterator(N[K]);var M=L.getParents();for(var J=0;J<M.length;++J){var H=M[J].getReferenceId();if(H&&P.indexOf(H)===-1){P.push(H)}}F.push(L.getReferenceId())}var O=this;var I=function(){O.done(F,[],G)};u(P,I)},getBatchSize:function(){return 1000},isReady:function(){return w===false},done:function(F,H,G){w=false;G.doneCB(F,H)},onFailure:function(F){console.log(F)}};n._model.enableProgressiveBI(n._userQueueCallbacks)}}}else{if(p.nodes){p.nodes.forEach(function(F){var H=n._context.getController().getNode({id:F.pid});if(H&&F.color){H.setBIColor(F.color);n._overloadedNodes.push(H);var I=a.buildPathesLeadingToNode(H,t);var G=new l.MeshPhongMaterial({color:F.color,side:l.DoubleSide});I.forEach(function(K){var J=n._biOverrideSet.createOverride(K);J.setMaterial(G,false)})}});p.path.forEach(function(K){var H=[];K.forEach(function(L){H.push(p.nodes[L].pid)});var J=n._context.unstreamPath(H,true);if(J){var F=J.getLastElement(true).getBIColor();if(F!==null){var I=new l.MeshPhongMaterial({color:J.getLastElement(true).getBIColor(),side:l.DoubleSide});var G=n._biOverrideSet.createOverride(J);G.setMaterial(I,true)}}})}v()}}})},"filterBIColorize",false)}},_onFilterBIUnColorize:function(){if(this.isColorizeAvailable()===true){var n=this;var o=g.getPromises().slice();g.createPromise(function(q,p){Promise.all(o).then(function(r){n._model.disableProgressiveBI(n._userQueueCallbacks);o=null;n._resetShading();n._isColorizeActive=false;n._context.getLevelSelectorCommand(function(s){s.endExecute()});n.publish({event:"onBIUnColorize",});q()})},"filterBIUnColorize")}},colorizeNewNodes:function(r){if(this.isColorizeAvailable()===true){if(j.getSetting("enopad3dviewer_lightNodeModel")===true){for(var q=0;q<r.leavesToColorize.length;q++){var n=this.createReferenceIterator(r.leavesToColorize[q]);var p=n.getParents();for(var o=0;o<p.length;++o){var s=p[o].getReferenceId();if(!this.hasOverrideCB(s,this._overrideSetId)&&r.hashMap[s]){this.setOverrideCB(s,function(v,u){var w=true;var t=this._colorMap.map[r.hashMap[v][this._colorMap.predicate]];if(!t){w=false;t=!t?"#FFFFFF":t}u.setColor(t,w)}.bind(this),this._overrideSetId)}}}this._viewer.render()}else{console.warn("colorizeNewNodes: This method must be called in light node model only.")}}},_onFilterBIUnFilter:function(){if(this.isColorizeAvailable()===true){var n=this;var o=g.getPromises().slice();g.createPromise(function(q,p){Promise.all(o).then(function(r){n._resetFiltering();n.publish({event:"onBIUnFiltering",});q()})},"filterBIUnFilter")}},_resetShading:function(){if(this.isColorizeAvailable()===true){var n=this;if(this._viewer){if(j.getSetting("enopad3dviewer_lightNodeModel")===true){n.removeOverrideSet(n._overrideSetId);n.registerOverrideSet(n._overrideSetId)}else{if(n._overloadedNodes&&n._overloadedNodes.length){n._overloadedNodes.forEach(function(p){if(typeof p!=="string"){p.setBIColor(null)}});var o=this._viewer.getSceneGraphOverrideSetManager();if(o&&this._biOverrideSet){o.removeSceneGraphOverrideSet(this._biOverrideSet);delete this._biOverrideSet;this._biOverrideSet=new i(this._context.getController().getRootBagPath().externalPath[0])}}n._overloadedNodes=[]}n._viewer.render({updateInfinitePlane:true})}}},_resetFiltering:function(){if(this.isColorizeAvailable()===true){var n=this;if(n._viewer&&this._refineOverrideSet){var o=this._viewer.getSceneGraphOverrideSetManager();if(o){o.removeSceneGraphOverrideSet(this._refineOverrideSet);delete this._refineOverrideSet;this._refineOverrideSet=new i(this._context.getController().getRootBagPath().externalPath[0])}n._viewer.render({updateInfinitePlane:true})}}},getBIProxy:function(){return this._BIProxy},isColorizeActivated:function(){return this._isColorizeActive},isStandalone:function(){return(this._biMode==="STANDALONE")},getBIColorMap:function(){return f.clone(this._colorMap,true)},isColorizeAvailable:function(){var p=j.getSetting("enopad3dviewer_roles");var n=false;if(p){for(var o=0;o<p.length;o++){if(p[o].id==="CSV"||p[o].id==="InternalDS"){n=true;break}}}return(n&&this._BIMode!=="OFF")},applyPGPColor:function(B){var y=this;var o=y._context.getController().getRootBag();if(B.references&&B.references.length>0){var r=[];for(var x=0;x<B.references.length;x++){var A=a.buildPathesLeadingToNode(y._context.getController().getNode({id:B.references[x].id}),o);if(B.references[x].type==="color"){r=refShowPaths.concat(A)}}if(r.length){}}if(B.instances&&B.instances.length>0){var C=[];for(var w=0;w<B.instances.length;w++){var u=a.buildPathesLeadingToNode(y._context.getController().getNode({id:B.instances[w].id}),o);for(var v=0;v<u.length;v++){u[v].addElement(b.getReferences(u[v].getLastElement(true))[0])}if(B.instances[w].type==="color"){C=C.concat(u)}}if(C.length){}}if(B.occurrences&&B.occurrences.length>0){for(var q=0;q<B.occurrences.length;q++){var D=[],t,s,z;s=y._context.unstreamPath(B.occurrences[q].path);s.substractPath(y._context.unstreamPath([B.occurrences[q].path[0],B.occurrences[q].path[1]]),s);z=a.buildPathesLeadingToNode(y._context.getController().getNode({id:B.occurrences[q].path[0]}),o);for(var p=0;p<z.length;p++){z[p].concatenatePathes(z[p],s);t=z[p];if(B.occurrences[q].type==="color"){}}if(D.length){}}}}});return m});define("DS/ENOPAD3DViewer/models/PAD3DLayer",["DS/ENOPAD3DViewer/views/PAD3DLayerView","DS/PADUtils/PADSettingsMgt","DS/Core/ModelEvents","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/Node3D"],function(b,c,f,a,e){function d(g){this._view=null;this._node3DBag=null;this._overrideSet=null;this._uuid=g.UUID;this._overrideSetId=g.UUID;this._label=g.label;this._viewer=g.viewer;this._controller=g.controller;this._decorationBag=g.decorationBag;this._overrideSetManager=g.viewer.getSceneGraphOverrideSetManager();this._buildView(g);this._buildOverrideSet(g);this._buildNode(g);this._bindEvents()}d.prototype.getID=function(){return this._uuid};d.prototype.getOverrideSet=function(){return this._overrideSet};d.prototype.getOverrideSetID=function(){return this._overrideSetId};d.prototype.getNode3DBag=function(){return this._node3DBag};d.prototype.show=function(){this._addNodeBagToSG();this._pushOverrideSet()};d.prototype.hide=function(){this._removeNodeBagFromSG();this._removeOverrideSet()};d.prototype.render=function(){return this._view.render()};d.prototype.destroy=function(){this._removeOverrideSet();this._removeNodeBagFromSG();this._view.destroy();delete this._view;delete this._node3DBag;delete this._uuid;delete this._modelEvents;delete this._overrideSet;delete this._overrideSetManager;delete this._overrideSetId;delete this._controller;delete this._viewer};d.prototype.getModelEvents=function(g){return this._modelEvents};d.prototype.publish=function(g){this.getModelEvents().publish(g)};d.prototype.subscribe=function(g,h){return this.getModelEvents().subscribe(g,h)};d.prototype.unsubscribe=function(g){this.getModelEvents().unsubscribe(g)};d.prototype._buildView=function(){this._view=new b({label:this._label})};d.prototype._buildOverrideSet=function(g){if(c.getSetting("enopad3dviewer_lightNodeModel")){this._controller.registerOverrideSet(this.getOverrideSetID())}else{this._overrideSet=new a(g.rootBag)}this._pushOverrideSet()};d.prototype._buildNode=function(g){this._node3DBag=new e(g.root);this._addNodeBagToSG()};d.prototype._pushOverrideSet=function(){if(c.getSetting("enopad3dviewer_lightNodeModel")){this._controller.registerOverrideSet(this.getOverrideSetID())}else{if(this._overrideSetManager&&this._overrideSet&&this._overrideSet.getOverrides().length){this._overrideSetManager.pushSceneGraphOverrideSet(this._overrideSet)}}this._viewer.render()};d.prototype._removeOverrideSet=function(){if(c.getSetting("enopad3dviewer_lightNodeModel")){this._controller.removeOverrideSet(this.getOverrideSetID())}else{if(this._overrideSetManager&&this._overrideSet){this._overrideSetManager.removeSceneGraphOverrideSet(this._overrideSet)}}this._viewer.render()};d.prototype._addNodeBagToSG=function(){this._decorationBag.add(this._node3DBag)};d.prototype._removeNodeBagFromSG=function(){this._decorationBag.remove(this._node3DBag)};d.prototype._bindEvents=function(){this._modelEvents=new f();this._view.subscribe({event:"show"},function(){this.show();this.publish({event:"show",data:{id:this.getID(),layer:this}})}.bind(this));this._view.subscribe({event:"hide"},function(){this.hide();this.publish({event:"hide",data:{id:this.getID(),layer:this}})}.bind(this));this._view.subscribe({event:"delete"},function(){this.publish({event:"delete",data:{id:this.getID(),layer:this}})}.bind(this))};return d});define("DS/ENOPAD3DViewer/models/PAD3DViewerNode",["DS/Visualization/Node3D","DS/ENOPAD3DViewer/utils/PAD3DViewerTypesDictionary"],function(c,b){function a(f,e,g){e=f.length;if(e>1){while(g=--e){while(g--){if(f[e]===f[g]){f.splice(g,1)}}}}return f}var d=c.extend({className:"PAD3DViewerNode",_id:null,_type:null,_treeOrder:null,_loadedStream:null,_BIColor:null,_sequence_filter:null,_config_filter:null,_CVFilterQuery:null,_globalType:null,init:function(e){this._parent();if(e.id){this._id=e.id}if(e.type){this._type=e.type}if(e.BIColor){this._BIColor=e.BIColor}if(e.treeOrder){this._treeOrder=e.treeOrder}if(e.globalType){this._globalType=e.globalType}if(e.sequence_filter){this._sequence_filter=e.sequence_filter}if(e.config_filter){this._config_filter=e.config_filter}if(e.CVFilterQuery){this._CVFilterQuery=e.CVFilterQuery}},getID:function(){return this._id},_setID:function(e){this._id=e},getDid:function(){console.warn("Deprecated: did is not stored on the node anymore, please request it using getAttributes API on PAD3DViewerController");return null},getCgrUrl:function(){console.warn("Deprecated: cgr url is not stored on the node anymore, please request it using getAttributes API on PAD3DViewerController");return null},getThbUrl:function(){console.warn("Deprecated: thb url is not stored on the node anymore, please request it using getAttributes API on PAD3DViewerController");return null},getLoadedStream:function(){return this._loadedStream},setLoadedStream:function(e){this._loadedStream=e},getType:function(){return this._type},getGlobalType:function(){return this._globalType},getBIColor:function(){return this._BIColor},setBIColor:function(e){this._BIColor=e},getTreeOrder:function(){return this._treeOrder},getSequenceFilter:function(){return UWA.clone(this._sequence_filter,true)},setSequenceFilter:function(e){this._sequence_filter=e},getConfigFilter:function(){return UWA.clone(this._config_filter,true)},setConfigFilter:function(e){this._config_filter=e},getCVFilterQuery:function(){return UWA.clone(this._CVFilterQuery,true)},setCVFilterQuery:function(e){this._CVFilterQuery=e},isPLMInstance:function(){return b.get().instances.indexOf(this.getType())!==-1||this.getGlobalType()==="ds6w:Instance"},isPLMRepInstance:function(){return b.get().repInstances.indexOf(this.getType())!==-1||this.getGlobalType()==="ds6w:RepInstance"},isPLMRepReference:function(){return b.get().repReferences.indexOf(this.getType())!==-1||this.getGlobalType()==="ds6w:Document"},isPLMReference:function(){return b.get().references.indexOf(this.getType())!==-1||this.getGlobalType()==="ds6w:Part"},is3DLeaf:function(){return(b.get().representations.indexOf(this.getType())!==-1||this.getGlobalType()==="ds6w:Document")},equals:function(f){var e=false;if(f.getID){e=this.getID()===f.getID()}return e},getSiblings:function(){var f=[],e=this;this.parents.forEach(function(g){g.children.forEach(function(h){if(!h.equals(e)){f.push(h)}})});return a(f)},getReferences:function(){var e=[];if(this.isPLMInstance()){e=this.children}else{if(this.isPLMReference()){e.push(this)}else{if(this.isPLMRepReference()){this.parents.forEach(function(f){e=e.concat(f.parents)})}else{if(this.isPLMRepInstance()){e=this.parents}}}}return a(e)},isLeaf:function(){var e=true;this.children.forEach(function(f){if(f.isPLMRepInstance&&!f.isPLMRepInstance()){e=false}});return this.isPLMReference()&&e},getRootReferences:function(e){if(!e){e=[]}if(this.parents.length===1&&this.parents[0].name==="RootBag"){e.push(this);return a(e)}else{this.parents.forEach(function(f){if(f.getRootReferences){f.getRootReferences(e)}});return a(e)}}});return d});define("DS/ENOPAD3DViewer/models/PAD3DViewerNodeModel",["UWA/Class","DS/ENOPAD3DViewer/models/PAD3DViewerNode","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/Visualization/ModelLoader","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/PADUtils/PADProbes","DS/PADUtils/PADSettingsMgt","DS/Core/ModelEvents","DS/3DXMTiles/OOCManager","DS/3DXMTiles/OOCModel3DHandler"],function(b,m,j,f,a,l,d,k,i,c,h,g){var e=b.extend({className:"PAD3DViewerNodeModel",init:function(o){var q=this;this._parent(o);this._modelEvents=new c();this._nodeIndex={};this._rootLog=[];this._hiddenRootIds=[];this._modelLoader=null;this._parsingRunning=false;this._withRepLoading=true;if(window.localStorage.getItem("ENOPADNoGeometry")){this._withRepLoading=false}this._selectiveLoadingActivated=i.getSetting("enopad3dviewer_dynamicRepLoading");this._supportPgpBasedOnDescription=i.getSetting("supportPgpBasedOnDescription");this._getFcsUrlsCB=o.getFcsUrlsCB;this._nodeIndex[this.getRootBagId()]=new j("RootBag");o.viewer.addNode(this._nodeIndex[this.getRootBagId()]);this._decorationBag=new j("DecorationBag");o.viewer.addNode(this._decorationBag);this._loadingBoxesBag=new j("LoadingBoxesBag");o.viewer.addNode(this._loadingBoxesBag);var p=new f();p.addElement(this._nodeIndex[this.getRootBagId()]);this._nodeIndex[this.getRootBagId()].path=p;this._modelLoader=new a(o.viewer.getWebGLContext(),false);this._modelLoader.setFileType("cgr");this._modelLoader.setRenderCallback(o.viewer.render,1000);this._modelLoader.setCGRNewInfra(true);this._modelLoader.setSceneGraph(this._nodeIndex[this.getRootBagId()]);if(this._selectiveLoadingActivated){this._modelLoader.setKeepLoaderMode(true);o.viewer.budgetedRenderManager.setBudget(0.1);var n="full";if(navigator.userAgent.match(/iPad/i)){o.viewer.setSmallRenderTargetPicking(true);n="medium"}else{if(navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i)){o.viewer.setSmallRenderTargetPicking(true);n="restricted"}}window.OOCNewPriorityPrototype=true;this._OOCManager=new h(o.viewer,{config:n});this._OOCManager.setTargetNode(this.getRootBag());this._OOCManager.setOnStartLoadingCB(o.startLoadingCB);this._OOCManager.setOnEndLoadingCB(o.endLoadingCB);this._OOCManager.setUnloadLeafReferenceCB(function(s){var t=q.getNode({id:s});if(t){for(var r=t.children.length-1;r>=0;r--){if(t.children[r].className==="PAD3DViewerCGRNode"){t.remove(t.children[r])}}this.publish({event:"onLeafReferenceUnloaded",data:{id:s}})}}.bind(this));this._OOCManager.setOnLeafReferenceLoadedCB(function(r,s){if(s&&s.nodes){s.nodes.forEach(function(t){t.className="PAD3DViewerCGRNode"})}this.publish({event:"onLeafReferenceLoaded",data:{id:r}})}.bind(this));this._OOCManager.setTargetNode(this.getRootBag());this._OOCManager.setPerformancesOptions({pauseLoadingDuringViewpointMove:true});window._OOCManager=this._OOCManager;this._model3DHandler=new g();this._model3DHandler.setFileType(!i.getSetting("enopad3dviewer_streamFileType")?"cgr":i.getSetting("enopad3dviewer_streamFileType"));this._model3DHandler.setLoadModelOptions({proxyurl:"none"});if(i.getSetting("enopad3dviewer_useStaticURL")&&this._model3DHandler.setRedirectUrlCB){this._model3DHandler.setRedirectUrlCB(function(r,s){this._getFcsUrlsCB({urls:r,callbacks:{onComplete:function(t){if(t.results){s(t.results)}},onFailure:function(v){var u=[];for(var t=0;t<r.length;t++){u.push(null)}s(u)}}})}.bind(this))}}},getRootBagId:function(){return"rootBag"},getRootLog:function(){return this._rootLog.slice(0)},addToRootLog:function(n){this._rootLog.push(n)},getHiddenRootIds:function(n){if(n!==undefined){return this._hiddenRootIds[n]}else{return this._hiddenRootIds}},destroy:function(){delete this._modelLoader;delete this._nodeIndex;delete this._hiddenRootIds;delete this._rootLog;if(this._modelEvents){delete this._modelEvents}this._parent()},_parseAttributes:function(o,n){var r=null;var q=o.length;var p=0;n.did=null;n.type=null;n.globalType=null;n.pid=null;n.thbUrl=null;n.cgrUrl=null;n.matrix=null;n.treeOrder=null;n.hide=null;n.pgpOptions=null;for(p=0;p<q;p++){r=o[p];if(r.name==="did"){n.did=r.value}else{if(r.name==="type"){n.type=r.value}else{if(r.name==="ds6w:type"){n.type=r.value}else{if(r.name==="ds6w:globalType"){n.globalType=r.value}else{if(r.name==="physicalid"){n.pid=r.value}else{if(r.name==="resourceid"){n.pid=r.value}else{if(r.name==="thumbnail_3d"){n.thbUrl=r.value}else{if(r.name==="cgr"){n.cgrUrl=r.value}else{if(r.name==="stepcgr"){n.stepcgrUrl=r.value}else{if(r.name==="TreeOrder"){n.treeOrder=parseFloat(r.value)}else{if(r.name==="ro.plminstance.V_description"&&this._supportPgpBasedOnDescription){if(r.value==="tmpHide"){n.hide=true}}else{if(r.name==="matrixtxt"&&r.value!==""){n.matrix=new l.Matrix4();if(r.value!=="1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"&&r.value!=="1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"&&r.value!=="1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0"){var s=r.value.split(/[,]/);n.matrix.elements[0]=parseFloat(s[0]);n.matrix.elements[1]=parseFloat(s[1]);n.matrix.elements[2]=parseFloat(s[2]);n.matrix.elements[4]=parseFloat(s[3]);n.matrix.elements[5]=parseFloat(s[4]);n.matrix.elements[6]=parseFloat(s[5]);n.matrix.elements[8]=parseFloat(s[6]);n.matrix.elements[9]=parseFloat(s[7]);n.matrix.elements[10]=parseFloat(s[8]);n.matrix.elements[12]=parseFloat(s[9]);n.matrix.elements[13]=parseFloat(s[10]);n.matrix.elements[14]=parseFloat(s[11])}}else{if(r.name.toLowerCase()==="ro.pgpshowextension.v_pgp_show"||r.name.toLowerCase()==="bo.pgpshowextension.v_pgp_show"){n.pgpOptions=r.value.toLowerCase()==="true"?true:false}else{if(r.name.toLowerCase()==="bo.pgpcolorrgbextension.v_pgp_colorrgb"||r.name.toLowerCase()==="ro.pgpcolorrgbextension.v_pgp_colorrgb"){n.pgpOptions=r.value}}}}}}}}}}}}}}}if(n.stepcgrUrl){n.cgrUrl=n.stepcgrUrl;delete n.stepcgrUrl}if(!n.globalType&&n.type==="VPMRepInstance"){n.globalType="ds6w:RepInstance"}},_parseBoundingBox:function(n){return new l.Box3(new l.Vector3(parseFloat(n.min[0]),parseFloat(n.min[1]),parseFloat(n.min[2])),new l.Vector3(parseFloat(n.max[0]),parseFloat(n.max[1]),parseFloat(n.max[2])))},buildFromJSON:function(ac){var N=this;var y=ac.hidden!==undefined?ac.hidden:false;N._rootId=null;N._nbCGRToLoad=0;N._nbCGRLoaded=0;N.nbCgrLoaded=0;N.nbThbLoaded=0;var P=true;var L=[];var H=[];var K=new Map();var R=[];var A={hiddenPaths:[]};var z={references:[],instances:[],occurrences:[]};var ae={};var M=null;var B=function(){if(N._nbCGRToLoad>0){N.load3DProbe.end();delete N.load3DProbe}var af=L.slice(0);var ag=H.slice(0);var n=N._rootId;ac.callbacks.onComplete({id:n,createdPaths:af,selectedPaths:ag,pgpOverride:A,BS:M});N._nbCGRToLoad=null;N._nbCGRLoaded=null;N._rootId=null;L=null;H=null;ac=null;A=null;N=null};if(!N._selectiveLoadingActivated){var v=function(n){if(n&&n.nodes){n.nodes.forEach(function(af){af.className="PAD3DViewerCGRNode"})}N._nbCGRLoaded++;ac.callbacks.onCGRLoad({nbCGRLoaded:N._nbCGRLoaded,nbCGRToLoad:N._nbCGRToLoad})};var aa=function(n){N._nbCGRLoaded++;ac.callbacks.onCGRLoad({nbCGRLoaded:N._nbCGRLoaded,nbCGRToLoad:N._nbCGRToLoad})};this._modelLoader.setOnLoadedCallback(B);this._modelLoader.setOnLoadedProductStructureCallback(v);this._modelLoader.onErrorCB=aa}this._parsingRunning=true;this.parsingProbe=k.createProbe("queryResultParsing");var t=false;var X=ac.json.results.length;var ad=0;for(ad=0;ad<X;ad++){var S=ac.json.results[ad];if(S.attributes!==undefined){var Q={},I;N._parseAttributes(S.attributes,Q);K.set(Q.did,Q.pid);var G=N.getNode({id:Q.pid});if(!G){R.push(Q.pid);if(Q.hide===true){ae[Q.pid]=true}G=N.createNode({id:Q.pid,type:Q.type,globalType:Q.globalType,matrix:Q.matrix,treeOrder:Q.treeOrder});var J=null,s=null;if(N._selectiveLoadingActivated){if(S.boundingbox){s=this._parseBoundingBox(S.boundingbox);J=s?s.getBoundingSphere():null;if(s.max.x<s.min.x){if(!Q.thbUrl&&!Q.cgrUrl){J.radius=0}else{J=null}}if((J!==null&&M!==null&&J.radius>M.radius)||(M===null&&J!==null)){M=J}}if(ac.rootIds.indexOf(Q.pid)!==-1&&J&&J.radius>0){M=J;t=true}}if(G.is3DLeaf()&&(Q.thbUrl||Q.cgrUrl)){if(ac.streamToLoad==="thumbnail"&&Q.thbUrl){I=Q.thbUrl;G.setLoadedStream("thumbnail");N.nbThbLoaded++}else{I=Q.cgrUrl;G.setLoadedStream("cgr");N.nbCgrLoaded++}if(N._nbCGRToLoad===0){N.load3DProbe=k.createProbe("3DLoading")}if(N._selectiveLoadingActivated){if(I&&N._withRepLoading){N._OOCManager.registerLeafReference(Q.pid,{handler:N._model3DHandler,url:I,boundingBox:J&&J.radius>0?s:undefined,boundingSphere:J,node:G});if(P){P=false;N._OOCManager.forceReferenceLoad(Q.pid,null)}}}else{if(I&&N._withRepLoading){N._nbCGRToLoad++;N._modelLoader.loadModel({filename:I,format:"cgr",requestsOptions:{proxymode:"passport"}},G)}}}}if(Q.pgpOptions!==undefined&&Q.pgpOptions!==null){var D={id:Q.pid,value:Q.pgpOptions,type:typeof(Q.pgpOptions)==="boolean"?"hideshow":"color"};if(Q.globalType==="ds6w:Part"||Q.globalType==="ds6w:Document"){z.references.push(D)}else{z.instances.push(D)}}}else{if(S.path!==undefined){var p=K.get(""+S.path[0]);var T=[p];if(N._rootId===null||N._rootId!==p){N._rootId=p;var u=false;if(ac.parent){var C=ac.parent.children;for(var ab=0;ab<C.length;ab++){if(C[ab].getID&&C[ab].getID()===N._rootId){u=true;break}}var w=N.getNode({id:N._rootId});if(!u&&!y){ac.parent.add(w);w.path=ac.parent.path.clone();w.path.addElement(w)}else{if(y){w.path=ac.parent.path.clone();w.path.addElement(w)}}}}var o=N._rootId;if(null!==o){var O=false;var x=true;var r=N.getNode({id:o});for(var ab=1;ab<S.path.length;ab++){var Z=K.get(""+S.path[ab]);if(undefined===Z){Z=String(S.path[ab])}var U=true;T.push(Z);if(ae[Z]){var F=UWA.clone(T);F.push(K.get(""+S.path[ab+1]));A.hiddenPaths.push(F)}if(!N.isNodeAlreadyAttached(Z,o)){N.attachNode({id:Z,parentId:o});O=true}o=Z}if(O){L.push(T)}H.push(T)}}else{if(S.pgp_overload!==undefined){var E=Object.keys(S.pgp_overload);var q=Object.values(S.pgp_overload);for(var Y=0;Y<q.length;Y++){if(q[Y]["PGPShowExtension.V_PGP_Show"]!==undefined){E[Y]=E[Y].split(",");for(var W=0;W<E[Y].length;W++){E[Y][W]=K.get(""+E[Y][W])}z.occurrences.push({path:E[Y],value:q[Y]["PGPShowExtension.V_PGP_Show"].toLowerCase()==="true"?true:false,type:"hideshow"})}if(q[Y]["PGPColorRGBExtension.V_PGP_ColorRGB"]!==undefined){E[Y]=E[Y].split(",");for(var V=0;V<E[Y].length;V++){E[Y][V]=K.get(""+E[Y][V])}z.occurrences.push({path:E[Y],value:q[Y]["PGPColorRGBExtension.V_PGP_ColorRGB"],type:"color"})}}}}}}N.parsingProbe.end();delete N.parsingProbe;ac.json=null;delete ac.json;N._parsingRunning=false;if(N._selectiveLoadingActivated&&ac.intent==="addRoot"&&ac.reframe===true){ac.callbacks.onReframe({BS:M,rootBS:t})}if(A.hiddenPaths.length){N.publish({event:"PGPPostProcess",data:A})}if(z.references.length||z.instances.length||z.occurrences.length){N.publish({event:"PGPPostProcess",data:z})}N.publish({event:"onUrlLoaded",data:{nbCgrLoaded:N.nbCgrLoaded,nbThbLoaded:N.nbThbLoaded}});if(R.length){N.publish({event:"newNodes",data:{newNodes:R}})}if(N._nbCGRToLoad===0||N._selectiveLoadingActivated){B()}},reparentNode:function(t){var r;var s=this;for(var q=0;q<t.json.results.length;q++){var o=t.json.results[q];if(o.attributes!==undefined){var n={};s._parseAttributes(o.attributes,n);if(n.pid===t.createdInstID){r=s.getNode({id:n.pid});if(!r){r=s.createNode({id:n.pid,type:n.type,globalType:n.globalType,matrix:n.matrix,treeOrder:n.treeOrder});break}}}}t.json=null;delete t.json;if(t.newParent.getID){s.attachNode({id:t.createdInstID,parentId:t.newParent.getID()})}var p=t.oldInstance.children;p.forEach(function(u){if(u.getID&&t.oldInstance.getID){s.detachNode({id:u.getID(),parentId:t.oldInstance.getID()});s.attachNode({id:u.getID(),parentId:t.createdInstID})}});s.removeNode({id:t.oldInstance.getID()});return r},insertExistingNode:function(s){var q;var r=this;for(var p=0;p<s.json.results.length;p++){var o=s.json.results[p];if(o.attributes!==undefined){var n={};r._parseAttributes(o.attributes,n);if(n.pid===s.createdInstID){q=r.getNode({id:n.pid});if(!q){q=r.createNode({id:n.pid,type:n.type,globalType:n.globalType,matrix:n.matrix,treeOrder:n.treeOrder});break}}}}s.json=null;delete s.json;if(s.parent.getID&&s.toInsert.getID){r.attachNode({id:s.createdInstID,parentId:s.parent.getID()});r.attachNode({id:s.toInsert.getID(),parentId:s.createdInstID})}return q},isNodeAlreadyAttached:function(q,r){var n=false;var o=this.getNode({id:q}).parents;for(var p=0;p<o.length;p++){if(o[p]&&o[p].getID&&o[p].getID()===r){n=true;break}}return n},createNode:function(o){if(!UWA.is(o,"object")){throw new Error("No parameter defined")}if(!UWA.is(o.id,"string")){throw new Error("No id defined")}if(!UWA.is(o.type,"string")){throw new Error("No type defined")}var n=new m({id:o.id,type:o.type,globalType:o.globalType,treeOrder:o.treeOrder});if(o.matrix){n.setMatrix(o.matrix)}this._nodeIndex[String(o.id)]=n;return n},removeNode:function(p){if(!UWA.is(p,"object")){throw new Error("No parameter defined")}if(p.id===undefined){console.error("No id defined");return}for(var n=this._rootLog.length-1;n>=0;n--){if(UWA.is(this._rootLog[n],"array")){if(this._rootLog[n][0]===p.id){this._rootLog.splice(n,1)}}}var o=this.getNode({id:p.id});if(o){if(o.parents.length<=1){if(p.removeDetached===true&&o.isDetached){o.isDetached=false}if(o.isDetached!==true){this._removeChildren(o);o.parents.forEach(function(q){q.remove(o)});delete this._nodeIndex[p.id];if(o.is3DLeaf()&&this._selectiveLoadingActivated&&this._OOCManager&&this._OOCManager.isRegistered(o.getID())){this._OOCManager.unregisterLeafReference(o.getID())}}}else{this.detachNode({id:p.id,parentId:this.getRootBagId()})}}},removeRoot:function(n){this.removeNode(n)},_removeChildren:function(o){if(o){var p=this;var n=o.children;if(n){n.forEach(function(q){if(q.parents.length===1){if(q.getID){if(p.getHiddenRootIds().indexOf(q.getID())===-1){if(q.is3DLeaf()&&p._selectiveLoadingActivated&&p._OOCManager&&p._OOCManager.isRegistered(q.getID())){p._OOCManager.unregisterLeafReference(q.getID())}delete p._nodeIndex[q.getID()];p._removeChildren(q)}}else{p._removeChildren(q)}}});n.forEach(function(q){o.remove(q)})}}},detachNode:function(p){if(!UWA.is(p,"object")){throw new Error("No parameter defined")}if(p.id===undefined){console.error("No id defined");return}if(p.parentId===undefined){console.error("No parentId defined");return}var o=this.getNode({id:p.id});o.isDetached=true;var n=this.getNode({id:p.parentId});if(o&&n){n.remove(o)}},attachNode:function(p){if(!UWA.is(p,"object")){throw new Error("No parameter defined")}if(p.id===undefined){console.error("No id defined");return}if(p.parentId===undefined){console.error("No parentId defined");return}var o=this.getNode({id:p.id});o.isDetached=false;var n=this.getNode({id:p.parentId});if(o&&n){n.add(o);o.path=n.path.clone();o.path.addElement(o)}},updateNode:function(p,n){var o=null;if(!UWA.is(p,"object")){console.error("updateNode: There is no parameter defined.");return o}if(!UWA.is(p.id,"string")){console.error("updateNode: There is no id defined.");return o}if(!UWA.is(n,"object")){console.error("updateNode: There is no new parameter defined.");return o}if(!UWA.is(n.id,"string")){console.error("updateNode: There is no new id defined.");return o}o=this.getNode({id:p.id});if(o){if(n.matrix){o.setMatrix(n.matrix)}else{o._setID(n.id);this._nodeIndex[n.id]=o;delete this._nodeIndex[p.id]}}else{throw new Error("updateNode: Node not found.")}return o},switchNodeVisuStreamOnDemand:function(q){if(!UWA.is(q,"object")){throw new Error("No parameter defined")}if(!UWA.is(q.data,"array")){throw new Error("No input data defined")}if(!UWA.is(q.callbacks.onURLLoad,"function")){throw new Error("No onURLLoad callback function defined")}if(!UWA.is(q.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}var p=this;p._nbURLToLoad=q.data.length;p._nbURLLoaded=0;p.nbCgrLoaded=0;p.nbThbLoaded=0;var o=null;if(!p._selectiveLoadingActivated){var r=function(s){if(s&&s.nodes){s.nodes.forEach(function(t){t.className="PAD3DViewerCGRNode"})}p._nbURLLoaded++;q.callbacks.onURLLoad({nbURLLoaded:p._nbURLLoaded,nbURLToLoad:p._nbURLToLoad})};var n=function(){q.callbacks.onComplete({nbUrlLoaded:p._nbURLLoaded})};p._modelLoader.setOnLoadedCallback(n);p._modelLoader.setOnLoadedProductStructureCallback(r);p._modelLoader.onErrorCB=r}else{o=function(){p._nbURLToLoad--;p._nbURLLoaded++;if(p._nbURLToLoad===0){q.callbacks.onComplete({nbUrlLoaded:p._nbURLLoaded})}}}q.data.forEach(function(s){var u=s.url;if(u&&s.stream!==s.node.getLoadedStream()){for(var t=s.node.children.length-1;t>=0;t--){if(s.node.children[t].className==="PAD3DViewerCGRNode"){s.node.remove(s.node.children[t])}}s.node.setLoadedStream(s.stream);if(s.stream==="cgr"){p.nbCgrLoaded++}else{p.nbThbLoaded++}if(p._selectiveLoadingActivated){p._OOCManager.setReferenceLoadModelOptions(s.node.getID(),{applicativeContainer:q.applicativeContainers?q.applicativeContainers:undefined});p._OOCManager.switchLOD(s.node.getID(),u,o)}else{p._modelLoader.loadModel({filename:u,format:"cgr",requestsOptions:{proxymode:"passport"}},s.node,false,{applicativeContainers:q.applicativeContainers?q.applicativeContainers:undefined})}}else{p._nbURLToLoad--}});p.publish({event:"onUrlLoaded",data:{nbCgrLoaded:p.nbCgrLoaded,nbThbLoaded:p.nbThbLoaded}});if(!p._nbURLToLoad){q.callbacks.onComplete({nbUrlLoaded:p._nbURLLoaded})}},refreshStream:function(r){if(!UWA.is(r,"object")){throw new Error("No parameter defined")}if(!UWA.is(r.data,"array")){throw new Error("No input data defined")}if(!UWA.is(r.callbacks.onURLLoad,"function")){throw new Error("No onURLLoad callback function defined")}if(!UWA.is(r.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}var q=this;q._nbURLToLoad=r.data.length;q._nbURLLoaded=0;q.nbCgrLoaded=0;q.nbThbLoaded=0;var p=null;if(!q._selectiveLoadingActivated){var o=function(s){if(s&&s.nodes){s.nodes.forEach(function(t){t.className="PAD3DViewerCGRNode"})}q._nbURLLoaded++;r.callbacks.onURLLoad({nbURLLoaded:q._nbURLLoaded,nbURLToLoad:q._nbURLToLoad})};var n=function(){r.callbacks.onComplete()};q._modelLoader.setOnLoadedCallback(n);q._modelLoader.setOnLoadedProductStructureCallback(o);q._modelLoader.onErrorCB=o}else{p=function(){q._nbURLToLoad--;if(q._nbURLToLoad===0){r.callbacks.onComplete()}}}r.data.forEach(function(t){var u=t.url;if(u){for(var s=t.node.children.length-1;s>=0;s--){if(t.node.children[s].className==="PAD3DViewerCGRNode"){t.node.remove(t.node.children[s])}}t.node.setLoadedStream(t.stream);if(q._selectiveLoadingActivated){q._OOCManager.setReferenceLoadModelOptions(t.node.getID(),{applicativeContainer:r.applicativeContainers});q._OOCManager.switchLOD(t.node.getID(),u,p)}else{q._modelLoader.loadModel({filename:u,format:"cgr",requestsOptions:{proxymode:"passport"},},t.node,false,{applicativeContainers:r.applicativeContainers})}}else{q._nbURLToLoad--}});q.publish({event:"onUrlLoaded",data:{nbCgrLoaded:q.nbCgrLoaded,nbThbLoaded:q.nbThbLoaded}});if(!q._nbURLToLoad){r.callbacks.onComplete()}},getRootBag:function(){return this._nodeIndex.rootBag},getNode:function(n){if(!UWA.is(n,"object")){throw new Error("No parameter defined")}if(!UWA.is(n.id,"string")){console.error("No id defined");return}return this._nodeIndex[n.id]},getRoot:function(n){return this.getNode(n)},abort:function(){while(this._parsingRunning){}this._modelLoader.abort()},getDecorationBag:function(){return this._decorationBag},getLoadingBoxesBag:function(){return this._loadingBoxesBag},publish:function(n){this.getModelEvents().publish(n)},subscribe:function(n,o){return this.getModelEvents().subscribe(n,o)},unsubscribe:function(n){this.getModelEvents().unsubscribe(n)},getModelEvents:function(){return this._modelEvents},isNodeLocked:function(n){if(this._OOCManager){return(this._OOCManager.getSceneGraphLockCounter(n)>0)?true:false}return null},lockNodes:function(n){if(!UWA.is(n,"object")){console.error("Incorrect options type in lockNodes()");return}if(this._OOCManager){for(var o=0;o<n.ids.length;++o){this._OOCManager.addSceneGraphLock(n.ids[o])}}},unlockNodes:function(n){if(!UWA.is(n,"object")){console.error("Incorrect options type in unlockNodes()");return}if(this._OOCManager){for(var o=0;o<n.ids.length;++o){this._OOCManager.removeSceneGraphLock(n.ids[o])}}},getReferenceBoundingSphere:function(n){return null},pause:function(){if(this._OOCManager){this._OOCManager.setPauseLoading(true)}},resume:function(){if(this._OOCManager){this._OOCManager.setPauseLoading(false)}},enableProgressiveBI:function(){},disableProgressiveBI:function(){},displayCandidateQueue:function(n){if(n){this._OOCManager.setCandidateQueueRendererParams(true,{displayIntermediateReferences:true,repRefAttributes:{color:new l.Color(i.getSetting("enopad3dviewer_displayCandidateQueue_rep_color")),opacity:0.3,dimension:2},refAttributes:{color:new l.Color(i.getSetting("enopad3dviewer_displayCandidateQueue_assembly_color")),opacity:1,dimension:1},rootNode:this.getLoadingBoxesBag()})}else{this._OOCManager.setCandidateQueueRendererParams(false)}},setLoadingBoxesPickable:function(n){if(this._OOCManager&&this._OOCManager.setLoadingBoxesPickable){if(n){this._OOCManager.setLoadingBoxesPickable(d.PICKABLE)}else{this._OOCManager.setLoadingBoxesPickable(d.NODRAWHL)}}},getOOCSelectedReferenceID:function(){var n=null;if(this._OOCManager){n=this._OOCManager.getSelectedReference()}return n}});return e});define("DS/ENOPAD3DViewer/controller/PAD3DLayerController",["DS/ENOPAD3DViewer/views/PAD3DLayerWindow","DS/ENOPAD3DViewer/models/PAD3DLayer","DS/Utilities/UUID"],function(b,a,d){function c(e){this._layers=new Map();this._layerListView=null;this._rootBag=e.rootBag;this._decorationBag=e.decorationBag;this._viewer=e.viewer;this._parentContainer=e.renderTo;this._controller=e.controller;this._layerListView=new b({renderTo:this._parentContainer});this._layerListView.hide()}c.prototype.getLayer=function(e){return this._layers.get(e)};c.prototype.createLayer=function(e){var g=d.v4();var f=new a({UUID:g,label:e.label,rootBag:this._rootBag,decorationBag:this._decorationBag,viewer:this._viewer,controller:this._controller});this._bindEvents(f);this._layers.set(g,f);this._layerListView.appendChild(f.render());this._layerListView.show();return f};c.prototype.deleteLayer=function(g){var f=g.getID();var e=this._layers.get(f);if(e){this._layerListView.removeChild(e.render());this._layers["delete"](f);e.destroy()}if(this._layers.size===0){this._layerListView.hide()}};c.prototype.deleteLayers=function(){this._layers.forEach(function(e,f){this.deleteLayer(e)}.bind(this))};c.prototype.destroy=function(){this.deleteLayers();this._layers.clear();delete this._layers;this._layerListView.destroy();delete this._layerListView;delete this._rootBag;delete this._decorationBag;delete this._viewer;delete this._parentContainer;delete this._controller};c.prototype._bindEvents=function(e){e.subscribe({event:"delete"},function(f){this.deleteLayer(f.layer)}.bind(this));e.subscribe({event:"hide"},function(f){}.bind(this));e.subscribe({event:"show"},function(f){}.bind(this))};return c});define("DS/ENOPAD3DViewer/views/PAD3DRootListMgt",["UWA/Class","UWA/Promise","DS/PADUtils/views/PADResponsiveRootList","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/PADUtils/PADWSAccess","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Core/ModelEvents","DS/PADUtils/PADSettingsMgt"],function(s,c,u,f,o,t,h,i,m,d){var k=[];var q=s.extend({createRootListSlidder:function(w){var v=this;v.elements.padrootlist_div=UWA.createElement("div",{"class":"pad3drootlist",styles:{height:"calc(100% - 38px)",background:"white",top:"38px",position:"absolute",width:"100%"}});v.elements.pad3drootlist=new u({events:{onTileAdd:n.bind(v),onTileDelete:a.bind(v),onTileSelect:e.bind(v),onAttach:r.bind(v),onDetach:p.bind(v),},callback:function(){t.onPostAdd(function(){var y=l().slice();var x=t.get();b(function(A,z){c.all(y).then(function(B){if(x.length>0){x.forEach(function(D){if(D.pathElement!==null){var E=D.pathElement;var C=E.getLastElement(true);v._controller.getRoots().forEach(function(F){if(i.getNodeID(F)===i.getNodeID(C)){var G=function(){return i.getNodeID(C)};v.elements.pad3drootlist.selectTile({data:{nodeModel:{getID:G}}})}})}})}A()})},"SelectTile");return false});t.onPostRemove(function(A){for(var y=0;y<A.length;y++){if(A[y].pathElement!==null){var z=A[y].pathElement;var x=z.getLastElement(true);v._controller.getRoots().forEach(function(B){if(i.getNodeID(B)===i.getNodeID(x)){var C=function(){return i.getNodeID(x)};v.elements.pad3drootlist.unselectTile({data:{nodeModel:{getID:C}}})}})}}})},disableDetach:d.getSetting("disableDetach")}).inject(v.elements.padrootlist_div);v.subscribe({event:"onRootAdded"},function(x){var y=l().slice();b(function(A,z){c.all(y).then(function(B){o.fetch({enopad_webapis:d.getSetting("enopad_webapis"),data:{authored:false,intent:"fetch_3D",select_predicate:["ds6w:label","ds6w:responsible","ds6w:identifier"],select_file:["icon","thumbnail_2d"]},pids:[x.id],onComplete:function(D){var H=UWA.is(D,"string")?JSON.parse(D):D;var J={};J.grid={};for(var G=0;G<H.results.length;G++){var F=H.results[G];if(F.hasOwnProperty("attributes")){for(var E=0;E<F.attributes.length;E++){var I=F.attributes[E];if(I.name==="resourceid"){J.resourceid=I.value}if(I.name==="ds6w:label"){J.label=I.value}if(I.name==="type_icon_url"){J.icon=[I.value]}if(I.name==="preview_url"){J.thumbnail=I.value}if(I.name==="ds6w:responsible"){J.grid["ds6w:responsible"]=I.value}}}}var C=null;if(i.isFiltered){C=i.isFiltered(v.getController().getNode({id:x.id}),v)}if(C){J.isFiltered=true}else{J.isFiltered=false}if(x.hidden){J.isRootAttached=false}if(d.getSetting("disableDetach")){J.disableDetach=true}if(J){J.nSelect=true;J.resolve=A;v.elements.pad3drootlist.addRootTile(J)}},onFailure:function(){z()}})})},"AddRootTile")});v.subscribe({event:"onRootRemoved"},function(x){if(v.elements.pad3drootlist){v.elements.pad3drootlist.removeTile({tile_id:x.id,noDispatch:true})}return false});if(!d.getSetting("disableDetach")){v.subscribe({event:"onRootDetached"},function(y){var x=0;if(v.elements.pad3drootlist._roots2add.length>0){x=250}setTimeout((function(){var A=y.id,z=v.elements.pad3drootlist._search(A);if(z.length===1){z[0].options.isRootAttached=false;z[0].options.statusbarIcons[1]="eye-off";z[0].options.statusbarIconsTooltips[1]=f.attachRoot;v.elements.pad3drootlist.options.grid.layout.invalidate();z[0].unselect()}}).bind(v.elements.pad3drootlist),x)});v.subscribe({event:"onRootAttached"},function(B){var x=B.id,z=v.elements.pad3drootlist._search(x);if(z.length===1){var A=v.elements.pad3drootlist.options.model.getRoots();var y=A.indexOf(z[0]);z[0].options.isRootAttached=true;z[0].options.statusbarIcons[1]="eye";z[0].options.statusbarIconsTooltips[1]=f.detachRoot;v.elements.pad3drootlist.options.grid.layout.invalidate();z[0].select()}})}if(w&&w.leftContainer){v.elements.padrootlist_div.inject(w.leftContainer)}return v.elements.padrootlist_div},});function n(w){var v=this,x={};if(w.json_content.authorized_objects&&w.json_content.authorized_objects.length>0){x={pids:[]};x.callback=w.callback;w.json_content.authorized_objects.forEach(function(y){x.pids.push(y.objectId)});v.addRoots(x)}else{console.warn("You have accessed an invalid branch in the _onTileAdd() event handler.")}return false}function e(x){if(!UWA.is(x.tile_ids,"array")){throw new Error("Invalid input param, no params.tile_ids defined")}var w=this;var v=[];t.empty();h.empty();x.tile_ids.forEach(function(y){var A=w._controller.getNode({id:y});if(A){var z=w._controller.buildPathFromArray([y]);v.push({pathElement:z});t.add(v);t.get().forEach(function(B){h.add(B)})}else{console.log("Cannot find ["+y+"] in the TreeDocument")}})}function a(w){if(!UWA.is(w.tile_id)){throw new Error("Invalid input parameter")}var v=this.getController().getNode({id:w.tile_id});if(UWA.is(v)){this.getController().removeRoots({pids:[w.tile_id]})}return false}function r(y){var w=this.getController().getNode({id:y.tile_id});if(UWA.is(w)){var v=[];var x=this._controller.buildPathFromArray([y.tile_id]);v.push({pathElement:x});t.add(v);t.get().forEach(function(z){h.add(z)});this.getController().attachRoots({pids:[y.tile_id]},true)}this.dispatchEvent("onRootsVisibility");return false}function p(x){var w=this,v=w.getController().getNode({id:x.tile_id});if(UWA.is(v)){w.getController().detachRoots({pids:[x.tile_id]},true)}w.dispatchEvent("onRootsVisibility");return false}function l(){var w=[];for(var v=0;v<k.length;v++){if(!k[v].isFulfilled||!k[v].isFulfilled()){w.push(k[v])}}k=w;return k}function b(x,w){var y=new c(x);var v=j(y,w);l().push(v);return v}function g(){k=[]}function j(A,y){if(A.isResolved){return A}var w=true;var z=false;var x=false;var v=A.then(function(B){x=true;w=false;return B},function(B){z=true;w=false;throw B});v.isFulfilled=function(){return x};v.isPending=function(){return w};v.isRejected=function(){return z};v.name=y;return v}return q});define("DS/ENOPAD3DViewer/commands/PAD3DViewerDebugVisuCmd",["i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","UWA/Core","UWA/Class","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADContext","DS/Controls/Button","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(d,e,a,f,g,h,b){var i="DS/ENOFloatingPanel/ENOFloatingPanel";var c=a.extend({init:function(j){this.context={};this.floatingpanel={};this.closeButton={}},execute:function(){this.context=g.get();var j=e.createElement("div",{});var k=e.createElement("div",{});this._build(j,k);require([i],function(l){this.floatingpanel=new l({body:j,footer:k,title:d.debugVisuTitle,overlay:true,closable:true,animate:true,resizable:true,visible:true,events:{onClose:function(){this.close()}.bind(this)}});this.floatingpanel.inject(document.body)}.bind(this))},_build:function(x,D){x.id="DebugVisuCmdPanel";x.style.width="100%";x.style.height="100%";x.style.display="flex";x.style.justifyContent="center";x.style.alignItems="center";x.style.flexDirection="column";var A={styles:{marginBottom:0}};var t=e.createElement("p",A).inject(x);var B=e.createElement("p",A).inject(x);var r=e.createElement("p",A).inject(x);var m=e.createElement("p",A).inject(x);var w=e.createElement("p",A).inject(x);var C=e.createElement("p",A).inject(x);var o=e.createElement("p",A).inject(x);var F=e.createElement("p",A).inject(x);var k=e.createElement("p",A).inject(x);var H=e.createElement("p",A).inject(x);var u=e.createElement("p",A).inject(x);var p=e.createElement("p",A).inject(x);var N=e.createElement("p",A).inject(x);var y=e.createElement("p",A).inject(x);var O=e.createElement("p",A).inject(x);var z=e.createElement("p",A).inject(x);this.closeButton=new h({label:d.close,emphasize:"primary",touchMode:true,}).inject(D);this.closeButton.elements.button.id="DebugVisuCmdCloseButton";this.close=this.close.bind(this);this.closeButton.addEventListener("click",this.close);var G=0;var J=0;var j=0;var v=0;if(f.getSetting("enopad3dviewer_lightNodeModel")===true){var q={};var n=function(S){for(var R=0;R<S.children.length;++R){if(S.children[R].children.length>0&&!q[S.children[R].modelIdentification]){if(b.isReference(S.children[R])){++v}else{if(b.isRepInstance(S.children[R])){++G}else{if(b.isInstance(S.children[R])){++J}else{if(b.isRepReference(S.children[R])){++j}}}}q[S.children[R].modelIdentification]=1;n(S.children[R])}else{return}}}.bind(this);var L=this.context.getController()._model._nodeIndex.rootBag;n(L)}else{var Q=function(T){var S=Object.getOwnPropertyNames(T);for(var R=0;R<S.length;R++){if(b.isReference(T[S[R]])){v++}else{if(b.isInstance(T[S[R]])){J++}else{if(b.isRepReference(T[S[R]])){j++}else{if(b.isRepInstance(T[S[R]])){G++}}}}}};var I=this.context.getController()._model._nodeIndex;Q(I)}var K=this.context.getViewer().getInfos();var P=K.memory,E=K.render;t.innerHTML=d.debugVisuRefAmount+"<b>"+v+"</b>";B.innerHTML=d.debugVisuInstAmount+"<b>"+J+"</b>";r.innerHTML=d.debugVisuRepRefAmount+"<b>"+j+"</b>";m.innerHTML=d.debugVisuRepInstAmount+"<b>"+G+"</b>";w.innerHTML=d.debugVisuTotalGeometryAmount+"<b>"+P.geometries+"</b>";C.innerHTML=d.debugVisunbSharedBufferAmount+"<b>"+P.sharedbuffers+"</b>";o.innerHTML=d.debugVisunbTexturesAmount+"<b>"+P.textures+"</b>";F.innerHTML=d.debugVisunbProgramsAmount+"<b>"+P.programs+"</b>";k.innerHTML=d.debugVisunbCallsAmount+"<b>"+E.calls+"</b>";H.innerHTML=d.debugVisunbFacesAmount+"<b>"+E.faces+"</b>";u.innerHTML=d.debugVisunbLinesAmount+"<b>"+E.lines+"</b>";p.innerHTML=d.debugVisunbMeshesAmount+"<b>"+E.meshes+"</b>";N.innerHTML=d.debugVisunbCulledMeshesAmount+"<b>"+E.culledMeshes+"</b>";y.innerHTML=d.debugVisunbCulledGeometriesAmount+"<b>"+E.culledGeometries+"</b>";O.innerHTML=d.debugVisunbCulledTrianglesAmount+"<b>"+E.culledDGTriangles+"</b>";z.innerHTML=d.debugVisunbCulledLinesAmount+"<b>"+E.culledDGLines+"</b>";var s={refCount:v,instCount:J,repRefCount:j,repInstCount:G,geometries:P.geometries,sharedBuffer:P.sharedbuffers,textures:P.textures,programs:P.programs,calls:E.calls,faces:E.faces,lines:E.lines,meshes:E.meshes,culledMeshes:E.culledMeshes,culledGeometries:E.culledGeometries,culledDGTriangles:E.culledDGTriangles,culledDGLines:E.culledDGLines};var M=(function(){var R=document.createElement("a");document.body.appendChild(R);if(/Edge/.test(navigator.userAgent)){R.style.display="none;"}else{if(/Firefox/.test(navigator.userAgent)||/Google Inc/.test(navigator.vendor)){R.style="display: none"}else{R.setAttribute("display","none")}}return function(S,U){if(!!document.documentMode){navigator.msSaveBlob(S,U)}else{var T=window.URL.createObjectURL(S);R.href=T;R.download=U;R.click();window.URL.revokeObjectURL(T)}}}());var l=new Blob([JSON.stringify(s,null,2)],{type:"application/json"});M(l,Date.now()+"-VisuDebugValues.json");M=null;l=null},close:function(){this.closeButton.removeEventListener("click",this.close);this.floatingpanel.destroy();this.destroy()},destroy:function(){delete this.context;delete this.floatingpanel;delete this.closeButton}});return c});define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerExternalKPIController",["UWA/Core","UWA/Controls/Abstract","DS/PADUtils/PADPromise","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphUtils","DS/Visualization/Node3D","DS/Selection/CSOManager","DS/PADUtils/PADSettingsMgt","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENOPAD3DViewer/views/PAD3DPushpinCanvasNode","DS/PADUtils/PADUtilsServices","DS/Utilities/Utils"],function(g,i,h,e,n,a,l,c,k,b,j,f,m){var d=i.extend({name:"PAD3DViewerExternalKPIController",_externalKPICommandProxy:null,_viewer:null,_decorationBag:null,_activeKPI:false,_colorDescriptionMap:null,_layers:null,_colorKPIUserQueueCallbacks:{},_POIsDescriptionMap:null,_POIsNode3DMap:null,_pushPinNodeColorMap:null,_selectedPushpinCanvasNodeMap:null,_highlightedPushPinNode:null,_POIsKPIUserQueueCallbacks:{},initExternalKPIController:function(){return new Promise(function(o){if(this._context.isInterwidgetComAvailable()&&!this._externalKPICommandProxy){this._viewer=this._context.getViewer();this._decorationBag=this.getDecorationBag();this._layers=new Map();this._colorDescriptionMap=new Map();this._POIsDescriptionMap={};this._POIsNode3DMap=new Map();this._pushPinNodeColorMap=new Map();this._selectedPushpinCanvasNodeMap=new Map();this.poiToLoad=[];this.max_path=5000;this._highlightedPushPinNode=new j({fillColor:"#368EC4",borderColor:"#00B8DE"}).render();require(["DS/PADUtils/PADCommandProxy"],function(p){this._externalKPICommandProxy=p.create({events:{onEnrichWithKPI:function(q){this.enrichWithKPI(q)}.bind(this)}});c.onPostAdd(this._drawHighlight.bind(this));c.onEmpty(this._drawHighlight.bind(this));c.onPostRemove(this._drawHighlight.bind(this));this.subscribe({event:"onEndRootRemoved"},function(){this.resetPOIs();this.resetGraphicProperties();this._shareSessionContent()}.bind(this));this.subscribe({event:"onComplete"},function(q){if(q.intend==="addRoot"){this.resetPOIs();this.resetGraphicProperties();this._shareSessionContent()}}.bind(this));o()}.bind(this))}else{o()}}.bind(this))},destroyExternalKPIController:function(){if(this._viewer){delete this._viewer}if(this._externalKPICommandProxy){this._externalKPICommandProxy.destroy();delete this._externalKPICommandProxy}this._layers.clear();delete this._layers;this._layersController.destroy();delete this._layersController;if(this._colorKPIUserQueueCallbacks&&this._model){this._model.disableProgressiveBI(this._colorKPIUserQueueCallbacks);delete this._colorKPIUserQueueCallbacks}this._parent()},enrichWithKPI:function(o){this.resetGraphicProperties();this.resetPOIs();if(o.graphicProperties){this.applyGraphicProperties(o.graphicProperties)}if(o.pointOfInterest){this.drawPOIs(o.pointOfInterest)}},isKPIActivated:function(){return this._activeKPI},_shareSessionContent:function(){var o=this.getRoots();var q=[];var p=0;for(p=0;p<o.length;p++){q.push(b.getNodeID(o[p]))}var r={widgetId:f.getWidgetId(),rootIds:q};this._externalKPICommandProxy.sessionContent(r)},applyGraphicProperties:function(s){if(s.colorMap.length){var o=this._layerController.createLayer({label:s.label!==undefined?s.label:"KPI colors"});this._layers.set("KPIs",o);this._activeKPI=true;this._convertColorMap(s.colorMap);if(k.getSetting("enopad3dviewer_lightNodeModel")===true){var r=false;var q=this;this._colorKPIUserQueueCallbacks={handleReferences:function(v,u){r=true;var t=0;for(t=0;t<v.length;t++){var x=v[t];var w=q._colorDescriptionMap.get(x);if(w){q.setOverrideCB(x,q._applyOverride.bind(q),o.getOverrideSetID())}}this.done(v,[],u)},getBatchSize:function(){return 1000},isReady:function(){return r===false},getParams:function(){return{addLeaves:true,addIntermediateNodes:true}},done:function(t,v,u){r=false;u.doneCB(t,v)},onFailure:function(t){console.log(t)}};this._model.enableProgressiveBI(this._colorKPIUserQueueCallbacks)}else{var p=this.getRootBag();this._colorDescriptionMap.forEach(function(A,z){var w=this.getNode({id:z});if(w){var y=a.buildPathesLeadingToNode(w,p);var t=A.color;var u=A.opacity;var x=A.forceInherit;var v=o.getOverrideSet().createOverride(y);v.setOpacity(u,x);v.setColor(t,x)}}.bind(this));o.show()}this._viewer.render()}},resetGraphicProperties:function(){if(k.getSetting("enopad3dviewer_lightNodeModel")){this._model.disableProgressiveBI(this._colorKPIUserQueueCallbacks)}var o=this._layers.get("KPIs");if(o){this._layerController.deleteLayer(o);this._layers["delete"]("KPIs")}this._viewer.setOIT(false);this._activeKPI=false;this._colorDescriptionMap.clear();this._viewer.render()},streamPOI:function(o,q){var r=o.externalPath;for(var p=0;p<r.length;p++){if(r[p]._poiId!==undefined){q.push(r[p]._poiId)}}},unstreamPOI:function(q){var o=null;var p=this.getPOINode(q);if(p){o=new e();o.setFromArray([this._decorationBag,p])}return o},getPOINode:function(p){var o=null;if(p){o=this._POIsNode3DMap.get(p)}return o},drawPOIs:function(s){if(s.pointMap.length){this._activeKPI=true;this._convertPointMap(s.pointMap);this._pushPinNodeColorMap=new Map();var q=this._layerController.createLayer({label:s.label!==undefined?s.label:"POIs"});this._layers.set("POIs",q);if(k.getSetting("enopad3dviewer_lightNodeModel")===true){var o=this._POIsDescriptionMap.referencePOIs;o.forEach(function(v,u){this._drawPOIWithDynamicLoading(v)}.bind(this));var r=this._POIsDescriptionMap.pathPOIs;r.forEach(function(v,u){this._drawPOIWithDynamicLoading(v)}.bind(this));if(this.poiToLoad.length>0){while(this.poiToLoad.length>this.max_path){this._loadPOI(this.poiToLoad.slice(0,this.max_path));this.poiToLoad=this.poiToLoad.slice(this.max_path)}this._loadPOI(this.poiToLoad)}}else{var o=this._POIsDescriptionMap.referencePOIs;o.forEach(function(v,u){this._drawPOI(v)}.bind(this));var r=this._POIsDescriptionMap.pathPOIs;r.forEach(function(v,u){this._drawPOI(v)}.bind(this))}var p=0;var t=this._POIsDescriptionMap.positionPOIs;for(p=0;p<t.length;p++){this._drawPOI(t[p])}q.show()}},resetPOIs:function(){var o=this._layers.get("POIs");if(o){this._layerController.deleteLayer(o);this._layers["delete"]("POIs")}this._POIsNode3DMap.clear();this._model.disableProgressiveBI(this._POIsKPIUserQueueCallbacks);this._POIsDescriptionMap={};this._pushPinNodeColorMap.clear();this._activeKPI=false;this._viewer.render()},_convertColorMap:function(o){this._colorDescriptionMap=new Map();var p=0;for(p=0;p<o.length;p++){this._colorDescriptionMap.set(o[p].resourceid,{color:o[p].color!==undefined?o[p].color:"#FFFFFF",opacity:o[p].opacity!==undefined?o[p].opacity:1,forceInherit:o[p].forceInherit!==undefined?o[p].forceInherit:true})}},_applyOverride:function(r,q){var t=this._colorDescriptionMap.get(r);if(t){var o=t.color;var p=t.opacity;var s=t.forceInherit;q.setOpacity(p,s);q.setColor(o,s)}},_applyKPIsOnNewNodes:function(v){if(this.isKPIActivated()){var w=0;var p=this.getRootBag();var x=this._layers.get("KPIs");for(w=0;w<v.newNodes.length;w++){var r=v.newNodes[w];var t=this._colorDescriptionMap.get(r);if(t){if(k.getSetting("enopad3dviewer_lightNodeModel")){this.setOverrideCB(r,this._applyOverride.bind(this),x.getOverrideSetID())}else{var s=this.getNode({id:r});if(s){var z=a.buildPathesLeadingToNode(s,p);var u=t.color;var y=t.opacity;var o=t.forceInherit;var q=x.getOverrideSet().createOverride(z);q.setOpacity(y,o);q.setColor(u,o)}}}}if(!k.getSetting("enopad3dviewer_lightNodeModel")){x.show()}}},_convertPointMap:function(p){this._POIsDescriptionMap={positionPOIs:[],referencePOIs:new Map(),pathPOIs:new Map(),};var q=0;for(q=0;q<p.length;q++){var o=p[q];if(o.resourceid){this._POIsDescriptionMap.referencePOIs.set(o.resourceid,{id:o.id,resourceid:o.resourceid,color:o.color!==undefined?o.color:"#EA4F37"})}else{if(o.path){this._POIsDescriptionMap.pathPOIs.set(o.path[o.path.length-1],{id:o.id,path:o.path,color:o.color!==undefined?o.color:"#EA4F37"})}else{if(o.position){this._POIsDescriptionMap.positionPOIs.push({id:o.id,position:o.position,color:o.color!==undefined?o.color:"#EA4F37"})}}}}},_drawPOINode:function(r){var p=this._pushPinNodeColorMap.get(r.color);if(!p){p=new j({fillColor:r.color}).render();this._pushPinNodeColorMap.set(r.color,p)}var q=new l();q._poiId=r.id;q.className="PAD3DPOINode";q.addChild(p);var o=new n.Matrix4();o.setPosition(new n.Vector3(r.position.x,r.position.y,r.position.z));q.setMatrix(o);this._layers.get("POIs").getNode3DBag().addChild(q);this._POIsNode3DMap.set(r.id,q)},_drawPOI:function(u){if(u.resourceid){var s=this.getNode({id:u.resourceid});if(s){var t=a.buildPathesLeadingToNode(s,this.getRootBag());for(var q=0;q<t.length;q++){var r=t[q];var p=r.getWorldMatrix();var o=r.getLastElement(true).getBoundingSphere().center;o.applyProjection(p);if(o){u.position=o;this._drawPOINode(u)}}}}else{if(u.path){var r=this.buildPathFromArray(u.path);if(r){var p=r.getWorldMatrix();var o=r.getLastElement(true).getBoundingSphere().center;o.applyProjection(p);if(o){u.position=o;this._drawPOINode(u)}}}else{if(u.position){this._drawPOINode(u)}}}},_drawPOIWithDynamicLoading:function(o){if(o!==undefined&&o.resourceid){if(this._model.getOOCManager().isRegistered(o.resourceid)){var q=this._model.getOOCReference(o.resourceid);if(q){var s=q.getBoundingBox();var r=new n.Vector3((s.min.x+s.max.x)/2,(s.min.y+s.max.y)/2,(s.min.z+s.max.z)/2);var p=q.getOccurrences();for(var t=0;t<p.length;t++){var w=p[t];var v=this._model.getWorldMatrix(w.getIdPath());var u=r.clone();u.applyProjection(v);if(u){o.position=u;this._drawPOINode(o)}}}}else{this.poiToLoad.push(o.resourceid)}}else{if(o!==undefined&&o.path){if(this._model.getOOCManager().isRegistered(o.path[o.path.length-1])){var q=this._model.getOOCReference(o.path[o.path.length-1]);if(q){var s=q.getBoundingBox();var v=this._model.getWorldMatrix(o.path);var u=new n.Vector3((s.min.x+s.max.x)/2,(s.min.y+s.max.y)/2,(s.min.z+s.max.z)/2);u.applyProjection(v);if(u){o.position=u;this._drawPOINode(o)}}}else{this.poiToLoad.push(o.path[o.path.length-1])}}else{if(o!==undefined&&o.position){this._drawPOINode(o)}}}},_drawHighlight:function(){if(this._POIsNode3DMap&&this._POIsNode3DMap.size){this._selectedPushpinCanvasNodeMap.forEach(function(u,t){var s=this.getPOINode(t);if(s){s.remove(s.children[0]);s.add(u)}}.bind(this));this._selectedPushpinCanvasNodeMap.clear();var o=c.get();for(var q=0;q<o.length;q++){var r=o[q].pathElement.externalPath;for(var p=0;p<r.length;p++){if(r[p]._poiId!==undefined){this._selectedPushpinCanvasNodeMap.set(r[p]._poiId,r[p].children[0]);r[p].remove(r[p].children[0]);r[p].add(this._highlightedPushPinNode);break}}}this._viewer.render()}},_loadPOI:function(u){if(u.length>0){var p=this.getRoots();var s=this;var t=h.getPromises().slice();var q=[];var o=u;if(p.length>0){for(var r=0;r<p.length;r++){h.createPromise(function(x,w){var v={cancelable:false,forceIndex:true,find_in_context_physicalid:o,path:[b.getNodeID(p[r])],parent:s._model.getRootBag(),sequence_filter:s._model.getRoot({id:b.getNodeID(p[r])}).getSequenceFilter(),configBin:s._model.getRoot({id:b.getNodeID(p[r])}).getConfigFilter(),CVQuery3D:s._model.getRoot({id:b.getNodeID(p[r])}).getCVFilterQuery(),resolve:x,intent:"searchInDsBoard",progressiveExpand:false,expand_iter:"-1",forceLoad:false,max_count_path:(s.max_path*10).toString(),onComplete:function(z){for(var y=0;y<z.selectedPaths.length;y++){if(s._POIsDescriptionMap.referencePOIs.get(z.selectedPaths[y][z.selectedPaths[y].length-1])!==undefined){s._drawPOIWithDynamicLoading(s._POIsDescriptionMap.referencePOIs.get(z.selectedPaths[y][z.selectedPaths[y].length-1]))}if(s._POIsDescriptionMap.pathPOIs.get(z.selectedPaths[y][z.selectedPaths[y].length-1])!==undefined){s._drawPOIWithDynamicLoading(s._POIsDescriptionMap.pathPOIs.get(z.selectedPaths[y][z.selectedPaths[y].length-1]))}}if(x){x()}if(s._loadingQueue.length){s._processLoadingQueue()}else{s.publish({event:"onComplete",data:{reframe:false}})}},onFailure:function(y){s.publish({event:"onLoadPOIFailure",data:y});if(x){x()}if(s._loadingQueue.length){s._processLoadingQueue()}else{s.publish({event:"onComplete",data:{reframe:false}})}},onTimeout:function(y){s.publish({event:"onLoadPOIFailure",data:y});if(x){x()}if(s._loadingQueue.length){s._processLoadingQueue()}else{s.publish({event:"onComplete",data:{reframe:false}})}},};q.push(v)},"loadPOI")}}Promise.all(t).then(function(v){t=null;for(var w=0;w<q.length;w++){var x=q[w];s._loadingQueue.push(x)}s._processLoadingQueue()})}}});return d});define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerFilterController",["UWA/Class","DS/PADUtils/PADUtilsServices","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADPromise","DS/ENOPAD3DViewer/views/PAD3DRemoveFilterPanel","DS/Visualization/SceneGraphUtils","DS/Visualization/PathElement"],function(a,f,c,h,g,i,b,e){var d=a.extend({initFilterController:function(){return new Promise(function(j){var k=function(l){if(this.isStandaloneFilterAvailable()===true){this.applyFilter(l,false)}}.bind(this);require(["DS/PADUtils/PADUtilsServices","DS/ENOFilterBIUX/FilterBIComponentProxy"],function(q,m){var n=(this._context.getWidget()&&this._context.getWidget().id)?this._context.getWidget().id:"fakeWidgetIDFallback";var o=(this._context.getWidget())?q.getSharedId():null;var l=h.getSetting("activateVolumeFilter")?h.getSetting("activateVolumeFilter"):0;this._BIProxy=new m({tenant:q.getPlatformId(),processingMode:"appProcessing",ExpandSynthesisON:this.isStandaloneFilterAvailable()?true:false,colorize:true,widgetId:n,volumeFilterAvailable:l,appId:o,synthesis_priority:2});this._BIProxy.addEvent("ApplyNGFilter",k,this);this._BIProxy.addEvent("NGFilter_Volume",this._onNGFilterVolume,this);this._BIProxy.addEvent("FilterBIFilteringEvent",this._onFilterBIRefineEvent,this);if(UWA.is(this._BIProxy.setNGFilterOptions,"function")){var p={expandServices:"expand3d",appID:o};this._BIProxy.setNGFilterOptions(p)}j()}.bind(this))}.bind(this))},retrieveFilters:function(j){if(this.isStandaloneFilterAvailable()===true){this._BIProxy.retrieveFilters({filterObjects:j.authorizedWithKind.Filter,callback:function(l){if(l.success.length){for(var m=0;m<l.success.length;++m){var k=this.getRoot({id:l.success[m].rootId});if(!k){this.applyFilter(l.success[m].filter,false)}else{this.publish({event:"onRootAlreadyExisting"})}}}if(l.failure.length){console.error("Failed to retrieve filters",l.failure)}}.bind(this)})}},removeFilterFullReload:function(k){if(this.isStandaloneFilterAvailable()===true){this._clearRootEvents();this.removeRoots({pids:k},false,false);var l=[];for(var j=0;j<k.length;j++){l.push({path:[k[j]]})}this.addRoots({objects:l},false,true,false,function(){this._restoreRootEvents()}.bind(this))}},applyFilter:function(m,k,j){var l=this;g.createPromise(function(x,y){var r=[];if(l.getRoots().length&&!l._context._physicalId.length){l._context._physicalId.push(c.getNodeID(l.getRoots()[0]))}l.publish({event:"onEnableUX"});if(l._context._volumePanel!==0){l._context.publish({event:"onVolumeOpen",data:{closePanel:true}})}var v=false;if(l._wait4Filter===true){if(h.getSetting("enopad3dviewer_lightNodeModel")===true){l.resumeProgressiveLoading()}v=true;delete l._wait4Filter}if(l._useWrapToRemoveWhenFilter===true){l._useWrap=false}if(m){if(!m.CVQuery3D&&!m.empty){if(m.sequence_filter||m.config_filter){var o=m.root_physicalid;var s=m.sequence_filter;var t=m.config_filter;r=[];var z=true;if(!v){if(o&&l.getNode({id:o})){z=false}}r.push({path:[o],sequence_filter:s,configBin:t});l._clearRootEvents();l.removeRoots({pids:[o]},false,false);l.addRoots({objects:r},false,false,z,function(){this._restoreRootEvents()}.bind(l));if(k){l._commandProxy.applyFilter(m)}}else{if(m.root_physicalid){var p=l.getNode({id:m.root_physicalid});p.setSequenceFilter(undefined);p.setConfigFilter(undefined)}else{var w=l.getRoots();for(var u=0;u<w.length;u++){w[u].setSequenceFilter(undefined);w[u].setConfigFilter(undefined)}}}l.publish({event:"onFilterApplied",data:{filter:{objects:r}}});x()}else{if(!m.empty&&m.CVQuery3D){var n=m.filterRootIds;r=[];l._clearRootEvents();var z=true;for(var q=0;q<n.length;q++){if(!v){if(n[q]&&l.getNode({id:n[q]})){z=false}}l.removeRoots({pids:[n[q]]},false,false);r.push({path:[n[q]],CVQuery3D:m.CVQuery3D,filterId:typeof j!=="undefined"?j.filterId:undefined})}l.addRoots({objects:r},false,false,z,function(){this._restoreRootEvents()}.bind(l));if(k){l._commandProxy.applyFilter(m)}l.publish({event:"onFilterApplied",data:{filter:{objects:r}}})}else{if(m.empty===true){if(m.filterRootIds){for(var q=0;q<m.filterRootIds.length;q++){l.removeFilterFromRoot(m.filterRootIds[q])}}}else{var w=l.getRoots();for(var u=0;u<w.length;u++){w[u].setCVFilterQuery(undefined)}}}x()}}else{console.error("No parameter pass")}})},_onNGFilterVolume:function(k){var j=this;require(["DS/ApplicationFrame/CommandsManager","DS/PADUtils/PADPromise","DS/Selection/CSOManager"],function(n,l,m){if(k.action){var o=true;var p=l.getPromises().slice();l.createPromise(function(r,q){Promise.all(p).then(function(t){p=null;var s=[],x=null,z=[];var v=j._context._context;var y=n.getCommand("VolumeQueryHdr",v);j._context.publish({event:"onVolumeOpen",data:{changeType:k.volume}});var u=m.get();if(j._context._volumePanel==0){if(j._context.getRoots().length){if(k.volume){if(UWA.is(k.volume.root_path_physicalid[0],"array")){if(k.volume.type=="proximity"){x=j._context.unstreamPath(k.volume.root_path_physicalid[0]);if(x==null){o=false;j._context.publish({event:"onVolumeOpen",data:{error:true}})}else{s.push({pathElement:x});m.add(s)}}else{if(u.length==0){z.push(k.volume.root_path_physicalid[0][0]);x=j._context.unstreamPath(z);s.push({pathElement:x});m.add(s)}}}}else{if(u.length==0){z.push(c.getNodeID(j._context.getRoots()[0]));x=j._context.unstreamPath(z);s.push({pathElement:x});m.add(s)}}}if(o){y.begin()}}if(j._context.getRoots().length===0||j._context._controller._wait4Filter==true){j._context._filterDrop=true;j._context._controller.publish({event:"onEnableUX"});j._context._controller.publish({event:"onDisableActionBar"})}var w=l.getPromises().slice();l.createPromise(function(B,A){Promise.all(w).then(function(C){w=null;if(o){j._context.publish({event:"onVolumeOpen",data:{biData:k}})}B()})},"volumeFilterUpdate");r()})},"volumeFilter")}else{if(j._context._volumePanel!==0){j._context.publish({event:"onVolumeOpen",data:{closePanel:true}})}}})},_onFilterBIRefineEvent:function(l){var j=this;var k=g.getPromises().slice();g.createPromise(function(n,m){Promise.all(k).then(function(o){k=null;if(j._viewer){var p=j._context.getController()._model._nodeIndex;var s=Object.getOwnPropertyNames(p);var r=j._context.getController()._model.getRootBag();j._resetFiltering();if(j.isStandalone()){var q=Object.getOwnPropertyNames(l.allfilters);var t=[],v=0;if(q.length>0&&l.filteredSubjectList.length){s.forEach(function(x){if(p[x].is3DLeaf&&p[x].is3DLeaf()){var w=b.buildPathesLeadingToNode(p[x],r);w.forEach(function(z){var y=j._refineOverrideSet.createOverride(z);y.setVisibility(false);y.setVisibilityFree(true)})}});l.filteredSubjectList.forEach(function(y){var x=j._context.getController().getNode({id:l.nodes[y]});if(x&&x.is3DLeaf&&x.is3DLeaf()){var w=new e();w.addElement(x);var z=b.buildPathesLeadingToNode(x,r);z.forEach(function(B){var A=j._refineOverrideSet.getUniqueOverrideFromPathElement(B);if(A){j._refineOverrideSet.deleteOverride(A)}})}t.push([v++])});j._BIProxy.setPathTags({nodes:l.filteredPathIDList,paths:t})}else{j._onFilterBIUnFilter();l.filteredPathIDList.forEach(function(w){t.push([v++])});j._BIProxy.setPathTags({nodes:l.filteredPathIDList,paths:t})}}else{s.forEach(function(x){if(p[x].is3DLeaf&&p[x].is3DLeaf()){var w=b.buildPathesLeadingToNode(p[x],r);w.forEach(function(z){var y=j._refineOverrideSet.createOverride(z);y.setVisibility(false);y.setVisibilityFree(true)})}});if(l.nodes&&l.path){l.path.forEach(function(A){var y=[];A.forEach(function(D){y.push(l.nodes[D].pid)});var z=j._context.unstreamPath(y);var w=z.getLastElement(true);if(z){if(w.is3DLeaf&&w.is3DLeaf()){var x=j._refineOverrideSet.getUniqueOverrideFromPathElement(z);if(x){j._refineOverrideSet.deleteOverride(x)}}else{var C=[];var B={};w.traverse(function(E){if(E.is3DLeaf&&E.is3DLeaf()&&!B[c.getNodeID(E)]){B[c.getNodeID(E)]=true;var D=b.buildPathesLeadingToNode(E,r);D.forEach(function(F){if(z.isAParentOf(F)){C.push(F)}})}});C.forEach(function(E){var D=j._refineOverrideSet.getUniqueOverrideFromPathElement(E);if(D){j._refineOverrideSet.deleteOverride(D)}})}}})}}var u=j._viewer.getSceneGraphOverrideSetManager();if(u){u.insertSceneGraphOverrideSetAt(j._refineOverrideSet,0)}j._viewer.render({updateInfinitePlane:true});j.publish({event:"onBIFiltering",})}n()})},"filterBIFilter")},_onFilterClose:function(o){var n=this;if(o.tag==="dataFilterPanel"){var k=n._context.getController();var m=o?o:{};if(m.rootIds===undefined){m.rootIds=[];var l=k.getRoots();for(var j=0;j<l.length;j++){m.rootIds.push(l[j].getID())}}k._disableFilterWaiting(m)}},_clearRootEvents:function(){this._cbCounter--;this.unsubscribe(this._biRootAddedEvents);this.unsubscribe(this._biRootRemovedEvents);this._biRootAddedEvents=-1;this._biRootRemovedEvents=-1},_restoreRootEvents:function(){this._cbCounter++;if(this._cbCounter===0){this._biRootAddedEvents=this.subscribe({event:"onRootAdded"},this.onSetTagsWithExpandSynthesis.bind(this));this._biRootRemovedEvents=this.subscribe({event:"onEndRootRemoved"},this._rootRemovedProxyEvent.bind(this))}},isStandaloneFilterAvailable:function(){var l=h.getSetting("enopad3dviewer_roles");var j=false;if(l){for(var k=0;k<l.length;k++){if(l[k].id==="CSV"||l[k].id==="InternalDS"){j=true;break}}}return(h.getSetting("enopad3dviewer_FilterAvailable")&&j)},isSlaveFilterAvailable:function(){var l=h.getSetting("enopad3dviewer_roles");var j=false;if(l){for(var k=0;k<l.length;k++){if(l[k].id==="CSV"||l[k].id==="InternalDS"){j=true;break}}}return(this._biMode==="SLAVE"&&j)},removeFilterFromRoot:function(l,k){var j=this.getRoot({id:l});if(j&&(j.getCVFilterQuery()!==null&&j.getCVFilterQuery()!==undefined)){if(j.setCVFilterQuery){j.setCVFilterQuery(undefined)}this.publish({event:"onFilterEmpty",data:{id:l}})}},refreshAppliedFilters:function(){var j=this.getRoots();for(var k=0;k<j.length;++k){this.removeFilterFromRoot(c.getNodeID(j[k]),true)}}});return d});define("DS/ENOPAD3DViewer/controller/PAD3DViewerController",["UWA/Core","UWA/Controls/Abstract","UWA/Promise","DS/Core/ModelEvents","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADWSAccess","DS/PADUtils/PADSession","DS/PADUtils/PADPromise","DS/PADUtils/views/PADAlert","DS/ENOPAD3DViewer/mixins/PAD3DViewerDECSpecificController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerFilterController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerBIController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerExternalKPIController","DS/ENOPAD3DViewer/controller/PAD3DLayerController","DS/PADUtils/views/PADProgressBar","DS/Visualization/PathElement","DS/PADUtils/PADProbes","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices"],function(j,u,d,p,k,s,o,b,w,c,g,e,q,r,l,v,i,m,a,n,h){var f=1500;var t=u.extend(c,g,e,q,{name:"PAD3DViewerController",init:function(x){this._parent(x);this._model=null;this._modelEvents=null;this._commandProxy=null;this._rootIds=[];this._loadingQueue=[];this._operationInProgress=false;this._BIProxy=null;this._defaultStreamToLoad=null;this._stepcgrAvailableForRole=false;this._promises=[];this._runningQuery=null;this._useWrap=false;this._sessionCBTokens=[];this._configFilter=null;this._modelEvents=new p();this._querySuccess=true;this._engineState=1;this._initModel(x);this._setDefaultStreamToLoad(k.getSetting("enopad3dviewer_CGRorTHB"));var A=k.getWebAPI_Options("navigate3D");if(k.getSetting("supportPgpBasedOnDescription")){A.select_rel.push("ro.plminstance.V_description");k.setWebAPI_Options("navigate3D",A);k.setWebAPI_Options("volumeQuery",A)}var z=require("DS/PADUtils/PADUtilsServices");var y=this;z.getGrantedRoles(function(C){y._stepcgrAvailableForRole=false;for(var B=0;B<C.length;B++){if(C[B].id==="SXX"){y._stepcgrAvailableForRole=true;break}}if(y._stepcgrAvailableForRole){A.computeCGRsNThumbnails=["thumbnail_3d","stepcgr","cgr"];k.setWebAPI_Options("navigate3D",A);k.setWebAPI_Options("volumeQuery",A)}});this._context=x.context;this._BIProxy=x.BIProxy;this._initInterwidgetCom();this.setWrapUsage(k.getSetting("enopad3dviewer_navigate_with_wrap"));o.softInit();this._sessionCBTokens.push(o.subscribe({event:"authoringStateModified"},function(B){y.publish({event:"onAuthoringSwitch",data:{state:B.authored}})}));this._sessionCBTokens.push(o.subscribe({event:"useIndexPreferenceModified"},function(B){y.publish({event:"onIndexAvalabilityChange",data:{availability:B.useIndexPreference}})}));k.addEvent("onEnopad3dviewer_CGRorTHB",function(B){if(y){if(B===true){y._defaultStreamToLoad="cgr"}else{y._defaultStreamToLoad="thumbnail"}}})},destroy:function(){if(this._model){this._model.destroy();delete this._model}if(this._commandProxy){this._commandProxy.destroy();delete this._commandProxy}if(this._modelEvents){delete this._modelEvents}if(this._sessionCBTokens.length){for(var x=0;x<this._sessionCBTokens.length;x++){o.unsubscribe(this._sessionCBTokens[x])}this._sessionCBs=null}this.destroyBIController();this._rootIds=null;this._promises=null;this._BIProxy=null;this._parent()},_initInterwidgetCom:function(){var x=this;if(this._context.isInterwidgetComAvailable()){require(["DS/PADUtils/PADCommandProxy","DS/PADUtils/PADUtilsServices"],function(y,z){x._commandProxy=y.create({events:{onDrop:function(C){var D=require("DS/PADUtils/PADUtilsServices");D.updatePlatformId(C.tenant);if(C.pids||C.paths){x.addRoots(C,false)}else{if(C.rootsWithFilters){for(var B=0;B<C.rootsWithFilters.length;++B){var A=x.getRoot({id:C.rootsWithFilters[B].rootId});if(!A){x.applyFilter(C.rootsWithFilters[B].filter,false)}else{x.publish({event:"onRootAlreadyExisting"})}}}}},onRemove:function(A){x.removeRoots(A,false)},onDetach:function(A){x.detachRoots(A,false)},onAttach:function(A){x.attachRoots(A,false)},onCleanAll:function(){x.flushModel(false)},onPadRefresh:function(A){if(A.TitleInfo){x.publish({event:"onContentNameModified",data:{TitleInfo:A.TitleInfo}})}else{o.setAuthoringState(true,"PADSession_enabling_authored_mode",false);x._parseAuthoringTransaction(A)}},onReceiveFilterInfo:function(A){if(x._filterCalback){x._filterCalback(A);x._filterCalback=null;if(this._filterTimer){clearTimeout(this._filterTimer);this._filterTimer=null}}},onRefreshModel:function(){x.refresh(false)},onPadExpand:function(A){if(A===false){w.displayNotification({msg:a.find_in_context_no_result,eventID:"info"})}else{if(k.getSetting("enopad3dviewer_lightNodeModel")===true){x.unlockChildrenFromProgressiveExpand(A)}else{x.expand(A)}}},onUpdatePosMatrix:function(C){var B=[];if(C.instances){b.createPromise(function(E,D){C.instances.forEach(function(K){var F={elements:[]};var J=K.hasPositioningMatrix;F.elements[0]=parseFloat(J[0]);F.elements[1]=parseFloat(J[1]);F.elements[2]=parseFloat(J[2]);F.elements[3]=parseFloat(0);F.elements[4]=parseFloat(J[3]);F.elements[5]=parseFloat(J[4]);F.elements[6]=parseFloat(J[5]);F.elements[7]=parseFloat(0);F.elements[8]=parseFloat(J[6]);F.elements[9]=parseFloat(J[7]);F.elements[10]=parseFloat(J[8]);F.elements[11]=parseFloat(0);F.elements[12]=parseFloat(J[9]);F.elements[13]=parseFloat(J[10]);F.elements[14]=parseFloat(J[11]);F.elements[15]=parseFloat(1);var I={id:String(K.instance)},L={id:String(K.instance),matrix:F};var G=x._model.updateNode(I,L);if(G){var H=x.buildPathFromArray(K.nodePath);if(H){B.push(H)}}});E()},"posMatrixUpdate");var A=b.getPromises().slice();d.all(A).then(function(D){A=null;x.publish({event:"onEndMatriceUpdate",data:C})})}},onDisableFilterWaiting:x._disableFilterWaiting.bind(x),onSearchInApp:function(A){if(x.search){x.search({searchQuery:A.query})}}}})})}},onMove3D:function(x){this._commandProxy.update2DPosMatrix(x)},isFilterOpen:function(y){var x=this;this._filterCalback=y;this._commandProxy.sendFilterInfo();this._filterTimer=setTimeout(function(){if(x._filterCalback){var z={filterAvailable:false};x._filterCalback(z);x._filterCalback=null}},f)},_isAuthored:function(){return o.determineAuthoredFlag()},_initModel:function(y){var x=this;var z=function(){x.initFilterController().then(function(){x.initBIController();x.initExternalKPIController().then(function(){x._layerController=new r({renderTo:x._context.getFrameWindow().getImmersiveFrame(),rootBag:x.getRootBag(),decorationBag:x.getDecorationBag(),viewer:x._context.getViewer(),controller:x,});if(y.readyCB){y.readyCB()}})})};y.tileModel=y.tileModel===undefined?false:y.tileModel;if(k.getSetting("enopad3dviewer_lightNodeModel")===true){require(["DS/ENOPAD3DViewer/models/PAD3DViewerTileNodeModel"],function(A){x._model=new A({viewer:y.viewer,startLoadingCB:x._startProgressiveLoad.bind(x),endLoadingCB:x._endProgressiveLoad.bind(x),expandCB:function(D,C,B){x.expand(D,C,B)},getFcsUrlsCB:function(B){x.getFcsUrls(B)}});z();x._model.subscribe({event:"colorOverridePostProcess"},function(B){if(x.isColorizeActivated()){x.colorizeNewNodes(B)}});x._model.subscribe({event:"newNodes"},function(B){if(x.isKPIActivated()){x._applyKPIsOnNewNodes(B)}});x._model.subscribe({event:"onUrlLoaded"},function(B){x.publish({event:"onUrlLoaded",data:B})})})}else{require(["DS/ENOPAD3DViewer/models/PAD3DViewerNodeModel"],function(A){x._model=new A({viewer:y.viewer,startLoadingCB:x._startProgressiveLoad.bind(x),endLoadingCB:x._endProgressiveLoad.bind(x),getFcsUrlsCB:function(B){x.getFcsUrls(B)}});z();x._model.subscribe({event:"PGPPostProcess"},function(B){x.publish({event:"PGPPostProcess",data:B})});x._model.subscribe({event:"newNodes"},function(B){if(x.isKPIActivated()){x._applyKPIsOnNewNodes(B)}});x._model.subscribe({event:"onUrlLoaded"},function(B){x.publish({event:"onUrlLoaded",data:B})});x._model.subscribe({event:"onLeafReferenceLoaded"},function(B){x.publish({event:"onLeafReferenceLoaded",data:B})});x._model.subscribe({event:"onLeafReferenceUnloaded"},function(B){x.publish({event:"onLeafReferenceUnloaded",data:B})})})}},getHiddenRootIds:function(x){if(x!==undefined){return this._model.getHiddenRootIds(x)}else{return this._model.getHiddenRootIds()}},_startAsync:function(x){this._operationInProgress=true;x=undefined===x?{}:x;this.publish({event:"startAsync",data:x})},_startProgressiveLoad:function(){this.publish({event:"onStartProgressiveLoad"})},_stopAsync:function(x){this._operationInProgress=false;this._runningQuery=null;this.publish({event:"stopAsync",data:x})},_endProgressiveLoad:function(x){this.publish({event:"onEndProgressiveLoad",data:x})},switchAuthoringMode:function(y,x,z){o.setAuthoringState(y,z,x)},_parseAuthoringTransaction:function(B){var A=this;var x=B.transactions;if(x){A.publish({event:"onAuthoringTransactionBegin"});for(var z=0;z<x.length;z++){var D=x[z];if(D.reParent){A.reparent(D.reParent)}else{if(D.insertExisting){if(D.insertExisting.inserted&&D.insertExisting.inserted.length>1){for(var y=0;y<D.insertExisting.inserted.length;y++){var E={created:[D.insertExisting.created[y]],inserted:[D.insertExisting.inserted[y]],modified:[D.insertExisting.modified[y]]};A.insertExisting(E)}}else{A.insertExisting(D.insertExisting)}}}}var C=b.getPromises().slice();d.all(C).then(function(){C=null;A.publish({event:"onAuthoringTransactionEnd"})})}else{if(B.detach){A.unparent(B.detach)}}},_processLoadingQueue:function(){if(!this.isRunning()){var x=this._loadingQueue.splice(0,1);if(x.length){this._load(x[0])}}},_load:function(Q){var W=this;Q.userFeedback=Q.userFeedback!==undefined?Q.userFeedback:true;var N=Q.reframe;var S=Q.path;var R=Q.paths;var O=Q.structure;var I=Q.configBin;var E=Q.sequence_filter;var U=Q.CVQuery3D;var x=Q.id;var H=Q.parent;var K=Q.hidden!==undefined?Q.hidden:false;var D=Q.forceIndex?Q.forceIndex:false;var ab=W._useWrap?(W._wait4Filter?"expand3D":"wrap"):"expand3D";var Z=parseInt(k.getSetting("webapi_timeout"));var X=Q.expand_iter!==undefined?Q.expand_iter:"-1";var ac=k.getSetting("enopad3dviewer_navigate_wrap_density")?k.getSetting("enopad3dviewer_navigate_wrap_density"):4;var P=k.getWebAPI_Options("navigate3D");var G={expand_iter:X,select_bo:P.select_bo,select_rel:P.select_rel,compute_select_bo:this.getDefaultStreamToLoad()==="thumbnail"?P.computeCGRsNThumbnails:P.computeCGRs,intent:"explore_3D",authored:W._isAuthored(),debug:k.getSetting("enopad_webapis_debug"),boundingbox:W._withBoundingBoxes(),fcs_url_mode:k.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":undefined,find_in_context:Q.findInCtx?[{"q.query":Q.findInCtx}]:undefined,find_in_context_physicalid:Q.find_in_context_physicalid?Q.find_in_context_physicalid:undefined,option:W._useWrap>0&&!Q.findInCtx?{density:!j.is(ac,"string")?ac.toString():ac}:undefined,config_filter:I!==undefined?I:undefined,sequence_filter:E!==undefined?E:undefined,max_count_path:Q.max_count_path?Q.max_count_path:undefined};if(k.getSetting("enopad3dviewer_lightNodeModel")===true){if(W.isColorizeActivated()&&W._colorMap){G.select_bo.push(W._colorMap.predicate);G.select_rel.push(W._colorMap.predicate)}G.nbchildren=true}var M=Q.progressiveExpand!==undefined?Q.progressiveExpand:k.getSetting("enopad3dviewer_lightNodeModel")===true&&!W._useWrap;if(M){ab="progressiveExpand";var J=this._context.getViewpointParameters();G.zoom="0.0";if(!k.getSetting("enopad3dviewer_useNewProgressiveExpandAPI")){var T=J.near.toFixed(0);var L=J.far.toFixed(0);var z=L.length-T.length;for(var ae=0;ae<z;ae++){T="0"+T}G.pass="0";G.zoom=L+"."+T}var af=h.convertExponentialToDecimal;G.screen_width_px=this._context.getViewer().SCREEN_WIDTH.toFixed(1);G.screen_height_px=this._context.getViewer().SCREEN_HEIGHT.toFixed(1);G.eye_position=[af(J.eye[0].x),af(J.eye[0].y),af(J.eye[0].z)];G.sight=[af(J.sight[0].x),af(J.sight[0].y),af(J.sight[0].z)];G.up=[af(J.up[0].x),af(J.up[0].y),JSON.stringify(J.up[0].z)];G.angle=J.fov.toFixed(1);G.near_plane=J.near.toFixed(1);G.far_plane=J.far.toFixed(1);G.pixel_culling=Q.pixelCulling!==undefined?""+Math.max(Q.pixelCulling,parseInt(k.getSetting("enopad3dviewer_pixelCulling_progressiveExpand"))):k.getSetting("enopad3dviewer_pixelCulling_progressiveExpand")}var ag="";var V=false;var ad=false;if(S){if(S.length>1){V=true}else{x=S[0]}}if(R){ad=true}if(V){G.root_path_physicalid=[S];G.rootPhID=S[0];ag=S[0]}else{if(ad){G.root_path_physicalid=R;G.rootPhID=R[0][0];ag=R[0][0]}else{G.root_physicalid=x;G.rootPhID=x;ag=x}}function y(){H=null;S=null;K=null;I=null;x=null;G=null;Q=null;W=null}if(U&&!W._isAuthored()){D=true;var aa=U;if(G.find_in_context){aa=W._context.getBIController()._BIProxy.completeCVQueryWithAppSpecs(U,{find_in_context:G.find_in_context},true)}var B=j.clone(aa,true);if(ab==="wrap"){if(B.union){B.union.wrap=B.union.expand3d;delete B.union.expand3d;B.union.wrap.forEach(function(ah){ah.option=G.option})}else{if(B.intersect){B.intersect.wrap=B.intersect.expand3d;delete B.intersect.expand3d;B.intersect.wrap.forEach(function(ah){ah.option=G.option})}else{if(B.minus){B.minus.wrap=B.minus.expand3d;delete B.minus.expand3d;B.minus.wrap.forEach(function(ah){ah.option=G.option})}}}}delete G.root_physicalid;delete G.root_path_physicalid;delete G.find_in_context;delete G.expand_iter;delete G.option;G=j.extend(G,B,true)}if(ad){this.navQueryProbe=i.createProbe("Expand"+X+" - "+R.length+" paths")}else{this.navQueryProbe=i.createProbe("navigateQuery")}var F=W;W._abortLoading=function(){F._interruptLoading(ag);F._stopAsync({userFeedback:Q.userFeedback});if(Q.onCancel){Q.onCancel()}y()};W._pauseLoading=function(){if(F._runningQuery){F._pauseQuery();F._stopAsync({userFeedback:Q.userFeedback});if(Q.onCancel){Q.onCancel()}y()}};W._startAsync(Q.cancelable===false?{userFeedback:Q.userFeedback}:{onCancel:W.abortLoading.bind(W),userFeedback:Q.userFeedback});W.publish({event:"onBeginRootLoading"});l.setText(m.queryRunning);function A(ai){W.navQueryProbe.end();delete W.navQueryProbe;var aq;try{aq=j.is(ai,"string")?JSON.parse(ai):ai}catch(ah){W._stopAsync({userFeedback:Q.userFeedback});if(Q.onFailure){Q.onFailure()}y();return}var am=aq.error?aq.error.errorCode:false;if(am==="CLOUDVIEW_ERROR__SUMMARY"){W._stopAsync({userFeedback:Q.userFeedback});var ap=false;var ak=false;if(!W._isAuthored()&&k.getSetting("enopad_webapis")){for(var aj=0;aj<aq.error.errors.length;aj++){if(aq.error.errors[aj].errorCode==="CLOUDVIEW_ERROR__INVALID_PATH_QUERY"||aq.error.errors[aj].errorCode==="CLOUDVIEW_ERROR__INVALID_ROOTS"){ap=true}else{if(aq.error.errors[aj].errorCode==="VOLUME_QUERIES_DISABLED"){ak=true}}}}if(ap){o.setAuthoringState(true,a.PADSession_disabling_index_object_not_found,true);W._load(Q)}else{if(ak){if(Q.CVQuery3D){W._operationInProgress=true;delete Q.CVQuery3D;Q.expand_iter="0";W._load(Q);W.publish({event:"onVQDisabled"})}}else{if(Q.onFailure){var al={filterMessage:a.cannot_insert_branch};Q.onFailure(al,null,null)}}}y();return}if(aq.authoringMode&&aq.authoringMode===true){o.setAuthoringState(true,"PADSession_disabling_index_from_server",true)}l.setText(m.parsingResponse);if(!aq.results||aq.results.length===0||!W.isRunning()||(aq.results.length===1&&typeof aq.results[0].status!=="undefined")){if(Q.findInCtx){W._stopAsync({userFeedback:Q.userFeedback});if(Q.onComplete){var an=aq.results&&aq.results.length===1&&typeof aq.results[0].status!=="undefined"?aq.results[0].status:undefined;Q.onComplete({tooManyPath:an});y()}}else{if(Q.sequence_filter||Q.CVQuery3D){W._stopAsync({userFeedback:Q.userFeedback});var ao={filterMessage:a.sequence_filter_error,display:true,eventID:"info"};if(Q.CVQuery3D){Q.CVQuery3DToStoreOnObject=Q.CVQuery3D;delete Q.CVQuery3D;Q.expand_iter="0";W._loadingQueue.push(Q);W._operationInProgress=false}if(Q.onFailure){Q.onFailure(ao);y()}}else{if(M){W._stopAsync({userFeedback:Q.userFeedback});if(Q.onFailure){Q.onFailure();y()}}else{W._stopAsync({userFeedback:Q.userFeedback});if(!W._isAuthored()&&k.getSetting("enopad_webapis")){o.setAuthoringState(true,a.PADSession_disabling_index_object_not_found,true);W._load(Q)}else{if(Q.onFailure){Q.onFailure(ai);y()}}}}}}else{W._model.buildFromJSON({rootIds:[ag],json:aq,reframe:N,parent:H,hidden:K,forceLoad:Q.forceLoad,partialOpen:S!==undefined&&S.length>1?true:false,partialOpenPath:S!==undefined&&S.length>1?S:null,progressiveExpand:M,expand3DType:ab,streamToLoad:W.getDefaultStreamToLoad(),nbRoot:W.getNbRoots(),intent:Q.intent,extraAttribute:W._colorMap?W._colorMap.predicate:undefined,callbacks:{onCGRLoad:function(ar){if(Q&&Q.onProgress){Q.onProgress(ar)}},onReframe:function(ar){W.publish({event:"onReframe",data:ar})},onComplete:function(at){if(W){W._stopAsync({userFeedback:Q.userFeedback});var ar=W.getRoot({id:ag});if(ar){if(n.isPLMNode(ar)){Q.CVQuery3D=Q.CVQuery3D||Q.CVQuery3DToStoreOnObject;if(Q.configBin){ar.setConfigFilter(I)}else{ar.setConfigFilter(undefined)}if(Q.sequence_filter){ar.setSequenceFilter(E)}else{ar.setSequenceFilter(undefined)}if(Q.CVQuery3D){ar.setCVFilterQuery(Q.CVQuery3D)}else{ar.setCVFilterQuery(undefined)}}else{if(!ad){}}if(Q.onComplete){Q.onComplete(at)}}else{if(Q.onFailure){Q.onFailure()}}aq=null;y()}}}})}}var C=!W._useWrap&&!D?k.getSetting("enopad_webapis"):false;if(!O){var Y={enopad_webapis:C,data:G,expand3DType:ab,timeout:Z,onComplete:A,onCancel:!Q.userFeedback?(Q.onCancel?Q.onCancel:undefined):undefined,onFailure:function(al,ah,aj){W.navQueryProbe.end();delete W.navQueryProbe;var ai;try{ai=j.is(ah,"string")?JSON.parse(ah):ah;W._stopAsync({userFeedback:Q.userFeedback});if(!W._isAuthored()&&ai&&ai.error&&(ai.error.errorCode==="CLOUDVIEW_ERROR__INVALID_ROOT"||ai.error.errorMessage.search("No input query root")!==-1)){o.setAuthoringState(true,a.PADSession_disabling_index_object_not_found,true);W._load(Q)}else{if(Q.onFailure){Q.onFailure(al,ah,aj)}}y()}catch(ak){W._stopAsync({userFeedback:Q.userFeedback});if(Q.onFailure){Q.onFailure(al,null,aj)}y()}},onTimeout:function(){W.navQueryProbe.end();delete W.navQueryProbe;W._stopAsync({userFeedback:Q.userFeedback});if(Q.onTimeout){Q.onTimeout()}y()}};if(U&&ab!=="progressiveExpand"){delete Y.data.rootPhID;W._runningQuery=s.multiexpand(Y)}else{if(ab==="progressiveExpand"&&k.getSetting("enopad3dviewer_useNewProgressiveExpandAPI")){W._runningQuery=s.progressiveExpand(Y)}else{delete Y.data.rootPhID;W._runningQuery=s.navigate(Y)}}}else{A(O)}},getAttributes:function(C){if(!j.is(C,"object")){throw new Error("No parameter defined")}if(!j.is(C.ids,"array")){throw new Error("No input ids defined")}if(!j.is(C.attributes,"array")){throw new Error("No attributes to load defined")}if(!j.is(C.callbacks,"object")){throw new Error("No callbacks function defined")}if(!j.is(C.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}if(!j.is(C.callbacks.onFailure,"function")){throw new Error("No onFailure callback function defined")}var B=this;var x=[];var A=[];for(var y=0;y<C.attributes.length;y++){var z=C.attributes[y];switch(z){case"type_icon_url":x.push("icon");break;case"cgr":if(B._stepcgrAvailableForRole){x.push("stepcgr")}x.push(z);x.push("assembly_cgr");break;case"thumbnail_3d":x.push(z);break;case"svg":x.push(z);break;default:A.push(z);break}}s.fetch({enopad_webapis:k.getSetting("enopad_webapis"),pids:C.ids,data:{authored:C.authored?C.authored:B._isAuthored(),intent:"fetch_3D",select_file:x.length?x:undefined,select_predicate:A.length?A:undefined,fcs_url_mode:k.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":undefined},onComplete:function(H){var L=j.is(H,"string")?JSON.parse(H):H;if(!L.results||L.results.length===0){var K=new Error("Cannot find object with the physicalid "+C.ids);C.callbacks.onFailure(K);throw K}if(L.results.length!==C.ids.length){console.warn("Warning : some results are missing from input")}var M={};for(var I=0;I<L.results.length;I++){var E=L.results[I];if(E.attributes!==undefined){var J=null,G={};for(var F=0;F<E.attributes.length;F++){var D=E.attributes[F];if(D.name==="resourceid"){J=D.value}else{if(D.name==="assembly_cgr"){G.cgr=D.value}else{if(!G[D.name]){G[D.name]=D.value}}}}if(G.stepcgr){G.cgr=G.stepcgr;delete G.stepcgr}M[J]=G}}C.callbacks.onComplete(M)},onFailure:function(F,D,E){C.callbacks.onFailure(F)}})},addFilter:function(x){this._commandProxy.addFilter(x)},volumeQueryFilter:function(D,x,E){var C=this;var z=(D.completion)?D.completion:false;var B=C.getRootBag();var A=parseInt(k.getSetting("webapi_timeout"));var y={enopad_webapis:false,data:D.data,timeout:A,onComplete:function(N){var S;try{S=j.is(N,"string")?JSON.parse(N):N}catch(K){C.publish({event:"onLoadingFailure",data:{message:m.cannotParseQueryResult}});D.callbacks.onFailure(K);E();return}var Q=S.error?S.error.errorCode:false;if(Q==="CLOUDVIEW_ERROR__SUMMARY"){D.callbacks.onFailure({errors:S.error.errors});E();return}else{if(z){C._model.buildFromJSON({rootIds:D.rootIds,json:S,parent:B,hidden:false,forceLoad:true,streamToLoad:C.getDefaultStreamToLoad(),nbRoot:C.getNbRoots(),callbacks:{onCGRLoad:function(U){C.nbCGRToLoad=U.nbCGRToLoad;C.publish({event:"onProgress",data:{progress:Math.floor((U.nbCGRLoaded/U.nbCGRToLoad)*100),message:m.displaying3D+": "+U.nbCGRLoaded+" of "+U.nbCGRToLoad+" "+m.parts,reframe:false}})},onComplete:function(U){if(U.createdPaths){x.createdPaths=x.createdPaths.concat(U.createdPaths)}if(U.selectedPaths){x.selectedPaths=x.selectedPaths.concat(U.selectedPaths)}E()}}})}else{var T=[];l.setText(m.parsingResponse);var J={};for(var O=0;O<S.results.length;O++){var L=S.results[O];if(L.attributes!==undefined){var R="",P="";for(var M=0;M<L.attributes.length;M++){var I=L.attributes[M];if(I.name==="did"){R=I.value}else{if(I.name==="physicalid"){P=I.value}}}J[R]=P}if(L.path!==undefined){var F=[];for(var M=0;M<L.path.length;M++){var H=J[L.path[M].toString()];if(H){F.push(H)}}if(F.length){var G=C.buildPathFromArray(F);if(G){T.push(G)}}}}if(N.selectedPaths){x.selectedPaths=x.selectedPaths.concat(N.selectedPaths)}E()}}},onFailure:function(H,F,G){C._stopAsync();C._querySuccess=false;D.callbacks.onFailure(H,F,G);E()}};if(k.getSetting("enopad3dviewer_lightNodeModel")===true){y.nbchildren=true}if(D.data.union||D.data.intersect||D.data.minus){s.multiexpand(y)}else{s.volumeQuery(y)}},volumeQuery:function(H){if(!j.is(H,"object")){throw new Error("No parameter defined")}if(!j.is(H.data,"object")){throw new Error("No input data defined")}if(!j.is(H.callbacks,"object")){throw new Error("No callbacks function defined")}if(!j.is(H.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}if(!j.is(H.callbacks.onFailure,"function")){throw new Error("No onFailure callback function defined")}var C=this;C._startAsync();this._filterCheckPromise=[];var F=C.getRootBag();var x=[];var D=[];var B=k.getWebAPI_Options("navigate3D");H.data.boundingbox=H.data.boundingbox===undefined?C._withBoundingBoxes():H.data.boundingbox;H.data.select_bo=H.data.select_bo===undefined?B.select_bo:H.data.select_bo;H.data.select_rel=H.data.select_rel===undefined?B.select_rel:H.data.select_rel;H.data.compute_select_bo=H.data.compute_select_bo===undefined?this.getDefaultStreamToLoad()==="thumbnail"?B.computeCGRsNThumbnails:B.computeCGRs:H.data.compute_select_bo;if(k.getSetting("enopad3dviewer_lightNodeModel")===true){H.data.nbchildren=true}var y=[];for(var A=0;A<H.data.root_path_physicalid.length;A++){y.push(H.data.root_path_physicalid[A][0])}if(y){l.setText(m.queryRunning);y.forEach(function(J){var K=C.getRoot({id:J});if(K.getConfigFilter()!==undefined||K.getSequenceFilter()!==undefined||K.getCVFilterQuery()!==undefined){x.push(K)}else{D.push(J)}});var G={createdPaths:[],selectedPaths:[]};var z=[];if(x.length>0){var I=j.clone(H,true);x.forEach(function(L){I.data.config_filter=L.getConfigFilter();I.data.sequence_filter=L.getSequenceFilter();var K=L.getCVFilterQuery();if(K){var J=C._context.getBIController()._BIProxy.completeCVQueryWithAppSpecs(K,{volume_filter:I.data.volume_filter},true);delete I.data.volume_filter;delete I.data.root_path_physicalid;I.data=j.extend(I.data,J)}else{if(I.data.config_filter&&I.data.volume_filter&&I.data.volume_filter.assemblyshape){I.data.volume_filter.assemblyshape.config_filter=I.data.config_filter}}I.rootIds=[L];C._filterCheckPromise.push(b.createPromise(function(M){C.volumeQueryFilter(I,G,M)},"filterCheckPromise"))})}if(D.length>0){C._filterCheckPromise.push(b.createPromise(function(M){var J=j.clone(H,true);var L=[];for(var K=0;K<D.length;K++){L.push([D[K]])}J.data.root_path_physicalid=L;J.rootIds=D;C.volumeQueryFilter(J,G,M)},"filterCheckPromise"))}var E=b.getPromises().slice();if(C._filterCheckPromise){d.all(E).then(function(){E=null;H.callbacks.onComplete({createdPaths:G.createdPaths,selectedPaths:G.selectedPaths,querySuccess:C._querySuccess});C._stopAsync();if(G.createdPaths.length){C.publish({event:"onCompletionCompleted",data:{nbPathLoaded:G.createdPaths.length,rootNodes:[C.getNode({id:G.createdPaths[0][1]})],reframe:false}})}delete C._filterCheckPromise})}}},switchNodeVisuStreamOnDemand:function(B){if(!j.is(B,"object")){throw new Error("No parameter defined")}if(!j.is(B.data,"array")){throw new Error("No input data defined")}var A=this,z=[];A._startAsync();var y=B.data[0].stream==="thumbnail"?"thumbnail_3d":"cgr";for(var x=0;x<B.data.length;x++){z.push(n.getNodeID(B.data[x].node))}A.getAttributes({ids:z,attributes:[y],callbacks:{onComplete:function(C){for(var D=0;D<B.data.length;D++){B.data[D]={node:B.data[D].node,stream:B.data[D].stream,url:C[n.getNodeID(B.data[D].node)][y]}}A._model.switchNodeVisuStreamOnDemand({data:B.data,noMeshInRAM:undefined===B.noMeshInRAM?true:B.noMeshInRAM,applicativeContainers:undefined===B.applicativeContainers?undefined:B.applicativeContainers,callbacks:{onURLLoad:function(E){A.publish({event:"onProgress",data:{progress:Math.floor((E.nbURLLoaded/E.nbURLToLoad)*100),message:m.displaying3D+": "+E.nbURLLoaded+" of "+E.nbURLToLoad+" "+m.parts,reframe:false}})},onComplete:function(E){A._stopAsync();A.publish({event:"onStreamSwitched"});if(B.callbacks&&B.callbacks.onComplete){B.callbacks.onComplete(E)}}}})},onFailure:function(C){A._stopAsync();A.publish({event:"onStreamSwitchFailure"});if(B.callbacks&&B.callbacks.onFailure){B.callbacks.onFailure(C)}}}})},expand:function(G,C,B,H){B=B===undefined?true:B;H=H===undefined?false:H;if(!j.is(G,"object")){throw new Error("No parameter defined")}if(G.paths===undefined){console.error("No paths array defined");return}if(G.reframe){H=G.reframe}G.singleAdd=G.singleAdd===undefined?true:G.singleAdd;var A=this;var F=[];var E=b.getPromises().slice();if(G.singleAdd){for(var z=0;z<G.paths.length;z++){var y=G.paths[z];b.createPromise(function(M,L){var K=y[0];var I=A.getNode({id:j.is(K,"array")?K[0]:K});if(I){var J={cancelable:false,path:y,parent:A.getRootBag(),hidden:false,intent:G.intent,progressiveExpand:G.progressiveExpand,expand_iter:G.expand_iter,forceLoad:G.forceLoad,sequence_filter:I.getSequenceFilter&&I.getSequenceFilter()?I.getSequenceFilter():undefined,configBin:I.getConfigFilter&&I.getConfigFilter()?I.getConfigFilter():undefined,CVQuery3D:I.getCVFilterQuery&&I.getCVFilterQuery()?I.getCVFilterQuery():undefined,resolve:M,onComplete:function(Q){var O=new v();O.addElement(A.getRootBag());for(var N=0;N<y.length-1;N++){var P=A.getNode({id:y[N]});if(P){O.addElement(P)}}A.publish({event:"onExpandCompleted",data:{path:O,rootNodes:I,displayNotif:B}});if(M){M()}if(A._loadingQueue.length){A._processLoadingQueue()}else{if(G.onComplete){G.onComplete()}A.publish({event:"onComplete",data:{BS:Q.BS,reframe:H,displayNotif:B}})}},onProgress:function(N){A.publish({event:"onProgress",data:{progress:Math.floor((N.nbCGRLoaded/N.nbCGRToLoad)*100),message:m.displaying3D+": "+N.nbCGRLoaded+" of "+N.nbCGRToLoad+" "+m.parts,reframe:false}})},onFailure:function(){A.publish({event:"onLoadingFailure",data:{message:a.generic_service_failure,displayNotif:B}});if(M){M()}if(A._loadingQueue.length){A._processLoadingQueue()}else{if(G.onFailure){G.onFailure()}A.publish({event:"onComplete",data:{reframe:H,displayNotif:B}})}},onTimeout:function(){A.publish({event:"onLoadingFailure",data:{message:m.timeout,displayNotif:B}});if(M){M()}if(A._loadingQueue.length){A._processLoadingQueue()}else{if(G.onFailure){G.onFailure()}A.publish({event:"onComplete",data:{reframe:H,displayNotif:B}})}}};F.push(J)}else{console.warn("No root found");if(M){M()}}},"expand")}}else{var y=G.paths;var D=y[0][0];var x=A.getRoot({id:D});b.createPromise(function(K,J){var I={cancelable:false,paths:y,userFeedback:false,parent:A.getRootBag(),hidden:false,resolve:K,progressiveExpand:G.progressiveExpand,expand_iter:G.expand_iter,forceLoad:G.forceLoad,pixelCulling:G.pixelCulling,onComplete:function(L){if(K){K()}if(A._loadingQueue.length){A._processLoadingQueue()}else{if(G.onComplete){G.onComplete(L)}A.publish({event:"onComplete",data:{reframe:H,displayNotif:B}})}},onFailure:function(){A.publish({event:"onLoadingFailure",data:{message:a.generic_service_failure,displayNotif:B}});if(K){K()}if(A._loadingQueue.length){A._processLoadingQueue()}else{if(G.onFailure){G.onFailure()}A.publish({event:"onComplete",data:{reframe:H,displayNotif:B}})}},onCancel:function(){A.publish({event:"onLoadingCancel"});if(K){K()}if(A._loadingQueue.length){A._processLoadingQueue()}else{if(G.onFailure){G.onFailure()}}},onTimeout:function(){A.publish({event:"onLoadingFailure",data:{message:m.timeout,displayNotif:B}});if(K){K()}if(A._loadingQueue.length){A._processLoadingQueue()}else{if(G.onFailure){G.onFailure()}A.publish({event:"onComplete",data:{reframe:H,displayNotif:B}})}}};F.push(I)},"expand")}d.all(E).then(function(I){E=null;for(var J=0;J<F.length;J++){var K=F[J];A._loadingQueue.push(K)}A._processLoadingQueue()})},addRoots:function(B,T,O,x,Q){var D=this,N;var I=[];if(!j.is(B,"object")){throw new Error("No parameter defined")}if(B.pids===undefined&&B.paths===undefined&&B.structures===undefined&&B.objects===undefined&&B.rootsWithFilters===undefined){console.error("No ids or paths array defined");return}if(O!==undefined&&!j.is(O,"boolean")){throw new Error("displayNotif not correctely defined")}x=undefined===x?true:x;var z=B.objects!==undefined?B.objects:[];var R=B.pids_hidden!==undefined?B.pids_hidden:[];var y={};if(B.pids){for(N=0;N<B.pids.length;N++){var K=B.pids[N];z.push({id:K,hidden:R.indexOf(K)>=0?true:false})}}if(B.paths){for(N=0;N<B.paths.length;N++){var L=B.paths[N];z.push({path:L,hidden:R.indexOf(L[0])>=0?true:false})}}if(B.rootsWithFilters){var J=false;for(N=0;N<B.rootsWithFilters.length;N++){var K=B.rootsWithFilters[N].rootId;if(I.indexOf(K)===-1){I.push(K);var G=B.rootsWithFilters[N].filter.config_filter;var P=B.rootsWithFilters[N].filter.sequence_filter;var H=B.rootsWithFilters[N].filter.CVQuery3D;z.push({id:K,configBin:G,sequence_filter:P,CVQuery3D:H,hidden:R.indexOf(K)>=0?true:false})}else{J=true}}if(J===true){w.displayNotification({msg:a.filterMultipleSameRoot,eventID:"warning"})}}if(B.structures){for(N=0;N<B.structures.length;N++){z.push(B.structures[N])}}var E;if(B.loadWithFilter===true){if(k.getSetting("enopad3dviewer_lightNodeModel")===true){this.pauseProgressiveLoading()}E="0";this.publish({event:"onDisableUX"});this._wait4Filter=true}for(N=0;N<z.length;N++){var S=z[N];if(S.id){if(!y.pids){y.pids=[]}y.pids.push(S.id)}if(S.path){if(!y.paths){y.paths=[]}y.paths.push(S.path)}}O=O!==undefined?O:true;var A=[];var C=b.getPromises().slice();for(N=0;N<z.length;N++){var M=z[N];b.createPromise(function(ac,ae){var V=null,U=null,ad=null,ab=M.configBin!==undefined?M.configBin:undefined,aa=M.sequence_filter!==undefined?M.sequence_filter:undefined,Y=M.hidden!==undefined?M.hidden:false,X=M.CVQuery3D!==undefined?M.CVQuery3D:undefined,W=M.filterId!==undefined?M.filterId:undefined;if(M.structure&&M.rootID){V=M.structure;U=M.rootID;ad=[M.rootID]}else{if(M.id){U=M.id;ad=[M.id]}else{if(M.path){U=M.path[0];ad=M.path}}}var Z={cancelable:true,reframe:x,path:ad,structure:V,parent:D.getRootBag(),hidden:Y,configBin:ab,sequence_filter:aa,CVQuery3D:X,resolve:ac,intent:"addRoot",expand_iter:E,onComplete:function(ai){x=k.getSetting("enopad3dviewer_dynamicRepLoading")?false:x;var ag=new v();ag.addElement(D.getRootBag());for(var af=0;af<=ad.length-1;af++){var ah=D.getNode({id:ad[af]});if(ah){ag.addElement(ah)}}if(D._rootIds.indexOf(U)===-1){D._rootIds.push(U);if(Y&&D.getHiddenRootIds().indexOf(U)===-1){D.getHiddenRootIds().push(U)}}D._model.addToRootLog(ad);D.publish({event:"onRootAdded",data:{path:ag,rootLog:D._model.getRootLog(),isFiltered:B.loadWithFilter,filterId:W,id:U,displayNotif:O,reframe:x,inContext:ad.length>1?true:false,hidden:this.hidden,BS:ai.BS}});if(ac){ac()}if(D._loadingQueue.length){D._processLoadingQueue()}else{D.publish({event:"onComplete",data:{reframe:x,BS:ai.BS,intend:"addRoot"}});if(Q){Q()}}},onProgress:function(af){D.publish({event:"onProgress",data:{progress:Math.floor((af.nbCGRLoaded/af.nbCGRToLoad)*100),message:m.displaying3D+": "+af.nbCGRLoaded+" of "+af.nbCGRToLoad+" "+m.parts,reframe:x}})},onFailure:function(al,ag,aj){var ak=null;var ai=null;if(al&&al.filterMessage){ak=al.filterMessage}else{ak=a.generic_service_failure}if(al&&al.eventID){ai=al.eventID}var ah=j.is(ag,"string")?JSON.parse(ag):ag;if(ah&&ah.error&&ah.error.errorCode&&a[ah.error.errorCode]){ak=a[ah.error.errorCode]}var af=al&&al.display===true?al.display:O;D.publish({event:"onLoadingFailure",data:{displayNotif:af,message:ak,eventID:ai}});if(ac){ac()}if(D._loadingQueue.length){D._processLoadingQueue()}else{D.publish({event:"onComplete",data:{reframe:x}});if(Q){Q()}}},onTimeout:function(){if(O){D.publish({event:"onLoadingFailure",data:{displayNotif:O,message:m.timeout}})}if(ac){ac()}if(D._loadingQueue.length){D._processLoadingQueue()}else{D.publish({event:"onComplete",data:{reframe:x}});if(Q){Q()}}},onCancel:function(){D.removeRoots({pids:[U]});if(ac){ac()}if(D._loadingQueue.length){var af=D._loadingQueue.splice(0,1);if(af[0]&&af[0].onCancel){af[0].onCancel()}}else{D.publish({event:"onLoadingCanceled",data:{message:m.loadingCanceled}});D.publish({event:"onComplete",data:{reframe:x}});if(Q){Q()}}}};A.push(Z)},"addRoot")}d.all(C).then(function(U){C=null;for(var Y=0;Y<A.length;Y++){var aa=A[Y];var ab=aa.path;var W=false;for(var X=0;X<D._model.getRootLog().length;X++){var Z=D._model.getRootLog()[X];if(Z.length===ab.length){W=true;for(var V=0;V<ab.length;V++){if(Z[V]!==ab[V]){W=false}}if(W){break}}}if(W){D.publish({event:"onRootAlreadyExisting"});aa.resolve()}else{if(!aa.hidden){aa.hidden=D.getHiddenRootIds().indexOf(aa.path[0])>-1}D._loadingQueue.push(aa)}}if(k.getSetting("enopad3dviewer_initializeWithWrap")===true){D.setWrapUsage(true)}D._processLoadingQueue();if(k.getSetting("enopad3dviewer_initializeWithWrap")===true){D.setWrapUsage(false)}});if((T||(T===undefined))&&D._commandProxy){var F=require("DS/PADUtils/PADUtilsServices");y.tenant=F.getPlatformId();if(B.loadWithFilter===true){y.loadWithFilter=true}D._commandProxy.drop(y)}},attachRoot:function(y){if(!j.is(y,"object")){throw new Error("No parameter defined")}if(y.id===undefined){console.error("No ids array defined");return}var x=this;x._model.attachNode({id:y.id,parentId:x._model.getRootBagId()})},attachRoots:function(z,x){if(!j.is(z,"object")){throw new Error("No parameter defined")}if(z.pids===undefined){console.error("No ids array defined");return}var y=this;var A=b.getPromises().slice();b.createPromise(function(C,B){d.all(A).then(function(D){A=null;for(var G=0;G<z.pids.length;G++){var I=z.pids[G];var H=y.getNode({id:I});if(H){y.attachRoot({id:I});for(var E=y.getHiddenRootIds().length-1;E>=0;E--){if(y.getHiddenRootIds(E)===I){y.getHiddenRootIds().splice(E,1);break}}var F=y.getRootBagPath();F.addElement(H);y.publish({event:"onRootAttached",data:{path:F,id:I}})}}if((x||(x===undefined))&&y._commandProxy){y._commandProxy.attach(z)}C()})},"attachRoot")},removeRoots:function(B,z,x){if(!j.is(B,"object")){throw new Error("No parameter defined")}if(B.pids===undefined){console.error("No ids array defined");return}x=undefined===x?true:x;var A=this,y=false;var C=b.getPromises().slice();b.createPromise(function(E,D){d.all(C).then(function(F){C=null;for(var H=0;H<B.pids.length;H++){var K=B.pids[H];var I=A.getRoot({id:K});if(I){A.publish({event:"onBeginRootRemoved",data:{dispatch:z}});if(B.removeDetached===true){y=true}A._model.removeRoot({id:K,removeDetached:y});if(A._rootIds.indexOf(K)>-1){A._rootIds.splice(A._rootIds.indexOf(K),1);for(var J=A.getHiddenRootIds().length-1;J>=0;J--){if(A.getHiddenRootIds(J)===K){A.getHiddenRootIds().splice(J,1);break}}}var G=A.getRootBagPath();G.addElement(I);A.publish({event:"onRootRemoved",data:{path:G,id:K,reframe:x,rootLog:A._model.getRootLog(),dispatch:z}})}}if((z||(z===undefined))&&A._commandProxy){A._commandProxy.remove(B)}E();A.publish({event:"onEndRootRemoved",data:{ids:B.pids}});x=null;A=null})},"RemoveRoot")},detachRoots:function(z,x){if(!j.is(z,"object")){throw new Error("No parameter defined")}if(z.pids===undefined){console.error("No ids array defined");return}var y=this;var A=b.getPromises().slice();b.createPromise(function(C,B){d.all(A).then(function(D){A=null;for(var F=0;F<z.pids.length;F++){var H=z.pids[F];var G=y.getNode({id:H});if(G&&y.getHiddenRootIds().indexOf(H)===-1){y._model.detachNode({id:H,parentId:y._model.getRootBagId()});y.getHiddenRootIds().push(H);var E=y.getRootBagPath();E.addElement(G);y.publish({event:"onRootDetached",data:{path:E,id:H}})}}if((x||(x===undefined))&&y._commandProxy){y._commandProxy.detach(z)}C()})},"detachRoot")},unparent:function(B){if(!j.is(B,"object")){throw new Error("No parameter defined")}if(!j.is(B.deleted,"array")){throw new Error("No deleted objects streamed")}var A=this;for(var y=0;y<B.deleted.length;y++){var C=B.deleted[y];var z=A.getNode({id:C});if(!z){continue}A.publish({event:"onBeginDelete",data:{pathToReparent:z}});var x=z.getRootReferences();A._model.removeNode({id:C});A.publish({event:"onEndDelete",data:{pathToReparent:z,rootNodes:x}})}},reparent:function(y){if(!j.is(y,"object")){throw new Error("No parameter defined")}if(!j.is(y.deleted,"array")){throw new Error("No deleted objects streamed")}if(!j.is(y.modified,"array")){throw new Error("No modified objects streamed")}if(!j.is(y.created,"array")){throw new Error("No created objects streamed")}var x=this;var z=b.getPromises().slice();b.createPromise(function(B,A){d.all(z).then(function(C){z=null;var G=x.getNode({id:y.deleted[0]});var H=x.getNode({id:y.modified[0]});var D=y.created[0];if(G&&H&&D){var J=G.path.clone();x.publish({event:"onBeginReparent",data:{pathToReparent:G.path}});var F=parseInt(k.getSetting("webapi_timeout"));var I=k.getWebAPI_Options("navigate3D");var E={root_physicalid:n.getNodeID(H),expand_iter:"1",select_bo:I.select_bo,select_rel:I.select_rel,compute_select_bo:x.getDefaultStreamToLoad()==="thumbnail"?I.computeCGRsNThumbnails:I.computeCGRs,intent:"explore_3D",authored:x._isAuthored(),boundingbox:x._withBoundingBoxes(),debug:k.getSetting("enopad_webapis_debug")};if(k.getSetting("enopad3dviewer_lightNodeModel")===true){E.nbchildren=true}x._startAsync();l.setText(m.queryRunning);s.navigate({enopad_webapis:k.getSetting("enopad_webapis"),data:E,timeout:F,expand3DType:"expand3D",onComplete:function(N){var L;try{L=j.is(N,"string")?JSON.parse(N):N}catch(M){x._stopAsync();B();x.publish({event:"onReparentFailure",data:{message:m.cannotParseQueryResult}});return}l.setText(m.parsingResponse);if(L.results.length===0){x._stopAsync();x.publish({event:"onReparentFailure",data:{message:m.cannotLoadSuchObject}})}else{var K=x._model.reparentNode({json:L,oldInstance:G,newParent:H,createdInstID:D});x._stopAsync();B();x.publish({event:"onEndReparent",data:{path:K.path,createdNode:K,modifiedNode:H,rootNodes:H.getRootReferences()}})}},onFailure:function(M,K,L){x._stopAsync();B();x.publish({event:"onReparentFailure",data:{message:a.generic_service_failure}})},onTimeout:function(M,K,L){x._stopAsync();B();x.publish({event:"onReparentFailure",data:{message:m.timeout}})}})}})},"reparent")},insertExisting:function(y){if(!j.is(y,"object")){throw new Error("No parameter defined")}if(!j.is(y.inserted,"array")){throw new Error("No inserted objects streamed")}if(!j.is(y.modified,"array")){throw new Error("No modified objects streamed")}if(!j.is(y.created,"array")){throw new Error("No created objects streamed")}var x=this;var A=y.inserted[0];var z=b.getPromises().slice();b.createPromise(function(C,B){d.all(z).then(function(M){z=null;if(!j.is(y.inserted[0],"array")){console.log("No inserted paths streamed");y.inserted=[y.inserted];A=y.modified}var K=y.inserted[0][y.inserted[0].length-1];var I=x.getNode({id:K});var N=x.getNode({id:y.modified[0]});if(!N){throw new Error("Object to modify not found")}var J=y.created[0];if(I){var D=parseInt(k.getSetting("webapi_timeout"));var E=k.getWebAPI_Options("navigate3D");var H={root_path_physicalid:[A],expand_iter:"-1",select_bo:E.select_bo,select_rel:E.select_rel,compute_select_bo:x.getDefaultStreamToLoad()==="thumbnail"?E.computeCGRsNThumbnails:E.computeCGRs,intent:"explore_3D",authored:x._isAuthored(),boundingbox:x._withBoundingBoxes(),debug:k.getSetting("enopad_webapis_debug")};if(k.getSetting("enopad3dviewer_lightNodeModel")===true){H.nbchildren=true}x._startAsync();l.setText(m.queryRunning);s.navigate({enopad_webapis:k.getSetting("enopad_webapis"),data:H,expand3DType:"expand3D",timeout:D,onComplete:function(R){var P;try{P=j.is(R,"string")?JSON.parse(R):R}catch(Q){x._stopAsync();C();x.publish({event:"onInsertExistingFailure",data:{message:m.cannotParseQueryResult}});return}l.setText(m.parsingResponse);if(P.results.length===0){x._stopAsync();C();x.publish({event:"onInsertExistingFailure",data:{message:m.cannotLoadSuchObject}})}else{l.setText(m.inserting);var O=x._model.insertExistingNode({json:P,toInsert:I,parent:N,createdInstID:J});x._stopAsync();C();x.publish({event:"onInsertExisting",data:{insertedNode:I,modifiedNode:N,createdNode:O,rootNodes:N.getRootReferences()}})}},onFailure:function(Q,O,P){x._stopAsync();C();x.publish({event:"onInsertExistingFailure",data:{message:a.generic_service_failure}})},onTimeout:function(Q,O,P){x._stopAsync();C();x.publish({event:"onInsertExistingFailure",data:{message:m.timeout}})}})}else{var L=y.modified[0];var G=y.inserted[0][y.inserted[0].length-1];var F=y.created[0];x._loadingQueue.push({cancelable:false,id:L,path:A,expand_iter:"-1",resolve:C,onComplete:function(R){var Q=x.getNode({id:L});var P=x.getNode({id:G});var O=x.getNode({id:F});if(Q&&P){x.publish({event:"onInsertExisting",data:{insertedNode:P,modifiedNode:Q,createdNode:O,rootNodes:Q.getRootReferences()}})}if(C){C()}},onFailure:function(){x.publish({event:"onInsertExistingFailure",data:{message:a.generic_service_failure}});if(C){C()}},onTimeout:function(){x.publish({event:"onInsertExistingFailure",data:{message:m.timeout}});if(C){C()}},onProgress:function(O){x.publish({event:"onProgress",data:{progress:Math.floor((O.nbCGRLoaded/O.nbCGRToLoad)*100),message:m.displaying3D+": "+O.nbCGRLoaded+" of "+O.nbCGRToLoad+" "+m.parts,reframe:false}})}});x._processLoadingQueue()}})},"insertExisting")},_replaceInstances:function(A){var z=this;A.dispatch=A.dispatch!==undefined?A.dispatch:true;var x=z.getPromises();var B=x.slice();var y=d.deferred();d.all(B).then(function(C){B.splice(0,B.length);z.publish({event:"onBeginReplaceInstance"});var D=[];for(var F=0;F<A.data.length;F++){var G={id:String(A.data[F].oldId)},H={id:String(A.data[F].newId)};var E=z._model.updateNode(G,H);if(E){D.push(E)}}if(A.dispatch){z._commandProxy.padRefresh({transactions:[{replaceInstances:{couples:A.data}}]})}z.publish({event:"onEndReplaceInstance",data:{nodes:D}});y.resolve(D);z=null});y.name="UpdateNode";x.push(y);return y.promise},replaceInstances:function(B,x){if(!j.is(B,"object")){throw new Error("replaceInstances: There is no parameter defined.")}if((B.data===undefined)||(B.data.length===0)){console.error("replaceInstances: Id pairs array is not defined.");return}else{var A=null,z=null,C=false;for(var y=0;y<B.data.length;y++){z=this.getNode({id:String(B.data[y].oldId)});if(z){C=z.isPLMInstance();if(!C){A="replaceInstances: One or several nodes are not instances."}}else{A="replaceInstances: One or several Ids are invalid."}if(A){if(x&&x.onFailure){x.onFailure.call(null,A);return}else{throw new Error(A)}}}}this._replaceInstances(B).then(function D(){if(x&&x.onComplete){x.onComplete.apply(null,arguments)}})},buildPathFromArray:function(B,C){var z=this.getRootBagPath();var x=this.getRoots();var y=false;for(var A=0;A<x.length;++A){if(n.getNodeID(x[A])===B[0]){y=true}}if(y===false){return null}for(var A=0;A<B.length;A++){var D=this.getNode({id:B[A]});if(D){z.addElement(D)}else{if(!C){console.warn(B[A]+" does not exist");return null}}}return z},buildArrayFromPath:function(z){var A=[];if(z.externalPath&&z.externalPath.length){for(var y=0;y<z.externalPath.length;y++){var x=z.externalPath[y];if(n.isPLMNode(x)){A.push(n.getNodeID(x))}}}return A},buildArrayFromPathWithType:function(B,C,x){var A=[];if(B.externalPath&&B.externalPath.length){for(var z=0;z<B.externalPath.length;z++){var y=B.externalPath[z];if(n.isPLMNode(y)){A.push(n.getNodeID(y));if(n.getNodeType(y)){x[n.getNodeID(y)]={type:n.getNodeType(y)}}}}C.push(A)}},flushModel:function(y,x){this.removeRoots({pids:this._rootIds.slice(0),removeDetached:true},false,x);if(y&&this._commandProxy){this._commandProxy.cleanAll()}},search:function(C){var x=this.getRoots();var B=this;var D=b.getPromises().slice();var y=[];if(x.length>0){var A=[];for(var z=0;z<x.length;z++){b.createPromise(function(G,F){var E={cancelable:false,forceIndex:true,findInCtx:C.searchQuery,path:[n.getNodeID(x[z])],parent:B._model.getRootBag(),sequence_filter:B._model.getRoot({id:n.getNodeID(x[z])}).getSequenceFilter(),configBin:B._model.getRoot({id:n.getNodeID(x[z])}).getConfigFilter(),CVQuery3D:B._model.getRoot({id:n.getNodeID(x[z])}).getCVFilterQuery(),resolve:G,intent:"searchInDsBoard",progressiveExpand:false,expand_iter:"-1",forceLoad:true,max_count_path:k.getSetting("enopad3dviewer_max_count_in_search"),onComplete:function(J){if(J&&J.selectedPaths&&J.selectedPaths.length){var L=[];var I=[];for(var H=0;H<J.selectedPaths.length;H++){A.push(J.selectedPaths[H]);var K=B.buildPathFromArray(J.selectedPaths[H]);if(K){if(!n.is3DLeaf(K.externalPath[K.externalPath.length-1])){if(J.selectedPaths[H].length===1){I.push(J.selectedPaths[H])}else{L.push(J.selectedPaths[H])}}}else{if(J.selectedPaths[H].length===1){I.push(J.selectedPaths[H])}else{L.push(J.selectedPaths[H])}}}if((L.length||I.length)&&!k.getSetting("enopad3dviewer_lightNodeModel")){B.expand({paths:I.length?I:L,expand_iter:"-1",onComplete:function(){var M={selectedPaths:A};B.publish({event:"onSearchCompleted",data:M})},onFailure:function(){B.publish({event:"onSearchFailure",data:J})},},false,false)}else{B.publish({event:"onSearchCompleted",data:J})}}else{B.publish({event:"onSearchCompleted",data:J})}if(G){G()}if(B._loadingQueue.length){B._processLoadingQueue()}else{B.publish({event:"onComplete",data:{reframe:false}})}},onFailure:function(H){B.publish({event:"onSearchFailure",data:H});if(G){G()}if(B._loadingQueue.length){B._processLoadingQueue()}else{B.publish({event:"onComplete",data:{reframe:false}})}},onTimeout:function(H){B.publish({event:"onSearchFailure",data:H});if(G){G()}if(B._loadingQueue.length){B._processLoadingQueue()}else{B.publish({event:"onComplete",data:{reframe:false}})}},};y.push(E)},"search")}}else{B.publish({event:"onSearchCompleted"})}d.all(D).then(function(E){D=null;for(var F=0;F<y.length;F++){var G=y[F];B._loadingQueue.push(G)}B._processLoadingQueue()})},refresh:function(H){var x=this._rootIds.slice();var C=this._model.getRootLog();var I=this.getHiddenRootIds().slice();var A=[];var z=x.concat(I);for(var D=0;D<z.length;D++){var E={filter:{}};var J=this.getNode({id:z[D]});if(J.getConfigFilter){E.filter.config_filter=J.getConfigFilter()}if(J.getSequenceFilter){E.filter.sequence_filter=J.getSequenceFilter()}if(J.getCVFilterQuery){E.filter.CVQuery3D=J.getCVFilterQuery()}if(E.filter.config_filter||E.filter.sequence_filter||E.filter.CVQuery3D){E.rootId=z[D];A.push(E);for(var B=C.length-1;B>=0;B--){if(j.is(C[B],"array")){if(C[B][0]===z[D]){C.splice(B,1)}}}}}if(x.length){this.publish({event:"onRefreshBegin"});this.flushModel(false,false);var F=this;var G=0;var y=this.subscribe({event:"onRootRemoved"},function(){G++;if(G===x.length){F.unsubscribe(y);var K=F.subscribe({event:"onComplete"},function(){F.unsubscribe(K);F.publish({event:"onRefreshCompleted"})});F.addRoots({paths:C.length>0?C:undefined,rootsWithFilters:A.length>0?A:undefined,pids_hidden:I},false,false,false)}});if(H&&this._commandProxy){this._commandProxy.refreshModel()}}},refreshGeometry:function(B){var z=this;var y={},A=[];z._startAsync();for(var x=0;x<B.ids.length;x++){y[B.ids[x]]=z.getNode({id:B.ids[x]}).getLoadedStream()==="thumbnail"?"thumbnail_3d":z.getNode({id:B.ids[x]}).getLoadedStream()}this.getAttributes({ids:B.ids,attributes:["cgr","thumbnail_3d"],callbacks:{onComplete:function(C){for(var D=0;D<B.ids.length;D++){A[D]={node:z.getNode({id:B.ids[D]}),stream:z.getNode({id:B.ids[D]}).getLoadedStream(),url:C[B.ids[D]][y[B.ids[D]]]}}z._model.refreshStream({data:A,applicativeContainers:B.applicativeContainers,noMeshInRAM:undefined===B.noMeshInRAM?true:B.noMeshInRAM,callbacks:{onURLLoad:function(E){z.publish({event:"onProgress",data:{progress:Math.floor((E.nbURLLoaded/E.nbURLToLoad)*100),message:m.displaying3D+": "+E.nbURLLoaded+" of "+E.nbURLToLoad+" "+m.parts,reframe:false}})},onComplete:function(E){z._stopAsync();z.publish({event:"onGeometryRefreshed"});B.onComplete(E)}}})},onFailure:function(C){z._stopAsync();z.publish({event:"onRefreshGeometryFailure"});B.onFailure(C)},onTimeout:function(){z._stopAsync();z.publish({event:"onRefreshGeometryFailure"});B.onTimeout()}}})},lockNodes:function(x){if(!j.is(x.ids,"array")){console.error("Controller lockNodes(): Given array is not an array of IDs.");return}this._model.lockNodes(x)},unlockNodes:function(x){if(!j.is(x.ids,"array")){console.error("Controller unlockNodes(): Given array is not an array of IDs.");return}this._model.unlockNodes(x)},isRunning:function(){return this._operationInProgress},publish:function(x){this.getModelEvents().publish(x)},subscribe:function(x,y){return this.getModelEvents().subscribe(x,y)},unsubscribe:function(x){this.getModelEvents().unsubscribe(x)},getModelEvents:function(){return this._modelEvents},getNbRoots:function(){return this.getRoots().length},getRoots:function(){return this.getRootBag().children},getRootBagPath:function(){return this.getRootBag().path.clone()},getRootBag:function(){return this._model.getRootBag()},_setDefaultStreamToLoad:function(x){if(typeof x==="boolean"){x=x?"cgr":"thumbnail"}if(x){this._defaultStreamToLoad=x;this.publish({event:"onDefaultStreamChanged",data:{newStream:x}})}},getDefaultStreamToLoad:function(){return this._defaultStreamToLoad},getPromises:function(){return b.getPromises()},setWrapUsage:function(x){this._useWrap=x},getDecorationBag:function(){return this._model.getDecorationBag()},getLoadingBoxesBag:function(){return this._model.getLoadingBoxesBag()},getNode:function(y){if(!y.id){new Error("No id defined")}var x=null;if(this._model){x=this._model.getNode(y)}return x},getRoot:function(y){if(!y.id){new Error("No id defined")}var x=null;if(this._model){x=this._model.getRoot(y)}return x},abortLoading:function(){if(this._abortLoading){this._abortLoading();this._abortLoading=null}},_interruptLoading:function(x){if(this._runningQuery){this._runningQuery.cancel()}this._model.abort(x)},pauseLoading:function(){if(this._pauseLoading){this._pauseLoading();this._pauseLoading=null}},_pauseQuery:function(x){if(this._runningQuery){this._runningQuery.cancel()}},getReferenceBoundingSphere:function(x){return this._model.getReferenceBoundingSphere(x)},pauseProgressiveLoading:function(){--this._engineState;if(this._engineState===0){this._model.pause();this.pauseLoading()}},resumeProgressiveLoading:function(){++this._engineState;if(this._engineState>0){this._model.resume()}},unlockChildrenFromProgressiveExpand:function(D){var C=this,A=C._model.getRootLog(),B=null;for(var z=0;z<D.paths.length;z++){B=D.paths[z][D.paths[z].length-1];for(var y=0;y<A.length;y++){if(D.expand_level!==-1){for(var x=0;x<A[y].length-1;x+=2){if(A[y][x]===B){for(var E=x;E-x<=2*D.expand_level&&E<A[y].length-1;E+=2){C._model.unlockChildren({id:A[y][E]})}break}}}else{for(var x=0;x<A[y].length-1;x+=2){if(A[y][x]===B){for(var E=x;E<A[y].length-1;E+=2){C._model.unlockChildren({id:A[y][E]})}break}}}}}},getFcsUrls:function(A){if(!j.is(A.urls,"array")){throw new Error("No urls defined")}if(!j.is(A.callbacks.onComplete,"function")){throw new Error("No onComplete callback defined")}if(!j.is(A.callbacks.onFailure,"function")){throw new Error("No onFailure callback defined")}var z=0;function C(D){return decodeURIComponent((D+"").replace(/\+/g,"%20"))}var B=function(D){var I={};var J=document.createElement("a");J.href=D;var F=J.search.substring(1);var G=F.split("&");for(var E=0;E<G.length;E++){var H=G[E].split("=");I[H[0]]=C(H[1])}return I};var x={data:{boproxies:[]},onComplete:function(E){try{var D=!j.is(E,"object")?JSON.parse(E):E;A.callbacks.onComplete(D)}catch(F){console.warn("Error while parsing results")}},onFailure:function(D){A.callbacks.onFailure(D)}};for(z=0;z<A.urls.length;z++){var y=B(A.urls[z]);if(y.boid&&y.format&&y.filename){x.data.boproxies.push(y)}}if(x.data.boproxies.length){s.getFcsUrls(x)}},registerOverrideSet:function(x){if(k.getSetting("enopad3dviewer_lightNodeModel")===true){this._model.registerOverrideSet(x)}},setOverrideCB:function(y,z,x){if(k.getSetting("enopad3dviewer_lightNodeModel")===true){this._model.setOverrideCB(y,z,x)}},hasOverrideCB:function(y,x){var z=false;if(k.getSetting("enopad3dviewer_lightNodeModel")===true){z=this._model.hasOverrideCB(y,x)}return z},removeOverrideSet:function(x){if(k.getSetting("enopad3dviewer_lightNodeModel")===true){this._model.removeOverrideSet(x)}},createReferenceIterator:function(x){if(k.getSetting("enopad3dviewer_lightNodeModel")===true){return this._model._OOCManager.createReferenceIterator(x)}},getOOCSelectedReferenceID:function(){return this._model.getOOCSelectedReferenceID()},_withBoundingBoxes:function(){return this._context.isSelectiveLoadingActivated()},_disableFilterWaiting:function(B){var A=this;if(this._wait4Filter===true){delete this._wait4Filter;this.publish({event:"onEnableUX"});var y={paths:[],intent:"addRoot"};if(j.is(B.rootIds,"array")){for(var x=0;x<B.rootIds.length;x++){y.paths.push([B.rootIds[x]])}var z=k.getSetting("enopad3dviewer_dynamicRepLoading")?false:true;this.expand(y,false,false,z)}else{w.displayNotification({msg:a.noRoot2Expand,eventID:"error"})}this._context._filterDrop=false}this._context.publish({event:"onVolumeOpen",data:{closePanel:true}})}});return j.namespace("DS/ENOPAD3DViewer/controller/PAD3DViewerController",t)});define("DS/ENOPAD3DViewer/PAD3DViewer",["css!DS/ENOPAD3DViewer/ENOPAD3DViewer","UWA/Core","UWA/Controls/Abstract","DS/ENOPAD3DViewer/controller/PAD3DViewerController","DS/ENOPAD3DViewer/mixins/PAD3DViewerLoadingBoxesEngine","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADProgressBar","DS/PADUtils/PADContext","DS/ApplicationFrame/CommandsManager","DS/ApplicationFrame/FrameWindow3D","DS/Visualization/PathElement","DS/Visualization/SceneGraphUtils","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/i3DXCompassServices/i3DXCompassPubSub","DS/Core/ModelEvents","DS/Utilities/Utils","DS/PADUtils/PADProbes","DS/PADUtils/PADPromise","DS/PADUtils/PADTypesMgt","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADWSAccess","DS/PADUtils/PADWebInWinServices","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENOPAD3DViewer/utils/PAD3DViewerChangeAction","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices","UWA/Utils/InterCom","UWA/Promise","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/ENOXTriptych/js/ENOXTriptych","DS/ENOPAD3DViewer/commands/PAD3DViewerDebugVisuCmd","DS/PADUtils/PADSession","DS/ENOPAD3DViewer/views/PAD3DRootListMgt","DS/Visualization/Viewpoint"],function(Q,e,P,s,f,B,h,y,I,t,J,H,a,o,q,x,v,G,w,k,L,p,d,O,u,c,r,K,D,N,A,F,l,g,C,i){var n=null;var M="2.0";var z=1;var b={version:M,results:[],structures:[],viewpoint:[]};var j={authorizedRootTypes:null};var E=false;var m=P.extend(f,C,{name:"ENOPAD3DViewer",init:function(S){var T=this;this._frmWindow=null;this._viewer=null;this._layout=null;this._UILoader=null;this._lockCSONotification=false;this._lockCSONotificationEmpty=false;this._modelEvents=null;this._controller=null;this._controllerTokens=[];this._csoTokens=[];this._psoTokens=[];this._hsoTokens=[];this._filteredIdToReload=[];this._hideShowController=null;this._authorizeSet3DStructure=false;this._isVolumeFilter=false;this._isFilterOpen=false;this._volumePanel=0;this._physicalId=[];this._hideShowControllerTokens=[];this._dndCB=[];this._defaultProgressBarVisibility=null;this._automaticReframePolicy=null;this._mouse={x:0,y:0};this._readyCheckPromises=[];this._platformServicesInitPromise=null;this._actionBarTokens=[];this._robotVisibility=true;this._defaultContextualBarVisibility=true;this._defaultContextualMenuVisibility=true;this._propertiesCommandAvailability=true;this._BIController=null;this._firstInit=true;this._interwidgetComAvailability=true;this._loadingDelegations=null;this._dropZoneContainer=null;this._actionBarCloseEvt=-1;this._actionBarOpenEvt=-1;var R=S.widget;if(R){this._lang=R.lang}else{this._lang=S.windowOptions?S.windowOptions.language:"en"}this.getWidget=function(){return R};window.nearFarBigScale=true;O.initialize(S);this.setAutomaticReframePolicy(S.windowOptions.automaticReframePolicy===undefined?true:S.windowOptions.automaticReframePolicy);this.setDefaultProgressBarVisibility(S.windowOptions.defaultProgressBarVisibility===undefined?true:S.windowOptions.defaultProgressBarVisibility);B.setSetting("enopad3DViewer_enableStatusInfo",S.windowOptions.enableStatusInfo!==undefined?S.windowOptions.enableStatusInfo:true);if(B.app_context===null){B.set_app_context("enopad3dviewer",true);B.setSetting("lang",this._lang)}if(S.authorizedRootTypes!==null&&e.is(S.authorizedRootTypes,"array")){this.setAuthorizedRootTypes(S.authorizedRootTypes)}B.setSetting("enopad3dviewer_roles",[]);if(S.enableFiltering===true){B.setSetting("enopad3dviewer_FilterAvailable",true)}if(S.activateProbes===false){B.setSetting("probes_activated",false)}if(S.debugVisuCommand===true){B.setSetting("enopad3dviewer_debugvisucommand",true)}if(S.visuProgressiveTileModel!==undefined){B.setSetting("enopad3dviewer_lightNodeModel",S.visuProgressiveTileModel)}this._authorizeSet3DStructure=S.authorizeSet3DStructure===undefined?true:S.authorizeSet3DStructure;this._isVolumeFilter=S.isVolumeFilter===undefined?false:S.isVolumeFilter;this._propertiesCommandAvailability=undefined!==S.propertiesCommandAvailability?S.propertiesCommandAvailability:this._propertiesCommandAvailability;this.initProbe=w.createProbe("PAD3DViewer_init");this._parent(S);if(undefined!==S.interwidgetComAvailability){this._interwidgetComAvailability=S.interwidgetComAvailability}if(undefined!==S.loadingDelegations){this.setLoadingDelegations(S.loadingDelegations)}if(undefined!==S.loadCGRAsDefaultStream){B.setSetting("enopad3dviewer_CGRorTHB",S.loadCGRAsDefaultStream)}if(undefined!==S.dynamicRepLoading){B.setSetting("enopad3dviewer_dynamicRepLoading",S.dynamicRepLoading);B.setSetting("enopad3dviewer_useStaticURL",true)}if(undefined!==S.supportPgpBasedOnDescription){B.setSetting("supportPgpBasedOnDescription",S.supportPgpBasedOnDescription)}if(undefined!==S.selectionFilter){B.setSetting("enopad3dviewer_selectionFilter",S.selectionFilter)}this._modelEvents=new v();if(S.widget){if(S.widget.lang){B.setSetting("lang",S.widget.lang)}}this._changeAction=new c();if(!S.offline){this.connectToPlatform(S)}else{this._platformServicesInitPromise=new D(function(U){U()})}if(!S.getPlatformServicesInBackground&&!S.offline){this._readyCheckPromises.push(this._platformServicesInitPromise)}this._buildSkeleton(S);this._buildComponent(S);this.setupLoadingBoxesEngine();D.all(this._readyCheckPromises).then(function(){delete T._readyCheckPromises;if(B.getSetting("enopad3dviewer_rotateFocusMode")){T.getViewpoint()._setFocusMode(i._FOCUS_MODE.ROTATION)}var U=window.getComputedStyle(T.elements.container);if(T.getStatusBar()&&U&&Number(U.width.slice(0,-2))<900){T.getFrameWindow().getActionBar().elements.container.setStyle("bottom","0");T.getFrameWindow().getActionBar().close();T.getStatusBar().close()}T.publish({event:"onReady",data:T});if(T.isSelectiveLoadingActivated()){var V=p.isTouchDevice()?" touch-mode":"";var U={bottom:"0"};if(T._frmWindow.getActionBar().elements.container.getAttribute("data-open")==="true"){if(p.isTouchDevice()){U={bottom:"38px"}}else{U={bottom:"24px"}}}if(T.getOption("enableSidePanel")===true){T._frmWindow.getActionBar().inject(T.elements.main);T._frmWindow.getActionBar().elements.container.setStyles(U)}if(T._actionBarCloseEvt===-1){T._actionBarCloseEvt=T._frmWindow.getActionBar().onActionBarClose(function(){if(T.getStatusBar()){T.getStatusBar().close()}T.elements.container.firstChild.className="enopad3Dviewer_3dcontainer"+V;T._frmWindow.getActionBar().elements.container.setStyle("bottom","0")})}if(T._actionBarOpenEvt===-1){T._actionBarOpenEvt=T._frmWindow.getActionBar().onActionBarOpen(function(){var W=p.isTouchDevice()?{bottom:"38px"}:{bottom:"24px"};T.getStatusBar().open();T.elements.container.firstChild.className="enopad3Dviewer_3dcontainer"+V;T._frmWindow.getActionBar().elements.container.setStyles(W)})}}if(S.objects2Load){T.openStoredObjects(S.objects2Load)}})},isSelectiveLoadingActivated:function(){return B.getSetting("enopad3dviewer_dynamicRepLoading")||B.getSetting("enopad3dviewer_lightNodeModel")},connectToPlatform:function(R){var S=this;this._platformServicesInitPromise=new D(function(T){p.app_initialization(function(){p.getGrantedRoles(function(U){B.setSetting("enopad3dviewer_roles",U)});S.publish({event:"grantedRoleRetrieved",data:B.getSetting("enopad3dviewer_roles")});if(R.allowAuthoring===false){B.setSetting("enopad_webapis",false)}else{B.setSetting("enopad_webapis",true)}if(R&&R.securityContext&&R.securityContextList){B.setSetting("pad_security_ctx",R.securityContext);B.setSetting("pad_security_ctx_list",R.securityContextList);T()}else{p.getSecurityContext(function(U){if(U&&U.securityContext&&U.securityContextList){B.setSetting("pad_security_ctx",U.securityContext);B.setSetting("pad_security_ctx_list",U.securityContextList)}T();if(!R.readyCB){R.readyCB=function(){}}R.readyCB()})}},R.plateformServices)})},render:function(){if(this.getOption("enableSidePanel")===true){return this.elements.triptych}else{return this}},getPropertiesFacet:function(){var R=this.getOption("propertiesFacet")?this.getOption("propertiesFacet"):[];return R},destroy:function(){var R=this;if(this._frmWindow){this._actionBarTokens.forEach(function(S){if(R._frmWindow.removeActionBarCallback){R._frmWindow.removeActionBarCallback(S)}});if(this._frmWindow.getActionBar()){if(this._actionBarCloseEvt!==-1){this._frmWindow.getActionBar().removeCallback(this._actionBarCloseEvt)}if(this._actionBarOpenEvt!==-1){this._frmWindow.getActionBar().removeCallback(this._actionBarOpenEvt)}}this._frmWindow.dispose();delete this._frmWindow}if(this._viewer){delete this._viewer}if(this._commandProxy){this._commandProxy.padDestroy();this._commandProxy.destroy();delete this._commandProxy}if(this._controller){this._controllerTokens.forEach(function(S){R._controller.unsubscribe(S)});this._controller.destroy();delete this._controller;delete this._controllerTokens}if(o){this._csoTokens.forEach(function(S){o.unsubscribe(S)});delete this._csoTokens}if(a){this._psoTokens.forEach(function(S){a.unsubscribe(S)});delete this._psoTokens}if(q){this._hsoTokens.forEach(function(S){q.unsubscribe(S)});delete this._hsoTokens}if(this._hideShowController){this._hideShowControllerTokens.forEach(function(S){R._hideShowController.unsubscribe(S)});this._hideShowController.destroy();delete this._hideShowController;delete this._hideShowControllerTokens}if(this._BIController){this._BIController.destroy();delete this._BIController}if(this._layout){if(this._layoutActivatedTokenBegin){this._layout.unsubscribe(this._layoutActivatedTokenBegin);delete this._layoutActivatedTokenBegin}if(this._layoutActivatedTokenEnd){this._layout.unsubscribe(this._layoutActivatedTokenEnd);delete this._layoutActivatedTokenEnd}this._layout.destroy();delete this._layout}if(this._dndCB&&this._dndCB.length){this.elements.container.removeEventListener("dragenter",this._dndCB[0]);this.elements.container.removeEventListener("dragover",this._dndCB[1]);this.elements.container.removeEventListener("dragleave",this._dndCB[2]);this.elements.container.removeEventListener("dragend",this._dndCB[3]);this.elements.container.removeEventListener("drop",this._dndCB[4]);delete this._dndCB}this.disposeLoadingBoxesEngine();R=null;y.reset();B.destroy();this._parent()},_buildSkeleton:function(U){var X=this;if(!e.is(this.elements.container)){this.elements.container=e.createElement("div",{"class":"enopad3Dviewer_container"});if(this.getOption("css_view_class")){this.elements.container.addClassName(this.getOption("css_view_class"))}var T="enopad3Dviewer_3dcontainer";var W=p.isTouchDevice()?" touch-mode":"";T+=W;this.elements.view_container=e.createElement("div",{"class":T}).inject(this.elements.container);var S=function(){if(B.getSetting("enopad3dviewer_debugvisucommand")===true){var Y=e.createElement("span",{"class":"fonticon fonticon-chart-gauge-angular enopad3dviewer_3dcontainer_debugvisuicon",id:"pad3dviewer_debugVisuCommandID"}).inject(X.elements.container);Y.addEventListener("click",function(){var Z=new l();Z.execute()})}};if(B.getSetting("enopad3DViewer_enableStatusInfo")){var R=new D(function(Y){X._platformServicesInitPromise.then(function(){if(!X.isSelectiveLoadingActivated()){require(["DS/PADUtils/views/PADStatusInfos"],function(Z){X.elements.padstatus=new Z({renderTo:X.elements.container,events:{onShow:function(){var aa=o.get();X.elements.padstatus.setStatus(Z.buildStatus({Tenant:p.getPlatformId(),tree_content:{nbObjectsSelected:aa.length}}))}},withProgress:B.getSetting("enopad3DViewer_lightLoaderForBackgroundLoad"),attention:N.progressiveExpandFullMemory});S();Y()})}else{require(["DS/PADUtils/views/PADStatusBar","DS/PADUtils/PADSession"],function(aa,Z){X.elements.padstatusbar=new aa({renderTo:X.getOption("enableSidePanel")===true?X.elements.main:X.elements.container,withLoader:true,perfoDebug:(B.getSetting("enopad3dviewer_debugvisucommand")===true),onPlay:function(){X.getController().resumeProgressiveLoading();X.getStatusBar().restorePreviousLabel()},onPause:function(){X.getController().pauseProgressiveLoading();if((X.getController().getRoots().length>0||X._checkHiddenRoots())&&X.getStatusBar()){X.getStatusBar().pauseProgresslabel()}},onPerfoClicked:function(){var ab=new l();ab.execute()},onDragEvent:function(ab){var ac=this.set3DDragDropData(o.get());ab.dataTransfer.effectAllowed="move";ab.dataTransfer.setData("text",JSON.stringify(ac))}.bind(X)});Y()})}})});if(!U.getPlatformServicesInBackground){this._readyCheckPromises.push(R)}}else{S()}h.render({renderTo:this.elements.view_container})}if(this.getOption("enableSidePanel")===true){this.elements.main=e.createElement("div",{"class":"enopad3Dviewer_mainTriptych"});this.elements.borderedLayout=e.createElement("div",{"class":"enopad3Dviewer_borderedLayout"}).inject(document.body);this.elements.right=e.createElement("div",{"class":"enopad3Dviewer_rightTriptych rightSidePanel"});var V={left:{resizable:true,originalState:"close",overMobile:true,minWidth:300,withClose:true},container:this.elements.main,withtransition:true,withoverflowhidden:true,right:{resizable:true,originalState:"close",overMobile:true,minWidth:250,withClose:false}};this.elements.triptych=new F();this.elements.triptych.init(V,X.createRootListSlidder(),this.elements.container,this.elements.right);X.elements.triptych.togglePanel=function(Y){if(Y==="left"){X.elements.triptych._modelEvents.publish({event:"triptych-toggle-panel",data:"left"})}else{X.elements.triptych._modelEvents.publish({event:"triptych-toggle-panel",data:"right"})}};require(["DS/ApplicationFrame/CommandsManager"],function(Y){var Z=Y.getCommand("RootPanel");if(Z){RootPanel.addCallback()}});X.publish({event:"on3DTriptychReady"})}},_buildComponent:function(T){var U=T.windowOptions?T.windowOptions:{};U.actionbar_corrected=T.actionbar_corrected;if(this._lang){U.language=this._lang}var S=B.getLayout_options("frmWindow_opts");var R=e.extend(S,U,true);this.setDefaultContextualBarVisibility(R.defaultContextualBarVisibility);this.setDefaultContextualMenuVisibility(R.defaultContextualMenuVisibility);if(T.selectiveLoading!==undefined){B.setSetting("enopad3dviewer_selectiveLoading",T.selectiveLoading)}else{if(T.widget&&T.widget.getValue("enopad3dviewer_selectiveLoading")){B.setSetting("enopad3dviewer_selectiveLoading",T.widget.getValue("enopad3dviewer_selectiveLoading"))}}this._initFrameWindow(R)},_initModelController:function(R){var S=this;var T=new D(function(U){S._controller=new s({viewer:S._viewer,context:S,selectiveLoading:R.selectiveLoading,initializeWithWrap:B.getSetting("enopad3dviewer_initializeWithWrap")===true,readyCB:function(){S._controllerTokens.push(S._controller.subscribe({event:"onRootDetached"},function(W){S._viewer.render({updateInfinitePlane:true});S.reframe();S.publish({event:"onRootDetached",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onContentNameModified"},function(W){S.publish({event:"onContentNameModified",data:W.TitleInfo})}));S._controllerTokens.push(S._controller.subscribe({event:"onFilterApplied"},function(W){if(S.isSelectiveLoadingActivated()){S.getController().getAttributes({ids:W.filter.objects[0].path,attributes:["ds6w:label"],callbacks:{onComplete:function(X){S.getStatusBar().setFilter({id:W.filter.objects[0].path[0],message:X[W.filter.objects[0].path[0]]["ds6w:label"]})},onFailure:function(X){console.warn("Failed : "+X)}}})}}));S._controllerTokens.push(S._controller.subscribe({event:"onSearchCompleted"},function(Y){var W=[],X=false;if(Y&&Y.selectedPaths&&Y.selectedPaths.length){Y.selectedPaths.forEach(function(ac){var ab=S.unstreamPath(ac);if((S._hideShowController&&!S._hideShowController.isVisible(ab)&&S._viewer.getVisibleSpace()===1)||(S._hideShowController&&S._hideShowController.isVisible(ab)&&S._viewer.getVisibleSpace()===0)){X=true}W.push({pathElement:ab})})}if(W.length){S.lockSelectionBroadcast(true);o.empty();q.empty();var aa=Y.selectedPaths.length>1?N.multipleResultOfSearchInContext:N.singleResultOfSearchInContext;o.add(W);o.get().forEach(function(ab){q.add(ab)});S.displayNotification({eventID:"info",msg:Y.selectedPaths.length+aa});if(X){S.displayNotification({eventID:"info",msg:N.selectionInOtherSpace})}var Z=I.getCommand("PAD3DViewerNavigateOnSelectionHdr",S._context);if(Z){Z.execute(Y.selectedPaths).then(function(){S.publish({event:"onSearchCompleted",data:Y})});S.lockSelectionBroadcast(false)}}else{if(Y&&Y.tooManyPath){S.displayNotification({eventID:"info",msg:N.tooManyResultFound})}else{S.displayNotification({eventID:"info",msg:N.emptyResultOfSearchInContext})}S.publish({event:"onSearchCompleted",data:Y})}}));S._controllerTokens.push(S._controller.subscribe({event:"onSearchFailure"},function(W){S.displayNotification({eventID:"error",msg:N.searchInContextFailed});S.publish({event:"onSearchFailure",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onRootAttached"},function(W){if(S._dropZoneContainer){S._dropZoneContainer.hide()}S._viewer.render({updateInfinitePlane:true});S.reframe();S.publish({event:"onRootAttached",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onBeginRootRemoved"},function(W){if(W.dispatch===false){S.lockSelectionBroadcast(true)}}));S._controllerTokens.push(S._controller.subscribe({event:"onRootRemoved"},function(X){if(!S.getController().getNbRoots()&&(!S.getController().getHiddenRootIds().length)&&S._dropZoneContainer){S._dropZoneContainer.show("drop");if(S.getStatusBar()){S.getStatusBar().setIsPaused(false);S.getStatusBar().resetPreviousLabel();S.getStatusBar().setLoader({status:"off"})}}S._viewer.render({updateInfinitePlane:true});if(X.reframe){if(B.getSetting("enopad3dviewer_lightNodeModel")===true){if(S.getController()._model.getOOCManager().getReframeBoundingSphere){var W=S.getController()._model._OOCManager.getReframeBoundingSphere();if(W.radius!==0){S.reframe(W)}else{S.reframe()}}}else{S.reframe()}}S.publish({event:"onRootRemoved",data:X});if(X.dispatch===false){S.lockSelectionBroadcast(false)}}));S._controllerTokens.push(S._controller.subscribe({event:"onBeginReplaceInstance"},function(){S.publish({event:"onBeginReplaceInstance",})}));S._controllerTokens.push(S._controller.subscribe({event:"onEndReplaceInstance"},function(W){S.publish({event:"onEndReplaceInstance",data:W});S.publish({event:"onModelUpdated",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onEndMatriceUpdate"},function(W){S._viewer.render({updateInfinitePlane:true});S.publish({event:"onEndMatriceUpdate",data:W});S.publish({event:"onModelUpdated",data:{rootNodes:S.getRoots()}})}));S._controllerTokens.push(S._controller.subscribe({event:"onBeginRootLoading"},function(W){S._lastReframeRequiered=0;if(S._dropZoneContainer){S._dropZoneContainer.hide()}S.publish({event:"onBeginRootLoading"})}));S._controllerTokens.push(S._controller.subscribe({event:"onProgress"},function(W){if(S.getDefaultProgressBarVisibility()){h.setText(W.message);if(W.progress%20===0&&W.progress!==S._lastReframeRequiered){S._lastReframeRequiered=W.progress;if(W.reframe){S.reframe()}else{S._viewer.render({updateInfinitePlane:true})}}}else{S.publish({event:"onProgress",data:W})}}));S._controllerTokens.push(S._controller.subscribe({event:"onRootAdded"},function(W){S._viewer.render({updateInfinitePlane:true});if(W.reframe){S.reframe(W.BS)}if(W.displayNotif){if(W.hidden){S.displayNotification({eventID:"info",msg:N.addonDetachedRootSuccessNotif})}else{S.displayNotification({eventID:"success",msg:W.inContext?N.addRootInContextSuccessNotif:N.addRootSuccessNotif})}}S.publish({event:"onRootAdded",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onReframe"},function(W){if(!window.ENOPADNoReframe){if(W.BS){S.getViewpoint().reframe(undefined,0,W.BS)}if(!W.rootBS){setTimeout(function(){S.reframe()},3000)}}}));S._controllerTokens.push(S._controller.subscribe({event:"onRootAlreadyExisting"},function(W){S.displayNotification({eventID:"info",msg:N.rootAlreadyLoadedNotif});S.publish({event:"onRootAlreadyExisting",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onComplete"},function(W){if(!S.isSelectiveLoadingActivated()){S._viewer.render({updateInfinitePlane:true})}if(W.reframe){S.reframe(W.BS)}S.publish({event:"onLoadingComplete"})}));S._controllerTokens.push(S._controller.subscribe({event:"onLoadingFailure"},function(X){if(!S._controller.getNbRoots()&&!S._checkHiddenRoots()&&S._dropZoneContainer&&!S._controller.isRunning()){S._dropZoneContainer.show("drop")}if(X.displayNotif){var Y=N.addRootFailureNotif;var W="error";if(X&&X.message){Y=X.message}if(X&&X.eventID){W=X.eventID}S.displayNotification({eventID:W,msg:Y})}S.publish({event:"onLoadingFailure"})}));S._controllerTokens.push(S._controller.subscribe({event:"onLoadingCanceled"},function(W){if(!S._controller.getNbRoots()&&!S._checkHiddenRoots()&&S._dropZoneContainer){S._dropZoneContainer.show("drop")}var X=N.addRootFailureNotif;if(W&&W.message){X=W.message}S.displayNotification({eventID:"info",msg:X});S.publish({event:"onLoadingCanceled"})}));S._controllerTokens.push(S._controller.subscribe({event:"startAsync"},function(X){var W=X===undefined||X.userFeedback===undefined?true:X.userFeedback;if(W){S._frmWindow.getActionBar()._afr.elements.container.addClassName("enopad3Dviewer_actionbar_disabled");if(S.getDefaultProgressBarVisibility()){h.on(undefined,X.onCancel,A.PADProgressBar_cancelAll);if(S.isSelectiveLoadingActivated()){S.getStatusBar().setLoader({status:"hide"})}}else{S.publish({event:"onStartAsync"})}}else{S.publish({event:"onStartAsync"})}}));S._controllerTokens.push(S._controller.subscribe({event:"stopAsync"},function(X){var W=X===undefined||X.userFeedback===undefined?true:X.userFeedback;if(W){S._frmWindow.getActionBar()._afr.elements.container.removeClassName("enopad3Dviewer_actionbar_disabled");if(S.getDefaultProgressBarVisibility()){h.off();if(S.isSelectiveLoadingActivated()){S.getStatusBar().setLoader({status:"show"})}}else{S.publish({event:"onStopAsync"})}}else{S.publish({event:"onStopAsync"})}}));S._controllerTokens.push(S._controller.subscribe({event:"onMove"},function(W){S.publish({event:"onMove",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onEndReparent"},function(Z){if(Z.createdNode){var Y=S.getController().getRootBag();var aa=H.buildPathesLeadingToNode(Z.createdNode,Y);var W=[];for(var X=0;X<aa.length;X++){W.push({pathElement:aa[X]})}S.lockSelectionBroadcast(true);o.add(W);q.add(W);S.lockSelectionBroadcast(false)}S._viewer.render({updateInfinitePlane:true});S.reframe();S.displayNotification({eventID:"success",msg:N.reparentSuccessful});S.publish({event:"onEndReparent",data:Z});S.publish({event:"onModelUpdated",data:Z})}));S._controllerTokens.push(S._controller.subscribe({event:"onBeginReparent"},function(W){S.publish({event:"onBeginReparent",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onReparentFailure"},function(W){var X=N.reparentFailure;if(W&&W.message){X=W.message}S.displayNotification({eventID:"error",msg:X});S.publish({event:"onReparentFailure"})}));S._controllerTokens.push(S._controller.subscribe({event:"onInsertExistingFailure"},function(W){var X=N.insertFailure;if(W&&W.message){X=W.message}S.displayNotification({eventID:"error",msg:X});S.publish({event:"onInsertExistingFailure"})}));S._controllerTokens.push(S._controller.subscribe({event:"onInsertExisting"},function(Z){if(Z.createdNode&&Z.insertedNode){var Y=S.getController().getRootBag();var aa=H.buildPathesLeadingToNode(Z.createdNode,Y);var W=[];for(var X=0;X<aa.length;X++){aa[X].addElement(Z.insertedNode);W.push({pathElement:aa[X]})}o.add(W);q.add(W)}S._viewer.render({updateInfinitePlane:true});S.reframe();S.displayNotification({eventID:"success",msg:N.insertSuccessful});S.publish({event:"onInsertExisting",data:Z});S.publish({event:"onModelUpdated",data:Z})}));S._controllerTokens.push(S._controller.subscribe({event:"onStreamSwitched"},function(W){S.publish({event:"onStreamSwitched"});S.publish({event:"onModelUpdated",data:{rootNodes:S.getRoots()}})}));S._controllerTokens.push(S._controller.subscribe({event:"onStreamSwitchFailure"},function(W){S.publish({event:"onStreamSwitchFailure"})}));S._controllerTokens.push(S._controller.subscribe({event:"onGeometryRefreshed"},function(W){S.publish({event:"onGeometryRefreshed"});S.publish({event:"onModelUpdated",data:{rootNodes:S.getRoots()}})}));S._controllerTokens.push(S._controller.subscribe({event:"onRefreshGeometryFailure"},function(W){S.publish({event:"onRefreshGeometryFailure"})}));S._controllerTokens.push(S._controller.subscribe({event:"onEndDelete"},function(W){S._viewer.render({updateInfinitePlane:true});S.reframe();S.displayNotification({eventID:"success",msg:N.deleteSuccessful});S.publish({event:"onEndDelete",data:W});S.publish({event:"onModelUpdated",data:W});S.lockSelectionBroadcast(false)}));S._controllerTokens.push(S._controller.subscribe({event:"onCompletionCompleted"},function(W){S._viewer.render({updateInfinitePlane:true});S.displayNotification({eventID:"info",msg:W.nbPathLoaded+N.completionCompleted});S.publish({event:"onCompletionCompleted"});S.publish({event:"onModelUpdated",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onBeginDelete"},function(W){S.lockSelectionBroadcast(true);S.publish({event:"onBeginDelete",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onDefaultStreamChanged"},function(X){if(X.newStream){var W=X.newStream==="cgr";S.changeVisuModeCmdAvailability(W)}S.publish({event:"onDefaultStreamChanged",data:X})}));S._controllerTokens.push(S._controller.subscribe({event:"onIndexAvalabilityChange"},function(W){S.publish({event:"onIndexAvalabilityChange",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onEndRootRemoved"},function(W){S.publish({event:"onEndRootRemoved",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onRefreshCompleted"},function(W){if(!S._controller.getNbRoots()&&!S._checkHiddenRoots()&&S._dropZoneContainer){S._dropZoneContainer.show("drop")}S.displayNotification({eventID:"info",msg:N.refreshCompleted});S.publish({event:"onRefreshCompleted",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onRefreshBegin"},function(W){S.publish({event:"onRefreshBegin",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onAuthoringSwitch"},function(W){if(W.message&&W.message!==""){S.displayNotification({eventID:"info",msg:W.message})}S.getController().refreshAppliedFilters();S.publish({event:"onAuthoringSwitch",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onAuthoringTransactionBegin"},function(){o.empty();q.empty();S.publish({event:"onAuthoringTransactionBegin"})}));S._controllerTokens.push(S._controller.subscribe({event:"onAuthoringTransactionEnd"},function(){S.publish({event:"onAuthoringTransactionEnd"})}));S._controllerTokens.push(S._controller.subscribe({event:"onExpandCompleted"},function(W){if(W.displayNotif){S.displayNotification({eventID:"info",msg:N.expandCompleted})}S.publish({event:"onExpandCompleted"});S.publish({event:"onModelUpdated",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onDisableUX"},function(W){require(["DS/UIKIT/Modal"],function(X){S.elements.container.blockUX=new X({className:"disableMainUX",closable:false,body:"",visible:true});S.elements.container.blockUX.inject(document.body)})}));S._controllerTokens.push(S._controller.subscribe({event:"onEnableUX"},function(W){if(S.elements.container.blockUX){S.elements.container.blockUX.destroy();delete S.elements.container.blockUX}if(S.elements.container.blockActionBar){S.elements.container.blockActionBar.destroy();delete S.elements.container.blockActionBar}if(document.querySelector(".enopad3Dviewer_actionbar_disabled")){S._frmWindow.getActionBar()._afr.elements.container.removeClassName("enopad3Dviewer_actionbar_disabled")}}));S._controllerTokens.push(S._controller.subscribe({event:"onDisableActionBar"},function(W){S._frmWindow.getActionBar()._afr.elements.container.addClassName("enopad3Dviewer_actionbar_disabled")}));S._controllerTokens.push(S._controller.subscribe({event:"PGPPostProcess"},function(W){if(W.hiddenPaths&&W.hiddenPaths.length){var X=[];W.hiddenPaths.forEach(function(Z){var Y=S.unstreamPath(Z);X.push(Y)});S.getHideShowController().hide({paths:X,dispatch:false})}if(W.references.length||W.instances.length||W.occurrences.length){S.getBIController().applyPGPColor(W);S.getHideShowController().applyPGPHideShow(W)}}));S._controllerTokens.push(S._controller.subscribe({event:"onStartProgressiveLoad"},function(W){if(S.isSelectiveLoadingActivated()){if(S.getStatusBar()){S.getStatusBar().setLoader({status:"on"});S.getStatusBar().setProgressLabel(N.PADStatus_loadingData);S.getStatusBar().clearWarning()}}S.publish({event:"onStartProgressiveLoad",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onEndProgressiveLoad"},function(W){if(S.isSelectiveLoadingActivated()){S.getStatusBar().setLoader({status:"off"});if(S.getRoots().length===0&&!S._checkHiddenRoots()&&S.getStatusBar()){S.getStatusBar().setIsPaused(false);S.getStatusBar().resetProgressLabel()}else{if(W.memoryFull===true&&S.getStatusBar()){S.getStatusBar().setCustomProgressLabel({label:N.PADStatus_loadingStopped,tooltip:N.progressiveExpandFullMemory,severity:"warning"})}else{if(S.getStatusBar()){S.getStatusBar().setCustomProgressLabel({label:N.PADStatus_loadingComplete,tooltip:N.PADStatus_loadingComplete,severity:"success"})}}}}S.publish({event:"onEndProgressiveLoad",data:W})}));var V=false;S._controllerTokens.push(S._controller.subscribe({event:"onFilterEmpty"},function(X){if(S.elements.pad3drootlist){var W=S.elements.pad3drootlist._search(X.id);W[0].setBadges({bottomRight:""})}this._filteredIdToReload.push(X.id);if(V===false){V=true;require(["DS/ENOPAD3DViewer/views/PAD3DRemoveFilterPanel"],function(Y){var Z=new Y({container:S.elements.container,events:{onValidate:function(aa){V=false;if(this.getStatusBar()){this.getStatusBar().clearFilter({id:X.id})}if(aa){this.getController().removeFilterFullReload(this._filteredIdToReload)}this._filteredIdToReload=[]}.bind(this)}})}.bind(this))}}.bind(S)));S._controllerTokens.push(S._controller.subscribe({event:"onUrlLoaded"},function(W){S.publish({event:"onUrlLoaded",data:{nbCgrLoaded:W.nbCgrLoaded,nbThbLoaded:W.nbThbLoaded}})}));S._controllerTokens.push(S._controller.subscribe({event:"onVQDisabled"},function(W){S.displayNotification({eventID:"warning",msg:N.queryFailed_VQDisabled})}));S._controllerTokens.push(S._controller.subscribe({event:"onLeafReferenceLoaded"},function(W){S.publish({event:"onLeafReferenceLoaded",data:W})}));S._controllerTokens.push(S._controller.subscribe({event:"onLeafReferenceUnloaded"},function(W){S.publish({event:"onLeafReferenceUnloaded",data:W})}));S.subscribe({event:"onFilterDropped"},function(){S.clearWidgetBorder()});U()}})});this._readyCheckPromises.push(T);return T},getCommandContext:function(){return this._context},changeVisuModeCmdAvailability:function(T){var ac=this.getCommandContext();var X=I.getCommandCheckHeader("VisuFilterLines",ac);if(X){if(T===true){X.enable()}else{X.disable()}}var Z=I.getCommandCheckHeader("VisuFilterPoints",ac);if(Z){if(T===true){Z.enable()}else{Z.disable()}}var aa=I.getCommandCheckHeader("VisuFilterAxis",ac);if(aa){if(T===true){aa.enable()}else{aa.disable()}}var W=I.getCommand("VisuNoShadingEdges",ac);if(W){if(T===true){W.enable()}else{W.disable()}}var U=I.getCommand("VisuShading",ac);if(U){if(T===true){U.enable()}else{U.begin()}}var V=I.getCommand("VisuShadingEdges",ac);if(V){if(T===true){V.enable()}else{V.disable()}}var ab=I.getCommand("VisuShadingEdgesNoSmoothEdges",ac);if(ab){if(T===true){ab.enable()}else{ab.disable()}}var Y=I.getCommand("VisuShadingEdgesHiddenEdges",ac);if(Y){if(T===true){Y.enable()}else{Y.disable()}}var S=I.getCommand("VisuShadingMaterial",ac);if(S){if(T===true){S.enable()}else{S.disable()}}var R=I.getCommand("VisuShadingMaterialEdges",ac);if(R){if(T===true){R.enable()}else{R.disable()}}},_initHideShowController:function(){var R=this;require(["DS/ENOPAD3DViewer/controller/PAD3DViewerHideShowController"],function(S){R._hideShowController=new S({context:R,viewer:R._viewer});R._hideShowControllerTokens.push(R._hideShowController.subscribe({event:"onHide"},function(T){R.publish({event:"onHide",data:T})}));R._hideShowControllerTokens.push(R._hideShowController.subscribe({event:"onShow"},function(T){R.publish({event:"onShow",data:T})}));R._hideShowControllerTokens.push(R._hideShowController.subscribe({event:"onExclusiveShow"},function(T){R.publish({event:"onExclusiveShow",data:T})}))})},_initFrameWindow:function(T){var S=this;y.set(this);T.context=T.context===undefined?null:T.context;T.viewerOptions.showReferenceAxisSystem=T.viewerOptions.showReferenceAxisSystem===undefined?true:T.viewerOptions.showReferenceAxisSystem;var R=null;if(T.workbench&&T.workbenchModule){R={workbench:T.workbench,workbenchModule:T.workbenchModule,};delete T.workbench;delete T.workbenchModule}this._context=T.context;this._readyCheckPromises.push(new D(function(U){T.uiOptions.displayTree=false;S.fWInitProbe=w.createProbe("FrameWindow3D_init");S.viewerInitProbe=w.createProbe("3DViewer_init");S._frmWindow=new t(T).inject(S.elements.view_container);S._frmWindow.onReady(function(){S._viewer=S._frmWindow.getViewer();S._robotVisibility=T.robotVisibility;if(T.viewerOptions.showReferenceAxisSystem){S._viewer.setRobot(S._robotVisibility,{snapOnFace:true})}S._viewer.setPicking(T.viewerOptions.highlight);S._viewer.setPrePicking(T.viewerOptions.pHighlight);S._viewer.displayPoints(true);S._viewer.restoreVisualizationMode();S._viewer.restoreAmbiance();S.getViewpoint().setDefaultController(true,T.mouseProfile);if(T.viewpointProjectionType!==undefined){var V=T.viewpointProjectionType==="PERSPECTIVE"?0:1;S.getViewpoint().setProjectionType(V)}else{S._viewer.restoreProjectionMode()}S.viewerInitProbe.end();delete S.viewerInitProbe;S.defAbDisplayProbe=w.createProbe("defaultActionBarDisplay");S.defAbReadyProbe=w.createProbe("defaultActionBarReady");S._frmWindow.getContextualUIManager().activateContextualBarOnLeftClicAfterCSOChange();if(T.contextualMenuContent&&T.contextualMenuContent.workbenchName&&T.contextualMenuContent.module&&T.contextualMenuContent.fileName){S._frmWindow.getContextualUIManager().register({workbenchName:T.contextualMenuContent.workbenchName,module:T.contextualMenuContent.module,cmdPrefix:"",fileName:T.contextualMenuContent.fileName,context:S.getCommandContext(),onContextualMenuReady:function(ab,Y){var aa=S.getViewer();var ad=I.getCommand("FlyWalk",S.getCommandContext());var ac=true;if(ad){ac=!ad._isRunning}if(ac&&S._defaultContextualMenuVisibility&&undefined!==Y&&undefined!==Y.XmousePositionWithDevPxRatio&&undefined!==Y.YmousePositionWithDevPxRatio&&aa){var X=aa.pick({xPix:Y.XmousePositionWithDevPxRatio,yPix:Y.YmousePositionWithDevPxRatio},"mesh",true).path;var W=X.length===0?true:false;var Z=[];if(W){T.contextualMenuContent.emptiness.forEach(function(af){Z.push({name:af.name,line:1,hdr_list:[af.header]})})}else{var ae=o.get();if(ae.length>0){if(S._areValidPaths(ae)){T.contextualMenuContent.geometry.forEach(function(af){if(af.header==="ActionBar_Attributes"){if(S._propertiesCommandAvailability){Z.push({name:af.name,line:1,hdr_list:[af.header]})}}else{Z.push({name:af.name,line:1,hdr_list:[af.header]})}})}}}return Z.length?{cmdList:Z}:undefined}},onContextualBarReady:function(aa,Z){var ab=S.getViewer();if(S._defaultContextualBarVisibility&&undefined!==Z&&undefined!==Z.XmousePositionWithDevPxRatio&&undefined!==Z.YmousePositionWithDevPxRatio&&ab){var W=ab.pick({xPix:Z.XmousePositionWithDevPxRatio,yPix:Z.YmousePositionWithDevPxRatio},"mesh",true).path.length===0?true:false;if(W){}else{var Y=[];var X=o.get();if(X.length>0){if(S._areValidPaths(X)){if(X.length===1){if(X[0].pathElement.externalPath.length===2){Y.push({name:"RemoveRoot",line:1,hdr_list:["RemoveRootHdr"]})}else{Y.push({name:"LevelSelector",line:1,hdr_list:["LevelSelectorHdr"]})}}}}return Y.length?{cmdList:Y}:undefined}}}})}S._initModelController(T).then(function(){if(R){S.loadActionBar(R);S._actionBarTokens.push(S._frmWindow.onActionBarReady(function(){if(S._firstInit){S._firstInit=false;S._controller._setDefaultStreamToLoad(B.getSetting("enopad3dviewer_CGRorTHB"));S.defAbReadyProbe.end();delete S.defAbReadyProbe;S.fWInitProbe.end();delete S.fWInitProbe;S.initProbe.end();delete S.initProbe}else{if(S.abReadyProbe){S.abReadyProbe.end();delete S.abReadyProbe}}S.publish({event:"onActionBarReady",data:S});if(S._readyCheckPromises&&R){U()}else{S.publish({event:"onReady",data:S})}}))}S._initHideShowController();if(T.allowDnD){S._initDnD()}S._initInterwidgetCom();S._initCSOEvent(T);if(undefined!==T.BIMode&&"OFF"!==T.BIMode){S.getController().toggleBetweenStandaloneAndSlaveMode(T.BIMode);if(T.BIMode==="STANDALONE"){S._isVolumeFilter=false}}setTimeout(function(){S.publish({event:"onViewerReady",data:S});if(!R){U()}})})})}))},_checkHiddenRoots:function(){var S=this;var R=S._controller.getHiddenRootIds()?S._controller.getHiddenRootIds().length:0;if(R===0){return false}else{return true}},_initDnD:function(){var R=this;if(!B.getSetting("activate_newDropInvite")){require(["DS/PADUtils/views/PADDnDInvite"],function(U){R._dropZoneContainer=new U({renderTo:R.elements.container,mode:"inviteWithFilter",filterActive:B.getSetting("enopad3dviewer_FilterAvailable"),dropOnInvite:function(Y){T(Y)}});function X(Y){Y.preventDefault();R.addWidgetBorder();if(Y.shiftKey){R._dropZoneContainer.show("add_as_object")}else{R._dropZoneContainer.show("add_in_context")}}R._dndCB[0]=(X);function W(Y){R.clearWidgetBorder();if(R.getRoots().length===0&&!R._checkHiddenRoots()){R._dropZoneContainer.show("drop")}else{R._dropZoneContainer.hide()}}R._dndCB[1]=(W);function T(Y){Y.preventDefault();Y.stopPropagation();if(R.elements.container.contains(Y.target)){R._dropZoneContainer.hide();var Z=true;if(Y.shiftKey){Z=false}R.addRootNodesFromContent({dndEvent:Y,dispatch:true,inContext:Z});R.clearWidgetBorder()}}R._dndCB[2]=(T);function S(Y){Y.preventDefault();R.clearWidgetBorder();if(Y.shiftKey){R._dropZoneContainer.show("add_as_object")}else{R._dropZoneContainer.show("add_in_context")}}R._dndCB[3]=(S);function V(Y){if(Y.relatedTarget==null||!Y.relatedTarget.classList.contains("paddnd_invite_container")){R._dropZoneContainer.hide();if(R.getRoots().length===0){R._dropZoneContainer.show()}R.clearWidgetBorder()}}R._dndCB[4]=(V);R.elements.container.addEventListener("dragenter",S);R.elements.container.addEventListener("dragover",X);R.elements.container.addEventListener("dragleave",V);R.elements.container.addEventListener("dragend",W);R.elements.container.addEventListener("drop",T)})}},addRootNodesFromContent:function(S){var T=this;S.dispatch=undefined===S.dispatch?true:S.dispatch;S.inContext=undefined===S.inContext?true:S.inContext;var R=null;if(S.json3DXContent){R=e.is(S.json3DXContent,"string")?JSON.parse(S.json3DXContent):S.json3DXContent}var U=S.dndEvent?{dataTransfer:S.dndEvent.dataTransfer}:undefined;L.retrieveAuthorizedObjects({displayNotif:false,X3DContentId:R?R:undefined,dnd_event:U?U:undefined,callback:function(X){if(X.unauthorized_objects.length){X.unauthorized_objects.forEach(function(Y){if(T._loadingDelegations&&T._loadingDelegations["_"+Y.objectType]){var Z=T._loadingDelegations["_"+Y.objectType];Z(Y)}else{T.displayNotification({msg:A.replace(A.get("unsupported_type"),{type:Y.displayType,name:Y.displayName}),eventID:"warning"})}})}if(X.authorized_objects.length===0){if(T.getRoots().length===0&&!T._checkHiddenRoots()&&T._dropZoneContainer){T._dropZoneContainer.show("drop")}}else{var V=T.getRoots(),W=X.authorized_objects;p.multiTenantMgt(W,V,function(Y){if(!Y.isMultiTenant){if(X.authorizedWithKind){if(X.authorizedWithKind.Product&&X.authorizedWithKind.Product.length>0){var Z=[];X.authorizedWithKind.Product.forEach(function(aa){var ab=aa.path&&S.inContext?aa.path.map(function(ac){return ac.resourceid}):[aa.objectId];Z.push({path:ab})});T.addRoots({objects:Z},S.dispatch)}if(X.authorizedWithKind.Filter&&X.authorizedWithKind.Filter.length>0){if(T.getController().isStandaloneFilterAvailable()===true){T._commandProxy.dropFilter3D({droppedFilters:X.authorizedWithKind.Filter,broadcast:false});T.getController().retrieveFilters(X)}else{if(T.getController().isSlaveFilterAvailable()===true){T._commandProxy.dropFilter3D({droppedFilters:X.authorizedWithKind.Filter})}else{if(T.getRoots().length===0&&!T._checkHiddenRoots()&&T._dropZoneContainer){T._dropZoneContainer.show("drop")}}}}if(X.authorizedWithKind.Change&&X.authorizedWithKind.Change.length>0){T.loadChange({objects:X.authorizedWithKind.Change})}}else{var Z=[];X.authorized_objects.forEach(function(aa){var ab=aa.path&&S.inContext?aa.path.map(function(ac){return ac.resourceid}):[aa.objectId];Z.push({path:ab})});T.addRoots({objects:Z},S.dispatch)}}T=null})}},version:"2.0"})},_areValidPaths:function(T){var S=true;if(T){for(var R=0;R<T.length;R++){if(!u.isAModelPath(T[R].pathElement)){S=false;break}}}return S},_initCSOEvent:function(V){var T=this;if(this.isInterwidgetComAvailable()){var U=function(){if(!T._lockCSONotification&&!T._lockCSONotificationEmpty){var ae=[];var ad=[];var Z={};var ac=[];var af=o.get();var W={version:"1.1",paths:ae,POIs:ad,attributes:Z,sharedID:p.getSharedId(),focusOn:T._reframeFocus};af.forEach(function(ag){if(u.isAModelPath(ag.pathElement)){T.streamPathWithType(ag.pathElement,ae,Z)}if(u.isAPOIPath(ag.pathElement)){T.streamPOI(ag.pathElement,ad);T.getDecorationBag()}});if(B.getSetting("authorizeChangeControl")){var aa=require("DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext");W.changeControl=aa.get()}var Y=T._searchRecent?T._searchRecent:false;if(Y===true){W.searchDone=Y}T._commandProxy.select(W);if(T._authorizeSet3DStructure===true){if(ae){ae.forEach(function(ag){ac.push(ag[ag.length-1])})}T.set3DXContentData({nodes2Open:ac,selectedPaths:W});if(B.getSetting("settypes")!==true){var X=T.set3DStructure4OpenInCV5({nodes2Open:ac,selectedPaths:W});var ab=JSON.stringify(X);x.publish("setStructure",{structure:ab})}else{T.setTypesFor3D(W)}}}};if(o.onPostAdd){T._csoTokens.push(o.onPostAdd(U))}if(T.isSelectiveLoadingActivated()&&o.onChange){T._csoTokens.push(o.onChange(G.debounce(function(){var W=o.get().length;if(W){T.getStatusBar().setSelection({length:W})}else{T.getStatusBar().clearSelection()}})))}if(o.onPostRemove){T._csoTokens.push(o.onPostRemove(U))}else{T._csoTokens.push(o.onRemove(G.debounce(U,100)))}T._csoTokens.push(o.onPreEmpty(function(){T._lockCSONotificationEmpty=true}));T._csoTokens.push(o.onEmpty(function(){T._lockCSONotificationEmpty=false;if(!T._lockCSONotification){T._commandProxy.select({paths:[],sharedID:p.getSharedId(),focusOn:T._reframeFocus})}}));function S(X){if(!X||!X.pathElement||!X.pathElement.externalPath.length||!u.isAModelPath(X.pathElement)){return X}else{var Y=X.pathElement;var W=Y.getLastElement(true);while(Y&&!u.isReference(W)){Y=Y.getParentPath();if(Y){W=Y.getLastElement(true)}}X.pathElement=Y;return X}}function R(Y){if(!T._lockCSONotification&&B.getSetting("enopad3dviewer_selectionFilter")==="PRODUCT"){if(Y instanceof Array){var X=0,W=Y.length;for(X=0;X<W;X++){if(Y[X].event){S(Y[X])}}}else{if(Y.event){S(Y)}}}}T._psoTokens.push(a.onPreAdd(R));T._csoTokens.push(o.onPreAdd(R));T._hsoTokens.push(q.onPreAdd(R))}},set3DXContentData:function(S){if(!e.is(S.nodes2Open,"array")){throw new Error("set3DXContentData: Invalid init parameter nodes2Open")}var R=e.is(widget)&&widget.id?"padcompassSocket_"+widget.id:"padcompassSocket";if(n===null){n=new K.Socket(R);n.subscribeServer("com.ds.compass",window.parent)}if(S.nodes2Open.length===0){n.dispatchEvent("onResetX3DContent",{},R)}else{var T={protocol:"3DXContent",version:"1.0",source:widget&&widget.getValue("x3dAppId")?widget.getValue("x3dAppId"):"ENOSTDE_AP",data:{items:[]}};S.selectedPaths.paths.forEach(function(V){var W=function(X){var Y=[];X.forEach(function(Z){Y.push({resourceid:Z,type:S.selectedPaths.attributes[Z].type})});return Y};var U=V[V.length-1];T.data.items.push({envId:p.getPlatformId(),serviceId:"3DSpace",contextId:B.getSetting("pad_security_ctx")?B.getSetting("pad_security_ctx"):undefined,objectId:U,objectType:S.selectedPaths.attributes[U].type,path:W(V)})});n.dispatchEvent("onSetX3DContent",T,R)}},set3DDragDropData:function(R){var T={protocol:"3DXContent",version:"1.1",source:this.getWidget()&&this.getWidget().getValue("x3dAppId")?this.getWidget().getValue("x3dAppId"):"tmp",widgetId:p.getWidgetId(),data:{items:[]}};var S=this;R.forEach(function(W){if(u.isAModelPath(W.pathElement)){var Z=S.streamPath(W.pathElement);var Y=S.getController().getNode({id:Z[Z.length-1]});if(Z.length>0){}var U=[];for(var V=0;V<Z.length;++V){var X=S.getController().getNode({id:Z[V]});U.push({resourceid:Z[V],type:u.getNodeType(X)})}T.data.items.push({envId:p.getPlatformId(),serviceId:"3DSpace",contextId:B.getSetting("pad_security_ctx")?B.getSetting("pad_security_ctx"):undefined,objectId:u.getNodeID(Y),objectType:u.getNodeType(Y),path:U})}});return T},buildStructure:function(S,R,U){var T=0;for(var V in S){var W=[];U.push({id:R[V].idx,show:R[V].show,select:R[V].selected,children:[]});W=this.buildStructure(S[V],R,U[T].children);if(W){U.push({children:W})}T++}},setTypesFor3D:function(S){var T=this;if(!E){x.subscribe("setTypesCallback",function(aa){if(aa.widgetId===p.getWidgetId()){var ad=[];var X={};var Y=[];var ac=[];var Z=[];var ae=o.get();var V=T.getController()._model.getRootBag();var ab=[];var W={version:"1.1",paths:ad,attributes:X};T.getRoots().forEach(function(af){ab.push(u.getNodeID(af))});ae.forEach(function(ah){if(u.isAModelPath(ah.pathElement)){var ai=ah.pathElement;var ag=ai.getLastElement(true);var af=u.getNodeID(ag);if(ab.indexOf(af)!==-1){ad.push([af])}if(ag.is3DLeaf){if(!ag.is3DLeaf()){var aj={};ag.traverse(function(ak){if(ak.is3DLeaf&&ak.is3DLeaf()&&!aj[ak.getID()]){aj[ak.getID()]=true;var al=H.buildPathesLeadingToNode(ak,V);al.forEach(function(am){if(ai.isAParentOf(am)){Y.push(am)}})}});Y.forEach(function(ak){if(!T._hideShowController.isVisible(ak)){Z.push(ak.getLastElement(true).getID())}T.streamPathWithType(ak,ad,X)})}else{T.streamPathWithType(ah.pathElement,ad,X)}}else{T.streamPathWithType(ah.pathElement,ad,X)}}});if(ad){ad.forEach(function(af){ac.push(af[af.length-1])})}T.setTypesForOFW({nodes2Open:ac,hiddenNodes:Z,selectedPaths:W},function(ai){var ag=T.getViewpoint();var af=r.buildViewPoint(ag);if(af!==null){ai.viewpoint.push(af)}if(S.changeControl){ai.workUnder=S.changeControl}var aj=JSON.stringify(ai);var ah={appId:aa.appId,widgetId:aa.widgetId,fileName:"-file",fileContent:aj};x.publish("launchApp",ah)})}});E=true}var U={widgetId:T.getWidget().id};var R=o.get();if(R.length>0){x.publish("setTypes",U)}else{x.publish("resetType")}},setTypesForOFW:function(ag,af){var aa=this;if(!e.is(ag.nodes2Open,"array")){throw new Error("settypes_open_in_web: Invalid init parameter nodes2Open")}var Z=e.clone(b);var ab=[],V=[],S="",Y=0,X=0,ad=1,ah={id:null,phid:null},U,W={},ac={};ag.selectedPaths.paths.forEach(function(al){var ak=function(an){var am=W[an];if(am){if(!e.is(U[am.localid])){U[am.localid]={}}U=U[am.localid]}};var aj=function(an){var am=false;if(ag.nodes2Open.indexOf(an)===-1){am=false}else{am=true}return am};var ai=function(an){var am=false;if(ag.hiddenNodes.indexOf(an)===-1){am=true}else{am=false}return am};for(Y=0;Y<al.length;Y++){S=al[Y];if(ab.indexOf(S)===-1){Z.results.push({id:ad.toString(),phid:S});W[S]={idx:ad,localid:X,};ac[X]={idx:ad.toString(),nodeId:S,show:ai(S),selected:aj(S)};ad++;X++;ab.push(S)}}U=V;al.forEach(ak)});for(var T in V){var ae=[];var R=[];ae.push({id:ac[T].idx,show:ac[T].show,select:ac[T].selected,children:[]});R=aa.buildStructure(V[T],ac,ae[0].children);if(R){ae.push({children:R})}Z.structures.push({structure:ae})}af(Z)},set3DStructure4OpenInCV5:function(U){if(!e.is(U.nodes2Open,"array")){throw new Error("setStructure_4_open_in_cv5: Invalid init parameter nodes2Open")}var Y={version:"1",structures:{references:[],connections:[],trees:{}}};var W=[],X="",S=0,R=0,V,T={};U.selectedPaths.paths.forEach(function(ab){var aa=function(ad){var ac=T[ad];if(!e.is(V[ac.localid])){V[ac.localid]={};if(ac.selected){V[ac.localid].selected=ac.selected}}V=V[ac.localid]};var Z=function(ad){var ac=false;if(U.nodes2Open.indexOf(ad)===-1){ac=false}else{ac=true}return ac};for(S=0;S<ab.length;S++){X=ab[S];if(W.indexOf(X)===-1){if(S%2!==0){Y.structures.connections.push({physicalid:ab[S],localid:R+""});T[X]={localid:R,selected:Z(X)};R++;W.push(X)}else{Y.structures.references.push({physicalid:ab[S],type:U.selectedPaths.attributes[ab[S]].type,localid:R+""});T[X]={localid:R,selected:Z(X)};R++;W.push(X)}}}V=Y.structures.trees;ab.forEach(aa)});return Y},_initInterwidgetCom:function(){var R=this;if(this.isInterwidgetComAvailable()){require(["DS/PADUtils/PADCommandProxy"],function(S){R._commandProxy=S.create({events:{onSharedAlert:function(T){var U=k.getPromises().slice();k.createPromise(function(W,V){D.all(U).then(function(X){U=null;if(R.getRoots().length===0&&!R._checkHiddenRoots()){R._dropZoneContainer.show("drop")}else{R._dropZoneContainer.hide()}R.displayNotification(T);W()})},"SharedAlert")},onFilterWarn:function(T){var U=k.getPromises().slice();k.createPromise(function(W,V){D.all(U).then(function(X){U=null;if(R.getRoots().length===0&&!R._checkHiddenRoots()){R._dropZoneContainer.show("drop")}else{R._dropZoneContainer.hide()}var Y="";switch(T){case"inauthoring":Y=A.filterInAuthoring;break;case"notactivated":Y=A.filterNotActivated;break}R.displayNotification({eventID:"warning",msg:Y});W()})},"FilterWarn")},onFocusChange:function(T){if(T.sharedID==p.getSharedId()){R.publish({event:"onFocusChange",data:T})}},onSelect:function(U,T){var V=k.getPromises().slice();k.createPromise(function(X,W){D.all(V).then(function(Y){V=null;if(U.focusOn===true&&U.sharedID&&U.sharedID!==p.getSharedId()){console.log("Call from another instance hence not selecting");X();return}R.lockSelectionBroadcast(true);try{var ab=[];if(U.paths){var ad=[];if(U.version==="2"){U.paths.forEach(function(af){var ae=[];af.forEach(function(ag){ae.push(ag.resourceid)});ad.push(ae)})}else{ad=U.paths}ad.forEach(function(af){if(af.length){var ae=R.unstreamPath(af);if(ae){ab.push({pathElement:ae})}}})}if(U.POIs){for(var Z=0;Z<U.POIs.length;Z++){var aa=R.getController().unstreamPOI(U.POIs[Z]);if(aa){ab.push({pathElement:aa})}}}if(U.exclusiveShow===true){var ac=ab.map(function(ae){return ae.pathElement});R._hideShowController.exclusiveShow({paths:ac})}if(ab.length){o.empty();q.empty();o.add(ab);q.add(ab)}else{if(T.appid===S.appId()&&U.focusOn!==true){o.empty();q.empty()}else{R.publish({event:"onClosePager"})}}}finally{R.lockSelectionBroadcast(false);X()}})},"select")},onReframeSelection:function(){R.reframe()},onFocus:function(U){if(B.getSetting("enopad3dviewer_lightNodeModel")===true){if(!U.paths){console.error("No path to focus on or call from another 3D widget reference");resolve();return}if(U.intent==="reframe"){var W=[];U.paths.forEach(function(Y){if(Y.length){var X=R.unstreamPath(Y);if(X){W.push(X)}}});r.reframeOn({paths:W,viewpoint:R.getViewpoint()});return}else{var T=I.getCommand("PAD3DViewerNavigateOnSelectionHdr",R.getCommandContext());if(T){T.execute(U.paths)}}}else{var V=k.getPromises().slice();k.createPromise(function(Y,X){D.all(V).then(function(Z){V=null;if(!U.paths){console.error("No path to focus on or call from another 3D widget reference");Y();return}if(U.intent==="reframe"){var ab=[];U.paths.forEach(function(ad){if(ad.length){var ac=R.unstreamPath(ad);if(ac){ab.push(ac)}}});r.reframeOn({paths:ab,viewpoint:R.getViewpoint()});Y()}else{var aa=I.getCommand("PAD3DViewerNavigateOnSelectionHdr",R.getCommandContext());if(aa){aa.execute(U.paths).then(function(){Y()})}}})},"focusOn")}},onPadDestroy:function(T){R.publish({event:"onWidgetDestroyed",data:T})},onRequestViewPoint:function(){var U=R.getViewpoint();var T=r.buildViewPoint(U);R._commandProxy.updateViewPoint(T)}}})})}},displayNotification:function(R){var S=this;require(["DS/PADUtils/views/PADAlert"],function(T){T.displayNotification(R);if(S.isSelectiveLoadingActivated()){S.getStatusBar().setLatestNotification({notification:R})}})},streamPath:function(R){return this._controller.buildArrayFromPath(R)},streamPathWithType:function(S,T,R){return this._controller.buildArrayFromPathWithType(S,T,R)},streamPOI:function(S,R){return this.getController().streamPOI(S,R)},unstreamPath:function(R,S){return this._controller.buildPathFromArray(R,S)},loadActionBar:function(R){R.context=this.getCommandContext();this.abReadyProbe=w.createProbe("actionBarReady");R.language=this._lang;var S={};if(this.isSelectiveLoadingActivated()){if(p.isTouchDevice()){S={bottom:"38px"}}else{S={bottom:"24px"}}}if(this.getFrameWindow().getActionBar()){this.getFrameWindow().getActionBar().loadModel(R)}else{this.getFrameWindow().loadActionBar(R)}if(this.getOption("enableSidePanel")===true){this.getFrameWindow().getActionBar().inject(this.elements.main);this.getFrameWindow().getActionBar().elements.container.setStyles(S)}},displayTree:function(R){if(R){this._frmWindow.getTree().show()}else{this._frmWindow.getTree().hide()}},getBIController:function(){return this._controller},author:function(S){var R=true;if(e.is(S,"boolean")){R=S}this._controller.switchAuthoringMode(S)},addRoots:function(T,S,R){if(T.pids===undefined&&T.paths===undefined&&T.objects===undefined){console.error("No PIDs or paths or objects array defined");return}if(T.pids!==undefined||T.paths!==undefined){console.warn("The usage of pids or paths is deprecated, please use objects")}S=S===undefined?true:S;R=R===undefined?true:R;this._controller.addRoots(T,S,R,this.getAutomaticReframePolicy())},addFilter:function(R){this._controller.addFilter(R)},loadJSON:function(T){if(!e.is(T.data,"array")||e.is(T.data,"array")&&T.data.length===0){throw new Error("No data defined")}for(var S=0;S<T.data.length;S++){if(!e.is(T.data[S].rootID,"string")){throw new Error("No rootID defined for the data nÃ‚Â°"+(S+1))}if(!e.is(T.data[S].structure,"object")){throw new Error("No structure defined for the data nÃ‚Â°"+(S+1))}}var R=false;this._controller.addRoots({structures:T.data},R)},removeRoots:function(R){if(R.pids===undefined){console.error("No PID array defined");return}if(this.getStatusBar()){this.getStatusBar().clearFilter({ids:R.pids})}this._controller.removeRoots(R,true)},empty:function(R){if(this.getStatusBar()){this.getStatusBar().clearFilter()}R=R===undefined?true:R;this._controller.flushModel(R)},publish:function(R){this.getModelEvents().publish(R)},subscribe:function(R,S){return this.getModelEvents().subscribe(R,S)},unsubscribe:function(R){this.getModelEvents().unsubscribe(R)},getRootBagPath:function(){return this._controller.getRootBagPath()},getRoots:function(){return u.getRoots(this)},getModelEvents:function(){return this._modelEvents},reframe:function(R){if(R){this._frmWindow.getViewpoint().reframe(null,undefined,R)}else{this._frmWindow.getViewpoint().reframe()}},reframeSelection:function(){var R=this;R._commandProxy.reframeSelection()},setCurrentLayout:function(S){var R=this;if(S&&!this._layoutActivatedTokenBegin){this._layoutActivatedTokenBegin=S.subscribe({event:"onLayoutComputationBegin"},function(){R.publish({event:"onLayoutComputationBegin"})});this._layoutActivatedTokenEnd=S.subscribe({event:"onLayoutComputationEnd"},function(){R.publish({event:"onLayoutComputationEnd"})})}this._layout=S},getViewer:function(){return this._viewer},getCommandProxy:function(){return this._commandProxy},getHideShowController:function(){return this._hideShowController},getViewpoint:function(){return this._frmWindow.getViewpoint()},getViewpointParameters:function(){return r.buildViewPoint(this.getViewpoint())},getLevelSelectorCommand:function(V){var R=I.getCommand("LevelSelectorHdr",this.getCommandContext());if(!R){var U=this;var T="DS/ENOPAD3DViewer/commands/PAD3DViewerLevelSelectorCmd";var S=T.replace(/\./g,"/");require(["DS/ApplicationFrame/CommandFactory",S],function(X,W){R=X._createCommand(W,{context:U.getCommandContext(),ID:"LevelSelectorHdr"});V(R);U=null})}else{V(R)}},getContentName:function(U){if(!e.is(U.callbacks,"object")){throw new Error("No callbacks function defined")}if(!e.is(U.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}var R=this.getRoots();var S="";var V=(R.length===1&&this._controller.getHiddenRootIds().length===0)?u.getNodeID(R[0]):null;if(null===V&&(R.length===0&&this._controller.getHiddenRootIds().length===1)){V=this._controller.getHiddenRootIds(0)}if(V){var T=this;this._controller.getAttributes({ids:[V],attributes:["ds6w:label"],callbacks:{onComplete:function(X){var W=T.getRoots();if((W.length>0||T._controller.getHiddenRootIds().length>0)&&X[V]){S=X[V]["ds6w:label"]}U.callbacks.onComplete({contentName:S});T=null},onFailure:function(){if(U.callbacks.onFailure){U.callbacks.onFailure({contentName:S})}T=null}}})}else{if(R.length+this._controller.getHiddenRootIds().length>1){S=(R.length+this._controller.getHiddenRootIds().length)+" "+N.contentNameSuffix;U.callbacks.onComplete({contentName:S})}else{U.callbacks.onComplete({contentName:S})}}},setRobotVisibility:function(R){this._robotVisibility=R;if(this._viewer.getRobot&&this._viewer.getRobot()){this._viewer.getRobot().setVisibility(R)}},isRobotVisible:function(){return this._robotVisibility},setDefaultContextualBarVisibility:function(R){this._defaultContextualBarVisibility=R},setDefaultProgressBarVisibility:function(R){this._defaultProgressBarVisibility=R},getDefaultProgressBarVisibility:function(){return this._defaultProgressBarVisibility},setAutomaticReframePolicy:function(R){this._automaticReframePolicy=R},getAutomaticReframePolicy:function(){return window.ENOPADNoReframe?false:this._automaticReframePolicy},isInterwidgetComAvailable:function(){return this._interwidgetComAvailability},isDefaultContextualBarVisible:function(){return this._defaultContextualBarVisibility},setDefaultContextualMenuVisibility:function(R){this._defaultContextualMenuVisibility=R},isDefaultContextualMenuVisible:function(){return this._defaultContextualMenuVisibility},getController:function(){return this._controller},getFrameWindow:function(){return this._frmWindow},deactivateCurrentLayout:function(S){var R=this;var T=k.getPromises().slice();k.createPromise(function(V,U){D.all(T).then(function(W){T=null;var X=false;if(R._layout){X=R._layout.isActive();if(X){R._layout.deactivate(false)}}if(S.disableCommand){var Y=document.querySelector("div[data-command=PAD3DLineLayoutHdr]");if(Y){Y.setAttribute("style","opacity: 0.5; pointer-events: none !important; -webkit-filter: grayscale(100%);")}}V();return X})},"deactivateLayout")},activateCurrentLayout:function(){if(this._layout&&!this._layout.isActive()){this._layout.activate()}var R=document.querySelector("div[data-command=PAD3DLineLayoutHdr]");if(R){R.setAttribute("style","")}},getCurrentLayout:function(){return this._layout},refresh:function(R){R=R===undefined?true:R;this._controller.refresh(R)},search:function(S){if(e.is(S.searchQuery,"string")){var R=this;require(["DS/PADServices/utils/PredefinedQueryUtils"],function(T){T.isPredefinedQry(S.searchQuery).then(function(U){S.searchQuery=U;R._controller.search(S)})})}},setLoadingDelegations:function(R){if(!e.is(R,"object")){throw new Error("Wrong parameter for setLoadingDelegations")}this._loadingDelegations=R},getDecorationBag:function(){return this._controller.getDecorationBag()},lockSelectionBroadcast:function(R){this._lockCSONotification=R},setAuthorizedRootTypes:function(S){var U=[];var T=B.getSetting("supported_root_types");for(var R=0;R<S.length;R++){if(T.indexOf(S[R])>-1){U.push(S[R])}}B.setSetting("authorized_root_types",U)},setDefaultStreamToLoad:function(R){B.setSetting("enopad3dviewer_CGRorTHB",R);this.getController()._setDefaultStreamToLoad(R)},loadChange:function(R){if(this._changeAction){this._changeAction.loadChange({app:this,changes:R.objects})}},addWidgetBorder:function(){if(this.getOption("enableSidePanel")===true){this.elements.borderedLayout.addClassName("bordered")}else{this.elements.container.addClassName("bordered")}},clearWidgetBorder:function(){if(this.getOption("enableSidePanel")===true){this.elements.borderedLayout.removeClassName("bordered")}else{this.elements.container.removeClassName("bordered")}},getStatusBar:function(R){return this.elements.padstatusbar},openStoredObjects:function(T){var S=this;var R=function(af,X,ac,ah){if(ac===undefined){ac=[]}var ag=Object.getOwnPropertyNames(X);var ab,V=ag.length;for(ab=0;ab<V;ab++){var aa=Object.getOwnPropertyNames(X[ag[ab]]);var ad,U=aa.length;if(U===0){var Y;if(ah===undefined){Y=[]}else{Y=ah.slice()}Y.push(ag[ab]);var W=Y.join(",");if(ac.indexOf(W)===-1){ac.push(W);var Z={path:Y};af.push(Z)}}else{for(ad=0;ad<U;ad++){var ae;if(ah===undefined){ae=[]}else{ae=ah.slice()}ae.push(ag[ab]);R(af,X[ag[ab]],ac,ae)}}}};return new D(function(U){var Y=k.getPromises();var Z=[];if(T.products){var X=Object.getOwnPropertyNames(T.products);if(X.length){var V=new D(function(ab){D.all(Y).then(function(){var ad=[];R(ad,T.products);if(ad.length){if(T.withFilter===true){var ac=S.subscribe({event:"onRootAdded"},function(ae){S.unsubscribe(ac);ab();if(T.fromProxy!==true){require(["DS/ApplicationFrame/CommandsManager"],function(af){var ag=af.getCommand("DefineFilterHdr",S.getCommandContext());if(ag){ag.setAppParams({widgetId:p.getWidgetId(),appId:p.getSharedId(),selectedId:ae.id});ag.begin()}})}})}S.addRoots({objects:ad,loadWithFilter:T.withFilter},false)}else{ab()}})});V.name="AddRoots";Z.push(V)}}if(T.filters){var aa=Object.getOwnPropertyNames(T.filters);if(aa.length){var W=new D(function(ab){D.all(Y).then(function(){var ae=[];for(var ad=0;ad<aa.length;ad++){ae.push({envId:p.getPlatformId(),serviceId:"3DSpace",objectId:aa[ad],objectType:"ENOStrRefinementSpecification"})}var ac={protocol:"3DXContent",version:"1.1",source:p.getAppId(),widgetId:p.getWidgetId(),data:{items:ae}};S.addRootNodesFromContent({json3DXContent:ac,inContext:false});ab()})});W.name="AddFilters";Z.push(W)}}D.all(Z).then(function(){if(S.getRoots().length===0&&!S._checkHiddenRoots()){var ab=require("DS/PADServices/utils/GlobalModelEvents");var ac=ab.getModelEvents();ac.publish({event:"ENXViews/WelcomePanel/activate"})}U()})})},openDroppedObjects:function(S){var R=this;return new D(function(U){if(S.behavior==="FILTER"){require(["DS/ApplicationFrame/CommandsManager"],function(V){var W=V.getCommand("FilterDropObjects");if(W){W.execute(S.unserializedData)}else{console.error("XNavComponent## FilterDropObjects command is undefined")}U(W&&S.unserializedData?undefined:{error:"noCommandAvailable"})})}else{var T=true;if(S.enxNavInitial){T=false}R.addRootNodesFromContent({json3DXContent:S.unserializedData,inContext:S.behavior?S.behavior==="WITH_CONTEXT"?true:false:true,dispatch:T});U()}})}});return m});