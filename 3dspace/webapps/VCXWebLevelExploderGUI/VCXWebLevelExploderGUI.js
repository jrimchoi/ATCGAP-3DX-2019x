define("DS/VCXWebLevelExploderGUI/VCXPartSlider",["UWA/Class","UWA/Core","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Core/PointerEvents","DS/RuntimeView/NLSManager","DS/Visualization/ThreeJS_DS","DS/VisuEvents/EventsManager","DS/WebappsUtils/WebappsUtils"],function(a,g,d,c,i,m,k,f,e){var j=["back","restore"];var h={};var b=false;var l=a.extend({init:function(o,r){this._modelEvent=new c();this._experienceBase=o;this._cursorColor=null;this._sliderColor=null;this._sliderLightColor=null;this._nbStages=null;this._ticks=null;this._tickColor=null;this._tickWidth=null;this._tickHeight=null;this._width=null;this._defaultWidth=400;this._sliderWidth=null;this._height=null;this._defaultHeight={classic:30,mab:26};this._defaultBottom=65;this._buttonWidth=32;this._defaultButtonWidth=32;this._padding=15;this._defaultPadding=15;this._divsGap=20;this._gapLength=null;this._defaultGapLength=10;this._cursorSize={width:6,height:7};this._defaultCursorSize={classic:{width:6,height:7},mab:{width:12,height:14}};this._ratio=null;this._widthStage=null;this._cursorBottomAt0=1;var p=this._experienceBase.getManager("VCXContextManager");var t=p.getFrameWindow();var n=t.getActionBar()&&t.getActionBar().MAB;if(n){this._mabIsVisible=n.state.visible;n.onVisibilityChangeSubscribe("ExplodePartSlider",this._switchMABDisplay.bind(this))}this._events={stages:{},ticks:{}};for(var s=0;s<j.length;++s){var q=j[s];if(!h[q]){h[q]={msg:null,msgFound:false}}if(!h[q].msgFound){h[q].msg=this._getButtonString(q)}}this._initOptions=this._getSliderParameters(r);this._currentPos=0;this._onDragEventAvailable=f.GESTURES_MAP.onDrag;this._containerDiv=null;this._triangle=null;var u=this;this._build();this._buildCursor();this._subscribeToGestureEvents();this.setRestoreButton(function(){u.setCursorPosWithTransition(0)});this._adaptSliderDimensionsToContext();this._cursorTransi=null;this.onResizeToken=d.subscribe({event:"/VISU/onWindowResized"},function(){u._adaptSliderDimensionsToContext()});if(!b){this._experienceBase.getManager("VCXContextManager").loadCssFile("VCXWebLevelExploderGUI/VCXWebLevelExploderGUI.css",1);b=true}},_switchMABDisplay:function(n){if(typeof n==="string"){if(this._currentMabVisibility!==n){this._currentMabVisibility=n;if(n==="stamp"){this._mabIsVisible=false;if(this._containerDiv){this._containerDiv.style.display="none"}}else{this._mabIsVisible=(n==="mobile");if(this._containerDiv){this._containerDiv.style.display=null;this._adaptSliderDimensionsToContext()}}}}else{console.warn("Typeof MAB Visibility has changed !!")}},_getSliderParameters:function(p){var o=function(q){return typeof q==="string"&&(/^rgb\(\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*\)$/.test(q)||/^rgba\(\s*\d{1,3},\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*\)$/.test(q)||/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(q))};Number.isInteger=Number.isInteger||function(q){return typeof q==="number"&&isFinite(q)&&Math.floor(q)===q};this._cursorColor=o(p.cursorColor)?p.cursorColor:"rgb(232, 123, 0)";this._sliderColor=o(p.sliderColor)?p.sliderColor:"rgb(66, 162, 218)";this._sliderLightColor=o(p.sliderLightColor)?p.sliderLightColor:"rgb(213, 232, 242)";this._nbStages=Number.isInteger(p.stagesNb)?p.stagesNb:1;if(this._nbStages===1){var n=function n(q){return q.sort().filter(function(s,r,t){return(!r||s!==t[r-1])&&(s>=0&&s<=1)})};this._ticks=Array.isArray(p.ticks)?n(p.ticks):[];this._tickColor=o(p.tickColor)?p.tickColor:"rgb(0, 21, 255)";this._tickWidth=Number.isInteger(p.tickWidth)?p.tickWidth:2;this._tickHeight=Number.isInteger(p.tickHeight)?p.tickHeight:5}this._width=Number.isInteger(p.width)?p.width:this._defaultWidth;this._height=this._mabIsVisible?this._defaultHeight.mab:Number.isInteger(p.height)?p.height:this._defaultHeight.classic;this._gapLength=Number.isInteger(p.gapLength)?p.gapLength:this._defaultGapLength;this._sliderWidth=this._width-(this._buttonWidth+this._divsGap);this._ratio=this._height/this._sliderWidth;this._widthStage=Math.floor((this._sliderWidth-((this._nbStages-1)*this._gapLength))/this._nbStages);return{stages:this._nbStages,ticks:this._ticks,tickColor:this._tickColor,tickWidth:this._tickWidth,tickHeight:this._tickHeight,width:this._width,sliderWidth:this._sliderWidth,height:Number.isInteger(p.height)?p.height:this._defaultHeight.classic,gapLength:this._gapLength,cursorColor:this._cursorColor,sliderColor:this._sliderColor}},remove:function(){for(var q=0;q<this._nbStages;q++){var p=document.getElementById("VCXPartSliderStage"+q);if(p){this._events.stages[q]&&p.removeEventListener(this._events.stages[q].evtType,this._events.stages[q].callback);p.remove()}}this.onResizeToken&&d.unsubscribe(this.onResizeToken);this.onResizeToken=null;this._onDragToken&&f.removeEventFromToken(this._onDragToken);this._onDragToken=null;this._onSpreadToken&&f.removeEventFromToken(this._onSpreadToken);this._onSpreadToken=null;var o=this._experienceBase.getManager("VCXContextManager");var r=o.getFrameWindow();var n=r.getActionBar().MAB;if(n){n.onVisibilityChangeUnsubscribe("ExplodePartSlider")}this.button.remove();this.button=null;this.partSliderStages.remove();this.partSliderStages=null;this._containerDiv.remove();this._containerDiv=null;this._triangle=null},_adaptSliderDimensionsToContext:function(){if(!(this._initOptions&&this._containerDiv)){return}var n=this._experienceBase.getManager("VCXContextManager").getMainViewer().div.clientWidth;this._updateContainerDimsGivenWidth((n>600)?this._initOptions.width:0.6*n)},_updateContainerDimsGivenWidth:function(F){if(F){this._width=Math.min(F,this._initOptions.width)}this._padding=this._mabIsVisible?0:this._defaultPadding;var z=this._containerDiv.parentElement;var A=this._experienceBase.getManager("VCXContextManager");var s=A.getFrameWindow();var u=s.getActionBar().MAB;var o=A.getUIFrame();var q=0;if(this._mabIsVisible){if(z===o){if(this.button.classList.contains("wux-afr-cmdstarter")){this.button.classList.remove("wux-afr-cmdstarter")}this._containerDiv.removeAttribute("style");u.showCustomFlyout(1,this._containerDiv)}if(this._containerDiv.parentElement.className.includes("PlayWeb-MAB-flyout")&&this._containerDiv.parentElement.style.overflowX!=="visible"){this._containerDiv.parentElement.style.overflowX="visible";this._containerDiv.parentElement.style.overflowY="visible"}q=parseFloat(window.getComputedStyle(this._containerDiv.parentElement).getPropertyValue("width"));this._sliderWidth=q-(this._buttonWidth+2*this._divsGap);this._height=this._defaultHeight.mab;this._gapLength=0}else{if(z!==o){if(z.className.includes("PlayWeb-MAB-flyout")){this._containerDiv.parentElement.style.overflowX=null;this._containerDiv.parentElement.style.overflowY=null}if(!this.button.classList.contains("wux-afr-cmdstarter")){this.button.classList.add("wux-afr-cmdstarter")}this._containerDiv.removeAttribute("style");o.appendChild(this._containerDiv)}var H=this._width+2*this._padding;this._containerDiv.set({styles:{width:H+"px",marginLeft:(A.getMainViewer().div.clientWidth-H)*0.5+"px"}});q=this._width;this._sliderWidth=q-(this._buttonWidth+this._divsGap);this._height=this._initOptions.height;var w=this._sliderWidth/this._initOptions.sliderWidth;this._gapLength=Math.round(this._initOptions.gapLength*w)}var w=this._sliderWidth/this._initOptions.sliderWidth;this._widthStage=Math.floor((this._sliderWidth-((this._nbStages-1)*this._gapLength))/this._nbStages);this._ratio=this._height/this._sliderWidth;if(this.partSliderStages){var E;for(E=0;E<this._nbStages;++E){var r=document.getElementById("VCXPartSliderStage"+E);if(r){this._events.stages[E]&&r.removeEventListener(this._events.stages[E].evtType,this._events.stages[E].callback);r.remove()}}var C=0;var B=0;for(E=0;E<this._nbStages;++E){var t=(E===0)?0:this._gapLength*0.5;var n=(E===(this._nbStages-1))?0:this._gapLength*0.5;C=(E===0)?0:C+Math.floor((this._widthStage+t*2)*this._ratio);B=C+Math.floor(this._widthStage*this._ratio);var G=this._buildStage(E,this._height-B,B-C,C,this._widthStage,t,n);G.inject(this.partSliderStages);this._fctPickStage=(this._nbStages===1||this._mabIsVisible)?this._onPickUniqueStage():this._onPickStage(E);G.addEventListener(i.POINTERDOWN,this._fctPickStage);this._events.stages[E]={evtType:i.POINTERDOWN,callback:this._fctPickStage}}this.partSliderStages.setStyle("width",this._sliderWidth+"px");this.partSliderStages.setStyle("height",this._height+"px");var p=this._mabIsVisible?"mab":"classic";this._cursorSize.width=this._defaultCursorSize[p].width;this._cursorSize.height=this._defaultCursorSize[p].height;var y=this._cursorPos2PixelInSlider(this._currentPos);var x=(y/this._sliderWidth);var v=this._cursorBottomAt0+x*this._height;var D=(x*100)+"%";this._triangle.set({styles:{borderWidth:this._cursorSize.height+"px "+this._cursorSize.width+"px 0px "+this._cursorSize.width+"px",marginLeft:"-"+this._cursorSize.width+"px",bottom:v+"px",left:D+"px"}})}},getCursorPos:function(){return this._currentPos},setCursorPos:function(n){this._onChangeCursorPos(this._cursorPos2PixelInSlider(n))},setCursorPosWithTransition:function(n){this._onChangeCursorPosWithTransi(this._cursorPos2PixelInSlider(n))},addElementToSliderDiv:function(n){n.inject(this._containerDiv)},subscribe:function(n,o){return this._modelEvent.subscribe({event:n},o)},unsubscribe:function(n){this._modelEvent.unsubscribe(n)},_buildCursor:function(){var n=4;if(!this._mabIsVisible){this._cursorSize.width=this._defaultCursorSize.classic.width;this._cursorSize.height=this._defaultCursorSize.classic.height}else{this._cursorSize.width=this._defaultCursorSize.mab.width;this._cursorSize.height=this._defaultCursorSize.mab.height}this._triangle=g.createElement("div",{html:"",id:"partSliderCursor",styles:{bottom:n+"px",borderWidth:this._cursorSize.height+"px "+this._cursorSize.width+"px 0px "+this._cursorSize.width+"px",borderColor:this._cursorColor+"transparent transparent transparent",marginLeft:"-"+this._cursorSize.width+"px"}});this._triangle.inject(this.partSliderStages)},setRestoreButton:function(p){var n="restore";var o="icons/32/I_VCX_ExplLvlRestoreButton.png";return this._setButton(p,n,o)},setBackButton:function(p){var n="back";var o="icons/32/I_VCX_ExplLvlBackButton.png";return this._setButton(p,n,o)},_setButton:function(q,o,p){this.button.removeEvent(i.POINTERDOWN);this._buttonWidth=this._defaultButtonWidth;this.button.set({"class":o+"Button",title:this._getButtonString(o),styles:{height:this._buttonWidth+"px",}});var r=this;if(!h[o].imgLoaded){var n=new Image();n.onload=function(){r.button.set({styles:{backgroundImage:"url("+this.src+")"}});h[o].imgLoaded=true;r._updateContainerDimsGivenWidth(r._width)};n.src=e.getWebappsAssetUrl("VCXWebLevelExploderGUI",p)}else{r.button.set({styles:{backgroundImage:"url("+e.getWebappsAssetUrl("VCXWebLevelExploderGUI",p)+")"}})}this.button.classList.add("wux-afr-cmdstarter");this.button.addEvent(i.POINTERDOWN,q);return this.button},_getButtonString:function(s){var n="VCXWebLevelExploderGUI/VCXWebLevelExploderGUI",r="VCXPartSlider: Could not recover a string for a text in the current language.",p,q;if(s==="back"){p="PreviousLevelButton";q="Go back to last exploded view."}else{if(s==="restore"){p="RestoreModelButton";q="Restore exploded model to its original state."}else{return null}}if(!h[s].msgFound){var o=null;m.onResourceLoaded({resourceFile:n},function(){o=this.getTitle({key:p})});m.loadResource({resourceFile:n});if(o){h[s].msg=o;h[s].msgFound=true}else{h[s].msg=q;if(!h[s].errorDisplayed){console.log(r);h[s].errorDisplayed=true}}}return h[s].msg},_subscribeToGestureEvents:function(){var p=this;var o=this._experienceBase.getManager("VCXContextManager").getMainViewer();if(this._onDragEventAvailable){this._ondragCB=function n(u){p._stopCursorAnimation();var t=u.from[0].type;var r=(t==="Mouse")?u.from[0].event:(t==="Touch")?u.from[0].event.changedTouches[0]:null;var q=new k.Vector2(r.pageX,r.pageY);var v=p._getSliderPositionLeft();var w=q.x-v;var s=(u.state==="end");p._onChangeCursorPos(w,s)};this._onDragToken=f.addEvent(this.partSliderStages,"onDrag",this._ondragCB)}else{this._triangle.addEvent(i.POINTERDOWN,function(){p._fctDragEnd=p.onDragEnd(p);p._fctDrag=function(q){q.preventDefault();var r=p._getSliderPositionLeft();var s=q.pageX-r;p._onChangeCursorPos(s)};document.removeEventListener(i.POINTERMOVE,p._fctDrag);document.removeEventListener(i.POINTERUP,p._fctDragEnd);document.addEventListener(i.POINTERMOVE,p._fctDrag);document.addEventListener(i.POINTERUP,p._fctDragEnd)})}this._onSpreadCB=function(q){var s=q.gesture.distance-q.gesture.lastDistance;var r=s*p._nbStages/600+p._currentPos;p._onChangeCursorPos(p._cursorPos2PixelInSlider(r))};this._onSpreadToken=f.addEvent(o.canvas,"onSpread",this._onSpreadCB)},_stopCursorAnimation:function(){if(this._cursorTransi!==null){clearInterval(this._cursorTransi);this._cursorTransi=null}},_buildStage:function(x,C,t,p,y,v,D){var B=g.createElement("div",{id:"VCXPartSliderStage"+x,"class":"stage",styles:{marginLeft:v+"px",marginRight:D+"px",width:y+"px"}});var E=B.getStyleName("float");B.setStyle(E,"left");if(C!==0){var n=g.createElement("div",{"class":"blankSpace",styles:{height:C+"px"}});n.inject(B)}var z=this;var s=function(K,G){var H=G;if(typeof H!=="number"){H=parseInt(G)}var L=(H===0);var M=(H===z._nbStages-1);var I,O,J,P,R;switch(K){case"border":case"filler":if(K==="border"){R=y+"px";P=t+"px"}else{if(K==="filler"){var Q=Math.floor(z._currentPos);if(Q>G){R=y+"px";P=t+"px"}else{if(Q<G){R="0px";P="0px"}else{R=((z._currentPos%1)*y)+"px";P=((z._currentPos%1)*t)+"px"}}}}break;case"background":O="1px";P=(L?t-2:t)+"px";if(z._mabIsVisible&&z._nbStages!==1){I=L?Math.floor(2/z._ratio)+"px":"0px";R=(L?y-Math.floor(2/z._ratio):M?y-1:y)+"px"}else{I=L?Math.floor(2/z._ratio)-1+"px":"1px";R=(L?y-Math.floor(2/z._ratio):y-2)+"px"}break;default:break}var N=g.createElement("div",{"class":"triangle",styles:{left:I,borderWidth:P+" "+R+" 0 0"}});if(O){N.style.top=O}else{if(J){N.style.bottom=J}}return N};var F=function(K,N){var J=(x===z._nbStages-1);var M,H,L;switch(K){case"border":case"filler":M=z._sliderColor;H=p+"px";if(K==="border"){L=y+"px"}else{if(K==="filler"){var G=Math.floor(z._currentPos);if(G>N){L=y+"px"}else{if(G<N){L="0px"}else{L=((z._currentPos%1)*y)+"px"}}}}break;case"background":M=z._sliderLightColor;H=p-2+"px";if(z._mabIsVisible&&z._nbStages!==1){L=(J?y-1:y)+"px"}else{L=y-2+"px"}break;default:break}var I=g.createElement("div",{"class":"base",styles:{background:M,width:L,height:H}});return I};var r=["border","background","filler"];for(var w=0;w<r.length;++w){var o=r[w];var u=g.createElement("div",{"class":o,styles:{width:y+"px"}});if(o==="filler"){u.style.bottom="0px"}var A=s(o,x);A.inject(u);if(p!==0){var q=F(o,x);q.inject(u)}u.inject(B)}return B},_build:function(){if(!this._containerDiv){this._containerDiv=g.createElement("div",{html:"",id:"partSliderContainer"})}this.partSliderStages=g.createElement("div",{html:"",id:"partSliderStages",styles:{width:this._sliderWidth+"px",height:this._height+"px"}});this.partSliderStages.inject(this._containerDiv);var q={id:"partSliderButton","class":"wux-afr-cmdstarter",title:this._getButtonString("restore"),styles:{height:this._defaultButtonWidth+"px"}};this.button=g.createElement("div",q);this.button.inject(this._containerDiv);if(this._nbStages===1&&this._ticks.length>0){this._buildTicks(this._ticks)}var y=0;var p=0;var s;for(s=0;s<this._nbStages;++s){var x=(s===0)?0:this._gapLength*0.5;var u=(s===(this._nbStages-1))?0:this._gapLength*0.5;y=p+Math.floor(x*2*this._ratio);p=y+Math.floor(this._widthStage*this._ratio);var v=this._buildStage(s,this._height-p,p-y,y,this._widthStage,x,u);v.inject(this.partSliderStages)}var r=null;if(this._nbStages===1&&this._ticks.length>0){for(s=0;s<this._ticks.length;++s){r=document.getElementById("VCXPartSliderTickContainer"+s);if(r){this._fctPickStage=this._onPickTick(r,s);r.addEventListener(i.POINTERDOWN,this._fctPickStage);this._events.ticks[s]={evtType:i.POINTERDOWN,callback:this._fctPickStage}}}}for(s=0;s<this._nbStages;++s){r=document.getElementById("VCXPartSliderStage"+s);if(r){this._fctPickStage=(this._nbStages===1||this._mabIsVisible)?this._onPickUniqueStage():this._onPickStage(s);r.addEventListener(i.POINTERDOWN,this._fctPickStage);this._events.stages[s]={evtType:i.POINTERDOWN,callback:this._fctPickStage}}}var o=this._experienceBase.getManager("VCXContextManager");var t=o.getUIFrame();if(this._mabIsVisible){var z=o.getFrameWindow();var w=z.getActionBar().MAB;w.showCustomFlyout(1,this._containerDiv)}else{var n=this._width+2*this._padding;this._containerDiv.set({styles:{width:n+"px",bottom:this._defaultBottom+"px",marginLeft:(o.getMainViewer().div.clientWidth-n)*0.5+"px",padding:this._padding+"px"}});this._containerDiv.inject(t)}},_buildTicks:function(p){var q=Math.max(20,this._tickWidth);for(var n=0;n<p.length;++n){var r=g.createElement("div",{id:"VCXPartSliderTickContainer"+n,"class":"tickContainer",styles:{left:p[n]*this._sliderWidth-1+"px",width:q+"px",marginLeft:"-"+q*0.5+"px"}});if(!(p[n]===0||p[n]===1)){var o=g.createElement("div",{id:"VCXPartSliderInnerTick"+n,"class":"innerTick",styles:{marginTop:(1-p[n])*this._height+"px",height:Math.min(this._tickHeight,p[n]*this._height)+"px",width:this._tickWidth+"px",marginLeft:(q-this._tickWidth)*0.5+"px",backgroundColor:this._tickColor}});o.inject(r)}r.inject(this.partSliderStages)}},_onPickStage:function(o){var p=this;var n=function(r){r.preventDefault();var q=o+0.5;p._onChangeCursorPosWithTransi(p._cursorPos2PixelInSlider(q))};this._fctPickStage=n;return n},_onPickUniqueStage:function(){var o=this;var n=function(p){p.preventDefault();var q=o._getSliderPositionLeft();if(!q){return}var r=p.pageX-q;o._onChangeCursorPosWithTransi(r)};this._fctPickStage=n;return n},_onPickTick:function(o){var p=this;var n=function(s){s.preventDefault();var r=o.style.left.length;var q=p._pixelInSlider2CursorPos(parseInt(o.style.left.substr(0,r-2),10));p._onChangeCursorPosWithTransi(p._cursorPos2PixelInSlider(q))};this._fctPickStage=n;return n},_getContainerPositionLeft:function(){var o=document.getElementById("partSliderContainer");if(!o){return null}var n=o.getBoundingClientRect();return n.left},_getSliderPositionLeft:function(){var o=document.getElementById("partSliderStages");if(!o){return null}var n=o.getBoundingClientRect();return n.left},onDrag:function(o){var n=function(q){q.preventDefault();var r=o._getSliderPositionLeft();if(!r){return}var p=o._experienceBase.getManager("VCXContextManager").getMainViewer().canvas.getBoundingClientRect();var s=q.pageX-(p.left+r);o._onChangeCursorPos(s)};o._fctDrag=n;return n},onDragEnd:function(o){var n=function(){document.removeEventListener(i.POINTERMOVE,o._fctDrag);document.removeEventListener(i.POINTERUP,o._fctDragEnd);o._modelEvent.publish({event:"onChangeCursorPos",data:{eventChannel:"onChangeCursorPos",newCursorPos:o._currentPos,bReleased:true,end:true}})};return n},_getRealPos:function(q){if(q<0){return 0}else{if(q>this._sliderWidth){return this._sliderWidth}}var n=Math.floor(q/(this._widthStage+this._gapLength));var o=n*(this._widthStage+this._gapLength)+this._widthStage;var p=o+this._gapLength;if(q<=o){return q}else{if((q-o)<(p-q)){return o}else{return p}}},_cursorPos2PixelInSlider:function(q){var p=Math.floor(q);var n=q-p;var o=p*(this._widthStage+this._gapLength)+n*this._widthStage;return o},_pixelInSlider2CursorPos:function(q){var n=Math.floor(q/(this._widthStage+this._gapLength));var p=n*(this._widthStage+this._gapLength);var o=Math.min((q-p)/this._widthStage,0.999999);return n+o},_onChangeCursorPos:function(q,r){q=this._getRealPos(q);var o=(q/this._sliderWidth);var D=document.getElementById("partSliderCursor");if(D){var x=this._cursorBottomAt0;x+=o*this._height;D.style.left=(o*100)+"%";D.style.bottom=x+"px"}this._currentPos=this._pixelInSlider2CursorPos(q);var z=Math.floor(this._currentPos);var w=document.getElementsByClassName("filler");for(var A=0;A<w.length;++A){var p=w[A];var B=p.parentNode.id;var u=parseInt(B.replace("VCXPartSliderStage",""));var v=0;var n=0;var C=Math.floor(this._widthStage*this._ratio);if(z===u){v=(this._currentPos%1)*(this._widthStage+1);n=(this._currentPos%1)*C}else{if(this._currentPos>A){v=this._widthStage;n=C}}var t=p.childNodes;for(var s=0;s<t.length;++s){var y=t[s];if(y.className==="triangle"){y.style.borderRightWidth=v+"px";y.style.borderTopWidth=n+"px"}else{if(y.className==="base"){y.style.width=v+"px"}}}}this._modelEvent.publish({event:"onChangeCursorPos",data:{eventChannel:"onChangeCursorPos",newCursorPos:this._currentPos,bReleased:false,end:(typeof r==="boolean")?r:false}})},_onChangeCursorPosWithTransi:function(u){this._stopCursorAnimation();var t=this;var q=0;var n=t._cursorPos2PixelInSlider(this._currentPos);var s=new k.Clock();var p=function(C,x){var B=Math.floor(C*x);var v=s.getDelta();var y=v*C;q+=y;if(q>=B){q=B;clearInterval(t._cursorTransi);t._cursorTransi=null;s.stop()}var w=q/B;var A=n+(u-n)*w;var z=(w===1);t._onChangeCursorPos(A,z)};var r=60;var o=0.5;this._cursorTransi=setInterval(p,1000/r,r,o)}});return l});define("DS/VCXWebLevelExploderGUI/VCXLevelExploderManager",["DS/ApplicationFrame/CommandsManager","DS/CoreEvents/ModelEvents","DS/WebApplicationBase/W3AAManager"],function(b,c,d){var a=d.extend({init:function(){this._tokens={};this._setExplodeStateAllowed=true},initialize:function(){this._parent();this._levelExploderStruct={};this._rootPathsStack=[]},postInitialize:function(){this._parent();this._modelEvent=new c()},unInitialize:function(){this._parent();this._levelExploderStruct=null;this._rootPathsStack=null;this._explodeLvlCmd=null},setLoadHandling:function(e){if(typeof e==="boolean"){this._setExplodeStateAllowed=e}},getLoadHandling:function(){return this._setExplodeStateAllowed},getExplodeLevelState:function(){if(this._rootPathsStack.length===0){console.log("No cache available in LevelExploderManager yet.");return null}var f=this._cloneLevelExploderStruct(this._levelExploderStruct);var h=this._cloneRootPathsStack(this._rootPathsStack);var j=h.length-1;var g=h[j];var i=g.relativeRootPath&&g.relativeRootPath.getLastElement();var e=g.cursorPosition;return{basicInfos:{level:j,nodeRoot:i,cursorPosition:e},completeInfos:{structure:f,rootPathsStack:h}}},setExplodeLevelState:function(h){if(!this._setExplodeStateAllowed){console.warn("Currently using the original design of LevelExploder, thus setting of specific explode state currently denied.\nUse a call to VCXLevelExploderManager.setLoadHandling(true) to enable it.");return}var e=this._experienceBase.getManager("VCXContextManager");var g=e&&e.getContext();this._explodeLvlCmd=b.getCommand("EnhancedExplode",g)||b.getCommand("VCXLevelExploderGUICmd",g);if(!this._explodeLvlCmd){console.warn("Issue: No LevelExploder command has been found for this app.");return}var f=h;if(f.completeInfos){f=f.completeInfos}if(!(typeof f==="object"&&f.structure&&f.rootPathsStack)){console.warn("Issue: VCXLevelExploderManager.setExplodeLevelState() method needs an object as parameter, in the same form as the one given by a call to VCXLevelExploderManager.getExplodeLevelState() method.");return}this._levelExploderStruct=this._cloneLevelExploderStruct(f.structure);this._rootPathsStack=this._cloneRootPathsStack(f.rootPathsStack);this._explodeLvlCmd.restoreSetState(f.structure,f.rootPathsStack,false)},subscribeToStateChanges:function(e){return this._modelEvent.subscribe({event:"LevelExplodeChanges"},e)},unsubscribeFromStateChanges:function(e){this._modelEvent.unsubscribe(e)},bothStatesAreTheSame:function(o,m){if(!o||!m){return false}var i=o.completeInfos.rootPathsStack;var h=m.completeInfos.rootPathsStack;if(!i||!h){return false}if(i.length!==h.length){return false}for(var e=0;e<i.length;++e){var k=i[e];var j=h[e];var n=k.relativeRootPath;var l=j.relativeRootPath;if(!n.isEqual(l)){return false}var g=k.cursorPosition;var f=j.cursorPosition;if(g!==f){return false}}return true},bothStatesShareCurrentSubExplode:function(n,l){if(!n||!l){return false}var j=n.completeInfos.rootPathsStack;var f=j[j.length-1];var i=l.completeInfos.rootPathsStack;var e=i[i.length-1];var m=f.relativeRootPath;var k=e.relativeRootPath;if(!m.isEqual(k)){return false}var h=f.cursorPosition;var g=e.cursorPosition;if(h!==g){return false}return true},recordState:function(f){if(!f){return}var l=false;if(f.levelExploderStruct){for(var e in f.levelExploderStruct){if(f.levelExploderStruct.hasOwnProperty(e)){var n=f.levelExploderStruct[e];if(!this._levelExploderStruct[e]){this._levelExploderStruct[e]={}}var j=Object.keys(n).length;for(var h=j-1;h>=0;--h){if(this._levelExploderStruct[e][h]){break}else{this._levelExploderStruct[e][h]=n[h]}}}}}if(f.rootPathsStack){var i=null;if(!f.cursorChangeOnly){this._rootPathsStack=[];for(var g=0;g<f.rootPathsStack.length;++g){var m=f.rootPathsStack[g].relativeRootPath;i=f.rootPathsStack[g].cursorPosition;this._rootPathsStack.push({relativeRootPath:m,cursorPosition:i})}l=true}else{i=f.rootPathsStack[f.rootPathsStack.length-1].cursorPosition;this._rootPathsStack[this._rootPathsStack.length-1].cursorPosition=i;l=true}}if(l){var k={eventChannel:"LevelExplodeChanges",isManualManipulation:false,cursorPosition:this._rootPathsStack[this._rootPathsStack.length-1].cursorPosition};if(!f.cursorChangeOnly){k.rootPath=this._rootPathsStack[this._rootPathsStack.length-1].relativeRootPath}this._modelEvent.publish({event:"LevelExplodeChanges",data:k})}},_publishVolatileManipEvent:function(g,h,f){var e={eventChannel:"LevelExplodeChanges",isManualManipulation:true,component:g,nodePath:h,localPosition:f};this._modelEvent.publish({event:"LevelExplodeChanges",data:e})},_cloneLevelExploderStruct:function(g){var f={};for(var i in g){if(g.hasOwnProperty(i)){f[i]={};for(var h in g[i]){if(g[i].hasOwnProperty(h)){if(!g[i][h]){console.warn("There should be a true boolean-evaluated-value here, either number or object");continue}var e=(typeof g[i][h]==="number")?g[i][h]:Object.keys(g[i][h]).length;f[i][h]=e}}}}return f},_cloneRootPathsStack:function(f){var h=[];for(var i=0;i<f.length;++i){var e=f[i];var g=e.relativeRootPath.clone();var j=e.cursorPosition;h.push({relativeRootPath:g,cursorPosition:j})}return h}});Object.defineProperty(a.prototype,"componentType",{enumerable:true,get:function(){return"VCXLevelExploderManager"}});return a});define("DS/VCXWebLevelExploderGUI/VCXLevelExploderGUICmd",["UWA/Core","DS/Core/PointerEvents","DS/CoreEvents/Events","DS/ApplicationFrame/Command","DS/ApplicationFrame/CommandsManager","DS/ApplicationFrame/FrameWindowsManager","DS/Manipulators/ScreenPlaneManipulator","DS/VCXWebExperienceBase/VCXSceneGraphOverridesServices","DS/VCXWebExperienceBase/VCXOverridesChangeServices","DS/VCXWebLevelExploderKernel/VCXLevelExploderKernelServices","DS/VCXWebLevelExploderGUI/VCXPartSlider","DS/VCXWebModifiablesServices/VCXModifiablesAccess","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/VisuEvents/EventsManager"],function(i,l,f,e,c,j,m,d,b,k,p,o,n,h,g){var a=e.extend({init:function(r){this._parent(r,{mode:"exclusive",isAsynchronous:true});this.neverLaunched=true;this._experienceBase=null;this._vcxPartSlider=null;this._levelExploderStruct=null;this._rootPathsStack=null;this._overrideSetStack=null;this._manipulationOverrideSet=null;this._moveableElManipulators=null;this._elementInfoBeforeManip=null;this._componentInitFrames={};this.PRODUCT_TYPES=k.PRODUCT_TYPES;this._tokenBackTrigger=null;this._tokenCursorPosUpdate=null;var u=this.getFrameWindow()||j.getFrameWindow(r.context);var t=u&&u.getViewer();var v=this;var q=t&&t.canvas;if(q){var s=function(){if(!c._getCurrent(r.context)&&!(v.isRunning())){v.begin()}};this._onSpreadToken=g.addEvent(u.getViewer().canvas,"onSpread",s)}else{console.warn("Feature to execute levelExploder cmd from onSpread gesture could not be initialized...")}this._tokenModelLoaded=u.experience&&u.experience.subscribe("ASSET/LOADINGFINISHED",function(){v._experienceBase=u._experienceBase;var x=v._experienceBase&&v._experienceBase.getManager("VCXContextManager");var A=x&&x.getRootPathElement().clone();if(!A){return}var y=A&&v._getExplodeRootPath(A);if(!y){v.disable();v._levelExploderStruct=null;v._rootPathsStack=null;v._overrideSetStack=null}else{if(!v.isEnabled()){v.enable()}var w=v._experienceBase&&v._experienceBase.getManager("VCXLevelExploderManager");if(!w){return}v.neverLaunched=true;v._rootPathsStack=[];var z={relativeRootPath:y,cursorPosition:0};v._rootPathsStack.push(z);v._levelExploderStruct={};var B=y.getLastElement();var C=k._getStagesInfo(B);v._ignoredStagesIdxs=C.discardedStagesIdxs;v._levelExploderStruct[B.id]=[v._getStage(y,0)];w.recordState({rootPathsStack:v._rootPathsStack,levelExploderStruct:v._levelExploderStruct})}})},destroy:function(){var r=this.getFrameWindow();var q=r&&r.experience;if(!q){return}if(this.isRunning()){this.endExecute()}this._tokens=null;this._tokenModelLoaded&&q.unsubscribe(this._tokenModelLoaded);this._onSpreadToken&&g.removeEventFromToken(this._onSpreadToken);this._tokenModelLoaded=null;this._onSpreadToken=null},execute:function(){this._parent();var z=this;var x=this.getFrameWindow();this._experienceBase=x._experienceBase;var r=this._experienceBase.getManager("VCXContextManager");this._viewer=r.getMainViewer();this._levelExploderManager=this._experienceBase.getManager("VCXLevelExploderManager");this._overrideSetStack=[];var C=(this._levelExploderManager&&this._levelExploderManager.getLoadHandling())?this._levelExploderManager.getExplodeLevelState():null;if(C&&C.completeInfos){C=C.completeInfos}if(!this.neverLaunched&&C&&C.rootPathsStack.length>0){this.restoreSetState(C.structure,C.rootPathsStack,true);this._subscribeToSliderEvents()}else{var t=r.getRootPathElement().clone();var w=this._getExplodeRootPath(t);if(!w){this.end();return}this._rootPathsStack=[];var A={relativeRootPath:w,cursorPosition:0.5};this._rootPathsStack.push(A);var y=w.getLastElement();if(this._vcxPartSlider===null){var v=k._getStagesInfo(y);var u=v.nbOfStages;if(u===0){console.warn("No stages found. End of the command.");this.end();return}this._ignoredStagesIdxs=v.discardedStagesIdxs;var q={stagesNb:u};this._vcxPartSlider=new p(this._experienceBase,q);this._subscribeToSliderEvents()}var B=d.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer);B.name="SGOverrideSet ExplodeLvl0";B.explodeRootPath=w;this._overrideSetStack.push(B);this._levelExploderManager&&this._levelExploderManager.recordState({rootPathsStack:this._rootPathsStack});this.initializeFirstExplode()}this._doublePointerClickCB=function s(E){var D=o.GetPathElementFromEvent(E,z._experienceBase);if(D){z._onChangeLevelCB(D)}};g.addEvent(this._viewer.canvas,"onPrimaryPointerDoubleClick",this._doublePointerClickCB);this.neverLaunched=false;if(!this._tokens){this._tokens={}}this._tokens.pointerDownToken=f.subscribe({event:"/VISU/onPrimaryPointerDown"},this._onPointerDownCB.bind(this))},initializeFirstExplode:function(){if(!this._vcxPartSlider){return}var r=this._rootPathsStack[0].relativeRootPath;this._updateExplode(0.5,true);var q=r.getBoundingSphere(this._viewer);this._updateExplode(0,true);this._vcxPartSlider.setCursorPosWithTransition(0.5);this.getFrameWindow().getViewpoint().reframe(null,500,q)},restoreSetState:function(q,x,E){if(!(q&&x)){return}var C;var F;for(C=0;C<x.length;++C){F=x[C].relativeRootPath;var y=F.getLastElement();if(!q[y.id]){console.warn("Something has wrong with the consistency of the infos given in parameter of the current method...");return}}if(!E){this._resetExplode()}this._levelExploderStruct={};var s=x.slice();this._overrideSetStack=[];var D=this._viewer.getSceneGraphOverrideSetManager();var A=D.getNumberOfSceneGraphOverrideSets();for(var B=A-1;B>=0;--B){var G=D.getSceneGraphOverrideSetAt(B);if(G&&G.name&&G.name.includes("SGOverrideSet Explode")){D.removeSceneGraphOverrideSet(G)}}this._rootPathsStack=[];for(C=0;C<s.length;++C){F=s[C].relativeRootPath;var r=s[C].cursorPosition;this._rootPathsStack[C]={relativeRootPath:F,cursorPosition:0};var w=F&&F.getLastElement();var v=k._getStagesInfo(w);var u=v.nbOfStages;this._ignoredStagesIdxs=v.discardedStagesIdxs;var t=d.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer);t.name="SGOverrideSet ExplodeLvl"+C;t.explodeRootPath=F;this._overrideSetStack.push(t);if(this.isRunning()){this._isolate(F)}this._updateExplode(r);if(this.isRunning()){var z=(C===s.length-1);if(z){this._updateSlider(u,r)}}}this.neverLaunched=false},isExplodable:function(q){return Boolean(this._getExplodeRootPath(q))},_getExplodeRootPath:function(F){var v=F.clone();var E=F.getLastElement();var x=k.doesNodeHasProductTypeValue(E)?E:null;var t=null;var q=null;if(!x){q=[E];while(!x&&q.length!==0){var z=[];var A=[];for(var w=0;w<q.length;++w){var r=q[w];for(var s=0;s<r.children.length;++s){t=r.children[s];if(k.doesNodeHasProductTypeValue(t)){if(k.doesNodeHasProductTypeValue(t,this.PRODUCT_TYPES.INSTANCE)||k.doesNodeHasProductTypeValue(t,this.PRODUCT_TYPES.REFERENCE)){A.push(t)}z.push(t)}}if(A.length===1){if(!x){x=A[0]}else{console.log("explodeRootNode already found on another branch from root.. the case of multi-explodeRoot nodes is not supported")}}else{if(A.length>1){if(!x){x=r}else{console.log("explodeRootNode already found on another branch from root.. the case of multi-explodeRoot nodes is not supported")}}}}q=z}if(q.length===0){console.warn("No node has been found as decent candidate for the root of the explode for current model.");return null}}var B=false;while(!B&&x.children.length>0){q=x.children;var D=[];t=null;if(k.doesNodeHasProductTypeValue(q[0],this.PRODUCT_TYPES.REFERENCE)){q=x.children[0].children}for(var y=0;y<q.length;++y){t=q[y];if(k.doesNodeHasProductTypeValue(t,this.PRODUCT_TYPES.INSTANCE)){D.push(t)}}if(D.length===1){x=D[0]}else{if(D.length===0){return null}else{B=true}}}var u=x;var C=[];while(u!==E){C.push(u);u=u.parents[0]}while(C.length!==0){v.addElement(C.pop())}return v},pauseExecute:function(){},resumeExecute:function(){},endExecute:function(){this._parent();this._unsubscribeToSliderEvents();g.removeEvent(this._viewer.canvas,"onPrimaryPointerDoubleClick",this._doublePointerClickCB);this._removeTemporaryChanges();var q=this._experienceBase.getManager("VCXLevelExploderManager");if(q){q.recordState({rootPathsStack:this._rootPathsStack,levelExploderStruct:this._levelExploderStruct});if(!q.getLoadHandling()){this._resetExplode()}else{this._isolate(this._rootPathsStack[0].relativeRootPath);this._unghostAll()}}else{this._resetExplode()}if(this._vcxPartSlider!==null){this._vcxPartSlider.remove();this._vcxPartSlider=null}if(this._tokens.pointerDownToken){f.unsubscribe(this._tokens.pointerDownToken);this._tokens.pointerDownToken=null}},_resetExplode:function(){if(this._overrideSetStack&&this._overrideSetStack.length>0){this._removeTemporaryChanges();for(var r=this._rootPathsStack.length-1;r>0;--r){var t=true;this._onBackTriggerCB(t)}if(this._overrideSetStack){if(this._overrideSetStack.length!==1){console.warn("Something has gone wrong with the _overrideSetStack member")}else{var s=this._overrideSetStack.pop();var q=d.removeSceneGraphOverrideSet(this._experienceBase,s,this._viewer);!q&&console.warn("Something has gone wrong with the removal of exec overrideSet")}}if(!(this._rootPathsStack&&this._rootPathsStack.length>0)){console.warn("There should have been a path available in this array..")}this._updateGroundIfExistsAndRender()}},_updateLvlExplStruct:function(t,s){var q=t;if(!q){q=this._rootPathsStack[this._rootPathsStack.length-1].relativeRootPath}var u=q.getLastElement();var r=s;if(!r){r=0}if(!(this._levelExploderStruct)){this._levelExploderStruct={}}if(!this._levelExploderStruct[u.id]){this._levelExploderStruct[u.id]=[]}this._levelExploderStruct[u.id][r]=this._getStage(q,r);this._levelExploderManager&&this._levelExploderManager.recordState({levelExploderStruct:this._levelExploderStruct})},_getStage:function(u,v){var x=this;var t=0;for(var r=0;r<this._ignoredStagesIdxs.length&&this._ignoredStagesIdxs[r]<=v;++r){++t}var q;var s=function s(B,G,F){for(var C=0;C<B.children.length;C++){var z=B.children[C];if(k.doesNodeHasProductTypeValue(z,x.PRODUCT_TYPES.INSTANCE_REP,true)){var E=G.clone();E.addElement(z);var A=F;if(k.doesNodeHasProductTypeValue(z,x.PRODUCT_TYPES.INSTANCE)){var y=A-t;if(y===v){var D=x._experienceBase.ComponentsMap.GetComponentFromPathElement(E);if(!D){return}x.saveInitPositionWithOverrideSet(D);if(q===undefined){q={}}q[D.GetID()]={pathElement:E,component:D,initCenterPosInWCS:E.getBoundingSphere(x._viewer).center,maxTranslationVect:null}}++A}s(z,E,A)}}};var w=u.getLastElement();s(w,u,0);k.updateMapWithTranslationsVectors(q,this._viewer);return q},_updateExplode:function(w,t){var v=this;var u=false;var x=-1;var A=this._rootPathsStack[this._rootPathsStack.length-1].cursorPosition;var B=Math.floor(w);var C=w-B;var r=Math.floor(A);var s=A-r;this._removeTemporaryChanges();var z=this._rootPathsStack[this._rootPathsStack.length-1].relativeRootPath;var y=z.getLastElement();if(!(this._levelExploderStruct)||!(this._levelExploderStruct[y.id])){this._updateLvlExplStruct(z)}var q=function q(D,F){if(!(v._levelExploderStruct[y.id][D])){v._updateLvlExplStruct(z,D)}var E;var G;if(D===r){E=s}else{E=F?0:1}if(D===B){G=C;if(D!==r){u=true}}else{G=F?1:0}v._updateStageExplode(D,E,G)};if(A<w){for(x=r;x<=B;++x){q(x,true)}}else{if(A>w){for(x=r;x>=B;--x){q(x,false)}}}this._rootPathsStack[this._rootPathsStack.length-1].cursorPosition=w;this._levelExploderManager&&this._levelExploderManager.recordState({rootPathsStack:this._rootPathsStack,cursorChangeOnly:true});if(!t){this._updateGroundIfExistsAndRender()}},_updateStageExplode:function(q,A,z){var x=this._rootPathsStack[this._rootPathsStack.length-1].relativeRootPath;var u=x.getLastElement();var s=this._levelExploderStruct[u.id][q];for(var r in s){if(s.hasOwnProperty(r)){var w=s[r].component;var t=this._overrideSetStack[this._overrideSetStack.length-1];var v=s[r].maxTranslationVect.clone();var y=v.clone().multiplyScalar(z);this.restoreInitPositionWithOverrideSet(w,t);this.translateWithOverrideSet(w,y,t)}}},_onChangeCursorPosCB:function(q){this._updateExplode(q.newCursorPos)},_removeTemporaryChanges:function(){if(!this._manipulationOverrideSet){return}var q=d.removeSceneGraphOverrideSet(this._experienceBase,this._manipulationOverrideSet,this._viewer);if(q){this._manipulationOverrideSet=null}},_subscribeToSliderEvents:function(){if(this._vcxPartSlider!==null){var q=this;this._tokenCursorPosUpdate=this._vcxPartSlider.subscribe("onChangeCursorPos",function(r){q._onChangeCursorPosCB(r)})}},_unsubscribeToSliderEvents:function(){if(this._vcxPartSlider===null){this._tokenCursorPosUpdate=null;this._tokenBackTrigger=null;return}if(this._tokenCursorPosUpdate!==null){this._vcxPartSlider.unsubscribe(this._tokenCursorPosUpdate);this._tokenCursorPosUpdate=null}},_onChangeLevelCB:function(y){var A=this;var C=this._rootPathsStack[this._rootPathsStack.length-1].relativeRootPath;var B=C.getLastElement();var w=this._rootPathsStack[this._rootPathsStack.length-1].cursorPosition;var z=Math.floor(w);for(var v=0;v<this._ignoredStagesIdxs.length;++v){if(z>=this._ignoredStagesIdxs[v]){++z}else{break}}++z;var D=this._viewer.getRootNode();var E=function E(I){if(I.id===0||I.id===1){return false}var H=I;for(var G=0;G<z;++G){if(H&&k.doesNodeHasProductTypeValue(H,A.PRODUCT_TYPES.INSTANCE)&&(k.doesNodeHasProductTypeValue(H.parents[0],A.PRODUCT_TYPES.INSTANCE)||H.parents[0].parents[0]===D)){H=H.parents[0]}else{if(H&&(k.doesNodeHasProductTypeValue(H,A.PRODUCT_TYPES.REFERENCE)||k.doesNodeHasProductTypeValue(H.parents[0],A.PRODUCT_TYPES.REFERENCE))){if(H.parents[0]){H=H.parents[0].parents[0]}}}if(!H||H.id===0||H.id===1){return false}}if(H){return(H.id===B.id)}return false};var s=y.getSubPath(E);var q=s&&this._getExplodeRootPath(s);if(!q){console.warn("No new root found. Diving cancelled.");return}var u=q.getLastElement();var x=k._getStagesInfo(u);var t=x.nbOfStages;if(t===0){console.warn("No stages found. Diving cancelled.");return}this._ignoredStagesIdxs=x.discardedStagesIdxs;var F=d.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer);F.name="SGOverrideSet ExplodeLvl"+this._rootPathsStack.length;F.explodeRootPath=q;this._overrideSetStack.push(F);this._updateExplode(w);var r={relativeRootPath:q,cursorPosition:0};this._rootPathsStack.push(r);this._levelExploderManager&&this._levelExploderManager.recordState({rootPathsStack:this._rootPathsStack});this._isolate(q);this._updateSlider(t,0);this._reframeWithPath(q)},_onBackTriggerCB:function(v){var y=this._overrideSetStack.pop();var z=d.removeSceneGraphOverrideSet(this._experienceBase,y,this._viewer);!z&&console.warn("Something has gone wrong with the removal of exec overrideSet");var w=this._rootPathsStack.pop();var r=w.relativeRootPath.getLastElement();delete this._levelExploderStruct[r.id];if(this.isRunning()){var t=this._rootPathsStack[this._rootPathsStack.length-1].relativeRootPath;var u=t.getLastElement();var x=this._rootPathsStack[this._rootPathsStack.length-1].cursorPosition;var s=k._getStagesInfo(u);var q=s.nbOfStages;this._ignoredStagesIdxs=s.discardedStagesIdxs;this._updateSlider(q,x,false);if(!v){this._reframeWithPath(t)}this._levelExploderManager&&this._levelExploderManager.recordState({rootPathsStack:this._rootPathsStack})}},_onRestoreTriggerCB:function(){var q=this._rootPathsStack[this._rootPathsStack.length-1].cursorPosition;if(q!==0){this._vcxPartSlider.setCursorPosWithTransition(0)}},_isolate:function(r){var t=this._rootPathsStack[0].relativeRootPath;var v=this._overrideSetStack[this._overrideSetStack.length-1];var u=k.getLeafGeometriesPathsUnderPath(t);var s=0;for(s=0;s<u.length;++s){b.Ghost(v,u[s])}var q=k.getLeafGeometriesPathsUnderPath(r);for(s=0;s<q.length;++s){b.UnGhost(v,q[s])}this._experienceBase.getManager("VCXContextManager").renderAll()},_unghostAll:function(){var s=this._rootPathsStack[0].relativeRootPath;var r=k.getLeafGeometriesPathsUnderPath(s);for(var q=this._overrideSetStack.length-1;q>=0;--q){var u=this._overrideSetStack[q];for(var t=0;t<r.length;++t){b.UnGhost(u,r[t])}}},_reframeWithPath:function(q,s){var r=s;if(!r||typeof r!=="number"||r<0){r=200}this._viewpoint=this.getFrameWindow().getViewpoint().reframe(null,r,q.getBoundingSphere(this._viewer))},_updateSlider:function(t,r){var u=r;if(typeof u!=="number"){u=0}if(this._vcxPartSlider){this._unsubscribeToSliderEvents();this._vcxPartSlider.remove()}var s=(this._rootPathsStack.length>1);var q={stagesNb:t};this._vcxPartSlider=new p(this._experienceBase,q);this._subscribeToSliderEvents();if(s){this._vcxPartSlider.setBackButton(this._onBackTriggerCB.bind(this,false))}else{this._vcxPartSlider.setRestoreButton(this._onRestoreTriggerCB.bind(this))}this._vcxPartSlider.setCursorPos(u)},_onPointerDownCB:function(u){if(!this._vcxPartSlider){return}if(this._tokens.pointerUpToken){this._disposeEvents(u);return}if(!this._tokens.pointerUpToken){var x=this;this._tokens.pointerUpToken=g.addEvent(this._viewer.canvas,"onPrimaryPointerUpUnique",this._disposeEvents.bind(this))}var F=this._viewer.getMousePosition(u.from[0].getCurrentPosition(this._viewer.canvas));var q;var v=this._viewer.pick(F,"mesh",true);if(v&&v.path&&v.path.length>0){q=v.path[0].clone()}if(!q){return}var C=this._experienceBase.ComponentsMap.GetComponentFromPathElement(q);if(C){this._viewer.currentViewpoint.setControlActive({viewpoint:false});if(this._manipulationOverrideSet===null){this._manipulationOverrideSet=d.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer);this._manipulationOverrideSet.name="SGOverrideSet ExplodeManualManip"}this.viewerPrePicking=this._viewer.pPicking.activated;this._viewer.setPrePicking({activated:false});var D=null;var t=Math.floor(this._vcxPartSlider.getCursorPos());var B=this._rootPathsStack[this._rootPathsStack.length-1].relativeRootPath;var y=B.getLastElement();var z=this._levelExploderStruct[y.id][t];for(var s in z){if(z.hasOwnProperty(s)){if(z[s].pathElement.isAParentOf(q)){D=z[s].pathElement;break}}}if(!D){D=q}var w=D&&this._experienceBase.ComponentsMap.GetComponentFromPathElement(D);if(!w){return}var r=v.position.clone();var A=new n.Vector3().subVectors(this._viewer.currentViewpoint.target,this._viewer.currentViewpoint.position).normalize();var E=new n.Plane(A,0).setFromNormalAndCoplanarPoint(A,r);this._initInfos={data:u,pickInfo:v,componentToMove:w,plane3D:E,mousePos:F};this._isDragging=false;this._lastPosition=r;if(!this._tokens.pointerDragToken){this._tokens.pointerDragToken=g.addEvent(this._viewer.canvas,"onPrimaryPointerMoveUnique",this._translate())}}},_translate:function(){var r=this;return function q(x){if(!r._initInfos||!r._lastPosition){return}var t=r._viewer.getMousePosition(x.from[0].getCurrentPosition(r._viewer.canvas));if(!r._isDragging){var v=r._initInfos.mousePos;var z=Math.max(Math.abs(t.xPix-v.xPix),Math.abs(t.yPix-v.yPix));if(z<3){return}else{r._isDragging=true}}var u=r._viewer.pick(t,"mesh",false);var s=u.ray.intersectPlane(r._initInfos.plane3D);var y=r._initInfos.componentToMove;var w=new n.Vector3().subVectors(s,r._lastPosition);r.translateWithOverrideSet(y,w,r._manipulationOverrideSet);r._lastPosition=s.clone()}},_disposeEvents:function(q){this._tokens.pointerDragToken&&g.removeEventFromToken(this._tokens.pointerDragToken);this._tokens.pointerDragToken=null;this._tokens.pointerUpToken&&g.removeEventFromToken(this._tokens.pointerUpToken);this._tokens.pointerUpToken=null;this._viewer.currentViewpoint.setControlActive({viewpoint:true});this.viewerPrePicking&&this._viewer.setPrePicking({activated:this.viewerPrePicking});delete this.viewerPrePicking;this._initInfos=null;this._translateCB=null;this._disposeCB=null;this._isDragging=false},saveInitPositionWithOverrideSet:function(q){var r=q.QueryInterface("W3AISGNodeHolder").getPathElement().getMatrix(this.viewer);this._componentInitFrames[q.GetID()]=r},restoreInitPositionWithOverrideSet:function(q,r){var u=this._componentInitFrames[q.GetID()];var t=q.QueryInterface("W3AISGNodeHolder").getPathElement();var s=d.getSceneGraphOverride(r,t);s.setPosition(u)},translateWithOverrideSet:function(A,x,y){var w=A.QueryInterface("W3AISGNodeHolder");var v=w.getPathElement();var B=v.getParentPath().getWorldMatrix(this._viewer);var z=new n.Matrix4().getInverse(B);var t=new n.Matrix4().extractRotation(z);var s=new n.Vector3().copy(x).applyMatrix4(t);var r=v.getMatrix(this._viewer);var u=new n.Vector3().getPositionFromMatrix(r).add(s);r.setPosition(u);var q=d.getSceneGraphOverride(y,v);q.setPosition(r);if(this._levelExploderManager&&y.name==="SGOverrideSet ExplodeManualManip"){this._levelExploderManager._publishVolatileManipEvent(A,v,u)}this._updateGroundIfExistsAndRender()},_getBBoxCenterFromComponent:function(q){var s=q.QueryInterface("W3AISGNodeHolder");var r=s.getPathElement().getBoundingBox(null,this._viewer);s&&r.applyMatrix4(s.getWorldMatrix(this._viewer));return(r?r.center():null)},_updateGroundIfExistsAndRender:function(){var q=this._experienceBase.getManager("VCXContextManager");q.renderAll({updateInfinitePlane:true})}});return a});