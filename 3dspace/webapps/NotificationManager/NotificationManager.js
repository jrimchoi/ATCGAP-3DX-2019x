define("DS/NotificationManager/view/notificationManagerView",["UWA/Core","UWA/Class/View","UWA/Controls/Abstract","DS/NotifAlert/NotifAlert","css!DS/NotificationManager/NotificationManager.css"],function(e,c,d,b){var a=c.extend({defaultOptions:{itemView:b,language:"en"},setup:function(f){this.maxItems=3;this.isInject=false;this.isClosed=false;this.itemView=(f&&f.itemView)?f.itemView:this.options.itemView;this.language=(f&&f.language)?f.language:this.options.language;this.listenTo(this.collection,"onAdd",this.add);this.listenTo(this.collection,"onRemove",this.deleteModel);this.collection.addEvents({"onChange:readState":function(g){e.log("AlertBox model changed")}});this.setContainer({tag:"div","class":"RTnotification"})},add:function(f){var g;if(this.isInject){if(this.collection.length<=this.maxItems){e.log("AlertBox - Add");g=new this.itemView({model:f});var i=e.createElement("div",{"class":"RTnotif-alert",html:g}).inject(this.container,"top");if(!f.get("isInNotifCenter")){this._createAlertShowFx(f,i);g.show();f.showAlertFx.start({top:["0px","0px"],right:["-400px","15px"],opacity:[0,1]})}}else{if(this._timeToRemove){clearTimeout(this._timeToRemove);this._timeToRemove=undefined}var h=this;this._timeToRemove=setTimeout(function(){h.closeAllAlerts()},1000)}}},deleteModel:function(f){if(f){var g=this;e.log("AlertBox model deleted");if(f.showAlertFx){f.showAlertFx.fade("out").onComplete=function(){if(this.element){this.element.destroy()}}}}},inject:function(g){this.isInject=true;this.container.inject(g);for(var f=0;f<this.collection.size();f++){this.add(this.collection.at(f))}},checkExistingAlert:function(){if(document.querySelector(".RTnotif-alert")){return true}else{return false}},_createAlertShowFx:function(f,g){f.showAlertFx=new e.Fx(g,{duration:500,transition:"linear",events:{onComplete:function(){}}})},closeAllAlerts:function(){while(!this.collection.isEmpty()){this.collection.pop()}}});return a});define("DS/NotificationManager/notificationDriver",["UWA/Core","UWA/Class","DS/PlatformAPI/PlatformAPI","UWA/Class/Events","DS/DSNodeSocketioClient/DSNodeSocketioClient","DS/WAFData/WAFData"],function(g,d,c,b,f,a){var e=d.extend(b,{defaultOptions:{notifServer:"",currentLanguage:"en"},init:function(h){var i=this;this._listenedEvents=h.listenedEvents;this._socket=undefined;this._server=undefined;this._token=undefined;c.subscribe("3dNotifCenterInit",function(){if(i._socket){c.publish("3dNotifManagerInit",true)}else{c.publish("3dNotifManagerInit",false)}})},activeConnection:function(h){g.log("3DNOTIF - NotificationManager activeConnection");var k=this;var l={"force new connection":false,reconnection:true,reconnectionAttempts:"Infinity",timeout:10000,transports:["websocket"]};if(!this._server){this._server=h.notifServer}if(this._server){this._socket=f.connect(this._server,l)}if(this._socket){for(var j=0;j<k._listenedEvents.length;j++){(function(i){k._socket.on(i,function(m){k.dispatchListenedEvents(m,i)})})(k._listenedEvents[j])}this._socket.on("connect",function(){var i={onComplete:function(p){var n;if(typeof p!="object"){try{n=JSON.parse(p)}catch(q){g.log("3DNotification : error parsing cas validate ticket response :"+q)}}else{n=p}if(n&&n.access_token){k._token=n.access_token;k._socket.emit("new_user",{pseudo:h.login.toLowerCase(),pass:k._token,language:h.currentLanguage});delete k._token;k._token=undefined;var m,o;c.publish("intf-ws-topic",{event:"ready",code:200})}else{g.log("3DNotification : json null or no acess token");for(var m=0;m<k._listenedEvents.length;m++){(function(r){k._socket.off(r)})(k._listenedEvents[m])}k._socket.off("connect");k._socket.off("error");k._socket.close();delete k._socket}},onFailure:function(m){g.log(m)},onTimeout:function(m){g.log(m)},type:"json"};a.authenticatedRequest(h.iamUrl,i)});this._socket.on("error",function(i){g.log("3DNotification Socket Connection Error\n"+i)})}},dispatchListenedEvents:function(h,i){this.dispatchEvent(i,h)},emit:function(h,i){if(this._socket){this._socket.emit(h,i)}},});return e});define("DS/NotificationManager/view/notificationMessageView",["UWA/Class","UWA/Class/Events","DS/UIKIT/Tooltip"],function(b,a,d){var c=b.extend(a,{init:function(e){this.views=[];this.expand=true;this.elementDisplay=false;this.globalDisplay=true;this.buddyMinimize=false;this.displayCss=undefined;this.dontDisplayIcon=e.dontDisplayIcon;this.notifQtyIcon=e.notifQtyIcon;this.notificationStyle=e.notificationStyle;var f=this;if((navigator.platform.indexOf("iPhone")!=-1)||(navigator.platform.indexOf("iPod")!=-1)||(navigator.platform.indexOf("iPad")!=-1)){this.globalView=UWA.createElement("div",{"class":"NTFMsgMiniNotification",id:"NTFMsgMiniNotification",styles:{position:"absolute"}})}else{this.globalView=UWA.createElement("div",{"class":"NTFMsgMiniNotification",id:"NTFMsgMiniNotification"})}this.iconView=UWA.createElement("div",{styles:{padding:"2px"}}).inject(this.globalView);this.buddyIconView=UWA.createElement("div",{styles:{padding:"2px",marginRight:"-60px",overflow:"hidden",display:"none"}}).inject(this.globalView);this.buddyIcon=UWA.createElement("div",{styles:{margin:"2px",width:"50px",height:"50px",borderRadius:"50px",border:"1px solid gray",background:"white"},events:{mouseover:function(){f.buddyIcon.style.cursor="pointer"},mouseout:function(){f.buddyIcon.style.cursor="default"},click:function(){if(f.expand){f.collapseAll()}else{f.expandAll()}}}}).inject(this.buddyIconView);UWA.createElement("span",{"class":"fonticon handler fonticon-users",styles:{fontSize:"1.6em",color:"rgb(0, 86, 134)",margin:"9px 12px"}}).inject(this.buddyIcon);this.arrowDownView=UWA.createElement("div",{styles:{margin:"2px",width:"50px",height:"14px",display:"none"},events:{mouseover:function(){f.spanDown.style.color="#3D3D3D";f.spanDown.style.cursor="pointer"},mouseout:function(){f.spanDown.style.color="gray";f.spanDown.style.cursor="default"},click:function(){var g=f.iconsListView.scrollTop;f.iconsListView.scrollTop+=100}}}).inject(this.globalView);this.spanDown=UWA.createElement("span",{"class":"fonticon handler fonticon-down-open",styles:{fontSize:"2em",color:"gray",position:"relative",bottom:"13px",margin:"0px 11px"}}).inject(this.arrowDownView);this.iconsListView=UWA.createElement("div",{styles:{margin:"2px",maxHeight:"580px",overflow:"hidden",minWidth:"50px",padding:"2px"},events:{mousewheel:function(g){f.iconsListView.scrollTop+=g.deltaY}}}).inject(this.globalView);this.arrowUpView=UWA.createElement("div",{styles:{margin:"2px",width:"50px",height:"14",display:"none"},events:{mouseover:function(){f.spanUp.style.color="#3D3D3D";f.spanUp.style.cursor="pointer"},mouseout:function(){f.spanUp.style.color="gray";f.spanUp.style.cursor="default"},click:function(){var g=f.iconsListView.scrollTop;f.iconsListView.scrollTop-=100}}}).inject(this.globalView);this.spanUp=UWA.createElement("span",{"class":"fonticon handler fonticon-up-open",styles:{fontSize:"2em",color:"gray",position:"relative",bottom:"13px",margin:"0px 11px"}}).inject(this.arrowUpView)},getView:function(){return this.globalView},removeAllElements:function(){for(var e=0;e<this.views.length;e++){this.removeElement(this.views[e].idElement)}},removeElement:function(g){var k=this;var f=-1;for(var h=0;h<this.views.length;h++){if(this.views[h].idElement===g){f=h;break}}if(f!==-1){var j=new UWA.Fx(this.views[f].view,{duration:200,transition:"linear",events:{onComplete:function(i){if(k.views[f]&&k.views[f].view){k.views[f].view.destroy()}k.views.splice(f,1);if(!k.views.length){k.activeBuddyIcon(false)}}}});j.start({height:0})}if(this.views.length===10){var e=new UWA.Fx(this.arrowDownView,{duration:200,transition:"linear",events:{onComplete:function(i){k.arrowDownView.style.display="none"}}});e.start({height:0});var l=new UWA.Fx(this.arrowUpView,{duration:200,transition:"linear",events:{onComplete:function(i){k.arrowUpView.style.display="none"}}});l.start({height:0})}},addContact:function(f){var e=-1;for(var g=0;g<this.views.length;g++){if(this.views[g].idElement===f.id){e=g;break}}if(e===-1){var h=this;var j=UWA.createElement("div",{styles:{width:"50px",height:"50px",marginTop:"6px",background:"white",borderRadius:"50px",border:"1px solid gray"},events:{mouseover:function(){j.style.cursor="pointer"},mouseout:function(){j.style.cursor="default"},click:function(){f.events.click();j.tooltip.destroy();h.removeElement(f.id)}}});j.tooltip=new d({target:j,body:f.userName,position:"left"});j.tooltip.getContent().style.zIndex="30000";UWA.createElement("img",{styles:{width:"42px",borderRadius:"42px",margin:"3px"},src:f.pathPicture}).inject(j);this.addElement({idElement:f.id,view:j,contactView:j,position:"bottom",show:true})}},addNotification:function(l){var m=-1;for(var g=0;g<this.views.length;g++){if(this.views[g].idElement===l.id){m=g;break}}if(m===-1){var h=this;if(this.notificationStyle){var f="";var s={right:"15px","border-radius":"4px",width:"300px",height:"74px",marginTop:"6px",boxShadow:"0px 1px 2px 0px #77797c",overflow:"hidden"}}else{var f="";var s={width:"300px",height:"74px",marginTop:"6px",boxShadow:"0px 1px 2px 0px #77797c",overflow:"hidden"}}var o=UWA.createElement("div",{id:"RTNotifView","class":f,styles:s,events:{mouseover:function(){o.style.cursor="pointer";h.expendNotif(this,this.children[0])},mouseout:function(){o.style.cursor="default"},mouseleave:function(){h.replaceNotif(this,this.children[0])},click:function(){h.removeElement(l.id);if(l&&l.events&&l.events.click){l.events.click()}}}});var r=UWA.createElement("div",{styles:{width:"50px",height:"50px",margin:"13px 12px",background:"white",borderRadius:"100%",border:"1px solid gray","float":"left"},events:{mouseover:function(){r.style.cursor="pointer"},mouseout:function(){r.style.cursor="default"},click:function(){}}}).inject(o);UWA.createElement("img",{styles:{width:"42px",borderRadius:"42px",margin:"3px"},src:l.pathPicture,}).inject(r);var n=UWA.createElement("div",{styles:{width:"300px",height:"38px",background:this.notificationStyle?"white":"#005686",textAlign:"left"}}).inject(o);var q=UWA.createElement("div",{styles:{height:"38px",display:"flex",flexDirection:"row"}}).inject(n);UWA.createElement("div",{text:l.userName,styles:{width:"150px",color:this.notificationStyle?"#77797c":"white",fontFamily:"arial",fontWeight:"bold",margin:"auto",whiteSpace:"nowrap",overflow:"hidden","float":"left",textOverflow:"ellipsis","margin-bottom":this.notificationStyle?0:"auto"}}).inject(q);UWA.createElement("span",{"class":"fonticon handler fonticon-popup",styles:{fontSize:"1.4em",color:"white",width:"38px","float":"left",margin:"auto"}}).inject(q);UWA.createElement("span",{"class":"fonticon handler fonticon-cancel",styles:{fontSize:"1.2em",color:"white",width:"38px","float":"left",margin:"auto"},events:{click:function(i){UWA.Event.stopPropagation(i);h.removeElement(l.id)}}}).inject(q);var p=UWA.createElement("div",{styles:{width:"300px",height:"36px",background:"white",textAlign:"left"}}).inject(o);var e=UWA.createElement("div",{styles:{margin:"auto",borderRadius:"4px",width:"294px",height:"33px",background:this.notificationStyle?"white":"#F1F1F1",paddingTop:this.notificationStyle?"0":"8px"}}).inject(p);UWA.createElement("div",{html:l.infoTxt,styles:{color:"#3D3D3D",fontFamily:"arial",width:"210px",whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"}}).inject(e);this.addElement({idElement:l.id,view:o,contactView:r,position:"bottom",show:true});var j=new UWA.Fx(o,{duration:300,transition:"linear"});var k=new UWA.Fx(r,{duration:300,transition:"linear",events:{onComplete:function(i){n.style.display="none";p.style.display="none";o.style.boxShadow="rgb(119, 121, 124) 0px 0px 0px 0px";j.start({width:50,height:50,marginRight:0,borderRadius:"50px"});r.style.border="1px solid orange";r.style.borderRadius="50px"}}});setTimeout(function(){j.start({marginRight:-250});k.start({margin:0})},4000)}else{this.receivedMessage(l.id)}},expendNotif:function(e,h){var g=new UWA.Fx(e,{duration:300,transition:"linear",events:{onComplete:function(i){}}});var f=new UWA.Fx(h,{duration:300,transition:"linear",events:{onComplete:function(i){h.style.border="1px solid gray";h.style.margin="13px 12px"}}});e.style.display="block";e.style.marginTop="6px";e.style.boxShadow="0px 1px 2px 0px #77797c";e.style.overflow="hidden";e.style.borderRadius="0px";e.children[1].style.display="";e.children[2].style.display="";g.start({width:300,height:74,borderRadius:0});f.start({marginTop:13,marginRight:12})},replaceNotif:function(f,h){var g=new UWA.Fx(f,{duration:300,transition:"linear"});var e=new UWA.Fx(h,{duration:300,transition:"linear"});g.start({width:50,height:50,marginRight:0,borderRadius:"50px",});e.start({margin:0})},addElement:function(i){console.log(i.position);var l=this;this.elementDisplay=i.show;if(i.position==="top"){console.log("top");this.views.push({idElement:i.idElement,view:i.view,contactView:i.contactView,show:this.expand||i.show})}else{console.log("not top");this.views.unshift({idElement:i.idElement,view:i.view,contactView:i.contactView,show:this.expand||i.show})}console.log(this.iconsListView);i.view.inject(this.iconsListView,i.position);console.log(this.iconsListView);if(this.expand||i.show){var f=i.view.offsetWidth;var j=i.view.offsetHeight;i.view.style.marginRight=-f+"px";var k=false;var g=new UWA.Fx(i.view,{duration:200,transition:"linear",events:{onAnimate:function(h,o,n){if(!k){l.iconsListView.scrollTop+=5}},onComplete:function(h){if(!(i.position==="top")&&k){k=false;g.start({marginRight:[-f,0]})}}}});if(i.position==="top"){g.start({marginRight:[-f,0]})}else{k=true;g.start({height:[0,j]})}if(!this.buddyMinimize&&!this.dontDisplayIcon){this.activeBuddyIcon(true)}}if(this.views.length===11){this.arrowDownView.style.display="block";this.arrowUpView.style.display="block";var e=new UWA.Fx(this.arrowDownView,{duration:200,transition:"linear"});e.start({height:[0,13],marginRight:2});var m=new UWA.Fx(this.arrowUpView,{duration:200,transition:"linear"});m.start({height:[0,13],marginRight:2})}},expandAll:function(){var f=this;this.expand=true;this.buddyIcon.style.display="block";if(f.views.length){this.animeElement(0);if(this.views.length>10){this.arrowDownView.style.display="block";var e=new UWA.Fx(this.arrowDownView,{duration:200,transition:"linear"});e.start({height:[0,13],marginRight:2})}}},collapseAll:function(){var f=this;this.expand=false;this.elementDisplay=false;this.views.forEach(function(g){g.show=false;var h=new UWA.Fx(g.view,{duration:200,transition:"linear",events:{onComplete:function(i){g.view.style.display="none"}}});h.start({marginRight:-60})});var e=new UWA.Fx(this.arrowDownView,{duration:200,transition:"linear",events:{onComplete:function(g){f.arrowDownView.style.display="none"}}});e.start({marginRight:-60});var e=new UWA.Fx(this.arrowUpView,{duration:200,transition:"linear",events:{onComplete:function(g){f.arrowUpView.style.display="none"}}});e.start({marginRight:-60})},animeElement:function(e){var g=true;var i=this;if(!this.views[e].show){this.views[e].show=true;var f=this.views[e].view;f.style.display="block";var h=new UWA.Fx(f,{duration:200,transition:"linear",events:{onAnimate:function(k,n,m){var j=h.currentTime;if(j>30&&g){g=false;if(++e<i.views.length){i.animeElement(e)}else{if(i.views.length>10){i.arrowUpView.style.display="block";var l=new UWA.Fx(i.arrowUpView,{duration:200,transition:"linear"});l.start({height:[0,13],marginRight:2})}}}}}});h.start({marginRight:[-60,0]})}else{if(++e<i.views.length){i.animeElement(e)}}},updateIcon:function(e){this.statusIconMiniIcon.className=e.name;this.statusIconMiniIcon.style["font-size"]=e.fontSize;this.statusIconMiniIcon.style.top=e.top;this.statusIconMiniIcon.style.left=e.left},receivedMessage:function(g){var k=this;var f=-1;for(var j=0;j<this.views.length;j++){if(this.views[j].idElement===g){f=j;break}}if(f!==-1){var l=0;var h=false;this.views[f].contactView.style.border="1px solid gray";var e=setInterval(function(){if(k.views&&k.views[f]&&k.views[f].contactView){k.views[f].contactView.style.border=h?"1px solid gray":"1px solid orange";h=!h;l++;if(l===5){k.views[f].contactView.style.border="1px solid orange";clearInterval(e)}}else{clearInterval(e)}},300)}},activeMiniZone:function(g){if(this.globalDisplay!==g){var f=this;if(g){this.globalDisplay=g;f.globalView.className="NTFMsgMiniNotification";var e=new UWA.Fx(this.globalView,{duration:200,transition:"linear"});e.start({marginRight:0})}else{this.globalDisplay=g;var e=new UWA.Fx(this.globalView,{duration:200,transition:"linear",events:{onComplete:function(h){f.globalView.className="NTFMsgMiniNotificationNone"}}});e.start({marginRight:-60})}}},setNotifQty:function(e){this.notifqtyIconMini.innerText=e},incrementNotifQty:function(e){this.notifqty=Math.min((this.notifqty||0)+(e||1),99);this.setNotifQty(this.notifqty)},razNotifQty:function(e){this.notifqty=0;this.setNotifQty(this.notifqty)},hideNotifQty:function(e){this.notifqtyIconMini.hide()},showNotifQty:function(e){this.notifqtyIconMini.show()},activeBuddyIcon:function(g){var f=this;if(g){this.buddyMinimize=true;if(this.views.length){this.buddyIconView.style.display="block";var e=new UWA.Fx(this.buddyIcon,{duration:200,transition:"linear",events:{onComplete:function(h){var i=new UWA.Fx(f.buddyIconView,{duration:200,transition:"linear"});i.start({marginRight:0})}}});e.start({height:50})}}else{this.buddyMinimize=false;var e=new UWA.Fx(this.buddyIconView,{duration:200,transition:"linear",events:{onComplete:function(h){var i=new UWA.Fx(f.buddyIcon,{duration:200,transition:"linear",events:{onComplete:function(j){f.buddyIconView.style.display="none"}}});i.start({height:0})}}});e.start({marginRight:-60})}},destroy:function(){this.globalView.destroy()},});return c});define("DS/NotificationManager/notificationManager",["UWA/Core","UWA/Class","UWA/Data","UWA/Controls/Abstract","UWA/Class/Model","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI","DS/UWPClientCode/I18n","DS/NotificationManager/view/notificationManagerView","DS/i3DXCompass/i3DXCompass","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/TopBar/TopBar","DS/NotificationManager/notificationDriver","DS/NotifAlert/NotifAlert","DS/NotificationManager/view/notificationMessageView"],function(i,a,p,j,f,m,q,h,n,o,b,l,g,d,c){var k;var e=a.extend({init:function(r){k=this;this.login=r.login;this.ODT=r.ODT;this.isMobileApp=r.isMobileApp;if(!this.ODT){this.frame=require("DS/TopFrame/TopFrame")}this.topBar=l.MainMenuBar;this.swymServer=r.swymServer;this.badge=0;this.isFiltered=false;this.listOfAppw={};this.listOfService=undefined;this._notifManagerView=undefined;this.blockAlert=false;this._listenedEvents=undefined;this._emmitedEvents=undefined;this.initListenedEvents();this.initEmmitedEvents();this.getServices();this._notificationDriver=new g({listenedEvents:Object.keys(k._listenedEvents)});this._notificationDriver.addEvent("newINTFTokenConnection",function(){var t=k.getParams();if(t&&t.login){k.requestProxyTicket(t)}});this.initConnection(r.login,r.passportServer,r.tenant);this.InitPushTo3dNotif("pushto3dnotification");this.initListeners();if(!this.notifCollection&&!this._notifManagerView){this.notifCollection=new i.Class.Collection();this._notifManagerView=new n({collection:this.notifCollection});if(!this.isMobileApp){try{this._notifConvView=new c({});this._notifConvView.getView().inject(document.body)}catch(s){console.log("3DNotification - ERROR - instantiate bubble")}}this._notifManagerView.inject(document.body);if(!this.ODT){this.initFrameEvents()}}this.addListener("3dnotifinterne",k.getActions);this.addListener("INTFSubscriptionTopic",function(t){k._notificationDriver.emit("subscription",t)})},initEmmitedEvents:function(){this._emmitedEvents={notifCenterOpened:"notifCenterOpened",resetNotifications:"resetNotifications",notificationRead:"notificationRead",decrementBadge:"decrementBadge",getHistory:"getHistory",getUnreadTotal:"getUnreadTotal",getSettings:"getSettings",updateSettings:"updateSettings",notificationDelete:"notificationDelete",deleteAllNotification:"deleteAllNotification",unsubscribe:"unsubscribe",filter:"filter",rollback:"rollback",rollbackPopupconfirmation:"rollbackPopupconfirmation",pushToken:"pushToken"}},initListenedEvents:function(){this._listenedEvents={notify:this.notify,notifyCenter:this.notifyCenter,notifySystem:this.notifySystem.bind(this),setHistory:this.setHistory,setUnreadTotal:this.setUnreadTotal,setFilteredTotal:this.setFilteredTotal,setSettings:this.setSettings,setSetting:this.setSetting,updateBadge:this.updateBadge,readNotification:this.readNotification,deleteNotification:this.deleteNotification,setTenants:this.setTenants,setDates:this.setDates,setWhoSettings:this.setWhoSettings,setNotifications:this.setNotifications,setSubscribedState:this.setSubscribedState,refreshForRollback:this.refreshForRollback,authenticated:this.authenticated,authenticate_error:this.authenticate_error,token_registered:this.token_registered,token_registered_error:this.token_registered_error}},initListeners:function(){for(var r in this._listenedEvents){if(this._listenedEvents.hasOwnProperty(r)){this._notificationDriver.addEvent(r,this._listenedEvents[r])}}},initConnection:function(r,s,u){var t=this;if(window.location.href.search(/https:\/\/([A-z0-9]+)-[A-z0-9]+-[A-z0-9]+-[A-z0-9]+/)===0){if(!u){u=window.location.href.split(/https:\/\//)[1].split("-")[0];u=u.toUpperCase()}t.getPlatformServicesUrl(r,s,u)}else{t.getPlatformServicesUrl(r,s,u)}},getPlatformServicesUrl:function(s,t,v){var r=false,u=this;b.getServiceUrl({serviceName:"3dnotifications",platformId:v,onComplete:function(x){if(!x){u.getPlatformServicesUrl(s,t)}else{if(!u.passportUrl){u.passportUrl=t;if(!u.passportUrl){u.passportUrl=q.getApplicationConfiguration("app.urls.passport")}}var y=u.getParams(s);if(typeof x==="object"){for(var w=0;w<x.length;w++){if(x[w].url){u.notifServer=u.extractDomain(x[w].url);r=true}if(r){if(y&&y.login){u.requestProxyTicket(y)}break}}}else{if(typeof x==="string"){u.notifServer=u.extractDomain(x);if(y&&y.login){u.requestProxyTicket(y)}}}if(!u.notifServer){i.log("3DNotification error : no intf url found need visual information")}}}})},initFrameEvents:function(){var r=this;if(r.frame&&r._notifManagerView&&r._notificationDriver){r.frame.addEvent("onRightPanelOpened",function(s){r._notifManagerView.closeAllAlerts();if(r.frame._visibleXApp==="notification"){r.topBar.setBadge("notification",0);r.badge=0;r.blockAlert=true;r._notificationDriver.emit("notifCenterOpened",r.blockAlert)}});r.frame.addEvent("onRightPanelClosed",function(s){if(r.frame._visibleXApp==="notification"){r.blockAlert=false;r._notificationDriver.emit("resetNotifications",r.blockAlert)}})}},getParams:function(r){var s={};s.currentLanguage=h.getCurrentLanguage();if(!s.currentLanguage){s.currentLanguage=window.navigator.language}if(q.getUser()){s.login=q.getUser().login}if(!s.login){s.login=r}k.language=s.currentLanguage;return s},getServices:function(){if(this.listOfService===undefined){b.getPlatformServices({onComplete:function(t){for(var s=0;s<t.length;s++){for(var r in t[s]){if(t[s].hasOwnProperty(r)){t[s][r.toLowerCase()]=t[s][r];delete t[s][r]}}}k.listOfService=t;q.publish("3dnotifinterne",{action:"setServices",services:k.listOfService})}})}else{q.publish("3dnotifinterne",{action:"setServices",services:k.listOfService})}},getServiceUrl:function(r){for(var s=0;s<this.listOfService.length;s++){if(r.platformId){if(this.listOfService[s].platformid.toLowerCase()===r.platformId.toLowerCase()){return this.listOfService[s][r.name.toLowerCase()]}}else{return this.listOfService[s][r.name.toLowerCase()]}}if(this.listOfService.length>0){return this.listOfService[0][r.name.toLowerCase()]}return undefined},getAppInfos:function(r){var s=this;if(!this.listOfAppw[r.appID]){o.getAppInfo({appId:r.appID,onComplete:function(t){i.log(t);if(t){s.listOfAppw[t.id]=t.icon;if(r.notif){r.notif.dispatchEvent("updatePicture",[{src:t.icon}])}else{q.publish("3dnotifinterne",{action:"setAppInfos",src:t.icon,notifID:r.notifID})}}}})}else{if(r.notif){r.notif.dispatchEvent("updatePicture",[{src:this.listOfAppw[r.appID]}])}else{q.publish("3dnotifinterne",{action:"setAppInfos",src:this.listOfAppw[r.appID],notifID:r.notifID})}}},addListener:function(r,s){q.subscribe(r,s)},addItem:function(r){var s=this;r.addEvent("publish",function(t){q.publish(t.topic,t.data)});r.addEvent("read",function(t){s._notificationDriver.emit("notificationRead",t);s._notificationDriver.emit("decrementBadge",s.badge);q.publish("3dnotifinterne",{action:"read",params:{id:t.id,read:true}})});r.addEvent("actioned",function(t){q.publish("3dnotifinterne",{action:"actioned",params:{id:t.id,actioned:true}})});r.addEvent("alertBoxClosed",function(){s.badge-=1;s._notificationDriver.emit("decrementBadge",s.badge)});r.addEvent("updateLabel",function(t){if(t&&t.id){var u={action:"updateLabel",updateLabel:"updateLabel",params:{id:t.id,label:t.label,flag:t.flag}};q.publish("3dnotifinterne",u)}s._notificationDriver.emit("notificationRead",u)});s.notifCollection.add(r)},addNotification:function(r){q.publish("3dnotifinterne",{action:"addNotification",notification:JSON.stringify(r)})},getActions:function(t){switch(t.action){case"rollback":q.publish("3dnotifinterne",{action:"rollbackPopup",params:{file:t.file,id:t.id,isInNotifCenter:t.isInNotifCenter}});break;case"rollbackPopupconfirmation":k._notificationDriver.emit("rollback",{filename:t.file,user:q.getUser().login,confirmPopupResult:t.confirmPopupResult,id:t.id});break;case"getHistory":k._notificationDriver.emit("getHistory",{type:t.type,oldID:t.oldID,groupIDs:t.groupIDs});break;case"getUnreadTotal":k._notificationDriver.emit("getUnreadTotal");break;case"getAppInfos":k.getAppInfos({appID:t.appID,notifID:t.notifID});break;case"getSettings":k._notificationDriver.emit("getSettings");break;case"getTenants":k._notificationDriver.emit("getTenants");break;case"getDates":k._notificationDriver.emit("getDates");break;case"getWhoSettings":k._notificationDriver.emit("getWhoSettings");break;case"getParams":q.publish("3dnotifinterne",{action:"setParams",params:{passportUrl:k.options.passportUrl,swymUrl:k.options.swymServer}});break;case"getServices":k.getServices();break;case"notificationRead":k._notificationDriver.emit("notificationRead",t);break;case"actioned":k._notificationDriver.emit("notificationRead",t);break;case"updateSettings":k._notificationDriver.emit("updateSettings",t);break;case"notificationDelete":k._notificationDriver.emit("notificationDelete",t);break;case"deleteAllNotification":k._notificationDriver.emit("deleteAllNotification",t);break;case"unsubscribe":k._notificationDriver.emit("unsubscribe",t);break;case"NotifCenterOpened":k._notificationDriver.emit("NotifCenterOpened",t.blockAlert);break;case"resetNotifications":k._notificationDriver.emit("resetNotifications",k.blockAlert);break;case"filter":var w=[];for(var r=0;r<t.values.what.length;r++){w.push(t.values.what[r])}if(w.length===0){w[0]=" "}k.filterValues={msg:w,first_date:k.getFormattedDate(new Date(t.values.first_date)),last_date:k.getFormattedDate(new Date(t.values.last_date)),tenants:t.values.tenants,whoSettings:t.values.whoSettings};k.isFiltered=true;k._notificationDriver.emit("filter",k.filterValues);break;case"notifyBrowser":var u=t.titleNotif||"3DSwym Conversations";var s=t.textNotif;var v=k.swymServer||k.getServiceUrl({name:"3dswym",platformId:t.tenant});var x=(v&&t.login)?""+v+"/api/user/getpicture/login/"+t.login+"/format":"./resources/en/1/webapps/NotifAlertBox/assets/icons/notifIcon.png";k.notifyWeb(u,{ICON:x},s,"en",false,function(){i.log("browser notif has been clicked");window.focus();this.close()});break;default:i.log("Unknown action published on 3dnotifinterne : "+t.action)}},InitPushTo3dNotif:function(r){var s;q.subscribe(r,function(t){switch(t.method){case"pushplatformid":if(t.data){if(t.data.provider.toLowerCase()==="3dswym"){k._notificationDriver.emit("getTokens",t.data.data)}}break;case"registerTenantApp":if(t.data){s=t.data.provider.toLowerCase()}if(s){if(!k.listOfTenantApp[s]){k.listOfTenantApp[s]=[]}}k.listOfTenantApp[s].push(t.data.data);break;case"unregisterTenantApp":if(t.data){s=t.data.provider.toLowerCase()}if(s){if(k.listOfTenantApp[s]){k.listOfTenantApp[s].splice(k.listOfTenantApp[s].indexOf(t.data.data),1)}}break;default:}})},requestProxyTicket:function(s){var r=this.passportUrl+"/login?service=INTF";k._notificationDriver.activeConnection({login:s.login,currentLanguage:s.currentLanguage,iamUrl:r,notifServer:k.notifServer})},computeAlertBox:function(z,v,t){var x=this;if(v.ICON){if(v.ICON.type==="appID"){t=true}else{v.ICON=x.getIconInfo(v)}}else{t=false}if(z.actions){for(var w=0;w<z.actions.length;w++){var u=z.actions[w];if(u.options&&u.options.event&&u.options.event.type==="url"){var r=u.options.event;if(r.options&&r.options.service&&r.options.uri){var s=this.getServiceUrl({name:r.options.service,platformId:v.PLATFORMID});r.options.url=s+r.options.uri;if(v.APPID==="USASWYM_AP"){r.options.csrf=s+"/api/index/tk/"}}}}}var y=new f({id:v.ID,img:v.ICON,text:z.nls.msg,options:z.actions,appIconBorder:t,listOfService:x.listOfService,readState:false,isInNotifCenter:false,actioned:false,provider:v.APPID,refresh:v.REFRESH,platformId:v.PLATFORMID?v.PLATFORMID:""});if(t){x.getAppInfos({notif:y,appID:v.ICON.data})}return y},getIconInfo:function(u){if(u.ICON){if(u.ICON.type==="url"){if(!u.ICON.data.service){return u.ICON.data}else{if(u.PLATFORMID){for(var t=0;t<k.listOfService.length;t++){if(k.listOfService[t].platformid===u.PLATFORMID){return k.listOfService[t][u.ICON.data.service.toLowerCase()]+u.ICON.data.uri}}}else{for(var r in k.listOfService[0]){if(u.ICON.data.service.toLowerCase()===r.toLowerCase()){return k.listOfService[0][r]+u.ICON.data.uri}}}}}else{if(u.ICON.type==="login"){var s="/api/user/getpicture/login/";if(u.PLATFORMID){for(var v=0;v<k.listOfService.length;v++){if(k.listOfService[v].platformid===u.PLATFORMID){k.swymServer=k.listOfService[v]["3dswym"];break}}}return k.swymServer+s+u.ICON.data+"/format"}}}else{u.ICON="./resources/en/1/webapps/NotifAlertBox/assets/icons/notifIcon.png"}},authenticated:function(){i.log("3DNotification : socket connected !")},authenticate_error:function(r){i.log("3DNotification : socket error :"+JSON.stringify(r))},token_registered:function(){i.log("3DNotification : token registred !")},token_registered_error:function(r){i.log("3DNotification : token registred error"+JSON.stringify(r))},updateBadge:function(r){if(!k.blockAlert){if(r.badge!==undefined){k.topBar.setBadge("notification",r.badge);k.badge=r.badge}}},setSetting:function(r){q.publish("3dnotifinterne",{action:"setSetting",setting:r.setting})},setSettings:function(t){var r=[];for(var s=0;s<t.settings.length;s++){if(r.indexOf(t.settings[s].APPID)===-1){r.push(t.settings[s].APPID)}}o.getAppsInfo({data:r,onComplete:function(w){i.log(w);if(w){var v=[];for(var u=0;u<t.settings.length;u++){for(var x=0;x<w.length;x++){if(t.settings[u].APPID===w[x].id){v.push({id:t.settings[u].ID,name:t.settings[u].NAME,serviceName:w[x].title,service:w[x].id,icon:w[x].icon,subscribe:t.settings[u].SUBSCRIBE,notif_by_ui:t.settings[u].NOTIF_BY_UI,notif_by_email:t.settings[u].NOTIF_BY_EMAIL,notif_by_browser:t.settings[u].NOTIF_BY_BROWSER})}k.listOfAppw[w[x].id]=w[x].icon}}v.sort(function(z,y){var B=z.serviceName.toLowerCase(),A=y.serviceName.toLowerCase();if(B<A){return -1}if(B>A){return 1}return 0});q.publish("3dnotifinterne",{action:"setSettings",settings:v})}}})},checkRegisteredApp:function(t,s,r){if(this.listOfTenantApp[t]&&this.listOfTenantApp[t][s]){q.publish("3dnotifexterneapi",{action:"getCurrentConversation"});return false}else{return true}},refreshForRollback:function(){q.publish("3dnotifinterne",{action:"refreshForRollback"})},setUnreadTotal:function(s){var r=JSON.parse(s.unread);if(r){q.publish("3dnotifinterne",{action:"setUnreadTotal",unread:r[0].UNREAD})}},setFilteredTotal:function(r){if(r.count!==undefined){q.publish("3dnotifinterne",{action:"setFilteredTotal",count:r.count})}},setHistory:function(r){q.publish("3dnotifinterne",{action:"setHistory",notifications:r.notifications,language:k.language})},setNotifications:function(r){q.publish("3dnotifinterne",{action:"setNotifications",notifications:r.notifications})},setDates:function(r){q.publish("3dnotifinterne",{action:"setDates",Dates:r})},setWhoSettings:function(r){q.publish("3dnotifinterne",{action:"setWhoSettings",settings:r})},setTenants:function(r){var s=JSON.parse(r.tenants);b.getPlatformServices({onComplete:function(u){for(var v=0;v<s.length;v++){for(var t=0;t<u.length;t++){if(s[v].PLATFORMID===u[t].platformId){s[v].displayName=u[t].displayName}}}q.publish("3dnotifinterne",{action:"setTenants",tenants:JSON.stringify(s)})}})},setSubscribedState:function(r){q.publish("INTFSubscriptionTopic",{action:"setSubscribedState",state:r.state})},notifySystem:function(w){var x=this;var u=decodeURIComponent(escape(atob(w.message))),H=JSON.parse(u);if(H){q.publish(H.actions[0].options.event.options.topic,H.actions[0].options.event.options.data)}try{if(this._notifConvView){var E=H.actions[0].options.event.options.data.external_app_id;if(E==="3DSWYM"){if(H.actions[0].options.event.options.data.message_type==="INSTANT_MESSAGE"){var C=H.actions[0].options.event.options.data.author.login;if(C!==x.login){var t=H.actions[0].options.event.options.data.message_uri;var G=H.actions[0].options.event.options.topic;var A=H.actions[0].options.event.options.data.subject_uri;var r=H.actions[0].options.event.options.data.community_id;var F=H.actions[0].options.event.options.data.community_type;var v=H.actions[0].options.event.options.data.message_details.content;var D=H.actions[0].options.event.options.data.author.firstName+" "+H.actions[0].options.event.options.data.author.lastName;var z=H.actions[0].options.event.options.data.community_id;G=G.substring(G.indexOf("_")+1,G.length);G=G.substring(0,G.indexOf("_"));var s=x.getServiceUrl({name:"3dswym",platformId:G});if(s&&F==="dm"&&C!==q.getUser().login){var B={id:r+C,pathPicture:s+"/api/user/getpicture/login/"+C+"/format",userName:D,infoTxt:v,events:{click:function(I){var J=window.open(s+"/#dm:"+r,"3DSwym Conversations");J.focus()}}};this._notifConvView.addNotification(B);if(Notification.permission!=="granted"){Notification.requestPermission(function(I){if(I==="granted"){x.notifyWeb("3DSwym Conversations",{ICON:s+"/api/user/getpicture/login/"+C+"/format"},v,"en",false,function(){var J=window.open(s+"/#dm:"+r,"3DSwym Conversations");J.focus()})}})}else{x.notifyWeb("3DSwym Conversations",{ICON:s+"/api/user/getpicture/login/"+C+"/format"},v,"en",false,function(){var I=window.open(s+"/#dm:"+r,"3DSwym Conversations");I.focus()})}}}}}}}catch(y){console.log("3DNotification - Error : "+JSON.stringify(y))}},notifyCenter:function(r){k.addNotification(r)},readNotification:function(r){q.publish("3dnotifinterne",{action:"read",params:{id:r.id,read:r.read,scope:r.scope||null}})},deleteNotification:function(r){q.publish("3dnotifinterne",{action:"delete",params:{id:r.id,read:r.read}})},notify:function(x){if(!this.isMobileApp){var r=decodeURIComponent(escape(window.atob(x.MESSAGE))),z=JSON.parse(r),s=false,u=true,t=true;if(k.isFiltered){if(x.CREATION_DATE>=k.filterValues.first_date&&x.CREATION_DATE<=k.filterValues.last_date){for(var y=0;y<k.filterValues.tenants.length;y++){if(x.PLATFORMID===k.filterValues.tenants[y]){for(var w=0;w<k.filterValues.msg.length;w++){if(JSON.stringify(z).search(k.filterValues.msg[w])!==-1){u=true;break}else{u=false}}}else{u=false}}}else{u=false}}if(u){if(!k.blockAlert){var v=k.computeAlertBox(z,x,s);k.addItem(v);t=false}if(x.NOTIFBROWSER){k.notifyWeb("3DEXPERIENCE Platform Notification",x,z.nls.msg,k.language,t)}k.addNotification(x)}}},extractDomain:function(r){var s;if(r.indexOf("://")>-1){s=r.split("/")[2]}else{s=r.split("/")[0]}if(s.indexOf(":")>-1){return s}else{return s+":443"}},getFormattedDate:function(s){var t=s.getFullYear();var u=(1+s.getMonth()).toString();u=u.length>1?u:"0"+u;var r=s.getDate().toString();r=r.length>1?r:"0"+r;return t+"-"+u+"-"+r},notifyWeb:function(z,v,w,s,x,u){var y;if(x){y=k.getIconInfo(v)}else{y=v.ICON}if(Notification.permission==="granted"&&document.hidden){i.log("3DNotification Browser notification");w=w.replace(/<(?!\strong)[^>]*>/gi,"");var t=new Notification(z,{lang:s,body:w,icon:y});t.onclick=function(B){B.preventDefault();if(u){u()}else{t.close();var A=window.open("","notification");A.focus();A.close()}};var r=setTimeout(function(){t.close()},5000)}}});return e});