define("DS/DeleteWidget/DeleteWidget",["css!DS/DeleteWidget/DeleteWidget","UWA/Core","UWA/Controls/Abstract","DS/LifecycleServices/LifecycleCommandManager","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleServicesSettings","DS/LifecycleControls/CommandDialog","DS/WAFData/WAFData","DS/LifecycleCmd/MessageMediator"],function(h,g,d,k,a,c,b,e,j,f){var i=d.extend({physicalid:"",securityContext:null,context:null,tenant:null,operationType:"delete",refreshType:"",_commandResult:false,init:function(l){if(UWA.is(l,"string")){this.operationType=l}this.deleteOptions=[];var m=this;this.commandManager=new k();this.commandManager.addEvent("onModifyOptions",function(n){m.deleteOptions=n.options})},executeCmd:function(m,l,n){this.addEvent("onReady",function(o){this._showCommandUI(m)},this);this.addEvent("onComplete",function(o){n()});this.context=l.context;this.setObjects(m)},getResult:function(){return this._commandResult},_showCommandUI:function(m){var l=this;if(this.deleteOptions.length===0&&this.operationType==="delete"){l._executeDelete(function(){l._onComplete()})}else{if(this.operationType==="restore"){l._executeDelete(function(){l._onComplete()})}else{var n=this._renderDialogContent(m[0].displayName);var p=new e();var o=p.create(n,{title:a.delete_,closeButton:true,imageUrl:m[0].imageUrl||"",onOk:function(){l._executeDelete(function(){p.destroy();l._onComplete()})},onClose:function(){l._onComplete()}});o.inject(widget.body);o.setNewSize({})}}},_renderDialogContent:function(l){var q=document.createElement("div");q.className="delete_popup";var p=document.createElement("div");var n;if(this.operationType==="delete"){n=a.doLogicalDelete+l+a.doLogicalDeleteEnd+a.questionMark}else{var m=document.createElement("div");m.className="delete_popup_warning";var r=UWA.createElement("span",{"class":"delete_warning_icon fonticon fonticon-attention fonticon-2x"});m.appendChild(r);q.appendChild(m);n=a.doDelete+l+a.questionMark}p.innerHTML=n;q.appendChild(p);var o=document.createElement("div");o.appendChild(this.commandManager.buildOptionPanel(this.deleteOptions));q.appendChild(o);return q},_onComplete:function(){this.dispatchEvent("onComplete",{})},setObjects:function(o){var n=this;if(o.length===0){throw a.noObject}else{if(o.length===1){var p={};p.data=o;var m=o[0];if(m.hasOwnProperty("physicalid")&&m.physicalid===""){throw a.epmtyPhysicalId}else{if((this.operationType==="restore"||this.operationType==="destroy")&&(["CATIA Embedded Component","CATAnalysisResults","CATAnalysisComputations"].indexOf(m.type)>=0)){throw a.selectParentToPerformOperation}this.physicalid=m.physicalid;this.tenant=m.tenant;this.commandManager.setTenant(this.tenant);this.commandManager.addEvent("onCompleteGetOptions",function(q){document.body.style.cursor="default";this.deleteOptions=q.options;if(this.operationType==="restore"){this.refreshType="Restore"}else{if(this.operationType==="destroy"){this.refreshType="PhysicalDeleteAfterLogical"}else{this.refreshType="Delete"}}if(q.hasOwnProperty("logicalDeleteSupported")){if(this.operationType==="delete"&&!q.logicalDeleteSupported){this.operationType="destroy";this.refreshType="Delete"}}this.dispatchEvent("onReady",{})},this);var l={data:[{physicalid:this.physicalid}],command:"Delete"};this.commandManager.getOptions(l,function(r,q){n.showError(r);n._refreshInvalidObjects(q);n._onComplete()})}}else{throw a.multipleSelection}}},_executeDelete:function(s){var o={};var q={physicalid:this.physicalid};var r=[];r.push(q);o.data=r;if(this.operationType!="restore"){o.options=this.deleteOptions}console.log("Prepare Delete/Restore Input:");console.log(o);var m=JSON.stringify(o);document.body.style.cursor="wait";var l=function(){document.body.style.cursor="default";s()};var n=this;if(n.context!=null&&typeof n.context.getSecurityContext==="function"){var p=n.context.getSecurityContext();n.securityContext=p.SecurityContext;n.DeleteServiceRequest(m,l)}else{c.getSecurityContextPromise().then(function(t){if(t==null){n.showError({errorMsg:a.ErrorSecurityContextEmpty});l()}else{n.securityContext=t;n.DeleteServiceRequest(m,l)}})["catch"](function(t){n.showError({errorMsg:t});l()})}},_refreshInvalidObjects:function(m){if(!m){return}if(!UWA.is(m.report,"array")){return}var p=this._getInvalidObjectIDs(m.report);if(p.length<1){return}var l=[];for(var o=0;o<p.length;++o){l.push({physicalid:p[o]})}var n=this.operationType==="delete"?"Delete":"PhysicalDeleteAfterLogical";this._refreshObjects(n,l)},_getInvalidObjectIDs:function(l){var p=[];for(var n=0;n<l.length;++n){if(!UWA.is(l[n].errorcode,"number")){continue}if(l[n].errorcode!==1&&l[n].errorcode!==100&&l[n].errorcode!==101){continue}if(UWA.is(l[n].physicalids,"array")){var o=l[n].physicalids;for(var m=0;m<o.length;++m){p.push(o[m])}}else{if(UWA.is(l[n].physicalid)){p.push(l[n].physicalid)}}}return p},showNotification:function(l,n){if(typeof this.context.displayNotification==="function"){var m={eventID:((typeof n==="string")?n:"primary"),msg:l};this.context.displayNotification(m)}else{alert(l)}},showError:function(n){if(typeof this.context.displayNotification==="function"){var m=n.message||n;var l={eventID:"error",msg:m.split?m.split("\n").join("<br>"):m};this.context.displayNotification(l)}else{alert(n)}},_refreshObjects:function(m,l,n){var o={created:[],deleted:[],modified:[],restored:[]};o.context=this.context;var p=function(s,r,q){s.forEach(function(t){r.push({physicalid:t.physicalid,operation:q,impl:t.impl})})};if(l){p(l,o.deleted,m)}if(n){p(n,o.restored,m)}f.dispatchEvent("onModification",o)},_refreshFromSuccessResponse:function(n){var l=[];var m=[];n.results.forEach(function(o){if(this.operationType==="restore"){m.push(o)}else{l.push(o)}},this);this._refreshObjects(this.refreshType,l,m)},DeleteServiceRequest:function(q,s){var o=this;this._commandResult=false;var m="/resources/lifecycle/Delete/structure";if(this.operationType==="delete"){m="/resources/lifecycle/Delete/logicalstructure"}else{if(this.operationType==="restore"){m="/resources/lifecycle/Delete/restore"}}var n=b.get3DSpaceWSUrl(this.tenant,m,null);var r=function(v){console.log("delete: COMPLETED");console.log(v);if(v==null){s();return}if(v.hasOwnProperty("results")&&v.results.length!==0){o._commandResult=true}s();var w;if(o._commandResult===true){if(v.hasOwnProperty("report")&&v.report.length!==0){var t=v.report.length;w=a.deletePartialSuccessful+": "+t+" ";w+=(t===1)?a.deleteIgnoredObject:a.deleteIgnoredObjects}else{w=a.deleteSuccessful;if(o.operationType==="restore"){w=a.restoreSuccessful}}o.showNotification(w);o._refreshFromSuccessResponse(v)}else{if(v.hasOwnProperty("report")&&v.report.length!==0){w=v.report[0].error;if(v.report.length>1){for(var u=1;u<v.report.length;u++){if(v.report[u].physicalid===o.physicalid){w=v.report[u].error;break}}}}else{w=a.deleteFailed;if(o.operationType==="restore"){w=a.restoreFailed}}o.showError(w);o._refreshInvalidObjects(v)}};var l=function(t,u){o.showError(c.parseWebServiceError(t,u));console.log("Failed to retrive data from the server");s()};var p=function(t){o.showError(a.timeout);console.log("Timeout error");s()};j.authenticatedRequest(n,{method:"POST",headers:b.getHeaders(this.securityContext),timeout:8*60*60*1000,onComplete:r,data:q,onFailure:l,ontimeout:p,type:"json"})},});return i});