define("DS/CAT3DExpLinkContext/CAT3DExpLinkContext",["UWA/Core","UWA/Class/Promise"],function(c,b){var a=c.Class.extend({init:function(){},getJSONDescription:function(){console.error("not yet implemented");var d={};return d},retrieveLinkDescriptions:function(){console.error("not yet implemented");return[]},getNameForLinkDescription:function(d){console.error("not yet implemented"+d);return"error"},getFirstLink:function(d){return c.Promise.reject("DEPRECATED! use getLinkDescriptionByType instead"+d)},resolveLinkAsStream:function(d){return b.reject(new Error("Not yet implemented"+d))},pushStream:function(d,e){return b.reject(new Error("Not yet implemented"+e))},getLinkDescriptionByType:function(d){return b.reject(new Error("Not yet implemented"+d))}});return a});define("DS/CAT3DExpLinkContext/CAT3DExpWebLinkContext",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpLinkContext/CAT3DExpLinkContext"],function(d,c,b){var a=b.extend({init:function(e){this._parent();this._baseURL=e.baseURL;this._links=[];this._links.push({StreamName:e.experienceFile})},getLinkDescriptionByType:function(f){for(var e=0;e<this._links.length;e++){if(this._getLinkType(this._links[e])===f){return d.Promise.resolve(this._links[e])}}return d.Promise.reject()},_typeExtMap:{".json":"CXPExperience_Spec",".cgr":"Model_VPMReference_Spec",".3dxml":"Model_VPMReference_Spec",".3dx":"Model_VPMReference_Spec",".jpg":"CXPPictureResource_Spec"},_getLinkType:function(f){for(var e in this._typeExtMap){if(f.StreamName.endsWith(e)){return this._typeExtMap[e]}}console.error("unknown link");return undefined},retrieveLinkDescriptions:function(){return c.resolve(this._links)},resolveLinkAsStream:function(f){var e=this;return this._httpGet(this._baseURL+f.StreamName).done(function(g){g.format=e._getLinkFormat(f);return g})},_httpGet:function(f){var e=d.Promise.deferred();var g=new XMLHttpRequest();g.onreadystatechange=function(){if(g.readyState===4){if(g.status===200){e.resolve(g.response)}}};g.open("GET",f,true);g.responseType="blob";g.send();return e.promise},_formatExtMap:{".cgr":"cgr",".3dxml":"xmlv43",".3dx":"3dx"},_getLinkFormat:function(f){for(var e in this._formatExtMap){if(f.StreamName.endsWith(e)){return this._formatExtMap[e]}}return undefined}});return a});define("DS/CAT3DExpLinkContext/CAT3DExpPlatformMediaLinkContext",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpLinkContext/CAT3DExpLinkContext","DS/WAFData/WAFData"],function(e,c,b,a){var d=b.extend({init:function(f){this._parent();this._objectId=f.physicalid;this._3DSpaceURL=f.serverurl;this._securityContext=f.contextid},getLinkDescriptionByType:function(g){if(g!=="CXPExperience_Spec"){return e.Promise.reject()}var f=this;return this.retrieveLinkDescriptions().done(function(j){for(var h=0;h<j.length;h++){if(f._getLinkType(j[h])===g){return j[h]}}return e.Promise.reject()})},_typeExtMap:{".json":"CXPExperience_Spec",".cgr":"Model_VPMReference_Spec",".3dx":"Model_VPMReference_Spec",".3dxc":"Model_VPMReference_Spec",".jpg":"CXPPictureResource_Spec"},_getLinkType:function(g){for(var f in this._typeExtMap){if(g.StreamName.endsWith(f)){return this._typeExtMap[f]}}console.error("unknown link");return undefined},retrieveLinkDescriptions:function(){if(this._links){return e.Promise.resolve(this._links)}if(this._retrieveLinksDeferred){return this._retrieveLinksDeferred.promise}this._retrieveLinksDeferred=e.Promise.deferred();var f=this;this._retrieveStreamsDef().done(function(h){f._links=[];for(var g=0;g<h.length;g++){f._links.push({StreamName:h[g].persistencyname})}f._retrieveLinksDeferred.resolve(f._links)});return this._retrieveLinksDeferred.promise},_retrieveStreamsDef:function(){if(this._streamsDef){return e.Promise.resolve(this._streamsDef)}if(this._retrieveStreamsDeferred){return this._retrieveStreamsDeferred.promise}this._retrieveStreamsDeferred=e.Promise.deferred();var f=this;var g=this._3DSpaceURL+"/resources/experience/medias/"+f._objectId+"/streams";a.authenticatedRequest(g,{method:"GET",type:"json",headers:{"Content-Type":"application/json",SecurityContext:this._securityContext},onComplete:function(h){f._streamsDef=h.results;f._retrieveStreamsDeferred.resolve(f._streamsDef)},onFailure:function(h){f._retrieveStreamsDeferred.reject(h)}});return this._retrieveStreamsDeferred.promise},resolveLinkAsStream:function(g){if(g){var f=this._getLinkType(g);switch(f){case"CXPExperience_Spec":return this._resolveExperienceAsStream(g);default:return this._resolveMediaLinkAsBinaryStream(g)}}return e.Promise.reject("Unknown Link")},_retrieveStreamDefByLink:function(f){return this._retrieveStreamsDef().done(function(h){for(var g=0;g<h.length;g++){if(h[g].persistencyname===f.StreamName){return h[g]}}return e.Promise.reject("Imposible to retrieve stream def for"+f.StreamName)})},_resolveExperienceAsStream:function(g){var f=this;return this._retrieveStreamDefByLink(g).done(function(h){return f._retrieveStream(h)}).done(function(h){return new Blob([h],{type:"text/xml"})})},_resolveMediaLinkAsBinaryStream:function(g){var f=this;return this._retrieveStreamDefByLink(g).done(function(h){return f._retrieveStream(h,{type:"arraybuffer",headers:{Accept:"text/plain"}})}).done(function(i){var h=new Blob([i],{type:"application/octet-binary"});h.format=f._getLinkFormat(g);h.filename=g.StreamName;return h})},_formatExtMap:{".cgr":"cgr",".3dxml":"xmlv43",".3dx":"3dx",".3dxc":"3dxc"},_getLinkFormat:function(g){for(var f in this._formatExtMap){if(g.StreamName.endsWith(f)){return this._formatExtMap[f]}}return undefined},_retrieveStream:function(h,g){var f=this;return this._retreiveStreamInfo(h).done(function(i){return f._retrieveStreamContent(i,g)})},_retreiveStreamInfo:function(h){var f=e.Promise.deferred();var g=this._3DSpaceURL+"/resources/experience/medias/"+h.physicalid+"/streams/"+h.persistencyname;a.authenticatedRequest(g,{method:"GET",type:"json",headers:{"Content-Type":"application/json",SecurityContext:this._securityContext},onComplete:function(i){f.resolve(i.results[0])},onFailure:function(i){f.reject(i)}});return f.promise},_retrieveStreamContent:function(j,i){var h=i?i:{};var f=e.Promise.deferred();var g={timeout:h.timeout?h.timeout:100000,method:h.method?h.method:"POST",data:"__fcs__jobTicket="+encodeURIComponent(j.ticket),type:h.type?h.type:"text",headers:h.headers?h.headers:{"Content-type":"application/x-www-form-urlencoded",Accept:"text/plain"},onComplete:function(k){f.resolve(k)},onFailure:function(k){f.reject(k)}};g.proxy="passport";a.authenticatedRequest(j.fcsurl,g);return f.promise}});return d});define("DS/CAT3DExpLinkContext/CAT3DExpRTVLinkContext",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpLinkContext/CAT3DExpLinkContext","DS/WebappsUtils/WebappsUtils"],function(e,d,b,c){var a=b.extend({getJSONDescription:function(){return{protocol:"RTVContent"}},resolveLinkAsStream:function(f){return new d(function(h,g){var i=new XMLHttpRequest();i.open("GET",c.getWebappsBaseUrl()+f,true);i.responseType="blob";i.onload=function(){if(this.status===200){var j=f.split(".").pop();j=j!=="3dxml"?j:"xmlv43";this.response.format=j;h(this.response)}else{g(new Error("status !== 200"))}};i.send()})}});return a});define("DS/CAT3DExpLinkContext/CAT3DExpLocalStorageLinkContext",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpLinkContext/CAT3DExpLinkContext","UWA/Storage/Adapter/Dom"],function(d,c,b){var a=b.extend({init:function(e){this._parent();this._dataBaseName=e.databaseName;this._storage=new d.Storage({adapter:"Dom",database:"uwaLocalStorage-"+this._dataBaseName});this._storage.currentAdapter.options.duration=100},getLinkDescriptionByType:function(f){var e=this._storage.getAll();for(var g in e){if(e.hasOwnProperty(g)&&e[g].type===f){return d.Promise.resolve(g)}}return d.Promise.fail()},retrieveLinkDescriptions:function(){var e=[];var f=this._storage.getAll();for(var g in f){if(f.hasOwnProperty(g)){e.push(g)}}return d.Promise.resolve(e)},pushStream:function(h){var g=d.Promise.deferred();var i=d.Utils.getUUID();var f=this;var e=new FileReader();e.onload=function(){f._storage.set(i,{data:f._arrayBufferToBase64(this.result),format:h.format,type:f._getStreamType(h)});g.resolve(i)};e.readAsArrayBuffer(h);return g.promise},_typeMap:{"application/json":"CXPExperience_Spec","image/jpeg":"CXPPictureResource_Spec"},_getStreamType:function(f){for(var e in this._typeMap){if(f.type===e){return this._typeMap[e]}}return undefined},resolveLinkAsStream:function(g){var f=this._storage.get(g);if(!f){return d.Promise.reject(g+" Object not find")}if(d.is(f.data)){var e=new Blob([this._base64ToArrayBuffer(f.data)],{type:"application/octet-binary"});e.format=f.format;return d.Promise.resolve(e)}else{return d.Promise.reject("cannot read that")}},_base64ToArrayBuffer:function(f){var e=window.atob(f);var g=new Uint8Array(e.length);for(var h=0;h<e.length;h++){g[h]=e.charCodeAt(h)}return g.buffer},_arrayBufferToBase64:function(f){var h="";var e=new Uint8Array(f);for(var g=0;g<e.byteLength;g++){h+=String.fromCharCode(e[g])}return window.btoa(h)},getJSONDescription:function(){return{objectType:"CAT3DExpLocalStorage",databaseName:this._dataBaseName}}});return a});define("DS/CAT3DExpLinkContext/CAT3DExpFilesLinkContext",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpLinkContext/CAT3DExpLinkContext"],function(d,c,b){var a=b.extend({init:function(f){this._links=[];this._files=f;for(var e=0;e<f.length;e++){this._links.push({StreamName:this._files[e].name})}},getLinkDescriptionByType:function(f){for(var e=0;e<this._links.length;e++){if(this._getLinkType(this._links[e])===f){return d.Promise.resolve(this._links[e])}}return d.Promise.reject()},_typeExtMap:{".json":"CXPExperience_Spec",".cgr":"Model_VPMReference_Spec",".3dxml":"Model_VPMReference_Spec",".3dx":"Model_VPMReference_Spec",".3dxc":"Model_VPMReference_Spec",".jpg":"CXPPictureResource_Spec",".bmp":"CXPPictureResource_Spec",".png":"CXPPictureResource_Spec"},_getLinkType:function(f){for(var e in this._typeExtMap){if(f.StreamName.endsWith(e)){return this._typeExtMap[e]}}console.error("unknown link");return undefined},retrieveLinkDescriptions:function(){return c.resolve(this._links)},resolveLinkAsStream:function(f){if(f){for(var e=0;e<this._files.length;e++){if(this._files[e].name===f.StreamName){this._files[e].format=this._getLinkFormat(f);return d.Promise.resolve(this._files[e])}}}return d.Promise.reject("Unknown Link")},_formatExtMap:{".cgr":"cgr",".3dxml":"xmlv43",".3dx":"3dx",".3dxc":"3dxc"},_getLinkFormat:function(f){for(var e in this._formatExtMap){if(f.StreamName.endsWith(e)){return this._formatExtMap[e]}}return undefined},getNameForLinkDescription:function(f){var e=f.StreamName.lastIndexOf(".");return(e!==-1)?f.StreamName.substr(0,e):f.StreamName}});return a});define("DS/CAT3DExpLinkContext/CAT3DExpZipLinkContext",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpLinkContext/CAT3DExpLinkContext","DS/ZipJS/zip"],function(e,c,a,b){var d=a.extend({init:function(f){this._blob=new Blob([f],{type:"application/zip"});this._blobReader=new b.BlobReader(this._blob);this._links=null;this._entries=null},getLinkDescriptionByType:function(g){var f=this;return this.retrieveLinkDescriptions().done(function(j){for(var h=0;h<j.length;h++){if(f._getLinkType(j[h])===g){return j[h]}}return e.Promise.reject()})},_typeExtMap:{".json":"CXPExperience_Spec",".cgr":"Model_VPMReference_Spec",".3dx":"Model_VPMReference_Spec",".3dxc":"Model_VPMReference_Spec",".jpg":"CXPPictureResource_Spec",".bmp":"CXPPictureResource_Spec",".png":"CXPPictureResource_Spec"},_getLinkType:function(g){for(var f in this._typeExtMap){if(g.StreamName.endsWith(f)){return this._typeExtMap[f]}}console.error("unknown link");return undefined},retrieveLinkDescriptions:function(){if(this._links){return e.Promise.resolve(this._links)}if(this._retrieveLinksDeferred){return this._retrieveLinksDeferred.promise}this._retrieveLinksDeferred=e.Promise.deferred();var f=this;this._retrieveEntries().done(function(g){f._links=[];for(var h=0;h<g.length;h++){f._links.push({StreamName:g[h].filename})}f._retrieveLinksDeferred.resolve(f._links)});return this._retrieveLinksDeferred.promise},_retrieveEntries:function(){if(this._entries){return e.Promise.resolve(this._entries)}if(this._retrieveEntriesDeferred){return this._retrieveEntriesDeferred.promise}this._retrieveEntriesDeferred=e.Promise.deferred();var f=this;b.createReader(this._blobReader,function(g){g.getEntries(function(h){f._entries=h;f._retrieveEntriesDeferred.resolve(f._entries)})});return this._retrieveEntriesDeferred.promise},resolveLinkAsStream:function(g){if(!g){return e.Promise.reject("Unknown Link")}var f=this;return this._retrieveEntries().done(function(h){for(var j=0;j<h.length;j++){if(h[j].filename===g.StreamName){return f._getBlobFromZippedFile(h[j],g)}}return e.Promise.reject("Unknown Link")})},_getBlobFromZippedFile:function(h,i){var g=e.Promise.deferred();var f=this;h.getData(new b.BlobWriter(),function(j){j.name=h.filename;j.format=f._getLinkFormat(i);g.resolve(j)});return g.promise},_formatExtMap:{".cgr":"cgr",".3dxml":"xmlv43",".3dx":"3dx",".3dxc":"3dxc"},_getLinkFormat:function(g){for(var f in this._formatExtMap){if(g.StreamName.endsWith(f)){return this._formatExtMap[f]}}return undefined},getNameForLinkDescription:function(g){var f=g.StreamName.lastIndexOf(".");return(f!==-1)?g.StreamName.substr(0,f):g.StreamName}});return d});define("DS/CAT3DExpLinkContext/CAT3DExpPLMDocumentLinkContext",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpLinkContext/CAT3DExpLinkContext","DS/DocumentManagement/DocumentManagement","DS/WAFData/WAFData","DS/CAT3DExpModel/CAT3DXModel"],function(g,f,c,e,a,d){var b=c.extend({init:function(h){this._objectId=h.objectId},getLinkDescriptionByType:function(i){var h=g.Promise.deferred();this.retrieveLinkDescriptions().done(function(j){var k=j[0].split(".").pop();if(k==="ctps"&&i==="CityPresentation"){h.resolve(j[0])}else{if((k==="json"||k==="ctxp")&&i==="CIDComponentCityAsset"){h.resolve(j[0])}}if(k==="exprd"&&i==="ProductPresentation"){h.resolve(j[0])}else{h.reject()}});return h.promise},retrieveLinkDescriptions:function(){if(this._links){return g.Promise.resolve(this._links)}if(this._retrieveLinksDeferred){return this._retrieveLinksDeferred.promise}this._retrieveLinksDeferred=g.Promise.deferred();var h=this;this._getFilesInfo().done(function(i){h._links=i.map(function(j){return j.fileName});h._retrieveLinksDeferred.resolve(h._links)});return this._retrieveLinksDeferred.promise},_getFilesInfo:function(){if(this._filesInfo){return g.Promise.resolve(this._filesInfo)}if(this._filesInfoDeferred){return this._filesInfoDeferred}this._filesInfoDeferred=g.Promise.deferred();var h=this;var j,i;d.getFactory().getPlatformId().done(function(k){j=k;return d.getFactory().getServerURL()}).done(function(k){i=k;return d.getFactory().getSecurityContext()}).done(function(k){e.getDocuments([h._objectId],{tenant:j,tenantUrl:i,securityContext:k,onComplete:function(n){if(n.data.length<1){h._filesInfoDeferred.reject(n);return}var m=n.data[0].relateddata.files;h._filesInfo=[];for(var l=0;l<m.length;l++){h._filesInfo.push({id:m[l].id,fileName:m[l].dataelements.title})}h._filesInfoDeferred.resolve(h._filesInfo)},onFailure:function(l){h._filesInfoDeferred.reject(l)}})});return this._filesInfoDeferred.promise},_getFileId:function(h){return this._getFilesInfo().done(function(k){for(var j=0;j<k.length;j++){if(k[j].fileName===h){return k[j].id}}return g.Promise.reject()})},_getFileURL:function(l){var i=g.Promise.deferred();var h=this;var k,j;d.getFactory().getPlatformId().done(function(m){k=m;return d.getFactory().getServerURL()}).done(function(m){j=m;return d.getFactory().getSecurityContext()}).done(function(m){e.downloadDocument([h._objectId],l,false,{tenant:k,tenantUrl:j,securityContext:m,onComplete:function(n){i.resolve(n)},onFailure:function(n){i.reject(n)}})});return i.promise},_getFile:function(i){var h=this;return this._getFileId(i).done(function(j){return h._getFileURL(j)}).done(function(k){var j=g.Promise.deferred();a.authenticatedRequest(k,{method:"GET",type:"json",headers:{"content-type":"application/json"},proxy:"passport",onComplete:function(l){j.resolve(new Blob([JSON.stringify(l)],{type:"text/plain;charset=utf-8"}))},onFailure:function(l){j.reject(l)}});return j.promise})},resolveLinkAsStream:function(h){return this._getFile(h).done(function(i){return i})},getJSONDescription:function(){return{protocol:"PLMDoc",objectId:this._objectId}},pushStream:function(i){var h=i.name;var j=new f(function(n,m){var l={title:h,type:"Document",policy:"Document Release",fileInfo:{file:i}};var o,k;d.getFactory().getPlatformId().done(function(p){o=p;return d.getFactory().getServerURL()}).done(function(p){k=p;return d.getFactory().getSecurityContext()}).done(function(q){var p={tenant:o,tenantUrl:k,securityContext:q,onComplete:n,onFailure:m};e.createDocument(l,p)})});return j}});return b});define("DS/CAT3DExpLinkContext/CAT3DExpLinkContextFactory",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpModel/CAT3DXModel","DS/CAT3DExpLinkContext/CAT3DExpFilesLinkContext","DS/CAT3DExpLinkContext/CAT3DExpLocalStorageLinkContext","DS/CAT3DExpLinkContext/CAT3DExpRTVLinkContext","DS/CAT3DExpLinkContext/CAT3DExpZipLinkContext","DS/CAT3DExpLinkContext/CAT3DExpPLMDocumentLinkContext"],function(e,h,c,a,b,i,f,g){var d=e.Class.extend({init:function(j){this._experienceBase=j;this._dataTransferLinkContext=[{constructor:b,description:{objectType:"CAT3DExpLocalStorage"}},{constructor:g,description:{objectType:"Document",serviceId:"3DSpace"}}];this._jsonDescriptionLinkContext=[{constructor:b,description:{objectType:"CAT3DExpLocalStorage"}},{constructor:g,description:{protocol:"PLMDoc"}}]},registerLinkContextForDatatransfer:function(k,j){this._dataTransferLinkContext.push({constructor:k,description:j})},getLinkContextFromDataTransfer:function(n){if(n.files.length>0){if(n.files.length===1&&n.files[0].name.endsWith(".3dx")){return new f(n.files[0])}return new a(n.files)}try{var j=JSON.parse(n.getData("text/plain"));var l=j.data.items[0];for(var k=0;k<this._dataTransferLinkContext.length;k++){if(this._isObjectMatchDescription(l,this._dataTransferLinkContext[k].description)){return new this._dataTransferLinkContext[k].constructor(l)}}console.error("cannot retrieve link context");return undefined}catch(m){console.error("cannot compute link context : error parsing data");return undefined}},_isObjectMatchDescription:function(l,j){for(var k in j){if(l[k]!==j[k]){return false}}return true},registerLinkContextForJSONDescription:function(k,j){this._jsonDescriptionLinkContext.push({constructor:k,description:j})},getLinkContextFromJSONDescription:function(j){for(var k=0;k<this._jsonDescriptionLinkContext.length;k++){if(this._isObjectMatchDescription(j,this._jsonDescriptionLinkContext[k].description)){return new this._jsonDescriptionLinkContext[k].constructor(j)}}return undefined}});return d});