/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CATWebUXTooltipManager/CATWebUXTooltipManager",["UWA/Class","UWA/Core","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/Selection/PSOManager","DS/Core/Events","css!DS/CATWebUXTooltipManager/CATWebUXTooltipManager.css"],function(j,i,d,g,h,f){var e=4,c=70;var k=j.extend({init:function(n){var L=0,F,q,p,z,s,m,A;var y={},x,E=[],D,N;var t=n.context.getViewer();var M,G,J;function C(){if(!D){D=i.createElement("div",{id:"CATWebUXtooltip","class":"CATWebUXtooltip top"}).inject(n.context.getFrameWindow().getUIFrame());i.createElement("div",{"class":"CATWebUXtooltip-arrow"}).inject(D);N=i.createElement("div",{"class":"CATWebUXtooltipbody"}).inject(D);D.addEventListener("mouseleave",function(){G=false;if(!J){J=setTimeout(function(){I();J=0},1000)}});D.addEventListener("mouseenter",function(){G=true;if(J){clearTimeout(J);J=0}})}M=false;if(J){clearTimeout(J);J=0}o()}this.clearTooltipManager=function(){this.destroyTooltip();var O=this;if(E){E.forEach(function(P){O.unregister(P.token);P.obj=null})}if(s){clearTimeout(s);s=undefined}if(m){clearTimeout(m);m=undefined}if(J){clearTimeout(J);J=undefined}y=x=E=D=N=t=null};this.destroyTooltip=function(){r();if(D){D.destroy()}D=N=undefined};function u(O){if(O.eventType==="@onViewpointBeginMove"){r()}}function w(P){var O=P;E.some(function(Q){if(Q.obj.filterPath){var R=Q.obj.filterPath(P);if(R){O=R}return R?true:false}});return O}function v(P){var O=t.pick(t.getMousePosition(P),!t.picking.primitive?"mesh":"primHybrid",false);if(!O||!O.path||O.path.length<1){return null}return w(O.path[0])}function B(Q){var O=Q.from[0].getCurrentPosition(t.canvas);if(Q.eventType==="@onLeftMouseDownEvent"&&Q.from[0].event.buttons===1){var P=v(O);if(!P){r();return}if(y.x!==O.x||y.y!==O.y||!D||!D.hasClassName("visible")){r();x=P.clone();var R=setTimeout(function(){if(R===s){K([P],e)}},100);s=R}y=O}else{if(Q.eventType==="@onLeftMouseUpEvent"||Q.eventType==="@onRightMouseUpEvent"){r();y=O}else{if(Q.eventType==="@onLongHoldEvent"){y=O;var P=v(O);if(!P){r();return}if(!x||!x.isEqual(P)){o();x=P.clone()}clearTimeout(s);s=undefined;clearTimeout(m);m=undefined;var R=setTimeout(function(){if(R===s){d.addEvent(t.canvas,"onRelease",B);K([P],c,true)}},100);s=R}else{if(Q.eventType==="@onReleaseEvent"){if(Q.from[0].type==="Touch"&&M){J=setTimeout(function(){I();J=0},2000)}else{r()}y=O;d.removeEvent(t.canvas,"onRelease",B)}}}}}function l(R){D.removeClassName("top");D.removeClassName("left");D.removeClassName("right");var P="top";var O=(y.x-(N.offsetWidth)/2),Q=(y.y-N.offsetHeight-8-R);if(Q<0){Q=y.y-N.offsetHeight/2;if(Q<0){Q=0}P="right";O=y.x+10+R;if((O+N.offsetWidth)>t.SCREEN_WIDTH){P="left";O=y.x-N.offsetWidth-8-R}}else{if(O<0){P="right";O=y.x+10+R;Q=y.y-N.offsetHeight/2}else{if((O+N.offsetWidth)>t.SCREEN_WIDTH){P="left";O=y.x-N.offsetWidth-8-R;Q=y.y-N.offsetHeight/2}}}D.addClassName(P);D.setStyles({left:O+"px",top:Q+"px"})}function K(O,T,R){function S(U,V){Q--;if(!V||!V.token||!V.div){if(D){o()}return}if(typeof V.token!=="number"||V.token!==s){if(D){o()}return}if(V.interactiveContent){M=true}P[U]=V.div;if(Q===0){N.empty();P.forEach(function(W){W.inject(N)});N.removeClassName("prefill");l(T);if(M){D.setStyle({"pointer-events":""})}else{D.setStyle({"pointer-events":"none !important"})}}}C();N.empty();N.addClassName("prefill");D.addClassName("visible");l(T);var Q=E.length,P=[];E.forEach(function(V,U){V.obj.onTooltipReady({arrayPath:O,token:s,completed:function(W){S(U,W)},fromTouchEvt:R})})}function H(){var O=h.get()[0];if(!O||(O&&!O.event)){return}var R=O.event.getCurrentPosition(t.canvas);if(!R||(y.x===R.x&&y.y===R.y)){return}y=R;clearTimeout(m);m=undefined;var P=O.pathElement;P=w(P);if(!P){r();return}if(!x||!x.isEqual(P)){if(M&&D&&D.hasClassName("visible")){if(!J){J=setTimeout(function(){I();J=0},1000)}return}o();x=P.clone()}else{if(D&&D.hasClassName("visible")){if(J){clearTimeout(J);J=0}m=setTimeout(function(){l(O.event&&O.event.type==="Touch"?c:e)},500);return}}clearTimeout(s);s=undefined;var Q=setTimeout(function(){if(Q===s){K([P],O.event&&O.event.type==="Touch"?c:e)}},500);s=Q}function r(){clearTimeout(J);J=0;clearTimeout(s);clearTimeout(m);s=m=x=undefined,y={};o()}function o(){if(D){D.removeClassName("visible")}}function I(){if(!G){r();H()}}this.register=function(Q){if(!Q||!Q.onTooltipReady){return}var O,P=E.some(function(R){if(R.obj===Q){O=R.token;return true}});if(!P){O=++L;E.push({token:O,obj:Q});if(!F){F=h.onPostAdd(H);z=h.onRemove(function(){if(J){clearTimeout(J);J=0}if(M){J=setTimeout(function(){I();J=0},500)}});p=h.onEmpty(function(){if(J){clearTimeout(J);J=0}if(M){J=setTimeout(function(){I();J=0},500)}else{r()}});q=t.onViewerResize(r);A=f.subscribe({event:"/VISU/"},u);d.addEvent(t.canvas,"onLeftMouseDown",B);d.addEvent(t.canvas,"onLeftMouseUp",B);d.addEvent(t.canvas,"onRightMouseUp",B);d.addEvent(t.canvas,"onLongHold",B)}}return O};this.unregister=function(O){var P;E.some(function(R,Q){if(R.token===O){P=O;E.splice(Q,1);return true}});if(E.length===0){h.unsubscribe(F);F=undefined;h.unsubscribe(p);p=undefined;h.unsubscribe(z);z=undefined;t.unsubscribe(q);q=undefined;f.unsubscribe(A);A=undefined;d.removeEvent(t.canvas,"onLeftMouseDown",B);d.removeEvent(t.canvas,"onLeftMouseUp",B);d.removeEvent(t.canvas,"onRightMouseUp",B);d.removeEvent(t.canvas,"onLongHold",B);this.destroyTooltip()}return P}}});var b=[];var a=j.singleton({init:function(){},giveTooltipManager:function(l){var m;if(l&&l.context&&l.context.getViewer&&l.context.getFrameWindow){b.some(function(n){if(n.context===l.context){m=n.tooltipMng;n.counter++;return true}})}return m},getTooltipManager:function(l){var m=this.giveTooltipManager(l);if(!m&&l&&l.context&&l.context.getViewer&&l.context.getFrameWindow){m=new k({context:l.context});b.push({context:l.context,tooltipMng:m,counter:1})}return m},unreferenceTooltipManager:function(l){if(l&&l.context&&l.context.getViewer&&l.context.getFrameWindow){b.some(function(n,m){if(n.context===l.context){n.counter--;if(n.counter<=0){b[m].tooltipMng.clearTooltipManager();b.splice(m,1)}return true}})}}});return a});