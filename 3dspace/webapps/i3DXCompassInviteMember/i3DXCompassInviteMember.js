define("DS/i3DXCompassInviteMember/Views/SelectAppsView",["UWA/Core","UWA/Class/View","UWA/Controls/Pager","DS/i3DXCompassCmp/Controls/Input/Text","DS/UIKIT/Input/Toggle","DS/UIKIT/Mask","DS/i3DXCompassCore/Utils","DS/i3DXCompassCore/Controls/PlatformNotify","DS/i3DXCompassCmp/Modal/Prereq","DS/i3DXCompassCmp/Modal/PrereqError","DS/i3DXCompassCore/Collection/ProcessCollection","UWA/Event","i18n!DS/i3DXCompassInviteMember/assets/nls/i3DXCompassInviteMember"],function(g,e,a,h,j,f,i,k,d,c,b,l,m){return e.extend({tagName:"div",hideTableWithoutLicences:1,hideTableWithLicences:0,setup:function(n){if(n.collectionSelected){this.collectionSelected=n.collectionSelected}if(n.platform){this.platform=n.platform}else{throw new Error("platform is mandatory")}if(n.disabledCrossCompany){this.disabledCrossCompany=n.disabledCrossCompany}this._disabledRoles=[];this.preSelectedRoleDone=false;return n},render:function(){this._managePreselection();this.filterData();if(!this.subView){this.container.setContent(this.buildAppSkeleton());this.mask()}else{if(!this.collectionFull){this.collectionFull=new b();this.collectionFull.add(this.collection.toJSON());if(this.options.collectionWithOutLicenses){this.collectionWithOutLicensesFull=new b();this.collectionWithOutLicensesFull.add(this.options.collectionWithOutLicenses.toJSON())}if(this.collectionSelected){this._managePreselection();if(this.collectionSelected.size()>0){this.filterData()}}}this.subView.setContent(this.buildSubView());this.unmask()}if(this.options.setNextDisabled){this._manageNextButton()}return this},_manageNextButton:function(){var n=this.options.tagger?this.options.tagger.getSelected().length:1;if(n&&this.collectionSelected.size()>0){this.options.setNextDisabled(false)}else{this.options.setNextDisabled(true)}},_managePreselection:function(){var p=this.options.tagger?this.options.tagger.getSelected().length:1,o,q,n=this.platform.canCrossCompany()&&!this.disabledCrossCompany;if(this.collectionSelected&&this.collectionFull&&!this.preSelectedRoleDone){o=this.collectionFull.filter(function(s){var r=n?true:s.get("free")>=p;return s.get("isPlatform")===true&&r});if(o.length===1){q=o[0];this.collectionSelected.add(q);this._disabledRoles.push(q.get("trigram"))}this.preSelectedRoleDone=true}},getMaxFreeRole:function(){var n=null;if(this.collectionSelected){this.collectionSelected.forEach(function(o){n=!n?o.get("free"):Math.min(n,o.get("free"))})}return n},buildAppSkeleton:function(){return[this.buildSearch(),this.buildSubView()]},buildSubView:function(){this.subView=g.createElement("div",{styles:{position:"relative"},"class":"wrapper",html:[this.collectionSelected&&this.collectionSelected.size()>0?this.buildSelectedTable():{"class":"text-center",text:this.options.emptyText||""},this.collection&&this.collection.size()>0?(this.options.collectionWithOutLicenses)?this.buildWithoutLicensesTable(this.collection):this.buildTable():null,this.options.collectionWithOutLicenses&&this.options.collectionWithOutLicenses.size()>0?this.buildWithoutLicensesTable(this.options.collectionWithOutLicenses):null]});return this.subView},buildSelectedTable:function(){return{tag:"table","class":"table table-hover table-select-process table-selection",html:[{tag:"thead",html:{tag:"tr",html:[{tag:"th",colspan:2,text:m.get("Selected")}]}},{tag:"tbody",html:this.buildSelectedRows()}]}},buildSelectedRows:function(){var o=[],n=this;this.collectionSelected.forEach(function(p){o.push(n.buildRow(p))});return o},buildTable:function(){var n=function(q){var p=q.target.getParent("table").getElement("tbody"),o=q.target.getParent("table").getElement(".fonticon");if(o.hasClassName("fonticon-down-dir")){p.hide();o.removeClassName("fonticon-down-dir").addClassName("fonticon-right-dir")}else{p.show();o.removeClassName("fonticon-right-dir").addClassName("fonticon-down-dir")}};return{tag:"table","class":"table table-hover table-select-process",html:[{tag:"thead",html:{tag:"tr",html:[{tag:"th",colspan:2,text:(this.options.titleTableCollection)?this.options.titleTableCollection:m.get("Available")}]}},{tag:"tbody",html:this.buildRows()}]}},buildWithoutLicensesTable:function(q){var o=this,n=(q===this.options.collectionWithOutLicenses),r=(n)?this.hideTableWithoutLicences:this.hideTableWithLicences,p=function(u){var t=u.target.getParent("table").getElement("tbody"),s=u.target.getParent("table").getElement(".fonticon");if(s.hasClassName("fonticon-down-dir")){t.hide();s.removeClassName("fonticon-down-dir").addClassName("fonticon-right-dir")}else{t.show();s.removeClassName("fonticon-right-dir").addClassName("fonticon-down-dir")}};return{tag:"table","class":"table table-hover table-select-process",html:[{tag:"thead",html:{tag:"tr",styles:{cursor:"pointer"},html:[{tag:"th",text:(n)?this.options.titleTableCollectionWithOutLicenses:this.options.titleTableCollection},{tag:"th",html:[{tag:"span","class":(r)?"fonticon fonticon-right-dir":"fonticon fonticon-down-dir",styles:{"float":"right","font-size":"14px",cursor:"pointer"},events:{click:function(s){p(s);if(n){o.hideTableWithoutLicences=(o.hideTableWithoutLicences)?0:1}else{o.hideTableWithLicences=(o.hideTableWithLicences)?0:1}g.Event.stopPropagation(s)}}}]}],events:{click:function(s){p(s);if(n){o.hideTableWithoutLicences=(o.hideTableWithoutLicences)?0:1}else{o.hideTableWithLicences=(o.hideTableWithLicences)?0:1}g.Event.stopPropagation(s)}}}},{tag:"tbody",styles:{display:(r)?"none":""},html:this.buildRows(q)}]}},buildRows:function(q){var p=[],o=this,n=this.collection;if(q){n=q}n.forEach(function(r){p.push(o.buildRow(r,"other"))});return p},buildRow:function(o){var r=this,s=function(t){var v=null,y,w=0,x,u=function(z){z.forEach(function(A){v=(r.platform.canCrossCompanyExtended()&&!r.disabledCrossCompany&&r.collectionWithOutLicensesFull&&r.collectionWithOutLicensesFull.get(A.get("uid")))?r.collectionWithOutLicensesFull.get(A.get("uid")):r.collectionFull.get(A.get("uid"));if(v){r.collectionSelected.add(v);r.collection.remove(y)}})};if(r.options.tagger){w=r.options.tagger.getSelected().length}if(t.isChecked()){if(o.hasFree()||o.isTPA()||o.isCustom()){x=new d({selectedCollection:r.collectionSelected,model:o,number:w,onConfirm:function(z){u(z);r.collectionSelected.add(o);if(r.platform.canCrossCompanyExtended()&&!r.disabledCrossCompany&&r.options.collectionWithOutLicenses&&r.options.collectionWithOutLicenses.remove(o.id)){r.options.collectionWithOutLicenses.set(r.options.collectionWithOutLicenses.sortBy("name"))}else{r.collection.remove(o.id);r.collection.set(r.collection.sortBy("name"))}r.collectionSelected.set(r.collectionSelected.sortBy("name"));r.render();r._manageCrossCompanySelection()},onCancel:function(){t.uncheck()}});if(x.isNeeded()){x.confirm()}else{r.collectionSelected.add(o);if(r.platform.canCrossCompanyExtended()&&!r.disabledCrossCompany&&r.options.collectionWithOutLicenses&&r.options.collectionWithOutLicenses.remove(o.id)){r.options.collectionWithOutLicenses.set(r.options.collectionWithOutLicenses.sortBy("name"))}else{r.collection.remove(o.id);r.collection.set(r.collection.sortBy("name"))}r.collectionSelected.set(r.collectionSelected.sortBy("name"));r.render();r._manageCrossCompanySelection()}}else{k.warn(m.get("You have not enough role"))}}else{x=new c({model:o,selectedCollection:r.collectionSelected,onCancel:function(){t.check()}});if(x.isNeeded()){x.show()}else{r.collectionSelected.remove(o.id);r.collectionSelected.set(r.collectionSelected.sortBy("name"));if(r.platform.canCrossCompanyExtended()&&!r.disabledCrossCompany&&r.options.collectionWithOutLicenses&&!o.get("withLicenses")){r.options.collectionWithOutLicenses.add(o);r.options.collectionWithOutLicenses.set(r.options.collectionWithOutLicenses.sortBy("name"))}else{r.collection.add(o);r.collection.set(r.collection.sortBy("name"))}r.render();r._manageCrossCompanySelection()}}},q=r.collectionSelected.contains(o);if(o.isTPA()&&o.get("private")===false){q=true}function n(){var u=false,t=null;if(r.options.tagger){t=r.options.tagger.getSelected().length}if(this._disabledRoles.indexOf(o.get("trigram"))>-1){u=true}if((!o.canCrossCompany()||r.disabledCrossCompany)&&o.isDisabled(false,t)){u=true}if(!o.isTPA()&&!o.isCustom()&&!o.canCrossCompany()&&this._isCrossCompanyRoleDisabled()){}return u}var p=new j({"data-free":o.get("free"),className:"primary",type:"checkbox",name:"licenses[]",value:o.get("uid"),id:o.get("uid"),label:o.get("option")===true?i.getTextFromHtml(o.get("name"))+" "+m.get("(Option)"):i.getTextFromHtml(o.get("name")),checked:q,disabled:n.call(this)});return g.createElement("tr",{html:[{tag:"td",styles:{"vertical-align":"middle"},html:p},{tag:"td","class":r.platform.canCrossCompany()&&!r.disabledCrossCompany&&!o.isTPA()&&!o.isCustom()&&q?"":"text-right status",html:r.platform.canCrossCompany()&&!r.disabledCrossCompany&&!o.isTPA()&&!o.isCustom()&&q?this._createCrossCompany(o):this._getInformation(o)}],events:{click:function(u){if(p.isDisabled()){return}else{if(!u.target.getParent(".toggle-switch")){var t=!p.isChecked();p.setCheck(t);s(p);l.stop(u)}}}}})},_getInformation:function(o,q){var n="",p="";if(o.isTPA()){n=g.String.format(m.get("Type: {0}"),o.getDisplayType())}else{if(!o.isCustom()&&o.get("free")<(this.options.tagger?this.options.tagger.getSelected().length:1)){if(this.platform.canCrossCompany()&&!this.disabledCrossCompany){if(!o.get("withLicenses")){n=m.get("No license associated")}else{n=g.String.format(m.get("Not enough licenses available ({0} remaining)"),o.get("free"))}}else{n=g.String.format(m.get("Not enough roles available ({0} remaining)"),o.get("free"))}p="text-error"}else{if(!o.isCustom()){n=o.get("total")?g.String.format(m.get("Used: {0}/{1}"),(o.get("total")-o.get("free")),o.get("total")):""}}}return{tag:"span","class":p,text:q&&n!==""?" - "+n:n}},_manageCrossCompanySelection:function(o){var q=this,r=this.container.getElements(".table-selection tbody tr"),p,n=this.collectionSelected.find(function(s){return s.isWA()&&!s.canCrossCompany()});if(!this._isCrossCompanyRoleDisabled()){if(o&&q.platform.getCrossCompanyRoles().indexOf(o.get("trigram"))>-1){p=o}else{p=this.collectionSelected.find(function(s){return q.platform.getCrossCompanyRoles().indexOf(s.get("trigram"))>-1})}r.forEach(function(u){var t=u.getElement("[name=licensed\\[\\]]"),s=u.getElement("[name=restricted\\[\\]]");if(p&&t&&s){var v=q.collectionSelected.find(function(w){return w.get("trigram")===t.getAttribute("data-trigram")});if(g.is(n)){if(q.platform.getCrossCompanyRoles().indexOf(t.getAttribute("data-trigram"))>-1){p.set("licensed",true);t.checked=p.get("licensed");t.disabled=true;s.checked=p.get("restricted");s.getParent().toggleClassName("hidden",!p.get("licensed"));v.set("licensed",p.get("licensed"));v.set("restricted",p.get("restricted"))}else{s.getParent().toggleClassName("hidden",!t.checked)}}else{if(q.platform.getCrossCompanyRoles().indexOf(t.getAttribute("data-trigram"))>-1){t.checked=p.get("licensed");t.disabled=false;s.checked=p.get("restricted");s.getParent().toggleClassName("hidden",!p.get("licensed"));v.set("licensed",p.get("licensed"));v.set("restricted",p.get("restricted"))}else{s.getParent().toggleClassName("hidden",!t.checked)}}}})}},_isCrossCompanyRoleDisabled:function(){var o=this,n;if(o.options.tagger){n=o.options.tagger.getSelected().length}return !!this.collectionSelected.find(function(p){return o.platform.getCrossCompanyRoles().indexOf(p.get("trigram"))>-1&&p.isAssignDisabled(undefined,n)})},_createCrossCompany:function(o){var r=this,s=(!o.get("withLicenses"))||(this.platform.getCrossCompanyRoles().indexOf(o.get("trigram"))>-1||(!o.isTPA()&&!o.isCustom()&&!o.canCrossCompany()))&&this._isCrossCompanyRoleDisabled(),n=!s&&!o.isDisabled(false,r.options.tagger?r.options.tagger.getSelected().length:null)&&(g.is(o.get("licensed"))?o.get("licensed"):true),q=new j({className:"primary",type:"switch",name:"licensed[]",attributes:{"data-trigram":o.get("trigram")},checked:n,value:o.get("uid"),disabled:s||!o.canCrossCompany()||o.isDisabled(false,r.options.tagger?r.options.tagger.getSelected().length:null),label:"",events:{onClick:function(){o.set("licensed",this.isChecked());r._manageCrossCompanySelection(o)}}}),p=o.get("withLicenses")?new j({className:"primary"+(n?" ":" hidden"),type:"switch",name:"restricted[]",attributes:{"data-trigram":o.get("trigram")},checked:g.is(o.get("restricted"))?o.get("restricted"):true,value:o.get("uid"),label:m.get("Restrict Usage to this Platform"),disabled:!o.canCrossCompany()||o.isWU(),events:{onClick:function(){o.set("restricted",this.isChecked());r._manageCrossCompanySelection(o)}}}):null;q.getContent().getElement("label").setContent([{tag:"span",text:m.get("Assign License")},{tag:"span",html:this._getInformation(o,true)}]);return[q,p]},filterData:function(){var n=this;n.collectionSelected.forEach(function(o){if(o){n.collection.remove(o.id)}})},_fetchSearch:function(p){var o=this,n=0;this.mask();this.collection.setQuery(p);this.collection.setOffset(0);this.collection.reset();this.collection.fetch({onComplete:function(){if(!o.options.collectionWithOutLicenses||n===2){o.render();o._manageCrossCompanySelection()}else{n=1}}});if(this.platform.canCrossCompanyExtended()&&!this.disabledCrossCompany&&this.options.collectionWithOutLicenses){this.options.collectionWithOutLicenses.setQuery(p);this.options.collectionWithOutLicenses.setOffset(0);this.options.collectionWithOutLicenses.reset();this.options.collectionWithOutLicenses.fetch({onComplete:function(){if(n===1){o.render();o._manageCrossCompanySelection()}else{n=2}}})}},_search:function(o){var n=this,p;if(((!this.platform.canCrossCompany()||this.disabledCrossCompany)&&this.collection.isFetched())||(this.options.collectionWithOutLicenses&&this.options.collectionWithOutLicenses.isFetched()&&this.collection.isFetched())){this._fetchSearch(o)}else{p=function(){n.collection.removeEvent("onAdd",p);setTimeout(function(){n._fetchSearch(o)},100)};this.collection.addEvent("onAdd",n._search(o))}},buildSearch:function(){var n=this;return new h({attributes:{placeholder:this.options.searchPlaceholder,value:this.collection.getQuery()||"",events:{keyup:function(){n._search.call(n,this.value)}}}})},getBody:function(){if(!this.content){this.content=this.container.getElement(".wrapper")}return this.content},mask:function(){if(!this.isMasked()){f.mask(this.getBody());this.masked=true}},unmask:function(){if(this.isMasked()){f.unmask(this.getBody());this.masked=false}},isMasked:function(){return this.masked}})});define("DS/i3DXCompassInviteMember/Modal/InviteMember",["UWA/Core","UWA/Controls/Abstract","UWA/Controls/Input","DS/UIKIT/Mask","DS/UIKIT/Tooltip","DS/i3DXCompassCmp/Modal/FullScreenModal","DS/UIKIT/Input/Text","DS/UIKIT/Input/Select","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Button","DS/UIKIT/Input/ButtonGroup","DS/UIKIT/Input/File","DS/i3DXCompassCore/Controls/PlatformNotify","DS/i3DXCompassCore/Utils/Data","DS/i3DXCompassCmp/Controls/Tagger","DS/i3DXCompassCore/Utils","DS/i3DXCompassInviteMember/Views/SelectAppsView","DS/i3DXCompassCore/Collection/ProcessCollection","DS/i3DXCompassCore/Collection/AppsCollection","DS/i3DXCompassCore/Collection/MemberCollection","DS/i3DXCompassCore/Model/ImportModel","DS/i3DXCompassCore/Model/PlatformModel","DS/i3DXCompassCore/Model/UserRightModel","i18n!DS/i3DXCompassInviteMember/assets/nls/i3DXCompassInviteMember"],function(k,z,A,G,C,a,B,r,u,p,w,d,v,i,l,e,q,D,y,c,s,E,j,o){var t=0,g=1,F=10,f=0,m=999,b="-1",h="Contractor",n,x;return z.extend({defaultOptions:{platform:null,onAdded:function(){}},casualType:{casual:f},mode:t,step:0,viewStep2Casual:null,id:e.getUUID(),selectedLicenses:[],nextButtonDisabled:true,locationsView:null,init:function(H){var I=this;I._parent(H);if(H.mode){this.mode=H.mode}this.platform=H.platform;this.inviteInProgress=false;this.uploadInProgress=false;I.casualHasRole={};this.buildContainer()},buildContainer:function(){var J=this,K=new D([]),I=4,H=function(){I--;if(I===0){J.viewStep1=J.buildContent();J.modal.unmask();J.elements.container.setBody(J.viewStep1);J.dispatchEvent("onRendered")}};this.modal=new a({closable:true,className:"invite-member",header:this.getModalTitle(),body:{"class":"empty-body"},footer:"",events:{onHide:function(){this.destroy()}}});this.elements.container=this.modal;this.elements.container.inject(document.body,"top").show();this.modal.mask();J.elements.container.setFooter(J.getButtons());new j().fetch({onComplete:function(L,M){J.roles=M.roles;J.agreements=M.agreements;H()}});J.platform.fetch({data:{id:this.platform.get("id"),availability:true},onComplete:function(L){J.data=L.toJSON();H()}});K.fetch({data:{selfexp:false,platform:J.platform.get("id"),casual:0,limit:1,apps:false},onComplete:function(L){J.casualHasRole[J.casualType.casual]=L.length>0;J.manageButtonNextText(J.casualHasRole[J.casualType.casual]);H()}});e.getParentModule("DS/UWPClientCode/I18n",function(L){x=L;H()})},_canCrossCompany:function(){return this.mode===t&&this.platform.canCrossCompany()},buildContent:function(){var H,N=x.getSupportedLanguages(),M,J,O,I=[],K=this,L=this.buildCasual();if(this.step===0){for(M in N){if(N.hasOwnProperty(M)){J=N[M];O=J.localizedName+" ("+J.staticName+")";I.push({value:M,label:O,selected:M===this.options.lang})}}if(this.mode===t){this.elements.tagger=new l({placeholder:o.get("Enter email"),limit:this._getMinAvailability(),focus:true,validator:function(P){return e.isEmail(P)},onError:function(P){var Q=K.casualType.free===0&&!K._canCrossCompany()?o.get("No more roles available"):o.get("Your Email is not valid");if(!P&&!K.errorInterval){setTimeout(function(){if(K.elements.container.isVisible===true){v.alert(Q)}},200);K.errorInterval=true;setTimeout(function(){K.errorInterval=null},2000)}K.setNextDisabled(true)},onLimitError:function(){var P=(F<K.casualType.free)?k.String.format(o.get("You cant add more than {0} emails"),F):o.get("No more roles available");if(K._getMinAvailability()<F&&K._getMinAvailability()<K.casualType.free){k.String.format(o.get("You cant add more than {0} emails because of selected roles"),K._getMinAvailability())}v.alert(P);K.errorInterval=true;setTimeout(function(){K.errorInterval=null},2000);K.setNextDisabled(true)},onSuccess:function(){var P=K.elements.tagger.getSelected().length;if(K.elements.tagger.elements.container.getElement(".has-error")===null){if((P>0&&(K.platform.get("platform")===true))||(P>0&&K.platform.get("platform")===false)){K.setNextDisabled(false)}else{K.setNextDisabled(true)}}else{K.setNextDisabled(true)}},validatorAsync:function(Q,R){var P=new c();K.setNextDisabled(true);P.setLimit(15);P.setOffset(0);P.setQuery(Q);P.setPlatform(K.platform.get("id"));P.fetch({onComplete:function(){var S=P.find(function(T){return T.get("email").toLowerCase()===Q.toLowerCase()});if(k.is(S)){v.alert(o.get("You cannot invite a user already on the platform"));K.setNextDisabled(true);R.onFailure()}else{R.onComplete()}},onFailure:function(){R.onFailure()}})},onChange:function(){var P=K.elements.tagger.getSelected().length;if(K.platform!=="none"){K.updateAvailability()}if(P){K.setNextDisabled(true)}}})}else{this.elements.iframe=k.createElement("iframe",{"class":"hidden",id:"uploadFrame"+this.id,name:"uploadFrame"+this.id,src:i.getUrl("resources")+"s.gif",events:{load:function(){K.modal.unmask();if(K.uploadInProgress){K.uploadInProgress=false;v.success(o.get("Import has been created"));if(K.options.onAdded){K.options.onAdded()}K.hide()}}}});this.elements.form=k.createElement("form",{"class":"form-wrapper",action:"#",method:"POST",enctype:"multipart/form-data",target:"uploadFrame"+this.id,html:[{tag:"input",type:"hidden",name:"__fcs__jobTicket",id:"__fcs__jobTicket"},new d({showResetButton:false,className:"input-file",attributes:{name:"file_import"},buttonBefore:false,events:{onChange:function(){var Q=this.elements.input,R=this.getValue(),S=e.getFileExtension(R),P=Q.getParent(".form-group");if(R!==""&&S==="csv"){P.removeClassName("has-error");K.setNextDisabled(false)}else{if(R!==""){K.setNextDisabled(true);P.addClassName("has-error");v.alert(o.get("Wrong file type. Please select a correct csv file."));this.setValue()}else{P.removeClassName("has-error");K.setNextDisabled(true)}}}}}),{tag:"a",target:"_blank",href:e.getAsset("data/import-sample.csv"),html:new p({value:o.get("See Example"),events:{onClick:function(){if(k.Utils.Client.Engine.ie){window.open(e.getAsset("data/import-sample.csv"))}}}})},{tag:"input",type:"hidden",value:i.getUrl("faillurePageImport"),name:"__fcs__failurePage",id:"__fcs__failurePage"},{tag:"input",type:"hidden",value:"false",name:"attachment",id:"attachment"},{tag:"input",type:"hidden",value:"",name:"file_0_name",id:"file_0_name"}]})}H=k.createElement("div",{html:[{"class":"row",html:{"class":"form-group col-sm-12",html:[this.elements.availability,{tag:"label","class":"control-label",html:this.mode===t?(k.i18n("Invite by email")+" <em>"+k.i18n("(If multiple separate by ';')")+"</em>"):k.i18n("Select a file to import")},this.mode===t?{"class":"wrapper",html:this.elements.tagger}:[this.elements.form]]}},this.mode===t?{"class":"row",html:[this.displayCompany()?this.buildCompany():this.buildPlatform()]}:{"class":"row",html:this.buildCompany()},this.mode===t?this.displayCompany()?{"class":"row",html:[this.buildPlatform()]}:{styles:{width:"40%"},html:this.buildCompany()}:null,{styles:{clear:"both"}},{"class":"row",html:L},this.locationsView&&this.locationsView.hasLocations()?{"class":"form-group col-sm-12",html:this.locationsView.render()}:null,{"class":"row",html:{"class":"form-group col-sm-6",html:[{tag:"label","for":"language-"+this.id,text:o.get("Invitation Email language")},new r({attributes:{id:"language-"+this.id,name:"language"},placeholder:false,options:I,className:"select-language"})]}},{"class":"row",html:{"class":"form-group col-sm-12",html:[{tag:"label","for":"text-"+this.id,text:o.get("Add a message")},new B({multiline:true,attributes:{id:"text-"+this.id,name:"text",styles:{height:80}}})]}}]})}else{if(!K.viewStep2||K.viewStep2Casual!==K.casualType.casual){K.viewStep2Casual=K.casualType.casual;H=k.createElement("div",{html:[K.buildLicensesSkeleton(),K.options.hasApp?K.buildAppsSkeleton():null]});K.viewStep2=H}else{H=K.viewStep2;n._manageNextButton.call(n)}}return H},updateAvailability:function(){var H=this.elements.availability;H.setText(this.getAvailabilityText());this.elements.tagger.options.limit=this._getMinAvailability()},_getMinAvailability:function(){var H,I=F;if(!this._canCrossCompany()&&n){H=n.getMaxFreeRole();if(H){I=Math.min(H,I)}}return Math.min(F,I)},getAvailabilityText:function(){var I=this.elements.tagger?this.elements.tagger.getSelected().length:0,K=this.casualType,J=K.total-K.free+I,H=J+"/"+K.total;return k.String.format(J>1?o.get("Used invitations: {0}"):o.get("Used invitation: {0}"),H)},buildCasual:function(){var J=this.data.availability,I=[],K=this,H;J.forEach(function(L){if(!k.is(K.casualType.free)&&K.casualType.casual===L.casual){K.casualType=L}if(!I.detect(function(M){return M.value===""+L.casual})){I.push({value:""+L.casual,label:L.casual===0?o.get("Unlimited"):k.String.format(o.get("Casual {0}h/month"),L.casual),selected:K.casualType.casual===L.casual})}});this.elements.availability=k.createElement("span",{"class":"pull-right"+(K._canCrossCompany()?" hidden":""),text:this.getAvailabilityText(this.casualType)});H=new r({attributes:{name:"casual",id:"casual-"+this.id},placeholder:false,options:I,events:{onChange:function(){var L=parseInt(this.getValue()[0],10),M=new D([]);K.casualType=k.Array.detect(J,function(N){return N.casual===L});if(!K.options.hasApp){if(!k.is(K.casualHasRole[K.casualType.casual])){K.modal.mask();M.fetch({data:{limit:1,platform:K.platform.get("id"),casual:K.casualType.casual,selfexp:false,apps:false},onComplete:function(N){K.modal.unmask();K.casualHasRole[K.casualType.casual]=N.length>0;K.manageButtonNextText(K.casualHasRole[K.casualType.casual])}})}else{K.manageButtonNextText(K.casualHasRole[K.casualType.casual])}}K.updateAvailability()}}});return[{"class":I.length>1?"form-group col-sm-6":"form-group col-sm-6 hidden",html:[{tag:"label","for":"casual-"+this.id,text:o.get("Usage Type")},H]}]},displayCompany:function(){var H=this.data.companies||[];return H.length>1},buildCompany:function(){var J=this.data.companies||[],H=[],I=this;J.forEach(function(K){H.push({value:K.id,label:e.isEmptyString(K.name)?K.id:K.name})});I.elements.company=new r({attributes:{name:"company",id:"company-"+this.id},placeholder:false,options:H,events:{onChange:function(){}}});return{"class":this.displayCompany()?"form-group col-sm-6":"form-group col-sm-6 hidden",html:[{tag:"label","for":"company-"+this.id,text:o.get("Company")},I.elements.company]}},buildRoles:function(){var J,H=this.roles.length,I=[],K=this;for(J=0;J<H;J++){if(this.roles[J].id!=="2"){I.push({value:this.roles[J].id,label:this.roles[J].name})}}I.push({value:b,label:o.get(h)});K.elements.roles=new r({attributes:{name:"role",id:"role-"+this.id},placeholder:false,options:I,events:{onChange:function(){}}});return K.elements.roles},buildSelectAgreement:function(){var K=this,I=[],H=this.agreements.length,J;for(J=0;J<H;J++){if(this.agreements[J].id!=="-1"){I.push({value:this.agreements[J].id,label:this.agreements[J].name})}}this.selectAgreement=new u({type:"checkbox",name:"agreement",value:"",label:o.get("Contractor"),className:"primary",events:{onClick:function(){K.elements.roles.setDisabled(this.isChecked())}}});return this.selectAgreement},getModalTitle:function(){var H=o.get("Invite members");if(this.platform.get("platform")===false){H=o.get("Grant Roles")}return H},buildPlatform:function(){return{"class":"form-group col-sm-6"+(this.platform.isPlatform()?"":" hidden"),html:[{tag:"label","for":"role-"+this.id,text:o.get("User rights")},this.buildRoles()]}},buildLicensesSkeleton:function(){var L=this,K=0,N=new D([],{data:{platform:this.platform.get("id"),casual:this.casualType.casual,selfexp:false,apps:false,withLicenses:true}}),I=new D([],{data:{platform:this.platform.get("id"),casual:this.casualType.casual,selfexp:false,apps:false,withLicenses:false}}),M=new D(),H=new q({disabledCrossCompany:!L._canCrossCompany(),collection:N,titleTableCollection:(L.platform.canCrossCompanyExtended()&&L._canCrossCompany())?o.get("Available roles with licenses"):null,collectionWithOutLicenses:(L.platform.canCrossCompanyExtended()&&L._canCrossCompany())?I:null,titleTableCollectionWithOutLicenses:(L.platform.canCrossCompanyExtended()&&L._canCrossCompany())?o.get("Available roles without any license"):null,collectionSelected:M,searchPlaceholder:o.get("Search Roles & Options"),tagger:this.elements.tagger,platform:this.platform,setNextDisabled:this.setNextDisabled.bind(this)}),J=k.createElement("span",{"class":"fonticon fonticon-down-dir",styles:{opacity:"1"}});n=H;N.setLimit(m);N.fetch({onComplete:function(){if(!L.platform.canCrossCompanyExtended()||!L._canCrossCompany()||K===2){H.render()}else{K=1}}});if(this.platform.canCrossCompanyExtended()&&L._canCrossCompany()){I.setLimit(m);I.fetch({onComplete:function(){if(K===1){H.render()}else{K=2}}})}return[{tag:"h5",html:[J,{tag:"span",text:o.get("Roles & Options")}],events:{click:function(){if(J.hasClassName("fonticon-down-dir")){H.hide();J.removeClassName("fonticon-down-dir").addClassName("fonticon-right-dir")}else{H.show();J.removeClassName("fonticon-right-dir").addClassName("fonticon-down-dir")}}}},H.render(),{"class":"clearfix"}]},buildAppsSkeleton:function(){var K=new y([],{data:{platform:this.platform.get("id")}}),J=new y(),H=new q({collection:K,platform:this.platform,collectionSelected:J,searchPlaceholder:o.get("Search Additional Apps")}),I=k.createElement("span",{"class":"fonticon fonticon-down-dir",styles:{opacity:"1"}});K.setLimit(m);K.fetch({onComplete:function(){H.render()}});return[{tag:"h5",html:[I,{tag:"span",text:o.get("Additional Apps")}],events:{click:function(){if(I.hasClassName("fonticon-down-dir")){H.hide();I.removeClassName("fonticon-down-dir").addClassName("fonticon-right-dir")}else{H.show();I.removeClassName("fonticon-right-dir").addClassName("fonticon-down-dir")}}}},H.render(),{"class":"clearfix"}]},onClickInvite:function(){var K=this,J=[],L=K.elements.container.getBody().getElements(".table-selection tbody tr");if(this.inviteInProgress===false&&this.uploadInProgress===false){this.inviteInProgress=true;L.forEach(function(O){var N=O.getElement("[name=licenses\\[\\]]:checked"),P=O.getElement("[name=licensed\\[\\]]"),M=O.getElement("[name=restricted\\[\\]]");if(K._canCrossCompany()){J.push({id:N.value,licensed:P&&P.checked,restricted:M&&M.checked})}else{J.push({id:N.value})}});K.modal.mask();if(K.mode===t&&K.elements.tagger.getSelected().length>0&&(K.platform.get("platform")===true||(K.platform.get("platform")===false&&J.length>0))){var H=K.viewStep1.getElement("[name=role]").value,I="0";if(H!==b){I="0"}else{H="1";I="1"}i.platformInvite({platform:K.platform.get("id"),emails:K.elements.tagger.getSelected().join(","),role:H,agreement:I,language:K.viewStep1.getElement("[name=language]").value,text:K.viewStep1.getElement("[name=text]").value,licenses:JSON.stringify(J),company:K.viewStep1.getElement("[name=company]").value,casual:K.casualType.casual,location:this.locationsView&&this.locationsView.getValue()},{onComplete:function(M){K.inviteInProgress=false;v.success(M.message);K.options.onAdded();K.hide()},onFailure:function(){K.inviteInProgress=false;K.hide()}})}else{if(K.mode===g){new s().save({platform:K.platform.get("id"),language:K.viewStep1.getElement("[name=language]").value,text:K.viewStep1.getElement("[name=text]").value,licenses:JSON.stringify(J),company:K.viewStep1.getElement("[name=company]").value,casual:K.casualType.casual,location:this.locationsView&&this.locationsView.getValue()},{patch:true,onComplete:function(M){K.inviteInProgress=false;K.uploadInProgress=true;K.elements.form.inject(K.elements.container.elements.body);K.elements.iframe.inject(K.elements.container.elements.body);K.elements.form.addClassName("hidden");K.elements.form.getElement("[name=__fcs__jobTicket]").setAttribute("value",M.get("fcsJobTicket"));K.elements.form.getElement("[name=file_0_name]").setAttribute("value",K.elements.form.getElement("[name=file_import]").value);K.elements.form.setAttribute("action",M.get("fcsUrl"));K.elements.form.setAttribute("target","uploadFrame"+K.id);K.elements.form.setAttribute("enctype","multipart/form-data");K.elements.form.submit()},onFailure:function(){K.hide()}})}}}},needSecondStep:function(){return this.casualHasRole[this.casualType.casual]===true||this.options.hasApp},manageButtonNextText:function(){this.nextButton.setValue(this.getButtonNextText())},getInviteText:function(){return this.platform.isPlatform()?o.get("Invite"):o.get("Grant")},getButtonNextText:function(){return this.needSecondStep()?o.get("Next"):this.getInviteText()},getButtons:function(){var I=this,H=[];if(this.step===1){H.push(new p({value:o.get("Back"),className:"default pull-left",events:{onClick:function(){I.step=0;I.nextButtonDisabled=false;I.elements.container.setFooter(I.getButtons());I.elements.container.setBody(I.viewStep1)}}}));this.nextButton=new p({value:this.getInviteText(),className:"primary",disabled:I.platform.get("platform")===false,events:{onClick:this.onClickInvite.bind(this)}});H.push(k.createElement("span",{"class":"tooltip-wrapper",html:this.nextButton}))}else{this.nextButton=new p({value:this.getButtonNextText(),className:"primary",disabled:I.nextButtonDisabled,events:{onClick:function(){if(this.needSecondStep()){this.step=1;this.elements.container.setFooter(this.getButtons());this.viewStep2=I.buildContent();this.elements.container.setBody([this.viewStep2]);this.dispatchEvent("onNextViewRendered")}else{this.onClickInvite()}}.bind(this)}});H.push(k.createElement("div",{"class":"tooltip-wrapper",html:this.nextButton}))}H.push(new p({className:"default",value:o.get("Cancel"),events:{onClick:function(){I.elements.container.hide()}}}));I.elements.container.buttons=H;return H},setNextDisabled:function(J){var H=this.step===1?1:0,I=this.nextButton;I.setDisabled(J);if(!J){this.dispatchEvent("onNextAvailable")}if(this.tooltip){this.tooltip.destroy();this.tooltip=null}if(J){this.tooltip=new C({position:"top",target:this.elements.container.buttons[H],body:this.step===1?o.get("You need to select a least one role"):o.get("You need to add a least one email")})}this.nextButtonDisabled=J}})});