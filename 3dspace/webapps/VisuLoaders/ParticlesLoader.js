define("DS/VisuLoaders/ParticlesLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/Visualization/GeometryHelper","DS/Visualization/Utils","DS/Visualization/ProxyAbstraction","DS/Animation/PropertyAnimation","DS/Visualization/SceneGraphFactory"],function(f,d,b,h,a,i,c,e){var g=function(o,n){var k=o;var j=(n!==undefined)?n:null;var l=[];var m=null;this.load=function(r,u,t,q){var s=new i();a.setProxyFromSpec(r,s);var p=r.serverurl?r.serverurl:"";p+=r.filename?r.filename:"";s.executeGetHttpRequest(p,"text",null,function(V){var y=JSON.parse(V);if(1){var A=new f.ShaderMaterialDS({side:f.FrontSide,transparent:true,blending:f.NormalBlending,defines:{MAX_STEPS:256,TM_MIN:0.05,EPS:0.0001,PI:3.14159265,HALFPI:1.57079633,ROOTTHREE:1.73205081},uniforms:{nbCol:{type:"i",value:0},map:{type:"t",value:null},mapDim:{type:"v3",value:new f.Vector3()},uTMK:{type:"f",value:16},modelMatrixInv:{type:"m4",value:new f.Matrix4()}},vertexShaderPars:["varying vec3 worldPos;","varying vec3 objPos;","varying vec3 camPosLocal;","uniform mat4 modelMatrixInv;"].join("\n"),vertexShaderBody:[f._DefaultShaderChunk.model_view_transformation_vertex,f._DefaultShaderChunk.model_view_normal_vertex,"gl_Position = projectionMatrix * mvPosition;","worldPos = ( modelMatrix * vec4(position, 1.0) ).xyz;","objPos = position;","camPosLocal = (modelMatrixInv * vec4(cameraPosition, 1.0)).xyz;"].join("\n"),fragmentShaderPars:["varying vec3 worldPos;","varying vec3 objPos;","varying vec3 camPosLocal;","uniform int nbCol;","uniform sampler2D map;","uniform vec3 mapDim;","uniform float uTMK;","float stepSize;","float nbTexelsX;","float nbTexelsY;","const vec3 weight = vec3(1.0, 0.04, 0.01);","vec4 sampleVolTex(vec3 pos) {","float rowID = floor(pos.z / float(nbCol));","float rowID2 = rowID;","float colID = mod(floor(pos.z), float(nbCol));","float colID2 = mod(ceil(pos.z), float(nbCol));","if (colID2 == 0.0) { rowID2 = rowID2 + 1.0; }","float x1 = colID  * mapDim.x + pos.x;","float x2 = colID2 * mapDim.x + pos.x;","float y1 = rowID  * mapDim.y + pos.y;","float y2 = rowID2 * mapDim.y + pos.y;","vec2 mapUV  = vec2(x1 / nbTexelsX, 1.0 - y1 / nbTexelsY);","vec2 mapUV2 = vec2(x2 / nbTexelsX, 1.0 - y2 / nbTexelsY);","vec4 alpha1 = texture2D(map, mapUV);","vec4 alpha2 = texture2D(map, mapUV2);","return mix(alpha1, alpha2, fract(pos.z));","}","vec4 raymarchNoLight(vec3 ro, vec3 rd) {","vec3 step = rd * stepSize;","vec3 pos = ro;","vec3 col = vec3(0.0);","float tm = 1.0;","for (int i=0; i<MAX_STEPS; ++i) {","vec4 rgba = sampleVolTex(pos);","float dtm = exp( -uTMK * stepSize * dot(rgba.rgb, weight) * 0.01 );","tm *= dtm;","col += (1.0 - 0.995*dtm) * rgba.rgb * rgba.rgb * tm;","pos += step;","if (tm < 0.0 || pos.x > mapDim.x - 1.0 || pos.x < 0.0 || pos.y > mapDim.y - 1.0 || pos.y < 0.0 || pos.z > mapDim.z - 1.0 || pos.z < 0.0)","break;","}","float alpha = 1.0 - tm;","return vec4(col / alpha, alpha);","}"].join("\n"),fragmentShaderBody:["vec3 ro = objPos;","vec3 rd = normalize(ro - camPosLocal);","stepSize = max(mapDim.x, max(mapDim.y, mapDim.z)) * ROOTTHREE / float(MAX_STEPS);","nbTexelsX = float(nbCol) * mapDim.x;","nbTexelsY = float(nbCol) * mapDim.y;","gl_FragColor = raymarchNoLight(ro, rd);"].join("\n")});A.force=true;var C=y.results.length;var G=new f.Vector3(10000,10000,10000);var K=new f.Vector3(-10000,-10000,-10000);for(var J=0;J<C;J++){var B=y.results[J];var R=B.positions;for(var M=0;M<R.length;M++){if(R[M].X<G.x){G.x=R[M].X}if(R[M].Y<G.y){G.y=R[M].Y}if(R[M].Z<G.z){G.z=R[M].Z}if(R[M].X>K.x){K.x=R[M].X}if(R[M].Y>K.y){K.y=R[M].Y}if(R[M].Z>K.z){K.z=R[M].Z}}}var I=new f.Vector3(K.x-G.x+1,K.y-G.y+1,K.z-G.z+1);var v=Math.ceil(Math.sqrt(I.z));l=[];for(var J=0;J<C;J++){l[J]=new Uint8Array(4*v*v*I.x*I.y);for(var M=0;M<v*v*I.x*I.y;M++){l[J][4*M]=0;l[J][4*M+1]=0;l[J][4*M+2]=0;l[J][4*M+3]=0}var B=y.results[J];var R=B.positions;for(var M=0;M<R.length;M++){var U=R[M].X-G.x;var T=R[M].Y-G.y;var S=R[M].Z-G.z;var x=Math.floor(S/v);var L=S%v;var F=(x*I.y+T)*(v*I.x)+L*I.x+U;l[J][4*F]=255*R[M].R;l[J][4*F+1]=255*R[M].G;l[J][4*F+2]=255*R[M].B;l[J][4*F+3]=Math.min(128,255*Math.pow(2*R[M].V,0.8))}}m=new f.DataTexture(l[0],v*I.x,v*I.y,f.RGBAFormat,f.UnsignedByteType,new f.LatLongReflectionMapping(),f.ClampToEdgeWrapping,f.ClampToEdgeWrapping,f.LinearFilter,f.LinearFilter);m.generateMipmaps=false;m.needsUpdate=true;var z=null;var O=function(){this._nbLoops=5;this._duration=50000;this.duration=function(){return this._duration};this.valueAt=function(X){var Y=this._duration/this._nbLoops;var W=(X%Y)/Y;return W}};var E=new O();var N=function(Y){var X=Math.floor(Y*(this.buffer.length));this.map.image.data=this.buffer[X];this.map.needsUpdate=true;if(z){var W=new f.Matrix4();W.getInverse(z._occurrences[0].renderable.matrixWorld);A.uniforms.modelMatrixInv.value=W}if(j!==null){j()}};var Q={map:m,buffer:l,animate:N};var H=new c(Q,"animate",E);H.setLoop(1);H.start();A.uniforms.nbCol.value=v;A.uniforms.map.value=m;A.uniforms.mapDim.value.x=I.x;A.uniforms.mapDim.value.y=I.y;A.uniforms.mapDim.value.z=I.z;var w=new h();var D=w.CreateVis3DCuboid({cornerPoint:new f.Vector3(),firstAxis:new f.Vector3(I.x-1,0,0),secondAxis:new f.Vector3(0,I.y-1,0),thirdAxis:new f.Vector3(0,0,I.z-1)});z=e.createMeshNode(D);var P=new f.Matrix4().makeTranslation(G.x,G.y,G.z);z.setSSAO(false);z.setMatrix(P);z.setMaterial(A);if(u){u(z)}if(q){q()}return}})}};return g});