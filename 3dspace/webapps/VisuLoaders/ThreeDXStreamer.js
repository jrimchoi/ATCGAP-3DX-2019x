define("DS/VisuLoaders/ThreeDXStreamer",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/ZipJS/zip"],function(g,b,d,f,h,l,c){var k=null;var j=new g.Box3();var e=new g.Vector3();var i=function(n){var m=document.getElementsByTagName("script");for(var p=0;p<m.length;p++){var o=m.item(p);var q=o.getAttribute("src");if(q&&q.match(n)){return q.substring(0,q.lastIndexOf("/")+1)}}return null};var a={stream:function(ah){var ae=["vertexIndexArray","vertexPositionArray","vertexNormalArray","vertexUvArray","vertexUv2Array","vertexColorArray","vertexTangentArray","vertexBinormalArray"];var af={vertexPositionArray:1,vertexNormalArray:2,vertexUvArray:4,vertexUv2Array:8,vertexColorArray:16,vertexTangentArray:32,vertexBinormalArray:64};var t=["none","PLANAR","SPHERICAL","CUBIC","FINITE_CYLINDRICAL","INFINITE_CYLINDRICAL"];var al={1003:"NEAREST",1004:"NEAREST_MIPMAP_NEAREST",1005:"NEAREST_MIPMAP_LINEAR",1006:"LINEAR",1007:"LINEAR_MIPMAP_NEAREST",1008:"LINEAR_MIPMAP_LINEAR"};var S={1000:"REPEAT",1001:"CLAMP_TO_EDGE",1002:"MIRRORED_REPEAT"};var ac={0:"POINTS",1:"LINES",4:"TRIANGLES"};var r=!!ah.zipped||false;var Q=!!ah.concat||false;var A=ah.compressNormals||false;var aC=ah.compressVertices||false;var ab=null;var M=null;var I=ah.layers||false;var z=ah.streamEdges||false;var D=ah.streamPoints||false;var W=(ah.primitives!==undefined)?ah.primitives:false;var ay=ah.reps||false;var T=ah.node?ah.node:ah;var aa=ah.metalnessToSpecularConverter?ah.metalnessToSpecularConverter:null;var q=ah.nodeCallback;var aD=ah.imageCallback;var ad=ah.endCallback;var aA=null;var am=ah.embeddedTextures||false;var p=0;var Z=0;var U=new WeakMap();var ai=0;var ag={binaries:{},vertexLayouts:{},buffers:{},images:{},textures:{},materials:{},geometries:{},nodes:{}};var an={header:{generator:"Dassault Systemes 3DX generator",version:"3.0",upAxis:"Z",unit:"mm"},binaries:[],buffers:[],vertexLayouts:[],images:[],textures:[],materials:[],geometries:[],nodes:[],extensionsUsed:[],extensionsRequired:[],root:null};var w=new Set();var R=new Set();var Y=104857600;var J=0;var aw=1;var ak={geometry:0,image:1};var aj=[];var P={json:an,chunks:aj,zipData:null};function L(aI){var aF=new ArrayBuffer(2*aI.length);var aE=new Uint16Array(aF);for(var aG=0,aH=aI.length;aG<aH;aG++){aE[aG]=aI.charCodeAt(aG)}return aF}function O(aJ,aE,aH,aG){var aI=aH;for(var aF=0;aF<aG;aF++){aE[aI++]=aJ[aF]}return aI}function aq(aG,aE,aF){var aM=JSON.stringify(aG.json,undefined,2);var aL=L(aM);var aO=4+aL.byteLength;if(aO%4){aO+=4-(aO%4)}for(var aJ=0;aJ<aG.chunks.length;aJ++){aO+=aG.chunks[aJ].data.byteLength;if(aO%4){aO+=4-(aO%4)}}var aP=new ArrayBuffer(aO);var aI=4;var aK=new Uint32Array(aP,0,1);var aH=new Uint8Array(aP);aK[0]=aL.byteLength;aI=O(new Uint8Array(aL),aH,aI,aL.byteLength);if(aI%4){aI+=4-(aI%4)}for(var aJ=0;aJ<aG.chunks.length;aJ++){var aN=aG.chunks[aJ].data;aI=O(aN,aH,aI,aN.byteLength);if(aI%4){aI+=4-(aI%4)}}aG.concatData=aP;aE&&aE()}function V(aI,aE,aH){if(!M){M=new c.BlobWriter()}var aL=JSON.stringify(aI.json,undefined,2);var aM=new Blob([aL],{type:"text/plain"});var aG=0;var aF=[{data:aM}];for(var aK=0;aK<aI.chunks.length;aK++){aF.push({index:aK,data:new Blob([aI.chunks[aK].data],{type:"arraybuffer"})})}function aJ(){var aN=aF[aG];var aO=!aG?"manifest.json":aI.json.binaries[aN.index].uri;ab.add(aO,new c.BlobReader(aN.data),function(){aG++;if(aG<aF.length){aJ()}else{ab.close(function(aP){aI.zipData=aP;aE&&aE()})}},null)}if(ab){aJ()}else{c.createWriter(M,function(aN){ab=aN;aJ()},aH)}}function N(aF){for(var aJ=0;aJ<aj.length;aJ++){var aL=aj[aJ];var aK=aF.binaries[aJ];aK.byteLength=aL.size;aL.data=new Uint8Array(aL.size);for(var aH=0;aH<aL.buffers.length;aH++){var aM=aL.buffers[aH];var aI=aM.buffer;var aE=aM.offset;for(var aG=0;aG<aI.byteLength;aG++){aL.data[aE+aG]=aI[aG]}}}return aj}function X(aG,aF){var aE=aj[ak[aF]];if(!aE||(aE.size+aG.byteLength>Y)){ak[aF]=aj.length;aE={size:0,buffers:[],data:null,type:aF};aj.push(aE)}var aH=aE.size;aE.buffers.push({buffer:new Uint8Array(aG.buffer,aG.byteOffset,aG.byteLength),offset:aH});aE.size+=aG.byteLength;if(aE.size%4){aE.buffers.push({buffer:new Uint8Array(4-(aE.size%4)),offset:aE.size});aE.size+=4-(aE.size%4)}return aH}function E(){p--;console.log("nb textures loading: "+p);if(aA&&!p){P.chunks=N(an);if(r){V(P,function(){aA(P)})}else{if(Q){aq(P,function(){aA(P)})}else{aA(P)}}}}function v(aF,aJ,aG,aH){var aI={name:aG,format:aJ};var aE=new FileReader();aE.onload=function(){var aL=new DataView(this.result);var aK=X(aL,"image");aI.binary=m(ak,"image",aH);aI.byteOffset=aK;aI.byteLength=aL.byteLength;E()};aE.readAsArrayBuffer(aF);return aI}function u(aG,aE){var aF={name:"image_"+aG.sourceFile};var aH=new XMLHttpRequest();aH.open("GET",aG.sourceFile,true);aH.responseType="blob";aH.onload=function(aJ){if(this.status===200){var aK=this.response.type;aF.format=(aK==="image/jpeg")?"jpeg":"png";var aI=new FileReader();aI.onload=function(){var aM=new DataView(this.result);var aL=X(aM,"image");aF.binary=m(ak,"image",aE);aF.byteOffset=aL;aF.byteLength=aM.byteLength;E()};aI.readAsArrayBuffer(this.response);console.log("canvas blob")}};aH.send();return aF}function x(aJ,aW,aX){if(aJ.image){if(aJ.image.getContext||(aJ.image.tagName&&(aJ.image.tagName.toLowerCase()==="img"))){if(aJ.sourceFile&&aJ.sourceFile.substring(0,5)==="blob:"){var aL=ag.images[aJ.sourceFile];if(!aL){p++;console.log("nb textures loading: "+p);var aE=u(aJ,aW);aL={index:aW.images.length,item:aE};aW.images.push(aE);ag.images[aJ.sourceFile]=aL}aX.image=aL.index}else{var aI=aJ.image;var aG="jpeg";if(!aI.getContext){if(aI.src){var aS=b.getExtension(aI.src);if(aS&&(aS.toLowerCase()==="png")){aG="png"}}aI=k?k:document.createElement("canvas");aI.width=aJ.image.width;aI.height=aJ.image.height;var aN=aI.getContext("2d");aN.drawImage(aJ.image,0,0,aJ.image.width,aJ.image.height)}var aF=atob(aI.toDataURL("image/"+aG).split(",")[1]);var aR=new Array(aF.length);for(var aT=0;aT<aF.length;aT++){aR[aT]=aF.charCodeAt(aT)}var aO=new Uint8Array(aR);var aU=new Blob([aO],{type:"image/"+aG});var aV="img_"+Z;Z++;p++;console.log("nb textures loading: "+p);var aE=v(aU,aG,aV,aW);var aL={index:aW.images.length,item:aE};aW.images.push(aE);ag.images[aV]=aL;aX.image=aL.index;console.log("png")}}else{if(aJ.mipmaps&&aJ.mipmaps.length){var aM=aJ.image.width;var aK=aJ.image.height;var aU=new Blob([g.ImageUtils.streamDDS(aJ)],{type:"arraybuffer"});var aV="img_"+Z;Z++;p++;console.log("nb textures loading: "+p);var aE=v(aU,"dds",aV,aW);var aL={index:aW.images.length,item:aE};aW.images.push(aE);ag.images[aV]=aL;aX.image=aL.index;console.log("dds")}else{var aM=aJ.image.width;var aK=aJ.image.height;var aI=k?k:document.createElement("canvas");aI.width=aM;aI.height=aK;var aN=aI.getContext("2d");var aU=aN.getImageData(0,0,aM,aK);var aH=aU.data;if(aJ.format==1021){for(var aT=0;aT<aK;aT++){for(var aQ=0;aQ<4*aM;aQ++){aH[(aK-aT-1)*4*aM+aQ]=aJ.image.data[aT*4*aM+aQ]}}}else{if(aJ.format==1020){for(var aT=0;aT<aK;aT++){for(var aQ=0;aQ<aM;aQ++){for(var aP=0;aP<3;aP++){aH[(aK-aT-1)*4*aM+aQ*4+aP]=aJ.image.data[aT*3*aM+aQ*3+aP]}aH[(aK-aT-1)*4*aM+aQ*4+3]=255}}}else{console.log("texture format export to code :"+aJ.format)}}aN.putImageData(aU,0,0,0,0,aM,aK);var aF=atob(aI.toDataURL("image/png").split(",")[1]);var aR=new Array(aF.length);for(var aT=0;aT<aF.length;aT++){aR[aT]=aF.charCodeAt(aT)}var aO=new Uint8Array(aR);var aU=new Blob([aO],{type:"image/png"});var aV="img_"+Z;Z++;p++;console.log("nb textures loading: "+p);var aE=v(aU,"png",aV,aW);var aL={index:aW.images.length,item:aE};aW.images.push(aE);ag.images[aV]=aL;aX.image=aL.index;console.log("uncompressed")}}}}function aB(aI,aG,aF){var aH;if(!aH){var aE={anisotropy:aI.anisotropy,magFilter:al[aI.magFilter],minFilter:al[aI.minFilter],uWrap:S[aI.wrapS],vWrap:S[aI.wrapT],mapping:aG};if(aD){aD(aI,aE)}else{if(!aI.loadEndStatus||(aI.loadEndStatus==="complete")){x(aI,aF,aE)}else{if(aI.loadEndStatus==="error"){console.log("Texture corrupted: impossible to embed it in 3dx archive.");return undefined}else{aI.onLoadCallbacks.push(function(aJ){x(aJ,aF,aE)})}}}aH={index:aF.textures.length,item:aE};aF.textures.push(aE)}return aH.index}function ap(aH,aF){var aG=ag.textures[aH.id];if(!aG){var aE={anisotropy:aH.anisotropy,magFilter:al[aH.magFilter],minFilter:al[aH.minFilter],uWrap:S[aH.wrapS],vWrap:S[aH.wrapT]};if(aD){aD(aH,aE)}else{if(!aH.loadEndStatus||(aH.loadEndStatus==="complete")){x(aH,aF,aE)}else{if(aH.loadEndStatus==="error"){console.log("Texture corrupted: impossible to embed it in 3dx archive.");return undefined}else{aH.onLoadCallbacks.push(function(aI){x(aI,aF,aE)})}}}aG={index:aF.textures.length,item:aE};aF.textures.push(aE);ag.textures[aH.id]=aG}return aG.index}function ao(aE){return[aE.r,aE.g,aE.b]}function az(aM,aI){var aJ="Phong";if(aM instanceof g.ParticleBasicMaterial){aJ="PointBasic"}else{if(aM instanceof g.LineBasicMaterial){aJ="LineBasic"}else{if(aM instanceof g.MeshBasicMaterial){aJ="MeshBasic"}else{if(aM instanceof g.PhysicalMaterial){aJ="Physical";var aG="EXT_Material_PBR";if(!w.has(aG)){w.add(aG);an.extensionsUsed.push(aG)}if(!R.has(aG)){R.add(aG);an.extensionsRequired.push(aG)}}else{if(aM instanceof g.MeshLambertMaterial){aJ="Lambert"}}}}}var aN={type:aJ,visible:aM.visible,side:aM.side,transparent:aM.transparent,alphaTest:aM.alphaTest,depthTest:aM.depthTest,depthWrite:aM.depthWrite};if(!(aM instanceof g.PhysicalMaterial)){aN.opacity=aM.opacity;if(aM.color){aN.color=ao(aM.color)}if(aM instanceof g.ParticleBasicMaterial){aN.size=aM.size;aN.sizeAttenuation=aM.sizeAttenuation}if(aM instanceof g.LineBasicMaterial){aN.lineWidth=aM.lineWidth}if((aM instanceof g.MeshPhongMaterial)||(aM instanceof g.MeshLambertMaterial)){aN.ambient=ao(aM.ambient);aN.shininess=aM.shininess}if((aM instanceof g.MeshPhongMaterial)||(aM instanceof g.MeshLambertMaterial)){aN.emissive=ao(aM.emissive);if(aM.specular){aN.specular=ao(aM.specular)}aN.vertexColors=aM.vertexColors;if(aM.map){aN.diffuseMap=ap(aM.map,aI)}if(aM.bumpMap){aN.bumpMap=ap(aM.bumpMap,aI)}if(aM.normalMap){aN.normalMap=ap(aM.normalMap,aI)}if(aM.specularMap){aN.specularMap=ap(aM.specularMap,aI)}if(aM.lightMap){aN.lightMap=ap(aM.lightMap,aI)}if(aM.bumpMap&&(aM.bumpScale!==undefined)){aN.bumpMapScale=aM.bumpScale}if(aM.normalMap&&(aM.normalScale!==undefined)){aN.normalMapScale=aM.normalScale}}}else{var aK=function(aQ,aS,aR){aN[aQ]={};var aV=aN[aQ];if(typeof aM[aS]!=="undefined"){if(typeof aM[aS+"Map"]==="undefined"){aV=typeof aM[aS]==="number"?aM[aS]:aM[aS].x;return}aV.value=typeof aM[aS]==="number"?aM[aS]:aM[aS].x}if(aM[aS+"Map"]){if(aR){var aT=aM[aS+"UvTransform"].elements;var aR;if(aM.mappingType>0){aR={operator:{type:t[aM.mappingType],transform:aM.mappingObjTransformation.elements},uvTransform:[aT[0],aT[1],aT[2],0,aT[3],aT[4],aT[5],0,aT[6],aT[7],aT[8],0,0,0,0,1]}}else{var aU="TEXCOORD_0";if(aM.uvSlots[aS+"Map"]&&aM.uvSlots[aS+"Map"]===2){aU="TEXCOORD_1"}aR={slot:"slot",uvTransform:[aT[0],aT[1],aT[2],0,aT[3],aT[4],aT[5],0,aT[6],aT[7],aT[8],0,0,0,0,1]}}aV.texture=aB(aM[aS+"Map"],aR,aI)}else{aV.texture=ap(aM[aS+"Map"],aI)}}if(aM[aS+"MulCoef"]>0){aV.MADCoefficients=[aM[aS+"MulCoef"],aM[aS+"AddCoef"]]}};var aL=function(aQ,aS,aR){aN[aQ]={};var aV=aN[aQ];if(typeof aM[aS+"Map"]==="undefined"){aV=ao(aM[aS]);return}aV.value=ao(aM[aS]);if(aM[aS+"Map"]){if(aR){var aT=aM[aS+"UvTransform"].elements;var aR;if(aM.mappingType>0){aR={operator:{type:t[aM.mappingType],transform:aM.mappingObjTransformation.elements},uvTransform:[aT[0],aT[1],aT[2],0,aT[3],aT[4],aT[5],0,aT[6],aT[7],aT[8],0,0,0,0,1]}}else{var aU="TEXCOORD_0";if(aM.uvSlots[aS+"Map"]&&aM.uvSlots[aS+"Map"]===2){aU="TEXCOORD_1"}aR={slot:aU,uvTransform:[aT[0],aT[1],aT[2],0,aT[3],aT[4],aT[5],0,aT[6],aT[7],aT[8],0,0,0,0,1]}}aV.texture=aB(aM[aS+"Map"],aR,aI)}else{aV.texture=ap(aM[aS+"Map"],aI)}}if(aM[aS+"MulCoef"]){aV.MADCoefficients=[aM[aS+"MulCoef"].x,aM[aS+"MulCoef"].y,aM[aS+"MulCoef"].z,aM[aS+"AddCoef"].x,aM[aS+"AddCoef"].y,aM[aS+"AddCoef"].z]}};var aF=function(aQ,aS,aR){aN[aQ]={};var aV=aN[aQ];if(aM[aS+"Map"]){if(aM[aS+"MapFlipY"]){aN[aS+"MapFlipY"]=aM[aS+"MapFlipY"]}if(aR){var aT=aM[aS+"UvTransform"].elements;var aR;if(aM.mappingType>0){aR={operator:{type:t[aM.mappingType],transform:aM.mappingObjTransformation.elements},uvTransform:[aT[0],aT[1],aT[2],0,aT[3],aT[4],aT[5],0,aT[6],aT[7],aT[8],0,0,0,0,1]}}else{var aU="TEXCOORD_0";if(aM.uvSlots[aS+"Map"]&&aM.uvSlots[aS+"Map"]===2){aU="TEXCOORD_1"}aR={slot:aU,uvTransform:[aT[0],aT[1],aT[2],0,aT[3],aT[4],aT[5],0,aT[6],aT[7],aT[8],0,0,0,0,1]}}aV.texture=aB(aM[aS+"Map"],aR,aI)}else{aV.texture=ap(aM[aS+"Map"],aI)}}};aN.albedo={};aN.albedo.value=ao(aM.color);if(aM.map){var aH=aM.diffuseUvTransform.elements;var aE;if(aM.mappingType>0){aE={operator:{type:t[aM.mappingType],transform:aM.mappingObjTransformation.elements},uvTransform:[aH[0],aH[1],aH[2],0,aH[3],aH[4],aH[5],0,aH[6],aH[7],aH[8],0,0,0,0,1]}}else{var aO="TEXCOORD_0";if(aM.uvSlots.diffuseMap&&aM.uvSlots.diffuseMap===2){aO="TEXCOORD_1"}aE={slot:aO,uvTransform:[aH[0],aH[1],aH[2],0,aH[3],aH[4],aH[5],0,aH[6],aH[7],aH[8],0,0,0,0,1]}}aN.albedo.texture=aB(aM.map,aE,aI)}if(aM.diffuseMulCoef){aN.albedo.MADCoefficients=[aM.diffuseMulCoef.x,aM.diffuseMulCoef.y,aM.diffuseMulCoef.z,aM.diffuseAddCoef.x,aM.diffuseAddCoef.y,aM.diffuseAddCoef.z]}aK("metallic","metalness",true);aK("roughness","roughness",true);aK("glossiness","glossiness",false);aK("anisotropy","anisotropy",true);aK("anisotropyRotation","anisotropyAngle",true);aF("normal","normal",true);aK("normalScale","normalScale",false);aK("transparency","transparency",true);aK("cutoutOpacity","opacity",true);aK("sheen","sheen",true);aN.sheenMode=aM.sheenMode;aK("specular","specularContrib",true);aL("specularTint","specular",true);aK("clearcoat","clearCoat",true);aK("clearcoatRoughness","clearCoatRoughness",true);aF("clearcoatNormal","clearCoatNormal",true);aK("clearcoatNormalScale","clearCoatNormalScale",false);aK("orangePeelScale","orangePeelScale",false);aN.orangePeel=aM.orangePeel;if(typeof aM.flakes!=="undefined"){aN.flakes=aM.flakes;aK("flakesRoughness","flakesRoughness",false);aK("flakesDensity","flakesDensity",false);aK("flakesScale","flakesScale",false);aK("flakesBump","flakesBump",false);aL("flakesColor","flakesColor",false);aK("pearlFlakesDensity","pearlFlakesDensity",false);aK("pearlFlakesBump","pearlFlakesBump",false);aL("pearlFlakesColor","pearlFlakesColor",false)}else{aL("flakeColor","flakesColor",true);aK("flakeRoughness","flakesRoughness",true);aK("flakeSize","flakesSize",true);aK("flakeCoverage","flakesCoverage",true)}aL("emissionColor","emissionColor",true);aK("emissionValue","emissionValue",false);aN.emissionEnergyNormalization=aM.emissionNormalized;aN.emissionMode="LUMINOUS_EMITTANCE";aN.thinWalled=aM.thinWalled;aK("ior","ior",false);aK("translucencyScale","translucencyScale",false);aL("attenuationColor","attenuationColor",false);aK("attenuationDistance","attenuationDistance",false);aL("subsurfaceColor","subsurfaceColor",false);aK("subsurfacePreset","subsurfacePreset",false);aK("displacement","displacement",false);aN.vertexColors=aM.vertexColors;aN.alphaTest=aM.alphaTest;if(aM.lightMap){aN.lightMap=ap(aM.lightMap,aI)}if(aM.occlusionMap){aN.occlusionMap=ap(aM.occlusionMap,aI)}aN.uv0Transform=[];aM.mappingUVTransformation.flattenToArray(aN.uv0Transform);var aP=aN;aN={extensions:{EXT_Material_PBR:aP}}}return aN}function m(aG,aF,aE){var aI=aG[aF];var aH=aE.binaries[aI];if(!aH){aE.binaries[aI]={uri:aF+"_"+aI+".bin",byteLength:0}}return aI}function K(aH,aF){var aG=X(aH,"geometry");var aE={binary:m(ak,"geometry",aF),byteOffset:aG,byteLength:aH.byteLength};return aE}function C(aG,aF){var aE=K(aG,aF);if(aG instanceof Uint32Array){aE.format="UNSIGNED_INT"}else{aE.format="UNSIGNED_SHORT"}aF.buffers.push(aE);return aF.buffers.length-1}function s(aG,aF){var aE=K(aG,aF);aF.buffers.push(aE);return aF.buffers.length-1}function o(aP){var aJ=aP.length/3;var aL=new Uint8Array(aJ*3);for(var aI=0;aI<aJ;aI++){var aK=aP[3*aI];var aH=aP[3*aI+1];var aG=aP[3*aI+2];var aN=Math.abs(aK)+Math.abs(aH)+Math.abs(aG);var aO=aK/aN;var aM=aH/aN;if(aG<0){var aF=(1-Math.abs(aM))*(aO>=0?1:-1);var aE=(1-Math.abs(aO))*(aM>=0?1:-1);aO=aF;aM=aE}aO=Math.round(4095*(0.5*aO+0.5));aM=Math.round(4095*(0.5*aM+0.5));aL[3*aI]=Math.floor(aO/16);aL[3*aI+1]=(aO%16)*16+Math.floor(aM/256);aL[3*aI+2]=aM%256}return aL}function n(aF,aO){var aN=aF.length/3;var aJ=new Uint16Array(3*aN);var aE=new g.Vector3(aO.max.x-aO.min.x,aO.max.y-aO.min.y,aO.max.z-aO.min.z);aE.multiplyScalar(1/65535);var aH=new g.Vector3().copy(aO.min);aH.x/=aE.x;aH.y/=aE.y;aH.z/=aE.z;aH.x=Math.floor(aH.x);aH.y=Math.floor(aH.y);aH.z=Math.floor(aH.z);var aI=function(aR,aQ,aP){return Math.max(Math.min(aR,aP),aQ)};for(var aG=0;aG<aN;aG++){var aM=Math.round(aF[3*aG]/aE.x)-aH.x;var aL=Math.round(aF[3*aG+1]/aE.y)-aH.y;var aK=Math.round(aF[3*aG+2]/aE.z)-aH.z;aJ[3*aG]=aI(aM,0,65535);aJ[3*aG+1]=aI(aL,0,65535);aJ[3*aG+2]=aI(aK,0,65535)}return aJ}function y(aF,aG){var aJ=ag.vertexLayouts[aF];if(aJ==undefined){aJ=ag.vertexLayouts[aF]=aG.vertexLayouts.length;var aH=[];var aE=1;if((aF&aE)!=0){var aI=aC?"UNSIGNED_SHORT":"FLOAT";aH[aH.length]=[{attribute:"POSITION",format:aI,dimension:3}]}aE=aE<<1;if((aF&aE)!=0){var aI=A?"UNSIGNED_BYTE":"FLOAT";aH[aH.length]=[{attribute:"NORMAL",format:aI,dimension:3}]}aE=aE<<1;if((aF&aE)!=0){aH[aH.length]=[{attribute:"TEX_COORD_0",format:"FLOAT",dimension:3}]}aE=aE<<1;if((aF&aE)!=0){aH[aH.length]=[{attribute:"TEX_COORD_1",format:"FLOAT",dimension:3}]}aE=aE<<1;if((aF&aE)!=0){aH[aH.length]=[{attribute:"COLOR",format:"FLOAT",dimension:4}]}aE=aE<<1;if((aF&aE)!=0){aH[aH.length]=[{attribute:"TANGENT",format:"FLOAT",dimension:3}]}aE=aE<<1;if((aF&aE)!=0){aH[aH.length]=[{attribute:"BINORMAL",format:"FLOAT",dimension:3}]}aG.vertexLayouts[aJ]=aH}return aJ}function ax(aE){var aI=0;for(var aG=0;aG<aE.length;aG++){var aH=aE[aG];var aF=aH.group;if(aF.glType>=4){aI+=aH.count/3}}return aI}function B(aG,aF,aE){j.makeEmpty();for(var aJ=0;aJ<aG.length;aJ++){var aK=aG[aJ];for(var aI=0;aI<aK.count;aI++){var aH=aF[aK.start+aI];e.set(aE[3*aH],aE[3*aH+1],aE[3*aH+2]);j.expandByPoint(e)}}return j.getBoundingSphere()}function H(aL,aS){var a9={indexBuffer:null,vertexBuffers:[],drawingGroups:[],normalCompression:A?"OCT_24":"NONE",positionCompression:aC?"BBOX_QUANTIZATION_16_16_16":"NONE"};var aR;var aM;if(ay){aR={};aM=[]}var a7=aL.boundingSphere;if(a7){a9.boundingSphere={center:[a7.center.x,a7.center.y,a7.center.z],radius:a7.radius}}var aQ=null;if(aC){if(!aL.boundingBox){aL.computeBoundingBox()}aQ=aL.boundingBox.clone();if(aQ){a9.boundingBox={min:[aQ.min.x,aQ.min.y,aQ.min.z],max:[aQ.max.x,aQ.max.y,aQ.max.z]}}}var bb=0;for(var bc=0;bc<ae.length;bc++){var aU=ae[bc];var aK=aL[aU];var bf=(aU==="vertexIndexArray");var aG=(aU==="vertexNormalArray");var aP=(aU==="vertexPositionArray");if(aK){if(aP&&aC){aK=n(aK,aQ)}if(aG&&A){aK=o(aK)}if(bf){a9.indexBuffer=C(aK,aS)}else{a9.vertexBuffers.push(s(aK,aS));bb+=af[aU]}}}a9.vertexLayout=y(bb,aS);for(var bc=0;bc<aL.drawingGroups.length;bc++){var aJ=aL.drawingGroups[bc];if((aJ.glType===1)&&!z){continue}if((aJ.glType===0)&&!D){continue}if(I&&hasLayers){aJ.__id__=bc}var aE=aJ.primitives;var aY=d.GeomTypeString[aJ._geomType];var a3={start:aJ.start,count:aJ.count,mode:ac[aJ.glType],geometricType:aY?aY:"UNKNOWN"};var a6=[];var be=-1;var aF=0;if(W||ay){var a0;if(W){a0=new Uint32Array(4*aE.length)}for(var ba=0;ba<aE.length;ba++){var aN=aE[ba];var a1=null;if(ay&&aN.rep){a1=U.get(aN.rep);if(!a1){var a2=B(aN.rep.primitives,aL.vertexIndexArray,aL.vertexPositionArray);var a4=ax(aN.rep.primitives);var a5={uid:ai,cgmId:aN.rep.cgmId,solid:aN.rep.solid,sag:aN.rep.sag,bsphere:a2,nbTriangles:a4};a1=a5;U.set(aN.rep,a1);ai++}if(!aR[a1.uid]){aR[a1.uid]=aM.length;aM.push(a1)}if(be<0){be=aR[a1.uid]}}if(W){a0[4*ba]=aN.cgmId;a0[4*ba+1]=a1?aR[a1.uid]:(aN.rep?aN.rep.cgmId:0);a0[4*ba+2]=aN.start;a0[4*ba+3]=aN.count}else{if(aR[a1.uid]!==be){a6.push({index:be,count:aF});be=aR[a1.uid];aF=aN.count}else{aF+=aN.count}}}if(W){a3.primitives=s(a0,aS)}else{a6.push({index:be,count:aF});var bg=new Uint32Array(2*a6.length);for(var bd=0;bd<a6.length;bd++){bg[2*bd]=a6[bd].index;bg[2*bd+1]=a6[bd].count}a3.repRanges=s(bg,aS)}}a9.drawingGroups.push(a3);if(aJ.material instanceof g.Material){var aV=ag.materials[aJ.material.id];if(!aV){var aX=az(aJ.material,aS);aV={index:aS.materials.length,item:aX};aS.materials.push(aX);ag.materials[aJ.material.id]=aV}a3.material=aV.index}if(aJ.gas){var aH=ag.materials[aJ.gas.id];if(!aH){var aX=az(aJ.gas,aS);aH={index:aS.materials.length,item:aX};aS.materials.push(aX);ag.materials[aJ.gas.id]=aH}a3.graphicAttributes=aH.index}}if(ay&&aM){var aZ=4*aM.length;var a8=9*aM.length;var aT=new Uint8Array(4*a8);var aW=new Uint32Array(aT.buffer,0);var aI=new Float32Array(aT.buffer,4*aZ);for(var bd=0;bd<aM.length;bd++){var aO=aM[bd];aW[4*bd]=aO.uid;aW[4*bd+1]=aO.cgmId;aW[4*bd+2]=aO.solid;aW[4*bd+3]=aO.nbTriangles;aI[5*bd]=aO.bsphere.center.x;aI[5*bd+1]=aO.bsphere.center.y;aI[5*bd+2]=aO.bsphere.center.z;aI[5*bd+3]=aO.bsphere.radius;aI[5*bd+4]=aO.sag}a9.reps=s(aT,aS)}return a9}var G=function(aR,a0){var aQ=ag.nodes[aR.id];if(!aQ){var aG=aR.getNodeType();aQ={type:aG};if(aR._matrix&&!aR._matrix.isIdentity()){var aX=[];aR._matrix.flattenToArray(aX);aQ.matrix=aX}if(aR.material&&aR.material.force){var aK=ag.materials[aR.material.id];if(!aK){var aN=az(aR.material,a0);aK={index:a0.materials.length,item:aN};a0.materials.push(aN);ag.materials[aR.material.id]=aK}aQ.material=aK.index}ag.nodes[aR.id]={index:a0.nodes.length,item:aQ};if(a0.root===null){a0.root=a0.nodes.length}a0.nodes.push(aQ);if(aG==="Node3D"){var aH=[];for(var aU=0;aU<aR.children.length;aU++){aH.push(aR.children[aU].id)}aQ.children=aH}else{if(aG==="LODNode3D"){var aS=[],aM,aU,aT;for(aU=0;aU<aR._representations.length;aU++){aM=[];for(aT=0;aT<aR._representations[aU].length;aT++){aM.push(aR._representations[aU][aT].id)}aS.push(aM)}aQ.representations=aS;var aZ=aR._boundingSphere;if(aZ){aQ.boundingSphere={center:[aZ.center.x,aZ.center.y,aZ.center.z],radius:aZ.radius}}var aF=aR._boundingBox;if(aF){aQ.boundingBox={min:[aF.min.x,aF.min.y,aF.min.z],max:[aF.max.x,aF.max.y,aF.max.z]}}aQ.lodSelector=aR._lodSelector&&aR._lodSelector.createJSON()}else{if(aG==="URLNode3D"){aQ.url=aR.url;var aZ=aR._boundingSphere;if(aZ){aQ.boundingSphere={center:[aZ.center.x,aZ.center.y,aZ.center.z],radius:aZ.radius}}}else{if(aG==="LDHNode3D"){aQ.url=aR.url;var aZ=aR._boundingSphere;if(aZ){aQ.boundingSphere={center:[aZ.center.x,aZ.center.y,aZ.center.z],radius:aZ.radius}}aQ.lodSelector=aR._lodSelector&&aR._lodSelector.createJSON()}else{if(aR._occurrences[0]&&aR._occurrences[0].renderable){var aE=aR._occurrences[0].renderable;var aZ=aE.boundingSphere;var aF=aE.boundingBox;if(!aF){aF=aZ.getBoundingBox()}var aY=false;if(I){for(var aU=0;aU<aR._occurrences.length;aU++){if(aR._occurrences[aU].renderable.layer){aY=true;break}}}var aL=[];for(var aU=0;aU<aE.geometry.length;aU++){var aJ=aE.geometry[aU].id;var aP=ag.geometries[aJ];if(!aP){var aV=H(aE.geometry[aU],a0);aP={index:a0.geometries.length,item:aV};a0.geometries.push(aV);ag.geometries[aJ]=aP}aL.push(aP.index)}aQ.boundingSphere={center:[aZ.center.x,aZ.center.y,aZ.center.z],radius:aZ.radius};aQ.boundingBox={min:[aF.min.x,aF.min.y,aF.min.z],max:[aF.max.x,aF.max.y,aF.max.z]};aQ.geometries=aL;if(I&&aY){aQ.occurrences={};for(var aU=0;aU<aR._occurrences.length;aU++){var aO=aR._occurrences[aU].renderable;if(aO.layer){var aI=[];aQ.occurrences[aU]={index:aU,layers:aI};for(var aT=0;aT<aO.layer.layers.length;aT++){var a1=aO.layer.layers[aT];var aW={start:a1.drawableInterval.start,count:a1.drawableInterval.count,primitiveStart:a1.drawableInterval.primitiveStart,primitiveCount:a1.drawableInterval.primitiveCount,layerNum:a1.drawableInterval.layerNum};if(a1.drawableInterval.material){aW.material=a1.drawableInterval.material.id;var aK=a0.materials[aW.material];if(!aK){aK=a1.drawableInterval.material;a0.materials[aW.material]=az(aK,a0)}}aI.push({geometry:a1.geometry.id,drawableGroup:a1.drawableGroup.__id__,drawableInterval:aW})}}}}if(!aR.material&&aE.material&&aE.material.force){var aK=ag.materials[aE.material.id];if(!aK){var aN=az(aE.material,a0);aK={index:a0.materials.length,item:aN};a0.materials.push(aN);ag.materials[aE.material.id]=aK}aQ.material=aK.index}}else{aQ.type="Node3D"}}}}}if(q){q(aR,aQ)}}};T.traverse(G,an,false,true);for(var av=0;av<an.nodes.length;av++){var T=an.nodes[av];var ar=[];if(T.type==="LODNode3D"){for(var au=0;au<T.representations.length;au++){ar.push(T.representations[au])}}else{if(T.children&&T.type!=="URLNode3D"){ar.push(T.children)}}var at;for(at=0;at<ar.length;at++){var F=ar[at];for(var au=0;au<F.length;au++){F[au]=ag.nodes[F[au]].index}}}if(ad){aA=ad}if(!p&&aA){P.chunks=N(an);if(r){V(P,function(){aA(P)})}else{if(Q){aq(P,function(){aA(P)})}else{aA(P)}}}}};return a});