define("DS/VisuLoaders/MTLLoader",["DS/Visualization/ThreeJS_DS"],function(a){var b=function(d,c){a.EventDispatcher.call(this);this.baseUrl=d;this.options=c};b.prototype={load:function(c){var d=this;var f=new XMLHttpRequest();function e(g){if(g.target.status===200||g.target.status===0){var h=d.parse(g.target.responseText);d.dispatchEvent({type:"load",content:h})}else{d.dispatchEvent({type:"error",message:"Couldn't load URL ["+c+"]",response:g.target.responseText})}}f.addEventListener("load",e,false);f.addEventListener("progress",function(g){d.dispatchEvent({type:"progress",loaded:g.loaded,total:g.total})},false);f.addEventListener("error",function(){d.dispatchEvent({type:"error",message:"Couldn't load URL ["+c+"]"})},false);f.open("GET",c,true);f.send(null)},parse:function(l){var n=l.split("\n");var d={};var e=/\s+/;var c={};for(var f=0;f<n.length;f++){var o=n[f];o=o.trim();if(o.length===0||o.charAt(0)==="#"){continue}var h=o.indexOf(" ");var k=(h>=0)?o.substring(0,h):o;k=k.toLowerCase();var j=(h>=0)?o.substring(h+1):"";j=j.trim();if(k==="newmtl"){d={name:j};c[j]=d}else{if(d){if(k==="ka"||k==="kd"||k==="ks"){var m=j.split(e,3);d[k]=[parseFloat(m[0]),parseFloat(m[1]),parseFloat(m[2])]}else{d[k]=j}}}}var g=new b.MaterialCreator(this.baseUrl,this.options);g.setMaterials(c);return g}};b.MaterialCreator=function(d,c){a.EventDispatcher.call(this);this.baseUrl=d;this.options=c;this.materialsInfo={};this.materials={};this.materialsArray=[];this.nameLookup={};this.side=(this.options&&this.options.side)?this.options.side:a.FrontSide;this.wrap=(this.options&&this.options.wrap)?this.options.wrap:a.RepeatWrapping};b.MaterialCreator.prototype={setMaterials:function(c){this.materialsInfo=this.convert(c);this.materials={};this.materialsArray=[];this.nameLookup={}},convert:function(c){if(!this.options){return c}var j={};for(var e in c){var k=c[e];var i={};j[e]=i;for(var d in k){var f=true;var h=k[d];var g=d.toLowerCase();switch(g){case"kd":case"ka":case"ks":if(this.options&&this.options.normalizeRGB){h=[h[0]/255,h[1]/255,h[2]/255]}if(this.options&&this.options.ignoreZeroRGBs){if(h[0]===0&&h[1]===0&&h[1]===0){f=false}}break;case"d":if(this.options&&this.options.invertTransparency){h=1-h}break;default:break}if(f){i[g]=h}}}return j},preload:function(){for(var c in this.materialsInfo){this.create(c)}},getIndex:function(c){return this.nameLookup[c]},getAsArray:function(){var c=0;for(var d in this.materialsInfo){this.materialsArray[c]=this.create(d);this.nameLookup[d]=c;c++}return this.materialsArray},create:function(c){if(this.materials[c]===undefined){this.createMaterial_(c)}return this.materials[c]},createMaterial_:function(g){var c=this.materialsInfo[g];var e={name:g,side:this.side};for(var f in c){var d=c[f];switch(f.toLowerCase()){case"kd":e.diffuse=new a.Color().setRGB(d[0],d[1],d[2]);break;case"ka":e.ambient=new a.Color().setRGB(d[0],d[1],d[2]);break;case"ks":e.specular=new a.Color().setRGB(d[0],d[1],d[2]);break;case"map_kd":e.map=b.loadTexture(this.baseUrl+d);e.map.wrapS=this.wrap;e.map.wrapT=this.wrap;break;case"ns":e.shininess=d;break;case"d":if(d<1){e.transparent=true;e.opacity=d}break;default:break}}if(e.diffuse){if(!e.ambient){e.ambient=e.diffuse}e.color=e.diffuse}this.materials[g]=new a.MeshPhongMaterial(e);return this.materials[g]}};b.loadTexture=function(f,e,g,i){var d=/\.dds$/i.test(f);if(d){var h=a.ImageUtils.loadCompressedTexture(f,e,g,i)}else{var j=new Image();var h=new a.Texture(j,e);var c=new a.ImageLoader();c.addEventListener("load",function(k){h.image=b.ensurePowerOfTwo_(k.content);h.needsUpdate=true;if(g){g(h)}});c.addEventListener("error",function(k){if(i){i(k.message)}});c.crossOrigin=this.crossOrigin;c.load(f,j)}return h};b.ensurePowerOfTwo_=function(e){if(!b.isPowerOfTwo_(e.width)||!b.isPowerOfTwo_(e.height)){var d=document.createElement("canvas");d.width=b.nextHighestPowerOfTwo_(e.width);d.height=b.nextHighestPowerOfTwo_(e.height);var c=d.getContext("2d");c.drawImage(e,0,0,e.width,e.height,0,0,d.width,d.height);return d}return e};b.isPowerOfTwo_=function(c){return(c&(c-1))===0};b.nextHighestPowerOfTwo_=function(c){--c;for(var d=1;d<32;d<<=1){c=c|c>>d}return c+1};return b});