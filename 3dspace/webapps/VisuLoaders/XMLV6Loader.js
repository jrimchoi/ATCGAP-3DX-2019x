define("DS/VisuLoaders/XMLV6Loader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager"],function(d,f,e,b,a){var c=function(A,q,w,l){var p=A;var x=(typeof w==="undefined")?false:w;var R=(q!==undefined)?q:null;var S=null;var U=null;var N=null;var m;var o=null;var P=0;var E=0;var V=0;var s=[];var C=[];var W=[];var j=[];var h=[];var K=[];var r=[];var J=[];var G;var O=null;var n=[];var D;var T=l;this.setGeometryMode=function(Y){T=Y};function B(){S=null;U=null;N=null;m="";P=0;E=0;V=0;s=[];C=[];W=[];j=[];h=[];K=[];r=[];J=[];G="";O=null;n=[];D=null}this.load=function(Z,ad,ac,Y){B();m=Z;var aa=Z+"/Manifest.3dxml";if(document.implementation&&document.implementation.createDocument){var ab=new XMLHttpRequest();ab.onreadystatechange=function(){if(ab.readyState===4){if(ab.status===0||ab.status===200){if(ab.responseXML){S=ad;U=Y;N=ac;t(ab.responseXML,undefined,aa)}else{console.error("XMLV6Loader: Empty or non-existing file ("+aa+")")}}}};ab.open("GET",aa,true);if(ab.overrideMimeType){ab.overrideMimeType("text/xml")}ab.send(null)}else{alert("Don't know how to parse XML!")}};function t(ad){var ab=ad.firstChild;if(ab&&ab.childNodes){for(var aa=0;aa<ab.childNodes.length;aa++){var ae=ab.childNodes[aa];switch(ae.nodeName){case"XMLContent":var ac=ae.getAttribute("Domain");var Y=ae.getAttribute("Location");var Z=ae.getAttribute("Name");if(ac==="Geometry"){s.push({path:Y,filename:Z})}else{if(ac==="Material"){r.push(Y+"/"+Z)}else{if(ac==="Link"){h.push(Y+"/"+Z)}else{if(ac==="Product3D"){if(Z==="Product.3dxmlproduct3d"){G=Y+"/"+Z}}}}}break;case"Other":break}}}D=new e();if(h.length){L(0)}}function L(Y){if(Y<h.length){y(Y)}else{u(0)}}function u(Y){if(Y<r.length){M(Y)}else{g()}}function g(){G=m+"/"+G;if(document.implementation&&document.implementation.createDocument){var Y=new XMLHttpRequest();Y.onreadystatechange=function(){if(Y.readyState===4){if(Y.status===0||Y.status===200){if(Y.responseXML){var aa=Y.responseXML.firstChild;if(aa&&aa.childNodes){for(var an=0;an<aa.childNodes.length;an++){var ab=aa.childNodes[an];if((ab.nodeName!=="Product")&&(ab.nodeName!=="ProductInst")&&(ab.nodeName!=="RepUsage")){continue}var ah=ab.getAttribute("id");var ai=new e();ai.name=ah;ai.getPersistentId=function(){return this.name};switch(ab.nodeName){case"Product":n[ah]=ai;if(O===null){O=ai}break;case"ProductInst":n[ah]=ai;var am="";var ao="";var ak=null;for(var al=0;al<ab.childNodes.length;al++){var ag=ab.childNodes[al];if(ag.nodeName==="Owned"){am=ag.getAttribute("idref")}else{if(ag.nodeName==="Instancing"){ao=ag.getAttribute("idref")}else{if(ag.nodeName==="RelativeTransformation3D"){for(var aj=0;aj<ag.childNodes.length;aj++){var ad=ag.childNodes[aj];if(ad.nodeName==="Translation3D"){var aq=F(ad.textContent);if(aq.length===3){if(ak===null){ak=new d.Matrix4()}ak.setPosition(new d.Vector3(aq[0]*1000,aq[1]*1000,aq[2]*1000))}}else{if(ad.nodeName==="Rotation3D"){var aq=F(ad.textContent);if(aq.length===9){if(ak===null){ak=new d.Matrix4()}var ac=[aq[0],aq[3],aq[6],aq[1],aq[4],aq[7],aq[2],aq[5],aq[8]];ak.setRotation(ac)}}}}}}}}if(ak!==null){ai.setMatrix(ak)}if((am!=="")&&(ao!=="")){n[am].addChild(ai);ai.addChild(n[ao])}break;case"RepUsage":n[ah]=ai;var am="";var ao="";var Z={};for(var al=0;al<ab.childNodes.length;al++){var ag=ab.childNodes[al];if(ag.nodeName==="Owned"){am=ag.getAttribute("idref")}else{if(ag.nodeName==="Instancing"){ao=ag.getAttribute("linkidref")}else{if(ag.nodeName==="BoundingBox"){for(var aj=0;aj<ag.childNodes.length;aj++){var af=ag.childNodes[aj];if(af.nodeName==="MinPoint"){Z.min=F(af.textContent)}else{if(af.nodeName==="MaxPoint"){Z.max=F(af.textContent)}}}}}}}if((am!=="")&&(ao!=="")){n[am].addChild(ai);var ap=K[ao].target;C[ap]=ai;if(Z.min!==undefined){W[ai.name]=ap}else{j.push(ap)}E++;V++}if((Z.min!==undefined)&&(Z.max!==undefined)){var ae=k(Z);ai.addChild(ae)}break;default:break}}if(O!==null){D.addChild(O)}}}else{console.error("XMLV6Loader: Empty or non-existing file ("+G+")")}I()}}};Y.open("GET",G,true);if(Y.overrideMimeType){Y.overrideMimeType("text/xml")}Y.send(null)}else{alert("Don't know how to parse XML!")}}function y(Y){var aa=m+"/"+h[Y];if(document.implementation&&document.implementation.createDocument){var Z=new XMLHttpRequest();Z.onreadystatechange=function(){if(Z.readyState===4){if(Z.status===0||Z.status===200){if(Z.responseXML){var ac=Z.responseXML.firstChild;if(ac&&ac.childNodes){var ab=0;while(ab<ac.childNodes.length){if(ac.childNodes[ab].nodeName==="Links"){ac=ac.childNodes[ab];break}ab++}if(ac&&ac.childNodes){for(var ab=0;ab<ac.childNodes.length;ab++){var ag=ac.childNodes[ab];if(ag.nodeName==="Link"){var ad=ag.getAttribute("Source");var ae=ag.getAttribute("Target");var af=ag.getAttribute("id");K[af]={source:ad,target:ae}}}}}L(Y+1)}else{console.error("XMLV6Loader: Empty or non-existing file ("+aa+")")}}}};Z.open("GET",aa,true);if(Z.overrideMimeType){Z.overrideMimeType("text/xml")}Z.send(null)}else{alert("Don't know how to parse XML!")}}function M(Z){var Y=m+"/"+r[Z];if(document.implementation&&document.implementation.createDocument){var aa=new XMLHttpRequest();aa.onreadystatechange=function(){if(aa.readyState===4){if(aa.status===0||aa.status===200){if(aa.responseXML){var ac=aa.responseXML.firstChild;if(ac&&ac.childNodes){var ab=0;while(ab<ac.childNodes.length){if(ac.childNodes[ab].nodeName==="AppliedAppearanceGroup"){ac=ac.childNodes[ab];break}ab++}if(ac&&ac.childNodes){var ad=new a();for(var ab=0;ab<ac.childNodes.length;ab++){var ag=ac.childNodes[ab];if(ag.nodeName==="AppliedAppearance"){var af=ag.getAttribute("id");var ae=i(ag);J[af]=ad.createMaterial(ae,m+"/resources","XMLV6")}}}}u(Z+1)}else{console.error("XMLV6Loader: Empty or non-existing file ("+Y+")")}}}};aa.open("GET",Y,true);if(aa.overrideMimeType){aa.overrideMimeType("text/xml")}aa.send(null)}else{alert("Don't know how to parse XML!")}}function i(ae){var af={};var ad=null;for(var ah=0;ah<ae.childNodes.length;ah++){if(ae.childNodes[ah].nodeName==="ShadingModel"){ad=ae.childNodes[ah];break}}if(ad){for(var ah=0;ah<ad.childNodes.length;ah++){var ac=ad.childNodes[ah];switch(ac.nodeName){case"IlluminationModel":if(ac.textContent==="PHONG"){af.shading="Phong"}break;case"DiffuseColor":af.colorDiffuse=z(ac.textContent);break;case"SpecularColor":af.colorSpecular=z(ac.textContent);break;case"AmbientColor":af.colorAmbient=z(ac.textContent);break;case"SpecularCoefficient":af.specularCoef=parseFloat(ac.textContent);break;case"SpecularExponent":af.shininess=128*parseFloat(ac.textContent);break;case"ReflectivityCoefficient":af.reflectivityCoef=parseFloat(ac.textContent);break;case"TransparencyCoefficient":af.transparency=parseFloat(ac.textContent);af.transparent=(af.transparency>0);break;case"DiffuseMap":case"ReflectionMap":var aa=-1;var Z=-1;var ab=-1;var Y=-1;var ak=1;var aj=1;af[ac.nodeName+"Wrap"]=[];for(var ag=0;ag<ac.childNodes.length;ag++){var ai=ac.childNodes[ag];switch(ai.nodeName){case"WrappingU":aa=(ai.textContent==="REPEAT")?1:0;break;case"WrappingV":Z=(ai.textContent==="REPEAT")?1:0;break;case"FlipU":ab=(ai.textContent==="true")?1:-1;break;case"FlipV":Y=(ai.textContent==="true")?1:-1;break;case"ScaleU":ak=parseFloat(ai.textContent);break;case"ScaleV":aj=parseFloat(ai.textContent);break;case"MapFile":af[ac.nodeName]=K[ai.textContent].target;break;default:break}}if((aa>=0)||(Z>=0)){if(aa===1){af[ac.nodeName+"Wrap"][0]="repeat"}if(Z===1){af[ac.nodeName+"Wrap"][1]="repeat"}af[ac.nodeName+"Repeat"]=[aa,Z];if(ak!==1){af[ac.nodeName+"Repeat"][0]=ak}if(aj!==1){af[ac.nodeName+"Repeat"][1]=aj}}if(ab===1){af[ac.nodeName+"Wrap"][0]="mirror"}if(Y===1){af[ac.nodeName+"Wrap"][1]="mirror"}break;default:break}}}return af}function z(Z){var ab=[];var aa=new RegExp(/RGB\(\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*\)/i);var Y=aa.exec(Z);if(Y!==null){ab[0]=parseFloat(RegExp.$1);ab[1]=parseFloat(RegExp.$2);ab[2]=parseFloat(RegExp.$3)}else{aa=new RegExp(/RGBA\(\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*\)/i);Y=aa.exec(Z);if(Y!==null){ab[0]=parseFloat(RegExp.$1);ab[1]=parseFloat(RegExp.$2);ab[2]=parseFloat(RegExp.$3);ab[3]=parseFloat(RegExp.$4)}}return ab}function I(){if(o!==null){o.terminate();o=null}if(o===null){if(T==="3dxmlgeometry"){o=new Worker(f.getWebappsBaseUrl()+"Workers/XMLV6Worker.js")}else{o=new Worker(f.getWebappsBaseUrl()+"Workers/CGRWorker.js")}o.onmessage=function(ad){var ac=ad.data;var ae=C[ac.node];P--;E--;if(ae){var ab=null;if(ac.rep.length>0){ab=Q(ac.rep)}else{ab=H()}ae.removeChild(ae.getChildByName("BBox"));ae.addChild(ab);ae.setVisibility(true)}if(N!==null){N({loaded:V-E,total:V})}if(R!==null){R({hack:true,updateInfinitePlane:true})}if(!E&&(U!==null)){U()}}}P+=j.length;for(var Z=0;Z<j.length;Z++){var aa=j[Z];if(aa!==undefined){var Y=m+"/3dxmlcontent/"+aa;if(aa!==""){if(o){o.postMessage({path:Y,node:aa})}}}}if(S){S(D)}}this.loadGeometryFiles=function(aa){var ab=Math.min(aa.length,1);P+=ab;for(var Z=0;Z<ab;Z++){var ac=W[aa[Z].name];if(ac!==undefined){var Y=m+"/3dxmlcontent/"+ac;if(ac!==""){if(o){o.postMessage({path:Y,node:ac})}}delete W[aa[Z].name]}}};this.isWebWorkerBusy=function(){return(P>0)};function Q(ai){var Y=null;var ae=[];var ad=null;var aq=null;var at=new d.Sphere();var Z=new d.Box3();var ag=new a();for(var ap=0;ap<ai.length;ap++){var aa=ai[ap];var af=new d.BufferGeometryDS();var al=new d.Vector3(aa.AABB.min[0],aa.AABB.min[1],aa.AABB.min[2]);var ao=new d.Vector3(aa.AABB.max[0],aa.AABB.max[1],aa.AABB.max[2]);if(ad===null){ad=al}if(aq===null){aq=ao}if(al.x<ad.x){ad.x=al.x}if(al.y<ad.y){ad.y=al.y}if(al.z<ad.z){ad.z=al.z}if(ao.x>aq.x){aq.x=ao.x}if(ao.y>aq.y){aq.y=ao.y}if(ao.z>aq.z){aq.z=ao.z}Z.set(ad,aq);at.radius=aq.clone().sub(ad).multiplyScalar(0.5).length();at.center=aq.clone().add(ad).multiplyScalar(0.5);for(var an=0;an<aa.drawingGroups.length;an++){aa.drawingGroups[an].geometry=af;var aj=aa.drawingGroups[an].gas;var ah=aa.drawingGroups[an].material;if(ah!==null){ah=ah.id}if((ah!==null)&&K[ah]){var ak=K[ah].target;var ar=[];ar=ak.split("#");aa.drawingGroups[an].gas=J[ar[1]]}else{if(aj!==null){var am=new d.Color();am.setRGB(aj.color.r,aj.color.g,aj.color.b);aa.drawingGroups[an].gas=ag.getMaterialFromGAS({color:am,opacity:aj.opacity,lineWidth:(aj.lineWidth?aj.lineWidth:aj.linewidth),solid:aj.solid})}}}af.drawingGroups=aa.drawingGroups;af.vertexPositionArray=aa.vertexPositionArray;if(aa.vertexNormalArray!==null){af.vertexNormalArray=aa.vertexNormalArray}if(aa.vertexUvArray!==null){af.vertexUvArray=aa.vertexUvArray}af.vertexIndexArray=aa.vertexIndexArray;ae.push(af)}var ac=new d.Color();ac.setRGB(ai[0].gas.fill.color.r,ai[0].gas.fill.color.g,ai[0].gas.fill.color.b);var ab=new d.Color();ab.setRGB(ai[0].gas.line.color.r,ai[0].gas.line.color.g,ai[0].gas.line.color.b);var ah=ag.getMaterialFromGAS({color:ac,opacity:ai[0].gas.fill.opacity,solid:ai[0].gas.fill.solid});ah.line=ag.getMaterialFromGAS({color:ab,opacity:ai[0].gas.line.opacity,lineWidth:(ai[0].gas.line.lineWidth?ai[0].gas.line.lineWidth:ai[0].gas.line.linewidth)});ae.boundingSphere=at;ae.boundingBox=Z;Y=new d.Mesh(ae,ah);Y.matrixAutoUpdate=false;Y.castShadow=true;Y.receiveShadow=true;return new b(Y)}function H(){var Z=new d.BufferGeometryDS();Z.boundingSphere=new d.Sphere();Z.boundingBox=new d.Box3();var Y=new d.MeshPhongMaterial();var aa=new d.Mesh(Z,Y);aa.matrixAutoUpdate=false;aa.castShadow=true;aa.receiveShadow=true;return new b(aa)}function F(ac){var Z=X(ac);var ab=[];for(var aa=0,Y=Z.length;aa<Y;aa++){ab.push(parseFloat(Z[aa]))}return ab}function X(Y){return(Y.length>0)?v(Y).split(/\s+/):[]}function v(Y){return Y.replace(/^\s+/,"").replace(/\s+$/,"")}function k(Y){var ab=new d.BufferGeometryDS();var ac=new Float32Array(72);var ah=new Float32Array(72);var aa=new Uint16Array(36);var am=0;var ak=0;var aj=0;for(var an=0;an<6;an++){aa[ak++]=aj;aa[ak++]=aj+1;aa[ak++]=aj+2;aa[ak++]=aj;aa[ak++]=aj+2;aa[ak++]=aj+3;aj+=4}for(var ae=0;ae<12;ae+=3){ah[am+ae]=0;ah[am+ae+1]=-1;ah[am+ae+2]=0}ac[am++]=Y.min[0];ac[am++]=Y.min[1];ac[am++]=Y.min[2];ac[am++]=Y.max[0];ac[am++]=Y.min[1];ac[am++]=Y.min[2];ac[am++]=Y.max[0];ac[am++]=Y.min[1];ac[am++]=Y.max[2];ac[am++]=Y.min[0];ac[am++]=Y.min[1];ac[am++]=Y.max[2];for(var ae=0;ae<12;ae+=3){ah[am+ae]=0;ah[am+ae+1]=1;ah[am+ae+2]=0}ac[am++]=Y.min[0];ac[am++]=Y.max[1];ac[am++]=Y.min[2];ac[am++]=Y.min[0];ac[am++]=Y.max[1];ac[am++]=Y.max[2];ac[am++]=Y.max[0];ac[am++]=Y.max[1];ac[am++]=Y.max[2];ac[am++]=Y.max[0];ac[am++]=Y.max[1];ac[am++]=Y.min[2];for(var ae=0;ae<12;ae+=3){ah[am+ae]=0;ah[am+ae+1]=0;ah[am+ae+2]=1}ac[am++]=Y.max[0];ac[am++]=Y.max[1];ac[am++]=Y.max[2];ac[am++]=Y.min[0];ac[am++]=Y.max[1];ac[am++]=Y.max[2];ac[am++]=Y.min[0];ac[am++]=Y.min[1];ac[am++]=Y.max[2];ac[am++]=Y.max[0];ac[am++]=Y.min[1];ac[am++]=Y.max[2];for(var ae=0;ae<12;ae+=3){ah[am+ae]=0;ah[am+ae+1]=0;ah[am+ae+2]=-1}ac[am++]=Y.min[0];ac[am++]=Y.min[1];ac[am++]=Y.min[2];ac[am++]=Y.min[0];ac[am++]=Y.max[1];ac[am++]=Y.min[2];ac[am++]=Y.max[0];ac[am++]=Y.max[1];ac[am++]=Y.min[2];ac[am++]=Y.max[0];ac[am++]=Y.min[1];ac[am++]=Y.min[2];for(var ae=0;ae<12;ae+=3){ah[am+ae]=1;ah[am+ae+1]=0;ah[am+ae+2]=0}ac[am++]=Y.max[0];ac[am++]=Y.min[1];ac[am++]=Y.min[2];ac[am++]=Y.max[0];ac[am++]=Y.max[1];ac[am++]=Y.min[2];ac[am++]=Y.max[0];ac[am++]=Y.max[1];ac[am++]=Y.max[2];ac[am++]=Y.max[0];ac[am++]=Y.min[1];ac[am++]=Y.max[2];for(var ae=0;ae<12;ae+=3){ah[am+ae]=-1;ah[am+ae+1]=0;ah[am+ae+2]=0}ac[am++]=Y.min[0];ac[am++]=Y.min[1];ac[am++]=Y.max[2];ac[am++]=Y.min[0];ac[am++]=Y.max[1];ac[am++]=Y.max[2];ac[am++]=Y.min[0];ac[am++]=Y.max[1];ac[am++]=Y.min[2];ac[am++]=Y.min[0];ac[am++]=Y.min[1];ac[am++]=Y.min[2];var ad=new a();var ap=ad.getMaterialFromGAS({color:new d.Color(16729156),opacity:0});ab.drawingGroups=[];ab.drawingGroups.push({start:0,count:36,glType:4,gas:ap});var ai=new d.Vector3(Y.min[0],Y.min[1],Y.min[2]);var al=new d.Vector3(Y.max[0],Y.max[1],Y.max[2]);var Z=al.clone().sub(ai).multiplyScalar(0.5).length();var ao=al.clone().add(ai).multiplyScalar(0.5);ab.boundingSphere=new d.Sphere(ao,Z);ab.boundingBox=new d.Box3(ai,al);ab.vertexPositionArray=ac;ab.vertexNormalArray=ah;ab.vertexIndexArray=aa;var af=new d.Mesh(ab,ap);af.matrixAutoUpdate=false;var ag=new b(af,"BBox");return ag}};return c});