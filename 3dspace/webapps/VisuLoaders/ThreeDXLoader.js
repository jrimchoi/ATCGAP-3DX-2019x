define("DS/VisuLoaders/ThreeDXLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Visualization/LightNode3D","DS/Visualization/Viewpoint","DS/Visualization/Ambience","DS/ZipJS/zip"],function(C,n,k,r,e,d,D,t,b,A){window.THREEDXLOADER_DEBUG_MODE=false;var s=function(G){window.THREEDXLOADER_DEBUG_MODE&&console.log("3DX Loader >> "+G)};var w={indexMap:null,indices:null,positions:null,normals:null};var h=0;var p=0;var E=0;var y=0;var v=0;var j=function(){var G=100000;var I=new C.Vector3();var H=new C.Vector3();this.computeBoundingVolume=function(N){var M={min:new C.Vector3(Infinity,Infinity,Infinity),max:new C.Vector3(-Infinity,-Infinity,-Infinity)};for(var J=0;J<N.length;J++){var K=N[J];var L=K.bbox;if(L[0]<M.min.x){M.min.x=L[0]}if(L[1]<M.min.y){M.min.y=L[1]}if(L[2]<M.min.z){M.min.z=L[2]}if(L[3]>M.max.x){M.max.x=L[3]}if(L[4]>M.max.y){M.max.y=L[4]}if(L[5]>M.max.z){M.max.z=L[5]}}return M};this.countTriangles=function(L){var K=0;for(var J=0;J<L.length;J++){K+=L[J].nbTriangles}return K};this.partitionObjects=function(N,L){var K=I;K.subVectors(L.max,L.min);var J=0;var M=K.x;if(K.y>K.x){J=1;M=K.y}if(K.z>M){J=2;M=K.z}N.sort(function(Q,P){var O=Q.bbox[3+J];var R=P.bbox[3+J];if(O===R){O=Q.bbox[3+(J+1)%3];R=P.bbox[3+(J+1)%3];if(O===R){O=Q.bbox[3+(J+2)%3];R=P.bbox[3+(J+2)%3];return R-O}return R-O}return R-O});return Math.floor(0.5*N.length)};this.buildBVH=function(P,O,J){var L={type:0,objects:null,bbox:null,leftRightNode:[]};L.bbox=this.computeBoundingVolume(P);if(O){O.leftRightNode[J]=L}if((P.length===1)||(this.countTriangles(P)<=G)){L.type=1;L.objects=P}else{var N=this.partitionObjects(P,L.bbox);var K=P.slice(0,N);var M=P.slice(N,P.length);if(K.length){this.buildBVH(K,L,0)}if(M.length){this.buildBVH(M,L,1)}}return L};this.getRenderListFromBVH=function(J,L,K){if(K&&!this.cullingBVH(J.bbox,K)){return}if(J.type===1){L.push(J)}else{J.leftRightNode[0]&&this.getRenderListFromBVH(J.leftRightNode[0],L,K);J.leftRightNode[1]&&this.getRenderListFromBVH(J.leftRightNode[1],L,K)}}};var m={1:"vertexPositionArray",2:"vertexNormalArray",4:"vertexUvArray",8:"vertexUv2Array",16:"vertexColorArray",32:"vertexTangentArray",64:"vertexBinormalArray"};var g={1:3,2:3,4:2,8:2,16:4,32:3,64:3};var q={1:0,2:3,4:6,8:8,16:10,32:14,64:17};var a={NEAREST:1003,NEAREST_MIPMAP_NEAREST:1004,NEAREST_MIPMAP_LINEAR:1005,LINEAR:1006,LINEAR_MIPMAP_NEAREST:1007,LINEAR_MIPMAP_LINEAR:1008};var l={REPEAT:1000,CLAMP_TO_EDGE:1001,MIRRORED_REPEAT:1002};var B={POINTS:0,LINES:1,TRIANGLES:4};var F={Physical:"PhysicalMaterial",Phong:"MeshPhongMaterial",PointBasic:"ParticleBasicMaterial",LineBasic:"LineBasicMaterial",MeshBasic:"MeshBasicMaterial"};var z={PLANAR:1,SPHERICAL:2,CUBIC:4,FINITE_CYLINDRICAL:5,INFINITE_CYLINDRICAL:6};var c=function(G){var H=null;if(G.length==16){H=new C.Matrix3(G[0],G[4],G[12],G[1],G[5],G[13],G[3],G[7],G[15])}else{if(G.length==9){H=new C.Matrix3(G[0],G[3],G[6],G[1],G[4],G[7],G[2],G[5],G[8])}}return H};var x=function(G){this.options={};this.isGAS=true;this.id="";this.data=G};x.prototype.read=function(I,H,G){this.options={visible:I.visible,force:true,side:I.side,transparent:I.transparent,depthTest:I.depthTest,depthWrite:I.depthWrite};this.isGAS=true;this.id="VIS"+this.options.visible+"S"+this.options.side+"T"+this.options.transparent;this.id+="DT"+this.options.depthTest+"DW"+this.options.depthWrite;if(typeof I.NRECompatibility!=="undefined"){this.options.NRECompatibility=I.NRECompatibility}if(I.needTangentBinormal){this.options.needTangentBinormal=I.needTangentBinormal}if(I.alphaTest){this.options.alphaTest=I.alphaTest}if(I.vertexColors){this.options.vertexColors=I.vertexColors}if(typeof I.normalMap!=="undefined"){this.options.normalMap=this.data.textures[I.normalMap].texture;this.options.needTangentBinormal=true;if(typeof I.needTangentBinormal!=="undefined"){this.options.needTangentBinormal=I.needTangentBinormal}this.isGAS=false}if(typeof I.normalMapFlipY!=="undefined"){this.options.normalMapFlipY=I.normalMapFlipY}if(typeof I.bumpMap!=="undefined"){this.options.bumpMap=this.data.textures[I.bumpMap].texture;this.isGAS=false}if(typeof I.lightMap!=="undefined"){this.options.lightMap=this.data.textures[I.lightMap].texture;this.isGAS=false}if(typeof I.iterative!=="undefined"){this.options.iterative=I.iterative}if(typeof I.sslr!=="undefined"){this.options.sslr=I.sslr}};var i=function(G){x.call(this,G)};i.prototype=Object.create(x.prototype);i.prototype.buildGenericColor=function(I,G,J,K){if(typeof I[G]!=="undefined"){var H=I[G];this.options[J]=new C.Color().setRGB(H[0],H[1],H[2]);if(K!==null){this.id+=K+this.options[J].getStyle()}}};i.prototype.buildGenericFloat=function(H,G,J,K){if(typeof H[G]!=="undefined"){var I=H[G];if((G==="shininess")&&(I<1)){I*=255}this.options[J]=I;if(K!==null){this.id+=K+this.options[J]}}};i.prototype.buildGenericMap=function(I,H,K,G){if(typeof I[H]!=="undefined"){this.isGAS=false;var J=this.data.textures[I[H]].texture;this.options[K]=J;this.options.transparent=this.options.transparent||K==="opacityMap";if(G){this.options[K+"Linear"]=!this.options[K].sRGB}}};i.prototype.read=function(K,I,G){x.prototype.read.apply(this,arguments);this.buildGenericFloat(K,"opacity","opacity","O");this.buildGenericColor(K,"color","color","C");this.buildGenericColor(K,"ambient","ambient","A");this.buildGenericColor(K,"emissive","emissive","E");this.buildGenericColor(K,"specular","specular","SP");this.buildGenericFloat(K,"shininess","shininess","SH");this.buildGenericFloat(K,"glossiness","glossiness","G");this.buildGenericMap(K,"glossinessMap","glossinessMap",false);this.buildGenericMap(K,"specularMap","specularMap",true);this.buildGenericMap(K,"opacityMap","opacityMap",false);if(typeof K.diffuseMap!=="undefined"){this.isGAS=false;var J=this.data.textures[K.diffuseMap];this.options.map=J.texture;if(this.options.color&&(I.content==="material")){this.options.color.setRGB(1,1,1)}if(J.lods){this.options.map.setAsLOD(I.switchLODTextureCB?I.switchLODTextureCB:G);for(var H=0;H<J.lods.length;H++){this.options.map.lods.push(new C.LODTextureData(J.lods[H].textureData,null,J.lods[H].loadCB))}}}if(typeof K.normalMapScale!=="undefined"){this.options.normalScale=K.normalMapScale}if(typeof K.bumpMapScale!=="undefined"){this.options.bumpScale=K.bumpMapScale}if(typeof K.size!=="undefined"){this.options.size=K.size}if(typeof K.sizeAttenuation!=="undefined"){this.options.sizeAttenuation=K.sizeAttenuation}if(typeof K.lineWidth!=="undefined"){this.options.lineWidth=K.lineWidth}if(typeof K.envMap!=="undefined"){this.options.envMap=this.data.textures[K.envMap].texture}if(typeof K.refractionRatio!=="undefined"){this.options.refractionRatio=K.refractionRatio}if(typeof K.refractionRatioMap!=="undefined"){this.options.refractionRatioMap=this.data.textures[K.refractionRatioMap].texture}};var u=function(G){x.call(this,G);this.isGAS=false};u.prototype=Object.create(x.prototype);u.prototype.buildGenericPhysicalColorOptions=function(J,N,L,K,Q,O){if(typeof J[N]!=="undefined"){var H=J[N];if(H.length){this.options[L]=new C.Color().setRGB(H[0],H[1],H[2]);return}if(typeof H.value!=="undefined"){var M=H.value;this.options[L]=new C.Color().setRGB(M[0],M[1],M[2])}else{if(Q!==null){this.options[L]=Q}}if(typeof H.texture!=="undefined"){var P=H.texture;if(typeof H.value==="undefined"){this.options[L]=new C.Color().setRGB(1,1,1)}this.options[L+"Map"]=this.data.textures[P].texture;this.options[L+"MapLinear"]=O;if(K&&this.data.textures[P].mapping){var G=this.data.textures[P].mapping;if(G.uvTransform){this.options[L+"UvTransform"]=c(G.uvTransform)}if(G.operator){var I=G.operator;this.options.mappingUseFragment=true;this.options.mappingType=z[I.type];this.options.mappingObjTransformation=new C.Matrix4();if(I.transform){this.options.mappingObjTransformation.elements=I.transform}}if(G.slot){this.options.uvSlots[L+"Map"]=(G.slot==="TEX_COORD_1")?2:1}}}if(typeof H.MADCoefficients!=="undefined"){var R=H.MADCoefficients;this.options[L+"MulCoef"]=new C.Vector3(R[0],R[1],R[2]);this.options[L+"AddCoef"]=new C.Vector3(R[3],R[4],R[5])}}else{if(Q!==null){this.options[L]=Q}}};u.prototype.buildGenericPhysicalFloatOptions=function(K,N,M,L,Q,O){if(typeof K[N]!=="undefined"){var H=K[N];if(typeof H!=="object"){this.options[M]=H;return}if(typeof H.value!=="undefined"){var R=H.value;this.options[M]=R}else{if(Q!==null){this.options[M]=Q}}if(typeof H.texture!=="undefined"){var P=H.texture;if(typeof H.value==="undefined"){this.options[M]=1}this.options.transparent=this.options.transparent||(M==="opacity"||M==="transparency");this.options[M+"Map"]=this.data.textures[P].texture;this.options[M+"MapLinear"]=O;if(L&&this.data.textures[P].mapping){var G=this.data.textures[P].mapping;if(G.uvTransform){var J=G.uvTransform;this.options[M+"UvTransform"]=c(G.uvTransform)}if(G.operator){var I=G.operator;this.options.mappingUseFragment=true;this.options.mappingType=z[I.type];this.options.mappingObjTransformation=new C.Matrix4();if(I.transform){this.options.mappingObjTransformation.elements=I.transform}}if(G.slot){this.options.uvSlots[M+"Map"]=(G.slot==="TEX_COORD_1")?2:1}}}if(typeof H.MADCoefficients!=="undefined"){var S=H.MADCoefficients;this.options[M+"MulCoef"]=S[0];this.options[M+"AddCoef"]=S[1]}}else{if(Q!==null){this.options[M]=Q}}};u.prototype.buildGenericPhysicalFloat2Options=function(J,M,L,K,P,N){if(typeof J[M]!=="undefined"){var H=J[M];if(typeof H.value!=="undefined"){var Q=H.value;if(typeof Q==="number"){this.options[L]=new C.Vector2(Q,Q)}else{this.options[L]=new C.Vector2(Q[0],Q[1])}}else{if(P!==null){this.options[L]=P}}if(typeof H.texture!=="undefined"){var O=H.texture;if(typeof H.value==="undefined"){this.options[L]=new C.Vector2(1,1)}this.options[L+"Map"]=this.data.textures[O].texture;this.options[L+"MapLinear"]=N;if(K&&this.data.textures[O].mapping){var G=this.data.textures[O].mapping;if(G.uvTransform){this.options[L+"UvTransform"]=c(G.uvTransform)}if(G.operator){var I=G.operator;this.options.mappingUseFragment=true;this.options.mappingType=z[I.type];this.options.mappingObjTransformation=new C.Matrix4();if(I.transform){this.options.mappingObjTransformation.elements=I.transform}}if(G.slot){this.options.uvSlots[L+"Map"]=(G.slot==="TEX_COORD_1")?2:1}}}if(typeof H.MADCoefficients!=="undefined"){var R=H.MADCoefficients;this.options[L+"MulCoef"]=R[0];this.options[L+"AddCoef"]=R[1]}}else{if(P!==null){this.options[L]=P}}};u.prototype.buildGenericPhysicalNormalOptions=function(L,G,N,K){var J=G+"Map";if(typeof L[J]!=="undefined"){var M=L[J];this.options[N+"Map"]=this.data.textures[M].texture;if(K&&this.data.textures[M].mapping){var I=this.data.textures[M].mapping;if(I.uvTransform){this.options[N+"UvTransform"]=c(I.uvTransform)}if(I.operator){var H=I.operator;this.options.mappingUseFragment=true;this.options.mappingType=z[H.type];this.options.mappingObjTransformation=new C.Matrix4();if(H.transform){this.options.mappingObjTransformation.elements=H.transform}}if(I.slot){this.options.uvSlots[N+"Map"]=(I.slot==="TEX_COORD_1")?2:1}}}if(typeof L[G+"MapFlipY"]!=="undefined"){this.options[G+"MapFlipY"]=L[G+"MapFlipY"]}};u.prototype._startread=function(J,H,G){x.prototype.read.call(this,J,undefined,undefined);this.options.uvSlots={diffuseMap:1,specularMap:1,roughnessMap:1,normalMap:1,lightMap:2};this.options.NRECompatibility=true;if(typeof J.useAlphaDiffuseChannel!=="undefined"){this.options.useAlphaFromDiffuseMap=J.useAlphaDiffuseChannel}this.buildGenericPhysicalNormalOptions(J,"normal","normal",true);if(typeof J.lightMap!=="undefined"){var I=this.data.textures[J.lightMap].mapping;if(I){if(I.uvTransform){this.options.lightMapUvTransform=c(I.uvTransform)}else{this.options.lightMapUvTransform=new C.Matrix3()}if(I.operator){this.options.mappingUseFragment=true;this.options.mappingType=z[I.operator.type];this.options.mappingObjTransformation=new C.Matrix4();if(I.operator.transform){this.options.mappingObjTransformation.elements=I.operator.transform}}if(I.slot){this.options.uvSlots.lightMap=(I.slot==="TEX_COORD_1")?2:1}}}this.buildGenericPhysicalFloatOptions(J,"displacement","displacement",false,null,true)};u.prototype._endread=function(I,H,G){if(typeof I.uv0Transform!=="undefined"){if(!this.options.mappingType){this.options.mappingType=0}var J=I.uv0Transform;this.options.mappingUVTransformation=new C.Matrix3(J[0],J[3],J[6],J[1],J[4],J[7],J[2],J[5],J[8])}if(this.options.mappingObjTransformation){this.options.mappingNormTransformation=new C.Matrix3().getInverse(this.options.mappingObjTransformation).transpose()}};u.prototype.read=function(M,K,H){this._startread(M,K,H);this.options.color=new C.Color().setRGB(0,0,0);if(typeof M.diffuse!=="undefined"){if(M.diffuse.value!==undefined){this.options.color=new C.Color().setRGB(M.diffuse.value[0],M.diffuse.value[1],M.diffuse.value[2])}var I=M.diffuse.texture;if(typeof I!=="undefined"){var L=this.data.textures[I];this.options.map=L.texture;this.options.diffuseMapLinear=false;if(L.lods){this.options.map.setAsLOD(K.switchLODTextureCB?K.switchLODTextureCB:H);for(var J=0;J<L.lods.length;J++){this.options.map.lods.push(new C.LODTextureData(L.lods[J].textureData,null,L.lods[J].loadCB))}}var G=this.data.textures[I].mapping;if(G){if(G.uvTransform){this.options.diffuseUvTransform=c(G.uvTransform)}else{this.options.diffuseUvTransform=new C.Matrix3()}if(G.operator){this.options.mappingUseFragment=true;this.options.mappingType=z[G.operator.type];this.options.mappingObjTransformation=new C.Matrix4();if(G.operator.transform){this.options.mappingObjTransformation.elements=G.operator.transform}}if(G.slot){this.options.uvSlots.diffuseMap=(G.slot==="TEX_COORD_1")?2:1}}}if(typeof M.diffuse.MADCoefficients!=="undefined"){this.options.diffuseMulCoef=new C.Vector3(M.diffuse.MADCoefficients[0],M.diffuse.MADCoefficients[1],M.diffuse.MADCoefficients[2]);this.options.diffuseAddCoef=new C.Vector3(M.diffuse.MADCoefficients[3],M.diffuse.MADCoefficients[4],M.diffuse.MADCoefficients[5])}}this.buildGenericPhysicalColorOptions(M,"emissive","emissive",true,new C.Color().setRGB(0,0,0),false);this.buildGenericPhysicalColorOptions(M,"specular","specular",true,new C.Color().setRGB(0.04,0.04,0.04),false);this.buildGenericPhysicalColorOptions(M,"coatingSpecular","coatingSpecular",false,null,false);this.buildGenericPhysicalColorOptions(M,"flakesColor","flakesColor",false,new C.Color().setRGB(0,0,0),false,false);this.buildGenericPhysicalColorOptions(M,"pearlFlakesColor","pearlFlakesColor",false,new C.Color().setRGB(0,0,0),false,false);this.buildGenericPhysicalFloatOptions(M,"opacity","opacity",true,1,true);this.buildGenericPhysicalFloatOptions(M,"glossiness","glossiness",true,0,true);this.buildGenericPhysicalFloatOptions(M,"anisotropy","anisotropy",true,0,true);this.buildGenericPhysicalFloatOptions(M,"anisotropyAngle","anisotropyAngle",true,0,true);this.buildGenericPhysicalFloatOptions(M,"bumpScale","bumpScale",false,1,true);this.buildGenericPhysicalFloatOptions(M,"metalness","metalness",true,null,true);this.buildGenericPhysicalFloatOptions(M,"fresnelTransparency","transparency",false,0,true);this.buildGenericPhysicalFloatOptions(M,"coating","coating",true,false,true);if(typeof M.coatingNormalMap!=="undefined"){this.options.clearCoatNormalMap=this.data.textures[M.coatingNormalMap].texture}this.buildGenericPhysicalFloatOptions(M,"coatingGlossiness","coatingGlossiness",true,1,true);this.buildGenericPhysicalFloatOptions(M,"proceduralCoating","orangePeel",false,false,true);this.buildGenericPhysicalFloatOptions(M,"coatingNormalBump","orangePeelScale",false,0,true);this.buildGenericPhysicalFloatOptions(M,"coatingNormalScale","clearCoatNormalScale",false,0,true);this.buildGenericPhysicalFloatOptions(M,"flakes","flakes",false,false,true);this.buildGenericPhysicalFloatOptions(M,"flakesScale","flakesScale",false,0.5,true);this.buildGenericPhysicalFloatOptions(M,"flakesBump","flakesBump",false,1,true);this.buildGenericPhysicalFloatOptions(M,"flakesRoughness","flakesRoughness",false,0.25,true);this.buildGenericPhysicalFloatOptions(M,"flakesDensity","flakesDensity",false,1,true);this.buildGenericPhysicalFloatOptions(M,"pearlFlakesBump","pearlFlakesBump",false,1,true);this.buildGenericPhysicalFloatOptions(M,"pearlFlakesDensity","pearlFlakesDensity",false,1,true);this.buildGenericPhysicalFloat2Options(M,"normalScale","normalScale",false,null,true);this.buildGenericPhysicalFloatOptions(M,"diffuseAlpha","alphaToCoverage",false,null,true);this._endread(M,K,H);this.isGAS=false};var o=function(G){u.call(this,G)};o.prototype=Object.create(u.prototype);o.prototype.buildGenericPhysicalNormalOptions=function(K,G,M,J){if(typeof K[G]!=="undefined"){var N=K[G];if(typeof N.texture!=="undefined"){var L=N.texture;this.options[M+"Map"]=this.data.textures[L].texture;if(J&&this.data.textures[L].mapping){var I=this.data.textures[L].mapping;if(I.uvTransform){this.options[M+"UvTransform"]=c(I.uvTransform)}if(I.operator){var H=I.operator;this.options.mappingUseFragment=true;this.options.mappingType=z[H.type];this.options.mappingObjTransformation=new C.Matrix4();if(H.transform){this.options.mappingObjTransformation.elements=H.transform}}if(I.slot){this.options.uvSlots[M+"Map"]=(I.slot==="TEX_COORD_1")?2:1}}}if(typeof K[G+"MapFlipY"]!=="undefined"){this.options[G+"MapFlipY"]=K[G+"MapFlipY"]}}};o.prototype.read=function(L,J,H){this._startread(L,J,H);if(typeof L.albedo!=="undefined"){if(L.albedo.value!==undefined){this.options.color=new C.Color().setRGB(L.albedo.value[0],L.albedo.value[1],L.albedo.value[2])}var I=L.albedo.texture;if(typeof I!=="undefined"){var K=this.data.textures[I];this.options.map=K.texture;this.options.diffuseMapLinear=false;var G=this.data.textures[I].mapping;if(G){if(G.uvTransform){this.options.diffuseUvTransform=c(G.uvTransform)}else{this.options.diffuseUvTransform=new C.Matrix3()}if(G.operator){this.options.mappingUseFragment=true;this.options.mappingType=z[G.operator.type];this.options.mappingObjTransformation=new C.Matrix4();if(G.operator.transform){this.options.mappingObjTransformation.elements=G.operator.transform}}if(G.slot){this.options.uvSlots.diffuseMap=(G.slot==="TEX_COORD_1")?2:1}}}if(typeof L.albedo.MADCoefficients!=="undefined"){this.options.diffuseMulCoef=new C.Vector3(L.albedo.MADCoefficients[0],L.albedo.MADCoefficients[1],L.albedo.MADCoefficients[2]);this.options.diffuseAddCoef=new C.Vector3(L.albedo.MADCoefficients[3],L.albedo.MADCoefficients[4],L.albedo.MADCoefficients[5])}}if(J.lightMapAsIrradiance){this.options.lightMapMode=1}this.buildGenericPhysicalFloatOptions(L,"metallic","metalness",true,null,true);this.buildGenericPhysicalFloatOptions(L,"roughness","roughness",true,0,true);this.buildGenericPhysicalFloatOptions(L,"anisotropy","anisotropy",true,0,true);this.buildGenericPhysicalFloatOptions(L,"anisotropyRotation","anisotropyAngle",true,0,true);this.buildGenericPhysicalFloatOptions(L,"transparency","transparency",true,0,true);this.buildGenericPhysicalFloatOptions(L,"cutoutOpacity","opacity",true,1,true);this.buildGenericPhysicalFloatOptions(L,"sheen","sheen",true,0,true);if(typeof L.sheenMode!=="undefined"){this.options.sheenMode=L.sheenMode}this.buildGenericPhysicalFloatOptions(L,"specular","specularContrib",true,1,true);this.buildGenericPhysicalColorOptions(L,"specularTint","specular",true,new C.Color().setRGB(1,1,1),false);this.buildGenericPhysicalFloatOptions(L,"clearcoat","clearCoat",true,0,true);this.buildGenericPhysicalFloatOptions(L,"clearcoatRoughness","clearCoatRoughness",true,0,true);this.buildGenericPhysicalNormalOptions(L,"clearcoatNormal","clearCoatNormal",true);if(typeof L.orangePeel!=="undefined"){this.options.orangePeel=L.orangePeel}this.buildGenericPhysicalFloatOptions(L,"orangePeelScale","orangePeelScale",false,0,false);this.buildGenericPhysicalColorOptions(L,"emissionColor","emissionColor",true,new C.Color().setRGB(1,1,1),false);this.buildGenericPhysicalFloatOptions(L,"emissionValue","emissionValue",false,0,false);this.options.emissionNormalized=false;if(typeof L.emissionEnergyNormalization!=="undefined"){this.options.emissionNormalized=L.emissionEnergyNormalization}this.options.thinWalled=true;if(typeof L.thinWalled!=="undefined"){this.options.thinWalled=L.thinWalled}this.buildGenericPhysicalFloatOptions(L,"ior","ior",false,1.5,false);this.buildGenericPhysicalColorOptions(L,"attenuationColor","attenuationColor",false,new C.Color().setRGB(1,1,1),false);this.buildGenericPhysicalColorOptions(L,"subsurfaceColor","subsurfaceColor",false,new C.Color().setRGB(0,0,0),false);this.buildGenericPhysicalFloatOptions(L,"attenuationDistance","attenuationDistance",false,1000000000000,false);this.buildGenericPhysicalFloatOptions(L,"translucencyScale","translucencyScale",false,1,false);this.buildGenericPhysicalFloatOptions(L,"subsurfacePreset","subsurfacePreset",false,null,false);this.buildGenericPhysicalColorOptions(L,"flakeColor","flakesColor",false,new C.Color().setRGB(1,1,1),false);this.buildGenericPhysicalFloatOptions(L,"flakeSize","flakesSize",true,0.5,true);this.buildGenericPhysicalFloatOptions(L,"flakeCoverage","flakesCoverage",true,0,true);this.buildGenericPhysicalFloatOptions(L,"flakeRoughness","flakesRoughness",true,0,true);this._endread(L,J,H)};var f=function(K){var I=performance.now();var H=(K!==undefined)?K:null;this.mode=undefined;this.sharedBuffers=false;this.noMeshInRAM=false;this.baseUrl="";this.modelsToLoad={};this.loadIndex=0;this.nbModelsToLoad=0;this.extensionsRequired=new Set();this.extensionsUsed=new Set();this.globalOldFlipTexture=false;this.SSBMinNbReps=1;this.SSBMinNbTriangles=1000;var L=this;var J=new C.MeshPhongMaterial({side:C.DoubleSide,color:new C.Color(16777215)});var G=new C.MeshBasicMaterial({color:new C.Color(16777215)});this.getURI=function(P,R){var Q="";if(P.substring(0,7)==="http://"){Q=P}else{if(P.substring(0,8)==="https://"){Q=P}else{if(P.substring(0,1)==="/"){Q=P}else{var O=R;if((R.substring(0,5)==="blob:")||(R==="/")){O=location.href;var N=O.indexOf("?");if(N!==-1){O=O.substring(0,N)}var M=O.lastIndexOf("/");if(M!==-1){O=O.substring(0,M+1)}}Q=O+P}}}return Q};this.getEntryFile=function(O,N,M){var P=((N==="blob")||(N==="arraybuffer"))?new A.BlobWriter():new A.TextWriter();O.getData(P,function(R){if(N==="arraybuffer"){var Q=new FileReader();Q.onload=function(){M(this.result)};Q.readAsArrayBuffer(R)}else{M(R.target.result)}},null)};this.createAmbience=function(ac,Q){var U=ac.ambiance;var O=null;if(!U){return}if(Q.destinationNode){var X=Q.destinationNode;for(var aa=0;aa<X._occurrences.length;aa++){var ad=X._occurrences[aa];var ab=ad.parent;if(!ad.scene3js){continue}var O=ad.scene3js.viewer}}var P=null;var M=null;if(U.background&&(U.background.type=="gradient")){var Y=U.background.colors[0];U.background.colors[0]=U.background.colors[1];U.background.colors[1]=Y}if(U.background&&(U.background.image!==undefined)){var W=Q.data.images[U.background.image];if(W.data){var V=window.URL.createObjectURL(W.data);P={data:V,format:W.format}}}var S=false;if(U.environmentLight&&(U.environmentLight.light!==undefined)){var Z;if(U.environmentLight.matrix){Z=U.environmentLight.matrix}var T=Q.json.lights[U.environmentLight.light];var R=T.image;var W=Q.data.images[R];if(W.data){var V=window.URL.createObjectURL(W.data);M={data:V,format:W.format}}U.environmentLight=T;if(Z){U.environmentLight.matrix=Z}S=true}if(U.directionalLights){for(var aa=0;aa<U.directionalLights.length;aa++){if(!ac.lightInstances||!ac.lightInstances.length){ac.lightInstances=[]}U.directionalLights[aa].castShadows=U.directionalLights[aa].castShadows&&!S;U.directionalLights[aa].ambianceTransform=U.transform;ac.lightInstances.push(U.directionalLights[aa])}}if(O){O.setAmbientLight(0);O.setIntensityCorrection(true);if(O.useDefaultLights){O.setTriLights(false);O.directionalLight.intensity=0;O.directionalLight2.intensity=0}if(O.renderer.ToneMappingEffect){O.renderer.ToneMappingEffect.setToneMapping(9)}var N=new b({viewer:O,ambiance:U,images:{background:P,environmentLight:M,from3DX:true}});O.setAmbience(N)}};this.createImages=function(U,S){if(!U){return}for(var R=0;R<U.length;R++){var N=U[R];var V=N.format.toLowerCase();if(V==="png"||V==="jpeg"||V==="jpg"||V==="dds"||V==="hdr"){var T="image/"+V;if((V==="dds")||(V==="hdr")){T="arraybuffer"}var O=S.data.chunks[N.binary];if(O){var Q=O.buffer?O.buffer:O;var P=O.byteOffset?O.byteOffset:0;var W=new Uint8Array(Q,P+N.byteOffset,N.byteLength);var M=new Blob([W],{type:T});S.data.images.push({data:M,format:V})}else{S.data.images.push({uri:S.json.binaries[N.binary].uri,width:N.width,height:N.height,format:V})}}}};this.createBuffers=function(ac,M){if(!ac){return}for(var Y=0;Y<ac.length;Y++){var U=ac[Y];var Q=M.data.chunks[U.binary];var Z=Q.buffer?Q.buffer:Q;var N=Q.buffer?Q.byteOffset+U.byteOffset:U.byteOffset;if(U.format){var ad;if(U.format==="UNSIGNED_SHORT"){ad=new Uint16Array(Z,N,U.byteLength/2)}else{if(U.format==="UNSIGNED_INT"){ad=new Uint32Array(Z,N,U.byteLength/4)}else{if(U.format==="UNSIGNED_BYTE"){var R=new Uint8Array(Z,N,U.byteLength);ad=new Uint16Array(U.byteLength);for(var X=0;X<U.byteLength;X++){ad[X]=R[X]}}}}M.data.buffers.push(ad)}else{if(U.attributes){var T=m[U.attributes];if(T){var ad=new Float32Array(Z,N,U.byteLength/4);M.data.buffers.push({attribute:T,buffer:ad})}else{var R=new Float32Array(Z,N,U.byteLength/4);var af=[];M.data.buffers.push(af);var O=0;for(var X in m){if(U.attributes&X){O+=g[X]}}var ae=R.length/O;for(var X in m){if(U.attributes&X){var W=g[X];var ad=new Float32Array(ae*W);var P={attribute:m[X],buffer:ad};var S=q[X];for(var V=0;V<ae;V++){for(var aa=0;aa<W;aa++){ad[V++]=R[S+aa]}S+=O}af.push(P)}}}}else{if(U.geometricType){var ad=new Uint32Array(Z,N,U.byteLength/4);M.data.buffers.push({geometricType:U.geometricType,buffer:ad})}else{var ad=new Uint8Array(Z,N,U.byteLength);M.data.buffers.push({buffer:ad})}}}}};this.getBuffers=function(ac,N,P,O,M){if(!ac){return}var X=ac[P];var T=N.data.chunks[X.binary];var aa=T.buffer?T.buffer:T;var Q=T.buffer?T.byteOffset+X.byteOffset:X.byteOffset;if(X.format){var ad;if(X.format==="UNSIGNED_SHORT"){ad=new Uint16Array(aa,Q,X.byteLength/2)}else{if(X.format==="UNSIGNED_INT"){ad=new Uint32Array(aa,Q,X.byteLength/4)}else{if(X.format==="UNSIGNED_BYTE"){var U=new Uint8Array(aa,Q,X.byteLength);ad=new Uint16Array(X.byteLength);for(var Z=0;Z<X.byteLength;Z++){ad[Z]=U[Z]}}}}return ad}else{if(O){if(O.length==1){var R=O[0];var ad;if(R.format==="UNSIGNED_SHORT"){ad=new Uint16Array(aa,Q,X.byteLength/2)}else{if(R.format==="UNSIGNED_INT"){ad=new Uint32Array(aa,Q,X.byteLength/4)}else{if(R.format==="UNSIGNED_BYTE"){var U=new Uint8Array(aa,Q,X.byteLength);ad=new Uint16Array(X.byteLength);for(var Z=0;Z<X.byteLength;Z++){ad[Z]=U[Z]}}else{ad=new Float32Array(aa,Q,X.byteLength/4)}}}return ad}else{var ad=new Float32Array(aa,Q,X.byteLength/4);var af=[];var S=0;for(var Z in O){S+=O[Z].dimension}var ae=ad.length/S;for(var Z in O){var R=O[Z];af[Z]=new Float32Array(ae*R.dimension)}var V=0;for(var Z in O){var P=0;var R=O[Z];for(var Y=0;Y<ae;Y++){for(var W=0;W<R.dimension;W++){af[Z][P++]=ad[Y*S+V+W]}}V+=R.dimension}return af}}else{if(M){var ad=new Uint32Array(aa,Q,X.byteLength/4);return{geometricType:M,buffer:ad}}else{var ad=new Uint8Array(aa,Q,X.byteLength);return ad}}}};this.getGenericBuffer=function(U,Q,R,S){if(!U){return}var P=U[R];var M=Q.data.chunks[P.binary];var N=M.buffer?M.buffer:M;var O=M.buffer?M.byteOffset+P.byteOffset:P.byteOffset;var T;switch(S){case"Float32":T=new Float32Array(N,O,P.byteLength/4);break;case"Uint32":T=new Uint32Array(N,O,P.byteLength/4);break;default:T=new Uint8Array(N,O,P.byteLength);break}return T};this.onImageLoaded=function(M){M.data.nbImagesToLoad--;if(!M.data.nbImagesToLoad&&M.onTexturesLoadedCB){M.onTexturesLoadedCB()}};this.createTextures=function(N,O){if(!N){return}var W=this;var M={};for(var Z=0;Z<N.length;Z++){var Q=N[Z];if(!M[Q.image]){M[Q.image]=[];if(!O.imagesCallback&&O.data.images[Q.image]){O.data.nbImagesToLoad++}}M[Q.image].push({texture:Z,lod:-1});if(!Q.lods){continue}for(var Y=0;Y<Q.lods.length;Y++){var R=Q.lods[Y];if(!M[R]){M[R]=[]}M[R].push({texture:Z,lod:Y})}}for(var ab in M){var ad=null;var S,ac;if(O.imagesCallback){ad=O.imagesCallback(Q,O)}else{var P=O.data.images[ab];var V=(M[ab][0].lod>=0);var U;if(!V){if(P.data){U=window.URL.createObjectURL(P.data)}else{U=P.uri}if(P.format==="dds"){ad=C.ImageUtils.loadCompressedTexture(U,null,(function(ae){return function(){W.onImageLoaded(ae)}})(O),(function(ae){return function(){W.onImageLoaded(ae)}})(O),true)}else{if(P.format==="hdr"){ad=C.ImageUtils.loadHDRTexture(U,null,(function(ae){return function(){W.onImageLoaded(ae)}})(O),(function(ae){return function(){W.onImageLoaded(ae)}})(O),true,false,true)}else{ad=C.ImageUtils.loadTexture(U,null,(function(ae){return function(){W.onImageLoaded(ae)}})(O),(function(ae){return function(){W.onImageLoaded(ae)}})(O),undefined,true);ad.flipY=true}}}else{ad=P.uri;S=P.width;ac=P.height}}var T=M[ab];for(var Y=0;Y<T.length;Y++){var Q=N[T[Y].texture];if(T[Y].lod===-1){ad.wrapS=l[Q.uWrap]||1000;ad.wrapT=l[Q.vWrap]||1000;ad.anisotropy=Q.anisotropy||8;ad.minFilter=a[Q.minFilter]||1008;ad.magFilter=a[Q.magFilter]||1006;if(ad.magFilter!=1003&&ad.magFilter!=1006){ad.magFilter=1006}ad.repeat=Q.repeat||{x:1,y:1};var aa=O.json.images[Q.image].format;ad.sRGB=(Q.format==="jpg")||(Q.format==="jpeg");if(!ad.sRGB&&(aa==="jpg"||aa==="jpeg")){ad.sRGB=true}var X={texture:ad,mapping:Q.mapping};O.data.textures[T[Y].texture]=X}else{var X=O.data.textures[T[Y].texture];if(!X.lods){X.lods=[]}X.lods.push({textureData:{texture:ad,width:S,height:ac},loadCB:this.loadLODTextureCB})}}}};this.loadLODTextureCB=function(M){var N=n.parseUrl(this.imageData.texture);N=(N.protocol==="")?(L.baseUrl+N.source):N.source;var O=C.ImageUtils.loadTexture(N,undefined,undefined,undefined,undefined,true);O.flipY=true;if(M){O.wrapS=M.wrapS;O.wrapT=M.wrapT;O.anisotropy=M.anisotropy;O.minFilter=M.minFilter;O.magFilter=M.magFilter;O.repeat=M.repeat;O.sRGB=M.sRGB}return O};this.switchLODTextureCB=function(P){var W=P.matrix,U=P.bSphere,S=U.radius*W.getMaxScaleOnAxis(),N=new C.Vector3();if(U){N.copy(U.center)}else{N.set(0,0,0)}N.applyMatrix4(W);var T=P.camera.matrixWorldInverse.elements;var V=Math.abs(T[2]*N.x+T[6]*N.y+T[10]*N.z+T[14])-S;var Q=C.glStates.currentHeight/Math.tan(0.5*P.camera.fov*Math.PI/180);var M=Q*S/Math.abs(V);if(M<Math.min(P.texture.image.width,P.texture.image.height)){return -1}var O,R;for(O=0;O<P.lods.length;O++){R=P.lods[O];if(M<Math.min(R.imageData.width,R.imageData.height)){break}}return(O===P.lods.length)?O-1:O};this.createMaterialsV2=function(W,P,R){if(!W){return}var S=new d();for(var Q=0;Q<W.length;Q++){var O=W[Q];var T=null;if(R.materialsCallback){T=R.materialsCallback(O,R)}else{if(O.type==="External"){var N={uri:O.uri,destinationNodes:[],destinationDGforGAS:[],destinationDGforMaterial:[]};R.data.modelsToLoad.push(N);P.materials[Q]=N;continue}else{var X={visible:O.visible,force:O.force,side:O.side,transparent:O.transparent,opacity:O.opacity,depthTest:O.depthTest,depthWrite:O.depthWrite};var M=true;var V="VIS"+X.visible+"S"+X.side+"T"+X.transparent;V+="O"+X.opacity;V+="DT"+X.depthTest+"DW"+X.depthWrite;if(O.forceSide){X.forceSide=O.forceSide;T+="FS"+X.forceSide}if(O.NRECompatibility!==undefined){X.NRECompatibility=O.NRECompatibility}if(O.needTangentBinormal){X.needTangentBinormal=O.needTangentBinormal}if(O.alphaTest){X.alphaTest=O.alphaTest}if(O.color){X.color=new C.Color().setRGB(O.color[0],O.color[1],O.color[2]);V+="C"+X.color.getStyle()}if(O.ambient){X.ambient=new C.Color().setRGB(O.ambient[0],O.ambient[1],O.ambient[2]);V+="A"+X.ambient.getStyle()}if(O.emissive){X.emissive=new C.Color().setRGB(O.emissive[0],O.emissive[1],O.emissive[2]);V+="E"+X.emissive.getStyle()}if(O.specular){X.specular=new C.Color().setRGB(O.specular[0],O.specular[1],O.specular[2]);V+="SP"+X.specular.getStyle()}if(O.shininess){X.shininess=O.shininess;V+="SH"+X.shininess}if(O.vertexColors){X.vertexColors=O.vertexColors}if(O.diffuseMap!==undefined){M=false;X.map=P.textures[O.diffuseMap].texture}if(O.opacityMap!==undefined){M=false;X.opacityMap=P.textures[O.opacityMap].texture;X.transparent=true}if(O.normalMap!==undefined){M=false;X.normalMap=P.textures[O.normalMap].texture;X.needTangentBinormal=true;if(O.needTangentBinormal!==undefined){X.needTangentBinormal=O.needTangentBinormal}}if(O.normalMapScale!==undefined){X.normalScale=new C.Vector2(O.normalMapScale.x,O.normalMapScale.y)}if(O.normalMapFlipY!==undefined){X.normalMapFlipY=O.normalMapFlipY}if(O.bumpMap!==undefined){M=false;X.bumpMap=P.textures[O.bumpMap].texture}if(O.bumpMapScale!==undefined){X.bumpScale=O.bumpMapScale}if(O.glossiness!==undefined){X.glossiness=O.glossiness;V+="G"+X.glossiness}if(O.glossinessMap!==undefined){M=false;X.glossinessMap=P.textures[O.glossinessMap].texture}if(O.specularMap!==undefined){M=false;X.specularMap=P.textures[O.specularMap].texture;X.specularMapLinear=!X.specularMap.sRGB}if(O.lightMap!==undefined){M=false;X.lightMap=P.textures[O.lightMap].texture}if(O.type==="Physical"){M=false;if(O.emissiveMap!==undefined){X.emissiveMap=P.textures[O.emissiveMap].texture}if(O.metalnessMap!==undefined){if(O.metalness===undefined){O.metalness=1}X.metalnessMap=P.textures[O.metalnessMap].texture}if(O.metalness!==undefined){X.metalness=O.metalness}if(O.coating!==undefined){X.coating=O.coating}if(O.coatingGlossiness!==undefined){X.coatingGlossiness=O.coatingGlossiness}}if(O.iterative!==undefined){X.iterative=O.iterative}if(O.sslr!==undefined){X.sslr=O.sslr}var U=F[O.type];V="id"+V.hashCode();if(M&&R.gasSharing){T=S.get3DXMaterial(V)}if(!T&&U){T=new C[U](X);if(M&&R.gasSharing){S.set3DXMaterial(V,T)}}}}P.materials[Q]=T}};this.createMaterials=function(Y,P,S){if(!Y){return}var T=new d();var O=this.extensionsRequired.has("EXT_Material_PBR")||this.extensionsUsed.has("EXT_Material_PBR");for(var Q=0;Q<Y.length;Q++){var N=Y[Q];var U=null;var V=false;if(N.extensions&&N.extensions.EXT_Material_PBR){N=N.extensions.EXT_Material_PBR;V=O}if(S.materialsCallback){U=S.materialsCallback(N,S)}else{if(N.type==="External"){var M={uri:N.uri,destinationNodes:[],destinationDGforGAS:[],destinationDGforMaterial:[]};S.data.modelsToLoad.push(M);P.materials[Q]=M;continue}else{var R=null;var W=F[N.type];if(V){W=F.Physical;R=new o(P)}else{if(N.type!=="Physical"){R=new i(P)}else{if(N.type==="Physical"){R=new u(P)}}}R.read(N,S,this.switchLODTextureCB);var X="id"+R.id.hashCode();if(R.isGAS&&S.gasSharing){U=T.get3DXMaterial(X)}if(!U&&W){U=new C[W](R.options);if(R.isGAS&&S.gasSharing){T.set3DXMaterial(X,U)}}}}P.materials[Q]=U}};this.createGeometriesV2=function(T,R){if(!T){return}var ai=R.data;for(var ab=0;ab<T.length;ab++){var ag=T[ab];var Y=new C.BufferGeometryDS();Y.compressedNormals=ag.compressedNormals||(typeof ag.normalCompression!=="undefined"&&ag.normalCompression==="OCT_24");Y.compressedVertices=ag.compressedVertices||(typeof ag.positionCompression!=="undefined"&&ag.positionCompression==="BBOX_QUANTIZATION_16_16_16");ai.geometries[ab]=Y;Y.sharedBuffers=this.sharedBuffers;Y.noMeshInRAM=this.noMeshInRAM;Y.vertexIndexArray=ai.buffers[ag.indexBuffer];for(var aa=0;aa<ag.vertexBuffers.length;aa++){var P=ai.buffers[ag.vertexBuffers[aa]];if(P.attribute){Y[P.attribute]=P.buffer}else{if(P.length){for(var Z=0;Z<P.length;Z++){Y[P[Z].attribute]=P[Z].buffer}}}}for(var aa=0;aa<ag.drawingGroups.length;aa++){var ae=ag.drawingGroups[aa];var ah=(ae.primitives!==undefined);var ak=(ae.canonicals!==undefined);var X=Y.vertexNormalArray?J:G;var ac=[];var S=new k.DrawingGroup(X,null,B[ae.mode],ae.start,ae.count,ac,undefined,C.GeomTypeEnum.UNKNOWN,0);S.geometry=Y;Y.drawingGroups.push(S);if((ae.graphicAttributes!==undefined)&&ai.materials[ae.graphicAttributes]){var aj=ai.materials[ae.graphicAttributes];if(aj.uri){aj.destinationDGforGAS.push(S)}else{S.gas=aj}}if((ae.material!==undefined)&&ai.materials[ae.material]){var aj=ai.materials[ae.material];if(aj.uri){aj.destinationDGforMaterial.push(S)}else{S.material=aj}}if(ah){var ad=ai.buffers[ae.primitives];var Q=ad.buffer;var V=0;var O=ak?ai.buffers[ae.canonicals].buffer:null;S._geomType=C.GeomTypeEnum[ad.geometricType];for(var Z=0;Z<Q.length;Z+=4){var U=new k.SGPrimitive({cgmId:Q[Z],group:S,start:Q[Z+2],count:Q[Z+3]});if(R.unstreamReps){var N=Q[Z+1];var M=ai.reps[N];if(!M){M=new k.SGRep({cgmId:N});ai.reps[N]=M}U.rep=M;M.primitives.push(U)}if(ak){var W=O[V++];if(W){U.decoration=new Array();for(var af=0;af<W;af++){U.decoration.push(O[V++])}}}ac.push(U)}}else{var U=new k.SGPrimitive({cgmId:0,group:S,start:ae.start,count:ae.count});ac.push(U)}}}};this.getInternalDimensionBuffer=function(M,T,R){var Q=T;if(R=="POSITION"){Q=T}else{if(R=="NORMAL"){Q=T}else{if(R=="TEX_COORD_0"){Q=3}else{if(R=="TEX_COORD_1"){Q=3}else{if(R=="COLOR"){Q=4}else{if(R=="TANGENT"){Q=3}else{if(R=="BINORMAL"){Q=3}}}}}}}if(Q==T){return M}else{if(T>0){var P=M.length/T;var S=new Float32Array(P*Q);if(T<Q){for(var O=0;O<P;O++){for(var N=0;N<T;N++){S[O*Q+N]=M[O*T+N]}for(var N=T;N<Q;N++){S[O*Q+N]=0}}}else{for(var O=0;O<P;O++){for(var N=0;N<Q;N++){S[O*Q+N]=M[O*T+N]}}}return S}else{console.log("wrong definition of buffer dimension");return M}}};this.createGeometries=function(ad,aq,at,P){if(!ad){return}var a1=P.data;for(var aY=0;aY<ad.length;aY++){var aT=ad[aY];var ak={};var X=0;var ay=aT.reps&&!(aT.reps instanceof Object);var al,ac;if(ay){var am=this.getGenericBuffer(aq,P,aT.reps,"Uint8");al=new Uint32Array(am.buffer,am.byteOffset);var a3=4*am.byteLength/9;ac=new Float32Array(am.buffer,am.byteOffset+a3)}var aw=at[aT.vertexLayout];var ab=new C.BufferGeometryDS();ab.compressedNormals=aT.compressedNormals||(typeof aT.normalCompression!=="undefined"&&aT.normalCompression==="OCT_24");ab.compressedVertices=aT.compressedVertices||(typeof aT.positionCompression!=="undefined"&&aT.positionCompression==="BBOX_QUANTIZATION_16_16_16");a1.geometries[aY]=ab;ab.sharedBuffers=this.sharedBuffers;ab.noMeshInRAM=this.noMeshInRAM;if(aT.indexBuffer===undefined){if(aT.drawingGroups&&aT.drawingGroups[0].count){ab.vertexIndexArray=new Uint32Array(aT.drawingGroups[0].count);for(var aV=0;aV<aT.drawingGroups[0].count;aV++){ab.vertexIndexArray[aV]=aV}}}else{ab.vertexIndexArray=this.getBuffers(aq,P,aT.indexBuffer)}if(aT.boundingSphere){var N=aT.boundingSphere.center;var aP=aT.boundingSphere.radius;ab.boundingSphere=new C.Sphere(new C.Vector3(N[0],N[1],N[2]),aP)}if(aT.boundingBox){var a2=aT.boundingBox.min;var an=aT.boundingBox.max;if(ab.compressedVertices){ab.quantizedVector=new C.Vector3(an[0]-a2[0],an[1]-a2[1],an[2]-a2[2]);ab.quantizedVector.multiplyScalar(1/65535);ab.offsetVector=new C.Vector3(a2[0],a2[1],a2[2]);ab.offsetVector.x/=ab.quantizedVector.x;ab.offsetVector.y/=ab.quantizedVector.y;ab.offsetVector.z/=ab.quantizedVector.z;ab.offsetVector.x=Math.floor(ab.offsetVector.x);ab.offsetVector.y=Math.floor(ab.offsetVector.y);ab.offsetVector.z=Math.floor(ab.offsetVector.z)}}if(aw[0].length===1){for(var aX=0;aX<aT.vertexBuffers.length;aX++){var a4=aw[aX];var ao=this.getBuffers(aq,P,aT.vertexBuffers[aX],a4);var aZ=a4[0];if(aZ.attribute=="POSITION"){ab.vertexPositionArray=this.getInternalDimensionBuffer(ao,aZ.dimension,aZ.attribute);if(ab.compressedVertices){var aN=ab.vertexPositionArray;var S=aN.length/3;ab.vertexPositionArray=new Float32Array(S*2);for(var aV=0;aV<S;aV++){var aI=aN[3*aV];var aG=aN[3*aV+1];var aM=Math.floor(aG/256);var aS=aG%256;var aE=aN[3*aV+2];ab.vertexPositionArray[2*aV]=aI*256+aM;ab.vertexPositionArray[2*aV+1]=aE*256+aS}}}else{if(aZ.attribute=="NORMAL"){ab.vertexNormalArray=this.getInternalDimensionBuffer(ao,aZ.dimension,aZ.attribute);if(ab.compressedNormals){var au=ab.vertexNormalArray;var aW=au.length/3;ab.vertexNormalArray=new Float32Array(aW);for(var aV=0;aV<aW;aV++){var aI=au[3*aV];var aG=au[3*aV+1];var aE=au[3*aV+2];var aJ=16*aI+Math.floor(aG/16);var aH=(aG%16)*256+aE;ab.vertexNormalArray[aV]=aJ*4096+aH}}}else{if(aZ.attribute=="TEX_COORD_0"){ab.vertexUvArray=this.getInternalDimensionBuffer(ao,aZ.dimension,aZ.attribute)}else{if(aZ.attribute=="TEX_COORD_1"){ab.vertexUv2Array=this.getInternalDimensionBuffer(ao,aZ.dimension,aZ.attribute)}else{if(aZ.attribute=="COLOR"){ab.vertexColorArray=this.getInternalDimensionBuffer(ao,aZ.dimension,aZ.attribute)}else{if(aZ.attribute=="TANGENT"){ab.vertexTangentArray=this.getInternalDimensionBuffer(ao,aZ.dimension,aZ.attribute)}else{if(aZ.attribute=="BINORMAL"){ab.vertexBinormalArray=this.getInternalDimensionBuffer(ao,aZ.dimension,aZ.attribute)}else{ab[aZ.attribute]=ao}}}}}}}}}else{var a4=aw[0];var U=this.getBuffers(aq,P,aT.vertexBuffers[0],a4);for(var aX=0;aX<a4.length;aX++){var aZ=a4[aX];if(aZ.attribute=="POSITION"){ab.vertexPositionArray=this.getInternalDimensionBuffer(U[aX],aZ.dimension,aZ.attribute)}else{if(aZ.attribute=="NORMAL"){ab.vertexNormalArray=this.getInternalDimensionBuffer(U[aX],aZ.dimension,aZ.attribute)}else{if(aZ.attribute=="TEX_COORD_0"){ab.vertexUvArray=this.getInternalDimensionBuffer(U[aX],aZ.dimension,aZ.attribute)}else{if(aZ.attribute=="TEX_COORD_1"){ab.vertexUv2Array=this.getInternalDimensionBuffer(U[aX],aZ.dimension,aZ.attribute)}else{if(aZ.attribute=="COLOR"){ab.vertexColorArray=this.getInternalDimensionBuffer(U[aX],aZ.dimension,aZ.attribute)}else{if(aZ.attribute=="TANGENT"){ab.vertexTangentArray=this.getInternalDimensionBuffer(U[aX],aZ.dimension,aZ.attribute)}else{if(aZ.attribute=="BINORMAL"){ab.vertexBinormalArray=this.getInternalDimensionBuffer(U[aX],aZ.dimension,aZ.attribute)}else{ab[aZ.attribute]=U[aX]}}}}}}}}}for(var aX=0;aX<aT.drawingGroups.length;aX++){var ae=aT.drawingGroups[aX];var aa=(ae.repRanges!==undefined);var aL=(ae.primitives!==undefined);var Q=(ae.canonicals!==undefined);var ap=(ae.cullingData!==undefined);var Z=ab.vertexNormalArray?J:G;var O=[];var aA=new k.DrawingGroup(Z,null,B[ae.mode],ae.start,ae.count,O,undefined,C.GeomTypeEnum.UNKNOWN,0);aA.geometry=ab;aA._geomType=C.GeomTypeEnum[ae.geometricType];ab.drawingGroups.push(aA);if((ae.graphicAttributes!==undefined)&&a1.materials[ae.graphicAttributes]){var aF=a1.materials[ae.graphicAttributes];if(aF.uri){aF.destinationDGforGAS.push(aA)}else{aA.gas=aF}}if((ae.material!==undefined)&&a1.materials[ae.material]){var aF=a1.materials[ae.material];if(aF.uri){aF.destinationDGforMaterial.push(aA)}else{aA.material=aF}}if(ap){aA.cullingData=[];var W=this.getGenericBuffer(aq,P,ae.cullingData.start,"Uint32");var aC=this.getGenericBuffer(aq,P,ae.cullingData.radius,"Float32");for(var aV=0;aV<W.length;aV++){aA.cullingData.push({start:W[aV],radius:aC[aV]})}}if(aa&&!aL){var ag=this.getGenericBuffer(aq,P,ae.repRanges,"Uint32");var aD=ae.start;for(var aV=0;aV<ag.length;aV+=2){var T=new k.SGPrimitive({cgmId:0,group:aA,start:aD,count:ag[aV+1]});aD+=T.count;if(P.unstreamReps&&aT.reps){var aj=ag[aV];var M=al[4*aj];var aB=a1.reps[M];if(!aB){aB={rep:new k.SGRep({cgmId:al[4*aj+1],solid:al[4*aj+2],sag:ac[5*aj+4]}),bsphere:[ac[5*aj],ac[5*aj+1],ac[5*aj+2],ac[5*aj+3]],nbTriangles:al[4*aj+3]};ak[aj]=aB;a1.reps[M]=aB;X++}T.rep=aB.rep;aB.rep.primitives.push(T)}O.push(T)}}else{if(aL&&P.unstreamPrimitives){var Y=this.getBuffers(aq,P,ae.primitives,undefined,ae.geometricType);var az=Y.buffer;var ar=0;var ai=Q?this.getBuffers(aq,P,ae.canonicals).buffer:null;for(var aV=0;aV<az.length;aV+=4){var ah=new k.SGPrimitive({cgmId:az[aV],group:aA,start:az[aV+2],count:az[aV+3]});if(P.unstreamReps&&aT.reps){var aj=az[aV+1];var M=ay?al[4*aj]:0;var aB=ay?a1.reps[M]:ak[aj];if(!aB){if(ay){aB={rep:new k.SGRep({cgmId:al[4*aj+1],solid:al[4*aj+2],sag:ac[5*aj+4]}),bsphere:[ac[5*aj],ac[5*aj+1],ac[5*aj+2],ac[5*aj+3]],nbTriangles:al[4*aj+3]};a1.reps[M]=aB}else{var aO=aT.reps[aj];aB={rep:new k.SGRep({cgmId:aO.cgmId,solid:aO.solid,sag:aO.sag}),bbox:aO.bbox,nbTriangles:aO.nbTriangles}}ak[aj]=aB;X++}ah.rep=aB.rep;aB.rep.primitives.push(ah)}if(Q){var af=ai[ar++];if(af){ah.decoration=new Array();for(var a0=0;a0<af;a0++){ah.decoration.push(ai[ar++])}}}O.push(ah)}}else{var ah=new k.SGPrimitive({cgmId:0,group:aA,start:ae.start,count:ae.count});O.push(ah)}}}if(P.unstreamSSB&&(X>this.SSBMinNbReps)){var R=performance.now();var aR=[];var aK=0;var aU=null;var ax=new C.Sphere();var V=new C.Sphere();for(var av in ak){var aQ=ak[av].bsphere;V.center.set(aQ[0],aQ[1],aQ[2]);V.radius=aQ[3];if(!aU){aU=V.clone()}else{ax.copy(aU);ax.mergeWithSphere(V,aU)}ak[av].rep.boundingSphere={center:[V.center.x,V.center.y,V.center.z],radius:V.radius};aK+=ak[av].nbTriangles;aR.push(ak[av])}if(aK>this.SSBMinNbTriangles){ab.bvhCells=[];R=performance.now();w.indexMap=new Uint32Array(ab.vertexIndexArray.length);if(!w.positions||w.positions.length<ab.vertexPositionArray.length){w.positions=new Float32Array(ab.vertexPositionArray.length)}if(!w.normals||w.normals.length<ab.vertexNormalArray.length){w.normals=new Float32Array(ab.vertexNormalArray.length)}console.log("allocate indexMap/positions/normals in "+(performance.now()-R)+" ms.");ab.bvhCells.push(this.batchBVHCell({objects:aR},ab,w,aU))}}}};this.batchBVHCell=function(V,ab,ag,M){var W=performance.now();var aa=new C.BufferGeometryDS();aa.sharedBuffers=this.sharedBuffers;aa.noMeshInRAM=this.noMeshInRAM;if(M){aa.boundingSphere=M;aa.boundingBox=aa.boundingSphere.getBoundingBox()}else{aa.boundingBox=new C.Box3(V.bbox.min,V.bbox.max);aa.boundingSphere=aa.boundingBox.getBoundingSphere()}aa.compressedVertices=ab.compressedVertices;aa.compressedNormals=ab.compressedNormals;aa.quantizedVector=ab.quantizedVector;aa.offsetVector=ab.offsetVector;var aj=ag.indexMap;var R=ag.positions;var X=ag.normals;h+=performance.now()-W;W=performance.now();var Z=0;var Q=0;var ah=[];var af=[];var U=0;for(var ae=0;ae<V.objects.length;ae++){var N=V.objects[ae];for(var ad=0;ad<N.rep.primitives.length;ad++){var Y=N.rep.primitives[ad];U+=Y.count;af.push(Y)}}p+=performance.now()-W;W=performance.now();var O=new Uint32Array(U);af.sort(function(al,ak){if(al.group.glType<ak.group.glType){return -1}if(al.group.glType>ak.group.glType){return 1}if(al.group._geomType<ak.group._geomType){return -1}if(al.group._geomType>ak.group._geomType){return 1}if(al.group.gas.id<ak.group.gas.id){return -1}if(al.group.gas.id>ak.group.gas.id){return 1}if(al.group.material&&!ak.group.material){return -1}if(!al.group.material&&ak.group.material){return 1}if(al.group.material&&ak.group.material){if(al.group.material.id<ak.group.material.id){return -1}if(al.group.material.id>ak.group.material.id){return 1}}if(al.rep.boundingSphere.radius>ak.rep.boundingSphere.radius){return -1}if(al.rep.boundingSphere.radius<ak.rep.boundingSphere.radius){return 1}return 0});E+=performance.now()-W;W=performance.now();var ai;var N;var S;var Y;for(var ad=0;ad<af.length;ad++){Y=af[ad];if(Y.group!==ai){ai=Y.group;S=new k.DrawingGroup(Y.group.gas,Y.group.material,Y.group.glType,Q,0,[],undefined,Y.group._geomType,0);S.geometry=aa;aa.drawingGroups.push(S);N=null;S.cullingData=[]}if(Y.rep!==N){N=Y.rep;S.cullingData.push({start:Q,radius:N.boundingSphere.radius})}var T=Q;for(var ac=0;ac<Y.count;ac++){var P=ab.vertexIndexArray[Y.start+ac];if(aj[P]===0){aj[P]=Z+1;if(ab.compressedVertices){R[2*Z]=ab.vertexPositionArray[2*P];R[2*Z+1]=ab.vertexPositionArray[2*P+1]}else{R[3*Z]=ab.vertexPositionArray[3*P];R[3*Z+1]=ab.vertexPositionArray[3*P+1];R[3*Z+2]=ab.vertexPositionArray[3*P+2]}if(ab.compressedNormals){X[Z]=ab.vertexNormalArray[P]}else{X[3*Z]=ab.vertexNormalArray[3*P];X[3*Z+1]=ab.vertexNormalArray[3*P+1];X[3*Z+2]=ab.vertexNormalArray[3*P+2]}Z++}O[Q]=aj[P]-1;Q++}Y.start=T;Y.group=S;S.count+=Y.count;S.primitives.push(Y)}y+=performance.now()-W;W=performance.now();aa.vertexIndexArray=O;aa.vertexPositionArray=new Float32Array(R.buffer.slice(0,4*(ab.compressedVertices?2:3)*Z));aa.vertexNormalArray=new Float32Array(X.buffer.slice(0,4*(ab.compressedNormals?1:3)*Z));v+=performance.now()-W;return aa};this.createNodes=function(T,P){if(!T){return}if(!P.data.children){P.data.children=[]}var ae=P.data;for(var aa=0;aa<T.length;aa++){var ab=T[aa];var U=null;if(ab.type==="External"){U=new r();P.data.modelsToLoad.push({destinationNode:U,uri:ab.uri})}else{if(ab.type==="Node3D"){U=new r();P.data.children[aa]=ab.children}else{var ac=null;var M=null;if(ab.boundingSphere){var ad=ab.boundingSphere.center;var Q=ab.boundingSphere.radius;ac=new C.Sphere(new C.Vector3(ad[0],ad[1],ad[2]),Q)}if(ab.boundingBox){var V=ab.boundingBox.min;var Z=ab.boundingBox.max;M=new C.Box3(new C.Vector3(V[0],V[1],V[2]),new C.Vector3(Z[0],Z[1],Z[2]))}var R=[];for(var Y=0;Y<ab.geometries.length;Y++){var O=ae.geometries[ab.geometries[Y]];if(O.bvhCells){for(var W=0;W<O.bvhCells.length;W++){R.push(O.bvhCells[W])}}else{R.push(O)}}if(!M){R[0].computeBoundingBox();M=R[0].boundingBox}R.boundingBox=M;if(!ac){R[0].computeBoundingSphere();ac=R[0].boundingSphere}R.boundingSphere=ac;var S=(R.length&&R[0]["vertexNormalArray"])?J:G;var N=new C.Mesh(R,S);N.fromLoadedModel=true;N.castShadow=(ab.castShadow!==undefined)?ab.castShadow:true;N.receiveShadow=(ab.receiveShadow!==undefined)?ab.receiveShadow:true;N.enableNormalDepth=(ab.enableNormalDepth!==undefined)?ab.enableNormalDepth:true;U=new e(N);if(ab.lightmaps){for(var Y=0;Y<ab.lightmaps.length;Y++){R[Y].lightMap=ae.textures[ab.lightmaps[Y]].texture}}}}if(ab.material!==undefined){var af=ae.materials[ab.material];if(af.uri){af.destinationNodes.push(U)}else{U.setMaterial(af)}}ae.nodes[aa]=U;if(ab.matrix){var X=new C.Matrix4().setFromArray(ab.matrix);U.setMatrix(X)}if(ab.name){U.setName(ab.name)}if(P.nodeCallback){P.nodeCallback(ab,P,U)}}};this.createLayers=function(M,T){var Q=T.data;for(var Z in Q.nodes){var N=Q.nodes[Z];var W=M[Z];for(var R in W.occurrences){var V=W.occurrences[R].index;var P=W.occurrences[R];if(!P.layers.length){continue}N._occurrences[V].renderable.layer=new C.BufferLayer();for(var O=0;O<P.layers.length;O++){var S=P.layers[O];var Y=Q.geometries[S.geometry];var X=new C.DrawableInterval(S.drawableInterval.layerNum,S.drawableInterval.start,S.drawableInterval.count,Q.materials[S.drawableInterval.material]);X.primitiveStart=S.drawableInterval.primitiveStart;X.primitiveCount=S.drawableInterval.primitiveCount;var U=new C.LayerInterval(Y,Y.drawingGroups[S.drawableGroup],X);N._occurrences[V].renderable.layer.addLayerInterval(U)}}}};this.applyLights=function(P){var ac=P.json.lightInstances;if(!ac||!ac.length){return}var N=null;var S=P.destinationNodes?P.destinationNodes[0]:P.destinationNode;if(S._occurrences[0].scene3js){N=S._occurrences[0].scene3js.viewer;N.setAmbientLight(0);N.setIntensityCorrection(true);if(N.useDefaultLights){N.setTriLights(false);N.directionalLight.intensity=0;N.directionalLight2.intensity=0}N.renderer.ToneMappingEffect.setToneMapping(9)}var R=1;if(P.rootMatrix){R=P.rootMatrix.elements[0]}S._updateBoundingElements();var ai=P.json.lights;var T=[];for(var aa=0;aa<ai.length;aa++){var U=ai[aa];var Q=U.emissionColor?U.emissionColor:U.color;if(U.energyNormalization){var af=0.2126*Q[0]+0.7152*Q[1]+0.0722*Q[2];Q[0]=Q[0]/af;Q[1]=Q[1]/af;Q[2]=Q[2]/af}var M=new C.Color().setRGB(Q[0],Q[1],Q[2]);var V="rgb("+Q[0]*255+","+Q[1]*255+","+Q[2]*255+")";var X=U.emissionValue?U.emissionValue:U.value;if(U.type=="directional"){X=X/(R*R);X=X;var ah=new C.DirectionalLight(V,X);ah.color=M}else{if(U.type=="point"){if(!U.emissionMode||U.emissionMode=="LUMINOUS_POWER"){X=X/(4*Math.PI)}var ah=new C.PointLight(V,X,0);ah.color=M;ah.isPhysicallyAttenuated=true;ah.attenuationScale=1/1000000}else{if(U.type=="spot"){var Z=U.cutoffAngle*Math.PI/180;var W=U.falloffAngle*Math.PI/180;if(!U.emissionMode||U.emissionMode=="LUMINOUS_POWER"){X=X/(Math.PI*((1-Math.cos(Z))+(1-Math.cos(W))))}var ah=new C.SpotLight(V,X,0,Z,W);ah.color=M;ah.isPhysicallyAttenuated=true;ah.attenuationScale=1/1000000}else{if(U.type=="rectangle"){if(!U.emissionMode||U.emissionMode=="LUMINOUS_POWER"){X=X/(U.width*U.height)}var ah=new C.AreaLight(V,X,U.width,U.height);ah.color=M}else{if(U.type=="disk"){if(!U.emissionMode||U.emissionMode=="LUMINOUS_POWER"){X=X/(U.radius*U.radius*Math.PI)}var ah=new C.DiskLight(V,X,U.radius);ah.color=M}else{if(U.type=="sphere"){if(!U.emissionMode||U.emissionMode=="LUMINOUS_POWER"){X=X/(U.radius*U.radius*4*PI)}var ah=new C.SphereLight(V,X,U.radius);ah.color=M}else{if(U.type=="tube"){if(!U.emissionMode||U.emissionMode=="LUMINOUS_POWER"){X=X/(2*Math.PI*U.width*U.radius+U.radius*U.radius*4*PI)}var ah=new C.SphereLight(V,X,U.radius,U.width);ah.color=M}else{var ah={}}}}}}}}T.push(ah)}for(var aa=0;aa<ac.length;aa++){var ad=ac[aa];if(ai[ad.light].type=="environment"){continue}var O=T[ad.light];if(ad.castShadows&&!(O instanceof C.PointLight)){O.castShadow=true;O.shadowBias=-0.05;O.shadowDarkness=1/ac.length}else{O.castShadow=false}var Y=new C.Matrix4();if(ad.matrix){Y.setFromArray(ad.matrix);O.target=null}var ab=new C.Matrix4();if(ad.ambianceTransform){ab.setFromArray(ad.ambianceTransform)}Y=new C.Matrix4().multiplyMatrices(ab,Y);if(P.rootMatrix){Y=new C.Matrix4().multiplyMatrices(P.rootMatrix,Y)}if(O instanceof C.DirectionalLight&&O.castShadow){var ae=new C.Vector3();ae.set(0,0,1);ae.applyMatrix4(new C.Matrix4().extractRotation(Y));ae.normalize();ae.multiplyScalar(S._bsShow.radius*1.5);var aj=new C.Vector3().addVectors(S._bsShow.center,ae);Y.setPosition(aj);O.shadowCameraLeft=-S._bsShow.radius;O.shadowCameraRight=S._bsShow.radius;O.shadowCameraTop=S._bsShow.radius;O.shadowCameraBottom=-S._bsShow.radius;O.shadowCameraNear=aj.distanceTo(S._bsShow.center)-S._bsShow.radius;O.shadowCameraFar=aj.distanceTo(S._bsShow.center)+S._bsShow.radius;O.shadowMapHeight=1024;O.shadowMapWidth=1024}var ag=new D(O);ag.setMatrix(Y);S.add(ag)}};this.applyCamera=function(Q){var X=Q.destinationNodes?Q.destinationNodes[0]:Q.destinationNode;if(!X._occurrences[0].scene3js){return}var P=X._occurrences[0].scene3js.viewer;var Z=Q.json.renderFrames;var R=Q.json.currentRenderFrame?Q.json.currentRenderFrame:0;if(!Z||!Z.length){return}for(var af=0;af<Z.length;af++){var aa=Z[af];var ag=Q.json.cameras[aa.camera];var ac=aa.resolution;var ad=aa.activeEffects;var ae=new C.Matrix4().setFromArray(ag.matrix);var T=new C.Vector3();var O=new C.Quaternion();var al=new C.Vector3();ae.decompose(T,O,al);var W;var ai=10,N=2500;var V=1;if(Q.rootMatrix){V=Q.rootMatrix.elements[0]}T.multiplyScalar(V);var U=ag.focusDistance*V;if(!ag.autoNearFar&&ag.nearFar){ai=ag.nearFar[0];N=ag.nearFar[1];ai*=V;N*=V}var aj=ag.sensorSize?ag.sensorSize:[36,24];aj[0]*=V;aj[1]*=V;var M;if(ag.type&&ag.Type=="orthographic"){M=t.ORTHOGRAPHIC}else{M=t.PERSPECTIVE;var S=ag.focalLength?ag.focalLength:50;S*=V;var ah=(2*Math.atan(aj[0]/(2*S)))*180/Math.PI}var W=new t({viewer:P,projectionType:M,angle:ah,near:ai,far:N,defaultController:true});W.onMove(P.render);W.moveTo({eyePosition:T,orientation:O});W.setTargetDistance(U);P.addViewpoint(W)}var ad=Z[R].effects;var ab={bloom:false,aa:false,tonemapping:-1};if(ad){for(var af=0;af<ad.length;af++){if(effect.type==="bloom"){ab.bloom=true}else{if(effect.type==="downsampling"){ab.aa=true}else{if(effect.type==="toneMapper"){if(effect.toneMapperType==="filmic"){result.tonemapping=6}else{if(effect.toneMapperType==="photographic"){result.tonemapping=8}}if(effect.toneMapperType==="reinhard"){result.tonemapping=3}if(effect.toneMapperType==="gamma"){result.tonemapping=9}if(effect.toneMapperType==="exposure"){}if(effect.toneMapperType==="iccProfile"){}}else{if(effect.type==="vignetting"){}else{if(effect.type==="reconstructionFilter"){}}}}}}}P.setAntiAliasing(ab.aa);if(ab.tonemapping>-1){P.getEffect("ToneMapping").setToneMapping(ab.tonemapping)}P.setBloom(ab.bloom);var Y=P.getViewpoints();var ak=Y.length-Z.length;P.selectViewpoint(ak+R)};this.parseHeader=function(N){var O=N.json.header;if(!O||!O.version){return false}if(parseFloat(O.version)!==2&&parseFloat(O.version)!==3&&parseFloat(O.version)!==3.1){return false}N.version=parseFloat(O.version);if(O.content==="material"){N.content=O.content}var M=new C.Matrix4();if(O.unit==="m"||O.unit==="meter"||O.unit==="meters"){M.makeScale(1000,1000,1000)}else{if(O.unit==="inch"||O.unit==="inches"){M.makeScale(25.4,25.4,25.4)}}if(O.upAxis==="Y"){M.rotateX(0.5*Math.PI)}else{if(O.upAxis==="X"){M.rotateY(0.5*Math.PI)}}if(!M.isIdentity()){N.rootMatrix=M}return true};this.processJSON=function(M){var N=this.parseHeader(M);if(!N){return}if(!M.data.chunks.length&&M.json.binaries){this.getChunks(M.json.binaries.length,M,this.processChunks)}else{this.processChunks(M)}};this.processChunks=function(W){I=performance.now();var Y=W.json;if(typeof Y.extensionsUsed!=="undefined"){for(var V=0;V<Y.extensionsUsed.length;V++){this.extensionsUsed.add(Y.extensionsUsed[V])}}if(typeof Y.extensionsRequired!=="undefined"){for(var V=0;V<Y.extensionsRequired.length;V++){this.extensionsRequired.add(Y.extensionsRequired[V])}}this.createImages(Y.images,W);if(W.content!=="material"){this.createAmbience(Y,W);if(W.version===2){this.createBuffers(Y.buffers,W)}}this.createTextures(Y.textures,W);if(W.version===2){this.createMaterialsV2(Y.materials,W.data,W)}else{this.createMaterials(Y.materials,W.data,W)}if(W.content!=="material"){if(Y.root!==undefined){if(W.version===2){this.createGeometriesV2(Y.geometries,W)}else{this.createGeometries(Y.geometries,Y.buffers,Y.vertexLayouts,W)}this.createNodes(Y.nodes,W);s("processed data in "+(performance.now()-I)+" ms.");I=performance.now();for(var V=0;V<W.data.nodes.length;V++){var P=W.data.nodes[V];var S=W.data.children;if(S[V]){for(var T=0;T<S[V].length;T++){P.add(W.data.nodes[S[V][T]],true)}}if(P.__representations){var T;for(T=0;T<P.__representations.length;T++){var R,Q=[];for(R=0;R<P.__representations[T].length;R++){Q.push(W.data.nodes[P.__representations[T][R]])}P._pushRepresentation(Q)}}}W.unstreamLayers&&this.createLayers(Y.nodes,W);s("Created links between nodes in "+(performance.now()-I)+" ms.");I=performance.now();var N=W.data.nodes[Y.root];if(W.rootMatrix){var Z=new C.Matrix4().multiplyMatrices(W.rootMatrix,N.getMatrix());N.setMatrix(Z)}if(W.destinationNodes){for(var V=0;V<W.destinationNodes.length;V++){W.destinationNodes[V].add(N)}}else{W.destinationNode.add(N)}s("Attached to scenegraph in "+(performance.now()-I)+" ms.")}else{if(W.data.materials.length===1){for(var V=0;V<W.destinationNodes.length;V++){W.destinationNodes[V].setMaterial(W.data.materials[0])}for(var V=0;V<W.destinationDGforGAS.length;V++){W.destinationDGforGAS[V].gas=W.data.materials[0]}for(var V=0;V<W.destinationDGforMaterial.length;V++){W.destinationDGforMaterial[V].material=W.data.materials[0]}}}this.applyLights(W);this.applyCamera(W)}var X=W.data.modelsToLoad.length;if(X){var O=0;for(var V=0;V<X;V++){var M=W.data.modelsToLoad[V];this.load({url:this.getURI(M.uri,W.path),destinationNode:M.destinationNode,destinationNodes:M.destinationNodes,destinationDGforGAS:M.destinationDGforGAS,destinationDGforMaterial:M.destinationDGforMaterial,zipped:true,layers:W.unstreamLayers,reps:W.unstreamReps,doneCallback:function(){O++;if(O===X){if(W.doneCallback){W.doneCallback()}}}})}}else{this.nbModelsToLoad--;if(W.doneCallback){var U={isLast:!this.nbModelsToLoad,json:W.json};if((W.content==="material")&&(W.data.materials.length>0)){U.material=W.data.materials[0];U.materials=W.data.materials.slice()}W.doneCallback(U)}}if(W.readyCallback){W.readyCallback()}delete this.modelsToLoad[W.loadIndex]};this.internalLoad=function(O){var S=this;var N=this.modelsToLoad[O];I=performance.now();if(!N.json){var R=N.url;var M="text";if(N.zipped){M="blob"}if(N.concat){M="arraybuffer"}var Q=function(aa){s("file downloaded in "+(performance.now()-I)+" ms.");I=performance.now();if(N.zipped){var T=function(ad){s("zip file reader created in "+(performance.now()-I)+" ms.");N.zipEntries=ad;var af=null;for(var ae=0;ae<ad.length;ae++){if(ad[ae].filename==="manifest.json"){af=ad[ae]}}I=performance.now();S.getEntryFile(af,"text",function(ag){s("unzipped JSON file in "+(performance.now()-I)+" ms.");I=performance.now();N.json=JSON.parse(ag);s("parsed JSON file in "+(performance.now()-I)+" ms.");S.processJSON(N)})};A.createReader(new A.BlobReader(aa),function(ad){ad.getEntries(T)},N.errorCallback)}else{if(N.concat){var U=new Uint8Array(aa);var Y=new Uint32Array(aa,0,1);var X=Y[0];var ab=new Uint16Array(U.buffer,4,X/2);var V=[];var W=65535;for(var Z=0;Z*W<ab.length;Z++){V.push(String.fromCharCode.apply(null,ab.subarray(Z*W,(Z+1)*W)))}var ac=V.join("");s("unbinarized JSON file in "+(performance.now()-I)+" ms.");I=performance.now();N.json=JSON.parse(ac);s("parsed JSON file in "+(performance.now()-I)+" ms.");N.concatBinaries={data:U,offset:U.byteLength};S.processJSON(N)}else{s("JSON file downloaded in "+(performance.now()-I)+" ms.");I=performance.now();N.json=JSON.parse(aa);s("parsed JSON file in "+(performance.now()-I)+" ms.");S.processJSON(N)}}};if(R.slice(0,5)=="file:"){var P=new XMLHttpRequest();P.open("GET",R,true);P.responseType=M;P.withCredentials=true;P.onreadystatechange=function(T){if(P.readyState===4){if(P.status===0||P.status===200){Q(P.response)}else{N.errorCallback()}}};P.send(null)}else{UWA.Ajax.request(R,{async:true,cors:true,withCredentials:true,responseType:M,onComplete:Q,onFailure:N.errorCallback})}}else{this.processJSON(N)}};this.getChunks=function(R,S,M){var Q=this;if(!R){if(S.concatBinaries){S.concatBinaries.data=null}M.call(this,S);return}R--;I=performance.now();if(S.zipped){var V=null;for(var P=0;P<S.zipEntries.length;P++){if(S.zipEntries[P].filename===S.json.binaries[R].uri){V=S.zipEntries[P]}}if(V){this.getEntryFile(V,"arraybuffer",function(Y){s("unzipped binary file "+R+" in "+(performance.now()-I)+" ms.");S.data.chunks[R]=Y;Q.getChunks(R,S,M)})}else{Q.getChunks(R,S,M)}}else{if(S.concat){I=performance.now();var T=S.json.binaries[R];if(T.concatenated===false){Q.getChunks(R,S,M);return}var O=T.byteLength;if(O%4){O+=4-(O%4)}S.concatBinaries.offset-=O;if(S.concatBinaries.data.buffer.slice){var X=S.concatBinaries.data.buffer.slice(S.concatBinaries.offset,S.concatBinaries.offset+T.byteLength);S.data.chunks[R]=new Uint8Array(X)}else{var X=new Uint8Array(S.concatBinaries.data.buffer,S.concatBinaries.offset,T.byteLength);var U=new Uint8Array(T.byteLength);for(var N=0;N<T.byteLength;N++){U[N]=X[N]}S.data.chunks[R]=U}s("splitted binary file "+R+" in "+(performance.now()-I)+" ms.");Q.getChunks(R,S,M)}else{var W=new XMLHttpRequest();W.open("GET",S.path+S.json.binaries[R].uri,true);W.responseType="arraybuffer";W.withCredentials=true;W.onreadystatechange=function(Y){if(W.readyState===4){if(W.status===0||W.status===200){s("xhr binary file "+R+" in "+(performance.now()-I)+" ms.");S.data.chunks[R]=this.response;Q.getChunks(R,S,M)}}};W.send(null)}}};this.setMode=function(M){this.mode=M};this.setSharedBuffers=function(M){this.sharedBuffers=M};this.setNoMeshInRAM=function(M){this.noMeshInRAM=M};this.setBaseUrl=function(M){this.baseUrl=M};this.load=function(N){var M={version:3,content:"sceneGraph",url:N.url,path:N.url?n.parseUrl(N.url+".json").directoryPath:null,zipped:(N.zipped!==undefined)?N.zipped:((this.mode===undefined)||(this.mode==="zipped")),concat:(N.concat!==undefined)?N.concat:(this.mode==="concat"),json:N.json,readyCallback:N.readyCallback,progressCallback:N.progressCallback,doneCallback:N.doneCallback,errorCallback:N.errorCallback,imagesCallback:N.imageCallback,materialsCallback:N.materialCallback,nodeCallback:N.nodeCallback,switchLODTextureCB:N.switchLODTextureCallback,onTexturesLoadedCB:N.onTexturesLoadedCallback,destinationNode:N.destinationNode,destinationNodes:N.destinationNodes,destinationDGforGAS:N.destinationDGforGAS,destinationDGforMaterial:N.destinationDGforMaterial,unstreamLayers:(N.layers!==undefined)?N.layers:false,unstreamReps:(N.reps!==undefined)?N.reps:false,unstreamPrimitives:(N.primitives!==undefined)?N.primitives:false,unstreamSSB:(N.ssb!==undefined)?N.ssb:false,gasSharing:(N.gasSharing!==undefined)?N.gasSharing:false,lightMapAsIrradiance:(N.lightMapAsIrradiance!==undefined)?N.lightMapAsIrradiance:false,loadIndex:this.loadIndex,data:{chunks:N.chunks?N.chunks:[],header:{},nodes:[],children:[],buffers:[],geometries:[],images:[],textures:[],materials:[],reps:{},modelsToLoad:[],nbImagesToLoad:0}};this.modelsToLoad[this.loadIndex]=M;this.nbModelsToLoad++;this.internalLoad(this.loadIndex);this.loadIndex++};this.loadMaterial=function(O){if(!O.json){return false}O.zipped=false;O.chunks=[];var M=0;if(O.json.binaries&&O.binaries){for(var N=0;N<O.json.binaries.length;N++){var P=O.json.binaries[N];if(!P.extUri){O.chunks.push(O.binaries[M]);M++}}}this.load(O)}};return f});