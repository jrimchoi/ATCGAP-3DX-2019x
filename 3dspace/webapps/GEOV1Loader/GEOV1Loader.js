/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/GEOV1Loader/GEOConvertLength",function(){var a={convertToMM:function(e){var b=undefined;if(e==""){return b}var d=e.toLowerCase();if(d=="yard"){d="yd"}else{if(d=="foot"){d="ft"}}var c={mm:1,cm:10,m:1000,km:1000000,inch:25.4,ft:304.8,yd:914.4,mile:1609344,nauticalmile:1852000};b=c[d];if(b!==undefined){return b}if(d=="meter"||d=="metre"){d="m"}else{if(d=="kilometer"||d=="kilometre"){d="km"}else{if(d=="centimeter"||d=="centimetre"){d="cm"}else{if(d=="millimeter"||d=="millimetre"){d="mm"}}}}return c[d]}};return a});define("DS/GEOV1Loader/GEOStyleServices",["DS/Visualization/ThreeJS_DS"],function(a){var b=function(){function c(f,e,g){this._min=f;this._max=e;this._modulo=g;this.print=function(){console.log("propertiesRange print: min="+this._min+" max="+this._max+" modulo="+this._modulo+"\n")}}function d(f,h,e,g){this._dashSize=f;this._gapSize=h;this._lineWidth=e;this._patternNumber=g;this.print=function(){console.log("line type print: dashSize="+this._dashSize+" gapSize="+this._gapSize+" lineWidth="+this._lineWidth+"\n")};this.printPattern=function(){var i=["solid","dashed","dotted","dashes and dots alternating","dashes and double-dot alternating","dashes and triple dots alternating","long dashes","very long dash and short dash alternating","very long dash and double short dash alternating","very fine dotted line"];console.log("line pattern: "+i[this._patternNumber]+"\n")}}this._parseSsi_lines=function(L,K,G,I,v){I[0]=new a.LineBasicMaterial({color:8806,lineWidth:1});var h=K.length;var H=[];for(var E=0;E<h;E++){H[E]=new Array(K[E],E,0)}var w=H.length;var q=L.split("STRINGS");var o=q.length;var N=[];var m=[];var u=false;var M=false;for(var x=1;x<o;x++){var e=q[x].split("\n");var y=e.length;for(var E=1;E<y;E++){var J=e[E];J=J.trim();var g=J.split(",");if(g.length==0){continue}var n=parseInt(g[0]);if(isNaN(n)){if(g[0].indexOf("default")==0){u=true;M=true}else{if(g[0].indexOf("TRIOBJECTS")==0){break}else{console.log("_parseSsi irrelevant line ="+J+"\n");continue}}}var f=this._getLineColor(J);var A=this._getLineType(J);var t=this._buildGraphicProperty(f,A);if(u==true){I[0]=t;u=false;continue}var F=[];var D=[];this._getPropertyObjectIndex(J,F,D);var l=F.length;var p=0;for(var C=0;C<l;C++){if(F[C]._min>G[1]){continue}if(F[C]._max<G[0]){continue}p=0;w=H.length;var s=F[C]._min%F[C]._modulo;for(var z=0;z<w;z++){if((H[z][0])%(F[C]._modulo)==s){p++;H[z][2]=1;v[H[z][1]]=t}}if(p>0){H=this._resizeProcessTable(H,G)}}var B=D.length;var r=0;for(var C=0;C<B;C++){m.push(D[C]);N.push(t)}}var B=m.length;w=H.length;var r=0;for(var C=0;C<B;C++){for(var z=0;z<w;z++){if(H[z][0]==m[C]){H[z][2]=1;r++;v[H[z][1]]=N[C]}}}if(r>0){H=this._resizeProcessTable(H,G)}}w=H.length;if(w>0){if(M){for(var E=0;E<w;E++){v[H[E][1]]=I[0]}}else{for(var E=0;E<w;E++){v[H[E][1]]=this._getLineDefault(H[E][0])}}}};this._parseSsi_triObjects=function(J,I,E,r){var B=this._getFaceColorDefault(0);var g=I.length;var F=[];for(var C=0;C<g;C++){F[C]=new Array(I[C],C,0)}var u=F.length;var p=J.split("TRIOBJECTS");var n=p.length;var L=[];var l=[];var t=false;var K=false;for(var v=1;v<n;v++){var e=p[v].split("\n");var w=e.length;for(var C=1;C<w;C++){var H=e[C];H=H.trim();var f=H.split(",");if(f.length==0){continue}var m=parseInt(f[0]);if(isNaN(m)){if(f[0].indexOf("default")==0){t=true;K=true}else{if(f[0].indexOf("STRINGS")==0){break}else{console.log("_parseSsi_triObjects irrelevant line ="+H+"\n");continue}}}var G=this._getFaceColor(H);if(t==true){B=G;t=false;continue}var D=[];var A=[];this._getPropertyObjectIndex(H,D,A);var h=D.length;var o=0;for(var z=0;z<h;z++){if(D[z]._min>E[1]){continue}if(D[z]._max<E[0]){continue}o=0;u=F.length;var s=D[z]._min%D[z]._modulo;for(var x=0;x<u;x++){if((F[x][0])%(D[z]._modulo)==s){o++;F[x][2]=1;r[F[x][1]]=G}}if(o>0){F=this._resizeProcessTable(F,E)}}var y=A.length;var q=0;for(var z=0;z<y;z++){l.push(A[z]);L.push(G)}}var y=l.length;u=F.length;var q=0;for(var z=0;z<y;z++){for(var x=0;x<u;x++){if(F[x][0]==l[z]){F[x][2]=1;q++;r[F[x][1]]=L[z]}}}if(q>0){F=this._resizeProcessTable(F,E)}}u=F.length;if(u>0){if(K){for(var C=0;C<u;C++){r[F[C][1]]=B}}else{for(var C=0;C<u;C++){r[F[C][1]]=this._getFaceColorDefault(F[C][0])}}}};this._computeColor=function(M){var ac=new a.Color();var aj=0.5;var ap=0.5;var aq=0.5;ac.setRGB(aj,ap,aq);var B=M.trim();B.toLowerCase();var ao=M.indexOf("r=");if(ao!=-1){var ar=M.split(" ");var P=ar.length;if(P!=3){return ac}var C=0.5;var am=0.5;var ab=0.5;var ai;var U,ad,ae=false;for(var an=0;an<P;an++){var ak=ar[an].indexOf("r=");if(ak!=-1){ai=ar[an].substr(ak+2,ar[an].length-1);C=parseFloat(ai);if(!isNaN(C)){U=true}}ak=ar[an].indexOf("g=");if(ak!=-1){ai=ar[an].substr(ak+2,ar[an].length-1);am=parseFloat(ai);if(!isNaN(am)){ad=true}}ak=ar[an].indexOf("b=");if(ak!=-1){ai=ar[an].substr(ak+2,ar[an].length-1);ab=parseFloat(ai);if(!isNaN(ab)){ae=true}}}if(U==false||ad==false||ae==false){console.log("_computeColor  rgb syntax error\n");return ac}ac.setRGB(C,am,ab);return ac}var ah=[];var ag=[];var aa=["apricot","aquamarine"];var I=[255,194,166,0,242,214];ah.push(aa);ag.push(I);var Z=["bittersweet","black","blue","blue green","blue grey","blue violet","brick red","brown","burnt orange","burnt sienna"];var G=[207,10,0,0,0,0,0,0,255,0,181,168,41,117,166,25,0,64,163,3,0,51,8,0,181,79,0,143,25,13];ah.push(Z);ag.push(G);var Y=["cadet blue","cerulean","copper","cornflower","cyan"];var E=[79,79,143,0,82,102,133,54,0,107,107,255,0,255,255];ah.push(Y);ag.push(E);var X=["dandelion"];var D=[230,191,0];ah.push(X);ag.push(D);var W=["forest green","fuchsia"];var y=[0,92,23,166,0,102];ah.push(W);ag.push(y);var V=["gold","goldenrod","green","green blue","green yellow","grey"];var x=[173,94,0,255,92,0,0,255,0,0,148,204,230,255,0,128,128,128];ah.push(V);ag.push(x);var T=["indian red"];var v=[128,0,0];ah.push(T);ag.push(v);var S=["jungle green"];var u=[0,166,102];ah.push(S);ag.push(u);var R=["lavender","lemon yellow"];var t=[255,143,199,255,219,10];ah.push(R);ag.push(t);var Q=["magenta","mahogany","maize","maroon","melon","midnight blue","mulberry"];var s=[255,0,156,135,0,0,255,171,0,128,0,59,245,94,77,0,0,92,194,0,120];ah.push(Q);ag.push(s);var O=["navy blue"];var q=[0,0,122];ah.push(O);ag.push(q);var L=["olive green","orange","orange red","orange yellow","orchid"];var p=[125,125,0,255,31,0,191,8,0,255,128,0,242,56,207];ah.push(L);ag.push(p);var K=["peach","periwinkle","pine green","pink","plum","purple"];var o=[255,163,125,173,191,255,0,92,69,255,89,133,138,0,112,23,0,31];ah.push(K);ag.push(o);var J=["raw sienna","raw umber","red","red orange","red violet","royal purple"];var m=[148,56,3,82,38,0,255,0,0,255,10,0,158,0,140,64,0,102];ah.push(J);ag.push(m);var H=["salmon","sea green","sepia","silver","sky blue","spring green","strawberry"];var l=[255,125,94,41,255,41,41,8,0,184,184,184,112,217,255,189,255,66,204,0,51];ah.push(H);ag.push(l);var F=["tan","tangerine","teal","teal blue","thistle","turquoise blue"];var k=[181,41,0,255,102,0,0,102,82,209,10,168,0,143,163];ah.push(F);ag.push(k);var A=["violet red"];var h=[163,0,64];ah.push(A);ag.push(h);var z=["white"];var f=[255,255,255];ah.push(z);ag.push(f);var w=["yellow","yellow green","yellow orange"];var e=[255,255,0,125,255,0,255,59,0];ah.push(w);ag.push(e);var P=ah.length;var af=M.charAt(0);lab1:for(var an=0;an<P;an++){if(af==ah[an][0].charAt(0)){var N=ah[an].length;for(var al=0;al<N;al++){if(M==ah[an][al]){aj=ag[an][3*al]/255;ap=ag[an][(3*al)+1]/255;aq=ag[an][(3*al)+2]/255;break lab1}}}}ac.setRGB(aj,ap,aq);return ac};this._getLineColor=function(u){var k=new a.Color();var e=1;var m=0;var o=0;k.setRGB(e,m,o);var p=u.split("HGS_color=");var j=p.length;for(var l=1;l<j;l++){var s;var f=p[l].split(",");var t=f[0].indexOf("lines=");if(t>=0){if(f[0].indexOf(" g=")!=-1||f[0].indexOf(" b=")!=-1||f[0].indexOf(" r=")!=-1){var h=f[0].lastIndexOf("=");s=f[0].substring(0,h);h=s.lastIndexOf("=");if(h==-1){console.log("_getLineColor rgb syntax error.\n");return k}s=f[0].substring(0,h);h=s.lastIndexOf("=");if(h==-1){console.log("_getLineColor rgb syntax error.\n");return k}s=f[0].substring(h-1,n)}else{var n=f[0].length;var h=f[0].lastIndexOf("=");if(n>h+1){s=f[0].substring(h+1,n)}else{console.log("_getLineColor color name error.\n");return k}}var q=this._computeColor(s);return q}}return k};this._getFaceColor=function(u){var k=new a.Color();var e=0.349;var m=1;var p=0.349;k.setRGB(e,m,p);var q=u.split("faces");var j=q.length;for(var l=1;l<j;l++){var t;var f=q[l].split(",");var o=f[0].indexOf("diffuse=");if(o==-1){o=f[0].lastIndexOf("=")}if(o>=0){if(f[0].indexOf(" g=")!=-1||f[0].indexOf(" b=")!=-1||f[0].indexOf(" r=")!=-1){var h=f[0].lastIndexOf("=");t=f[0].substring(0,h);h=t.lastIndexOf("=");if(h==-1){console.log("_getFaceColor rgb syntax error.\n");return k}t=f[0].substring(0,h);h=t.lastIndexOf("=");if(h==-1){console.log("_getFaceColor rgb syntax error.\n");return k}t=f[0].substring(h-1,n)}else{var n=f[0].length;var h=f[0].lastIndexOf("=");if(n>h+1){t=f[0].substring(h+1,n)}else{console.log("_getFaceColor color name error.\n");return k}}var s=this._computeColor(t);return s}}return k};this._getLineType=function(t){var j=0;var g=0;var l=1;var o=0;var k=new d(j,g,l,o);var r=t.split("HGS_line_weight=");var h=r.length;if(h<2){return k}var f=r[1].split(",");if(f.length>0){l=parseInt(f[0])}else{l=parseInt(r[1])}if(isNaN(l)){}else{k._lineWidth=l}r=t.split("HGS_line_pattern=");var i=["-","- -",".","-.","-..","-...","-- --","center","phantom","finedot"];var e=r.length;if(e<2){return k}var s=r[1].split(",");var n;if(s.length>0){n=s[0]}else{n=r[1]}n.trim();if(n.length==0){return k}var q=n.charAt(0);var m=n.length;if(q!="."&&q!="-"&&q!="c"&&q!="p"&&q!="f"){if(m>1){n=n.substring(1,m)}}m=n.length;q=n.charAt(m-1);if(q!="."&&q!="-"&&q!="r"&&q!="m"&&q!="e"&&q!="t"){if(m>1){n=n.substring(0,m-1)}}var p=n.split(" ");if(p.length==1){if(n.indexOf(i[0])!=-1){if(n.indexOf(i[2])!=-1){if(n==i[3]){k._patternNumber=3;return k}else{if(n==i[4]){k._patternNumber=4;return k}else{if(n==i[5]){k._patternNumber=5;return k}}}}else{k._patternNumber=0;return k}}if(n==i[7]){k._patternNumber=7;return k}if(n==i[8]){k._patternNumber=8;return k}if(n==i[9]||n=="...fine"){k._patternNumber=9;return k}if(n.indexOf(i[2])!=-1){k._patternNumber=2;return k}return k}else{if(p.length==2){if(n.localeCompare(i[1])==0){k._patternNumber=1;return k}if(n.localeCompare(i[6])==0){k._patternNumber=6;return k}}}return k};this._buildGraphicProperty=function(e,f){if(f._patternNumber==0){return new a.LineBasicMaterial({color:e,lineWidth:f._lineWidth})}else{if(f._patternNumber==1){return new a.LineBasicMaterial({color:e,dashSize:1,gapSize:1,lineWidth:1})}else{if(f._patternNumber==6){return new a.LineBasicMaterial({color:e,dashSize:2,gapSize:1,lineWidth:f._lineWidth})}else{if(f._patternNumber==7||f._patternNumber==8){return new a.LineBasicMaterial({color:e,dashSize:3,gapSize:1,lineWidth:f._lineWidth})}else{if(f._patternNumber==2||f._patternNumber==3||f._patternNumber==4||f._patternNumber==5||f._patternNumber==9){return new a.LineBasicMaterial({color:e,dashSize:1,gapSize:1,lineWidth:f._lineWidth})}}}}}return new a.LineBasicMaterial({color:e,lineWidth:f._lineWidth})};this._getLineColorDefault=function(h){var i=this;var f=i._getLineDefault(h);var l=new a.Color();var k=f.color.r;var j=f.color.g;var e=f.color.b;l.setRGB(k,j,e);return l};this._getLineDefault=function(l){var n=new a.Color();var e=1;var k=1;var o=0;n.setRGB(e,k,o);var m=new a.LineBasicMaterial({color:n,lineWidth:1});if(l<1){return m}if(l>99&&l<30000){return m}if(l>30008){return m}var q=[1,1,1,0,0,1,0,0.6,0.8,0.478,0.819,0.478,0.349,1,0.349,1,1,0,1,0.6,0.2,1,0,0,1,0.4,1];if(l<10){var j=l-1;e=q[3*j];k=q[3*j+1];o=q[3*j+2];n.setRGB(e,k,o);var f=new a.LineBasicMaterial({color:n,lineWidth:1});return f}if(l<100){var j=l%10;e=q[3*j];k=q[3*j+1];o=q[3*j+2];n.setRGB(e,k,o);var f=new a.LineBasicMaterial({color:n,lineWidth:1});return f}var h=[0.5,0.5,0.5,0.698,0.584,0.29,0,1,1,0.803,0.6,0.596,0,0,0,1,0.761,0.651,0,0.949,0.839,0.8,0,0.8,0.709,0.541,0.521];if(l<30009){var j=l-30000;if(j==4){return m}e=h[3*j];k=h[3*j+1];o=h[3*j+2];n.setRGB(e,k,o);var p=1;if(l==30000||l==30001){p=3}if(l==30002||l==30006){p=2}if(l==30001){var f=new a.LineBasicMaterial({color:n,dashSize:1,gapSize:1,lineWidth:p});return f}else{var f=new a.LineBasicMaterial({color:n,lineWidth:p});return f}}return m};this._getFaceColorDefault=function(m){var i=[89,173,0,0,45,89,255,255,255,255,173,0,0,45,89,255,255,255,255,172,148,0,51,255,204,153,0,55];var h=[255,94,0,153,204,255,255,153,0,102,94,0,153,204,255,255,153,0,102,172,56,51,255,163,0,0,255,163];var j=[89,0,255,204,147,89,0,51,0,255,0,255,204,147,89,0,51,0,255,172,3,255,51,125,255,153,255,125];if(m>10){if(m<20001){m=10+(m%10)}else{if(m<20009){m=(m-20001)+20}else{m=0}}}var f=new a.Color();f.setRGB(i[m]/255,h[m]/255,j[m]/255);var l,k,e;l=f.r;k=f.g;e=f.b;return f};this._getPropertyObjectIndex=function(p,e,g){var h=0;var o=p.split("=ssi_label");var j=o[0];var n=j.split(";");var f=n.length;for(var l=0;l<f;l++){var k=n[l].split(",");if(k.length==1){n[l].trim();g[h]=parseInt(n[l]);h++}else{if(k.length==2){var m=new c(0,0,0);m._min=parseInt(k[0]);m._max=parseInt(k[1]);m._modulo=1;e.push(m)}else{if(k.length==3){var m=new c(0,0,0);m._min=parseInt(k[0]);m._max=parseInt(k[1]);m._modulo=parseInt(k[2]);e.push(m)}else{console.log("_getPropertyObjectIndex index syntax error\n")}}}}};this._resizeProcessTable=function(l,g){var f=[];var k=l.length;var j=0;var e=0;for(var h=0;h<k;h++){if(l[h][2]==0){f.push(new Array(l[h][0],l[h][1],0))}}if(f.length==k){return l}k=f.length;if(k==0){return f}j=l[0][0];e=j;for(var h=0;h<k;h++){if(f[h][0]<j){j=f[h][0]}else{if(f[h][0]>e){e=f[h][0]}}}g[0]=j;g[1]=e;return f}};return b});define("DS/GEOV1Loader/GEOdtmServices",["DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/Utils","DS/GEONavDriveAPI/GEOdriveServices","DS/GEOV1Loader/GEOstrServices","DS/GEOV1Loader/GEOStyleServices","DS/WebInfraUI/Notification","DS/WebSystem/Nls"],function(g,d,f,e,b,a,c,k,h,i){var j=function(){this.debug=false;this.method_debug="";this.vertexCoords=[];this.errorCallbackFunc=null;this.renderCallbackFunc=null;this._multiLoad=false;this._dtmPath="";this.load=function(m,B,x,q,o,t,z){var A=this;A.errorCallbackFunc=(t!==undefined)?t:null;A.renderCallbackFunc=(z!==undefined)?z:null;var s=new e();s.productType="Reference3D";var w=[];var p=[];var r=function(C){if(q){q({loaded:C.loaded,total:C.total})}};var n=function(C){console.log(C.message);A._errorLoader("LOAD_DTM",m,false)};A.endReader=function(){if(!B.multiLoad){var D=w.length;for(var C=0;C<D;C++){w[C].mesh3js.sceneGraph.children[0].solid=1;s.addChild(w[C])}if(z){z({hack:true,updateInfinitePlane:true})}if(o){o()}}else{B.itemDoneCB(w)}};var u=function(E){if(A.debug==true){A.method_debug="handleAnswerObj  "}try{var C=A._parse(E,m,w,p)}catch(D){A._errorLoader(D.message,m,false)}};var l="";if(B.multiLoad==true){l=B.path;if(l.length){var v=l.lastIndexOf("/");if(v!=-1){var y=l.lastIndexOf("\\");if(v<y){v=y}A._dtmPath=l.substring(0,v)}else{var y=l.lastIndexOf("\\");if(y!=-1){A._dtmPath=l.substring(0,y)}}}}a.load(m,l,u,n);if(x&&!B.multiLoad){x(s)}};this._parse=function(E,y,w,m){if(this.debug==true){this.method_debug="_parse  "}var l=this;var q=[];var z=[];var C=[];var D=this._decodeHeader(E,0);var o=D.length;if(o==0){console.log(this.method_debug+"Error: invalid dtm file, no header.\n");l._errorLoader("PARSE_DTM",y,true);return false}D.trim();var s=D.indexOf(".str");if(s==-1){console.log(this.method_debug+"Error: invalid dtm file, no str file.\n");l._errorLoader("PARSE_DTM",y,true);return false}var r=D.substring(0,s)+".str";var t=s;var v=false;s=o-1;if(D.charAt(s)==="\0"){v=true}var A=false;var B=[0,0];if(v){s=s+1;A=this._parseDTM_binary(E,s,z,C,q,B)}else{A=this._parseDTM_ascii(this._ensureString(E),z,C,q,B)}if(!A){console.log(this.method_debug+"Error: parsing dtm file failed.\n");l._errorLoader("PARSE_DTM",y,true);return false}var x=function(F){if(progressCallback){progressCallback({loaded:F.loaded,total:F.total})}};var u=function(F){console.log("Error: load str file failed.\n");console.log(F.message);l._errorLoader("LOAD_DTM_STR",y,false)};var n=function(){var N=function(ae,ai,ag){var ad;var af=0.000001;var ah=ae*ae+ai*ai+ag*ag;if(Math.abs(ah-1)<af){ad=1}else{if(ah>af){ad=Math.sqrt(ah)}}return ad};var F=z.length;for(var K=0;K<F;K++){var M=z[K];var T=M.length/3;var L=new Float32Array(T*3*3);var S=new Float32Array(T*3*3);var V=0;var U=0;var R=0;var Z;var Y;var X;var I;var H;var G;var Q;var P;var O;var ac;var ab;var aa;var J;for(var W=0;W<T;W++){R=M[U]-1;L[V]=l.vertexCoords[3*R]*1000;L[V+1]=l.vertexCoords[3*R+1]*1000;L[V+2]=l.vertexCoords[3*R+2]*1000;V=V+3;R=M[U+1]-1;L[V]=l.vertexCoords[3*R]*1000;L[V+1]=l.vertexCoords[3*R+1]*1000;L[V+2]=l.vertexCoords[3*R+2]*1000;V=V+3;R=M[U+2]-1;L[V]=l.vertexCoords[3*R]*1000;L[V+1]=l.vertexCoords[3*R+1]*1000;L[V+2]=l.vertexCoords[3*R+2]*1000;V=V+3;U=U+3}V=0;for(var W=0;W<T;W++){Z=L[V];I=L[V+1];Q=L[V+2];Y=L[V+3];H=L[V+4];P=L[V+5];X=L[V+6];G=L[V+7];O=L[V+8];ac=(H-I)*(O-Q)-(P-Q)*(G-I);ab=(P-Q)*(X-Z)-(Y-Z)*(O-Q);aa=(Y-Z)*(G-I)-(H-I)*(X-Z);J=N(ac,ab,aa);S[V]=ac/J;S[V+1]=ab/J;S[V+2]=aa/J;S[V+3]=S[V];S[V+4]=S[V+1];S[V+5]=S[V+2];S[V+6]=S[V];S[V+7]=S[V+1];S[V+8]=S[V+2];V=V+9}w.push(l._createMeshNode(T,L,S,m[K]))}};var p=function(I){if(l.debug==true){l.method_debug="handleAnswerStr  "}var G=[];var J=new c();if(!J.parseStrVertex(I,l.vertexCoords,G)){l._errorLoader("PARSE_DTM_STR",y,true);return}if(!l._SurpacCheckSum(D,t,l.vertexCoords,G)){console.log(l.method_debug+"Error: dtm and str files are not compatible.\n");l._errorLoader("LOAD_DTM_MISMATCH",y,true);return}var M=function(R){var Q=new k();Q._parseSsi_triObjects(l._ensureString(R),q,B,m);n();l.endReader()};var O=function(Q){console.log(Q.message);var T=new k();var S=q.length;for(var R=0;R<S;R++){m[R]=T._getFaceColorDefault(q[R])}n();l.endReader()};var H=J.hasStyle();var P=J.getStylePathName();if(H){if(l._dtmPath.length){P=l._dtmPath+"/"+P}try{a.load(y,P,M,O)}catch(N){H=false}}if(!H){var L=new k();var F=q.length;for(var K=0;K<F;K++){m[K]=L._getFaceColorDefault(q[K])}n();l.endReader()}};if(l._dtmPath.length){r=l._dtmPath+"/"+r}a.load(y,r,p,u);return true};this._parseDTM_ascii=function(H,G,A,v,D){var s=true;var q=0;var F=0;var t=H.indexOf("OBJECT");if(t!=-1){var B=Math.min(H.length-t,1024);var E=H.substring(t+6,t+B);var m=E.split(",");if(m.length>1){F=parseInt(m[1]);if(isNaN(F)){F=0}}}var C=H.split("TRISOLATION");for(var y=1;y<C.length;y++){q=F;var p=[];var u=[];var l=C[y].split("\n");var x=l[0].split(",");if(x.length<2){return false}for(var z=1;z<l.length-1;z++){var r=l[z];r=r.trim();var m=r.split(",");var n=m.length;if(n==0){continue}if(parseInt(m[0])==0){continue}if(n<8){if(m[0]==="END"){break}if(m[0]==="OBJECT"){if(n>2){F=parseInt(m[1]);if(isNaN(F)){F=0}}else{F=0}break}s=false;console.log("_parseDTM Error: invalid triangle data\n");console.log("_parseDTM  triangle="+y+" line ="+r+"\n");break}if(m[0]==="OBJECT"){if(n>2){F=parseInt(m[1]);if(isNaN(F)){F=0}}break}for(var w=1;w<=3;w++){p.push(parseInt(m[w]))}for(var w=4;w<=6;w++){u.push(parseInt(m[w]))}}if(p.length<3){return false}G.push(p);A.push(u);v.push(q);var o=q;if(isNaN(o)){o=-1}if(o!=-1){if(D[0]==0&&D[1]==0){D[0]=o;D[1]=o}else{if(o<D[0]){D[0]=o}else{if(o>D[1]){D[1]=o}}}}}return s};this._parseDTM_binary=function(G,s,D,A,x,C){if(this.debug==true){this.method_debug="_parseDTM_binary  "}var n=new DataView(G,s);var q=n.byteLength;var r=n.byteOffset;var E=this._readDMTFirstBinaryBlock(n,q,r);if(E===-1){console.log(this.method_debug+"Error : invalid first block\n");return false}var H=-1;var m=1;var B=2;var o=3;var l=0;var u=0;var v=0;s=E;var t=[];var w=[];var p=0;do{if(q<s+4){return false}var y=false;var F=n.getInt32(s,y);s=s+4;if(F==H){}else{if(F==m){}else{if(F==B){}else{if(F==o){}else{console.log(this.method_debug+"Error: invalid dtm file.\n");return false}}}}if(F!=H){if(q<s+4){return false}v=n.getInt32(s,y);s=s+4}if(F==o){if(q<s+24){return false}for(var z=0;z<3;z++){t.push(n.getInt32(s,y));s=s+4}for(var z=0;z<3;z++){w.push(n.getInt32(s,y));s=s+4}}if(F!=H){s=this._skipDescription(n,q,r,s);if(s==-1){return false}}if(F==o){}if(F==B){if(t.length!=0){D.push(t);A.push(w)}t=[];w=[];u=l;x.push(u);if(C[0]==0&&C[1]==0){C[0]=v;C[1]=v}else{if(v<C[0]){C[0]=v}else{if(v>C[1]){C[1]=v}}}}if(F==m){l=v}}while(F!=H);if(t.length!=0){D.push(t)}if(w.length!=0){A.push(w)}return true};this._readDMTFirstBinaryBlock=function(q,n,o){var p=-1;if(n<33){return p}var l=false;var u=0;var s=0;var t=q.getInt32(u,l);u=u+4;for(;;){s=0;do{if(n<u+28){return -1}var m=q.getInt32(u,l);u=u+4;var r=q.getFloat64(u,false);u=u+8;r=q.getFloat64(u,false);u=u+8;r=q.getFloat64(u,false);u=u+8;p=this._skipDescription(q,n,o,u);if(p==-1){return p}u=p;s++}while(m!=0);if(s==1){break}}return p};this._skipDescription=function(q,m,n,t){var o=-1;var s=1;var p=0;var u=t;var r=Math.min(m-t-1,1024);if(r==0){return o}var l=new Uint8Array(q.buffer,n+t,r);for(p=0;p<r;p++){s=l[p];if(s==0){o=t+1;break}t++;if(t>m){console.log("_skipDescription error end line ="+p+"\n");o=-1;break}}if(p==r){if(t!=m-1){console.log("_skipDescription error no end line \n")}o=-1}return o};this._END_Description=function(l,o,q,r){r=r-4;var p=new Uint8Array(l.buffer,q+r,3);var m="";for(var n=0;n<3;n++){m+=p[n]&255}if(m=="END"){return true}else{return false}};this._createMeshNode=function(w,u,y,o){var l=new d.PrimitiveGroup();l.fillAttr=new d.FillAttributes();l.lineAttr=new d.LineAttributes();l.pointAttr=new d.PointAttributes();var r=new d.Buffer();r.size=3*3*w;r.component=d.VertexComponentEnum.POSITION;r.format=d.DataTypeEnum.FLOAT;r.dimension=3;r.data=u;var s=new d.Buffer();s.size=3*w;s.component=d.VertexComponentEnum.NORMAL;s.format=d.DataTypeEnum.FLOAT;s.dimension=3;s.data=y;l.addBuffer(0,r);l.addBuffer(1,s);var v=new d.Primitive();v.geomType="FACE";v.nbIndices=3*w;v.connectivity=d.ConnectivityTypeEnum.TRIANGLES;v.attr={fill:new d.FillAttributes(new d.Color(o.r,o.g,o.b,1)),line:new d.LineAttributes(),point:new d.PointAttributes()};var t=new d.VertexComponent();t.component=d.VertexComponentEnum.POSITION;t.nbVertices=3*w;t.nbValuesPerVertex=3;t.format=d.DataTypeEnum.FLOAT;t.cardinality=0;t.bufferId=0;t.indices=null;var x=new d.VertexComponent();x.component=d.VertexComponentEnum.NORMAL;x.nbVertices=3*w;x.nbValuesPerVertex=3;x.format=d.DataTypeEnum.FLOAT;x.cardinality=0;x.bufferId=1;x.indices=null;v.addVertexComponent(t);v.addVertexComponent(x);var q=null;l.addPrimitive(v);var m=f.createMeshNode(l);m.mesh3js.sceneGraph.children[0].solid=1;var z=m.getPrimitives();for(var p=0;p<z.length;p++){var n=z[p].sgNode;n._bNotRecognized=true}return m};this._decodeHeader=function(l,q){if(this.debug==true){this.method_debug="_decodeHeader  "}var p="";if(typeof l!=="string"){var n=Math.min(l.byteLength-q-1,1025);var o=new Uint8Array(l,q,n);var r;for(var m=0;m<n;m++){r=String.fromCharCode(o[m]);p+=r;if(r=="\n"){if(n==m+1){console.log(this.method_debug+"Error : invalid dtm file. \n");return""}p+=String.fromCharCode(o[m+1]);break}}if(m==n){console.log(this.method_debug+"Error : dtm header is too long. \n");return""}return p}else{var n=l.length;for(var m=q;m<n;m++){r=l[m];p+=r;if(r=="\n"){if(n==m+1){console.log(this.method_debug+"Error : invalid dtm file. \n");return""}p+=l[m+1];break}}return p}};this._ensureString=function(n){if(typeof n!=="string"){var q=new Uint8Array(n);var p=32768;var m=0;var o=q.length;var l="";var r;while(m<o){r=q.subarray(m,Math.min(m+p,o));l+=String.fromCharCode.apply(null,r);m+=p}return l}else{return n}};this._ensureBinary=function(l){if(typeof l==="string"){var n=new Uint8Array(l.length);for(var m=0;m<l.length;m++){n[m]=l.charCodeAt(m)&255}return n.buffer||n}else{return l}};this._SurpacCheckSum=function(o,H,N,I){var Q=false;if(o.charAt(H+4)!=","){return true}if(o.length<H+15){return true}var r=o.substr(H+5,8);var E=o.replace(/;/gi,"|");var M="standard";var q=E.indexOf("algorithm");if(q!=-1&&q>14){var K=o.substr(H+13,1);if(K!=="|"){if(K!=="0"){return false}if(o.substr(H+14,1)!="0"){return false}}var u=E.substring(q+9,E.length);var J=u.indexOf("=");var B=u.length;if(J==-1||J+1==B){return false}u=u.substring(J+1,B);J=u.indexOf("|");if(J!=-1){M=u.substring(0,J)}else{M=u}M.trim();if(M!="none"&&M!="standard"){return false}if(M=="none"){return true}}var l=[];var p=E.indexOf("fields");if(p==-1){l.push("y");l.push("x")}else{var u=E.substring(p+6,E.length-2);var J=u.indexOf("=");var B=u.length;if(J==-1||J+1==B){return false}u=u.substring(J+1,B);B=u.length;J=u.indexOf(",");var T="0";while(J!=-1){var T=u.substring(0,J);T.trim();if(T!="x"&&T!="y"&&T!="z"){l.push("0")}else{l.push(T)}B=u.length;u=u.substring(J+1,B);J=u.indexOf(",")}B=u.length;if(u.charAt(B-1)=="\r"){B=B-1}T=u.substring(0,B);T.trim();if(T!="x"&&T!="y"&&T!="z"){l.push("0")}else{l.push(T)}}var n=N.length/3;var w=l.length;var P;var O;var L;var F=0;var D;var G;var X;var S="00000000";var A=[48,48,48,48,48,48,48,48];var Y="0";var U=Y.charCodeAt(0);var R;var s=-1;var C=I.length;var m=0;if(I.length>0){s=I[0]}for(var W=0;W<n;W++){P=N[3*W];O=N[3*W+1];L=N[3*W+2];if(W==s){m++;if(m<C){s=I[m]}else{s=-1}continue}for(var V=0;V<w;V++){if(l[V]=="x"){F=P}else{if(l[V]=="y"){F=O}else{if(l[V]=="z"){F=L}else{F=0}}}D=F.toFixed(3);D=D.replace(".","9");D=D.replace("-","9");D=D.replace(",","9");G=D.length;while(G<8){D="9"+D;G=D.length}for(var t=0;t<8;t++){X=D.charCodeAt(t);R=A[t];A[t]=(R-U+X-U)%10+U}S=String.fromCharCode(A[0],A[1],A[2],A[3],A[4],A[5],A[6],A[7])}}if(r==S){Q=true}return Q};this._errorLoader=function(p,l,o){var n=this;var m=p;console.log("error message="+m+"\n");i.nls("GEOV1Loader/GEOV1Loader_errors",m,function(q){if(q===undefined){m="INTERNAL_ERROR"}if(n.errorCallbackFunc){n.errorCallbackFunc({type:[m],url:[JSON.stringify(l)],rsc:"GEOV1Loader/GEOV1Loader_errors",level:h.error})}if(o==true&&n.renderCallbackFunc){n.renderCallbackFunc({hack:true,updateInfinitePlane:true})}})}};return j});define("DS/GEOV1Loader/GEOMineSchedAnimation2JSON",["DS/ZipJS/zip"],function(b){var a=function(){this.load=function(g,i,e,f){var h=this;var j=g;h._readMineSchedAnimation(j,i,e)};var d=function(g,i,e,h){var f;b.createReader(new b.HttpReader(g),function(j){j.getEntries(function(k){if(k.length){var l;for(var m=0;m<k.length;m++){if(k[m].filename.includes(i)){l=k[m]}}l.getData(new b.TextWriter(),function(n){e(n.currentTarget.result,h);j.close(function(){})},function(o,n){})}})},function(j){console.log("erreur dans createReader")});return f};var c=function(f,e){b.createReader(new b.HttpReader(f),function(g){g.getEntries(function(h){if(h.length){var k=[];for(var l=0;l<h.length;l++){var i=h[l];var j=0;i.getData(new b.TextWriter(),function(m){k[k.length]={name:i.filename,content:m.currentTarget.result};if(k.length==h.length){e(k)}g.close(function(){})},function(n,m){})}}})},function(g){console.log("erreur dans createReader")})};this._readMineSchedAnimation=function(g,h,e){var f;d(g,"results3d.xml",function(i){var j=function(B,s,k){var u={Periods:{"0":{}}};var o=new DOMParser();var t=o.parseFromString(B,"text/xml");var y=t.evaluate("/results3d/period",t,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);var p;var w=[29.9,71.5,106.4,129.2,144,176,135.6,148.5,216.4,194.1,95.6,54.4,29.9,71.5,106.4,129.2,144,176,135.6,148.5,216.4];for(var v=0;v<y.snapshotLength;v++){p=y.snapshotItem(v);var l=t.evaluate("./number",p,null,XPathResult.ANY_TYPE,null);var r=t.evaluate("./start",p,null,XPathResult.ANY_TYPE,null);var q=t.evaluate("./end",p,null,XPathResult.ANY_TYPE,null);var m=l.iterateNext().textContent;var A=r.iterateNext();var x=q.iterateNext();var n=new Date(A.attributes.year.value,A.attributes.month.value,A.attributes.day.value);var z=new Date(x.attributes.year.value,x.attributes.month.value,x.attributes.day.value);u.Periods[m]={startDate:n,endDate:z,data:w[v]}}s(u)};j(i,e,h)},h)}};return a});define("DS/GEOV1Loader/GEOsdmServices",["DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/Utils","DS/GEONavDriveAPI/GEOdriveServices","DS/GEOV1Loader/GEOStyleServices","DS/WebInfraUI/Notification","DS/WebSystem/Nls","DS/GEOV1Loader/GEOConvertLength","DS/WebSystem/Environment"],function(i,d,h,f,c,b,l,j,k,g,a){var e=function(){this.debug=true;this.method_debug="";this.stringsObj3D=[];this.parseTriangulationObjects=function(v,o){var w=this;if(w.debug==true){w.method_debug="parseTriangulationObjects  "}var y=true;var r=[];var t=[];var x=[];var q=[];var n=[];var p=[];var s=new l();if(v.TriangulationObjects==undefined){try{y=w.parseStringObjects(v,n,p,w.stringsObj3D);return y}catch(u){throw u}}var m=0;var u=false;v.TriangulationObjects.forEach(function(H){m++;var D=(H.Name!==undefined)?H.Name:"";var C=w.readFaceStyle(H,D);var z=new i.Color();z.setRGB(C.color_R,C.color_G,C.color_B);var I=[];var F=[];var G=[];if(H.Attributes!=undefined){if(!w.readAttributesFormat(H,I,F,G)){I=[];F=[];G=[]}}var E=[];var B=[];var A=0;if(H.Triangulations!=undefined){H.Triangulations.forEach(function(N){A++;var Q=parseInt(N.Name);if(isNaN(Q)){Q=0}var K=[];var R=[];var J=[];if(N.Attributes==undefined){var T=I.length;if(T==0){y=false;return}for(var M=0;M<T;M++){K[M]=I[M];R[M]=F[M];J[M]=G[M]}}else{if(!w.readAttributesFormat(N,K,R,J)){y=false;return}}if(m<2&&A<2){var O=K.length;console.log("TriangulationObject nbAtts="+O+"\n");for(var M=0;M<O;M++){console.log("Triangulation attribute "+K[M]+" format:"+R[M]+"\n")}}var L=[];try{L=w.readAttributes(N.Data,K,R)}catch(P){console.log("Error attributes TriangulationObject "+m+", Triangulations "+A+".\n");y=false;return}var S=L.length;if(m<2&&A<2){console.log("Triangulation number of data packages= "+S+"\n")}if(S&&m<2&&A<2){console.log("Triangulation attributes "+JSON.stringify(L[0])+"\n")}for(var M=0;M<S;M++){E.push(L[M].V1);E.push(L[M].V2);E.push(L[M].V3)}if(C.visible){r.push(D);t.push(E);x.push(B);q.push(z)}console.log(w.method_debug+"object,Triangulation,nVertices="+m+","+A+","+E.length/3+"\n")})}console.log(w.method_debug+"object,nbTriangulations="+m+","+A+"\n")});console.log(w.method_debug+"countTriangulationObjects="+m+"\n");console.log(w.method_debug+"Trisolation_V.length="+t.length+"\n");if(u){return false}try{y=w.parseStringObjects(v,n,p,w.stringsObj3D);if(!y){return y}}catch(u){throw u}w.buildfaces(t,n,q,o);return y};this.buildfaces=function(D,O,o,A){var n=this;var w=function(Q,U,S){var P;var R=0.000001;var T=Q*Q+U*U+S*S;if(Math.abs(T-1)<R){P=1}else{if(T>R){P=Math.sqrt(T)}}return P};var m=D.length;for(var t=0;t<m;t++){var v=D[t];var E=v.length/3;var u=new Float32Array(E*3*3);var C=new Float32Array(E*3*3);var G=0;var F=0;var B=0;var K;var J;var I;var r;var q;var p;var z;var y;var x;var N;var M;var L;var s;for(var H=0;H<E;H++){B=v[F];u[G]=O[3*B];u[G+1]=O[3*B+1];u[G+2]=O[3*B+2];G=G+3;B=v[F+1];u[G]=O[3*B];u[G+1]=O[3*B+1];u[G+2]=O[3*B+2];G=G+3;B=v[F+2];u[G]=O[3*B];u[G+1]=O[3*B+1];u[G+2]=O[3*B+2];G=G+3;F=F+3}G=0;for(var H=0;H<E;H++){K=u[G];r=u[G+1];z=u[G+2];J=u[G+3];q=u[G+4];y=u[G+5];I=u[G+6];p=u[G+7];x=u[G+8];N=(q-r)*(x-z)-(y-z)*(p-r);M=(y-z)*(I-K)-(J-K)*(x-z);L=(J-K)*(p-r)-(q-r)*(I-K);s=w(N,M,L);C[G]=N/s;C[G+1]=M/s;C[G+2]=L/s;C[G+3]=C[G];C[G+4]=C[G+1];C[G+5]=C[G+2];C[G+6]=C[G];C[G+7]=C[G+1];C[G+8]=C[G+2];G=G+9}A.push(n._createMeshNode(E,u,C,o[t]))}};this._createMeshNode=function(x,v,z,p){var m=new d.PrimitiveGroup();m.fillAttr=new d.FillAttributes();m.lineAttr=new d.LineAttributes();m.pointAttr=new d.PointAttributes();var s=new d.Buffer();s.size=3*3*x;s.component=d.VertexComponentEnum.POSITION;s.format=d.DataTypeEnum.FLOAT;s.dimension=3;s.data=v;var t=new d.Buffer();t.size=3*x;t.component=d.VertexComponentEnum.NORMAL;t.format=d.DataTypeEnum.FLOAT;t.dimension=3;t.data=z;m.addBuffer(0,s);m.addBuffer(1,t);var w=new d.Primitive();w.geomType="FACE";w.nbIndices=3*x;w.connectivity=d.ConnectivityTypeEnum.TRIANGLES;w.attr={fill:new d.FillAttributes(new d.Color(p.r,p.g,p.b,1)),line:new d.LineAttributes(),point:new d.PointAttributes()};var u=new d.VertexComponent();u.component=d.VertexComponentEnum.POSITION;u.nbVertices=3*x;u.nbValuesPerVertex=3;u.format=d.DataTypeEnum.FLOAT;u.cardinality=0;u.bufferId=0;u.indices=null;var y=new d.VertexComponent();y.component=d.VertexComponentEnum.NORMAL;y.nbVertices=3*x;y.nbValuesPerVertex=3;y.format=d.DataTypeEnum.FLOAT;y.cardinality=0;y.bufferId=1;y.indices=null;w.addVertexComponent(u);w.addVertexComponent(y);var r=null;m.addPrimitive(w);var n=h.createMeshNode(m);n.mesh3js.sceneGraph.children[0].solid=1;var A=n.getPrimitives();for(var q=0;q<A.length;q++){var o=A[q].sgNode;o._bNotRecognized=true}return n};this.parseStringObjects=function(s,m,p,n){var t=this;if(t.debug==true){t.method_debug="parseStringObjects  "}var u=true;var q=new l();var o=false;var r=0;s.StringObjects.forEach(function(N){var M=[];var x=[];var E=[];var D=0;r++;var R=(N.Name!==undefined)?N.Name:"";var y=t.readLineStyle(N,R);var A=new i.Color();A.setRGB(y.color_R,y.color_G,y.color_B);var H=new d.Color(y.color_R,y.color_G,y.color_B);o=y.visible;var w=y.width;var J=[];var O=[];var P=[];if(N.Attributes!=undefined){if(!t.readAttributesFormat(N,J,O,P)){J=[];O=[];P=[]}}N.Segments.forEach(function(al){D++;var ai=parseInt(al.Name);if(isNaN(ai)){ai=0}var V=[];var ak=[];var aa=[];if(al.Attributes==undefined){var ag=J.length;if(ag==0){u=false;return}for(var aj=0;aj<ag;aj++){V[aj]=J[aj];ak[aj]=O[aj];aa[aj]=P[aj]}}else{if(!t.readAttributesFormat(al,V,ak,aa)){u=false;return}}if(r<2&&D<2){var ac=V.length;for(var aj=0;aj<ac;aj++){console.log("Segment attribute "+V[aj]+" format:"+ak[aj]+"\n")}}var af="";var ao=false;for(var aj=0;aj<V.length;aj++){if(V[aj]=="X"||V[aj]=="Y"||V[aj]=="Z"){if(!ao){ao=true;af=aa[aj]}else{if(aa[aj]==af){continue}else{throw new Error("PARSE_UNITS")}}}}var ab=[];var ad=[];try{ad=t.readAttributes(al.Data,V,ak)}catch(am){console.log("Error attributes StringObject "+r+", segment "+D+".\n");u=false;return}var W=ad.length;if(r<2&&D<2){console.log("Segment number of data packages= "+W+"\n")}if(W&&r<2&&D<2){console.log("Segment attributes "+JSON.stringify(ad[0])+"\n")}var ae=1000;if(ao&&af.length){ae=g.convertToMM(af);if(ae==undefined){console.log("Error: convert unit "+af+"\n");throw new Error("UNITS_ERROR")}}for(var aj=0;aj<W;aj++){var U=ad[aj].X*ae;var T=ad[aj].Y*ae;var S=ad[aj].Z*ae;if(o){ab.push(new i.Vector3(U,T,S))}m.push(U);m.push(T);m.push(S)}if(r==1&&D==1&&W){var an=a.get("ODT_GEOLOADER_mmValue");if(an!==""&&an!==undefined){var ah=m[0].toString().substring(0,7);if(ah!==an){console.log("Parse StringObjects- conversion error: unit="+af+" scaleToMM="+ae+" , wrong value="+ah+" , expected value="+an+"\n");throw new Error("UNITS_ERROR")}else{console.log("Parse StringObjects- unit checker is successful ("+af+").\n")}}}if(o){M.push(ab);x.push(new i.LineBasicMaterial({color:A,lineWidth:w}))}});if(!u){return}if(o){var B=M.length;var C=new f();C.productType="Reference3D";var Q=[];var v=[];var G=0;for(var L=0;L<B;L++){var F=M[L];if(F.length>1){x[L].force=true;var z=h.createLineNode({points:M[L],material:x[L]});z.mesh3js.sceneGraph.children[0].primitives[0].group.glType=1;n.push(z)}else{var v=[];var G=0;var I=F[0];v[G++]=I.x;v[G++]=I.y;v[G++]=I.z;var z=h.createPointsNode({positions:v,color:H,size:3});z.setPickParent(true);z.mesh3js.sceneGraph.children[0].primitives[0].group.gas.size=3;z.mesh3js.sceneGraph.children[0].primitives[0].group.glType=0;Q.push(z)}}if(Q.length!=0){for(var K=0;K<Q.length;K++){C.addChild(Q[K])}n.push(C)}}});return u};this._ensureString=function(m){if(typeof m!=="string"){var o=new Uint8Array(m);var p="";for(var n=0;n<m.byteLength;n++){p+=String.fromCharCode(o[n])}return p}else{return m}};this.load=function(t,q,A,m,w,v,p){var n=this;n.errorCallbackFunc=(v!==undefined)?v:null;n.renderCallbackFunc=(p!==undefined)?p:null;var B=new f();B.productType="Reference3D";var C=[];var D=[];var o=[];var y=[];var z=function(F){if(m){m({loaded:F.loaded,total:F.total})}};var x=function(F){console.log(F.message);n._errorLoader("LOAD_SDM",t,false)};n.endReader=function(){console.log("GEOVIA loader: number of Triangulations="+C.length+"\n");console.log("GEOVIA loader: number of Strings="+n.stringsObj3D.length+"\n");var G=n.stringsObj3D.length;if(G){for(var F=0;F<G;F++){C.push(n.stringsObj3D[F])}}if(!q.multiLoad){var H=C.length;for(var F=0;F<H;F++){B.addChild(C[F])}if(p){p({hack:true,updateInfinitePlane:true})}if(w){w()}}else{q.itemDoneCB(C)}};var s=function(G){try{if(!n._parse(G,t,C,D,y,o)){n._errorLoader("PARSE_SDM",t,false)}}catch(F){n._errorLoader(F.message,t,false)}};var E="";if(q.multiLoad==true){E=q.path}if(E.length){var u=E.lastIndexOf("/");if(u!=-1){var r=E.lastIndexOf("\\");if(u<r){u=r}n._strPath=E.substring(0,u)}else{var r=E.lastIndexOf("\\");if(r!=-1){n._strPath=E.substring(0,r)}}}b.load(t,E,s,x);if(A&&!q.multiLoad){A(B)}};this._parse=function(p,s,o,n,u,t){var v=this;var q=0;var w=true;if(this.debug==true){this.method_debug="_parse  "}var m;try{m=JSON.parse(v._ensureString(p))}catch(r){console.log("Error JSON.parse\n");console.log(r+"\n");return false}try{if(!v.parseTriangulationObjects(m,o)){return false}}catch(r){throw r}v.endReader();return w};this._errorLoader=function(q,m,p){var o=this;var n=q;console.log("error message="+n+"\n");k.nls("GEOV1Loader/GEOV1Loader_errors",n,function(r){if(r===undefined){n="INTERNAL_ERROR"}if(o.errorCallbackFunc){o.errorCallbackFunc({type:[n],url:[JSON.stringify(m)],rsc:"GEOV1Loader/GEOV1Loader_errors",level:j.error})}if(p&&o.renderCallbackFunc){o.renderCallbackFunc({hack:true,updateInfinitePlane:true})}})};this.readAttributesFormat=function(s,r,q,n){var o=0;var p=false;var m=false;if(s.Attributes==undefined){console.log("Attributes format error \n");return false}s.Attributes.forEach(function(t){if(t.Name==undefined||t.Format==undefined){p=true}else{r.push(t.Name);var v=t.Format.trim();q.push(v);if(v=="int4"){o+=4}else{if(v=="real8"){o+=8}else{if(v=="text"){m=true}else{p=true}}}var u="";if(t.Units!=undefined){u=t.Units.trim()}n.push(u)}});if(p){console.log("readAttributesFormat error \n");return false}return true};this.readAttributes=function(E,r,z){var v=[];var C=r.length;if(C==0){return v}try{var m=atob(E)}catch(B){console.log("Error Attributes\n");console.log(B+"\n");throw (B)}var A=m.length,w=new Uint8Array(A);for(var y=0;y<A;y++){w[y]=m.charCodeAt(y)}var n=new DataView(w.buffer);var u=0;var o=0;var x=false;for(;;){o++;if(A<u+1){break}if(x){break}var q=[];for(var y=0;y<C;y++){if(z[y]=="int4"){try{if(A<u+4){console.log("readAttributes int4 error: data overflow \n");x=true;break}q.push(n.getInt32(u,true));u+=4}catch(B){console.log("readAttributes int4 attpack,i="+v.length+", "+y+"\n");console.log("read error: "+x+"\n");x=true;break}}else{if(z[y]=="real8"){try{if(A<u+8){console.log("readAttributes real8 error: data overflow \n");x=true;break}q.push(n.getFloat64(u,true));u+=8}catch(B){console.log("readAttributes real8 attpack,i="+v.length+", \n");console.log("read error: "+B+"\n");x=true;break}}else{if(z[y]=="text"){if(u==A){break}var s="";for(;;){if(A<u+1){break}var D=w[u++];if(D=="0"){break}else{s+=D}}q.push("empty")}else{console.log("readAttributes error format="+z[y]+"\n");x=true;break}}}}if(x){break}var t='{"';var p=C-1;for(var y=0;y<p;y++){t+=r[y]+'":';if(z[y]=="text"){t+='"'+q[y]+'","'}else{t+=q[y]+',"'}}t+=r[p]+'":';if(z[p]=="text"){t+='"'+q[p]+'"}'}else{t+=q[p]+"}"}v.push(JSON.parse(t))}return v};this.readFaceStyle=function(v,n){var x=this;var p=true;var u="solid";var w=false;var s=false;var m=v.Style;if(m==undefined){console.log("No Style description.\n");s=true}else{if(m.FaceStyle==undefined){console.log("No FaceStyle description.\n");s=true}}if(s){var o=parseInt(n);if(isNaN(o)){o=0}var t=new l();var r=t._getFaceColorDefault(o);var q={visible:p,pattern:u,color_R:r.r,color_G:r.g,color_B:r.b,edgeVisible:w};return q}if(m.FaceStyle.Visible!=undefined){p=m.FaceStyle.Visible}if(m.FaceStyle.FacePattern!=undefined){u=m.FaceStyle.FacePattern}var r=x.readColor(m.FaceStyle,"FaceStyle",n);var q={visible:p,pattern:u,color_R:r.r,color_G:r.g,color_B:r.b,edgeVisible:w};return q};this.readLineStyle=function(v,m){var w=this;var p=false;var u="---";var o=1;var s=false;if(v.Style==undefined){console.log("No Style desciption.\n");s=true}else{if(v.Style.LineStyle==undefined){console.log("No LineStyle description.\n");s=true}}if(s){var n=parseInt(m);if(isNaN(n)){n=0}var t=new l();var q=t._getLineColorDefault(n);var r={visible:p,pattern:u,width:o,color_R:q.r,color_G:q.g,color_B:q.b};return r}if(v.Style.LineStyle.Visible!=undefined){p=v.Style.LineStyle.Visible}if(v.Style.LineStyle.Pattern!=undefined){u=v.Style.LineStyle.Pattern}var o=1;if(v.Style.LineStyle.Width!=undefined){o=v.Style.LineStyle.Width}var q=w.readColor(v.Style.LineStyle,"LineStyle",m);var r={visible:p,pattern:u,width:o,color_R:q.r,color_G:q.g,color_B:q.b};return r};this.readColor=function(z,C,p){var t=false;var s=false;var o=0;var y=0;var A=0;var q=0;var x=new l();if(C=="LineStyle"){t=true}if(C=="FaceStyle"){s=true}if(!t&&!s){var w=new i.Color();w.setRGB(o,y,A);console.log("readColor error style\n");return w}var n=z.Colour;if(z.Colour==undefined){console.log("No Colour desciption.\n");q=parseInt(p);if(isNaN(q)){q=0}if(t){return x._getLineColorDefault(q)}else{return x._getFaceColorDefault(q)}}var m=true;var u,v,B=0;if(z.Colour.R==undefined){m=false}if(m){u=n.R/255;if(z.Colour.G!==undefined){v=z.Colour.G/255;if(z.Colour.B!==undefined){B=z.Colour.B/255}else{m=false}}else{m=false}if(m){o=u;y=v;A=B;var w=new i.Color();w.setRGB(o,y,A);return w}}else{n=n.toLowerCase();return x._computeColor(n)}q=parseInt(p);if(isNaN(q)){q=0}if(t){return x._getLineColorDefault(q)}else{return x._getFaceColorDefault(q)}}};return e});define("DS/GEOV1Loader/GEOstrServices",["DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/Utils","DS/GEONavDriveAPI/GEOdriveServices","DS/GEOV1Loader/GEOStyleServices","DS/WebInfraUI/Notification","DS/WebSystem/Nls"],function(g,d,f,e,b,a,j,h,i){var c=function(){this.debug=true;this.method_debug="";this._hasStyle=false;this._ssiFileName="";this._multiLoad=false;this._strPath="";this.parseStrVertex=function(p,l,o){var t=this;if(t.debug==true){t.method_debug="parseStr  "}var s=this._decodeHeader(p,0);var n=s.length;if(n==0){return false}var q=s.lastIndexOf(".ssi");if(q!=-1){var r=s.lastIndexOf(",");t._ssiFileName=s.substring(r+1,q+4);t._hasStyle=true}s=t._decodeHeader(p,n-1);var m=s.length;if(m==0){return false}var k=false;var r=m-1;if(s.charAt(r)==="\0"){k=true}var u=false;if(k){u=t.parseStrVertex_binary(p,n+m-1,l,o)}else{u=t.parseStrVertex_ascii(t._ensureString(p),l,o)}return u};this.parseStrVertex_binary=function(r,q,k,p){var B=this;if(B.debug==true){B.method_debug="parseStr_binary  "}var s=new DataView(r,q);var n=s.byteLength;var o=s.byteOffset;if(n<33){return false}var l=false;var w=0;var t=s.getInt32(w,l);w=w+4;var m=0;var A=0;var v=0;var u=0;for(;;){if(n<w+28){break}m=s.getInt32(w,l);w=w+4;v=s.getFloat64(w,false);w=w+8;A=s.getFloat64(w,false);w=w+8;u=s.getFloat64(w,false);w=w+8;w=B._skipDescription(s,n,o,w);if(w==-1){break}if(B._END_Description(s,n,o,w)){break}else{if(m==0){k.push(0);k.push(0);k.push(0);p.push((k.length/3)-1)}else{k.push(A);k.push(v);k.push(u)}}}return true};this.parseStrVertex_ascii=function(p,r,m){var o=this;if(o.debug==true){o.method_debug="parseStrVertex_ascii  "}var q=p.split("\n");for(var n=2;n<q.length;n++){var k=q[n];k=k.trim();if(k==="END"){break}var l=k.split(",");if(parseInt(l[0])===0){if(k.endsWith("END")){break}r.push(0);r.push(0);r.push(0);m.push((r.length/3)-1);continue}if(l.length<5){console.log(o.method_debug+" Error: invalid vertex data\n");continue}r.push(parseFloat(l[2]));r.push(parseFloat(l[1]));r.push(parseFloat(l[3]))}return true};this._decodeHeader=function(k,p){if(this.debug==true){this.method_debug="_decodeHeader  "}var o="";if(typeof k!=="string"){var m=Math.min(k.byteLength-p-1,1025);var n=new Uint8Array(k,p,m);var q;for(var l=0;l<m;l++){q=String.fromCharCode(n[l]);o+=q;if(q=="\n"){if(m==l+1){console.log(this.method_debug+"Error : invalid str file. \n");return""}o+=String.fromCharCode(n[l+1]);break}}if(l==m){console.log(this.method_debug+"Error : invalid str file header. \n");return""}return o}else{var m=k.length;for(var l=p;l<m;l++){q=k[l];o+=q;if(q=="\n"){if(m==l+1){console.log(this.method_debug+"Error : invalid str file. \n");return""}o+=k[l+1];break}}return o}};this._skipDescription=function(p,l,m,s){var n=-1;var r=1;var o=0;var t=s;var q=Math.min(l-s-1,1024);if(q==0){return n}var k=new Uint8Array(p.buffer,m+s,q);for(o=0;o<q;o++){r=k[o];if(r==0){n=s+1;break}s++;if(s>l){console.log("_skipDescription error end line ="+o+"\n");n=-1;break}}if(o==q){if(s!=l-1){console.log("_skipDescription error no end line \n")}n=-1}return n};this._END_Description=function(k,n,p,q){q=q-4;var o=new Uint8Array(k.buffer,p+q,3);var l="";for(var m=0;m<3;m++){l+=o[m]&255}if(l=="END"){return true}else{return false}};this._ensureBinary=function(k){if(typeof k==="string"){var m=new Uint8Array(k.length);for(var l=0;l<k.length;l++){m[l]=k.charCodeAt(l)&255}return m.buffer||m}else{return k}};this._ensureString=function(m){if(typeof m!=="string"){var p=new Uint8Array(m);var o=32768;var l=0;var n=p.length;var k="";var q;while(l<n){q=p.subarray(l,Math.min(l+o,n));k+=String.fromCharCode.apply(null,q);l+=o}return k}else{return m}};this.hasStyle=function(){var k=this;return k._hasStyle};this.getStylePathName=function(){var k=this;return k._ssiFileName};this.load=function(r,o,y,k,u,t,n){var l=this;l.errorCallbackFunc=(t!==undefined)?t:null;l.renderCallbackFunc=(n!==undefined)?n:null;var z=new e();z.productType="Reference3D";var A=[];var B=[];var m=[];var w=[];var x=function(D){if(k){k({loaded:D.loaded,total:D.total})}};var v=function(D){console.log(D.message);l._errorLoader("LOAD_STR",r,false)};l.endReader=function(){var I=[];var K=A.length;var F=0;var E=[];for(var J=0;J<K;J++){var D=A[J];if(D.length>1){m[J-F].force=true;if(!o.multiLoad){z.addChild(f.createLineNode({points:A[J],material:m[J-F]}))}else{I.push(f.createLineNode({points:A[J],material:m[J-F]}))}}else{if(D!=-1){var N=[];var M=D[0];N[0]=M.x;N[1]=M.y;N[2]=M.z;var L=f.createPointsNode({positions:N,color:new d.Color(255,0,0),size:3});L.mesh3js.sceneGraph.children[0].primitives[0].group.gas.size=3;L.setPickParent(true);E.push(L)}else{F++;if(E.length!=0){var H=new e();H.productType="Reference3D";for(var G=0;G<E.length;G++){H.addChild(E[G])}z.addChild(H);E=[]}}}}if(!o.multiLoad){if(n){n({hack:true,updateInfinitePlane:true})}if(u){u()}}else{o.itemDoneCB(I)}};var q=function(E){try{if(!l._parse(E,r,A,B,w,m)){l._errorLoader("PARSE_STR",r,false)}}catch(D){l._errorLoader(D.message,r,false)}};var C="";if(o.multiLoad==true){C=o.path}if(C.length){var s=C.lastIndexOf("/");if(s!=-1){var p=C.lastIndexOf("\\");if(s<p){s=p}l._strPath=C.substring(0,s)}else{var p=C.lastIndexOf("\\");if(p!=-1){l._strPath=C.substring(0,p)}}}a.load(r,C,q,v);if(y&&!o.multiLoad){y(z)}};this._parse=function(G,n,u,F,D,y){var l=this;if(this.debug==true){this.method_debug="parseStr  "}var x=false;var k;var E=this._decodeHeader(G,0);var m=E.length;if(m==0){return false}var r=E.lastIndexOf(".ssi");if(r!=-1){var q=E.lastIndexOf(",");k=E.substring(q+1,r+4);x=true}E=this._decodeHeader(G,m-1);var w=E.length;if(w==0){return false}var t=false;if(E.charAt(w-1)==="\0"){t=true}var C=[0,0];var s=true;if(t){s=this._parseBinarySTR(l._ensureBinary(G),m+w-1,u,F,C,D,y)}else{s=this._parseAsciiSTR(l._ensureString(G),u,F,C,D,y)}var v=function(I){if(progressCallback){progressCallback({loaded:I.loaded,total:I.total})}};var p=function(J){console.log(J.message);var L=new j();var I=F.length;for(var K=0;K<I;K++){y[K]=L._getLineDefault(F[K])}l.endReader()};var H=function(I){l._parseSsi(l._ensureString(I),F,C,D,y);l.endReader()};if(x){if(l._strPath.length){k=l._strPath+"/"+k}try{a.load(n,k,H,p)}catch(A){x=false}}if(!x){var o=new j();var z=F.length;for(var B=0;B<z;B++){y[B]=o._getLineDefault(F[B])}l.endReader()}return s};this._parseSsi=function(o,k,l,p,m){var n=new j();n._parseSsi_lines(o,k,l,p,m)};this._parseBinarySTR=function(G,n,w,F,D,E,A){var B=0;var r=0;var s=0;var q=[];var k=new DataView(G,n);var l=k.byteLength;var o=k.byteOffset;if(l<33){return false}var C=false;var p=0;var m=k.getInt32(p,C);p=p+4;var v=0;var u=0;var t=0;for(;;){if(l<p+28){break}r=k.getInt32(p,C);p=p+4;u=k.getFloat64(p,false);p=p+8;v=k.getFloat64(p,false);p=p+8;t=k.getFloat64(p,false);p=p+8;p=this._skipDescription(k,l,o,p);if(p==-1){break}if(this._END_Description(k,l,o,p)){break}else{if(r==0){w.push(q);F.push(B);q=[];s++;if(s==1){D[0]=B;D[1]=B}else{if(B<D[0]){D[0]=B}else{if(B>D[1]){D[1]=B}}}continue}else{B=r;q.push(new g.Vector3(1000*v,1000*u,1000*t))}}}return true};this._parseAsciiSTR=function(r,q,o,k,v,t){var l=r.split("\n");var y=0;var s=0;var w=[];var n=l.length;var u=-1;var m=-1;for(var p=2;p<n;p++){var z=l[p];z=z.trim();if(z==="END"){break}var x=z.split(",");if(parseInt(x[0])==0){if(z.endsWith("END")){break}if(m!==u){q.push([-1]);u=m}q.push(w);o.push(y);w=[];s++;if(s==1){k[0]=y;k[1]=y}else{if(y<k[0]){k[0]=y}else{if(y>k[1]){k[1]=y}}}continue}if(u===-1){u=parseInt(x[0])}m=parseInt(x[0]);y=parseInt(x[0]);if(x.length<5){console.log("_parseAsciiSTR  "+p+" line="+z+"\n");console.log("_parseAsciiSTR Parse str file Error: invalid vertex data\n");continue}w.push(new g.Vector3(parseFloat(x[2])*1000,parseFloat(x[1])*1000,parseFloat(x[3])*1000))}q.push([-1]);return true};this._errorLoader=function(o,k,n){var m=this;var l=o;console.log("GEOstrService error message="+l+"\n");i.nls("GEOV1Loader/GEOV1Loader_errors",l,function(p){if(p===undefined){l="INTERNAL_ERROR"}if(m.errorCallbackFunc){m.errorCallbackFunc({type:[l],url:[JSON.stringify(k)],rsc:"GEOV1Loader/GEOV1Loader_errors",level:h.error})}if(n&&m.renderCallbackFunc){cope.renderCallbackFunc({hack:true,updateInfinitePlane:true})}})}};return c});