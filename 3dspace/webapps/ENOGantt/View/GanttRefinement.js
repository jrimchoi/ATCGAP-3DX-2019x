define("DS/ENOGantt/View/GanttRefinement",["UWA/Core","UWA/Class/View","DS/ENOGantt/Ven/Ext","DS/ENOGantt/GanttUtil","DS/ENOGantt/Controller/MainController"],function(e,a,b,h,d){var i=false;var c=[];var g=[];var k=[];var f=false;var j=a.extend({setup:function(l){var m=this;this.taskModel=l.taskModel;this.taskStore=l.taskStore;this.taskStore.on("filterchange",function(){m.refresh()},this);this.taskStore.on("nodeExpand",function(){m.refresh("nodeExpand")},this);this.taskStore.on("nodeCollapse",function(){m.refresh()},this);this.taskStore.on("commit",function(n){m.refresh()})},resize:function(){},refresh:function(m){if(this.panel.isVisible()){var l=new b.util.HashMap();if(enoviaServer.resetRefinement){delete enoviaServer.resetRefinement}else{l=this.getRefinementSectionExpandCollapseStateMap()}this.panel.removeAll();this.panel.add(this.getFields(null,l))}if(App.Gantt.filter.filterBy.Name&&"nodeExpand"==m){this.taskStore.filterTreeBy()}this.retainSelection()},getRefinementSectionExpandCollapseStateMap:function(){var q=new b.util.HashMap();var m=b.ComponentQuery.query("panel#GanttRefinementPanel")[0];if(m){var p=m.items.items;for(var o=0,n=p.length;o<n;o++){var s=p[o];var r=s.id;var l=s.collapsed;q.add(r,l)}}return q},retainSelection:function(l){if(App.Gantt.filter.filterBy){for(var o in App.Gantt.filter.filterBy){if("Name"===o){continue}var r=App.Gantt.filter.filterBy[o].split("@");var n=App.Gantt.filter.fields[o]["fieldDataType"];if("datefield"==n){b.getCmp(o+"_from_date").setValue(r[0]);b.getCmp(o+"_to_date").setValue(r[1])}else{var t=b.getCmp(o);var s=t.items.items;for(var q=0,m=s.length;q<m;q++){checkBox=s[q];checkBoxValue=checkBox.inputValue;if(r.indexOf(checkBoxValue.toString())>=0){checkBox.setValue(true)}}}}}},render:function(){var l=this;if(!this.panel){var m=App.Nls["emxProgramCentral.gantt.Refinements"];this.panel=b.create("Ext.form.Panel",{title:"<div>"+m+"</div>",xtype:"dpmganttrefinement",id:"GanttRefinementPanel",controller:"GanttViewController",region:"west",store:l.taskStore,width:250,hidden:true,frame:true,scrollable:true,buttons:[{text:App.Nls["emxProgramCentral.Common.Apply"],scope:l,reference:"filter",},{text:App.Nls["emxProgramCentral.Common.Reset"],scope:l,reference:"resetFilter",},{text:App.Nls["emxProgramCentral.Common.Close"],scope:l,reference:"hide",}],beforeShow:function(){l.refresh()}})}},getFieldItems:function(y){var v=this;var s=y.header;var z=y.dataIndex;var u=y.columnDataType;var A=new Array();var t;if("Duration"==z||"Deviation"==z){t=App.Nls["emxProgramCentral.DurationUnits.Days"]}var n=false;if("Deviation"==z){n=true}if(v.taskStore){var x=v.taskStore.collect(z,{allowNull:false,filtered:n});if(x&&x.length>0){A.push({boxLabel:"<div>"+App.Nls["emxProgramCentral.Common.All"]+"</div>",name:z,inputValue:"Select All"});if("Status"==z){for(var m=0,l=x.length;m<l;m++){var o=x[m];var r="";var w=App.Nls["emxProgramCentral.Gantt.TaskStatus."+o];if(w){r='<div class="status '+o+'" style="display:inline-block;position:absolute;top:7px;">&nbsp;</div><div style="display:inline-block;position:absolute;left:35px;top:5px;">'+w+"</div>"}A.push({boxLabel:r,name:"Status",inputValue:o,})}}else{if("Deviation"==z){x=this.getDeviationFilterRangeArray(x,t);b.Array.forEach(x,function(q,p){A.push({boxLabel:"<div>"+q+"</div>",name:z,inputValue:q,})})}else{this.sorteFieldValueArray(u,x,t,z);b.Array.forEach(x,function(q,p){A.push({boxLabel:"<div>"+q+"</div>",name:z,inputValue:q,})})}}}}return A},getDeviationFilterRangeArray:function(p,z){z=" "+z;var G=[];var B=[];var n=[];for(var y=0,x=p.length;y<x;y++){var o=p[y];var l=o.indexOf(z);o=o.substring(0,l);if(o<0){B.push(o)}else{G.push(o)}}if(G.length>0){var A=G[0]+" - "+G[G.length-1]+z;n.push(A)}var u=B[0];var s=B[B.length-1];if(u==s||u>=-4||(r<=4)){var w=u+" - "+s+z;n.push(w)}else{var r=s-u;var t=parseInt(r/4);var q=parseInt(u)+parseInt(t);var F=u+" - "+q+z;var v=parseInt(u)+parseInt(t)*2;var E=(q+1)+" - "+v+z;var m=parseInt(u)+parseInt(t)*3;var D=(v+1)+" - "+m+z;var C=m+" - "+s+z;n.push(F);n.push(E);n.push(D);n.push(C)}return n},sorteFieldValueArray:function(l,q,p,o){if("datefield"==l){q.sort(function(s,r){s=new Date(s);r=new Date(r);return s-r})}else{q.sort(function(s,r){return s-r});if("Duration"==o){p=" "+p.toLowerCase();for(var n=0,m=q.length;n<m;n++){q[n]=q[n]+p}}}},getDateFields:function(p,o){var l=h.getDateFormat();var n=p.dataIndex;var m=p.groupedHeader?p.groupedHeader:p.header;return{xtype:"fieldset",defaultType:"datefield",title:"<div>"+m+"</div>",id:"cid"+n,name:n,collapsible:true,collapsed:o,defaults:{anchor:"100%"},layout:"anchor",items:[{id:n+"_from_date",name:n,anchor:"100%",fieldLabel:App.Nls["emxProgramCentral.Gantt.Refinement.FromDate"],format:l,labelPad:-60,editable:false,},{id:n+"_to_date",name:n,anchor:"100%",fieldLabel:App.Nls["emxProgramCentral.Gantt.Refinement.ToDate"],format:l,labelPad:-60,editable:false,}]}},getFields:function(m,o){var p=this;if(!m){m=App.Infra.Columns}var l=new Array();var n=false;var q=enoviaServer.viewId;b.Array.forEach(m,function(C,x){if(!C.excludeInRefinement){var z=C.name;if((q&&q=="WBSView")&&(z&&(z=="BaselineStartDate"||z=="BaselineEndDate"||z=="BaselineDuration"))){return}else{if((q&&q!="PlannedVsActualView")&&C.hidden){return}}if(C.columns){for(var t=0,s=C.columns.length;t<s;t++){var r=C.columns[t];if(!r.groupedHeader){r.groupedHeader=C.text+" "+r.header}}l=l.concat(p.getFields(C.columns,o))}else{if(C&&!C.excludeInRefinement){var w=(App.Gantt.filter.filterBy&&(C.dataIndex in App.Gantt.filter.filterBy))?"selected-fieldset":"";var y=z;if("datefield"==C.columnDataType){y="cid"+z}var A=o.get(y);if(A==undefined){if(z==="Type"||z==="State"||z==="Status"){A=false}else{A=true}}if("datefield"==C.columnDataType){var v=p.getDateFields(C,A);v.cls=w;l.push(v)}else{var B=p.getFieldItems(C);if(B&&B.length>0){var u=C.groupedHeader?C.groupedHeader:C.header;l.push({xtype:"fieldset",cls:w,title:"<div>"+u+"</div>",id:C.dataIndex,name:C.dataIndex,collapsible:true,collapsed:A,defaultType:"checkbox",layout:"anchor",items:B,defaults:{anchor:"100%",listeners:{change:function(K,J,G,I){var H=b.getCmp(K.getName()).items.items;if(K.inputValue=="Select All"){if(J==true){for(var E=0,D=H.length;E<D;E++){var F=H[E];F.setValue(true)}}else{if(!f){for(var E=0,D=H.length;E<D;E++){var F=H[E];F.setValue(false)}}}f=false}else{if(J==false){f=true;var F=H[0];F.setValue(false)}}}}},})}}App.Gantt.filter.fields[C.dataIndex]={fieldLabel:C.columnLabel,fieldDataType:C.columnDataType,}}}}});return l},});return j});