define("DS/ENOGantt/View/FindResource",["UWA/Class","DS/Foundation2/FoundationV2Data","DS/ENOGantt/Data/ResourceStore","DS/ENOGantt/Data/ResponseUtil"],function(a,d,f,e){var c;try{c=a.extend({init:function(){that=this;var g=new f();that.resourceStore=Ext.create("DS.ENOGantt.Data.ResourceStore",{storeId:"resourceStore"});Ext.define("DS.ENOGantt.View.FindResource",{extend:"Ext.form.field.ComboBox",xtype:"dpmfindresourceview",store:that.resourceStore,displayField:"title",emptyText:App.Nls["emxProgramCentral.Gantt.ResourceUtilization.FindResource.PlaceholderText"],typeAhead:false,minChars:3,hideLabel:true,hideTrigger:true,width:"100%",anchor:"100%",displayField:"Name",valueField:"UserName",queryCaching:false,listeners:{beforequery:function(h){var j=h.query;if(j){var i=/^([A-Za-z\d\-_.]+(\s[A-Za-z]+)?)+$/i;return i.test(j)}return false},select:function(j,h,i){that.assignResource(h);j.clearValue()},}})},assignResource:function(m){var q=this;var t=Ext.ComponentQuery.query("#dpmprojectgantt")[0];var h=Ext.ComponentQuery.query("#dpmresourceutilizationpanel")[0];var o=m.get("Id");var k=t.resourceStore.getModelById(o);if(k){Ext.Msg.alert(App.Nls["emxProgramCentral.Gantt.ResourceUtilization.AddAssignment.Alert.Header"],App.Nls["emxProgramCentral.Gantt.ResourceUtilization.AddAssignment.Alert.Body"].replace("{PERSON_NAME}",m.get("Name")),Ext.emptyFn);combo.clearValue();return}var i=h.context;var l=i.get("Id");var p=i.get("TaskProjectId");var n=t.taskStore.getModelById(p);var s=n.get("StartDate").getTime();var j=n.get("EndDate").getTime();this.data={taskId:l,taskProjectId:p,projectStart:s,projectEnd:j,};var r={id:p,updateAction:"NONE",relateddata:{tasks:[]}};r.relateddata.tasks.push({id:l,updateAction:"MODIFY",relateddata:{assignees:[{updateAction:"CREATE",relelements:{allocation:"100"},dataelements:{},id:o,}]}});var g={};g.data=[r];g.csrf={name:App.csrf.name,value:App.csrf.value,};var u="/resources/v1/modeler/projects/"+p+"?$include=none,assignees,Assignments&$fields=none,Assignments.TaskId,Assignments.Id,Assignments.allocation,Assignments.icon,Assignments.TaskProjectId,Assignments.Name,Assignments.percentComplete,Assignments.estimatedStartDate,Assignments.dueDate,Assignments.estimatedDurationInputValue,Assignments.owner,assignees.name,assignees.Id,assignees.WorkTime,assignees.firstname,assignees.lastname,assignees.icon";d.ajaxRequest({url:u,data:JSON.stringify(g),type:"PUT",dataType:"json",callback:function(B){var Y=q.data.taskProjectId;var T=q.data.projectStart;var M=q.data.projectEnd;var ap=B.data[0].relateddata.assignees;var ap=B.data[0].relateddata.tasks[0].relateddata.assignees;var R=ap.length;var w=[];var v=[];var L=[];for(var ak=0;ak<R;ak++){var S=ap[ak];var N=S.dataelements;N.FirstName=N.firstname;N.LastName=N.lastname;N.Name=N.name;delete N.firstname;delete N.lastname;delete N.name;if(S.relateddata.calendar&&S.relateddata.calendar.length>0){if(S.relateddata.calendar[0].relateddata.EventInfo){var ae=S.relateddata.calendar[0].relateddata.EventInfo;var x=[];for(var ak=0,aj=ae.length;ak<aj;ak++){var ar=ae[ak];var W=ar.relelements;var J=W.workStartTime;var U=W.workFinishTime;var V=W.lunchStartTime;var am=W.lunchFinishTime;var C=W.weekDay;if(J.length<4){J="0"+J}if(U.length<4){U="0"+U}if(V.length<4){V="0"+V}if(am.length<4){am="0"+am}var an=W.exceptionType;var al=true;J=J.substring(0,2)+":"+J.substring(2);U=U.substring(0,2)+":"+U.substring(2);V=V.substring(0,2)+":"+V.substring(2);am=am.substring(0,2)+":"+am.substring(2);var ai=J+"-"+V;var ag=am+"-"+U;if("Working"!=an){al=false}var P={Type:"WEEKDAY",Weekday:C-1,availability1:ai,availability2:ag,isWorkingDay:al};x.push(P)}N.CalendarInfo=x}}var af=N.WorkTime;if(!af){N.WorkTime=parseFloat("8.0")}else{N.WorkTime=parseFloat(af)/60}var G=N.Id;var X="Custom:"+G;N.CalendarId=X;w.push(N);var F=S.relateddata.Assignments;if(F.length>0){var aa=F[0].dataelements;var A=aa.contextUser;for(var aj=1;aj<F.length;aj++){var K=F[aj];var Z=K.dataelements;var I=K.relelements;e.convertToGanttKeyValues(Z);e.convertToGanttKeyValues(I);var aq=new Date(Z.StartDate);var Q=new Date(Z.EndDate);aq=aq.getTime();Q=Q.getTime();if(aq<T||Q>M){continue}var D={};D.TaskId=Z.TaskId;var ah=Z.Owner;if(ah==A){D.isReadOnly=false}else{D.isReadOnly=true}var at=K.type;if(aa[at]){D.icon=aa[at]}D.Id=I.Id;D.Units=I.allocation;D.ResourceId=G;var ad=Z.TaskProjectId;if(ad==Y){D.Type="Internal"}else{var ac={};D.Type="External";ac.Id=Z.TaskId;ac.Name=Z.Name;ac.PercentDone=Z.PercentDone;ac.Duration=Z.Duration;if(Z.StartDate){Z.StartDate=Ext.Date.format(new Date(Z.StartDate),"c")}if(Z.EndDate){Z.EndDate=Ext.Date.format(new Date(Z.EndDate),"c")}ac.StartDate=Z.StartDate;ac.EndDate=Z.EndDate;ac.expanded=true;L.push(ac)}v.push(D)}}}var E=t.taskStore.data.items[0];var z=L.length;if(z>0){for(var ak=0;ak<z;ak++){var O=L[ak];var ab=O.Id;var ao=t.taskStore.getModelById(ab);if(ao==null&&O.Name!="root"){O.visible=false;O.Id=ab;O.Rollup=false;O.ReadOnly=true;O.ExternalTask=true;O.expanded=true;var y=Ext.create("DS.ENOGantt.Data.TaskModel",O);App.Infra.ExtTaskArray.push(y);E.addTaskBelow(y);E.nextSibling="";t.taskStore.commitChanges()}}}var H=v.length;if(w.length>0){t.taskStore.resourceStore.add(w)}if(v.length>0){t.taskStore.assignmentStore.add(v)}t.taskStore.resourceStore.commitChanges();t.taskStore.assignmentStore.commitChanges();t.taskStore.commitChanges();t.taskStore.filterBy(function(au){if(au.get("ExternalTask")){return false}return true})}})}})}catch(b){console.log("::::::::error")}return c});