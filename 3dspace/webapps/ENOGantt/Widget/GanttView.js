define("ENOGantt/Widget/GanttView",["UWA/Core","DS/E6WCommonUI/Views/DetailsDisplayView","DS/E6WCommonUI/Views/FoundationBaseView","DS/Foundation2/Models/ReferenceModel","DS/Foundation2/FoundationV2Data","DS/UIKIT/Mask","ENOGantt/Widget/PreferenceUtils","DS/E6WCommonUI/UIHelper","DS/UIKIT/Alert","DS/ENO6WPlugins/jQuery","css!ENOGantt/GanttWidget.css",],function(d,n,h,p,e,y,l,r,f,i){var w="savedObject";var q="savedTitle";var o="savedTenant";var x="Project Space";var v="bordered";var g=e.getWidgetConstant;var j=function(){return[{readWrite:"true",name:"project",attributeToDisplay:"name",imageAttribute:"image",singleObjectOnly:true,searchTypes:x,validTypes:x,searchTitle:"Project Search",typeAheadCallback:p.typeAheadCallback,type:"object"}]};var s=p.extend({dataForRendering:function(){return{canEdit:true}},add:function(A,z){this._fireRelationshipChangeEvents(A,z,true)}});var k=h.extend({_uwaClassName:"GanttView",className:"gantt-view",id:function(){return"ganttView"},domEvents:{"dragenter ":"handleDragEnter","dragover ":"handleDragOver","dragleave ":"handleDragLeave","drop ":"handleDrop","dragend .drop-target":"handleDragEnd"},setup:function(){this._parent.apply(this,arguments);this.model=new s();this._firstGanttLoad=true;this._ganttElement=d.createElement("iframe",{id:"projectGantt",src:this._getSrc()});this._searchBar=new n({model:this.model,id:"projectSpaceSearch",});this._searchBar.setConfig(j());this.listenTo(this._ganttElement,"load",this._onGanttIFrameLoad.bind(this));this.listenTo(this.model,"onChange:project",this._onProjectSelected);var z={autoHide:true,closable:true};this.alerter=new f(z);l.get(w)?this.addClearProjectPreference():this.removeClearProjectPreference();this.listenTo(widget,"endEdit",this.onPreferencesChanged)},render:function(){this.container.empty();this.alerter.inject(this.container);if(l.get(w)){this._renderProjectGantt()}else{this._renderProjectSearch()}return this},reset:function(){l.set(w,false);this.removeClearProjectPreference();this.render()},_getSrc:function(){return e.calculateFinalUrl("/common/emxFrameworkContextManager.jsp?forwardUrl=/programcentral/emxProgramCentralWhatIfAnalysis.jsp?mode=GanttChart&fromIFWE=true&objectId="+l.get(w))},_onGanttIFrameLoad:function(){if(this._firstGanttLoad){delete this._firstGanttLoad;this._ganttElement.setAttribute("src","");this._ganttElement.setAttribute("src",this._getSrc())}else{this._hideLoadingMessage()}},_renderProjectGantt:function(){widget.setTitle(l.get(q));this._ganttElement.inject(this.container);this._showLoadingMessage()},_renderProjectSearch:function(){widget.setTitle("");this._searchBar.render().inject(this.container);this._changeAutoCompleteDisplaySettings();this._searchBar.container.toggleClassName("fluid-width",true);this._searchBar.container.toggleClassName("visible",true);this._searchBar.container.toggleClassName("ds-detail-display",false);this.refreshPlaceHolderText()},_changeAutoCompleteDisplaySettings:function(){var z=this._searchBar.getElement("input");var A=this._searchBar.getElement(".chooser");i(z).autocomplete("option","position",{my:"left-1.5 top",at:"left bottom",of:A,collision:"fit",within:this.container})},_onProjectSelected:function(B,A){var z=this;e.ajaxRequest({url:"/resources/v2/e6w/service/ObjectInfo/"+A+"?$fields=objectId",callback:function(D){var C=d.is(D,"object")?D:JSON.parse(D);if(C.data[0].id&&C.data[0].id!==l.get(w)){l.set(w,C.data[0].id);l.set(q,C.data[0].dataelements.title);z.addClearProjectPreference();z._ganttElement.setAttribute("src",z._getSrc());z.render()}}})},_showLoadingMessage:function(){y.mask(this.container)},_hideLoadingMessage:function(){y.unmask(this.container)},refreshPlaceHolderText:function(){var z=this._searchBar.getElement("input[type=text]");if(!z){return}z.setAttribute("placeholder",g("emxProgramCentral.GanttView.SearchForProject","Search for Project..."))},destroy:function(){this._ganttElement.destroy();this._searchBar.destroy();delete this._ganttElement;delete this.searchBar;this._parent.apply(this,arguments)},handleDragEnter:function m(){l.get(w)&&this.container.addClassName(v)},handleDragLeave:function b(){this.container.removeClassName(v)},handleDrop:function c(A){if(A.stopPropagation){A.stopPropagation()}if(A.preventDefault){A.preventDefault()}this.container.removeClassName(v);var z=r.getDataTransferJSON(A.dataTransfer);if(z){this.processDropData(z)}return false},handleDragEnd:function a(){this.container.removeClassName(v)},handleDragOver:function u(z){if(z.preventDefault){z.preventDefault()}z.dataTransfer.dropEffect="copy";l.get(w)&&this.container.addClassName(v);return false},processDropData:function t(A){var B=A.data.items[0],z=B.displayName;if(z&&z.length>0){if(B.objectType!=="Project Space"){this.alerter.add({message:g("emxProgramCentral.GanttView.NotProjectSpace","A Project Space must be dropped on to the gantt chart."),className:"error"});this.alerter.show()}else{this._onProjectSelected("",B.objectId)}}},addClearProjectPreference:function(){var z={name:"reset",type:"boolean",label:g("emxProgramCentral.GanttView.ClearProject","Clear selected project"),defaultValue:"",};widget.addPreference(z);widget.setValue("reset","")},removeClearProjectPreference:function(){var z={name:"reset",type:"hidden",label:g("emxProgramCentral.GanttView.ClearProject","Clear selected project"),defaultValue:"",};widget.addPreference(z)},onPreferencesChanged:function(){if(widget.getValue("reset")!=="false"&&widget.getValue("reset")!==false){this.reset()}}});k.SAVED_OBJECT_PREFERENCE=w;k.SAVED_TENANT_PREFERENCE=o;return k});