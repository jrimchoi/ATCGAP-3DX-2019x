define("DS/WAfrContainer/Container",["UWA/Core","UWA/Class/Promise","DS/Core/Core","DS/WAfrExecutionContext/mod_ExecutionContext","DS/PlatformAPI/PlatformAPI","DS/WAfrUtils/Logger","DS/WAfrUtils/PerformanceHelper","WebappsUtils/WebappsUtils","DS/WAFData/WAFData"],function(d,g,f,k,i,j,a,c,h){var e=k.ExecutionContext;var b=function(n){var l={view:null,debug:false,infraComponents:[],proxified:false,baseUrl:c.getWebappsBaseUrl()};var o=l;o=d.extend(d.clone(l),n);this._proxified=o.proxified;this._view=o.view;if(!this._view){throw new Error("A view must be defined for the container")}this.id=this._view.getId();this._executionContexts=[];this._currentExecutionContext=-1;this._config=o.config;this._registeredInfraComponents=o.standardComponents;this._baseUrl=o.baseUrl;this._version=null;var m=this.destroy.bind(this);this._view.addEvent("onDestroy",m);this._restoreContextsIfNeed();var p=this;this.subscribe("onCreateContext."+this.id,function(q){p.createNewExecutionContext();p.loadCurrentConfig(q)});Object.defineProperty(this,"currentApp",{get:function(){var r=this.getCurrentExecutionContext();if(r){var q=r.getSourceApp();if(q){return q}}return undefined}});Object.defineProperty(this,"lang",{get:function(){return this._view.getLanguage()}});Object.defineProperty(this,"productTitle",{get:function(){return this._view.getValue("afrProductTitle")}})};b.prototype.destroy=function(){this._executionContexts.map(function(l){return l.dispose()});this._executionContexts=[];this._currentExecutionContext=-1;this._view.setValues({afrCode:undefined,afrAppId:undefined,appId:undefined,title:undefined,afrDebug:undefined,components:undefined});this._view.destroy();return g.resolve()};b.prototype._restoreContextsIfNeed=function(){var p=this._view.getValue("afrExecutionContexts")||[];var l=this._view.getValue("afrCurrentExecutionContextIdx")||0;var o=this._view.getValue("afrAppId");if(p.length>0&&!o){j.warn("A context has been found "+JSON.stringify({contexts:p})+" but the app id is null,Ignore the restoration of the saved context");p=[]}if(p.length===0){var n=this.createNewExecutionContext();p.push({id:n.getId(),currentappId:null});l=this._currentExecutionContext}else{var m=0;for(m=0;m<p.length;m++){this.createNewExecutionContext(p[m].id)}if(l<0||l>=p.length){throw new Error("The current context index must be in the range of the list of contexts")}this._currentExecutionContext=l}this._view.setValue("afrExecutionContexts",p.slice());this._view.setValue("afrCurrentExecutionContextIdx",l);this._view.setValue("afrAppId",o)};b.prototype.createNewExecutionContext=function(m){var l=new e({id:m,container:this,config:this._config});this._executionContexts.push(l);this._currentExecutionContext=this._executionContexts.length-1;this._view.addExecutionContextView(l,this.onChangeExecutionContext.bind(this));return l};b.prototype.onChangeExecutionContext=function(l){};b.prototype.requestWAfrService=function(u,t){if(!this._configService){return g.resolve()}if(t&&!u){throw new Error("Must provide an app id to call the transition service")}u=u||this._configService.afrAppId||this._configService.appId;var v=this._configService.afrService;var l="GET";var q;if(t){v=v.replace("/apps","/transition");l="POST";q={containers:[{id:this.id,contexts:this._view.getValue("afrExecutionContexts"),currentIndex:this._view.getValue("afrCurrentExecutionContextIdx")}],currentIndex:0}}v+=u;if(!v.startsWith("http")){var s=this._baseUrl;var m=s.split("/");if(m.length>=2){var r=m[2].split(":");var p=r[0];var n="";if(r.length>1&&!this._configService.afrServicePort){n=":"+r[1]}if(this._configService.afrServicePort){n=":"+this._configService.afrServicePort}v=m[0]+"//"+p+n+"/"+v}}if(this.lang){v+="?lang="+this.lang}var o=this._proxified?"proxifiedRequest":"request";return new g(function(x,w){h[o](v,{type:"json",responseType:"json",method:l,data:q,onComplete:function(y){x(y)},onFailure:function(y){y.url=v;w(y)}})})};b.prototype.loadCurrentConfig=function(n){a.checkpoint("requestWAfrService");var l=n||this.getCurrentConfig();this._configService=null;if(l.afrService){this._configService=l}if(!l.title||l.title==="Apps supporting transition"){l.title=this._view.getTitleHeader().appTitle}var m=this.getCurrentExecutionContext();return this.requestWAfrService().then(function(o){a.checkpoint("requestWAfrService");return m.load(o||l)})};b.prototype.launchApp=function(n,m){var l=this.id;return new g(function(p,o){var q="DS/i3DXCompassServices/i3DXCompassPubSub";require([q],function(r){r.subscribe("launchAppCallback",function(t){if(t.response==="COMPLETE"){p()}else{o()}});var s={widgetId:l,appId:n};s=d.extend(s,m);r.publish("launchApp",s)})})};b.prototype.getCurrentConfig=function(){var l=d.clone(this._view.getValues());var m=this._view.getTitleHeader();l.appId=this._view.getValue("afrAppId")||this._view.getValue("appId");l.title=this._view.getValue("title")||this._view.getTitle();if(l.title===l.brand){l.title=m.appTitle}return l};b.prototype.publish=function(l,m){i.publish(l,m)};b.prototype.subscribe=function(l,m){i.unsubscribe(l);i.subscribe(l,m)};b.prototype.getCurrentExecutionContext=function(){if(this._currentExecutionContext<0){return null}return this._executionContexts[this._currentExecutionContext]};b.prototype.registerInfraComponents=function(o){for(var n=0;n<this._registeredInfraComponents.length;n++){var l=this._registeredInfraComponents[n];var m=l.DEFAULT_COMPONENT_NAME;o.createAndRegisterComponent(m,l,{container:this})}};b.prototype.updateTitle=function(l,m){if(!m){const n=this.getCurrentExecutionContext();if(n){m=n.getTargetApp()||n.getSourceApp()}}if(m){l.appTitle=l.appTitle||m.getTitle()||this._view.getValue("title");l.brand=l.brand||m.getBrand()||this._view.getValue("brand")}this._view.setValue("afrProductTitle",l.title);this._view.setTitleHeader(l)};return b});