/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedDataLauncher/CATRelatedDataController",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/Core/Events","DS/WAFData/WAFData","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADWSAccess"],function(g,a,l,e,d,k,j,h,b,m){var f=a.extend({init:function(S){var t=S||{};this._parent(t);var D;var y;var I=S.ctxViewer;var o=null;var B=[];var Q=[];var x=0;var R;var E=new l.Vector3(),F=new l.Vector3();var A=new l.Matrix4(),N=new l.Matrix4();var q,r=null;var z,P;var M;this.setActiveState=function(T){if(D===T){return}if(!I){D=false;return}D=T;if(y){if(D){L()}else{H(true)}}};this.getActiveState=function(){return D};this.clearController=function(){this.setActiveState(false);o=B=I=E=A=q=null;F=r=N=y=Q=M=null};this.setVisibility=function(U){if(o&&D&&y){var T=null;if(U){for(var X=0;X<B.length;X++){var W=B[X].pickPath.getWorldMatrix(I.getViewer());var V=new l.Matrix4().multiplyMatrices(W,B[X].localMatrix);T=new l.Vector3().getPositionFromMatrix(V);B[X].position.copy(T)}}o.setDataLauncherPosition(T);o.setVisibleFlag(U)}};this.displayDataLauncher=function(T){if(y===T){return}y=T?true:false;if(y&&D){L()}else{H(true)}};this.isDisplayed=function(){return y};function w(U,V,T){h.getSecurityContext(function(X){V.headers.SecurityContext=X.securityContext;var W=h.get3DSpaceUrl()+U;if(T){W+="?SecurityContext="+X.securityContext}k.authenticatedRequest(W,V)})}function G(U){var T={input_physical_ids:U.physicalIDs,primitives:[{navigate_from_rel:{id:1,filter:{rel_type:["XCADBaseDependency"]}},navigate_from_sr:{id:2}}],patterns:{relatedXCADDrw:[{id:1}],relatedDrw:[{id:2}]},patternTypeFilters:{relatedXCADDrw:{typesToNotReturn:["XCADNonPSBaseRepReference"]},relatedDrw:{typesToNotReturn:["PGPRep","VPMPort"]}},version:3,attributes:["ds6w:label","ds6w:modified","ds6w:created","ds6w:type"],fileAttributes:["svg","preview_url","thumbnail_2d","icon"],label:"CATRelatedDataDrawingsNav"};var V={data:JSON.stringify(T),timeout:parseInt(j.getSetting("webapi_timeout"),10),method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":j.getSetting("lang")},onComplete:function(Y){var W=[];var ab=JSON.parse(Y);if(ab&&ab.result&&ab.result.length){for(var X=0;X<ab.result.length;X++){if((ab.result[X].outputs&&ab.result[X].outputs.relatedXCADDrw&&ab.result[X].outputs.relatedXCADDrw.length)||(ab.result[X].outputs&&ab.result[X].outputs.relatedDrw&&ab.result[X].outputs.relatedDrw.length)){var aa=ab.result[X].outputs.relatedXCADDrw?ab.result[X].outputs.relatedXCADDrw:ab.result[X].outputs.relatedDrw;for(var Z=0;Z<aa.length;Z++){if(aa[Z]&&aa[Z].physicalid&&aa[Z].svg&&(aa[Z]["ds6w:type"]==="Drawing"||aa[Z]["ds6w:type"]==="CATDrawing")){W.push(aa[Z])}}}}}U.callbacks.onComplete(W)},onFailure:U.callbacks.onFailure,onTimeout:U.callbacks.onFailure};w("/cvservlet/navigate",V,true)}function p(W){var V="";for(var U=0;U<W.physicalIDs.length;U++){V+="physicalid:"+W.physicalIDs[U];if(U!==W.physicalIDs.length-1){V+=" OR "}}var T={query:V,intent:"stream_2D",order_by:"asc",order_field:"update",nresults:1,tenant:h.getPlatformId(),authored:true,label:"CATRelatedDataLayoutsNav"};var X={data:JSON.stringify(T),method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":j.getSetting("lang")},onComplete:function(Y){var ac={ids:[]};var af=JSON.parse(Y);for(var ag=0;ag<af.results.length;ag++){var aa,ad,ae,ab;for(var Z=0;Z<af.results[ag].attributes.length;Z++){if(af.results[ag].attributes[Z].name==="physicalid"){ae=af.results[ag].attributes[Z]}if(af.results[ag].attributes[Z].name==="streamName"){ad=af.results[ag].attributes[Z]}if(af.results[ag].attributes[Z].name==="streamType"){aa=af.results[ag].attributes[Z]}}if(aa&&aa.value.indexOf("SVG")!==-1){ab=aa.value.indexOf("SVG");ac.ids.push({id:ae.value,what:{name:"DerivedOutput",data:[{streamType:aa.value[ab],streamName:ad.value[ab]}]}})}}if(ac.ids.length){w("/resources/enopad/navigate/getstreamurl",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":j.getSetting("lang")},data:JSON.stringify(ac),onComplete:W.callbacks.onComplete,onFailure:W.callbacks.onFailure})}},onCancel:W.callbacks.onFailure,onFailure:W.callbacks.onFailure};w("/resources/enopad/lwc/fetch",X)}var J=function(V){if(o&&B.length&&V&&V instanceof Array){for(var T=0;T<V.length;T++){for(var U=0;U<B.length;U++){if(V[T].isAParentOf(B[U].pathElement)){v(B[U].pathElement)}}}}};var C=function(ac){if(D&&y){if(!M){var W=ac;require(["DS/CATRelatedDataLauncher/CATRelatedDataLauncher","i18n!DS/CATRelatedDataLauncher/assets/nls/CATRelatedDataLauncher"],function(ak,ai){M=ak;z=ai.NameUnknownLbl;P=ai.DateUnknownLbl;if(W&&W.pathElement){var ah=e.get();for(var aj=0;aj<ah.length;aj++){if(ah[aj].pathElement.isEqual(W.pathElement)){C(W)}}}});return}if(!M){return}if(ac.event&&ac.event.offsetPosition&&ac.event.offsetPosition.x!==0&&ac.event.offsetPosition.y!==0){if(o){o.clear()}return}if(ac.pathElement&&(!ac.pathElement.getLastElement(true)._getExcludeFromCSO||!ac.pathElement.getLastElement(true)._getExcludeFromCSO())){var ad=O(ac.pathElement);var ae=n(ac.pathElement);if(!ac.event||s(ac.pathElement)!==-1||(!ad&&!ae)){return}if(!o){o=new M({viewer:I.getViewer(),window:I.getFrameWindow()});o.subscribe("onRelatedDataSelected",function(ah){h.getSecurityContext(function(ai){var al=[],ak;for(var aj=0;aj<ah.length;aj++){ak={protocol:"3DXContent",version:"0.1",source:"X3DCSMA_AP",data:{items:[{envId:h.getPlatformId(),contextId:ai.securityContext,serviceId:"2DLayout",asset:{filename:ah[aj].urlDerivedOutput,format:"svg",provider:"FILE"},experience:"3DPlayDocumentViewer"}]}};al.push({id:ah[aj].appId,title:ah[aj].NLSType+" - "+ah[aj].title,data:{x3dSharedId:widget.getValue("x3dSharedId"),x3dPlatformId:widget.getValue("x3dPlatformId"),X3DContentId:JSON.stringify(ak)}})}require(["DS/TransientWidget/TransientWidget"],function(am){if(al.length===1){am.showWidget(al[0].id,al[0].title,al[0].data)}else{if(al.length>1){am.showWidget(al)}}})})})}var ag=ac.event.currentPosition?ac.event.currentPosition:(ac.event.from?ac.event.from[0].currentPosition:new l.Vector2(0,0));var X=I.getViewer().getMousePosition(ag);var T=I.getViewer().pick(X,"primHybrid",false);F=new l.Vector3().copy(T.position?T.position:F);var V=new l.Matrix4().makeTranslation(F.x,F.y,F.z);var aa=ac.pathElement.getWorldMatrix(I.getViewer());aa.getInverse(aa);N=new l.Matrix4().multiplyMatrices(aa,V);r=ac.pathElement.clone();var U=0;var Y=0;if(x){clearTimeout(x);x=0}x=setTimeout(function(){if(o){o.clearIfWaiting()}var ah=1;while(ah){ah=s(ac.pathElement);if(ah!==-1){Q.splice(ah,1)}else{ah=null}}},15000);E.copy(F);A.copy(N);q=r.clone();o.setDataLauncherPosition(E);o.show();var ab=function(){if(!o){return}o.hideSpinner();Y++;if(Y===U){var ah=s(ac.pathElement);if(ah!==-1){Q.splice(ah,1)}}};var Z=ad?b.getNodeID(ad):null,af=ae?b.getNodeID(ae):null;if(af){Q.push(ac.pathElement.clone());o.displaySpinner();U++;p({physicalIDs:[af],callbacks:{onComplete:function(ah){if(!o){return}var ai=JSON.parse(ah);if(ai&&ai.results&&ai.results.length&&ai.results[0].what&&ai.results[0].what.data&&ai.results[0].what.data.length&&ai.results[0].what.data[0].streamURL){m.fetch({enopad_webapis:require("DS/PADUtils/PADSettingsMgt").getSetting("enopad_webapis"),pids:[Z,af],data:{intent:"explore_2D",select_file:["preview_url","thumbnail_2d","icon"],select_predicate:["ds6w:label","ds6w:modified","ds6w:created"]},onComplete:function(al){if(!o){return}var an=JSON.parse(al),ak={};((an&&an.results)||[]).forEach(function(au){if(!au||!au.attributes){return}var aq,ap,at={};for(var ar=0,ao=au.attributes.length;ar<ao;++ar){ap=au.attributes[ar];if(ap.name==="resourceid"){aq=ap.value}else{if(ap.name==="assembly_cgr"){at.cgr=ap.value}else{at[ap.name]=ap.value}}}if(aq){ak[aq]=at}});if(ak[Z]){var aj={};aj.type="LayoutPreview";aj.appId="X3DPLAW_AP";aj.appIcon=ak[af].preview_url||ak[af].thumbnail_2d;aj.typeIcon=ak[af].type_icon_url;aj.pathElement=ac.pathElement;aj.title=ak[Z]["ds6w:label"]||z;var am=ak[Z]["ds6w:modified"]?ak[Z]["ds6w:modified"]:ak[Z]["ds6w:created"];aj.modifDate=am?g.String.parseRelativeTime(am):P;if(!aj.modifDate){aj.modifDate=am?am:P}aj.urlDerivedOutput=ai.results[0].what.data[0].streamURL;aj.tileId=aj.type+"_"+aj.appId+"_"+aj.urlDerivedOutput;K([aj],ac.pathElement)}ab()},onFailure:ab})}},onFailure:ab}})}if(Z){Q.push(ac.pathElement.clone());o.displaySpinner();U++;G({physicalIDs:[Z],callbacks:{onComplete:function(ak){if(!o){return}var ah=[];for(var aj=0;aj<ak.length;aj++){var ai=ak[aj];if(ai.svg&&ai.svg!==""){var am={};am.title=ai["ds6w:label"]||z;am.type="DrawingPreview";am.appId="X3DPLAW_AP";am.appIcon=ai.preview_url||ai.thumbnail_2d;am.typeIcon=ai.type_icon_url;am.urlDerivedOutput=ai.svg;am.tileId=String(am.type+"_"+am.appId+"_"+am.urlDerivedOutput);am.pathElement=ac.pathElement;var al=ai["ds6w:modified"]?ai["ds6w:modified"]:(ai["ds6w:created"]?ai["ds6w:created"]:undefined);am.modifDate=al?g.String.parseRelativeTime(al):P;if(!am.modifDate){am.modifDate=al?al:P}ah.push(am)}}K(ah,ac.pathElement);o.hideSpinner();ab()},onFailure:ab}})}}else{H(false)}}};var u=function(T){if(D&&y){if(!T){H(false)}else{if(T.pathElement&&(!T.pathElement.getLastElement(true)._getExcludeFromCSO||!T.pathElement.getLastElement(true)._getExcludeFromCSO())){v(T.pathElement)}}}};var L=function(){if(!R){R={};R.onBeginReparent=I.subscribe({event:"onBeginReparent"},function(V){if(D&&y){for(var U=B.length-1;U>=0;U--){if((V.reparentedInstance&&B[U].pathElement.externalPath.some(function(W){return W===V.reparentedInstance}))||(V.pathToReparent&&V.pathToReparent.isParentOf(B[U].pathElement))){v(B[U].pathElement)}}}});R.onRootRemoved=I.subscribe({event:"onRootRemoved"},function(U){if(D&&y){J([U.path])}});R.onRootDetached=I.subscribe({event:"onRootDetached"},function(U){if(D&&y){J([U.path])}});R.onHide=I.subscribe({event:"onHide"},function(V){if(D&&y){var U=[];V.paths.forEach(function(W){U.push(W)});J(U)}});var T=null;R.VISU=d.subscribe({event:"/VISU/"},function(U){if(D&&y){if(U.eventType==="@onViewpointChange"){if(T===null){T=true;return}if(T&&o){o.setVisibleFlag(false,true);T=false}}else{if(U.eventType==="@onViewpointEndMove"){if(T===false&&o){o.setVisibleFlag(true)}T=null}}}});R.onAdd=e.onAdd(C);R.onRemove=e.onRemove(u);R.onEmpty=e.onEmpty(u);R.swapVisibleSpace=I.getViewer().onSwapVisibleSpace?I.getViewer().onSwapVisibleSpace(function(){if(D&&y){H(false)}}):null}};var s=function(U){if(!U){return -1}for(var T=0;T<Q.length;T++){if(Q[T].isEqual(U)){return T}}return -1};var O=function(U){if(!U){return null}for(var T=U.externalPath.length-1;T>=0;T--){if(b.isReference(U.externalPath[T])){return U.externalPath[T]}}};function n(U){if(!U){return null}for(var T=U.externalPath.length-1;T>=0;T--){if(U.externalPath[T].is3DLeaf&&b.is3DLeaf(U.externalPath[T])){return U.externalPath[T]}}}var v=function(W){if(o){var T=s(W);if(T!==-1){Q.splice(T,1)}for(var U=B.length-1;U>=0;U--){if(B[U].pathElement.isEqual(W)){for(var V=B[U].tiles.length-1;V>=0;V--){o.removeTile(B[U].tiles[V])}B.splice(U,1)}}if(B.length===0){o.clear()}else{o.setDataLauncherPosition(B[B.length-1].position);o.update()}}};var H=function(T){if(x){clearTimeout(x);x=0}if(o){o.clear(T)}Q=[];if(T&&R){if(R.VISU){d.unsubscribe(R.VISU)}if(R.onHide){I.unsubscribe(R.onHide)}if(R.onRootDetached){I.unsubscribe(R.onRootDetached)}if(R.onRootRemoved){I.unsubscribe(R.onRootRemoved)}if(R.onBeginReparent){I.unsubscribe(R.onBeginReparent)}if(R.onAdd){e.unsubscribe(R.onAdd)}if(R.onRemove){e.unsubscribe(R.onRemove)}if(R.onEmpty){e.unsubscribe(R.onEmpty)}if(R.swapVisibleSpace&&I.getViewer()){I.getViewer().unsubscribe(R.swapVisibleSpace)}R=o=null}};var K=function(T,V){var W=null;if(s(V)===-1){return}for(var U=0;U<B.length;U++){if(B[U].pathElement.isEqual(V)){W=B[U];break}}for(var U=0;U<T.length;U++){if(T[U].tileId&&T[U].type&&T[U].appId&&T[U].urlDerivedOutput){if(!o.addTile(T[U])){continue}o.update();if(x){clearTimeout(x);x=0}if(!W){W={tiles:[T[U]],pathElement:V,position:new l.Vector3().copy(E),localMatrix:new l.Matrix4().copy(A),pickPath:q.clone()};B.push(W)}else{W.tiles.push(T[U])}}}}}});var i=[];var c=a.singleton({init:function(){},giveDataLauncherController:function(o){if(o&&o.context){for(var n=0;n<i.length;n++){if(i[n].context===o.context){return i[n].dataLauncherController}}}},getDataLauncherController:function(o){var p=this.giveDataLauncherController(o);if(o&&o.context&&!p){var n=new f({ctxViewer:o.context});p=Object.freeze({setActiveState:function(q){if(n){return n.setActiveState(q)}},getActiveState:function(){if(n){return n.getActiveState()}},clearController:function(){if(n){n.clearController();n=null}},displayDataLauncher:function(q){if(n){return n.displayDataLauncher(q)}},isDisplayed:function(){if(n){return n.isDisplayed()}},setVisibility:function(q){if(n){return n.setVisibility(q)}}});i.push({context:o.context,dataLauncherController:p})}return p},unregisterDataLauncherController:function(o){if(o&&o.context){for(var n=0;n<i.length;n++){if(i[n].context===o.context){i[n].dataLauncherController.clearController();i.splice(n,1);break}}}}});return c});
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedDataLauncher/CATRelatedDataLauncher",["UWA/Core","UWA/Class","DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils","DS/SceneGraphNodes/CSS2DNode","DS/Manipulators/Manipulator","DS/CoreEvents/ModelEvents","UWA/Controls/ThemedScroller","DS/UIKIT/Spinner","DS/Controls/Toggle","DS/CATWebUXComponents/CATWebUXPanel","DS/CATWebUXComponents/CATWebUXThumbnail","DS/VisuEvents/EventsManager","css!DS/UIKIT/UIKIT.css","css!DS/CATRelatedDataLauncher/CATRelatedDataLauncher.css"],function(g,r,j,u,f,c,t,m,s,i,l,n,d,q){var b="";var e="All";var p="";var h=[];require(["i18n!DS/CATRelatedDataLauncher/assets/nls/CATRelatedDataLauncher"],function(v){b=v.SelectAllLbl;h.push({type:"LayoutPreview",singleCase:v.LayoutPreviewSingleLbl,multipleCase:v.LayoutPreviewMultipleLbl});h.push({type:"DrawingPreview",singleCase:v.DrawingPreviewSingleLbl,multipleCase:v.DrawingPreviewMultipleLbl});p=v.RelatedDataLauncherPanelTitle});var k=function(w){for(var v=0;v<h.length;v++){if(h[v].type===w){return{singleCase:h[v].singleCase,multipleCase:h[v].multipleCase}}}return{singleCase:"",multipleCase:""}};var o=r.extend({init:function(C){var C=C||{};this._parent(C);var L=this;var N=[];var S=-1;var G=0,w=0;var y=false;var M;var U,x,I,O,R,z,W,Q;var K=new i();K.getContent().addClassName("dLSpinner");var v=new s();v.getInnerElement().parentNode.setStyle("height","100%");this.build=function(ad){if(!M){M=g.createElement("div",{id:"CATRelatedDataLauncherPanelDiv","class":"dLTilePanelDiv dLOpacityTransfo dLTilePanelDivDocked"});U=g.createElement("div",{id:"CATRelatedDataLauncherPanelScrollTileContainer"});v.inject(U);x=g.createElement("div",{id:"CATRelatedDataLauncherPanelTileContainer","class":"dLPanelTileContainer"});v.getInnerElement().setContent(x);R=g.createElement("div",{id:"CATRelatedDataLauncherHeaderContainer","class":"dLHeaderContainer"});var af=g.createElement("div",{id:"headerDiv","class":"dLHeaderDiv"}).inject(R);Q=g.createElement("span",{id:"counterSpan","class":"dLCounter"}).inject(af);var Z=g.createElement("span",{id:"separator","class":"dLSeparator"}).inject(af);Z.innerHTML="|";W=new l({checkFlag:y}).inject(af);W.elements.container.addClassName("dLHeaderCheck");W.elements.container.setStyle("display","inline-block");W.elements.checkSign.addClassName("dLHeaderCheckSign");O=g.createElement("span",{id:"checkDescSpan","class":"dLClickableText"}).inject(af);I=g.createElement("span",{id:"bulletsSpan","class":"fonticon fonticon-dot-3 dLBullets"}).inject(af);z=g.createElement("div",{id:"divCheckAll","class":"dLCheckAllDiv"});z.setStyle("height","0px");q.addEvent(O,"onPrimaryPointerClick",J);q.addEvent(I,"onPrimaryPointerClick",P);q.addEvent(W.elements.container,"onPrimaryPointerClick",F);q.addEvent(R,"onPrimaryPointerDoubleClick",C.onPanelSizeChangedCB)}var ab=ad.length||N.length;if(!ab&&(ad.length===N.length)){for(var ae=0;ae<ad.length;ae++){if(N[ae].getData()!==ad[ae]){ab=true;break}}}if(!ab){return}w=0;S=-1;var ac=this.getSelectedTilesIDs();for(var ae=0;ae<N.length;ae++){N[ae].clear()}N.splice(0,N.length);if(ad&&ad.length){for(var ae=0;ae<ad.length;ae++){var X=false;for(var aa=0;aa<ac.length;aa++){if(ad[ae].tileId===ac[aa]){X=true;w++;break}}var Y=Object.assign({},ad[ae]);N.push(new d({id:Y.tileId,displayType:1,title:Y.NLSType,titleIcon:Y.typeIcon,subtitle:Y.title,additionalText:Y.modifDate,preview:Y.appIcon,data:Y,checkFlag:X,checkFlagChangedCB:H,clickCB:B,doubleClickCB:D,isCheckable:ad.length>1}))}if(R.parentNode===M){M.removeChild(R)}if(U.parentNode===M){M.removeChild(U)}while(x.firstChild){x.removeChild(x.firstChild)}if(ad.length>1){R.inject(M)}z.inject(R);U.inject(M);U.setStyles({height:ad.length>1?"calc(100% - 45px)":"100%"});for(var ae=0;ae<N.length;ae++){N[ae].inject(x)}K.inject(x);V();if(I.hasClassName("dLBulletsActivated")){P()}Q.innerHTML=w;E();if(e==="All"){O.innerHTML=b}else{O.innerHTML=k(e).multipleCase}}};this.getContent=function(){return M};this.setSpinnerVisibility=function(X){if(X){K.show()}else{K.hide()}};this.getSelectedTilesIDs=function(){var Y=[];for(var X=0;X<N.length;X++){if(N[X].isChecked()){Y.push(N[X].getData().tileId)}}return Y};this.clear=function(Y){if(!M){return}for(var X=0;X<N.length;X++){N[X].clear()}while(M.firstChild){M.removeChild(M.firstChild)}N.splice(0,N.length);if(Y){q.removeEvent(O,"onPrimaryPointerClick",J);q.removeEvent(I,"onPrimaryPointerClick",P);q.removeEvent(W.elements.container,"onPrimaryPointerClick",F);q.removeEvent(R,"onPrimaryPointerDoubleClick",C.onPanelSizeChangedCB);v.destroy();K.destroy();M=v=K=J=P=F=null}};this.setSelectedTilesIDs=function(Y){if(Y){for(var X=0;X<N.length;X++){N[X].setCheckFlag(false)}for(var X=0;X<Y.length;X++){for(var Z=0;Z<N.length;Z++){if(N[Z].getData().tileId===Y[X]){N[Z].setCheckFlag(true)}}}}};var B=function(ab){var ae=ab.id;var ac=ab.event.from[0].event.shiftKey;var X=ab.event.from[0].event.ctrlKey;var Z=-1;var aa=null;for(var af=0;af<N.length;af++){if(N[af].getData().tileId===ae){Z=af;aa=N[af];break}}if(!aa){return}if(!ac){S=Z}if(X){aa.setCheckFlag(!aa.isChecked());return}else{if(ac){if(S===-1){aa.setCheckFlag(!aa.isChecked());S=Z}else{if(S===Z){for(var af=0;af<N.length;af++){N[af].setCheckFlag(af===Z)}}else{var Y=Z>S?S:Z;var ad=Z>S?Z:S;for(var af=0;af<N.length;af++){if(af<Y||af>ad){N[af].setCheckFlag(false)}else{if(af>=Y&&af<=ad){N[af].setCheckFlag(true)}}}}}return}}S=Z;if(L.getSelectedTilesIDs().length>0){aa.setCheckFlag(true)}C.onTileSelectedCB(ae)};var D=function(aa){var ab=aa.id;var Y=null;for(var X=0;X<N.length;X++){if(N[X].getData().tileId===ab){Y=N[X].getData().type;break}}for(var Z=0;Z<N.length;Z++){N[Z].setCheckFlag(N[Z].getData().type===Y)}C.onTileSelectedCB()};var P=function(){if(!I.hasClassName("dLBulletsActivated")){I.addClassName("dLBulletsActivated");z.setStyle("height",G+"px")}else{I.removeClassName("dLBulletsActivated");z.setStyle("height","0px")}};var J=function(){y=!y;W.checkFlag=y;A()};var F=function(){y=!y;A();setTimeout(function(){W.checkFlag=y},0)};var T=function(Y){S=-1;e=Y.from[0].view.dataLauncherType;if(e==="All"){for(var X=0;X<N.length;X++){N[X].setCheckFlag(true)}}else{for(var X=0;X<N.length;X++){N[X].setCheckFlag(N[X].getData().type===e)}}O.innerHTML=Y.from[0].view.innerHTML;P()};var V=function(){var X=[];while(z.firstChild){q.removeEvent(z.firstChild,"onPrimaryPointerClick",T);z.removeChild(z.firstChild)}for(var Y=0;Y<N.length;Y++){if(X.indexOf(N[Y].getData().type)===-1){X.push(N[Y].getData().type)}}if(X.length>1){I.show();G=(X.length+1)*30;var Z=g.createElement("div",{"class":"dLClickableText dLCheckOptions"}).inject(z);Z.innerHTML=b;Z.dataLauncherType="All";q.addEvent(Z,"onPrimaryPointerClick",T);for(var Y=0;Y<X.length;Y++){var Z=g.createElement("div",{"class":"dLClickableText dLCheckOptions"}).inject(z);Z.innerHTML=k(X[Y]).multipleCase;Z.dataLauncherType=X[Y];q.addEvent(Z,"onPrimaryPointerClick",T)}}else{I.hide();G=0}};var A=function(){S=-1;var X=y;if(e==="All"){for(var Y=0;Y<N.length;Y++){N[Y].setCheckFlag(X)}}else{if(X){for(var Y=0;Y<N.length;Y++){N[Y].setCheckFlag(N[Y].getData().type===e)}}else{for(var Y=0;Y<N.length;Y++){if(N[Y].getData().type===e){N[Y].setCheckFlag(false)}}}}};var E=function(){if(e==="All"&&w===N.length&&!y){y=true}else{if(e==="All"&&w!==N.length&&y){y=false}else{if(e!=="All"){y=true;for(var X=0;X<N.length;X++){if(N[X].getData().type===e&&!N[X].isChecked()){y=false;break}else{if(N[X].getData().type!==e&&N[X].isChecked()){y=false;break}}}}}}W.checkFlag=y};var H=function(Y){if(Y.checkFlag){if(Y.event&&Y.event.shiftKey===false){for(var X=0;X<N.length;X++){if(N[X].getData().tileId===Y.id){S=X;break}}}w++}else{w--}E();Q.innerHTML=w}}});var a=r.extend({init:function(A){var A=A||{};this._parent(A);var M=false;var P=new j("CATRelatedDataLauncherMainNode");P.setVisibilityInTree(false);P.exludeFromBounding(true);P._getExcludeFromCSO=function(){return true};P.setVisibilityFree(true);A.viewer.addNode(P,false);var T=null;var C=null;var I=[];var W=[];var Y=new m();var N=new u.Vector3();var x=null;var L=null;var V=false;var R=false;var S=0;var y=null;var D=null;var v=localStorage.getItem("CATRelatedDataLauncherDockPref")==="left"||localStorage.getItem("CATRelatedDataLauncherDockPref")==="right";var O;this.show=function(){F();if(I.length){if(T&&T.isVisible()){T.setVisibility(false)}X();if(v){if(!D){U()}H();D.setPanelVisibilityFlag(true)}}else{G()}V=true;A.viewer.render()};this.clear=function(Z){I=[];if(y){y.clear(Z)}if(D){D.setPanelVisibilityFlag(false)}if(C&&C.isVisible()){C.setVisibility(false)}if(T&&T.isVisible()){T.setVisibility(false)}if(Z){if(D){D.destroy()}A.viewer.removeNode(P,false);D=P=T=C=I=null;W=Y=N=y=x=L=null}V=M=R=false;A.viewer.render()};this.clearIfWaiting=function(){if(!I.length){this.clear()}};this.update=function(){if(V){if(I.length){X();if(T&&T.isVisible()){T.setVisibility(false)}if(v){if(!D){U()}H();D.setPanelVisibilityFlag(true,true)}}else{G()}A.viewer.render()}};this.displaySpinner=function(){S++;if(y&&S===1){y.setSpinnerVisibility(true)}};this.hideSpinner=function(){S--;if(y&&S===0){y.setSpinnerVisibility(false)}};this.addTile=function(aa){var ab=true;for(var Z=0;Z<I.length;Z++){if(I[Z].urlDerivedOutput===aa.urlDerivedOutput&&I[Z].appId===aa.appId){ab=false;break}}if(ab){I.push(aa)}H(ab);return ab};this.removeTile=function(ab){var Z=false;for(var aa=0;aa<I.length;aa++){if(I[aa].urlDerivedOutput===ab.urlDerivedOutput&&I[aa].appId===ab.appId){I.splice(aa,1);Z=true}}H(Z);if(D&&I.length===0){D.setPanelVisibilityFlag(false)}};this.updateTile=function(Z,af){var ag=Z||{},ac=false;for(var ab=0;ab<I.length;ab++){if(I[ab].urlDerivedOutput===af){if(ag.title&&I[ab].title!==ag.title){I[ab].title=ag.title;ac=true}if(ag.modifDate&&I[ab].modifDate!==ag.modifDate){I[ab].modifDate=ag.modifDate;ac=true}if(ag.appIcon){I[ab].appIcon=ag.appIcon;ac=true;var aa=-1;for(var ad=0;ad<W.length;ad++){if(W[ad].type===I[ab].type){aa=ad;break}}if(aa===-1){W.push({type:I[ab].type,icon:ag.appIcon});aa=W.length-1}for(var ae=0;ae<I.length;ae++){if(I[ae].type===W[aa].type){I[ae].appIcon=W[aa].icon;ac=true}}}if(!I[ab].appIcon){for(var ad=0;ad<W.length;ad++){if(W[ad].type===I[ab].type){I[ab].appIcon=W[ad].icon;ac=true}}}}}H(ac)};this.setDataLauncherPosition=function(aa){if(aa){N.copy(aa);var Z=new u.Matrix4().setPosition(aa);if(T){T.setMatrix(Z)}if(C){C.setMatrix(Z)}}};this.setVisibleFlag=function(Z,aa){if((!aa&&D&&v)||(aa&&D&&!v)){if((Z&&I.length)||!Z){D.setPanelVisibilityFlag(Z,true)}}if(P&&((Z&&!v)||Z===false)){P.setVisibility(Z)}A.viewer.render()};this.subscribe=function(Z,aa){if(Z==="onRelatedDataSelected"){return Y.subscribe({event:Z},aa)}};this.unsubscribe=function(Z){if(Z&&Y){Y.unsubscribe(Z)}};var F=function(){if(!T&&!C){L=g.createElement("div",{id:"CATRelatedDataLauncherWaitingDiv","class":"dLWaitingMarker"});T=new c({html:L,name:"CATRelatedDataLauncherWaitingNode"});T._getExcludeFromCSO=function(){return true};T.css2DNode.primitive=true;T.setVisibilityInTree(false);T.exludeFromBounding(true);T.setOffset(new u.Vector2(-20,-12));T.setVisibility(false);T.setPickability(false);var Z=f.getWebappsAssetUrl("CATRelatedDataLauncher","textures/I_W3dDataLauncherPin_Over.png");var ab=f.getWebappsAssetUrl("CATRelatedDataLauncher","textures/I_W3dDataLauncherPin.png");x=g.createElement("div",{id:"CATRelatedDataLauncherPinDiv","class":"dLPinMainDiv"});x.setStyle("backgroundImage",'url("'+ab+'")');C=new c({html:x,name:"CATRelatedDataLauncherPinNode"});C.setVisibilityInTree(false);C.exludeFromBounding(true);C.setOffset(new u.Vector2(-20,-54));C._getExcludeFromCSO=function(){return true};C.css2DNode.primitive=true;C.setNoZ(true);C.setVisibility(false);var aa=t.extend({init:function(ad){var ad=ad||{};this._parent(ad);this.setExclusive(true);this._token=-1},PrimaryPointerClick:function(ae,ad,ag){this._parent(ae,ad,ag);if(this._token===-1){var af=this;this._token=setTimeout(function(){af.publish("Click");af._token=-1},200)}else{clearTimeout(this._token);this._token=-1;this.publish("DblClick")}},BeginPreactivate:function(ae,ad,af){this._parent(ae,ad,af);this.publish("BeginPreactivate")},EndPreactivate:function(ae,ad,af){this._parent(ae,ad,af);this.publish("EndPreactivate")}});var ac=new aa({viewer:A.viewer});ac.subscribe("Click",function(){if(M){U();H();if(y){D.setPanelVisibilityFlag(true,true);y.setSpinnerVisibility(S>0)}else{D.setPanelVisibilityFlag(false)}A.window.getContextualUIManager().hideContextualMenus()}});ac.subscribe("DblClick",function(){if(M){if(y){var ad=[];if(e==="All"){for(var ae=0;ae<I.length;ae++){ad.push(I[ae].tileId)}}else{for(var ae=0;ae<I.length;ae++){if(I[ae].type===e){ad.push(I[ae].tileId)}}}if(ad.length){if(y){y.setSelectedTilesIDs(ad)}w()}}else{z("onRelatedDataSelected",I)}A.window.getContextualUIManager().hideContextualMenus()}});ac.subscribe("BeginPreactivate",function(){if(M){x.setStyle("backgroundImage",'url("'+Z+'")')}});ac.subscribe("EndPreactivate",function(){if(M){x.setStyle("backgroundImage",'url("'+ab+'")')}});ac.linkToNode(C);P.addChild(C);P.addChild(T)}};var H=function(Z){var aa=[],ac=[],af=[],ae=typeof Z==="boolean"?Z:false,ah;for(var ag=0;ag<I.length;ag++){ah=true;if(!I[ag].appIcon){for(var ab=0;ab<W.length;ab++){if(W[ab].type===I[ag].type){if(I[ag].appIcon!==W[ab].icon){I[ag].appIcon=W[ab].icon;ae=true}ah=false;break}}}else{ah=false}if(!ah){aa.push(I[ag])}else{ac.push(I[ag].type);af.push(I[ag].urlDerivedOutput)}}if(ac.length){window.console.log("No type icon returned by server query")}if(D){var ad=aa.length===0||aa.length===1?104:(aa.length===2?244:300);D.setMinHeight(ad);D.setHeight(ad)}if(ae&&y){E(aa);y.build(aa)}};var E=function(Z){for(var aa=0;aa<Z.length;aa++){if(!Z[aa].NLSType){Z[aa].NLSType=k(Z[aa].type).singleCase}}};var B=function(aa){for(var Z=0;Z<I.length;Z++){if(aa===I[Z].tileId){return I[Z]}}};var w=function(ad){if(M){var Z=[];if(ad){Z.push(B(ad))}var ab=[];if(y){ab=y.getSelectedTilesIDs()}if(I.length===1){ab=[I[0].tileId]}for(var aa=0;aa<ab.length;aa++){var ac=B(ab[aa]);if(Z.indexOf(ac)===-1){Z.push(ac)}}if(!v){D.setPanelVisibilityFlag(false)}z("onRelatedDataSelected",Z)}};var U=function(){if(!y){y=new o({onTileSelectedCB:w,onPanelSizeChangedCB:Q})}E(I);y.build(I);var ac=A.viewer.getViewpoints()[0].project(N);var aa={at:"top left",offsetX:0,offsetY:0};var ab=305,af=I.length===0||I.length===1?104:(I.length===2?244:300);if(ac.x<ab){aa.offsetX=15}else{if(ac.x+ab>A.viewer.SCREEN_WIDTH){aa.offsetX=A.viewer.SCREEN_WIDTH-ab-15}else{aa.offsetX=ac.x-ab/2}}if(ac.y<af){aa.offsetY=15}else{if(ac.y+af>A.viewer.SCREEN_HEIGHT){aa.offsetY=A.viewer.SCREEN_HEIGHT-af-15}else{aa.offsetY=ac.y-(I.length===1?90:130)}}var Z=localStorage.getItem("CATRelatedDataLauncherDockPref");var ae=Z==="left"?WUXDockAreaEnum.LeftDockArea:(Z==="right"?WUXDockAreaEnum.RightDockArea:WUXDockAreaEnum.NoneDockArea);if(!D){var ad={id:"CATRelatedDataLauncherPanel",className:"CATRelatedDataLauncherPanel",title:p,showTitleFlag:false,icon:f.getWebappsAssetUrl("CATRelatedDataLauncher","icons/32/")+"I_RevealRelatedDataCmd.png",immersiveFrame:A.window.getImmersiveFrame(),content:y.getContent(),minWidth:ab,width:ab,widthStep:296,minHeight:af,height:af,heightStep:94,resizableFlag:false,closeButtonFlag:true,autoCloseFlag:false,closePanelCB:K,onPlaceChangedCB:J,position:aa,currentDockArea:ae,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea};D=new n(ad)}else{if(!v){D.setPanelPosition(aa);D.setMinHeight(af);D.setHeight(af)}}J({currentDockArea:ae})};var Q=function(){if(v){if(D.getWidth()!==308){O=D.getWidth();D.setWidth(308)}else{if(O){D.setWidth(O)}}}};var K=function(){if(y){y.clear(true);y=null}if(D){D.clean();D=null}P.setVisibility(true);v=false;A.viewer.render()};var J=function(Z){localStorage.setItem("CATRelatedDataLauncherDockPref",Z.currentDockArea===WUXDockAreaEnum.LeftDockArea?"left":Z.currentDockArea===WUXDockAreaEnum.RightDockArea?"right":"none");D.setResizableFlag(Z.currentDockArea!==WUXDockAreaEnum.NoneDockArea);v=Z.currentDockArea!==WUXDockAreaEnum.NoneDockArea;P.setVisibility(!v);D.setMinWidth(v?308:305);A.viewer.render()};var X=function(){if(N){if(!R){M=false;C.setVisibility(true);x.addClassName("dLPinAnimation");setTimeout(function(){if(x){x.removeClassName("dLPinAnimation")}M=true},550);R=true}C.setMatrix(new u.Matrix4().setPosition(N))}};var G=function(){if(N){T.setMatrix(new u.Matrix4().setPosition(N));if(!T.isVisible()){L.setAttribute("style","animation-iteration-count:infinite;");T.setVisibility(true)}}};var z=function(Z,aa){if(Z==="onRelatedDataSelected"){E(aa)}return Y.publish({event:Z,data:aa,context:this})}}});return a});
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedDataLauncher/CATRevealRelatedDataCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/PADUtils/PADContext"],function(d,c,b){var a=d.extend({init:function(g){this._parent(g,{});var j=this;var h=null;var i=this.onStateChange(function(){if(!h){h=b.get()}c.getDataLauncherController({context:h}).displayDataLauncher(j.getState());localStorage.setItem("CATRevealRelatedDataCmd",j.getState()?"true":"false")});var f=this._destroy;this._destroy=function(){if(h){c.unregisterDataLauncherController({context:h})}j._modelEvents.unsubscribe(i);f.call(j)};var e=localStorage.getItem("CATRevealRelatedDataCmd");e=e==="true"?true:false;this.setState(e,true)},_destroy:function(){this._parent()}});return a});