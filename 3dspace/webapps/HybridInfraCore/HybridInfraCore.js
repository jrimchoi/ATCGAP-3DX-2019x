define("DS/HybridInfraCore/HybridApp",["UWA/Class","DS/WebappsUtils/WebappsUtils","DS/ExperienceKernel/ExperienceKernel","DS/NativeDelegate/NativeDelegateController","DS/NativeDelegate/NativeDelegate"],function(b,f,e,g,c){var d=new Array();var a=b.singleton({PLATFORM:Object.freeze({IOS:"iOS",ANDROID:"Android"}),init:function(){this._parent();this._mainAppArgs=null;this._delegateCtrl=new g();this._internalDelegate=new c("internal",this._delegateCtrl,false);this._delegateCtrl.linkDelegate(this._internalDelegate);this._httpNativeDelegate=null;document.addEventListener("DELEGATE_CONTROLLER",function(i){if("ON_NATIVE_DELEGATION_CONNECTION"===i.detail){console.info("Native connection has been succefully initialized");HybridApp.executeOnServerReady(window.HybridAppArgs)}else{if("ON_NATIVE_DELEGATION_DISCONNECTION"===i.detail){console.info("Native connection has been lost")}}});this._platformName="unknown";var h=navigator.userAgent||navigator.vendor||window.opera;if(h.match(/iPad/i)||h.match(/iPhone/i)||h.match(/iPod/i)){this._platformName=this.PLATFORM.IOS;this.__enableWAFDataNativeRequestForCrossDomainIssueOnIOS()}else{if(h.match(/Android/i)){this._platformName=this.PLATFORM.ANDROID}}},addDelegate:function(h){if(!HybridApp._internalDelegate){throw new Error("Internal delegate is missing")}return new Promise(function(j,i){HybridApp._internalDelegate._isCpp=false;HybridApp._internalDelegate.execute("addDelegate",{delegate:h}).then(function(k){console.log(h+" has been correctly added");HybridApp._delegateCtrl.linkDelegate(new c(h,false));j(HybridApp._delegateCtrl._delegateDico[h])},function(k){HybridApp._internalDelegate._isCpp=true;HybridApp._internalDelegate.execute("addDelegate",{delegate:h}).then(function(l){console.log(h+" has been correctly added");HybridApp._delegateCtrl.linkDelegate(new c(h,true));j(HybridApp._delegateCtrl._delegateDico[h])},function(l){i(l)})})})},removeDelegate:function(h){if(!HybridApp._internalDelegate){throw new Error("Internal delegate is missing")}return new Promise(function(j,i){HybridApp._internalDelegate._isCpp=false;HybridApp._internalDelegate.execute("removeDelegate",{delegate:h}).then(function(k){delete HybridApp._delegateCtrl._delegateDico[h];j(k)},function(k){HybridApp._internalDelegate._isCpp=true;HybridApp._internalDelegate.execute("removeDelegate",{delegate:h}).then(function(l){delete HybridApp._delegateCtrl._delegateDico[h];j(l)},function(l){i(l)})})})},onDeviceReady:function(h){if(this._delegateCtrl.isAvailable()&&this._mainAppArgs){h(this._mainAppArgs)}else{d.push(h)}},executeOnServerReady:function(h){this._mainAppArgs=h;var k=d.length;for(var j=0;j<k;j++){var l=d[j];if(l){l(h)}}},getPlatformName:function(){return this._platformName},isIOS:function(){if(this.PLATFORM.IOS===this._platformName){return true}return false},isAndroid:function(){if(this.PLATFORM.ANDROID===this._platformName){return true}return false},getWebappsPath:function(){if(!window.HybridAppArgs||!window.HybridAppArgs.config||window.HybridAppArgs.config.isExternal===true){return f.getWebappsBaseUrl()}else{if(this.isIOS()){return"/webapps/"}else{if(this.isAndroid()){return"file:///android_asset/"}else{console.error("UNSUPPORTED PLATFORM ")}}}},authentifyAppWith:function(h,i){return new Promise(function(k,j){HybridApp.__getHttpNativeDelegate().then(function(m){var l={passportURL:h,CASTGC:i};m.execute("authentify",l).then(function(n){k(n)},function(n){j(n)})})})},interactiveAuthentify:function(){return new Promise(function(i,h){HybridApp.__getHttpNativeDelegate().then(function(j){j.execute("interactiveAuthentify",{}).then(function(k){i(k)},function(k){h(k)})})})},__getHttpNativeDelegate:function(){return new Promise(function(i,h){if(null===HybridApp._httpNativeDelegate){HybridApp.addDelegate("HttpRequestDelegate").then(function(j){HybridApp._httpNativeDelegate=j;i(HybridApp._httpNativeDelegate)},function(j){console.log("ERROR : Cannot add HttpRequestDelegate",j);h(null)})}else{i(HybridApp._httpNativeDelegate)}})},__enableWAFDataNativeRequestForCrossDomainIssueOnIOS:function(){require(["DS/WAFData/WAFData"],function(h){HybridApp.__getHttpNativeDelegate().then(function(l){var m=h.authenticatedRequest;var j=h.request;var k=h.proxifiedRequest;var i=function(o,n){var p={url:encodeURI(o),method:n.method||"GET",};if(n.data){if("object"===typeof n.data){p.data=JSON.stringify(n.data)}else{p.data=n.data}}if(n.headers){if("object"===typeof n.headers){p.headers=JSON.stringify(n.headers)}else{p.headers=n.headers}}l.execute("httpRequest",p).then(function(r){if(n.onComplete){if(r.responseType){if("zip"===r.responseType){var q=new Uint8Array(atob(r.data).split("").map(function(s){return s.charCodeAt(0)}));n.onComplete(q.buffer)}else{n.onComplete(r.data)}}else{n.onComplete(r)}}else{console.log(r)}},function(q){if(n.onFailure){n.onFailure(q)}else{console.log(q)}})};h.authenticatedRequest=function(o,n){if(o.contains("https")){console.log("iOS authenticatedRequest instead of WAFData on : "+o);i(o,n)}else{m(o,n)}};h.request=function(o,n){if(o.contains("https")){console.log("iOS request instead of WAFData on : "+o);i(o,n)}else{j(o,n)}};h.proxifiedRequest=function(o,n){if(o.contains("https")){console.log("iOS proxifiedRequest instead of WAFData on : "+o);i(o,n)}else{k(o,n)}}})})},__onPlateformReady:function(){this._delegateCtrl.onConnection()},__postTextMsgToJS:function(h){this._delegateCtrl.onText(h)},__postBinaryMsgToJS:function(h){this._delegateCtrl.onBinary(h)},__postTextMsgToNative:function(h){if(this.PLATFORM.IOS===this._platformName){window.webkit.messageHandlers.notification.postMessage(h)}else{if(this.PLATFORM.ANDROID===this._platformName){JS2Native.postMessage(h)}}},__postBinaryMsgToNative:function(h){if(this.PLATFORM.IOS===this._platformName){window.webkit.messageHandlers.notification.postMessage(h)}else{if(this.PLATFORM.ANDROID===this._platformName){JS2Native.postMessage(h)}}},});return UWA.namespace("HybridApp",a,window,true)});