if(typeof window!="undefined"){window.usesLDHAsync=true}define("DS/SelectiveLoading/SelectiveLoadingAsync",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/SelectiveLoading/LoadingBoxes","DS/Animation/PropertyAnimation","DS/CoreEvents/Events","DS/SceneGraphOverrides/GenericOverride"],function(k,j,l,h,c,e){l.log=function(){Function.prototype.apply.apply(console.log,[console,arguments])};var a=false;l.Context.prototype._autoLoadCandidates=function(n,p){if(n!=undefined&&n.length!=undefined){for(var m=0;m<n.length;++m){if(n[m].object!=undefined){var o=n[m].object.length;if(o!=undefined){p.load(n[m].object)}else{p.load([n[m].object])}}else{return -1}}return n.length}else{return -1}};l.AsyncInterface=function(m){this.asyncIndex=0;this.objectIdHash=[];this.ldhWorkerStarted=false;this.maxRegisterCount=5000;this.registerCount=0;this.fps=60;this.timestamp=Date.now();this.fpsFrameCount=0;var n=window.dsDefaultWebappsBaseUrl;this.countToStopAnim=-1;if(n.length!=0&&n.slice(-1)=="/"){n=n.slice(0,-1)}this.ldhContext=new l.Context({asyncInterface:this,hashSize:0});this.helpers=new l.Helpers();this.ldhWorker={};this.ldhWorker=new Worker(n+"/SelectiveLoading/SelectiveLoadingWorker.js");this.ldhWorker.unbufferedMessages=["ready","autoLoad","autoUnload","getLoadCandidates","getUnloadCandidates","enableLoadingBoxes","profile","profileEnd","error"];this.ldhWorker.messageQueue=[];this.ldhWorker._flushMessages=function(){if(this.asyncInterface.ldhWorkerStarted){var o;for(o=0;o<this.messageQueue.length;o+=1){if(this.messageQueue[o][0]=="registerObjects"){var p=this.messageQueue[o][1].length;this.messageQueue[o][1]=(new Uint32Array(this.messageQueue[o][1])).buffer;this.messageQueue[o][3]=this.asyncInterface._makeBoxesStruct(this.messageQueue[o][3]);this.messageQueue[o][4]=this.asyncInterface._makeMatricesStruct(this.messageQueue[o][4]);this.messageQueue[o][5]=(new Int32Array(this.messageQueue[o][5])).buffer}else{if(this.messageQueue[o][0]=="registerObject"){this.messageQueue[o][3]=this.asyncInterface._makeBoxStruct(this.messageQueue[o][3]);this.messageQueue[o][4]=this.asyncInterface._makeMatrixStruct(this.messageQueue[o][4])}}}if(this.messageQueue.length>1){this.postMessage(["pack",this.messageQueue.slice(0)])}else{if(this.messageQueue.length!=0){this.postMessage(this.messageQueue[0].slice(0))}}this.messageQueue.length=0}};this.ldhWorker._piggyback=function(p){var q=false;if(p[0]=="registerObject"){if(this.messageQueue.length!=0){if(this.messageQueue[this.messageQueue.length-1][0]=="registerObject"){var o=this.messageQueue[this.messageQueue.length-1];if((o[4]!=undefined&&p[4]!=undefined)||(o[4]==undefined&&p[4]==undefined)){this.messageQueue[this.messageQueue.length-1]=["registerObjects",[o[1]],[o[2]],[o[3]],[o[4]],[o[5]]]}}if(this.messageQueue[this.messageQueue.length-1][0]=="registerObjects"){var o=this.messageQueue[this.messageQueue.length-1];if((o[4][0]!=undefined&&p[4]!=undefined)||(o[4][0]==undefined&&p[4]==undefined)){o[1].push(p[1]);o[2].push(p[2]);o[3].push(p[3]);o[4].push(p[4]);o[5].push(p[5]);q=true}}}}return q};this.ldhWorker.bufferedPostMessage=function(o){var p=this._piggyback(o);if(!p){this.messageQueue.push(o)}if(this.unbufferedMessages.indexOf(o[0])!=-1){this._flushMessages()}};this.ldhWorker._onLoadMessage=function(r){var q=r[1];var p=[];var o=this;q.forEach(function(t){if(t.length!=undefined){t.forEach(function(u){var v=o.asyncInterface.objectIdHash[u];if(v!=undefined&&v.ldhId!=undefined){p.push(v)}})}else{var s=o.asyncInterface.objectIdHash[t];if(s!=undefined&&s.ldhId!=undefined){p.push(s)}}});this._onLoad(p)};this.ldhWorker._onUnloadMessage=function(r){var q=r[1];var p=[];var o=this;q.forEach(function(t){if(t.length!=undefined){t.forEach(function(u){var v=o.asyncInterface.objectIdHash[u];if(v!=undefined&&v.ldhId!=undefined){p.push(v)}})}else{var s=o.asyncInterface.objectIdHash[t.object];if(s!=undefined&&s.ldhId!=undefined){p.push({object:s,priority:t.priority})}}});this._onUnload(p)};this.ldhWorker._onAutoLoadMessage=function(r){var p=r[1];var o=[];var q=this.asyncInterface;if(p.length==0){if(q.countToStopAnim!=-1){q.countToStopAnim+=1}}else{q.countToStopAnim=0}p.forEach(function(t){if(t.length!=undefined){var u=[];t.forEach(function(v){var w=q.objectIdHash[v];if(w!=undefined&&w.ldhId!=undefined){u.push(w)}});o.push({object:u})}else{var s=q.objectIdHash[t];if(s!=undefined&&s.ldhId!=undefined){o.push({object:s})}}});this._onAutoLoad(o)};this.ldhWorker._onAutoUnloadMessage=function(q){var r=q[1];var o=[];var p=this.asyncInterface;if(r.length==0){if(p.countToStopAnim!=-1){p.countToStopAnim+=1}}else{p.countToStopAnim=0}r.forEach(function(t){if(t.length!=undefined){var u=[];t.forEach(function(v){var w=p.objectIdHash[v];if(w!=undefined&&w.ldhId!=undefined){u.push(w)}});o.push({object:u})}else{var s=p.objectIdHash[t];if(s!=undefined&&s.ldhId!=undefined){o.push({object:s})}}});this._onAutoUnload(o)};this.ldhWorker._onReadyMessage=function(o){if(this.asyncInterface.workerReadyCallback!=undefined){this.asyncInterface.workerReadyCallback()}};this.ldhWorker._onUpdateBoxMessage=function(o){this.ldhContext.boxPool.updateBox(o[1],new k.Box3(new k.Vector3(o[2].x,o[2].y,o[2].z),new k.Vector3(o[3].x,o[3].y,o[3].z)))};this.ldhWorker._onHideBoxMessage=function(o){this.ldhContext.boxPool.hideBox(o[1])};this.ldhWorker._onShowBoxMessage=function(o){this.ldhContext.boxPool.showBox(o[1])};this.ldhWorker._onYieldBoxMessage=function(o){this.ldhContext.boxPool.yieldBox(o[1])};this.ldhWorker._onAlreadyLoadingMessage=function(r){var o=r[1];var p=this.asyncInterface.objectIdHash[o];var s=r[2];var v=this.asyncInterface.objectIdHash[s];var u=r[3];if(p==undefined||v==undefined||p.selectiveLoadingParent==undefined||v.selectiveLoadingNode==undefined){console.error("Error : _onAlreadyLoadingMessage failed because of invalid object");if(this.asyncInterface.errorCallback!=undefined){this.asyncInterface.errorCallback("Error : _onAlreadyLoadingMessage failed because of invalid object",p,v)}return}if(undefined==p.selectiveLoadingParent.children.length||0==p.selectiveLoadingParent.children.length){p.selectiveLoadingParent.addChild(v.selectiveLoadingNode)}else{var w=p.selectiveLoadingParent.children;var t=v.selectiveLoadingNode.id;var x=false;for(var q=0;q<w.length;q+=1){if(w[q].id==t){x=true;break}}if(!x){p.selectiveLoadingParent.addChild(v.selectiveLoadingNode)}}if(p.selectiveLoadingNode==undefined){p.selectiveLoadingNode=v.selectiveLoadingNode}if(this.asyncInterface._LDHDebug){this.asyncInterface._debug._idLDHLoaded.add(o)}if(this.ldhContext.boxPool!=undefined){this.ldhContext.boxPool.hideBox(u)}};this.ldhWorker._onErrorMessage=function(q){l.log(q[1]);l.log("Error code: "+q[2]);if(q[1]=="Error in registerObject: registerObject failed"){this.registerCount-=1;var p=this.asyncInterface.objectIdHash[q[3]];if(p!=undefined){delete p.ldhId;delete this.asyncInterface.objectIdHash[q[3]];q[3]=p}else{console.error("Error: worker report register failure on object that we did not try to registered")}if(this.ldhContext.boxPool!=undefined){this.ldhContext.boxPool.yieldBox(q[4])}}else{if(q[1]=="Error in unregisterObject: unregisterObject failed"){this.registerCount+=1}}if(this.asyncInterface.errorCallback!=undefined){var o=(q.length>3?q[3]:undefined);var r=(q.length>4?q[4]:undefined);this.asyncInterface.errorCallback(q[1],q[2],o,r)}};this.ldhWorker._onMessageHelper=function(r){var q=this;var p=r[0];switch(p){case"pack":var o=r[1];o.forEach(function(s){q._onMessageHelper(s)});break;case"load":this._onLoadMessage(r);break;case"unload":this._onUnloadMessage(r);break;case"autoLoad":this._onAutoLoadMessage(r);break;case"autoUnload":this._onAutoUnloadMessage(r);break;case"ready":this._onReadyMessage(r);break;case"updateBox":this._onUpdateBoxMessage(r);break;case"hideBox":this._onHideBoxMessage(r);break;case"showBox":this._onShowBoxMessage(r);break;case"yieldBox":this._onYieldBoxMessage(r);break;case"alreadyLoading":this._onAlreadyLoadingMessage(r);break;case"error":this._onErrorMessage(r);break;default:l.log("Unknown answer from worker: "+p);break}};this.ldhWorker.onerror=function(o){l.log("worker error: "+o.message)};this.ldhWorker.onmessage=function(p){var o=p.data[0];if(!this.asyncInterface.ldhWorkerStarted){if(o=="workerStarted"){this.asyncInterface.TOTAL_MEMORY=p.data[1];this.asyncInterface.maxRegisterCount=this.asyncInterface.TOTAL_MEMORY/700;this.asyncInterface.ldhWorkerStarted=true;if(this.asyncInterface.workerStartedCallback!=undefined){this.asyncInterface.workerStartedCallback()}this._flushMessages();return}else{l.log("error in first message from worker");return}}this._onMessageHelper(p.data)};this.ldhWorker.ldhContext=this.ldhContext;this.ldhWorker.asyncInterface=this;this.ldhWorker.modelLoader=m;this.ldhWorker.waitingLoadResponse=false;this.ldhWorker.waitingUnloadResponse=false;if(this.ldhWorker.hasStarted){this.ldhWorker.onmessage({data:["workerStarted"]})}this.ldhWorker._onLoad=function(o){if(this.asyncInterface.loadCandidatesCallback!=undefined){this.asyncInterface.loadCandidatesCallback(o)}this.waitingLoadResponse=false};this.ldhWorker._onUnload=function(o){if(this.asyncInterface.unloadCandidatesCallback!=undefined){this.asyncInterface.unloadCandidatesCallback(o)}this.waitingUnloadResponse=false};this.ldhWorker._onAutoLoad=function(q){var p=this;var o=this.ldhContext._autoLoadCandidates(q,{load:function(u){if(u.length==undefined){return}var t=new j();for(var s=0;s<u.length;++s){var r=u[s];r.selectiveLoadingParent.addChild(t);r.selectiveLoadingNode=t;if(p.asyncInterface._LDHDebug){if(p.asyncInterface._debug._idLDHLoaded.has(r.ldhId)){console.log("Error _onAutoLoad: object id doublon !!!! : ",r.ldhId)}else{p.asyncInterface._debug._idLDHLoaded.add(r.ldhId)}}}t.ldhObjects=u;m.loadModel({filename:u[0].uri,proxyurl:"none"},t);if(!p.asyncInterface.hasRootBB){p.asyncInterface._noLDHCgrLoaded++}}});this.waitingLoadResponse=false;return o};this.ldhWorker._onAutoUnload=function(o){var p=this.ldhContext._autoUnloadHelper(o,{notifyUnload:function(){return l.error.sOk}});this.waitingUnloadResponse=false;return p};if(m._LDHDebug!=undefined){this._LDHDebug=m._LDHDebug}this._debug={};this._debug._VisuNodeLoaded=[];this._debug._idLDHLoaded=new Set()};l.AsyncInterface.prototype={};l.AsyncInterface.prototype._LDHDebug=a;l.AsyncInterface.prototype.constructor=l.Helpers;l.AsyncInterface.prototype.version="0.0.1";l.AsyncInterface.prototype._makeViewpointStruct=function(m){if(m==undefined||m.camera==undefined||m.viewer==undefined||m.viewer.canvas==undefined){return undefined}return{projectionType:m.projectionType,camera:{fov:m.camera.fov,position:m.camera.position,up:m.camera.up,near:m.camera.near,far:m.camera.far,left:(m.projectionType==1?m.camera.left:0),top:(m.projectionType==1?m.camera.top:0)},viewer:{canvas:{offsetWidth:m.viewer.canvas.offsetWidth,offsetHeight:m.viewer.canvas.offsetHeight}}}};l.AsyncInterface.prototype._makeBoxStruct=function(m){if(m==undefined){return undefined}return new Float32Array([m.min.x,m.min.y,m.min.z,m.max.x,m.max.y,m.max.z]).buffer};l.AsyncInterface.prototype._makeMatrixStruct=function(m){if(m==undefined){return undefined}return new Float64Array([m.elements[0],m.elements[1],m.elements[2],m.elements[3],m.elements[4],m.elements[5],m.elements[6],m.elements[7],m.elements[8],m.elements[9],m.elements[10],m.elements[11],m.elements[12],m.elements[13],m.elements[14],m.elements[15]]).buffer};l.AsyncInterface.prototype._makeBoxesStruct=function(n){if(n==undefined){return undefined}var o=new Float32Array(n.length*6);for(var m=0;m<n.length;++m){o.set([n[m].min.x,n[m].min.y,n[m].min.z,n[m].max.x,n[m].max.y,n[m].max.z],6*m)}return o.buffer};l.AsyncInterface.prototype._makeMatricesStruct=function(n){if(n==undefined||n[0]==undefined){return undefined}var p=new Float64Array(n.length*16);for(var o=0;o<n.length;++o){var m=n[o];p.set([m.elements[0],m.elements[1],m.elements[2],m.elements[3],m.elements[4],m.elements[5],m.elements[6],m.elements[7],m.elements[8],m.elements[9],m.elements[10],m.elements[11],m.elements[12],m.elements[13],m.elements[14],m.elements[15]],16*o)}return p.buffer};l.AsyncInterface.prototype.setWorkerStartedCallback=function(m){this.workerStartedCallback=m};l.AsyncInterface.prototype.setWorkerReadyCallback=function(m){this.workerReadyCallback=m};l.AsyncInterface.prototype.setLoadCandidatesCallback=function(m){this.loadCandidatesCallback=m};l.AsyncInterface.prototype.setUnloadCandidatesCallback=function(m){this.unloadCandidatesCallback=m};l.AsyncInterface.prototype.setErrorCallback=function(m){this.errorCallback=m};l.AsyncInterface.prototype.pollWorker=function(){this.ldhWorker.bufferedPostMessage(["ready"])};l.AsyncInterface.prototype.autoLoad=function(n,o){if(!this.ldhWorker.waitingLoadResponse){var m=this._makeViewpointStruct(n);if(m!=undefined){this.ldhWorker.waitingLoadResponse=true;this.ldhWorker.bufferedPostMessage(["autoLoad",JSON.stringify(m),n.camera.getLookAt(),o]);return 0}else{l.log("Error in autoLoad: viewpoint is invalid");return -1}}else{this.ldhWorker._flushMessages()}return 0};l.AsyncInterface.prototype.autoUnload=function(n,o){if(!this.ldhWorker.waitingUnloadResponse){this.ldhWorker.waitingUnloadResponse=true;var m=this._makeViewpointStruct(n);if(m!=undefined){this.ldhWorker.bufferedPostMessage(["autoUnload",JSON.stringify(m),n.camera.getLookAt(),o]);return 0}else{l.log("Error in autoLoad: viewpoint is invalid");return -1}}else{this.ldhWorker._flushMessages()}return 0};l.AsyncInterface.prototype.registerObject=function(p,o,n){if(this.registerCount>=this.maxRegisterCount){var m=l.error.eOutOfMemory}if(p==undefined){l.log("Error in AsyncInterface::registerObject: object is undefined!");return l.error.eInvalidArg}else{if(p.ldhId!=undefined){l.log("Error in AsyncInterface::registerObject: object already has an ldhId field!");return l.error.eInvalidArg}else{if(o==undefined){l.log("Error in AsyncInterface::registerObject: boundingBox is undefined!");return l.error.eInvalidArg}else{var r;if(n!=undefined){if(n.elements==undefined||n.elements.length!=16){l.log("Error in AsyncInterface::registerObject: matrix is invalid!");return l.error.eInvalidArg}if(!(n.elements instanceof Float32Array)){for(var q=0;q!=n.elements.length;++q){if(typeof n.elements[q]!="number"){console.log("Error in Context::registerObject: matrix is invalid!");return l.error.eInvalidArg}}}r=new k.Box3();this.helpers.applyMatrix(o,n,r)}else{r=o}p.ldhId=this.asyncIndex;this.asyncIndex+=1;this.objectIdHash[p.ldhId]=p;var s=-1;if(this.ldhContext.boxPool!=undefined){s=this.ldhContext.boxPool.getBoxId(new k.Box3(r.min,r.max))}this.ldhWorker.bufferedPostMessage(["registerObject",p.ldhId,p.uri,o,n,s]);this.registerCount+=1}}}return l.error.sOk};l.AsyncInterface.prototype.unregisterObject=function(m){if(m==undefined){l.log("Error in AsyncInterface::unregisterObject: object is undefined!");return l.error.eInvalidArg}else{if(m.ldhId!=undefined){this.ldhWorker.bufferedPostMessage(["unregisterObject",m.ldhId]);this.registerCount-=1;this.objectIdHash[m.ldhId]=undefined;if(this._LDHDebug){this._debug._idLDHLoaded["delete"](m.ldhId)}delete m.ldhId}}return l.error.sOk};l.AsyncInterface.prototype.unregisterAllObjects=function(){this.objectIdHash=[];this.registerCount=0;this.ldhWorker.bufferedPostMessage(["unregisterAllObjects"]);if(this.ldhContext.boxPool!=undefined){this.ldhContext.boxPool.yieldAllBoxes()}return l.error.sOk};l.AsyncInterface.prototype.updateObject=function(o,n,m){if(o==undefined){l.log("Error in AsyncInterface::updateObject: object is undefined!");return l.error.eInvalidArg}else{if(o.ldhId==undefined){l.log("Error in AsyncInterface::updateObject: object has no ldhId field!");return l.error.eInvalidArg}else{if(m!=undefined){if(m.elements==undefined||m.elements.length!=16){l.log("Error in AsyncInterface::updateObject: matrix is invalid!");return l.error.eInvalidArg}if(!(m.elements instanceof Float32Array)){for(var p=0;p!=m.elements.length;++p){if(typeof m.elements[p]!="number"){console.log("Error in Context::registerObject: matrix is invalid!");return l.error.eInvalidArg}}}}else{if(n==undefined){l.log("Error in AsyncInterface::updateObject: both matrix and bounding boxes are missing!");return l.error.eInvalidArg}}this.countToStopAnim=0;this.ldhWorker.bufferedPostMessage(["updateObject",o.ldhId,this._makeBoxStruct(n),this._makeMatrixStruct(m)])}}return l.error.sOk};l.AsyncInterface.prototype.getLoadCandidates=function(n,o){if(!this.ldhWorker.waitingLoadResponse){var m=this._makeViewpointStruct(n);if(m!=undefined){this.ldhWorker.waitingLoadResponse=true;this.ldhWorker.bufferedPostMessage(["getLoadCandidates",JSON.stringify(m),n.camera.getLookAt(),o]);return[]}else{return undefined}}else{this.ldhWorker._flushMessages()}};l.AsyncInterface.prototype.getUnloadCandidates=function(n,o){if(!this.ldhWorker.waitingUnloadResponse){var m=this._makeViewpointStruct(n);if(m!=undefined){this.ldhWorker.waitingUnloadResponse=true;this.ldhWorker.bufferedPostMessage(["getUnloadCandidates",JSON.stringify(m),n.camera.getLookAt(),o]);return[]}else{return undefined}}else{this.ldhWorker._flushMessages()}};l.AsyncInterface.prototype.notifyLoad=function(o){if(o==undefined){l.log("Error in notifyLoad: objects is invalid");return l.error.eInvalidArg}var n=[];var m=false;if(o.length>0){if(o[0].ldhId!=undefined){o.forEach(function(p){n.push(p.ldhId)})}else{o.forEach(function(p){if(p.object!=undefined){n.push(p.object.ldhId)}else{m=true}})}if(m){l.log("Error in notifyLoad: invalid objects");return l.error.eInvalidArg}else{this.ldhWorker.bufferedPostMessage(["notifyLoad",n])}}return l.error.sOk};l.AsyncInterface.prototype.notifyUnload=function(o){if(o==undefined){l.log("Error in notifyUnload: objects is invalid");return l.error.eInvalidArg}var n=[];var m=false;if(o.length>0){if(o[0].ldhId!=undefined){o.forEach(function(p){n.push(p.ldhId)})}else{o.forEach(function(p){if(p.object!=undefined){n.push(p.object.ldhId)}else{m=true}})}if(m){l.log("Error in notifyUnload: invalid objects");return l.error.eInvalidArg}else{this.ldhWorker.bufferedPostMessage(["notifyUnload",n])}}return l.error.sOk};l.AsyncInterface.prototype.enableLoadingBoxes=function(p,o,n){var m=this.ldhContext.enableLoadingBoxes(p,o,n);if(m==l.error.sOk&&this.ldhWorker!==null||this.ldhWorker!==undefined){this.ldhWorker.bufferedPostMessage(["enableLoadingBoxes",n])}return m};l.AsyncInterface.prototype.flushMessages=function(){this.ldhWorker._flushMessages()};l.AsyncInterface.prototype.toggleClippingPlanes=function(m){this.ldhWorker.bufferedPostMessage(["toggleClippingPlanes",m==true]);return l.error.sOk};l.AsyncInterface.prototype.addClippingPlane=function(m){this.ldhWorker.bufferedPostMessage(["addClippingPlane",[m.normal.x,m.normal.y,m.normal.z,m.constant]]);return l.error.sOk};l.AsyncInterface.prototype.removeClippingPlane=function(m){this.ldhWorker.bufferedPostMessage(["removeClippingPlane",[m.normal.x,m.normal.y,m.normal.z,m.constant]]);return l.error.sOk};l.AsyncInterface.prototype.emptyClippingPlanes=function(){this.ldhWorker.bufferedPostMessage(["emptyClippingPlanes"]);return l.error.sOk};l.AsyncInterface.prototype.setGlobalBox=function(n){this.hasRootBB=false;var m=l.error.eInvalidArg;if(this.ldhContext.boxPool!=undefined){m=this.ldhContext.boxPool.setGlobalBox(n)}if(m==l.error.sOk){this.hasRootBB=true;this.ldhWorker.modelLoader.setOnLoadedCallback(null);this.ldhWorker.modelLoader.setOnLoadedProductStructureCallback(null)}else{this.ldhWorker.modelLoader.setOnLoadedCallback(this._fullLoadCB);this.ldhWorker.modelLoader.setOnLoadedProductStructureCallback(this._prdCB)}return m};l.AsyncInterface.prototype.expandGlobalBox=function(m){if(this.hasRootBB){return this.ldhContext.boxPool.expandGlobalBox(m)}else{return l.error.eFail}};l.AsyncInterface.prototype._modifyURL=function(m,n){this.ldhWorker.bufferedPostMessage(["modifyURL",[m,n]]);return l.error.sOk};l.AsyncInterface.prototype._profileWorker=function(m){this.ldhWorker.bufferedPostMessage(["profile",m])};l.AsyncInterface.prototype._endProfileWorker=function(){this.ldhWorker.bufferedPostMessage(["profileEnd"])};l.AsyncInterface.prototype._checkOccurrences=function(){if(this.ldhOccs!=undefined){for(var m=0;m<this.ldhOccs.length;m+=1){if(this.ldhOccs[m].node==undefined){console.error("_checkOccurences : node deleted but occurrences remained")}}}};l.AsyncInterface.prototype._notifyFrame=function(){this.fpsFrameCount+=1;if(this.fpsFrameCount>=10){this.fpsFrameCount=0;var m=Date.now();var o=Math.round(10*1000/(m-this.timestamp));var n=(o-this.fps)/10;this.fps=o;this.timestamp=m}};l.AsyncInterface.prototype.destructor=function(){this.ldhContext.destructor();this.ldhContext=undefined;this.ldhWorker.terminate();this.ldhWorker=null;this.ldhWorkerStarted=false};l.AsyncInterface.prototype._forceLoad=function(m,n){if(n==undefined){n=true}this.ldhWorker.bufferedPostMessage(["forceLoad",[m,n]]);return l.error.sOk};var i=function(v,w,u,p){if(p[v.id]!=undefined){return p[v.id]}var x;if(u){x=new k.Matrix4()}else{x=v.getMatrix()}if(v==w){return[x]}var y=[];var q=x.isIdentity();var n=v.parents.length;for(var r=0;r<n;r+=1){var t=i(v.parents[r],w,false,p);var m=t.length;for(var o=0;o<m;o+=1){var s=t[o].clone();if(!q){s.multiply(x)}y.push(s)}}p[v.id]=y;return y};var g=function(v,w,o,q){if(q[v.id]!=undefined){return q[v.id]}if(v==w){var x;if(o){x=new k.Matrix4()}else{x=v.getMatrix()}return[x]}var x=v.getMatrix();var y=[];var r=x.isIdentity();var n=v.parents.length;for(var s=0;s<n;s+=1){var u=g(v.parents[s],w,o,q);var m=u.length;for(var p=0;p<m;p+=1){var t=u[p].clone();if(!r){t.multiply(x)}y.push(t)}}q[v.id]=y;return y};var f=function(p,n){var m=n.id;var o=p;while(o.node.id!=n.id){o=o.parent;if(o==undefined){return false}}return true};var d=function(p,m){if(p.node.ldhRegistrations!=undefined){m.push(p);return}var q=[];var o=p.children.length;for(var n=0;n<o;n+=1){d(p.children[n],m)}};var b=function(s,t){if(s.ldhRegistrations!=undefined){if(t||s.getMatrix().isIdentity()){return[[s.ldhRegistrations,[]]]}else{return[[s.ldhRegistrations,[s.getMatrix()]]]}}var n=[];var q=s.children.length;for(var p=0;p<q;p+=1){var o=b(s.children[p],false);var r=o.length;for(var m=0;m<r;m+=1){if(!t&&!s.getMatrix().isIdentity()){o[m][1].push(s.getMatrix())}n.push(o[m])}}return n};l.AsyncInterface.prototype._addRemoveUpdateHelper=function(q,o,r){var n=[];var p=i(q,this.sg,r,n);if(p.length==0){return[]}var m=b(o,r);if(m.length==0){return[]}return[p,m]};l.AsyncInterface.prototype._addRemoveUpdateHelper2=function(p,o){if(!p.linkedToSceneGraph){return[]}var m=[];for(var n=0;n<o._occurrences.length;n+=1){if(o._occurrences[n].parent.node.id==p.id&&f(o._occurrences[n],this.sg)){d(o._occurrences[n],m)}}return m};l.AsyncInterface.prototype._applyPath=function(m,o){for(var n=o.length-1;n>=0;n-=1){m.multiply(o[n])}};l.AsyncInterface.prototype._onMatrixUpdate=function(q,p){var s=(q.matrix==undefined||q.matrix.isIdentity());var m=(p==undefined||p.isIdentity());if(!s||!m){if(f(q,this.sg)){if(q.ldhRegistrations==undefined){return}for(var r=0;r<q.ldhRegistrations.length;r+=1){var o=q.ldhRegistrations[r];if(o.ldhObject!=undefined){if(!q.matrix.equals(o.ldhObject.matrix)){if(o.ldhObject.ldhId!=undefined){var n=this.updateObject(o.ldhObject,undefined,q.matrix);if(n==l.error.sOk){o.ldhObject.matrix=q.matrix.clone()}else{console.error("Error in _onMatrixUpdate: updateObject failed")}}else{o.ldhObject.matrix=q.matrix.clone()}}}}}}};l.AsyncInterface.prototype._addNode=function(u,t){var v=this._addRemoveUpdateHelper2(u,t);if(!v.length){return}if(this._ldhHelper!=undefined){while(this._ldhHelper.checkBatch(this,this.viewpoint,this.highPriorityCount)){}}this.countToStopAnim=0;for(var s=0;s<v.length;s+=1){var r=v[s];var n=r.node;for(var q=0;q<n.ldhRegistrations.length;q+=1){var o=n.ldhRegistrations[q];var p={uri:o.uri,selectiveLoadingParent:n,matrix:r.matrix.clone()};var w=l.error.sOk;var m=r.ldhRegistrations;if(m==undefined||m[q]==undefined||m[q].ldhObject==undefined||m[q].ldhObject.ldhId==undefined){w=this.registerObject(p,o.localAABox,p.matrix);if(w==l.error.sOk){if(r.ldhRegistrations==undefined){r.ldhRegistrations=[]}if(r.ldhRegistrations.length<=q){r.ldhRegistrations.push({localAABox:o.localAABox,uri:o.uri,selectiveLoadingParent:o.selectiveLoadingParent})}r.ldhRegistrations[q].ldhObject=p}else{console.error("Error in _addNode: registerObject failed")}}}}};l.AsyncInterface.prototype._removeNode=function(s,q){this._noLDHCgrToLoad=0;this._noLDHCgrLoaded=0;var u=l.error.sOk;var t=this._addRemoveUpdateHelper2(s,q);if(!t.length){return}if(this._ldhHelper!=undefined){while(this._ldhHelper.checkBatch(this,this.viewpoint,this.highPriorityCount)){}}for(var p=0;p<t.length;p+=1){var n=t[p];for(var o=0;o<n.ldhRegistrations.length;o+=1){var m=n.ldhRegistrations[o];var r=m.ldhObject;var u=this.unregisterObject(r);if(u==l.error.sOk){if(r.selectiveLoadingNode!==undefined&&r.selectiveLoadingNode!=null){delete r.selectiveLoadingNode.ldhObjects}m.ldhObject=undefined}else{console.error("Error in _removeNode: unregisterObject failed.")}}}};l.Helpers.prototype.setRegisterBatchSize=function(o,m,n){if(n==undefined){n=o}if(m==undefined){m=1}if(o==undefined){return l.error.eInvalidArg}this.batchSize=o;this.autoloadSize=m;this.firstBatchSize=n;this.isFirstBatch=true;this.batchCount=0;this.buffer=[];return l.error.sOk};l.Helpers.prototype.registerBatch=function(m,o,n){this.buffer.push([m,o,n]);return l.error.sOk};l.Helpers.prototype.checkBatch=function(p,q,s){if(this.buffer.length==0){return false}var m=l.error.sOk;var o=this.batchSize;if(this.isFirstBatch){o=this.firstBatchSize}var r=this.buffer.length;if(this.buffer.length>=o){r=o}for(var n=0;n<r;n+=1){m=p.registerObject(this.buffer[n][0],this.buffer[n][1],this.buffer[n][2]);if(m!=l.error.sOk){l.log("Error in checkBatch: registerObject failed");if(p.errorCallback!=undefined){p.errorCallback("Error : a registerObject failed in checkBatch",this.buffer[n][0],m)}}}if(this.buffer.length>=o){this.buffer=this.buffer.slice(o);p.flushMessages();this.batchCount+=1;if(this.isFirstBatch||this.batchCount==this.autoloadSize){if(this.isFirstBatch){this.isFirstBatch=false}else{this.batchCount=0}m=(p.autoLoad(q,s)!=-1?l.error.sOk:l.error.eFail);if(m!=l.error.sOk){l.log("Error in checkBatch: autoLoad failed");if(p.errorCallback!=undefined){p.errorCallback("Error : autoLoad failed in checkBatch",m)}}}}else{this.buffer=[]}return this.buffer.length!=0};l.Helpers.prototype._recursiveHelper=function(o,m,n){};l.Helpers.prototype._registerMultipleParentsBatch=function(v,n,u,s){if(u==undefined||n==undefined){return l.error.eInvalidArg}var t=v._ldhInterface._ldhAsyncInterface.sg;if(t=="undefined"){l.log("Error in _registerMultipleParentsBatch: root undefined")}if(this.isFirstBatch&&this.buffer.length>=this.firstBatchSize){this.checkBatch(v._ldhInterface._ldhAsyncInterface,v._ldhInterface._ldhAsyncInterface.viewpoint,v._ldhInterface._ldhAsyncInterface.highPriorityCount)}if(n.ldhRegistrations==undefined){n.ldhRegistrations=[];for(var r=0;r<n._occurrences.length;r+=1){n._occurrences[r].ldhRegistrations=[]}}n.ldhRegistrations.push({localAABox:s,uri:u,selectiveLoadingParent:n,});for(var r=0;r<n._occurrences.length;r+=1){n._occurrences[r].ldhRegistrations.push({localAABox:s,uri:u,selectiveLoadingParent:n,})}var m=n.ldhRegistrations.length;var q=n.ldhRegistrations[m-1];var p=[];for(var r=0;r<n._occurrences.length;++r){if(undefined==n._occurrences[r].matrix||null==n._occurrences[r].matrix){continue}var o={uri:u,selectiveLoadingParent:n,matrix:n._occurrences[r].matrix.clone()};n._occurrences[r].ldhRegistrations[m-1].ldhObject=o;this.registerBatch(o,s,o.matrix)}return l.error.sOk};l.Helpers._ldhCleanup=function(m){m._ldhInterface._ldhAsyncInterface.viewer.unsubscribe(m._ldhInterface._ldhAsyncInterface.onPreRenderToken);if(m._ldhInterface._ldhAsyncInterface.animatonToken){c.unsubscribe(m._ldhInterface._ldhAsyncInterface.animatonToken)}m._ldhInterface._ldhAsyncInterface.sg._occurrences[0].__proto__.updateMatrix=m._ldhInterface._ldhAsyncInterface.sg._occurrences[0].__proto__._noLDHUpdateMatrix;delete m._ldhInterface._ldhAsyncInterface.sg._occurrences[0].__proto__._noLDHUpdateMatrix;m._ldhInterface._ldhAsyncInterface.sg.__proto__.removeChild=m._ldhInterface._ldhAsyncInterface.sg.__proto__._noLDHRemoveChild;delete m._ldhInterface._ldhAsyncInterface.sg.__proto__._noLDHRemoveChild;m._ldhInterface._ldhAsyncInterface.destructor();delete m._ldhInterface._ldhAsyncInterface;delete m._ldhInterface._ldhHelper;delete m._ldhInterface};l.Helpers._enableLoadingBoxes=function(p,o,n){if(typeof o!="number"||(o|0)!=o){return false}if(n==undefined){n=p._ldhInterface._ldhAsyncInterface.sg}var m=p._ldhInterface._ldhAsyncInterface.enableLoadingBoxes(n,o);return m==l.error.sOk};l.Helpers._enableLDH=function(z,s,t,x,q,A){if(A==undefined){A=z.targetNode}if(A==undefined||s==undefined||typeof s.onPreRender!="function"||t==undefined||t.camera==undefined||(z._ldhInterface&&z._ldhInterface._ldhAsyncInterface!=undefined)){if(typeof x=="function"){x()}return false}var r=1000;var m=3;var o=100;z._ldhInterface=new l.LDHInterface(z);var u=z._ldhInterface;u._ldhAsyncInterface=new l.AsyncInterface(z);var n=u._ldhAsyncInterface;if(n._LDHDebug){var p=new UWA.Element("div",{html:"LDHCounter",styles:{fontFamily:"arial, sans-serif",fontSize:"20px",color:"white",position:"absolute",top:"20px",right:"10px",textAlign:"left",verticalAlign:"middle",backgroundColor:"#333"}});p.inject(s.div);u._LDHCounter=p;u._frameRateLDHCounter=0;u._frameCountLDHCounter=0}u._ldhAsyncInterface.sg=A;u._ldhHelper=new l.Helpers();n._ldhHelper=u._ldhHelper;n.highPriorityCount=20;n.lowPriorityCount=100;n.frameCount=-40;n.viewpoint=t;if(typeof x=="function"){n.setErrorCallback(x)}var w=u._ldhHelper.setRegisterBatchSize(r,m,o);n.forceReframe=false;n.hasRootBB=false;var y=function(){var B=u._ldhAsyncInterface;B._checkOccurrences();B._notifyFrame();u._ldhHelper.checkBatch(B,B.viewpoint,B.highPriorityCount);B.autoLoad(B.viewpoint,B.highPriorityCount);B.frameCount+=1;if(B._LDHDebug){u.displayLDHCounter()}if(B.frameCount==20){B.frameCount=0;B.autoUnload(B.viewpoint,B.lowPriorityCount)}if(B._LDHDebug){if(u._frameRateLDHCounter>0){u._frameCountLDHCounter+=1;if(u._frameRateLDHCounter==u._frameCountLDHCounter){u.displayLDHCounter();u._frameCountLDHCounter=0}}}};var v=u._ldhAsyncInterface;if(A._occurrences[0].__proto__._noLDHUpdateMatrix==undefined){A._occurrences[0].__proto__._noLDHUpdateMatrix=A._occurrences[0].__proto__.updateMatrix;A._occurrences[0].__proto__.updateMatrix=function(B,D){var C=this._noLDHUpdateMatrix(B,D);v._onMatrixUpdate(this,B);return C}}if(A.__proto__._noLDHRemoveChild==undefined){A.__proto__._noLDHRemoveChild=A.__proto__.removeChild;A.__proto__.removeChild=function(B){v._removeNode(this,B);return this._noLDHRemoveChild(B)}}n._fullLoadCB=function(){n.viewer.render({updateInfinitePlane:true});n.viewpoint.reframe();z.setOnLoadedCallback(null)};z.setOnLoadedCallback(n._fullLoadCB);n._prdCB=function(B){n._noLDHCgrLoaded++;var C=Math.floor((n._noLDHCgrLoaded/n._noLDHCgrToLoad)*100);if(Math.floor((n._noLDHCgrLoaded/n._noLDHCgrToLoad)*100)%20==0){n.viewpoint.reframe()}};z.setOnLoadedProductStructureCallback(n._prdCB);n._noLDHCgrLoaded=0;n._noLDHCgrToLoad=0;n.viewer=s;n.onPreRenderToken=s.onPreRender(y);setTimeout(function(){n.useAnimation=true;var B={updateRender:function(){if(n.countToStopAnim<=10){n.viewer.render()}}};var D={duration:function(){return 0},valueAt:function(E){return 0}};var C=new h(B,"updateRender",D);C.setLoop(true);C.start();n.animatonToken=c.subscribe({event:"/VISU/"},function(E){if(E.eventType==="@onViewpointEndMove"){C.resume();n.countToStopAnim=0}else{if(E.eventType==="@onViewpointBeginMove"){C.pause();z.setOnLoadedCallback(null);z.setOnLoadedProductStructureCallback(null)}}})},2000);return w==l.error.sOk};l.Helpers._onLoadModel=function(q,o,n,p){if(o.localAABox==null||o.localAABox.min.x>=o.localAABox.max.x||o.localAABox.min.y>=o.localAABox.max.y||o.localAABox.min.z>=o.localAABox.max.z||!q._ldhInterface._ldhAsyncInterface.hasRootBB){if(!q._ldhInterface._ldhAsyncInterface.hasRootBB){q._ldhInterface._ldhAsyncInterface._noLDHCgrToLoad++}delete o.localAABox;return q.loadModel(o,n,p)}var m=q._ldhInterface._ldhHelper._registerMultipleParentsBatch(q,n,o.filename,o.localAABox);if(q._ldhInterface._ldhAsyncInterface.objectIdHash.length!=0&&q._ldhInterface._ldhAsyncInterface.countToStopAnim>-1){q._ldhInterface._ldhAsyncInterface.countToStopAnim=0}return m==l.error.sOk};l.LDHInterface=function(m){this._modelLoader=m};l.LDHInterface.prototype={};l.LDHInterface.prototype.constructor=l.LDHInterface;l.LDHInterface.prototype.version="0.0.1";l.LDHInterface.prototype.displayLDHCounter=function(){var m=0;if(this._ldhAsyncInterface.registerCount>0&&this._ldhAsyncInterface._debug._idLDHLoaded.size<=this._ldhAsyncInterface.registerCount){m=this._ldhAsyncInterface._debug._idLDHLoaded.size/this._ldhAsyncInterface.registerCount;m=m*100;m=m.toFixed(2)}this._LDHCounter.setHTML(String(m))};l.LDHInterface.prototype.activateLDHCounter=function(m){this._frameRateLDHCounter=m};l.LDHInterface.prototype.desactivateLDHCounter=function(){this._frameRateLDHCounter=0};l.LDHInterface.prototype.unregisterAllObjects=function(){this._ldhHelper=new l.Helpers();var p=1000;var n=10;var o=100;var m=this._ldhHelper.setRegisterBatchSize(p,n,o);if(m==l.error.sOk){m=this._ldhAsyncInterface.unregisterAllObjects()}return m==l.error.sOk};l.LDHInterface.prototype.modifyURL=function(q,m){while(this._ldhHelper.checkBatch(this._ldhAsyncInterface,this._ldhAsyncInterface.viewpoint,this._ldhAsyncInterface.highPriorityCount)){}if(q.ldhRegistrations==undefined){return}var n=[];var w=q.ldhRegistrations.length;if(w!=1){var u=function(x){var z=x.ldhRegistrations[y].uri;for(var y=0;y<w;++y){if(x.ldhRegistrations[y].uri!==z){return false}}return true};if(!u(q)){console.error("Error check_same_url : should have the same url");v=l.error.eFail}}for(var t=0;t<w;t+=1){q.ldhRegistrations[t].uri=m}var p=q._occurrences.length;for(var s=0;s<p;s+=1){var r=q._occurrences[s];for(var t=0;t<w;t+=1){r.ldhRegistrations[t].uri=m;r.ldhRegistrations[t].ldhObject.uri=m;var o=r.ldhRegistrations[t].ldhObject.ldhId;if(o!=undefined){n.push(o)}}}var v=this._ldhAsyncInterface._modifyURL(n,m);return v==l.error.sOk};l.LDHInterface.prototype.forceLoad=function(q,o){while(this._ldhHelper.checkBatch(this._ldhAsyncInterface,this._ldhAsyncInterface.viewpoint,this._ldhAsyncInterface.highPriorityCount)){}var m=[];var p=q._occurrences.length;for(var s=0;s<p;s+=1){var r=q._occurrences[s];if(r.ldhRegistrations!=undefined){var v=r.ldhRegistrations.length;for(var t=0;t<v;t+=1){var n=r.ldhRegistrations[t].ldhObject.ldhId;if(n!=undefined){m.push(n)}}}}var u=this._ldhAsyncInterface._forceLoad(m,o);return u==l.error.sOk};l.LDHInterface.prototype.enableLDHLoadingBoxes=function(n,m){return this._modelLoader.LDH.Helpers._enableLoadingBoxes(this._modelLoader,n,m)};l.LDHInterface.prototype.setGlobalBox=function(m){return this._ldhAsyncInterface.setGlobalBox(m)==l.error.sOk};l.LDHInterface.prototype.expandGlobalBox=function(m){return this._ldhAsyncInterface.expandGlobalBox(m)==l.error.sOk};return l});