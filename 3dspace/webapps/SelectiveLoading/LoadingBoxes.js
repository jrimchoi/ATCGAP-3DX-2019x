define("DS/SelectiveLoading/LoadingBoxes",["DS/SelectiveLoading/SelectiveLoadingImpl","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory"],function(a,e,d,b){a.Helpers.prototype.buildBox=function(g,f,k,j,i,h){return new d.Box3(new d.Vector3(g,f,k),new d.Vector3(j,i,h))};var c=function(k,r){this.boxCount=r;this.unused=new Array(r);this.allBoxedUsed=false;this._colorHideBox=new d.Vector4(0,0,0,0);this._colorShowBox=new d.Vector4(0,0,1,0.005);var m=new d.MeshBasicMaterial({force:true,side:d.FrontSide,opacity:0.05});m.activatePDSFX();var l={vColor:{type:"v4"}};m.setPDSFXVaryings({vColor:{type:"v4"}});var h={ProcessViewTangentSpace:["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","vec3 localPosition = vGetAttribPosition();","mat4 WVMat = vGetWorldViewMatrix();","ioWorldViewTS.Position = (WVMat * (instanceMatrix * vec4(localPosition, 1.0))).xyz;","}"].join("\n"),ComputeVaryingValues:"void ComputeVaryingValues() { vColor = instanceColor; }"};var q={ComputeDiscard:"bool ComputeDiscard() { return vColor.w == 0.0; }",ProcessFinalColor:"void ProcessFinalColor(inout vec4 ioFinalColor) { ioFinalColor = vColor;}"};m.setPDSFXOverridableFunctions(h,q);m.force=true;m.opacity=0.05;this.template=b.createCuboidNode({cornerPoint:new d.Vector3(0,0,0),firstAxis:new d.Vector3(1,0,0),secondAxis:new d.Vector3(0,1,0),thirdAxis:new d.Vector3(0,0,1),color:new e.Color(0,0,1,0.5),fill:true});var f=new Array(r);var n=new Array(r);var g=new d.Vector4(0,0,0,0);var s=new d.Matrix4();for(var j=0;j<r;++j){f[j]=g;n[j]=s;this.unused[r-j-1]=(j+1)*5}var p={data:f,type:"v4",attribName:"instanceColor"};var o={data:n,type:"m4",attribName:"instanceMatrix"};this.template.setPickable(e.NODRAWHL);this.template.setMaterial(m);this.template.setInstancingParameters(f.length,[p,o],"instance");this.template.setShadow(false,false);k.addChild(this.template)};c.prototype.setGlobalBox=function(f){if(f==undefined||f==null||f.min==undefined||f.max==undefined||f.min.x==undefined||f.max.x==undefined||f.min.x>f.max.x||f.min.y==undefined||f.max.y==undefined||f.min.y>f.max.y||f.min.z==undefined||f.max.z==undefined||f.min.z>f.max.z||typeof f.clone!="function"){return a.error.eInvalidArg}this.template.forceBoundingBox(f.clone());return a.error.sOk};c.prototype.expandGlobalBox=function(g){if(g==undefined||g==null||g.min==undefined||g.max==undefined||g.min.x==undefined||g.max.x==undefined||g.min.x>g.max.x||g.min.y==undefined||g.max.y==undefined||g.min.y>g.max.y||g.min.z==undefined||g.max.z==undefined||g.min.z>g.max.z){return a.error.eInvalidArg}var f=this.template.mesh3js.geometry.boundingBox.clone();f.expandByPoint(g.min);f.expandByPoint(g.max);this.template.forceBoundingBox(f);return a.error.sOk};c.prototype.updateBox=function(j,i){if(j!=-1){var g=i.min;var f=i.size();var h=new d.Matrix4(f.x,0,0,g.x,0,f.y,0,g.y,0,0,f.z,g.z,0,0,0,1);this.template.updateInstanceAttribValue({instanceId:j,attribName:"instanceMatrix",value:h})}};c.prototype.updateBoxFromCoordinates=function(g,m,l,k,f,p,n){if(g!=-1){var j=new d.Box3(new d.Vector3(m,l,k),new d.Vector3(f,p,n));var i=j.min;var o=j.size();var h=new d.Matrix4(o.x,0,0,i.x,0,o.y,0,i.y,0,0,o.z,i.z,0,0,0,1);this.template.updateInstanceAttribValue({instanceId:g,attribName:"instanceMatrix",value:h})}};c.prototype.hideBox=function(f){if(f!=-1){this.template.updateInstanceAttribValue({instanceId:f,attribName:"instanceColor",value:this._colorHideBox})}};c.prototype.showBox=function(f){if(f!=-1){this.template.updateInstanceAttribValue({instanceId:f,attribName:"instanceColor",value:this._colorShowBox})}};c.prototype.getBoxId=function(f){if(this.unused.length==0){if(this.allBoxedUsed==false){console.log("All boxes are used (this is supported but may not be what you want: additional objects will not have one).");this.allBoxedUsed=true}return -1|0}var g=this.unused.pop();this.updateBox(g,f);this.showBox(g);return g};c.prototype.yieldBox=function(f){if(f!=-1){this.hideBox(f);this.unused.push(f)}};c.prototype.yieldAllBoxes=function(){this.allBoxedUsed=false;for(var f=0;f<this.boxCount;++f){this.unused[this.boxCount-f-1]=(f+1)*5;this.hideBox((f+1)*5)}};a.Context.prototype.enableLoadingBoxes=function(h,f){if(typeof f!="number"){return a.error.eInvalidArg}if(this.boxPool!=undefined){return a.error.eInvalidState}var g=new c(h,f);this.boxPool=g;if(this.cppContext!=undefined){this.cppContext.setBoxPool(g)}return a.error.sOk};a.Context.prototype.setGlobalBox=function(f){return this.boxPool.setGlobalBox(f)};a.Context.prototype.expandGlobalBox=function(f){return this.boxPool.expandGlobalBox(f)};return a});