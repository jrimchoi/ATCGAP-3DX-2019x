/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationController/CAT3DAnnotBaseControllerInstance",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/SceneGraphUtils","DS/CATWebUXComponents/CATWebUXInfoFlag","DS/SceneGraphNodes/PolyLineSectionUtils","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CATWebUXSlideShow/CATWebUXSlideShowController","DS/Visualization/Viewpoint","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices","DS/WAFData/WAFData","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CoreEvents/Events","DS/ApplicationFrame/CommandsManager","DS/CATWebUXTooltipManager/CATWebUXTooltipManager","DS/CAT3DAnnotationBaseUI/CAT3DAnnotationAttrDiv","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(d,t,x,v,k,r,s,u,l,n,c,f,i,m,g,j,b,p,o,a,w,q,h){var e=t.extend({init:function(af){var Q=af||{};this._parent(Q);var N=Q.ctxViewer;var B=this;var ax=false;var U;var ac=new n();var E;var ar;var ay=[];var aa={};var at=null;var J;var F=new x.MeshPhongMaterial({color:"#436655"});var X;var A;var C=0;var am,S;var Y,az;var ad,Z;var aA;var W;function D(){if(!aA){aA=i.getSlideShowController({context:N.getFrameWindow(),id:"CAT3DAnnotationSlideShow"});var aH={},aC,aE=[],aG=[];function aD(aK,aJ){var aI=aG[aJ-1].label;B.displayViewOrCapture({path:aK,data:{label:aI,icon:aG[aJ-1].icon.replace("icons/22/","icons/32/")}});aA.displaySlideInformation({message:aI+(aJ!==undefined?(" ("+aJ+" / "+aE.length+") "):"")})}function aB(aI,aL){if(aL&&aL.length&&aL[aI[0]]){if(aL[aI[0]].children&&aL[aI[0]].children[aI[1]]){if(aL[aI[0]].children[aI[1]].path){var aJ=aL[aI[0]].children[aI[1]].path.getChildrenPathes();if(aJ&&aJ.length&&aJ[aI[2]]){var aK=aJ[aI[2]].getChildrenPathes();if(aK&&aK.length&&aK[aI[3]]){return aK[aI[3]]}}}}}return undefined}function aF(aK,aR){var aV=0;var aS=[];var aO,aW;for(aV=0;aV<aK.children.length;aV++){if(aK.children[aV].type==="RootViews"){aO=aV}else{if(aK.children[aV].type==="RootCaptures"){aW=aV}}}if(aC&&aK.children[aW].children.length){for(aV=0;aV<aK.children[aW].children.length;aV++){aS.push([aR[0],aR[1],aW,aV]);aG.push({label:aK.children[aW].children[aV].name,icon:aK.children[aW].children[aV].icon})}}else{if(!aC){for(aV=0;aV<aK.children[aO].children.length;aV++){var aP=aK.children[aO].children[aV];if(aP.isSubView){continue}var aT=[aR[0],aR[1],aO,aV];var aQ=aP.name,aN=aP.icon;var aI=aP.associatedCapture;if(aI&&aI.length){aT=[aR[0],aR[1],aW,aI[0]-1]}aS.push(aT);aG.push({label:aQ,icon:aN});var aM=0;if(aI.length>1){for(aM=1;aM<aI.length;aM++){aS.push([aR[0],aR[1],aW,aI[aM]-1]);aG.push({label:aK.children[aW].children[aI[aM]-1].name,icon:aK.children[aW].children[aI[aM]-1].icon})}}if(aP.isMultiSectionView){for(aM=0;aM<aP.multiSectionData.views.length;aM++){var aX=aK.children[aO].children[aP.multiSectionData.views[aM]-1];if(!aX.isSubView){continue}var aL=aX.associatedCapture;if(!aL||(aL&&!aL.length)){continue}for(var aJ=0;aJ<aL.length;aJ++){aS.push([aR[0],aR[1],aW,aL[aJ]-1]);aG.push({label:aK.children[aW].children[aL[aJ]-1].name,icon:aK.children[aW].children[aL[aJ]-1].icon})}}}}for(aV=0;aV<aK.children[aW].children.length;aV++){var aU=aK.children[aW].children[aV];if(!aU.pointedView){aS.push([aR[0],aR[1],aW,aV]);aG.push({label:aU.name,icon:aU.icon})}}}}return aS}aH.onPreviousSlideCB=aA.subscribe("onPreviousSlideCB",function(){for(var aI=0;aI<aE.length;aI++){if(aE[aI].isEqual(K())){if(aI>0){aD(aE[aI-1],aI)}else{aD(aE[aE.length-1],aE.length)}return}}aD(aE[aE.length-1],aE.length)});aH.onNextSlideCB=aA.subscribe("onNextSlideCB",function(){for(var aI=0;aI<aE.length;aI++){if(aE[aI].isEqual(K())){if(aI<aE.length-1){aD(aE[aI+1],aI+2)}else{aD(aE[0],1)}return}}aD(aE[0],1)});aH.onFirstSlideCB=aA.subscribe("onFirstSlideCB",function(){aD(aE[0],1)});aH.onLastSlideCB=aA.subscribe("onLastSlideCB",function(){aD(aE[aE.length-1],aE.length)});aH.onActiveStateModified=aA.subscribe("onActiveStateModified",function(aJ){var aI=0;if(aJ.state){B._getJSONModel(function(aQ){aE=[];for(aI=0;aI<aQ.length;aI++){if(aQ[aI].children){for(var aO=0;aO<aQ[aI].children.length;aO++){var aN=aQ[aI].children[aO];if(aN.isVisible){var aK=aF(aN,[aI,aO]);if(aK.length){for(var aP=0;aP<aK.length;aP++){aE.push(aB(aK[aP],aQ))}aL+=aK.length}}}}}aJ.onBeginSlideShow(aE.length>0);if(!aE.length){return}B._disableAnnotUI();aC=f.getPreference("3DAnnotDisplayCapturesPref");var aL=0;var aM=K();if(aM){for(aI=0;aI<aE.length;aI++){if(aM.isEqual(aE[aI])){aD(aM,aI+1)}}}else{aD(aE[0],1)}})}else{B._enableAnnotUI()}B._publish("onSlideShowActiveStateModified",{state:aJ.state})})}}this.setActiveState=function(aC){ax=aC;U=c.giveAnnotationModelLoader({context:N});if(aC&&!U){var aB=setInterval(function(){U=c.giveAnnotationModelLoader({context:N});if(U){clearInterval(aB);B.setActiveState(ax)}},10);return}D();if(ax&&!ar){ar={};ad={activated:N.getViewer().picking.activated,primitive:N.getViewer().picking.primitive,trapSelectionMesh:N.getViewer().picking.trapSelectionMesh,trapSelection:N.getViewer().picking.trapSelection};Z={activated:N.getViewer().pPicking.activated,primitive:N.getViewer().pPicking.primitive,trapSelectionMesh:N.getViewer().pPicking.trapSelectionMesh,trapSelection:N.getViewer().pPicking.trapSelection};N.getViewer().setPicking({activated:true,primitive:1,trapSelectionMesh:true,trapSelection:true});N.getViewer().setPrePicking({activated:true,primitive:1,trapSelectionMesh:true,trapSelection:true});az=w.getTooltipManager({context:N});Y=az.register({onTooltipReady:ah,filterPath:aj});ar.onAnnotationSetLoaded=U.subscribe("onAnnotationSetLoaded",function(aD){if(aA&&aA.getActiveState()){aA.setActiveState(false)}V(aD.path)});ar.onAnnotationSetPartiallyLoaded=U.subscribe("onAnnotationSetPartiallyLoaded",function(){if(aA&&aA.getActiveState()){aA.setActiveState(false)}});ar.onAnnotationSetRemoved=U.subscribe("onAnnotationSetRemoved",function(){if(aA&&aA.getActiveState()){aA.setActiveState(false)}ab()});ar.onAnnotationVisibilityModified=U.subscribe("onAnnotationVisibilityModified",function(){k.empty()});ar.cmdsManager=a.onCommandStart(B._onCommandStartCB,N.getCommandContext&&N.getCommandContext()?N.getCommandContext():undefined)}else{if(!ax&&ar){if(N.getViewer()){N.getViewer().setPicking({primitive:ad.primitive,trapSelectionMesh:ad.trapSelectionMesh,trapSelection:ad.trapSelection,activated:ad.activated});N.getViewer().setPrePicking({primitive:Z.primitive,activated:Z.activated,trapSelectionMesh:Z.trapSelectionMesh,trapSelection:Z.trapSelection})}i.unreferenceSlideShowController({context:N.getFrameWindow(),id:"CAT3DAnnotationSlideShow"});aA=null;az.unregister(Y);w.unreferenceTooltipManager({context:N});ab();if(X){X.clean();X=null}if(U&&ar.onAnnotationSetLoaded){U.unsubscribe(ar.onAnnotationSetLoaded)}if(U&&ar.onAnnotationSetRemoved){U.unsubscribe(ar.onAnnotationSetRemoved)}if(U&&ar.onAnnotationVisibilityModified){U.unsubscribe(ar.onAnnotationVisibilityModified)}if(ar.cmdsManager){o.unsubscribe(ar.cmdsManager)}ar=null;ay.splice(0,ay.length)}}B._publish("onAnnotControllerActiveStateChanged",{state:ax})};this.clearController=function(){B.setActiveState(false);N=B=U=ac=E=F=X=A=null;ay=aa=null};this.onAdditionalInfosRequired=function(aB){if(aB.controller==="AnnotBrowser"){require(["DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController"],function(aD){var aC=aD.give3DAnnotBrowserController({context:N});if(aC&&aC.setDataModelMethods){aC.setDataModelMethods(B._getJSONModel,an,ag,O,au,G)}aB.cb()})}else{if(aB.controller==="AnnotScenario"){aB.cb({func:B._getSelectedAnnotationsVisibilityFlag})}else{if(aB&&aB.cb){B._getJSONModel(aB.cb)}}}};this.getAnnotControllerPrototype=function(){var aB={getAnnotationControllerType:function(){if(B){return B.getAnnotationControllerType()}return undefined},onAdditionalInfosRequired:function(aC){if(B){B.onAdditionalInfosRequired(aC)}},setActiveState:function(aC){if(B){B.setActiveState(aC)}},getActiveState:function(){if(B){return B.getActiveState()}return undefined},getFTAViewOrCaptureDisplayInfos:function(aC){if(B){return al(aC)}return undefined},displayFTAViewOrCapture:function(aC){if(B){B.displayViewOrCapture(aC)}},removeFilteringAndClipping:function(){ab()},subscribe:function(aC,aD){if(B){return B.subscribe(aC,aD)}return undefined},unsubscribe:function(aC){if(B){B.unsubscribe(aC)}}};return aB};this.getActiveState=function(){return ax};this.getAnnotationControllerType=function(){return"3DAnnotationBaseServices"};this.subscribe=function(aC,aB){return ac&&aC&&aB?ac.subscribe({event:aC},aB):undefined};this.unsubscribe=function(aB){if(ac&&aB){ac.unsubscribe(aB)}};var al=function(aJ){if(!aJ||(aJ&&!aJ.path&&!aJ.uuid)||!ax||(aJ&&!aJ.cb)){if(aJ.cb){aJ.cb()}return}var aO=aJ.path;if(!aO&&aJ.uuid){var aF=U.getLoadedAnnotationSets();for(var aM=0;aM<aF.length;aM++){var aN=aF[aM].getChildrenPathes();for(var aG=0;aG<aN.length;aG++){if(aN[aG].getLastElement(true).getAnnotationType()==="RootViews"||aN[aG].getLastElement(true).getAnnotationType()==="RootCaptures"){var aE=aN[aG].getChildrenPathes();for(var aB=0;aB<aE.length;aB++){if(aE[aB].getLastElement(true).getAnnotationUuid()===aJ.uuid){aO=aE[aB];break}}if(aO){break}}}if(aO){break}}}if(!aO){if(aJ.cb){aJ.cb()}return}var aH={path:aO};var aD=aO.getLastElement(true);if(!aD.getAnnotationClassType||(aD&&aD.getAnnotationClassType()!=="tpsView"&&aD.getAnnotationClassType()!=="tpsCapture")){if(aJ.cb){aJ.cb(aH)}return}var aL=aO.getParentPath().getParentPath();var aK=aq(aO);if(aK&&(aD.getAnnotationClassType()==="tpsView"||(aD.getAnnotationClassType()==="tpsCapture"&&aD.isSectionPlaneActivated()))){aH.clippingInfos=ap(aK)}aH.visibleAnnotations=[aO,aL];aH.visibleAnnotations=aH.visibleAnnotations.concat(aD.getVisibleAnnotations(aL,true));if(aD.getVisibleBodiesInst){var aI=M(aD.getVisibleBodiesInst(),aL.getParentPath());if(aI&&aI.length){aH.visibleBodies=aI}}if(aD.getHiddenBodiesInst){var aC=M(aD.getHiddenBodiesInst(),aL.getParentPath());if(aC&&aC.length){aH.hiddenBodies=aC}}aH.reframeInfos=z(aO);ao(aO,function(aP){if(aP&&aP.hiddenPaths&&aP.hiddenPaths.length){aH.hiddenAssyComponents=aP.hiddenPaths}if(aP&&aP.visiblePaths&&aP.visiblePaths.length){aH.visibleAssyComponents=aP.visiblePaths}aJ.cb(aH)})};this.getAssociatedInformations=function(aQ,aP){var aE=[];if(!aQ||!aQ.length||!B.getActiveState()){return aE}var aB=null;if(aP&&aP.getAttributeTypesFiltered){aB=aP.getAttributeTypesFiltered()}var aF=f.getPreference("3DAnnotAttributesOrderedList");var aN=function(aZ){var a0=false,a1={};var aY=aZ.getAnnotationHyperlinkData?aZ.getAnnotationHyperlinkData():null;if(aY){if((aB&&aB.indexOf("hyperlinksAndComments")===-1)||aB===null){if(aY.hyperlinksAndComments){a1.hyperlinksAndComments=aY.hyperlinksAndComments;a0=true}if(aY.relatedDocs){a1.relatedDocs=aY.relatedDocs;a0=true}}if(aY.requirements&&((aB&&aB.indexOf("navReq")===-1)||aB===null)){a1.requirements=aY.requirements;a0=true}if(aY.failureModes&&((aB&&aB.indexOf("failureModes")===-1)||aB===null)){a1.failureModes=aY.failureModes;a0=true}}return a0?a1:null};var aK,aS;for(aK=0;aK<aQ.length;aK++){var aT=aQ[aK].getLastElement(true);if(aT.getAnnotationClassType){var aO=aT.getAnnotationClassType()==="tpsAnnotationSet"?-1:aT.getAnnotationID();var aV={id:aO,type:aT.getAnnotationType(),name:aT.getAnnotationName(),icon:aT.getAnnotationIcon(),infos:{}};for(aS=0;aS<aF.length;aS++){aV.infos[aF[aS]]=null}var aJ=false;if(aT.getAnnotationClassType()==="tpsAttribute"){if((aB&&aB.indexOf(aT.getAttributeCategory())===-1)||aB===null){var aH=aT.getAttributeParam();if(!aH){continue}aV.infos[aT.getAttributeCategory()]=aH;aJ=true}}else{if(aT.getAnnotationClassType()==="tps"&&((aB&&aB.indexOf("tolerances")===-1)||aB===null)){var aR;var aC=aT.getTabulatedLimit?aT.getTabulatedLimit():null;var aD=aT.getAnnotationDimensionLimits?aT.getAnnotationDimensionLimits():null;if(aC&&aD){aR={tabulatedLimit:aC,toleranceLimits:aD}}var aX=aT.getGeneralTolerance?aT.getGeneralTolerance():null;if(aX){if(!aR){aR={}}aR.generalTol=aX}if(aR){aV.infos.tolerances=aR;aJ=true}}}var aW=aN(aT);if(aW){d.extend(aV.infos,aW);aJ=true}if(aJ){var aM=Object.keys(aV.infos);for(aS=aM.length-1;aS>=0;aS--){if(!aV.infos[aM[aS]]){delete aV.infos[aM[aS]]}}aE.push(aV)}}else{if(typeof B.getPontingAnnotations==="function"){var aL=B.getPontingAnnotations(aQ[aK],true);if(aL&&aL.length){for(aS=0;aS<aL.length;aS++){var aG=aL[aS].getLastElement(true);if(aG.getAnnotationClassType()==="tpsAttribute"){if((aB&&aB.indexOf(aG.getAttributeCategory())===-1)||aB===null){var aI=aG.getAttributeParam();if(!aI){continue}var aU={};aU[aG.getAttributeCategory()]=aI;aE.push({name:aG.getAnnotationName(),icon:aG.getAnnotationIcon(),infos:aU})}}}}}}}return aE};var aj=function(aC){var aB=aC;while(aB.getLastElement(true).getPickParent()){aB=aB.getParentPath()}return aB};var ah=function(aD){if(!aD||!aD.completed){return}if(!aD.arrayPath||aD.arrayPath.length!==1||!aD.token){aD.completed();return}if(!E){E=new q();N.getFrameWindow().getUIFrame().appendChild(E.getContent())}var aC=B.getAssociatedInformations(aD.arrayPath);var aF;var aE=false;if(aC&&aC.length){E.setTouchDisplay(aD.fromTouchEvt);aF=E.build(aC,false,B.onAttributeClicked);for(var aI=0;aI<aC.length;aI++){var aG=aC[aI].infos;if(aG.hyperlinksAndComments&&aG.hyperlinksAndComments.urls&&aG.hyperlinksAndComments.urls.length||aG.relatedDocs&&aG.relatedDocs.length||aG.requirementsSpec&&aG.requirementsSpec.length||aG.requirements&&aG.requirements.length){aE=true;break}}if(aF){var aH=50;aF.setStyles({"max-width":"300px",width:""});var aJ=d.createElement("div");aJ.setStyles({opacity:"0",position:"absolute",left:"-400px"});N.getFrameWindow().getUIFrame().appendChild(aJ);aJ.appendChild(aF);var aB=setInterval(function(){if(E.getContainerHeight()){N.getFrameWindow().getUIFrame().removeChild(aJ);aJ=undefined;clearInterval(aB);var aK=aF;if(E.areAllInformationVisible({maxHeight:aH})){aE=true;aK=E.buildDivWithDots({maxHeight:aH,callback:function(){r.empty();var aM=a.getCommandCheckHeader("CAT3DAnnotSemanticAttrViewerHdr",N.getCommandContext?N.getCommandContext():null);if(aM&&aM.getState()){w.getTooltipManager({context:N}).destroyTooltip()}else{E.expand()}var aN=[];for(var aL=0;aL<aD.arrayPath.length;aL++){aN.push({pathElement:aD.arrayPath[aL]})}v.empty();k.empty();v.add(aN);k.add(aN)}})}aD.completed({token:aD.token,div:aK,interactiveContent:aE})}},10);return}}aD.completed({token:aD.token,div:aF,interactiveContent:aE})};var G=function(){return aa};this.displayViewOrCapture=function(aC){if(!aC||!ax){return}C++;var aB=C;ab();al({path:aC.path,uuid:aC.uuid,cb:function(aI){if(!aI||(aI&&!aI.path)){return}A=aI.path.clone();var aG=aI.path.getLastElement(true),aD,aF;if(!aG||!aG.getAnnotationClassType||(aG&&aG.getAnnotationClassType()!=="tpsCapture"&&aG.getAnnotationClassType()!=="tpsView")){return}if(C===aB){var aE=aI.path.getParentPath().getParentPath().getChildrenPathes();for(aD=0;aD<aE.length;aD++){var aH=aE[aD].getChildrenPathes();for(aF=0;aF<aH.length;aF++){aH[aF].getLastElement(true).setVisibility(false)}}if(aI.visibleAnnotations){for(aD=0;aD<aI.visibleAnnotations.length;aD++){aI.visibleAnnotations[aD].getLastElement(true).setVisibility(true)}}if((aI.hiddenBodies&&aI.hiddenBodies.length)||(aI.visibleBodies&&aI.visibleBodies.length)){if(aI.visibleBodies&&aI.visibleBodies.length){aa.visibleBodies=[];for(aD=0;aD<aI.visibleBodies.length;aD++){if(s.getVisibilityFromPath&&!s.getVisibilityFromPath(aI.visibleBodies[aD])){aa.visibleBodies.push(aI.visibleBodies[aD]);s.applyVisibilityToPath(aI.visibleBodies[aD],1)}}}if(aI.hiddenBodies&&aI.hiddenBodies.length){aa.hiddenBodies=[];for(aD=0;aD<aI.hiddenBodies.length;aD++){if((s.getVisibilityFromPath&&s.getVisibilityFromPath(aI.hiddenBodies[aD]))||!s.getVisibilityFromPath){aa.hiddenBodies.push(aI.hiddenBodies[aD]);s.applyVisibilityToPath(aI.hiddenBodies[aD],0)}}}}if(aI.hiddenAssyComponents||aI.visibleAssyComponents){ai(aI.hiddenAssyComponents,aI.visibleAssyComponents)}if(aI.clippingInfos){J=aI.clippingInfos;an(J)}N.getViewer().render();au(N.getViewer().currentViewpoint,aI.reframeInfos);T(aC.data&&aC.data.label?aC.data.label:aG.getAnnotationName(),aC.data&&aC.data.icon?aC.data.icon:aG.getAnnotationIcon().replace("icons/22/","icons/32/"));aG.setDisplayFlag(true);if(aC.cb){aC.cb(aI)}B._publish("onViewOrCaptureDisplayed",aI)}}})};function K(){return A}var an=function(aF){if(aF&&aF.path){if(!aF.multiClipping){N.getViewer().addClippingPlane(aF.data,F)}y(aF.rootPath,aF,true);var aB=aF.path.getLastElement(true).getCappingRep?aF.path.getLastElement(true).getCappingRep():null;if(aB){var aD=aF.path.getParentPath().getParentPath().getParentPath();if(!aF.multiClipping){var aC=aF.data.normal.clone().normalize().negate().multiplyScalar(0.01);var aE=new x.Matrix4().makeTranslation(aC.x,aC.y,aC.z);aB.setMatrix(aE)}aD.getLastElement(true).addChild(aB)}N.getViewer().setSectionCapping(true)}};var O=function(){if(J&&J.path){return{multiClipping:J.multiClipping,rootPath:J.rootPath.clone(),path:J.path.clone(),data:J.data}}return undefined};var ag=function(aC){if(aC&&aC.path&&N.getViewer()){if(!aC.multiClipping){N.getViewer().removeClippingPlane(aC.data)}y(aC.rootPath,aC,false);var aB=aC.path.getLastElement(true).getCappingRep?aC.path.getLastElement(true).getCappingRep():null;if(aB){aC.path.getParentPath().getParentPath().getParentPath().getLastElement(true).removeChild(aB)}N.getViewer().setSectionCapping(false)}};var I=function(aC,aI){if(!(aC instanceof Array)||!aI||!ax){return}var aE=[],aD,aB=[];if(h.getLoadedAssetType()==="3DXML"){for(aD=0;aD<aC.length;aD++){var aG=h.getNodeInfos(aC[aD]);aB.push({id:h.getNodeID(aC[aD]),label:aG.name,icon:aG.icon})}aI(aB)}else{for(aD=0;aD<aC.length;aD++){if(h.getNodeID(aC[aD])){aE.push(h.getNodeID(aC[aD]))}}var aH=aE.slice(0);for(aD=aH.length-1;aD>=0;aD--){for(var aF=0;aF<ay.length;aF++){if(ay[aF].id===aH[aD]){aB.push({id:ay[aF].id,label:ay[aF].label,icon:ay[aF].icon});aH.splice(aD,1);break}}}if(aH.length){N.getController().getAttributes({ids:aE,attributes:["ds6w:label","type_icon_url"],callbacks:{onComplete:function(aM){if(!ax){return}var aN=function(aP){for(var aO=0;aO<ay.length;aO++){if(ay[aO].id===aP.id){return}}ay.push(aP)};var aJ=[];for(var aK=0;aK<aE.length;aK++){var aL={id:aE[aK],label:aM[aE[aK]]?aM[aE[aK]]["ds6w:label"]:"",icon:aM[aE[aK]]?aM[aE[aK]].type_icon_url:undefined};aJ.push(aL);aN(aL)}aI(aJ)},onFailure:function(){if(!ax){return}var aJ=[];for(var aK=0;aK<aE.length;aK++){aJ.push({id:aE[aK],label:"",icon:""})}aI(aJ)}}})}else{aI(aB)}}};this._disableAnnotUI=function(){S=true;W=N.isDefaultContextualMenuVisible();if(W){N.setDefaultContextualMenuVisibility(false)}if(X){X.setVisibleFlag(false)}am=null;require(["DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController"],function(aC){var aB=aC.give3DAnnotBrowserController({context:N});if(aB&&aB.getActiveState()){am=aB.getPanelVisibilityFlag();aB.setPanelVisibilityFlag(false)}})};this._enableAnnotUI=function(){S=false;if(W!==undefined){N.setDefaultContextualMenuVisibility(W)}W=undefined;if(X){X.setVisibleFlag(true)}if(am!==null){require(["DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController"],function(aC){var aB=aC.give3DAnnotBrowserController({context:N});if(aB){aB.setPanelVisibilityFlag(am)}})}};this._getJSONModel=function(aH){if(!U){return}var aC=U.getLoadedAnnotationSets();var aB=[],aK;for(aK=0;aK<aC.length;aK++){var aL=R(N.getRootBagPath(),aC[aK]);var aF=aC[aK].getParentPath().getLastElement(true);if(aB.indexOf(aF)===-1){aB.push(aF)}var aJ=aC[aK].getLastElement(true).getContextType();var aE;if(aJ!==1&&aJ!==3){aE=aJ===2?aC[aK].getParentPath().getParentPath():aC[aK].getParentPath();aF=aE.getLastElement(true);if(!aE.isEqual(aL)){while(aE){if(h.isReference(aE.getLastElement(true))){aF=aE.getLastElement(true);break}aE=aE.getParentPath()}}if(aB.indexOf(aF)===-1){aB.push(aF)}}aE=aC[aK].getParentPath();while(aE){if(h.isInstance(aE.getLastElement(true))||aE.isEqual(aL.getParentPath())){if(!aE.isEqual(aL.getParentPath())){if(aB.indexOf(aE.getLastElement(true))===-1){aB.push(aE.getLastElement(true))}}break}aE=aE.getParentPath()}}var aD=N.getRootBagPath().getChildrenPathes();var aI=N.getHideShowController();for(aK=0;aK<aD.length;aK++){if(aI.isVisible(aD[aK])){var aG=U.hasAlreadyBeenLoaded(aD[aK]);if(aG===0||aG===1||aG===3||aG===4||aG===5||aG===6){if(aB.indexOf(aD[aK].getLastElement(true))===-1){aB.push(aD[aK].getLastElement(true))}}}}I(aB,function(a5){if(!B.getActiveState()){aH();return}var aS=U.getLoadedAnnotationSets();var aO=N.getRootBagPath().getChildrenPathes();var a1=[];var aN=[];var aU,a0,aM;for(a0=0;a0<aO.length;a0++){var aW=aO[a0].getLastElement(true);for(aU=0;aU<a5.length;aU++){if(h.getNodeID(aW)===a5[aU].id&&aN.indexOf(aO[a0])===-1){a1.push({id:h.getNodeID(aW),path:aO[a0].clone(),name:a5[aU].label,icon:a5[aU].icon,type:h.getNodeType(aW),children:[]});aN.push(aO[a0]);break}}}for(a0=0;a0<aS.length;a0++){var aY=R(N.getRootBagPath(),aS[a0]);var aX=aS[a0].getParentPath().getLastElement(true);for(aU=0;aU<a5.length;aU++){if(h.getNodeID(aX)===a5[aU].id){var aV=a5[aU].label;var a3=aS[a0].getParentPath();while(a3){if(h.isInstance(a3.getLastElement(true))||a3.isEqual(aY.getParentPath())){if(!a3.isEqual(aY.getParentPath())){for(aM=0;aM<a5.length;aM++){if(a5[aM].id===h.getNodeID(a3.getLastElement(true))&&a5[aM].label){aV+=" ("+a5[aM].label+")"}}}break}a3=a3.getParentPath()}var a2=a5[aU].icon;var aZ=aS[a0].getLastElement(true).getContextType();if(aZ!==1&&aZ!==3){var aP=aZ===2?aS[a0].getParentPath().getParentPath():aS[a0].getParentPath();aF=aP.getLastElement(true);if(!aP.isEqual(aY)){while(aP){if(h.isReference(aP.getLastElement(true))){break}aP=aP.getParentPath()}}if(aP){for(aM=0;aM<a5.length;aM++){if(a5[aM].id===h.getNodeID(aP.getLastElement(true))&&a5[aM].icon){a2=a5[aM].icon}}}}for(aM=0;aM<a1.length;aM++){if(a1[aM].path.isAParentOf(aS[a0])){var a4=false;var aR=U.getDirectChildrenAnnotSets(a1[aM].path);for(var aT=0;aT<aR.length;aT++){if(aR[aT].isEqual(aS[a0])){a4=true}}var aQ=JSON.parse(JSON.stringify(aS[a0].getLastElement(true).toJSON()));aQ.id=aS[a0].getLastElement(true).id;aQ.path=aS[a0].clone();aQ.referenceLabel=aV;aQ.referenceIcon=a2;aQ.isDirectChild=a4;aQ.isLeafChild=h.is3DLeaf(aX);a1[aM].children.push(aQ);break}}break}}}aH(a1)})};this._getSelectedAnnotationsVisibilityFlag=function(){var aN="notAssigned";var aB=localStorage.getItem("3DAnnotLoadARMPartsPref")==="true";var aL=v.get(),aP,aF;for(aP=0;aP<aL.length;aP++){var aQ=aL[aP].pathElement;if(aQ.internalPath.length){while(aQ.internalPath.length){aQ=aQ.getParentPath()}while(!h.isPLMNode(aQ.getLastElement(true))&&!aQ.getLastElement(true).getAnnotationClassType){aQ=aQ.getParentPath()}}var aD=aQ.getLastElement(true);if(aD.getAnnotationClassType){if(aN==="notAssigned"||aN===null){aN=aD.isVisible()}else{if(aN!==aD.isVisible()){return undefined}}}else{if(h.is3DLeaf(aD)){var aE=false;var aM=H(aQ);if(aM){aE=true;aN=aM.getLastElement(true).isVisible()}if(!aE){if(!aQ){if(aN==="notAssigned"){aN=null}continue}var aK=U.hasAlreadyBeenLoaded(aQ);if(aK===1||aK===4){var aJ=U.getLoadedAnnotationSets(aQ);for(aF=0;aF<aJ.length;aF++){if(aN==="notAssigned"||aN===null){aN=aJ[aF].getLastElement().isVisible()}else{if(aN!==aJ[aF].getLastElement().isVisible()){return undefined}}}}else{if(aK===2||aK===5){if(aN==="notAssigned"){aN=null}}else{if(aK===0){if(aN==="notAssigned"||aN===null){aN=false}else{if(aN){return undefined}}}}}}}else{var aI=null;var aO=U.getDirectChildrenAnnotSets(aL[aP].pathElement);if(h.getNodeType(aD)==="CATProduct"){if(aB){aI=U.hasAlreadyBeenLoaded(aL[aP].pathElement,true)}for(aF=0;aF<aO.length;aF++){if(aO[aF].getLastElement(true).getContextType()===2||aO[aF].getParentPath().isEqual(aL[aP].pathElement)){var aH=aO[aF].getLastElement(true).isVisible();if(aI===null){aI=aH}else{if(aI!==aH){aI=undefined;break}}}}}else{for(aF=0;aF<aO.length;aF++){var aC=aO[aF].getLastElement(true).isVisible();if(aI===null){aI=aC}else{if(aI!==aC){aI=undefined;break}}}}if(aI===undefined||(aI!==null&&aN!=="notAssigned"&&aN!==aI)){return undefined}else{if(aI!==null&&aN==="notAssigned"){aN=aI}else{if(aI===null){var aG=U.hasAlreadyBeenLoaded(aL[aP].pathElement);if(aG===2||aG===5){aN=null}else{aN=false}}}}}}}return aN};this._onCommandStartCB=function(aB){if(aB._id==="SwitchVisuOnDemandHdr"){ab()}};var z=function(aD){var aP;var aG=N.getViewer().currentViewpoint.camera.fov;var aE=aD.getLastElement(true);var aF=P(aD);var aC=new x.Matrix4().extractRotation(aF);if(aE.getCaptureCamera&&aE.getCaptureCamera()){aP={};var aK=aE.getCaptureCamera();var aH=new x.Vector3().copy(aK.position);aH.applyMatrix4(aF);aP.target=new x.Vector3().copy(aK.target);aP.target.applyMatrix4(aF);aP.sight=new x.Vector3().copy(aK.direction).normalize();aP.sight.applyMatrix4(aC);aP.up=new x.Vector3().copy(aK.zenith).normalize();aP.up.applyMatrix4(aC).normalize();var aO=aK.zoom;if(aO===0||isNaN(aO)){aP.distanceToTarget=aP.target.distanceTo(aH);aO=1/(aP.distanceToTarget*Math.tan(Math.PI/180*13.5))}aP.distanceToTarget=1/(aO*Math.tan(0.5*aG*Math.PI/180));aP.projectionType=aK.type==="0"?m.PERSPECTIVE:m.ORTHOGRAPHIC;aP.origin=new x.Vector3().copy(aP.target);aP.origin.sub(new x.Vector3().copy(aP.sight).multiplyScalar(aP.distanceToTarget))}else{var aL=aq(aD);if(aL){aP={};aE=aL.getLastElement(true);var aB=aE.getReframeArea();var aI=aE.getViewPlaneInformations();if(aB){var aJ=Math.sqrt(aB.width*aB.width+aB.length*aB.length)/2;var aN=new x.Vector2(aB.cornerX+aB.width/2,aB.cornerY+aB.length/2);var aM=new x.Vector3().crossVectors(aI.direction,aI.normal).normalize();aP.origin=new x.Vector3().copy(aI.origin);aP.origin.add(new x.Vector3().copy(aM).multiplyScalar(aN.x));aP.origin.add(new x.Vector3().copy(aI.direction).multiplyScalar(aN.y));aP.origin.applyMatrix4(aF);aP.sight=new x.Vector3().copy(aI.normal).applyMatrix4(aC).normalize().negate();aP.distanceToTarget=aJ/Math.tan(aG*Math.PI/360);aP.origin.sub(new x.Vector3().copy(aP.sight).multiplyScalar(aP.distanceToTarget));aP.up=new x.Vector3().copy(aI.direction).applyMatrix4(aC).normalize()}else{aP.sight=new x.Vector3().copy(aI.normal).applyMatrix4(aC).normalize().negate();aP.up=new x.Vector3().copy(aI.direction).applyMatrix4(aC).normalize();aP.reframeView=aL.clone()}}}return aP};var au=function(aK,aH,aI){if(!aH||!aK){return}var aM=aH.origin,aP=aH.distanceToTarget;if(!aM&&!aP&&aH.reframeView){var aL;var aE=aH.reframeView.getLastElement(true);var aN=aH.reframeView.getParentPath().getParentPath();var aG=P(aH.reframeView);var aF=aE.getVisibleAnnotations(aN,true);var aR,aJ,aQ;if(aF.length){var aB;for(aR=0;aR<aF.length;aR++){if(aF[aR].getLastElement(true).getAnnotationClassType()!=="tps"){continue}aB=[];av(aF[aR].getLastElement(true),aB);if(aB.length){for(aJ=0;aJ<aB.length;aJ++){aQ=aB[aJ].getBoundingSphere("visibleSpace");if(aQ.radius){if(!aL){aL=new x.Sphere().copy(aQ)}else{aL.mergeWithSphere(aQ,aL)}}}}}if(!aL){aB=[];av(aH.reframeView.getLastElement(true),aB);if(aB.length){for(aJ=0;aJ<aB.length;aJ++){aQ=aB[aJ].getBoundingSphere("visibleSpace");if(aQ.radius){if(!aL){aL=new x.Sphere().copy(aQ)}else{aL.mergeWithSphere(aQ,aL)}}}}}if(aL){aL.center.applyMatrix4(aG)}}else{var aO=aN.getParentPath();var aC;if(aN.getLastElement(true).getContextType()===2){aO=aO.getParentPath();if(h.isInstance(aO.getLastElement(true))){aO=aO.getParentPath()}var aD=aO.getChildrenPathes();for(aR=0;aR<aD.length;aR++){aQ=aD[aR].getBoundingSphere(N.getViewer(),"visibleSpace");if(aQ.radius){if(!aL){aL=new x.Sphere().copy(aQ)}else{aL.mergeWithSphere(aQ,aL)}}}if(aL){aL.center.applyMatrix4(aG)}}else{for(aR=0;aR<aO.getChildrenPathes().length;aR++){if(!aO.getChildrenPathes()[aR].isEqual(aN)){aC=aO.getChildrenPathes()[aR];break}}aL=new x.Sphere().copy(aC.getBoundingSphere(N.getViewer(),"visibleSpace"))}}aM=new x.Vector3().copy(aL.center);if(!aL.radius){aM.copy(aE.getViewPlaneInformations().origin)}aP=aL.radius/Math.tan(aK.camera.fov*Math.PI/360);aM.sub(new x.Vector3().copy(aH.sight).multiplyScalar(aP))}if(aM&&aP&&aH.sight&&aH.up){if(aH.projectionType!==undefined){aK.setProjectionType(aH.projectionType)}if(aI!==0){aK.moveTo({eyePosition:aM,upDirection:aH.up,sightDirection:aH.sight,distanceToTarget:aP,duration:aI>0?aI:400})}else{aK.setEyePosition(aM);aK.setSightDirection(aH.sight);aK.setUpDirection(aH.up);aK.setTargetDistance(aP)}}};function aw(aF){var aJ=aF.getChildrenPathes();var aB={relIds:[],paths:[]};for(var aI=0;aI<aJ.length;aI++){var aG=aJ[aI].getChildrenPathes();for(var aH=0;aH<aG.length;aH++){var aE=aG[aH].getLastElement(true);var aC=aE.getLinkedDataRelatedInfos?aE.getLinkedDataRelatedInfos():null;if(aC&&aC.length){aB.paths.push(aG[aH].clone());for(var aD=0;aD<aC.length;aD++){if(aB.relIds.indexOf(aC[aD].addressRelId)===-1){aB.relIds.push(aC[aD].addressRelId)}}}}}return aB}function ae(aI,aC,aB){if(!aI||(aI&&!aI.length)||!aC||!aB||(aB&&!aB.length)){return}var aD,aF;for(aD=0;aD<aI.length;aD++){for(aF=0;aF<aB.length;aF++){var aE=aB[aF].getLastElement(true);if(aE.getLinkedDataRelatedInfos){var aH=aE.getLinkedDataRelatedInfos();for(var aG=0;aG<aH.length;aG++){if(aH[aG].addressRelId===aI[aD].matches[0].sr_id){aE.addLinkedData({displayLabel:aH[aG].anchorText,label:aI[aD].elements[0]["ds6w:label"],type:aH[aG].type,phyID:aI[aD].elements[0].physicalid,phyType:aI[aD].elements[0]["ds6w:type"]})}}}}}for(aF=0;aF<aB.length;aF++){delete aB[aF].getLastElement(true).getLinkedDataRelatedInfos}}var V=function(aD){if(h.getLoadedAssetType()==="3DXML"){return}var aC=aD?aD.getLastElement(true):null;if(!aD||(aD&&!aC.getAnnotationClassType)||(aD&&aC.getAnnotationClassType&&aC.getAnnotationClassType()!=="tpsAnnotationSet")){return}var aB=aw(aD);if(aB.relIds&&aB.relIds.length&&aB.paths&&aB.paths.length){B._getPointedRelations({physicalID:h.getNodeID(aD.getParentPath().getLastElement(true)),relIds:aB.relIds,semantics:["4"],role:["173"],onComplete:function(aF){if(!B){return}var aE=d.is(aF,"string")?JSON.parse(aF):aF;if(!d.is(aE.result,"array")||aE.result.length<1||!d.is(aE.result[0].outputs.RESULTS,"array")||aE.result[0].outputs.RESULTS.lenght<1){return}ae(aE.result[0].outputs.RESULTS,aD,aB.paths);B._publish("onAnnotationsLinkedDataSolved",{path:aD,succeeded:true})},onFailure:function(){if(!B){return}B._publish("onAnnotationsLinkedDataSolved",{path:aD,succeeded:false})},onTimeout:function(){if(!B){return}B._publish("onAnnotationsLinkedDataSolved",{path:aD,succeeded:false})}})}};var R=function(aC,aG){if(aC.isAParentOf(aG)){var aF=aC.getLastElement(true);if(h.is3DLeaf(aF)||h.isReference(aF)){return aC}else{var aD=aC.getChildrenPathes();for(var aE=0;aE<aD.length;aE++){var aB=R(aD[aE],aG);if(aB){return aB}}}}return undefined};var aq=function(aD){var aC=aD.getLastElement(true);if(!aC||!aC.getAnnotationClassType||aC.getAnnotationClassType()==="tpsView"){return aD}if(!aC||!aC.getAnnotationClassType||aC.getAnnotationClassType()!=="tpsCapture"){return undefined}var aB=aD.getParentPath().getParentPath();if(aC.getPointedView()){var aF=aB.getLastElement(true).getRootAnnotationNode("RootViews");if(aF){var aE=aB.clone();aE.addElement(aF);aE.addElement(aF.children[aC.getPointedView()-1]);return aE}}return undefined};var ap=function(aT){if(aT&&aT.getLastElement(true).getAnnotationClassType()==="tpsView"){var aV=aT.getLastElement(true),aG=aV.getViewType();var aE={};if(aG!=="SectionView"&&aG!=="SectionCutView"&&!aV.isMultiSectionView()){return aE}aE.path=aT.clone();aE.clipPlaneMaterial=F;var aB=N.getRootBagPath();var aU=P(aT);var aI=aB.getChildrenPathes();var aQ;for(aQ=0;aQ<aI.length;aQ++){if(aI[aQ].isAParentOf(aT)){aE.rootPath=aI[aQ].clone()}}var aS=aV.getViewPlaneInformations();var aF=new x.Plane().setFromNormalAndCoplanarPoint(aS.normal.clone().negate(),aS.origin.clone());if(aV.isMultiSectionView()){aE.multiClipping=true;var aY=aV.getMultiSectionData();var aZ=new x.Vector3().copy(aY.SketchNormal).normalize().negate();var aL=new x.Vector3().subVectors(aY.pointsDef[1],aY.pointsDef[0]);var aN=new x.Vector3().crossVectors(aZ,aL).normalize();var aP=aT.getParentPath().getLastElement(true);var aO=aP.children[aY.views[0]-1].getViewPlaneInformations().normal;if(aO.dot(aN)>0){aZ.negate()}var aX=new x.Vector3().copy(aY.SketchOrigin);var aJ=new x.Vector3(aZ.y,aZ.x,aZ.z).normalize();if(aJ.equals(aZ)){aJ=new x.Vector3(aZ.x,aZ.z,aZ.y).normalize()}var aH=new x.Vector3().crossVectors(aZ,aJ).normalize();aX.applyMatrix4(aU);var aW=new x.Matrix4().extractRotation(aU);aJ.applyMatrix4(aW);aH.applyMatrix4(aW);var aK=[];var aD;for(aQ=0;aQ<aY.pointsDef.length;aQ++){var aC=new x.Vector3().copy(aY.pointsDef[aQ]).applyMatrix4(aU);aD=new x.Vector3().subVectors(aC,aX);aK.push(new x.Vector2(aD.dot(aJ),aD.dot(aH)))}var aR={polyLinePoints:aK,planeOrigin:aX,planeU:aJ,planeV:aH};var aM=aB.getLastElement(true).getBoundingSphere("visibleSpace");aM.radius=aM.radius;aE.data=l.makeClosedPolyLine(aR,aM)}else{aE.multiClipping=false;aE.data=aF;aE.data.applyMatrix4(aU)}return aE}return undefined};this._publish=function(aC,aB){ac.publish({event:aC,data:aB,context:B})};var H=function(aD){var aB=aD.getChildrenPathes();for(var aC=0;aC<aB.length;aC++){if(aB[aC].getLastElement(true).getAnnotationClassType&&aB[aC].getLastElement(true).getAnnotationClassType()==="tpsAnnotationSet"){return aB[aC]}}return undefined};var P=function(aD){var aC=aD.clone();while(aC){if(h.isInstance(aC.getLastElement(true))){break}aC=aC.getParentPath()}var aB=new x.Matrix4();if(aC){aB.copy(aC.getWorldMatrix(N.getViewer()))}return aB};var y=function(aF,aG,aC){var aE=aF.getLastElement(true);var aD;if(h.is3DLeaf(aE)){for(aD=0;aD<aE.children.length;aD++){if(!aE.children[aD].getAnnotationClassType){if(!aG.multiClipping){aE.children[aD].enableClippingPlane(aG.data,aC)}else{aE.children[aD].setClippingProfile(aC?aG.data:null)}}}}else{if(aE.getAnnotationClassType){return}else{var aB=aF.getChildrenPathes();for(aD=0;aD<aB.length;aD++){y(aB[aD],aG,aC)}}}};var ab=function(){var aB;if((aa.hiddenBodies&&aa.hiddenBodies.length)||(aa.visibleBodies&&aa.visibleBodies.length)){if(aa.hiddenBodies&&aa.hiddenBodies.length){for(aB=0;aB<aa.hiddenBodies.length;aB++){s.applyVisibilityToPath(aa.hiddenBodies[aB],1)}}if(aa.visibleBodies&&aa.visibleBodies.length){for(aB=0;aB<aa.visibleBodies.length;aB++){s.applyVisibilityToPath(aa.visibleBodies[aB],0)}}}aa.hiddenBodies=null;aa.visibleBodies=null;ag(J);J=null;L();if(at){N.getViewer().getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(at);at=null}N.getViewer().render();B._publish("onFilteringAndClippingRemoved")};var T=function(aC,aB){if(!ax){return}L();if((J&&J.path)||(aa.hiddenBodies&&aa.hiddenBodies.length)||(aa.visibleBodies&&aa.visibleBodies.length)||at){if(!X){X=new u({frameWindow:N.getFrameWindow(),viewer:N.getViewer()})}X.display({label:aC,icon:aB,onClickCB:ab,widgetType:"Cancel"});if(S){X.setVisibleFlag(false)}}};var L=function(){if(X){X.hide()}};this.getCGRPath=function(aF){if(aF){var aE=aF.getChildrenPathes(),aB;for(var aC=0;aC<aE.length;aC++){var aD=aE[aC].getLastElement(true);if(aD.getPathElement&&aD.setInternalSceneGraph){return aE[aC]}}if(h.getLoadedAssetType()==="3DXML"){aE=aF.getChildrenPathes();for(aC=0;aC<aE.length;aC++){aB=B.getCGRPath(aE[aC]);if(aB){return aB}}}else{return B.getCGRPath(aF.getParentPath())}}return undefined};var M=function(aB,aC){if(!aB||(aB&&aB.length===0)||!aC){return undefined}var aD=B.getCGRPath(aC);if(aD){return aD.getLastElement(true).getPathElement(aB,aD)}return undefined};this._getPointedRelations=function(aD){if(!d.is(aD,"object")){return}if(!d.is(aD.onComplete,"function")){return}if(!d.is(aD.physicalID,"string")){aD.onComplete();return}if(!d.is(aD.onFailure,"function")){aD.onComplete();return}if(!d.is(aD.onTimeout,"function")){aD.onComplete();return}var aE={};if(aD.semantics){aE.semantics=aD.semantics}if(aD.role){aE.role=aD.role}if(aD.relIds&&aD.relIds.length){aE.sr_id=aD.relIds}var aC={input_physical_ids:[aD.physicalID],primitives:[{navigate_to_sr:{id:1,filter:aE,mode:"path"}}],patterns:{RESULTS:[{id:1,iter:1}]},flags:["returnMatches","noReturnThumbnails"],version:3,label:"CAT3DAnnotControllerNav"};var aB={data:JSON.stringify(aC),timeout:parseInt(g.getSetting("webapi_timeout"),10),method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:aD.onComplete,onFailure:aD.onFailure,onTimeout:aD.onTimeout};j.getSecurityContext(function(aF){var aG=j.get3DSpaceUrl()+"/cvservlet/navigate?SecurityContext="+aF.securityContext;if(g.getSetting("cors_activated")===true){b.authenticatedRequest(aG,aB)}else{aB.proxy="passport";b.proxifiedRequest(aG,aB)}})};var ai=function(aD,aC){if(at){N.getViewer().getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(at)}if(!aD||!aC||(!aD.length&&!aC.length)){return}at=new p(N.getRootBagPath().getLastElement(true));N.getViewer().getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(at);if(aC&&aC.length){var aE=at.createOverride({pathes:aC});aE.setVisibility(true)}if(aD&&aD.length){var aB=at.createOverride({pathes:aD});aB.setVisibility(false)}};var ao=function(aF,aG){var aE=aF.getLastElement(true).getVisibleCompRelIds?aF.getLastElement(true).getVisibleCompRelIds():null;var aD=aF.getLastElement(true).getXMLVisibleCompRelIds?aF.getLastElement(true).getXMLVisibleCompRelIds():null;if(!aE&&!aD){aG()}var aC=function(aK,aQ){var aN=N.getRootBagPath().getChildrenPathes();var aO,aM,aL;for(aM=0;aM<aN.length;aM++){if(aN[aM].isAParentOf(aQ)){aO=aN[aM];break}}var aH=[];for(aM=0;aM<aK.length;aM++){var aP=aO.clone();for(aL=0;aL<aK[aM].length;aL++){aP=ak(aP,aK[aM][aL])}aH.push(aP)}var aJ=[];var aI=function(aW){var aS=aW.getLastElement(true);if(h.is3DLeaf(aS)||aW.isEqual(aQ)){return}if(!aW.isAParentOf(aQ)&&((aW.getParentPath().isEqual(aO)&&h.isRepInstance(aS))||(h.isInstance(aS)))){var aR=true;for(var aU=0;aU<aH.length;aU++){if(aH[aU].isEqual(aW)){aR=false;break}}if(aR){aJ.push(aW.clone())}if(aW.getParentPath().isEqual(aO)&&h.isRepInstance(aS)){return}}var aT=aW.getChildrenPathes();for(var aV=0;aV<aT.length;aV++){aI(aT[aV])}};aI(aO);aF.getLastElement(true).setListsOfAssyPathComponents(aH,aJ);aG({visiblePaths:aH,hiddenPaths:aJ})};if(aE&&aE.length){if(aF.getLastElement(true).getListsOfAssyPathComponents&&aF.getLastElement(true).getListsOfAssyPathComponents()!==undefined){aG(aF.getLastElement(true).getListsOfAssyPathComponents())}else{var aB=aF.getParentPath().getParentPath().getParentPath();B._getPointedRelations({physicalID:h.getNodeID(aB.getLastElement(true)),relIds:aE,semantics:["4"],role:["173"],onComplete:function(aM){var aJ,aK;var aI=d.is(aM,"string")?JSON.parse(aM):aM;if(!d.is(aI.result,"array")||aI.result.length<1||!d.is(aI.result[0].outputs.RESULTS,"array")||aI.result[0].outputs.RESULTS.lenght<1){return}var aN=aI.result[0].outputs.RESULTS,aH=[],aL;for(aJ=0;aJ<aN.length;aJ++){aL=aN[aJ].elements;aH.push([]);for(aK=0;aK<aL.length;aK++){aH[aH.length-1].push(aL[aK].physicalid)}}aC(aH,aB)},onFailure:aG,onTimeout:aG})}}else{if(aD&&aD.length){aC(aD,aF)}}};var ak=function(aF,aG){var aC=aF.getLastElement(true);if(h.getNodeID(aC)===aG){return aF}var aE=aF.getChildrenPathes();for(var aB=0;aB<aE.length;aB++){var aD=ak(aE[aB],aG);if(aD){return aD}}return undefined};var av=function(aD,aB){if(aD.getNodeType&&aD.getNodeType()==="Mesh3D"){aB.push(aD)}else{for(var aC=0;aC<aD.children.length;aC++){av(aD.children[aC],aB)}}}}});return e});define("DS/CAT3DAnnotationController/CAT3DAnnotationController",["UWA/Class","DS/CAT3DAnnotationController/CAT3DAnnotBaseControllerInstance"],function(c,d){var b=[];var a=c.singleton({registerAnnotationController:function(e){if(!e||!e.annotController||!e.context){return}this.unreferenceAnnotationController(e);b.push({context:e.context,annotController:e.annotController})},giveAnnotationController:function(f){if(f&&f.context){for(var e=0;e<b.length;e++){if(b[e].context===f.context){return Object.freeze(b[e].annotController.getAnnotControllerPrototype())}}}},getAnnotationController:function(f){var g=this.giveAnnotationController(f);if(!g&&f&&f.context){var e=new d({ctxViewer:f.context});b.push({context:f.context,annotController:e});g=Object.freeze(b[b.length-1].annotController.getAnnotControllerPrototype())}return g},unreferenceAnnotationController:function(f){if(f&&f.context){for(var e=b.length-1;e>=0;e--){if(b[e].context===f.context){if(b[e].annotController){b[e].annotController.clearController()}b.splice(e,1)}}}}});return a});