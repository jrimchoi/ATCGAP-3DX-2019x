define("DS/DataAnalyzerWidget/DataAnalyzerWidget",["css!DS/DataAnalyzerWidget/DataAnalyzerWidget","UWA/Controls/Abstract","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","i18n!DS/DataAnalyzerWidget/assets/nls/DataAnalyzerWidgetNls","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleServicesSettings","DS/WAFData/WAFData","DS/LifecycleCmd/MessageMediator","DS/WebToWinInfra/WebToWinCom","DS/WebInWinHelper/WebInWinHelper","DS/LifecycleControls/CommandDialog","DS/Controls/Accordeon","DS/Controls/Button","DS/Controls/Tab","DS/Tree/FileTreeView","DS/Tree/Tree"],function(p,j,c,g,f,d,n,k,b,q,i,o,h,a,m,e){var l=j.extend({options:null,wintop:false,odtmode:false,debugWebServiceRequest:false,physicalIds:null,tenant:null,_computingTxt:null,init:function(t,r,s){this.widget=t;this.parentWidget=r;this.options=s;if(s!==undefined&&s!==null&&s.hasOwnProperty("odtmode")){this.odtmode=s.odtmode}if(s!==undefined&&s!==null&&s.hasOwnProperty("debugWebServiceRequest")){this.debugWebServiceRequest=s.debugWebServiceRequest}this._parent(s);this.physicalIds=[];if(s!==undefined&&s!==null&&s.hasOwnProperty("wintop")&&s.wintop==true){this.wintop=true;this.container=UWA.createElement("div",{name:"data_analyzis","class":"dataanalyze_popup","data-rec-id":"dataanalyze_popup"});this._computingTxt=new UWA.Element("text",{text:g.computing});this._computingTxt.inject(this.container);this._computingTxt.hide();q.initTenant(this);q.getServices(this);this.webToWinCom_Socket=b.createSocket({socket_id:"WebInWin_DataAnalyzerWidget_Socket_"+Math.floor((Math.random()*100000)+1)});if(typeof this.options.serverUrl!=="undefined"&&this.options.serverUrl.length>0){if(typeof this.options.serverUrl[0].platformId!=="undefined"){var u=this.options.serverUrl[0].platformId;this.tenant=u}}}},initDatafromWin:function(r){var s=this;var t=[];r.forEach(function(x){var u=x.physicalId;var w=x.name;var v={physicalid:u,name:w,displayName:w};if(x.hasOwnProperty("config_filter")){v.config_filter=x.config_filter}t.push(v)});this.executeCmd(t,{},function(){s._executeCmdEnded()})},executeCmd:function(s,r,u){var t=this;this.addEvent("onReady",function(v){t._executeAnalyzis(function(w){t._showCommandUI(s,w)},function(w){t._showCommandFailed(s,w)})},this);this.addEvent("onComplete",function(v){u()});if(s.length===0){throw c.noObject}s.forEach(function(v){if(v.hasOwnProperty("physicalid")&&v.physicalid===""){throw c.epmtyPhysicalId}t.physicalIds.push(v)});this.dispatchEvent("onReady",{})},_executeCmdEnded:function(){if(this.wintop){this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"ClosePanel",notif_parameters:"ClosePanel"},"lf_web_in_win")}},_logToConsole:function(r){if(this.wintop){this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"onLogToCNEXTOUTPUT",notif_parameters:r},"lf_web_in_win");console.log(r)}else{console.log(r)}},_setWaitingResponse:function(){if(this.widget!==undefined&&this.widget!==null){this.widget.body.style.cursor="wait"}else{document.body.style.cursor="wait"}if(this._computingTxt!==null){this._computingTxt.show()}},_setEndWaitingResponse:function(){if(this.widget!==undefined&&this.widget!==null){this.widget.body.style.cursor="default"}else{document.body.style.cursor="default"}if(this._computingTxt!==null){this._computingTxt.hide()}},_showCommandFailed:function(v,s){this._logToConsole(s);this._logToConsole("\n");var u=null;var x=null;if(s!==undefined&&s!==null&&s.hasOwnProperty("status")){u=s.status}if(s!==undefined&&s!==null&&s.hasOwnProperty("report")&&s.report.length>=1){var x=g.error_message_report;for(var w=0;w<s.report.length;w++){var t=s.report[w];if(t!==null&&t.hasOwnProperty("message")){x=x+"\n"+t.message}}}if(s!==undefined&&s!==null&&s.hasOwnProperty("error")&&s.error.length>=1){var x="";var y=s.error[0];if(y!==null&&y.hasOwnProperty("message")){x=y.message}for(var w=1;w<s.error.length;w++){y=s.error[w];if(y!==null&&y.hasOwnProperty("message")){x=x+"\n"+y.message}}}if(x===null){x=g.error_message_invalid_server_response}if((this.wintop&&!this.debugWebServiceRequest)||this.odtmode){this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"onDisplayErrorMessage",notif_parameters:{severity:"warning",message:x}},"lf_web_in_win")}else{alert("computation failed:\n"+x)}this.dispatchEvent("onComplete",{})},_showCommandUI:function(I,D){var A=null;if(this.wintop){A=this.container}else{A=new UWA.Element("div",{name:"data_analyzis","class":"dataanalyze_popup","data-rec-id":"dataanalyze_popup"});var v=this;var y=new i();var F=y.create(A,{title:g.CommandDialogTitle,closeButton:true,resizable:true,buttonStyle:y.buttonStyle.none,onClose:function(){v.dispatchEvent("onComplete",{})}});if(this.widget!==undefined&&this.widget!==null){F.inject(this.widget.body)}else{F.inject(document.body)}}if(I.length==1&&!this.wintop){new UWA.Element("h5",{text:g.H5Title+I[0].displayName+":"}).inject(A)}else{if(I.length==1){new UWA.Element("h5",{text:g.H5Title1+":"}).inject(A)}else{new UWA.Element("h5",{text:g.H5TitleS+":"}).inject(A)}}if(D!==undefined&&D!==null&&D.hasOwnProperty("summary")){var H=[];var u=D.summary;var w=false;var r=false;var C=this._itemSummaryCount(u);if(C!==undefined&&C!==null){H.push(C);w=true}var t=this._itemSummaryDepth(u);if(t!==undefined&&t!==null){H.push(t);r=true}var G=new UWA.Element("div",{"data-rec-id":"advanced_div","class":"dataanalyze_advanced"});var x=this._itemSummaryTypes(u,this.tenant);if(x!==undefined&&x!==null){x.inject(G)}var E=I[0].displayName;var s=this._DumpList(E,u,D,this.tenant);if(s!==undefined&&s!==null){s.inject(G)}var B={header:g.AdvancedSection,content:G};H.push(B);var z=new o({items:H,exclusive:false,style:"simple",recId:"displayedSummaryInt"});z.getContent().setAttribute("data-rec-id","displayedSummaryExt");z.inject(A);if(z.items.length>0&&(w||r)){z.expandItem(0)}if(z.items.length>1&&r){z.expandItem(1)}if(D.hasOwnProperty("elapse_time")&&D.hasOwnProperty("cloudview_elapse_time")){new UWA.Element("text",{"class":"dataanalyze_elapses_time",text:g.elapse_time+D.elapse_time+"(ms) , "+g.cloudview_elapse_time+D.cloudview_elapse_time+"(ms)"}).inject(A)}}},_executeAnalyzis:function(s,w){var v=this;var u=this.physicalIds;var t=[];t.push({expand_tool:"cloudview"});var r=function(x){if(x===undefined||x===null||!x.hasOwnProperty("status")||x.status==="failure"||x.status==="error"){w(x);return}if(x.status==="success"&&x.hasOwnProperty("results")){s(x.results)}else{w(x)}};f.getSecurityContextPromise(this.tenant).then(function(x){v._analyzisServiceRequest(u,t,r,x)})["catch"](function(x){w({status:"failure",error:{message:x.message}})})},_analyzisServiceRequest:function(u,A,s,y){var v=this;if(u.length==1&&u[0]!==undefined&&u[0]!==null&&u[0].hasOwnProperty("physicalid")){this._logToConsole("DATA ANALYZIS: "+u[0]["physicalid"]+"\n")}else{if(u.length>1){this._logToConsole("DATA ANALYZIS: "+u.length+" objects\n")}else{this._logToConsole("DATA ANALYZIS: ???\n")}}this._logToConsole(u);this._logToConsole("\n");var w=JSON.stringify({data:u,options:A});var r=d.get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/dataanalyze/structure","SecurityContext="+y);var x=function(B){if(v.debugWebServiceRequest){var C=JSON.stringify(B);v._logToConsole("after webservice request\n"+C+"\n\n")}v._setEndWaitingResponse();v._logToConsole("DATA ANALYZIS: COMPLETED\n");s(B)};var t=function(B,C){v._setEndWaitingResponse();v._logToConsole("DATA ANALYZIS: Failed to retrieve data from the server\n");if(C!==undefined&&C!==null){v._logToConsole(C)}s({status:"failure",error:{message:g.error_message_request_failed}})};var z=function(B){v._setEndWaitingResponse();v._logToConsole("DATA ANALYZIS: Timeout error\n");s({status:"failure",error:{message:g.error_message_timeout}})};this._setWaitingResponse();if(this.debugWebServiceRequest){this._logToConsole("before webservice request\n"+w+"\n\n")}n.authenticatedRequest(r,{method:"POST",headers:d.getHeaders(y),timeout:1000*60*60*24,onComplete:x,data:w,onTimeout:z,onFailure:t,type:"json"})},_itemSummaryCount:function(u){if(u!==null){var s=0;if(u.hasOwnProperty("nbObjects")){s=u.nbObjects}var x=0;if(u.hasOwnProperty("nbEntities")){x=u.nbEntities}var w=0;if(u.hasOwnProperty("nbRelations")){w=u.nbRelations}var t=new UWA.Element("div",{"data-rec-id":"itemSummaryCount_div"});var v=new UWA.Element("ul").inject(t);if(x>1){new UWA.Element("li",{text:x+g.itemSummaryCount_entities}).inject(v)}else{new UWA.Element("li",{text:x+g.itemSummaryCount_entity}).inject(v)}if(w>=1){new UWA.Element("li",{text:w+g.itemSummaryCount_relations}).inject(v)}var r={header:g.itemSummaryCount_summaryItem+s,content:t};return r}},_itemSummaryDepth:function(t){if(t!==null&&t.hasOwnProperty("max_depth")&&t.max_depth>0){var s=new UWA.Element("div",{"data-rec-id":"itemSummaryDepth_div"});var u=new UWA.Element("ul").inject(s);new UWA.Element("li",{text:g.replace(g.itemSummaryDepth_one_structure,{max_depth:t.max_depth})}).inject(u);var r={header:g.itemSummaryDepth_header,content:s};return r}else{if(t!==null&&t.hasOwnProperty("structures")){var v=t.structures;var s=new UWA.Element("div",{"data-rec-id":"itemSummaryDepth_div"});new UWA.Element("text",{text:g.replace(g.itemSummaryDepth_several_structures,{nbStructures:v.length})}).inject(s);var u=new UWA.Element("ul").inject(s);v.forEach(function(x){if(x.hasOwnProperty("nbObjects")&&x.hasOwnProperty("max_depth")){var y=x.nbObjects;var w=x.max_depth;new UWA.Element("li",{text:g.replace(g.itemSummaryDepth_composed_of,{structure_nb_objects:y,max_depth:w})}).inject(u)}});var r={header:g.itemSummaryDepth_header,content:s};return r}}},_itemSummaryTypes_ListContent:function(v,t,u){var r=new UWA.Element("div",{"class":"itemSummaryTypes_ListContent","data-rec-id":"itemSummaryTypes_ListContent_div"});var s=new UWA.Element("table").inject(r);t.forEach(function(z){if(z!==null&&z.hasOwnProperty("name")&&z.hasOwnProperty("count")){var A=z.name;var G=parseInt(z.count);if(v.hasOwnProperty(A)){var w=v[A];if(w!==null&&w.hasOwnProperty("icon")){var y="";if(w.hasOwnProperty("nls")&&w.nls!==null&&w.nls!==""){y=w.nls}else{y="`"+w.name+"`"}var F="";if(w.hasOwnProperty("icon")&&w.icon!==null&&w.icon!==""){F=w.icon}var B=new UWA.Element("tr").inject(s);var x=d.get3DSpaceWSUrl(u,F);var E=new UWA.Element("td").inject(B);new UWA.Element("img",{src:x}).inject(E);var D=new UWA.Element("td",{"class":"dataanalyze_typelist_count_td"}).inject(B);new UWA.Element("text",{text:G+" "}).inject(D);var C=new UWA.Element("td").inject(B);new UWA.Element("text",{text:y+"(s)"}).inject(C)}}else{console.log("_itemSummaryTypes_ListContent / not found "+A)}}});return r},_typeGoThru:function(s,x,r,w,v){if(w.hasOwnProperty(s)){var t=w[s];var u=null;if(!v.hasOwnProperty(s)){u={name:s,nls:"",icon:"",count:0,isroot:false,nodechildren:[],irpc:""};v[s]=u;if(t!==null&&t.hasOwnProperty("nls")){u.nls=t.nls}if(t!==null&&t.hasOwnProperty("icon")){u.icon=t.icon}if(t!==null&&t.hasOwnProperty("irpc")){u.irpc=t.irpc}if(t!==null&&t.hasOwnProperty("parent")&&t.parent!==null){u.isroot=false}else{u.isroot=true;v.push(u)}}else{u=v[s]}u.count=u.count+r;if(x!==null&&!u.nodechildren.hasOwnProperty(x.name)){u.nodechildren[x.name]=x;u.nodechildren.push(x)}if(t!==null&&t.hasOwnProperty("parent")&&t.parent!==null){this._typeGoThru(t.parent,u,r,w,v)}}else{console.log("_typeGoThru / not found "+s)}},_convertTypesListAsTreeNode:function(r,s,y){var w=this;var x=false;var u="";if(s.hasOwnProperty("nls")&&s.nls!==null&&s.nls!==""){u=s.nls+" ("+s.count+")";x=true}else{u="`"+s.name+"` ("+s.count+")"}s.label=u;var t=d.get3DSpaceWSUrl(y,s.icon);s.icons=[t];s.data=s;var z=[];s.nodechildren.forEach(function(B){var C=w._convertTypesListAsTreeNode(r,B,y);for(var A in C){z.push(C[A])}});if(x&&(z.length!=1||s.isroot||(z.length==1&&z[0].count!=s.count))){if(z.length!=0){s.children=[];for(var v in z){s.children.push(z[v])}}return[s]}else{if(!x){console.log("_convertTypesListAsTreeNode / skipping not displayable: "+u)}else{if(z.length==1){console.log("_convertTypesListAsTreeNode / skipping only 1 child: "+u)}}}return z},_itemSummaryTypes_TreeContent:function(w,x,F){var G=[];var A=this;x.forEach(function(K){if(K!==null&&K.hasOwnProperty("name")&&K.hasOwnProperty("count")){var J=K.name;var I=parseInt(K.count);A._typeGoThru(J,null,I,w,G)}});var t=null;var H=null;var z=null;var C=null;var y=null;var D=null;var v=[];var s=[];var B=[];G.forEach(function(I){if(I.name=="PLMCoreInstance"){t=I}else{if(I.name=="PLMCoreRepInstance"){z=I}else{if(I.name=="PLMCoreReference"){H=I}else{if(I.name=="PLMCoreRepReference"){C=I}else{if(I.name=="PLMPort"){y=I}else{if(I.name=="PLMConnection"){D=I}else{if(I.isroot&&I.irpc=="PLMInstance"){t.push(I)}else{if(I.isroot&&I.irpc=="PLMRepInstance"){z.push(I)}else{if(I.isroot&&I.irpc=="PLMReference"){H.push(I)}else{if(I.isroot&&I.irpc=="PLMRepReference"){C.push(I)}else{if(I.isroot&&I.irpc=="PLMConnection"){D.push(I)}else{if(I.isroot&&I.irpc=="PLMPort"){y.push(I)}else{if(I.isroot&&I.irpc=="entity"){v.push(I)}else{if(I.isroot&&I.irpc=="relation"){s.push(I)}else{B.push(I)}}}}}}}}}}}}}}});G=[];if(H!==null){G.push(H)}if(t!==null){G.push(t)}if(C!==null){G.push(C)}if(z!==null){G.push(z)}if(D!==null){G.push(D)}if(y!==null){G.push(y)}G=G.concat(v);G=G.concat(s);G=G.concat(B);var E=new UWA.Element("div",{"data-rec-id":"itemSummaryTypes_TreeContent_div","class":"dataanalyze_itemSummaryTypes_TreeContent"});G.forEach(function(I){A._convertTypesListAsTreeNode(E,I,F)});var r={apiVersion:2,roots:G};var u=new m(r);u.inject(E);return E},_itemSummaryTypes:function(t,x){var s=new UWA.Element("div",{"data-rec-id":"itemSummaryTypes_div"});if(t!==null&&t.hasOwnProperty("typesinfo")&&t.hasOwnProperty("typescount")){var y=t.typesinfo;var u=t.typescount;if(y!==null&&y.length!==0&&u!==null&&u.length!==0){var w=new a({displayStyle:"panel",multiSelFlag:true,reorderFlag:false,showComboBoxFlag:true,recId:"typeSummaryTab"});w.tabBar.closeButtonFlag=false;w.tabBar.centeredFlag=false;var r=this._itemSummaryTypes_ListContent(y,u,x);var v=this._itemSummaryTypes_TreeContent(y,u,x);w.add({label:g.Types_as_list,content:r,index:0,value:0});w.add({label:g.Types_as_tree,content:v,index:1,value:1});w.value=[0];w.inject(s)}}return s},_DumpList:function(r,z,v,A){var x=this;var s=new UWA.Element("div");s.setStyle("padding-top","10px");if(v!==undefined&&v!==null&&v.hasOwnProperty("structure")&&z!==undefined&&z!==null&&z.hasOwnProperty("typesinfo")){var u=v.structure;var w=z.typesinfo;var t=["id","type","irpc","primarytype","interface","name","revision","physicalid","policy","owner","project","organization","PLM_ExternalID","V_Name","current","V_discipline","V_Owner","V_InstanceOf"];var y=new h({label:g.Dump_objects,recId:"dumpButton"});y.inject(s);y.addEventListener("buttonclick",function(G){var I="";var E=0;for(E=0;E<t.length;E++){I+=t[E];if(E!==t.length-1){I+=","}}I+="\n";var J={};if(w!==undefined&&w!==null){for(var D in w){if(w.hasOwnProperty(D)){var H=w[D];if(!J.hasOwnProperty(H.name)){J[H.name]=[]}J[H.name].push(H)}}}u.forEach(function(N){var L=N.type;if(J.hasOwnProperty(L)){var M=J[L];var O=null;if(M!==undefined&&M!==null&&M.length>=1){O=M[0]}if(O!==undefined&&O!==null&&O.hasOwnProperty("irpc")){N.irpc=O.irpc}}for(E=0;E<t.length;E++){var K=t[E];if(N!==null&&N.hasOwnProperty(K)){I+=N[K]}if(E!==t.length-1){I+=","}}I+="\n"});var B=new Blob([I],{type:"data:text/csv;charset=utf-8"});var F=window.document.createElementNS("http://www.w3.org/1999/xhtml","a");F.href=URL.createObjectURL(B);F.download=r+".csv";var C=new MouseEvent("click");if(!x.odtmode){F.dispatchEvent(C)}})}return s},});return l});