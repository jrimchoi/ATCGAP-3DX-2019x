/*! -- Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/RichView/mixins/_dndUtilities",["UWA/Class","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/jQueryUI","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/Services/RequirementWebServices","i18n!DS/RichView/assets/nls/RichView",],function(c,l,k,h,i,e){var d=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0;var b=typeof InstallTrigger!=="undefined";var a=!!window.chrome&&!d;var f=false||!!document.documentMode;var j=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0;var g=c.extend({init:function(){var m=this},isVisible:function(){var p=this;var n=p.context.contentPanel.height(),o=p.container.height();var m=p.container.offset().top;if((m+o)>0&&m<n){return true}else{return false}},isDroppable:function(m){var p=this;if(p._dragging){return false}if(l.inArray("cke/id",m.originalEvent.dataTransfer.types)!==-1){return false}if(f){return p.options.droppable.Text}var s=false;if(UWA.is(m.originalEvent.dataTransfer.types[0],"string")){var o=p.extractFromDataTransfer(m.originalEvent.dataTransfer.types[0]);var n=p.model.getNodesByElementID(o);if(n.length>0){s=true}}if((l.inArray("Files",m.originalEvent.dataTransfer.types)!==-1)&&s===false){return p.options.droppable.Files}else{if((l.inArray("text/searchitems",m.originalEvent.dataTransfer.types)!==-1)&&s===false){return p.options.droppable["text/searchitems"]}else{if((l.inArray("text/plain",m.originalEvent.dataTransfer.types)!==-1)&&s===false){return p.options.droppable["text/plain"]}else{if((l.inArray("Text",m.originalEvent.dataTransfer.types)!==-1)&&s===false){return p.options.droppable.Text}}}}var u=m.originalEvent.dataTransfer,q=p._lowerMatchUpper[p.extractFromDataTransfer(u.types[2])],r=p._lowerMatchUpper[p.extractFromDataTransfer(u.types[3])];var t=false;if(p.options.droppable[q]!==undefined){t=p.options.droppable[q]}else{if(p.options.droppable[r]){t=p.options.droppable[r]}}return t},extractFromDataTransfer:function(n){var m=n.indexOf("_")!==-1?(n.indexOf("_")+1):0;return n.substring(m)},isInUpperHalf:function(m,n){return(m<=n.offset().top+n.outerHeight()/4)},isInLowerHalf:function(m,n){return(m+n.outerHeight()/4>=n.offset().top+n.outerHeight())},updateHighlight:function(m,p,n){var o=this;if(o.isInUpperHalf(m,p)&&n.indexOf("before")!==-1){if(p.prev().hasClass("droppable-above")){return"before"}p.removeClass("droppable-child");if(p.next().hasClass("droppable-below")){p.next().remove()}p.before('<div class="droppable-target droppable-above wux-datagrid-row-insertion-mark"></div>');return"before"}else{if(o.isInLowerHalf(m,p)&&n.indexOf("after")!==-1){if(p.next().hasClass("droppable-below")){return"after"}p.removeClass("droppable-child");if(p.prev().hasClass("droppable-above")){p.prev().remove()}p.after('<div class="droppable-target droppable-below wux-datagrid-row-insertion-mark"></div>');return"after"}else{if(n.indexOf("over")!==-1){if(p.hasClass("droppable-child")){return"over"}if(p.next().hasClass("droppable-below")){p.next().remove()}if(p.prev().hasClass("droppable-above")){p.prev().remove()}p.addClass("droppable-child");return"over"}}}},cleanupHighlight:function(m){m.removeClass("droppable-child");if(m.next().hasClass("droppable-below")){m.next().remove()}else{if(m.prev().hasClass("droppable-above")){m.prev().remove()}}},handleDataTransferInIE:function(m){var p=this;var n=m.dataTransfer.getData("text");var o=undefined;try{o=JSON.parse(n)}catch(q){o=undefined}return o},process3DXContentData:function(t,r){var q=this;if(t.source===widget.getValue("appId")&&q.traceabilityAuthoring===true){if(t.data.items[0].kindof==="Requirement"){var m={id:t.data.items[0].objectId,physicalId:t.data.items[0].objectId,type:t.data.items[0].objectType,kindof:t.data.items[0].kindof,path:t.data.items[0].path,title:t.data.items[0].displayName};q.StartLinkCmd.execute(m);var o=q.model.getNodesByElementID(q.id)[0];var u=o.getOccurencePath();var p={id:q.objectId,physicalId:q.physicalId,type:q.type,kindof:q.kindof,path:u,title:q.title};q.EndLinkCmd.execute(p)}else{q.context.displayNotification({msg:e.RichView_Notif_NotAuthorized,eventID:"error"})}}else{var s=t.data.items[0].objectType;var n=t.data.items[0].objectId;i.getKindOf({securityContext:h.getSecurityContext(),pid:n,onComplete:function(z){var y=UWA.is(z,"string")?JSON.parse(z):z;var x=y.results;var v=q.options.droppable[x];if(!UWA.is(v)||v.indexOf(q._dropPosition)===-1){q.mediator.publish("onNotification",{className:"error",message:e.RichView_Notif_NotAuthorized});return false}else{var w=t.data.items[0].objectId;q.mediator.publish("onInsert",{operation:"insertExisting",position:q._dropPosition,type:s,objectId:w,content:"",contentType:"",kindof:x,target:{element:r,id:r.attr("id")},fetchContent:true,})}}})}}});return g});define("DS/RichView/RichContentEditor",["UWA/Core","UWA/Class","UWA/Class/Events","UWA/Class/Listener","UWA/Class/Options","DS/CKEditor/CKEditor","DS/Logger/Logger","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/jQueryUI","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/RichEditor/RichEditor","DS/PADUtils/PADContext","DS/DocumentManagement/DocumentManagement","i18n!DS/RichView/assets/nls/RichView","css!DS/RichView/RichView.css"],function(b,o,i,f,m,n,s,h,l,r,d,g,j,p,q){var k=false||!!document.documentMode;var e={content:function(u){return h('<div data-objectid="'+u.objectId+'" contenteditable="true" class="content-data">'+u.content+"</div>")},toolbar:function(u){return h('<div id="toolbar" class="editor-toolbar"></div>')}};var t="../../VENREQPlugins/External/ckeditor";var a=new g();String.prototype.isEmpty=function(){return(this.length===0||!this.trim())};var c=o.extend(i,f,m,{defaultOptions:{mediator:null,selector:".rich-object",target:".content-data",container:".content-panel",inlineEditing:true,saveOnBlur:true,commandProxy:null,richView:null,events:null},_logger:null,init:function(u){var v=this;this._logger=s.getLogger(c);this._logger.log("init");UWA.merge(u||{},this.defaultOptions);this.options=u;this.mediator=u.mediator;this._init();if(widget.hasEvent("onDragOverFiles")===false&&this.options.selector===".rich-object"){widget.addEvent("onDragOverFiles",function(w){v.handleFiles(w)})}return this},_init:function(){this._logger.log("_init");var v=this;this._customConfig=t+"/config.js";this._toolbar="Rich";this._plugins={sharedspace:t+"/plugins/sharedspace/",colorbutton:t+"/plugins/colorbutton/",panelbutton:t+"/plugins/panelbutton/",quicktable:t+"/plugins/quicktable/",base64image:t+"/plugins/base64image/",selectall:t+"/plugins/selectall/",lineutils:t+"/plugins/lineutils/",widget:t+"/plugins/widget/"};this._extraPlugins="";for(var u in this._plugins){this._extraPlugins+=u+","}this._extraPlugins=this._extraPlugins.slice(0,-1);if(this.options.selector===".rich-container"||this.options.target===".rich-object-title-editable"){this._toolbar="Container";this._extraPlugins="selectall";this._customConfig=t+"/config_rich_container.js"}this.editor=null;this.selector=this.options.selector;CKEDITOR.disableAutoInline=!this.options.inlineEditing;CKEDITOR.plugins.addExternal("rcowidget","../../VENREQPlugins/External/ckeditor/plugins/rcowidget/","plugin.js");this._extraPlugins+=",rcowidget";CKEDITOR.dtd.$editable.span=1;this.isEditing=false;this.hasBeenModified=false;this._padCommandProxy=v.options.commandProxy;this._reqCommandProxy=v.options.reqCommandProxy},startEditionForAll:function(){this._logger.log("startEditionForAll");var u=this;var v=r.getLanguage();if("zh"===v){v+="-cn"}this.defaultEditorOptions={skin:"office2013,"+t+"/skins/office2013/",customConfig:u._customConfig,extraPlugins:u._extraPlugins,toolbar:u._toolbar,language:v,startupFocus:true,on:{instanceReady:function(w){},blur:function(w){if(u.options.saveOnBlur&&u.hasBeenModified){u.save(w.editor)}u.isEditing=false;u.hasBeenModified=false;h("#"+w.editor.name).parents(u.options.selector).attr("draggable",true);h("#"+w.editor.name).parents(u.options.selector).find(".rich-object-menu").toggleClass("rich-object-menu-hidden",false)},change:function(w){u.hasBeenModified=true;u._reqCommandProxy.contentChanged()},focus:function(w){if(w.sender.container.getAttribute("contentEditable")==="false"){return}h("#"+w.editor.name).parents(u.options.selector).attr("draggable",false);h("#"+w.editor.name).parents(u.options.selector).find(".rich-object-menu").toggleClass("rich-object-menu-hidden",true)},key:function(w){if(w.data.keyCode==13&&u.options.selector===".rich-container"){w.cancel();w.editor.fire("blur",w);h("#"+w.editor.name).parents(u.options.selector).focusout()}}}};if(!this.options.inlineEditing){this.defaultEditorOptions.sharedSpaces={top:"toolbar"}}h(this.options.container).on("focus",this.options.target,function(w){u._onFocus(w)})},_onFocus:function(u){var z=this;u.stopPropagation();var A=this;var D=h(u.target).parents(z.options.selector),v=D.attr("id")+"_content";if(h(u.target).attr("id").indexOf("title")!==-1){v=D.attr("id")+"_title_content"}this.defaultEditorOptions.data={objectId:D.data("objectid")};if(z.isEditing===true&&z.id===v){return}var w=j.get();var x=w.getRichObject(D.attr("id"));var B=false;B=true;if(B||(x.isHTMLReady&&(a.getPreferredEditor()!="Word"||a.isMobile&&a.isMobile()))){if(UWA.is(x)&&x.convertBeforeEdit){richView.utilities.loading();d.htmlConvert({securityContext:r.getSecurityContext(),id:D.data("objectid"),onComplete:function(E){richView.utilities.loading(true);E=JSON.parse(E);var G=E.html;if(!G){G=""}if(E.isHTMLEditable||a.getPreferredEditor()!="Word"){h(A).html(G);z.isEditing=true;z.id=v;if(!CKEDITOR.instances[v]){CKEDITOR.inline(v,z.defaultEditorOptions)}h(".rich-object.active, .rich-container.active").toggleClass("active",false);D.toggleClass("active",true);if(j.get().onInnerSelection){var F=j.get().getPADTreeDocument();var H=F.getNodesByElementID(D.attr("id"))[0];j.get().onInnerSelection(H)}}else{A.setAttribute("contenteditable",false);z.mediator.publish("onNotification",{className:"info",message:a.nls.Msg_NoHTMLEditing})}},onFailure:function(E){z.mediator.publish("onNotification",{className:"error",message:E.message})}})}else{if(u.target.contentEditable==="false"){return}z.isEditing=true;z.id=v;if(!CKEDITOR.instances[v]){CKEDITOR.inline(v,z.defaultEditorOptions)}h(".rich-object.active, .rich-container.active").toggleClass("active",false);D.toggleClass("active",true);if(j.get().onInnerSelection){var y=j.get().getPADTreeDocument();var C=y.getNodesByElementID(D.attr("id"))[0];j.get().onInnerSelection(C)}}}else{if(u.target.setAttribute){u.target.setAttribute("contenteditable",false)}}},handleFiles:function(u){var B=this;this._logger.log("Files are dragged over ckeditor editor");var x=u.originalEvent.dataTransfer;if(UWA.is(u.originalEvent.target)){var z=h(u.originalEvent.target).parents(this.options.selector+":first");var A=z.attr("id");if(UWA.is(A)){var w=j.get();var y=w.getRichObject(z.attr("id"));var C=false;if(z.hasClass("rich-container")){C=true}var v=z.attr("id")+"_content";if(!CKEDITOR.instances[v]){if(C||(y.isHTMLReady&&(a.getPreferredEditor()!="Word"||a.isMobile&&a.isMobile()))){if(y.convertBeforeEdit){d.htmlConvert({securityContext:r.getSecurityContext(),id:parentObject.data("objectid"),onComplete:function(D){D=JSON.parse(D);var E=D.html;if(!E){E=""}if(D.isHTMLEditable||a.getPreferredEditor()!="Word"){B.updateHtmlContent({element:z,content:E});B.id=v;CKEDITOR.inline(v,B.defaultEditorOptions)}}})}else{B.defaultEditorOptions.data={objectId:z.data("objectid")};B.id=v;CKEDITOR.inline(v,B.defaultEditorOptions)}}}}}},updateHtmlContent:function(x){var w=this;w._logger.log("updateHtmlContent");var z=x.content;var u=x.element;if(UWA.is(z)&&UWA.is(u)){var B=u.attr("id");if(UWA.is(CKEDITOR.instances[B])){CKEDITOR.instances[B].setData(z)}else{if(!!widget.getPreference("trm_richview_optimizedloading").value){function v(E){var F=new DOMParser(),C=F.parseFromString("<","text/xml"),D=C.getElementsByTagName("parsererror")[0].namespaceURI;if(D==="http://www.w3.org/1999/xhtml"){return E.getElementsByTagName("parsererror").length>0}return E.getElementsByTagNameNS(D,"parsererror").length>0}var A=new DOMParser();var y=A.parseFromString(z,"application/xml");if(UWA.is(y)&&UWA.is(y.querySelector("body"))&&!v(y)){z=y.querySelector("body").innerHTML}}u[0].innerHTML=z;if(x.hasOwnProperty("editable")){u[0].setAttribute("contenteditable",x.editable)}}}},save:function(E){this._logger.log("save");var D=this;var x=false;this.hasBeenModified=false;function z(I){return I.replace(/\n/g,"")}function u(I){var J=document.createElement("div");J.innerHTML=I;return J.textContent||J.innerText}var w=j.get();var C=this.clearSemanticFormat(E.getData().trim());var F=z(C.trim());var v=u(C.trim());var H=UWA.Utils.base64Encode(F);var A=UWA.Utils.base64Encode(v);var G=h(E.element.$).parents(D.options.selector).data("physicalid");var y=[];if(D.options.selector===".rich-container"){if(v.isEmpty()){x=true}y.push({name:"Title",value:v})}else{if(D.options.target===".rich-object-title-editable"){if(v.isEmpty()){x=true}y.push({name:"Title",value:v})}else{y.push({name:"Content Data",value:H},{name:"Content Text",value:A},{name:"Content Type",value:"html"})}}if(x===true){D.mediator.publish("onNotification",{className:"info",message:q.RichView_Notif_EmptyTitle});var B={element:h(E.element.$).parents(D.options.selector),refresh:["title"]};D.mediator.publish("onRefreshElement",B)}else{d.edit({securityContext:r.getSecurityContext(),pid:G,json:{attributes:y},onComplete:function(I){I=UWA.is(I,"string")?JSON.parse(I):I;var K=I.results;var J=UWA.is(K.type,"object")?K.type["displayName"]:K.type;var L=J+" "+K.name+" "+K.revision;var M=q.RichView_Notif_ObjectSaved;M=M.replace("{TNR}",L);D.mediator.publish("onNotification",{className:"success",message:M});var N={element:h(E.element.$).parents(D.options.selector)};if(D.options.selector===".rich-container"){N.updates={title:v}}else{if(D.options.target===".rich-object-title-editable"){N.updates={title:v}}else{N.updates={content:F}}}D.mediator.publish("onUpdateElement",N);D._padCommandProxy.refresh({authored:{modified:[K.physicalid]}})},onFailure:function(J,I){if(UWA.is(J,"string")){try{J=JSON.parse(J)}catch(L){}}if(UWA.is(I,"string")){try{I=JSON.parse(I)}catch(L){}}if(UWA.is(I)&&UWA.is(I.message,"string")){D.mediator.publish("onNotification",{className:"error",message:I.message})}else{if(UWA.is(J)&&UWA.is(J.message,"string")){D.mediator.publish("onNotification",{className:"error",message:J.message})}else{if(UWA.is(J,"string")){D.mediator.publish("onNotification",{className:"error",message:J})}else{console.error('"RequirementWebServices.edit(...)" failed without returning an error message!')}}}var K={element:h(E.element.$).parents(D.options.selector)};if(D.options.selector===".rich-container"){K.refresh=["title"]}else{K.refresh=["content"]}D.mediator.publish("onRefreshElement",K)}})}},cancel:function(u){this._logger.log("cancel");this.editor.destroy(true);this.mediator.publish("onCancel",u)},clearSemanticFormat:function(v){var w=["find-in-resultgreen","find-in-resultyellow","find-in-resultred"];for(var u=0;u<w.length;++u){h(v).find("span."+w[u]).contents().unwrap()}console.log("RCE: Data cleared before save!");return v}});return c});define("DS/RichView/Service/KeyboardShortcuts",["UWA/Class","UWA/Class/Events","DS/Logger/Logger","DS/PADUtils/PADContext","DS/TraceableRequirementsUtils/jQuery","text!DS/TraceableRequirementsUtils/assets/RequirementRelationshipsPatterns.json","i18n!DS/TraceableRequirementsUtils/assets/nls/TraceableRequirementsUtils"],function(a,h,b,e,i,g,c){var d=null;var f=a.singleton(h,{name:"KeyboardShortcuts",options:{},mediator:null,_logger:null,_defaultTypes:{},init:function(j){d=this;this._logger=b.getLogger(f);this._relPattern=JSON.parse(g);return this},addKeyboardEventListener:function(){this._logger.log("_addKeyboardEventListener");document.addEventListener("keyup",this._objectCreation,false)},removeKeyboardEventsListener:function(){this._logger.log("_removeKeyboardEventsListener");document.removeEventListener("keyup",this._objectCreation,false)},_objectCreation:function(r){var s=null;var m=null;var k=null;var o=null;var t=false;var n=e.get();if(r.altKey&&r.keyCode===73){t=true;o="over";m=n.getDefaultType("Requirement");k="Requirement";var p=n.getSelectedElement();if(p.path.length===1){s=undefined}else{var j=d._relPattern[p.kindof]||d._relPattern[p.type];if(j.Requirement){s=p.element}else{t=false}}}else{if(r.altKey&&r.keyCode===74){t=true;o="over";m=n.getDefaultType("Chapter");k="Chapter";var p=n.getSelectedElement();if(p.path.length===1){s=undefined}else{var j=d._relPattern[p.kindof]||d._relPattern[p.type];if(j.Chapter){s=p.element}else{t=false}}}else{if(r.altKey&&r.keyCode===71){t=true;o="after";m=n.getDefaultType("Requirement");k="Requirement";var p=n.getSelectedElement();if(p.path.length===1){var u=i(".rich-object:not(.placeholder),.rich-container");if(u.size()>0){s=u.eq(u.size()-1)}else{t=false}}else{s=p.element}}else{if(r.altKey&&r.keyCode===75){t=true;o="after";m=n.getDefaultType("Chapter");k="Chapter";var p=n.getSelectedElement();if(p.path.length===1){var u=i(".rich-object:not(.placeholder),.rich-container");if(u.size()>0){s=u.eq(u.size()-1)}else{t=false}}else{s=p.element}}}}}if(t===true){var q={};if(UWA.is(s)){q={element:s,id:s.attr("id")}}var l={target:q,position:o,operation:"insertNew",type:m,kindof:k,content:"",contentType:"html"};if(UWA.is(n)&&UWA.is(n.authoring)&&UWA.is(n.authoring.insertWithPromise)){n.authoring.insertWithPromise(l)}}else{if(UWA.is(n)&&UWA.is(n.displayNotification)){}}return}});return f});define("DS/RichView/mixins/_RichBIFilter",["UWA/Class"],function(b){var a=b.extend({_biFilter:null,eventInit:false,initializeBI:function(c){var d=this;this._createProxy()},cleanProxy:function(){if(this._biFilter&&this._biFilter.cleanProxy){this._biFilter.cleanProxy()}if(this._biFilter&&this._biFilter.resetNGFilterUI){this._biFilter.resetNGFilterUI({widgetId:widget.id})}},onApplyNGFilter:function(c){var d=c||null;d=UWA.is(d,"string")?JSON.parse(d):d;this.applyFilter(d)},onSetPathTags:function(){if(this._biFilter){var g=this;this._biFilter.setPathTags({nodes:[],paths:[]});var h={nodes:[],paths:[]};var c={};function e(i){if(!c.hasOwnProperty(i)){h.nodes.push(i);c[i]=h.nodes.length-1}return c[i]}function f(k){if(!k.isHidden()){var j=k.getPath();var l=j.map(function(n){var m=n.getID();return e(m)});h.paths.push(l);var i=k.getChildren();if(i){i.forEach(function(m){f(m)})}}}var d=g.options.model.getRoots();d.forEach(function(i){f(i)});g._biFilter.setPathTags(h)}},onFilterBIColorize:function(f){console.log("_RichBIFilter onFilterBIColorize");var d=this;var c="FilterBIColorize";function e(h,g){if(UWA.is(h.coloredSubjects,"array")){h.coloredSubjects.forEach(function(j){var i=j.color;var k=j.path.map(function(l){return h.nodes[l]});g(i,k)})}else{console.error("Invalid Argument : %o",f)}}e(f,function(g,h){d.options.model.getNodesByIDPath(h).forEach(function(i){if(UWA.is(i.getRichViewElement())){i.getRichViewElement().update({bi_color:g})}})})},onFilterBIUnColorize:function(){console.log("_RichBIFilter onFilterBIUnColorize");var c=this;c.options.model.getRoots().forEach(function(d){d.getAllDescendants().forEach(function(e){e.getRichViewElement().update({bi_color:""})})})},onFilterBIFilteringEvent:function(q){var m=this,r=false;var k=m.options.model;if(q){if(Object.keys(q.allfilters).length>0){r=true}}m.options.model.onUpdate(function(i){console.log("_RichBIFilter onNodeModelUpdate",i)});var s=k.getRoots(true).slice(0);s.forEach(function(i){i.filterIn(true)});var n=q.filteredSubjectList;if(n){var c=q.nodes;var d=[];var e={};var g=function g(i){return c[i]};for(var h=0;h<n.length;h++){var p=n[h];if(!e.hasOwnProperty(p)){d.push(p.map(g))}}d.forEach(function(i){k.getNodesByIDPath(i).forEach(function(t){t._filterStatus="IN";t.getParents().forEach(function(u){u._filterStatus="IN"})})});var o=function o(t,u){if(t._filterStatus==="IN"){var i=t.getChildren();if(i&&i.length>0){i.slice(0).forEach(function(w){o(w)})}}else{var v=t.getAllDescendants();if(v&&v.length>0){v.slice(0).forEach(function(w){w.filterOut();if(u){u.push(w)}delete w._filterStatus})}t.filterOut();if(u){u.push(t)}}delete t._filterStatus};s.forEach(function(i){o(i);var t=false;if(i.options._childrenFilterInfo){var u=i.options._childrenFilterInfo.filteredOutChildren;if(u&&u.length>0){t=true}}if(t){i.setState({state:"partiallyExpanded"});i.options.padstate="partiallyExpanded"}t=false});var j=[];for(var l=0;l<d.length;l++){var f=d[l];j.push(f[f.length-1])}this.onSetPathTags()}else{console.error("Invalid Argument : %o",q)}},_createProxy:function(){var c=this;require(["DS/ENOFilterBIUX/FilterBIComponentProxy"],function(d){var e={tenant:c.getTenant(),processingMode:"appProcessing",colorize:true,widgetId:widget.id};if(UWA.is(c.onFilterFilteringEvent,"function")){e.events={addFilterChangeListener:c.onFilterFilteringEvent.bind(c)}}c._biFilter=new d(e);c._biFilter.addEvent("FilterBIColorize",c.onFilterBIColorize,c);c._biFilter.addEvent("FilterBIUnColorize",c.onFilterBIUnColorize,c);c._biFilter.addEvent("FilterBIFilteringEvent",c.onFilterBIFilteringEvent,c);c.options.model.addEventListener("setPathTags",c.onSetPathTags.bind(c));c.eventInit=true})},_colorChildren:function(){}});return a});define("DS/RichView/Service/WidgetPreferences",["UWA/Class","UWA/Class/Events","DS/Logger/Logger","DS/TraceableRequirementsUtils/Services/RequirementSecurityCtxMgt","DS/TraceableRequirementsUtils/Services/RequirementTypeMgt","DS/TraceableRequirementsUtils/Services/RequirementTenantMgt","i18n!DS/RichView/assets/nls/RichView"],function(a,g,c,f,i,e,b){var d=null;var h=a.extend(g,{name:"richview_widgetpreferences",_logger:null,init:function(){d=this;this._logger=c.getLogger("DS/RichView/Service/WidgetPreferences")},addPreferencesToWidget:function(j){this._addTenantMgtToPreference(j);this._addSecurityContextPreference(j);this._addSubcriptionToPreference();this._addTypeMgtToPreference(j)},_addSecurityContextPreference:function(j){this._logger.log("add security context management to the widget preferences");f.addSecurityCtx2Preferences(j)},_addTypeMgtToPreference:function(j){this._logger.log("add requirement type management to the widget preferences");i.addTypes2Preferences(j)},_addTenantMgtToPreference:function(j){this._logger.log("add tenant management to the widget preferences");e.addTenant2Preferences(j)},_addSubcriptionToPreference:function(){this._logger.log("add TRA subscription management to the widget preferences");widget.mergePreferences([{name:"subscribeToTRASelect",type:"boolean",label:b.RichView_SubscribeToTRA,defaultValue:"false"}])}});return h});define("DS/RichView/Navigation",["UWA/Core","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/jQueryUI","DS/UIKIT/Scroller","DS/TraceableRequirementsUtils/Fancytree","i18n!DS/RichView/assets/nls/RichView","css!DS/RichView/RichView.css","css!../VENREQPlugins/External/fancytree/latest/media/skin-bootstrap/ui.fancytree.css"],function(f,e,b,a,d,g){var c=function(p){var m=UWA.merge(p||{},{mediator:null,selector:"h1,h2,h3,h4",context:null});var o={categories:function(r){var q=g.RichView_Headers_Navigation;return e('<div class="navigation-categories hidden-xs"><ul class="navigation-categories-list">	<li class="active nav-headers" data-content="headers">'+q+"</li></div></ul>")},content:function(q){return e('<div class="navigation-content">	<div class="navigation-headers active"></div></div>')},navigation:function(r){var q=e('<div class="navigation-list"></div><div class="top-border"><span class="fonticon fonticon-doc-text "></span>'+r.objects+' <span class="fonticon fonticon-book"></span>'+r.containers+"</div>");return q},helpers:function(q){return e('<div class="helpers">	<p></p></div>')},tree:function(q){return e('<div id="treetable" style="font-size: 8pt; border: none;"></div>')}};var n=0;var j=function(){return ++n};var l="expanded",i="over";var k=0;var h=null;return{inject:function(q){h=this;this.options=m;this.mediator=m.mediator;this.context=m.context;this.container=q;this._navigationCategories();this._init();return this},_subscribers:{subscribeToScroll:function(){h.mediator.subscribe("onScroll",function(q){k=q.position;h.update(q.position)})},subscribeToHelpersClick:function(){h.mediator.subscribe("onClick:helpers",function(){e(h.container+" .navigation-categories-list .nav-helpers").click()})},subscribeToHeadersClick:function(){h.mediator.subscribe("onClick:headers",function(){e(h.container+" .navigation-categories-list .nav-headers").click()})},subscribeToRefresh:function(){h.mediator.subscribe("onRefresh",function(q){h.refresh()})}},_init:function(){this._subscribers.subscribeToHelpersClick();this._subscribers.subscribeToHeadersClick();this._subscribers.subscribeToScroll();this._subscribers.subscribeToRefresh();this.isExpanded="expanded";this.navigation=e(this.container+" .navigation-headers").append(o.navigation({objects:e(".rich-object").length,containers:e(".rich-container").length,}));this.helpers=e(this.container+" .navigation-helpers").append(o.helpers({}));try{e(".navigation-list").fancytree(this.getExplorerSettings())}catch(q){console.warn(error)}if(!this.isExpanded){var r=new Array();e(this.container).on("mouseover",".navigation-entry",function(t){var s=e(t.target);r.push(s);if(s.hasClass("expanded-temp-object")||s.parent().hasClass("expanded-temp-object")){return}if(!s.hasClass("navigation-entry")){s=s.parent()}s.nextUntil(":not(.collapsed-object)").removeClass("collapsed-object").addClass("expanded-temp-object")});e(this.container).on("mouseleave",".navigation-list",function(t){for(var s=0;s<r.length;s++){r[s].nextUntil(":not(.expanded-temp-object)").removeClass("expanded-temp-object").addClass("collapsed-object")}})}},_navigationCategories:function(){var r=e(this.container).append(o.categories());var q=e(this.container).append(o.content());e(this.container+" .navigation-categories-list").on("click","li",function(t){var s=e(this);if(s.hasClass("active")){return false}else{e(h.container+" .navigation-"+e("li.active",r).removeClass("active").addClass("not-active").data("content")).removeClass("active").addClass("not-active");e(h.container+" .navigation-"+s.removeClass("not-active").addClass("active").data("content")).removeClass("not-active").addClass("active")}})},_scrollView:function(s,r){var q=e(".navigation-content").height();e(s).height(q);h.scroller=new a({element:UWA.Element.getElement.call(document,this.container+" "+s)}).inject(UWA.Element.getElement.call(document,this.container+" "+r),"top")},update:function(r){var q=this.navigation;function s(){var t=q.find(".fancytree-node").map(function(){var v=e(this);var w=e("#"+v.data("id"));if(w===null||!w.is(":visible")){return null}return{top:w.position().top,node:v}});var u=null;e.each(t,function(v,x){var w=x.node;w.removeClass("navigation-current");if((u===null||(x.top<=0&&x.top>u.top))){u=x}});u&&u.node.addClass("navigation-current")}s()},refresh:function(){e(".navigation-list").fancytree("destroy");if(h.scroller){h.scroller.destroy();h.scroller=null}e(".navigation-list").empty();e(".navigation-list").fancytree(this.getExplorerSettings())},resizeList:function(){var q=e(".navigation-content").height()-e(".top-border").height();e(".navigation-list").height(q)},getExplorerSettings:function(){var q=e(this.options.selector);if(q.length===0){return}var u=[];for(var r=0;r<q.length;r++){var s=q.eq(r);u[r]={title:s.find(".rich-container-title").text(),key:s.attr("id")}}var t={map:{doc:"fonticon fonticon-book",docOpen:"glyphicon glyphicon-file",checkbox:"glyphicon glyphicon-unchecked",checkboxSelected:"glyphicon glyphicon-check",checkboxUnknown:"glyphicon glyphicon-share",dragHelper:"ffonticon fonticon-play",dropMarker:"fonticon fonticon-right",error:"glyphicon glyphicon-warning-sign",expanderClosed:"glyphicon glyphicon-plus-sign",expanderLazy:"glyphicon glyphicon-plus-sign",expanderOpen:"glyphicon glyphicon-minus-sign",folder:"glyphicon glyphicon-folder-close",folderOpen:"glyphicon glyphicon-folder-open",loading:"glyphicon glyphicon-refresh"}};return{extensions:["dnd","glyph","wide"],checkbox:false,dnd:{focusOnClick:true,dragStart:function(v,w){return true},dragEnter:function(v,w){return true},dragOver:function(v,w){switch(w.hitMode){case"after":v.span.classList.remove("droppable-child");if((v.li.nextSibling&&!v.li.nextSibling.classList.contains("droppable-below"))||(!v.li.nextSibling&&v.isLastSibling())){e(v.li).after('<div class="droppable-target droppable-below wux-datagrid-row-insertion-mark"></div>')}break;case"before":v.span.classList.remove("droppable-child");if((v.li.previousSibling&&!v.li.previousSibling.classList.contains("droppable-below"))||(!v.li.previousSibling&&v.isFirstSibling())){e(v.li).before('<div class="droppable-target droppable-below wux-datagrid-row-insertion-mark"></div>')}break;case"over":if(v.li.previousSibling&&v.li.previousSibling.classList.contains("droppable-below")){v.li.parentNode.removeChild(v.li.previousSibling)}if(v.li.nextSibling&&v.li.nextSibling.classList.contains("droppable-below")){v.li.parentNode.removeChild(v.li.nextSibling)}v.span.classList.add("droppable-child");break}},dragStop:function(v,w){if(v.li.previousSibling&&v.li.previousSibling.classList.contains("droppable-below")){v.li.parentNode.removeChild(v.li.previousSibling)}if(v.li.nextSibling&&v.li.nextSibling.classList.contains("droppable-below")){v.li.parentNode.removeChild(v.li.nextSibling)}v.span.classList.remove("droppable-child")},dragLeave:function(v,w){if(v.li.previousSibling&&v.li.previousSibling.classList.contains("droppable-below")){v.li.parentNode.removeChild(v.li.previousSibling)}if(v.li.nextSibling&&v.li.nextSibling.classList.contains("droppable-below")){v.li.parentNode.removeChild(v.li.nextSibling)}v.span.classList.remove("droppable-child")},dragDrop:function(v,w){if(v.li.previousSibling&&v.li.previousSibling.classList.contains("droppable-below")){v.li.parentNode.removeChild(v.li.previousSibling)}if(v.li.nextSibling&&v.li.nextSibling.classList.contains("droppable-below")){v.li.parentNode.removeChild(v.li.nextSibling)}v.span.classList.remove("droppable-child");h.mediator.publish("onReorder",{source:{element:e("#"+w.otherNode.key),id:w.otherNode.key},target:{element:e("#"+v.key),id:v.key},position:w.hitMode,type:"rich-container"});if(w.hitMode==="over"){w.hitMode="after"}w.otherNode.moveTo(v,w.hitMode)}},glyph:t,selectMode:2,source:u,table:{nodeColumnIdx:1},wide:{iconWidth:"1em",iconSpacing:"0.5em",levelOfs:"1.5em"},activate:function(v,w){},lazyLoad:function(v,w){w.result={url:"ajax-sub2.json",debugDelay:1000}},click:function(v,w){h.mediator.publish("onNavigationClick",w.node.key)},renderNode:function(w,x){var v=x.node;v.span.setAttribute("data-id",v.key)},init:function(){try{h._scrollView(".navigation-list",".navigation-headers")}catch(v){}}}},}};return c});define("DS/RichView/Command/CreateLinkAction",["UWA/Core","UWA/Class","DS/UIKIT/SuperModal","DS/UIKIT/Input/Toggle","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/TraceableRequirementsUtils/Utils","DS/PlatformAPI/PlatformAPI","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/REQCommandProxy","UWA/Drivers/Alone","DS/Logger/Logger","DS/PADUtils/PADContext","i18n!DS/RichView/assets/nls/RichView","i18n!DS/RichView/assets/nls/CreateLinkAction","css!DS/RichView/RichView.css"],function(a,s,q,o,f,g,e,n,k,u,v,p,l,r){var h={radioBtn:function(A){var z='<div class="toggle create-link-options"><input type="radio" name="radios" id="radio'+A.index+'" value="'+A.rel+'"><label class="control-label" for "radio1">'+A.label+"</label></div>";return z}};var t="http://www.3ds.com/vocabularies/syc/type/Scope";var i="http://www.3ds.com/vocabularies/syc/type/Traceability";var b="http://www.3ds.com/vocabularies/syc/type/Enovia.Requirement%20Specification";var j="/";var m="traceability_model";var x="http://www.3ds.com/vocabularies/syc/displayText";var c="ENORERE_AP.StartLink";var d="TRA-current-scope";var w=null;var y=s.singleton({name:"CreateLinkCommand",context:null,defaultOptions:{renderTo:".content-panel",relationship:undefined},_superDlg:null,_commandProxy:null,_initialized:false,_scopeId:null,_notifSMV:null,_widgetIdSMV:null,init:function(z){w=this;this._logger=v.getLogger(y);this._logger.log("init");UWA.merge(z||{},w.defaultOptions);this._parent(z);this.context=p.get();this._commandProxy=new k();this.getScopeFromStorage();this.subscribeToSMVContextModification();this._initialized=true;return this},setStartLink:function(z){sessionStorage.removeItem(c);sessionStorage.setItem(c,JSON.stringify(z))},getStartLink:function(){var z=sessionStorage.getItem(c);return UWA.is(z,"string")?JSON.parse(z):z},getScopeFromStorage:function(){try{var B=JSON.parse(localStorage.getItem(d));var A=w._formatMessage(B);w._onSMVContextChanged(A)}catch(z){w._logger.log("Failed to retrieve TRA-current-scope")}},subscribeToSMVContextModification:function(){if(!UWA.is(w._notifSMV)){w._logger.log("Subscribing to topic: DS/CATSmmUI/3DExperience/Proxy/contextChanged");w._notifSMV=e.subscribe("DS/CATSmmUI/3DExperience/Proxy/contextChanged",function(z){w._onSMVContextChanged(z)})}if(widget.hasEvent("onCheckScopeRV")===false){widget.addEvent("onCheckScopeRV",function(z){w.getScopeFromStorage()})}},_formatMessage:function(B){var A={resources:[],widgetId:B.widgetId};if(UWA.is(B.scope)&&UWA.is(B.scope.id)){var D=B.scope.id;var C=B.scope.types;var z=B.scope.title;A.resources.push({id:D,types:C,title:z})}return A},_onSMVContextChanged:function(A){var B=JSON.parse(localStorage.getItem(d));var z=w._formatMessage(B);if(UWA.is(z.resources)&&z.resources.length>0){var B=z.resources[0];if(UWA.is(B.types[0])&&B.types[0]===t){w._setScope(B.id,z.widgetId,B.title)}else{w._cleanScope()}}else{w._cleanScope()}},_setScope:function(z,A,B){w._scopeId=z;w._widgetIdSMV=A;w.context.updateScopeInformation(B);w.context.setTraceabiltyScope(z,B)},_cleanScope:function(){w._scopeId=null;w._widgetIdSMV=null;w.context.updateScopeInformation(l.RichView_DefaultValue_None);w.context.setTraceabiltyScope(null,null)},execute:function(z){w._initUI(w.defaultOptions.renderTo);w.defaultOptions.to=z.to;w.defaultOptions.from=z.from;if(UWA.is(w._scopeId)){w._getScopeInformation()}else{w._displayDialog()}},_initUI:function(z){w._superDlg=new q({closable:true,renderTo:UWA.Element.getElement.call(document,z)})},_getScopeInformation:function(){f.getScopeInformation({scopeId:w._scopeId,onComplete:function(A){w._logger.log("RequirementWebServices.getScopeInformation onComplete");var z=UWA.is(A,"string")?JSON.parse(A):A;w._checkScopeContent(z)},onFailure:function(z){w._logger.log("RequirementWebServices.getScopeInformation onFailure");w._displayDialog()},onTimeout:function(z){w._logger.log("RequirementWebServices.getScopeInformation onTimeout");w._displayDialog()}})},_checkScopeContent:function(A){var I=A.roots;var H=A.links;var G=false;var J=Object.keys(I);for(var B=0;B<J.length;B++){var E=I[J[B]];if(E.type===b){var D=E.id;var F=D.substr(D.lastIndexOf(j)+1);if(F===w.defaultOptions.from.path[0]){var z=E.outLinks;G=w._checkLinks(I,H,z,"to",w.defaultOptions.to.path[0],"Upstream Derived Requirement");if(G===true){break}var C=E.inLinks;G=w._checkLinks(I,H,C,"from",w.defaultOptions.to.path[0],"Derived Requirement");if(G===true){break}}}}if(G===true){w._createLink()}else{w._displayDialog()}},_checkLinks:function(K,J,z,H,C,E){var I=false;for(var D=0;D<z.length;D++){var A=z[D];var M=J[A];var L=M[H];for(var B=0;B<L.length;B++){var G=K[L[B]];var F=G.id;F=F.substr(F.lastIndexOf(j)+1);if(G.type===b&&F===C){w.defaultOptions.relationship=E;I=true;break}}if(I===true){break}}return I},_displayDialog:function(){var F=["Downstream Derived Requirement","Upstream Derived Requirement"];var E=[];var G="<div>";var A=w.defaultOptions.from.type+' "'+w.defaultOptions.from.title+'"';A=A.length>40?(A.substr(0,39)+'..."'):A;var B=w.defaultOptions.to.type+' "'+w.defaultOptions.to.title+'"';B=B.length>40?(B.substr(0,39)+'..."'):B;for(var D=0;D<F.length;D++){var C=F[D];C=C.split(" ").join("_");C="CreateLinkAction_"+C;var z=r[C];z=z.replace("{first_object}",A);z=z.replace("{second_object}",B);G+=h.radioBtn({index:D,rel:F[D],label:z})}G+="</div>";w._superDlg.dialog({title:r.CreateLinkAction_SelectRelationship,body:n(G),buttons:[{value:r.CreateLinkAction_Cancel,action:function(H){w._cancel(H)}},{value:r.CreateLinkAction_Confirm,action:function(H){w._confirm(H)}}]});n("input[name=radios]")[0].checked=true},_cancel:function(z){z.hide()},_confirm:function(z){w.defaultOptions.relationship=n("input[name=radios]:checked",z.elements.content).val();z.hide();w._createLink()},_createLink:function(){var B,z,A=null;if(w.defaultOptions.relationship==="Downstream Derived Requirement"){B="Derived Requirement";z=w.defaultOptions.from.id;A=w.defaultOptions.to.id}else{if(w.defaultOptions.relationship==="Upstream Derived Requirement"){B="Derived Requirement";z=w.defaultOptions.to.id;A=w.defaultOptions.from.id}else{B=w.defaultOptions.relationship;z=w.defaultOptions.from.id;A=w.defaultOptions.to.id}}f.connect({securityContext:g.getSecurityContext(),json:{pid:z,id:A,relationship:B},onComplete:function(D){var D=JSON.parse(D);w._displayNotification({className:"success",message:r.CreateLinkAction_Success});var C=widget.getUrl();C=C.substr(0,C.indexOf("/webapps"));var F=C.substr(C.lastIndexOf("/")+1);var E=w.defaultOptions.relationship==="Upstream Derived Requirement"?"covered":"refined";var D={from:w.defaultOptions.from,to:w.defaultOptions.to,link_type:E,connection:D.results["type[connection]"],connectionId:D.results["id[connection]"],widgetid:widget.id,contextId:g.getSecurityContext()};w._commandProxy.traceabilityAuthoring({data:D,appId:widget.getValue("appId"),event:"create"});if(UWA.is(w._scopeId)){setTimeout(function(){w._logger.log("Publish topic DS/CATSmmUI/3DExperience/Proxy/refresh");e.publish("DS/CATSmmUI/3DExperience/Proxy/refresh",{resources:[w._scopeId+"/"+m],widgetId:w._widgetIdSMV,clearCache:true})},500)}},onFailure:function(D,C){var E=D.message;w._displayNotification({className:"error",message:r.CreateLinkAction_Failure});C=UWA.is(C,"string")?JSON.parse(C):C;if(UWA.is(C.message)){E=C.message}w._displayNotification({className:"error",message:E})}})},_displayNotification:function(z){if(UWA.is(w.context)&&UWA.is(w.context.displayNotification)){w.context.displayNotification({eventID:z.className,msg:z.message})}else{alert(z.message)}}});return y});define("DS/RichView/ActionBar",["DS/Core/Core","DS/ApplicationFrame/FrameWindow","DS/RuntimeView/NLSManager","DS/Core/ModelEvents","css!DS/RichView/RichView.css"],function(c,a,b,d){var e=function(g){var j=UWA.merge(g||{},{mediator:null});var i="trm-richview";var f=["InsertRequirement","InsertComment","InsertChapter"];var h=null;return{inject:function(){c.setFullscreen();h=this;this.options=j;this.mediator=j.mediator;this._modelEvents=new d();b.DEFAULT_LANGUAGE=widget.lang?widget.lang:widget.getValue("lang");b.loadResource({resourceFile:"RichView/RichView"});b.onResourceLoaded({resourceFile:"RichView/RichView",language:widget.lang?widget.lang:widget.getValue("lang")},function(){});widget.frmWindow=new a({workbenchModule:"RichView",workbench:"RichView.xml",viewer:"none",height:"100%"}).inject(widget.body);var k=widget.frmWindow.getUIFrame();var l=new UWA.Element("div",{id:i});l.inject(k);widget.frmWindow.onActionBarReady(function(){k.style.height=k.parentNode.offsetHeight-70+"px";this._modelEvents.subscribe({event:"ACTIONBAR_OPEN"},function(m){k.style.height=k.parentNode.offsetHeight-70+"px"});this._modelEvents.subscribe({event:"ACTIONBAR_CLOSE"},function(m){k.style.height=k.parentNode.offsetHeight-20+"px"})});return i}}};return e});define("DS/RichView/Command/CtxMenu_StartLinkCmd",["DS/ApplicationFrame/Command"],function(a){var b=a.extend({init:function(c){this._parent(c,{isAsynchronous:true});this.TOPIC_NAME="ENORERE_AP.StartLink"},execute:function(d){var c=this;sessionStorage.removeItem(this.TOPIC_NAME);sessionStorage.setItem(this.TOPIC_NAME,JSON.stringify(d))}});return b});define("DS/RichView/Models/RichViewDocument",["DS/Logger/Logger","DS/Tree/TreeDocument"],function(b,a){var d=null;var c=a.extend({init:function(e){d=this;this._parent(e)},sortInTreeOrder:function(e){if(!e){return}e.forEach(function(f){f.sortChildren({isRecursive:true,sortFunction:function(h,g){if(h.options&&g.options){if(h.options.relationOrder<g.options.relationOrder){return -1}else{if(h.options.relationOrder>g.options.relationOrder){return 1}}}return 0}})})},reparentNode:function(e,s,p,r,h,q){s.removeChild(e);e.setRelationID(h);e.setRelationOrder(r);e.setParentID(p.getID());p.addChild(e);e.setRelationType(q);var n=e.getLevel();var f=-1;var m=e.getBrothers();if(UWA.is(m)&&m.length>0){f=m[0].getLevel();if(!UWA.is(q)||q===""){q=m[0].getRelationType()}}else{f=p.getLevel()+1}e.setLevel(f);e.setRelationType(q);var k=f-n;var j=e.getAllDescendants();for(var l=0;l<j.length;l++){var o=j[l].getLevel();var g=o+k;j[l].setLevel(g)}d.sortInTreeOrder([p])},getNodesById:function(f){var e=[];this.getRoots().forEach(function(g){var h=g.getNodesById(f);e=e.concat(h)});return e},getNodesByMatrixID:function(f){var e=[];this.getRoots().forEach(function(g){var h=g.getNodesByMatrixID(f);e=e.concat(h)});return e},getNodeByOccurencePath:function(f){var e=this.getRoots();for(var g=0;g<e.length;g++){var h=e[g].getNodeByPath(f,undefined,undefined,true);if(h){return h}}},getNodesByRelId:function(e){var f=[];this.getRoots().forEach(function(g){var h=g.getNodesByRelId(e);f=f.concat(h)});return f},getNodesByElementID:function(e){var f=[];this.getRoots().forEach(function(g){var h=g.getNodesByElementID(e);f=f.concat(h)});return f},getNodesByIDPath:function(f){function e(j,k,h,l){if(j.getID()===k[h]){if(h===k.length-1){l.push(j)}else{var i=j.getChildren();if(i&&i.length>0){h+=1;i.forEach(function(m){e(m,k,h,l)})}}}}var g=[];this.getRoots().forEach(function(h){e(h,f,0,g)});return g}});return c});define("DS/RichView/Views/RichViewInfos",["i18n!DS/RichView/assets/nls/RichView","css!DS/RichView/RichView.css","UWA/Core","UWA/Controls/Abstract","UWA/Class/Options","UWA/Drivers/Alone","DS/Logger/Logger","DS/UIKIT/Tooltip","DS/UIKIT/Popover"],function(c,j,f,e,i,g,b,h,d){var a=e.extend(i,{name:"richview_infos",_logger:null,_tooltip:null,init:function(k){var l=k||{};this._logger=b.getLogger(a);this._logger.log("init");this._parent(k);this.elements.container=UWA.createElement("span",{"class":this.getClassNames()+" fonticon fonticon-info"});this._tooltip=new h({className:this.getClassNames("_tooltip"),target:this.elements.container,position:"left",body:this.buildInfos()});if(this.getOption("renderTo")){this.inject(this.getOption("renderTo"))}},setBody:function(){this._tooltip.setBody(this.buildInfos())},buildInfos:function(){var k=UWA.createElement("div",{"class":"richview_infos_msg"});var l=c.RichView_Tooltip_InsertReqAsChild+", "+c.RichView_Tooltip_InsertReqAsSibling+", "+c.RichView_Tooltip_InsertChapAsChild+", "+c.RichView_Tooltip_InsertChapAsSibling;var m=UWA.createElement("div",{text:l});m.inject(k);return k}});return a});define("DS/RichView/Views/DropInvit",["DS/TraceableRequirementsUtils/jQuery","i18n!DS/RichView/assets/nls/RichView","UWA/Core","UWA/Controls/Abstract","UWA/Class/Options","DS/PADUtils/PADContext","DS/HomePage/HomePage","text!DS/RichView/assets/RichViewSetting.json","css!DS/RichView/RichView.css"],function(k,c,b,d,h,f,j,g){var a=null;var i=JSON.parse(g);var e=d.extend(h,{name:"richview_main",mediator:null,_selector:null,_context:null,init:function(l){this._context=f.get();this._parent(l);a=this;this.elements.container=b.createElement("div",{"class":this.getClassNames("_container")});this.elements.container.invite=b.createElement("div",{"class":this.getClassNames("_invite")});this.elements.container.homepage=new j({widget:widget,settings:i}).inject(this.elements.container);this.elements.container.invite.drop=b.createElement("div",{"class":this.getClassNames("_display drop"),draggable:false}).inject(this.elements.container.invite);b.createElement("span",{"class":this.getClassNames("_img wux-ui-3ds wux-ui-3ds-5x wux-ui-3ds-drag-drop")}).inject(this.elements.container.invite.drop);b.createElement("h5",{"class":this.getClassNames("_txt font-3dsregular drop"),text:c.RichViewDropInvit_Drop}).inject(this.elements.container.invite.drop);this.elements.container.invite.inject(this.elements.container);if(this.getOption("renderTo")){this.elements.container.inject(b.Element.getElement.call(document,this.getOption("renderTo")))}this._droppable(this.getOption("selector"));this._selector=this.getOption("selector");this.mediator=this.getOption("mediator")},show:function(){this.elements.container.show()},hide:function(){this.elements.container.hide()},remove:function(){this._notDroppable(this._selector);this.elements.container.remove()},_onDragEnter:function(l){k(l).addClass("bordered")},_onDragLeave:function(l){k(l).removeClass("bordered")},_onDragEnd:function(l){k(l).removeClass("bordered")},_onDragOver:function(l,m){if(m.preventDefault){m.preventDefault()}m.originalEvent.dataTransfer.dropEffect="copy";k(l).addClass("bordered")},_onDrop:function(p,s){if(s.originalEvent.dataTransfer){if(s.stopPropagation){s.stopPropagation()}if(s.preventDefault){s.preventDefault()}k(p).removeClass("bordered");var o=false||!!document.documentMode;var q=o?"text":"text/searchitems";var m=window.navigator.userAgent;var n=m.indexOf("Edge/");if(n>0){q="text/plain"}var r=s.originalEvent.dataTransfer.getData(q);if(b.is(r)&&r!==""){var v=JSON.parse(r);var t=v.data.items;if(t.length>0){var u=t[0].objectId;var l=a.getOption("mediator");a._notDroppable(p);a.elements.container.remove();if(b.is(a._context)&&b.is(a._context._onInitialDrop)){a._context._onInitialDrop(u)}else{l.publish("onInitialDrop",u)}}}}},_droppable:function(l){k(l).on("dragenter",function(){a._onDragEnter(l)});k(l).on("dragleave",function(){a._onDragLeave(l)});k(l).on("dragend",function(){a._onDragEnd(l)});k(l).on("dragover",function(m){a._onDragOver(l,m);return false});k(l).on("drop",function(m){a._onDrop(l,m)})},_notDroppable:function(l){k(l).off("dragenter");k(l).off("dragover");k(l).off("dragend");k(l).off("dragleaver");k(l).off("drop")}});return e});define("DS/RichView/mixins/_delimiterUtilities",["UWA/Class"],function(b){var a=b.extend({_DELIMITER:"\7"});return a});define("DS/RichView/Views/RichViewIdCard",["UWA/Core","UWA/Class","DS/Logger/Logger","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/jQuery","DS/PADUtils/PADContext","i18n!DS/RichView/assets/nls/RichView","css!DS/RichView/RichView.css"],function(i,b,c,j,d,k,h,f){var a={container:function(l){return k('<div id="'+l.id+'" data-physicalid="'+l.physicalid+'" class="richview-idcard"></div>')},thumbnail:function(l){return k('<div class="richview-idcard-thumbnail"><div class="richview-idcard-title"><span class="trm-icon-large trm-icon-'+l.icon+'"></span> '+l.title+"</div></div>")},selection:function(l){return k('<div class="richview-idcard-selection"><div><span class="richview-idcard-property richview-idcard-padding">'+f.RichView_Headers_Containers+'</span><span class="richview-idcard-value">'+l.containers+'</span></div><div><span class="richview-idcard-property richview-idcard-padding">'+f.RichView_Headers_Objects+'</span><span class="richview-idcard-value">'+l.objects+'</span></div><div><span class="fonticon fonticon-close richview-idcard-delete" title="'+f.RichView_Tooltip_CleanSelection+'"></span><span class="richview-idcard-property richview-idcard-selected">'+f.RichView_Headers_Selected+'</span><span class="richview-idcard-value richview-idcard-link" data-id="'+l.id+'">'+l.selected+"</span></div></div>")},lifecycle:function(l){return k('<div class="richview-idcard-lifecycle"><span class="richview-idcard-property">'+f.RichView_Headers_Status+'</span><span class="richview-idcard-value">'+l.state+"</span></div>")},traceability:function(l){return k('<div class="richview-idcard-traceability"><span class="richview-idcard-property">'+f.RichView_Headers_TraceabilityScope+'</span><span class="richview-idcard-value">'+l.scope+"</span></div>")}};var e=null;var g=b.extend({name:"richview_identitycard",physicalid:null,container:null,init:function(l){e=this;this._parent(l);this._logger=c.getLogger(g);this._logger.log("init Id card");this.physicalid=l.physicalid;this.container=l.container;this.buildIdCard(this.physicalid)},_inject:function(l){this.container=l;this.container.prepend(this._idCardContainer);this.hideCleanSelection();this.container.on("click",".richview-idcard-link",function(m){if(UWA.is(this.dataset.id)&&this.dataset.id!==""){h.get().scrollToElement(this.dataset.id)}});this.container.on("click",".richview-idcard-delete",function(n){var m=k(".content-panel").find(".rich-object.active,.rich-container.active");m.toggleClass("active",false);h.get().onCleanSelection(true)})},updateSelection:function(){var r=k(".rich-container:not(.fake-rich-container)").length;var q=k(".rich-object").length;var o=f.RichView_DefaultValue_None;var n="";var p=h.get().getSelectedNodes()[0];var l=h.get().getSelectedElement();if(p.isRoot()===false){n=p.getRichViewElementID();o=p.options.title}else{o=f.RichView_DefaultValue_None;n=""}var m=a.selection({containers:r,objects:q,selected:o,id:n});if(UWA.is(this._idCardSelection)){this._idCardSelection.replaceWith(m);this._idCardSelection=m}if(o!==f.RichView_DefaultValue_None){k(".richview-idcard-link").addClass("richview-underline");this.showCleanSelection()}else{this.hideCleanSelection()}},showCleanSelection:function(){if(UWA.is(this._idCardSelection)){this._idCardSelection.find(".richview-idcard-delete").toggleClass("hidden",false);this._idCardSelection.find(".richview-idcard-selected").toggleClass("richview-idcard-padding",false)}},hideCleanSelection:function(l){if(UWA.is(this._idCardSelection)){this._idCardSelection.find(".richview-idcard-delete").toggleClass("hidden",true);this._idCardSelection.find(".richview-idcard-selected").toggleClass("richview-idcard-padding",true)}},updateThumbnail:function(l,n){var m=a.thumbnail({icon:l.toLowerCase().replace(" ","-"),title:n});if(this._idCardThumbnail){this._idCardThumbnail.replaceWith(m)}this._idCardThumbnail=m},updateLifecyle:function(m){var l=a.lifecycle({state:m});if(this._idCardLifecycle){this._idCardLifecycle.replaceWith(l)}this._idCardLifecycle=l;this._idCardLifecycle.append(this._idCardScope)},updateScope:function(m){var l=a.traceability({scope:m});if(this._idCardScope){this._idCardScope.replaceWith(l)}this._idCardScope=l},buildIdCard:function(l){j.getInfo({securityContext:d.getSecurityContext(),pid:l,selectables:"type,name,revision,attribute[Title],type.kindof,physicalid,current",onComplete:function(m){m=UWA.is(m,"string")?JSON.parse(m):m;var n=m.results[0];e._buildView(n);e._inject(e.container)},onFailure:function(m){},onTimeout:function(){}})},_buildView:function(o){var l=a.container({id:o.physicalid+"_idcard",physicalid:o.physicalid});var s=a.thumbnail({icon:o["type.kindof"].toLowerCase().replace(" ","-"),title:o["attribute[Title]"]});var n=a.selection({containers:"0",objects:"0",selected:f.RichView_DefaultValue_None});var m=a.lifecycle({state:o.current.displayName});var r=f.RichView_DefaultValue_None;var p=h.get().getTraceabilityScope();if(UWA.is(p)&&UWA.is(p.title)){r=p.title}var q=a.traceability({scope:r});m.append(q);l.append(s).append(n).append(m);this._idCardContainer=l;this._idCardThumbnail=s;this._idCardLifecycle=m;this._idCardSelection=n;this._idCardScope=q;return l}});return g});define("DS/RichView/Models/RichViewModel",["DS/ENXNav/models/xNavNodeModel","DS/PADUtils/PADSettingsMgt"],function(d,c){function b(e){if(!e._getFilterInfo){e._getFilterInfo=a.prototype._getFilterInfo.bind(e);e._getChildrenFilterInfo=a.prototype._getChildrenFilterInfo.bind(e);e._removeChildrenFilterInfo=a.prototype._removeChildrenFilterInfo.bind(e);e.filterInChild=a.prototype.filterInChild.bind(e);e.filterOutChild=a.prototype.filterOutChild.bind(e)}}function a(e){this.options={matrixID:null,physicalID:null,elementID:null,elementRV:null,type:"",kindof:"",title:"",name:"",revision:"",content:"",relationtype:"",relationid:null,parentID:"",level:0,editable:true,isDocx:false,format:"html"};if(UWA.is(e.relcount)&&e.relcount===0){e.children=null}this.tenant=e.tenant;this.options=UWA.extend(this.options,e);d.call(this,this.options)}a.prototype=Object.create(d.prototype);a.prototype.setParentID=function(e){this.options.parentID=e};a.prototype.getParentID=function(){return this.options.parentID};a.prototype.setLevel=function(e){this.options.level=e};a.prototype.getLevel=function(){return this.options.level};a.prototype.setRelationOrder=function(e){this.options.relationOrder=e};a.prototype.getRelationOrder=function(){return this.options.relationOrder};a.prototype.getRelationType=function(){return this.options.relationtype};a.prototype.setRelationType=function(e){this.options.relationtype=e};a.prototype.setRichViewElementID=function(e){this.options.elementID=e};a.prototype.getRichViewElementID=function(){return this.options.elementID};a.prototype.setRichViewElement=function(e){this.options.elementRV=e};a.prototype.getRichViewElement=function(){return this.options.elementRV};a.prototype.getNodesByMatrixID=function(f){var e={listOfFoundNodes:[],foundId:undefined};this._getNodesByMatrixID(f,e);return e.listOfFoundNodes};a.prototype._getNodesByMatrixID=function(k,j){var f=this.options.matrixID;var e=this.getID();if(f===k){j.listOfFoundNodes.push(this);j.foundId=e}else{if(e!==j.foundId){var h=this.getChildren();if(h){for(var g=0;g<h.length;g++){h[g]._getNodesByMatrixID(k,j)}}}}};a.prototype.getNodesByElementID=function(e){var f={listOfFoundNodes:[],foundId:undefined};this._getNodesByElementID(e,f);return f.listOfFoundNodes};a.prototype._getNodesByElementID=function(f,k){var g=this.options.elementID;var e=this.getID();if(g===f){k.listOfFoundNodes.push(this);k.foundId=e}else{if(e!==k.foundId){var j=this.getChildren();if(j){for(var h=0;h<j.length;h++){j[h]._getNodesByElementID(f,k)}}}}};a.prototype._removeFilterInfo=function(){delete this.options._filterInfo};a.prototype._removeChildrenFilterInfo=function(){delete this.options._childrenFilterInfo};a.prototype._getFilterInfo=function(e){if(!this.options._filterInfo&&Boolean(e)){this.options._filterInfo={}}return this.options._filterInfo};a.prototype._getChildrenFilterInfo=function(e){if(!this.options._childrenFilterInfo&&Boolean(e)){this.options._childrenFilterInfo={}}return this.options._childrenFilterInfo};a.prototype.filterOut=function(){var e=this.isRoot()?this.getTreeDocument():this.getParent();if(e!==null){b(e);e.filterOutChild(this)}};a.prototype.filterIn=function(e){var i=this._getFilterInfo();if(i&&i.parentBeforeFiltering){var g=i.parentBeforeFiltering;b(g);g.filterInChild(this)}if(Boolean(e)){var f;var h=this._getChildrenFilterInfo();if(h&&h.childrenBeforeFiltering){f=h.childrenBeforeFiltering}else{f=this.getChildren()}if(f){f.forEach(function(j){j.filterIn(e)})}}};a.prototype.filterOutChild=function(i){var e=this.getChildren();if(e.indexOf(i)<0){throw"Not a child"}var h=this._getChildrenFilterInfo(true);if(!h.childrenBeforeFiltering){h.childrenBeforeFiltering=e&&e.length>0?e.slice(0):[];var g={noExpandState:"noChildren",expandingState:"expanding",partiallyExpandedState:"partiallyExpanded",collapseState:"expanded",expandState:"collapsed",noChildren:"noChildren",expanding:"expanding",partiallyExpanded:"partiallyExpanded",expanded:"expanded",collapsed:"collapsed"};if(UWA.is(this._expandState)){h.expandStateBeforeFiltering=g[this._expandState]}}var f=i._getFilterInfo(true);f.parentBeforeFiltering=this;if(UWA.is(this.removeChild,"function")){this.removeChild(i);i.options.elementRV.hide()}else{}if(UWA.is(this.setState,"function")){this.setState({state:h.expandStateBeforeFiltering})}if(!h.filteredOutChildren){h.filteredOutChildren=[]}h.filteredOutChildren.push(i)};a.prototype.filterInChild=function(f){var o=this._getChildrenFilterInfo();if(o){var m=o.childrenBeforeFiltering;if(m){var g=m.indexOf(f);if(g>=0){var l=f._getFilterInfo();if(l&&l.parentBeforeFiltering===this){var p=this.getChildren();var j;if(p){for(var h=0;h<p.length;h++){var k=p[h];var e=m.indexOf(k);if(e>g){j=k;break}}}delete l.parentBeforeFiltering;if(!f.isRoot()){if(f.options.isRootAttached!==undefined){if(f.options.isRootAttached===true){this.insertBefore(f,j);f.options.elementRV.show()}}else{this.insertBefore(f,j);if(UWA.is(f.options.elementRV)){f.options.elementRV.show()}}}if(UWA.is(this.setState,"function")){this.setState({state:o.expandStateBeforeFiltering})}f._removeFilterInfo();var n=o.filteredOutChildren.indexOf(f);o.filteredOutChildren.splice(n,1);if(o.filteredOutChildren.length===0){this._removeChildrenFilterInfo()}}}}}};return a});define("DS/RichView/Command/CtxMenu_EndLinkCmd",["DS/ApplicationFrame/Command","DS/RichView/Command/CreateLinkAction"],function(b,a){var c=b.extend({init:function(d){this._parent(d,{isAsynchronous:true});this._container=d.container;this.mediator=d.mediator;this.TOPIC_NAME="ENORERE_AP.StartLink";if(!a._initialized){a.init({renderTo:this._container})}},execute:function(d){var f=this;var g=sessionStorage.getItem(this.TOPIC_NAME);var h=UWA.is(g,"string")?JSON.parse(g):g;var e={from:{id:h.physicalId,type:h.type,kindof:h.kindof,path:h.path,title:h.title},to:{id:d.physicalId,type:d.type,kindof:d.kindof,path:d.path,title:d.title}};a.execute(e)}});return c});define("DS/RichView/Models/RichViewModelParser",["DS/Logger/Logger","DS/RichView/Models/RichViewModel","DS/TraceableRequirementsUtils/Utils"],function(b,e,g){var d=b.getLogger("DS/RichView/Models/RichViewModelParser"),f={},a={};var c=function(i,m){var l={resourceid:null,rootID:null,elementID:null,matrixID:null,physicalID:null,type:"",kindof:"",title:"",name:"",revision:"",content:"",externalObject:false,reqInterface:null,relationtype:"",relationid:null,relationOrder:null,parentID:"",level:0,editable:true,isDocx:false,format:"html"};for(var k in i){if(i.hasOwnProperty(k)){switch(k){case"physicalid":l.physicalID=i[k];l.resourceid=i[k];break;case"id":l.matrixID=i[k];break;case"type":if(typeof i[k]!=="Object"){l.type=i[k]}else{l.type=i[k].value}break;case"type.kindof":l.kindof=i[k];break;case"interface":if(UWA.is(i[k].name)&&i[k].name!==null){var j=[];if(i[k].name.indexOf(",")>=0){j=i[k].name.split(",")}else{j.push(i[k].name)}for(var h=0;h<j.length;h++){if(UWA.is(m)&&m.indexOf(j[h])>=0){l.externalObject=true}}l.reqInterface=j}break;case"attribute[Title]":l.title=i[k];break;case"name":l.name=i[k];break;case"revision":l.revision=i[k];break;case"physicalid[connection]":l.relationid=i[k];break;case"type[connection]":l.relationtype=i[k];break;case"attribute[TreeOrder]":l.relationOrder=parseFloat(i[k]);break;case"level":l.level=parseInt(i[k]);break;case"attribute[Content Type]":l.format=i[k];break;case"attribute[Content Data]":l.content=i[k];break;case"editable":l.editable=i[k];break;case"current.access[read]":l.editable=i[k].toLowerCase();break;case"isDocx":l.isDocx=i[k];break;case"from.physicalid[connection]":l.parentID=i[k];break}}}return l};a.process={root:function(j,i){var h=c(j.data,i);h.tenant=j.tenant;var k=new e(h);j.treedocument.addRoot(k)},createNode:function(i,h){return new e(c(i.data,h))},streaming:function(r,o){var m=r.data;var h=1;var k=[r.root_node];var j=0;for(var n=0;n<m.length;n++){var q=c(m[n],o);q.tenant=r.tenant;var p=new e(q);var l=parseInt(m[n].level);if(k.length>1){if(l===h){k[l].childComputed=true;k[l].options.children=null;k[l-1].addChild(k[l]);k[l]=p;h=l}else{if(l>h){k[l]=p;h=l}else{j=h;k[h].childComputed=true;k[h].options.children=null;while((l-1)<j){k[j-1].childComputed=true;k[j-1].addChild(k[j]);j=j-1}k[l]=p;h=l}}}else{k.push(p)}j=h;k[h].childComputed=true;k[h].options.children=null;while(0<j){k[j-1].childComputed=true;k[j-1].addChild(k[j]);j=j-1}}}};return a});define("DS/RichView/Command/DeleteLinkAction",["UWA/Class","UWA/Controls/Abstract","DS/UIKIT/Input/Button","DS/UIKIT/Badge","DS/UIKIT/SuperModal","DS/UIKIT/Scroller","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Select","DS/UIKIT/Tooltip","DS/ENOFloatingPanel/ENOFloatingPanel","UWA/Drivers/Alone","DS/Logger/Logger","DS/PlatformAPI/PlatformAPI","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/REQCommandProxy","DS/RichView/RichContentEditor","DS/RichView/RichView","DS/PADUtils/PADContext","i18n!DS/RichView/assets/nls/RichView","css!DS/RichView/RichView.css"],function(s,q,j,h,p,u,m,l,r,k,w,y,c,e,d,x,g,a,f,n,t){var z=null;var v="http://www.3ds.com/vocabularies/syc/type/Scope";var b="TRA-current-scope";var i="traceability_model";var o=s.singleton({name:"DeletLinkAction",defaultOptions:{renderTo:".main-panel",mediator:null},_superModal:null,mediator:null,context:null,container:null,_logger:null,_commandProxy:null,_initialized:false,_scopeId:null,_notifSMV:null,_widgetIdSMV:null,_onLoadingUI:false,init:function(A){z=this;this._logger=y.getLogger(o);this._logger.log("init");this._parent(A);this.mediator=A.mediator;this.context=n.get();this.defaultOptions.renderTo=A.renderTo;this.subscribeToSMVContextModification();this._commandProxy=new g();this._initialized=true;return this},_initUI:function(A){z._floatingComponent=new k({title:t.DeleteLinkAction_DeleteLinks,overlay:true,closable:false,animate:true,autocenter:true,resizable:true,events:{onResizeFloating:function(){z._logger.log("onResizeFloating")},onClose:function(){z._logger.log("onClose")}}}).inject(UWA.Element.getElement.call(document,A))},subscribeToSMVContextModification:function(){if(!UWA.is(z._notifSMV)){z._logger.log("Subscribing to topic: DS/CATSmmUI/3DExperience/Proxy/contextChanged");z._notifSMV=c.subscribe("DS/CATSmmUI/3DExperience/Proxy/contextChanged",function(A){z._onSMVContextChanged(A)})}},_onSMVContextChanged:function(B){var C=JSON.parse(localStorage.getItem(b));var A=z._formatMessage(C);if(UWA.is(A.resources)&&A.resources.length>0){var C=A.resources[0];if(UWA.is(A.types[0])&&A.types[0]===v){z._scopeId=C.id;z._widgetIdSMV=A.widgetId}else{z._scopeId=null;z._widgetIdSMV=null}}else{z._scopeId=null;z._widgetIdSMV=null}},execute:function(C){if(this._onLoadingUI){return}this._onLoadingUI=true;var B=C.physicalid;z.defaultOptions.physicalid=C.physicalid;z.defaultOptions.name=C.name;z.defaultOptions.type=C.type;var D=[];var A=[];d.expand({json:{root_physical_id:B,type_filter:["Requirement"],rel_filter:["Derived Requirement"],select_level:"1",object_selects:["type","name","revision","physicalid","type.kindof","attribute[Title]","attribute[Content Data]","attribute[Content Type]"],relationship_selects:["physicalid[connection]","attribute[TreeOrder]","type[connection]","attribute[Link Status]"],navigate_from_rel:"true",navigate_to_rel:"false",level:"1"},onComplete:function(F){var E=UWA.is(F,"string")?JSON.parse(F):F;D=E.results;d.expand({json:{root_physical_id:B,type_filter:["Requirement"],rel_filter:["Derived Requirement"],select_level:"1",object_selects:["type","name","revision","physicalid","type.kindof","attribute[Title]","attribute[Content Data]","attribute[Content Type]"],relationship_selects:["physicalid[connection]","attribute[TreeOrder]","type[connection]","attribute[Link Status]"],navigate_from_rel:"false",navigate_to_rel:"true",level:"1"},onComplete:function(H){var G=UWA.is(H,"string")?JSON.parse(H):H;A=G.results;z._buildDialog(A,D)},onFailure:function(G){},onTimeout:function(){}})},onFailure:function(E){},onTimeout:function(){}})},_buildDialog:function(A,E){var B=z.defaultOptions.type+" "+z.defaultOptions.name;var D=t.DeleteLinkAction_ToHeader;D=D.replace("{TNR}",B);var C=t.DeleteLinkAction_FromHeader;C=C.replace("{TNR}",B);z._footer=UWA.createElement("div");z._cancelButton=new j({value:t.DeleteLinkAction_Cancel,name:"cancel_button"});z._cancelButton.addEvents({onClick:function(F){z._onCancel(F)}});z._deleteButton=new j({value:t.DeleteLinkAction_Delete,name:"delete_button",className:"primary",disabled:true});z._deleteButton.addEvents({onClick:function(F){z._onDelete(F)}});z._deleteButton.inject(z._footer);z._cancelButton.inject(z._footer);z._dialogBody=UWA.createElement("div",{"class":"delete-link-dialog",id:"dlg_"+z.defaultOptions.physicalid});z._refinedSection=UWA.createElement("div",{id:"section_refined"});z._refinedSectionHeader=UWA.createElement("h4",{text:D});z._refinedSectionHeader.inject(z._refinedSection);z._coveredSection=UWA.createElement("div",{id:"section_covered"});z._coveredSectionHeader=UWA.createElement("h4",{text:C});z._coveredSectionHeader.inject(z._coveredSection);z._noRefinedLinks=UWA.createElement("h5",{"class":"no-link",text:t.DeleteLinkAction_NoLinkFound});z._noCoveredLinks=UWA.createElement("h5",{"class":"no-link",text:t.DeleteLinkAction_NoLinkFound});if(E.length>0){z._buildSection(E,z._refinedSection)}else{z._noRefinedLinks.inject(z._refinedSection)}if(A.length>0){z._buildSection(A,z._coveredSection)}else{z._noCoveredLinks.inject(z._coveredSection)}new a({mediator:z.mediator,selector:".delete-link-content",target:".content-data"}).startEditionForAll();if(A.length===0&&E.length===0){z._deleteButton.disable()}z._refinedSection.inject(z._dialogBody);z._coveredSection.inject(z._dialogBody);z._floatingComponent=new k({className:"DeleteLinkModal",title:t.DeleteLinkAction_DeleteLinks,body:z._dialogBody,footer:z._footer,overlay:true,closable:true,animate:true,autocenter:true,resizable:true,events:{onResizeFloating:function(){z._logger.log("onResizeFloating")},onClose:function(){z._logger.log("onClose");z._onCancel(z._floatingComponent)}}}).inject(UWA.Element.getElement.call(document,z.defaultOptions.renderTo));z._floatingComponent.show();new u({element:UWA.Element.getElement.call(z._floatingComponent.getBody(),".delete-link-dialog")})},_buildSection:function(O,N){for(var E=0;E<O.length;E++){var I=O[E];var M=null;var A=false;if(this.context.options.model.getNodesById(I.physicalid).length!=0){A=UWA.is(this.context)?this.context.options.model.getNodesById(I.physicalid)[0].options.externalObject:false}if(widget&&widget.displayNameSettings){var Q=widget.displayNameSettings[I.type]||widget.displayNameSettings[I["type.kindof"]];if(UWA.is(Q)){M=x.computeDisplayName({name:I.name,title:I["attribute[Title]"],revision:I.revision},Q);M=z._decodeHtml(M)}}if(!UWA.is(M)){M=I["attribute[Title]"];M=z._decodeHtml(M)}var D=I["attribute[Link Status]"];if(I.physicalid!==z.defaultOptions.physicalid){var P=UWA.createElement("div",{"class":"delete-link-object",id:I["physicalid[connection]"]+"_rel","data-physicalid":I.physicalid});var G=UWA.createElement("div",{id:I["physicalid[connection]"]+"_toggle"});var L=UWA.createElement("div",{"class":"delete-link-content"});var J=UWA.createElement("div",{"class":"delete-link-data"});var H="";if(I.type.value==="Requirement Proxy"){H=t.ExternalObject_DisplayContent}else{H=z._decodeHtml(I["attribute[Content Data]"])}var C=UWA.createElement("div",{"class":"content-data",id:I["physicalid[connection]"]+"_data","data-physicalid":I.physicalid,contenteditable:false,html:H});if(I.type.value==="Requirement Proxy"){C.addEventListener("click",function(R){z._getProxyContentData(this,R)})}var F=new m({type:"checkbox",value:I["physicalid[connection]"],label:M,checked:false});F.addEvents({onClick:function(T){var S=jQuery("input:checkbox:checked",z._floatingComponent.elements.content);var R=S.closest(".delete-link-object");if(R.length==0){z._deleteButton.setDisabled(true)}else{z._deleteButton.setDisabled(false)}}});C.inject(J);J.inject(L);F.inject(G);G.inject(P);L.inject(P);var B;switch(D){case"Invalid":B="error";break;case"Suspect":B="warning";break;case"Valid":B="success";break}var K=new h({id:I["physicalid[connection]"]+"_statusLabel",content:D,className:"linkStatus "+B,selectable:true});new r({target:K.getContent(),body:"Click here to update the status",position:"top"});K.addEvents({onClick:function(R){var U;var T;U=R.target.id;T=R.target.parentElement.parentElement.id;if(U==""||U=="undefined"||U=="null"){U=R.target.parentElement.id.split("_")[0];T=R.target.parentElement.parentElement.parentElement.id.split("_")[0]}var S=jQuery("#"+U+"_statusLabel").find(".badge-content").text().trim();z._updateUIElem(U,T,F,S)}});P.inject(N);if(!A){jQuery(F.getContent()).find(".control-label").prepend('<span class="trm-icon trm-icon-requirement"></span>')}else{jQuery(F.getContent()).find(".control-label").prepend('<span class="trm-icon trm-icon-requirement-proxy"></span>')}jQuery(F.getContent()).append(K.getContent())}}},_updateUIElem:function(F,E,B,D){jQuery("#"+F+"_statusLabel").hide();var C=E+"_statusComboBox";var A=new l({placeholder:false,className:"linkStatus small",id:C});z._getRelationshipStatus(C,A,D);jQuery("#"+E+"_toggle").find(".toggle.toggle-root").append(A.getContent());jQuery("#"+E+"_statusComboBox").focus();jQuery("#"+E+"_statusComboBox").focusout(function(){jQuery("#"+F+"_statusLabel").show();jQuery("#"+F+"_toggle").find(".toggle.toggle-root").find(".select").remove()})},_getRelationshipStatus:function(B,A,D){var E=B.split("_")[0];var C;d.getRelStatusValues({pid:E,json:{operation:[{markup:"getRange",object:[{objectId:null,relId:null,parentId:null,attributeName:"Link Status",objectName:null,objectType:null}]}]},onComplete:function(G){var H=JSON.parse(G);var F=H.operation[0].results;jQuery.each(F,function(I,J){var K=J.split("|");if(D==K[0]){A.add({value:K[0],label:K[1],selected:true})}else{A.add({value:K[0],label:K[1]})}});A.addEvents({onChange:function(J){var I=J.target.value;var K=J.target.id;z._updateLinkStatus(K,I)}})}.bind(this),onFailure:function(G,F){}})},_updateLinkStatus:function(B,A){var C=B.split("_")[0];d.editRelationAttributes({pid:C,json:{attributes:[{name:"Link Status",value:A}]},onComplete:function(D){jQuery("#"+C+"_toggle").find(".toggle.toggle-root").find(".select").remove();jQuery("#"+C+"_statusLabel").find(".badge-content").text(A);jQuery("#"+C+"_statusLabel").show();z._updateBackGroundColor(C)},onFailure:function(E,D){}})},_updateBackGroundColor:function(D){var B=jQuery("#"+D+"_statusLabel");var C=B.find(".badge-content");var A=C.text().trim();switch(A){case"Invalid":B.removeClass("badge-warning badge-error badge-success");B.addClass("badge-error");break;case"Suspect":B.removeClass("badge-warning badge-error badge-success");B.addClass("badge-warning");break;case"Valid":B.removeClass("badge-warning badge-error badge-success");B.addClass("badge-success");break}},_onCancel:function(){z._onLoadingUI=false;this._onLoadingUI=false;z._logger.log("onCancel");z._floatingComponent.hide();z._floatingComponent.destroy()},_onDelete:function(){z._onLoadingUI=false;this._onLoadingUI=false;z._logger.log("onDelete");var D=jQuery("input:checkbox:checked",z._floatingComponent.elements.content);var C=D.closest(".delete-link-object");var B=[];for(var A=0;A<C.length;A++){B.push(C[A].parentElement)}z._floatingComponent.hide();z._floatingComponent.destroy();z._deleteLink(D,C,B)},_deleteLink:function(F,D,B){z._logger.log("_deleteLink");var G=[];var E=[],A=[];for(var C=0;C<F.length;C++){G.push(F[C].value);if((B[C].id).indexOf("refined")!=-1){E.push(D[C].dataset.physicalid)}else{if((B[C].id).indexOf("covered")!=-1){A.push(D[C].dataset.physicalid)}}}d.detach({securityContext:x.getSecurityContext(),json:{relationship_physical_ids:G},onComplete:function(H){z._displayNotification({className:"success",message:t.DeleteLinkAction_Success});var H={selected_id:z.defaultOptions.physicalid,refined_ids:E,covered_ids:A,connectionId:G,widgetid:widget.id,contextId:x.getSecurityContext()};z._commandProxy.traceabilityAuthoring({data:H,appId:widget.getValue("appId"),event:"delete"});if(UWA.is(z._scopeId)){setTimeout(function(){z._logger.log("Publish topic DS/CATSmmUI/3DExperience/Proxy/refresh");c.publish("DS/CATSmmUI/3DExperience/Proxy/refresh",{resources:[z._scopeId+"/"+i],widgetId:z._widgetIdSMV,clearCache:true})},500)}},onFailure:function(H){z._displayNotification({className:"error",message:H})},onTimeout:function(){}})},_decodeHtml:function(B){var A=document.createElement("textarea");A.innerHTML=B;return A.value},_displayNotification:function(A){if(UWA.is(z.context)&&UWA.is(z.context.displayNotification)){z.context.displayNotification({eventID:A.className,msg:A.message})}else{alert(A.message)}},_getProxyContentData:function(C,D){var B=this;var A=this.context.OSLCProviders;d.getInfo({securityContext:x.getSecurityContext(),pid:C.attributes["data-physicalid"].value,onComplete:function(F){F=UWA.is(F,"string")?JSON.parse(F):F;var J=F.results[0];var K=J["ProxyItem.Proxy_Service"];var H=J["ProxyItem.Proxy_URL"];var G="",E="";if(UWA.is(A)){for(var I=0;I<A.repositories.length;I++){if(K===A.repositories[I].id){G=A.repositories[I].rootUrl;E=A.repositories[I].oauth}break}d.getOSLCContent({service:K,doors_url:G+H,tenant:x.getTenant(),Oauth:E,method:"GET",onComplete:function(M){var L=D.target;var M=jQuery(jQuery.parseXML(M));var P=M[0].getElementsByTagNameNS(M[0].lookupNamespaceURI("jazz_rm"),"primaryText");if(P[0].childNodes[0].childNodes.length>0){var N=P[0].childNodes[0].childNodes;var Q="";for(var O=0;O<N.length;O++){if(UWA.is(N[O].innerText)){Q+=" "+N[O].innerText}}L.innerText=Q}else{P=M[0].getElementsByTagName("dcterms:description");L.innerText=P[0].innerHTML}console.log(M)},onFailure:function(L){B._logger.log(L)}})}},onFailure:function(E){B._logger.log(E)},onTimeout:function(){B._logger.log("RequirementWebServices.getInfo timed out")}})},});return o});define("DS/RichView/Service/ContextualMenu",["UWA/Core","UWA/Class","DS/Logger/Logger","DS/UIKIT/Input/Button","DS/ApplicationFrame/CommandsManager","DS/WebappsUtils/WebappsUtils","DS/TraceableRequirementsUtils/Utils","DS/PADUtils/PADContext","DS/RichView/Command/CtxMenu_StartLinkCmd","DS/RichView/Command/CtxMenu_EndLinkCmd","DS/RichView/Command/DeleteLinkAction","i18n!DS/RichView/assets/nls/RichView"],function(l,c,d,i,a,f,e,k,m,h,b,j){var g=null;var n=c.extend({model:null,_logger:undefined,mediator:null,init:function(o){g=this;this.model=o.model;this._logger=d.getLogger(n);this.menu_container=o.container;this.menu_id=o.id+"_menu";this.kindof=o.kindof;this.mediator=o.mediator;this.type=o.type;this.externalProviders=o.externalProviders;if(UWA.is(o.externalObject)){this.externalObject=o.externalObject}else{this.externalObject=false}this._initTraceabilityCmd()},_initTraceabilityCmd:function(){this.StartLinkCmd=new m({ID:"StartLink_ctx"});this.EndLinkCmd=new h({ID:"EndLink_ctx",container:".content-panel"});if(!b._initialized){b.init({renderTo:".main-panel",mediator:g.mediator})}},inject:function(){var t=this.menu_container;var q=this.menu_id;var r=this._getContextualMenu(this.kindof);var s=this._callbacks(r);var p={value:"",dropdownCaret:false,removeOnHide:true,id:q,className:"link",icon:"fonticon fonticon-menu-dot",dropdown:{className:"richview-menu",items:r,events:{onClick:function(y,x){var w=k.get().getSelectedNodes();var v=w[0];var u=v.getRichViewElement();var z=s[x.name];if(z){z.call(null,u)}}}},events:{onClick:function(x){var y;if(UWA.is(this.elements.container.closest)){y=this.elements.container.closest(".rich-object,.rich-container").id}else{var w=function(A,B,z,E,D){var C=A.parentNode;while(C.className!=B&&C.className!=z&&C.className!=E&&C.className!=D){C=C.parentNode}return C.id};y=w(this.elements.container,"rich-object  right-border","rich-container  right-border","rich-container ","rich-container")}var v=g.model.getNodesByElementID(y)[0];var u=v.getRichViewElement();if(!u.container.hasClass("active")){u.info.click();if(o.dropdown.isVisible===false){o.dropdown.show()}}}}};var o=new i(p).inject(t)},_getContextualMenu:function(o){var p=[];switch(o){case"Requirement":if(this.externalObject){p=this._getExternalRequirementMenu()}else{p=this._getRequirementMenu()}break;case"Comment":p=this._getCommentMenu();break;case"Chapter":p=this._getChapterMenu();break;default:p=this._getDefaultMenu();break}return p},_getRequirementMenu:function(){var o=[];o.push({name:"addChapter",text:j.AddChapter,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewChapter.png"),data:"",callback:this._addChapterCommand.bind(this)});o.push({name:"addRequirement",text:j.AddRequirement,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewRequirement.png"),data:"",callback:this._addRequirementCommand.bind(this)});o.push({name:"addComment",text:j.AddComment,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewComment.png"),data:"",callback:this._addCommentCommand.bind(this)});o.push({className:"divider"});o.push({name:"insertRequirement",text:j.InsertRequirement,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),data:"",callback:this._insertRequirementCommand.bind(this)});if(this.externalProviders){o.push({text:j.InsertNewExtReq,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),items:[{name:"CreateExternalSubRequirement",text:j.ExternalSubReq,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),callback:this._createExternalSubRequirementCommand.bind(this)},{name:"CreateExternalDerRequirement",text:j.ExternalDerivedReq,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),callback:this._createExternalDerRequirementCommand.bind(this)}]})}o.push({name:"insertExistingRequirement",text:j.InsertExistingRequirement,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertExisting.png"),data:"",callback:this._insertInsertExistingCommand.bind(this)});if(this.externalProviders){o.push({text:j.InsertExistExtReq,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),items:[{name:"insertExternalSubRequirement",text:j.ExternalSubReq,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),callback:this._insertExternalSubRequirementCommand.bind(this)},{name:"InsertExternalDerRequirement",text:j.ExternalDerivedReq,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),callback:this._insertExternalDerRequirementCommand.bind(this)}]})}o.push({className:"divider"});o.push({name:"startLink",text:j.RichView_Cmd_StartLink,icon:f.getWebappsAssetUrl("RichView","icons/32/DerivedRequirementStartLink.png"),data:"",callback:this._startLink.bind(this)});o.push({name:"endLink",text:j.RichView_Cmd_EndLink,icon:f.getWebappsAssetUrl("RichView","icons/32/DerivedRequirementEndLink.png"),data:"",callback:this._endLink.bind(this)});o.push({name:"linkManagement",text:j.RichView_Cmd_DeleteLink,icon:"",data:"",callback:this._linkManagement.bind(this)});o.push({className:"divider"});o=o.concat(this._getDefaultMenu());return o},_getExternalRequirementMenu:function(){var o=this._getDefaultMenu();o.push({name:"addRequirement",text:j.AddRequirement,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewRequirement.png"),data:"",callback:this._addRequirementCommand.bind(this)});return o},_getCommentMenu:function(){var o=[];o.push({name:"addChapter",text:j.AddChapter,data:"",icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewChapter.png"),callback:this._addChapterCommand.bind(this)});o.push({name:"addRequirement",text:j.AddRequirement,data:"",icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewRequirement.png"),callback:this._addRequirementCommand.bind(this)});o.push({name:"addComment",text:j.AddComment,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewComment.png"),data:"",callback:this._addCommentCommand.bind(this)});o.push({className:"divider"});o=o.concat(this._getDefaultMenu());return o},_getChapterMenu:function(){var o=[];o.push({name:"addChapter",text:j.AddChapter,data:"",icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewChapter.png"),callback:this._addChapterCommand.bind(this)});o.push({name:"addRequirement",text:j.AddRequirement,data:"",icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewRequirement.png"),callback:this._addRequirementCommand.bind(this)});o.push({name:"addComment",text:j.AddComment,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewComment.png"),data:"",callback:this._addCommentCommand.bind(this)});o.push({className:"divider"});o.push({name:"insertChapter",text:j.InsertChapter,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubChapter.png"),data:"",callback:this._insertChapterCommand.bind(this)});o.push({name:"insertRequirement",text:j.InsertRequirement,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),data:"",callback:this._insertRequirementCommand.bind(this)});o.push({name:"insertComment",text:j.InsertComment,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubComment.png"),data:"",callback:this._insertCommentCommand.bind(this)});o.push({name:"insertExisting",text:j.InsertExisting,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertExistingObject.png"),data:"",callback:this._insertInsertExistingCommand.bind(this)});o.push({className:"divider"});o=o.concat(this._getDefaultMenu());return o},_getDefaultMenu:function(){var o=[];o.push({name:"detach",text:j.RichView_Cmd_Detach,icon:f.getWebappsAssetUrl("RichView","icons/32/iconReqCmdDetach.png"),data:"",callback:this._detach.bind(this)});o.push({name:"properties",text:j.RichView_Cmd_Properties,icon:f.getWebappsAssetUrl("RichView","icons/32/I_CATSSEditorDisplayProperties.png"),data:"",callback:this._editProperties.bind(this)});return o},_addRequirementCommand:function(){this._launchAction({command:"AddNewRequirement"})},_addChapterCommand:function(){this._launchAction({command:"AddNewChapter"})},_addCommentCommand:function(){this._launchAction({command:"AddNewComment"})},_insertRequirementCommand:function(){this._logger.log("_insertRequirement");this._launchAction({command:"InsertRequirement"})},_insertChapterCommand:function(){this._logger.log("_insertRequirement");this._launchAction({command:"InsertChapter"})},_insertCommentCommand:function(){this._logger.log("_insertComment");this._launchAction({command:"InsertComment"})},_insertInsertExistingCommand:function(){this._logger.log("_insertInsertExistingCommand");this._launchAction({command:"InsertExisting"})},_insertExternalSubRequirementCommand:function(){this._logger.log("_insertExternalRequirement");this._launchAction({command:"InsertExternalSubRequirement"})},_insertExternalDerRequirementCommand:function(){this._logger.log("_insertExternalRequirement");this._launchAction({command:"InsertExternalDerRequirement"})},_createExternalSubRequirementCommand:function(){this._logger.log("_insertExternalRequirement");this._launchAction({command:"CreateExternalSubRequirement"})},_createExternalDerRequirementCommand:function(){this._logger.log("_insertExternalRequirement");this._launchAction({command:"CreateExternalDerRequirement"})},_startLink:function(o){this._logger.log("_startLink");var p=g.model.getNodesByElementID(o.id)[0];var r=p.getOccurencePath();var q={id:o.objectId,physicalId:o.physicalId,type:o.type,kindof:o.kindof,path:r,title:o.title};this.StartLinkCmd.execute(q)},_endLink:function(o){this._logger.log("_endLink");var p=g.model.getNodesByElementID(o.id)[0];var r=p.getOccurencePath();var q={id:o.objectId,physicalId:o.physicalId,type:o.type,kindof:o.kindof,path:r,title:o.title};this.EndLinkCmd.execute(q)},_linkManagement:function(o){this._logger.log("_linkManagement");b.execute({physicalid:o.physicalId,name:o.title,type:o.type})},_editProperties:function(){this._logger.log("_editProperties");this._launchAction({command:"ActionBar_Attributes"})},_detach:function(){this._logger.log("_detach");this._launchAction({command:"Detach"})},_launchAction:function(p){this._logger.log("_launchAction");var o=a.getCommand(p.command);if(o){o.begin()}},_callbacks:function(s){var r={};for(var p=0;p<s.length;p++){var q=s[p];r[q.name]=q.callback;if(UWA.is(q.items)){for(var o=0;o<q.items.length;o++){var t=q.items[o];r[t.name]=t.callback}}}return r}});return n});define("DS/RichView/Views/RichContainer",["UWA/Core","UWA/Class","UWA/Class/Events","UWA/Class/Listener","UWA/Class/Options","DS/Logger/Logger","DS/UIKIT/Input/Button","DS/UIKIT/Popover","DS/UIKIT/Tooltip","DS/UIKIT/Mask","DS/RichView/Service/ContextualMenu","DS/RichView/mixins/_dndUtilities","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/jQueryUI","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/Services/RequirementWebServices","i18n!DS/RichView/assets/nls/RichView","css!DS/RichView/RichView.css"],function(a,q,j,d,o,u,i,r,p,w,k,g,h,m,c,b,s){var l=false||!!document.documentMode||/Edge\/\d./i.test(navigator.userAgent);var e=!l&&!!window.StyleMedia;var t=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0;var n=6;var v={container:function(x){return h('<div id="'+x.id+'" class="rich-container '+x.className+'" draggable="true" data-objectid="'+x.objectId+'" data-level="'+x.level+'" data-physicalid="'+x.physicalId+'" data-relid="'+x.connectionId+'"></div>')},info:function(){return h('<span class="rich-container-info"></span>')},header:function(x){return h('<span class="rich-container-title header-size-'+x.size+'"><span class="rich-container-title-index"> '+x.index+' - </span><span><div id="'+x.id+'_content" class="rich-container-title-editable" contenteditable="'+x.editable+'">'+x.title+"</div></span></span>")},menu:function(){return h('<span class="collapsable-container"><span class="fonticon fonticon-minus-squared site-icon"></span></span>')},menu_context:function(){return h('<span class="rich-container-menu"></span>')}};var f=q.extend(j,d,o,g,{defaultOptions:{model:null,node:null,rootId:null,mediator:null,id:null,objectId:null,physicalId:null,type:"",kindof:"",title:"",index:"",connection:"",connectionId:null,level:0,editable:"true",defaultType:"Requirement",placeholder:false,droppable:null,context:null,bi_color:null},model:null,node:null,id:null,objectId:null,parentId:null,physicalId:null,connection:null,connectionId:null,level:null,index:null,title:null,container:null,info:null,header:null,menu:null,menu_context:null,type:null,kindof:null,context:null,mediator:null,init:function(x){var A=this;this._logger=u.getLogger(f);this._logger.log("init");UWA.merge(x||{},this.defaultOptions);this.options=x;this.model=this.options.model;this.node=this.options.node;this.id=this.options.id;this.objectId=this.options.objectId;this.parentId=this.options.parentId;this.physicalId=this.options.physicalId;this.connection=this.options.connection;this.connectionId=this.options.connectionId;this.level=this.options.level;this.index=this.options.index;this.title=this.options.title;this.type=this.options.type;this.kindof=this.options.kindof;this.context=this.options.context;this.mediator=this.options.mediator;this.container=v.container({id:this.options.id,objectId:this.options.objectId,physicalId:this.options.physicalId,connectionId:this.options.connectionId,level:this.options.level,className:this.options.placeholder===true?"placeholder":""}),this.info=v.info(),this.header=v.header({size:this.options.level>n?n:this.options.level,index:this.options.index,title:this.options.title,editable:this.options.editable,id:this.options.id}),this.menu=v.menu(),this.menu_context=v.menu_context();this.container.append(this.info).append(this.menu).append(this.menu_context).append(this.header);this._lowerMatchUpper={};var z=Object.keys(this.options.droppable);z.forEach(function(C){if(UWA.is(widget.getPreference("trm_types_"+C))){var B=widget.getPreference("trm_types_"+C).options;B.forEach(function(D){if(h.inArray(D.value,z)===-1){z.push(D.value)}})}});for(var y=0;y<z.length;y++){this._lowerMatchUpper[z[y].toLowerCase()]=z[y]}this._menu_context_attached=false},_subscribeToStopDnD:function(){var x=this;this.mediator.subscribe("onStopDnd",function(y){x._isDnD=false;x._notDroppable();x._notDraggable()})},_subscribeToStartDnD:function(){var x=this;this.mediator.subscribe("onStartDnd",function(y){x._isDnD=true;x._droppable();x._draggable()})},_subscribeToOnScroll:function(){var x=this;this.mediator.subscribe("onScroll",function(y){x._scroll(y)})},create:function(){var x=this;if(this.options.placeholder===true){return this}if(this.options.fake===true){this.menu_context.remove()}else{this.node.setRichViewElementID(this.id);this.node.setRichViewElement(this)}this._dragging=false;this._isDnD=false;this._dropPosition="";this._draggingY=null;this._subscribeToStopDnD();this._subscribeToStartDnD();this._subscribeToOnScroll();return this},update:function(D,C){var B=this;var A=Object.keys(D);for(var y=0;y<A.length;y++){switch(A[y]){case"bi_color":if(UWA.is(D.bi_color)&&D.bi_color!==""){B.options.bi_color=D.bi_color;B.info.css("border-left-color",D.bi_color)}else{B.options.bi_color=null;if(B.info.attr("style")){B.info.removeAttr("style")}}break;case"level":var x=B.options.level>n?n:B.options.level;B.options.level=D.level;B.level=B.options.level;B.container.data("level",B.options.level);B.container[0].dataset.level=B.options.level;var z=B.options.level>n?n:B.options.level;B.header.removeClass("header-size-"+x);B.header.addClass("header-size-"+z);break;case"index":B.options.index=D.index;B.index=B.options.index;B.header.find(".rich-container-title-index").text(B.options.index+" - ");break;case"title":if(B.options.title!==D.title){B.options.title=D.title;B.title=B.options.title;B.context.updateRichContent({content:B.title,element:B.header.find(".rich-container-title-editable"),editable:B.options.editable});B.mediator.publish("onRefresh")}break;case"connectionId":B.options.connectionId=D.connectionId;B.connectionId=B.options.connectionId;B.container.data("relid",B.options.connectionId);B.container[0].dataset.relid=B.options.connectionId;break;case"parentId":B.options.parentId=D.parentId;B.parentId=B.options.parentId;break;case"connection":B.options.connection=D.connection;B.connection=B.options.connection;break;default:break}}},refresh:function(z){var y=this;var z=z||[];for(var x=0;x<z.length;x++){switch(z[x]){case"title":y.context.updateRichContent({content:y.title,element:y.header.find(".rich-container-title-editable"),editable:y.options.editable});break;default:break}}},_scroll:function(z){var y=this;var x=this.isVisible(z.position);if(x&&this._menu_context_attached===false){this._menu_context_attached=true;this._menu_context()}if(x){if(this._isDnD){return true}this._isDnD=true;this._droppable();this._draggable()}else{this._isDnD=false;this._notDroppable();this._notDraggable()}},_menu_context:function(){var x=new k({model:this.model,container:this.menu_context[0],id:this.id,kindof:this.kindof}).inject()},hide:function(){this.container.hide()},show:function(){this.container.show()},_draggable:function(){var x=this;var y=false;this.container.on("mousedown ",function(z){y=h(z.target)});this.container.on("dragstart",function(z){x._dragging=true;x._draggingY=z.originalEvent.clientY;if(y.hasClass("rich-container-info")){h(this).addClass("being-dragged");z.originalEvent.dataTransfer.dropEffect="move";var G=l?"text":"text/searchitems";var A=widget.getUrl();A=A.substr(0,A.indexOf("/webapps"));var H=A.substr(A.lastIndexOf("/")+1);var B=x.model.getNodesByElementID(x.id)[0];var D=B.getOccurencePath();if(false===B.isSelected()&&this.hasOwnProperty("hasClassName")&&false===this.hasClassName("active")){x.context._selectionMgt(x.info,".rich-container")}var C={protocol:"3DXContent",version:"1.1",source:widget.getValue("appId"),data:{items:[{envId:c.getTenant(),serviceId:H,contextId:c.getSecurityContext(),objectId:x.physicalId,objectType:x.type,displayName:x.title,kindof:x.kindof,path:D}]}};if(l){var F={"0":this.id,"1":x.options.title,"2":x.options.type,"3":x.options.kindof,"4":widget.id,protocol:"3DXContent",version:"1.1",source:widget.getValue("appId"),data:{items:[{envId:c.getTenant(),serviceId:H,contextId:c.getSecurityContext(),objectId:x.physicalId,objectType:x.type,displayName:x.title,kindof:x.kindof,path:D}]}};z.originalEvent.dataTransfer.setData("text",JSON.stringify(F))}else{var E=h(".fancytree-icon.fonticon-book")[0];z.originalEvent.dataTransfer.setDragImage(E,-10,-10);z.originalEvent.dataTransfer.setData("0_"+this.id,"");z.originalEvent.dataTransfer.setData("1_"+x.options.title,"");z.originalEvent.dataTransfer.setData("2_"+x.options.type,"");z.originalEvent.dataTransfer.setData("3_"+x.options.kindof,"");z.originalEvent.dataTransfer.setData("4_"+widget.id,"");z.originalEvent.dataTransfer.setData(G,JSON.stringify(C))}}else{z.preventDefault()}});this.container.on("dragend",function(z){x._dragging=false;x._draggingY=null;h(this).removeClass("being-dragged");x.cleanupHighlight(h(this))})},_notDraggable:function(){var x=this;this.container.off("mousedown");this.container.off("dragstart");this.container.off("dragend")},_droppable:function(){var y=this;var x=0;this.container.on("dragenter",function(z){if(z.stopPropagation){z.stopPropagation()}if(z.preventDefault){z.preventDefault()}if(y.isDroppable(z)===false){return false}x++});this.container.on("dragover",function(z){var J=y.isDroppable(z);if(h.inArray("text/html",z.originalEvent.dataTransfer.types)!==-1){z.originalEvent.dataTransfer.dropEffect="copy"}if(J===false){return false}var H=h(this);if(y._draggingY==null){y._draggingY=z.originalEvent.clientY}var C=z.originalEvent.clientY-y._draggingY;if(C>0){var A=H.next()[0];if(UWA.is(A)){var G=A.getAttribute("id");var D=y.context.options.model.getNodesByElementID(G)[0];if(D!=null&&D.getRichViewElement()!=null){if(!D.getRichViewElement().isVisible()){y.context.scroller.scrollToElement("#"+G,"center")}else{var E=y.context.contentPanel.height()-y.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight,L=D.getRichViewElement().container.height();var F=36+D.getRichViewElement().container.offset().top-y.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight;if(F>E){y.context.scroller.scrollToElement("#"+G,"center")}}}}}else{if(C<0){var K=H.prev()[0];if(UWA.is(K)){var I=K.getAttribute("id");var B=y.context.options.model.getNodesByElementID(I)[0];if(B!=null&&B.getRichViewElement()!=null){if(!B.getRichViewElement().isVisible()){y.context.scroller.scrollToElement("#"+I,"center")}else{var F=B.getRichViewElement().container.offset().top-y.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight;if((F-20)<0){y.context.scroller.scrollToElement("#"+I,"center")}}}}}}y._draggingY=z.originalEvent.clientY;if(!H.hasClass("rich-container")){H=H.parents(".rich-container:first")}if(!H.hasClass("rich-container")){return}y._dropPosition=y.updateHighlight(z.originalEvent.clientY,H,J);return false});this.container.on("dragleave",function(z){if(y.isDroppable(z)===false){return false}x--;if(x===0){var A=h(this);if(!A.hasClass("rich-container")){A=A.parents(".rich-container:first")}if(!A.hasClass("rich-container")){return}y.cleanupHighlight(A)}});this.container.on("drop",function(M){M.preventDefault();var R=h(this);y.cleanupHighlight(R);if(!y._dropPosition){return}if(l){var P=y.handleDataTransferInIE(M.originalEvent);if(UWA.is(P)){if(UWA.is(P.protocol)&&P.protocol==="3DXContent"){if(P["4"]!==widget.id){y.process3DXContentData(P,R);return}}}else{if(UWA.is(M.originalEvent.dataTransfer.getData("text"),"string")){var z=y.options.defaultType;if(UWA.is(widget.getValue("trm_types_"+y.options.defaultType.replace(" ","_")))&&widget.getValue("trm_types_"+y.options.defaultType.replace(" ","_"))!==""){z=widget.getValue("trm_types_"+y.options.defaultType)}y.mediator.publish("onInsert",{target:{element:R,id:R.attr("id")},position:y._dropPosition,operation:"insertNew",type:z,kindof:y.options.defaultType,parentId:y.objectId,content:M.originalEvent.dataTransfer.getData("text"),contentType:"html"})}}}else{var N=false;if(UWA.is(M.originalEvent.dataTransfer.types[0],"string")){var A=y.extractFromDataTransfer(M.originalEvent.dataTransfer.types[0]);var J=y.model.getNodesByElementID(A);if(J.length>0){N=true}}if(h.inArray("text/searchitems",M.originalEvent.dataTransfer.types)!==-1&&N===false){var E="text/searchitems";var L=M.originalEvent.dataTransfer.getData(E);var Q=JSON.parse(L);y.process3DXContentData(Q,R);return}else{if(e&&h.inArray("text/html",M.originalEvent.dataTransfer.types)!==-1&&N===false){var z=y.options.defaultType;if(UWA.is(widget.getValue("trm_types_"+y.options.defaultType.replace(" ","_")))&&widget.getValue("trm_types_"+y.options.defaultType.replace(" ","_"))!==""){z=widget.getValue("trm_types_"+y.options.defaultType)}var I=M.originalEvent.dataTransfer.getData("text/html");if(I.indexOf("<!--StartFragment-->")>-1&&I.indexOf("<!--EndFragment-->")>-1){var F=I.indexOf("<!--StartFragment-->")+20;var B=I.indexOf("<!--EndFragment-->");var G=I.slice(F,B);y.mediator.publish("onInsert",{target:{element:R,id:R.attr("id")},position:y._dropPosition,operation:"insertNew",type:z,kindof:y.options.defaultType,parentId:y.objectId,content:G,contentType:"html"})}else{y.mediator.publish("onInsert",{target:{element:R,id:R.attr("id")},position:y._dropPosition,operation:"insertNew",type:z,kindof:y.options.defaultType,parentId:y.objectId,content:M.originalEvent.dataTransfer.getData("text/html"),contentType:"html"})}return}else{if(h.inArray("text/html",M.originalEvent.dataTransfer.types)!==-1&&N===false){var z=y.options.defaultType;if(UWA.is(widget.getValue("trm_types_"+y.options.defaultType.replace(" ","_")))&&widget.getValue("trm_types_"+y.options.defaultType.replace(" ","_"))!==""){z=widget.getValue("trm_types_"+y.options.defaultType)}y.mediator.publish("onInsert",{target:{element:R,id:R.attr("id")},position:y._dropPosition,operation:"insertNew",type:z,kindof:y.options.defaultType,parentId:y.objectId,content:M.originalEvent.dataTransfer.getData("text/html"),contentType:"html"});return}}}}var H=undefined,K=undefined,S=undefined,C=undefined,D=undefined;if(l){var O=y.handleDataTransferInIE(M.originalEvent);if(!UWA.is(O)){return}H=O["0"];K=h("#"+H);S=O["1"];C=O["2"];D=O["3"]}else{H=y.extractFromDataTransfer(M.originalEvent.dataTransfer.types[0]),K=h("#"+H),S=y.extractFromDataTransfer(M.originalEvent.dataTransfer.types[1]),C=y._lowerMatchUpper[y.extractFromDataTransfer(M.originalEvent.dataTransfer.types[2])],D=y._lowerMatchUpper[y.extractFromDataTransfer(M.originalEvent.dataTransfer.types[3])]}y.mediator.publish("onReorder",{source:{element:K,id:H},target:{element:R,id:y.options.id},position:y._dropPosition,type:"rich-container"})})},_notDroppable:function(){var x=this;this.container.off("drop");this.container.off("dragenter");this.container.off("dragover");this.container.off("dragleave")}});return f});define("DS/RichView/Views/RichObject",["UWA/Core","UWA/Class","UWA/Class/Events","UWA/Class/Listener","UWA/Class/Options","DS/Logger/Logger","DS/PlatformAPI/PlatformAPI","DS/UIKIT/Input/Button","DS/UIKIT/Popover","DS/UIKIT/Tooltip","DS/UIKIT/Mask","DS/UIKIT/Scroller","DS/RichView/Service/ContextualMenu","DS/RichView/Command/CtxMenu_StartLinkCmd","DS/RichView/Command/CtxMenu_EndLinkCmd","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/jQueryUI","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/Services/RequirementWebServices","i18n!DS/RichView/assets/nls/RichView","i18n!DS/RichEditor/assets/nls/RichEditor","css!DS/RichView/RichView.css"],function(a,r,j,f,n,x,d,i,t,q,z,v,k,p,u,h,m,c,b,s,o){var l=false||!!document.documentMode||/Edge\/\d./i.test(navigator.userAgent);var g=!l&&!!window.StyleMedia;var w=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0;var y={container:function(B){var A=" right-border";if(w){A=""}return h('<div id="'+B.id+'" draggable="true" data-objectid="'+B.objectId+'" data-level="'+B.level+'" data-physicalid="'+B.physicalId+'" data-relid="'+B.connectionId+'" class="rich-object '+B.className+A+'"></div>')},info:function(){return h('<div class="rich-object-info"></div>')},content:function(A){return h('<div class="rich-object-content">	<div id="'+A.id+'_content" contenteditable="'+A.editable+'" class="content-data">'+A.content+"</div></div>")},menu:function(){return h('<span class="rich-object-menu"></span>')},header:function(A){return h('<div id="'+A.id+'_header" class="rich-object-header"></div>')},header_content:function(B){var A="<span>";if(UWA.is(B.externalObject)&&B.externalObject){B.icon="requirement-proxy"}if(B.connection==="Sub Requirement"){A+='<span class="rich-object-container-index"> '+B.containerIdx+' - </span><span class="rich-object-index"> '+B.index+'  </span><span class="fonticon fonticon-level-down"></span><span class="object-link"><span class="trm-icon trm-icon-'+B.icon+'"></span> <span><div id="'+B.id+'_title_content" class="rich-object-title-editable" contenteditable="'+B.editable+'">'+B.title+"</div></span></span></span></span>"}else{A+='<span class="rich-object-container-index"> '+B.containerIdx+' - </span><span class="rich-object-index"> '+B.index+'  </span><span class="object-link"><span class="trm-icon trm-icon-'+B.icon+'"></span> <span><div id="'+B.id+'_title_content" class="rich-object-title-editable" contenteditable="'+B.editable+'">'+B.title+"</div></span></span></span></span>"}return h(A)},body:function(){return h('<div class="rich-object-body"></div>')}};var e=r.extend(j,f,n,{defaultOptions:{model:null,node:null,rootId:null,mediator:null,id:null,objectId:null,physicalId:null,type:"",kindof:"",title:"",containerIdx:"",index:"",content:"",connection:"",connectionId:null,parentId:null,level:0,editable:"true",droppable:null,placeholder:false,defaultType:"Requirement",fetchContent:false,context:null,isDocx:false,underCA:false,changeid:"",format:"html",isHTMLReady:true,convertBeforeEdit:false,bi_color:null},model:null,node:null,id:null,objectId:null,parentId:null,physicalId:null,connection:null,connectionId:null,level:null,index:null,containerIdx:null,title:null,container:null,info:null,content:null,header:null,menu:null,type:null,kindof:null,context:null,mediator:null,traceabilityAuthoring:true,isHTMLReady:true,isDocx:false,underCA:false,changeid:"",format:"html",convertBeforeEdit:false,init:function(B){var E=this;this._logger=x.getLogger(e);this._logger.log("init");UWA.merge(B||{},this.defaultOptions);this.options=B;this.model=this.options.model;this.node=this.options.node;this.id=this.options.id;this.objectId=this.options.objectId;this.parentId=this.options.parentId;this.physicalId=this.options.physicalId;this.connection=this.options.connection;this.connectionId=this.options.connectionId;this.level=this.options.level;this.index=this.options.index;this.containerIdx=this.options.containerIdx;this.title=this.options.title;this.type=this.options.type;this.kindof=this.options.kindof;this.context=this.options.context;this.mediator=this.options.mediator;var A=false;if(UWA.is(this.node)&&UWA.is(this.node._options)){A=this.node._options.externalObject}this.container=y.container({id:this.options.id,objectId:this.options.objectId,physicalId:this.options.physicalId,connectionId:this.options.connectionId,type:this.options.type,level:this.options.level,className:this.options.placeholder===true?"placeholder":""}),this.header=y.header({id:this.options.id}),this.header_content=y.header_content({icon:this.options.kindof.toLowerCase(),title:this.options.title,containerIdx:this.options.containerIdx,index:this.options.index,connection:this.options.connection,level:this.options.level,externalObject:A,id:this.options.id,editable:this.options.editable}),this.body=y.body();this.info=y.info(),this.content=y.content({id:this.options.id,editable:this.options.editable,content:this.options.content,title:this.options.title}),this.menu=y.menu();this.header.append(this.menu).append(this.header_content);this.body.append(this.info).append(this.content);this.container.append(this.header).append(this.body);this._lowerMatchUpper={};var D=Object.keys(this.options.droppable);D.forEach(function(G){if(UWA.is(widget.getPreference("trm_types_"+G))){var F=widget.getPreference("trm_types_"+G).options;F.forEach(function(H){if(h.inArray(H.value,D)===-1){D.push(H.value)}})}});for(var C=0;C<D.length;C++){this._lowerMatchUpper[D[C].toLowerCase()]=D[C]}this._menuAttached=false},_subscribeToStopDnD:function(){var A=this;this.mediator.subscribe("onStopDnd",function(B){A._isDnD=false;A._notDroppable();A._notDraggable()})},_subscribeToStartDnD:function(){var A=this;this.mediator.subscribe("onStartDnd",function(B){A._isDnD=true;A._droppable();A._draggable()})},_subscribeToOnScroll:function(){var A=this;this.mediator.subscribe("onScroll",function(B){A._scroll(B)})},create:function(){var A=this;if(this.options.placeholder===true){return this}this.node.setRichViewElementID(this.id);this.node.setRichViewElement(this);this._dragging=false;this._isDnD=false;this._dropPosition="";this._draggingY=null;if(this.options.fetchContent===true){this.refreshContent()}this._subscribeToStopDnD();this._subscribeToStartDnD();this._subscribeToOnScroll();this.StartLinkCmd=new p({ID:"StartLink_DnD"});this.EndLinkCmd=new u({ID:"EndLink_DnD",container:".content-panel"});return this},update:function(F){var D=this;var A=UWA.clone(F,true);F=UWA.merge(F||{},this.options);this.options=F;var C=Object.keys(A);for(var B=0;B<C.length;B++){switch(C[B]){case"bi_color":if(UWA.is(F.bi_color)&&F.bi_color!==""){D.options.bi_color=F.bi_color;D.info.css("border-left-color",F.bi_color)}else{D.options.bi_color=null;if(D.info.attr("style")){D.info.removeAttr("style")}}break;case"level":D.level=D.options.level;D.container.data("level",D.options.level);D.container[0].dataset.level=D.options.level;break;case"underCA":D.options.underCA=F.underCA;D.underCA=D.options.underCA;break;case"changeid":D.options.changeid=F.changeid;D.changeid=D.options.changeid;break;case"content":if(F.hasOwnProperty("isDocx")){D.isHTMLReady=!(F.isDocx&&!F.content);D.convertBeforeEdit=(F.format=="rtf.gz.b64"||F.isDocx)&&F.content.toLowerCase().indexOf("<img")>=0;if(!D.isHTMLReady){D.options.content=o.Msg_NoPreview}}D.context.updateRichContent({content:D.options.content,element:D.content.find(".content-data"),editable:F.editable});break;case"title":if(D.title!==F.title){D.options.title=F.title;D.title=D.options.title;D.context.updateRichContent({content:D.title,element:h(D.header_content[0].children[2].children[1].children[0]),editable:D.options.editable});D.mediator.publish("onRefresh")}break;case"index":D.options.index=F.index;D.options.index=D.options.index;D.header.find(".rich-object-index").text(D.options.index+" ");break;case"containerIdx":D.options.containerIdx=F.containerIdx;D.options.containerIdx=D.options.containerIdx;D.header.find(".rich-object-container-index").text(D.options.containerIdx+" - ");break;case"connection":D.options.connection=F.connection;D.connection=D.options.connection;var E=y.header_content({icon:D.options.kindof.toLowerCase(),title:D.options.title,containerIdx:D.options.containerIdx,index:D.options.index,connection:D.options.connection,level:D.options.level,externalObject:D.node._options.externalObject,id:D.options.id,editable:D.options.editable});D.header_content.replaceWith(E);D.header_content=E;break;case"connectionId":D.options.connectionId=F.connectionId;D.connectionId=D.options.connectionId;D.container.data("relid",D.options.connectionId);D.container[0].dataset.relid=D.options.connectionId;break;case"parentId":D.options.parentId=F.parentId;D.parentId=D.options.parentId;break;case"editable":if(F.underCA&&F.changeid===""&&(D.context.getAuthoringContextPID()!==""&&D.context.getAuthoringContextPID()!=="null"&&D.context.getAuthoringContextPID()!=null)||F.changeid!==""&&F.changeid===D.context.getAuthoringContextPID()){F.editable=true}if(F.underCA&&(D.context.getAuthoringContextPID()==="")){F.editable=false}D.options.editable=F.editable;D.editable=D.options.editable;D.content.find(".content-data").attr("contenteditable",F.editable);case"isDocx":D.options.isDocx=F.isDocx;D.isDocx=D.options.isDocx;default:break}}},refresh:function(D){var B=this;var D=D||[];for(var A=0;A<D.length;A++){switch(D[A]){case"content":var C=B.content.find(".content-data").html();B.mediator.publish("onUpdateCKEditorContent",{content:C,element:B.content.find(".content-data")});break;case"title":B.context.updateRichContent({content:B.title,element:h(B.header_content[0].children[2].children[1].children[0]),editable:B.options.editable});break;default:break}}},hide:function(){this.container.hide()},show:function(){this.container.show()},_scroll:function(C){var B=this;var A=B.isVisible(C.position);if(A&&this._menuAttached===false){this._menuAttached=true;this._menu()}if(A){if(this._isDnD){return true}this._isDnD=true;this._droppable();this._draggable()}else{this._isDnD=false;this._notDroppable();this._notDraggable()}},_draggable:function(){var A=this;var B=false;this.container.on("mousedown ",function(C){B=h(C.target)});this.container.on("dragstart",function(C){A._dragging=true;A._draggingY=C.originalEvent.clientY;if(B.hasClass("rich-object-info")){h(this).addClass("being-dragged");C.originalEvent.dataTransfer.dropEffect="move";var J=l?"text":"text/searchitems";var D=widget.getUrl();D=D.substr(0,D.indexOf("/webapps"));var K=D.substr(D.lastIndexOf("/")+1);var E=A.model.getNodesByElementID(A.id)[0];var G=E.getOccurencePath();if(false===E.isSelected()&&this.hasOwnProperty("hasClassName")&&false===this.hasClassName("active")){A.context._selectionMgt(A.info,".rich-object")}var F={protocol:"3DXContent",version:"1.1",source:widget.getValue("appId"),data:{items:[{envId:c.getTenant(),serviceId:K,contextId:c.getSecurityContext(),objectId:A.physicalId,objectType:A.type,displayName:A.title,kindof:A.kindof,path:G}]}};if(l){var I={"0":A.id,"1":A.options.title,"2":A.options.type,"3":A.options.kindof,"4":widget.id,protocol:"3DXContent",version:"1.1",source:widget.getValue("appId"),data:{items:[{envId:c.getTenant(),serviceId:K,contextId:c.getSecurityContext(),objectId:A.physicalId,objectType:A.type,displayName:A.title,kindof:A.kindof,path:G}]}};C.originalEvent.dataTransfer.setData("text",JSON.stringify(I))}else{var H=h(this).find(".rich-object-header .trm-icon")[0];C.originalEvent.dataTransfer.setDragImage(H,-10,-10);C.originalEvent.dataTransfer.setData("0_"+this.id,"");C.originalEvent.dataTransfer.setData("1_"+A.options.title,"");C.originalEvent.dataTransfer.setData("2_"+A.options.type,"");C.originalEvent.dataTransfer.setData("3_"+A.options.kindof,"");C.originalEvent.dataTransfer.setData("4_"+widget.id,"");C.originalEvent.dataTransfer.setData(J,JSON.stringify(F))}}else{C.preventDefault()}});this.container.on("dragend",function(C){A._dragging=false;A._draggingY=null;h(this).removeClass("being-dragged");A.cleanupHighlight(h(this))})},_notDraggable:function(){var A=this;this.container.off("mousedown");this.container.off("dragstart");this.container.off("dragend")},_droppable:function(){var B=this;var A=0;this.container.on("dragenter",function(C){if(C.stopPropagation){C.stopPropagation()}if(C.preventDefault){C.preventDefault()}if(B.isDroppable(C)===false){return false}A++});this.container.on("dragover",function(C){var M=B.isDroppable(C);if(h.inArray("text/html",C.originalEvent.dataTransfer.types)!==-1){C.originalEvent.dataTransfer.dropEffect="copy"}if(M===false){return false}if(h.inArray("Files",C.originalEvent.dataTransfer.types)!==-1){widget.dispatchEvent("onDragOverFiles",C)}var K=h(this);if(B._draggingY==null){B._draggingY=C.originalEvent.clientY}var F=C.originalEvent.clientY-B._draggingY;if(F>0){var D=K.next()[0];if(UWA.is(D)){var J=D.getAttribute("id");var G=B.context.options.model.getNodesByElementID(J)[0];if(G!=null&&G.getRichViewElement()!=null){if(!G.getRichViewElement().isVisible()){B.context.scroller.scrollToElement("#"+J,"center")}else{var H=B.context.contentPanel.height()-B.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight,O=G.getRichViewElement().container.height();var I=36+G.getRichViewElement().container.offset().top-B.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight;if(I>H){B.context.scroller.scrollToElement("#"+J,"center")}}}}}else{if(F<0){var N=K.prev()[0];if(UWA.is(N)){var L=N.getAttribute("id");var E=B.context.options.model.getNodesByElementID(L)[0];if(E!=null&&E.getRichViewElement()!=null){if(!E.getRichViewElement().isVisible()){B.context.scroller.scrollToElement("#"+L,"center")}else{var I=E.getRichViewElement().container.offset().top-B.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight;if((I-20)<0){B.context.scroller.scrollToElement("#"+L,"center")}}}}}}B._draggingY=C.originalEvent.clientY;if(!K.hasClass("rich-object")){K=K.parents(".rich-object:first")}if(!K.hasClass("rich-object")){return}B._dropPosition=B.updateHighlight(C.originalEvent.clientY,K,M);return false});this.container.on("dragleave",function(C){if(B.isDroppable(C)===false){return false}A--;if(A===0){var D=h(this);if(!D.hasClass("rich-object")){D=D.parents(".rich-object:first")}if(!D.hasClass("rich-object")){return}B.cleanupHighlight(D)}});this.container.on("drop",function(P){P.preventDefault();var U=h(this);B.cleanupHighlight(U);if(!B._dropPosition){return}if(l){var S=B.handleDataTransferInIE(P.originalEvent);if(UWA.is(S)){if(UWA.is(S.protocol)&&S.protocol==="3DXContent"){if(S["4"]!==widget.id){B.process3DXContentData(S,U);return}}}else{if(UWA.is(P.originalEvent.dataTransfer.getData("text"),"string")){var C=B.options.defaultType;if(UWA.is(widget.getValue("trm_types_"+B.options.defaultType.replace(" ","_")))&&widget.getValue("trm_types_"+B.options.defaultType.replace(" ","_"))!==""){C=widget.getValue("trm_types_"+B.options.defaultType)}B.mediator.publish("onInsert",{target:{element:U,id:U.attr("id")},position:B._dropPosition,operation:"insertNew",type:C,kindof:B.options.defaultType,parentId:B.objectId,content:P.originalEvent.dataTransfer.getData("text"),contentType:"html"})}}}else{var Q=false;if(UWA.is(P.originalEvent.dataTransfer.types[0],"string")){var D=B.extractFromDataTransfer(P.originalEvent.dataTransfer.types[0]);var M=B.model.getNodesByElementID(D);if(M.length>0){Q=true}}if(h.inArray("text/searchitems",P.originalEvent.dataTransfer.types)!==-1&&Q===false){var H="text/searchitems";var O=P.originalEvent.dataTransfer.getData(H);var T=JSON.parse(O);B.process3DXContentData(T,U);return}else{if(h.inArray("Files",P.originalEvent.dataTransfer.types)!==-1&&Q===false){return}else{if(g&&h.inArray("text/html",P.originalEvent.dataTransfer.types)!==-1&&Q===false){var C=B.options.defaultType;if(UWA.is(widget.getValue("trm_types_"+B.options.defaultType.replace(" ","_")))&&widget.getValue("trm_types_"+B.options.defaultType.replace(" ","_"))!==""){C=widget.getValue("trm_types_"+B.options.defaultType)}var L=P.originalEvent.dataTransfer.getData("text/html");if(L.indexOf("<!--StartFragment-->")>-1&&L.indexOf("<!--EndFragment-->")>-1){var I=L.indexOf("<!--StartFragment-->")+20;var E=L.indexOf("<!--EndFragment-->");var J=L.slice(I,E);B.mediator.publish("onInsert",{target:{element:U,id:U.attr("id")},position:B._dropPosition,operation:"insertNew",type:C,kindof:B.options.defaultType,parentId:B.objectId,content:J,contentType:"html"})}else{B.mediator.publish("onInsert",{target:{element:U,id:U.attr("id")},position:B._dropPosition,operation:"insertNew",type:C,kindof:B.options.defaultType,parentId:B.objectId,content:P.originalEvent.dataTransfer.getData("text/html"),contentType:"html"})}return}else{if(h.inArray("text/html",P.originalEvent.dataTransfer.types)!==-1&&Q===false){var C=B.options.defaultType;if(UWA.is(widget.getValue("trm_types_"+B.options.defaultType.replace(" ","_")))&&widget.getValue("trm_types_"+B.options.defaultType.replace(" ","_"))!==""){C=widget.getValue("trm_types_"+B.options.defaultType)}B.mediator.publish("onInsert",{target:{element:U,id:U.attr("id")},position:B._dropPosition,operation:"insertNew",type:C,kindof:B.options.defaultType,parentId:B.objectId,content:P.originalEvent.dataTransfer.getData("text/html"),contentType:"html"});return}else{if(h.inArray("text/plain",P.originalEvent.dataTransfer.types)!==-1){return}}}}}}var K=undefined,N=undefined,V=undefined,F=undefined,G=undefined;if(l){var R=B.handleDataTransferInIE(P.originalEvent);if(!UWA.is(R)){return}K=R["0"];N=h("#"+K);V=R["1"];F=R["2"];G=R["3"]}else{K=B.extractFromDataTransfer(P.originalEvent.dataTransfer.types[0]),N=h("#"+K),V=B.extractFromDataTransfer(P.originalEvent.dataTransfer.types[1]),F=B._lowerMatchUpper[B.extractFromDataTransfer(P.originalEvent.dataTransfer.types[2])],G=B._lowerMatchUpper[B.extractFromDataTransfer(P.originalEvent.dataTransfer.types[3])]}B.mediator.publish("onReorder",{source:{element:N,id:K},target:{element:U,id:B.options.id},position:B._dropPosition,type:"rich-object"})})},_notDroppable:function(){var A=this;this.container.off("drop");this.container.off("dragenter");this.container.off("dragover");this.container.off("dragleave");this.container.off("click");this.container.off("mouseenter");this.container.off("mouseover");this.container.off("mouseleave")},_menu:function(){var B=this;var A=new k({model:this.model,container:this.menu[0],id:this.id,kindof:this.kindof,externalObject:this.node.options.externalObject,type:this.type,externalProviders:this.context.externalProviders}).inject()},refreshContent:function(){var A=this;b.getContent({securityContext:c.getSecurityContext(),pid:A.physicalId,onComplete:function(B){B=UWA.is(B,"string")?JSON.parse(B):B;var C=B.results;if(!UWA.is(C["Content Data"])){C["Content Data"]=""}A.update({content:C["Content Data"],format:C["Content Type"],isDocx:C.isDocx,editable:C.editable})},onFailure:function(B){A.mediator.publish("onNotification",{className:"error",message:B.message})}})},isVisible:function(){var D=this;var B=D.context.contentPanel.height()-D.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight,C=D.container.height();var A=D.container.offset().top-D.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight;if((A+C)>0&&A<B){return true}else{return false}},isDroppable:function(A){var D=this;if(D._dragging){return false}if(h.inArray("cke/id",A.originalEvent.dataTransfer.types)!==-1){return false}if(l){return D.options.droppable.Text}var G=false;if(UWA.is(A.originalEvent.dataTransfer.types[0],"string")){var C=D.extractFromDataTransfer(A.originalEvent.dataTransfer.types[0]);var B=D.model.getNodesByElementID(C);if(B.length>0){G=true}}if((h.inArray("Files",A.originalEvent.dataTransfer.types)!==-1)&&G===false){return D.options.droppable.Files}else{if((h.inArray("text/searchitems",A.originalEvent.dataTransfer.types)!==-1)&&G===false){return D.options.droppable["text/searchitems"]}else{if((h.inArray("text/plain",A.originalEvent.dataTransfer.types)!==-1)&&G===false){return D.options.droppable["text/plain"]}else{if((h.inArray("Text",A.originalEvent.dataTransfer.types)!==-1)&&G===false){return D.options.droppable.Text}}}}var I=A.originalEvent.dataTransfer,E=D._lowerMatchUpper[D.extractFromDataTransfer(I.types[2])],F=D._lowerMatchUpper[D.extractFromDataTransfer(I.types[3])];var H=false;if(D.options.droppable[E]!==undefined){H=D.options.droppable[E]}else{if(D.options.droppable[F]){H=D.options.droppable[F]}}if(D.node._options.externalObject){H="before,after"}return H},extractFromDataTransfer:function(B){var A=B.indexOf("_")!==-1?(B.indexOf("_")+1):0;return B.substring(A)},isInUpperHalf:function(A,B){return(A<=B.offset().top+B.outerHeight()/4)},isInLowerHalf:function(A,B){return(A+B.outerHeight()/4>=B.offset().top+B.outerHeight())},updateHighlight:function(A,D,B){var C=this;if(C.isInUpperHalf(A,D)&&B.indexOf("before")!==-1){if(D.prev().hasClass("droppable-above")){return"before"}D.removeClass("droppable-child");if(D.next().hasClass("droppable-below")){D.next().remove()}D.before('<div class="droppable-target droppable-above wux-datagrid-row-insertion-mark"></div>');return"before"}else{if(C.isInLowerHalf(A,D)&&B.indexOf("after")!==-1){if(D.next().hasClass("droppable-below")){return"after"}D.removeClass("droppable-child");if(D.prev().hasClass("droppable-above")){D.prev().remove()}D.after('<div class="droppable-target droppable-below wux-datagrid-row-insertion-mark"></div>');return"after"}else{if(B.indexOf("over")!==-1){if(D.hasClass("droppable-child")){return"over"}if(D.next().hasClass("droppable-below")){D.next().remove()}if(D.prev().hasClass("droppable-above")){D.prev().remove()}D.addClass("droppable-child");return"over"}}}},cleanupHighlight:function(A){A.removeClass("droppable-child");if(A.next().hasClass("droppable-below")){A.next().remove()}else{if(A.prev().hasClass("droppable-above")){A.prev().remove()}}},handleDataTransferInIE:function(A){var D=this;var B=A.dataTransfer.getData("text");var C=undefined;try{C=JSON.parse(B)}catch(E){C=undefined}return C},process3DXContentData:function(I,G){var F=this;if(I.source===widget.getValue("appId")){if(I.data.items[0].kindof==="Requirement"){var C="RichView.onStartLink";var A={id:I.data.items[0].objectId,physicalId:I.data.items[0].objectId,type:I.data.items[0].objectType,kindof:I.data.items[0].kindof,path:I.data.items[0].path,title:I.data.items[0].displayName};F.StartLinkCmd.execute(A);var D=F.model.getNodesByElementID(F.id)[0];var J=D.getOccurencePath();var E={id:F.objectId,physicalId:F.physicalId,type:F.type,kindof:F.kindof,path:J,title:F.title};F.EndLinkCmd.execute(E)}else{F.context.displayNotification({msg:s.RichView_Notif_NotAuthorized,eventID:"error"})}}else{var H=I.data.items[0].objectType;var B=I.data.items[0].objectId;b.getKindOf({securityContext:c.getSecurityContext(),pid:B,onComplete:function(O){var N=UWA.is(O,"string")?JSON.parse(O):O;var M=N.results;var K=F.options.droppable[M];if(!UWA.is(K)||K.indexOf(F._dropPosition)===-1){F.mediator.publish("onNotification",{className:"error",message:s.RichView_Notif_NotAuthorized});return false}else{var L=I.data.items[0].objectId;F.mediator.publish("onInsert",{operation:"insertExisting",position:F._dropPosition,type:H,objectId:L,content:"",contentType:"",kindof:M,target:{element:G,id:G.attr("id")},fetchContent:true,})}}})}}});return e});define("DS/RichView/RichView",["UWA/Core","UWA/Controls/Abstract","UWA/Class/Options","UWA/Class/Events","UWA/Class/Promise","DS/Logger/Logger","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/jQueryUI","DS/UIKIT/Scroller","DS/CATSystemSlidePanel/SlidePanel","DS/RichView/Navigation","DS/RichView/RichContentEditor","DS/RichView/Views/RichObject","DS/RichView/Views/RichContainer","DS/RichView/Views/RichViewIdCard","DS/UIKIT/Alert","DS/UIKIT/Mask","DS/UIKIT/Spinner","DS/Controls/ProgressBar","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/TraceableRequirementsUtils/Utils","DS/RichView/Service/WidgetPreferences","DS/RichView/Views/DropInvit","DS/RichView/Views/RichViewInfos","DS/PlatformAPI/PlatformAPI","DS/RichView/Service/KeyboardShortcuts","DS/PADUtils/PADContext","DS/PADUtils/PADCommandProxy","DS/RichEditor/RichEditor","DS/i3DXCompassServices/i3DXCompassPubSub","DS/RichView/Models/RichViewDocument","DS/RichView/Models/RichViewModelParser","DS/RichView/mixins/_delimiterUtilities","DS/TraceableRequirementsUtils/REQCommandProxy","DS/RichView/mixins/_RichBIFilter","DS/Windows/DockingElement","i18n!DS/RichView/assets/nls/RichView","css!DS/RichView/RichView.css"],function(v,am,y,al,R,g,w,I,ae,ak,U,q,b,aj,t,A,X,H,O,l,k,Q,ap,u,B,m,G,Y,r,D,M,ag,C,a,an,E,f){var K={richView:function(aq){return w('<div class="main-panel">	<div class="navigation-panel"></div>   <div class="content-panel">		<div class="id-card-panel"></div>		<div class="richview-editor-container"> <div class="richview-editor-content"></div>		</div>	</div>	<div class="properties-panel off"></div></div>')}};var ad={serverStart:0,serverEnd:0,buildStart:0,buildEnd:0,contentStart:0,contentEnd:0};function F(){var aq="";do{aq="object_"+Math.floor(Math.random()*1000000)}while(ao[aq]);ao[aq]=aq;return aq}var N={},n=0,ac=9999,S="";var ab={},j=undefined,P=9999;var o=15;var W=45;var ao={};var V={};var d=null,i=3000;var T=null;var ah=false;var c=false;var J=false;var h=false;var af=false;var Z=false;var aa=false;var x=false;var z=false;var e=false;var s=false;var L=false;var ai={};var p=am.extend(y,al,an,C,{name:"richview_container",defaultOptions:{isSemanticQualityPanelOpen:false,x3dAppId:"REQ_appId",mediator:null,data:null,root:"Requirement Specification",rich:"Requirement,Comment",container:"Chapter",authorizeChangeControl:true,CfgAuthoringContext:null,droppable:{Requirement:{Requirement:"before,after,over",Comment:"before,after",Chapter:"before,after",Files:"over","text/plain":"before,after,over","text/html":"before,after,over","text/searchitems":"before,after,over",Text:"before,after,over"},Comment:{Requirement:"before,after",Comment:"before,after",Chapter:"before,after",Files:"over","text/plain":"before,after","text/html":"before,after","text/searchitems":"before,after,over",Text:"before,after,over"},Chapter:{Chapter:"before,after,over",Requirement:"before,after,over",Comment:"before,after,over","text/plain":"over","text/html":"over","text/searchitems":"before,after,over",Text:"before,after,over"},"Requirement Specification":{Chapter:"over",Requirement:"over",Comment:"over"}},relationship:{Requirement:"Sub Requirement",Chapter:"Specification Structure","Requirement Specification":"Specification Structure"}},_logger:null,_commandProxy:null,_padCommandProxy:null,_reqCommandProxy:null,_curentlyLoadingReqSpec:false,_smvSelectionEvent:null,externalTypes:["ProxyItem"],externalProviders:false,OSLCProviders:undefined,_csrf:null,_isReady:{actionbar:false,richview:false,dropinvite:false},_isSelectionEmpty:true,_traceabilityScope:{id:null,title:null},context:null,init:function(aq){T=this;if(widget.id!="dummy"){try{require(["text!DS/OSLCConsumer/assets/OSLCConfig.json"],function(at){T.OSLCProviders=JSON.parse(at);if(UWA.is(T.OSLCProviders)&&UWA.is(T.OSLCProviders.repositories)&&T.OSLCProviders.repositories.length>0){T.externalProviders=true}})}catch(ar){console.log("/OSLCConsumer/assets/OSLCConfig.json file not found")}}UWA.merge(aq||{},T.defaultOptions);this._parent(aq);this._logger=g.getLogger(p);this._logger.log("init");G.set(this);T.context=G.get();if(!UWA.is(widget.getValue("x3dAppId"))){widget.addPreference({name:"x3dAppId",type:"hidden",defaultValue:T.defaultOptions.x3dAppId})}widget.addPreference({name:"trm_richview_optimizedloading",type:"boolean",defaultValue:true,label:f.TRM_OptimizationLoading});T.options.model=new M();self.widget.addEvent("endEdit",function(){T.utilities.onEndEdit();T._onWidgetResize()})},inject:function(aq){this.mediator=this.options.mediator;this.container=aq;w(aq).parent().css("height","100%");w(aq).css("height","100%");this.richView=w(this.container).append(K.richView());this.contentPanel=w(".content-panel",this.richView);this.idCardPanel=w(".id-card-panel",this.richView);this.richViewEditorContainer=w(".richview-editor-container",this.richView);this.richViewEditorContent=w(".richview-editor-content",this.richView);this.navigationPanel=w(".navigation-panel",this.richView);this.propertiesPanel=w(".properties-panel",this.richView);this.richviewinfos=new u({renderTo:UWA.Element.getElement.call(document,".AfrActionBar"),events:{}});this.contentPanel.on("dblclick",".content-data",function(aw){var ar=this;var av=new r();if(av.getPreferredEditor()=="Word"&&!(av.isMobile&&av.isMobile())){var au=w(ar).closest(".rich-object");var ay=T.options.model.getNodesByElementID(au.attr("id"))[0];var ax=ay.options.matrixID;if(UWA.is(ay)&&UWA.is(ay.options.externalObject)&&ay.options.externalObject){T.displayNotification({eventID:"error",msg:f.RichView_Notif_NotAuthorized});return}var at=ay.getRichViewElement();if(!at.isHTMLReady){return}av.openRichTextInWord({uid:ax,onClose:function(az,aB,aA){w("DIV.rich-object[data-objectid='"+az+"'] .content-data").html(aA);av.saveRichText(az,aB);at=T.options.model.getNodesByElementID(w("DIV.rich-object[data-objectid='"+az+"']").attr("id"))[0];at.update({content:aA})}})}});k.app_initialization(function(){T._initWidgetPreferences();T._loadData();if(!UWA.is(T.CfgAuthoringContext)){T._checkIfChangeControlEnabled(function(ar){if(ar){require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext"],function(au){T.CfgAuthoringContext=au;var at=document.querySelector(".Content");var av="show";au.initialize2(at,a.appId(),av,"bottom-right",function(aw){T.dispatchEvent("onAuthoringCtxAvailable",aw);B.subscribe(T.CfgAuthoringContext.myAuthkey,function(ax){setTimeout(function(){T.mediator.publish("onRefresh")},1000)});B.subscribe("toggleDeActiveCA"+T.CfgAuthoringContext.myAuthkey,function(ax){setTimeout(function(){T.mediator.publish("onRefresh")},200)});B.subscribe("toggleActiveCA"+T.CfgAuthoringContext.myAuthkey,function(ax){setTimeout(function(){T.mediator.publish("onRefresh")},200)});B.subscribe("removeAuthCtxEvent"+T.CfgAuthoringContext.myAuthkey,function(ax){setTimeout(function(){T.mediator.publish("onRefresh")},200)})})})}})}});return this},_initWidgetEvents:function(){if(widget.hasEvent("onRefresh")===false){widget.addEvent("onRefresh",function(){T._onWidgetRefresh()})}if(widget.hasEvent("onResize")===false){widget.addEvent("onResize",function(){T._onWidgetResize()})}if(widget.hasEvent("onDestroy")===false){widget.addEvent("onDestroy",function(){T._onWidgetDestroy()})}},_loadData:function(){var aq=null;var at=this.utilities.useCompassContent();var au=this.utilities.reloadSaveObject();var ar=false;if(UWA.is(this.options.data)&&this.options.data!==""){ar=true;T._buildView();this.json=this.options.data;this.root=this.json[0];l.getInfo({securityContext:k.getSecurityContext(),pid:aq,selectables:"type,name,revision,type.kindof,attribute[Title],physicalid,id",onComplete:function(av){av=UWA.is(av,"string")?JSON.parse(av):av;ag.process.root({treedocument:T.options.model,data:av.results[0],tenant:k.getTenant()},T.externalTypes);T._richView(T.json);T.mediator.publish("onRefresh");T._startEdition()}})}else{if(UWA.is(at)&&at!==""){aq=at}else{if(UWA.is(au)&&au!==""){aq=au}}}if(UWA.is(aq)){l.getInfo({securityContext:k.getSecurityContext(),pid:aq,selectables:"type,name,revision,type.kindof,attribute[Title],physicalid,id",onComplete:function(aw){aw=UWA.is(aw,"string")?JSON.parse(aw):aw;var av=aw.results[0]["type.kindof"];if(av===T.options.root){T.options.data=aq;ag.process.root({treedocument:T.options.model,data:aw.results[0],tenant:k.getTenant()},T.externalTypes);T._init()}else{T._initDropZone()}},onFailure:function(av){T._initDropZone()},onTimeout:function(){T._initDropZone()}})}else{if(ar!==true){T._initDropZone()}}},_initDropZone:function(){T.mediator.subscribe("onInitialDrop",function(aq){T._onInitialDrop(aq)});T.mediator.subscribe("onRemoveDropInvit",function(aq){T.dropinvit.remove();T.options.data=aq;T._init()});T.dropinvit=new ap({renderTo:T.container,mediator:T.mediator,selector:".moduleContent"});T._initWidgetEvents();T._initProxyEvents()},_init:function(){this._initWidgetEvents();this._initProxyEvents();this._initMediatorEvents();this.current_selection={element:null,objectId:T.options.model.getRoots()[0].getID(),physicalid:T.options.model.getRoots()[0].options.matrixID,kindof:T.options.model.getRoots()[0].options.kindof,type:T.options.model.getRoots()[0].options.type,path:T.options.model.getRoots()[0].getOccurencePath()};T.options.model.getRoots()[0].select();if(UWA.is(this.options.data,"string")){this._fetchData(this.options.data)}this._initKeyboardShortcuts();this._initWidgetPreferences();this.utilities.setWidgetTitle();this.utilities.saveObject(this.options.data);this.rootId=this.options.data;this._promises=[];this._promisesData=[];widget.dispatchEvent("onCheckScopeRV")},_onInitialDrop:function(aq){T.options.data=aq;l.getInfo({securityContext:k.getSecurityContext(),pid:aq,selectables:"type,name,revision,type.kindof,attribute[Title],physicalid,id",onComplete:function(at){at=UWA.is(at,"string")?JSON.parse(at):at;var ar=UWA.is(at.results[0]["type"],"object")?at.results[0]["type"]["value"]:at.results[0]["type"];var au=at.results[0]["type.kindof"];if(ar===T.options.root||au===T.options.root){ag.process.root({treedocument:T.options.model,data:at.results[0],tenant:k.getTenant()},T.externalTypes);T._init()}else{T.displayNotification({eventID:"warning",msg:f.RichView_Notif_NotAuthorized});T._initDropZone()}},onFailure:function(at,ar){T.displayNotification({eventID:"error",msg:f.RichView_Notif_LoadError});T._initDropZone()},onTimeout:function(ar){T.displayNotification({eventID:"error",msg:f.RichView_Notif_LoadError});T._initDropZone()}});T._reqCommandProxy.drop({id:aq,appId:widget.getValue("appId"),widgetId:widget.id,action:"load"})},_subscribers:{subscribeToRefreshElement:function(){T.mediator.subscribe("onRefreshElement",function(au){var aq=au.element;var av=aq.attr("id");var ar=au.refresh;var at=T.options.model.getNodesByElementID(av)[0];at.getRichViewElement().refresh(ar)});return true},subscribeToUpdateElement:function(){T.mediator.subscribe("onUpdateElement",function(at){var aq=at.element;var au=at.updates;var av=aq.attr("id");var ar=T.options.model.getNodesByElementID(av)[0];ar.getRichViewElement().update(au)});return true},subscribeToNavigationClick:function(){T.mediator.subscribe("onNavigationClick",function(aq){T.scroller.scrollToElement("#"+aq,"top");if(!w("#"+aq).hasClass("active")){w("#"+aq).find(".rich-container-title-index,.rich-object-info").click()}});return true},subscribeToDragActionInsertRequirement:function(){T.mediator.subscribe("onDrag:ActionInsertRequirement",function(aq){var ar=w(aq.target).data("current-droppable");if(ar){updateHighlight(aq.ui,ar)}});return true},subscribeToRefresh:function(){T.mediator.subscribe("onRefresh",function(aq){T.refreshView(aq)});return true},subscribeToNotification:function(){T.mediator.subscribe("onNotification",function(aq){d.add({className:aq.className,message:aq.message})});return true},subscribeToInsert:function(){T.mediator.subscribe("onInsert",function(aq){T.authoring.insertWithPromise(aq)});return true},subscribeToReorder:function(){T.mediator.subscribe("onReorder",function(aq){T.authoring.reorder(aq)});return true},subscribeToOnNewRichView:function(){T.mediator.subscribe("onNewRichView",function(aq){T.utilities.saveObject(aq);T._onWidgetRefresh()});return true}},onInnerSelection:function(av,au){var aw=T.options.model.getSelectedNodes()[0];if(aw.getID()!==av.getID()){aw.unselect();av.select()}var aq=av.getOccurencePath();T._reqCommandProxy.reqSelect({paths:[aq],appId:widget.getValue("appId"),widgetId:widget.id});var ar={paths:[aq],attributes:{}};ar.attributes[av.getID()]={tenant:k.getTenant()};T._padCommandProxy.select(ar);var at=UWA.is(av.getRichViewElement())?av.getRichViewElement().container:null;T.current_selection={element:at,objectId:av.options.matrixID,physicalid:av.getID(),kindof:av.options.kindof,type:av.options.type,path:aq};D.publish("setObject",{objectId:av.getID(),envId:k.getTenant(),contextId:k.getSecurityContext()});T.idcard.updateSelection();T._logger.log("An object has been selected in RichView",av)},onCleanSelection:function(ar){var at=T.contentPanel.find(".rich-object.active, .rich-container.active");if(at.length===0){T.options.model.unselectAll();T.options.model.getRoots()[0].select();T.current_selection={element:null,objectId:T.rootId,physicalid:T.rootId,kindof:T.options.root,type:T.options.parentType,path:[T.rootId]};if(ar!==false){T._reqCommandProxy.reqSelect({paths:[[T.rootId]],appId:widget.getValue("appId"),widgetId:widget.id})}var aq={paths:[[T.rootId]],attributes:{}};aq.attributes[T.rootId]={tenant:k.getTenant()};T._padCommandProxy.select(aq);T.idcard.updateSelection()}},cleanAll:function(){T.richView.empty();T._resetMembers();T.utilities.cleanObject();T.utilities.cleanWidgetTitle();T.inject(T.container);T.options.model.getModelEvents().publish({event:"setPathTags",context:T.options.model})},_onWidgetDestroy:function(){T._padCommandProxy.destroy();T._reqCommandProxy.destroy();T.cleanAll();T._logger.log("onWidgetDestroy")},_onWidgetResize:function(){T._logger.log("onWidgetResize");if(UWA.Element.getElement.call(document,".AfrActionBar").getAttribute("data-open")==="true"){var ar=T.richView.parent().parent().height()-70}else{var ar=T.richView.parent().parent().height()-20}T.richView.parent().height(ar);T.options.height=ar;var at=UWA.Element.getElement.call(document,".wux-windows-docking-and-collapser.wux-docking-element-top.hidden-xs");var aq=at.offsetHeight;if(UWA.is(at)){if(at.getStyle("display")==="none"){UWA.Element.getElement.call(document,".wux-windows-docking-element-free-zone.wux-docking-element-top").style.height="100%"}else{UWA.Element.getElement.call(document,".wux-windows-docking-element-free-zone.wux-docking-element-top").style.height="calc(100% - "+aq+"px)"}}if(T.navigationPanel&&T.navigationPanel.updateSize){T.navigationPanel.updateSize(T.richView.parent().width(),T.options.height)}if(T.navigation&&T.navigation.resizeList){T.navigation.resizeList()}T._resizeContentPanel();T.richviewinfos.setBody();if(UWA.is(T._reqCommandProxy)){T._reqCommandProxy.resizeRV()}},_onWidgetRefresh:function(){T._logger.log("onWidgetRefresh");T.richView.empty();T._resetMembers();T.inject(T.container)},_resetMembers:function(){ad={serverStart:0,serverEnd:0,buildStart:0,buildEnd:0,contentStart:0,contentEnd:0};N={};n=0;ac=9999;S="";ab={};j=undefined;P=9999;o=15;W=45;ao={};V={};T.scroller=null;if(this.shortcuts){this.shortcuts.removeKeyboardEventsListener()}this._defineDefaultTypes();this.current_selection={};this.options.data=null;this.rootId=null;T.options.model.unselectAll();T.options.model.removeRoots()},_initProxyEvents:function(){if(!UWA.is(this._padCommandProxy)){this._padCommandProxy=Y.create({events:{onRefresh:function(aq){T.utilities.refreshAuthoredObject(aq)},onSelect:function(aq,ar){T.utilities.syncViewOnExternalSelection(aq)}}})}if(!UWA.is(this._reqCommandProxy)){this._reqCommandProxy=a.create({events:{onReqSelect:function(aq,ar){T.utilities.syncViewOnInternalSelection(aq);console.log("rich view req select event",aq);console.log("rich view req select data",ar);console.log("rich view req select data widget id",widget.id);console.log("rich view req select data widget x3dSharedId",widget.getValue("x3dSharedId"))},onDrop:function(aq){if(!T._curentlyLoadingReqSpec){T._curentlyLoadingReqSpec=true;T.utilities.loadSpec(aq)}},onAttach:function(aq){T.utilities.attachObject(aq)},onDetach:function(aq){T.utilities.detachObject(aq)},onReorder:function(aq){T.utilities.reorderObject(aq)},onPreferenceModification:function(aq){T.utilities.updatePreferences(aq)},onRevise:function(aq){T.utilities.reviseObject(aq)},}})}if(!UWA.is(this._smvSelectionEvent)){this._logger.log("Listening to topic DS/CATSmmUI/3DExperience/Proxy/localSelectionChanged");this._smvSelectionEvent=B.subscribe("DS/CATSmmUI/3DExperience/Proxy/localSelectionChanged",function(aq){T.utilities.syncViewOnExternalSelection(aq)})}},_initMediatorEvents:function(){if(s!==true){s=this._subscribers.subscribeToRefreshElement()}if(e!==true){e=this._subscribers.subscribeToUpdateElement()}if(ah!==true){ah=this._subscribers.subscribeToNavigationClick()}if(c!==true){c=this._subscribers.subscribeToDragActionInsertRequirement()}if(J!==true){J=this._subscribers.subscribeToNotification()}if(h!==true){h=this._subscribers.subscribeToInsert()}if(af!==true){af=this._subscribers.subscribeToReorder()}if(Z!==true){Z=this._subscribers.subscribeToRefresh()}if(z!==true){z=this._subscribers.subscribeToOnNewRichView()}},_initKeyboardShortcuts:function(){if(this.shortcuts===null){this.shortcuts=m.init()}this.shortcuts.addKeyboardEventListener()},_initWidgetPreferences:function(){var aq=this._defineOptionsForPref();new Q().addPreferencesToWidget(aq)},_defineOptionsForPref:function(){var au={};au.types=[];var ar=T.options.rich.split(",");var at=T.options.container.split(",");var aq=ar.concat(at);aq.push(T.options.root);aq.forEach(function(av){au.types.push(av)});au.events={onUpdateTypePreferences:function(av){T._defineDefaultTypes()}};return au},_defineDefaultTypes:function(){this._defaultTypes={"Requirement Proxy":"Requirement"};var ar=T.options.rich.split(",");var at=T.options.container.split(",");var aq=ar.concat(at);aq.push(T.options.root);aq.forEach(function(au){var aw=au.replace(" ","_");var av=widget.getValue("trm_types_"+aw);if(UWA.is(av)){ai[au]=av}})},scrollToElement:function(aq){T.scroller.scrollToElement("#"+aq,"top")},updateScopeInformation:function(aq){this.idcard.updateScope(aq)},getRelationshipType:function(aq){return T.options.relationship[aq]},getDefaultType:function(aq){return ai[aq]||aq},saveCSRF:function(aq){this._csrf=aq},getCSRF:function(){return this._csrf},getTenant:function(){return k.getTenant()},getAuthoringContextPID:function(){var ar=null;if(UWA.is(T.CfgAuthoringContext)&&UWA.is(T.CfgAuthoringContext.get)){var aq=T.CfgAuthoringContext.get();ar=UWA.is(aq)?UWA.is(aq.change.id)?aq.change.id:null:null}return ar},_buildView:function(){X.mask(UWA.Element.getElement.call(document,".main-panel"));this.options.height=this.richView.parent().height();this.navigation=null;this._currentPosition=0;this._navigationPanel();d=new A({closable:true,visible:true,autoHide:true,fullWidth:true,hideDelay:i}).inject(UWA.Element.getElement.call(document,this.contentPanel.selector));this.idcard=new t({physicalid:T.options.data,container:this.idCardPanel});this._scrollView();this.topDockingElement=new E({identifier:T.options.data+"_idcard_docking",side:WUXDockAreaEnum.TopDockArea,dockingZoneSize:60,resizableFlag:false,interactiveDockAreaVisibleFlag:false,dockingZoneContent:UWA.Element.getElement.call(document,this.idCardPanel.selector),freeZoneContent:UWA.Element.getElement.call(document,this.richViewEditorContainer.selector)}).inject(UWA.Element.getElement.call(document,this.contentPanel.selector));this.topDockingElement.elements.dockingWithCollapserContainer.addClassName("hidden-xs");this._onWidgetResize();this._attachControls()},displayNotification:function(aq){if(d){d.add({className:aq.eventID,message:aq.msg})}else{alert(aq.msg)}},getProxyContentData:function(at,ar){var aw=this;var aA=this.context.OSLCProviders;var aq="[ "+f.get("ExternalObject_LoadingError")+" ]";var ay=f.get("ExternalObject_LoadingError");var az;if(UWA.is(at.getClosest,"function")){az=at.getClosest(".rich-object[data-physicalid][data-relid]")}else{function ax(aE,aF){while((aE=aE.parentElement)&&!((aE.matches||aE.matchesSelector||aE.msMatchesSelector).call(aE,aF))){}return aE}if(UWA.is(at.closest,"function")){az=at.closest(".rich-object[data-physicalid][data-relid]")}else{az=ax(at,".rich-object[data-physicalid][data-relid]")}console.error('"nodeToSelect" is not a UWA element!')}if(!UWA.is(az)&&!UWA.is(aA)){console.error('Proxy content data cannot be retreived! Check rich-object for (1) 				 "data-relid", (2) "data-physicalid" and (3) check if context.OSLCProviders is defined.');if(UWA.is(aw.mediator)){aw.mediator.publish("onNotification",{className:"error",message:ay})}return}var au;if(at.hasClassName("content-data")){au=at}else{au=at.getElement(".content-data")}var av=az.attributes["data-physicalid"].value;var aD=az.attributes["data-relid"].value;var aC=UWA.createElement("span",{"class":"richview-loading-external-indication",html:f.get("ExternalObject_LoadingContent")+" "});var aB=new H({"class":"richview-spinner"}).inject(aC).show();au.innerHTML="";aC.inject(au);l.getInfo({securityContext:k.getSecurityContext(),pid:av,onComplete:function(aK){aK=UWA.is(aK,"string")?JSON.parse(aK):aK;var aF=aK.results[0];var aH=aF["ProxyItem.Proxy_Service"];var aL=aF["ProxyItem.Proxy_URL"];var aM="",aI="";for(var aG=0;aG<aA.repositories.length;aG++){if(aH===aA.repositories[aG].id){aM=aA.repositories[aG].rootUrl;aI=aA.repositories[aG].oauth}break}var aJ=aw.context.options.model.getNodesByRelId(aD)[0];var aE=aJ.getRichViewElement();l.getOSLCContent({service:aH,doors_url:aM+aL,tenant:k.getTenant(),Oauth:aI,method:"GET",dataType:"xml",onComplete:function(aN){var aN=w(w.parseXML(aN));var aO;if(UWA.is(aN[0].lookupNamespaceURI("jazz_rm"))){aO=aN[0].getElementsByTagNameNS(aN[0].lookupNamespaceURI("jazz_rm"),"primaryText");if(UWA.is(aO[0])){aE.update({content:aO[0].firstChild.innerHTML})}else{console.error("Tag with proxy req content was not found in response.");aE.update({content:aq})}}else{aO=aN[0].getElementsByTagNameNS(aN[0].lookupNamespaceURI("dcterms"),"description");if(UWA.is(aO[0])){aE.update({content:aO[0].innerHTML})}else{console.error("Tag with proxy req content was not found in response.");aE.update({content:aq})}}},onFailure:function(aN){aw._logger.log(aN);aw.mediator.publish("onNotification",{className:"error",message:ay});aE.update({content:aq})}})},onFailure:function(aE){aw._logger.log(aE);aw.mediator.publish("onNotification",{className:"error",message:ay});proxy_object.update({content:aq})},onTimeout:function(){aw.mediator.publish("onNotification",{className:"error",message:ay});proxy_object.update({content:aq});aw._logger.log("RequirementWebServices.getInfo timed out")}})},showProgressBar:function(){T.utilities.loading()},hideProgressBar:function(){T.utilities.loading(true)},refreshView:function(ay){N={},n=0,ac=9999,S="";var ar=w(".rich-container",T.contentPanel);for(var aw=0;aw<ar.length;aw++){var at=T.options.model.getNodesByElementID(ar.eq(aw).attr("id"))[0];var au=at.getRichViewElement();var aq=parseInt(au.level);if(aq<ac){for(var av=0;av<Object.keys(N).length;av++){if(Object.keys(N)[av]>aq){N[Object.keys(N)[av]]=0}}N[ac]=0;ac=aq}if(N[aq]===undefined){N[aq]=1}else{N[aq]+=1}ac=aq;var az="";for(var ax=1;ax<aq;ax++){az+=N[ax]+"."}S=az+N[aq];if(UWA.is(ay)&&UWA.is(ay.level)&&aq<ay.level){continue}au.update({index:S})}T._refreshRichObjectIdx(ay)},_refreshRichObjectIdx:function(aw){j=undefined,P=9999,ab={};var av=w(".rich-object:not(.placeholder)",T.contentPanel);for(var at=0;at<av.length;at++){var au=T.options.model.getNodesByElementID(av.eq(at).attr("id"))[0];var ar=au.getRichViewElement();var ax=parseInt(ar.level);var aq=T._generateObjectIdx(au);if(UWA.is(aw)&&UWA.is(aw.level)&&ax<aw.level){continue}ar.update({containerIdx:aq.containerIdx,index:aq.index})}},_generateObjectIdx:function(at){var av=at.getLevel();var au=at.getParent();if((av<P)&&j!==au.getID()){ab[j]=0;P=av}j=au.getID();if(ab[j]===undefined){ab[j]=1}else{ab[j]+=1}var ar="";var aq="";if(T._isContainer(au.options.type)||T._isContainer(au.options.kindof)||au.isRoot()===true){if(au.isRoot()===true){ar="0"}else{ar=au.getRichViewElement().index}aq=ab[au.getID()]}else{ar=au.getRichViewElement().containerIdx;aq=au.getRichViewElement().index+"."+ab[au.getID()]}return{index:aq,containerIdx:ar}},_fetchData:function(aq){ad.globalStart=ad.serverStart=new Date().getTime();T._buildView();T._startEdition();l.getStructureWithStreaming({id:aq,onComplete:function(at){function au(){at=UWA.is(at,"string")?JSON.parse(at):at;ad.serverEnd=ad.buildStart=new Date().getTime();T._logger.log("Server response: "+(ad.serverEnd-ad.serverStart)/1000);T._richView(at);ad.buildEnd=ad.contentStart=new Date().getTime();T._logger.log("Build view: "+(ad.buildEnd-ad.buildStart)/1000);if(!UWA.is(T.navigation)){T.navigation=new U({mediator:T.mediator,selector:T.container+" .rich-container",preview:T.container,context:T.context}).inject(T.container+" .navigation-panel .syc-panel-tab-contents")}T.idcard.updateSelection()}if(!!widget.getPreference("trm_richview_optimizedloading").value){setTimeout(function(){window.requestAnimationFrame(function(){au()})},500)}else{au()}ar()},onFailure:function(au,at){T.mediator.publish("onNotification",{className:"error",message:f.RichView_Notif_FatalError})}});function ar(){T.utilities.loading();function at(){var av=0;var au="";l.getContentWithStreaming({id:aq,onComplete:function(ax){if(!!widget.getPreference("trm_richview_optimizedloading").value){window.requestAnimationFrame(function(){T.processLoadedContentChunk(ax)})}else{T.processLoadedContentChunk(ax)}ad.globalEnd=ad.contentEnd=new Date().getTime();T._logger.log("Content: "+(ad.contentEnd-ad.contentStart)/1000);T._logger.log("Time global: "+(ad.globalEnd-ad.globalStart)/1000);T.utilities.loading(true);T.mediator.publish("onNotification",{className:"success",message:f.RichView_Notif_StructureLoaded});T.mediator.publish("onScroll",{position:0});var aw={paths:[[T.options.data]],attributes:{}};aw.attributes[T.options.data]={tenant:k.getTenant()};T._padCommandProxy.select(aw);T._reqCommandProxy.refreshRV()},onFailure:function(ax,aw){T.mediator.publish("onNotification",{className:"error",message:f.RichView_Notif_FatalError})},onProgress:function(aw){if(!widget.getPreference("trm_richview_optimizedloading").value){var ay=aw.currentTarget;if(ay.readyState!==2&&ay.readyState!==3&&ay.readyState!==4){return}if(ay.readyState===3&&ay.status!==200){return}if(ax===undefined){var ax=ay.response.slice(av)}else{ax+=ay.response.slice(av)}av=ay.response.length;ax=T.processLoadedContentChunk(ax)}}})}at()}},processLoadedContentChunk:function(aw){if(aw.indexOf(T._DELIMITER)===-1){return}var ax=aw.split(T._DELIMITER);var au=0;for(var at=0;at<ax.length-1;at++){au+=ax[at].length+1;ad.before=new Date().getTime();var av=JSON.parse(ax[at]);for(var ar=0;ar<av.length;ar++){var aq=T.options.model.getNodesByMatrixID(av[ar].id);aq.forEach(function(aB){var aA="";var az=aB.getRichViewElement();if(aB.options.externalObject){aA="[ "+f.ExternalObject_DisplayContent+" ]";av[ar].editable=false;az.content[0].addEventListener("click",function(aC){T.getProxyContentData(this,aC)})}else{aA=T.utilities.decodeHtml(av[ar].content)}var ay=w(az.container).find("#"+az.id+"_content");if(ay.length>0&&ay.html()!==aA){az.update({content:aA,editable:av[ar].editable,isDocx:av[ar].isDocx,underCA:av[ar].underCA,changeid:av[ar].changeid})}})}ad.after=new Date().getTime();T._logger.log("One array content: "+(ad.after-ad.before)/1000)}aw=aw.slice(au);return aw},_scrollView:function(){if(T.scroller){return true}var at=false;var aq=function(aw,av,au,ax){if(!at){at=true;setTimeout(function(){T._currentPosition=Math.abs(parseInt(w(T.scroller.elements.yScrollbar).css("top"),10));T.mediator.publish("onScroll",{position:T._currentPosition});at=false},100)}};var ar={scroll:aq.bind(this)};T.scroller=new ae({element:UWA.Element.getElement.call(document,T.container+" .richview-editor-content")}).inject(UWA.Element.getElement.call(document,T.container+" .richview-editor-container"),"top");T.scroller.elements.content.addEvents(ar)},_richView:function(aw){var ax=w(".scroller-content",this.contentPanel).length>0?w(".scroller-content",this.contentPanel):this.richViewEditorContent;if(aw.length===0){ax.empty();this._generateFakeContainer()}ag.process.streaming({root_node:T.options.model.getRoots()[0],data:aw,tenant:k.getTenant()},this.externalTypes);T.options.model.sortInTreeOrder(T.options.model.getRoots());var at=T.options.model.getRoots()[0].getAllDescendants();for(var ar=0;ar<aw.length;ar++){var av=at[ar];var au=aw[ar];au.objectId=au.id;au.physicalId=au.physicalid;au.id=F();au.content=T.utilities.decodeHtml(au.content!==undefined?au.content:"Loading...");au.title=T.utilities.decodeHtml(au.title||au["attribute[Title]"]);var aq=UWA.is(au.type,"object")?au.type["value"]:au.type;var ay=au["type.kindof"];if(this._isContainer(aq)||this._isContainer(ay)){ax.append(this._richContainer(au,av))}else{if(this._isRich(aq)||this._isRich(ay)){ax.append(this._richObject(au,av))}}}if(UWA.is(T.eventInit)&&T.eventInit){T.options.model.getModelEvents().publish({event:"setPathTags",context:T.options.model})}else{setTimeout(function(){T.options.model.getModelEvents().publish({event:"setPathTags",context:T.options.model})},1000)}X.unmask(UWA.Element.getElement.call(document,".main-panel"))},_generateFakeContainer:function(){var aq=w(".scroller-content",this.contentPanel).length>0?w(".scroller-content",this.contentPanel):this.contentPanel;L=true;this.fakeContainer=new aj({mediator:T.mediator,id:F(),objectId:T.options.data,physicalId:T.options.data,type:T.options.parentType,kindof:T.options.parentType,title:f.RichView_Tooltip_NoObjects,index:"",connection:"",connectionId:"",level:1,editable:"false",droppable:{Chapter:"over",Comment:"over",Requirement:"over","text/plain":"before,after,over","text/html":"before,after,over","text/searchitems":"before,after,over",Text:"before,after,over"},context:T.context,fake:true}).create();this.fakeContainer.container.addClass("fake-rich-container");aq.append(this.fakeContainer.container);this.fakeContainer.container.find(".rich-container-title-index").click()},_richContainer:function(at,aw){var aq=parseInt(at.level);if(aq<ac){for(var au=0;au<Object.keys(N).length;au++){if(Object.keys(N)[au]>aq){N[Object.keys(N)[au]]=0}}N[ac]=0;ac=aq}if(N[aq]===undefined){N[aq]=1}else{N[aq]+=1}ac=aq;var ay="";for(var av=1;av<aq;av++){ay+=N[av]+"."}at.title=at.title!==""?at.title:at.name;var ar=UWA.is(at.type,"object")?at.type["value"]:at.type;var az=at["type.kindof"];var ax=new aj({model:T.options.model,node:aw,rootId:T.rootId,mediator:T.mediator,id:at.id,objectId:at.objectId,physicalId:at.physicalId,type:ar,kindof:az,title:at.title,index:ay+N[aq],connection:at["type[connection]"],connectionId:at["physicalid[connection]"],parentId:at["from.physicalid[connection]"],level:at.level,droppable:T.options.droppable[ar]!==undefined?T.options.droppable[ar]:T.options.droppable[az],context:T.context}).create();return ax.container},_richObject:function(au,aw){au.parentId=au["from.physicalid[connection]"];var at=T._generateObjectIdx(aw);au.title=au.title!==""?au.title:au.name;var aq=UWA.is(au.type,"object")?au.type["value"]:au.type;var ar=au["type.kindof"];var av=new b({model:T.options.model,node:aw,rootId:T.rootId,mediator:T.mediator,id:au.id,objectId:au.objectId,physicalId:au.physicalId,type:aq,kindof:ar,title:au.title,index:at.index,containerIdx:at.containerIdx,content:au.content,connection:au["type[connection]"],connectionId:au["physicalid[connection]"],parentId:au.parentId,level:au.level,droppable:T.options.droppable[aq]!==undefined?T.options.droppable[aq]:T.options.droppable[ar],fetchContent:au.fetchContent!==undefined?au.fetchContent:false,context:T.context}).create();return av.container},_selectionMgt:function(at,aq){var aw=T.options.model.getSelectedNodes();var av=w(at).parents(aq+":first");if(aw.length>0){var ar=av.data("relid");var ax=aw[0].getRelationID();var au=T.options.model.getNodesByRelId(ar);if(ar===ax){au[0].unselect();av.toggleClass("active",false);T.mediator.publish("onUnselect:object",av);T.onCleanSelection(false)}else{if(!av.hasClass("fake-rich-container")){T.contentPanel.find('[data-relid="'+ax+'"]').toggleClass("active",false);T.options.model.unselectAll();au[0].select();T.onInnerSelection(au[0])}av.toggleClass("active",true)}}else{var ar=av.data("relid");var au=T.options.model.getNodesByRelId(ar);au[0].select();av.toggleClass("active",true);T.onInnerSelection(au[0])}},_attachControls:function(){this.contentPanel.on("click",".rich-container-title-index,.rich-container-info",function(aq){T._selectionMgt(this,".rich-container")});this.contentPanel.on("click",".rich-object-info,.rich-object-container-index,.rich-object-index",function(aq){T._selectionMgt(this,".rich-object")});this.contentPanel.on("click",".collapsable-container",function(at){T._logger.log("Click",at);var au=w(this).parents(".rich-container:first"),ax=au.attr("id"),aw=parseInt(au.data("level"));if(V[ax]===undefined||V[ax]===false){w(".fonticon",this).removeClass("fonticon-minus-squared").addClass("fonticon-plus-squared");V[ax]=true}else{w(".fonticon",this).removeClass("fonticon-plus-squared").addClass("fonticon-minus-squared");V[ax]=false}var av=au.nextAll();for(var ar=0;ar<av.length;ar++){var aq=av.eq(ar);if(aq.hasClass("rich-object")&&(parseInt(aq.data("level"))>aw)){if(V[ax]){aq.addClass("collapsed-object")}else{aq.removeClass("collapsed-object")}}else{if(aq.hasClass("rich-container")&&parseInt(aq.data("level"))>aw){if(V[ax]){aq.addClass("collapsed-object")}else{aq.removeClass("collapsed-object")}}else{break}}}})},_startEdition:function(){T._objectRichEditor=new q({mediator:T.mediator,selector:".rich-object",target:".content-data",commandProxy:T._padCommandProxy,reqCommandProxy:T._reqCommandProxy,richView:T});T._containerRichEditor=new q({mediator:T.mediator,selector:".rich-container",target:".rich-container-title-editable",commandProxy:T._padCommandProxy,reqCommandProxy:T._reqCommandProxy,richView:T});T._objectTitleRichEditor=new q({mediator:T.mediator,selector:".rich-object",target:".rich-object-title-editable",commandProxy:T._padCommandProxy,reqCommandProxy:T._reqCommandProxy,richView:T});T._objectRichEditor.startEditionForAll();T._containerRichEditor.startEditionForAll();T._objectTitleRichEditor.startEditionForAll()},updateRichContent:function(aq){T._objectRichEditor.updateHtmlContent(aq)},_navigationPanel:function(){var aq=new ak(0.2,w(this.richView).width(),this.options.height,"left");aq.contents.style.overflowY="hidden";var ar=aq.createTab("navigationMaintab");ar.setIconClassName("fonticon fonticon-list");if(this.navigationPanel.append){this.navigationPanel.append(aq.container)}aq.container.addEventListener("syc-panel-resize",function(){T._resizeContentPanel();widget.setValue("trm_navigation_open",T.navigationPanel.isVisible())});this.navigationPanel=aq;this._resizeContentPanel();if(!widget.getValue("trm_navigation_open")){widget.addPreference({name:"trm_navigation_open",type:"hidden",defaultValue:false})}if(widget.getValue("trm_navigation_open")===true&&this.navigationPanel.isVisible()===false){this.navigationPanel.open();this._resizeContentPanel()}else{if(widget.getValue("trm_navigation_open")===false&&this.navigationPanel.isVisible()===true){this.navigationPanel.close();this._resizeContentPanel()}}},_resizeContentPanel:function(){var at=this.contentPanel,aq=this.navigationPanel;if(aq&&aq.isVisible){var ar=aq.isVisible()===false?0:aq.size;at.css("margin-left",ar+W)}},_isContainer:function(aq){if(this.options.container.indexOf(aq)>=0){return true}return false},_isRich:function(aq){if(this.options.rich.indexOf(aq)>=0){return true}return false},_plainTextFromHtml:function(aq){var ar=document.createElement("div");ar.innerHTML=aq;return ar.textContent||ar.innerText},setTraceabiltyScope:function(ar,aq){this._traceabilityScope.id=ar;this._traceabilityScope.title=aq},getTraceabilityScope:function(){return this._traceabilityScope},getRootId:function(){return T.rootId},getSelectedElement:function(){return this.current_selection},getSelectedNodes:function(){return T.options.model.getSelectedNodes()},getSecurityContext:function(){return{SecurityContext:k.getSecurityContext()}},getPADTreeDocument:function(){return T.options.model},beginBlockingTransaction:function(aq){if(UWA.is(T.current_selection.element)){X.mask(UWA.Element.getElement.call(T.current_selection.element.parent()[0],"#"+T.current_selection.element.attr("id")))}},endBlockingTransaction:function(aq){if(UWA.is(T.current_selection.element)){X.unmask(UWA.Element.getElement.call(T.current_selection.element.parent()[0],"#"+T.current_selection.element.attr("id")))}},refreshOnCreate:function(at,av){var aw=false;if(UWA.is(at.type)&&UWA.is(at["type.kindof"])){var au=UWA.is(at.type,"object")?at.type["value"]:at.type;var ar=at["type.kindof"];if(au===T.options.root||ar===T.options.root){aw=true}}if(aw===true){var aq=at.physicalid;this.options.data=aq;ag.process.root({treedocument:T.options.model,data:at,tenant:k.getTenant()},this.externalTypes);this._curentlyLoadingReqSpec=false;if(UWA.is(this.dropinvit)&&w(".richview_main_container").size()>0){this.dropinvit.remove();this._init()}else{T.utilities.saveObject(aq);T._onWidgetRefresh()}if(av===true){T._reqCommandProxy.drop({id:aq,appId:widget.getValue("appId"),widgetId:widget.id,action:"new"})}}else{T.displayNotification({eventID:"warning",msg:f.RichView_Notif_NotAuthorized})}},refreshOnInsert:function(aq,ar,at){this.authoring._refreshOnInsert(aq,ar,null,true,at)},refreshOnRemove:function(av,aq){var aw=av.element;var ar=T.options.model.getNodesByElementID(aw.attr("id"))[0];var at=ar.getAllDescendants();if(UWA.is(at)&&at.length>0){for(var ax=0;ax<at.length;ax++){var az=at[ax];var au=az.getRichViewElement();au.container.remove();az.remove()}}aw.remove();ar.unselect();ar.remove();var aA=av.path;T.onCleanSelection(false);T.mediator.publish("onRefresh");if(aq===true){T._reqCommandProxy.detach({appId:widget.getValue("appId"),path:aA})}T.options.model.getModelEvents().publish({event:"setPathTags",context:T.options.model});var ay=w(".rich-container,.rich-object:not(.placeholder)");if(ay.length===0){widget.dispatchEvent("onRefresh")}},authoring:{insertWithPromise:function(at){var aq=T.authoring.placeholder(at);T._promisesData.push(aq);T._promises.push(ar);function ar(){var av=T._promisesData.shift(),aw=T.authoring.insert(av);return aw}function au(){var av=R.resolve();T._promises.forEach(function(aw){av=av.then(ar)});return av}au()},placeholder:function(az){var aq=F();var aF=new b({id:aq+"_placeholder",title:'<span class="fonticon fonticon-dot-3"></span>',content:az.content,droppable:T.options.droppable[az.type]!==undefined?T.options.droppable[az.type]:T.options.droppable[az.kindof],placeholder:true}).create();if(L===true){az.position="over"}var aG=undefined;var ay=undefined;if(UWA.is(az.target.element)){var aB=T.options.model.getNodesByElementID(az.target.element.attr("id"))[0];var aC=az.target.element;if(az.position!=="over"){aG=aB.getParent()}else{aG=aB}aG=aG.getRichViewElement()}else{aG={type:T.options.model.getRoots()[0].options.type,objectId:T.options.model.getRoots()[0].getID(),kindof:T.options.model.getRoots()[0].options.kindof}}if(!UWA.is(aG)){aG={type:T.options.model.getRoots()[0].options.type,objectId:T.options.model.getRoots()[0].getID(),kindof:T.options.model.getRoots()[0].options.kindof}}az.relationship=T.options.relationship[aG.type]||T.options.relationship[aG.kindof];switch(az.position){case"before":az.target.element.before(aF.container);var at=T.options.model.getNodesByElementID(az.target.element.attr("id"))[0];az.nextSibling={id:at.getID(),relId:at.getRelationID()};var aD=at.getPreviousBrother();if(!UWA.is(aD)){az.previousSibling={}}else{az.previousSibling={id:aD.getID(),relId:aD.getRelationID()}}ay=at.getLevel();break;case"after":var aD=T.options.model.getNodesByElementID(az.target.element.attr("id"))[0];var aw=aD.getAllDescendants();var av=aD.getRichViewElement().container;if(UWA.is(aw)&&aw.length>0){var aA=aw.length;av=aw[aA-1].getRichViewElement().container}av.after(aF.container);az.previousSibling={id:aD.getID(),relId:aD.getRelationID()};var at=aD.getNextBrother();az.nextSibling={};if(UWA.is(at)){az.nextSibling={id:at.getID(),relId:at.getRelationID()}}ay=aD.getLevel();break;case"over":if(!UWA.is(az.target.element)){var aH=w(".rich-container,.rich-object:not(.placeholder)");if(aH.size()>0){az.target.element=aH.eq(aH.size()-1)}az.target.element.after(aF.container);ay=1}else{var aE=T.options.model.getNodesByElementID(az.target.element.attr("id"))[0];var au=aE.getChildren();var ax=az.target.element;if(UWA.is(au)&&au.length){var ar=au[au.length-1];ax=ar.getRichViewElement().container;var aw=ar.getAllDescendants();if(UWA.is(aw)&&aw.length>0){var ar=aw[aw.length-1];ax=ar.getRichViewElement().container}}ax.after(aF.container);ay=aE.getLevel()+1;az.previousSibling={};az.nextSibling={};if(L===true){aG={type:T.options.model.getRoots()[0].options.type,objectId:T.options.model.getRoots()[0].getID(),kindof:T.options.model.getRoots()[0].options.kindof};ay=1}}break}X.mask(UWA.Element.getElement.call(az.target.element.parent()[0],"#"+aq+"_placeholder"));az.parent=aG;az.newLevel=ay;az.placeholder=aF;return az},insert:function(ar){switch(ar.operation){case"insertNew":var aq=[];if(ar.hasOwnProperty("content")){aq.push({name:"Content Data",value:UWA.Utils.base64Encode(T.utilities.jsonEscape(ar.content))},{name:"Content Type",value:ar.contentType},{name:"Content Text",value:UWA.Utils.base64Encode(T._plainTextFromHtml(ar.content))})}return new R(function(au,at){l.insertNew({securityContext:k.getSecurityContext(),type:ar.type,json:{pid:ar.parent.objectId,relationship:ar.relationship,previousSibling:ar.previousSibling,nextSibling:ar.nextSibling,attributes:aq},onComplete:function(av){av=UWA.is(av,"string")?JSON.parse(av):av;var ax=av.results;ax.objectId=ax.id;ax.physicalId=ax.physicalid;ax.id=F();ax.level=ar.newLevel;ax.content=ar.content;ax.fetchContent=false;if(UWA.is(ax["attribute[Title]"])){ax.title=ax["attribute[Title]"]}else{ax.title=""}T.authoring._refreshOnInsert(ax,ar,ar.placeholder,true);var aw=UWA.is(ax.type,"object")?ax.type["displayName"]:ax.type;var ay=aw+" "+ax.name+" "+ax.revision;var az=f.RichView_Notif_ObjectCreated;az=az.replace("{TNR}",ay);T.mediator.publish("onNotification",{className:"success",message:az});au("OK")},onFailure:function(av){T.mediator.publish("onNotification",{className:"error",message:av.message});ar.placeholder.container.remove();at()}})});case"insertExisting":l.insertExisting({securityContext:k.getSecurityContext(),json:{pid:ar.parent.objectId,id:ar.objectId,relationship:ar.relationship,previousSibling:ar.previousSibling,nextSibling:ar.nextSibling},onComplete:function(at){at=UWA.is(at,"string")?JSON.parse(at):at;var av=at.results;av.objectId=av.id;av.physicalId=av.physicalid;av.id=F();av.level=ar.newLevel;av.content=ar.content;av.fetchContent=ar.fetchContent;if(UWA.is(av["attribute[Title]"])){av.title=av["attribute[Title]"]}else{av.title=""}T.authoring._refreshOnInsert(av,ar,ar.placeholder,true);var au=UWA.is(av.type,"object")?av.type["displayName"]:av.type;var aw=au+" "+av.name+" "+av.revision;var ax=f.RichView_Notif_ObjectInserted;ax=ax.replace("{TNR}",aw);T.mediator.publish("onNotification",{className:"success",message:ax})},onFailure:function(at){T.mediator.publish("onNotification",{className:"error",message:at.message});ar.placeholder.container.remove()}});break}},_refreshOnInsert:function(aw,ax,aD,at,aB){if(!UWA.is(aw.level)){aw.level=ax.newLevel}var az=T.options.model.getRoots();var au=ag.process.createNode({data:aw,tenant:k.getTenant()},T.externalTypes);if(UWA.is(ax.parent.id)&&ax.parent.id!==""){az=T.options.model.getNodesByElementID(ax.parent.id)}az[0].addChild(au);T.options.model.sortInTreeOrder(az);var aA;if(!UWA.is(aD)){aD=ax.placeholder;aA=ax.position;aw.objectId=aw.id;aw.physicalId=aw.physicalid;aw.id=F();aw.level=ax.newLevel;aw.content=ax.content;if(UWA.is(aB)&&aB==="insertExisting"){ax.fetchContent=true}aw.fetchContent=UWA.is(ax.fetchContent)?ax.fetchContent:false;if(UWA.is(aw["attribute[Title]"])){aw.title=aw["attribute[Title]"]}else{aw.title=""}}if(!UWA.is(ax.path)){if(ax.target.element.hasClass("fake-rich-container")){ax.path=[T.rootId,aw["physicalid[connection]"],aw.physicalId]}else{ax.path=az[0].getOccurencePath()}}if(at!==false){T._reqCommandProxy.attach({path:ax.path,object:aw,selection:T.getSelectedNodes()[0].getOccurencePath(),mode:(aA==="after")?"append":"insert"})}var aC=false;var ay=null;var av=false;var ar=UWA.is(aw.type,"object")?aw.type["value"]:aw.type;var aE=aw["type.kindof"];if(T._isContainer(ar)||T._isContainer(aE)){ay=T._richContainer(aw,au);aC=true;av=false}else{if(T._isRich(ar)||T._isRich(aE)){if(au.options.externalObject){aw.fetchContent=false}ay=T._richObject(aw,au);aC=false;av=true}}if(au.options.externalObject){var aq=au.getRichViewElement();aq.update({content:"[ "+f.ExternalObject_DisplayContent+" ]",editable:false,isDocx:true});aq.content[0].addEventListener("click",function(aF){T.getProxyContentData(this,aF)})}aD.container.after(ay);aD.container.remove();if(L===true){T.fakeContainer.container.remove();aC=true;L=false}ay.find(".rich-object-info").removeClass("highlight-operation").addClass("highlight-creation",1000,"swing",function(){w(this).removeClass("highlight-creation",1000,"swing")});setTimeout(function(){if(au.options.externalObject){var aF=au.getRichViewElement();aF.info.click()}else{if(av===true){ay.find(".content-data").focus()}else{ay.find(".rich-container-title-editable").focus()}}T.onInnerSelection(au,true)},100);T.mediator.publish("onRefresh",{level:parseInt(au.getRichViewElement().level)});T.scroller.scrollToElement("#"+ay.attr("id"),"center");T.mediator.publish("onScroll",{position:T._currentPosition});T.options.model.getModelEvents().publish({event:"setPathTags",context:T.options.model});if(UWA.is(aB)&&aB==="insertExisting"&&!au.options.externalObject){l.getStructureWithStreaming({id:aw.physicalid,onComplete:function(aG){var aL=UWA.is(aG,"string")?JSON.parse(aG):aG;ag.process.streaming({root_node:au,data:aL,tenant:k.getTenant()},T.externalTypes);T.options.model.sortInTreeOrder(T.options.model.getRoots());var aI=au.getAllDescendants();var aM=w(".scroller-content",T.contentPanel).length>0?w(".scroller-content",T.contentPanel):T.contentPanel;for(var aH=0;aH<aL.length;aH++){var aK=aI[aH];var aJ=aL[aH];aJ.objectId=aJ.id;aJ.physicalId=aJ.physicalid;aJ.id=F();aJ.content="Loading...";aJ.fetchContent=true;aJ.title=T.utilities.decodeHtml(aJ.title||aJ["attribute[Title]"]);aJ.level=parseInt(aJ.level)+parseInt(aw.level);var aF=UWA.is(aJ.type,"object")?aJ.type["value"]:aJ.type;if(T._isContainer(aF)||T._isContainer(aJ["type.kindof"])){aM.append(T._richContainer(aJ,aK))}else{if(T._isRich(aF)||T._isRich(aJ["type.kindof"])){aM.append(T._richObject(aJ,aK))}}}T.mediator.publish("onRefresh");T.scroller.scrollToElement("#"+ay.attr("id"),"center");T.mediator.publish("onScroll",{position:T._currentPosition});T.options.model.getModelEvents().publish({event:"setPathTags",context:T.options.model})},onFailure:function(aG,aF){},onTimeout:function(){}})}},reorder:function(aQ){T.utilities.loading();var aE=aQ.source.element,aP=aQ.target.element,at=aQ.source.id,ay=aQ.target.id,aA=aQ.source.element.prev();var aM=T.options.model.getNodesByElementID(aQ.source.id)[0];var aO=aM.getAllDescendants();var aJ=new Array();aJ.push(aM.getRichViewElement().container);for(var aH=0;aH<aO.length;aH++){var ax=aO[aH];aJ.push(ax.getRichViewElement().container);ax.getRichViewElement().container}var aD=T.options.model.getNodesByElementID(aQ.target.id)[0];if(aD.getOccurencePath().indexOf(aM.getOccurencePath()[aM.getOccurencePath().length-1])>-1){T.displayNotification({eventID:"error",msg:f.RichView_Notif_FailureAndRollback});T.utilities.loading(true);return}var aK=undefined;if(aQ.position==="over"){aK=aD}else{aK=aD.getParent()}var aG={};var aq=undefined;var aB={};var aw=undefined;if(aQ.position==="after"){aq=aD;aG={id:aq.getID(),relid:aq.getRelationID()};aw=aD.getNextBrother();if(UWA.is(aw)){aB={id:aw.getID(),relid:aw.getRelationID()}}}else{if(aQ.position==="before"){aw=aD;aB={id:aw.getID(),relid:aw.getRelationID()};aq=aD.getPreviousBrother();if(UWA.is(aq)){aG={id:aq.getID(),relid:aq.getRelationID()}}}}switch(aQ.position){case"before":aQ.target.element.before(aJ);break;case"after":var aI=aD.getChildren();if(UWA.is(aI)&&aI.length>0){var au=aI.length;var aC=aI[au-1];var aL=aC.getAllDescendants();if(aL.length>0){var az=aL.length;aC=aL[az-1]}aC.getRichViewElement().container.after(aJ)}else{aD.getRichViewElement().container.after(aJ)}break;case"over":var aF=aK.getChildren();if(UWA.is(aK.getChildren())&&aF.length>0){var ar=aF.length;var av=aF[ar-1];var aN=av.getAllDescendants();if(aN.length>0){var az=aN.length;av=aN[az-1]}av.getRichViewElement().container.after(aJ)}else{aK.getRichViewElement().container.after(aJ)}break}T.scroller.scrollToElement("#"+at,"center");l.reorder({securityContext:k.getSecurityContext(),json:{dataArray:[{object:{id:aM.getID(),rootId:T.options.model.getRoots()[0].getID(),position:{previousSibling:aG,nextSibling:aB}},old:{id:aM.getParent().getID(),relid:aM.getRelationID()},newParentId:aK.getID()}]},onComplete:function(aV){var a1=UWA.is(aV,"string")?JSON.parse(aV):aV;var aW=a1.results.resultArray[0];var a0=aM.getParent().getOccurencePath();var aZ=aK.getOccurencePath();T._reqCommandProxy.reorder({appId:widget.getValue("appId"),id:aM.getID(),old_position:{id:aM.getParent().getID(),relid:aM.getRelationID(),path:a0},new_position:{id:aW["from.physicalid[connection]"],relid:aW["physicalid[connection]"],reltype:aW["type[connection]"],path:aZ,treeOrder:aW["attribute[TreeOrder]"]}});if(aM.getParent().getID()===aK.getID()){aM.setRelationOrder(parseFloat(aW["attribute[TreeOrder]"]));T.options.model.sortInTreeOrder([aK])}else{T.options.model.reparentNode(aM,aM.getParent(),aK,parseFloat(aW["attribute[TreeOrder]"]),aW["physicalid[connection]"],aW["type[connection]"])}var aY=aM.getRichViewElement();aY.update({connectionId:aM.getRelationID(),connection:aM.getRelationType(),parentId:aM.getParentID(),level:aM.getLevel()});for(var aS=0;aS<aO.length;aS++){var aX=aO[aS].getRichViewElement();aX.update({level:aO[aS].getLevel()})}for(var aU=0;aU<aJ.length;aU++){var aT=aJ[aU];aT.find(".rich-object-info").removeClass("highlight-operation").addClass("highlight-creation",1000,"swing",function(){w(this).removeClass("highlight-creation",1000,"swing")});X.unmask(UWA.Element.getElement.call(aT.parent()[0],"#"+aT.attr("id")))}T.mediator.publish("onRefresh");T.utilities.loading(true);var aR=".rich-object";if(aY.container.hasClass("rich-container")){aR=".rich-container"}T._selectionMgt(aY.header,aR);T.displayNotification({eventID:"success",msg:f.RichView_Notif_OperationSucceeded})},onFailure:function(aT){T.scroller.scrollToElement("#"+aA.attr("id"),"center");for(var aS=0;aS<aJ.length;aS++){aJ[aS].detach()}aA.after(aJ);for(var aS=0;aS<aJ.length;aS++){var aR=aJ[aS];aR.find(".rich-object-info").removeClass("highlight-operation").addClass("highlight-fail",1000,"swing",function(){w(this).removeClass("highlight-fail",1000,"swing")});X.unmask(UWA.Element.getElement.call(aR.parent()[0],"#"+aR.attr("id")))}T.mediator.publish("onRefresh");T.utilities.loading(true);T.displayNotification({eventID:"error",msg:f.RichView_Notif_FailureAndRollback})},onTimeout:function(){T.scroller.scrollToElement("#"+aA.attr("id"),"center");for(var aS=0;aS<aJ.length;aS++){aJ[aS].detach()}aA.after(aJ);for(var aS=0;aS<aJ.length;aS++){var aR=aJ[aS];aR.find(".rich-object-info").removeClass("highlight-operation").addClass("highlight-fail",1000,"swing",function(){w(this).removeClass("highlight-fail",1000,"swing")});X.unmask(UWA.Element.getElement.call(aR.parent()[0],"#"+aR.attr("id")))}T.mediator.publish("onRefresh");T.utilities.loading(true);T.mediator.publish("onNotification",{className:"error",message:f.RichView_Notif_FailureAndRollback})}})}},shortcuts:null,utilities:{useCompassContent:function(){var av=(typeof(widget.getValue("X3DContentId"))!=="undefined")?JSON.parse(widget.getValue("X3DContentId")):null;if(av!==null){var at=av.data;if(at!==null){var ar=at.items.length;var au=[];if(ar>0){var aq=at.items[0].objectId;if(UWA.is(aq)){T._logger.log("3DCompass content has been detected: ",aq);return aq}}}}},reloadSaveObject:function(){if(!widget.getValue("custo_root_pid")){widget.addPreference({name:"custo_root_pid",type:"hidden",defaultValue:""})}else{var aq=widget.getValue("custo_root_pid");if(UWA.is(aq)){T._logger.log("Saved Object has been detected: ",aq);return aq}}},saveObject:function(aq){T._logger.log("Save Object to widget preferences: ",aq);if(!widget.getValue("custo_root_pid")){widget.addPreference({name:"custo_root_pid",type:"hidden",defaultValue:""})}widget.setValue("custo_root_pid",aq)},cleanObject:function(){T._logger.log("Clean Object Preferences");widget.setValue("custo_root_pid","");T.options.data=null},cleanWidgetTitle:function(){widget.setTitle("")},jsonEscape:function(aq){return aq.replace(/\n/g,"")},encodeHtml:function(ar){var aq={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return String(ar).replace(/[&<>"'\/]/g,function(at){return aq[at]})},decodeHtml:function(ar){if(!UWA.is(ar)){return""}var aq=document.createElement("textarea");aq.innerHTML=ar;return aq.value},loading:function(at){var aq=d.getMessages(),av=null;for(var ar=0;ar<aq.length;ar++){var au=aq[ar].getElement(".wux-controls-progressbar-linear-subcontainer-lite");if(au){av=aq[ar];break}}if(at&&av){d.options.autoHide=true;d.remove(av);return}else{if(at){d.options.autoHide=true;return}}if(!av){d.options.autoHide=false;T.mediator.publish("onNotification",{className:"primary",message:""});new O({shape:"linear",displayStyle:"lite",infiniteFlag:true,statusFlag:false,emphasize:"info"}).inject(d.elements.container.getElement(".alert-message.alert-primary"))}else{d.remove(av)}},onEndEdit:function(){var aq=self.widget.getPreferences();aq.forEach(function(ar){switch(ar.name){case"req_tenant":T.utilities.updateTenantIndex(ar.value);T._reqCommandProxy.tenantChange({appId:widget.getValue("appId")});break}});T._reqCommandProxy.preferenceModification({preferences:aq,appId:widget.getValue("appId"),widgetId:widget.id})},updatePreferences:function(ar){if(UWA.is(ar)&&UWA.is(ar.appId)&&ar.appId!==widget.getValue("appId")){var aq=ar.preferences;if(UWA.is(aq)&&aq.length>0){aq.forEach(function(at){if(widget.hasPreference(at.name)){widget.setValue(at.name,at.value);T._logger.log("update "+at.name+" preference")}else{if(at.name==="x3dPlatformId"){widget.setValue("req_tenant",at.value);T._logger.log("update req_tenant preference")}else{if(at.name==="pad_security_ctx"){widget.setValue("trm_security_ctx",at.value);T._logger.log("update trm_security_ctx preference")}}}})}}},updateTenantIndex:function(aq){k.setTenantIndex(aq)},setWidgetTitle:function(){l.getInfo({securityContext:k.getSecurityContext(),pid:T.options.data,selectables:"type,name,revision,attribute[Title],type.kindof,current",onComplete:function(aq){aq=UWA.is(aq,"string")?JSON.parse(aq):aq;var ar=aq.results[0];var at="";if(UWA.is(ar["attribute[Title]"])&&ar["attribute[Title]"]!==""){at+=" "+ar["attribute[Title]"]}else{at+=" "+ar.name}self.widget.setTitle(at);T.options.parentType=UWA.is(ar.type,"object")?ar.type["value"]:ar.type;T.options.parentName=ar.name;T.options.parentTitle=ar["attribute[Title]"];T.options.parentKindof=ar["type.kindof"];T.idcard.updateThumbnail(ar["type.kindof"],ar["attribute[Title]"]);T.idcard.updateLifecyle(ar.current["displayName"]);T.options.model.getRoots()[0].options.title=ar["attribute[Title]"]},onFailure:function(aq){}})},refreshAuthoredObject:function(av){if(UWA.is(av.authored)&&UWA.is(av.authored.modified)&&av.authored.modified.length!==0){var aw=av.authored.modified[0];if(typeof aw==="object"&&UWA.is(aw.physicalid)){aw=aw.physicalid}if(aw===T.options.model.getRoots()[0].getID()){T.utilities.setWidgetTitle()}else{l.getInfo({securityContext:k.getSecurityContext(),pid:aw,selectables:"id,physicalid,type,name,revision,attribute[Title],type.kindof",onComplete:function(ay){ay=UWA.is(ay,"string")?JSON.parse(ay):ay;var aB=ay.results[0];var ax=T.options.model.getNodesById(aw);for(var aA=0;aA<ax.length;aA++){var aC=ax[aA];aC.options.title=aB["attribute[Title]"]!==""?aB["attribute[Title]"]:aB.name;var az=aC.getRichViewElement();if(UWA.is(az)){az.update({title:aB["attribute[Title]"]!==""?aB["attribute[Title]"]:aB.name})}}T.idcard.updateSelection()}})}}else{if(UWA.is(av.authored)&&UWA.is(av.authored.deleted)){var ar=av.authored.deleted[0];var aq=T.options.model.getNodesById(ar);for(var at=0;at<aq.length;at++){var au=aq[0];if(au.options.kindof==="Requirement Specification"){T.cleanAll()}else{var av={path:au.getOccurencePath(),appId:"notRichview"};T.utilities.detachObject(av)}}}}},findAndScrollToObject:function(ar){var aq=T.utilities.findObjectElement(ar);if(UWA.is(aq)){if(UWA.is(aq.id)&&UWA.is(aq.element)){T.scroller.scrollToElement("#"+aq.id,"top");if(w(aq.element).hasClass("active")!==true){w(aq.element).find(".rich-container-title-index,.rich-object-info").click()}}}},isSamePath:function(aq,at){if(aq.length!==at.length){return false}for(var ar=0;ar<aq.length;ar++){if(aq[ar]!==at[ar]){return false}}return true},findObjectElement:function(aw){var aA=aw.id,ax=aw.relid,aD=aw.path,ay=null,ar=null;var aq=T.options.model.getNodesById(aA);if(aq.length>0){ay=aq[0].getRichViewElementID();ar=aq[0].getRichViewElement().container;for(var az=0;az<aq.length;az++){var au=aq[az];if(UWA.is(aD)){var aB=au.getOccurencePath();var av=aD;if(av.length>aB.length){var at=av.length-aB.length;av=av.slice(at,av.length-1)}if(T.utilities.isSamePath(av,aB)){ay=au.getRichViewElementID();ar=au.getRichViewElement().container}}else{var aC=au.getRelationID();if(ax===aC){ay=au.getRichViewElementID();ar=au.getRichViewElement().container}}}}return{id:ay,element:ar}},syncViewOnExternalSelection:function(at){if(UWA.is(at.protocol)&&at.protocol==="3DXContent"){if((at.source==="CATTRA_AP"||at.source==="CATSMM_AP")&&widget.getValue("subscribeToTRASelect")==="true"){var aq=at.data.items;if(UWA.is(aq)&&aq.length>0){var ar=aq[0];var av=ar.objectId;T.utilities.findAndScrollToObject({id:av})}}}else{if(UWA.is(at.paths)&&at.paths.lenght>0){var au=at.paths[0];var av=au[au.length-1];T.utilities.findAndScrollToObject({id:av})}}},syncViewOnInternalSelection:function(av){if(UWA.is(av.appId)&&av.appId!==widget.getValue("appId")){if(UWA.is(av.paths)){var aw=av.paths[0];var ar=aw[aw.length-1];var aq=T.options.model.getRoots().length>0?T.options.model.getRoots()[0].getID():"";if(ar!==aq){var au=aw[aw.length-2];l.getKindOf({securityContext:k.getSecurityContext(),pid:ar,onComplete:function(az){var ay=UWA.is(az,"string")?JSON.parse(az):az;var ax=ay.results;if(ax===T.options.root||ax==="DOCUMENTS"){if(w(".richview_main_container").size()>0){T.dropinvit.remove()}T.utilities.saveObject(ar);T._onWidgetRefresh()}else{T.utilities.findAndScrollToObject({id:ar,relid:au,path:aw})}},onFailure:function(ax){T._logger.log(ax)}})}else{if(T.options.model.getSelectedNodes()[0].getID()!==ar){var at=w(".content-panel").find(".rich-object.active,.rich-container.active");at.toggleClass("active",false);T.options.model.unselectAll();T.onCleanSelection(false)}}}}},loadSpec:function(ar){if(UWA.is(ar)){if(UWA.is(ar.appId)&&ar.appId!==widget.getValue("appId")){if(UWA.is(ar.paths)){var aq=ar.paths[0][0];if(aq!==T.rootId){l.getInfo({securityContext:k.getSecurityContext(),pid:aq,selectables:"type,name,revision,type.kindof,attribute[Title],physicalid,id",onComplete:function(ax){var aw=UWA.is(ax,"string")?JSON.parse(ax):ax;var av=aw.results[0];var at=UWA.is(av.type,"object")?av.type["value"]:av.type;var au=av["type.kindof"];T._curentlyLoadingReqSpec=false;if(at===T.options.root||au===T.options.root){T.refreshOnCreate(av,false)}else{T._logger.log("The dropped object is not a "+T.options.root)}},onFailure:function(at){T._logger.log(at)},onTimeout:function(){T._logger.log("RequirementWebServices.getInfo timed out")}})}else{T._curentlyLoadingReqSpec=false}}}}},attachObject:function(aw){T._logger.log("attachObject");var aq=function(aI,aE,aK,aF){if(T.options.model.getRoots().length>0){if(aI===T.options.model.getRoots()[0].getID()){var aD=T.authoring.placeholder({physicalid:ar,type:T.options.model.getRoots()[0].options.type,kindof:T.options.model.getRoots()[0].options.kindof,target:{element:null,id:""},position:aE,content:""});T.authoring._refreshOnInsert(at,aD,null,false,aF)}else{var aG=T.options.model.getNodesById(aI);if(aG.length>0){var az;var aH=aK.slice(0,aK.length-3);if(aE==="over"){az=aK[aK.length-4]}else{az=aK[aK.length-2]}var aJ=null;var aA=null;var aC=null;for(var aB=0;aB<aG.length;aB++){var ay=aG[aB].getOccurencePath();if(aG[aB].getRelationID()===az){aJ=aG[aB].getRichViewElement();aA=aG[aB].getRichViewElementID();aC=aJ.container;break}}if(UWA.is(aA)){var aD=T.authoring.placeholder({physicalid:ar,target:{element:aC,id:aA},position:aE,content:"",type:aJ.type,objectId:aJ.physicalId,kindof:aJ.kindof});T.authoring._refreshOnInsert(at,aD,null,false,aF)}}}}};if(UWA.is(aw)){if(UWA.is(aw.appId)&&aw.appId!==widget.getValue("appId")){var ax=aw.mode,at=aw.object,av=aw.path,ar=av[av.length-1],au;switch(ax){case"insert":au=av[av.length-3];aq(au,"over",av);break;case"insertExisting":au=av[av.length-3];aq(au,"over",av,ax);break;case"append":au=aw.selection[aw.selection.length-1];aq(au,"after",aw.selection);break;case"prepend":au=aw.selection[aw.selection.length-1];aq(au,"before",aw.selection);break;case"appendExisting":au=aw.selection[aw.selection.length-1];aq(au,"after",aw.selection,"insertExisting");break;case"prependExisting":au=aw.selection[aw.selection.length-1];aq(au,"before",aw.selection,"insertExisting");break;default:break}}}},detachObject:function(at){T._logger.log("detachObject");if(UWA.is(at)){if(UWA.is(at.appId)&&at.appId!==widget.getValue("appId")){var aw=at.path;var av=aw[aw.length-1];var aq=aw[aw.length-2];var ar=T.utilities.findObjectElement({id:av,relid:aq,path:aw});if(UWA.is(ar.element)){var au={element:ar.element,path:aw};T.refreshOnRemove(au,false)}}}},reorderObject:function(aW){T._logger.log("reorderObject");if(UWA.is(aW)){if(UWA.is(aW.appId)&&aW.appId!==widget.getValue("appId")){var aY=aW.old_position,aQ=aW.new_position,au=aW.id;var aM=aY.id,az=aY.relid,aA=aY.path,aD=aQ.id,aK=aQ.relid,ax=aQ.relType,aF=aQ.path,aq=aQ.treeOrder;var aG=T.options.model.getNodesByRelId(az);if(aG.length===0){return}aG=aG[0];var av=T.options.model.getNodeByOccurencePath(aA);var aJ=T.options.model.getNodeByOccurencePath(aF);if(!UWA.is(av)){var aT=aA.indexOf(T.rootId);if(aT!=-1){var aw=aA.slice(aT);av=T.options.model.getNodeByOccurencePath(aw)}}if(!UWA.is(aJ)){var aT=aF.indexOf(T.rootId);if(aT!=-1){var aw=aF.slice(aT);aJ=T.options.model.getNodeByOccurencePath(aw)}}if(!UWA.is(av)||!UWA.is(aJ)){return}var aV=aG.getRichViewElement();var aC=aG.getAllDescendants();if(av.getID()===aJ.getID()){aG.setRelationOrder(parseFloat(aq));T.options.model.sortInTreeOrder([aJ])}else{T.options.model.reparentNode(aG,av,aJ,parseFloat(aq),aK,ax)}var aN=new Array();aN.push(aG.getRichViewElement().container);if(UWA.is(aC)&&aC.length>0){for(var aP=0;aP<aC.length;aP++){var aZ=aC[aP];aN.push(aZ.getRichViewElement().container)}}var aO=aG.getNextBrother();var aI=aG.getPreviousBrother();if(UWA.is(aO)){var aL=aO.getRichViewElement().container;aL.before(aN)}else{if(UWA.is(aI)){var at=aI.getAllDescendants();var aX=aI.getRichViewElement().container;if(UWA.is(at)&&at.length>0){var aE=at.length;aX=at[aE-1].getRichViewElement().container}aX.after(aN)}else{if(aG.getParent().isRoot()===true){var aH=w(".scroller-content",T.contentPanel).length>0?w(".scroller-content",T.contentPanel):T.contentPanel;var ar=aH.find(".rich-object, .rich-container");var ay=ar.last();ay.after(aN)}else{var aB=aG.getParent().getRichViewElement().container;aB.after(aN)}}}aV.update({connectionId:aG.getRelationID(),connection:aG.getRelationType(),parentId:aG.getParentID(),level:aG.getLevel()});for(var aS=0;aS<aC.length;aS++){var aR=aC[aS].getRichViewElement();aR.update({level:aC[aS].getLevel()})}T.mediator.publish("onRefresh");T.scroller.scrollToElement("#"+aG.getRichViewElementID(),"center");var aU=".rich-object";if(aV.container.hasClass("rich-container")){aU=".rich-container"}T._selectionMgt(aV.header,aU)}}},reviseObject:function(aq){var ay=function(aL,aH,aN,aI){if(T.options.model.getRoots().length>0){if(aL===T.options.model.getRoots()[0].getID()){var aG=T.authoring.placeholder({physicalid:aw,type:T.options.model.getRoots()[0].options.type,kindof:T.options.model.getRoots()[0].options.kindof,target:{element:null,id:""},position:aH,content:""});T.authoring._refreshOnInsert(az,aG,null,false,aI)}else{var aJ=T.options.model.getNodesById(aL);if(aJ.length>0){var aC;var aK=aN.slice(0,aN.length-3);if(aH==="over"){aC=aN[aN.length-4]}else{aC=aN[aN.length-2]}var aM=null;var aD=null;var aF=null;for(var aE=0;aE<aJ.length;aE++){var aB=aJ[aE].getOccurencePath();if(aJ[aE].getRelationID()===aC){aM=aJ[aE].getRichViewElement();aD=aJ[aE].getRichViewElementID();aF=aM.container;break}}if(UWA.is(aD)){var aG=T.authoring.placeholder({physicalid:aw,target:{element:aF,id:aD},position:aH,content:"",type:aM.type,objectId:aM.physicalId,kindof:aM.kindof});T.authoring._refreshOnInsert(az,aG,null,false,aI)}}}}};var ar=T.options.model.getNodesByRelId(aq.data.old_rel_id)[0];var aA=ar.getNextBrother();var at=ar.getPreviousBrother();T.utilities.detachObject(aq);var av="over",az=aq.data.object,au=aq.newPath,aw=aq.newPath[aq.newPath.length-1],ax;if(UWA.is(aA)){av="before";ax=aA.getOccurencePath()[aA.getOccurencePath().length-1];ay(ax,"before",aA.getOccurencePath(),"insertExisting")}else{if(UWA.is(at)){av="after";ax=at.getOccurencePath()[at.getOccurencePath().length-1];ay(ax,"after",at.getOccurencePath(),"insertExisting")}else{ax=au[au.length-3];ay(ax,"over",au,"insertExisting")}}}},getRichObject:function(ar){var aq=T.options.model.getNodesByElementID(ar);if(aq.length>0&&UWA.is(aq[0].getRichViewElement)){return aq[0].getRichViewElement()}else{return undefined}},getEditMode:function(){return true},_checkIfChangeControlEnabled:function(ar){var aq=false;l.getTRMExpressionValue({expression:"TRM_AuthoringContext_Enabled",securityContext:k.getSecurityContext(),onComplete:function(at){var au=JSON.parse(at).results.value;if(UWA.is(au,"boolean")){aq=au}else{if(UWA.is(au,"string")){if(au==="true"){aq=true}}}ar(aq)},onFailure:function(at){console.error("Could not get change control enabled state: "+at);console.warn("--> Change Control deactivated");ar(aq)},onTimeout:function(){console.error("Could not get change control enabled state: "+error);console.warn("--> Change Control deactivated");ar(aq)}})}});return p});