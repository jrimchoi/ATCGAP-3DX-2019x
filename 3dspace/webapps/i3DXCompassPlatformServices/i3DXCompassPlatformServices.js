define("DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices",[],function(){var e=false,g=[],b=function(j){g.forEach(function(){setTimeout(c,0,j)});callbacks.length=0},i=(function(){var j={};function k(){var l;try{top.document;l=true}catch(m){l=false}return l}return function(m,l){if(!j[m]){if(k()){try{top.require([m],function(o){j[m]=o;l(o)})}catch(n){try{require([m],function(o){j[m]=o;l(o)})}catch(n){l(null)}}}else{try{require([m],function(o){j[m]=o;l(o)})}catch(n){l(null)}}}else{if(j[m]){l(j[m])}}}}()),h=function(j){i("DS/i3DXCompass/i3DXCompassServices",j)},f=function(j){i("DS/i3DXCompass/ServiceApi/GrantedRolesApi",j)},a=function(j){i("DS/i3DXCompass/i3DXCompass",j)};var d={getPlatformServices:function(j){h(function(k){if(k){k.getPlatformServices(j)}else{if(j.onFailure){j.onFailure()}}})},getServiceUrl:function(j){h(function(k){if(k){k.getServiceUrl(j)}else{if(j.onFailure){j.onFailure()}}})},getGrantedRoles:function(j){f(function(k){k.getGrantedRoles(j)})},getPlatformConfig:function(j){h(function(k){if(k){k.getPlatformConfig(j)}else{if(j.onFailure){j.onFailure()}}})},getUser:function(j){h(function(k){if(k){k.getUser(j)}else{if(j.onFailure){j.onFailure()}}})},getAppInfo:function(j){a(function(k){if(k){k.getAppInfo(j)}else{if(j.onComplete){j.onComplete()}}})},getAppsInfo:function(j){a(function(k){if(k){k.getAppsInfo(j)}else{if(j.onComplete){j.onComplete()}}})},_private:{getParentAPI:i}};return d});define("DS/i3DXCompassPlatformServices/OpenWith",["UWA/Core","UWA/Class","UWA/Utils","DS/i3DXCompassServices/i3DXCompassPubSub","DS/i3DXCompass/Tools","DS/i3DXCompass/Data","DS/i3DXCompass/CacheManager","DS/i3DXCompass/Collection/AppList","i18n!DS/i3DXCompassPlatformServices/assets/nls/openWith"],function(g,q,b,d,a,l,s,e,k){var j="open-with",p,o=null,r=[],i=false,m=(function(){var t={};function u(){var v;try{top.document;v=true}catch(w){v=false}return v}return function(w,v){if(!t[w]&&u()){try{top.require([w],function(y){t[w]=y;v(y)})}catch(x){try{require([w],function(y){t[w]=y;v(y)})}catch(x){v(null)}}}else{if(t[w]){v(t[w])}}}}()),h=function(t){m("DS/i3DXCompass/i3DXCompass",t)},n=function(t){m("DS/i3DXCompass/EventManager",t)},f=function(t){m("DS/i3DXCompass/Types",t)};return q.extend({init:function(){this._UID=j+b.getUUID().substr(0,6);this._content=null;this._type=false;p={name:this._UID,fonticon:"export",text:k.OpenWith}},set3DXContent:function(u,t){this._check3DXContentFormat(u);this._content=u;this._type=!!t;return this},setIndex:function(t){this._index=t;return this},render:function(u){var t=this;if(u){this._dropdown=u}if(this._index){p.index=this._index}this._fetchCompatibleApps(function(v){t._appsList=v;t._addSubMenu()});return this},retrieveCompatibleApps:function(v){var t=this,u;this._fetchCompatibleApps(function(w){t.removeParentItemId=true;t._appsList=w;u=t._buildItems();v(u)})},_fetchCompatibleApps:function(t){h(function(u){if(typeof COMPASS_CONFIG!=="undefined"&&COMPASS_CONFIG.myAppsBaseUrl&&!o&&!i){i=true;if(!l.myAppsBaseUrl){l.initialize(COMPASS_CONFIG);s.setup(COMPASS_CONFIG.userId,COMPASS_CONFIG.lang)}o=new e();o.fetch({onComplete:function(){i=false;t(o);_fireCallbacks(o)},onFailure:function(){i=false;g.log("AppList: onFailure")}})}else{if(!i){t(o||u._private._getAppList())}else{r.push(t)}}})},_buildItems:function(){var w=this,t=[],u=this._getCompatibleApps(),v=u.length>4;if(u.length>0){u=u.slice(0,4);u.forEach(function(x){t.push({name:x.get("id"),text:x.get("title"),fonticon:"play",handler:function(){w._launchApp(x)}})});if(v){t.push({name:"more-apps",text:k.moreApps,fonticon:"plus",handler:function(){h(function(x){x._private._setQuadrant("west");x.showAccordion(true)})}})}}return t},_fireCallbacks:function(t){r.forEach(function(u){if(u){setTimeout(u,0,t)}});r.length=0},_addSubMenu:function(){var v=this,u=this._getCompatibleApps(),t;this._dropdown.removeItem(this._dropdown.getItem(v._UID).id);if(u.length>0){this._dropdown.addItem(g.merge(p,{items:[]}));t=this._buildItems();t.forEach(function(x,w){x.parentItemId=v._dropdown.getItem(v._UID).id;v._dropdown.addItem(x)})}else{}},_launchApp:function(v){var t,u=g.clone(this._content.data.items[0]);g.log("_launchApp:"+v.id);g.log("_launchApp:"+this._content);if(this._content){if(g.is(u.objectType,"array")){t=u.objectType.detect(function(w){return v.get("compatibility").indexOf(w)>-1});u.objectType=t}this._setObjectEvents(u)}this._launchAppEvent(v.id)},_setObjectEvents:function(t){d.publish("setObject",t);d.publish("setX3DContent",g.clone(this._content))},_launchAppEvent:function(u){var t=this;if(t._type===true){d.publish("setTypes",t._content);d.publish("setTypesCallback",g.merge({appId:u},t._content));t._type=false}else{d.publish("launchApp",{appId:u},function(v){var w=t._appsList.get(v.appId);g.log(v);if(v.error&&w){h(function(x){x._private._setQuadrant(w.get("quadrant"));x.showAccordion(true);n(function(y){y.dispatchEvent("onShowMessage",k.no_install_compatible);y.dispatchEvent("onHideMessage",5000)})})}})}},_getCompatibleMap:function(){var t=this,u=[];this._appsList.forEach(function(v){if(v.get("compatibility")){v.get("compatibility").forEach(function(x){var w=t._removeFirstDot(x.toLowerCase());if(!u[w]){u[w]=[]}u[w].push(v)})}});return u},_check3DXContentFormat:function(t){if(!t.data&&!t.data.items&&!t.data&&!t.data.items[0]&&!t.data.items[0].objectType){throw new Error("Not good format for 3DXContent")}},_getContentType:function(){var v=this,t=[],u;if(!this._content){throw new Error("A 3DXContent need to be set")}this._check3DXContentFormat(this._content);u=this._content.data.items[0].objectType;if(g.is(this._content.data.items[0].objectTaxonomies,"array")){this._content.data.items[0].objectTaxonomies.forEach(function(w){t.push(v._removeFirstDot(w.toLowerCase()))})}else{if(typeof u==="string"){t.push(this._removeFirstDot(u.toLowerCase()))}else{if(g.is(this._content.data.items[0].objectType,"array")){g.log("Usage of objectType as array is deprecated!, use objectTaxonomies instead");u.forEach(function(w){t.push(v._removeFirstDot(w.toLowerCase()))})}}}return t},_isAvailableAppOnPlatform:function(u){var t=this._content.data.items[0].envId;if(t&&u.get("platforms")&&u.get("platforms").length>0){return u.get("platforms").detect(function(v){return v.id&&v.id.toLowerCase()===t.toLowerCase()})}else{return true}},_getCompatibleApps:function(){var t=this._getCompatibleMap(),u=this;var w=[];this._getContentType().forEach(function(x){if(t[x]){t[x].forEach(function(y){if(u._isAvailableAppOnPlatform(y)){a.pushUnique(w,y)}})}});w.sort(function v(z,y){var B=(z.get("isFavorite")===true?"#":"")+z.get("lowerCaseTitle"),A=(y.get("isFavorite")===true?"#":"")+y.get("lowerCaseTitle"),x=0;if(B<A){x=-1}else{if(B>A){x=1}}return x});return w},_removeFirstDot:function(t){return(t.length&&t[0]===".")?t.slice(1):t}})});