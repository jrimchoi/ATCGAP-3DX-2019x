/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/i3DXPnOAdminUIOrganization/js/DataProxy",["UWA/Class","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(a,c){var b=a.extend({init:function(d){this.setPlatform(d)},setPlatform:function(d){this.platformId=d.platformId;this.baseurl=d["3DSpace"]+"/resources/pno/admin/";this.swymUrl=d["3DSwym"]},});return b});define("DS/i3DXPnOAdminUIOrganization/js/util",[],function(){var a=/[\\*$?"',;\n\r]/;return{hasBadChars:function(b){if(b.search(a)!==-1){return true}return false}}});define("DS/i3DXPnOAdminUIOrganization/js/constants",[],function(){var a={company:"Company",bu:"Business Unit",department:"Department",employee:"Employee",contractor:"Contractor",errorCode:"error_code_",CLOUD_SECURITYCONTEXT:"VPLMAdmin.Company Name.Default",E4ALL_SECURITYCONTEXT:"VPLMAdmin.MyCompany.Default"};return a});define("DS/i3DXPnOAdminUIOrganization/js/Collections/Collection",["UWA/Class/Collection","DS/WAFData/WAFData","DS/i3DXPnOAdminUIOrganization/js/constants"],function(c,a,b){var c=c.extend({setup:function(e,d){this.dataProxy=d.dataProxy},sync:function(f,e,d){d.url=this.url+"?tenant="+this.dataProxy.platformId;if(this.dataProxy.platformId!=="OnPremise"){d.headers={SecurityContext:b.CLOUD_SECURITYCONTEXT}}else{d.headers={SecurityContext:b.E4ALL_SECURITYCONTEXT}}d.ajax=a.authenticatedRequest;this._parent.apply(this,[f,e,d])}});return c});define("DS/i3DXPnOAdminUIOrganization/js/Models/Model",["UWA/Class/Model","DS/WAFData/WAFData","DS/i3DXPnOAdminUIOrganization/js/constants"],function(c,a,b){var c=c.extend({sync:function(f,e,d){d.url=this.url()+"?tenant="+this.collection.dataProxy.platformId;if(this.collection.dataProxy.platformId!=="OnPremise"){d.headers={SecurityContext:b.CLOUD_SECURITYCONTEXT}}else{d.headers={SecurityContext:b.E4ALL_SECURITYCONTEXT}}d.ajax=a.authenticatedRequest;this._parent.apply(this,[f,e,d])}});return c});define("DS/i3DXPnOAdminUIOrganization/js/Models/OrganizationModel",["DS/i3DXPnOAdminUIOrganization/js/Models/Model","DS/WebappsUtils/WebappsUtils"],function(d,b){var a=b.getWebappsAssetUrl("i3DXPnOAdminUIOrganization","img/3DEXLoginCompass.png");var c=d.extend({idAttribute:"pid",defaults:{name:"",type:"",city:"",address:"",stateOrRegion:"",postalCode:"",country:"",description:"",parentName:null,parentType:null,image:a},parse:function(e,f){if(e){return{pid:e.pid,name:e.name,type:e.type,city:e.city,address:e.address,stateOrRegion:e.stateOrRegion,postalCode:e.postalCode,country:e.country,description:e.description,parentName:e.parentName,parentType:e.parentType}}}});return c});define("DS/i3DXPnOAdminUIOrganization/js/Views/ModalOrganizationCreation",["UWA/Class/View","DS/UIKIT/Modal","DS/UIKIT/Form","DS/UIKIT/Input/Button","DS/UIKIT/Alert","DS/i3DXPnOAdminUIOrganization/js/constants","DS/i3DXPnOAdminUIOrganization/js/util","i18n!DS/i3DXPnOAdminUIOrganization/assets/nls/organization"],function(a,f,c,d,b,i,e,h){var g=a.extend({setup:function(j){this.lastOrganizationTypeCreated=i.bu},render:function(){var j=this;var k=this.elements;k.mainAlert=new b({className:"create-alert",closable:true,renderTo:document.body,visible:true,autoHide:true,messageClassName:"error"});k.modal=new f({closable:false,renderTo:document.body,header:h.organization.add_organization+" | "+this.model.escape("name")});k.form=this.buildForm();k.create=new d({value:h.company.create,className:"primary",events:{onClick:function(){if(j.areInputsValid()){j.addOrganization()}}}});k.cancel=new d({value:h.company.cancel,events:{onClick:function(){j.elements.modal.hide();j.resetForm()}}});k.modal.setBody(k.form);k.modal.setFooter([k.create,k.cancel]);return this},destroy:function(){this.stopListening();this._parent()},buildForm:function(){var j=null;if(this.model.get("type")==i.company||this.model.get("type")==i.bu){j=[{label:h.type.Business_Unit,value:i.bu},{label:h.type.Department,value:i.department}]}else{if(this.model.get("type")==i.department){j=[{label:h.type.Department,value:i.department}]}}var l=[{type:"select",name:"type",label:h.company.create_type,options:j},{type:"text",name:"name",label:h.company.create_name,placeholder:h.company.create_name_placeholder},{type:"text",name:"description",label:h.company.create_description,placeholder:h.company.create_description_placeholder},{type:"text",name:"address",label:h.company.create_address,placeholder:h.company.create_address_placeholder},{type:"text",name:"city",label:h.company.create_city,placeholder:h.company.create_city_placeholder},{type:"text",name:"state",label:h.company.create_state,placeholder:h.company.create_state_placeholder},{type:"text",name:"postal_code",label:h.company.create_postal_code,placeholder:h.company.create_postal_code_placeholder},{type:"text",name:"country",label:h.company.create_country,placeholder:h.company.create_country_placeholder}];var k=new c({fields:l});return k},resetForm:function(){this.elements.form.reset();this.elements.form.unvalidate();this.elements.form.getListInput("type").select(this.lastOrganizationTypeCreated)},showModal:function(){this.elements.modal.show()},areInputsValid:function(){var m=this.elements;var l=m.form;var k=l.getTextInput("name");var j=k.getValue();if(j===""){k.getContent().addClassName("has-error");m.mainAlert.add({message:h.get("organization.errorEmptyName")});return false}if(e.hasBadChars(j)){k.getContent().addClassName("has-error");m.mainAlert.add({message:h.get("organization.errorUnauthorizedChars")});return false}return true},addOrganization:function(){var k=this;var j=this.elements.form;this.elements.create.disable();this.elements.cancel.disable();var l={name:j.getValue("name"),description:j.getValue("description"),address:j.getValue("address"),city:j.getValue("city"),stateOrRegion:j.getValue("state"),postalCode:j.getValue("postal_code"),country:j.getValue("country"),type:j.getValue("type"),parentType:this.model.get("type"),parentName:this.model.get("name")};this.collection.create(l,{data:l,wait:true,onComplete:function(){var m=k.elements;m.modal.hide();m.create.enable();m.cancel.enable();k.lastOrganizationTypeCreated=l.type;k.resetForm();m.mainAlert.add({message:h.get("organization.successCreation"),className:"success"})},onFailure:function(m,p){var o=k.elements;o.create.enable();o.cancel.enable();if(p.error){o.form.getTextInput("name").getContent().addClassName("has-error")}var n=p.error?h.get(i.errorCode+p.error.code):h.get("organization.errorCreation");o.mainAlert.add({message:n})}})}});return g});define("DS/i3DXPnOAdminUIOrganization/js/Models/EmployeeModel",["DS/i3DXPnOAdminUIOrganization/js/Models/Model","DS/WebappsUtils/WebappsUtils"],function(d,c){var a=c.getWebappsAssetUrl("i3DXPnOAdminUIOrganization","img/default-employee.png");var b=d.extend({idAttribute:"pid",defaults:{name:"",firstName:"",lastName:"",employmentType:"",image:a},parse:function(f,g){if(f){var e={pid:f.pid,name:f.name,firstName:f.firstName,lastName:f.lastName,employmentType:f.employmentType};if(this.collection.swymUrl){e.image=this.collection.swymUrl+"/api/user/getpicture/login/"+f.name}return e}}});return b});define("DS/i3DXPnOAdminUIOrganization/js/Collections/OrganizationList",["DS/i3DXPnOAdminUIOrganization/js/Collections/Collection","DS/i3DXPnOAdminUIOrganization/js/Models/OrganizationModel"],function(b,c){var a=b.extend({model:c,setup:function(f,d){this._parent(f,d);var e=d.collection_type?d.collection_type:"organizations";this.url=this.dataProxy.baseurl+"organization/"+e;this.state={firstPage:1,currentPage:1,hasNextPage:true,organization:d._modelKey}},fetch:function(d){if(!d.getNextPage){this.state.currentPage=this.state.firstPage;this.state.hasNextPage=true;d.data.pageNumber=this.state.firstPage}else{if(d.getNextPage){this.state.currentPage++;d.data.pageNumber=this.state.currentPage}}this._parent(d)},parse:function(d,e){var f=d.orgs;if(Array.isArray(f)){if(!f.length>0){this.state.hasNextPage=false}}else{this.state.hasNextPage=false}return f},onInfiniteScroll_handler:function(d){var e=this;this.fetch({getNextPage:true,remove:false,onComplete:function(h,f,g){d.endLoading();if(!e.state.hasNextPage){d.useInfiniteScroll(false)}},onFailure:function(){d.endLoading();d.useInfiniteScroll(false)}})}});return a});define("DS/i3DXPnOAdminUIOrganization/js/Models/ParentModel",["DS/i3DXPnOAdminUIOrganization/js/Models/Model"],function(b){var a=b.extend({idAttribute:"pid",parse:function(c,d){if(c){return{pid:c.pid,name:c.name,type:c.type}}}});return a});define("DS/i3DXPnOAdminUIOrganization/js/Collections/EmployeeCollection",["DS/i3DXPnOAdminUIOrganization/js/Collections/Collection","DS/i3DXPnOAdminUIOrganization/js/Models/EmployeeModel"],function(b,c){var a=b.extend({model:c,setup:function(e,d){this._parent(e,d);this.url=this.dataProxy.baseurl+"organization/employees";this.swymUrl=this.dataProxy.swymUrl;this.state={firstPage:1,currentPage:1,hasNextPage:true,organization:d._modelKey}},fetch:function(d){d.data={organization:this.state.organization.get("name")};if(!d.getNextPage){this.state.currentPage=this.state.firstPage;this.state.hasNextPage=true;d.data.pageNumber=this.state.firstPage}else{if(d.getNextPage){this.state.currentPage++;d.data.pageNumber=this.state.currentPage}}this._parent(d)},parse:function(d,e){var f=d.persons;if(Array.isArray(f)){if(!f.length>0){this.state.hasNextPage=false}}else{this.state.hasNextPage=false}return f},onInfiniteScroll_handler:function(d){var e=this;this.fetch({getNextPage:true,remove:false,onComplete:function(h,f,g){d.endLoading();if(!e.state.hasNextPage){d.useInfiniteScroll(false)}},onFailure:function(){d.endLoading();d.useInfiniteScroll(false)}})}});return a});define("DS/i3DXPnOAdminUIOrganization/js/Collections/OrganizationStructureList",["DS/i3DXPnOAdminUIOrganization/js/Collections/OrganizationList"],function(b){var a=b.extend({fetch:function(c){c.data={pid:this.state.organization.get("pid")};this._parent(c)},"onChange:parentName":function(c,d){if(d!==this.state.organization.get("name")){this.remove(c)}}});return a});define("DS/i3DXPnOAdminUIOrganization/js/Collections/ParentCollection",["DS/i3DXPnOAdminUIOrganization/js/Collections/Collection","DS/i3DXPnOAdminUIOrganization/js/Models/ParentModel"],function(b,c){var a=b.extend({model:c,setup:function(e,d){this._parent(e,d);this.url=this.dataProxy.baseurl+"organization/parents";this.state={organization:d._modelKey}},fetch:function(d){d.data={pid:this.state.organization.get("pid"),query:d.query};this._parent(d)},parse:function(d,e){return d.orgs},buildMatchesArray:function(){return this.map(function(d){return{value:d.get("pid"),label:d.get("name"),subLabel:d.get("type")}})}});return a});define("DS/i3DXPnOAdminUIOrganization/js/Collections/CompanyCollection",["DS/i3DXPnOAdminUIOrganization/js/Collections/Collection","DS/i3DXPnOAdminUIOrganization/js/Models/OrganizationModel"],function(a,c){var b=a.extend({model:c,setup:function(e,d){this._parent(e,d);this.url=this.dataProxy.baseurl+"organization/hostcompany"}});return b});define("DS/i3DXPnOAdminUIOrganization/js/Views/OrganizationStructureView",["DS/W3DXComponents/MemberSet","DS/i3DXPnOAdminUIOrganization/js/Views/ModalOrganizationCreation"],function(b,a){var c=b.extend({setup:function(d){this._parent(d);this.creationView=new a({model:this.model,collection:this.collection})},render:function(){this._parent();this.creationView.render().inject(this.container);return this},destroy:function(){this.creationView.destroy();this.creationView=null;this.stopListening();this._parent()},showModal:function(){this.creationView.showModal()}});return c});define("DS/i3DXPnOAdminUIOrganization/js/Views/DetailView",["UWA/Class/Promise","DS/UIKIT/Form","DS/UIKIT/Input/Button","DS/UIKIT/Input/Select","DS/UIKIT/Input/Text","DS/UIKIT/Alert","UWA/Class/View","DS/W3DXComponents/Views/Layout/ScrollView","DS/i3DXPnOAdminUIOrganization/js/constants","DS/i3DXPnOAdminUIOrganization/js/util","i18n!DS/i3DXPnOAdminUIOrganization/assets/nls/organization"],function(j,h,i,a,c,f,b,e,l,g,k){var d=b.extend({tagName:"div",className:"organization-detail",setup:function(m){this._parent(m);this.type=m.type;this.isHostCompany=m.isHostCompany;this.alertMessageBase=this.isHostCompany?"company.":"organization.";this.getIdCardTitleInput=m.getIdCardTitleInput;this.mainAlert=new f({className:"create-alert",closable:true,renderTo:document.body,visible:true,autoHide:true,messageClassName:"error"});this.listenTo(this.model,"onChange",this.render)},destroy:function(){this.mainAlert.destroy();this.mainAlert=null;this.stopListening();this.model=null;this._parent()},render:function(){var q=this;var m=[{type:"text",name:"description",label:k.company.create_description,value:q.model.get("description")},{type:"text",name:"country",label:k.prop_country,value:q.model.get("country")},{type:"text",name:"stateOrRegion",label:k.prop_state_region,value:q.model.get("stateOrRegion")},{type:"text",name:"city",label:k.prop_city,value:q.model.get("city")},{type:"text",name:"postalCode",label:k.prop_postal_code,value:q.model.get("postalCode")},{type:"text",name:"address",label:k.prop_address,value:q.model.get("address")}];if(!this.isHostCompany){m.unshift({type:"autocomplete",name:"parent",placeholder:(q.model.get("parentName"))?q.model.get("parentName"):k.none,datasets:{configuration:{remoteSearchEngine:function(t,u){var s;return new j(function(w,v){q.collection.fetch({reset:true,query:u,onComplete:function(y,x){s={};s.matchingItems=[];if(x){s.matchingItems=q.collection.buildMatchesArray()}s.dataset=t;w(s)},onFailure:function(y,x){x.type="error";x.dataset=t;v(x)}})})}}},label:k.organization.parent,})}var n=new h({fields:m});n.render=function(){};n.container=n.elements.container;var r=new e({view:n,useInfiniteScroll:false,usePullToRefresh:false});if(this.type=="disable"){n.disable()}else{var o=new i({value:k.organization.edit_organization_button,className:"primary",events:{onClick:function(){q.update()}}});var p=new i({value:k.organization.edit_organization_cancel,events:{onClick:function(){q.dispatchEvent("switchDetailView");q.elements.form.reset();q.elements.form.setValues(q.model.toJSON())}}});this.elements={form:n,create:o,cancel:p};n.container.addContent({tag:"div","class":"footer",html:[o,p]})}this.container.setContent(r.render());return this},update:function(){var o=this;var q={description:this.elements.form.getValue("description"),address:this.elements.form.getValue("address"),city:this.elements.form.getValue("city"),stateOrRegion:this.elements.form.getValue("stateOrRegion"),postalCode:this.elements.form.getValue("postalCode"),country:this.elements.form.getValue("country"),};if(this.getIdCardTitleInput){var n=this.getIdCardTitleInput();var m=n.value;if(m===""){n.addClassName("has-error");this.mainAlert.add({message:k.get("organization.errorEmptyName")});return}if(m!==this.model.get("name")&&g.hasBadChars(m)){n.addClassName("has-error");this.mainAlert.add({message:k.get("organization.errorUnauthorizedChars")});return}q.name=m}var p=this.elements.form.getValue("parent");if(p){q.parentName=this.collection.get(p).get("name");q.parentType=this.collection.get(p).get("type")}this.elements.create.disable();this.elements.cancel.disable();this.model.save(q,{wait:true,onComplete:function(){o.elements.create.enable();o.elements.cancel.enable();o.dispatchEvent("switchDetailView");var r=k.get(o.alertMessageBase+"successEdit");o.mainAlert.add({message:r,className:"success"})},onFailure:function(r,t){o.elements.create.enable();o.elements.cancel.enable();if(t.error){o.getIdCardTitleInput().addClassName("has-error")}var s=t.error?k.get(l.errorCode+t.error.code):k.get(o.alertMessageBase+"errorEdit");o.mainAlert.add({message:s})}})}});return d});define("DS/i3DXPnOAdminUIOrganization/js/organization",["UWA/Core","DS/W3DXComponents/Skeleton","DS/i3DXPnOAdminUIOrganization/js/Collections/CompanyCollection","DS/i3DXPnOAdminUIOrganization/js/Collections/OrganizationStructureList","DS/i3DXPnOAdminUIOrganization/js/Collections/ParentCollection","DS/i3DXPnOAdminUIOrganization/js/Collections/EmployeeCollection","DS/i3DXPnOAdminUIOrganization/js/Views/DetailView","DS/i3DXPnOAdminUIOrganization/js/Views/OrganizationStructureView","DS/W3DXComponents/ContentSet","DS/W3DXComponents/MemberSet","DS/W3DXComponents/Collections/ActionsCollection","DS/i3DXPnOAdminUIOrganization/js/constants","i18n!DS/i3DXPnOAdminUIOrganization/assets/nls/organization"],function(e,b,g,c,h,l,d,f,m,j,i,o,n){var k=new i([{id:"addstructure",title:n.get("structure.addOrganization"),icon:"plus",overflow:false}]);var a={buildOrganizationSkeleton:function(s,r,p){if(r.bones){r.bones.destroy()}var q=new g([],{dataProxy:p});q.fetch({onComplete:function(w,t,u){if(!q.isEmpty()){var v=q.first();r.bones=new b({properties:{view:d,viewOptions:{type:"disable"},fetchMode:"never"},properties_edit:{view:d,collection:h,collectionOptions:{dataProxy:p},fetchMode:"never",viewOptions:{type:"edit",events:{switchDetailView:function(){r.bones.getActiveIdCard().selectFacet(0);r.bones.getActiveIdCard().switchToViewMode()}}}},structure:{collection:c,collectionOptions:{collection_type:"structure",dataProxy:p},fetchOptions:{reset:true},fetchMode:"always",view:f,viewOptions:{contents:{useInfiniteScroll:true,usePullToRefresh:false,headers:[{label:n.get("organization.name"),property:"title"},{label:n.get("organization.type"),property:"subtitle"},{label:n.get("organization.description"),property:"content"}],itemViewOptions:{mapping:{title:function(){return this.model.escape("name")},subtitle:function(){var x=this.model.get("type");if(x===o.bu){return n.type.Business_Unit}else{if(x===o.department){return n.type.Department}}},content:function(){return this.model.escape("description")}}},events:{onInfiniteScroll:function(){this.collection.onInfiniteScroll_handler(this.scrollView)}}},actions:{collection:k},events:{onActionClick:function(){this.showModal()}}},idCardOptions:{actions:[{text:n.organization.edit_organization,icon:"pencil",handler:function(y,x){this.selectFacet(1);this.switchToEditMode()}}],attributesMapping:{title:function(){return this.escape("name")},ownerName:function(){var x=this.get("type");if(x===o.bu){return n.type.Business_Unit}else{if(x===o.department){return n.type.Department}}},description:function(){return this.escape("description")}},facets:function(){var x=[{text:n.facet_properties,icon:"doc-text",handler:b.getRendererHandler("properties")},{text:"",icon:"",handler:b.getRendererHandler("properties_edit",{viewOptions:{getIdCardTitleInput:function(){return r.bones.getActiveIdCard()._controls.titleInput.elements.input}}})},{text:n.facet_structure,icon:"flow-tree",handler:b.getRendererHandler("structure")}];return x}}},employees:{collection:l,collectionOptions:{dataProxy:p},fetchMode:"once",view:j,viewOptions:{contents:{selectionMode:null,headerOnEmpty:false,headers:[{label:n.get("employee.firstName"),property:"header_fname"},{label:n.get("employee.lastName"),property:"header_lname"},{label:n.get("employee.employmentType"),property:"subtitle"}],itemViewOptions:{mapping:{title:function(){return(this.model.get("firstName")+" "+this.model.get("lastName"))},subtitle:function(){var x=this.model.get("employmentType");if(x===o.employee){return n.get("employee.type.employee")}else{if(x===o.contractor){return n.get("employee.type.contractor")}}},header_fname:"firstName",header_lname:"lastName"}},useInfiniteScroll:true,events:{onInfiniteScroll:function(){this.collection.onInfiniteScroll_handler(this.scrollView)}}}}}},{rootIdCardOptions:{model:v,actions:[{text:n.organization.edit_organization,icon:"pencil",handler:function(y,x){this.selectFacet(1)}}],attributesMapping:{title:"name",ownerName:function(){return n.type.Company},description:function(){return this.escape("description")}},facets:function(){var x=[{text:n.facet_properties,icon:"doc-text",handler:b.getRendererHandler("properties",{viewOptions:{isHostCompany:true}})},{text:"",icon:"",handler:b.getRendererHandler("properties_edit",{viewOptions:{isHostCompany:true}})},{text:n.facet_structure,icon:"flow-tree",handler:b.getRendererHandler("structure")},{text:n.facet_employees,icon:"users",handler:b.getRendererHandler("employees")}];return x}}});s.body.setContent(r.bones.render())}else{s.body.setContent(n.get("company_issue"))}},onFailure:function(v,t,u){s.body.setContent(n.get("company_issue"))}})}};return a});define("DS/i3DXPnOAdminUIOrganization/js/organizationWidget",["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/i3DXPnOAdminUIOrganization/js/DataProxy","DS/i3DXPnOAdminUIOrganization/js/organization","i18n!DS/i3DXPnOAdminUIOrganization/assets/nls/organization"],function(c,a,b,k){var j,h,d;function f(l){h=l.reduce(function(n,m){var o=m.platformId;n[o]={platformId:o,displayName:m.displayName,"3DSpace":m["3DSpace"],"3DSwym":m["3DSwym"]};return n},{});d=Object.keys(h)}function i(n){f(n);var l;var o={type:"list",name:"platformPref",label:k.get("preference.platform"),options:[]};for(var m=0;m<d.length;m++){o.options.push({label:h[d[m]].displayName,value:h[d[m]].platformId})}if(o.options.length<2){o.type="hidden"}widget.addPreference(o);var p=widget.getValue("x3dPlatformId");if(p){l=h[p]}else{l=h[d[0]]}widget.setValue("platformPref",l.platformId);return l}function e(m){f(m);var n=widget.getPreference("platformPref");for(var l=0;l<d.length;l++){n.options.push({label:h[d[l]].displayName,value:h[d[l]].platformId})}widget.addPreference(n);widget.dispatchEvent("onEdit",["refreshPrefs"])}var g={onLoad:function(){c.getPlatformServices({onComplete:function(l){j=new a(i(l));b.buildOrganizationSkeleton(widget,g,j)},onFailure:function(){widget.body.setContent(k.get("URLIssue"))}})},onRefresh:function(){var l=h[widget.getValue("platformPref")];j.setPlatform(l);b.buildOrganizationSkeleton(widget,g,j)},onEdit:function(m){if(m!=="refreshPrefs"){var l=widget.getPreference("platformPref");l.options=[];widget.addPreference(l);widget.dispatchEvent("onEdit",["refreshPrefs"]);c.getPlatformServices({onComplete:function(n){e(n)},onFailure:function(){}})}},endEdit:function(){}};return g});