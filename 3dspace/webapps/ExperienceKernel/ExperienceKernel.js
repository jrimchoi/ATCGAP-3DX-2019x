if(typeof define==="undefined"){define=function(e,d,f){EK=f(BinaryHelpers);define=undefined}}define("DS/ExperienceKernel/ExperienceKernel",["DS/ExperienceKernel/EKBinaryHelpers"],function(a){if(typeof EK!=="undefined"){return EK}return(function(){var M={};M.window=typeof window!=="undefined"?window:undefined;var U=2;M.defaultsOptions=Object.freeze({hypervisorIp:"127.0.0.1",hypervisorUrl:undefined,webSocketPort:2097,pool:"browser",ssl:false,onText:function(){return true},onBinary:function(){return true},onHypervisorConnect:function(){},onHypervisorDisconnect:function(){},onDisconnect:function(){},authentication:undefined,onPoolSelectable:function(){return false}});M.defaultsMultiplexerOptions=Object.freeze({onText:function(){return true},onBinary:function(){return true},join:function(){return true}});M.defaultsMessageBalancerOptions=Object.freeze({onComplete:function(){return true},onError:undefined});M.defaultsStoreOptions=Object.freeze({hypervisorIp:"127.0.0.1",hypervisorUrl:undefined,webSocketPort:2097,ssl:false,distant:false,onHypervisorConnect:function(){},onHypervisorDisconnect:function(){},authentication:undefined});M.Status=Object.freeze({pending:0,connected:1,disconnected:2,autoScalingError:3});M.WebSocket=function(Z){this.ws=null;this.monitor=null;this.callback=function(){return true};this.onopen=[];this.onclose=[];this.inputs=[];this.outputs=[];this.waitingOutputs=[];this.connected=false;this.waitRelease=(Z!==undefined)};var x=Object.freeze({version:1});var W=Object.freeze({hypervisor:-2});var r=Object.freeze({noConstraint:0,onlyMyHypervisor:1,notMyHypervisor:2,preferMyHypervisor:3,identifier:5});var I=Object.freeze({none:0,channelRename:2,resultsSend:3,resultsAnswer:4,resultsAnswerEnd:5,resultsInterrupt:7,onDisconnect:8,subscribe:9,unsubscribe:10});var l=Object.freeze({GetFromWeb:9,SnapshotFromWeb:11,PutFromWeb:15,CommitFromWeb:17,LastSnapshotFromWeb:28,CreateObserverFromWeb:33,ReadKeysFromWeb:34,CreateKeysFromWeb:35,GetLocalMasterIdentifierFromWeb:38,DeleteObserverFromWeb:39,NotifyObserverFromWeb:40,StoreNodeDisconnectFromWeb:41});function T(ac){var ad=Object(ac);for(var Z=1;Z<arguments.length;++Z){var ab=arguments[Z];if(ab===undefined){continue}for(var aa in ab){if(ab.hasOwnProperty(aa)){ad[aa]=ab[aa]}}}return ad}function f(Z){return Z!==I.channelRename&&Z!==I.resultsAnswerEnd&&Z!==I.resultsInterrupt}var P={index:0,uniqueId:0,getTimestamp:function(ab){var Z=new Date();var aa=Math.floor(Z.getTime()/1000);var ac=Math.floor(1000*Z.getMilliseconds());if(f(ab)){return{sec:aa,usec:ac,index:this.index++}}return{sec:aa,usec:ac}},getCurrentTimeInSec:function(){var Z=new Date();return Math.floor(Z.getTime()/1000)},getUniqueId:function(){return ++this.uniqueId}};function O(af,ae,ag,ai,Z,ah,ad,aa,ab){var ac=ae;ac.type=ah;ac.headerType=ad;ac.isBinary=Z;ac.uniqueId=ag;ac.hypervisorId=aa.hypervisorId;ac.id=aa.id;ac.eventId=ab;ac.pool=aa.pool;af.sendText(JSON.stringify(ac));af.sendBinary(ai)}function y(Z,ae,ab,aa,ac){var ad=P.getTimestamp(ab);ad.type=ab;ad.uniqueId=ae;ad.hypervisorId=aa.hypervisorId;ad.id=aa.id;ad.hresult=ac;Z.sendText(JSON.stringify(ad))}M.WebSocket.prototype.flushMessages=function(){while(this.outputs.length){var Z=this.outputs.pop();Z()}};function d(Z,aa){if(Z===I.none||Z===I.channelRename||Z===I.onDisconnect||Z===I.subscribe||Z===I.unsubscribe){return aa?8:1}if(Z===I.resultsSend||Z===I.resultsAnswer||Z===I.resultsAnswerEnd||Z===I.resultsInterrupt){return aa?8:4}return -1}M.WebSocket.prototype.connect=function(ac,ab){this.connected=false;this.name=ab;var aa=new M.window.WebSocket(ac);this.ws=aa;this.ws.binaryType="arraybuffer";this.ws.onopen=function(){this.connected=true;this.flushMessages();this.onopen.forEach(function(af){af()});if(this.ws===null){aa.close()}}.bind(this);this.ws.onclose=function(){var af=this.connected;if(af){this.flushMessages()}this.ws=null;this.onclose.forEach(function(ag){ag(af)})}.bind(this);this.ws.onmessage=function(af){if(af.data.byteLength===0){return}this.inputs.push(af.data);if(this.inputs.length===1){ad()}}.bind(this);var ae=function(ah,ag,ak,aj){var af=ag===I.resultsSend;if(this.monitor){y(this.monitor,aj,2,this.name)}var ai=this.callback(ah,ak,af);if(af){c(this,undefined,I.resultsAnswerEnd,ak)}if(this.monitor){y(this.monitor,aj,3,this.name,ai)}this.inputs.shift();ad()}.bind(this);var Z=function(af){this.callbackResultsEnd(af);this.inputs.shift();ad()}.bind(this);var ad=function(){var an=this.inputs[0];if(an){var ak=new Uint8Array(an);var am=ak[0]&63;var ap=(ak[0]&64)===64;var ai=d(am,ap);var ag=-1;var ao=new DataView(an);if(am===I.resultsAnswerEnd){ag=ao.getInt32(0)&16777215;Z(ag);return}if(am===I.resultsSend||am===I.resultsAnswer){ag=ao.getInt32(0)&16777215}var al=ap?ao.getInt32(4):0;var aq=an.slice(ai);var af=(ak[0]&128)===128;if(this.monitor){var aj=P.getTimestamp(am);O(this.monitor,aj,al,aq,af,1,am,this.name)}var ah=new M.window.FileReader();ah.onload=function(ar){ae(ar.target.result,am,ag,al)};if(af&&M.window.FileReader.prototype.hasOwnProperty("readAsArrayBuffer")){ah.readAsArrayBuffer(new M.window.Blob([aq]))}else{if(af){ah.onload({target:{result:aq}})}else{ah.readAsText(new M.window.Blob([aq]))}}}}.bind(this)};M.WebSocket.prototype.close=function(){this.monitor=null;if(this.ws&&this.ws.readyState!==0){this.ws.close()}this.ws=null};function X(aa,af,ae){var ab=ae!==undefined;var Z=d(aa,ab);var ad=new Uint8Array(Z);var ac=new DataView(ad.buffer);if(Z>=4&&af!==undefined){ac.setInt32(0,af&16777215)}ad[0]=aa;if(ab){ad[0]|=64;ac.setInt32(4,ae)}return ad}function G(Z,ac,aa){if(Z.ws&&(Z.ws.readyState===2||Z.ws.readyState===3)){Z.ws=null}if(!Z.ws){return false}if(typeof aa!=="string"){ac[0]|=128}var ab=[ac];if(aa!==undefined){if(aa instanceof DataView){aa=aa.buffer}ab.push(aa)}Z.ws.send(new M.window.Blob(ab));return true}function c(Z,ad,ac,af,ae,ab){ac=ac||I.none;var aa=function(){var ag=X(ac,af,ae);return G(Z,ag,ad)};if((Z.waitRelease)&&(!ab)){Z.waitingOutputs.unshift(aa)}else{if(Z.connected){return aa()}else{Z.outputs.unshift(aa)}}return true}M.WebSocket.prototype.release=function(){this.waitRelease=false;while(this.waitingOutputs.length){this.outputs.unshift(this.waitingOutputs.pop())}if(this.connected){this.flushMessages()}};M.WebSocket.prototype.sendMessage=function(aa,Z,ac,ab){return c(this,aa,Z,ac,ab)};function N(aa,Z,ab){if(Z&&aa&&aa.waitingCredentials){Z({forWho:aa.from,passportURL:aa.passportURL},ab,function(ac){throw new Error(ac)});return true}return false}function v(aa,Z){this.key.subMessage={_:"proxyValidate",serviceURL:aa,serviceTicket:Z};G(this.ws,this.header,JSON.stringify(this.key));this.ws.release()}M.WebSocket.prototype.channelRename=function(ac,ab,aa){var Z=function(){var ad=X(I.channelRename);ac._="setPool";if(!N(aa,ab,v.bind({ws:this,header:ad,key:ac}))){G(this,ad,JSON.stringify(ac));this.release()}}.bind(this);this.outputs.push(Z)};M.WebSocket.prototype.onMessage=function(Z){this.callback=Z};M.WebSocket.prototype.onMessageResultsEnd=function(Z){this.callbackResultsEnd=Z};M.WebSocket.prototype.onOpen=function(Z){if(this.ws&&this.ws.readyState===1){Z()}else{this.onopen.push(Z)}};M.WebSocket.prototype.onClose=function(Z){if(this.ws&&this.ws.readyState===3){Z()}else{this.onclose.push(Z)}};function Q(Z,aa){return Z&&Z.sendMessage(JSON.stringify(aa))}function K(Z,aa){return c(Z,JSON.stringify(aa),undefined,undefined,undefined,true)}function i(aa,ab){for(var Z in aa){if(aa.hasOwnProperty(Z)){ab(Z,aa[Z])}}}var n;var e;var F=function(Z,aa){this.index=0;this.nodes=[];this.timeout=0;this.url=Z;this.checkSentMessages=aa};F.prototype.init=function(Z){this.buffer=Z.response;if(Z.status===200){this.dataView=new DataView(this.buffer);this.version=this.dataView.getUint8(0);this.offset=1}};F.prototype.reset=function(){M.window.clearTimeout(this.timeout);this.timeout=0};F.prototype.addNode=function(Z){if(this.buffer===undefined){return n("Missing EK.replayIsReady call")}if(this.version===undefined){return n("Record file not found: "+this.url)}if(this.version!==x.version){return n("Version mismatch: please update your record file")}Z.replayer=new S(this.index);this.index++;this.nodes.push(Z);this.processMessages()};F.prototype.getMessage=function(){var ae;var aa=this.dataView.getInt8(this.offset);var af=this.dataView.getInt8(this.offset+1);var ad=this.dataView.getInt8(this.offset+2);var ac=this.dataView.getInt32(this.offset+3,true);this.offset+=7;if(af){ae=this.buffer.slice(this.offset,this.offset+ac)}else{ae="";for(var ab=0;ab<ac;++ab){ae+=String.fromCharCode(this.dataView.getUint8(this.offset+ab))}try{ae=decodeURIComponent(window.escape(ae))}catch(Z){}}this.offset+=ac;return{index:aa,isSent:ad,message:ae}};F.prototype.processMessages=function(){if(this.timeout===0){if(this.offset>=this.dataView.byteLength){e=undefined}else{var Z=this.dataView.getInt8(this.offset+2);if(!Z){this.timeout=M.window.setTimeout(function(){while(this.offset<this.dataView.byteLength){if(this.dataView.getInt8(this.offset+2)){break}var aa=this.getMessage();this.nodes[aa.index].replayer.callback(aa.message,-1)}this.timeout=0;this.processMessages()}.bind(this),1)}}}};M.setReplayUrl=function(aa,Z){Z=Z||{};if(Z.checkSentMessages===undefined){Z.checkSentMessages=true}if(Z.onerror===undefined){Z.onerror=function(ad){jasmine.addMatchers({toFail:function(){return{compare:function(ae){return{pass:false,message:ae}}}}});expect(ad).toFail()}}n=function(ad){if(e instanceof F){e.reset()}e=undefined;Z.onerror(ad)};if(typeof e==="boolean"){return n("EK.Node created before calling EK.setReplayUrl")}aa+=".ekr";var ac=new F(aa,Z.checkSentMessages);var ab=new XMLHttpRequest();ab.onreadystatechange=function(){if(ab.readyState===4){ac.init(ab)}};ab.open("GET",aa,true);ab.responseType="arraybuffer";ab.send(null);e=ac};M.replayIsReady=function(){if(e instanceof F){return e.buffer!==undefined}return n("Missing EK.setReplayUrl call")};M.replayHasFinished=function(){return e===undefined};var S=function(Z){this.index=Z};function R(Z){if(Z instanceof Uint8Array){return Z}if(Z.buffer instanceof ArrayBuffer){return new Uint8Array(Z.buffer,Z.byteOffset,Z.byteLength)}return new Uint8Array(Z)}function z(ac){if(typeof ac==="string"){return ac}var Z=R(ac);var ad="";for(var aa=0;aa<Z.length;++aa){var ab=Z[aa].toString(16);if(ab.length===1){ab="0"+ab}ad+=ab+" "}return ad}function w(ac,aa){if(typeof ac==="string"||typeof aa==="string"){return ac===aa}var ab=R(ac);var Z=R(aa);if(ab.length!==Z.length){return false}for(var ad=0;ad!==ab.length;++ad){if(ab[ad]!==Z[ad]){return false}}return true}S.prototype.sendMessage=function(aa){if(e===undefined){return n("Unexpected send "+z(aa))}var Z=e.getMessage();if(Z.index!==this.index){return n("Send "+z(aa)+" with the wrong node")}if(!Z.isSent){return n("Send "+z(aa)+" but expect to receive "+z(Z.message))}if(!w(Z.message,aa)){var ab="Send "+z(aa)+" but expect to send "+z(Z.message);if(e.checkSentMessages){return n(ab)}M.window.console.warn("Ignoring because checkSentMessages is false: "+ab)}e.processMessages();return true};S.prototype.onMessage=function(Z){this.callback=Z};S.prototype.onMessageResultsEnd=function(Z){this.callbackResultsEnd=Z};S.prototype.onClose=function(){};function H(aa,Z){if(/^\s*wss?:/.test(aa)){return aa}return(Z?"wss://":"ws://")+aa}var b=function(aa,ab){this.pool=ab;this.clients={};this.uniqueId=0;this.handlers=[];this.cache={};this.urlIndex=0;this.authentication=aa.authentication;this.onPoolSelectableCallback=aa.onPoolSelectable;var ad=function(ag){var af=aa.hypervisorUrl[ag];if(af===undefined){af=aa.hypervisorIp+":"+aa.webSocketPort}af=H(af,aa.ssl);var ae={hypervisorId:0,id:W.hypervisor};this.wsHypervisor.connect(af,ae)}.bind(this);var Z=function(){aa.onHypervisorConnect()};var ac=function(ae){if(ae||this.urlIndex>=aa.hypervisorUrl.length){aa.onHypervisorDisconnect(ae)}else{ad(this.urlIndex++)}}.bind(this);if(e instanceof F){e.addNode(this)}else{e=false;this.pools={};this.inputs={};this.onDisconnect=aa.onDisconnect;this.onText=aa.onText;this.onBinary=aa.onBinary;this.wsHypervisor=new M.WebSocket(this.authentication);this.wsHypervisor.onMessage(this.privateOnText.bind(this));this.wsHypervisor.onOpen(Z);this.wsHypervisor.onClose(ac);aa.hypervisorUrl=[].concat(aa.hypervisorUrl);ad(this.urlIndex++);K(this.wsHypervisor,{_:"createNode",pool:ab,web:true,version:U})}};function E(Z){return Z.hypervisorId+"_"+Z.id}b.prototype.setNodeId=function(ab){var Z;if(ab.status!==undefined){Z=new M.WebSocket();Z.name={};Z.ws={readyState:3}}else{Z=this.clients[E(ab)]}if(Z===undefined){var aa=ab.pool;this.inputs[aa]=this.inputs[aa]||[];this.inputs[aa].push(ab)}else{var ad=ab.uniqueId;var ac=this.pools[ad];ac.setId(Z,ab.pool,this.onDisconnect);delete this.pools[ad]}};b.prototype.connect=function(ae){var ac={hypervisorId:ae.hypervisorId,id:ae.id};var ab=ae.url;if(ab===undefined){ab=ae.ip+":"+ae.port}ab=H(ab,ae.ssl);var aa=new M.WebSocket(this.authentication);ae.name.pool=this.pool;aa.channelRename(ae.name,this.authentication,ae.credentials);aa.connect(ab,ac);this.clients[E(ae)]=aa;var Z=this.inputs[ae.pool];if(Z!==undefined){this.inputs[ae.pool]=[];while(Z.length){this.setNodeId(Z.shift())}}else{var af=new B(this.wsHypervisor);af.nodeImpl=this;af.ws=aa;var ad=new J(af);aa.onMessage(this.onMessage(ad));aa.onMessageResultsEnd(this.onMessageResultsEnd(ad))}aa.pool=ae.pool;aa.used=0;this.poolPong(aa);if(this.monitor&&ae.pool!=="ek.local.monitor"){aa.monitor=this.monitor}};b.prototype.deleteHandler=function(Z){for(var aa=0;aa<this.handlers.length;aa++){var ab=this.handlers[aa];if(ab&&ab.nodeId.impl.ws===Z){ab.multiplexer.results.join();delete this.handlers[aa]}}};function g(aa,Z){K(this.wsHypervisor,{_:"proxyValidate",serviceURL:aa,serviceTicket:Z});if(this.wsHypervisor){this.wsHypervisor.release()}}b.prototype.privateOnText=function(ab){try{ab=JSON.parse(ab)}catch(aa){return false}var ad=ab._;if(ad==="setId"){if(ab.monitor){this.monitor=this.askConnect("ek.local.monitor",M.Criterion.onlyMyHypervisor());this.monitor.onMessage(this.privateOnText.bind(this))}this.ip=ab.ip;this.port=ab.port;if(!N(ab.credentials,this.authentication,g.bind(this))&&this.wsHypervisor){this.wsHypervisor.release()}}else{if(ad==="connect!"){if(this.clients[E(ab)]===undefined&&ab.type!==4){this.connect(ab)}}else{if(ad==="id!"){this.setNodeId(ab)}else{if(ad==="isPoolSelectable!"){this.onPoolSelectableCallback(ab.pool,ab.answer)}else{if(ad==="clientRemoved"){var ac=E(ab);var Z=this.clients[ac];if(Z!==undefined){delete this.clients[ac];this.deleteHandler(Z);if(Z.pool==="ek.local.monitor"){i(this.clients,function(af,ae){ae.monitor=null});this.monitor=undefined}Z.close()}}else{if(ad===""){this.setNodeId(ab)}else{if(ad==="monitorMessages"&&this.pool.substr(0,3)!=="ek."){if(!this.monitor){this.monitor=this.askConnect("ek.local.monitor",M.Criterion.onlyMyHypervisor());this.monitor.onMessage(this.privateOnText.bind(this))}i(this.clients,function(af,ae){ae.monitor=this.monitor}.bind(this))}else{return false}}}}}}}return true};b.prototype.getClientFromPool=function(ab){for(var aa in this.clients){if(this.clients.hasOwnProperty(aa)){var Z=this.clients[aa];if(Z.pool===ab&&Z.used===0){return Z}}}};b.prototype.getNodeIdFromClient=function(aa,Z){var ab=new B(this.wsHypervisor);ab.setId(aa,aa.pool,undefined);return new u(Z,undefined,ab)};b.prototype.poolPong=function(Z){if(this.cache[Z.pool]!==undefined&&this.cache[Z.pool].length!==0){this.sendBalancedMessage(Z,this.cache[Z.pool].shift())}};b.prototype.sendBalancedMessage=function(aa,ad){aa.used=1;aa.answers=[];var ae=ad.balancer;var Z=ae.nodePool;var ab=this.createBalancerResults(ae,aa);var ac=new M.Multiplexer(Z.node,ab);var af=Z.node.impl.getNodeIdFromClient(aa,Z);ac.impl.sendMessage(af,ad.message);ac.close();aa.message=ad.message};b.prototype.clientIsClosed=function(Z){for(var aa in this.clients){if(this.clients.hasOwnProperty(aa)){var ab=this.clients[aa];if(ab===Z){return false}}}return true};b.prototype.createBalancerResults=function(ae,Z){var ab=ae.nodePool.node;var ac=function(ag,af){Z.answers.push(ag);ab.impl.onText(ag,af)};var aa=function(ag,af){Z.answers.push(ag);ab.impl.onBinary(ag,af)};var ad=function(){Z.used=0;if(this.clientIsClosed(Z)){ae.isInsideOnError=true;ae.options.onError(Z.message,Z.answers);ae.isInsideOnError=false}else{this.poolPong(Z)}if(!--ae.nb&&ae.isClosed){ae.options.onComplete()}}.bind(this);return{onText:ac,onBinary:aa,join:ad}};var m=function(aa,Z){this.policy=aa;this.name=Z};m.prototype.withTimeout=function(Z){this.timeout=Z>0?Z:0;return this};m.prototype.withoutQueuing=function(){this.noQueuing=true;return this};m.prototype.withoutProcessCreation=function(){this.noProcess=true;return this};M.Criterion={onlyMyHypervisor:function(){return new m(r.onlyMyHypervisor)},notMyHypervisor:function(){return new m(r.notMyHypervisor)},preferMyHypervisor:function(){return new m(r.preferMyHypervisor)},identifier:function(Z){return new m(r.identifier,Z)},timeout:function(Z){return new m(r.noConstraint).withTimeout(Z)},noQueuing:function(){return new m(r.noConstraint).withoutQueuing()},noProcessCreation:function(){return new m(r.noConstraint).withoutProcessCreation()}};b.prototype.sendMessageWithInterrupt=function(ae,ac,Z,ab){var aa={onText:this.onText,onBinary:this.onBinary};var ad=new M.Multiplexer(ab,aa);ad.impl.sendMessageWithInterrupt(ae,ac,Z);ad.close()};b.prototype.askConnect=function(Z,aa){var ac=new B(this.wsHypervisor);if(e instanceof F){ac.setId(this.replayer)}else{aa=aa||{policy:r.noConstraint};var ad=P.getUniqueId();var ab={_:"id?",pool:Z,uniqueId:ad,policy:aa.policy,name:aa.name,timeout:aa.timeout!==undefined?aa.timeout:-1,noQueuing:aa.noQueuing,noProcess:aa.noProcess};this.pools[ad]=ac;Q(this.wsHypervisor,{_:"connect?",pool:Z,balancer:false});Q(this.wsHypervisor,ab)}return ac};b.prototype.unserializeNodeId=function(ad,af,ac,ag,ai,Z){var ab=new B(this.wsHypervisor);var ah=P.getUniqueId();var aa={_:"unserializeId",ip:af,port:ac,pool:ag,hypervisorId:ai,id:Z,uniqueId:ah,policy:m.noConstraint};this.pools[ah]=ab;Q(this.wsHypervisor,aa);var ae=new Y(ad,ag);return new u(ae,undefined,ab)};b.prototype.stop=function(){i(this.clients,function(aa,Z){Z.close()});if(this.wsHypervisor){this.wsHypervisor.close()}this.wsHypervisor=null};var B=function(Z){this.wsHypervisor=Z;this.outputs=[];this.onStatusChange=[]};B.prototype.setId=function(Z,ab,ac){this.ws=Z;var ad=new u();ad.impl=this;this.ws.onClose(function(){Q(this.wsHypervisor,{_:"clientRejected",hypervisorId:this.ws.name.hypervisorId,id:this.ws.name.id})}.bind(this));if(this.onStatusChange.length>0){var af=function(){this.onStatusChange.forEach(function(ag){ag(ad,ab)})}.bind(this);this.ws.onOpen(af);this.ws.onClose(af)}if(typeof ac==="function"&&ab.substr(0,3)!=="ek."){var ae=function(){ac(ad,ab)};this.ws.onClose(ae)}while(this.outputs.length){var aa=this.outputs.shift();aa()}};B.prototype.close=function(){if(this.wsHypervisor!==undefined){this.push(function(){return Q(this.wsHypervisor,{_:"closeId",hypervisorId:this.ws.name.hypervisorId,id:this.ws.name.id})}.bind(this))}};B.prototype.closeWithReducedTimeout=function(){if(this.wsHypervisor!==undefined){this.push(function(){return Q(this.wsHypervisor,{_:"closeId",hypervisorId:this.ws.name.hypervisorId,id:this.ws.name.id,immediately:true})}.bind(this))}};B.prototype.push=function(Z){if(!this.ws){this.outputs.push(Z)}else{if(!Z()&&typeof e==="boolean"){throw new Error("ExperienceKernel was unable to send a message since the distant node is unreachable")}}};B.prototype.sendText=function(Z){this.push(function(){return this.ws.sendMessage(Z)}.bind(this))};B.prototype.sendBinary=function(Z){this.push(function(){if(typeof Z==="string"){Z=new String(Z)}return this.ws.sendMessage(Z)}.bind(this))};B.prototype.sendMessage=function(ab,Z,ae){var ac=P.getTimestamp(Z);var aa=this.nodeImpl;var ad=++aa.uniqueId;this.push(function(){if(aa.monitor){var af=this.ws===undefined?{pool:this.nodePool.pool}:this.ws.name;O(aa.monitor,ac,ad,ab,typeof ab!=="string",0,Z,af,ae)}else{ad=undefined}return this.ws.sendMessage(ab,Z,ae,ad)}.bind(this))};B.prototype.onMessage=function(Z){this.push(function(){this.ws.onMessage(Z);return true}.bind(this))};B.prototype.onMessageResultsEnd=function(Z){this.push(function(){this.ws.onMessageResultsEnd(Z);return true}.bind(this))};B.prototype.getStatus=function(){if(this.ws===undefined){return M.Status.pending}var Z=this.ws.ws;if(Z===null){return M.Status.disconnected}if(Z.readyState===0){return M.Status.pending}if(Z.readyState===1){return M.Status.connected}return M.Status.disconnected};M.Node=function(aa){aa=aa||{};if(aa.onClose!==undefined){M.window.console.log("[EK.Node] onClose is DEPRECATED: use onHypervisorDisconnect instead");aa.onHypervisorDisconnect=aa.onClose;delete aa.onClose}for(var Z in aa){if(aa.hasOwnProperty(Z)&&!M.defaultsOptions.hasOwnProperty(Z)){throw new Error("Unknown EK.Node option named '"+Z+"'. Valid options are: "+JSON.stringify(Object.keys(M.defaultsOptions)))}}if(aa.hasOwnProperty("hypervisorUrl")&&(aa.hasOwnProperty("hypervisorIp")||aa.hasOwnProperty("webSocketPort"))){throw new Error("Invalid options combination. Do not use hypervisorUrl with hypervisorIp and/or webSocketPort")}var ab=T({},M.defaultsOptions,aa);this.onMessage=function(ac){return function(ad,ag,af){ac.id=ag;ac.resultsAnswer=af;if(af||ag===-1){return(typeof ad==="string"?ab.onText:ab.onBinary)(ad,ac)}if(this.impl.handlers[ag]!==undefined){var ae=this.impl.handlers[ag].multiplexer.results;return(typeof ad==="string"?ae.onText:ae.onBinary)(ad,ac)}}.bind(this)};this.onMessageResultsEnd=function(){return function(ad){var ac=this.impl.handlers[ad];if(ac&&ac.multiplexer.checkForJoin()){ac.multiplexer.results.join();delete this.impl.handlers[ad]}}.bind(this)};this.impl=new b(ab,ab.pool);this.impl.onMessage=this.onMessage.bind(this);this.impl.onMessageResultsEnd=this.onMessageResultsEnd.bind(this)};var C=function(Z,aa){this.multiplexer=Z;this.nodeId=aa};var J=function(Z){this.impl=Z;this.id=-1;this.resultsAnswer=false};J.prototype.answerText=function(Z){return this.answerMessage(Z+"")};J.prototype.answerBinary=function(Z){return this.answerMessage(Z)};J.prototype.answerMessage=function(aa){if(this.id===-1){this.impl.sendMessage(aa)}else{if(this.resultsAnswer){this.impl.sendMessage(aa,I.resultsAnswer,this.id)}else{var Z=this.impl.nodePool.node.impl.handlers[this.id];if(Z){Z.multiplexer.cnt++;this.impl.sendMessage(aa,I.resultsSend,this.id)}}}return this};var Y=function(aa,Z){this.node=aa;this.pool=Z};Y.prototype.select=function(Z){return new u(this,Z)};Y.prototype.createMessageBalancer=function(Z){if(!this.node.impl.wsHypervisor){return null}return new p(this,Z)};var u=function(Z,ad,aa){if(Z===undefined){return}var ac=Z.node;if(aa!==undefined){this.impl=aa}else{this.impl=ac.impl.askConnect(Z.pool,ad)}this.impl.nodePool=Z;this.impl.nodeImpl=Z.node.impl;var ab=new J(this.impl);this.impl.onMessage(ac.onMessage(ab));this.impl.onMessageResultsEnd(ac.onMessageResultsEnd(ab))};u.prototype.equals=function(ab){var aa=this.impl.ws;var Z=ab.impl.ws;if(aa===undefined||Z===undefined){return false}return aa.name.id===Z.name.id&&aa.name.hypervisorId===Z.name.hypervisorId};u.prototype.close=function(){this.impl.close();return this};u.prototype.closeWithReducedTimeout=function(){this.impl.closeWithReducedTimeout();return this};u.prototype.getStatus=function(){return this.impl.getStatus()};u.prototype.isConnected=function(){return this.impl.getStatus()===M.Status.connected};u.prototype.onStatusChange=function(Z){if(typeof Z==="function"){this.impl.onStatusChange.push(Z)}};M.Node.prototype.connect=function(Z){return new Y(this,Z)};M.Node.prototype.isPoolSelectable=function(Z){Q(this.impl.wsHypervisor,{_:"isPoolSelectable",pool:Z})};function L(aa,Z){if(aa.impl.nodePool.node!==Z){throw new Error("The NodeId doesn't belong to the right node")}}M.Node.prototype.sendText=function(aa,Z){L(aa,this);Z=Z||"";aa.impl.sendMessage(Z+"");return this};M.Node.prototype.sendBinary=function(aa,Z){L(aa,this);aa.impl.sendMessage(Z);return this};M.Node.prototype.sendBinaryWithInterrupt=function(ab,aa,Z){L(ab,this);this.impl.sendMessageWithInterrupt(ab,aa,Z,this);return this};M.Node.prototype.sendTextWithInterrupt=function(ab,aa,Z){L(ab,this);this.impl.sendMessageWithInterrupt(ab,aa+"",Z,this);return this};M.Node.prototype.sendTextOnDisconnection=function(aa,Z){L(aa,this);Z=Z||"";aa.impl.sendMessage(Z+"",I.onDisconnect);return this};M.Node.prototype.sendBinaryOnDisconnection=function(aa,Z){L(aa,this);aa.impl.sendMessage(Z,I.onDisconnect);return this};M.Node.prototype.subscribe=function(aa,Z){L(aa,this);Z=Z||"";aa.impl.sendMessage(Z+"",I.subscribe);return this};M.Node.prototype.unsubscribe=function(aa,Z){L(aa,this);Z=Z||"";aa.impl.sendMessage(Z+"",I.unsubscribe);return this};M.Node.prototype.stop=function(){var Z=function(){throw new Error("EK.Node is closed")};for(var aa in this.constructor.prototype){if(typeof this[aa]==="function"){this[aa]=Z}}this.impl.stop()};M.Interruption=function(){this.id=-1;this.interrupted=false};M.Interruption.prototype.interrupt=function(){if(this.interrupted||this.id===-1){return false}this.to.impl.sendMessage(undefined,I.resultsInterrupt,this.id);this.interrupted=true;return true};M.Multiplexer=function(ab,aa){aa=aa||{};for(var Z in aa){if(aa.hasOwnProperty(Z)&&!M.defaultsMultiplexerOptions.hasOwnProperty(Z)){throw new Error("Unknown EK.Multiplexer option named '"+Z+"'. Valid options are: "+JSON.stringify(Object.keys(M.defaultsMultiplexerOptions)))}}var ac=T({},M.defaultsMultiplexerOptions,aa);this.impl=new D(ab,ac)};M.Multiplexer.prototype.sendBinary=function(aa,Z){this.impl.sendMessage(aa,Z)};M.Multiplexer.prototype.sendText=function(aa,Z){this.impl.sendMessage(aa,Z+"")};M.Multiplexer.prototype.sendBinaryWithInterrupt=function(ab,aa,Z){this.impl.sendMessageWithInterrupt(ab,aa,Z)};M.Multiplexer.prototype.sendTextWithInterrupt=function(ab,aa,Z){this.impl.sendMessageWithInterrupt(ab,aa+"",Z)};M.Multiplexer.prototype.close=function(){this.impl.close()};var D=function(aa,Z){this.node=aa;this.results=Z;this.cnt=0;this.isClosed=false};D.prototype.sendMessage=function(ac,aa,Z){if(this.isClosed){return}L(ac,this.node);this.cnt++;var ab=this.node.impl.handlers.push(new C(this,ac))-1;if(Z!==undefined){Z.id=ab;Z.to=ac}ac.impl.sendMessage(aa,I.resultsSend,ab)};D.prototype.sendMessageWithInterrupt=function(ab,aa,Z){if(Z.id!==-1){return}this.sendMessage(ab,aa,Z)};D.prototype.close=function(){if(!this.cnt&&!this.isClosed){this.results.join()}this.isClosed=true};D.prototype.checkForJoin=function(){return !--this.cnt&&this.isClosed};var p=function(aa,ab){ab=ab||{};for(var Z in ab){if(ab.hasOwnProperty(Z)&&!M.defaultsMessageBalancerOptions.hasOwnProperty(Z)){throw new Error("Unknown EK.MessageBalancer option named '"+Z+"'. Valid options are: "+JSON.stringify(Object.keys(M.defaultsMessageBalancerOptions)))}}var ac=T({},M.defaultsMessageBalancerOptions,ab);ac.onError=ac.onError||function(ad){this.impl.sendMessage(ad)}.bind(this);this.impl=new k(aa,ac)};p.prototype.sendBinary=function(Z){if(this.impl.isInsideOnError||!this.impl.isClosed){this.impl.sendMessage(Z)}};p.prototype.sendText=function(Z){if(this.impl.isInsideOnError||!this.impl.isClosed){this.impl.sendMessage(Z+"")}};p.prototype.close=function(){if(!this.impl.nodePool.node.impl.wsHypervisor){throw new Error("EK.MessageBalancer close failed because EK.Node is closed")}this.impl.close()};var k=function(Z,aa){this.nodePool=Z;this.options=aa;this.isClosed=false;this.isInsideOnError=false;this.nb=0;var ab=this.nodePool.node.impl;Q(ab.wsHypervisor,{_:"connect?",pool:Z.pool,balancer:true})};k.prototype.sendMessage=function(ac){var ad=this.nodePool.node.impl;if(!ad.wsHypervisor){throw new Error("EK.MessageBalancer could not send the message "+ac+" because EK.Node from pool "+ad.pool+" is closed")}this.nb++;var Z=ad.getClientFromPool(this.nodePool.pool);if(Z!==undefined){ad.sendBalancedMessage(Z,{balancer:this,message:ac})}else{var aa=ad.cache;var ab=this.nodePool.pool;if(aa[ab]===undefined){aa[ab]=[]}aa[ab].push({balancer:this,message:ac})}};k.prototype.close=function(){if(!this.nb&&!this.isClosed){this.options.onComplete()}this.isClosed=true};function o(aa,Z){var ae=[];var ad=Z.readUint32();if(aa.observedSnapshots[ad]!==undefined){aa.observedSnapshots[ad].snapshot.timeStamp=Z.readUint64();while(Z.tell()<Z.getSize()){var ac=ae[ae.length]={low:Z.readUint32(),high:Z.readUint32()};var ab=Z.readInt64();aa.observedSnapshots[ad].snapshot.keys[ac.high][ac.low]=Z.readArrayBuffer(ab)}aa.observedSnapshots[ad].callback(aa.observedSnapshots[ad].snapshot,ae)}}M.Store=function(ac,ab){ab=ab||{};for(var aa in ab){if(ab.hasOwnProperty(aa)&&!M.defaultsStoreOptions.hasOwnProperty(aa)){throw new Error("Unknown EK.Store option named '"+aa+"'. Valid options are: "+JSON.stringify(Object.keys(M.defaultsStoreOptions)))}}this.observedSnapshots={};this.observedCounter=0;var af=T({},M.defaultsStoreOptions,ab);af.onBinary=function(ah){var ag=new M.BinaryReader(ah);var aj=ag.getSize();if(aj&&ag.readUint8()===l.NotifyObserverFromWeb){o(this,ag)}else{var ai=ah.slice(aj?1:0);this.callbacks.pop()(ai)}}.bind(this);this.onMessage=function(ag){return function(ah){return(typeof ah==="string"?af.onText:af.onBinary)(ah,ag)}};this.onMessageResultsEnd=function(){return function(){}};this.callbacks=[];this.impl=new b(af,(ab.distant?"ek.distant.store.":"ek.local.store.")+ac);var Z=new Y(this,"ek.store."+ac);this.master=Z.select(M.Criterion.preferMyHypervisor());var ae=new M.BinaryWriter(1);ae.writeUint8(l.StoreNodeDisconnectFromWeb);this.master.impl.sendMessage(ae.createArrayBuffer(),I.onDisconnect);var ad=new M.BinaryWriter(1);ad.writeUint8(l.GetLocalMasterIdentifierFromWeb);this.master.impl.sendMessage(ad.createArrayBuffer());this.callbacks.unshift(function(ah){var ag=new M.BinaryReader(ah);this.port=ag.readUint32();this.hostname=ag.readString();return true}.bind(this))};function t(Z){if(typeof Z==="number"){Z={low:Z,high:0}}else{if(Z===undefined||!Z.hasOwnProperty("low")){Z={low:0,high:0}}}return Z}M.Store.prototype.get=function(ab,Z){var aa=new M.BinaryWriter(9);aa.writeUint8(l.GetFromWeb);var ac=t(ab);aa.writeUint32(ac.low);aa.writeUint32(ac.high);this.master.impl.sendMessage(aa.createArrayBuffer());this.callbacks.unshift(Z);return this};M.Store.prototype.put=function(aa,ac){var ab=t(aa);ac=R(ac);var Z=new M.BinaryWriter(17+ac.byteLength);Z.writeUint8(l.PutFromWeb);Z.writeUint32(ab.low);Z.writeUint32(ab.high);Z.writeUint64(ac.byteLength);Z.writeUint8Array(ac);this.master.impl.sendMessage(Z.createArrayBuffer());return this};M.Store.prototype.del=function(aa){var ab=t(aa);var Z=new M.BinaryWriter(17);Z.writeUint8(l.PutFromWeb);Z.writeUint32(ab.low);Z.writeUint32(ab.high);Z.writeInt64(-1);this.master.impl.sendMessage(Z.createArrayBuffer());return this};var s=function(ad){var ac=[];var Z=new M.BinaryReader(ad);var aa=Z.readUint64();for(var ab=0;ab<aa;++ab){ac[ab]={low:Z.readUint32(),high:Z.readUint32()}}return ac};M.Store.prototype.createKeys=function(aa,Z,ac){ac=ac||[];var ab=new M.BinaryWriter(9);ab.writeUint8(l.CreateKeysFromWeb);ab.writeUint64(aa);ab.writeUint64(ac.length);ab.writeStrings(ac);this.master.impl.sendMessage(ab.createArrayBuffer());this.callbacks.unshift(function(ae){var ad=s(ae);return Z(ad)});return this};M.Store.prototype.readKeys=function(Z,ac){var aa=new M.BinaryWriter(1);aa.writeUint8(l.ReadKeysFromWeb);var ab=R(Z);aa.writeUint8Array(ab);this.master.impl.sendMessage(aa.createArrayBuffer());this.callbacks.unshift(function(ad){var ae=s(ad);return ac(ae)});return this};var V=function(aa,ae,af){var Z=new M.BinaryReader(af);this.store=aa;this.keys={};for(var ad=0;ad<ae.length;++ad){if(this.keys[ae[ad].high]===undefined){this.keys[ae[ad].high]={}}this.keys[ae[ad].high][ae[ad].low]=undefined}this.fullSnapshot=Z.readBool();this.timeStamp=Z.readUint64();while(Z.tell()<af.byteLength){var ac={low:Z.readUint32(),high:Z.readUint32()};var ab=Z.readInt64();if(this.keys[ac.high]===undefined){this.keys[ac.high]={}}this.keys[ac.high][ac.low]=Z.readArrayBuffer(ab)}};var j=function(aa,ae){var ad=[];var Z=new M.BinaryReader(ae);aa.timeStamp=Z.readUint64();while(Z.tell()<ae.byteLength){var ac=ad[ad.length]={low:Z.readUint32(),high:Z.readUint32()};var ab=Z.readInt64();aa.keys[ac.high][ac.low]=Z.readArrayBuffer(ab)}return ad};V.prototype.get=function(Z){var aa=t(Z);return this.keys[aa.high][aa.low]?this.keys[aa.high][aa.low]:new ArrayBuffer(0)};M.Store.prototype.createSnapshot=function(ad,ac){ac=ac||[];var ae;var af=9+8*ac.length;var ab=new M.BinaryWriter(af);ab.writeUint8(l.SnapshotFromWeb);ab.writeUint64(ac.length);for(var aa=0;aa<ac.length;++aa){ae=t(ac[aa]);ab.writeUint32(ae.low);ab.writeUint32(ae.high)}this.master.impl.sendMessage(ab.createArrayBuffer());var Z=this;this.callbacks.unshift(function(ag){return ad(new V(Z,ac,ag))});return this};V.prototype.last=function(Z){var af;var ad;var ac=0;for(af in this.keys){if(this.keys.hasOwnProperty(af)){var ab=Object.keys(this.keys[af]);ac+=ab.length}}var ag=17+8*ac;var ae=new M.BinaryWriter(ag);ae.writeUint8(l.LastSnapshotFromWeb);ae.writeUint64(this.timeStamp);ae.writeUint64(ac);for(af in this.keys){if(this.keys.hasOwnProperty(af)){for(ad in this.keys[af]){if(this.keys[af].hasOwnProperty(ad)){ae.writeUint32(ad);ae.writeUint32(af)}}}}this.store.master.impl.sendMessage(ae.createArrayBuffer());var aa=this;this.store.callbacks.unshift(function(ai){var ah=j(aa,ai);return Z(aa,ah)});return this};V.prototype.createObserver=function(ah,ac){var ae;var ad;var ag=0;for(ae in this.keys){if(this.keys.hasOwnProperty(ae)){var af=Object.keys(this.keys[ae]);ag+=af.length}}var aa=17+8*ag;var ab=new M.BinaryWriter(aa);ab.writeUint8(l.CreateObserverFromWeb);ab.writeBool(this.fullSnapshot);ab.writeUint32(this.store.observedCounter);ab.writeUint64(this.timeStamp);ab.writeDouble(ac);ab.writeUint64(ag);for(ae in this.keys){if(this.keys.hasOwnProperty(ae)){for(ad in this.keys[ae]){if(this.keys[ae].hasOwnProperty(ad)){ab.writeUint32(ad);ab.writeUint32(ae)}}}}var Z=this;this.store.observedSnapshots[this.store.observedCounter]={snapshot:Z,callback:ah};this.store.observedCounter++;this.store.master.impl.sendMessage(ab.createArrayBuffer());return this};V.prototype.deleteObserver=function(){var aa=new M.BinaryWriter(5);aa.writeUint8(l.DeleteObserverFromWeb);for(var Z=0;Z<this.store.observedCounter;++Z){if(this.store.observedSnapshots[Z]!==undefined&&this.store.observedSnapshots[Z].snapshot===this){aa.writeUint32(Z);this.store.observedSnapshots[Z]=undefined;this.store.master.impl.sendMessage(aa.createArrayBuffer());break}}return this};M.Batch=function(Z){this.commands={};this.store=Z};M.Batch.prototype.put=function(Z,ab){var aa=t(Z);ab=R(ab);if(this.commands[aa.high]===undefined){this.commands[aa.high]={}}this.commands[aa.high][aa.low]={size:ab.byteLength,binary:ab};return this};M.Batch.prototype.del=function(Z){var aa=t(Z);if(this.commands[aa.high]===undefined){this.commands[aa.high]={}}this.commands[aa.high][aa.low]={size:-1};return this};M.Batch.prototype.commit=function(){var ad=5;var ae;var ac=0;var ab;var Z;for(ab in this.commands){if(this.commands.hasOwnProperty(ab)){for(Z in this.commands[ab]){if(this.commands[ab].hasOwnProperty(Z)){ae=this.commands[ab][Z];ac++;ad+=16;if(ae.size!==-1){ad+=ae.size}}}}}var aa=new M.BinaryWriter(ad);aa.writeUint8(l.CommitFromWeb);aa.writeUint32(ac);for(ab in this.commands){if(this.commands.hasOwnProperty(ab)){for(Z in this.commands[ab]){if(this.commands[ab].hasOwnProperty(Z)){ae=this.commands[ab][Z];var af=new M.BinaryWriter(16);af.writeUint32(Z);af.writeUint32(ab);af.writeInt64(ae.size);aa.writeUint8Array(new Uint8Array(af.arrayBuffer));if(ae.size!==-1){aa.writeUint8Array(ae.binary)}}}}}this.store.master.impl.sendMessage(aa.createArrayBuffer());return this};M.defaultsMonitorCallbacks=Object.freeze({onConnect:function(){},onDisconnect:function(){},onHypervisorAdd:function(){},onHypervisorUpdate:function(){},onHypervisorUnresponsive:function(){},onHypervisorDelete:function(){}});M.defaultsMonitorOptions=Object.freeze({cpu:false,cpuLoad:false,ram:false,refreshIntervalInMilliseconds:1000});var h;function q(Z){var aa={_:"graph"};if(Z.options.cpu){aa.cpu=true}if(Z.options.cpuLoad){aa.cpuLoad=true}if(Z.options.ram){aa.ram=true}Z.lastRequest=Date.now();Z.timeout=undefined;Z.ws.sendMessage(JSON.stringify(aa))}function A(aa){aa=JSON.parse(aa);var ac={revision:aa.revision};if(this.options.cpu){ac.cpu=aa.cpu}if(this.options.cpuLoad){ac.cpuLoad=aa.cpuLoad}if(this.options.ram){ac.ram=aa.ram||aa.memory}var Z=!this.hypervisors.has(aa.id);this.hypervisors.add(aa.id);this.current.add(aa.id);if(aa.id===0){aa.links=aa.links||[];aa.links.forEach(function(ad){if(this.hypervisors.has(ad.id)){return}this.callbacks.onHypervisorAdd(ad.id,ad.hostname+":"+ad.port);this.hypervisors.add(ad.id)},this);this.current.forEach(function(ad){this.hypervisors["delete"](ad)},this);this.hypervisors.forEach(function(ae){var ad=aa.links.filter(function(af){return af.id===ae}).length!==0;if(ad){this.callbacks.onHypervisorUnresponsive(ae);this.current.add(ae)}else{this.callbacks.onHypervisorDelete(ae)}},this);this.hypervisors=this.current;this.current=new Set()}if(Z){this.callbacks.onHypervisorAdd(aa.id,aa.hostname+":"+aa.port)}this.callbacks.onHypervisorUpdate(aa.id,ac);if(aa.id===0&&this.running){var ab=Math.max(this.lastRequest+this.options.refreshIntervalInMilliseconds-Date.now(),0);this.timeout=setTimeout(q,ab,this)}}M.Monitor=function(ab,ac,aa){if(h===undefined){h=new WeakMap()}var Z={};h.set(this,Z);Z.callbacks=T({},M.defaultsMonitorCallbacks,ac);Z.options=T({},M.defaultsMonitorOptions,aa);Z.ws=new M.WebSocket();Z.ws.onOpen(Z.callbacks.onConnect);Z.ws.onClose(Z.callbacks.onDisconnect);Z.ws.onMessage(A.bind(Z));Z.ws.connect(ab,{hypervisorId:0,id:-2});Z.hypervisors=new Set();Z.current=new Set();Z.running=true;Z.lastRequest=0;Z.timeout=undefined;q(Z)};M.Monitor.prototype.pause=function(){var Z=h.get(this);clearTimeout(Z.timeout);Z.running=false;Z.timeout=undefined};M.Monitor.prototype.resume=function(){var aa=h.get(this);var Z=!aa.running;aa.running=true;if(Z&&aa.timeout===undefined){q(aa)}};M.Monitor.prototype.updateOptions=function(aa){var Z=h.get(this);Z.options=T(Z.options,aa);if(Z.running&&Z.timeout!==undefined){clearTimeout(Z.timeout);var ab=Math.max(Z.lastRequest+Z.options.refreshIntervalInMilliseconds-Date.now(),0);Z.timeout=setTimeout(q,ab,Z)}};M.Monitor.prototype.disconnect=function(){var Z=h.get(this);Z.ws.close()};Object.keys(a).forEach(function(Z){M[Z]=a[Z]});return M}())});