define("DS/DocumentManagement/FoundationAjax",["UWA/Core","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI"],function(f,a,b){"use strict";var d={widgetization:"ENOVIA_Application_Widget",getParams:function(){var k="";if(this.tenant&&this.tenant.length>0){k+="&tenant="+this.tenant}if(this.rows&&this.rows.length>0){k+="&e6w-objLimit="+this.rows}if(this.language&&this.language.length>0){var j=this.language;j=j==="zh"?"zh_CN":j;k+="&e6w-lang="+j}if(this.timezone){k+="&e6w-timezone="+this.timezone}var g=Object.prototype.hasOwnProperty;var h=this.preferences;for(var i in h){if(g.call(h,i)){k+="&"+i+"="+h[i]}}if(this.params&&this.params!==""){k+="&"+this.params}if(k!==""){k=k.substring(1)}return k},getParamsAsJSON:function(){var j={};if(this.tenant&&this.tenant.length>0){j.tenant=this.tenant}if(this.space&&this.space.length>0){j.SecurityContext=this.space}if(this.rows&&this.rows.length>0){j["e6w-objLimit"]=this.rows}if(this.language&&this.language.length>0){j["e6w-lang"]=this.language}if(this.timezone){j["e6w-timezone"]=this.timezone}var g=Object.prototype.hasOwnProperty;var h=this.preferences;for(var i in h){if(g.call(h,i)){j[i]=h[i]}}return j},setupEnoviaServer:function c(){var n,l,i,m,j;if(window.widget){n=window.widget.getUrl();l=window.widget.getUrl().match(/[?&]runYourApp=([^&]*)?/);i=b.getApplicationConfiguration("app.urls.myapps");n=n.substring(0,n.indexOf("/webapps"));m=window.widget.lang;j=window.widget.getValue("showSpace")||window.widget.getValue("widgetName")===d.widgetization||"false";window.widget.setValue("showSpace",j)}else{n=window.location.origin;j=""}if(!i||l){i=n}window.WidgetConstants={str:{}};var h=new Date();var k=h.getTimezoneOffset();var g=b.getUser();if(g&&g.login){g=g.login}window.enoviaServer={params:"",sRealURL:n,showSpace:j,objectId:"",widgetName:"",taggerContextId:"auto",appName:"",tenant:"",space:null,rows:null,preferences:{},storageUrl:i,language:m,timezone:k,_getUrl:function(){return this.storageUrl||this.sRealURL},getParams:d.getParams,getParamsAsJSON:d.getParamsAsJSON,computeUrl:function(o){return this._getUrl()+o},user:g};window.enoviaServer.storageUrl=window.enoviaServer.storageUrl.replace(":443","")},calculateFinalUrl:function e(j,i){var k=j;var h=f.Utils.parseUrl(j);if(h.protocol){return k}k=window.enoviaServer.computeUrl(k);k+=(k.indexOf("?")===-1)?"?":"&";var g=window.enoviaServer.getParams();if(g&&g.length>0&&!i){k+=g}else{k+="tenant="+window.enoviaServer.tenant}return k},ajaxRequest:function(l,m){var g=d.calculateFinalUrl(l.url,m);var h=f.clone(l.headers||{},false);!h["Accept-Language"]&&window.widget&&window.widget.lang&&(h["Accept-Language"]=window.widget.lang);var j=window.enoviaServer.space;if(!h.SecurityContext&&j&&j.length>0){h.SecurityContext=encodeURIComponent(j)}var i=l.onFailure||function(p,q){var r=q||{};if(!(r.success===false&&r.error)){r={error:"Network Error: Unable to load widget due to network or authentication error."}}l.callback.call(this,r)};var k=l.onTimeout||function(){l.callback.call(this,{error:"Network Error: Unable to load widget due to timeout error."})};var n=l.onCancel||function(){l.callback.call(this,{error:"Application Error: Request canceled."})};var o=a.authenticatedRequest(g,{method:l.type,type:l.dataType,proxy:"passport",timeout:500000,cache:3600,data:l.data,onComplete:l.callback,onFailure:i,onCancel:n,onTimeout:k,headers:h});o=o||{cancel:Function.prototype};return o},_newTempId:function(){return"temp_"+new Date().getTime()+Math.floor((Math.random()*10000))}};return d});define("DS/DocumentManagement/DriveDocumentManagement",["UWA/Core","UWA/Class","UWA/Utils","DS/DocumentManagement/FoundationAjax","DS/Foundation2/IndependentServiceBase"],function(c,a,g,b,h){var i="/resources/3ddrive/v1/bos/";var d=i+"ticket";var f="?tenant=";var j=h.extend({createDocument:function(l,m){var k=c.clone(m||{},false);k.create=true;k.driveFolderId=l.driveFolderId;this.modifyDocument(l,k)},downloadDocument:function(n,m){var o=this;var k=c.clone(m||{},false);var l;if(n){var q=c.clone(k.additionalHeaders||{},false);q["content-type"]="application/json";var p={url:k.tenantUrl+i+n+"/download",type:"get",dataType:"json",callback:function(r){if(r&&r.url){if(k.autoDownload){o.downloadWithPost(r.url,k)}else{if(c.is(k.onComplete,"function")){k.onComplete(r.url,k)}}}else{if(c.is(k&&k.onFailure,"function")){k.onFailure(r)}}},headers:q};l=b.ajaxRequest(p)}return l},modifyDocument:function(l,n){var k=c.clone(n||{},false);var o=this;var m;if(l&&l.fileInfo&&l.fileInfo.file){var q=c.clone(k.additionalHeaders||{},false);q["content-type"]="application/json";var p={url:k.tenantUrl+d+f+n.tenant,type:"get",dataType:"json",callback:function(t,v){if(t.ticket){var r=v["x-ds-csrftoken"];var s=c.clone(l.fileInfo||{},false);s.fileName=l.fileInfo.file.name;var u={csrf:r,fileInfo:s,docId:l.id,ticket:t.ticket,ticketparamname:t.jobticket,ticketURL:t.actionurl};o._handleTicket(u,k)}else{if(c.is(k&&k.onFailure,"function")){k.onFailure(t)}}},headers:q};m=b.ajaxRequest(p)}return m},_handleTicket:function(o,l){var m=this;var k=c.clone(l||{},false);var n=k.onComplete;k.onComplete=function(r,q){var p=c.clone(q||{},false);p.onComplete=n;o.fcsReceipt=r.trim();m._handleFCSReceipt(o,p)};m._checkinToFCS(c.merge(k,o))},_getFCSFormData:function(){var k=this._parent.apply(this,arguments);k.append("__fcs__nohtml",true);return k},_handleFCSReceipt:function(m,r){var l=c.clone(r||{},false);var o=m.fileInfo;var s={title:o.file.name,receipt:m.fcsReceipt};var p,q;if(l.create){q=l.driveFolderId+"/contents";s.type="DriveFile";p="post"}else{q=m.docId;p="put"}var k=l.tenantUrl+i+q+f+r.tenant;var n=c.clone(l.additionalHeaders||{},false);n["Content-Type"]="application/json";n["X-DS-CSRFTOKEN"]=m.csrf;return b.ajaxRequest({url:k,type:p,dataType:"json",data:JSON.stringify(s),callback:function(t){if(t&&t.id&&c.is(l.onComplete,"function")){l.onComplete(t)}else{if(c.is(l.onFailure,"function")){l.onFailure(t)}}},headers:n})},getNewBlobFileWithOldName:function(k,m){var l=m.get("title");k=new Blob([k],{type:k.type});k.name=l;return k},getFolders:function(m){var k=c.clone(m||{},false);var n=this;var l;var p=c.clone(k.additionalHeaders||{},false);p["content-type"]="application/json";var o={url:k.tenantUrl+d+f+k.tenant,type:"get",dataType:"json",callback:function(r,t){if(r){var q=t["x-ds-csrftoken"];var s={csrf:q,ticket:r.ticket,ticketparamname:r.jobticket,ticketURL:r.actionurl};n._handleTicketAndGetFoldersList(s,k)}else{if(c.is(k&&k.onFailure,"function")){k.onFailure(r)}}},headers:p};l=b.ajaxRequest(o);return l},_handleTicketAndGetFoldersList:function(p,m){var k=c.clone(m||{},false);var l;var o=c.clone(k.additionalHeaders||{},false);o["content-type"]="application/json";o["X-DS-CSRFTOKEN"]=p.csrf;var n={url:k.tenantUrl+i+"DSROOT/contents"+f+k.tenant,type:"get",dataType:"json",callback:function(q){if(q){k.callback(q)}else{if(c.is(k&&k.onFailure,"function")){k.onFailure(q)}}},headers:o};l=b.ajaxRequest(n);return l}});var e=new j();e.TICKET_URL=d;e.URL=i;e.TENANT_SUFFIX=f;return e});define("DS/DocumentManagement/DocumentManagement",["UWA/Core","DS/Foundation/FoundationAjax","DS/DocumentManagement/DriveDocumentManagement","DS/Foundation2/IndependentServiceBase"],function(d,c,l,h){var j=h.extend({MSFDocumentClient:null,SERVICE_ROOT_URL:"/resources/v1/modeler/documents/",deleteVersion:function(p,m,o,n){return this._deleteObject(this.SERVICE_ROOT_URL+p+"/files/"+m+"/versions/"+o,n)},deleteFile:function(o,m,n){return this._deleteObject(this.SERVICE_ROOT_URL+o+"/files/"+m,n)},deleteDocument:function(){return this._deleteRootObject.apply(this,arguments)},getDocuments:function(p,n){var m=d.clone(n||{},false);var o=m.additionalURLParams&&m.additionalURLParams.split("&")||[];if(n.getVersions){o.push("$include=versions")}var q=m.relInfo;if(q&&q.parentRelName){o.push("parentRelName="+q.parentRelName);o.push("parentDirection="+(q.parentDirection||"from"))}m.additionalURLParams=o.join("&");return this._getObjects(p,m)},connectDocumentToParent:function(o,n){var m=n||{};var p=m.relInfo;if(p){p.updateAction="CONNECT"}return this._handleDocumentParentConnection(o,m)},disconnectDocumentFromParent:function(o,n){var m=n||{};var p=m.relInfo;if(p){p.updateAction="DISCONNECT"}return this._handleDocumentParentConnection(o,m)},_handleDocumentParentConnection:function(o,u){var m=u||{};var t=u.relInfo;if(t&&t.parentId&&t.parentRelName&&o){var p=this;var r=this._prepareService(this._handleDocumentParentConnection.bind(this,o,u),m);if(r){return r}var s={csrf:this.getCsrf(m.tenantUrl),data:[{id:o,updateAction:"NONE",relateddata:{parents:[{id:t.parentId,updateAction:t.updateAction}]}}]};var n=d.clone(m.additionalHeaders||{},false);n["content-type"]="application/json";var q={url:this.SERVICE_ROOT_URL+"?parentRelName="+t.parentRelName+"&parentDirection="+(t.parentDirection||"from"),type:"post",dataType:"json",data:JSON.stringify(s),callback:function(v){if(v&&v.csrf){p.setCsrf(v.csrf,m.tenantUrl)}if(v&&v.success&&d.is(u.onComplete,"function")){u.onComplete(v,u)}else{if(d.is(u.onFailure,"function")){u.onFailure(v)}}},headers:n};return c.ajaxRequest(q)}else{throw new Error("Invalid input")}},getDocumentsFromParent:function(n){var m=n;if(n.getVersions){m=d.clone(n||{},false);m.additionalURLParams="$include=versions"}var p=n.relInfo;if(p&&p.parentId&&p.parentRelName){var o=this;m.requestType="get";m.csrf=m.csrf||"notNeeded";this._prepareService(this.getDocumentsFromParent.bind(this,n),m);c.ajaxRequest({url:this.SERVICE_ROOT_URL+"parentId/"+p.parentId+"?parentRelName="+p.parentRelName+"&parentDirection="+(p.parentDirection||"from")+(m.additionalURLParams?"&"+m.additionalURLParams:""),type:"get",dataType:"json",callback:function(q){if(q&&q.csrf){o.setCsrf(q.csrf,m.tenantUrl)}if(q&&q.success&&d.is(n.onComplete,"function")){n.onComplete(q,n)}else{if(d.is(n.onFailure,"function")){n.onFailure(q)}}}})}},downloadDocument:function(o,p,t,u){var m=u||{};if(m.serviceId==="3DDrive"){return l.downloadDocument(o,m)}if(this.MSFDocumentClient&&this.MSFDocumentClient.isConnectedToMSFClient()&&u.autoDownload===true){return this.MSFDocumentClient.downloadDocumentFromMSF(o,p,t,u)}var q=m.onComplete;var s=this;var r="";if(m.tenantUrl){r=m.tenantUrl}r+=this.SERVICE_ROOT_URL+o+"/files/"+(t?"CheckoutTicket":"DownloadTicket");var w=this._prepareService(this.downloadDocument.bind(this,o,p,t,u),m);if(w){return w}var x={csrf:this.getCsrf(m.tenantUrl)};if(p){if(d.is(p,"string")){x.data=[{id:p}]}else{x.data=[{dataelements:p}]}}var n=d.clone(m.additionalHeaders||{},false);n["content-type"]="application/json";var v={url:r,type:"put",dataType:"json",data:JSON.stringify(x),callback:function(z){if(z&&z.csrf){s.setCsrf(z.csrf,m.tenantUrl)}if(z&&z.data&&z.data.length&&z.data[0].dataelements&&z.data[0].dataelements.ticketURL){var y=z.data[0].dataelements.ticketURL;if(m.autoDownload){s.downloadWithPost(y,m)}else{if(d.is(q,"function")){q(y,m)}}}else{if(d.is(m.onFailure,"function")){m.onFailure(z,m)}}},headers:n};return c.ajaxRequest(v)},downloadDocuments:function(t,u){if(this.MSFDocumentClient&&this.MSFDocumentClient.isConnectedToMSFClient()){return this.MSFDocumentClient.downloadDocumentsFromMSF(t,u)}var m=u||{};var o=m.onComplete;var s=this;var r=this.SERVICE_ROOT_URL+"DownloadTicket";var w=t.length;if(!w){throw new Error("no document to download")}var q=[];for(var p=0;p<w;p++){q.push({id:t[p]})}var x=this._prepareService(this.downloadDocuments.bind(this,t,u),m);if(x){return x}var y={csrf:this.getCsrf(m.tenantUrl),data:q};if(m.asZip){r+="?zipFiles=true"}var n=d.clone(m.additionalHeaders||{},false);n["content-type"]="application/json";var v={url:r,type:"put",dataType:"json",data:JSON.stringify(y),callback:function(F){if(F&&F.csrf){s.setCsrf(F.csrf,m.tenantUrl)}var E=false;var A=false;var G=[];if(F&&F.success){if(F&&F.data&&F.data.length){var C=F.data.length;for(var z=0;z<C;z++){var D=F.data[z];var B={id:D.id,errorMessage:D.updateMessage};if(D.dataelements&&D.dataelements.ticketURL){B.downloadUrl=D.dataelements.ticketURL;if(D.dataelements.fileName){B.fileName=D.dataelements.fileName}if(D.dataelements.fileNames){B.fileNames=D.dataelements.fileNames}E=true}else{A=true}if(D.updateMessage){A=true}G.push(B)}}}else{A=true}if(E&&d.is(o,"function")){o(G)}if(A&&d.is(m.onFailure,"function")){m.onFailure(G,F,m)}},headers:n};return c.ajaxRequest(v)},createDocument:function g(m,n){if(m.driveFolderId){return l.createDocument(m,n)}return this._handleDocument(m,n)},addFileToDocument:function f(m,n){m.fileInfo.newFile=true;return this._handleDocument(m,n)},modifyDocument:function e(m,n){return this._handleDocument(m,n)},_handleDocument:function(p,v){var n=d.clone(v,false);var u=d.clone(p,false);if(!n.fileDropped&&this.MSFDocumentClient&&this.MSFDocumentClient.isConnectedToMSFClient()){return this.MSFDocumentClient.creatDocumentFromMSF(p,v)}if(u.fileInfo&&u.fileInfo.title){u.fileInfo=d.clone(u.fileInfo,false);delete u.fileInfo.title}if(d.is(u,"array")){var x=u.length;var s=[];for(var q=0;q<x;q++){var m=u[q];s.push(this._handleDocument(m,v))}return s}else{var t=this;if(!n.csrf&&u.fileInfo){n.csrf="notNeeded"}var r=this.SERVICE_ROOT_URL+"files/CheckinTicket";var y=this._prepareService(this._handleDocument.bind(this,u,v),n);if(y){return y}var z={csrf:this.getCsrf(n.tenantUrl)};n.documentInfo=u;if(u&&u.fileInfo&&u.fileInfo.file){var o=d.clone(n.additionalHeaders||{},false);o["content-type"]="application/json";var w={url:r,type:"put",dataType:"json",data:JSON.stringify(z),callback:function(A){t._handleTicket(A,n)},headers:o};return c.ajaxRequest(w)}else{return this._handleFCSReceipt(undefined,n)}}},_buildDocumentDataElements:function i(m,w){var p=(w&&w.documentInfo)||Object.create(null);var u=p.description;var s=p.title;var q=p.collabspace;var n=p.id;var v=p.policy;var o=p.fileInfo&&p.fileInfo.file;var r=o&&o.name;var y=p.relInfo;m.dataelements=Object.create(null);if(!s&&!n){if(r){var t=r.lastIndexOf(".");var x=r;if(t!==-1){x=x.substring(0,t)}s=x}}if(s){m.dataelements.title=s}if(q){m.dataelements.collabspace=q}if(u){m.dataelements.description=u}if(v){m.dataelements.policy=v}if(!n&&y){m.dataelements.parentId=y.parentId;m.dataelements.parentRelName=y.parentRelName;if(y.parentDirection){m.dataelements.parentDirection=y.parentDirection}}if(!Object.keys(m.dataelements).length){delete m.dataelements}},_buildFilesRelatedData:function a(m,w){var q=w.documentInfo||Object.create(null);var u=q.fileInfo||Object.create(null);var p=u.file;var o=u.id;var t=p&&p.name;var s=u.comments;var v=u.format;var r=w.fcsReceipt;var n=q.id;if(q.fileInfo){m.relateddata={files:[{dataelements:{}}]};if(t){m.relateddata.files[0].dataelements.title=t}if(s){m.relateddata.files[0].dataelements.comments=s}if(v){m.relateddata.files[0].dataelements.format=v}if(s){m.relateddata.files[0].dataelements.comments=s}if(r){m.relateddata.files[0].dataelements.receipt=r}if(p&&n){if(o||!u.newFile){m.relateddata.files[0].updateAction="REVISE";w.urlParams="?$include=versions"}else{m.relateddata.files[0].updateAction="CREATE"}}}},_handleFCSReceipt:function b(q,v){var s=this;var m=d.clone(v||{},false);m.urlParams="";var p=m.documentInfo||Object.create(null);var t=p.type;var o=p.id;var w=p.tempId;var r=Object.create(null);this._buildDocumentDataElements(r,m);m.fcsReceipt=q;this._buildFilesRelatedData(r,m);if(t){r.type=t}if(o){r.id=o}else{r.tempId=w||c._newTempId()}var u={csrf:s.getCsrf(v&&v.tenantUrl),data:[r]};if(!r.dataelements&&!r.tempId){r.updateAction="NONE"}if(v.isImage){m.urlParams+=m.urlParams.length?"&":"?";m.urlParams+="$fields=!image"}var n=d.clone(v.additionalHeaders||{},false);n["content-type"]="application/json";return c.ajaxRequest({url:this.SERVICE_ROOT_URL+m.urlParams,type:o?"put":"post",dataType:"json",data:JSON.stringify(u),callback:function(x){if(x&&x.csrf){s.setCsrf(x.csrf,v&&v.tenantUrl)}if(x&&x.success&&d.is(v.onComplete,"function")){v.onComplete(x,v)}else{if(d.is(v.onFailure,"function")){v.onFailure(x)}}},headers:n})}});var k=new j();return k});