define("DS/ExperiencePlay/EPPlayerServices",["DS/ExperienceKernel/ExperienceKernel","DS/EP/EP"],function(d,a){var c=function(){this.cmder=undefined;this.store=undefined;this.mapOfKeys={}};c.prototype.connectPlatform=function(h,g){return function(i,j){this.cmder=new a.Commander({ip:h,port:g,onDisconnect:j});this.cmder.sendEventToPlayer("Ping")(i,j);this.store=new d.Store("EPStore",{hypervisorIp:this.cmder.ip,webSocketPort:this.cmder.port})}.bind(this)};c.prototype.checkConnect=function(){if(this.cmder===undefined){console.error("EP.PlayerServices must be connected before to be used: call EP.PlayerServices.prototype.connect.");return false}return true};c.prototype.launchEngineInstance=function(i,g,h){return function(j,k){this.launchEngineInstances([{engineName:i,engineID:g,commandLine:h}])(function(l){j(l[0].engineName,l[0].engineID,l[0].commandLine)},k)}.bind(this)};c.prototype.launchEngineInstances=function(g){return function(j,m){if(this.checkConnect()){var l=new a.JSONMessage("LaunchEngines","PlayerServices");l.dataStr="LaunchEngines";for(var k=0;k<g.length;++k){var h=(g[k].commandLine!==undefined?g[k].commandLine:"");if(g[k].engineID!==undefined){h+=' " -pool '+g[k].engineID+' " '}l.parameters.push({name:g[k].engineName,valueType:a.JSONMessage.EValueType.eString,value:h})}this.cmder.sendToPlayer(l)(function(){if(j!==undefined){return j(g)}},function(){if(m===undefined){return console.error("The command launchEngineInstances failed!")}else{return m(g)}})}}.bind(this)};c.prototype.getActiveEngines=function(){return function(g,i){if(this.checkConnect()){var h=new a.JSONMessage("GetActiveEngineList","PlayerServices");this.cmder.sendToPlayer(h)(function(l){if(g!==undefined){var j=[];for(var k=0;k<l.parameters.length;++k){j.push({engineName:l.parameters[k].value.name,engineID:l.parameters[k].value.ID,commandLine:l.parameters[k].value.commandLine})}return g(j)}},i)}}.bind(this)};var f=["none","started","paused"];c.prototype.getState=function(){return function(g,i){if(this.checkConnect()){var h=new a.JSONMessage("GetState","PlayerServices");this.cmder.sendToPlayer(h)(function(k){if(g!==undefined){var j=f[0];if(k.parameters.length>0){j=f[k.parameters[0].value]}return g(j)}},i)}}.bind(this)};c.prototype.start=function(){return function(g,h){if(this.checkConnect()){this.cmder.sendBasicEventToPlayer("Start")(g,h)}}.bind(this)};c.prototype.pause=function(){return function(g,h){if(this.checkConnect()){this.cmder.sendBasicEventToPlayer("Pause")(g,h)}}.bind(this)};c.prototype.resume=function(){return function(g,h){if(this.checkConnect()){this.cmder.sendBasicEventToPlayer("Resume")(g,h)}}.bind(this)};c.prototype.stop=function(){return function(g,h){if(this.checkConnect()){this.cmder.sendBasicEventToPlayer("Stop")(g,h)}}.bind(this)};c.prototype.terminateAllEngines=function(){return function(g,h){if(this.checkConnect()){this.cmder.sendBasicEventToPlayer("TerminateEngines")(g,h)}}.bind(this)};c.prototype.terminateEngineInstance=function(g){return function(h,j){if(this.checkConnect()){var i=new a.JSONMessage("TerminateEngines","PlayerServices");i.parameters.push({name:"ID",valueType:a.JSONMessage.EValueType.eString,value:g});this.cmder.sendToPlayer(i)(function(){if(h!==undefined){return h(g)}},function(){if(j===undefined){return console.error("The command terminateEngineInstance of "+g+") failed!")}else{return j(g)}})}}.bind(this)};c.prototype.terminatePlatform=function(){return function(g,i){if(this.checkConnect()){var h=new a.JSONMessage("TerminatePlatform","PlayerServices");this.cmder.sendToPlayer(h)(g,i)}}.bind(this)};function b(j){var h=[];if(j.length>0){var g=new d.BinaryReader(j[0].buffer);var i=g.getSize();while(g.tell()<i){h.push(a.Def.readConnector(g))}}return h}c.prototype.requestProvidingConnectorsTo=function(g){return function(h,j){var i=new a.JSONMessage("RequestConnectors","PlayerServices");i.parameters.push({name:"Type",valueType:a.JSONMessage.EValueType.eInt,value:2});i.parameters.push({name:"EngineName",valueType:a.JSONMessage.EValueType.eString,value:g});this.cmder.sendToPlayer(i)(function(k){if(h!==undefined){return h(g,b(k.parameters))}},function(){if(j===undefined){return console.error("The command requestProvidingConnectorsTo "+g+" failed!")}else{return j(g)}})}.bind(this)};c.prototype.requestConsumingConnectorsTo=function(g){return function(h,j){var i=new a.JSONMessage("RequestConnectors","PlayerServices");i.parameters.push({name:"Type",valueType:a.JSONMessage.EValueType.eInt,value:1});i.parameters.push({name:"EngineName",valueType:a.JSONMessage.EValueType.eString,value:g});this.cmder.sendToPlayer(i)(function(k){if(h!==undefined){return h(g,b(k.parameters))}},function(){if(j===undefined){return console.error("The command requestConsumingConnectorsTo "+g+" failed!")}else{return j(g)}})}.bind(this)};c.prototype.requestPluggedConnections=function(){return function(g,i){if(this.checkConnect()){var h=new a.JSONMessage("RequestConnections","PlayerServices");this.cmder.sendToPlayer(h)(function(o){if(g!==undefined){var m=[];for(var l=0;l<o.parameters.length;++l){var j=new d.BinaryReader(o.parameters[l].buffer);var p=a.Def.readConnector(j);var n=[];var k=j.getSize();while(j.tell()<k){n.push(a.Def.readConsumer(j))}m.push({provider:p,consumers:n})}return g(m)}},i)}}.bind(this)};function e(g){if(g!==undefined){return function(i,k){var j,h;if(i.consumers.length>0){j=i.consumers[0].ownerEngineName;h=i.consumers[0].name}g(i.provider.ownerEngineName,i.provider.name,j,h,k)}}return undefined}c.EdiffusionType={eUndef:0,eSend:1,eStore:2};c.ConnectionSynchronism={nonBlocking:0,blocking:1};c.prototype.plugBySend=function(k,j,i,g,h){return function(l,m){this.plug(new a.Def.Connector(j,"Unknown",k,2),[(new a.Def.Connector(g,"Unknown",i,1)).plugBy(c.EdiffusionType.eSend,(h!==undefined?h:c.ConnectionSynchronism.nonBlocking))])(e(l),e(m))}.bind(this)};c.prototype.plugBySendBlocking=function(j,i,h,g){return this.plugBySend(j,i,h,g,c.ConnectionSynchronism.blocking)};c.prototype.plugByStore=function(j,i,h,g){return function(k,l){this.plug(new a.Def.Connector(i,"Unknown",j,2),[(new a.Def.Connector(g,"Unknown",h,1)).plugBy(c.EdiffusionType.eStore,c.ConnectionSynchronism.nonBlocking)])(e(k),e(l))}.bind(this)};c.prototype.plug=function(l,h){if(l.ownerEngineName===undefined){l.ownerEngineName="ConnectionServices";if((l.name===undefined)&&(h.length>0)){l.name=h[0].name}}var i=new d.BinaryWriter();l.write(i);for(var g=0;g<h.length;++g){if(h[g].ownerEngineName===undefined){h[g].ownerEngineName="ConnectionServices";if(h[g].name===undefined){h[g].name=l.name}}h[g].write(i)}var k={provider:l,consumers:h};return function(j,p){var o=new a.JSONMessage("PlugConnection","PlayerServices");o.parameters.push({name:"Connection",valueType:a.JSONMessage.EValueType.eBuffer,buffer:i.createArrayBuffer()});var n=function(r){var s={key:undefined,playerServices:this};if((this.store!==undefined)&&(r.parameters.length>0)){var q=new d.BinaryReader(r.parameters[0].buffer);s.name=q.readString();q.readKeys(this.store,function(t){this.key=t[0];if(this.binary){this.playerServices.store.put(this.key,this.binary)}}.bind(s));if((this.mapOfKeys[s.name])&&(this.mapOfKeys[s.name].binary)){s.binary=this.mapOfKeys[s.name].binary}this.mapOfKeys[s.name]=s}if(j!==undefined){return j(k,s)}}.bind(this);var m=function(){if(p===undefined){return console.error("The command PlugConnection from "+l.ownerEngineName+" "+l.name+" failed!")}else{return p(k)}};this.cmder.sendToPlayer(o)(n,m)}.bind(this)};c.prototype.unPlug=function(m,j,i,g){if(m===undefined){m="ConnectionServices";if(j===undefined){j=g}}if(i===undefined){i="ConnectionServices";if(g===undefined){g=j}}var l=new a.Def.Connector(j,"Unknown",m,2);var h=(new a.Def.Connector(g,"Unknown",i,1)).plugBy(c.EdiffusionType.eUndef,c.ConnectionSynchronism.nonBlocking);var k=new d.BinaryWriter();l.write(k);h.write(k);return function(n,p){var o=new a.JSONMessage("UnPlugConnection","PlayerServices");o.parameters.push({name:"Connection",valueType:a.JSONMessage.EValueType.eBuffer,buffer:k.createArrayBuffer()});this.cmder.sendToPlayer(o)(function(){if(n!==undefined){return n(m,j,i,g)}},function(){if(p===undefined){return console.error("The command UnPlugConnection from "+m+" "+j+" to "+i+" "+g+" failed!")}else{return p(m,j,i,g)}})}.bind(this)};c.prototype.setInitData=function(h,g,i){return function(j,l){var k="ConnectionServices_"+g;this.mapOfKeys[k]={binary:i};this.plugByStore(undefined,undefined,h,g)(function(){if(j!==undefined){return j(h,g,i)}},function(){if(l===undefined){return console.error("The command setInitData to "+h+" "+g+" failed!")}else{return l(h,g,i)}})}.bind(this)};c.prototype.exportConfiguration=function(){return function(g,h){if(this.checkConnect()){this.getActiveEngines()(function(i){var j=new a.JSONMessage("GetInitDataForExport","PlayerServices");this.cmder.sendToPlayer(j)(function(l){var k=l.parameters;this.requestPluggedConnections()(function(m){var n={engines:i,connections:m,initData:k};return g(n)},h)}.bind(this),h)}.bind(this),h)}}.bind(this)};c.prototype.importConfiguration=function(g){return function(k,q){if(this.checkConnect()){if(g!==undefined){if((g.engines!==undefined)&&(g.engines.length>0)){var o=[];if(g.connections!==undefined){for(var n=0;n<g.connections.length;++n){var h=g.connections[n];for(var l=0;l<h.consumers.length;++l){var m=h.consumers[l];o.push({provider:(new a.Def.Connector()).copy(h.provider),consumers:[(new a.Def.Consumer()).copy(m)]})}}}var p=function(){if(o.length>0){var i=o.shift();return this.plug(i.provider,i.consumers)(p.bind(this),q)}return(k?k(g):undefined)};return this.launchEngineInstances(g.engines)(function(){if((g.initData!==undefined)&&(g.initData.length>0)){var i=new a.JSONMessage("SetInitDataForImport","PlayerServices");i.parameters=g.initData;return this.cmder.sendToPlayer(i)(p.bind(this),q)}return p.bind(this)()}.bind(this),q)}}return(q?q(g):undefined)}}.bind(this)};a.PlayerServices=c;return c});