define("DS/DMUReadPersistence/CAT3DReviewTestLoadCmd",["UWA/Core","UWA/Controls/Abstract","DS/ApplicationFrame/Command"],function(f,e,b){var d=e.extend({init:function(g){this._parent(g);var j=null;var h=new FileReader();var k=false;function i(){if(!k&&g.onErrorCB){g.onErrorCB()}}j=new f.createElement("input",{id:"TestFileSelector"}).inject(widget.body);j.setAttribute("type","file");j.setAttribute("accept",".json");j.setStyles({opacity:0});j.onchange=function(){if(j){var l=j.files;if(!l||l&&!l.length){i();return}h.onload=function(){k=true;g.onFileLoadedCB(JSON.parse(h.result))};setTimeout(i,5000);h.readAsText(l[0])}};this.openFileBrowser=function(){j.click()};this.cleanFileBrowser=function(){if(j&&j.parentNode===widget.body){widget.body.removeChild(j)}j=null}}});var a;var c=b.extend({init:function(g){this._parent(g,{mode:"shared"});this.setRepeatMode(false);var h=this;this.initFileBrowser=function(){a=new d({onErrorCB:function(){alert("Error")},onFileLoadedCB:function(i){var j=["DS/DMUExperienceAPI/DMUExperienceImporterAPI","DS/PADUtils/PADContext"];require(j,function(k,m){var l=new k({context:m.get()});l.importModel({json:i})});a.cleanFileBrowser();a=null;h.end()}})};this.initFileBrowser()},beginExecute:function(){if(!a){this.initFileBrowser()}a.openFileBrowser()}});return c});define("DS/DMUReadPersistence/DMUReadPersistence",[],function(){});define("DS/DMUReadPersistence/DMUModalsForm",["UWA/Class","DS/Windows/Dialog","DS/Controls/Button","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"],function(a,c,b,d){return a.extend({init:function(f){this._parent(f);var e;var g={};var h=false;if(f.onValidateCB){g.Ok=new b({emphasize:"primary",touchMode:true,label:d.ValidateModalLabel,onClick:function(i){h=true;f.onValidateCB(i)}})}if(f.onCancelCB&&f.displayCancelButton){g.Cancel=new b({label:d.CloseModalLabel,touchMode:true,onClick:function(i){h=true;f.onCancelCB(i)}})}e=new c({touchMode:true,modalFlag:true,ensureHeightDefinitionOnHierarchy:true,title:f.title,resizableFlag:true,immersiveFrame:f.frmWindow.getImmersiveFrame(),buttons:g,content:f.content,minWidth:f.minWidth?f.minWidth:undefined,minHeight:f.minHeight?f.minHeight:undefined});e.addEventListener("close",function(){if(!h&&f.onCancelCB){f.onCancelCB()}});this.destroy=function(){if(e){e.destroy();e=null;if(f.onCancelCB){f.onCancelCB()}}}}})});define("DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting",["UWA/Class","UWA/Class/Options","DS/Logger/Logger","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/DMUBaseExperience/EXPPreferences","DS/WAFData/WAFData"],function(d,b,c,g,f,a){var e=d.singleton(b,{init:function(){var l=c.getLogger(e);l.log("init");this.setOptions({navigate_opts:{timeout:20000}});var o=this,i;var n=["DS/PADUtils/PADSettingsMgt"];require(n,function(p){i=p;h()},function(){i=null});function m(r){var s;var p=o.getOption("platform_services");if(UWA.is(r)){var t=r.value?r.value:r;for(var q=0;q<p.length&&!UWA.is(s);q++){if(p[q].platformId===t){s=q}}}if(!UWA.is(s)){window.console.warn("Tenant not found => Tenant idx by default is 0");s=0}return s}function k(){var q=o.get3DSpaceUrl()+"/resources/pno/person/getsecuritycontext";var p={};p.method="GET";p.type="json";p.onComplete=function(r){if(r&&r!==""&&r.hasOwnProperty("SecurityContext")){var s=null;var t="";if(r.SecurityContext.indexOf("ctx::")!==0){t="ctx::"}s=t+r.SecurityContext;f.writeLocal("ServerContext",s)}};p.onFailure=function(){window.console.log("pno/person/getsecuritycontext failed")};a.authenticatedRequest(q,p)}function h(){l.log("app_initialization");g.getPlatformServices({onComplete:function(p){o.setOption("platform_services",p);k()},onFailure:function(){l.warn("Cannot retrieve the Platform Services")}})}this.sendWebServiceCall=function(q,p,u,r){if(i){var t=UWA.clone(p,false);t.onComplete=u;t.onFailure=r;t.method=t.verb;t.headers={Accept:"application/json","Content-Type":"application/json","Accept-Language":i.getSetting("lang"),SecurityContext:i.getSetting("pad_security_ctx")};if(typeof t.data==="object"){t.data=JSON.stringify(t.data)}var s=[];s.push("securityContext");s.push(i.getSetting("pad_security_ctx"));s.push("tenant");s.push(o.getOption("platform_services")[m(i.getSetting("x3dPlatformId"))].platformId);a.authenticatedRequest(o.get3DSpaceUrl()+"/"+q+j(s),t)}};function j(r){if(r===null&&r===undefined){return""}var s="";if(Array.isArray(r)){var p=r.length/2;for(var q=0;q<p;q++){s+=(q===0)?"?":"&";s+=r[2*q]+"="+r[2*q+1]}}return encodeURI(s)}this.get3DSpaceUrl=function(){if(!UWA.is(o.getOption("platform_services","array"))||!i){throw new Error("Platform services not initialize yet")}var p=i.getSetting("x3dPlatformId");return o.getOption("platform_services")[m(p)]["3DSpace"]};this.getTenant=function(){return i?i.getSetting("x3dPlatformId"):null}},doInitialize:function(){}});return e});define("DS/DMUReadPersistence/DMUPersistenceServices",["UWA/Class","DS/DMUBaseExperience/EXPExportServices","DS/DMUBaseExperience/EXPImportServices","DS/DMUBaseExperience/DMUContextManager"],function(c,e,b,d){var a=c.extend({init:function(f){this.doExport=function(j,g){var t=0;var n=null;var p=[];var h=d.getReviewContext({viewer:f.viewer});if(h){var q=h.getPersistenceManager();if(q){p=q.getObjectsToPersist();var s=p.length;if(s>0){var o=new e(h);var m={};m.Version="1.0";m.Model=[];for(var l=0;l<p.length;l++){var r=p[l];if(r){if(r._isDirty===1){var k={};o.exportData(r,k);m.Model.push(k);t=1}else{t=2}}}n=JSON.stringify(m)}}}if(t===1){j(n)}else{g(t===2?"NoSaveNeeded":"error")}};this.importModel=function(h,i){if(h&&typeof h==="object"&&h.dataJson&&typeof h.dataJson==="object"&&h.dataJson.Model&&typeof h.dataJson.Model==="object"){var g=new b({viewer:f.viewer,experience:d.getReviewContext({viewer:f.viewer}),appType:h.appType});g.importDataModel(h.dataJson,function(){g.postImport();if(i){i()}})}else{if(i){i()}}}}});return a});define("DS/DMUReadPersistence/DMUReviewPersistenceServices",["UWA/Core","UWA/Class","UWA/Utils","DS/DMUReadPersistence/DMUModalsForm","DS/DMUControls/DMUWarningPanel","DS/DMUBaseExperience/EXPPreferences","DS/WAFData/WAFData","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUContextManager","DS/DMUControls/EXPNotify","DS/PlatformAPI/PlatformAPI","DS/WebappsUtils/WebappsUtils","DS/ApplicationFrame/CommandsManager","DS/3DSpaceDocumentConnector/3DSpaceDocumentConnector","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence","css!DMUReadPersistence/css/css_modalsForm.css"],function(e,b,k,q,p,j,l,o,m,h,n,c,a,i,g,d){var f=b.extend({init:function(){var B=this;var s=new i();var u,z,I,J;function w(){if(u&&u._counter>0){u.off()}}function F(U,V,O){var T='<div class="DMUPersistenceProductInfoMainDiv">';var N=o.getRootReferences(U.getViewer());if(N.length>1){for(var M=N.length-1;M>=0;M--){if(o.getNodeType(N[M])==="Drawing"){N.splice(M,1)}}}var L=[],R=[];var Q=N.length>0;if(Q){for(var M=0;M<N.length;M++){if(N[M]){L.push(o.getNodeID(N[M]))}}if(V.type==="CreatePanel"){T+='<p class="DMUPersistenceTitle">'+d.CreateReviewCmdHdr.Name+"</p>";T+='<input type="text" class="form-control" id="name_validation" placeholder="'+d.CreateReviewCmdHdr.NameInside+'">';T+='<p class="DMUPersistenceTitle">'+d.CreateReviewCmdHdr.Description+"</p>";T+='<input type="text" class="form-control" id="description_validation" placeholder="'+d.CreateReviewCmdHdr.DescriptionInside+'">'}else{if(V.type==="EditPanel"){T+='<p class="DMUPersistenceTitle">'+d.CreateReviewCmdHdr.Name+"</p>";T+='<input type="text" class="form-control" id="name_validation" value="'+V.Name+'">';T+='<p class="DMUPersistenceTitle">'+d.CreateReviewCmdHdr.Description+"</p>";if(V.Description===d.CreateReviewCmdHdr.StandardDescription){T+='<input type="text" class="form-control" id="description_validation" placeholder="'+d.CreateReviewCmdHdr.DescriptionInside+'">'}else{T+='<input type="text" class="form-control" id="description_validation" value="'+V.Description+'">'}}}}if(N.length>1&&V.type!=="EditPanel"){T+='<p class="DMUPersistenceTitle">'+d.ChooseRootForReviewCmdHdr.SelectRoot+"</p>";var P=m.getContextViewer({viewer:U.getViewer()});o.getName(N,function(Y){Q=false;for(var W=0;W<Y.length;W++){if(Y[W]!==""){Q=true;R.push("<option value="+L[W]+">"+Y[W]+"</option>")}}if(!R.length){return}T+='<select class="form-control" id="SelectProductID">';T+=R;T+="</select>";T+="</div>";O(T);if(Q){w();var X=document.getElementById("name_validation");if(X){X.focus()}}},P,"",true)}else{T+="</div>";O(T);if(N.length===1){w();var S=document.getElementById("name_validation");if(S){S.focus()}}}}function A(V,U,X,aa){var W=[];var Z=[];var Y=[];var S=[];var R=[];var N=[];var O=[];var Q=[];var M=V.length;for(var T=0;T<M;T++){O.push(V[T].MarkupTitle);N.push(V[T].MarkupDescription);Y.push(V[T].MarkupOwner);S.push(V[T].MarkupDateModified);R.push(V[T].MarkupThumbnail);Q.push(V[T].MarkupReservedby);W.push(V[T].MarkupTitle+" (Test_Owner)");Z.push(V[T].MarkupID)}var L=function(ab){x(ab,X,aa);if(z){z.destroy()}};D(O,Y,S,R,Q,N,L,aa,V,U);w();var P=document.getElementById("DMUPersistenceFilterName");if(P){P.focus()}}function x(L,R,P){var O=L?L.MarkupReservedby:null;if(O!==null&&s){var S=L.MarkupID;var Q=L.MarkupImageID;var N=L.MarkupName?L.MarkupName:L.MarkupTitle;var M={onComplete:function(T){var U={url:T[0].downloadUrl,responseType:"json",onComplete:function(W){var V={reviewPid:S,reviewThumbId:Q,reviewName:N,jsonObj:JSON.parse(W),modifiable:O&&O!==""?(O===n.getUser().login?true:false):true};R(V);if(window.widget){window.widget.dispatchEvent("onReviewLoaded",S)}},onFailure:P};l.request(U.url,{responseType:U.responseType,method:"GET",onComplete:U.onComplete,onFailure:U.onFailure,timeout:0})},onFailure:P};s.downloadDocuments([L.MarkupID],M)}else{P()}}function D(Z,am,Y,al,ag,O,P,ah,aj,S){var N="";var ai=[];var X="";var V=[];var M="";var L="";var R=d.SelectReviewCmdHdr.EditMarkupCmd;var U=d.SelectReviewCmdHdr.DeleteMarkupCmd;var W='<div class="DMUPersistenceFilterDiv"><input type="text" id="DMUPersistenceFilterName" placeholder="'+d.SelectReviewCmdHdr.Filter+'" autocomplete="off"></div>';var ae='<img class="DMUPersistenceLockIcon" src="'+c.getWebappsAssetUrl("DMUReadPersistence","images/lock.png")+'"/>';for(var ac=0;ac<Z.length;ac++){N='<img style="width:50px;height:38px;" src="'+al[ac]+'"/>';var ad=ac%2===0?' class="DMUPersistenceLine DMUPersistenceEvenLine" ':' class="DMUPersistenceLine"';if(ag[ac]!==""){L=d.ReservedBy+" : "+ag[ac]+" - "+d.Description+" : "+O[ac];M='<tr id="trTable_'+ac+'"'+ad+">";if(ag[ac]===n.getUser().login){M+='<td title="'+L+'">'+ae+Z[ac]+'</td><td  title="'+L+'">'+am[ac]+'</td><td  title="'+L+'">'+Y[ac]+'</td><td  title="'+L+'">'+N+'</td><td title="'+R+'" class="dmu-panel-td-not-hl"><p class="DMUPersistenceCmdIcons wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-pencil" style="opacity: 0.5; margin:0;" id="tdEdit_'+ac+'"></p></td><td title="'+U+'" class="dmu-panel-td-not-hl"><p class="DMUPersistenceCmdIcons wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-trash" style="opacity: 0.5;margin:0;" id="tdTrash_'+ac+'"></p></td></tr>'}else{M+='<td title="'+L+'">'+ae+Z[ac]+'</td><td title="'+L+'">'+am[ac]+'</td><td title="'+L+'">'+Y[ac]+'</td><td title="'+L+'">'+N+"</td><td></td><td></td></tr>"}}else{L=O[ac];M='<tr id="trTable_'+ac+'"'+ad+'><td title="'+L+'">'+Z[ac]+'</td><td title="'+L+'">'+am[ac]+'</td><td title="'+L+'">'+Y[ac]+'</td><td title="'+L+'">'+N+'</td><td title="'+R+'" class="dmu-panel-td-not-hl"><p class= "DMUPersistenceCmdIcons wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-pencil" style="opacity: 0.5;margin:0;" id="tdEdit_'+ac+'"></p></td><td title="'+U+'"class="dmu-panel-td-not-hl"><p class= "DMUPersistenceCmdIcons wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-trash" style="opacity: 0.5;margin:0;" id="tdTrash_'+ac+'"></p></td></tr>'}X=Z[ac]+" "+am[ac]+" "+Y[ac];V.push(X);ai.push(M);N=""}var Q="";for(var ab=0;ab<ai.length;ab++){Q+=ai[ab]}var af=W;af+='<div class="DMUPersistenceTableContainer">';af+='<table id="RevTableID" class="DMUPersistenceTable">';af+='<tbody id="RevTbodyID">';af+="<tr>";af+='<th style="width: 30%;" class="DMUPersistenceTitle">'+d.SelectReviewCmdHdr.Name+"</th>";af+='<th style="width: 15%;" class="DMUPersistenceTitle">'+d.SelectReviewCmdHdr.Owner+"</th>";af+='<th style="width: 35%;" class="DMUPersistenceTitle">'+d.SelectReviewCmdHdr.Date+"</th>";af+='<th style="width: 10%;" class="DMUPersistenceTitle">'+d.SelectReviewCmdHdr.Thumbnail+"</th>";af+='<th style="width: 5%;"></th>';af+='<th style="width: 5%;"></th>';af+="</tr>";af+=Q;af+="</tbody>";af+="</table>";var ak={};if(window.location.search!==""){e.extend(ak,k.parseQuery(window.location.search));if(ak.widgetDomain){e.extend(ak,k.parseQuery(ak.widgetDomain))}}if("debug_me" in ak||window.debug){af+='<button id="debugLoadJSONBtn">'+d.importJSONResultModelNLS+"</button>"}af+="</div>";if(z){z.destroy()}z=new q({frmWindow:S,title:d.SelectReviewCmdHdr.Title,onCancelCB:function(){ah("Cancel");if(z){z.destroy()}},minWidth:400,minHeight:150,content:af});r(aj,Z,P);G(aj,Z,S,V,ai);document.getElementById("DMUPersistenceFilterName").addEventListener("keyup",function(){y(V,ai);r(aj,Z,P);G(aj,Z,S,V,ai)});if("debug_me" in ak||window.debug){var T=m.getContextViewer({viewer:S.getViewer()});var aa=a.getCommand("LoadJSONCmdHdr",T.getCommandContext());if(aa){document.getElementById("debugLoadJSONBtn").addEventListener("click",function(){aa.begin();if(z){z.destroy()}w();P()})}}}function t(){var L=document.querySelectorAll(".DMUPersistenceLine");var M=0;for(var N=0;N<L.length;N++){if(L[N].style.display!=="none"){if(M%2===0&&L[N].className.indexOf("DMUPersistenceEvenLine")===-1){L[N].className="DMUPersistenceLine DMUPersistenceEvenLine"}else{if(M%2!==0&&L[N].className.indexOf("DMUPersistenceEvenLine")!==-1){L[N].className="DMUPersistenceLine"}}M++}}}function C(O,M,P,L){var N=M;P.addEventListener("click",function(){if(u){u.on(d.LoadingPanel,null)}L(O[N])})}function r(O,M,L){for(var N=0;N<M.length;N++){var P=document.getElementById("trTable_"+N);if(P){C(O,N,P,L)}}}function E(P,M,Q,L,N){var O=M;Q.addEventListener("click",function(R){new p({frmWindow:L,message:d.DeleteReviewPanel.Content+P[O].MarkupTitle+"?",title:d.DeleteReviewPanel.Title,callbacks:{onValidateCB:function(){B.deleteReview(P[O].MarkupID,function(){if(I){I.destroy()}I=new h({body:L.getUIFrame(),type:"info",messages:P[O].MarkupTitle+d.DeleteReviewPanel.Success});var T=document.getElementById("trTable_"+O);if(T){T.style.display="none";N[O]=T.outerHTML}t();var S=m.getReviewContext({viewer:L.getViewer()});if(S&&S._reviewPhysId){if(P[O].MarkupID===S._reviewPhysId.reviewId){window.widget.setValue("reviewIdInSession","")}}m.removeReviewContext({viewer:L.getViewer()});if(H(P)){if(z){z.destroy()}}},function(){if(I){I.destroy()}I=new h({body:L.getUIFrame(),type:"error",messages:d.DeleteReviewPanel.Error})})},onCancelCB:function(){}}});R.stopPropagation();R.preventDefault()})}function K(R,N,P,L,M,O){var Q=N;P.addEventListener("click",function(U){var S=false;var V=function(){var W=document.getElementById("name_validation").value;var X=document.getElementById("description_validation").value;if(X===""){X=d.CreateReviewCmdHdr.StandardDescription}var Z=W;Z=Z.replace(/ /g,"");if(Z===""){W=R[Q].MarkupTitle;Z=W}if(Z!==""){var Y=/[*:?<>|,\\/']/;if(Y.test(Z)||Y.test(X)){if(I){I.destroy()}I=new h({body:L.getUIFrame(),type:"error",messages:d.CreateReviewCmdHdr.SpecialCharacterError+' "'})}else{S=true;var aa=["DS/DocumentManagement/DocumentManagement"];require(aa,function(ad){if(ad){var ab={id:R[Q].MarkupID,title:W,description:X};var af=function(ag){var am=document.getElementById("trTable_"+Q);if(am){var ah=X;R[Q].MarkupDescription=X;if(R[Q].MarkupReservedby!==""){ah=d.ReservedBy+" : "+R[Q].MarkupReservedby+" - "+d.Description+" : "+R[Q].MarkupDescription;var an='<img class="DMUPersistenceLockIcon" src="'+c.getWebappsAssetUrl("DMUReadPersistence","images/lock.png")+'"/>';am.cells[0].innerHTML=an+W;am.cells[0].title=ah;am.cells[1].title=ah;am.cells[2].title=ah;am.cells[3].title=ah;am.cells[4].title=ah}else{am.cells[0].innerHTML=W;am.cells[0].title=ah;am.cells[1].title=ah;am.cells[2].title=ah;am.cells[3].title=ah}R[Q].MarkupTitle=W;var al=new Date(ag.data[0].dataelements.modified);var aj=al.toLocaleString();var ai=aj.replace(/,\s?/g," ");am.cells[2].innerHTML=ai;M[Q]=W+" "+R[Q].MarkupOwner+" "+ai;O[Q]=am.outerHTML;e.Event.dispatchEvent(document.getElementById("DMUPersistenceFilterName"),"keyup");var ak=m.getReviewContext({viewer:L.getViewer()});if(ak&&ak._reviewPhysId){if(R[Q].MarkupID===ak._reviewPhysId.reviewId){ak._reviewPhysId.reviewName=W}}if(I){I.destroy()}I=new h({body:L.getUIFrame(),type:"info",messages:d.EditReviewPanel.Success})}};var ae=function(){if(I){I.destroy()}I=new h({body:L.getUIFrame(),type:"error",messages:d.EditReviewPanel.Error})};var ac={onComplete:af,onFailure:ae,securityContext:j.readLocal("ServerContext"),tenant:g.getTenant(),tenantUrl:g.get3DSpaceUrl()};ad.modifyDocument(ab,ac)}})}}else{S=true}};var T={type:"EditPanel",Name:R[Q].MarkupTitle,Description:R[Q].MarkupDescription};if(J){J.destroy()}F(L,T,function(W){J=new q({frmWindow:L,title:d.EditReviewPanel.Title,onValidateCB:function(){V();if(S&&J){J.destroy()}},onCancelCB:function(){if(J){J.destroy()}},displayCancelButton:true,content:W,minWidth:400,minHeight:150})});U.stopPropagation();U.preventDefault()})}function G(R,N,L,M,Q){for(var O=0;O<N.length;O++){var S=document.getElementById("tdTrash_"+O);if(S){E(R,O,S,L,Q)}var P=document.getElementById("tdEdit_"+O);if(P){K(R,O,P,L,M,Q)}}}function H(N){var L=true;for(var M=0;M<N.length;M++){var O=document.getElementById("trTable_"+M);if(O){if(O.style.display!=="none"){L=false;break}}}return L}function y(N,W){var M=[];var U="";var T=document.getElementById("DMUPersistenceFilterName").value;for(var R=0;R<N.length;R++){var O=N[R];var L=new RegExp(T,"i");U=O.search(L);M.push(U)}var X=[];for(var R=0;R<N.length;R++){var P=M[R];if(P>=0){X.push(W[R])}}var V="";for(var Q=0;Q<X.length;Q++){V+=X[Q]}var S="<tr>";S+='<th style="width: 25%;" class="DMUPersistenceTitle">'+d.SelectReviewCmdHdr.Name+"</th>";S+='<th style="width: 25%;" class="DMUPersistenceTitle">'+d.SelectReviewCmdHdr.Owner+"</th>";S+='<th style="width: 30%;" class="DMUPersistenceTitle">'+d.SelectReviewCmdHdr.Date+"</th>";S+='<th style="width: 10%;" class="DMUPersistenceTitle">'+d.SelectReviewCmdHdr.Thumbnail+"</th>";S+='<th style="width: 5%;"></th>';S+='<th style="width: 5%;"></th>';S+="</tr>";S+=V;document.getElementById("RevTbodyID").innerHTML=S}function v(L,M,N,O){var P=["DS/ImageManagement/ImageManagement"];require(P,function(T){var R=L;var Q={onComplete:N,onFailure:O};if(M){var S={onComplete:function(){T.createImage(R,Q);var U={onComplete:function(){},onFailure:function(){}};T.deleteImage(M,U)},onFailure:function(){}};T.disconnectImage(R.parentId,M,S)}else{T.createImage(R,Q)}})}this.setProgressBar=function(L){if(L&&!u){u=L}};this.createReviewAndJSONFile=function(S,U,N,M){var Q=S;if(Q){if(Q.rootPhysicalId){var O=Q.json;var T=Q.thumbnail;var R=N;var L=M;var P=function(){if(u){u.on(d.SavingStep,null)}var W=document.getElementById("name_validation").value;var X=document.getElementById("description_validation").value;var V=document.getElementById("SelectProductID");if(X===""){X=d.CreateReviewCmdHdr.StandardDescription}var Z=W;Z=Z.replace(/ /g,"");if(Z!==""){var Y=/[*:?<>|,\\/']/;if(Y.test(Z)||Y.test(X)){if(I){I.destroy()}I=new h({body:U.getUIFrame(),type:"error",messages:d.CreateReviewCmdHdr.SpecialCharacterError+' "'});B.createReviewAndJSONFile(Q,U,N,M)}else{if(V===null){V=Q.rootPhysicalId}else{V=V.value}g.sendWebServiceCall("resources/markup/service/createmarkup",{verb:"POST",data:{sNameMarkup:W,sParentId:V,sDescription:X}},function(ac){var ad=JSON.parse(ac);var ab=ad.docId;var aa={markupName:W,thumbnail:T,json:O,reviewPhysicalId:ab,newFile:true};B.updateReviewAndJSONFile(aa,R,L)},function(){M()})}}else{if(I){I.destroy()}I=new h({body:U.getUIFrame(),type:"error",messages:d.CreateReviewCmdHdr.Error});B.createReviewAndJSONFile(Q,U,N,M)}};B.createForm(U,"CreatePanel",P,M)}else{M("NoContextForReview")}}};this.createForm=function(M,N,L,O){if(z){z.destroy()}F(M,{type:N},function(P){z=new q({frmWindow:M,title:N==="ChoosePanel"?d.ChooseRootForReviewCmdHdr.Title:d.CreateReviewCmdHdr.Title,onValidateCB:function(){L();if(z){z.destroy()}},onCancelCB:function(){O("Cancel");if(z){z.destroy()}},displayCancelButton:N==="CreatePanel"?true:false,minWidth:400,minHeight:150,content:P})})};this.getReviewAndJSONFile=function(R,M,N,P){var Q=null;var O=document.getElementById("SelectProductID");var L=true;if(O!==null){O=O.value}else{if(R){O=R}else{L=false;if(I){I.destroy()}I=new h({body:M.getUIFrame(),type:"error",messages:d.SelectReviewCmdHdr.Error})}}g.sendWebServiceCall("resources/markup/service/getmarkupinfo",{verb:"POST",data:{sProductId:O}},function(S){var T=JSON.parse(S);if(T.length===0){P("NoMarkup")}else{var U=["DS/DocumentManagement/DocumentManagement"];require(U,function(Z){if(Z){var Y=[];Q=T;for(var X=0;X<Q.length;X++){Y[X]=T[X].MarkupID}var W=function(aa){var ad=Q.length;var ac=aa.data.length;if(ad===ac){for(var ab=0;ab<ad;ab++){if(Q[ab].MarkupID===aa.data[ab].id){Q[ab].MarkupThumbnail=aa.data[ab].dataelements.image;Q[ab].MarkupReservedby=aa.data[ab].dataelements.reservedby;if(aa.data[ab].relateddata.files[0]){Q[ab].MarkupJsonFileID=aa.data[ab].relateddata.files[0].id}}}}if(L===true){A(Q,M,N,P)}};var V={onComplete:W,onFailure:P,securityContext:j.readLocal("ServerContext"),tenant:g.getTenant(),tenantUrl:g.get3DSpaceUrl()};Z.getDocuments(Y,V)}})}},function(){P()})};this.updateReviewAndJSONFile=function(L,M,N){var O=["DS/DocumentManagement/DocumentManagement"];require(O,function(aa){var ag=null;var V=L.reviewThumbId;var ab=L.markupName;if(L.thumbnail){var X=L.thumbnail.src.match(/data:([^;]*)(;base64)?,([0-9A-Za-z+/]+)/);var Q=atob(X[3]);var ae=new ArrayBuffer(Q.length);var U=new Uint8Array(ae);for(var Y=0;Y<U.length;Y++){U[Y]=Q.charCodeAt(Y)}ag=new Blob([U],{type:X[1]})}var ad=new Date().getTime();var Z="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(ai){var ah=(ad+Math.random()*16)%16|0;ad=Math.floor(ad/16);return(ai==="x"?ah:(ah&3|8)).toString(16)});var S=null;if(ag){S=ag;S.name=Z;S.fileName=Z}var P=new Blob([JSON.stringify(L.json)],{type:"application/json"});var af=null;if(P){af=P;af.name=Z;af.fileName=Z}var ac={fileInfo:{file:af,title:Z,newFile:L.newFile,fileName:Z},id:L.reviewPhysicalId};var W=function(ai){var aj=ai.data[0].id;if(S){var ah={file:S,parentId:ac.id,primaryImage:"ReviewThumbnail.png"};v(ah,V,function(ak){w();M({reviewId:aj,reviewThumbId:ak.data[0].id,reviewName:ab})},function(){w();N()})}};var T=function(ah){ah.reviewName=ab;N(ah)};var R={onComplete:W,onFailure:T,securityContext:j.readLocal("ServerContext"),tenant:g.getTenant(),tenantUrl:g.get3DSpaceUrl()};aa.modifyDocument(ac,R)})};this.deleteReview=function(L,M,N){var O=["DS/DocumentManagement/DocumentManagement"];require(O,function(Q){var P={onComplete:M,onFailure:N,securityContext:j.readLocal("ServerContext"),tenant:g.getTenant(),tenantUrl:g.get3DSpaceUrl()};Q.deleteDocument(L,P)})};this.getDMUServerCode=function(L,M){g.sendWebServiceCall("resources/markup/service/markupsinfo",{verb:"GET"},L,M)};this.getDnDReviewAndJSONFile=function(N,L,M){if(!N.serverurl){N.serverurl=g.get3DSpaceUrl()}if(!N.tenant){N.tenant=g.getTenant()}var O=["DS/DocumentManagement/DocumentManagement"];require(O,function(R){var Q=function(T){var S={MarkupID:N.markupId,MarkupJsonFileID:T&&T.data&&T.data.length&&T.data[0].relateddata&&T.data[0].relateddata.files&&T.data[0].relateddata.files.length?T.data[0].relateddata.files[0].id:undefined,MarkupImageID:T&&T.data&&T.data.length&&T.data[0].dataelements?T.data[0].dataelements.imageId:null,MarkupReservedby:T&&T.data&&T.data.length&&T.data[0].dataelements?T.data[0].dataelements.reservedby:null,MarkupName:T&&T.data&&T.data.length&&T.data[0].dataelements?T.data[0].dataelements.title:null};x(S,L,M)};var P={onComplete:Q,onFailure:M,securityContext:j.readLocal("ServerContext"),additionalURLParams:"$include=parents",tenantUrl:N.serverurl,tenant:N.tenant,relInfo:{parentRelName:"Markup",parentDirection:"from"}};R.getDocuments([N.markupId],P)})};this.getProductByMarkerId=function(N,L,M){if(!N||!N.physicalid){return}if(!N.serverurl){N.serverurl=g.get3DSpaceUrl()}if(!N.tenant){N.tenant=g.getTenant()}var O=["DS/DocumentManagement/DocumentManagement"];require(O,function(Q){var P={onComplete:function(R){if(R.data.length===0){M(R)}else{L(R)}},onFailure:M,securityContext:j.readLocal("ServerContext"),tenantUrl:N.serverurl,tenant:N.tenant,additionalURLParams:"$include=parents",relInfo:{parentRelName:"Markup",parentDirection:"from"}};Q.getDocuments([N.physicalid],P)})}}});return f});