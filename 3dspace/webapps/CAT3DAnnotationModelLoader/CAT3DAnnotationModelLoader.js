/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader",["UWA/Class","UWA/Utils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/LoaderUtils","DS/Visualization/AnnotationServices","DS/WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/CoreEvents/ModelEvents","DS/PADUtils/views/PADAlert","DS/PADUtils/views/PADProgressBar","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","i18n!DS/CAT3DAnnotationModelLoader/assets/nls/CAT3DAnnotationModelLoader"],function(b,l,m,k,f,n,g,c,e,a,j,d,o,i){var q=b.extend({init:function(V){this._parent(V);var aw=0;var T=V.ctxViewer;var C=V.favoriteCtxManager;var y=null;var D=new n();var ad=[];var ab=4;var v=this;var Y=new e();var z;var an=null;var W=0;var M=false;var N=[];var av=[];var A=[];var ay=[];var H=[];var G=[];var U=[];var B=[];var am=[];var ak=true;var ax=[];var at=[];var af={};var E=0;var I=0;var au=false;var R=false;this.setActiveState=function(aD){if(aD===aw||(aw!==0&&aw!==1&&aw!==2)){return}aw=aD;R=true;w();if(aw===1||aw===2){if(!y){v.setLoaderType()}aq();if(!af.onRemoveRoot){af.onRemoveRoot=T.subscribe({event:"onRootRemoved"},ai);af.on3DPlayAssetChanged=T.subscribe({event:"on3DPlayAssetChanged"},function(){ai({path:T.getRootBagPath()})});af.onRootAttached=T.subscribe({event:"onRootAttached"},u);af.onRootDetached=T.subscribe({event:"onRootDetached"},J);af.onHide=T.subscribe({event:"onHide"},ag);af.onShow=T.subscribe({event:"onShow"},s);af.onRefreshBegin=T.subscribe({event:"onRefreshBegin"},x);af.onRefreshCompleted=T.subscribe({event:"onRefreshCompleted"},r)}if(aw===1&&!af.onAddRoot){if(C){I=C.subscribe({event:"onFavoriteContextLoading"},K)}af.onAddRoot=T.subscribe({event:"onRootAdded"},F);af.onLoadingComplete=T.subscribe({event:"onLoadingComplete"},ar);af.onLoadingFailure=T.subscribe({event:"onLoadingFailure"},ar);af.onLoadingCanceled=T.subscribe({event:"onLoadingCanceled"},ar);E=d.subscribe("onPreferenceModified",ac);O()}}else{if(W>0){W=1;ah()}var aB=Object.keys(af);var aA;for(aA=0;aA<aB.length;aA++){T.unsubscribe(af[aB[aA]])}af={};if(E){d.unsubscribe(E);E=0}if(I&&C){C.unsubscribe(I);I=0}var aC=U.slice();for(aA=U.length-1;aA>=0;aA--){U[aA].getParentPath().getLastElement(true).removeChild(U[aA].getLastElement(true))}if(aC.length){ao("onAnnotationSetRemoved",{pathes:aC});T.getViewer().render()}G.splice(0,G.length);U.splice(0,U.length);B.splice(0,B.length);N.splice(0,N.length);av.splice(0,av.length);A.splice(0,A.length);ay.splice(0,ay.length);H.splice(0,H.length);am.splice(0,am.length)}ao("onAnnotModelLoaderActiveStateChanged",{state:aw});R=false};this.clear=function(){this.setActiveState(0);T=y=D=v=Y=z=af=am=null;ad=N=av=A=ay=H=G=U=B=ax=null};this.getActiveState=function(){return aw};var S=function(aF){var aB=aF.clone();var aE=aB.getLastElement(true);var aA;for(aA=0;aA<U.length;aA++){var aD=U[aA].getLastElement(true);if(aD===aE){d.removeA3EWidgetPref({path:U[aA],pref:"A3EAnnotSetsLoaded"});d.saveA3EWidgetPref({path:aF,pref:"A3EAnnotSetsLoaded",data:{visibility:aE.isVisible(),ctxType:aE.getContextType()}});for(var aC=U.length-1;aC>=0;aC--){if(U[aA].isEqual(U[aC])){U[aC]=aF.clone()}}}}for(aA=0;aA<G.length;aA++){if(G[aA].path.getLastElement(true)===aB.getParentPath().getLastElement(true)){G[aA].path=aB.getParentPath().clone()}}N.splice(0,N.length)};this.getLoadedAnnotationSets=function(){var aT=[],aR;if(!aw){return aT}var aQ=T.getRootBagPath();if(N.length===0){var aJ=[];for(var aN=0;aN<U.length;aN++){var aO=true;for(aR=0;aR<B.length;aR++){if(B[aR].path.isAParentOf(U[aN])){aO=false;break}}if(aO){aJ.push(U[aN])}}var aC=function(aX){var aW=aX.getLastElement(true);if(aW.getTreeOrder&&aW.getTreeOrder()){return true}var aV=aX.getChildrenPathes();for(var aY=0;aY<aV.length;aY++){var aU=aC(aV[aY]);if(aU===true){return true}}return undefined};var aL=function(aY){var aU=[];var aX=aY;while(!aX.isEqual(aQ)){var aW=aX.getLastElement(true);var aV=0;if(aW.getTreeOrder&&aW.getTreeOrder()){aV=aW.getTreeOrder()}aU.splice(0,0,aV);aX=aX.getParentPath()}return aU};var aB=function(aX,aV){if(aX.length===0){return true}if(aV.length===0){return false}var aU=Math.max(aX.length,aV.length);for(var aW=0;aW<aU;aW++){if(aX[aW]===aV[aW]){continue}else{return aX[aW]>aV[aW]}}return false};var aH=[];var aP=function(aZ){var aY=aZ.getLastElement(true);var aX,aW;if(aY.getAnnotationClassType&&aY.getAnnotationClassType()==="tpsAnnotationSet"){var aV=true;for(aX=0;aX<aJ.length;aX++){if(aZ.isEqual(aJ[aX])){for(aW=0;aW<aH.length;aW++){if(aH[aW].isEqual(aJ[aX])){aV=false;break}}if(aJ[aX]&&aV){aH.push(aJ[aX].clone())}break}}}else{var aU=aZ.getChildrenPathes();for(aX=0;aX<aU.length;aX++){aP(aU[aX])}}};var aE=aQ.getChildrenPathes();for(var aG=0;aG<aE.length;aG++){aH=[];var aI;if(aC(aE[aG])){var aF=[];for(aI=0;aI<aJ.length;aI++){if(aE[aG].isAParentOf(aJ[aI])){aF.push({index:aL(aJ[aI].getParentPath().getParentPath()),path:aJ[aI]})}}var aD=[];for(aI=0;aI<aF.length;aI++){var aM=aF[aI].index;var aK=aF[aI].path.clone();if(aH.length===0){aH.push(aK);aD.push(aM)}else{var aS=false;for(aR=0;aR<aD.length;aR++){if(aB(aM,aD[aR])){if(aR===aD.length-1){aH.push(aK);aD.push(aM);aS=true;break}else{if(aB(aD[aR+1],aM)){aH.splice(aR+1,0,aK);aD.splice(aR+1,0,aM);aS=true;break}}}else{break}}if(!aS){aH.splice(0,0,aK);aD.splice(0,0,aM)}}}}else{aP(aE[aG])}N=N.concat(aH)}}if(N&&N.length){for(var aA=0;aA<N.length;aA++){aT.push(N[aA].clone())}}return aT};this.subscribe=function(aB,aA){if(aB&&aA){return Y.subscribe({event:aB},aA)}return undefined};this.unsubscribe=function(aA){if(Y&&aA){Y.unsubscribe(aA)}};this.isRunning=function(){return A.length>0||H.length>0};this.setLoaderType=function(aB){var aA=aB||z||"DS/CAT3DAnnotationModel/CAT3DAnnotationLoader";if(aA!==z){z=aA;require([aA],function(aE){if(z===aA){y=new aE();if(U.length){var aD;for(var aC=U.length-1;aC>=0;aC--){aD=U[aC].getLastElement(true);U[aC].getParentPath().getLastElement(true).removeChild(aD);aD.removeChildren();aD=null;U.splice(aC,1)}U.splice(0,U.length);N.splice(0,N.length);G.splice(0,G.length);w();aq();O()}}})}};this.getLoaderType=function(){return y?y.getType():"undefined"};this.hasAlreadyBeenLoaded=function(aC,aE){var aA,aB;if(aC){if(aE){for(aA=0;aA<ax.length;aA++){if(ax[aA].isEqual(aC)){return 1}}}else{for(aA=0;aA<G.length;aA++){if(G[aA].recursive){if(G[aA].path.isAParentOf(aC)){for(aB=0;aB<U.length;aB++){if(aC.isAParentOf(U[aB])){return 1}else{if(aC.getLastElement(true)===U[aB].getParentPath().getLastElement(true)){return 7}}}for(aB=0;aB<A.length;aB++){if(A[aB]&&(aC.isAParentOf(A[aB])||aC.isEqual(A[aB]))){return 3}}return 2}else{if(G[aA].path.getLastElement(true)===aC.getLastElement(true)){return 7}}}else{if(aC.isEqual(G[aA].path)){for(aB=0;aB<U.length;aB++){var aD=U[aB].getParentPath();if(aC.isEqual(aD)){return 4}}for(aB=0;aB<A.length;aB++){if(A[aB]&&aC.isEqual(A[aB])){return 6}}return 5}else{if(G[aA].path.getLastElement(true)===aC.getLastElement(true)){return 8}}}}}}return 0};function X(aE,aD){if(o.getNodeID(aD.getLastElement(true))===aE){return aD}var aB=aD.getChildrenPathes();var aC;for(var aA=0;aA<aB.length;aA++){aC=X(aE,aB[aA]);if(aC){return aC}}return undefined}this.loadFTALightModel=function(aP,aX,aN,a1){var aM,aK,aU;if(!aP||!D||!aw){return}var aE=a1&&a1.length===1&&a1[0]===2;if(aE){if(v.hasAlreadyBeenLoaded(aP,true)===1){return}ax.push(aP.clone())}else{var aD=v.hasAlreadyBeenLoaded(aP);if(aD===1||aD===2||aD===3){return}if(!aN&&(aD===4||aD===5||aD===6)){return}if(!aN&&(aD===7||aD===8)){for(aK=0;aK<U.length;aK++){if(U[aK].getParentPath().getLastElement(true)===aP.getLastElement(true)){var aB=aP.clone();aB.addElement(U[aK].getLastElement(true));S(aB)}}return}var aC=[];if(aP.isEqual(T.getRootBagPath())){aC=T.getRootBagPath().getChildrenPathes()}else{aC.push(aP)}for(var aG=0;aG<aC.length;aG++){aM=aC[aG];var aH=false;for(aK=0;aK<G.length;aK++){if(G[aK].path.isEqual(aM)){if(!G[aK].recursive&&aN){G[aK].recursive=aN}aH=true}else{if(aN&&aM.isAParentOf(G[aK].path)&&!G[aK].recursive){G[aK].recursive=true}}}if(!aH&&!aM.isEqual(T.getRootBagPath())){G.push({path:aM.clone(),recursive:aN!==undefined?aN:false})}}}var aI=[];if(aN){t(aP,aI,aX)}else{if(aE){var aF=aP.getChildrenPathes();for(aU=0;aU<aF.length;aU++){var a0=aF[aU].getChildrenPathes();if(o.getNodeType(aP.getLastElement(true))==="CATProduct"&&a0.length===1&&o.is3DLeaf(a0[0].getLastElement(true))){aI.push(a0[0])}else{if(o.isReference(aP.getLastElement(true))&&a0.length===1&&o.isReference(a0[0].getLastElement(true))){var aO=a0[0].getChildrenPathes();if(aO.length===1&&o.isRepInstance(aO[0].getLastElement(true))){aI.push(aO[0].getChildrenPathes()[0])}}}}}else{aI.push(aP)}}var aR=[],aQ=[],aJ=[],aA=[],aZ=[];var aW=false;for(aK=0;aK<aI.length;aK++){aM=aI[aK];var aS=o.getNodeID(aM.getLastElement(true));if(aS){for(aU=0;aU<U.length;aU++){if(aM.getLastElement(true)===U[aU].getParentPath().getLastElement(true)){aS=false;break}}for(aU=0;aU<A.length;aU++){if(aM.isEqual(A[aU])){aS=false;break}}for(aU=0;aU<aR.length;aU++){if(aM.getLastElement(true)===aR[aU].getLastElement(true)){aS=false;break}}if(aS){var aL=o.getNodeID(aM.getLastElement(true));if(aM.getLastElement(true).xml){Z(aM,aM.getLastElement(true).xml,aX,a1,true);aM.getLastElement(true).xml=null;A.push(aM);aW=true}else{if(!o.getLoadedAssetType()){if(aM.getLastElement(true).getLoadedStream&&aM.getLastElement(true).getLoadedStream()){ay.push({path:aM.clone(),id:aL});if(aM.getLastElement(true).getLoadedStream()==="thumbnail"){aZ.push(aL);aA.push({node:T.getController().getNode({id:aL}),stream:"cgr"})}else{aJ.push(aL)}}else{aQ.push(aL);aR.push(aM)}}}}}}if(aQ.length||aJ.length||aZ.length){M=A.length!==0;A=A.concat(aR);H=H.concat(aJ);H=H.concat(aZ);var aT=function(a3){if(a3&&a3.node){var a5=o.getNodeID(a3.node);var a4;for(var a2=0;a2<ay.length;a2++){if(ay[a2].id===a5){if(!a3.xml){ay.splice(a2,1);return}ay[a2].xml=a3.xml;ay[a2].node=a3.node;a4=X(a5,ay[a2].path);if(a4){ay.splice(a2,1)}break}}if(!a4||!aw){return}if(A.indexOf(a4)!==-1){return}A.push(a4);H.splice(H.indexOf(a5),1);if(a3.xml){Z(a4,a3.xml,aX,a1);return}ao("onNoAnnotationSetLoaded",{path:a4})}else{ao("onNoAnnotationSetLoaded",{})}};var aV=function(){for(var a2=0;a2<ay.length;a2++){if(ay[a2].xml&&ay[a2].node){aT(ay[a2])}}};var aY=function(){var a2;for(a2=0;a2<aJ.length;a2++){H.splice(H.indexOf(aJ[a2]),1)}var a3=null;for(a2=0;a2<ay.length;a2++){a3=X(aL,ay[a2]);if(a3){ay.splice(a2,1);break}}if(H.length===0&&A.length===0){ao("onNoAnnotationSetLoaded",{})}};if(aQ.length){T.getController().getAttributes({ids:aQ,attributes:["cgr","ds6w:label"],callbacks:{onComplete:function(a4){for(var a3=0;a3<aQ.length;a3++){var a5=a4[aQ[a3]],a2=a5?a5.cgr:null;if(a2){ae(aR[a3],a2,aX,a1)}else{ao("onNoAnnotationSetLoaded",{path:aR[a3]})}}},onFailure:function(){for(aK=A.length-1;aK>=0;aK--){for(aU=0;aU<aR.length;aU++){if(aR[aU].isEqual(A[aK])){A.splice(aK,1);ao("onNoAnnotationSetLoaded",{path:A[aK]});break}}}}}})}if(aJ.length){T.getController().refreshGeometry({ids:aJ,applicativeContainers:{V4V5_FDT:{errorCallBack:aT,doneCallback:aT}},onComplete:aV,onFailure:aY,onTimeout:aY})}if(aA.length){T.getController().switchNodeVisuStreamOnDemand({data:aA,applicativeContainers:{V4V5_FDT:{errorCallBack:aT,doneCallback:aT}},callbacks:{onURLLoad:function(){},onComplete:aV,onFailure:aY,onTimeout:aY}})}}else{if(!aW){ao("onNoAnnotationSetLoaded",{})}}};this.getDirectChildrenAnnotSets=function(aA){return Q(aA)};this.setGlobalFTAVisibilityFlag=function(aB){var aA;if(typeof aB==="boolean"&&aw>0){ak=aB;if(!ak){for(aA=0;aA<U.length;aA++){if(U[aA].getLastElement(true).isVisible()){am.push(U[aA].clone());U[aA].getLastElement(true).setVisibility(false)}}}else{for(aA=0;aA<am.length;aA++){am[aA].getLastElement(true).setVisibility(true)}am.length=0}T.getViewer().render()}};var O=function(){var aF=T.getRootBagPath().getChildrenPathes();var aJ=[];var aD=d.getPreference("3DAnnotLoadARMPartsPref");for(var aI=0;aI<aF.length;aI++){var aA=d.getA3EWidgetAnnotSetsLoadedPref({path:aF[aI]});if(aA&&aA.length){aJ=aJ.concat(aA)}else{var aB=aF[aI].getLastElement(true);if(o.is3DLeaf(aB)){aJ.push({path:aF[aI],visibility:true})}else{v.loadFTALightModel(aF[aI],true,false);if(aD){v.loadFTALightModel(aF[aI],true,false,[2])}if(o.isReference(aF[aI].getLastElement(true))&&o.getNodeType(aF[aI].getLastElement(true))!=="CATProduct"){var aC=aF[aI].getChildrenPathes();for(var aG=0;aG<aC.length;aG++){var aH=aC[aG].getChildrenPathes();if(aH.length===1&&o.is3DLeaf(aH[0].getLastElement(true))){v.loadFTALightModel(aH[0],true,false)}}}}}}d.deleteA3EWidgetPref({pref:"A3EAnnotSetsLoaded"});for(var aE=0;aE<aJ.length;aE++){v.loadFTALightModel(aJ[aE].path,aJ[aE].visibility,o.is3DLeaf(aJ[aE].path.getLastElement(true)))}};var az=function(aC,aA){if(!aC||!aC.getAnnotationClassType||!aA){return}var aD;for(var aB=0;aB<U.length;aB++){if(U[aB].getLastElement(true)===aC){aD=U[aB];break}}if(aA==="visibility"){ao("onAnnotationVisibilityModified",{annotNode:aC,path:aD})}};var ac=function(aF){if(aF.preference==="3DAnnotLoadARMPartsPref"&&aF.value===true){var aH=T.getRootBagPath().getChildrenPathes();for(var aB=0;aB<aH.length;aB++){var aA=aH[aB].getLastElement(true);v.loadFTALightModel(aH[aB],true,false,[2]);if(o.getNodeType(aA)==="CATDrawing"||o.getNodeType(aA)==="CATAnalysis"){var aE=aH[aB].getChildrenPathes();for(var aD=0;aD<aE.length;aD++){var aG=aE[aD];var aC;while(aG){aC=aG.getLastElement(true);if(o.isReference(aC)||o.is3DLeaf(aC)||aG.getChildrenPathes().length!==1){break}aG=aG.getChildrenPathes()[0]}if(aG&&o.isReference(aG.getLastElement(true))){v.loadFTALightModel(aG,true,false,[2])}}}}T.getViewer().render()}};var K=function(aA){at=at.concat(aA)};var F=function(aE){if(!au){var aA=true;for(var aB=0;aB<at.length;aB++){if(at[aB].root===o.getNodeID(aE.path.getLastElement(true))){var aF=aE.path.clone();var aD=at[aB].instances&&at[aB].instances.length?at[aB].instances:[at[aB].origin];for(var aC=0;aC<aD.length;aC++){aF=al(aF,aD[aC])}if(aF&&!aF.isEqual(aE.path)){v.loadFTALightModel(aF,true,false);aA=false}at.splice(aB,1);break}}if(aA){ap(aE.path)}}};var ai=function(aB){var aC=[];var aA;for(aA=U.length-1;aA>=0;aA--){if(aB.path.isAParentOf(U[aA])){aC.push(U[aA].clone());U.splice(aA,1)}}N.length=0;for(aA=G.length-1;aA>=0;aA--){if(aB.path.isAParentOf(G[aA].path)){G.splice(aA,1)}}for(aA=av.length-1;aA>=0;aA--){if(aB.path.isAParentOf(av[aA].path)){av.splice(aA,1)}}for(aA=ad.length-1;aA>=0;aA--){if(ad[aA].loadedData&&(aB.path.isAParentOf(ad[aA].loadedData.path)||aB.path.isEqual(ad[aA].loadedData.path))){ao("onNoAnnotationSetLoaded",{path:ad[aA].loadedData.path,loadingAlreadyStarted:true});ad[aA].terminate();aq(aA);ah()}}if(aC.length){ao("onAnnotationSetRemoved",{pathes:aC})}};var u=function(aB){for(var aA=0;aA<B.length;aA++){if(B[aA].detached&&aB.path.isEqual(B[aA].path)){if(B[aA].hidden){B[aA].detached=false}else{B.splice(aA,1)}break}}ao("onAnnotationParentVisibilityModified")};var J=function(aC){var aA=false;for(var aB=0;aB<B.length;aB++){if(aC.path.isEqual(B[aB].path)){B[aB].detached=true;aA=true;break}}if(!aA){B.push({path:aC.path.clone(),hidden:false,detached:true})}ao("onAnnotationParentVisibilityModified")};var ar=function(){at.length=0};var ag=function(aD){for(var aB=0;aB<aD.paths.length;aB++){var aA=false;for(var aC=0;aC<B.length;aC++){if(aD.paths[aB].isEqual(B[aC].path)){B[aC].hidden=true;aA=true;break}}if(!aA){B.push({path:aD.paths[aB].clone(),hidden:true,detached:false})}}ao("onAnnotationParentVisibilityModified")};var s=function(aC){for(var aA=0;aA<aC.paths.length;aA++){for(var aB=0;aB<B.length;aB++){if(B[aB].hidden&&aC.paths[aA].isEqual(B[aB].path)){if(B[aB].detached){B[aB].hidden=false}else{B.splice(aB,1)}}}}ao("onAnnotationParentVisibilityModified")};var x=function(){au=true;N.splice(0,N.length)};var r=function(){au=false;if(W>0){W=1;ah()}w();aq();var aB=T.getRootBagPath().getChildrenPathes();for(var aA=0;aA<aB.length;aA++){ap(aB[aA])}};var al=function(aE,aF){var aB=aE.getLastElement(true);if(o.getNodeID(aB)===aF){return aE}var aD=aE.getChildrenPathes();for(var aA=0;aA<aD.length;aA++){var aC=al(aD[aA],aF);if(aC){return aC}}return undefined};var Q=function(aG){var aA=[];var aC;var aE=aG.getLastElement(true);if(o.is3DLeaf(aE)){for(aC=0;aC<U.length;aC++){if(aG.isAParentOf(U[aC])){aA.push(U[aC].clone())}}}else{if(o.isReference(aE)){for(aC=0;aC<U.length;aC++){var aH=aa(U[aC]);if(aH&&aG.isEqual(aH)){aA.push(U[aC].clone())}}}else{if(o.getNodeType(aE)==="CATDrawing"||o.getNodeType(aE)==="CATAnalysis"){var aD=aG.getChildrenPathes();for(aC=0;aC<aD.length;aC++){var aF=aD[aC];var aB;while(aF){aB=aF.getLastElement(true);if(o.isReference(aB)||o.is3DLeaf(aB)||aF.getChildrenPathes().length!==1){break}aF=aF.getChildrenPathes()[0]}if(aF){if(o.isReference(aF.getLastElement(true))||o.is3DLeaf(aF.getLastElement(true))){aA=aA.concat(Q(aF))}}}}}}return aA};var aa=function(aE){var aD=aE.clone();var aB=T.getRootBagPath();var aA=false;while(aD&&!aD.isEqual(aB)){var aC=aD.getLastElement(true);if(o.is3DLeaf(aC)){if(o.getNodeType(aC)==="3DShape"){if(aD.getParentPath().isEqual(aB)){return aD}}else{if(o.getNodeType(aC)==="CATPart"){if(aE.getLastElement(true).getContextType()!==2){return aD}}}}else{if(o.isReference(aC)){if(aE.getLastElement(true).getContextType()===2){if(o.getNodeType(aD.getLastElement(true))==="CATProduct"||aA){return aD}aA=true}else{return aD}}}aD=aD.getParentPath()}return undefined};var ap=function(aA){var aC=aA.getLastElement(true);var aK=d.getA3EWidgetAnnotSetsLoadedPref({path:aA});if(aK&&aK.length){for(var aF=0;aF<aK.length;aF++){v.loadFTALightModel(aK[aF].path,aK[aF].visibility,o.is3DLeaf(aA.getLastElement(true)))}}else{if(o.is3DLeaf(aC)){v.loadFTALightModel(aA,true,true)}else{if(o.isReference(aC)){v.loadFTALightModel(aA,true,false);if(d.getPreference("3DAnnotLoadARMPartsPref")){v.loadFTALightModel(aA,true,false,[2])}if(o.isReference(aA.getLastElement(true))&&o.getNodeType(aA.getLastElement(true))!=="CATProduct"){var aJ=aA.getChildrenPathes();for(var aE=0;aE<aJ.length;aE++){var aH=aJ[aE].getChildrenPathes();if(aH.length===1&&o.is3DLeaf(aH[0].getLastElement(true))){v.loadFTALightModel(aH[0],true,false)}}}}else{if(o.getNodeType(aC)==="CATDrawing"||o.getNodeType(aC)==="CATAnalysis"){var aD=aA.getChildrenPathes();for(var aG=0;aG<aD.length;aG++){var aI=aD[aG];var aB;while(aI){aB=aI.getLastElement(true);if(o.isReference(aB)||o.is3DLeaf(aB)||aI.getChildrenPathes().length!==1){break}aI=aI.getChildrenPathes()[0]}if(aI){if(o.isReference(aI.getLastElement(true))||o.is3DLeaf(aI.getLastElement(true))){ap(aI)}}}}}}}};var t=function(aB,aG,aE){var aH=false;var aI;var aA=aB.getChildrenPathes();for(aI=0;aI<aA.length;aI++){var aC=aA[aI].getLastElement(true);if(aC.getAnnotationClassType&&aC.getAnnotationClassType()==="tpsAnnotationSet"&&aC.getContextType){aA[aI].getLastElement(true).setVisibility(aE);aH=true}}if(!aH){var aD=aB.getLastElement(true);if(o.getNodeID(aD)){var aJ=true;if(!o.getNodeType(aD)||o.getNodeType(aD)!=="CATProduct"&&!o.is3DLeaf(aD)){aJ=false}if(aJ){for(var aF=0;aF<aG.length;aF++){if(aG[aF].getLastElement(true)===aD){aJ=false;break}}}if(aJ){aG.push(aB.clone())}}}if(aA&&aA.length){for(aI=0;aI<aA.length;aI++){t(aA[aI],aG,aE)}}};var aq=function(aE){var aA=g.getWebappsBaseUrl();var aG=!l.matchUrl(aA,window.location)?"Passport":null;var aF={provider:"FILE",filename:"CAT3DAnnotationLoadWorker.js",serverurl:aA+"CAT3DAnnotationWorkers/",requiredAuth:aG};var aB={provider:"FILE",filename:"AmdLoader.js",serverurl:aA+"AmdLoader/",requiredAuth:aG};var aC={provider:"FILE",filename:"ThreeJS_Base.js",serverurl:aA+"Mesh/",requiredAuth:aG};var aI={provider:"FILE",filename:"Mesh.js",serverurl:aA+"Mesh/",requiredAuth:aG};var aD={provider:"FILE",filename:"CGRFile.js",serverurl:aA+"Formats/",requiredAuth:aG};var aH={provider:"FILE",filename:"EasySax.js",serverurl:aA+"EasySax/",requiredAuth:aG};if(aE===undefined){ad.splice(0,ad.length)}c.getWorkerBlobFromSpecs([aB,aC,aI,aD,aH,aF],function(aJ){if(!ad){return}if(aE===undefined){for(var aK=0;aK<ab;aK++){var aL=new Worker(aJ);aL.onmessage=P;ad.push(aL)}}else{ad[aE]=new Worker(aJ);ad[aE].onmessage=P}})};var w=function(){for(var aA=0;aA<ad.length;aA++){ad[aA].terminate()}ad.splice(0,ad.length);av.splice(0,av.length);A.splice(0,A.length)};var ae=function(aD,aB,aC,aA){if(!aD||!aB||!D||!aw){return}D.getFTAContainer(aB,"V4V5_FDT",function(aE){if(aD&&aE&&aE.xml){Z(aD,aE.xml,aC,aA);return}ao("onNoAnnotationSetLoaded",{path:aD})})};var Z=function(aF,aC,aE,aB,aG){if(ad.length!==ab){var aA=setInterval(function(){if(ad.length===ab){clearInterval(aA);Z(aF,aC,aE,aB,aG)}},50);return}for(var aD=0;aD<ad.length;aD++){if(!ad[aD].loadedData){ao("onAnnotationSetBeginLoad",{path:aF});ad[aD].loadedData={annotationSets:{},path:aF.clone(),visibility:aE,xml:aC,ctxTypes:aB};ad[aD].postMessage({xmlData:aC,loadingIndex:aD,ctxTypes:aB});return}}av.push({annotationSets:{},path:aF.clone(),visibility:aE,xml:aC,ctxTypes:aB})};var aj=function(aB){if(v.getLoaderType()!=="visu"){if(aB.children.length!==12){return false}for(var aA=0;aA<aB.children.length;aA++){if(aB.children[aA].children.length!==0){return true}}return false}else{return true}};var P=function(aI){var aE=aI.data.loadingIndex;var aN,aM,aP;if(aE===undefined){return}var aL=ad[aE].loadedData?ad[aE].loadedData.path:null;if(!aL){ad[aE].terminate();aq(aE);return}if(aI.data.done===true){var aO=Object.keys(ad[aE].loadedData.annotationSets);if(aI.data.loadingCancelled===true){for(aN=0;aN<G.length;aN++){if(G[aN].path.isEqual(aL)&&o.is3DLeaf(G[aN].path.getLastElement(true))){G.splice(aN,1)}else{if(G[aN].path.isAParentOf(aL)&&G[aN].recursive){G[aN].recursive=false}}}for(aN=0;aN<aO.length;aN++){aM=ad[aE].loadedData.annotationSets[aO[aN]];aL.getLastElement(true).removeChild(aM);for(var aG=0;aG<am.length;aG++){if(am[aG].getLastElement(true)===aM){am.splice(aG,1)}}}if(aI.data.error===true){ao("onAnnotationSetLoadingFailed",{path:aL})}else{ao("onNoAnnotationSetLoaded",{path:aL,loadingAlreadyStarted:true})}}else{for(aN=0;aN<aO.length;aN++){aM=ad[aE].loadedData.annotationSets[aO[aN]];y.postProcessViewsAndCaptures(ad[aE].loadedData.annotationSets[aO[aN]]);if(aI.data.loadingPartiallyFailed){if(!ad[aE].loadedData.hasFailedOnce&&ad[aE].loadedData.xml){aL.getLastElement(true).removeChild(aM);var aC=ad[aE].loadedData;aC.hasFailedOnce=true;var aF=l.loadXml(aC.xml);aC.xml=l.xmlToString(aF);av.push(aC);console.warn("Error while loading annotations of : "+o.getNodeID(aL.getLastElement(true))+". FTA light model is converted and reloaded.")}else{aP=aL.clone();aP.addElement(aM);ao("onAnnotationSetPartiallyLoaded",{path:aP})}}else{if(aj(aM)){aP=aL.clone();aP.addElement(aM);if(!aI.data.hasTesseletedTextReps){if(!o.getLoadedAssetType()){var aB=o.getNodeID(aL.getLastElement(true));T.getController().getAttributes({ids:[aB],attributes:["ds6w:label"],callbacks:{onComplete:function(aQ){var aR=i.TesselatedTextRepsMissing;if(aQ[aB]["ds6w:label"]){aR+=aQ[aB]["ds6w:label"]+" / "}aR+=aM.getAnnotationName();ao("onAnnotationSetPartiallyLoaded",{path:aP,message:aR})},onFailure:function(){ao("onAnnotationSetPartiallyLoaded",{path:aP,message:i.TesselatedTextRepsMissing+aM.getAnnotationName()})}}})}else{ao("onAnnotationSetPartiallyLoaded",{path:aP,message:i.TesselatedTextRepsMissing+aM.getAnnotationName()})}}else{ao("onAnnotationSetLoaded",{path:aP})}}else{aL.getLastElement(true).removeChild(aM);ao("onNoAnnotationSetLoaded",{path:aL,loadingAlreadyStarted:true})}}}}if(av.length){var aH;for(aN=av.length-1;aN>=0;aN--){if(av[aN]&&!av[aN].path){av.splice(aN,1)}else{if(av[aN]&&av[aN].path){aH=aN}}}ad[aE].loadedData={visibility:av[aH].visibility,path:av[aH].path.clone(),annotationSets:{},hasFailedOnce:av[aH].hasFailedOnce,xml:av[aH].xml};ad[aE].postMessage({xmlData:av[aH].xml,loadingIndex:aE,ctxTypes:av[aH].ctxTypes});av.splice(aH,1)}else{ad[aE].loadedData=null}}else{var aJ=aI.data.node;if(ad[aE].loadedData.annotationSets[aI.data.annotSetID]){aM=ad[aE].loadedData.annotationSets[aI.data.annotSetID]}else{var aK=ad[aE].loadedData.visibility;var aA=false;if(aK&&!ak){aK=false;aA=true}aM=y.createAnnotationSet(aK,az,aJ);aL.getLastElement(true).addChild(aM);if(aA){var aD=aL.clone();aD.addElement(aM);am.push(aD)}ad[aE].loadedData.annotationSets[aI.data.annotSetID]=aM}if(aJ){y.loadAnnotation(aJ,aM,az)}}T.getViewer().render()};var ao=function(aH,aE){var aF=aE?(aE.path?aE.path.clone():null):null;var aA;var aD=!o.getLoadedAssetType();if(aH==="onAnnotationSetBeginLoad"){L()}else{if(aH==="onAnnotationSetLoaded"||aH==="onAnnotationSetPartiallyLoaded"){M=true;var aB=aF.getLastElement(true);if(aD){d.saveA3EWidgetPref({path:aF.getParentPath(),pref:"A3EAnnotSetsLoaded",data:{visibility:aB.isVisible(),ctxType:aB.getContextType()}})}N.splice(0,N.length);var aG=aF.getParentPath();for(aA=A.length-1;aA>=0;aA--){if(aG.isEqual(A[aA])){A.splice(aA,1)}}if(A.length===0&&M){if(aH==="onAnnotationSetPartiallyLoaded"){a.displayNotification({eventID:"error",msg:aE.message?aE.message:i.AnnotationSetPartiallyLoadedLbl})}else{a.displayNotification({eventID:"success",msg:i.AnnotationSetLoadedSuccessfullyLbl})}}U.push(aF.clone());ah()}else{if(aH==="onAnnotationSetRemoved"){if(!au&&!R&&aD){if(aE.pathes&&aE.pathes.length){for(aA=0;aA<aE.pathes.length;aA++){d.removeA3EWidgetPref({path:aE.pathes[aA],pref:"A3EAnnotSetsLoaded"})}}}N.splice(0,N.length)}else{if(aH==="onAnnotationSetLoadingFailed"){for(aA=A.length-1;aA>=0;aA--){if(aF.isEqual(A[aA])){A.splice(aA,1)}}a.displayNotification({eventID:"error",msg:i.AnnotationSetLoadedFailedLbl});ah()}else{if(aH==="onNoAnnotationSetLoaded"){if(aF){for(aA=A.length-1;aA>=0;aA--){if(aF.isEqual(A[aA])){A.splice(aA,1)}}}if(A.length===0&&!M&&H.length===0){a.displayNotification({eventID:"info",msg:i.NoAnnotationSetLoadedLbl})}else{if(A.length===0&&M&&H.length===0){a.displayNotification({eventID:"success",msg:i.AnnotationSetLoadedSuccessfullyLbl})}}if(aE&&aE.loadingAlreadyStarted){ah()}}else{if(aH==="onAnnotationSetLoadingCanceled"){A.splice(0,A.length);ay.splice(0,ay.length);H.splice(0,H.length);a.displayNotification({eventID:"info",msg:i.AnnotationSetLoadedCanceledLbl});ah()}else{if(aH==="onAnnotationVisibilityModified"){if(aF){var aC=aF.getLastElement(true);if(aD){d.removeA3EWidgetPref({path:aF,pref:"A3EAnnotSetsLoaded"});d.saveA3EWidgetPref({path:aF,pref:"A3EAnnotSetsLoaded",data:{visibility:aC.isVisible(),ctxType:aC.getContextType()}})}}}else{if(aH==="onAnnotationParentVisibilityModified"){N.length=0}}}}}}}}if(G){Y.publish({event:aH,data:aE,context:v})}};var L=function(){if(an){clearTimeout(an);an=null}an=setTimeout(function(){W=1;ah()},20000);W++;if(W===1){j.on(i.LoadingAnnotationsLbl,function(){for(var aA=ad.length-1;aA>=0;aA--){if(ad[aA].loadedData){var aD=ad[aA].loadedData.path.getLastElement(true);var aC=Object.keys(ad[aA].loadedData.annotationSets);var aB;for(aB=0;aB<aC.length;aB++){aD.removeChild(ad[aA].loadedData.annotationSets[aC[aB]])}for(aB=G.length-1;aB>=0;aB--){if(G[aB].path.isAParentOf(ad[aA].loadedData.path)||G[aB].path.isEqual(ad[aA].loadedData.path)){G.splice(aB,1)}}}}w();aq();ao("onAnnotationSetLoadingCanceled");T.getViewer().render()})}};var ah=function(){if(an){clearTimeout(an);an=null}W--;if(W<0){W=0;return}if(W===0){j.off()}}}});var h=[];var p=b.singleton({init:function(){},getAnnotationModelLoader:function(t){if(t&&t.context){var r=false;for(var s=0;s<h.length;s++){if(h[s].context===t.context){h[s].counter++;r=true;break}}if(!r){h.push({counter:1,context:t.context,modelLoader:new q({ctxViewer:t.context,favoriteCtxManager:t.favoriteCtxManager})})}return this.giveAnnotationModelLoader(t)}return undefined},giveAnnotationModelLoader:function(u){if(u&&u.context){var r,t;for(var s=0;s<h.length;s++){if(h[s].context===u.context){t=h[s];r=t.modelLoader;break}}if(r){return Object.freeze({setActiveState:function(v){if(r){r.setActiveState(v)}},getActiveState:function(){if(r){return r.getActiveState()}return undefined},setGlobalFTAVisibilityFlag:function(v){if(r){r.setGlobalFTAVisibilityFlag(v)}},loadFTALightModel:function(x,w,y,v){if(r){r.loadFTALightModel(x,w,y,v)}},hasAlreadyBeenLoaded:function(v,w){if(r&&t.counter>0){return r.hasAlreadyBeenLoaded(v,w)}return undefined},getLoadedAnnotationSets:function(){if(r){return r.getLoadedAnnotationSets()}return undefined},getDirectChildrenAnnotSets:function(v){if(r){return r.getDirectChildrenAnnotSets(v)}return undefined},isRunning:function(){if(r){return r.isRunning()}return undefined},setLoaderType:function(v){if(r){r.setLoaderType(v)}},getLoaderType:function(){if(r){return r.getLoaderType()}return undefined},subscribe:function(w,v){if(r){return r.subscribe(w,v)}return undefined},unsubscribe:function(v){if(r){r.unsubscribe(v)}}})}}return undefined},unreferenceAnnotationModelLoader:function(s){if(s&&s.context){for(var r=0;r<h.length;r++){if(h[r].context===s.context){h[r].counter--;if(h[r].counter<=0){if(h[r].modelLoader){h[r].modelLoader.clear()}h.splice(r,1)}return}}}}});return p});define("DS/CAT3DAnnotationModelLoader/CAT3DAnnotationVisuLoader",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/LoaderUtils"],function(b,d,e,c){var a=b.extend({init:function(f){var f=f||{};this._parent(f);this.getType=function(){return"visu"};this.createAnnotationSet=function(i){var j=new e();if(i!==undefined&&i!==null){j.setVisibility(i)}j.getAnnotationClassType=function(){return"tpsAnnotationSet"};return j};this.postProcessViewsAndCaptures=function(){};var h=function(k){if(k.getNodeType&&k.getNodeType()==="Mesh3D"){return k}else{var i=k.children;for(var j=0;j<i.length;j++){var l=h(i[j]);if(l){return l}}}};var g=function(k){if(k.setPickParent){k.setPickParent(true)}var i=k.children;for(var j=0;j<i.length;j++){g(i[j])}};this.createReps=function(k,l){var j={reps:[]};for(var r=0;r<k.reps.length;r++){if(k.reps[r].reps){var m=new e();var s={};s.textureInBlack=localStorage.getItem("3DAnnotWhiteVectorAsBlack")==="false"?false:true;s.edgeTransparency=(l===1||l===2||l===3)?false:true;c.processData([m],k.reps[r],undefined,true,s);if(s.textureInBlack&&m.whiteVectorInBlack){m.whiteVectorInBlack()}var n=h(m);n.setShadow(false,false);n.setSSAO(false);n.setVisibilityInTree(false);if(k.nodeXMLtype!=="TPSCG"){n.setNoZ(true)}else{var i=true;var p=n.getPrimitives();for(var r=0;r<p.length;r++){var o=p[r].getDimension();if(o==="surface"||o==="volume"){i=false}}n.setNoZ(i)}g(m);j.visibility=m.children[0].isVisible();m.children[0].setVisibility(true);var q=m.getBoundingSphere();if(q.radius>0){j.reps.push(m)}}}return j};this.createCappingRep=function(i){if(i.cappingRep.reps){var k=new e();c.processData([k],i.cappingRep,undefined,true);var j=h(k);j.setVisibilityInTree(false);j.setShadow(false,false);j.excludeFromHighlight(true,true);j.setNoZ(false);k.name=i.name+"_cappingRep";return k}}},loadAnnotation:function(j,h){if(j.type===6){return}else{if(j.nodeXMLtype==="AnnotationSet"){h.getContextType=function(){return(j.contextType!==undefined?j.contextType:0)}}else{var l=Object.keys(j);if(l.length){var m=new e();h.addChild(m);for(var k=0;k<l.length;k++){if(l[k]==="reps"){var g=this.createReps(j,h.getContextType());for(var i=0;i<g.reps.length;i++){m.addChild(g.reps[i])}m.setVisibility(g.visibility)}else{if(l[k]==="cappingRep"){var f=this.createCappingRep(j);if(f){m.cappingRep=f}}}}}}}}});return a});