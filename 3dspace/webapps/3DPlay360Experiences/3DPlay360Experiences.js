define("DS/3DPlay360Experiences/MediaLoader",["UWA/Class"],function(a){var b=a.extend({init:function(c){this._parent(c)},dispose:function(){},img:function(c){var d=null;if(c&&c.format&&c.path){d=new Promise(function(g,f){var e=document.createElement("img");e.crossOrigin="use-credentials";e.onload=function(){var i={format:c.format,fullPanoWidthPixels:e.width,fullPanoHeightPixels:e.height};var h={width:e.width,height:e.height};g({img:e,imgData:i,size:h})}.bind(this);e.onerror=function(h){f({error:h})}.bind(this);e.src=c.path}.bind(this))}return d},video:function(c){var d=null;if(c&&c.format&&c.path){d=new Promise(function(g,f){var e=document.createElement("video");e.crossOrigin="use-credentials";e.src=c.path;g({video:e})}.bind(this))}return d}});return b});define("DS/3DPlay360Experiences/DirectionIndicatorSwitch",["UWA/Class","css!DS/3DPlay360Experiences/Img360CurvedLayout.css","DS/3DPlayAnnotationUtils/CurvedLayout","DS/Core/PointerEvents","text!DS/3DPlay360Experiences/assets/templates/directionIndicator.hbs"],function(a,e,b,c,d){var h=null;var i=[];var g;var f=a.extend({init:function(j){g=this;i=j.directionIndicatorArray;h=j.directionIndicatorArray.length;this.UIFrame=j.frmWindow.getUIFrame();this.mainDiv=null;this._createMainDiv();if(j.iData){this._setSwitchCB(j.iData)}this._createCurvedUI(j.frmWindow);this._injectDiUi()},_injectDiUi:function(){this.mainDiv.innerHTML=d},_createMainDiv:function(){this.mainDiv=new UWA.Element("div",{"class":"direction-indicator-main-div"}).inject(g.UIFrame);this.mainDiv.addEvent("click",function(){g._showCurvedUI()})},_setProjectionType:function(j){i.forEach(function(k){if(k.id&&k.id.toString()===j){if(g._projTypeChangeCB){g._projTypeChangeCB(k.id);g._hideCurvedUI()}}})},_showCurvedUI:function(){g.curvedUIOuterDiv.style.transition="right 0.6s ease";g.curvedUIOuterDiv.style.right="0px"},_hideCurvedUI:function(){g.curvedUIOuterDiv.style.transition="right 0.6s ease";g.curvedUIOuterDiv.style.right=-(g.curvedUIOuterDiv.clientWidth)+"px";g.curvedUIOuterDiv.style.left=""},_createCurvedUI:function(j){var l=function(){g._setProjectionType(this.id);g._hideCurvedUI()};g.curvedUIOuterDiv=new UWA.Element("div",{"class":"i360-curved-ui-outer-div"}).inject(g.UIFrame);var k=new UWA.Element("div",{id:"curvedUI","class":"i360-curved-ui"}).inject(g.curvedUIOuterDiv);setTimeout(function(){var o=new b({childCount:h,containerElement:k,layoutOpts:{containerHeight:k.clientHeight,containerWidth:k.clientWidth,offsetX:10,offsetY:0}});for(var n=0;n<i.length;++n){var m=UWA.createElement("img",{src:i[n].icon,id:i[n].id,"class":"i360-curved-ui-element"}).inject(o.contentArray[n]);m.addEvent("click",l);m.addEvent("touchstart",l);if(g.mainDiv){g.curvedUIOuterDiv.style.top=g.mainDiv.offsetTop-g.mainDiv.offsetHeight+"px"}else{g.curvedUIOuterDiv.style.top="100px"}g._hideCurvedUI()}this.proxyEventTarget=j.getViewerFrame();this.proxyEventTarget.addEvent(c.POINTERDOWN,function(p){if(p.srcElement.className!=="i360-curved-ui-element"||p.target.className!=="i360-curved-ui-element"){g._hideCurvedUI()}})},0);return g.curvedUIOuterDiv},resetCurvedUIDiv:function(){if(g.mainDiv){g.curvedUIOuterDiv.style.top=g.mainDiv.offsetTop-g.mainDiv.offsetHeight+"px";g.curvedUIOuterDiv.style.transition="top .2s ease-in"}},_setSwitchCB:function(j){this._projTypeChangeCB=j.func},_removeSwitchCB:function(){this._projTypeChangeCB=null},destroy:function(){this.curvedUIOuterDiv.remove();this.curvedUIOuterDiv=undefined;this.mainDiv.remove();this.mainDiv=undefined;this._removeSwitchCB();this.projType=undefined;this.UIFrame=undefined;h=undefined;i=undefined;g=undefined}});return f});define("DS/3DPlay360Experiences/MediaAbstractViewerController",["UWA/Class","DS/Visualization/WebGLV6Viewer","DS/Visualization/Node3D","DS/Visualization/Viewpoint"],function(a,e,d,c){var b=a.extend({init:function(f){this._trackball=null;this._directionIndicator=null;this._viewer=null;this._viewpoint=null;this._node=null;this.initViewer(f.viewer,f.div)},dispose:function(){this.stoptrackBall();this.cleanViewer();this._trackball.dispose();this._trackball=null;this._directionIndicator=null;this._viewer=null;this._viewpoint=null;this._node=null},viewer:function(){return this._viewer},viewpoint:function(){return this._viewpoint},trackBall:function(){return this._trackball},directionIndicator:function(){return this._directionIndicator},createTrackball:function(){return null},reframe:function(){return null},_createNode:function(){return null},activate:function(f){this.activateTrackball({iViewer:this.viewer(),iViewpoint:this.viewpoint(),imgSize:f});if(this.showIndicator){this.showIndicator()}this.reframe()},initViewer:function(g,h){this._viewer=(g)?g:null;if(!this._viewer){var f=this.createViewer(h);this._viewer=f.viewer}if(this._viewer){this._viewpoint=this._viewer.currentViewpoint}if(this._viewer&&this._viewpoint){this.customizeViewer(this._viewer,this._viewpoint)}},cleanViewer:function(){this.cleanNodes();this._viewer=null;this._viewpoint=null},createViewer:function(g){var i=new e({div:g,mobile:true,useShadowMap:false,infinitePlane:false,displayGrid:false,backgroundColor:16777215});i.setRenderMode("@Edge",true);var f=new d();i.addNode(f);var h=new c(i);h.onMove(i.render);i.addViewpoint(h);return{viewer:i,viewpoint:h}},customizeViewer:function(h,f){if(h&&f){h.displayGrid=false;h.infinitePlane=false;h.setBackgroundColor(16777215);h.setShadow(false);f.setProjectionType(0);h.setDefaultPicking(false);h.setPicking({activated:false},false);h.setPrePicking({activated:false},false);h.setManipulators({activated:false,preActivate:false});var g=f.getControl();if(g){g.lockZ=true;g.setRotationInertia({mouse:true,touch:true});g.setZoomActive(true);g.setPanActive(true)}h.setReferenceAxisSystem(true);h.setReferenceAxisSystem(false);h.setCursor("Grab",0,false)}},activateTrackball:function(f){if(f.iViewer&&f.iViewpoint){if(!this._trackball){this._trackball=this.createTrackball(f.imgSize)}if(this._trackball){this._trackball.activate(f.iViewpoint)}}},_deactivateTrackball:function(){if(this._trackball){this._trackball.deactivate()}},stoptrackBall:function(){if(this._trackball){this._trackball.stop()}},node:function(){if(!this._node){this._node=this._createNode();this.viewer().getRootNode().addChild(this._node)}return this._node},cleanNodes:function(){if(this._node){this.viewer().getRootNode().remove(this._node);this._node=null}}});return b});define("DS/3DPlay360Experiences/shaderFactory360",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(a,c){var b=a.extend({init:function(d){this._parent(d)},getFlippedTextureMaterial:function(g){var i=new c.MeshBasicMaterial({force:true,side:c.DoubleSide,forceSide:true});i.activatePDSFX();var d={uSampler:{type:"t2",value:g}};i.setPDSFXUniforms(d);var e={vUV:{type:"v2"}};i.setPDSFXVaryings(e);var f={ComputeVaryingValues:["void ComputeVaryingValues() {","vec2 _uv = vGetAttribTexCoord0().xy;","vUV =vec2(1.0-_uv.x,1.0-_uv.y);","}"].join("\n")};var h={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = texture2D(uSampler, vec2(vUV.s, vUV.t));","#ifndef GAMMA_OUTPUT","ioFinalColor.xyz *= ioFinalColor.xyz;","#endif","ioFinalColor = vec4(1.0,0.0,0.0,1.0)","}"].join("\n")};i.setPDSFXOverridableFunctions(f,h);return i},getEdgeMaterial:function(e){var d=[-1,-1,-1,-1,8,-1,-1,-1,-1];return this.getTextureForFilterMaterial(e,{kernel:d,kernelDim:3})},getBlurMaterial:function(d){var e=[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,];return this.getTextureForFilterMaterial(d,{kernel:e,kernelDim:3,effectRadius:10})},getTextureForFilterMaterial:function(j,m){var i=m.kernel||null;var h=m.kernelDim||null;var o=Math.floor((h-1)/2);var g=m.effectRadius||10;var e=m.applyOnAllImage||false;var d=new c.MeshBasicMaterial({force:true,side:c.DoubleSide,forceSide:true});d.activatePDSFX();var n={uSampler:{type:"t2",value:j},fullPanoWidthPixels:{type:"f",value:1},fullPanoHeightPixels:{type:"f",value:1},croppedAreaImageWidthPixels:{type:"f",value:1},croppedAreaImageHeightPixels:{type:"f",value:1},croppedAreaLeftPixels:{type:"f",value:0},croppedAreaTopPixels:{type:"f",value:0},kernelMatrix:{type:"fv1",value:i,length:h*h},effectRadius:{type:"f",value:g},applyEffect:{type:"f",value:0}};d.setPDSFXUniforms(n);var l={vUV:{type:"v2"}};d.setPDSFXVaryings(l);var k={ComputeVaryingValues:["void ComputeVaryingValues() {","vec2 _uv = vGetAttribTexCoord0().xy;","vec2 uvF=vec2(1.0-_uv.x,1.0-_uv.y);","mat2 scale2Inv=mat2(fullPanoWidthPixels/croppedAreaImageWidthPixels, 0.0, 0.0, fullPanoHeightPixels/croppedAreaImageHeightPixels);","vec2 trans2=vec2((croppedAreaLeftPixels/fullPanoWidthPixels), ((fullPanoHeightPixels-croppedAreaTopPixels-croppedAreaImageHeightPixels)/fullPanoHeightPixels));","vUV=scale2Inv*(uvF-trans2);","}"].join("\n")};var f={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","float x=vUV.x;","float y=vUV.y;","float tx=100.0/fullPanoWidthPixels;","float ty=100.0/fullPanoHeightPixels;","float minDX=min(vUV.x-tx, (1.0-tx)-vUV.x);","float minDY=min(vUV.y-ty, (1.0-ty)-vUV.y);","float minD=min(minDX, minDY);","if(applyEffect>0.0 && (minD<0.0 || "+e+"))","{","vec2 uvToUse=vUV;","float blurRadius="+((e)?"effectRadius;":"effectRadius*(min(-minD/max(tx,ty),1.0));"),"float hStep=blurRadius/fullPanoWidthPixels;","float vStep=blurRadius/fullPanoHeightPixels;","vec4 sum = vec4( 0.0 );","for(int j=0; j<"+h+"; j++)","{","for(int i=0;i<"+h+";i++)","{","sum += kernelMatrix[i*"+h+"+j]*texture2D( uSampler, vec2( uvToUse.x - (float(i-"+o+"))*hStep, uvToUse.y - (float(j-"+o+"))*vStep ));","}","}","sum.a = 1.0;","ioFinalColor = sum;","}","else","{","ioFinalColor = texture2D(uSampler, vec2(vUV.s, vUV.t));","}","#ifndef GAMMA_OUTPUT","ioFinalColor.xyz *= ioFinalColor.xyz;","#endif","}"].join("\n")};d.setPDSFXOverridableFunctions(k,f);return d},getTextureForTilesMaterial:function(h,f){var j=new c.MeshBasicMaterial({force:true,side:c.DoubleSide,forceSide:true});j.activatePDSFX();var d={uSampler:{type:"t2",value:h},fullPanoWidthPixels:{type:"f",value:1},fullPanoHeightPixels:{type:"f",value:1},croppedAreaImageWidthPixels:{type:"f",value:1},croppedAreaImageHeightPixels:{type:"f",value:1},croppedAreaLeftPixels:{type:"f",value:0},croppedAreaTopPixels:{type:"f",value:0},};j.setPDSFXUniforms(d);var e={vUV:{type:"v2"}};j.setPDSFXVaryings(e);var g={ComputeVaryingValues:["void ComputeVaryingValues() {","vec2 _uv = vGetAttribTexCoord0().xy;","vec2 uvF=vec2(1.0-_uv.x,1.0-_uv.y);","mat2 scale2Inv=mat2(fullPanoWidthPixels/croppedAreaImageWidthPixels, 0.0, 0.0, fullPanoHeightPixels/croppedAreaImageHeightPixels);","vec2 trans2=vec2((croppedAreaLeftPixels/fullPanoWidthPixels), ((fullPanoHeightPixels-croppedAreaTopPixels-croppedAreaImageHeightPixels)/fullPanoHeightPixels));","vUV=scale2Inv*(uvF-trans2);","}"].join("\n")};var i={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = texture2D(uSampler, vec2(vUV.s, vUV.t));","#ifndef GAMMA_OUTPUT","ioFinalColor.xyz *= ioFinalColor.xyz;","#endif","}"].join("\n")};j.setPDSFXOverridableFunctions(g,i);return j},});return b});define("DS/3DPlay360Experiences/DirectionIndicatorAbstract",["UWA/Class","DS/Core/Events","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/WebSystem/Rsc","text!DS/3DPlay360Experiences/assets/templates/directionIndicator.hbs","css!DS/3DPlay360Experiences/directionIndicator.css"],function(d,b,g,h,c,f,e){var a=d.extend({init:function(i){var j=this;this._view=null;this._angle=0;this._height=0;this._radius=0;this._light=null;this._viewpointChangeToken=null;this._viewpoint=null;this.id=i.id;c.rsc("3DPlay360Experiences/3DPlay360Experiences",{iconName:this.iconName,iconSize:"Normal"},function(k){j.icon=k;i.callback()})},getDirectionIndicatorData:function(){return{id:this.id,icon:this.icon}},show:function(){this._getView();this.showIndicator()},hide:function(){this._detachVP();this._hideIndicator()},_getView:function(){if(this._view===null){var i=document.createElement("div");this._view=i}if(this._view){this._view.classList.add("directionIndicator")}return this._view},_getLight:function(){if(!this._light){if(this._getView()){this._light=document.querySelector("#light")}}return this._light},_getOuterContainer:function(){if(!this._outerContainer){if(this._getView()){this._outerContainer=document.querySelector("#indicatorOuterContainer")}}return this._outerContainer},_getContainer:function(){if(!this._container){if(this._getView()){this._container=document.querySelector("#indicatorContainer")}}return this._container},_getNorth:function(){if(!this._north){if(this._getView()){this._north=document.querySelector("#north")}}return this._north},getAngle:function(){return this._angle},setAngle:function(i){if(i){this._angle=i}},getHeight:function(){return this._height},setHeight:function(i){if(i){this._height=i}},getWidth:function(){return this._width},setWidth:function(i){if(i){this._width=i}},radius:function(){return this._radius},setRadius:function(i){if(i){this._radius=i}},attachTo:function(i){if(i&&i!==this._viewpoint){this._detachVP();this._viewpoint=i}this._addVPChangeListener()},_detachVP:function(){this._removeVPChangeListener();this._viewpoint=null},_addVPChangeListener:function(){if(this._viewpointChangeToken===null){this._viewpointChangeToken=b.subscribe({event:"/VISU/"},this._viewpointChangeCB.bind(this))}},_removeVPChangeListener:function(){if(this._viewpointChangeToken){b.unsubscribe(this._viewpointChangeToken);this._viewpointChangeToken=null}},_viewpointChangeCB:function(l){if(l&&l.eventType==="@onViewpointChange"&&l.viewpoint&&l.viewpoint==this._viewpoint){var r=l.viewpoint.getSightDirection().clone();var q=l.viewpoint.getCamera().height/l.viewpoint.viewer.SCREEN_HEIGHT*100;var j=l.viewpoint.getCamera().width/l.viewpoint.viewer.SCREEN_WIDTH*100;r.normalize();r.projectOnPlane(new h.Vector3(0,0,1));var m=r.length();var i=new h.Vector3(1,0,0);var p=(i.length()*m);var k=Math.acos(r.x/p);if(r.y<0){k=2*Math.PI-k}this.setAngle(k);this.setRadius(m);this.setHeight(q);this.setWidth(j);var o=(l.viewpoint.getCamera().x)/l.viewpoint.getCamera().fullWidth*100;var n=(l.viewpoint.getCamera().y)/l.viewpoint.getCamera().fullHeight*100;this._updateLight(o,n)}},destroy:function(){this._view=null;this._angle=null;this._radius=null;this._light=null;this._viewpointChangeToken=null;this._viewpoint=null;this.id=null;this.icon=null}});return a});define("DS/3DPlay360Experiences/directionIndicator",["UWA/Class","DS/Core/Events","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","text!DS/3DPlay360Experiences/assets/templates/directionIndicator.hbs","css!DS/3DPlay360Experiences/directionIndicator.css"],function(b,a,e,f,d,c){var g=b.extend({init:function(h){this._view=null;this._angle=0;this._radius=0;this._template=d;this._templateModel={};this._needle=null;this._needleContainer=null;this._light=null;this._viewpointChangeToken=null;this._viewpoint=null;this._onPressCB=null},show:function(){this.view().innerHTML=this._template;var h=this.view().querySelector(".indicatorOuterContainer");if(h){h.addEventListener("click",this._onPress.bind(this),false)}},hide:function(){this.detachVP();var h=this.view().querySelector(".indicatorOuterContainer");if(h){h.removeEventListener("click",this._onPress.bind(this),false)}},_onPress:function(){if(this._onPressCB){this._onPressCB()}},setOnPressCB:function(h){this._onPressCB=h},view:function(){if(this._view==null){var h=document.createElement("div");this._view=h}if(this._view){this._view.classList.add("directionIndicator")}return this._view},needle:function(){if(!this._needle){if(this._view){this._needle=this._view.querySelector(".needle")}}return this._needle},needleContainer:function(){if(!this._needleContainer){if(this._view){this._needleContainer=this._view.querySelector(".needle-container")}}return this._needleContainer},light:function(){if(!this._light){if(this._view){this._light=this._view.querySelector(".light")}}return this._light},angle:function(){return this._angle},setAngle:function(h){if(h){this._angle=h}},radius:function(){return this._radius},setRadius:function(h){if(h){this._radius=h}},_updateNeedle:function(){var l=180/Math.PI;var k=this.light();if(k){var h=this._radius*0.6;var i=this._angle;var p=50;var o=h*Math.cos(i);var m=h*Math.sin(i);var n=50-50*o;var j=50-50*m;k.style.top=n+"%";k.style.left=j+"%"}},attachTo:function(h){if(h&&h!=this._viewpoint){this.detachVP();this._viewpoint=h}this._addVPChangeListener()},detachVP:function(){this._removeVPChangeListener();this._viewpoint=null},_addVPChangeListener:function(){if(this._viewpointChangeToken==null){this._viewpointChangeToken=a.subscribe({event:"/VISU/"},this._viewpointChangeCB.bind(this))}},_removeVPChangeListener:function(){if(this._viewpointChangeToken){a.unsubscribe(this._viewpointChangeToken)}},_viewpointChangeCB:function(k){if(k&&k.eventType==="@onViewpointChange"&&k.viewpoint&&k.viewpoint==this._viewpoint){var n=k.viewpoint.getSightDirection().clone();n.normalize();n.projectOnPlane(new f.Vector3(0,0,1));var h=n.length();var j=new f.Vector3(1,0,0);var m=(j.length()*h);var i=n.dot(j);var l=Math.acos(n.x/m);if(n.y<0){l=2*Math.PI-l}this.setAngle(l);this.setRadius(h);this._updateNeedle()}},});return g});define("DS/3DPlay360Experiences/mathUtils360",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(b,c){var a=b.extend({init:function(d){this._parent(d)},getSPhericalCoordinates:function(h){var g=null,f=null,e=null,d=1;if(h){var g=h.length();if(g>0){f=Math.acos(h.z);e=Math.atan2(h.y,h.x)}}return{r:g,theta:e,phi:f}},getCartesianCoord:function(h){var g=(h.r>0)?h.r:0;var d=h.theta;var f=h.phi;var e=new c.Vector3(g*Math.sin(f)*Math.cos(d),g*Math.sin(f)*Math.sin(d),g*Math.cos(f));return e},ur:function(g){var d=g.theta;var f=g.phi;var e=new c.Vector3(1*Math.sin(f)*Math.cos(d),1*Math.sin(f)*Math.sin(d),1*Math.cos(f));return e},uTheta:function(g){var d=g.theta;var f=g.phi;var e=new c.Vector3(-1*Math.sin(d),1*Math.cos(d),0);return e},uPhi:function(g){var d=g.theta;var f=g.phi;var e=new c.Vector3(1*Math.cos(f)*Math.cos(d),1*Math.cos(f)*Math.sin(d),-1*Math.sin(f));return e},});return a});define("DS/3DPlay360Experiences/ImgData",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(a,c){var b=a.extend({init:function(d){this._src=null;this._img=null;this._imgGeomData=null;this._isReady=false;this._parent(d)},setImg:function(d){this._img=d},img:function(){return this._img},setGeomData:function(d){if(d){this._imgGeomData=d;this._imgGeomData.croppedAreaImageWidthPixels=d.fullPanoWidthPixels;this._imgGeomData.croppedAreaImageHeightPixels=d.fullPanoHeightPixels;this._imgGeomData.croppedAreaLeftPixels=(d.croppedAreaLeftPixels!==null)?d.croppedAreaLeftPixels:0.5*(d.fullPanoWidthPixels-d.croppedAreaImageWidthPixels);this._imgGeomData.croppedAreaTopPixels=(d.croppedAreaTopPixels!==null)?d.croppedAreaTopPixels:0.5*(d.fullPanoHeightPixels-d.croppedAreaImageHeightPixels)}},geomData:function(){if(this._imgGeomData){return this._imgGeomData}else{return null}},readyCB:function(d){this._readyCB=d},isReady:function(){return this._isReady},activate:function(){if(this._isReady){return Promise.resolve(this)}else{return this._checkImg(this._img).then(function(d){this._isReady=true;return Promise.resolve(this)}.bind(this))["catch"](function(d){console.log(d)})}},dispose:function(){this.reset()},reset:function(){this._isReady=false;this._readyCB=null;this._src=null;this._img=null;this._imgGeomData=null},thetaPhiForPixel:function(h){var i=this.geomData();var f=null,g=null;if(h&&i){var e=h.x,d=h.y;if(i.fullPanoWidthPixels>0&&i.fullPanoHeightPixels>0){f=(2*Math.PI/i.fullPanoWidthPixels)*e-Math.PI;g=(-Math.PI/i.fullPanoHeightPixels)*d+Math.PI}}return{theta:f,phi:g}},pixelForThetaPhi:function(d){var i=this.geomData();var g=null,e=null;if(d&&i){var f=d.theta,h=d.phi;if(i.fullPanoWidthPixels>0&&i.fullPanoHeightPixels>0){g=(i.fullPanoWidthPixels/(2*Math.PI))*(f+Math.PI);e=(i.fullPanoHeightPixels/(-Math.PI))*(h-Math.PI)}}return{px:g,py:e}},computeImgRangeInSphericalCoord:function(){var e=this.geomData();var g=null;if(e){var i=e.croppedAreaLeftPixels;var f=e.croppedAreaLeftPixels+e.croppedAreaImageWidthPixels;var d=e.fullPanoHeightPixels-e.croppedAreaTopPixels-e.croppedAreaImageHeightPixels;var h=e.fullPanoHeightPixels-e.croppedAreaTopPixels;g={};g.thetaMax=this.thetaPhiForPixel({x:f,y:0}).theta+0.75;g.thetaMin=this.thetaPhiForPixel({x:i,y:0}).theta-0.75;g.phiMin=this.thetaPhiForPixel({x:0,y:h}).phi+0.9;g.phiMax=this.thetaPhiForPixel({x:0,y:d}).phi-0.9}return g},computeMiddlePointSphericalCoord:function(){var f=this.geomData();var e=null;if(f){var j=f.croppedAreaLeftPixels;var g=f.croppedAreaLeftPixels+f.croppedAreaImageWidthPixels;var d=f.fullPanoHeightPixels-f.croppedAreaTopPixels-f.croppedAreaImageHeightPixels;var i=f.fullPanoHeightPixels-f.croppedAreaTopPixels;var k={x:j+((g-j)/2),y:d+((i-d)/2)};var h=this.thetaPhiForPixel(k,f);e=new c.Vector2(h.theta,h.phi)}return e},_checkImg:function(d){var e=new Promise(function(g,f){if(d){if(d.complete){g(d)}d.onload=function(){g(d)}}else{f("_checkImg")}}.bind(this));return e}});return b});define("DS/3DPlay360Experiences/TrackballAbstractControl",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/VisuEvents/EventsManager","DS/Core/Events","DS/VisuEvents/ScreenEvent","DS/3DPlay360Experiences/mathUtils360"],function(a,i,b,e,d,c,g,f){var h;var j=a.extend({init:function(k){this._userExpConfig={inertia:{minVelocity:0.1,tau:0.3,toleranceAngle:5,dtStationary:0.1},rotation:{speedRadius:1000,toleranceAngle:50},zoom:{minFovDeg:0,maxFovDeg:130,toleranceAngle:5,rightClickScalingAcceleration:0.015},elasticReturn:{animDuration:75}};this.checkSize(k.size);this._viewpoint=null;this._animation=null;this._VisuEventsManagerTokens=null;this._basicEventToken=null;this._kinematicConstraints=null;this._applyKinematicConstraints=(k&&k.applyKinematicConstraints!==undefined)?k.applyKinematicConstraints:true;this._inertianAnim=null;this._inertia=(k&&k.inertia!==undefined)?k.inertia:true;this._currT=-1;this._angularVelocity={vTheta:null,vPhi:null};this._velocity={x:null,y:null};h=this;var l=(window.devicePixelRatio!==undefined)?window.devicePixelRatio:1;this.viewerHeight=i.glStates.currentHeight/l;this.viewerWidth=i.glStates.currentWidth/l;this._zoomCoeff=null;this._onZoomCB=null;if(k){this._viewpoint=k.viewpoint||null}this._parent(k)},dispose:function(){this.clear();this._userExpConfig=null;this._viewpoint=null;this._animation=null;this._VisuEventsManagerTokens=null;this._basicEventToken=null;this._kinematicConstraints=null;this._applyKinematicConstraints=null;this._inertianAnim=null;this._inertia=null;this._currT=null;this._angularVelocity=null;this._zoomCoeff=null;this._onZoomCB=null;this._viewpoint=null;h=null;this._parent()},checkSize:function(k){if(typeof(k.imgSize)==="object"){if(k.imgSize.height>1024&&k.imgSize.width>2048){this.defaultZoom=true}else{this.defaultZoom=false}}else{if(k.imgSize!=0&&k.imgSize<100){this.defaultZoom=false}else{this.defaultZoom=true}}},setApplyConstraints:function(k){if(k===true&&this._applyKinematicConstraints===false&&this._kinematicConstraints){this._applyKinematicConstraints=true;this._animateBackToBestViewpointCompliantWithConstraints()}this._applyKinematicConstraints=k},applySphericalConstraints:function(){return this._applyKinematicConstraints},clear:function(){this.stop();this._onZoomCB=null;this._animation=null;this._basicEventToken=null;this._kinematicConstraints=null;this._viewpoint=null;this._applyKinematicConstraints=true;this._inertia=true;this._currT=-1;this._angularVelocity={vTheta:null,vPhi:null};h=null},activate:function(k){if(k){this._setViewpoint(k);this.overloadScreenControls();this.subscribeToUserInteractions()}h=this},deactivate:function(){this.stopAnimation();this.stopInertia();this.stopGyro();var k=this._viewpoint.getControl();this.resetScreenControls(k);this.unsubscribeFromUserInteractions()},stop:function(){this.stopAnimation();this.stopInertia();this.stopGyro();this._setViewpoint(null);this.resetScreenControls();this.unsubscribeFromUserInteractions()},onZoomCB:function(k){this._onZoomCB=k},_setViewpoint:function(k){this._viewpoint=k},viewpoint:function(){return this._viewpoint},inertia:function(){return this._inertia},setInertia:function(k){if(k!==false){this.stopInertia()}this._inertia=k},stopGyro:function(){},getDeviceOrientation:function(){var k=null;if(window.orientation!==undefined){k=window.orientation}else{console.log("This browser does not support device orientation")}return k},onUserEndScreenInteraction:function(k){if(!(k.from[0].view.className.includes("indicator")||k.from[0].view.className.includes("curved"))){if(this._inertia){this.applyInertia.call(this)}}},onUserStartScreenInteraction:function(){this.stopInertia()},subscribeToUserInteractions:function(){this._VisuEventsManagerTokens=[];this._VisuEventsManagerTokens.push(d.addEvent(document,"onLeftMouseUp",this.onUserEndScreenInteraction.bind(this)));this._VisuEventsManagerTokens.push(d.addEvent(document,"onRelease",this.onUserEndScreenInteraction.bind(this)));this._VisuEventsManagerTokens.push(d.addEvent(document,"onTap",this.onUserEndScreenInteraction.bind(this)));this._VisuEventsManagerTokens.push(d.addEvent(document,"onLeftMouseDown",this.onUserStartScreenInteraction.bind(this)));this._VisuEventsManagerTokens.push(d.addEvent(document,"onRightMouseDown",this.onUserStartScreenInteraction.bind(this)));this._VisuEventsManagerTokens.push(d.addEvent(document,"onTouch",this.onUserStartScreenInteraction.bind(this)))},unsubscribeFromUserInteractions:function(){if(this._VisuEventsManagerTokens){var k=this._VisuEventsManagerTokens.length;for(var l=0;l<k;l++){d.removeEventFromToken(this._VisuEventsManagerTokens[l])}this._VisuEventsManagerTokens=null}},overloadScreenControls:function(l){if(this._viewpoint){this._viewpoint.onReframe(function(){});this._viewpoint.onCenterCamera(function(){});var k=this._viewpoint.getControl();if(k){k.onPan(function(m){m.defaultBehavior=false;console.log("onpan")}.bind(this));k.onZoom(this.zoomFun);k.onRotate(this.rotateFun)}}},resetScreenControls:function(k){if(k){k.onPan(null);k.onZoom(null);k.onRotate(null)}},setViewpointForSphericalCoord:function(l){if(l&&l.theta!==undefined&&l.phi!==undefined){var k=this.computeViewpointForSphericalCoord({theta:l.theta,phi:l.phi});this._viewpoint.setEyePosition(k.eyePosition);this._viewpoint.setSightDirection(k.sightDirection);this._viewpoint.setUpDirection(k.upDirection)}},setViewpointForRotation:function(l){if(l&&l.dTheta!==undefined&&l.dPhi!==undefined){var k=this._computeViewpointForRotation({dTheta:l.dTheta,dPhi:l.dPhi});this._viewpoint.setEyePosition(k.eyePosition);this._viewpoint.setSightDirection(k.sightDirection);this._viewpoint.setUpDirection(k.upDirection)}},computeAngleForScalingFactor:function(l){console.log(l);var m=null;if(l!==null&&l!==0&&l!==1){var k=this.computeFieldOfViews(this.viewpoint());if(k&&k.vFov){m=2*Math.atan((1/l)*Math.tan(k.vFov/2))*180/Math.PI}}return m},computeViewpointForSightDir:function(p){var m=new f();var n=m.getSPhericalCoordinates(p);var o=this._viewpoint.getSightDirection();var l=m.getSPhericalCoordinates(o);var k=n.theta-l.theta;var q=n.phi-l.phi;return this._computeViewpointForRotation({dTheta:k,dPhi:q})},computeViewpointForSphericalCoord:function(o){var n=this._viewpoint.getSightDirection();var m=new f();var l=m.getSPhericalCoordinates(n);var k=o.theta-l.theta;var p=o.phi-l.phi;return this._computeViewpointForRotation({dTheta:k,dPhi:p})},_computeViewpointForRotation:function(r){var u=null;var o=null;var k=null;if(r&&r.dTheta!==null&&r.dPhi!==null){var s=r.dTheta;var q=r.dPhi;var l=new f();var n=l.getSPhericalCoordinates(this._viewpoint.getSightDirection().clone().normalize());var m={r:1,theta:n.theta+s,phi:n.phi+q};var p=0.05;var t={min:p,max:Math.PI-p};m.phi=(m.phi<t.min)?t.min:m.phi;m.phi=(m.phi>t.max)?t.max:m.phi;k=this._viewpoint.getEyePosition();u=l.getCartesianCoord(m);o=l.uPhi(m).multiplyScalar(-1)}return{eyePosition:k,sightDirection:u,upDirection:o}},computeFieldOfViews:function(l){var n=null,o=null;if(l){var m=l.getCamera();if(m){o=m.fov*Math.PI/180;var k=m.aspect;n=2*Math.atan(k*Math.tan(o/2))}}return{hFov:n,vFov:o}},vFov:function(n){var m=null;if(n){var l=this.viewpoint().getCamera();if(l){var k=l.aspect;if(k){m=2*Math.atan((1/k)*Math.tan(n/2))}}}return m},hFov:function(k){var n=null;if(k){var m=this.viewpoint().getCamera();if(m){var l=m.aspect;if(l){n=2*Math.atan(l*Math.tan(k/2))}}}return n},getRotationSphericalAngleForScreenDisplacement:function(n){var l=null,p=null;if(n&&n.dx!==undefined&&n.dy!==undefined){var k=this.computeFieldOfViews(this.viewpoint());var m=(k.hFov)?k.hFov:0;var o=(k.vFov)?k.vFov:0;l=(m/this.viewerWidth)*n.dx;p=-(o/this.viewerHeight)*n.dy}return{dTheta:l,dPhi:p}},getDt:function(){var l=0;var k=Date.now();if(this._currT>0){l=(k-this._currT)/1000}return l},updateT:function(){this._currT=Date.now()},stopInertia:function(){if(this._inertianAnim){this._inertianAnim.stop();this._inertianAnim=null}},applyInertia:function(){this.stopInertia();var n=new i.Vector2();n.x=this._angularVelocity.vTheta;n.y=this._angularVelocity.vPhi;var p=1000;var q=this;var o=0;var l=new b(0,0,p);l.setInterpolator(function(G){var x=q._userExpConfig.inertia.tau;G=G*p/1000;var u=G-o;o=G;var C=n;var E=C.x;var F=C.y;var r=E*Math.exp(-G/x);var D=F*Math.exp(-G/x);var v=new f();var B=q._viewpoint.getSightDirection().clone().normalize();var w=v.getSPhericalCoordinates(B);var A=w.theta;var z=w.phi;var s=A+r*u;var y=z+D*u;return{theta:s,phi:y}});var m=function(r){this.me.setViewpointForSphericalCoord({theta:r.theta,phi:r.phi})};var k={me:this,setOrientation:m};this._inertianAnim=new e(k,"setOrientation",l);this._inertianAnim.start()},viewpointAnimationCB:function(k){if(k&&k.viewpoint&&k.sightDir){k.viewpoint.setEyePosition(k.eyePosition);k.viewpoint.setSightDirection(k.sightDir)}},stopAnimation:function(){if(this._basicEventToken){c.unsubscribe(this._basicEventToken);this._basicEventToken=null}if(this._animation){this._animation.stop();this._animation=null}},zoomFun:function(M){M.defaultBehavior=false;var I=M.evt;var B=M.factor;var l=(M&&M.gesture)?M.gesture.getEvents():null;var J=(M&&M.gesture&&M.gesture.view.length>0&&M.gesture.view[0])?M.gesture.view[0]:null;if(l&&l.length==2){var u=null,t=null;u=l[0];t=l[1];if(u&&t&&J){var H=1;var E=u.currentPosition;var C=t.currentPosition;var p=u.lastPosition;var o=t.lastPosition;var F=new i.Vector2(C.x-E.x,C.y-E.y);var z=new i.Vector2(o.x-p.x,o.y-p.y);var m=F.length();var D=z.length();if(D!=0){H=m/D}var k=this.computeFieldOfViews(this.viewpoint);if(k&&k.vFov&&H&&H!=0&&H!=1){var y=2*Math.atan((1/H)*Math.tan(k.vFov/2))*180/Math.PI;this._setZoomForAngle(y);var q=new i.Vector2(0.5*(o.x+p.x),0.5*(o.y+p.y));var L=new i.Vector2(0.5*(this.viewerWidth),0.5*(this.viewerHeight));var v=new i.Vector2().addVectors(q,L.negate());v.multiplyScalar(1-H);console.log(v.x);var n=h.getRotationSphericalAngleForScreenDisplacement({dx:v.x,dy:v.y});this.setViewpointForRotation({dTheta:n.dTheta,dPhi:n.dPhi});this.viewer.render()}}}else{if(l&&l.length==1){var I=l[0];if(I&&I.event!=undefined){var K=I.event;if(K.button===g.MouseButton.RIGHT){var w=I.currentPosition;var s=I.lastPosition;var H=1;var E=I.startPosition;var C=I.currentPosition;var p=I.startPosition;var o=I.lastPosition;var F=new i.Vector2(0,C.y-E.y);var z=new i.Vector2(0,o.y-p.y);var m=F.length();var D=z.length();if(m!=0){H=D/m}var y=this.computeAngleForScalingFactor(H);this._setZoomForAngle(y);this.viewer.render()}}}else{if(B!=undefined&&B!=0){var x=this._viewpoint?this._viewpoint:this.viewpoint;var k=h.computeFieldOfViews(x);var A=(k.vFov)?k.vFov:0;var G=A*180/Math.PI;var r=G-B;h._setZoomForAngle(r);if(this.viewer){this.viewer.render()}else{this._viewpoint.viewer.render()}}}}},rotateFun:function(q){q.defaultBehavior=false;if(q&&q.gesture.events&&q.gesture.view&&q.gesture.view.length&&this){h.stopInertia();var r=q.gesture.events;var t=q.gesture.view[0];var n=r[0].getCurrentPosition?r[0].getCurrentPosition(t):r[0].currentPosition;var k=r[0].getLastPosition?r[0].getLastPosition(t):r[0].lastPosition;if(n&&k){var u=n.x-k.x;var s=n.y-k.y;var m=h.getRotationSphericalAngleForScreenDisplacement({dx:u,dy:s});var p=m.dTheta;var o=m.dPhi;var l=h.getDt();if(l>0){h._angularVelocity.vTheta=p/l;h._angularVelocity.vPhi=o/l}h.updateT();h.setViewpointForRotation({dTheta:p,dPhi:o})}h.lastLockZState=this._state}},reframe:function(){},setKinematicConstraints:function(){},startAnimation:function(){}});return j});define("DS/3DPlay360Experiences/ImgMaterialAbstract",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/3DPlay360Experiences/shaderFactory360","DS/3DPlay360Experiences/ImgData"],function(a,e,d,c){var b=a.extend({init:function(){this._imgData=null;this._src=null;this._img=null;this._imgMaterial=null},setImgData:function(f){this._imgData=f;return this.activate()},imgData:function(){return this._imgData},material:function(){return this._imgMaterial},activate:function(){return this.imgData().activate().then(function(f){return this._createimgTexture(f.img())}.bind(this)).then(function(f){if(!this._imgMaterial){this._imgMaterial=this._createimgMaterial(this.imgData(),f)}else{if(this._imgMaterial){this._updateMaterial(this._imgData,this._imgMaterial,f)}}return Promise.resolve(this)}.bind(this))["catch"](function(f){console.log(f)})},dispose:function(){this.reset()},reset:function(){this._imgMaterial=null;this._src=null;this._img=null;this._imgData=null},_createimgTexture:function(f){var g=new Promise(function(j,i){var l=null;if(f){var h=document.createElement("canvas");h.width=f.width;h.height=f.height;h.getContext("2d").drawImage(f,0,0);var k=h.toDataURL("image/png");l=e.ImageUtils.loadTexture(k,undefined,null,null,e.ImageUtils.crossOriginPolicy);l.minFilter=e.LinearFilter;l.needsUpdate=true;l.anisotropy=1024;h=undefined;k=undefined;j(l)}else{i("_createimgTexture")}l=null}.bind(this));return g},_createimgMaterial:function(i,h){var g=new d();var f=g.getBlurMaterial(h);f.side=e.BackSide;f.forceSide=true;f.force=true;this._updateMaterial(i,f,h);return f}});return b});define("DS/3DPlay360Experiences/ImgAbstractViewerController",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/3DPlay360Experiences/MediaAbstractViewerController"],function(b,d,c){var a=c.extend({init:function(e){this._parent(e);if(e.size&&e.size.height&&e.size.width){this.nodeDim={height:e.size.height,width:e.size.width}}this._imgData=null},dispose:function(){this._parent()},reframe:function(e){this._reframeOnInitialView(e);this._trackball.reframe()},setImgData:function(e){this._imgData=e},getImgData:function(){return this._imgData},getDirectionIndicatorData:function(){return this._directionIndicator.getDirectionIndicatorData()},hide:function(){this.setDefaultVP();this._hideNode();this._deactivateTrackball();this._hideIndicator()},_hideIndicator:function(){this._directionIndicator.hide()},showIndicator:function(){if(this._directionIndicator){this._directionIndicator.show()}},_hideNode:function(){if(this.createdNode){this.createdNode.setVisibility(false)}},displayDirIndicator:function(){if(this.viewpoint()){this._directionIndicator.attachTo(this.viewpoint())}},showNode:function(){if(this.createdNode){this.createdNode.setVisibility(true)}},build:function(f){var e=this;if(!this._imgMaterial){console.log("MATERIAL");this._imgMaterial=this.createMaterial()}this._imgMaterial.setImgData(this.getImgData()).then(function(g){console.time("[360 perfos] - node Creation");console.log("NODE : "+e.node().name);console.timeEnd("[360 perfos] - node Creation");console.time("[360 perfos] - apply material and render");e.node().setMaterial(g.material());e.viewer().render();console.timeEnd("[360 perfos] - apply material and render");f();return Promise.resolve()})},applyKinematicConstraints:function(){},removeKinematicConstraints:function(){},_computeInitialView:function(){},_reframeOnInitialView:function(){},_getVisiblePixelCoord:function(){},setDefaultVP:function(){}});return a});define("DS/3DPlay360Experiences/DirectionIndicatorPlaner",["UWA/Class","DS/Core/Events","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/WebSystem/Environment","DS/3DPlay360Experiences/DirectionIndicatorAbstract","css!DS/3DPlay360Experiences/directionIndicatorPlaner.css"],function(d,b,g,h,f,a,e){var c=a.extend({init:function(i){this.iconName="Planer";this._parent(i)},_hideIndicator:function(){if(this._getOuterContainer()&&this._getContainer()&&this._getLight()){this._getOuterContainer().classList.remove("indicatorOuterContainerPlaner");this._getContainer().classList.remove("directionIndicatorPlaner");this._getLight().classList.remove("lightPlaner");this._getNorth().classList.remove("hide")}},showIndicator:function(){if(this._getOuterContainer()&&this._getContainer()&&this._getLight()){this._getOuterContainer().classList.add("indicatorOuterContainerPlaner");this._getContainer().classList.add("directionIndicatorPlaner");this._getLight().classList.add("lightPlaner");this._getNorth().classList.add("hide")}},_updateLight:function(i,m){var k=this._getLight();if(k){var l=this.getHeight();var j=this.getWidth();k.style.height=(20+l)+"%";k.style.width=(5+j)+"%";k.style.top=(m-10)+"%";k.style.left=(i)+"%"}},setOrigin:function(i){this._origin=i}});return c});define("DS/3DPlay360Experiences/TrackballControlSpherical",["UWA/Class","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/VisuEvents/EventsManager","DS/Core/Events","DS/VisuEvents/ScreenEvent","DS/3DPlay360Experiences/mathUtils360","DS/3DPlay360Experiences/TrackballAbstractControl","DS/Visualization/ThreeJS_DS"],function(a,b,e,d,c,h,f,k,j){var i=null;var g=k.extend({init:function(l){this._parent(l);this._applyKinematicConstraints=false;i=this},dispose:function(){this._applyKinematicConstraints=null;this._parent();i=null},setKinematicConstraints:function(){},_animateBackToBestViewpointCompliantWithConstraints:function(){},_setZoomForAngle:function(m){if(m){var l=m;if(l&&l>=this._userExpConfig.zoom.minFovDeg&&l<=this._userExpConfig.zoom.maxFovDeg){this.viewpoint().setAngle(l);if(this._onZoomCB){this._onZoomCB()}}}},_computeViewpointForRotation:function(s){var v=null;var p=null;var l=null;if(s&&s.dTheta!==null&&s.dPhi!==null){var t=s.dTheta;var r=s.dPhi;var m=new f();var o=m.getSPhericalCoordinates(this._viewpoint.getSightDirection().clone().normalize());var n={r:1,theta:o.theta+t,phi:o.phi+r};var q=0.05;var u={min:q,max:Math.PI-q};n.phi=(n.phi<u.min)?u.min:n.phi;n.phi=(n.phi>u.max)?u.max:n.phi;l=this._viewpoint.getEyePosition();v=m.getCartesianCoord(n);p=m.uPhi(n).multiplyScalar(-1)}return{eyePosition:l,sightDirection:v,upDirection:p}},startAnimation:function(l){this.stopInertia();this.stopAnimation();if(null===this._basicEventToken){this._basicEventToken=c.subscribe({event:"/VISU/onBasicEvent"},function(p){if(p){for(var r=0;r<p.from.length;r++){var q=p.from[r];var t=q.getType();var s=q.getState();if((q instanceof h)&&t!=="Keyboard"){if(s===h.State.BEGIN){this.stopAnimation()}}}}}.bind(this))}if(this._animation===null){var m=function(p){this._nbLoops=(p.animationData.nbLoops!==undefined)?p.animationData.nbLoops:5;this._duration=(p.animationData.duration!==undefined)?p.animationData.duration:10000;this._T=this._duration/this._nbLoops;this._rotVect=p.viewpointData.rotVect;this._rotAngle=p.viewpointData.rotAngle;this._sightDir_t0=p.viewpointData.sightDir;this.duration=function(){return this._duration};this.valueAt=function(u){var r=(u%this._T)/this._T;var v=new j.Matrix4();v.makeRotationAxis(this._rotVect,r*this._rotAngle);var s=this._sightDir_t0.clone();s.applyMatrix4(v);var q={viewpoint:p.viewpointData.viewpoint,sightDir:s,eyePosition:new j.Vector3(0,0,0)};return q}};var n={animationData:{nbLoops:1,duration:100000},viewpointData:{viewpoint:l,sightDir:new j.Vector3(1,0,0),rotVect:new j.Vector3(0,0,1),rotAngle:-2*Math.PI}};var o=new m(n);this._animation=new e(this,"viewpointAnimationCB",o)}if(this._animation){this._animation.setLoop(1);this._animation.start()}},reframe:function(){var l=this.computeFieldOfViews(this.viewpoint());var n=(l.vFov)?l.vFov:0;var m;if(this.defaultZoom){m=n*180/Math.PI}else{m=this._userExpConfig.zoom.maxFovDeg}this._setZoomForAngle(m);if(this.viewer){this.viewer.render()}}});return g});define("DS/3DPlay360Experiences/ImgMaterialSpherical",["DS/3DPlay360Experiences/ImgMaterialAbstract"],function(b){var a=b.extend({init:function(c){this._parent(c)},_updateMaterial:function(f,e,d){if(f&&f.isReady){if(d){e.updatePDSFXUniform("uSampler",d)}var c=f.geomData();if(c&&e){e.updatePDSFXUniform("fullPanoWidthPixels",c.fullPanoWidthPixels);e.updatePDSFXUniform("fullPanoHeightPixels",c.fullPanoHeightPixels);e.updatePDSFXUniform("croppedAreaImageWidthPixels",c.fullPanoWidthPixels);e.updatePDSFXUniform("croppedAreaImageHeightPixels",c.fullPanoHeightPixels);e.updatePDSFXUniform("croppedAreaLeftPixels",0);e.updatePDSFXUniform("croppedAreaTopPixels",0);e.updatePDSFXUniform("applyEffect",1)}}}});return a});define("DS/3DPlay360Experiences/ImgMaterialPlaner",["DS/3DPlay360Experiences/ImgMaterialAbstract"],function(a){var b=a.extend({init:function(c){this._parent(c)},_updateMaterial:function(f,e,d){if(f&&f.isReady){if(d){e.updatePDSFXUniform("uSampler",d)}var c=f.geomData();if(c&&e){e.updatePDSFXUniform("fullPanoWidthPixels",c.fullPanoWidthPixels);e.updatePDSFXUniform("fullPanoHeightPixels",c.fullPanoHeightPixels);e.updatePDSFXUniform("croppedAreaImageWidthPixels",c.fullPanoWidthPixels);e.updatePDSFXUniform("croppedAreaImageHeightPixels",c.fullPanoHeightPixels);e.updatePDSFXUniform("croppedAreaLeftPixels",0);e.updatePDSFXUniform("croppedAreaTopPixels",0);e.updatePDSFXUniform("applyEffect",-1)}e.needsUpdate=true;c=undefined}}});return b});define("DS/3DPlay360Experiences/DirectionIndicatorSpherical",["UWA/Class","DS/Core/Events","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/WebSystem/Environment","DS/3DPlay360Experiences/DirectionIndicatorAbstract","css!DS/3DPlay360Experiences/directionIndicatorSpherical.css"],function(c,b,f,h,e,a,d){var g=a.extend({init:function(i){this.iconName="Spherical";this._parent(i)},_hideIndicator:function(){if(this._getOuterContainer()&&this._getContainer()&&this._getLight()){this._getOuterContainer().classList.remove("indicatorOuterContainerSpherical");this._getContainer().classList.remove("directionIndicatorSpherical");this._getLight().classList.remove("lightSpherical");this._getNorth().classList.add("hide")}},showIndicator:function(){if(this._getOuterContainer()&&this._getContainer()&&this._getLight()){this._getOuterContainer().classList.add("indicatorOuterContainerSpherical");this._getContainer().classList.add("directionIndicatorSpherical");this._getLight().classList.add("lightSpherical");this._getNorth().classList.remove("hide");if(this._getLight().style.backgroundColor!=="white"){this._getLight().style.backgroundColor="white";this._getLight().style.border="2px solid black"}this._getLight().style.height="16px";this._getLight().style.width="16px"}},_updateLight:function(){var j=this._getLight();if(j){var l=this._radius*0.6;var k=this._angle;var i=l*Math.cos(k);var o=l*Math.sin(k);var n=50-50*i;var m=50-50*o;j.style.top=n+"%";j.style.left=m+"%"}}});return g});define("DS/3DPlay360Experiences/TrackballControlPlane",["DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/VisuEvents/EventsManager","DS/Core/Events","DS/VisuEvents/ScreenEvent","DS/3DPlay360Experiences/mathUtils360","DS/3DPlay360Experiences/TrackballAbstractControl","DS/Visualization/ThreeJS_DS"],function(a,d,c,b,f,e,j,i){var g=null;var h=j.extend({init:function(k){this._parent(k);this._applyKinematicConstraints=false;this._userExpConfig.translation={toleranceDistance:100};g=this},dispose:function(){this._applyKinematicConstraints=null;this._parent();g=null},setKinematicConstraints:function(k){this._kinematicConstraints={origin:k.origin,width:k.width,height:k.height}},_viewerRect:function(){var l=(window.devicePixelRatio!==undefined)?window.devicePixelRatio:1;var k={origin:new i.Vector2(0,0),width:this.viewerHeight,height:this.viewerWidth};return k},_visibleRect:function(){var k=(window.devicePixelRatio!==undefined)?window.devicePixelRatio:1;var n=this.viewpoint();var p=this.viewerHeight;var q=this.viewerWidth;var o=(n.getCamera().width!==undefined)?n.getCamera().width:q;var r=(n.getCamera().height!==undefined)?n.getCamera().height:p;var m=(n.getCamera().x!==undefined)?n.getCamera().x:0;var l=(n.getCamera().y!==undefined)?n.getCamera().y:0;var s={origin:new i.Vector2(m,l),width:o,height:r};return s},_convertVect:function(p,n,m){var o=new i.Vector2();if(p&&n&&m&&n.width>0&&n.height>0&&m.width>0&&m.height>0){var l=m.width/n.width;var k=m.height/n.height;o=p;o.x=o.x*l;o.y=o.y*k}return o},_interpolatedRect:function(y,k,v,n){var q={origin:k.origin.clone(),width:k.width,height:k.height};var A=k.origin.x-y.origin.x;var z=k.origin.y-y.origin.y;if(y&&k&&v&&n>0&&A!==0&&z!==0){var u=n;var x=v.origin.x;var s=v.origin.x+v.width;var w=v.origin.y;var r=v.origin.y+v.height;var p;if(A<0&&(y.origin.x+A)<x){var l=Math.abs(x-y.origin.x);p=Math.abs(1-(l/u));q.origin.x=y.origin.x+A*p}if(z<0&&(y.origin.y+z)<w){var m=Math.abs(w-y.origin.y);p=Math.abs(1-(m/u));q.origin.y=y.origin.y+z*p}if(A>0&&(y.origin.x+y.width+A)>s){var o=Math.abs(s-(y.origin.x+y.width));p=Math.abs(1-(o/u));q.origin.x=y.origin.x+A*p}if(z>0&&(y.origin.y+y.height+z)>r){var t=Math.abs(r-(y.origin.y+y.height));p=Math.abs(1-(t/u));q.origin.y=y.origin.y+z*p}}return q},maxRectInContainer:function(p){var m=null;if(this._kinematicConstraints&&p){m={origin:p.origin.clone(),width:p.width,height:p.height};if(this._kinematicConstraints.width<p.width||this._kinematicConstraints.height<p.height){var q=Math.min(this._kinematicConstraints.width/p.width,this._kinematicConstraints.height/p.height);m.width*=q;m.height*=q}var o=this._kinematicConstraints.origin.x;var l=this._kinematicConstraints.origin.x+this._kinematicConstraints.width;var n=this._kinematicConstraints.origin.y;var k=this._kinematicConstraints.origin.y+this._kinematicConstraints.height;if(m.origin.x<o){m.origin.x=o}if(m.origin.y<n){m.origin.y=n}if((m.origin.x+m.width)>l){m.origin.x=l-m.width}if((m.origin.y+m.height)>k){m.origin.y=k-m.height}}return m},offsetRectForScreenDisplacement:function(k){var m=null;if(k){var n=this._visibleRect();var o=this._viewerRect();var l=this._convertVect(k,o,n);m={origin:new i.Vector2(n.origin.x-l.x,n.origin.y-l.y),width:n.width,height:n.height}}return m},_zoomRectForScaleWithCenter:function(m){var l=null;if(m&&m.scalingFactor!=undefined&&m.scalingFactor!=1&&m.center!=undefined){var k=m.scalingFactor;var o=this._visibleRect();var p=this._viewerRect();var n=this._convertVect(m.center,p,o);var q=n.clone().multiplyScalar(1-k);l={origin:new i.Vector2(o.origin.x+q.x,o.origin.y+q.y),width:k*o.width,height:k*o.height}}return l},zoomToRect:function(q,A){if(q){var l=(window.devicePixelRatio!==undefined)?window.devicePixelRatio:1;var o=this.viewpoint();var u=this.viewerHeight;var v=this.viewerWidth;var p=(o.getCamera().width!==undefined)?o.getCamera().width:v;var w=(o.getCamera().height!==undefined)?o.getCamera().height:u;var m=(o.getCamera().x!==undefined)?o.getCamera().x:0;var k=(o.getCamera().y!==undefined)?o.getCamera().y:0;var z=(v!==0)?p/v:1;var s=(u!==0)?w/u:1;var n=q;n.width=(q.width!==undefined&&q.width>0)?q.width:p;n.height=(q.height!==undefined&&q.height>0)?q.height:w;n.origin=(q.origin!==undefined)?q.origin:i.Vector2(m,k);if(!(A&&A.ignoreConstraints)&&this._applyKinematicConstraints&&this._kinematicConstraints){if(A&&A.useResistence){n=this._interpolatedRect(this._visibleRect(),n,this._kinematicConstraints,this._userExpConfig.translation.toleranceDistance)}else{n=this.maxRectInContainer(n)}}var t=n.origin.x;var r=n.origin.y;if(this._kinematicConstraints){if(n.width>this._kinematicConstraints.width){n.width=this._kinematicConstraints.width}if(n.height>this._kinematicConstraints.height){n.height=this._kinematicConstraints.height}}o.setViewOffset({width:n.width,height:n.height,x:n.origin.x,y:n.origin.y})}},_animateBackToBestViewpointCompliantWithConstraints:function(){if(this._applyKinematicConstraints&&this._kinematicConstraints){var l=100;var p=50;var n=200;var k=new i.Vector3(200,100,-50);var m=new i.Vector3(200,-100,-50);var o=new i.Vector3(200,100,50)}},applyInertia:function(){this.stopInertia();var n=this._velocity;var o=0;if((Math.abs(this._velocity.x)<o&&Math.abs(this._velocity.y)<o)||this.getDt()>this._userExpConfig.inertia.dtStationary){this._animateBackToBestViewpointCompliantWithConstraints()}else{var k=new e();var l=1000;var s=this;var m=0;var q=new a(0,0,l);q.setInterpolator(function(C){var v=s._userExpConfig.inertia.tau;C=C*l/1000;var u=C-m;m=C;var A=s._velocity;var z=A.x;var y=A.y;var x=z*Math.exp(-C/v);var w=y*Math.exp(-C/v);var D=x*u;var B=w*u;return{dx:D,dy:B}});var p=function(u){var B=u.dx,A=u.dy;var w=this.me.offsetRectForScreenDisplacement(new i.Vector2(B,A));if(this.me._applyKinematicConstraints&&this.me._kinematicConstraints){var x=this.me._kinematicConstraints;var z=x.origin.x;var v=x.origin.x+x.width;var y=x.origin.y;var t=x.origin.y+x.height;if(w.origin.x<z){this.me._velocity.x=(this.me._velocity.x>0)?-this.me._velocity.x:this.me._velocity.x}if(w.origin.y<y){this.me._velocity.y=(this.me._velocity.y>0)?-this.me._velocity.y:this.me._velocity.y}if((w.origin.x+w.width)>v){this.me._velocity.x=(this.me._velocity.x<0)?-this.me._velocity.x:this.me._velocity.x}if((w.origin.y+w.height)>t){this.me._velocity.y=(this.me._velocity.y<0)?-this.me._velocity.y:this.me._velocity.y}}this.me.zoomToRect(w,{ignoreConstraints:true})};var r={me:this,setOrientation:p};this._inertianAnim=new d(r,"setOrientation",q);this._inertianAnim.start()}},startAnimation:function(k){this.stopInertia();this.stopAnimation();if(null===this._basicEventToken){this._basicEventToken=b.subscribe({event:"/VISU/onBasicEvent"},function(o){if(o){for(var q=0;q<o.from.length;q++){var p=o.from[q];var s=p.getType();var r=p.getState();if((p instanceof f)&&s!=="Keyboard"){if(r===f.State.BEGIN){this.stopAnimation()}}}}}.bind(this))}if(this._animation===null){var l=function(o){this._nbLoops=(o.animationData.nbLoops!==undefined)?o.animationData.nbLoops:5;this._duration=(o.animationData.duration!==undefined)?o.animationData.duration:10000;this._T=this._duration/this._nbLoops;this._rotVect=o.viewpointData.rotVect;this._rotAngle=o.viewpointData.rotAngle;this._sightDir_t0=o.viewpointData.sightDir;this.duration=function(){return this._duration};this.valueAt=function(s){var q=(s%this._T)/this._T;var u=new i.Matrix4();u.makeRotationAxis(this._rotVect,q*this._rotAngle);var r=this._sightDir_t0.clone();r.applyMatrix4(u);var p={viewpoint:o.viewpointData.viewpoint,sightDir:r,eyePosition:new i.Vector3(0,0,0)};return p}};var m={animationData:{nbLoops:1,duration:100000},viewpointData:{viewpoint:k,sightDir:new i.Vector3(1,0,0),rotVect:new i.Vector3(0,0,1),rotAngle:-2*Math.PI}};var n=new l(m);this._animation=new d(this,"viewpointAnimationCB",n)}},zoomFun:function(p){p.defaultBehavior=false;var o=p.evt;var n=p.factor*-1;if(Math.abs(n)>=1){var m=1/40;n=n*m}var k=1+n;var q=o._currentPosition;var l=g._zoomRectForScaleWithCenter({center:q,scalingFactor:k});if(l&&l.origin.x){g.zoomToRect(l)}},rotateFun:function(n){n.defaultBehavior=false;if(n&&n.gesture.events&&n.gesture.view&&n.gesture.view.length){g.stopInertia();var p=n.gesture.events;var r=n.gesture.view[0];var m=p[0].getCurrentPosition?p[0].getCurrentPosition(r):p[0].currentPosition;var k=p[0].getLastPosition?p[0].getLastPosition(r):p[0].lastPosition;if(m&&k){var s=m.x-k.x;var q=m.y-k.y;var l=g.getDt();if(l>0){g._velocity.x=s/l;g._velocity.y=q/l}g.updateT();var o=g.offsetRectForScreenDisplacement(new i.Vector2(s,q));g.zoomToRect(o,{useResistence:false})}}}});return h});define("DS/3DPlay360Experiences/DirectionIndicatorCylindrical",["UWA/Class","DS/Core/Events","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/WebSystem/Environment","DS/3DPlay360Experiences/DirectionIndicatorAbstract","css!DS/3DPlay360Experiences/directionIndicatorCylindrical.css"],function(c,b,g,h,e,a,d){var f=a.extend({init:function(i){this.iconName="Cylindrical";this._parent(i)},_hideIndicator:function(){if(this._getOuterContainer()&&this._getContainer()&&this._getLight()){this._getOuterContainer().classList.remove("indicatorOuterContainerCylindrical");this._getContainer().classList.remove("directionIndicatorCylindrical");this._getLight().classList.remove("lightCylindrical");this._getLight().style.backgroundColor="white";this._getLight().style.border="2px solid black";this._getNorth().classList.remove("hide")}},showIndicator:function(){if(this._getOuterContainer()&&this._getContainer()&&this._getLight()){this._getOuterContainer().classList.add("indicatorOuterContainerCylindrical");this._getContainer().classList.add("directionIndicatorCylindrical");this._getLight().classList.add("lightCylindrical");this._getNorth().classList.add("hide");this._getLight().style.height="25px";this._getLight().style.width="13px"}},_updateLight:function(){var i=this._getLight();if(i){var k=this._radius*0.6;var j=this._angle;var m=k*Math.cos(j);var l=50-50*m;i.style.left=l+"%";if(i.style.top!=="50%"){i.style.top="50%"}if(j<3){i.style.backgroundColor="black";i.style.border="2px solid white"}else{if(j>3){i.style.backgroundColor="white";i.style.border="2px solid black"}}}}});return f});define("DS/3DPlay360Experiences/ImgMaterialCylindrical",["DS/3DPlay360Experiences/ImgMaterialAbstract"],function(a){var b=a.extend({init:function(c){this._parent(c)},_updateMaterial:function(f,e,d){if(f&&f.isReady){if(d){e.updatePDSFXUniform("uSampler",d)}var c=f.geomData();if(c&&e){e.updatePDSFXUniform("fullPanoWidthPixels",c.fullPanoWidthPixels);e.updatePDSFXUniform("fullPanoHeightPixels",c.fullPanoHeightPixels);e.updatePDSFXUniform("croppedAreaImageWidthPixels",c.croppedAreaImageWidthPixels);e.updatePDSFXUniform("croppedAreaImageHeightPixels",c.croppedAreaImageHeightPixels);e.updatePDSFXUniform("croppedAreaLeftPixels",c.croppedAreaLeftPixels);e.updatePDSFXUniform("croppedAreaTopPixels",c.croppedAreaTopPixels);e.updatePDSFXUniform("applyEffect",-1)}e.needsUpdate=true;c=undefined}}});return b});define("DS/3DPlay360Experiences/ImgSphericalViewerController",["UWA/Class","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/3DPlay360Experiences/mathUtils360","DS/3DPlay360Experiences/TrackballControlSpherical","DS/3DPlay360Experiences/DirectionIndicatorSpherical","DS/3DPlay360Experiences/ImgAbstractViewerController","DS/3DPlay360Experiences/ImgMaterialSpherical"],function(a,f,h,g,b,d,e,i,c){var j=i.extend({init:function(k){this._parent(k);this._directionIndicator=new e({id:k.id,callback:k.callback})},dispose:function(){this._parent()},createTrackball:function(k){return new d({applyKinematicConstraints:false,inertia:true,size:k})},createMaterial:function(){return new c()},_createNode:function(){var l=new h.Matrix4().makeBasis(new h.Vector3(-1,0,0),new h.Vector3(0,-1,0),new h.Vector3(0,0,1));var k={matrix:l,radius:100};var m=g.createSphereNode(k);m.name="imgSphereNode";m.setMatrix(new h.Matrix4().setPosition(new h.Vector3(0,0,0)));this.createdNode=m;return m},applyKinematicConstraints:function(){},removeKinematicConstraints:function(){var k=this.trackBall();if(k){k.setApplyConstraints(false)}},_computeInitialView:function(o){var m=null,l=null;if(o){var n=o.computeMiddlePointSphericalCoord();var k=new b();m=k.ur({r:1,theta:n.x,phi:n.y});l=k.uPhi({r:1,theta:n.x,phi:n.y}).multiplyScalar(-1)}return{sight:m,up:l}},_reframeOnInitialView:function(k){var m=this.getImgData();if(m&&m._img&&m._imgGeomData){var l=this._computeInitialView(m);if(l&&l.sight&&l.up&&this.viewpoint()){this.viewpoint().moveTo({eyePosition:new h.Vector3(),sightDirection:l.sight,upDirection:l.up,duration:(k)?500:0})}}},_getVisiblePixelCoord:function(x){x=this.getImgData();var z=null;var t=null;var s=null;var v=this.trackBall();if(v){var k=v.computeFieldOfViews(this.viewpoint());var p=(k.hFov)?k.hFov:0;var q=(k.vFov)?k.vFov:0;var r=this.viewpoint().getSightDirection();var u=new b();var A=u.getSPhericalCoordinates(r);var n=A.theta-p/2;var y=A.theta+p/2;var m=A.phi-q/2;var w=A.phi+q/2;var o={theta:n,phi:w};var B={theta:y,phi:w};var l={theta:n,phi:m};z=x.pixelForThetaPhi(o);t=x.pixelForThetaPhi(B);s=x.pixelForThetaPhi(l)}return{bottomLeftPixel:z,bottomRightPixel:t,topLeftPixel:s}}});return j});define("DS/3DPlay360Experiences/ImgFlatViewerController",["DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/3DPlay360Experiences/TrackballControlPlane","DS/3DPlay360Experiences/DirectionIndicatorPlaner","DS/3DPlay360Experiences/ImgAbstractViewerController","DS/3DPlay360Experiences/ImgMaterialPlaner"],function(e,f,d,h,b,a,g){var c=a.extend({init:function(i){this._parent(i);this._planeData={width:200,height:100,distance:150};if(this.nodeDim&&this.nodeDim.width&&this.nodeDim.height){this._planeData.width=this.nodeDim.width;this._planeData.height=this.nodeDim.height;this._planeData.distance=this.nodeDim.width+this.nodeDim.height/2}this._userExpConfig={zoom:{defaultFOV:45}};this._directionIndicator=new b({id:i.id,callback:i.callback})},dispose:function(){this._planeData=null;this._parent()},createTrackball:function(i){return new h({applyKinematicConstraints:false,inertia:true,size:i})},createMaterial:function(){return new g()},_createNode:function(){var j=this._planeData.width;var m=this._planeData.height;var k=new f.PlaneGeometry(j,m);k.applyMatrix(new f.Matrix4().makeBasis(new f.Vector3(0,-1,0),new f.Vector3(0,0,-1),new f.Vector3(1,0,0)));var i=new f.Mesh(k,new f.MeshPhongMaterial(),true);var l=d.createNodeFromTHREEMesh(i);l.setMatrix(new f.Matrix4().setPosition(new f.Vector3(30,0,0)));l.name="planeNode";this.createdNode=l;return l},applyKinematicConstraints:function(){var j=this.trackBall().offsetRectForScreenDisplacement(new f.Vector2(0,0));var i=this.trackBall();if(i){i.setKinematicConstraints(j);i.setApplyConstraints(true)}if(this._directionIndicator){this._directionIndicator.setOrigin(j.origin)}},removeKinematicConstraints:function(){var i=this.trackBall();if(i){i.setApplyConstraints(false)}},_reframeOnInitialView:function(i){var j=(i)?1000:0;var l=(this._planeData&&this._planeData.distance)?this._planeData.distance:1;var k=this.viewer();if(k){k.setShadow(false);k.setGrid(false);k.setMirror(false,false);k.displayInfinitePlane(false);k.setPrePicking({activated:false,displayHL:false},true);k.setPicking({activated:false,displayHL:false},true)}this.defaultOffsetRect=this.trackBall().offsetRectForScreenDisplacement(new f.Vector2(0,0));this.setDefaultVP(j)},setDefaultVP:function(i){i=(i)?i:1000;this.viewpoint().moveTo({eyePosition:new f.Vector3(-this._planeData.distance,0,0),upDirection:new f.Vector3(0,0,1),sightDirection:new f.Vector3(1,0,0),duration:i});this.viewpoint().setAngle(this._userExpConfig.zoom.defaultFOV);this.trackBall().zoomToRect(this.defaultOffsetRect,{useResistence:false})}});return c});define("DS/3DPlay360Experiences/trackballControl360Video",["UWA/Class","DS/Visualization/WebGLV6Viewer","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/VisuEvents/EventsManager","DS/Core/Events","DS/VisuEvents/ScreenEvent","DS/3DPlay360Experiences/mathUtils360"],function(a,l,j,k,b,f,d,c,g,e){var i;var h=a.extend({init:function(m){this._userExpConfig={inertia:{minVelocity:0.1,tau:0.3,toleranceAngle:5,dtStationary:0.1},rotation:{speedRadius:1000,toleranceAngle:10},zoom:{minFovDeg:0,maxFovDeg:130,toleranceAngle:5,rightClickScalingAcceleration:0.015},elasticReturn:{animDuration:75}};this._viewpoint=null;this._animation=null;this._VisuEventsManagerTokens=null;this._basicEventToken=null;this._kinematicConstraints=null;this._applyKinematicConstraints=(m&&m.applyKinematicConstraints!==undefined)?m.applyKinematicConstraints:true;this._inertianAnim=null;this._inertia=(m&&m.inertia!==undefined)?m.inertia:true;this._currT=-1;this._angularVelocity={vTheta:null,vPhi:null};i=this;this._zoomCoeff=null;this._onZoomCB=null;if(m){this._viewpoint=m.viewpoint||null}this._parent(m)},clear:function(){this.stop();this._onZoomCB=null;this._animation=null;this._basicEventToken=null;this._kinematicConstraints=null;this._viewpoint=null;this._applyKinematicConstraints=true;this._inertia=true;this._currT=-1;this._angularVelocity={vTheta:null,vPhi:null}},activate:function(m){if(m){this._setViewpoint(m);this.overloadScreenControls();this.subscribeToUserInteractions()}},deactivate:function(){this.stopAnimation();this.stopInertia();this.stopGyro();var m=this._viewpoint.getControl();this.resetScreenControls(m);this.unsubscribeFromUserInteractions()},stop:function(){this.stopAnimation();this.stopInertia();this.stopGyro();this._setViewpoint(null);this.resetScreenControls();this.unsubscribeFromUserInteractions()},onZoomCB:function(m){this._onZoomCB=m},_setViewpoint:function(m){this._viewpoint=m},viewpoint:function(){return this._viewpoint},inertia:function(){return this._inertia},setInertia:function(m){if(m!==false){this.stopInertia()}this._inertia=m},setApplyConstraints:function(m){if(m===true&&this._applyKinematicConstraints===false&&this._kinematicConstraints){this._applyKinematicConstraints=true;this._animateBackToBestViewpointCompliantWithConstraints()}this._applyKinematicConstraints=m},applySphericalConstraints:function(){return this._applyKinematicConstraints},setKinematicConstraints:function(m){this._kinematicConstraints={thetaMin:m.thetaMin,thetaMax:m.thetaMax,phiMin:m.phiMin,phiMax:m.phiMax}},_computeSightDirRangeGivenConstraints:function(p,n){var r=this._kinematicConstraints;var m=this.computeFieldOfViews(this._viewpoint);var o=(m.hFov)?m.hFov:0;var q=(m.vFov)?m.vFov:0;return{thetaMin:r.thetaMin+(o/2),thetaMax:r.thetaMax-(o/2),phiMin:r.phiMin+(q/2),phiMax:r.phiMax-(q/2)}},computeMaxVFovGivenConstraints:function(){var m=null;if(this._applyKinematicConstraints){var s=this._kinematicConstraints;var n=s.thetaMax-s.thetaMin;var r=s.phiMax-s.phiMin;var o=n;var q=r;q=Math.min(this.vFov(o),q);var p=this._userExpConfig.zoom.toleranceAngle;m=(q*180/Math.PI)-p}return m},activateGyro:function(){},stopGyro:function(){},getDeviceOrientation:function(){var m=null;if(window.orientation!==undefined){m=window.orientation}else{console.log("This browser does not support device orientation")}return m},onUserEndScreenInteraction:function(){if(this._inertia){this.applyInertia.call(this)}},onUserStartScreenInteraction:function(){this.stopInertia()},subscribeToUserInteractions:function(){this._VisuEventsManagerTokens=[];this._VisuEventsManagerTokens.push(d.addEvent(document,"onLeftMouseUp",this.onUserEndScreenInteraction.bind(this)));this._VisuEventsManagerTokens.push(d.addEvent(document,"onRelease",this.onUserEndScreenInteraction.bind(this)));this._VisuEventsManagerTokens.push(d.addEvent(document,"onTap",this.onUserEndScreenInteraction.bind(this)));this._VisuEventsManagerTokens.push(d.addEvent(document,"onLeftMouseDown",this.onUserStartScreenInteraction.bind(this)));this._VisuEventsManagerTokens.push(d.addEvent(document,"onRightMouseDown",this.onUserStartScreenInteraction.bind(this)));this._VisuEventsManagerTokens.push(d.addEvent(document,"onTouch",this.onUserStartScreenInteraction.bind(this)))},unsubscribeFromUserInteractions:function(){var m=this._VisuEventsManagerTokens.length;for(var n=0;n<m;n++){d.removeEventFromToken(this._VisuEventsManagerTokens[n])}this._VisuEventsManagerTokens=null},overloadScreenControls:function(o){if(this._viewpoint){this._viewpoint.onReframe(function(){});this._viewpoint.onCenterCamera(function(){});var m=this._viewpoint.getControl();if(m){var n=this;m.onPan(function(p){p.defaultBehavior=false;console.log("onpan")}.bind(this));i.zoomFun=function(S){S.defaultBehavior=false;var O=S.evt;var H=S.factor;var r=(S&&S.gesture)?S.gesture.getEvents():null;var P=(S&&S.gesture&&S.gesture.view.length>0&&S.gesture.view[0])?S.gesture.view[0]:null;if(r&&r.length==2){var A=null,z=null;A=r[0];z=r[1];if(A&&z&&P){var N=1;var K=A.currentPosition;var I=z.currentPosition;var v=A.lastPosition;var u=z.lastPosition;var L=new k.Vector2(I.x-K.x,I.y-K.y);var F=new k.Vector2(u.x-v.x,u.y-v.y);var s=L.length();var J=F.length();if(J!=0){N=s/J}var p=n.computeFieldOfViews(this.viewpoint);if(p&&p.vFov&&N&&N!=0&&N!=1){var E=2*Math.atan((1/N)*Math.tan(p.vFov/2))*180/Math.PI;n.setZoomForAngle(E);var q=(window.devicePixelRatio!=undefined&&window.devicePixelRatio!=0)?window.devicePixelRatio:1;var w=new k.Vector2(0.5*(u.x+v.x),0.5*(u.y+v.y));var R=new k.Vector2(0.5*(k.glStates.currentWidth/q),0.5*(k.glStates.currentHeight/q));var B=new k.Vector2().addVectors(w,R.negate());B.multiplyScalar(1-N);console.log(B.x);var t=n.getRotationSphericalAngleForScreenDisplacement({dx:B.x,dy:B.y});n.setViewpointForRotation({dTheta:t.dTheta,dPhi:t.dPhi});this.viewer.render()}}}else{if(r&&r.length==1){var O=r[0];if(O&&O.event!=undefined){var Q=O.event;if(Q.button===g.MouseButton.RIGHT){var C=O.currentPosition;var y=O.lastPosition;var N=1;var K=O.startPosition;var I=O.currentPosition;var v=O.startPosition;var u=O.lastPosition;var L=new k.Vector2(0,I.y-K.y);var F=new k.Vector2(0,u.y-v.y);var s=L.length();var J=F.length();if(s!=0){N=J/s}var E=n.computeAngleForScalingFactor(N);n.setZoomForAngle(E);this.viewer.render()}}}else{if(H!=undefined&&H!=0){var D=this._viewpoint?this._viewpoint:this.viewpoint;var p=n.computeFieldOfViews(D);var G=(p.vFov)?p.vFov:0;var M=G*180/Math.PI;var x=M-H;n.setZoomForAngle(x);if(this.viewer){this.viewer.render()}else{this._viewpoint.viewer.render()}}}}};m.onZoom(i.zoomFun);i.rotateFun=function(v){v.defaultBehavior=false;if(v&&v.gesture.events&&v.gesture.view&&v.gesture.view.length&&n){n.stopInertia();var w=v.gesture.events;var y=v.gesture.view[0];var s=w[0].getCurrentPosition?w[0].getCurrentPosition(y):w[0].currentPosition;var p=w[0].getLastPosition?w[0].getLastPosition(y):w[0].lastPosition;if(s&&p){var z=s.x-p.x;var x=s.y-p.y;var r=n.getRotationSphericalAngleForScreenDisplacement({dx:z,dy:x});var u=r.dTheta;var t=r.dPhi;var q=n.getDt();if(q>0){n._angularVelocity.vTheta=u/q;n._angularVelocity.vPhi=t/q}n.updateT();n.setViewpointForRotation({dTheta:u,dPhi:t})}this.lastLockZState=this._state}};m.onRotate(i.rotateFun)}}},resetScreenControls:function(n){var m=n;if(m){m.onPan(null);m.onZoom(null);m.onRotate(null)}},_animateBackToBestViewpointCompliantWithConstraints:function(){if(this._applyKinematicConstraints&&this._kinematicConstraints){var B=this.computeFieldOfViews(this.viewpoint());var x=(B.vFov)?B.vFov:0;var p=x*180/Math.PI;var n=this.computeMaxVFovGivenConstraints();if(p>n){this.setZoomForAngle(n)}var r=new e();var C=this._viewpoint.getSightDirection().clone().normalize();var t=r.getSPhericalCoordinates(C);var q=t.theta;var w=t.phi;var A=this._computeSightDirRangeGivenConstraints();var m=t.theta-A.thetaMin;var u=t.theta-A.thetaMax;var z=t.phi-A.phiMin;var o=t.phi-A.phiMax;if(m<0){q=A.thetaMin}if(u>0){q=A.thetaMax}if(z<0){w=A.phiMin}if(o>0){w=A.phiMax}var s={r:1,theta:q,phi:w};var y=r.getCartesianCoord(s);var v=r.uPhi(s).multiplyScalar(-1);this._viewpoint.moveTo({eyePosition:this._viewpoint.getEyePosition(),sightDirection:y,upDirection:v,duration:this._userExpConfig.elasticReturn.animDuration})}},setViewpointForSphericalCoord:function(n){if(n&&n.theta!==undefined&&n.phi!==undefined){var m=this.computeViewpointForSphericalCoord({theta:n.theta,phi:n.phi});this._viewpoint.setEyePosition(m.eyePosition);this._viewpoint.setSightDirection(m.sightDirection);this._viewpoint.setUpDirection(m.upDirection)}},setViewpointForRotation:function(n){if(n&&n.dTheta!==undefined&&n.dPhi!==undefined){var m=this._computeViewpointForRotation({dTheta:n.dTheta,dPhi:n.dPhi});this._viewpoint.setEyePosition(m.eyePosition);this._viewpoint.setSightDirection(m.sightDirection);this._viewpoint.setUpDirection(m.upDirection)}},setViewpointForEulerRotation:function(p){if(p&&p.dAlpha!==undefined&&p.dBeta!==undefined&&p.dGamma!==undefined){var q=new k.Vector3(p.dAlpha,p.dBeta,p.dGamma,"ZXY");var n=(new k.Quaternion()).setFromEuler(q);var r=this._viewpoint.getSightDirection();var m=r.clone().applyQuaternion(n);var o=this.computeViewpointForSightDir(m);if(o){this._viewpoint.setEyePosition(o.eyePosition);this._viewpoint.setSightDirection(o.sightDirection);this._viewpoint.setUpDirection(o.upDirection)}}},setZoomForAngle:function(o){if(o){var n=o;if(this._applyKinematicConstraints){var m=this.computeMaxVFovGivenConstraints();n=(n>m)?m:n}if(n&&n>=this._userExpConfig.zoom.minFovDeg&&n<=this._userExpConfig.zoom.maxFovDeg){this.viewpoint().setAngle(n);if(this._onZoomCB){this._onZoomCB()}}}},computeAngleForScalingFactor:function(n){console.log(n);var o=null;if(n!==null&&n!==0&&n!==1){var m=this.computeFieldOfViews(this.viewpoint());if(m&&m.vFov){o=2*Math.atan((1/n)*Math.tan(m.vFov/2))*180/Math.PI}}return o},computeViewpointForSightDir:function(r){var o=new e();var p=o.getSPhericalCoordinates(r);var q=this._viewpoint.getSightDirection();var n=o.getSPhericalCoordinates(q);var m=p.theta-n.theta;var s=p.phi-n.phi;return this._computeViewpointForRotation({dTheta:m,dPhi:s})},computeViewpointForSphericalCoord:function(q){var p=this._viewpoint.getSightDirection();var o=new e();var n=o.getSPhericalCoordinates(p);var m=q.theta-n.theta;var r=q.phi-n.phi;return this._computeViewpointForRotation({dTheta:m,dPhi:r})},_computeViewpointForRotation:function(D){var r=null;var x=null;var n=null;if(D&&D.dTheta!==null&&D.dPhi!==null){var A=D.dTheta;var p=D.dPhi;var y=new e();var s=y.getSPhericalCoordinates(this._viewpoint.getSightDirection().clone().normalize());var t={r:1,theta:s.theta+A,phi:s.phi+p};if(this._applyKinematicConstraints&&this._kinematicConstraints){var u=this._computeSightDirRangeGivenConstraints();var z=t.theta-u.thetaMin;var C=t.theta-u.thetaMax;var q=t.phi-u.phiMin;var v=t.phi-u.phiMax;var o=this._userExpConfig.rotation.toleranceAngle*(Math.PI/180);if(z<0){var m=1-Math.abs(z)/o;A=m*A}if(C>0){var m=1-Math.abs(C)/o;A=m*A}if(q<0){var m=1-Math.abs(q)/o;p=m*p}if(v>0){var m=1-Math.abs(v)/o;p=m*p}t={r:1,theta:s.theta+A,phi:s.phi+p}}var w=0.05;var B={min:w,max:Math.PI-w};t.phi=(t.phi<B.min)?B.min:t.phi;t.phi=(t.phi>B.max)?B.max:t.phi;n=this._viewpoint.getEyePosition();r=y.getCartesianCoord(t);x=y.uPhi(t).multiplyScalar(-1)}return{eyePosition:n,sightDirection:r,upDirection:x}},computeFieldOfViews:function(n){var p=null,q=null;if(n){var o=n.getCamera();if(o){q=o.fov*Math.PI/180;var m=o.aspect;p=2*Math.atan(m*Math.tan(q/2))}}return{hFov:p,vFov:q}},vFov:function(p){var o=null;if(p){var n=this.viewpoint().getCamera();if(n){var m=n.aspect;if(m){o=2*Math.atan((1/m)*Math.tan(p/2))}}}return o},hFov:function(m){var p=null;if(m){var o=this.viewpoint().getCamera();if(o){var n=o.aspect;if(n){p=2*Math.atan(n*Math.tan(m/2))}}}return p},getRotationSphericalAngleForScreenDisplacement:function(o){var s=null,q=null;if(o&&o.dx!==undefined&&o.dy!==undefined){var r=k.glStates.currentHeight;var n=k.glStates.currentWidth;var u=this.computeFieldOfViews(this.viewpoint());var p=(u.hFov)?u.hFov:0;var t=(u.vFov)?u.vFov:0;var m=(window.devicePixelRatio!==undefined)?window.devicePixelRatio:1;s=(p/n)*o.dx*m;q=-(t/r)*o.dy*m}return{dTheta:s,dPhi:q}},getDt:function(){var n=0;var m=Date.now();if(this._currT>0){n=(m-this._currT)/1000}return n},updateT:function(){this._currT=Date.now()},stopInertia:function(){if(this._inertianAnim){this._inertianAnim.stop();this._inertianAnim=null}},applyInertia:function(){this.stopInertia();var p=new k.Vector2();p.x=this._angularVelocity.vTheta;p.y=this._angularVelocity.vPhi;var r=this._userExpConfig.inertia.minVelocity;if((Math.abs(p.x)<r&&Math.abs(p.y)<r)||this.getDt()>this._userExpConfig.inertia.dtStationary){this._animateBackToBestViewpointCompliantWithConstraints()}else{var s=1000;var t=this;var q=0;var n=new b(0,0,s);n.setInterpolator(function(C){var H=t._userExpConfig.inertia.tau;C=C*s/1000;var E=C-q;q=C;var y=p;var J=y.x;var N=y.y;var x=J*Math.exp(-C/H);var O=N*Math.exp(-C/H);var I=new e();var u=t._viewpoint.getSightDirection().clone().normalize();var D=I.getSPhericalCoordinates(u);var K=D.theta;var z=D.phi;var A=K+x*E;var w=z+O*E;if(t._applyKinematicConstraints&&t._kinematicConstraints){var G=t._computeSightDirRangeGivenConstraints();var v=t._userExpConfig.inertia.toleranceAngle*(Math.PI/180);var L=A-(G.thetaMin-v);var M=A-(G.thetaMax+v);var B=w-(G.phiMin-v);var F=w-(G.phiMax+v);if(L<0){p.x=(p.x<0)?-p.x:p.x}if(M>0){p.x=(p.x>0)?-p.x:p.x}if(B<0){p.y=(p.y<0)?-p.y:p.y}if(F>0){p.y=(p.y>0)?-p.y:p.y}A=K+x*E;w=z+O*E}return{theta:A,phi:w}});var o=function(u){this.me.setViewpointForSphericalCoord({theta:u.theta,phi:u.phi})};var m={me:this,setOrientation:o};this._inertianAnim=new f(m,"setOrientation",n);this._inertianAnim.start()}},startAnimation:function(m){this.stopInertia();this.stopAnimation();if(null===this._basicEventToken){this._basicEventToken=c.subscribe({event:"/VISU/onBasicEvent"},function(q){if(q){for(var s=0;s<q.from.length;s++){var r=q.from[s];var u=r.getType();var t=r.getState();if((r instanceof g)&&u!=="Keyboard"){if(t===g.State.BEGIN){this.stopAnimation()}}}}}.bind(this))}if(this._animation===null){var n=function(q){this._nbLoops=(q.animationData.nbLoops!==undefined)?q.animationData.nbLoops:5;this._duration=(q.animationData.duration!==undefined)?q.animationData.duration:10000;this._T=this._duration/this._nbLoops;this._rotVect=q.viewpointData.rotVect;this._rotAngle=q.viewpointData.rotAngle;this._sightDir_t0=q.viewpointData.sightDir;this.duration=function(){return this._duration};this.valueAt=function(v){var s=(v%this._T)/this._T;var w=new k.Matrix4();w.makeRotationAxis(this._rotVect,s*this._rotAngle);var u=this._sightDir_t0.clone();u.applyMatrix4(w);var r={viewpoint:q.viewpointData.viewpoint,sightDir:u,eyePosition:new k.Vector3(0,0,0)};return r}};var o={animationData:{nbLoops:1,duration:100000},viewpointData:{viewpoint:m,sightDir:m.getSightDirection(),rotVect:new k.Vector3(0,0,1),rotAngle:-2*Math.PI}};var p=new n(o);this._animation=new f(this,"viewpointAnimationCB",p)}if(this._animation){this._animation.setLoop(1);this._animation.start()}},viewpointAnimationCB:function(m){if(m&&m.viewpoint&&m.sightDir){m.viewpoint.setEyePosition(m.eyePosition);m.viewpoint.setSightDirection(m.sightDir)}},stopAnimation:function(){if(this._basicEventToken){c.unsubscribe(this._basicEventToken);this._basicEventToken=null}if(this._animation){this._animation.stop();this._animation=null}}});return h});define("DS/3DPlay360Experiences/TrackballControlCylindrical",["UWA/Class","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/VisuEvents/EventsManager","DS/Core/Events","DS/VisuEvents/ScreenEvent","DS/3DPlay360Experiences/mathUtils360","DS/3DPlay360Experiences/TrackballAbstractControl","DS/Visualization/ThreeJS_DS"],function(a,b,f,e,c,h,g,k,j){var i=null;var d=k.extend({init:function(n){this._parent(n);var o=Math.min(this.viewerHeight,n.size.imgSize.height);var l=Math.min(this.viewerWidth,n.size.imgSize.width);var m=o/l*2*180/Math.PI;this._userExpConfig.zoom.maxFovDeg=m?m:125;this._userExpConfig.rotation.toleranceAngle=l/o*10;i=this},dispose:function(){this._applyKinematicConstraints=null;this._parent();i=null},setKinematicConstraints:function(l){this._kinematicConstraints={thetaMin:l.thetaMin,thetaMax:l.thetaMax,phiMin:l.phiMin,phiMax:l.phiMax}},_computeSightDirRangeGivenConstraints:function(){var o=this._kinematicConstraints;var l=this.computeFieldOfViews(this._viewpoint);var m=(l.hFov)?l.hFov:0;var n=(l.vFov)?l.vFov:0;return{thetaMin:o.thetaMin+(m/2),thetaMax:o.thetaMax-(m/2),phiMin:o.phiMin+(n/2),phiMax:o.phiMax-(n/2)}},_computeMaxVFovGivenConstraints:function(){var l=null;var p=this._kinematicConstraints;if(p){var o=p.phiMax-p.phiMin;var n=o;var m=this._userExpConfig.zoom.toleranceAngle;l=(n*180/Math.PI)-m}return l},_animateBackToBestViewpointCompliantWithConstraints:function(){var A=this.computeFieldOfViews(this.viewpoint());var w=(A.vFov)?A.vFov:0;var o=w*180/Math.PI;var m=this._computeMaxVFovGivenConstraints();if(o>m){this._setZoomForAngle(m)}var q=new g();var B=this._viewpoint.getSightDirection().clone().normalize();var s=q.getSPhericalCoordinates(B);var p=s.theta;var v=s.phi;var z=this._computeSightDirRangeGivenConstraints();var l=s.theta-z.thetaMin;var t=s.theta-z.thetaMax;var y=s.phi-z.phiMin;var n=s.phi-z.phiMax;if(l<0){p=z.thetaMin}if(t>0){p=z.thetaMax}if(y<0){v=z.phiMin}if(n>0){v=z.phiMax}var r={r:1,theta:p,phi:v};var x=q.getCartesianCoord(r);var u=q.uPhi(r).multiplyScalar(-1);this._viewpoint.moveTo({eyePosition:this._viewpoint.getEyePosition(),sightDirection:x,upDirection:u,duration:this._userExpConfig.elasticReturn.animDuration})},_setZoomForAngle:function(n){if(n){var m=n;var l=this._computeMaxVFovGivenConstraints();m=(m>l)?l:m;if(m&&m>=this._userExpConfig.zoom.minFovDeg&&m<=this._userExpConfig.zoom.maxFovDeg){this.viewpoint().setAngle(m);if(this._onZoomCB){this._onZoomCB()}}}},_computeViewpointForRotation:function(C){var q=null;var w=null;var m=null;if(C&&C.dTheta!==null&&C.dPhi!==null){var z=C.dTheta;var o=C.dPhi;var x=new g();var r=x.getSPhericalCoordinates(this._viewpoint.getSightDirection().clone().normalize());var s={r:1,theta:r.theta+z,phi:r.phi+o};if(this._kinematicConstraints){var t=this._computeSightDirRangeGivenConstraints();var y=s.theta-t.thetaMin;var B=s.theta-t.thetaMax;var p=s.phi-t.phiMin;var u=s.phi-t.phiMax;var n=this._userExpConfig.rotation.toleranceAngle*(Math.PI/180);var l;if(y<0){l=1-Math.abs(y)/n;z=l*z}if(B>0){l=1-Math.abs(B)/n;z=l*z}if(p<0){l=1-Math.abs(p)/n;o=l*o}if(u>0){l=1-Math.abs(u)/n;o=l*o}s={r:1,theta:r.theta+z,phi:r.phi+o}}var v=0.05;var A={min:v,max:Math.PI-v};s.phi=(s.phi<A.min)?A.min:s.phi;s.phi=(s.phi>A.max)?A.max:s.phi;m=this._viewpoint.getEyePosition();q=x.getCartesianCoord(s);w=x.uPhi(s).multiplyScalar(-1)}return{eyePosition:m,sightDirection:q,upDirection:w}},startAnimation:function(l){this.stopInertia();this.stopAnimation();if(null===this._basicEventToken){this._basicEventToken=c.subscribe({event:"/VISU/onBasicEvent"},function(p){if(p){for(var r=0;r<p.from.length;r++){var q=p.from[r];var t=q.getType();var s=q.getState();if((q instanceof h)&&t!=="Keyboard"){if(s===h.State.BEGIN){this.stopAnimation()}}}}}.bind(this))}if(this._animation===null){var m=function(p){this._nbLoops=(p.animationData.nbLoops!==undefined)?p.animationData.nbLoops:5;this._duration=(p.animationData.duration!==undefined)?p.animationData.duration:10000;this._T=this._duration/this._nbLoops;this._rotVect=p.viewpointData.rotVect;this._rotAngle=p.viewpointData.rotAngle;this._sightDir_t0=p.viewpointData.sightDir;this.duration=function(){return this._duration};this.valueAt=function(u){var r=(u%this._T)/this._T;var v=new j.Matrix4();v.makeRotationAxis(this._rotVect,r*this._rotAngle);var s=this._sightDir_t0.clone();s.applyMatrix4(v);var q={viewpoint:p.viewpointData.viewpoint,sightDir:s,eyePosition:new j.Vector3(0,0,0)};return q}};var n={animationData:{nbLoops:1,duration:100000},viewpointData:{viewpoint:l,sightDir:new j.Vector3(1,0,0),rotVect:new j.Vector3(0,0,1),rotAngle:-2*Math.PI}};var o=new m(n);this._animation=new f(this,"viewpointAnimationCB",o)}if(this._animation){this._animation.setLoop(1);this._animation.start()}},reframe:function(){var l=this.computeFieldOfViews(this.viewpoint());var n=(l.vFov)?l.vFov:0;var m;if(this.defaultZoom){m=n*180/Math.PI}else{m=this._userExpConfig.zoom.maxFovDeg}this._setZoomForAngle(m);if(this.viewer){this.viewer.render()}}});return d});define("DS/3DPlay360Experiences/Video360ViewerController",["UWA/Class","DS/Visualization/WebGLV6Viewer","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/3DPlay360Experiences/trackballControl360Video","DS/3DPlay360Experiences/MediaAbstractViewerController"],function(a,h,d,e,c,g,b){var f=b.extend({init:function(i){this._parent(i)},dispose:function(){this._parent()},createTrackball:function(){},reframe:function(i){},_createNode:function(){},});return f});define("DS/3DPlay360Experiences/ImgCylindricalViewerController",["UWA/Class","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/3DPlay360Experiences/mathUtils360","DS/3DPlay360Experiences/TrackballControlCylindrical","DS/3DPlay360Experiences/DirectionIndicatorCylindrical","DS/3DPlay360Experiences/ImgAbstractViewerController","DS/3DPlay360Experiences/ImgMaterialCylindrical"],function(c,g,i,h,e,d,f,j,b){var a=j.extend({init:function(k){this._parent(k);this._directionIndicator=new f({id:k.id,callback:k.callback})},dispose:function(){this._parent()},createTrackball:function(k){return new d({applyKinematicConstraints:false,inertia:true,size:k})},createMaterial:function(){return new b()},_createNode:function(){var l=100;var k=200;if(this.nodeDim){l=this.nodeDim.width/(2*Math.PI);k=this.nodeDim.height}var n={bottomCenterPoint:new i.Vector3(0,0,-k),topCenterPoint:new i.Vector3(0,0,k),bottomRadius:l,topRadius:l,bottomCap:false,topCap:false};var m=h.createCylinderCustomNode(n);m.name="imgCylinderNode";m.setMatrix(new i.Matrix4().setPosition(new i.Vector3(0,0,0)));this.createdNode=m;return m},applyKinematicConstraints:function(){var m=this.getImgData();var l=m.computeImgRangeInSphericalCoord();var k=this.trackBall();if(k&&l){k.setKinematicConstraints(l);k.setApplyConstraints(true)}},removeKinematicConstraints:function(){var k=this.trackBall();if(k){k.setApplyConstraints(false)}},_computeInitialView:function(o){var m=null,l=null;if(o){var n=o.computeMiddlePointSphericalCoord();var k=new e();m=k.ur({r:1,theta:n.x,phi:n.y});l=k.uPhi({r:1,theta:n.x,phi:n.y}).multiplyScalar(-1)}return{sight:m,up:l}},_reframeOnInitialView:function(k){var m=this.getImgData();if(m&&m._img&&m._imgGeomData){var l=this._computeInitialView(m);if(l&&l.sight&&l.up&&this.viewpoint()){this.viewpoint().moveTo({eyePosition:new i.Vector3(),sightDirection:l.sight,upDirection:l.up,duration:(k)?500:0})}}},_getVisiblePixelCoord:function(x){x=this.getImgData();var z=null;var t=null;var s=null;var v=this.trackBall();if(v){var k=v.computeFieldOfViews(this.viewpoint());var p=(k.hFov)?k.hFov:0;var q=(k.vFov)?k.vFov:0;var r=this.viewpoint().getSightDirection();var u=new e();var A=u.getSPhericalCoordinates(r);var n=A.theta-p/2;var y=A.theta+p/2;var m=A.phi-q/2;var w=A.phi+q/2;var o={theta:n,phi:w};var B={theta:y,phi:w};var l={theta:n,phi:m};z=x.pixelForThetaPhi(o);t=x.pixelForThetaPhi(B);s=x.pixelForThetaPhi(l)}return{bottomLeftPixel:z,bottomRightPixel:t,topLeftPixel:s}}});return a});define("DS/3DPlay360Experiences/videoMaterial",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/3DPlay360Experiences/shaderFactory360"],function(a,c,b){var d=a.extend({init:function(e){this._src=null;this._video=null;this._videoMaterial=null;this._animationToken=null;this._updatedCB=null;this._parent(e)},setVideo:function(e){this._video=e},video:function(){return this._video},material:function(){return this._videoMaterial},updatedCB:function(e){this._updatedCB=e},activate:function(e){if(e){this.setVideo(e)}this._videoTexture=this._createVideoTexture(this._video);this._videoMaterial=this._createVideoMaterial(this._videoTexture);this.animate();return Promise.resolve(this)},dispose:function(){this.reset()},reset:function(){this._updatedCB=null;this.stopAnimationLoop();this._videoTexture=null;this._videoMaterial=null;this._src=null;this._video=null},animate:function(){this._animationToken=requestAnimationFrame(this.animate.bind(this));if(this._video.readyState>=this._video.HAVE_CURRENT_DATA){this._videoTexture.needsUpdate=true;if(this._updatedCB){this._updatedCB()}}},stopAnimationLoop:function(){if(this._animationToken){cancelAnimationFrame(this._animationToken)}this._animationToken=null},_render:function(e,f){f.needsUpdate=true;e.render()},_createVideoTexture:function(f){var e=new c.Texture(f);e.minFilter=c.LinearFilter;return e},_createVideoMaterial:function(g){var f=new b();var e=f.getFlippedTextureMaterial(g);e.side=c.DoubleSide;e.forceSide=true;e.force=true;e.needsUpdate=true;return e},});return d});define("DS/3DPlay360Experiences/ProjectionTypeManager",["UWA/Class","DS/3DPlay360Experiences/ImgFlatViewerController","DS/3DPlay360Experiences/ImgSphericalViewerController","DS/3DPlay360Experiences/ImgCylindricalViewerController"],function(c,d,b,e){var a=c.extend({init:function(f){this.PROJECTION_TYPE={CYLINDRICAL:1,EQUIRECTANGULAR:2,PLANER:3};this.imgData=null;this._defaultProjType=this.decideDefault(f.size);this._currentProjType=this._defaultProjType;this.viewerControllerEnum={CYLINDRICAL:null,EQUIRECTANGULAR:null,PLANER:null};this._createImgViewerControllers(f)},decideDefault:function(g){var f=this.PROJECTION_TYPE.EQUIRECTANGULAR;if(g&&g.height&&g.width){var h=g.width/g.height;if(h>2){console.log("CYLINDRICAL");f=this.PROJECTION_TYPE.CYLINDRICAL}}return f},getdirectionIndicatorArray:function(){return[this.viewerControllerEnum.CYLINDRICAL.getDirectionIndicatorData(),this.viewerControllerEnum.EQUIRECTANGULAR.getDirectionIndicatorData(),this.viewerControllerEnum.PLANER.getDirectionIndicatorData()]},dispose:function(){this.viewerControllerEnum={CYLINDRICAL:null,EQUIRECTANGULAR:null,PLANER:null};this._currentProjType=null;this.imgData=null;this.PROJECTION_TYPE=null},getCurrProjeType:function(){return this._currentProjType},getProjeTypeList:function(){return this.PROJECTION_TYPE},getDefaultProjeType:function(){return this._defaultProjType},getDefaultVC:function(){if(this.PROJECTION_TYPE.CYLINDRICAL===this._defaultProjType){return this.viewerControllerEnum.CYLINDRICAL}if(this.PROJECTION_TYPE.EQUIRECTANGULAR===this._defaultProjType){return this.viewerControllerEnum.EQUIRECTANGULAR}if(this.PROJECTION_TYPE.PLANER===this._defaultProjType){return this.viewerControllerEnum.PLANER}return null},checkProjectionType:function(f){if(!this._currentProjType){this._currentProjType=this._defaultProjType}if(this.PROJECTION_TYPE[f]==this._currentProjType){return true}return false},changeProjType:function(f){this._currentProjType=this.PROJECTION_TYPE[f];this._imgViewerController=this.viewerControllerEnum[f];return this._imgViewerController},_createImgViewerControllers:function(g){var k=Object.keys(this.PROJECTION_TYPE);var f={CYLINDRICAL:e,EQUIRECTANGULAR:b,PLANER:d};for(var j=0;j<k.length;j++){var h=k[j];g.id=h;this.viewerControllerEnum[h]=new f[h](g);this.viewerControllerEnum[h].name=h}},getAllVCs:function(){return[this.viewerControllerEnum.EQUIRECTANGULAR,this.viewerControllerEnum.CYLINDRICAL,this.viewerControllerEnum.PLANER]}});return a});define("DS/3DPlay360Experiences/video360",["UWA/Class","DS/Visualization/WebGLV6Viewer","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/3DPlay360Experiences/directionIndicator","DS/3DPlay360Experiences/videoMaterial","DS/3DPlay360Experiences/Video360ViewerController"],function(a,h,b,c,f,g,e){var d=a.extend({init:function(i){if(!i||i===undefined){i={}}i.viewer=(i.viewer!==undefined)?i.viewer:null;i.viewpoint=(i.viewpoint!==undefined)?i.viewpoint:null;this._view=null;this._src=null;this._video=null;this._videoMaterial=null;this._directionIndicator=null;this._videoViewerController=this.createViewerController(i.viewer,this.view());this._parent(i)},setSrc:function(i){},src:function(){},setVideo:function(i){},video:function(){},view:function(){},viewerController:function(){},readyCB:function(i){},_createVideoElem:function(){},_playVideo:function(i,j){},_display:function(){},dispose:function(){},_render:function(){},createViewerController:function(i,j){},cleanViewerController:function(){},displayOrientationIndicator:function(j,i){},removeOrientationIndicator:function(){}});return d});define("DS/3DPlay360Experiences/3DPlay360VideoExperience",["DS/3DPlayExperienceModule/PlayExperience3D","UWA/Core","DS/WebSystem/Environment","DS/Visualization/WebGLV6Viewer","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/3DPlay360Experiences/video360","DS/3DPlay360Experiences/MediaLoader"],function(c,h,a,g,b,d,e,f){return c.extend({init:function(i){this.ERROR_TYPE={unsupportedFormat:1,imageSize:2,loadingError:3};i.commandApplication=false;i.workbenchs=[];this._filePath=null;this._video360=null;if(i&&i.options){i.options.splashscreen=i.options.splashscreen||{};i.options.splashscreen.waitloading=true}this._parent(i);this.autoReframe=false;this.showSplashBetweenLoad=true},dispose:function(){if(!this._suiPhotoSphere){this._video360.dispose();this._video360=null}this._parent()},video360:function(){return this._video360},onPreCreate:function(){},onPostCreate:function(){console.log("IV Exp loaded");if(this.frmWindow){this._viewer=this.frmWindow.getViewer();this._viewpoint=this.frmWindow.getViewpoint()}},loadModel:function(j,k,i){console.log("Video360 Experience is not yet supported!!")}})});define("DS/3DPlay360Experiences/Img360",["UWA/Class","DS/3DPlay360Experiences/ImgData","DS/3DPlay360Experiences/ProjectionTypeManager","DS/3DPlay360Experiences/DirectionIndicatorSwitch"],function(c,d,b,a){var f;var e=c.extend({init:function(g){f=this;this.countForDiIcon=0;this.countForImgVC=0;this.frmWindow=g.frmWindow;this._view=null;this._imgData=null;this._imgMaterial=null;this._directionIndicator=null;this._projectionTypeManager=this._createProjectionTypeManager({viewer:g.frmWindow.getViewer(),div:this._getView(),callback:this.callbackDiIcon,size:g.size});this.frmWindow.getViewerFrame().addEvent("resize",this._onResize.bind(this))},_getView:function(){if(!this._view){this._view=document.createElement("div");this._view.style.width="100%";this._view.style.height="100%";this._view.className="img360"}return this._view},setImg:function(g){if(g&&g.img){if(this._imgData){this._imgData.dispose();this._imgData=null}this._imgData=new d();this._imgData.setImg(g.img);this._imgData.setGeomData(g);this.iData={size:g.size}}else{console.error("Image Data Not Found! ");console.log("Data : "+g)}},_displayDefault:function(){this._imgViewerController=this._projectionTypeManager.getDefaultVC();this._display(this._imgViewerController)},_getImgData:function(){return this._imgData},readyCB:function(g){this._readyCB=g},_readyVCForDisplay:function(g){if(g){console.log("IMG DATA");console.time("[360 perfos] - Img Data Activation");this._getImgData().activate().then(function(){console.log("VIEWER CONTROLLER");console.timeEnd("[360 perfos] - Img Data Activation");g.setImgData(this._getImgData());g.applyKinematicConstraints();g.build(this.callbackImgVC.bind(this));return g.name}.bind(this)).then(function(h){if(this._readyCB){this._readyCB(h)}return Promise.resolve()}.bind(this))["catch"](function(h){console.log(h)})}},callbackImgVC:function(){f.countForImgVC++;if(f.countForImgVC===3){f.hideAllVC();f._displayDefault();f.countForImgVC=0}},callbackDiIcon:function(){f.countForDiIcon++;if(f.countForDiIcon===3){var g=setInterval(function(){if(f._projectionTypeManager){clearInterval(g);f._projectionTypeSwitch=f._createSwitch(f.frmWindow);f._readyAllVCForDisplay({imgSize:f.iData.size})}},100)}},_display:function(g){g.activate();g.trackBall().startAnimation(g.viewpoint());this._displayOrientationIndicator(g);g.showNode()},_readyAllVCForDisplay:function(k){var j=this._projectionTypeManager.getAllVCs();for(var h=0;h<j.length;h++){var g=j[h];if(g){g.activate(k);this._readyVCForDisplay(g)}}},hideAllVC:function(){var j=this._projectionTypeManager.getAllVCs();for(var h=0;h<j.length;h++){var g=j[h];if(g){g.hide()}}},_createProjectionTypeManager:function(g){return new b(g)},_createSwitch:function(){var h={func:this.changeImageViewerController.bind(this)};var g=this._projectionTypeManager.getdirectionIndicatorArray();return new a({iData:h,frmWindow:this.frmWindow,directionIndicatorArray:g,defaultProjType:this._projectionTypeManager.getDefaultProjeType()})},changeImageViewerController:function(g){if(!this._projectionTypeManager.checkProjectionType(g)){if(this._imgViewerController){this._imgViewerController.hide()}this._imgViewerController=this._projectionTypeManager.changeProjType(g);this._display(this._imgViewerController)}},_cleanImgViewer:function(){if(this._imgViewerController){this._imgViewerController.dispose();this._imgViewerController=null}},_displayOrientationIndicator:function(g){if(g){g.displayDirIndicator()}},dispose:function(){this._projectionTypeSwitch.destroy();this._projectionTypeSwitch=null;this._readyCB=null;this._cleanImgViewer();this._imgViewerController=null;if(this._imgMaterial){this._imgMaterial.dispose();this._imgMaterial=null}if(this._imgData){this._imgData.dispose();this._imgData=null}if(this._directionIndicator){this._directionIndicator.dispose();this._directionIndicator=null}if(this._projectionTypeManager){this._projectionTypeManager.dispose();this._projectionTypeManager=null}this._view=null;if(f){f=undefined}},_onResize:function(){if(this._projectionTypeSwitch){this._projectionTypeSwitch.resetCurvedUIDiv()}},_sampleImgData:function(){var g={projectionType:this.PROJECTION_TYPE.EQUIRECTANGULAR,croppedAreaImageWidthPixels:600,croppedAreaImageHeightPixels:300,fullPanoWidthPixels:600,fullPanoHeightPixels:300,croppedAreaLeftPixels:0,croppedAreaTopPixels:0};g={projectionType:this.PROJECTION_TYPE.CYLINDRICAL,croppedAreaImageWidthPixels:5200,croppedAreaImageHeightPixels:1760,fullPanoWidthPixels:5200*2,fullPanoHeightPixels:1760*2,croppedAreaLeftPixels:null,croppedAreaTopPixels:null};return g}});return e});define("DS/3DPlay360Experiences/3DPlay360Experience",["DS/3DPlayExperienceModule/PlayExperience3D","DS/3DPlay360Experiences/Img360","DS/3DPlay360Experiences/MediaLoader"],function(a,c,b){return a.extend({init:function(d){this.ERROR_TYPE={unsupportedFormat:1,imageSize:2,loadingError:3};d.commandApplication=false;d.workbenchs=[];this._filePath=null;this._img360=null;if(d&&d.options){d.options.splashscreen=d.options.splashscreen||{};d.options.splashscreen.waitloading=true}this._parent(d);this.autoReframe=false;this.showSplashBetweenLoad=true;this.refreshImage360()},dispose:function(){this.refreshImage360();this._parent()},img360:function(){return this._img360},onPreCreate:function(){},onPostCreate:function(){if(this.frmWindow){this._viewer=this.frmWindow.getViewer();this._viewpoint=this.frmWindow.getViewpoint()}},_step:function(){},loadModel:function(e,f,d){if(e&&e.asset&&e.asset.filename&&e.asset.format){this.refreshImage360();var g=(d!==undefined)?d:true;this.onModelLoadingStarted(g);this.loadAndCheckImage({format:e.asset.format,path:e.asset.filename,requestsOptions:e.asset.requestsOptions}).then(function(h){if(h&&h.img&&h.imgData){if(!this._img360){this._img360=new c({frmWindow:this.frmWindow,size:h.size})}this.progress.updateProgression(50);this.img360().readyCB(function(i){this.modelName=i;this.onModelLoadingCompleted();if(g){this.onModelLoadingProgression({loaded:100,total:100})}Promise.resolve("Success")}.bind(this));this.img360().setImg({img:h.img,projectionType:h.imgData.projectionType,fullPanoWidthPixels:h.imgData.fullPanoWidthPixels,fullPanoHeightPixels:h.imgData.fullPanoHeightPixels,croppedAreaImageWidthPixels:null,croppedAreaImageHeightPixels:null,croppedAreaLeftPixels:null,croppedAreaTopPixels:null,size:(h.size?h.size:0)})}}.bind(this))["catch"](function(h){console.log(h);if(h&&h.errorType){this.onError({error:{errorType:h.errorType,errorData:h.error},input:{format:e.asset.format,path:e.asset.filename}})}this.getPhaseProgress().hideProgressBar()}.bind(this))}},onError:function(d){var e=d;if(e&&e.error&&e.error.errorType){switch(e.error.errorType){case this.ERROR_TYPE.unsupportedFormat:this.onModelLoadingError({type:"FORMAT",url:"dummy."+e.input.format});break;case this.ERROR_TYPE.imageSize:this.onModelLoadingError({type:"FORMAT",url:"dummy."+e.input.format});break;default:}}},loadAndCheckImage:function(d){var e=new Promise(function(i,h){if(d&&d.format&&d.path){var f=(d.format==="jpg"||d.format==="jpeg")?d.format:null;if(!f){h({errorType:this.ERROR_TYPE.unsupportedFormat,error:d.format})}else{console.time("[360 perfos] - Load img");var g=new b();if(g){g.img(d).then(function(j){console.timeEnd("[360 perfos] - Load img");i(j)}.bind(this))["catch"](function(j){h({errorType:this.ERROR_TYPE.loadingError,error:j})}.bind(this))}}}}.bind(this));return e},refreshImage360:function(){if(this._img360){this._img360.dispose();this._img360=null}}})});