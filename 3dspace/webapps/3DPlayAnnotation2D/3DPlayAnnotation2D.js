define("DS/3DPlayAnnotation2D/AnnotationManager",["UWA/Class","DS/3DPlayAnnotationUtils/AnnotationAbbreviations"],function(b,c){var a=b.extend({init:function(d){this.options=d;this.viewer=this.options.frameWindow.getViewer();this.AnnotationAbbreviations=new c()},saveAnnotationsToJSON:function(){var g=this.getAnnotations();var f=this.AnnotationAbbreviations.processJSON(g,"minify");var d=JSON.stringify(f);return d},getAnnotations:function(){var f={annotations:[]};this.totalShteets=this.viewer.nbSheets;for(var d=0;d<this.totalShteets;d++){if(this.viewer.sheets[d].annotations){f.annotations[d]=this.viewer.sheets[d].annotations}}return f},deleteAllAnnotations:function(){},drawAnnotationsFromJSON:function(d,h){if(h){this.deleteAllAnnotations()}var g=JSON.parse(d);var f=this.AnnotationAbbreviations.processJSON(g,"expand");this.viewer.saveAnnotData(f)},dispose:function(){this.deleteAllAnnotations()}});return a});define("DS/3DPlayAnnotation2D/Annotation2DCommand",["UWA/Class"],function(a){return(a.extend({init:function(b){this._parent(b);this.frameWindow=b.frameWindow;this.hideTools=b.hideTools;this._isRunning=false},begin:function(b){this._isRunning=true},end:function(b){this._isRunning=false},isRunning:function(){return this._isRunning},destroy:function(){this.frameWindow=undefined;this.hideTools=undefined;this._isRunning=undefined},hideUI:function(){if(this.hideTools){this.hideTools()}var b=this.frameWindow.getViewer();if((b.multiSheet==true||b.multiDoc==true)&&b.leftPanel!=undefined){if(b.leftPanel.elements.container.dataset.isopen=="true"){b.leftPanel.slideOut()}}}}))});define("DS/3DPlayAnnotation2D/Annotation2DDrawPreview",["UWA/Class","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/3DPlayAnnotationUtils/CursorManager","DS/Core/PointerEvents","DS/WebUtils/Vector2","DS/VisuEvents/EventsManager"],function(d,g,c,f,b,a){var h;return(d.extend({init:function(i){this._parent(i);h=this;this.viewer=i.viewer;this.hideUICB=i.hideUICB;this.strokeCompleteCB=i.strokeCompleteCB;this.draw=false;this.gesture=false;this.drawSettings=new g();this.viewerPoints=[];this.frameWindow=i.frameWindow;var j=this.frameWindow.experience;if(j&&j.registerCollabAction){this.exp=j;j.registerCollabAction("annot2DBeginManipulate",h._beginManipulate.bind(h));j.registerCollabAction("annot2DManipulate",h._manipulate.bind(h));j.registerCollabAction("annot2DEndManipulate",h._endManipulate.bind(h))}},begin:function(i){this.container=this.viewer.sheetCollection.getContent();this.currentSheet=this.viewer.currentSheet;this.sheetViewer=this.viewer.sheetCollection.getCellInfosAt(this.currentSheet).cellModel.getSheetViewer();this._activateManipulators();this.cursorManager=new c();this._setMouseCursor("custom")},isPointerInAnnotationDrawingSpace:function(j){if(this.sheetViewer){var l=this.sheetViewer.canvas.getBoundingClientRect();var k=(j.x>=l.left&&j.x<=l.left+l.width);var i=(j.y>=l.top&&j.y<=l.top+l.height);return(k&&i)}},end:function(i){if(this.cursorManager){this._setMouseCursor("auto");this.cursorManager.dispose();this.cursorManager=null}this._disableManipulators();this.drawSettings=undefined},destroy:function(){if(this.canvas){this._destroyCanvas()}this.viewerPoints=[];this.hideUICB=undefined;this.strokeCompleteCB=undefined;this.container=undefined;this.viewer=undefined;h=undefined},_setMouseCursor:function(i){if(this.cursorManager){this.cursorManager.setMouseCursor({container:this.container,caller:"2D",type:i,drawSettings:this.drawSettings})}},_createCanvas:function(){this.canvas=new UWA.Element("canvas",{id:"annotPreviewCanvas",styles:{position:"absolute","z-index":"2000",top:0,left:0,"pointer-events":"none"}}).inject(this.container);var i=this.container.getDimensions();this.canvas.width=i.width;this.canvas.height=i.height;this.canvasContext=this.canvas.getContext("2d")},_destroyCanvas:function(){this.canvasContext=undefined;this.canvas.destroy();this.canvas=undefined},_setStrokeStyle:function(){this.canvasContext.strokeStyle=""+this.drawSettings.getColor();this.canvasContext.fillStyle=""+this.drawSettings.getColor();this.canvasContext.globalAlpha=1;this.canvasContext.lineCap="round";this.canvasContext.lineJoin="round";this.canvasContext.lineWidth=this.drawSettings.getThickness()},_translateToCanvasPosition:function(i){var j=this.canvas.getBoundingClientRect();var k=new b(i.x-j.left,i.y-j.top);if(this.exp&&this.exp.collabMode===false){if(j.height!==origin.height||j.width!==origin.width){k.x=k.x-(e.width-j.width)/2;k.y=k.y-(e.height-j.height)/2}}return k},_translateToViewerPosition:function(j){var k=this.sheetViewer.canvas.getBoundingClientRect();if(this.isPointerInAnnotationDrawingSpace(j)){this._setMouseCursor("custom");var l=this.sheetViewer.getScale();var i=(j.x-k.left)/l;var m=(j.y-k.top)/l;return new b(i,m)}else{this._setMouseCursor("not-allowed");return false}},_beginManipulate:function(m){this.viewerPoints=[];var i=new b(m.clientX,m.clientY);var k=m.width?i:this._translateToViewerPosition(i);if(k&&m.button==0){this.viewerPoints.push(k);this.draw=true;this.hideUICB();this._setStrokeStyle();var l=this._translateToCanvasPosition(i);if(l){this.canvasContext.beginPath();this.canvasContext.moveTo(l.x,l.y);if(this.exp&&this.exp.collabMode===true){var j=m.srcElement.getBoundingClientRect();this.exp.notifyScriptingFunction("annot2DBeginManipulate",[{clientX:k.x,clientY:k.y,width:j.width,height:j.height,button:0}])}}}},_manipulate:function(m){var i=new b(m.clientX,m.clientY);var k=m.width?i:this._translateToViewerPosition(i);if(k&&m.button===0&&this.draw===true){this.viewerPoints.push(k);var l=this._translateToCanvasPosition(i);if(l){this.canvasContext.lineTo(l.x,l.y);this.canvasContext.stroke();this.canvasContext.beginPath();this.canvasContext.moveTo(l.x,l.y);if(this.exp&&this.exp.collabMode===true){var j=m.srcElement.getBoundingClientRect();this.exp.notifyScriptingFunction("annot2DManipulate",[{clientX:k.x,clientY:k.y,width:j.width,height:j.height,button:0}])}}}},_endManipulate:function(j){if(this.draw&&this.gesture==false){this.strokeCompleteCB(this.viewerPoints,this.currentSheet,this.sheetViewer);this.canvasContext.clearRect(0,0,this.canvas.width,this.canvas.height);if(this.exp&&this.exp.collabMode===true){var i=j.srcElement.getBoundingClientRect();this.exp.notifyScriptingFunction("annot2DEndManipulate",[])}}this.draw=false;this.gesture=false},_activateManipulators:function(){this.onPinch=function(l){if(l.state==="begin"){console.log("pinch is started");h.gesture=true}};var k=function(l,m){if(this.draw&&this.canvasContext){this.draw=false;this.canvasContext.clearRect(0,0,this.canvas.width,this.canvas.height);this._destroyCanvas()}if(m){this.sheetViewer=m.cellModel.getSheetViewer();this.currentSheet=m.cellID;this._createCanvas();this._beginManipulate(l)}}.bind(this);var i=function(l,m){if(this.gesture==true){this.draw=false}if(m&&!this.draw){this.sheetViewer=m.cellModel.getSheetViewer();this.currentSheet=m.cellID}this._manipulate(l)}.bind(this);var j=function(l,m){this._endManipulate(l);this._destroyCanvas()}.bind(this);this.pointerOut=function(l){if(l.button==0&&h.draw&&h.canvasContext){console.log("Outside the border");h.draw=false;h.canvasContext.clearRect(0,0,h.canvas.width,h.canvas.height);h.viewerPoints=[];if(h.cursorManager){h._setMouseCursor("auto")}}};this._mouseoutListner=this.viewer.sheetCollection.addEventListener("mouseout",this.pointerOut,true);this._touchcancelListner=this.viewer.sheetCollection.addEventListener("touchcancel",this.pointerOut,true);a.addEvent(document,"onPinch",this.onPinch);this._onMouseDownCB=this.viewer.sheetCollection.addEventListener(f.POINTERDOWN,k,true);this._onMouseMoveCB=this.viewer.sheetCollection.addEventListener(f.POINTERMOVE,i,true);this._onMouseUpCB=this.viewer.sheetCollection.addEventListener(f.POINTERUP,j,true)},_disableManipulators:function(){this.viewer.sheetCollection.removeEventListener(f.POINTERDOWN,this._onMouseDownCB,true);this.viewer.sheetCollection.removeEventListener(f.POINTERMOVE,this._onMouseMoveCB,true);this.viewer.sheetCollection.removeEventListener(f.POINTERUP,this._onMouseUpCB,true);this.viewer.sheetCollection.removeEventListener("mouseout",this._mouseoutListner,true);this.viewer.sheetCollection.removeEventListener("touchcancel",this._touchcancelListner,true);a.removeEvent(document,"onPinch",this.onPinch);this._onMouseDownCB=undefined;this._onMouseMoveCB=undefined;this._onMouseUpCB=undefined}}))});define("DS/3DPlayAnnotation2D/Annotation2DEraseHandle",["UWA/Class","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/Core/PointerEvents","DS/WebappsUtils/WebappsUtils","DS/WebUtils/Vector2"],function(b,d,c,f,a){var g;return(b.extend({init:function(h){this._parent(h);g=this;this.viewer=h.viewer;this.hideUICB=h.hideUICB;this.drag=false;this.viewerPoints=[];this.exp=h.exp;this.exp&&this.exp.registerCollabAction&&this.exp.registerCollabAction("annot2DErase",this._eraseRep.bind(this))},begin:function(h){this.container=this.viewer.sheetCollection.getContent();this.currentSheet=this.viewer.currentSheet;this.sheetViewer=this.viewer.sheetCollection.getCellInfosAt(this.currentSheet).cellModel.getSheetViewer();this.updateSheetThumbnail=function(){this.viewer._updateSheetThumbnail(this.currentSheet)}.bind(this);this._activateManipulators()},end:function(h){this._setMouseErase(false);this._disableManipulators();this.container=undefined;this.currentSheet=undefined;this.sheetViewer=undefined},destroy:function(){this.hideUICB=undefined;this.viewer=undefined;g=undefined},_setMouseErase:function(h){if(h){var i="url("+f.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_AnnotationRubber.png), auto";this.container.style.setProperty("cursor",i)}else{this.container.style.setProperty("cursor","auto")}},_eraseRep:function(){if(this.startPoint&&this.endPoint){var h=this.sheetViewer.getIntersectingShapes({startPoint:this.startPoint,endPoint:this.endPoint});if(h.length>0){this.sheetViewer.drawShape({idList:h,lowLightMode:true});this.sheetViewer.destroyShape({idList:h});if(g.exp&&g.exp.collabMode===true){g.exp.notifyAction&&g.exp.notifyAction("annot2DErase",[h])}}}},isPointerInAnnotationDrawingSpace:function(i){if(this.sheetViewer){var k=this.sheetViewer.canvas.getBoundingClientRect();var j=(i.x>=k.left&&i.x<=k.left+k.width);var h=(i.y>=k.top&&i.y<=k.top+k.height);return(j&&h)}},_translateToViewerPosition:function(i){var j=this.sheetViewer.canvas.getBoundingClientRect();if(this.isPointerInAnnotationDrawingSpace(i)){var k=this.sheetViewer.getScale();var h=(i.x-j.left)/k;var l=(i.y-j.top)/k;return new a(h,l)}else{return false}},_beginManipulate:function(j){this.viewerPoints=[];var h={x:j.clientX,y:j.clientY};var i=this._translateToViewerPosition(h);if(j.button===0&&i){this._setMouseErase(true);this.viewerPoints.push(i);this.startPoint=i;this.endPoint=null;this.drag=true;this.hideUICB()}},_manipulate:function(j){var h={x:j.clientX,y:j.clientY};var i=this._translateToViewerPosition(h);if(i&&j.button==0&&this.drag===true){this._setMouseErase(true);this.viewerPoints.push(i);if(this.endPoint!=null){this.startPoint=this.endPoint}this.endPoint=i;this._eraseRep()}},_endManipulate:function(j){var h={x:j.clientX,y:j.clientY};var i=this._translateToViewerPosition(h);this._setMouseErase(false);if(i){this.viewerPoints.push(i);if(this.endPoint!=null){this.startPoint=this.endPoint}this.endPoint=i}this._eraseRep();this.sheetViewer.scaleAndRender(this.updateSheetThumbnail);this.startPoint=undefined;this.endPoint=undefined;this.drag=false},_activateManipulators:function(){var j=function(k,l){if(l){this.sheetViewer=l.cellModel.getSheetViewer();this.currentSheet=l.cellID;this._beginManipulate(k)}}.bind(this);var h=function(k,l){if(l&&!this.drag){this.sheetViewer=l.cellModel.getSheetViewer();this.currentSheet=l.cellID}this._manipulate(k)}.bind(this);var i=function(k,l){this._endManipulate(k)}.bind(this);this._onMouseDownCB=this.viewer.sheetCollection.addEventListener(c.POINTERDOWN,j,true);this._onMouseMoveCB=this.viewer.sheetCollection.addEventListener(c.POINTERMOVE,h,true);this._onMouseUpCB=this.viewer.sheetCollection.addEventListener(c.POINTERUP,i,true)},_disableManipulators:function(){this.viewer.sheetCollection.removeEventListener(c.POINTERDOWN,this._onMouseDownCB,true);this.viewer.sheetCollection.removeEventListener(c.POINTERMOVE,this._onMouseMoveCB,true);this.viewer.sheetCollection.removeEventListener(c.POINTERUP,this._onMouseUpCB,true);this._onMouseDownCB=undefined;this._onMouseMoveCB=undefined;this._onMouseUpCB=undefined}}))});define("DS/3DPlayAnnotation2D/Annotation2DDraw",["DS/3DPlayAnnotation2D/Annotation2DCommand","DS/3DPlayAnnotation2D/Annotation2DDrawPreview","DS/3DPlayAnnotationUtils/ShapeUtils","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/CoreEvents/Events"],function(d,c,f,b,a){var g;return(d.extend({init:function(h){this._parent(h);g=this;this.drawSettings=new b()},begin:function(h){this._parent(h);this._createPreview();this.tokenSheetChange=a.subscribe({event:"Sheet/ChangeCompleted"},function(i){g._onSheetChange(i)});this.tokenZoom=a.subscribe({event:"3DPlay.2D.Zoom.Completed"},function(i){g._onResize(i)})},end:function(h){a.unsubscribe(this.tokenSheetChange);a.unsubscribe(this.tokenZoom);this._destroyPreview();this._parent(h)},destroy:function(){this.drawSettings=undefined;this._parent();g=undefined},_onSheetChange:function(h){this._destroyPreview();this._createPreview()},_onResize:function(h){this._destroyPreview();this._createPreview()},_strokeComplete:function(u,q,t){var o=this.frameWindow.getViewer();var h=t;if(u.length<=3){console.log("Not enough points to recoginize the shape")}else{var k=f.shapeEval(u).shape;if(k.type=="arrowhead"){var m=h.getShapeList();var w=k.data.vertices;var n=false;var i=0;for(var j in m){var p=m[j];if(p.linkID.length<2){var s=false;if(p.type=="line"){s=f.isArrow2D(p,w)}else{if(p.type=="unknownOpen"){s=f.isCurvedArrow2D(p,w)}}if(s){if(((p.linkID.length==0)||((p.linkID.length==1)&&(p.linkID[0].pointID!=s.pointID)))&&(n===false||s.distance<i)){i=s.distance;n={shape:p,pointEndID:s.pointEndID,pointID:s.pointID}}}}}if(n){k.connectionData=n}}var v=h.createShape({shapeData:k,settings:this.drawSettings});var r=v.lastPosition;r={x:r.x/h.currentWidth,y:r.y/h.currentHeight};this.drawSettings.setLastPosition(r);var l=h.getShapeList();o.sheets[q].annotations=l;o._updateSheetThumbnail(q)}},_createPreview:function(){var h=this.frameWindow.getViewer();this.drawPreview=new c({viewer:h,frameWindow:this.frameWindow,hideUICB:function(){g.hideUI()},strokeCompleteCB:function(k,i,j){g._strokeComplete(k,i,j)}});this.drawPreview.begin()},_destroyPreview:function(){if(this.drawPreview){this.drawPreview.end();this.drawPreview.destroy();this.drawPreview=undefined}}}))});define("DS/3DPlayAnnotation2D/Annotation2DText",["UWA/Core","DS/3DPlayAnnotation2D/Annotation2DCommand","DS/3DPlayAnnotationUtils/AnnotationTextControl2D","DS/CoreEvents/Events","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/WebUtils/GeometryUtils","DS/3DPlayAnnotationUtils/AnnotationTextPreview2D","DS/Core/PointerEvents"],function(c,g,d,j,b,a,i,f){var h;return(g.extend({init:function(k){h=this;h._parent(k);h.drawSettings=new b();h._exp=k.frameWindow.experience;if(h._exp&&this._exp.registerCollabAction){h._exp.registerCollabAction("annotTextEnd",h.end.bind(h));h._exp.registerCollabAction("annotTextOnTap",h._onTap.bind(h))}},begin:function(k){h._parent(k);this.viewerFrame=this.frameWindow.getViewerFrame();this.viewer=this.frameWindow.getViewer();this.currentSheet=this.viewer.currentSheet;this.canvasViewer=this.viewer.sheetCollection.getCellInfosAt(this.viewer.currentSheet).cellModel.getSheetViewer();this._createPreview();this._createTextControl();this.textControl.disable();this.textControl.hideControls();this._onMouseMoveCB=this.viewer.sheetCollection.addEventListener(f.POINTERMOVE,function(l,m){if(m&&!h.textControl.isEnabled()){h.canvasViewer=m.cellModel.getSheetViewer();h.currentSheet=m.cellID;h.textPreview.setBoundingLimitsFromReferenceElement(h.canvasViewer.canvas)}},true);this._onMouseDownCB=this.viewer.sheetCollection.addEventListener(f.POINTERDOWN,function(l,m){if(l.target&&l.target.className&&l.target.className.includes("cancel")){}else{if(m){h.canvasViewer=m.cellModel.getSheetViewer();h._onTap(l)}h.textControl.setBoundingLimitsFromReferenceElement(h.canvasViewer.canvas)}},true);this.viewerFrame.addEventListener("resize",this._onWidgetResize);this.tokenSheetChange=j.subscribe({event:"Sheet/ChangeCompleted"},function(l){h.refresh()});this.tokenZoom=j.subscribe({event:"3DPlay.2D.Zoom.Completed"},function(l){h._onWidgetResize(l)})},end:function(k){this.viewerFrame.removeEventListener("resize",this._onWidgetResize);j.unsubscribe(this.tokenSheetChange);this.tokenSheetChange=undefined;j.unsubscribe(this.tokenZoom);this.tokenZoom=undefined;this._destroyPreview();this._destroyTextControl();this.viewer.sheetCollection.removeEventListener(f.POINTERMOVE,this._onMouseMoveCB,true);this._onMouseMoveCB=undefined;this.viewer.sheetCollection.removeEventListener(f.POINTERDOWN,this._onMouseDownCB,true);this._onMouseDownCB=undefined;this.canvasViewer=undefined;this.viewerFrame=undefined;this.viewer=undefined;this._parent(k)},destroy:function(){this._parent();this.drawSettings=undefined;h=undefined},_onWidgetResize:function(){setTimeout(function(){var k=h.textControl.getFieldText();h.refresh();h.textPreview.setBoundingLimitsFromReferenceElement(h.canvasViewer.canvas);h.textControl.setBoundingLimitsFromReferenceElement(h.canvasViewer.canvas);if(k){h.textPreview.hidePreview();h.textPreview.disable();h.textControl.enable();h.textControl.showControls();h.textControl.setFieldText(k)}},100)},_onTap:function(k){var n=k.clientX?k.clientX:k.x;var m=k.clientY?k.clientY:k.y;if(k.originalEvent&&k.originalEvent.type&&k.originalEvent.type==="touchstart"){if(!h.textPreview.isEnabled()){var l=h.textControl.getFieldText();if(l){h.textControl.validate()}}if(h._exp&&h._exp.collabMode===false){h.textControl.elements.textField.setAttributes({readonly:"readonly"});h.textPreview.container.setAttributes({visibility:"hidden"})}h.textPreview.hidePreview();h.textPreview.disable();h.textControl.enable();h.textControl.showControls(n,m);if(h._exp&&h._exp.collabMode===true&&this._exp.notifyAction){this._exp.notifyAction("annotTextOnTap",[{which:k.which,x:k.x,y:k.y}])}}else{if(k.which===1){if(h.textPreview.isEnabled()){if(h.textPreview.isVisible){h.textPreview.hidePreview();h.textPreview.disable()}if(h.textControl.canBeCreatedAtPosition(n,m)){h.textControl.enable();h.textControl.showControls(n,m);if(h._exp&&h._exp.collabMode===true&&this._exp.notifyAction){this._exp.notifyAction("annotTextOnTap",[{which:k.which,x:k.x,y:k.y}])}}}else{var l=h.textControl.getFieldText();if(l){h.textControl.validate()}else{if(h.textControl.canBeCreatedAtPosition(n,m)){h.textControl.enable();h.textControl.showControls(n,m)}}}if(h._exp&&h._exp.collabMode===false){h.textControl.elements.textField.setAttributes({readonly:"readonly"});h.textPreview.container.setAttributes({visibility:"hidden"})}}}},refresh:function(){this._destroyPreview();this._destroyTextControl();this._createPreview();this._createTextControl();this.textControl.disable();this.textControl.hideControls()},_onValidate:function(k){this._createAnnotation(k);this.textControl.clearTextField();this.textControl.hideControls();this.textControl.container.style.cursor="pointer";this.textPreview.enable()},_createAnnotation:function(p){var r=this;var s=""+(parseInt(this.drawSettings.getThickness())-3)*100;var l=""+(p.fontSize*p.scale)+'px "3ds"';var u=a.wrapText({text:p.text,width:p.w,height:p.h,font:s+" "+l});var w=this.canvasViewer.canvas.getBoundingClientRect();var n=this.canvasViewer.getScale();var q=(p.x-w.left)/n;var o=(p.y-w.top)/n;var k={type:"text",text:u.wrappedLines,point:{x:q,y:o},height:p.h/this.canvasViewer.scale,width:p.w/this.canvasViewer.scale,offsetHeight:p.offsetHeight/this.canvasViewer.scale,fontSize:p.fontSize*p.scale/this.canvasViewer.scale,fontWeight:s,controlScale:p.scale};var v=this.canvasViewer.createShape({shapeData:k,settings:this.drawSettings});var t=v.lastPosition;t={x:t.x/this.canvasViewer.currentWidth,y:t.y/this.canvasViewer.currentHeight};this.drawSettings.setLastPosition(t);var m=this.canvasViewer.getShapeList();this.viewer.sheets[this.currentSheet].annotations=m;this.viewer._updateSheetThumbnail(this.currentSheet)},_createTextControl:function(){this.textControl=new d({container:this.viewer.sheetCollection.getContent(),onOk:function(l){h._onValidate(l);h.textControl.disable();h.textControl.hideControls();h.textPreview.enable();h.textPreview.showPreview(l)},onCancel:function(){h.textControl.clearTextField()},onTypeStartCB:function(l){h.hideUI()}});this.textControl.setBoundingLimitsFromReferenceElement(h.canvasViewer.canvas);this.textControl.updateDimensions();var k=this.drawSettings.getLastPosition();k.x*=this.canvasViewer.currentWidth;k.y*=this.canvasViewer.currentHeight;k.x/=this.canvasViewer.scale;k.y/=this.canvasViewer.scale;k=this.canvasViewer.getMousePositionFromViewer(k);if(k){this.textControl.showControls(k.x,k.y)}},_createPreview:function(){this.textPreview=new i({container:this.viewer.sheetCollection.getContent()});this.textPreview.setBoundingLimitsFromReferenceElement(this.canvasViewer.canvas);this.textPreview.enable();this.textPreview.hidePreview()},_destroyPreview:function(){if(this.textPreview){this.textPreview.destroy();this.textPreview=undefined}},_destroyTextControl:function(){if(this.textControl){this.textControl.destroy();this.textControl=undefined}}}))});define("DS/3DPlayAnnotation2D/Annotation2DErase",["DS/3DPlayAnnotation2D/Annotation2DCommand","DS/3DPlayAnnotation2D/Annotation2DEraseHandle","DS/CoreEvents/Events"],function(c,a,b){var d;return(c.extend({init:function(f){this._parent(f);d=this},begin:function(f){this._parent(f);this._createErase();this.tokenSheetChange=b.subscribe({event:"Sheet/ChangeCompleted"},function(g){d._onSheetChange(g)});this.tokenZoom=b.subscribe({event:"3DPlay.2D.Zoom.Completed"},function(g){d._onResize(g)})},end:function(f){b.unsubscribe(this.tokenSheetChange);b.unsubscribe(this.tokenZoom);this._destroyErase();this._parent(f)},destroy:function(){this._parent();d=undefined},_onSheetChange:function(f){this._destroyErase();this._createErase()},_onResize:function(f){this._destroyErase();this._createErase()},_createErase:function(){var f=this.frameWindow.getViewer();this.eraseHandle=new a({viewer:f,hideUICB:function(){d.hideUI()},exp:this.frameWindow.experience});this.eraseHandle.begin()},_destroyErase:function(){if(this.eraseHandle){this.eraseHandle.end();this.eraseHandle.destroy();this.eraseHandle=undefined}}}))});define("DS/3DPlayAnnotation2D/AnnotationCommands",["DS/ApplicationFrame/Command","DS/WebInfraUI/ContextualBarManager","DS/3DPlayAnnotationUtils/AnnotationToolsMenu","DS/3DPlayAnnotation2D/Annotation2DDraw","DS/3DPlayAnnotation2D/Annotation2DErase","DS/3DPlayAnnotation2D/Annotation2DText","DS/CoreEvents/Events","DS/WebSystem/Environment"],function(a,b,c,f,g,i,j,h){var d;return(a.extend({init:function(k){this._parent(k,{isAsynchronous:true,mode:"exclusive"});d=this;this._exp=this.getFrameWindow().experience;if(this._exp){this._exp.registerCollabAction("annot2DBeginExecute",this.beginExecute.bind(this));this._exp.registerCollabAction("annot2DExecute",this.execute.bind(this));this._exp.registerCollabAction("annot2DEndExecute",this.endExecute.bind(this));this._exp.registerCollabAction("annot2DStartCommand",this._startCommand.bind(this))}if(h.isSet("3DPlay.OldAnnotMenu")){this.newToolsUI=false}else{this.newToolsUI=true}},beginExecute:function(){var m=this;this.frameWindow=this.getFrameWindow();this.viewer=this.frameWindow.getViewer();this.viewer._detachUserEvents();this.Draw2D=new f({frameWindow:this.frameWindow,hideTools:function(){m._removeTools()}});this.Erase2D=new g({frameWindow:this.frameWindow,hideTools:function(){m._removeTools()}});this.Text2D=new i({frameWindow:this.frameWindow,hideTools:function(){m._removeTools()}});this._preventTouchStartAction=this.viewer.sheetCollection.addEventListener("touchstart",function(n){if(n.preventDefault){n.preventDefault()}else{n.returnValue=false}},true);this._preventTouchMoveAction=this.viewer.sheetCollection.addEventListener("touchmove",function(n){if(n.preventDefault){n.preventDefault()}else{n.returnValue=false}},true);this._preventTouchEndAction=this.viewer.sheetCollection.addEventListener("touchend",function(n){if(n.preventDefault){n.preventDefault()}else{n.returnValue=false}},true);this.tokenSheetChange=j.subscribe({event:"Sheet/ChangeCompleted"},function(n){m._removeTools(n)});this.leftPanelSheetChange=j.subscribe({event:"3DPlay/2DLeftPanel/SheetChange"},function(n){m.end()});var l=this.frameWindow.getActionBar();l.close();var k=l.onActionBarOpen(function(){l.removeCallback(k);m.end()});if(m._exp&&m._exp.notifyAction&&m._exp.collabMode===true){m._exp.notifyAction("annot2DBeginExecute")}this.MBAShow=j.subscribe({event:"3DPlay.MAB.Show"},function(){m._exitAnnot()});this.MBAHide=j.subscribe({event:"3DPlay.MAB.Hide"},function(){m._exitAnnot()});this.frameWindow.getViewerFrame().addEvent("resize",this._onWidgetResize)},execute:function(){var k=this;this._buildUI();if(k._exp&&k._exp.collabMode===true&&k._exp.notifyAction){k._exp.notifyAction("annot2DExecute")}},endExecute:function(){j.unsubscribe(this.tokenSheetChange);j.unsubscribe(this.MBAShow);j.unsubscribe(this.MBAHide);this.frameWindow.getViewerFrame().addEvent("resize",this._onWidgetResize);this._endCommands();this.viewer.sheetCollection.removeEventListener("touchstart",this._preventTouchStartAction,true);this.viewer.sheetCollection.removeEventListener("touchmove",this._preventTouchMoveAction,true);this.viewer.sheetCollection.removeEventListener("touchend",this._preventTouchEndAction,true);this._preventTouchStartAction=undefined;this._preventTouchMoveAction=undefined;this._preventTouchEndAction=undefined;this.viewer._attachUserEvents();if(this.annotationToolsMenu){this.annotationToolsMenu.dispose();this.annotationToolsMenu=undefined}if(this.contextualMenu&&this.contextualMenuToken){this.contextualMenu.removeButtons(this.contextualMenuToken);this.contextualMenu.dispose();this.contextualMenuToken=undefined;this.contextualMenu=undefined}if(this.Draw2D){this.Draw2D.destroy();this.Draw2D=undefined}if(this.Erase2D){this.Erase2D.destroy();this.Erase2D=undefined}if(this.Text2D){this.Text2D.destroy();this.Text2D=undefined}this.frameWindow.getActionBar().open();this.viewer=undefined;this.frameWindow=undefined;if(this._exp&&this._exp.collabMode===true&&this._exp.notifyAction){this._exp.notifyAction("annot2DEndExecute")}},_endCommands:function(){if(this.annotationToolsMenu&&this.annotationToolsMenu.colorPaletteVisible){this._hideColorPalette()}if(this.Draw2D&&this.Draw2D.isRunning()){this.Draw2D.end()}if(this.Erase2D&&this.Erase2D.isRunning()){this.Erase2D.end()}if(this.Text2D&&this.Text2D.isRunning()){this.Text2D.end()}},_startCommand:function(k){if(this.newToolsUI){this._newMenuStartCommand(k)}else{this._oldMenuStartCommand(k)}},_newMenuStartCommand:function(k){this._hideColorPalette();if(k.id==="2DDrawing"){this.Draw2D.begin()}else{if(k.id==="2DErase"){this.Erase2D.begin()}else{if(k.id==="2DText"){this.Text2D.begin()}}}if(this._exp&&this._exp.collabMode===true&&this._exp.notifyAction){this._exp.notifyAction("annot2DStartCommand",[k])}},_oldMenuStartCommand:function(k){d._endCommands();d.annotationToolsMenu.removeToolsButton();if(k.id==="2DDrawing"){d.Draw2D.begin();d.annotationToolsMenu.addToolsButton()}if(k.id==="2DErase"){d.Erase2D.begin();d.annotationToolsMenu.removeToolsButton()}if(k.id==="2DText"){d.Text2D.begin();d.annotationToolsMenu.addToolsButton()}if(this._exp&&this._exp.collabMode===true&&this._exp.notifyAction){this._exp.notifyAction("annot2DStartCommand",[k])}},_buildUI:function(){var n=this;this.contextualMenu=new b({frameWindow:this.frameWindow});var m=this.frameWindow.getActionBar();var l;if((m.MAB&&m.MAB.state.visible===true)){l=[{id:"2DDrawing",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",selected:true},{id:"2DErase",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation"}]}else{l=[{id:"2DDrawing",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",selected:true},{id:"2DText",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation"},{id:"2DErase",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation"}]}var k=[{type:this.contextualMenu.Button.Radio,content:l,onclickCB:function(o){n._endCommands();if(!n.newToolsUI){n.annotationToolsMenu.removeToolsButton()}n._startCommand(o)}},{type:this.contextualMenu.Button.Master,id:"ExitAnnotation",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",onclickCB:function(){n._exitAnnot()}}];this.contextualMenuToken=this.contextualMenu.addButtons(k,{barType:this.contextualMenu.Toolbar.New,showContextBarBackground:true});this.annotationToolsMenu=new c({contextualMenu:this.contextualMenu,frameWindow:this.frameWindow,newToolsUI:this.newToolsUI});this.annotationToolsMenu.addToolsButton();if(this.newToolsUI){this.contextualMenu.panel.container.style.cursor="pointer";this._hideColorPalette()}this.Draw2D.begin()},_removeTools:function(){if(this.newToolsUI){this._hideColorPalette()}else{if(this.annotationToolsMenu){this.annotationToolsMenu.removeTools()}}},_hideColorPalette:function(k){if(this.annotationToolsMenu&&this.annotationToolsMenu.hideColorPalette){this.annotationToolsMenu.hideColorPalette()}},_onWidgetResize:function(){d._exitAnnot()},_exitAnnot:function(){if(d&&d.frameWindow){d.frameWindow.getActionBar().open()}}}))});