define("DS/SUI/ARNodeManager",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/WebappsUtils/WebappsUtils","DS/Visualization/SceneGraphFactory"],function(f,b,d,c,a){var e=f.Class.extend({init:function(g){this._planeBag=new d();g.addNode(this._planeBag);this._imageBag=new d();g.addNode(this._imageBag);this._pointBag=new d();g.addNode(this._pointBag)},addPlane:function(h){var j=h.anchor.getName();var g=new d(j);this._planeBag.addChild(g);g.setMatrix(h.anchor.getVirtualGlobalMatrix());var i=new d(j+"_center");this._planeBag.addChild(i);i.setMatrix(h.center.getVirtualGlobalMatrix())},getAnchorPlaneNode:function(g){return this._planeBag.getChildByName(g)},getCenterPlaneNode:function(g){return this._planeBag.getChildByName(g+"_center")},updatePlane:function(g){var i=this.getAnchorPlaneNode(g.anchor.getName());if(i){i.setMatrix(g.anchor.getVirtualGlobalMatrix())}var h=this.getCenterPlaneNode(g.anchor.getName());if(h){h.setMatrix(g.center.getVirtualGlobalMatrix())}},removePlane:function(i){var h=this.getAnchorPlaneNode(i);this._planeBag.removeChild(h);var g=this.getCenterPlaneNode(i);this._planeBag.removeChild(g)},addImage:function(g){var i=g.anchor.getName();var h=new d(i);this._imageBag.addChild(h);h.setMatrix(g.anchor.getVirtualGlobalMatrix())},getAnchorImageNode:function(g){return this._imageBag.getChildByName(g)},updateImage:function(g){var h=this.getAnchorImageNode(g.anchor.getName());if(h){h.setMatrix(g.anchor.getVirtualGlobalMatrix())}},removeImage:function(h){var g=this.getAnchorImageNode(h);this._imageBag.removeChild(g)},addPoint:function(h){var i=h.getName();var g=new d(i);this._pointBag.addChild(g);g.setMatrix(h.getVirtualGlobalMatrix())},getAnchorPointNode:function(g){return this._pointBag.getChildByName(g)},updatePoint:function(h){var g=this.getAnchorPointNode(h.getName());if(g){g.setMatrix(h.getVirtualGlobalMatrix())}},changePointIdentifier:function(g,i){var h=this.getAnchorPointNode(g);h.setName(i)},removeAnchorPoint:function(h){var g=this.getAnchorPointNode(h);this._pointBag.removeChild(g)}});return e});define("DS/SUI/Context",["UWA/Core","DS/Visualization/ThreeJS_DS"],function(c,b){var a=c.Class.extend({init:function(){this.users=[];this._position=new b.Vector3();this._orientation=new b.Quaternion();this._scale=new b.Vector3(1,1,1)},getName:function(){return"context"},getMatrix:function(){return new b.Matrix4().compose(this._position,this._orientation,this._scale)},getUser:function(d){var d=d||0;return this.users[d]},getPosition:function(){return new b.Vector3().copy(this._position)},getOrientation:function(){return new b.Quaternion().copy(this._orientation)},getScale:function(){return new b.Vector3().copy(this._scale)},setPosition:function(d){this._position.copy(d)},setPositionX:function(d){this._position.x=d},setPositionY:function(d){this._position.y=d},setPositionZ:function(d){this._position.z=d},setOrientation:function(d){this._orientation.copy(d)},setScale:function(d){if(d<=0){return}this._scale.set(d,d,d)},translate:function(d){this._position.add(d)},multiplyQuaternion:function(d){this._orientation.multiply(d)}});return a});define("DS/SUI/Element",["UWA/Core","DS/Visualization/ThreeJS_DS"],function(c,b){var a=c.Class.extend({init:function(d,e){this._name=d;this._suiParent=e;this._position=new b.Vector3();this._orientation=new b.Quaternion();this._scale=new b.Vector3(1,1,1);this._virtualMapping=new b.Matrix4()},getName:function(){return this._name},getParent:function(){return this._suiParent},getPosition:function(){return new b.Vector3().copy(this._position)},getOrientation:function(){return new b.Quaternion().copy(this._orientation)},getScale:function(){return new b.Vector3().copy(this._scale)},getVirtualMapping:function(){return new b.Matrix4().copy(this._virtualMapping)},getPhysicalLocalMatrix:function(){return new b.Matrix4().compose(this._position,this._orientation,this._scale)},getPhysicalGlobalMatrix:function(){var d=new b.Matrix4();if("getPhysicalGlobalMatrix" in this._suiParent){var e=this.getPhysicalLocalMatrix();var f=this._suiParent.getPhysicalGlobalMatrix();d.multiplyMatrices(f,e)}return d},getVirtualGlobalMatrix:function(){var e=new b.Matrix4();if("getVirtualGlobalMatrix" in this._suiParent){var d=this.getPhysicalLocalMatrix();var g=this._virtualMapping;e.multiplyMatrices(g,d);var f=this._suiParent.getVirtualGlobalMatrix();e.multiplyMatrices(f,e)}else{if((this._suiParent.getName()==="context")&&"getMatrix" in this._suiParent){var d=this.getPhysicalLocalMatrix();e.multiplyMatrices(this._suiParent.getMatrix(),d)}}return e},setParent:function(d){if(this===d){throw new Error("cannot set parent to self")}if(this._suiParent===d){return}this._suiParent=d},setName:function(d){if(d===""){return}this._name=d},setPosition:function(d){this._position.copy(d)},setPositionX:function(d){this._position.x=d},setPositionY:function(d){this._position.y=d},setPositionZ:function(d){this._position.z=d},setOrientation:function(d){this._orientation.copy(d)}});return a});define("DS/SUI/SUIFactory",["UWA/Core","DS/SUI/Context","DS/SUI/Element","DS/Visualization/ThreeJS_DS"],function(e,b,a,d){var c=e.Class.singleton({createSUIModel:function(m){var i=new b();i.environment=new a("environment",i);var g=new a("user",i);g.head=new a("head",g);if(m){var h=g.head;h.centerEye=new a("centerEye",h);h.leftEye=new a("leftEye",h);h.rightEye=new a("rightEye",h);var k=new d.Vector3(-32,0,0);var j=m.getEyeParameters("left");if(j){k.x=j.offset[0]*1000;k.y=j.offset[1]*1000;k.z=j.offset[2]*1000}h.leftEye.setPosition(k);var l=new d.Vector3(32,0,0);var f=m.getEyeParameters("right");if(f){l.x=f.offset[0]*1000;l.y=f.offset[1]*1000;l.z=f.offset[2]*1000}h.rightEye.setPosition(l);h.ipd=l.x-k.x;g.rightHand=new a("rightHand",g);g.leftHand=new a("leftHand",g)}i.users.push(g);return i},createPlane:function(h,n){if(!h.planeBag){h.planeBag={}}var j=h.planeBag;var q=new a(n.identifier,h);var r=n.alignement;var k=new a(n.identifier+"_center",q);var g=new d.Vector3();var t=n.boundaryVertexCount;var p=new Array();var f=new Array();var o=n.vertexCount;var m=new Array();var i=n.triangleCount;var s=new Array();var l=n.textureCoordinateCount;n.vertices&&n.vertexCount&&n.triangleCount&&n.triangleIndices&&n.textureCoordinateCount&&n.textureCoordinates;j[n.identifier]={anchor:q,alignement:r,center:k,extent:g,boundaryVertexCount:t,boundaryVertices:p,vertices:f,vertexCount:o,triangleIndices:m,triangleCount:i,textureCoordinates:s,textureCoordinateCount:l}},createImageAnchor:function(f,h){if(!f.imageBag){f.imageBag={}}var g=f.imageBag;g[h.identifier]={anchor:new a(h.identifier,f),imageName:h.name,physicalWidth:h.imageWidth,physicalHeight:h.imageHeight}},createPointAnchor:function(g,f){if(!g.pointBag){g.pointBag={}}var h=g.pointBag;h[f.identifier]=new a(f.identifier,g)}});return c});define("DS/SUI/ARScenario",["UWA/Core","DS/SUI/SUIFactory","DS/SUI/Element","DS/SUI/ARNodeManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/Visualization/Node3D","DS/WebappsUtils/WebappsUtils","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/HybridInfraCore/HybridApp","DS/CoreEvents/Events"],function(e,m,a,j,l,h,g,c,k,d,i,b){var f=e.Class.extend({init:function(p){if(p.transparentCSS){var t=document.getElementsByClassName("windowed-view");var r=document.getElementsByClassName("wux-afr-framewindow");if(t.length>=2&&r.length>=1){t[0].style="background-color: transparent;";t[1].style="background-color: transparent;";r[0].style="background: transparent;"}}this._odt=p.odt||false;this._viewer=p.viewer;this._optionSaved={};this._nodeManager=new j(this._viewer);this._context=null;this._trackingViewpoint=null;this._onSessionStateChanged=null;this._onViewpointUpdated=null;this._onPlaneAdded=null;this._onPlaneUpdated=null;this._onPlaneRemoved=null;this._onImageAdded=null;this._onImageUpdated=null;this._onImageRemoved=null;this._onAnchorAdded=null;this._onAnchorUpdated=null;this._onAnchorRemoved=null;this._onReceiveHitTestResult=null;this._onReceiveCenterHitTestResult=null;this._onReceiveWorldMap=null;this._videoRatio=16/9;this.anchorsIdCounter_=0;this._drawPlanes=false;this._drawPlaneBoundaries=false;this._drawPlaneMeshes=false;if(p.drawPlanes){this._drawPlanes=!!p.drawPlanes.planes;this._drawPlaneBoundaries=!!p.drawPlanes.boundaries;this._drawPlaneMeshes=!!p.drawPlanes.mesh}this._cloudPoints={};this._showPointCloud=false;window.ARNativeDelegate=null;if(p.detectPlane){var q=p.detectPlane;if(q.activated){this._detectionMode={Horizontal:q.horizontal,Vertical:q.vertical,BoundaryMesh:q.boundary,Mesh:q.mesh}}else{this._detectionMode={Horizontal:false,Vertical:false,BoundaryMesh:false,Mesh:false}}}else{this._detectionMode={Horizontal:true,Vertical:true,BoundaryMesh:false,Mesh:false}}this._detectionImageData={external:false,imagesPath:""};if(p.imageData){var o=p.imageData.external&&p.imageData.imagesArray;o=o||(!p.imageData.external&&p.imageData.imagesPath);if(o){this._detectionImageData=p.imageData}}this.onPostRenderToken=null;this.planeMaterial=new l.MeshPhongMaterial({color:"red"});this.planeMaterial.line=new l.LineBasicMaterial({color:0,linewidth:2,opacity:1});this.planeMaterial.side=l.DoubleSide;this.planeMaterial.depthWrite=true;this.planeMaterial.opacity=0.05;this.planeMaterial.transparent=true;this.planeMaterial.force=true;this.planeMaterial.receiveShadow=true;this.planeMaterial.castShadow=false;this.boundaryMaterial=new l.LineBasicMaterial({color:"green",linewidth:25000,opacity:1,polygonBorderMode:true,linejoin:"miter"});var n=c.getWebappsAssetUrl("SUI","textures/WebPointCircle.png");var u=l.ImageUtils.loadTexture(n,undefined,undefined,undefined,true);this.pointCloudMaterial=new l.ParticleBasicMaterial({force:true,map:u,sizeAttenuation:false,size:50,blending:l.AdditiveBlending,depthTest:true,transparent:true,opacity:0.3});this._rotmX=new l.Matrix4().makeRotationAxis(new l.Vector3(1,0,0),-Math.PI/2);this._rotX=new l.Matrix4().makeRotationAxis(new l.Vector3(1,0,0),Math.PI/2);this.SUIHeadOrientation=new l.Quaternion();this.SUIHeadPosition=new l.Vector3();this.planeOrientation=new l.Quaternion();this.planePosition=new l.Vector3();this.planePositionCenter=new l.Vector3();this._loadWorldMap=false;this._worldMappingStatus="Not available";if(i&&i.isAndroid()){this._firstHitTestWarning=true}this.onReceivedJson=function(v){};var s=this;i.onDeviceReady(function(v){console.log("Local server is ready, with the following params : ",v);i.addDelegate("ARNativeDelegate").then(function(w){window.ARNativeDelegate=w;b.publish({event:"/AR/onScenarioReady",data:s})},console.error)});document.addEventListener("CONNECTION_INFO",function(v){console.log("CONNECTION_INFO",v.id)});document.addEventListener("APP_STATE_CHANGE",function(v){console.log("APP_STATE_CHANGE",v.id)});document.addEventListener("APP_SYSTEM_CALL",function(v){console.log("APP_SYSTEM_CALL",v.id)})},_configureSUI:function(){var p=this._viewer.currentViewpoint;this._context.setPosition(new l.Vector3(0,0,0));var o=new l.Quaternion().copy(p.getControl().orientation);var n=new l.Quaternion().setFromAxisAngle(new l.Vector3(1,0,0),-Math.PI/2);o.multiply(n);this._setContextUp(o)},_setContextUp:function(o){var p=new l.Vector3(0,0,1).applyQuaternion(o);var q=new l.Vector3(0,0,1);var r=q.angleTo(p);if(r!==0){var s=new l.Vector3().crossVectors(q,p).normalize();var n=new l.Quaternion().setFromAxisAngle(s,-r);n.multiply(o);this._context.setOrientation(n)}else{this._context.setOrientation(o)}},_saveViewerOptions:function(){this._optionSaved.backgroundColor=this._viewer.ambience.getBackgroundColor();this._optionSaved.displayPoints=this._viewer.renderer.renderPoints;this._optionSaved.viewpoint=this._viewer.currentViewpoint;this._optionSaved.grid=this._viewer.getGrid()},_restoreViewerOptions:function(){this._viewer.ambience.setBackgroundColor(this._optionSaved.backgroundColor);this._viewer.setBackgroundColor(this._optionSaved.backgroundColor,"1");this._viewer.displayPoints(this._optionSaved.displayPoints);this._viewer.currentViewpoint=this._optionSaved.viewpoint;this._viewer.setGrid(this._optionSaved.grid)},_configureViewer:function(){this._saveViewerOptions();this._viewer.setBackgroundColor("rgb(0,0,0)","0");this._trackingViewpoint=new h({viewer:this._viewer});this._trackingViewpoint.near=10;this._trackingViewpoint.far=100000;this._viewer.currentViewpoint=this._trackingViewpoint;var n=this._trackingViewpoint.getControl();var o={};o.viewpoint=false;n.setActive(o);if(!this._odt){this._viewer.defaultAnimationLoop=false}if(this.onPostRenderToken==null&&window.ARNativeDelegate!=null){this.onPostRenderToken=this._viewer.onPostRender(function(){window.ARNativeDelegate.sendJson({arDataSent:true})})}},_restoreViewer:function(){this._restoreViewerOptions();this._trackingViewpoint=null;this._viewer.defaultAnimationLoop=true;this._viewer._modelEvent.unsubscribe(this.onPostRenderToken);this.onPostRenderToken=null;var n=this._viewer.currentViewpoint.getControl();var o={};o.viewpoint=true;n.setActive(o);this._viewer.render({updateInfinitePlane:true});this._viewer.animate()},_updateSUIHead:function(n){this.SUIHeadOrientation.x=n.orientation[0];this.SUIHeadOrientation.y=n.orientation[1];this.SUIHeadOrientation.z=n.orientation[2];this.SUIHeadOrientation.w=n.orientation[3];this.SUIHeadPosition.x=n.position[0];this.SUIHeadPosition.y=n.position[1];this.SUIHeadPosition.z=n.position[2];this._context.getUser().head.setOrientation(this.SUIHeadOrientation);this._context.getUser().head.setPosition(this.SUIHeadPosition)},_updateTrackingViewpoint:function(p){if(undefined===this._trackingViewpoint){return}this._trackingViewpoint.camera.fov=p.fov;this._trackingViewpoint.camera.updateProjectionMatrix();var o=this._context.getUser().head;var n=o.getVirtualGlobalMatrix();n.multiply(this._rotX);var q=n.decompose();this._trackingViewpoint.moveTo({eyePosition:q[0],orientation:q[1]});this._videoRatio=p.videoRatio;if(!p.worldMappingStatus){return}switch(p.worldMappingStatus){case 0:this._worldMappingStatus="Not available";break;case 1:this._worldMappingStatus="Limited";break;case 2:this._worldMappingStatus="Extending";break;case 3:this._worldMappingStatus="Mapped";break}},_updatePlaneList:function(o){for(var p=0;p<o.length;++p){var n=o[p];var q;if(!this._context.planeBag||!(n.identifier in this._context.planeBag)){m.createPlane(this._context,n);q=this._updateSUIPlane(n);this._nodeManager.addPlane(q);if(this._drawPlanes||this._drawPlaneBoundaries||this._drawPlaneMeshes){this._updatePlaneModel(q)}if(this._onPlaneAdded){this._onPlaneAdded(q)}}else{q=this._updateSUIPlane(n);this._nodeManager.updatePlane(q);if(this._onPlaneUpdated){this._onPlaneUpdated(q)}}}},_updateSUIPlane:function(o){var q=this._context.planeBag[o.identifier];if(o.planeOrientation){this.planeOrientation.x=o.planeOrientation[0];this.planeOrientation.y=o.planeOrientation[1];this.planeOrientation.z=o.planeOrientation[2];this.planeOrientation.w=o.planeOrientation[3];q.anchor.setOrientation(this.planeOrientation)}if(o.planePosition){this.planePosition.x=o.planePosition[0];this.planePosition.y=o.planePosition[1];this.planePosition.z=o.planePosition[2];q.anchor.setPosition(this.planePosition)}if(o.center){this.planePositionCenter.x=o.center[0];this.planePositionCenter.y=o.center[1];this.planePositionCenter.z=o.center[2];q.center.setPosition(this.planePositionCenter)}var n=((q.extent.x!=o.extent[0])||(q.extent.y!=o.extent[1])||(q.extent.z!=o.extent[2]));if(o.extent){q.extent.x=o.extent[0];q.extent.y=o.extent[1];q.extent.z=o.extent[2]}if(o.boundaryVertices&&o.boundaryVertexCount){q.boundaryVertexCount=o.boundaryVertexCount;q.boundaryVertices=[];for(var p=0;p<o.boundaryVertexCount;++p){var r=new l.Vector3();r.x=o.boundaryVertices[p][0];r.y=o.boundaryVertices[p][1];r.z=o.boundaryVertices[p][2];q.boundaryVertices.push(r)}}if(o.vertices&&o.vertexCount&&o.triangleCount&&o.triangleIndices&&o.textureCoordinateCount&&o.textureCoordinates){q.vertexCount=o.vertexCount;q.vertices=[];for(var p=0;p<o.vertexCount;++p){q.vertices.push(o.vertices[p][0]);q.vertices.push(o.vertices[p][1]);q.vertices.push(o.vertices[p][2])}q.triangleCount=o.triangleCount;q.triangleIndices=[];for(var p=0;p<o.triangleCount*3;++p){q.triangleIndices.push(o.triangleIndices[p][0])}q.textureCoordinateCount=o.textureCoordinateCount;q.textureCoordinates=[];for(var p=0;p<o.textureCoordinateCount;++p){q.textureCoordinates.push(o.textureCoordinates[p][0]);q.textureCoordinates.push(o.textureCoordinates[p][1]);q.textureCoordinates.push(o.textureCoordinates[p][2])}}if((this._drawPlanes||this._drawPlaneBoundaries||this._drawPlaneMeshes)&&n){this._updatePlaneModel(q)}return q},_updatePlaneModel:function(s){var w=this._nodeManager.getCenterPlaneNode(s.anchor.getName());var t=this._nodeManager.getAnchorPlaneNode(s.anchor.getName());if(!w||!t){return}var v=w.getChildByName("planeModel");if(v){w.removeChild(v)}var r=t.getChildByName("boundaryModel");if(r){t.removeChild(r)}var o=t.getChildByName("meshModel");if(o){t.removeChild(o)}if(this._drawPlanes){var n=k.createRectangleNode({width:s.extent.x,height:s.extent.y,fill:true,color:"red"});n.setPickable(d.NOPICKABLE);n.setName("planeModel");n.material=this.planeMaterial;var x=new l.Matrix4();x.setPosition(new l.Vector3(-s.extent.x/2,-s.extent.y/2,0));n.setMatrix(x);w.addChild(n)}if(this._drawPlaneBoundaries&&s.boundaryVertices!="undefined"&&s.boundaryVertices.length>0){var p=k.createLineNode({points:s.boundaryVertices,material:this.boundaryMaterial});p.setName("boundaryModel");var q=new l.Matrix4().setPosition(new l.Vector3(0,0,0));q.multiply(this._rotX);p.setMatrix(q);t.addChild(p)}if(this._drawPlaneMeshes&&s.vertices!="undefined"&&s.vertices.length>0){var u=k.createSimpleMeshNode({bufferPosition:s.vertices,bufferIndex:s.triangleIndices,bufferUV:s.textureCoordinates,glType:d.ConnectivityTypeEnum.TRIANGLES,color:new d.Color(0.5,0.2,0.4,1)});u.setPickable(d.NOPICKABLE);u.setName("meshModel");var y=new l.Matrix4().setPosition(new l.Vector3(0,0,0));y.multiply(this._rotX);u.setMatrix(y);t.addChild(u)}},_removeFromPlaneList:function(o){for(var p=0;p<o.length;++p){var n=o[p];delete this._context.planeBag[n.identifier];this._nodeManager.removePlane(n.identifier);if(this._onPlaneRemoved){this._onPlaneRemoved()}}},_updateImageList:function(n){for(var p=0;p<n.length;++p){var q=n[p];var o;if(!this._context.imageBag||!(q.identifier in this._context.imageBag)){m.createImageAnchor(this._context,q);o=this._updateSUIImage(q);this._nodeManager.addImage(o);if(this._onImageAdded){this._onImageAdded(o)}}else{o=this._updateSUIImage(q);this._nodeManager.updateImage(o);if(this._onImageUpdated){this._onImageUpdated(o)}}}},_updateSUIImage:function(q){var o=this._context.imageBag[q.identifier];if(q.imagePosition){var n=new l.Vector3();n.x=q.imagePosition[0];n.y=q.imagePosition[1];n.z=q.imagePosition[2];o.anchor.setPosition(n)}if(q.imageOrientation){var p=new l.Quaternion();p.x=q.imageOrientation[0];p.y=q.imageOrientation[1];p.z=q.imageOrientation[2];p.w=q.imageOrientation[3];o.anchor.setOrientation(p)}return o},_removeFromImageList:function(n){for(var o=0;o<n.length;++o){var p=n[o];delete this._context.imageBag[p.identifier];this._nodeManager.removeAnchorImage(p.identifier);if(this._onImageRemoved){this._onImageRemoved()}}},_updateAnchorList:function(q){for(var p=0;p<q.length;++p){var n=q[p];if(!this._context.pointBag||!(n.identifier in this._context.pointBag)){if(n.JSidentifier in this._context.pointBag){var o=this._context.pointBag[n.JSidentifier];delete this._context.pointBag[n.JSidentifier];o.setName(n.identifier);this._context.pointBag[n.identifier]=o;this._updateSUIPointAnchor(n);this._nodeManager.changePointIdentifier(n.JSidentifier,n.identifier);this._nodeManager.updatePoint(o)}else{m.createPointAnchor(this._context,{identifier:n.identifier});var o=this._updateSUIPointAnchor(n);this._nodeManager.addPoint(o)}if(this._onAnchorAdded){this._onAnchorAdded(o)}}else{var o=this._updateSUIPointAnchor(n);this._nodeManager.updatePoint(o);if(this._onAnchorUpdated){this._onAnchorUpdated(o)}}}},_updateSUIPointAnchor:function(p){var q=this._context.pointBag[p.identifier];if(p.pointPosition){var n=new l.Vector3();n.x=p.pointPosition[0];n.y=p.pointPosition[1];n.z=p.pointPosition[2];q.setPosition(n)}if(p.pointOrientation){var o=new l.Quaternion();o.x=p.pointOrientation[0];o.y=p.pointOrientation[1];o.z=p.pointOrientation[2];o.w=p.pointOrientation[3];q.setOrientation(o)}return q},_removeFromAnchorList:function(p){for(var o=0;o<p.length;++o){var n=p[o];delete this._context.pointBag[n.identifier];this._nodeManager.removeAnchorPoint(n.identifier);if(this._onAnchorRemoved){this._onAnchorRemoved()}}},_updatePointCloud:function(r){if(!this._showPointCloud){return}var n=this._viewer.getRootNode().getChildByName("PointCloudBag");if(n===null){n=new g();n.setName("PointCloudBag");n.setMatrix(this._context.getMatrix());this._viewer.addNode(n)}else{if(n.children.length>3){n.removeChild(n.children[0],false)}}var t;var s=0;var q=[];for(var p=0;p<r.length;++p){t=r[p].identifier;if(!this._cloudPoints.hasOwnProperty(t)){this._cloudPoints[t]=new l.Vector3()}this._cloudPoints[t].x=r[p].pointPosition[0];this._cloudPoints[t].y=-r[p].pointPosition[2];this._cloudPoints[t].z=r[p].pointPosition[1];q[s++]=r[p].pointPosition[0];q[s++]=-r[p].pointPosition[2];q[s++]=r[p].pointPosition[1]}var o=k.createPointsNode({positions:q,material:this.pointCloudMaterial});n.addChild(o)},_unconfigureEventListeners:function(){this.onReceivedJson=function(n){}},_configureEventListeners:function(){var n=this;this.onReceivedJson=function(q){if("VIEWPOINT_UPDATED" in q){n._updateSUIHead(q.VIEWPOINT_UPDATED);n._updateTrackingViewpoint(q.VIEWPOINT_UPDATED);n._viewer.render();window.requestAnimationFrame(n._viewer.animate);if(n._onViewpointUpdated){n._onViewpointUpdated(q.VIEWPOINT_UPDATED)}b.publish({event:"/AR/onCameraUpdated",data:{viewpoint:q.VIEWPOINT_UPDATED,}})}if("IMAGE_ANCHOR_UPDATED" in q){var v=q.IMAGE_ANCHOR_UPDATED;n._updateImageList(v);b.publish({event:"/AR/onImageAdded",data:{image:q.IMAGE_ANCHOR_UPDATED,}})}if("IMAGE_ANCHOR_REMOVED" in q){var v=q.IMAGE_ANCHOR_REMOVED;n._removeFromImageList(v);b.publish({event:"/AR/onImageRemoved",data:{image:q.IMAGE_ANCHOR_REMOVED,}})}if("PLANE_ANCHOR_UPDATED" in q){var r=q.PLANE_ANCHOR_UPDATED;n._updatePlaneList(r);b.publish({event:"/AR/onPlaneAnchorUpdated",data:{plane:q.PLANE_ANCHOR_UPDATED,}})}if("PLANE_ANCHOR_REMOVED" in q){var r=q.PLANE_ANCHOR_REMOVED;n._removeFromPlaneList(r);b.publish({event:"/AR/onPlaneAnchorRemoved",data:{plane:q.PLANE_ANCHOR_REMOVED,}})}if("POINT_ANCHOR_UPDATED" in q){var o=q.POINT_ANCHOR_UPDATED;n._updateAnchorList(o);b.publish({event:"/AR/onPointAnchorUpdated",data:{point:q.POINT_ANCHOR_UPDATED,}})}if("POINT_ANCHOR_REMOVED" in q){var o=q.POINT_ANCHOR_REMOVED;n._removeFromAnchorList(o);b.publish({event:"/AR/onPointAnchorRemoved",data:{point:q.POINT_ANCHOR_REMOVED,}})}if("POINT_CLOUD_UPDATED" in q){var t=q.POINT_CLOUD_UPDATED;n._updatePointCloud(t);b.publish({event:"/AR/onPointCloudUpdated",data:{pointCloud:q.POINT_CLOUD_UPDATED,}})}if("TRACKINGSTATE_UPDATED" in q){var p;var u;switch(q.TRACKINGSTATE_UPDATED.trackingReason){case 0:u="NONE";break;case 1:u="NOT_READY";break;case 2:u="NOT_READY_RELOCALIZATION";break;case 3:u="EXCESSIVE_MOTION";break;case 4:u="INSUFFICIENT_FEATURES";break;case 5:u="INSUFFICIENT_LIGHT";break}switch(q.TRACKINGSTATE_UPDATED.trackingState){case 0:p="NOT_AVAILABLE";break;case 1:p="LIMITED";break;case 2:p="NORMAL";break}var w={trackingState:p,trackingReason:u};if(n._onSessionStateChanged){n._onSessionStateChanged(w)}b.publish({event:"/AR/onTrackingStateUpdated",data:{trackingState:w}})}if("HITTEST_RESULTS" in q){if(n._onReceiveHitTestResult){n._onReceiveHitTestResult(q.HITTEST_RESULTS)}b.publish({event:"/AR/onHitTestResultReceived",data:{hitTest:q.HITTEST_RESULTS,}})}if("CENTER_HITTEST_RESULTS" in q){if(n._onReceiveCenterHitTestResult){n._onReceiveCenterHitTestResult(q.CENTER_HITTEST_RESULTS)}b.publish({event:"/AR/onCenterHitTestResultReceived",data:{hitTest:q.CENTER_HITTEST_RESULTS,}})}if("WORLD_MAP_INFOS" in q){var s=q.WORLD_MAP_INFOS;if(n._onReceiveWorldMap){n._onReceiveWorldMap(s)}b.publish({event:"/AR/onWorldMapReceived",data:{hitTest:s}});if(n._loadWorldMap){if(s.planeAnchors){n._updateImageList(s.planeAnchors)}if(s.imageAnchors){n._updateAnchorList(s.imageAnchors)}if(s.pointAnchors){n._updatePlaneList(s.pointAnchors)}n._loadWorldMap=false}}};if(!this._odt){window.ARNativeDelegate.addJsonWatch(this.onReceivedJson)}},_planeIsHit:function(v,t,w){var D=new l.Vector3().copy(t.origin);var A=new l.Vector3().copy(t.direction);var u=v.center.getVirtualGlobalMatrix();var B=new l.Vector3(0,0,0).applyMatrix4(u);var o=u.decompose();var E=new l.Vector3(0,0,1).applyQuaternion(o[1]);E.normalize();var s=Math.abs(A.x*E.x+A.y*E.y+A.z*E.z);var F=new l.Vector3().subVectors(B,D);var q=F.x*E.x+F.y*E.y+F.z*E.z;var n=-q/s;if(n>0){var x=new l.Vector3().copy(D);x.add(A.multiplyScalar(n));var z=this._context.getMatrix();var C=new l.Matrix4().getInverse(z);var p=new l.Vector3().copy(x).applyMatrix4(C);if(w){return{hit:true,distance:n,intersection:p}}else{var r=new l.Matrix4().getInverse(u);var y=new l.Vector3().copy(x);y.applyMatrix4(r);if(y.x<0.5*v.extent.x&&y.x>-0.5*v.extent.x&&y.y<0.5*v.extent.y&&y.y>-0.5*v.extent.y){return{hit:true,distance:n,intersection:p,localIntersection:y}}}}return{hit:false}},activate:function(){this._context=m.createSUIModel();this._configureSUI();this._configureViewer();if(!this._odt&&window.ARNativeDelegate==null){return}this._configureEventListeners();if(this._odt){return}var o={imageDetectionData:this._detectionImageData,detectHorizontal:this._detectionMode.Horizontal,detectVertical:this._detectionMode.Vertical,BoundaryMesh:this._detectionMode.BoundaryMesh,Mesh:this._detectionMode.Mesh};var n=this;window.ARNativeDelegate.execute("start",o).then(function(p){console.log("ARSession has been started");if(n.onPostRenderToken==null){n.onPostRenderToken=n._viewer.onPostRender(function(){window.ARNativeDelegate.sendJson({arDataSent:true})})}b.publish({event:"/AR/onScenarioStarted",data:{}})},console.error)},suspend:function(){this._restoreViewer();this._unconfigureEventListeners();if(window.ARNativeDelegate==null){return}window.ARNativeDelegate.sendJson({suspendARSession:true})},resume:function(){this._configureViewer();if(window.ARNativeDelegate==null){return}this._configureEventListeners();var n=this;window.ARNativeDelegate.execute("resumeARSession",null).then(function(o){if(n.onPostRenderToken==null){n.onPostRenderToken=n._viewer.onPostRender(function(){window.ARNativeDelegate.sendJson({arDataSent:true})})}},console.error)},deactivate:function(){this._context=null;this._restoreViewer();this._unconfigureEventListeners();window.ARNativeDelegate.sendJson({stopARSession:true});window.ARNativeDelegate.removeAllWatch()},setCallback:function(o,n){switch(String(o)){case"TrackingSessionStateChanged":this._onSessionStateChanged=n;break;case"ViewpointUpdated":this._onViewpointUpdated=n;break;case"PlaneAdded":this._onPlaneAdded=n;break;case"PlaneUpdated":this._onPlaneUpdated=n;break;case"PlaneRemoved":this._onPlaneRemoved=n;break;case"AnchorAdded":this._onAnchorAdded=n;break;case"AnchorUpdated":this._onAnchorUpdated=n;break;case"AnchorRemoved":this._onAnchorRemoved=n;break;case"ImageAdded":this._onImageAdded=n;break;case"ImageUpdated":this._onImageUpdated=n;break;case"ImageRemoved":this._onImageRemoved=n;break;case"HitTestResultsReceived":this._onReceiveHitTestResult=n;break;case"CenterHitTestResultsReceived":this._onReceiveCenterHitTestResult=n;break;case"WorldMapReceived":this._onReceiveWorldMap=n;break;default:console.log("error");break}},setDrawPlanes:function(s){this._drawPlanes=s.plane;this._drawPlaneBoundaries=s.planeBoundary;this._drawPlaneMeshes=s.planeMesh;if(!this._context){return}var p=this._context.planeBag;if(!p){return}for(var v in p){var q=p[v];if(this._drawPlanes||this._drawPlaneBoundaries||this._drawPlaneMeshes){this._updatePlaneModel(q)}else{var u=this._nodeManager.getCenterPlaneNode(q.anchor.getName());var r=this._nodeManager.getAnchorPlaneNode(q.anchor.getName());var o=u.getChildByName("planeModel");if(o){u.removeChild(o)}var n=r.getChildByName("boundaryModel");if(n){r.removeChild(n)}var t=r.getChildByName("meshModel");if(t){r.removeChild("meshModel")}}}if(this._drawPlanes==false&&this._drawPlaneBoundaries==false&&this._drawPlaneMeshes==false){this._nodeManager._planeBag.setVisibility(false)}else{this._nodeManager._planeBag.setVisibility(true)}},setPlaneDetection:function(n){this._detectionMode={Horizontal:n.Horizontal,Vertical:n.Vertical,BoundaryMesh:n.BoundaryMesh,Mesh:n.Mesh};if(window.ARNativeDelegate==null){return}window.ARNativeDelegate.sendJson({setPlaneDetection:n})},setImageDetection:function(n){if(n.imageData){var o=n.imageData.external&&n.imageData.imagesArray;o=o||(!n.imageData.external&&n.imageData.imagesPath);if(o){this._detectionImageData=n.imageData}}this._detectionPlane={Horizontal:n.Horizontal,Vertical:n.Vertical,BoundaryMesh:n.BoundaryMesh,Mesh:n.Mesh};window.ARNativeDelegate.sendJson({setImageDetection:{imageDectionData:this._detectionImageData}})},setPointCloudVisibility:function(o){if(this._showPointCloud==o){return}this._showPointCloud=o;this._viewer.displayPoints(o);if(this._showPointCloud===false){var p=this._viewer.getRootNode();var n=p.getChildByName("PointCloudBag");if(n!==null){p.removeChild(n)}}if(window.ARNativeDelegate==null){return}window.ARNativeDelegate.sendJson({setPointCloudVisibility:o})},hitTest:function(p){if(window.ARNativeDelegate==null){return}var o={x:p.point2D.x,y:p.point2D.y};if(p.positionInPixel){var n=((this._viewer.canvas.height*this._videoRatio)-this._viewer.canvas.width)/2;o.x=(p.point2D.x*window.devicePixelRatio+n)/(this._viewer.canvas.height*this._videoRatio);o.y=p.point2D.y*window.devicePixelRatio/this._viewer.canvas.height}if(i&&i.isAndroid()&&this._firstHitTestWarning&&(p.IsHitEstimatedHorPlane||p.IsHitEstimatedVerPlane)){console.warn("IsHitEstimatedHorPlane and isHitEstimatedVerPlane are iOS only params");this._firstHitTestWarning=false}window.ARNativeDelegate.sendJson({hitTest:{x:o.x,y:o.y,IsHitFeaturePoint:p.IsHitFeaturePoint,IsHitEstimatedHorPlane:p.IsHitEstimatedHorPlane,IsHitEstimatedVerPlane:p.IsHitEstimatedVerPlane,IsHitExistingPlane:p.IsHitExistingPlane,IsHitExistingPlaneUsingExtent:p.IsHitExistingPlaneUsingExtent,IsHitExistingPlaneUsingGeometry:p.IsHitExistingPlaneUsingGeometry}})},activateHitTestCenterScreen:function(n){if(window.ARNativeDelegate==null){return}if(i&&i.isAndroid()&&(n.IsHitEstimatedHorPlane||n.IsHitEstimatedVerPlane)){console.log("IsHitEstimatedHorPlane and isHitEstimatedVerPlane are iOS only params")}window.ARNativeDelegate.sendJson({activateCenterHitTest:{IsHitFeaturePoint:n.IsHitFeaturePoint,IsHitEstimatedHorPlane:n.IsHitEstimatedHorPlane,IsHitEstimatedVerPlane:n.IsHitEstimatedVerPlane,IsHitExistingPlane:n.IsHitExistingPlane,IsHitExistingPlaneUsingExtent:n.IsHitExistingPlaneUsingExtent,IsHitExistingPlaneUsingGeometry:n.IsHitExistingPlaneUsingGeometry}})},deactivateHitTestCenterScreen:function(){if(window.ARNativeDelegate==null){return}window.ARNativeDelegate.sendJson({deactivateCenterHitTest:true})},addAnchor:function(p){var n="ID-"+this.anchorsIdCounter_++;var r=p.decompose();var t=[r[0].x,r[0].y,r[0].z];var s=[r[1].x,r[1].y,r[1].z,r[1].w];m.createPointAnchor(this._context,{identifier:n});var q=this._updateSUIPointAnchor({identifier:n,pointPosition:t,pointOrientation:s});this._nodeManager.addPoint(q);var o=new l.Matrix4().multiplyMatrices(this._rotmX,p);o.multiply(this._rotX);o.elements[12]*=0.001;o.elements[13]*=0.001;o.elements[14]*=0.001;if(window.ARNativeDelegate==null){return q}window.ARNativeDelegate.sendJson({addAnchor:{id:n,matrix:o.elements}});return q},removeAnchor:function(n){if(window.ARNativeDelegate==null){return}window.ARNativeDelegate.sendJson({removeAnchor:{id:n}})},hitJSPlane:function(v){var t=this._trackingViewpoint.create3DRayFrom2DPoint(v.point2D);t.direction.normalize();var s=[];var o=this._context.planeBag;var r=this;for(var u in o){var p=o[u];var n=r._planeIsHit(p,t,v.infinitePlane);if(n.hit){var q=0;if(s.length>0){for(q=0;q<s.length;++q){if(n.intersection.z>s[q].info.intersection.z){break}}}s.splice(q,0,{suiPlane:p,info:n})}}return s},requestCameraOnNextFrame:function(){if(window.ARNativeDelegate==null){return}window.ARNativeDelegate.sendJson({requestCameraNextFrame:true})},getNodeManager:function(){return this._nodeManager},getContext:function(){return this._context},updateViewer:function(q){if(!!q){this._viewer=q}this._configureViewer();this._nodeManager=new j(this._viewer);for(var n in this._context.planeBag){var p=this._context.planeBag[n];this._nodeManager.addPlane(p)}for(var r in this._context.pointBag){var o=this._context.pointBag[r];this._nodeManager.addPoint(o)}},saveWorldMap:function(){if(this._worldMappingStatus==="Mapped"){window.ARNativeDelegate.sendJson({saveWorldMap:true})}else{console.log("world mapping status is "+this._worldMappingStatus)}},loadWorldMap:function(){this._loadWorldMap=true;window.ARNativeDelegate.sendJson({loadWorldMap:true})},getWorldMap:function(){window.ARNativeDelegate.sendJson({getWorldMap:true})},setFrameImageCaptureParameter:function(n){if(window.ARNativeDelegate==null){return}window.ARNativeDelegate.sendJson({setFrameImageCaptureParameter:{compressionFactor:n.compressionFactor,scaleFactor:n.scaleFactor}})}});return f});define("DS/SUI/HMDScenario",["UWA/Core","DS/Devices/DeviceFactory","DS/Devices/HMD","DS/SUI/SUIFactory","DS/SUI/Element","DS/Visualization/ThreeJS_DS","DS/Visualization/WebGLV6Viewer","DS/Visualization/Viewpoint","DS/Visualization/CameraSystem","DS/Visualization/Node3D","DS/VRModels/ControllerModel","DS/IVBehaviours/TeleportBehaviour","DS/CoreEvents/Events"],function(c,g,n,m,a,k,j,f,l,e,d,i,b){var h=c.Class.extend({init:function(p){this._viewer=p;this._vrNode=new e();this._viewer.addNode(this._vrNode);this._viewer.renderer.renderer._VRCompatible=true;var q=this._viewer.renderer.gl.getContextAttributes();this._mirrorAttributesOn=q.antialias||q.preserveDrawingBuffer;this._context=null;this._hmd=null;this._controllers=[];this._trackingViewpoint=null;this._mirroring=true;this._standingMode=false;this.onPreRender=function(){};this.sceneMin=null;this._trackPosition=true;this._oldProjectionType=null;var o=this;this.onControllerConnect=function(){var r=new i();r.bindToScenario(o)}},getViewer:function(){return this._viewer},getContext:function(){return this._context},getControllers:function(){return this._controllers},setOnControllerConnect:function(o){this.onControllerConnect=o},setOnControllerModelLoaded:function(o){this.onControllerModelLoaded=o},setMirroring:function(o){this._mirroring=o},setSceneMin:function(o){this.sceneMin=o},setStanding:function(p){var o=this._hmd.hasStandingMatrix();p=p&&o;if(this._standingMode!==p){this._updateSUIUser(p)}this._standingMode=p},enterVRMode:function(){if(!this._hmd){return}if(this._standingMode){this._setStandingContext()}var p=this._viewer.canvas;if(!p){return}window.devicePixelRatio=1;var q=this._hmd.width;var o=this._hmd.height;if(q&&o){p.width=q;p.height=o}this._viewer.useOffscreenCanvas=true;return this._hmd.beginRender([{source:p,leftBounds:[0,0,0.5,1],rightBound:[0.5,0,0,1]}])},_configureContext:function(){if(this._viewer){var p=this._viewer.currentViewpoint;this._context.setPosition(p.getEyePosition());var o=new k.Quaternion().copy(p.getControl().orientation);this._setContextUp(o)}},_setStandingContext:function(){this._context.setPositionZ(this.sceneMin)},_setContextUp:function(q){var p=new k.Vector3(0,1,0).applyQuaternion(q);var r=new k.Vector3(0,0,1);var s=r.angleTo(p);var t=new k.Vector3().crossVectors(r,p).normalize();var o=new k.Quaternion().setFromAxisAngle(t,-s);o.multiply(q);this._context.setOrientation(o)},_updateSUIUser:function(t,o,r){var q=this._context.getUser();if(t){var s=this._hmd.getSittingToStanding();var p=s.decompose();p[0].multiplyScalar(1000);q.setPosition(p[0]);q.setOrientation(p[1])}else{if(!t&&o&&r){q.setPosition(o);q.setOrientation(r)}else{q.setPosition(new k.Vector3());q.setOrientation(new k.Quaternion())}}},_computeStereoCameras:function(u,s,r){if(this._hmd!==null){if(s<100){this._hmd.setNear(s)}else{this._hmd.setNear(100);s=100}this._hmd.setFar(r);this._hmd.updateFrameData();var q=this._context.getUser();var w=q.head.leftEye;var t=q.head.rightEye;var x=w.getVirtualGlobalMatrix().decompose();var p=t.getVirtualGlobalMatrix().decompose();var o=u.camera.clone();var v=u.camera.clone();o.position.copy(x[0]);v.position.copy(p[0]);o.quaternion.copy(x[1]);v.quaternion.copy(p[1]);o.updateMatrixWorld();v.updateMatrixWorld();o.near=s;o.far=r;v.near=s;v.far=r;o.projectionMatrix.copy(this._hmd.getProjectionMatrix("left"));o.externalProjectionMatrix=true;v.projectionMatrix.copy(this._hmd.getProjectionMatrix("right"));v.externalProjectionMatrix=true}return[o,v]},_configureViewer:function(){this._viewer.defaultAnimationLoop=false;window.requestAnimationFrame(this.animate.bind(this));this._trackingViewpoint=new f({viewer:this._viewer,projectionType:f.PERSPECTIVE});this._viewer.setTrackingViewpoint(this._trackingViewpoint);this._oldProjectionType=this._viewer.currentViewpoint.getProjectionType();this._viewer.currentViewpoint.setProjectionType(f.PERSPECTIVE);if(!this._viewer){return}var p=this._viewer.currentViewpoint;p.onMove(null);var o=new l();o.setComputeCameraArrayCB(this._computeStereoCameras.bind(this),true);o.setUsePredefinedCombineShader("leftRight");this._viewer.setCameraSystem(o)},restoreViewer:function(){if(this._viewer){var p=this._viewer.getViewpoints();if(!p.length){return}var o=this._viewer.currentViewpoint;o.onMove(this._viewer.render);this._viewer.setCameraSystem(null);this._viewer.setTrackingViewpoint(null);this._viewer.currentViewpoint.setProjectionType(this._oldProjectionType);this._viewer._updateShadowMaps();this._viewer.defaultAnimationLoop=true;window.requestAnimationFrame(this._viewer.animate)}},update:function(){if(!this._hmd){return}if(navigator.getGamepads&&this._controllers.length===0){var q=navigator.getGamepads();if(q.length!==this._controllers.length){this._controllers=g.createControllers(q);if(this._controllers.length>0){d.loadControllersModel(this._controllers,this._vrNode,this.onControllerModelLoaded);this.onControllerConnect()}}}for(var p=0;p<this._controllers.length;++p){var o=this._controllers[p];o.update();this._updateSUIHand(o)}this._hmd.update(this._trackPosition);this._updateSUIHead();this._updateTrackingViewpoint()},_updateSUIHead:function(){var o=this._context.getUser().head;o.setPosition(this._hmd.getPosition());o.setOrientation(this._hmd.getOrientation())},_updateSUIHand:function(o){var q;var p=this._context.getUser();if(o._hand==="left"){q=p.leftHand}else{if(o._hand==="right"){q=p.rightHand}}if(q){q.setPosition(o._position);q.setOrientation(o._orientation);var r=o.getNode();if(r){r.setMatrix(q.getVirtualGlobalMatrix())}}},_updateTrackingViewpoint:function(){var o=this._context.getUser().head.getVirtualGlobalMatrix().decompose();this._trackingViewpoint.moveTo({eyePosition:o[0],orientation:o[1]})},activate:function(){var o=this;return g.createHMD().then(function(p){o._hmd=p;o._context=m.createSUIModel(p);o._configureContext();o._configureViewer();b.publish({event:"IV_HMD_ACTIVATED"})})},deactivate:function(){var o=this;this._hmd.endRender().then(function(){var s=o._controllers.length;for(var q=0;q<s;++q){var p=o._controllers[q];var r=p.getNode();o._viewer.removeNode(r)}o._controllers=[];o._standingMode=false;o._mirroring=true;o.restoreViewer();o._hmd=null})},resetHMD:function(){if(!this._standingMode){this._updateSUIUser(false,this._hmd.getPosition().negate(),this._hmd.getOrientation().inverse())}},_render:function(){this.onPreRender();this._viewer.render();this._viewer.animate()},animate:function(){if(!this._hmd){window.requestAnimationFrame(this.animate.bind(this));this._render()}else{var p=this._hmd._vrHMD;p.requestAnimationFrame(this.animate.bind(this));this.update();this._hmd.render(this._render.bind(this));if(this._mirroring&&p.capabilities.hasExternalDisplay){var o=(!!window.chrome&&!!window.chrome.webstore);if(!this._mirrorAttributesOn&&o){this._viewer.glRender(this._viewer._renderParams)}}else{if(!this._mirroring&&p.capabilities.hasExternalDisplay){this._viewer.renderer.renderer.clear()}}}},setOnPreRender:function(o){this.onPreRender=o},setPositionTracking:function(o){this._trackPosition=o}});return h});