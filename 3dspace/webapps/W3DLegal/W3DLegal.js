define("DS/W3DLegal/W3DLegal",["UWA/Core","UWA/Element","UWA/Utils","UWA/Utils/Client","UWA/Event","UWA/Class/View","DS/WAFData/WAFData","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Button","DS/UIKIT/Modal","DS/UIKIT/SuperModal","DS/UIKIT/DropdownMenu","DS/TopBarProxy/TopBarProxy","i18n!DS/W3DLegal/assets/nls/W3DLegal","css!DS/W3DLegal/W3DLegal"],function(f,n,d,o,t,q,b,g,j,c,p,l,r,i){var k={superModal:null,messages:Object.create(null),elements:{},viewportWidth:0,init:function(u){k.elements.container=f.createElement("div",{"class":"alert-legal"}).inject(u);k.intResizeEvent()},intResizeEvent:function(){n.addEvent.call(window,"resize",k.updatePositions)},removeResizeEvent:function(){n.removeEvent.call(window,"resize",k.updatePositions)},notify:function(v,w){var x=s._legal,u=k.superModal;if(!u){u=new p({className:"legal-notifier"});k.superModal=u}x.grantModal&&x.grantModal.hide();u.alert(w||v,function(){x.grantModal&&x.grantModal.show()})},createBottomMessage:function(G){var B,C=k,z=G.msg,A=C.messages,F=Object.keys(A),u=G||{},D=F.length,w=C.elements.container,x=G.envId,E,y,v;if(A[x]){return}B=f.createElement("div",{"class":"alert-legal-message",text:z,styles:{zIndex:D}});B.inject(w);x=G.envId;v={id:x,element:B};A[x]=v;E=f.createElement("span",{"class":"fonticon fonticon-cancel-circled icon-close"});E.inject(B,"bottom");E.addEvent("click",C.onMessageClose.bind(null,v,u));if(f.is(u.onInfo,"function")){y=f.createElement("span",{"class":"fonticon fonticon-info-circled icon-info"});y.inject(B,"top");y.addEvent("click",C.onMessageInfo.bind(null,v,u))}C.updatePositions({force:true});return v},removeMessage:function(x){var w=k,v=w.messages,u=w.messages[x.id].element;u.destroy();delete v[x.id];w.updatePositions({force:true})},onMessageInfo:function(v,u){if(f.is(u.onInfo,"function")){u.onInfo(u)}},onMessageClose:function(w,v){var u=k;u.removeMessage(w);if(f.is(v.onClose,"function")){v.onClose(v)}},updatePositions:function(u){var z=k,y=z.messages,x=u||{},w=Object.keys(y),v=window.innerWidth||document.documentElement.clientWidth,A=0;if(z.viewportWidth===v&&!x.force){return}w.forEach(function(C){var B=y[C].element;B.setStyle("bottom",Math.round(A));A+=B.getDimensions().outerHeight});z.viewportWidth=v}};var e={checkoutticket:"/resources/AppsMngt/environment/checkoutticket",failurePage:"/resources/AppsMngt/uploadfile/message?error=true",eServiceError:"/enovia/eServiceError.jsp",init:function(u){e.initUrls(u.myAppsUrl)},initUrls:function(u){e.myAppsBaseUrl=(u&&f.typeOf(u)==="string")?u:""},buildCheckoutForm:function(w,v){var u=f.createElement("form",{method:"POST",action:v.fcsUrl,enctype:"application/x-www-form-urlencoded",style:{display:"none"}});f.createElement("input",{type:"hidden",value:e.myAppsBaseUrl+e.failurePage,name:"__fcs__failurePage",id:"__fcs__failurePage"}).inject(u);f.createElement("input",{type:"hidden",value:v.fcsJobTicket,name:"__fcs__jobTicket",id:"__fcs__jobTicket"}).inject(u);f.createElement("input",{type:"hidden",value:w,name:"file_0_name",id:"file_0_name"}).inject(u);return u},doCheckout:function(u){var w={envid:u.envid,file:u.file},x=u.file,v=u&&u.ressourceType;if(v==="url"){window.open(u.file,"_blank")}else{e.doRequest(e.myAppsBaseUrl+e.checkoutticket,w,{onComplete:function(y){if(o.Platform.android){var z=e.buildCheckoutForm(x,y);z.inject(document.body);z.submit();d.setImmediate(z.destroy)}else{var A=d.toQueryString({__fcs__failurePage:e.myAppsBaseUrl+e.failurePage,__fcs__jobTicket:y.fcsJobTicket,file_0_name:x,__fcs__attachment:true});window.location=y.fcsUrl+"?"+A}}})}},doRequest:function(v,u,x){var A={Accept:"application/json","Accept-Language":s._legal.language},z;function y(B){if(h.isResultValid(B)){if(f.is(x.onComplete,"function")){x.onComplete(B)}}else{k.notify(i.errorMsg);if(f.is(x.onFailure,"function")){x.onFailure(B)}}}function w(B){if(typeof x.onFailure==="function"){x.onFailure(B)}else{f.log(B.error?B.error:B)}}u=d.toQueryString(u);u=(u.length>0)?"?"+u:"";b.authenticatedRequest(v+u,{timeout:15000,method:"GET",type:"json",headers:A,data:z,cache:-1,onComplete:y,onFailure:w})}};var a=q.extend({tagName:"footer",className:"w3dfooter",elements:null,items:null,domEvents:{"click .list-itm-wrap":"onItemClick"},setup:function(u){var v=this;v.items=u.items;v._parent(u)},render:function(){var w=this,x={},v=w.getContent(),u=f.createElement;v=w.getContent();x.list=u("ul",{"class":w.className+"-list"}).inject(v);w.items.forEach(function(y){w._buildItem(y).inject(x.list)});w.elements=x;return w},_buildItem:function(x){var w=this,v=f.createElement,z="list-itm-wrap",u=v("li",{"class":w.className+"-list-itm",name:x.name}),y={"class":z,text:x.text},A;x.html&&(y.html=x.html);A=v("span",y).inject(u);f.merge(x,{clickable:true});x.clickable&&u.addClassName("clickable");if(x.icon){v("div",{"class":"fonticon "+x.icon}).inject(A)}return u},onItemClick:function(w){var u=this,v=t.getElement(w);u.dispatchEvent("onClick",[u,w,v.parentElement])},destroy:function(){this._parent()}});var h={_baseURL:"",APPS_MNGT:"/resources/AppsMngt/",GET_LEGAL:"user/startup",SET_LEGAL:"user/setlegal",isResultValid:function(v){var w=false,u;if(v){if((v.code&&v.code!=="0")||v.error||v.status){if(v.message&&v.message!==""){u=v.message}else{if(v.error&&v.error.type){u=v.error.type}else{if(v.error){u=v.error}else{if(v.status){u=v.status}else{u=v}}}}f.log(u)}else{w=true}}return w},init:function(u){var v=u.myAppsUrl||"";if(f.is(v,"string")){h._baseURL=v.replace(/\/$/g,"")}},fetchUserLegal:function(v){var u=h._baseURL+h.APPS_MNGT+h.GET_LEGAL,w=v.params?f.Utils.toQueryString(v.params):"";b.authenticatedRequest(w?u+"?"+w:u,{timeout:11000,method:"GET",type:"json",cache:-1,headers:{Accept:"application/json","Accept-Language":s._legal.language},onComplete:v.onComplete,onFailure:v.onFailure})},setUserLegal:function(w,v){var x=v||{},u=h._baseURL+h.APPS_MNGT+h.SET_LEGAL+(x.isCookie?"/cookie":"");b.authenticatedRequest(u,{method:"POST",type:"json",data:{envids:w.join(",")},onComplete:x.onComplete,onFailure:x.onFailure,cache:-1})}};var m=f.Class.extend({chineseTenantRegex:/aph7/gi,nonAcceptedTerms:null,nonAcceptedCookies:null,acceptedTerms:null,allEnvs:null,acceptedCbList:[],grantModal:null,grants:[],isAccessValid:false,myAppsBaseUrl:null,aboutHandler:null,footerEventHandler:null,dropdownEventHandler:null,isReady:false,language:null,COOKIE_KEY:"swymlang",config:null,acceptedTou:null,acceptedDp:null,acceptedCookies:null,legalInfos:null,swymTenants:null,elements:{},dsCn:"达索析统（上海）信息技术有限公司",icpReordal:"沪ICP备14051708号",cnMinistry:"http://www.beian.miit.gov.cn",defaultOptions:{onAccept:function(){},onFailure:function(){},renderFooter:true,footerContainer:document.body,onAboutClick:null,legal:null,swym:null,tenandId:null,myAppsBaseUrl:""},filterEnvironments:function(A){var B=this,w=[],C=[],y=[],v=[],D=[],F=[],E=[],x=[],z=[],u=false;A.forEach(function(K){var J=K.cookie,L=B.isValid(K.tos),M=B.isValid(K.dp),H,I,G;H={id:K.id,tou:K.tos,name:K.displayName,type:i.termsOfUse,env:K};I={id:K.id,dp:K.dp,name:K.displayName,type:i.dataPrivacy,env:K};if(L){if(B.isValidNotAccepted(K.tos,K.acceptedTOS)){D.push(H)}else{v.push(H)}}if(M){if(B.isValidNotAccepted(K.dp,K.acceptedDP)){F.push(I)}else{y.push(I)}}if(L||M){if(K.accepted&&K.acceptedDP&&K.acceptedTOS){w.push(K)}else{if((!K.acceptedDP&&M)||(!K.acceptedTOS&&L)){C.push(K)}}}if(K.footerDisplay){u=true}if(J&&J.message){G={id:K.id,cookie:K.cookie.file,name:K.displayName,message:K.cookie.message,type:"Cookie",env:K};if(J.accepted){x.push(G)}else{E.push(G)}}if(K.legalInfo){z.push({id:K.id,legalInfo:K.legalInfo,name:K.displayName,type:i.legalInfo,env:K})}});return{acceptedTerms:w,nonAcceptedTerms:C,acceptedTou:v,nonAcceptedTou:D,acceptedDp:y,nonAcceptedDp:F,acceptedCookies:x,nonAcceptedCookies:E,legalInfos:z,envDisplayFooter:u}},mergeTos:function(u,w){var v=u.concat(w);v.forEach(function(x){if(w.indexOf(x)!==-1){x.acceptedDP=!!x.dp;x.acceptedTOS=!!x.tos}return x.tos||x.dp});return v},isValidNotAccepted:function(u,v){return this.isValid(u)&&!v},isValid:function(u){return u&&f.is(u,"string")},buildTermsToAccept:function(u){var v=this,w=[];u.forEach(function(x){w.push(v.buildEnvToAccept(x))});return w},buildEnvToAccept:function(w){var y=this,u=f.createElement("div",{"class":"w3dlegal-env",html:'<div class="w3dlegal-env-title" name="'+w.id+'">'+w.displayName+'</div><div class="w3dlegal-env-msg"><p></p><div class="w3dlegal-env-links"></div></div>'}),x=u.getElement(".w3dlegal-env-links"),v=u.getElement(".w3dlegal-env-msg"),z=new g({type:"checkbox",checked:false,value:"",label:"",className:"w3dlegal-toggle primary",name:w.displayName});if(f.is(w.message,"string")){v.getElement("p").appendText(w.message)}if(y.isValidNotAccepted(w.tos,w.acceptedTOS)){y.buildLink(w,true).inject(x)}if(y.isValidNotAccepted(w.dp,w.acceptedDP)){y.buildLink(w).inject(x)}z.elements.container.inject(v,"before");y.grants.push(z);return u},buildLink:function(w,u){var y=this,v=w,z=!!u,x=f.createElement("span",{"class":"w3dlegal-link-ctn",html:'<span class="fonticon fonticon-doc-text"></span><a class="w3dlegal-link">'+(u?i.termsOfUse:i.dataPrivacy)+"</a>"});x.addEvent("click",function(){y.checkOut.doCheckout({envid:v.id,file:(z)?v.tos:v.dp})});return x},acceptHandler:function(){var v=this,u=v.getNonValid();if(u.length===0){v.acceptButton.disable();v.sendTos()}else{v.notifier.notify(i.warning,i.notValid)}},isTenantTypePresent:function(v,u){return u.some(function(w){return w&&w.url&&w.url.test(v)})},onReceivedTos:function(y,u){var z=this,w=z.filterEnvironments(y),x,v;z.allEnvs=y;f.extend(z,w);z.swymTenants=u;if(z.nonAcceptedTerms.length){v=new c({header:"<h4>"+i.legalNotice+"</h4>",body:z.buildTermsToAccept(z.nonAcceptedTerms),closable:false,className:"w3dlegal-modal",renderTo:document.body});x=new j({value:i.okBtn,className:"primary",events:{onClick:z.acceptHandler.bind(z)}});x.inject(v.getFooter());v.show();z.grantModal=v;z.acceptButton=x}else{z.onAcceptedTerms()}},getNonValid:function(){return this.grants.filter(function(u){return !u.isChecked()})},sendTos:function(){function u(){this.notifier.notify(i.error,i.errorMsg);f.log("Legal: Could not set user grants.")}var v=this;v.platformAccess.setUserLegal(v.nonAcceptedTerms.map(function(w){return w.id}),{onComplete:function(w){if(f.is(w.code)&&w.code.toString()==="0"){v.isAccessValid=true;v.grantModal.hide();v.onAcceptedTerms()}else{u()}},onFailure:function(){v.acceptButton.enable();v.notifier.notify(i.error,i.errorMsg);f.log("Legal: Could not set user grants.")}})},onAcceptedTerms:function(){var u=this;u.acceptedTerms=u.mergeTos(u.acceptedTerms,u.nonAcceptedTerms);u.nonAcceptedTerms=[];u.acceptedTou=u.acceptedTou.concat(u.nonAcceptedTou);u.nonAcceptedTou=[];u.acceptedDp=u.acceptedDp.concat(u.nonAcceptedDp);u.nonAcceptedDp=[];u.acceptedCookies=u.acceptedCookies.concat(u.nonAcceptedCookies);u.callAcceptedCbs();u.onAccept({isFooterRendered:u.renderFooter&&u.envDisplayFooter&&u.footerContainer});u.isReady=true;u.renderHelpLegal=!!(u.acceptedTou.length||u.acceptedDp.length);u.renderHelpLegal&&u.addHelpMenuLegal();u.renderFooter&&u.displayFooter();u.acceptButton&&u.acceptButton.destroy();u.grantModal&&u.grantModal.destroy();u.displayCookies(u.nonAcceptedCookies);u.grantModal=null;u.acceptButton=null},callAcceptedCbs:function(){var w=this,v,u;for(v=0,u=w.acceptedCbList.length;v<u;v++){w.acceptedCbList[v].call(null,w.acceptedTerms)}},initUrls:function(v){var u=this;u.myAppsBaseUrl=v.replace(/\/$/g,"");u.checkOut.init({myAppsUrl:u.myAppsBaseUrl});u.platformAccess.init({myAppsUrl:u.myAppsBaseUrl})},fetchAcceptedTerms:function(v){var u=this;if(!u.acceptedTerms){u.acceptedCbList.push(v)}else{v.call(null,u.acceptedTerms)}},displayCookies:function(u){var z=this,x=z.checkOut,w=z.platformAccess;function v(A){var B=A.cookie;if(B.accepted){return}w.setUserLegal([A.envId],{isCookie:true,onComplete:function(){B.accepted=true;var C=z.nonAcceptedCookies.indexOf(B);z.nonAcceptedCookies.splice(C,1)}})}function y(B){var C=B||{},A=C.cookie;if(A&&A.cookie&&C.envId){x.doCheckout({envid:C.envId,file:A.cookie})}}u.forEach(function(A){z.notifier.createBottomMessage({msg:A.message,envId:A.id,cookie:A,onClose:v,onInfo:A.cookie?y:null})})},displayFooter:function(u,v){var w=this,u=u||w.footerContainer,x;if(u&&w.envDisplayFooter){if(w.footer){w.footer.destroy()}x=w.getFilteredLegalInfos(function(y){return y.env&&y.env.footerDisplay});w.footer=w.buildFooter(f.merge(x,{aboutHandler:w.aboutHandler}));return w.footer.inject(u,v)}},buildFooter:function(v){var x=this,u={acceptedTou:[],acceptedDp:[],acceptedCookies:[],legalInfos:[],aboutHandler:null,others:[]},w=f.merge(v||{},u),y;y=new a({items:x.getFooterItems(w).concat(w.others),legalInfo:w,events:{onClick:x.footerEventHandler}});y.render();x.dropdownEventHandler=x.footerEventHandler.bind(x,y);x.buildDropdowns(y,w);return y},addHelpMenuLegal:function(){var v=this,u=v.getFilteredLegalInfos(function(w){return w});v.addHelpMenuLegalElements(u)},addHelpMenuLegalElements:function(v){var y=this,w=[],B,x,u,z={legalInfos:{label:"legalInfo",nlsLabel:"legalInfo",order:1},acceptedTou:{label:"tou",nlsLabel:"termsOfUse",order:2},acceptedDp:{label:"dp",nlsLabel:"dataPrivacy",order:3},acceptedCookies:{label:"cookie",nlsLabel:"cookies",order:4},others:{order:5}};y.topBarProxyInstance=y.topBarProxyInstance||new r({id:"helpMenu"});function A(D,F){var G=this,C,E=z[D].label;C={file:F[E],envid:F.id,type:E,ressourceType:F.env&&F.env.ressourceType};if(C.type.toLowerCase()==="cookie"&&!C.file){G.displayCookies([F])}else{C&&e.doCheckout(C)}}u=Object.keys(v).sort(function(D,C){return(z[D].order<z[C].order)?(-1):1});u.forEach(function(C){B=v[C]||[];x=z[C].nlsLabel;if(C==="others"&&B.length>0){w.push({label:B[0].text,submenu:[{label:B[1].text,onExecute:function(){window.open(B[1].link)}}]})}else{if(B.length===1){w.push({label:i[x],onExecute:A.bind(y,C,B[0])})}else{if(B.length>1){w.push({label:i[x],submenu:B.map(function(D){return{label:D.type&&(D.type.toLowerCase()!=="cookie")?D.type+" - "+D.name:D.name,onExecute:A.bind(y,C,D)}})})}}}});y.topBarProxyInstance.empty();y.topBarProxyInstance.addContent({help:w})},buildDropdowns:function(A,H){var y=this,x="top left",z="legal-dropdown",B="{name}",w="[name="+B+"] .list-itm-wrap",G={onClick:y.dropdownEventHandler},u=H.acceptedTou,C=H.acceptedDp,E=H.acceptedCookies,D=H.legalInfos,F=1050,v=A.getContent();if(u.length>1){y.touDropdown=new l({position:x,className:z,items:y.getDropdownItems(u),target:v.getElement(w.replace(B,"tou")),zindex:F,events:G})}if(C.length>1){y.dpDropdown=new l({position:x,className:z,items:y.getDropdownItems(C),target:v.getElement(w.replace(B,"dp")),zindex:F,events:G})}if(E.length>1){y.cookieDropdown=new l({position:x,className:z,items:y.getDropdownItems(E),target:v.getElement(w.replace(B,"cookies")),zindex:F,events:G})}if(D.length>1){y.legalInfosDropdown=new l({position:x,className:z,items:y.getDropdownItems(D),target:v.getElement(w.replace(B,"legalinfo")),zindex:F,events:G})}},onFooterItemClick:function(B,z,A){var y=this,v=y.checkOut,u=B.options,w=u.legalInfo,x,C;if(f.is(A,"element")){switch(A.getAttribute("name")){case"tou":if(w.acceptedTou.length>1){return}x=w.acceptedTou[0];C={file:x.tou,envid:x.id,type:"tou",ressourceType:x.env&&x.env.ressourceType};break;case"dp":if(w.acceptedDp.length>1){return}x=w.acceptedDp[0];C={file:x.dp,envid:x.id,type:"dp",ressourceType:x.env&&x.env.ressourceType};break;case"cookies":if(w.acceptedCookies.length>1){return}x=w.acceptedCookies[0];C={file:x.cookie,envid:x.id,type:"cookie",ressourceType:x.env&&x.env.ressourceType};break;case"about":y.aboutHandler&&y.aboutHandler();break;case"legalinfo":if(w.legalInfos.length>1){return}x=w.legalInfos[0];C={file:x.legalInfo,envid:x.id,type:"legalinfo",ressourceType:x.env&&x.env.ressourceType};break}}else{if(A.id&&A.icon){C={file:A.file,envid:A.envid,type:A.type,ressourceType:A.ref&&A.ref.env&&A.ref.env.ressourceType}}}if(C&&C.type&&C.type.toLowerCase()==="cookie"&&!C.file){y.displayCookies([x||A.ref])}else{C&&v.doCheckout(C)}},getFilteredLegalInfos:function(u){var v=this,w;if(v.isTenantTypePresent(v.chineseTenantRegex,v.swymTenants)){w=[{text:v.dsCn,name:"dsCn",clickable:false},{html:'<a target="_blank" href='+v.cnMinistry+">"+v.icpReordal+"</>",name:"icpReordal",text:v.icpReordal,link:v.cnMinistry}]}return f.clone({acceptedTou:v.acceptedTou.filter(u),acceptedDp:v.acceptedDp.filter(u),acceptedCookies:v.acceptedCookies.filter(u),legalInfos:v.legalInfos.filter(u),others:w})},getFooterItems:function(z){var y=this,v=[],x="fonticon-down-open",u=z.legalInfos.length,B=z.acceptedTou.length,A=z.acceptedDp.length,w=z.acceptedCookies.length;if(u>=1){v.push({text:i.legalInfo+" ",name:"legalinfo",icon:u>1?x:null})}if(z.aboutHandler){v.push({text:i.about3DExp+" ",name:"about",handler:y.aboutHandler})}if(B>=1){v.push({text:i.termsOfUse+" ",name:"tou",icon:B>1?x:null})}if(A>=1){v.push({text:i.dataPrivacy+" ",name:"dp",icon:A>1?x:null})}if(w>=1){v.push({text:i.cookies+" ",name:"cookies",icon:w>1?x:null})}return v},getDropdownItems:function(u){return u.map(function(v){return{text:v.type&&(v.type.toLowerCase()!=="cookie")?v.type+" - "+v.name:v.name,icon:"fonticon fonticon-doc-text",ref:v,type:v.type,file:v.tou||v.dp||v.cookie||v.legalInfo,envid:v.id}})},getCurrentLanguage:function(){var x=this,w=x.COOKIE_KEY,v=[];function u(){var y=null,z=document.cookie.split(";");v=z.filter(function(A){return A.toLowerCase().indexOf(w.toLowerCase())>=0});if(v.length>0){y=v[0].split("=")[1]}return y}return u()||window.dsLang||o.Locale.lang},init:function(u){var w=this,v=f.merge(u||{},w.defaultOptions);w.checkOut=e;w.platformAccess=h;w.notifier=k;w.language=w.getCurrentLanguage();w.initUrls(v.myAppsBaseUrl);w.onAccept=v.onAccept;w.onFailure=v.onFailure;w.renderFooter=v.renderFooter;w.footerContainer=v.footerContainer;w.aboutHandler=v.onAboutClick;w.swymTenants=v.swym;w.footerEventHandler=w.onFooterItemClick.bind(w);w.notifier.init(document.body);if(Array.isArray(v.legal)&&Array.isArray(v.swym)){w.onReceivedTos(v.legal,v.swym)}else{w.platformAccess.fetchUserLegal({params:v.tenantId?{platform:v.tenantId}:null,onComplete:function(x){if(w.platformAccess.isResultValid(x)){w.onReceivedTos(x.legal,x.swym)}else{w.notifier.notify(i.errorMsg);w.onFailure()}},onFailure:function(){f.log("Legal: Startup parameters could not be fetched");w.onFailure()}})}}});var s={_legal:null,init:function(u){var v=this;if(!v._legal){v._legal=m.singleton({uninitializedCalls:"throw"});v._legal.init(u)}else{f.log("Legal: bad parameters for Legal module initialization")}},isAccessValid:function(){return !!this._legal.isAccessValid},displayFooter:function(){var u=this._legal;return u.isReady&&u.displayFooter.apply(u,arguments)},fetchAcceptedTerms:function(){var u=this._legal;return u.fetchAcceptedTerms()}};return s});