define("DS/MPFBuyerAddressComponent/BuyerInformationBox",["UWA/Core","UWA/Class/View","i18n!DS/MPFBuyerAddressComponent/assets/nls/BuyerAddressComponent"],function(b,d,c){var a;a=d.extend({className:"mpf-info-box",setup:function(e){this._parent(e)},render:function(){var e;if(this.model._type==="CompanyModel"){e=this._createCompanyInfo()}else{e=this._createPersonInfo()}this.container.setContent(e);return this},_createPersonInfo:function(){var f;var e;e=this.model.getFirstName()+" "+this.model.getLastName();f=this._createEntry(e);return f},_createCompanyInfo:function(){var h;var g;var f;var e;g=this.model.getName();f=this.model.getRegistrationId();h=[this._createEntry(g),this._createEntry(c.get("taxRegistrationId"),e),this._createEntry(c.get("companyRegistrationId"),f)];return h},_createEntry:function(e,h){var g;var f;g=[];if(e){f=b.createElement("span",{"class":"mpf-label",text:e});g.push(f)}if(h){f=b.createElement("span",{"class":"mpf-value",text:h});g.push(f)}return b.createElement("p",{className:"mpf-info-box-item",html:g})}});return a});define("DS/MPFBuyerAddressComponent/BuyerAddressCard",["UWA/Core","UWA/Class/View","css!DS/MPFUI/MPFUI"],function(a,c){var b=c.extend({className:"mpf-address-card",domEvents:{click:"cardClicked"},setup:function(d){this._parent(d);this.buyer=d.buyer;if(!(this.model.get("addressLine0"))){this.model.set("addressLine0",this._getAddressTitle())}},render:function(){var e;var d=this.model;e=["addressLine1","addressLine2","addressLine3","addressLine4","city","county","state","postalCode","country"].map(function(f){return d.get(f)}).filter(function(f){return f&&f.length>0}).map(function(f){return a.createElement("p",{"class":"mpf-address-card-line",text:f})});e.unshift(a.createElement("p",{"class":"mpf-address-card-line title",text:this.model.get("addressLine0")}));this.container.setContent(e);return this},destroy:function(){this.model=null;this._parent();this.container=null},cardClicked:function(){this.dispatchEvent("onSelected",this.model)},_getAddressTitle:function(){var d;if(typeof this.buyer.defaults.registrationId!=="undefined"){d=this.buyer.get("name")}else{d=this.buyer.get("firstName")+" "+this.buyer.get("lastName")}return d}});return b});define("DS/MPFBuyerAddressComponent/BuyerTypeSelectorInput",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Toggle","i18n!DS/MPFBuyerAddressComponent/assets/nls/BuyerAddressComponent"],function(b,d,e,c){var a=d.extend({className:"mpf-buyer-type",setup:function(f){this._parent(f);this.readOnly=f.readOnly===true;this.inputs=[];this.isCompany=typeof this.model.defaults.registrationId!=="undefined";this.selected=this.isCompany?"company":"person"},domEvents:{click:"onClick"},render:function(){var f;var g;this.inputs=[new e({name:"buyerType",value:"person",className:"primary",label:c.get("personAddress"),checked:!this.isCompany,disabled:this.readOnly}),new e({name:"buyerType",value:"company",className:"primary",label:c.get("companyAddress"),checked:this.isCompany,disabled:this.readOnly})];f=b.createElement("label",{"class":"mpf-person",html:[this.inputs[0]]});g=b.createElement("label",{"class":"mpf-company",html:[this.inputs[1]]});this.container.setContent([f,g]);return this},onClick:function(){var f;f=this.getSelectedType();if(f!==this.selected){this.isCompany=f==="company";this.selected=f;this.dispatchEvent("onChange",[this.selected])}},getSelectedType:function(){return this.inputs.filter(function(f){return f.isChecked()}).shift().getValue()},setReadOnly:function(f){this.readOnly=f===true;this.render()},destroy:function(){this.model=null;this._parent();this.container=null}});return a});define("DS/MPFBuyerAddressComponent/BuyerAddressList",["UWA/Core","UWA/Class/View","DS/UIKIT/Scroller","DS/MPFBuyerAddressComponent/BuyerAddressCard"],function(c,e,b,d){var a;a=e.extend({className:"mpf-buyer-address-list",setup:function(f){this._parent(f);this.addressCards=[];this.selectedAddress=null;this.buyer=f.buyer;this.scroller=null;this.isBillingAddress=f.isBillingAddress===true;this.listenTo(this.model,"onChange",this.render.bind(this))},render:function(){var g=this;var f;var h;this._createAddressCards();f=this.addressCards.map(function(i){var j;j=i.render();if(g.selectedAddress&&g.selectedAddress.id===i.model.id){i.container.addClassName("selected")}return j});h=c.createElement("div",{"class":"mpf-address-cards",html:f});this.scroller=new b({element:h});this.container.setContent(this.scroller);return this},getSelectedAddress:function(){return this.selectedAddress},setSelectedAddress:function(g){var f=this.model.get(g);if(f){this.selectedAddress=f;this.addressCards.forEach(function(h){if(h.model.id===f.id){h.container.addClassName("selected")}else{h.container.removeClassName("selected")}});this.dispatchEvent("AddressSelected",f)}},scrollToSelectedAddress:function(){if(this.scroller){this.scroller.scrollToElement(".selected")}},removeClassName:function(f){this.container.removeClassName(f)},addClassName:function(f){this.container.addClassName(f)},size:function(){return this.addressCards.length},_isAddressesPesistedAndOfExpectedType:function(g){var h;var f;if(this.isBillingAddress){f=g.isBillTo()}else{f=g.isShipTo()}h=!(g.isNew());return h&&f},_createAddressCard:function(f){var g;g=new d({model:f,buyer:this.buyer});return g},_listenCardSeleted:function(f){this.listenTo(f,"onSelected",this.setSelectedAddress.bind(this))},_stopListeningCardSelected:function(f){this.stopListening(f,"onSelected")},_createAddressCards:function(){this.addressCards.forEach(this._stopListeningCardSelected.bind(this));this.addressCards=this.model.filter(this._isAddressesPesistedAndOfExpectedType.bind(this)).map(this._createAddressCard.bind(this));this.addressCards.forEach(this._listenCardSeleted.bind(this))}});return a});define("DS/MPFBuyerAddressComponent/BuyerAddressForm",["UWA/Core","UWA/Class/View","UWA/Promise","DS/UIKIT/Mask","DS/MPFBuyerAddressComponent/BuyerTypeSelectorInput","DS/MPFCompanyComponent/CompanyForm","DS/MPFCompanyComponent/CompanyNameForm","DS/MPFPersonComponent/PersonNameForm","DS/MPFAddressFormComponent/AddressFormComponent","DS/MPFBuyer/BuyerType","DS/MPFError/ValidationError"],function(l,a,k,g,e,h,c,d,f,b,m){var n="company";var i="individual";var j=a.extend({className:"mpf-buyer-address-form",setup:function(p){var o;this._parent(p);this.buyer=p.buyer||null;this.buyerType=b.fromModel(this.buyer);this.addressFactory=p.addressFactory;this.buyerTypeLocked=p.buyerTypeLocked===true;this.companyFactory=p.companyFactory;this.countryReadOnly=p.countryReadOnly===true;this.isBillingAddress=p.isBillingAddress===true;this.isCompany=this.buyerType===b.COMPANY;this.authorized=p.authorized===true;this.countries=p.countries;o=this._isBuyerTypeDetermined();if(!(o)&&!(this.isCompany)){this._changeBuyerType(i)}if(!(this.buyerTypeLocked)){this.buyerTypeSelector=new e({model:this.buyer,readOnly:o});this.listenTo(this.buyerTypeSelector,"onChange",this.onBuyerTypeChange)}this.buyerForm=null;this.addressForm=null},render:function(){var o=[];if(this.isCompany){this.buyerForm=this._createCompanyForm(this.buyer,this.isBillingAddress)}else{this.buyerForm=new d({model:this.buyer,readOnly:true,lockSave:true,required:true})}this.addressForm=new f({connector:this.model.dataProxy.connector,constraints:this.model.constraints,countryMode:"buyer",countryReadOnly:this.countryReadOnly,model:this.model,preSetCountry:this.preSetCountry,readOnly:!(this.model.isNew()),hideCountry:this.isCompany&&this.authorized&&this.isBillingAddress});if(!(this.buyerTypeLocked)){o.push(this.buyerTypeSelector.render())}o.push(this.buyerForm.render());o.push(this.addressForm.render());this.container.setContent(o);return this},save:function(){var p=this;var q;var r;var o;g.mask(this.container);r=this.buyerForm.save.bind(this.buyerForm);o=this._saveBillingAddressPromise.bind(this);q=k.all([this._validateBuyerPromise(),this._validateAddressPromise()]).then(r).then(o)["catch"](function(t){var s;s=t instanceof Error?t:new Error("Unable to save buyer or address form");return k.reject(s)})["finally"](function(){g.unmask(p.container)});return q},validate:function(){return this.buyerForm.validate()&&this.addressForm.validate()},onBuyerTypeChange:function(o){this._changeBuyerType(o);this.render()},destroy:function(){this.stopListening();this.model=null;this.buyer=null;this._parent();this.container=null;this.buyerTypeSelector.destroy()},addClassName:function(o){this.container.addClassName(o)},removeClassName:function(o){this.container.removeClassName(o)},clear:function(){if(this.addressForm){this.addressForm.clear()}},_isBuyerTypeDetermined:function(){var p;var o;p=this.buyer.addresses;o=(p.filter(function(q){return !(q.isNew())}).length>0);return this.isCompany||o},_changeBuyerType:function(o){this.isCompany=o===n;if(o===n){this.userBuyer=this.buyer;if(this.isBillingAddress){this.countryReadOnly=true;this.buyer=this.companyFactory.createModel("me",{country:this.model.get("country")})}else{this.countryReadOnly=false;this.buyer=this.companyFactory.createModel("me")}}else{if(this.userBuyer){this.buyer=this.userBuyer;this.countryReadOnly=false}}},_createCompanyForm:function(p,o){var q;if(o&&this.authorized){q=new h({model:p,countries:this.countries})}else{q=new c({model:p,readOnly:!(p.isNew()),required:true})}this.listenTo(p,"onChange:country",this._onChangeCountry.bind(this));return q},_onChangeCountry:function(){this.model.set("country",this.buyer.getCountry())},_validateBuyerPromise:function(){var o=this;return new k(function(q,p){if(o.buyerForm.validate()){q()}else{p(new m("Buyer validation failed"))}})},_validateAddressPromise:function(){var o=this;return new k(function(q,p){if(o.addressForm.validate()){q()}else{p(new m("Unable to save address"))}})},_saveBillingAddressPromise:function(){var o;if(this.addressForm.model.isNew()){if(this.isCompany){o=this.buyer.get("name");this.addressForm.model.dataProxy=this.addressFactory.getDataProxy("companyAddress")}else{o=this.buyer.get("firstName")+" "+this.buyer.get("lastName")}if(this.isBillingAddress){this.addressForm.model.set("isBillTo","TRUE");this.addressForm.model.set("isShipTo","TRUE")}else{this.addressForm.model.set("isShipTo","TRUE")}this.addressForm.model.parentResourceId=this.buyer.id;this.addressForm.model.set("addressLine0",o);return this.addressForm.savePromise()}}});return j});define("DS/MPFBuyerAddressComponent/BuyerAddressBook",["UWA/Core","UWA/Class/View","DS/UIKIT/Modal","DS/UIKIT/Input/Button","DS/UIKIT/Alert","DS/MPFBuyerAddressComponent/BuyerAddressList","DS/MPFBuyerAddressComponent/BuyerAddressForm","DS/MPFBuyer/BuyerType","DS/MPFError/ValidationError","DS/MPFFiniteStateMachine/FiniteStateMachine","i18n!DS/MPFBuyerAddressComponent/assets/nls/BuyerAddressComponent"],function(j,a,h,g,b,c,i,e,l,f,m){var d={};d.CREATION="creation";d.LIST="list";d.SAVING="saving";var k=a.extend({setup:function(n){n||(n={});this._parent(n);this.selectedAddress=null;this.preSetCountry=n.preSetCountry;this.addressFactory=n.addressFactory;this.buyerTypeLocked=n.buyerTypeLocked===true;this.companyFactory=n.companyFactory;this.cartFactory=n.cartFactory;this.cartItemFactory=n.cartItemFactory;this.countryReadOnly=n.countryReadOnly===true;this.isBillingAddress=n.isBillingAddress===true;this.buyer=n.buyer||null;this.buyerType=e.fromModel(this.buyer);this.showSelectButton=n.showSelectButton!==false;this.me=n.me;this.countries=n.countries;this.authorized=this._isAuthorizedToPatchCompany();this.stateMachine=this._createStateMachine();this.alertMessages=new b({closable:true,visible:true,autoHide:false});this.buyerAddressForm=this._createBuyerAddressForm();this.listPageLink=this._createAddressListLink();this.addressList=new c({model:this.model,buyer:this.buyer,isBillingAddress:this.isBillingAddress});this.creationPageLink=this._createAddressCreationLink();this.pages={list:this._renderAddressListPage(),creation:this._renderAddressCreationPage()};this.footer=this._createFooter();this.modal=this._createModal(this.pages,this.footer);if(n.className){this.container.addClassName(n.className)}},render:function(){var n=this.stateMachine.getState();if(n===d.CREATION){this.footer[0].setValue(m.get("save"));this.footer[0].show();this.pages.creation.removeClassName("hidden");this.pages.list.addClassName("hidden")}else{this.footer[0].setValue(m.get("select"));this.pages.creation.addClassName("hidden");this.pages.list.removeClassName("hidden");if(!(this.showSelectButton)){this.footer[0].hide()}}this.container.setContent(this.modal);return this},show:function(){this.modal.show();this._changeActivePage(d.LIST)},hide:function(){if(this.stateMachine.getState()!==d.SAVING){this.modal.hide()}},saveAndOrSelect:function(){var p=this;var o;var n;o=this.stateMachine.getState();if(o===d.CREATION){this.footer[0].load();this.footer[1].setDisabled(true);this.stateMachine.changeState(d.SAVING);this.buyerAddressForm.save().then(function(){p.stateMachine.changeState(d.CREATION);if(p.errorMessageContainer){p.errorMessageContainer.empty()}if(!(p.buyer.get("addressLine0"))){if(typeof p.buyer.defaults.registrationId!=="undefined"){n=p.buyer.get("name")}else{n=p.buyer.get("firstName")+" "+p.buyer.get("lastName")}p.buyerAddressForm.model.set("addressLine0",n)}p.selectedAddress=p.buyerAddressForm.model;p.buyerAddressForm=p._createBuyerAddressForm();p.buyerAddressForm.render();p.pages.creation=p._renderAddressCreationPage();p.dispatchEvent("onSelected",{ok:true,selectedAddress:p.selectedAddress});p.hide();p.render();p.modal.setBody([p.pages.list,p.pages.creation])})["catch"](function(q){p.stateMachine.changeState(d.CREATION);p.dispatchEvent("onSelected",{ok:false});if(!l.prototype.isPrototypeOf(q)){var r;r=q.toString()||m.get("saveAddressError");p.alertMessages.add({className:"error",message:r})}})["finally"](function(){p.footer[0].load(false);p.footer[1].setDisabled(false)})}else{p.selectedAddress=p.addressList.getSelectedAddress();p.dispatchEvent("onSelected",{ok:true,selectedAddress:p.addressList.getSelectedAddress()});p.hide()}},getSelectedAddress:function(){return this.selectedAddress},_createFooter:function(){var n=this;var o;o=[new g({className:"primary",events:{onClick:function(){n.saveAndOrSelect()}},value:m.get("select")}),new g({value:m.get("cancel"),events:{onClick:function(){n.hide()}}})];return o},_renderAddressListPage:function(){var o;var n;n=[];n.push(this.creationPageLink);n.push(this.addressList.render());o=j.createElement("div",{"class":"mpf-page",html:n});return o},_renderAddressCreationPage:function(){var o;var n;n=[];n.push(this.listPageLink);n.push(this.buyerAddressForm.render());o=j.createElement("div",{"class":"mpf-page",html:n});return o},_createAddressCreationLink:function(){var o=this;var n;n=j.createElement("a",{"class":"mpf-link",text:m.get("addAddress"),href:"#",events:{click:function(){o._changeActivePage("creation")}}});return n},_createAddressListLink:function(){var o=this;var n;n=j.createElement("a",{"class":"mpf-link",text:m.get("addressList"),href:"#",events:{click:function(){o._changeActivePage("list")}}});return n},_changeActivePage:function(o){var q;var n;var p;n=this.stateMachine.getState();if((o!==n)&&(this.pages.hasOwnProperty(o))){this.stateMachine.changeState(o);p=this.stateMachine.getState();if(p===d.CREATION){q=this.isBillingAddress?m.get("enterBillingAddress"):m.get("enterShippingAddress");this.footer[0].setValue(m.get("save"));this.footer[0].show();this.pages.creation.removeClassName("hidden");this.pages.list.addClassName("hidden")}else{q=this.isBillingAddress?m.get("selectBillingAddress"):m.get("selectShippingAddress");this.footer[0].setValue(m.get("select"));this.pages.creation.addClassName("hidden");this.pages.list.removeClassName("hidden");if(!(this.showSelectButton)){this.footer[0].hide()}}this.modal.getHeader().getElement("h4").setText(q)}},_createBuyerAddressForm:function(){var n;var o=this.model.create({isShipTo:"TRUE"});if(this.preSetCountry){o.set("country",this.buyer.get("country"))}n=new i({model:o,buyer:this.buyer,addressFactory:this.addressFactory,buyerTypeLocked:this.buyerTypeLocked,companyFactory:this.companyFactory,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory,countryReadOnly:this.countryReadOnly,isBillingAddress:this.isBillingAddress,preSetCountry:this.preSetCountry,authorized:this.authorized,countries:this.countries});return n},_createModal:function(o,s){var q;var n;var r;var p=this.stateMachine.getState();n=[this.alertMessages,o.creation,o.list];if(p===d.CREATION){r=this.isBillingAddress?m.get("enterBillingAddress"):m.get("enterShippingAddress")}else{r=this.isBillingAddress?m.get("selectBillingAddress"):m.get("selectShippingAddress")}q=new h({header:j.createElement("h4",{text:r}),body:n,footer:this.footer,closable:false,events:{onHide:this._onModalHide.bind(this)}});this.alertMessages.getContent().setStyle("visibility","visible");return q},_onModalHide:function(){this.buyerAddressForm.clear()},_createStateMachine:function(){return new f({state:d.LIST,states:[d.CREATION,d.LIST,d.SAVING],transitions:[{from:d.LIST,to:d.CREATION},{from:d.CREATION,to:d.LIST},{from:d.CREATION,to:d.SAVING},{from:d.SAVING,to:d.CREATION}]})},_isAuthorizedToPatchCompany:function(){var p=this;var o;var n=true;if(this.buyerType===e.COMPANY){this.buyerTypeLocked=true;if(this.isBillingAddress){this.countryReadOnly=true;this.preSetCountry=this.buyer.getCountry()}if(this.buyer.getEmpProjectName()!==""&&j.is(this.me)){o=this.me.getRoles();n=o.some(function(q){return q.Role==="Admin"&&q.Project===p.buyer.getEmpProjectName()})}else{n=true}}return n}});return k});