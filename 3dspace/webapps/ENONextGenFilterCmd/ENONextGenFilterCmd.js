define("DS/ENONextGenFilterCmd/commands/ENONextGenFilterCmd",["UWA/Core","DS/Core/PointerEvents","DS/ApplicationFrame/Command","DS/Logger/Logger","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/PlatformAPI/PlatformAPI","DS/WebappsUtils/WebappsUtils","UWA/Promise","i18n!DS/ENONextGenFilterCmd/assets/nls/ENONextGenFilterCmd","DS/Windows/ImmersiveFrame","DS/Windows/Dialog","DS/CollectionView/ResponsiveLargeTilesCollectionView","DS/Controls/ResponsiveTileView","DS/Controls/Button","DS/Tree/TreeDocument","DS/Tree/TreeNodeModel","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/NGFServices","DS/ENOFilterBIUX/FBISettings","DS/Utilities/Utils"],function(s,h,m,u,i,c,e,d,k,p,g,n,a,r,j,o,l,q,f,b){var t=m.extend({getAppParams:function(){u.error("Filter Command ......  The getAppParams() function is not implemented !");var v={};return v},getSelectorManager:function(){u.error("Filter Command ......   The getSelectorManager() function is not implemented !");return undefined},getRoots:function(){var v;return v},getSelection:function(){var v={};return v},init:function(x){this._parent(x,{mode:"exclusive",isAsynchronous:false});this._widget=widget;var C=[];var v=[];var w=arguments[0].arguments;if(Array.isArray(w)&&w.length){var B=w.length;for(var y=0;y<B;y++){C.push(w[y].ID);v.push(w[y].Value)}}this.cmdArgs={id:C,values:v};this._isCmdActivated=false;var A=this.getAppParams();this._appId=A.appId;this._widgetId=A.widgetId;this._SelectorManager=this.getSelectorManager();if(this._SelectorManager){if(this._SelectorManager.onPostAdd&&this._SelectorManager.onPostRemove&&this._SelectorManager.onEmpty){this._SelectorManager.onPostAdd(this._checkSelection.bind(this));this._SelectorManager.onPostRemove(this._checkSelection.bind(this));this._SelectorManager.onEmpty(this._checkSelection.bind(this))}else{u.error("Filter Command ...... One or more of onPostAdd() / onPostRemove() / onEmpty() function is not implemented !")}}this._isConfigAvailable=0;var z=this;q.isConfigAvailable().then(function(D){z._isConfigAvailable=D})},destroy:function(){c.publish("NGFilter.RemoveFilter",{appId:this._appId,widgetId:this._widgetId})},_setFocusToWidget:function(){if(this._widget){this._widget.dispatchEvent("onViewRequest",{focus:true})}},execute:function(){if(!this._isCmdActivated){this._isCmdActivated=true}var z=this._getRootsAndSelection(true);var I=z.context;var x=(I)?I.length:0;if(x){var C=this;var F=false;var v=[];for(var A=0;A<x;A++){v.push(I[A].id);F=(!F&&I[A].label)?false:true}if(F){z.label=[]}var D=e.getWebappsAssetUrl("ENONextGenFilterCmd","icons/32/I_DefaultRootFilterThumbnail.png");var w=["ds6w:label","ds6w:who/ds6w:responsible"];var y=f.getOption("displayRoot_Separator");var E=[];if(F){E=f.getOption("displayRoot_AttributesTitle")||["ds6w:label"]}var H=f.getOption("displayRoot_AttributesLevel1")||[];var G=f.getOption("displayRoot_AttributesLevel2")||[];var B=E.concat(H).concat(G);B=(B.length)?B:w;l.getPredicatesInfosFromIds(v,B,true).then(function(Q){var L=Q.length;for(var O=0;O<x;O++){for(var N=0;N<L;N++){if(I[O].id===Q[N].id){I[O].thumbnail=Q[N].thumbnail||D;I[O].icon=Q[N].icon;var P=[];if(F){I[O].label="";for(var M=0;M<E.length;M++){for(var K=0;K<Q[N].predicates.length;K++){var J=Q[N].predicates[K];if(J.name.endsWith(E[M])){P.push(J.value)}}}if(P.length){I[O].label=P.join(y);z.label.push([I[O].label])}}I[O].values="";P=[];for(var M=0;M<H.length;M++){for(var K=0;K<Q[N].predicates.length;K++){var J=Q[N].predicates[K];if(J.name.endsWith(H[M])){if(J.value&&J.value.length){P.push(J.value);break}}}}if(P.length){I[O].values=P.join(y)}I[O].description="";P=[];for(var M=0;M<G.length;M++){for(var K=0;K<Q[N].predicates.length;K++){var J=Q[N].predicates[K];if(J.name.endsWith(G[M])){P.push(J.value)}}}if(P.length){I[O].description=P.join(y)}}}}if(1===x){C._setSelectionAndUpdateFilter(z);C._openFilterPanel()}else{C._displayAndSelectRoot(I,z.path)}})}},getAvailability:function(){var v=(this._SelectedID)?1:0;return v},getWidgetId:function(){u.error("Filter Command ......  The getWidgetId() function is deprecated !");return undefined},getSelectionId:function(){u.error("Filter Command ...... The getSelectionId() function is deprecated !");var v=[];return v},getSelectedOccurence:function(){u.error("Filter Command ...... The getSelectedOccurence() function is deprecated !");var v={};return v},getCommandState:function(){u.error("Filter Command ...... The isCmdEnable() function is deprecated !");var v=0;return v},removeFilter:function(v){c.publish("NGFilter.RemoveFilter",{appId:this._appId,widgetId:this._widgetId,rootIds:(v)?v.rootIds:undefined})},_checkSelection:b.debounce(function(v){this._selected=this._getRootsAndSelection(false);this._setSelectionAndUpdateFilter(this._selected)},200),_getRootsAndSelection:function(z){var y={};var v=(z)?this.getRoots():undefined;var x=this.getSelection();if(!z){var w=(x.path&&(1===x.path.length&&1===x.path[0].length))?true:false;if(w){v=[{id:x.path[0][0],label:(x.label)?x.label[0][0]:undefined}]}}y={context:v,path:x.path,label:x.label};return y},_setSelectionAndUpdateFilter:function(z){this._SelectedID=undefined;if(z.context||z.path){if((z.context&&z.context.length)){this._SelectedID=z.context[0].id;this._SelectedAlias=(z.label)?z.label[0][0]:undefined;if(this._isCmdActivated){this._setFocusToWidget();this._updateFilterPanel()}}else{if(z.path&&z.path.length){if(this._isCmdActivated){if(z.path&&z.path.length){if(z.label&&z.label.length){var w=z.label[0];var v=w.length;if(v){var x=w[v-1];c.publish("NGFilter.OccPath",{selectedPath:z.path[0],pathAlias:x})}}else{var y=z.path[0];l.getInfosFromIds(y,true).then(function(G){var B=[];var F=y.length;var A=G.length;for(var E=0;E<F;E++){for(var D=0;D<A;D++){if(y[E]===G[D].id){B.push(G[D].label)}}}var C=B.length;c.publish("NGFilter.OccPath",{selectedPath:z.path[0],pathAlias:B[C-1]})},function(A){u.error("Advanced Filter: Error to retrieve labels on selected path !")})}}}}}}},_updateFilterPanel:function(){if(this._appId&&this._widgetId){var v={appId:this._appId,widgetId:this._widgetId,filterId:this._computeFilterId(),rootID:this._SelectedID,rootAlias:this._SelectedAlias,cmdArgs:this.cmdArgs,configUsed:this._isConfigAvailable,widgetTenant:this._getTenantId(),appQueryParam:q.getAppQueryParam()};c.publish("Frame3DXInfra.Update",{type:"Filter",options:v})}},_computeFilterId:function(){var v=this._appId+"_"+this._SelectedID;return v},_getTenantId:function(){var v="OnPremise";if(this._widget){v=this._widget.getValue("x3dPlatformId")||v}return v},_openFilterPanel:function(){c.publish("Frame3DXInfra.Open",{id:"Filter_"+this._computeFilterId()})},_displayAndSelectRoot:function(w,x){var v=this._buildRootTiles(w);var C=new p({identifier:"NGF_RootsToFilter"});C.inject(document.body);var A=this;var z=new g({immersiveFrame:C,width:450,height:225,title:k.get("RootsToFilter"),icon:e.getWebappsAssetUrl("ENONextGenFilterUX","icons/16/I_FilterActiveCriteria.png"),content:v,modalFlag:true,resizableFlag:true,buttons:{Ok:new r({emphasize:"secondary",disabled:true,onClick:A._onOKDialog.bind(A)}),Close:new r({onClick:A._onCloseDialog.bind(A)})}});v.onSelectionAdd(function(D){A._selected=D.options.rootToFilter;z.buttons.Ok.disabled=(A._selected)?false:true});v.onSelectionRemove(function(D){if(0===v.getTreeDocument().getSelectedNodes().length){z.buttons.Ok.disabled=true}});z.addEventListener("close",function(D){A._selected=undefined});var B=this._getRootToSelect(v,x);if(B){B.select(true);if(v.modelProvider){var y=v.modelProvider.getNodeModelRowID(B,true);v.ensureCellVisible(y)}}},_onOKDialog:function(y){var v={context:[this._selected],path:[[this._selected.id]],label:[[this._selected.label]]};this._setSelectionAndUpdateFilter(v);this._openFilterPanel();var x=y.dsModel;var w=x.dialog;w.close()},_onCloseDialog:function(x){var w=x.dsModel;var v=w.dialog;v.close();c.publish("Frame3DXInfra.onPanelClose",{tag:"dataFilterPanel"})},_buildRootTiles:function(x){var w={shouldAcceptDrag:function(){return false}};var y=new j(w);var B=x.length;for(var A=0;A<B;A++){var z=new o({label:x[A].label,subLabel:x[A].values,thumbnail:x[A].thumbnail,icons:[x[A].icon],multipleTitleLineNumber:false,emptyStatusbarVisibleFlag:(x[A].filtered)?true:false,statusbarIcons:(x[A].filtered)?["filter"]:[],rootToFilter:x[A],description:x[A].description});y.addChild(z)}var v=new n({model:y,useDragAndDrop:false,selectionBehavior:{unselectAllOnEmptyArea:true,toggle:true,canMultiSelect:false,canInteractiveMultiselectWithCheckboxClick:false,enableShiftSelection:false,enableFeedbackForActiveCell:false,},});v.model=y;return v},_getRootToSelect:function(B,A){var x;var C="";if(A){var w=A.length;for(var y=0;y<w;y++){var D=A[y];if(D&&D.length){C=(0===y)?D[0]:C;if(C!==D[0]){C="";break}}}}if(C.length){var v=B.getTreeDocument().getChildren();for(var y=0;y<v.length;y++){var z=v[y];if(C===z.options.rootToFilter.id){x=z}}}return x}});return t});