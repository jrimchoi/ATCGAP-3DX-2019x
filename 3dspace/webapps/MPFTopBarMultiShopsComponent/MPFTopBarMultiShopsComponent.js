define("DS/MPFTopBarMultiShopsComponent/TopBarMultiShopsComponent",["UWA/Core","UWA/Promise","UWA/Utils","UWA/Class/View","DS/MPFDataProxy/MarketplaceConnector","DS/MPFModelFactory/MPFFactories","DS/MPFModelFactory/ShopFactory","DS/MPFShopModel/ShopCollection","DS/UIKIT/DropdownMenu","DS/PlatformAPI/PlatformAPI"],function(j,h,e,c,f,g,k,b,a,i){var d;d=c.extend({className:"mpf-shop-selector",setup:function(l){l||(l={});this.shops=null;this.selectedLabId=l.selectedLabId;this.selectedLabName="";this.targetContainer=l.targetContainer;this.onInitCB=l.onInit;this.onRefreshCB=l.onRefresh;this.onSelectionCB=l.onSelection;this.container.setStyles({position:"absolute","text-align":"left"});i.subscribe("newLabSelectedRequest",this.onNewLabSelectedRequest.bind(this));i.subscribe("newLabCreated",this._onNewLabCreated.bind(this));i.publish("topBarMultiShopsReady");this._loadData()},_loadData:function(){var l=this;return f.fetchPromise().then(function(m){try{g.init(m)}catch(n){console.warn(n)}l.shopFactory=g.getFactory(g.types.shop);l.personFactory=g.getFactory(g.types.person);l.me=l.personFactory.createModel("me");l.shops=l.shopFactory.createCollection(k.Types.ME);return h.all([l._fetchShops(),l.me.fetchPromise()])}).then(this._initShop.bind(this))},_isEmpAmdin:function(l){var m;m=e.parseQuery(window.location.search).esid;return l.getRoles().filter(function(n){return n.Role==="Admin"&&n.Project===m}).length>0},_initShop:function(){var l=this;var m;if(this._isEmpAmdin(this.me)&&this.selectedLabId){m=this.shops.get(this.selectedLabId);if(m){this.selectedLabName=m.getName();this._callInitCallBack(m,true)}else{m=this.shopFactory.createModel(k.Types.SHOP,{id:this.selectedLabId});m.fetchPromise({uc2:true}).then(function(){l.selectedLabName=m.getName();l._callInitCallBack(m,true)})}}else{if(!(this.shops.isEmpty())){m=this.shops.get(this.selectedLabId);if(this.shops.size()===1||!(m)){m=this.shops.first();this._setSelectedLab(m.id)}this._callInitCallBack(m)}}},render:function(){var l=this;this.container.setContent();if(this.menu){this.menu.destroy()}this.menu=new a({position:"bottom right",items:this._createItems(),target:this.targetContainer,renderTo:this.container,events:{onClick:function(n,m){if(m.id!==l.selectedLabId){l._setSelectedLab(m.id);i.publish("newLabSelected",{id:l.selectedLabId,text:m.text,from:"TopBarMultiShops"});if(l.onSelectionCB){l.onSelectionCB({id:l.selectedLabId,text:m.text,shopsCount:l.shops.size()})}}}}});this.menu.elements.container.setStyles({"max-height":"80vh","overflow-y":"auto"});return this},setTarget:function(l){this.targetContainer=l;this.container.inject(l,"after")},onNewLabSelectedRequest:function(l){if(l&&(l.from==="CompanyEcosystem")){if(l.id!==this.selectedLabId){this.oldSelectedLabId=this.selectedLabId;this.selectedLabId=l.id;this._initShop()}else{if(l.backToPreviousLab&&j.is(this.oldSelectedLabId)){this.selectedLabId=this.oldSelectedLabId;this.oldSelectedLabId=null;this._initShop()}}}else{this._publishSelectedLab()}},_createItems:function(){var l=this;return this.shops.map(function(o){var m;var n;n=o.id===l.selectedLabId;m={text:o.get("shopName"),id:o.id,selected:n,selectable:!(n)};return m})},_fetchShops:function(){return this.shops.fetchPromise({expand:[]})},_getShopName:function(l){var m;var n;m=this.shops.get(l);n=m!==undefined?m.getName():"";return n},_publishSelectedLab:function(){var l;l=this._getShopName(this.selectedLabId);i.publish("newLabSelected",{id:this.selectedLabId,text:l,from:"TopBarMultiShops"})},_onNewLabCreated:function(m){var l=this;return this._fetchShops().then(function(){l._setSelectedLab(m.id);l._notifyNewLabSelected();l._callRefreshCallBack();l._notifyLabChanged(m.topic)})},_setSelectedLab:function(l){this.selectedLabId=l;this.selectedLabName=this._getShopName(this.selectedLabId)},_notifyNewLabSelected:function(){i.publish("newLabSelected",{id:this.selectedLabId,text:this.selectedLabName,from:"TopBarMultiShops"})},_callInitCallBack:function(n,m){var l;l=m?this.shops.size()||1:this.shops.size();if(this.onInitCB){this.onInitCB({id:n.get("id"),text:n.get("shopName"),shopsCount:l})}},_callRefreshCallBack:function(){if(this.onRefreshCB){this.onRefreshCB({id:this.selectedLabId,text:this.selectedLabName,shopsCount:this.shops.size()})}},_notifyLabChanged:function(l){i.publish(l,{event:"labChanged",target:"service-information"})}});return d});