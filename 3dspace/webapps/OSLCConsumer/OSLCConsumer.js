define("DS/OSLCConsumer/facets/ProxyFacet",["UWA/Core","UWA/Controls/Web","DS/EditPropWidget/facets/Common/FacetsBase","DS/EditPropWidget/constants/EditPropConstants","DS/WAFData/WAFData","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleServicesSettings","DS/UIKIT/Mask","DS/LifecycleServices/XMLDocHelper","UWA/Array","DS/LifecycleServices/OSLCServicesHelper"],function(f,h,k,l,j,e,b,d,g,a,c){var i=k.extend({init:function(){this._parent.apply(this,arguments);if(!this.elements.container){this.elements.container=f.createElement("div",{styles:{height:"100%"},"class":"proxy_container"});this.elements.myControl=new f.Controls.Web({url:"",height:"100%"});this.elements.myControl.setIFrameHeight("100%");this.elements.myControl.elements.container.style.height="100%";this.elements.myControl.inject(this.elements.container)}},onError:function(m){console.log(m)},updateFacet:function(){var n=this,m;d.mask(this.elements.container);b.app_initialization(function(){m=n.getModel();if(m){e.getOslcConfigPromise().then(function(p){var o="/resources/v1/modeler/e6wproxy/"+m._attributes.objectId;e.get(m._attributes.tenant,o,{},function(t){var q=a.detect(p.repositories,function(v){return v.id===t.data[0].dataelements.Proxy_Service}),r=t.data[0].dataelements.Proxy_URL,u=t.data[0].dataelements.Proxy_Modified,s=t.data[0].type;if(q&&r){d.unmask(n.elements.container);c.getProxyObjectExternalDetails({tenantId:m._attributes.tenant,proxyService:q.id,OSLCResource:q.rootUrl+r,proxyType:s,repositoryRootURL:q.rootUrl,onSuccess:function(w){var x=new Date(u),v=new Date(w.dataelements.Proxy_Modified);x.setMilliseconds(0);v.setMilliseconds(0);if(x.getTime()<v.getTime()){c.updateProxyObject({tenantId:m._attributes.tenant,data:{data:[w]},onSuccess:function(y){widget.dispatchEvent("onRefresh")},onError:n.onError})}e.oslcRequest(m._attributes.tenant,q.id,q.rootUrl+r,{method:"GET",headers:{Accept:"application/x-oslc-compact+xml"},onSuccess:function(y){var A=false;if(typeof y==="string"){var D=g.loadXMLDoc(y);if(typeof D==="object"){var z=g.filterDescendants([D],{tag:"oslc:largePreview"});(!z.length)&&(z=g.filterDescendants([D],{tag:"oslc:smallPreview"}));if(z.length===1){var C=g.filterDescendants(z,{tag:"oslc:document"});if(C.length===1){var B=g.getNodeInfo(C[0]);var E=B.attrList["rdf:resource"];if(typeof E==="string"){e.oslcRequest(m._attributes.tenant,q.id,E,{method:"GET",headers:{Accept:"text/html,text/*",},timeout:1000*60*60*24,onSuccess:function(F){n.elements.myControl.getIFrame().contentDocument.open();n.elements.myControl.getIFrame().contentDocument.write(F);n.elements.myControl.getIFrame().contentDocument.close()},onError:n.onError,onTimeout:function(F){console.log(F)},})}}}}}},onError:n.onError})},onError:n.onError})}},n.onError)},n.onError)}})},destroyComponent:function(){if(f.is(this.destroy,"function")){this.destroy()}}});return i});define("DS/OSLCConsumer/OSLCConsumer",["UWA/Core","css!DS/OSLCConsumer/OSLCConsumer","UWA/Controls/Abstract","UWA/Controls/Web","i18n!DS/OSLCConsumer/assets/nls/OSLCConsumerNls","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","DS/LifecycleServices/LifecycleServices","i18n!DS/LifecycleServices/assets/nls/LifecycleServicesNls","DS/LifecycleServices/LifecycleServicesSettings","DS/LifecycleServices/OSLCServicesHelper","DS/LifecycleServices/XMLDocHelper","DS/WAFData/WAFData","DS/LifecycleControls/CommandDialog","DS/Controls/ComboBox","DS/UIKIT/SuperModal","DS/UIKIT/Mask","DS/UIKIT/Scroller"],function(f,k,m,i,e,d,a,n,o,j,c,b,h,q,l,r,p){q.implement({_showPopup:function(){this._previous();this.elements.popup.elements.container.addClassName("oslc-combobox-popup")}});var g=m.extend({iframeContainer:{},context:null,oslc_repository_combo:null,oslc_repository_list:null,oslc_provider_combo:null,oslc_provider_list:null,init_options:null,init:function(s){this.init_options=s;console.log("this.init_options:");console.log(this.init_options);this._parent(s);this.oslc_repository_list=[];this.oslc_provider_list=[]},executeCmd:function(t,s,v){var u=this;this.context=s.context;this.addEvent("onReady",function(){r.unmask(document.body);this._showCommandUI(t)},this);this.addEvent("onComplete",function(){u._removeOslcEventListener();v()});r.mask(document.body);this._addOslcEventListener();this._loadOslcData()},_onComplete:function(){this.dispatchEvent("onComplete",{})},_destroyDialog:function(){this.cmdDlg.destroy();this._onComplete();this.dispatchEvent("onClose")},_addOslcEventListener:function(){var s=this;this.onOslcResultsMessage=function(v){var w="oslc-response:";if(v.data.startsWith(w)){var t=JSON.parse(v.data.substring(w.length));var u=t["oslc:results"];console.log(u);s._processOslcResults(u)}};window.addEventListener("message",this.onOslcResultsMessage,false)},_removeOslcEventListener:function(){window.removeEventListener("message",this.onOslcResultsMessage,false)},_showCommandUI:function(){var u=this;this.content=document.createElement("div");this.content.className="oslc_popup";var t=this;this.cmdDlg=new h();var v=f.createElement("div",{styles:{width:"100%",height:"100%",overflow:"auto"}});this.dlg=this.cmdDlg.create(v,{title:this.init_options.title,closeButton:true,resizable:true,buttonStyle:this.cmdDlg.buttonStyle.none,onClose:function(){t._onComplete();if(typeof u.init_options.notification==="function"){u.init_options.notification({objects:[]})}},events:{onShow:function(){f.extendElement(u.content).inject(v)}}});this._createDropdownLists();this.iframeContainer=f.createElement("div",{"class":"oslc-iframe"});this.iframeContainer.inject(this.content);this.dlg.inject(document.body);var s=this._computeDialogSize();this.dlg.setNewSize(s);f.extendElement(this.content).setStyle("height",s.bodyHeight.toString()+"px");if(this.oslc_provider_list.length>0){this.displayContentFromUrl(u.oslc_provider_combo.currentValue.url+"#oslc-core-postMessage-1.0",function(){r.unmask(u.iframeContainer)});r.mask(this.iframeContainer)}},_loadOslcData:function(){var s=this;a.getOslcConfigPromise().then(function(u){s.oslc_repository_list.length=0;u.repositories.forEach(function(v){if(v.domain===s.init_options.providerFilter){s.oslc_repository_list.push({labelItem:v.title,valueItem:v})}});var t=function(){s.dispatchEvent("onReady",{})};if(s.oslc_repository_list.length>0){s._loadProviders(s.oslc_repository_list[0].valueItem,t)}else{t()}},function(t){r.unmask(document.body);s.showError(t);s._onComplete();if(typeof s.init_options.notification==="function"){s.init_options.notification({objects:[],error:t})}})},_loadProviders:function(t,w){var u=this;this.oslc_provider_list.length=0;var v={Accept:"application/rdf+xml"};if(t["OSLC-Core-Version"]){v["OSLC-Core-Version"]=t["OSLC-Core-Version"]}if(t.catalogUrl!==""){a.oslcRequest(this.init_options.tenantId,t.id,t.catalogUrl,{method:"GET",headers:v,onSuccess:function(x){var y=new j.ProjectAreaCatalog(x);u._loadProviderDetails(t,y.serviceProviderList,0,w)},onError:function(x){if(x===n.authorizationRequired){if(r.isMasked(document.body)){r.unmask(document.body)}}else{u.showError(x)}}})}else{if(t.serviceUrl!==""){var s=[{url:t.serviceUrl,details:"/",title:t.title}];u._loadProviderDetails(t,s,0,w)}else{w()}}},_loadProviderDetails:function(u,t,s,y){var v=this;if(s===t.length){y();return}var x={Accept:"application/rdf+xml"};if(u["OSLC-Core-Version"]){x["OSLC-Core-Version"]=u["OSLC-Core-Version"]}var w=t[s];a.oslcRequest(v.init_options.tenantId,u.id,w.url,{method:"GET",headers:x,onSuccess:function(F){var E=new j.ServiceProvider(F);var H=w.details.substring(w.details.lastIndexOf("/")+1);var G;if(v.init_options.operation==="creationDialog"){G=E.operationTypes.CREATION_DIALOG}else{if(v.init_options.operation==="selectionDialog"){G=E.operationTypes.SELECTION_DIALOG}else{throw Error("OSLCConsumer._loadProviderDetails: Unexpected OSLC operation input parameter: "+v.init_options.operation)}}var z=u.defaultServices;if(v.init_options.defaultServices===true){z=true}var C=E.getServiceDetails(H,G,v.init_options.resourceType,z);if(C.length>0){var D=C[0];if("oslc:dialog" in D){var A=D["oslc:dialog"].attrList["rdf:resource"];var I=D["oslc:hintHeight"].text;var B=D["oslc:hintWidth"].text;v.oslc_provider_list.push({labelItem:w.title,valueItem:{url:A,height:I,width:B}})}}if(C.length>1){}v._loadProviderDetails(u,t,++s,y)},onError:function(z){v.showError(z)}})},_computeDialogSize:function(){var v=0;var u=0;if(this.oslc_provider_list.length>0){this.oslc_provider_list.forEach(function(z){var y=parseInt(z.valueItem.height,10);var x=parseInt(z.valueItem.width,10);if(y>v){v=y}if(x>u){u=x}})}var s=Math.max(v+54,120);var t=Math.max(u+30,400);return{height:s+54,width:t,bodyHeight:s}},_createDropdownLists:function(){var s=this;var t=f.createElement("div").inject(this.content);f.createElement("label",{"class":"oslc-dropdown-list-label",text:e.selectRepository}).inject(t);this.oslc_repository_combo=new q({elementsList:this.oslc_repository_list,selectedIndex:0}).inject(t);this.oslc_repository_combo.addEventListener("change",function(){r.mask(s.dlg.elements.body);s._loadProviders(s.oslc_repository_combo.currentValue,function(){s._createProviderComboBox();if(s.oslc_provider_list.length>0){var u=s._computeDialogSize();s.dlg.setNewSize(u);f.extendElement(s.content).setStyle("height",u.bodyHeight.toString()+"px");s.dlg.centerIt();s.displayContentFromUrl(s.oslc_provider_combo.currentValue.url+"#oslc-core-postMessage-1.0",function(){r.unmask(s.dlg.elements.body)})}else{s.iframeContainer.empty();r.unmask(s.dlg.elements.body)}})});this.providerDropdownListRow=f.createElement("div").inject(this.content);f.createElement("label",{"class":"oslc-dropdown-list-label",text:e.selectProvider}).inject(this.providerDropdownListRow);this._createProviderComboBox()},_createProviderComboBox:function(){var s=this;if(this.oslc_provider_combo){this.oslc_provider_combo.destroy()}this.oslc_provider_combo=new q({elementsList:this.oslc_provider_list,selectedIndex:0}).inject(this.providerDropdownListRow);this.oslc_provider_combo.addEventListener("change",function(){s.displayContentFromUrl(s.oslc_provider_combo.currentValue.url+"#oslc-core-postMessage-1.0",function(){r.unmask(s.iframeContainer)});r.mask(s.iframeContainer)})},_processOslcResults:function(s){if(s.length===0){this._destroyDialog();if(typeof this.init_options.notification==="function"){this.init_options.notification({objects:[]})}return}if(this.init_options.singleObject&&s.length>1){var t=new l({className:"oslc-supermodal",renderTo:document.body});t.alert(e.selectSingleObject);return}var u={data:[]};r.mask(this.dlg.elements.body,e.processing);this._loadOslcResultDetails(u,s,0)},_loadOslcResultDetails:function(w,u,v,A){var z=this;if(v===u.length){this._updateProxyObject(w);return}var t=A;if(typeof t!=="object"){t=this.oslc_repository_combo.currentValue}var y=t.id;var B=u[v];var s=this.init_options.tenantId;var x=this.init_options.proxyType;j.getProxyObjectExternalDetails({tenantId:s,proxyService:y,proxyType:x,OSLCResource:B["rdf:resource"],repositoryRootURL:t.rootUrl,onSuccess:function(C){w.data.push(C);z._loadOslcResultDetails(w,u,++v,t)},onError:z.showError})},_updateProxyObject:function(v){var t=this;var x=function(){r.unmask(t.dlg.elements.body);t._destroyDialog()};var w=function(z){console.log("proxyServiceRequest: COMPLETED");console.log(z);x();var y={objects:[]};z.data.forEach(function(A){y.objects.push({oslc:"oslc RDF+XML",proxy:A})});if(typeof t.init_options.notification==="function"){t.init_options.notification(y)}};var s=function(z,A){x();var y=a.parseWebServiceError(z,A);t.showError(y);console.log("Failed to retrieve data from the server");if(typeof t.init_options.notification==="function"){t.init_options.notification({objects:[],error:y})}};var u=function(){x();t.showError(d.timeout);console.log("Timeout error");if(typeof t.init_options.notification==="function"){t.init_options.notification({objects:[],error:d.timeout})}};j.updateProxyObject({tenantId:this.init_options.tenantId,data:v,onSuccess:w,onError:s})},displayContentFromUrl:function(s,t){this.iframeContainer.empty();new i({url:s,className:"oslc-web-control",events:{onLoad:function(){t()}}}).inject(this.iframeContainer)},showNotification:function(s,u){if(typeof this.context.displayNotification==="function"){var t={eventID:((typeof u==="string")?u:"primary"),msg:s};this.context.displayNotification(t)}else{alert(s)}},showError:function(t){if(typeof this.context.displayNotification==="function"){var s={eventID:"warning",msg:t};this.context.displayNotification(s)}else{alert(t)}}});return g});