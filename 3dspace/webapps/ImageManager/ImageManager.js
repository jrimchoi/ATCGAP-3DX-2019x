define("DS/ImageManager/SortManager",[],function(){return{alphaAsc:function g(h){localStorage.setItem("sort","alphaAsc");return h.sort(function(j,i){return j.options.label.localeCompare(i.options.label.toLocaleLowerCase())})},alphaDesc:function b(h){localStorage.setItem("sort","alphaDesc");return h.sort(function(j,i){return i.options.label.localeCompare(j.options.label.toLocaleLowerCase())})},dateAtoB:function d(h){localStorage.setItem("sort","dateAtoB");return h.sort(function(j,i){return new Date(j.options.propertiesList[0])-new Date(i.options.propertiesList[0])})},dateBtoA:function a(h){localStorage.setItem("sort","dateBtoA");return h.sort(function(i,j){return new Date(j.options.propertiesList[0])-new Date(i.options.propertiesList[0])})},sizeAsc:function c(h){localStorage.setItem("sort","sizeAsc");var i=this;return h.sort(function(k,j){return i._formatSizes(k.options.propertiesList[1])-i._formatSizes(j.options.propertiesList[1])})},sizeDesc:function f(h){localStorage.setItem("sort","sizeDesc");var i=this;return h.sort(function(j,k){return i._formatSizes(k.options.propertiesList[1])-i._formatSizes(j.options.propertiesList[1])})},_formatSizes:function e(h){switch(h.match(/[A-z]*$/)[0]){case"MB":return parseFloat(h.match(/^[0-9].[0-9]*/)[0])*1000000;case"KB":return parseFloat(h.match(/^[0-9].[0-9]*/)[0])*1000}}}});define("DS/ImageManager/SortView",["UWA/Core","UWA/Class/Debug","UWA/Controls/Abstract","DS/WebappsUtils/Performance","i18n!DS/ImageManager/assets/nls/imageManager","DS/UIKIT/Iconbar"],function(e,d,b,c,g,a){var f=b.extend(d,{_view:null,_container:null,_body:null,_defaultItem:[{dataIndex:"size",type:"num",nlsName:g.get("sort_size")},{dataIndex:"title",type:"alpha",nlsName:g.get("sort_title")},{dataIndex:"date",type:"num",nlsName:g.get("sort_date")},],_default_sort:{dataIndex:"date",order:"desc",type:"alpha"},_listItemExtend:[],_activedItem:"",_activedItemId:"",_activedItemOrder:"",_menuIcon:"",init:function(h){this._parent(h);var i=this;if(h&&h.container){this._container=h.container;this.options=h;if(!h.defaultSort){this.options.defaultSort=this._default_sort}i._setByDefaultSort();i.render()}},render:function(h){var i=this;this._view=new a({renderTo:i._container,styles:{padding:"0px",marginBottom:"0px",height:"45px",},events:{onClick:function(j){if(i.getDropdown()){i.getDropdown().elements.container.setHTML("");i.getDropdown().setBody(i._getBody())}else{setTimeout(function(){i.getDropdown().elements.container.setHTML("");i.getDropdown().setBody(i._getBody());i.updateStateInPanel()},50)}i.updateStateInPanel()}},items:[{fonticon:i._menuIcon?i._menuIcon:i._getIconByTypeAndOrder("alpha","asc"),text:g.get("sortMenuLabel"),content:{type:"dropdown",tag:"ul",options:{className:"dropdown-menu dropdown-menu-root dropdown dropdown-root",events:{onClick:function(k){var j=k.target||k.srcElement;if(j.id){i._activedItemId=j.id;i._activedItem=j.getAttribute("dataIndex");i._activedItemOrder=j.getAttribute("order");i._menuIcon=j.className;this.options.target.children[0].className=j.className;if(i.options.onClick&&i.options.onClick instanceof Function){i.options.onClick({dataIndex:i._activedItem,order:i._activedItemOrder,})}}}},body:this._getBody()}}}]})},updateStateInPanel:function(){if(this.getDropdown()){var m=this.getDropdown().elements.container.children[0].children;for(var k=0;k<m.length;k++){var l=m[k].children[1].children;for(var h=0;h<l.length;h++){l[h].removeClassName("sortActived");if(l[h].id===this._activedItemId){l[h].addClassName("sortActived")}}}}},updateMenu:function(){this._hide();this._i=this._i?this._i+1:1;var h=this;setTimeout(function(){if(h._i!==0){h._i=0;h.getDropdown()&&h.getDropdown().setBody(h._getBody())}},1000)},reinitMenu:function(){this._hide();if(this._view){}this.emptyItemExtend();this._setByDefaultSort();this.getDropdown()&&this.getDropdown().setBody(this._getBody())},getDropdown:function(){if(this._view){return this._view.menu.getItem(0).content.component}},_hide:function(){if(this.getDropdown()){this.getDropdown().hide()}},_getBody:function(){var h=this;this._body={html:[]};this._initDefaultItems();this._addFromListExtend();return this._body},addItemExtend:function(i){var k=this._listItemExtend.map(function(l){return l.dataIndex});var h=[];var j=Array.isArray(i)?i:[i];j.forEach(function(l){if(k.indexOf(l.dataIndex)===-1){h.push(l)}});this._listItemExtend=this._listItemExtend.concat(h)},removeItemExtend:function(j){var k=this._listItemExtend.map(function(l){return l.dataIndex});var i=[];var h=Array.isArray(j)?j:[j];h.forEach(function(m,l){if(k.indexOf(m.dataIndex)!==-1){i.push(m.dataIndex)}});this._listItemExtend=this._listItemExtend.filter(function(l){return i.indexOf(l.dataIndex)===-1})},emptyItemExtend:function(){this._listItemExtend=[]},_setByDefaultSort:function(){if(this.options.defaultSort&&this.options.defaultSort.dataIndex&&this.options.defaultSort.order){this._activedItemId=this.options.defaultSort.dataIndex+"-"+this.options.defaultSort.order;this._activedItem=this.options.defaultSort.dataIndex;this._activedItemOrder=this.options.defaultSort.order;this._menuIcon=this._getIconByTypeAndOrder(this.options.defaultSort.type,this.options.defaultSort.order)}},_setOrder:function(i,j,h){this._activedItemId=this._getIdByTypeIndexAndOrder(j,i,h);this._activedItem=i;this._activedItemOrder=this.options.defaultSort.order;this._menuIcon=this._getIconByTypeAndOrder(j,h);if(this._view&&this._view.elements.container&&this._view.elements.container.children[0]&&this._view.elements.container.children[0].children[0]&&this._view.elements.container.children[0].children[0].children[0]){this._view.elements.container.children[0].children[0].children[0].className=this._menuIcon}this._hide()},setOrderByExt:function(j){this._hide();var i=this;if(j.order_field&&j.order_by){var h=this._defaultItem.filter(function(k){if(k.dataIndex.indexOf("/")!==-1){return k.dataIndex.split("/")[1]===j.order_field}else{return k.dataIndex===j.order_field}});h=h?h[0]:"";if(h){this._setOrder(h.dataIndex,h.type,j.order_by)}}},_addFromListExtend:function(){var h=this;var i=this._defaultItem.map(function(j){return j.dataIndex});this._listItemExtend.forEach(function(j){if(i.indexOf(j.dataIndex)===-1){h._addItem(j.dataIndex,j.type,j.nlsName)}})},_addItem:function(i,j,h){var k={tag:"li","class":"item item-template sortPanelRow",html:[{tag:"span","class":"item-text",text:h},{tag:"div","class":"item-text item-icon-group",html:[]}]};switch(j){case"alpha":k.html[1].html=[{tag:"span",title:g.get("tooltip_SortAsc"),id:i+"-asc",order:"asc",dataIndex:i,"class":this._getIconByTypeAndOrder(j,"asc")},{tag:"span",title:g.get("tooltip_SortDesc"),id:i+"-desc",order:"desc",dataIndex:i,"class":this._getIconByTypeAndOrder(j,"desc")}];break;case"num":k.html[1].html=[{tag:"span",title:g.get("tooltip_SortAsc"),id:i+"-asc",order:"asc",dataIndex:i,"class":this._getIconByTypeAndOrder(j,"asc")},{tag:"span",title:g.get("tooltip_SortDesc"),id:i+"-desc",order:"desc",dataIndex:i,"class":this._getIconByTypeAndOrder(j,"desc")}];break;case"group":k.html[1].html=[{tag:"span",title:g.get("tooltip_SortGroup"),id:i+"-group",order:"asc",dataIndex:i,"class":this._getIconByTypeAndOrder(j,"asc")}];break;default:k.html[1].html=[{tag:"span",title:g.get("tooltip_SortAsc"),id:i+"-asc",order:"asc",dataIndex:i,"class":this._getIconByTypeAndOrder(j,"asc")},{tag:"span",title:g.get("tooltip_SortDesc"),id:i+"-desc",order:"desc",dataIndex:i,"class":this._getIconByTypeAndOrder(j,"desc")}]}if(this._body&&this._body.html){this._body.html.push(k)}},_getIconByTypeAndOrder:function(i,h){switch(i){case"alpha":return"fonticon fonticon-sort-alpha-"+h;case"num":return"fonticon fonticon-sort-num-"+h;case"group":return"fonticon fonticon-tag-sorting";default:if(h){return"fonticon fonticon-sort-alpha-"+h}else{return"fonticon fonticon-sort-alpha-asc"}}},_getIdByTypeIndexAndOrder:function(j,i,h){switch(j){case"group":return i+"-group";default:return i+"-"+h}},_initDefaultItems:function(){var i=this;var j=[];var h=j.concat(this._defaultItem);h.forEach(function(k){i._addItem(k.dataIndex,k.type,k.nlsName)})},destroy:function(){if(e.is(this._view)&&e.is(this._view.destroy,"function")){this._view.destroy();delete this._view}this._parent()}});return f});define("DS/ImageManager/ImageManager",["UWA/Core","UWA/Controls/Abstract","DS/UIKIT/Alert","DS/UIKIT/Input/File","DS/UIKIT/Input/Text","DS/UIKIT/Mask","DS/UIKIT/Form","DS/WAFData/WAFData","DS/WidgetServices/securityContextServices/SecurityContextServices","DS/WidgetServices/WidgetServices","DS/ErrorWidget/ErrorWidget","DS/UIKIT/SuperModal","DS/Tree/TreeDocument","DS/Tree/TreeNodeModel","DS/CollectionView/ResponsiveThumbnailsCollectionView","DS/CollectionView/ResponsiveTilesCollectionView","DS/UIKIT/IconDropdown","DS/UIKIT/Tooltip","DS/Windows/Dialog","DS/Controls/Button","DS/Windows/ImmersiveFrame","DS/ImageManager/SortManager","DS/ImageManager/SortView","DS/UIKIT/Input/Button","DS/UIKIT/Iconbar","DS/UIKIT/Modal","i18n!DS/ImageManager/assets/nls/imageManager","css!DS/UIKIT/UIKIT","css!DS/ImageManager/ImageManager"],function(e,w,i,d,x,B,g,c,k,q,z,v,l,r,u,j,h,y,f,s,p,A,t,n,a,b,m){var o=function(E){var D={};if(E){var C=E.options;if(C){D.url=C.thumbnail;D.name=C.name}}return D};return w.extend({currentView:"",_defaultView:"thumbnail",init:function(C){if(C.modelId){this._parent(C);this._modelId=C.modelId;if(C.tenantId){this._tenantId=C.tenantId}this._currentRequest={number:0,handler:null}}else{throw new Error(m.SubmitModelId)}this.currentView=this._defaultView},getModelId:function(){return this._modelId},onDeleteKeyPressed:function(C){this._prepareImageDeletion(C)},_buildGrid:function(F){var D=this;this.currentView=F||this.currentView;F=this.currentView;var E={height:"inherit",displayedOptionalCellProperties:["All"],selectionBehavior:{canMultiSelect:true,canInteractiveMultiselectWithCheckboxClick:true,enableShiftSelection:true,toggle:true}};var C;if(F==="tile"){C=this.elements.tile=new j(E)}else{if(F==="thumbnail"){C=this.elements.thumbnail=new u(E)}}C.onDeleteKeyPressed(D.onDeleteKeyPressed.bind(D));C.onContextualEvent={callback:function(H){var G=[];if(H&&H.cellInfos){if(H.cellInfos.cellModel){H.cellInfos.cellModel.getTreeDocument();G.push({type:"PushItem",title:m["Display image"],fonticon:{family:"entypo",content:"fonticon-eye"},action:{callback:function(){D.displayImage(H.cellInfos.cellID)}}});if(D.accessRight&&!H.cellInfos.nodeModel.options.primaryImage){G.push({type:"PushItem",title:m["Set Primary"],fonticon:{family:"entypo",content:"fonticon-favorite-on"},action:{callback:function(){D.setAsPrimaryImage(H.cellInfos.nodeModel.options.name).then(function(){D._changePrimaryImageAttributes(H.cellInfos.nodeModel._id)})}}})}G.push({type:"PushItem",title:m["Download Image"],fonticon:{family:"entypo",content:"fonticon-download"},action:{callback:function(){D._downloadImage(H.cellInfos.nodeModel)}}});G.push({type:"SeparatorItem"});if(D.accessRight){G.push({type:"PushItem",title:m["Delete image"],action:{callback:function(){D._prepareImageDeletion(H.cellInfos.nodeModel)}},fonticon:{family:"entypo",content:"fonticon-trash"}})}}}return G}};this.treeDocument=this.treeDocument||new l({useAsyncPreExpand:true});C.model=this.treeDocument;this.elements.gridContainer=this.elements.gridContainer||e.createElement("div",{"class":"imageManagerGrid"});this.elements.gridContainer.inject(this.elements.container);C.getContent().inject(this.elements.gridContainer);C.onStatusbarIconPointerDown=function(G){var I=G.cellInfos;var H=G.clickedIconIndex;switch(H){case 0:D.displayImage(I.cellID);break;case 1:D.setAsPrimaryImage(I.nodeModel.options.name).then(function(){D._changePrimaryImageAttributes(G.cellInfos.nodeModel._id)});break;case 2:D._downloadImage(I.nodeModel);break;case 3:D._prepareImageDeletion(I.nodeModel);break}}},getFileExtension:function(C){return C.split(".").pop()},_uploadFiles:function(G){var F=this;var D=[];if(G.target.files&&G.target.files.length>0){Array.prototype.forEach.call(G.target.files,function(H){D.push(H.name)})}var C=F._checkImagesExist(D);var E=Array.from(G.target.files);Array.from(G.target.files).forEach(function(H){if(C.indexOf(H.name)!==-1){F.elements.notificationManager.addWarning(m.replace(m.get("fileAlreadyExists"),{objName:H.name}));E.splice(E.indexOf(E.filter(function(I){return I.name===H.name})[0]),1);if(G.target.files.length===1){B.unmask(F.elements.container)}}});B.mask(F.elements.container);F.fetchTypes().then(function(H){Array.from(E).forEach(function(I){if(H.indexOf(F.getFileExtension(I.name))===-1){E.splice(E.indexOf(I),1);F.elements.notificationManager.addError(m.replace(m.get("InvalidFileType"),{filename:I.name,types:H}))}});if(E.length===0){B.unmask(F.elements.container)}F.uploadImages(E).then(function(I){B.unmask(F.elements.container);if(I.success===false){F.elements.notificationManager.addError(I.message)}else{F.elements.browseFile.value="";I.forEach(function(J){F._getImageFromServerAnswer(J,function(){F._addImageToCollection(this,F.treeDocument.getAllDescendants().length===0?true:false);if(F.elements.container.querySelector(".drop-component")){F.elements.container.querySelector(".imageManagerGrid").removeChild(F.elements.container.querySelector(".drop-component"))}})})}})["catch"](function(I){B.unmask(F.elements.container);F._onFailure.apply(F,arguments)})})["catch"](function(H){F._onFailure.apply(F,arguments)})},_buildToolbar:function(){var G;var F;var H;var E=this;var D=e.createElement("div",{"class":"toolbar",styles:{top:0,height:"auto",padding:"10px",width:"100%",backgroundColor:"white","text-align":"right",display:"flex"}}).inject(this.elements.container);var C=e.createElement("img",{id:"imagePreview",styles:{height:"38px",margin:"0 10px",border:"none"}}).inject(D);this.elements.browseFile=new d({input:false,multiple:true,events:{onChange:function(L){G.enable();var K=L.target.files;F.setValue(Array.from(K).map(function(M){return M.name}));var J=Array.from(K).map(function(M){return M.name});E.elements.inputTooltip.setBody(J.toString().replace(/,/g," \n"));F.getContent().setAttribute("readonly",true);F.setValue(J);var I=new FileReader();I.readAsDataURL(K[0]);I.onload=function(){document.querySelector("#imagePreview").setAttribute("src",I.result)};G["data-target"]=L;G.warning=Array.from(K).filter(function(M){return M.size>=5000000});I.onerror=function(M){E.elements.notificationManager.addError(M)}}}}).inject(D);H=e.createElement("div",{id:"inputContainer",styles:{width:"100%"}}).inject(D);F=new x({placeholder:m.PickOrCopy,attributes:{events:{change:function(I){if(I.target.value){document.querySelector("#imagePreview").setAttribute("src",I.target.value);G.enable()}else{document.querySelector("#imagePreview").removeAttribute("src");G.disable()}}}}}).inject(H);this.elements.inputTooltip=new y({position:"top",target:F.getContent(),body:F.getValue()});G=new n({icon:"upload",className:"validate-input",attributes:{title:m.uploadImage},events:{onClick:function(){var J;var K=this;if(q.isReplayedODT()&&this.elements.input.getAttribute("data-target")){var I=JSON.parse(this.elements.input.getAttribute("data-target")).e}if(this["data-target"]||I){if(this.warning.length>0||this.elements.input.getAttribute("data-target")&&JSON.parse(this.elements.input.getAttribute("data-target")).warning.length>0){J=new b({className:"site-reset",closable:true,header:"<h4>"+m.Validate+"</h4>",body:m.moreThan5MB+"<br/><code>"+(this.warning||JSON.parse(this.elements.input.getAttribute("data-target"))).map(function(L){return L.name+" - "+E._formatImageWeight(L.size)}).toString()+"</code>",footer:'<button type="button" class="btn btn-primary btn-submit-warn">'+m.Confirm+'</button> <button type="button" class="btn btn-default btn-cancel-warn">'+m.Cancel+"</button>"}).inject(E.elements.container).show();J.getContent().getElements(".btn-submit-warn").forEach(function(L){L.addEvent("click",function(){J.destroy();E._uploadFiles(K["data-target"]||I);delete K["data-target"];if(q.isReplayedODT()){this.elements.input.removeAttribute("data-target")}F.setValue(null);C.removeAttribute("src")})});J.getContent().getElements(".btn-cancel-warn").forEach(function(L){L.addEvent("click",function(){J.destroy();delete K["data-target"]})})}else{E._uploadFiles(this["data-target"]||I);delete this["data-target"];if(q.isReplayedODT()){this.elements.input.removeAttribute("data-target")}F.setValue(null);F.elements.input.removeAttribute("readonly");E.elements.inputTooltip.setBody("");E.elements.browseFile.setValue(null);C.removeAttribute("src")}}else{if(F.getValue().match(/^(http|https):*\/\//)){E.modal=E.modal||new b({className:"site-reset",closable:true,header:"<h4>"+m.Validate+"</h4>",body:"",footer:""}).inject(E.elements.container);if(E.modalForm){E.modalForm.setValue("url",F.getValue())}else{E.modalForm=new g({fields:[{type:"text",label:"URL",disabled:true,name:"url",value:F.getValue()},{type:"text",label:m.Name,placeholder:"Name",name:"name",className:"url-name",required:true,events:{onChange:function(M){var L=E.treeDocument.getChildren().map(function(N){return N.options.name});if(L.indexOf(M.target.value+".jpeg")>-1||L.indexOf(M.target.value+".png")>-1){E.modalForm.buttons[0].disable()}else{E.modalForm.buttons[0].enable()}}}},{type:"select",label:m.ImageType,pattern:"/.*S.*/",required:true,placeholder:m.PickType,className:"url-type",name:"type",options:[{label:"JPG/JPEG",value:"jpeg"},{label:"PNG",value:"png"}]}],buttons:[{type:"submit",value:m.Submit,className:"primary url-submit"}],events:{onSubmit:function(){var L=this;B.mask(E.elements.container);var M=[];L.getFields().forEach(function(N){M.push(N.value)});E.modal.hide();E._currentRequest.handler=c.authenticatedRequest(E.fullServerUrl+"/resources/v1/collabServices/images/op/"+E._modelId+"/images/uploadByUrl?tenant="+E._determineTenantId("onPremise"),{method:"POST",type:"json",data:JSON.stringify({url:M[0],name:M[1]+"."+M[2],type:M[2]}),timeout:600000,headers:{SecurityContext:encodeURIComponent(E.securityContext.SecurityContext),"content-type":"application/json"},onComplete:function(N){if(N.success===false){L.reset();E.elements.notificationManager.addError(N.message);B.unmask(E.elements.container)}else{N.forEach(function(O){E._getImageFromServerAnswer(O,function(){if(E.elements.container.querySelector(".drop-component")){E.elements.container.querySelector(".imageManagerGrid").removeChild(E.elements.container.querySelector(".drop-component"))}E._addImageToCollection(this,E.treeDocument.getAllDescendants().length===0?true:false);B.unmask(E.elements.container)})});F.setValue(null);C.removeAttribute("src")}},onFailure:function(N){E._onFailure.bind(E);E.elements.notificationManager.addError(N.message);B.unmask(E.elements.container)},ontimeout:function(){E._onTimeout.bind(E);B.unmask(E.elements.container)}})}}}).inject(document.querySelector(".modal-body"))}E.modal.show()}}}}}).inject(D);new y({position:"right",target:G.getContent()});if(!q.isReplayedODT()){G.disable()}E.elements.sortView=new t({container:D,onClick:function(J){console.log(J);var I=J.dataIndex+"_"+J.order;E.treeDocument.prepareUpdate();switch(I){case"size_asc":A.sizeAsc(E.treeDocument.getChildren());break;case"size_desc":A.sizeDesc(E.treeDocument.getChildren());break;case"title_asc":A.alphaAsc(E.treeDocument.getChildren());break;case"title_desc":A.alphaDesc(E.treeDocument.getChildren());break;case"date_asc":A.dateAtoB(E.treeDocument.getChildren());break;case"date_desc":A.dateBtoA(E.treeDocument.getChildren());break}E.treeDocument.pushUpdate()}});new a({renderTo:D,items:[{fonticon:"trash",text:m.Delete,handler:function(){var I=E.treeDocument.getSelectedNodes();E._prepareImageDeletion(I)}}]});new a({renderTo:D,items:[{fonticon:"view-small-thb",className:"switchBtn",text:m.SwitchView,content:{type:"dropdownmenu",options:{items:[{fonticon:"view-small-thb",text:m.Thumbnail,name:"thumbnail",selectable:true},{fonticon:"view-small-tile",text:m.Tile,name:"tile",selectable:true}],events:{onClick:function(J,I){if(this.currentView!==I.name){E.switchView(I.name);if(E.treeDocument.getAllDescendants().length===0){E._initDropComponent()}}document.querySelector(".switchBtn span").className="fonticon fonticon-"+I.fonticon}}}}}]})},switchView:function(C){this.elements[this.currentView]&&this.elements[this.currentView].hide();this.currentView=C;if(this.elements[C]){this.elements[C].show()}else{this._buildGrid(C)}},_compareLabels:function(G,D){var F=G&&typeof G==="string"?G.toLocaleLowerCase():"";var C=D&&typeof D==="string"?D.toLocaleLowerCase():"";var I=Math.min(F.length,C.length);var H=0;for(var E=0;E<I;E++){H=F[E].localeCompare(C[E]);if(H!==0){break}}if(H===0){H=F.length===C.length?0:F.length<C.length?-1:1}return H},_getImageFromServerAnswer:function(D,E){var C=new Image();C.name=D.name;C.weight=D.size;C.primaryImage=D.isPrimaryImage;C.details=D;C.onload=E;C.src=D.medium;C.large=D.large;C.generic=D.generic},compute:function(){this.images=[];var D=this;B.mask(this.elements.container);var C=this._currentRequest.number+1;this._currentRequest.number=C;if(this._currentRequest.handler){this._currentRequest.handler.cancel();this._currentRequest.handler=null}this.getModelImages("mxMedium").then(function(F){if(D._currentRequest.number!==C){return}D.treeDocument.removeRoots();if(Object.keys(F).length===0){B.unmask(D.elements.container);if(D.accessRight){D._initDropComponent()}else{D._initNoContent()}}else{var E=F.length;F.forEach(function(G){D._getImageFromServerAnswer(G,function(){if(D._currentRequest.number!==C){return}D._addImageToCollection(this);if(D.treeDocument.getChildren().length>=E){B.unmask(D.elements.container);var H=localStorage.getItem("sort")!="undefined"&&!!localStorage.getItem("sort")?localStorage.getItem("sort"):"alphaAsc";D.elements.sortView.setOrderByExt({order_field:H.indexOf("date")!==-1?"date":(H.indexOf("alpha")!==-1?"title":"size"),order_by:H.indexOf("Asc")!==-1?"asc":"desc",});D.treeDocument.prepareUpdate();A[H](D.treeDocument.getChildren());D.treeDocument.pushUpdate()}})})}})},_determine3DspaceUrl:function(C){var D=this;return new Promise(function(F,E){if(!C||!C.fullServerUrl){D._currentRequest.handler=q.get3DSpaceUrlAsync({onComplete:function(G){F(G)},onFailure:E})}else{F(C.fullServerUrl)}})},_determineSecurityContext:function(C){var D=this;return new Promise(function(F,E){if(!C||!C.securityContext){D._getSecurityContext(C).then(F)["catch"](function(G){E(G)})}else{F(C.securityContext)}})},_getSecurityContext:function(C){return new Promise(function(E,D){k.getInstance(C).getSecurityContext({alwaysUpdate:true,onFailure:D,onSuccess:E})})},getModelImages:function(D){var C=this;return new Promise(function(E){C._currentRequest.handler=c.authenticatedRequest(C.fullServerUrl+"/resources/v1/collabServices/images/op/"+C._modelId+"/images/"+D+"?tenant="+C._determineTenantId("onPremise"),{method:"GET",type:"json",timeout:600000,headers:{SecurityContext:encodeURIComponent(C.securityContext.SecurityContext)},onComplete:E,onFailure:C._onFailure.bind(C),ontimeout:C._onTimeout.bind(C)})})},_displaySuperModal:function(C){var D=new v({renderTo:this.elements.container});return new Promise(function(F,E){D.confirm(C.modalText,m.modalConfirmation,function(G){if(G){F(G)}else{E(false)}})})},deleteImages:function(C){var D=this;return new Promise(function(F,E){c.authenticatedRequest(D.fullServerUrl+"/resources/v1/collabServices/images/op/image/"+D._modelId+"?tenant="+D._determineTenantId(),{method:"POST",timeout:600000,headers:{SecurityContext:encodeURIComponent(D.securityContext.SecurityContext),Accept:"application/json","content-type":"application/json"},data:e.Json.encode({images:C}),onComplete:F,onFailure:E,ontimeout:E})})},_prepareImageDeletion:function(E){if(!E){return}if(!Array.isArray(E)){E=[E]}if(E.length===0){return}var C=this;var D=m.deleteMultiple;if(E.length===1){D=m.replace(m.get("objDelete"),{objName:E.length?E[0].options.name:E.options.name})}this._displaySuperModal({modalText:D}).then(function(){var F=[];var G=false;E.forEach(function(H){F.push(H.options.name);if(H.options.primaryImage){G=true}});B.mask(C.elements.container);C.deleteImages(F).then(function(H){C.treeDocument.prepareUpdate();C.dispatchEvent("onDeletion",o(E));E.forEach(function(I){C.treeDocument.removeRoot(I)});H=typeof H==="string"?JSON.parse(H):H;if(G){C._changePrimaryImageAttributes(null,H.primaryImage)}C.treeDocument.pushUpdate();if(C.treeDocument.getAllDescendants().length===0){C._initDropComponent()}B.unmask(C.elements.container)})["catch"](function(H){C._onFailure.apply(C,arguments);B.unmask(C.elements.container)})})},setAsPrimaryImage:function(D){var C=this;return new Promise(function(E){c.authenticatedRequest(C.fullServerUrl+"/resources/v1/collabServices/images/op/image/"+C._modelId+"/primaryImage/"+D+"?tenant="+C._determineTenantId(),{method:"PUT",timeout:600000,headers:{SecurityContext:encodeURIComponent(C.securityContext.SecurityContext)},onComplete:E,onFailure:C._onFailure.bind(C),ontimeout:C._onTimeout.bind(C)})})},_closeFullSize:function(){if(this.elements.fullSizeOverlay){this.elements.fullSizeOverlay.destroy();delete this.elements.fullSizeModal}if(this.elements.fullSizeImg){this.elements.fullSizeImg.destroy();delete this.elements.fullSizeImg}},displayImage:function(D){this.treeDocument.getXSO().empty();this.treeDocument.getNthRoot(D).select();var C=this;require(["DS/Tree/LightBoxView"],function(E){C._LightBoxPanel=new E({target:C.elements.container,treeDocument:C.treeDocument,height:"auto",bigPicturePath:function(H){var G=H.nodeModel;return G.options.large}});C._LightBoxPanel.getGridView().options.onContextualEvent={callback:function(H){var G=[];if(H&&H.cellInfos){if(H.cellInfos.cellModel){G.push({type:"PushItem",title:m["Download Image"],fonticon:{family:"entypo",content:"fonticon-download"},action:{callback:function(){C._downloadImage(H.cellInfos.nodeModel)}}});if(C.accessRight&&!H.cellInfos.nodeModel.options.primaryImage){G.push({type:"SeparatorItem"});G.push({type:"PushItem",title:m["Set Primary"],fonticon:{family:"entypo",content:"fonticon-favorite-on"},action:{callback:function(){C.setAsPrimaryImage(H.cellInfos.nodeModel.options.name).then(function(){C._changePrimaryImageAttributes(H.cellInfos.nodeModel._id)})}}})}}}return G}};var F=C._LightBoxPanel.getRightDockingElement();if(F){F.collapsibleFlag=false;F.dockingZoneSize=420;F.minSize=250;F.visibleDockingZoneFlag=false}});return},_initDropComponent:function(){var D=this;if(!D.elements.dropContainer){D.elements.dropContainer=e.createElement("div",{"class":"drop-component",events:{dragleave:function(){this.hide()},drop:function(G){G.preventDefault();G.stopPropagation();this.hide();B.mask(D.elements.container);var E=[];var F=Array.from(G.dataTransfer.files);D.fetchTypes().then(function(J){Array.from(F).forEach(function(K){if(J.indexOf(D.getFileExtension(K.name))===-1){F.splice(F.indexOf(K),1);D.elements.notificationManager.addError(m.replace(m.get("InvalidFileType"),{filename:K.name}))}});if(F&&F.length>0){F.forEach(function(K){E.push(K.name)})}var I=D._checkImagesExist(E);var H=[];F.forEach(function(K){if(I.indexOf(K.name)!==-1){D.elements.notificationManager.addWarning(m.replace(m.get("fileAlreadyExists"),{objName:K.name}))}else{H.push(K)}});F=H;if(F.length<1){B.unmask(D.elements.container)}else{D.uploadImages(F).then(function(K){if(K.success===false){D.elements.notificationManager.addError(K.message);B.unmask(D.elements.container)}else{if(K.length===0){B.unmask(D.elements.container)}K.forEach(function(L){D._getImageFromServerAnswer(L,function(){D._addImageToCollection(this,D.treeDocument.getAllDescendants().length===0?true:false);B.unmask(D.elements.container)})})}})["catch"](function(K){D.elements.notificationManager.addError(K);B.unmask(D.elements.container)})}})}}});var C=e.createElement("div",{"class":"text-icon-container"});e.createElement("span",{"class":"fonticon fonticon-drag-drop",events:{click:function(){document.querySelector("input[type=file]").click()}}}).inject(C);e.createElement("span",{"class":"drop-here-text",text:m.DropHere}).inject(C);C.inject(D.elements.dropContainer)}D.elements.dropContainer.inject(D.elements.container.querySelector(".imageManagerGrid"));D.elements.dropContainer.show()},_initNoContent:function(){var E=this;this.elements.container.addEventListener("dragover",function(F){F=F||event;F.preventDefault()},false);this.elements.container.addEventListener("drop",function(F){F=F||event;F.preventDefault()},false);var C=e.createElement("div",{styles:{position:"absolute","font-size":"10vh",height:"100%",width:"100%",display:"flex"},"class":"drop-component"});var D=e.createElement("div",{"class":"text-icon-container"});e.createElement("span",{"class":"fonticon fonticon-block"}).inject(D);e.createElement("span",{"class":"drop-here-text",text:m.NoContent}).inject(D);D.inject(C);C.inject(E.elements.container.querySelector(".imageManagerGrid"))},_changePrimaryImageAttributes:function(F,D){var E=this;var C=null;if(!!F||!!D){this.treeDocument.getChildren().forEach(function(H){var G=null;if((F===null&&H.options.name===D)||H._id===F){G={primaryImage:true,subLabel:m["Primary Image"],statusbarIcons:["eye",E.accessRight?"favorite-on":null,"download",E.accessRight?"trash":null],statusbarIconsTooltips:[m.FullSizeImage,"",m["Download Image"],E.accessRight?m["Delete image"]:null,],contextualMenu:[m.FullSize,E.accessRight?m["Delete Image"]:null,m["Download Image"]]};C=H}else{if(H.options.primaryImage){G={primaryImage:false,subLabel:"",statusbarIcons:["eye",E.accessRight?"favorite-off":null,"download",E.accessRight?"trash":null],statusbarIconsTooltips:[m.FullSizeImage,E.accessRight?m["Set Primary"]:"",m["Download Image"],E.accessRight?m["Delete image"]:"",],contextualMenu:[m.FullSize,E.accessRight?m.Delete:null,m["Download Image"],E.accessRight?m["Set Primary"]:null,]}}}if(G){H.updateOptions(G)}})}setTimeout(function(){E.dispatchEvent("onPrimaryChange",C?o(C):null)})},_checkImagesExist:function(D){var C=[];if(D&&D.length>0){this.treeDocument.getChildren().forEach(function(E){if(D.indexOf(E.options.name)>=0){C.push(E.options.name)}})}return C},fetchTypes:function(){var C=this;return new Promise(function(E,D){if(!!C.supportedTypes){E(C.supportedTypes)}else{c.authenticatedRequest(C.fullServerUrl+"/resources/v1/collabServices/images/op/validTypes",{method:"GET",type:"json",timeout:600000,headers:{SecurityContext:C.securityContext.SecurityContext},onComplete:function(F){C.supportedTypes=F;E(C.supportedTypes)},onFailure:D,ontimeout:D})}})},uploadImages:function(D){var C=this;var E=new FormData();var F=0;Array.prototype.forEach.call(D,function(G){if(G.size===0){C.elements.notificationManager.addError(m.replace(m.get("InvalidFileSize"),{size:G.size}))}else{E.append(G.name,G);F++}});return new Promise(function(H,G){if(F===0){H([])}else{c.authenticatedRequest(C.fullServerUrl+"/resources/v1/collabServices/images/op/"+C._modelId+"/images/upload?tenant="+C._determineTenantId(),{method:"POST",type:"json",timeout:600000,headers:{SecurityContext:encodeURIComponent(C.securityContext.SecurityContext)},data:E,onComplete:H,onFailure:G,ontimeout:G})}})},_formatImageWeight:function(C){if(C&&typeof C!=="number"){throw new TypeError(m.SetNumber)}if(C<=999){return C.toFixed(2)+"B"}if(C<=999999){return(C/1000).toFixed(2)+"KB"}return C?(C/1000000).toFixed(2)+"MB":""},_getIndexForNode:function(E){var D=this;var C=null;this.treeDocument.getChildren().every(function(G,F){var H=D._compareLabels(G.options.name,E.options.name);if(H>0){C=F}return C==null});C=C==null?this.treeDocument.getChildren().length:C;return C},_determineFavoriteOn:function(C){if(this.accessRight){if(C.primaryImage){return"favorite-on"}else{return"favorite-off"}}else{return null}},_addImageToCollection:function(D,H){var F=this;var C=D.details&&D.details.modifiedAt?D.details.modifiedAt:new Date();var G=q.formatDate(C,true);var E=new r({label:D.name,thumbnail:D.src,generic:D.generic,large:D.large,name:D.name,subLabel:D.primaryImage?m["Primary Image"]:undefined,statusbarIcons:["eye",F._determineFavoriteOn(D),"download",F.accessRight?"trash":null].filter(function(I){return I!==null}),statusbarIconsTooltips:["Display full-sized Image",F._determineFavoriteOn(D)==="favorite-off"?m["Set Primary"]:null,"Download",F.accessRight?"Delete image":null],multipleTitleLineNumber:false,icons:["picture"],primaryImage:D.primaryImage?"Primary Image":undefined,contextualMenu:["Display full-sized","Delete",!D.primaryImage?m["Set Primary"]:m["Primary Image"],m["Download Image"]].filter(function(I){return I!==null}),propertiesList:[G,this._formatImageWeight(D.weight)]});this._addNodeToCollection(E);if(D.primaryImage&&H){this._changePrimaryImageAttributes(null,E.options.name)}},_addNodeToCollection:function(C){this._getIndexForNode(C);this.treeDocument.prepareUpdate();this.treeDocument.addChild(C);this.treeDocument.pushUpdate()},close:function(){if(this.elements._dialogImg){this.elements._dialogImg.close()}},_close:function(){this._closeFullSize();this.elements._dialogImg.content=null;this.elements._dialogImg.destroy();delete this.elements._dialogImg},_onTimeout:function(){this.elements.notificationManager.addWarning(m.onTimeout,"timeout")},_onFailure:function(C,F,H,E){var G=this;var D={};if(F!=null&&F.hasOwnProperty("error")){D=F.error}else{D={message:m.get("An error occurred"),code:"ERROR"}}(this.elements.notificationManager||new z(null,G.elements.container||widget.body,"imageManagerNotifs")).addError(D.message)},execute:function(C){var E=this;var D=this._currentRequest.number+1;this._currentRequest.number=D;if(this._currentRequest.handler){this._currentRequest.handler.cancel();this._currentRequest.handler=null}Promise.all([this._determine3DspaceUrl(C),this._determineSecurityContext(C)]).then(function(F){E.fullServerUrl=F[0];E.securityContext=F[1];E._hasAccessRight().then(function(G){E.accessRight=G==="true";if(!E.elements.container){E.elements.container=e.createElement("div",{"class":"imgManagerContainer"});E.elements.notificationManager=new z(null,E.elements.container,"imageManagerNotifs");if(E.accessRight){E._buildToolbar()}E._buildGrid()}E.elements.container.addEventListener("dragover",function(H){H=H||event;H.preventDefault()},false);E.elements.container.addEventListener("drop",function(H){H=H||event;H.preventDefault()},false);if(E.accessRight){E.elements.container.addEventListener("dragover",function(H){H=H||event;H.preventDefault();E._initDropComponent()},false)}if(!E.elements._dialogImg){E.elements._dialogImg=new f({title:m.imgManagerTitle,content:E.elements.container,immersiveFrame:new p(),maximizedFlag:true,movableFlag:false,autoCloseFlag:false,buttons:{Close:new s({onClick:E.close.bind(E)})}}).inject(q.getWidgetBody());E.elements._dialogImg.addEventListener("close",E._close.bind(E))}E.compute(C)})})},_downloadImage:function(H){var C=window.navigator&&window.navigator.msSaveOrOpenBlob!==undefined;var E=this;B.mask(this.elements.container);var D=new XMLHttpRequest();var F=H.options.label;F=F?F:"image.jpg";if(!C){D.responseType="blob"}var G=q.isReplayedODT()?URL.createObjectURL(new Blob()):H.options.generic;D.open("GET",G,true);if(C){D.responseType="blob"}D.send(null);D.onload=function(){if(D.readyState===4){if(D.status===200){if(window.navigator&&window.navigator.msSaveOrOpenBlob){window.navigator.msSaveOrOpenBlob(D.response,F)}else{var I=document.createElement("a");I.setAttribute("href",URL.createObjectURL(D.response));I.setAttribute("download",F);document.body.appendChild(I);if(!q.isReplayedODT()){I.click()}document.body.removeChild(I)}B.unmask(E.elements.container)}else{E.elements.notificationManager.addWarning(m.get("cannotDownloadImage"),{objName:el.name})}}}},_determineTenantId:function(C){if(this._tenantId){return this._tenantId}return q.getTenantID(C)},_hasAccessRight:function(){var C=this;return new Promise(function(D){C._currentRequest.handler=c.authenticatedRequest(C.fullServerUrl+"/resources/v1/collabServices/images/op/"+C._modelId+"/accessRight?tenant="+C._determineTenantId("onPremise"),{method:"GET",timeout:600000,headers:{SecurityContext:encodeURIComponent(C.securityContext.SecurityContext)},onComplete:D,onFailure:C._onFailure.bind(C),ontimeout:C._onTimeout.bind(C)})})}})});if(!Array.from){Array.from=(function(){var d=Object.prototype.toString;var e=function(g){return typeof g==="function"||d.call(g)==="[object Function]"};var c=function(h){var g=Number(h);if(isNaN(g)){return 0}if(g===0||!isFinite(g)){return g}return(g>0?1:-1)*Math.floor(Math.abs(g))};var b=Math.pow(2,53)-1;var a=function(h){var g=c(h);return Math.min(Math.max(g,0),b)};return function f(p){var g=this;var o=Object(p);if(p==null){throw new TypeError("Array.from requires an array-like object - not null or undefined")}var m=arguments.length>1?arguments[1]:void undefined;var i;if(typeof m!=="undefined"){if(!e(m)){throw new TypeError("Array.from: when provided, the second argument must be a function")}if(arguments.length>2){i=arguments[2]}}var n=a(o.length);var h=e(g)?Object(new g(n)):new Array(n);var j=0;var l;while(j<n){l=o[j];if(m){h[j]=typeof i==="undefined"?m(l,j):m.call(i,l,j)}else{h[j]=l}j+=1}h.length=n;return h}})()};