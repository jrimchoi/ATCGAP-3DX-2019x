define("DS/NotifAlert/NotifAlert",["UWA/Core","UWA/Utils","UWA/Class/View","DS/UIKIT/DropdownMenu","DS/WAFData/WAFData","i18n!DS/NotifAlert/assets/nls/feed","DS/PlatformAPI/PlatformAPI","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","css!NotifAlert/NotifAlert.css"],function(Core,Utils,View,DropdownMenu,WAFData,NLS,PlatformAPI,i3DXCompassPlatformServices){var iView=View.extend({setup:function(options){this.timer=undefined;this.isClosed=false;this.showAlertFx=undefined;this.oldText=undefined;this.listEventTypes={bus:this.bus,url:this.url};var mergedCollection=this.model.get("mergedCollection");if(mergedCollection){this.numMerged=mergedCollection.length;this._createContent();this._addEvents();this.getAppInfo(this.model.get("provider"));this.listenTo(this.model,"onChange:actioned",this.modelActioned);this.mergedWrapper=UWA.createElement("div",{"class":"RTmergedWrapper",styles:{height:"auto","padding-top":"10px"}});this.container.appendChild(this.mergedWrapper);this.merge(mergedCollection.length);this.viewMerged=true;var that=this;that.mergeList=[],that.mergeUnreadFlag=false;mergedCollection._models.forEach(function(mergedElement){var NotifAlert=that.constructor;var view=new NotifAlert({model:mergedElement});view.isMerge=true;view.model=mergedElement;view._createContent();view._addEvents();view.getAppInfo(that.model.get("provider"));view.listenTo(that.model,"onChange:actioned",that.modelActioned);view.container.getElement(".RTnotif-alertImg").style.height="28px";view.container.getElement(".RTnotif-alertImg").style.width="28px";if(mergedElement.get("state")===4){view.setReadstate(true);view.anonymize()}that.mergeList.push(view);view.model.addEvent("delete",function(evt){that.numMerged--;view.destroy();var text=that.getElement(".RTnotif-span-Txt").innerHTML;if(that.numMerged===1){var person=('<strong class="mergecount">'+that.numMerged+"</strong>").toString()}else{var person=('<strong class="mergecount">'+that.numMerged+"</strong>").toString()}text=text.replace(/<strong class=.*?<\/strong>/,person);that.getElement(".RTnotif-span-Txt").innerHTML=text;view.model.dispatchEvent("deleteCenter",evt);if(that.numMerged===0){that.model.dispatchEvent("delete",function(){id:that.model.get("id")})}});view.model.addEvent("readStateforMainMerge",function(evt){if(evt.read){that.mergeUnreadFlag=false;for(var i=0;i<that.mergeList.length;i++){if(!that.mergeList[i].getReadstate()){that.mergeUnreadFlag=true;break}}if(!that.mergeUnreadFlag){that.setReadstate(true);that.model.dispatchEvent("read",[{id:that.model.get("id"),read:that.getReadstate()}])}}else{var countUnread=0;that.setReadstate(false);for(var i=0;i<that.mergeList.length;i++){if(!that.mergeList[i].getReadstate()){countUnread++}}if(countUnread===1){that.mergeUnreadFlag=true;that.model.dispatchEvent("read",[{id:that.model.get("id"),read:false}])}}});view.model.addEvent("buttonLabelforMainMerge",function(){var mergeLabelFlag=false;for(var i=0;i<that.mergeList.length;i++){if((that.mergeList[i].container.getElement(".RTAlertActions").childElementCount===2)||(that.mergeList[i].container.getElement(".RTAlertActions").firstElementChild.hasClassName("btn"))){mergeLabelFlag=true;break}}if(!mergeLabelFlag){that.updateActionedLabel(NLS.groupActionLabel,false)}})});for(var i=0;i<that.mergeList.length;i++){that.mergeList[i].container.style.display="none";that.mergedWrapper.appendChild(that.mergeList[i].container);if(!that.mergeList[i].getReadstate()){that.mergeUnreadFlag=true}}if(!that.mergeUnreadFlag){that.setReadstate(true)}}else{this._createContent();this._addEvents();this.getAppInfo(this.model.get("provider"));this.listenTo(this.model,"onChange:actioned",this.modelActioned)}},_createContent:function(){var that=this;this.dropdownMenuClose=null;var img=this.model.get("img"),text=this.model.get("text"),provider=this.model.get("provider"),url=this.model.get("url"),date=this.model.get("date"),options=this.model.get("options"),notifications=this.model.get("notifications");var appIconBorder=this.model.get("appIconBorder"),actioned=this.model.get("actioned"),isInNotifCenter=this.model.get("isInNotifCenter"),refreshStatus=this.model.get("refresh"),creationDate=this.model.get("creationDate"),mergedStatus=this.model.get("merged");if(this.model.get("mergedCollection")){var person=that.numMerged;person=("<strong class='mergecount'>"+person+" </strong>").toString();if(text.search("##MERGE_COUNT##")!==-1){text=text.replace("##MERGE_COUNT##",person)}else{text=text.replace(/<strong>.*?<\/strong>/,person)}if(text.search(/\(.*?\)/)){text=text.replace(/\(.*?\)/,"")}}this.id=this.model.get("id");if(!img||typeof img!="string"){img="./resources/en/1/webapps/NotifAlert/assets/icons/notificon.png";appIconBorder=true}var mergeClass=this.isMerge?" RTMergedNotif":"";this.setContainer({tag:"div","class":"RTMainNotifAlert "+provider+mergeClass,styles:{width:"100%"},html:[{tag:"span","class":"RTnotif-close fonticon fonticon-cancel",styles:{display:isInNotifCenter?"none":"block"}},{tag:"div","class":"RTnotif-alertboxbody",html:[{tag:"div","class":"RTnotif-alertIcon",html:[{"class":"RTnotif-alertImg",tag:"img",src:img,height:"48px",width:"48px",styles:{borderRadius:appIconBorder?"0px":"24px"}}]},{tag:"div","class":"RTnotif-alertBody",html:[{"class":"RTnotif-Txt",tag:"div",html:[{tag:"span","class":"RTnotif-span-Txt",html:decodeURI(encodeURI(text))}]}]},{tag:"span","class":"fonticon fonticon-menu-dot RTnotif-alertCenterOptions",styles:{margin:"auto 0",display:isInNotifCenter?"block":"none",fontSize:"1.6em",cursor:"pointer",color:"#B4B6BA",marginTop:"6px"},html:this.dropdownMenuClose}]},{tag:"div","class":"RTAlertActions",styles:{display:"none",textAlign:"right"}}]});var alertImg=this.container.getElement(".RTnotif-alertImg");alertImg.onerror=function(){i3DXCompassPlatformServices.getAppInfo({appId:"X3DNTFC_AP",onComplete:function(app){if(app){var notifUrl;if(app.launchInfos){notifUrl=app.launchInfos}else{notifUrl=app.platforms[0].launchInfos}notifUrl=notifUrl.split("/");notifUrl.pop();notifUrl.pop();alertImg.src=notifUrl.join("/").concat("/NotifAlert/assets/icons/notificon.png");alertImg.onerror=undefined}}})};if(isInNotifCenter){var readState=this.model.get("readState");var read_status;if(!this.numMerged){if(!readState){that.container.style.opacity=1;read_status=NLS.markAsRead}else{that.container.style.opacity=0.4;read_status=NLS.markAsUnread}}that.container.getElement(".RTnotif-alertCenterOptions").onclick=function(){if(that.container.getElement(".RTnotif-alertCenterOptions").style.color.rgbToHex()==="#b4b6ba"){that.container.getElement(".RTnotif-alertCenterOptions").style.color="#368ec4"}else{that.container.getElement(".RTnotif-alertCenterOptions").style.color="#b4b6ba"}};if(mergedStatus){that.mergedTime=UWA.createElement("div",{"class":"RTnotif-Txt",styles:{fontSize:"11px"}}).inject(that.container.getElement(".RTnotif-alertBody"));that.mergedTimeIcon=UWA.createElement("span",{"class":"fonticon fonticon-clock site-icon",}).inject(that.mergedTime);var mergedDate=new Date(creationDate);that.mergedTimeText=UWA.createElement("strong",{html:" "+(mergedDate.getDate()+"/"+Number(mergedDate.getMonth()+1)+"/"+mergedDate.getFullYear())+" - "+((mergedDate.getHours()<10?"0":"")+mergedDate.getHours())+":"+((mergedDate.getMinutes()<10?"0":"")+mergedDate.getMinutes())}).inject(that.mergedTime)}if(!this.numMerged){this.dropdownMenuClose=new DropdownMenu({target:that.container.getElement(".RTnotif-alertCenterOptions"),items:[{text:read_status,fonticon:"bell",handler:function(e){if(that.getReadstate()){that.setReadstate(false)}else{that.setReadstate(true)}if(that.isMerge){that.model.dispatchEvent("readStateforMainMerge",{read:that.getReadstate()})}that.model.dispatchEvent("read",[{id:that.model.get("id"),read:that.getReadstate()}])}},{text:NLS.unsubscribe,fonticon:"list-times",handler:function(){that.model.dispatchEvent("unsubscribe")},disabled:(provider=="X3DNTFC_AP")?true:false,title:(provider=="X3DNTFC_AP")?NLS.unsubscribeDisabled||"You cannot subscribe again":""},{text:NLS.trash,fonticon:"trash",handler:function(){that.model.dispatchEvent("delete",{id:that.model.get("id"),read:that.getReadstate()})},disabled:(provider=="X3DNTFC_AP")?true:false,title:(provider=="X3DNTFC_AP")?NLS.trashDisabled||"You cannot restore again":""}],events:{onHide:function(){that.container.getElement(".RTnotif-alertCenterOptions").style.color="#b4b6ba"}}})}var childrens=that.container.getElement(".RTnotif-span-Txt").children;for(var i=0;i<childrens.length;i++){childrens[i].style.color="rgb(54, 142, 196)"}}if(options){this._buildActions(options)}if(this.model.get("state")===4){this.anonymize()}},getAppInfo:function(appID){var that=this;this.appID=[];i3DXCompassPlatformServices.getAppInfo({appId:appID,onComplete:function(app){UWA.log(app);if(app){that.appID[appID]={};that.appID[appID].platforms=[];if(app.platforms){if(app.platforms.length===0){that.appID[appID].platforms[app.platformId]={serviceId:app.serviceId,url:app.launchUrl}}else{for(var i=0;i<app.platforms.length;i++){var contenturl={serviceId:app.serviceId,url:app.platforms[i].launchUrl};that.appID[appID].platforms[app.platforms[i].id]=contenturl}}}}}})},modelChange:function(evt){var itemChange=this.model.changedAttributes()},modelActioned:function(evt){var itemChange=this.model.changedAttributes();if(itemChange.actioned){var elements=this.container.querySelectorAll(".RTnotif-alertActionButton");if(elements){for(var i=0;i<elements.length;i++){elements[i].disabled=true}}}},getReadstate:function(){return this.model.get("readState")},setReadstate:function(value){this.model.set("readState",value);if(!value){this.container.style.opacity=1;if(!this.numMerged){this.dropdownMenuClose.items[0].elements.container.innerHTML='<span class="fonticon fonticon-bell"></span><span class="item-text">'+NLS.markAsRead+"</span>"}else{this.dropdownMenuMerged.items[0].elements.container.innerHTML='<span class="fonticon fonticon-bell"></span><span class="item-text">'+NLS.markGroupAsRead+"</span>"}}else{this.container.style.opacity=0.4;if(!this.numMerged){this.dropdownMenuClose.items[0].elements.container.innerHTML='<span class="fonticon fonticon-bell"></span><span class="item-text">'+NLS.markAsUnread+"</span>"}else{this.dropdownMenuMerged.items[0].elements.container.innerHTML='<span class="fonticon fonticon-bell"></span><span class="item-text">'+NLS.markGroupAsUnRead+"</span>"}}},getCenterState:function(){return this.model.get("isInNotifCenter")},getActionedState:function(){return this.model.get("actioned")},_addEvents:function(){var context=this;this.addEvent("updatePicture",function(e){context.container.getElement(".RTnotif-alertImg").src=e.src});this.container.getElement(".RTnotif-close").onclick=function(e){context.close({context:context,decrementFlag:true})}},_buildActions:function(actions){var that=this;var flag=true,btn="RTnotif-alertActionButton btn btn-primary btn-sm";if(actions.length>1&&(actions[0].type=="button")&&(that.getActionedState())){that.updateActionedLabel(that.model.get("actionedLabel"),false,that.model.get("actor_data"))}else{for(var i=0;i<actions.length;i++){if(flag){if(that._checkAction(actions[i])){var eventType=actions[i].options.event.type;switch(actions[i].type){case"link":that.activateLink();that.activateEvent({action:actions[i],eventType:eventType});flag=false;break;case"button":if(i>0){btn="RTnotif-alertActionButton btn btn-default btn-sm";actions[i].title="deny"}var button=that.activateButton(actions[i],btn);if(button){that.activateEvent({action:actions[i],eventType:eventType},button)}break;default:}}}}}},getEventOptions:function(option){if(option&&option.event&&option.event.options){var options=option.event.options;if(options.topic&&options.data){return{topic:options.topic,data:options.data}}else{UWA.log("3DNotification Error eventOptions missing topic or data")}}else{UWA.log("3DNotification Error eventOptions")}},url:function(data,element){var that=this;if(data&&data.type&&data.options){if(data.type==="link"){that.container.getElement(".RTnotif-alertBody").onclick=function(){that.activateLinkAction(data.options);if(that.model.get("mergedCollection")){for(var i=that.mergedWrapper.getElements(".RTMainNotifAlert").length-1;i>=0;i--){that.model.dispatchEvent("readMerged",[{id:that.model.get("notifications")[i].ID,read:true}]);that.mergeList[i].setReadstate(true)}}if(that.isMerge){that.model.dispatchEvent("readStateforMainMerge",{read:that.getReadstate()})}that.model.dispatchEvent("read",[{id:that.model.get("id"),read:true}]);that.model.dispatchEvent("actioned",[{id:that.model.get("id"),actioned:true}])}}else{if(data.type==="button"){element.onclick=function(e){if(!that.getActionedState()){if(that.model.get("mergedCollection")){for(var i=0;i<that.mergeList.length;i++){if(data.title==="deny"){if(that.mergeList[i].container.children[2].children[1]){that.mergeList[i].container.children[2].children[1].click()}}else{if(that.mergeList[i].container.children[2].children[0]){that.mergeList[i].container.children[2].children[0].click()}}}that.model.dispatchEvent("read",[{id:that.model.get("id"),read:true,actioned:true}]);if(that.getCenterState()){that.setReadstate(true)}}else{that.activateLinkAction(data.options);that.model.dispatchEvent("read",[{id:that.model.get("id"),read:true,actioned:true}]);that.model.dispatchEvent("actioned",[{id:that.model.get("id"),actioned:true}]);if(that.getCenterState()){that.setReadstate(true)}if(that.isMerge){that.model.dispatchEvent("readStateforMainMerge",{read:that.getReadstate()})}that.model.set("actioned",true);e.target.disabled=true}}}}}}},bus:function(data,element){var that=this;if(data&&data.type&&data.options){var eventOptions=this.getEventOptions(data.options);if(eventOptions){if(data.type==="link"){that.alertBoxClick(".RTnotif-alertBody",function(){that.model.dispatchEvent("publish",[{topic:eventOptions.topic,data:eventOptions.data}]);that.model.dispatchEvent("read",[{id:that.model.get("id"),read:true}]);if(that.getCenterState()){that.setReadstate(true)}else{that.close({decrementFlag:true})}})}else{if(data.type==="button"){if(eventOptions.data&&eventOptions.data.action=="rollback"){eventOptions.data.id=that.model.get("id");eventOptions.data.isInNotifCenter=that.model.get("isInNotifCenter")}element.onclick=function(e){if(!that.getActionedState()){that.model.dispatchEvent("publish",[{topic:eventOptions.topic,data:eventOptions.data}]);that.model.dispatchEvent("read",[{id:that.model.get("id"),read:true,actioned:true}]);that.model.dispatchEvent("actioned",[{id:that.model.get("id"),actioned:true}]);that.model.set("actioned",true);e.target.disabled=true;if(that.getCenterState()){that.setReadstate(true)}else{that.close({decrementFlag:true})}}}}}}}},alertBoxClick:function(element,callback){this.container.getElement(element).onclick=callback},activateLinkAction:function(options){if(this._checkUrlAction(options)){var eventOptions=options.event.options;var action_label=options.actioned_label;eventOptions.appID=this.model.get("provider");if(eventOptions.type==="GET"){this.activateGetAction(eventOptions)}else{if(eventOptions.type==="POST"){this.activatePostAction(eventOptions,action_label)}}if(this.getCenterState()){this.setReadstate(true)}else{this.close({decrementFlag:true})}}},activateGetAction:function(eventOptions){var that=this;var service;var flag=true;var platformId=this.model.get("platformId");if(eventOptions.url){if(!this.getLocation(eventOptions.url)){eventOptions.url=that.appID[this.model.get("provider")].platforms[platformId].url+eventOptions.uri}if(that.isSameApp(eventOptions.url,window.parent.location)){that.verifyLocation(eventOptions.url,window.parent.location.hash,flag)}else{service=window.parent.location.hostname;if(!window.parent.location.hash.contains("app")&&window.parent.location.hostname.contains("ifwe")){window.parent.document.location.href=eventOptions.url}else{if((this.model.get("provider")==="X3DOPMR_AP")&&platformId){eventOptions.url=eventOptions.url+"/content:x3dPlatformId="+platformId.trim()}if(typeof(this.appID[eventOptions.appID])==="object"){if(typeof(this.appID[eventOptions.appID].platforms[platformId])==="object"){if(typeof(this.appID[eventOptions.appID].platforms[platformId].url)!=="undefined"){if(that.getLocation(this.appID[eventOptions.appID].platforms[platformId].url).hostname.toLowerCase()===service.toLowerCase()){if(flag){PlatformAPI.publish("common.3DNotification.topic",{action:"refresh",data:{url:eventOptions.url}})}else{var win=window.open(eventOptions.url,"_blank");win.focus()}}else{var win=window.open(eventOptions.url,"_blank");win.focus()}}else{var win=window.open(eventOptions.url,"_blank");win.focus()}}else{var win=window.open(eventOptions.url,"_blank");win.focus()}}else{var win=window.open(eventOptions.url,"_blank");win.focus()}}}}},verifyLocation:function(url,hash,flag){var platformId=this.model.get("platformId");if(this.getLocation(url).hash===hash&&flag){PlatformAPI.publish("common.3DNotification.topic",{action:"refresh",data:{url:url}})}else{if((this.model.get("provider")==="X3DOPMR_AP")&&platformId){if(window.parent.document.location.hash.contains("app:X3DOPMR_AP")){var urlPlatform=UWA.Utils.getQueryString(window.parent.document.location.hash,"content:x3dPlatformId");if(urlPlatform){window.parent.document.location.hash=window.parent.document.location.hash.replace(urlPlatform,platformId.trim())}else{window.parent.document.location.hash=window.parent.document.location.hash+"/content:x3dPlatformId="+platformId.trim()}}else{window.parent.document.location.hash=this.getLocation(url).hash+"/content:x3dPlatformId="+platformId.trim()}}else{window.parent.document.location.hash=this.getLocation(url).hash}}},activatePostAction:function(eventOptions,action_label){if(eventOptions.url){if(eventOptions.csrf){this.csrf({csrf:eventOptions.csrf,url:eventOptions.url,params:(eventOptions.options&&eventOptions.options.data)?eventOptions.options.data:undefined,headers:(eventOptions.options&&eventOptions.options.headers)?eventOptions.options.headers:undefined},action_label)}else{this.post({url:eventOptions.url,params:(eventOptions.options&&eventOptions.options.data)?eventOptions.options.data:undefined,headers:(eventOptions.options&&eventOptions.options.headers)?eventOptions.options.headers:undefined},action_label)}}},_checkAction:function(action){if(action.options&&action.options.event&&action.options.event.type){return true}else{return false}},_checkUrlAction:function(options){if(options.event.options&&options.event.options.type){return true}else{return false}},activateEvent:function(options,element){var that=this;for(var eventName in this.listEventTypes){if(this.listEventTypes.hasOwnProperty(eventName)){if(options.eventType===eventName){this.listEventTypes[options.eventType].call(this,options.action,element)}}}},activateButton:function(action,btn){var button;if(action&&action.options&&action.options.label==undefined){if(action.options.event.options.data&&action.options.event.options.data.action=="rollback"){action.options.label="Restore"}}if(action&&action.options&&action.options.label){var actionsWrapper=this.container.getElement(".RTAlertActions");actionsWrapper.style.display="block";button=new UWA.Element("button",{"class":btn,text:action.options.label,styles:{marginBottom:"5px",marginRight:"10px",maxWidth:"100px",overflow:"hidden",textOverflow:"ellipsis"}}).inject(actionsWrapper)}else{UWA.log("3DNotification activateButton error : missing parameters");return null}if(this.getActionedState()){button.disabled=true}return button},activateLink:function(){var that=this;var txtBody=this.container.getElement(".RTnotif-alertBody");txtBody.onmouseover=function(){txtBody.style.textDecoration="underline";txtBody.style.cursor="pointer"};txtBody.onmouseout=function(){txtBody.style.textDecoration="";txtBody.style.cursor="default"}},close:function(options){if(!options.context){options.context=this}if(options.context.timer&&options.context.model&&options.context.model.collection){if(options.decrementFlag){options.context.model.dispatchEvent("alertBoxClosed")}options.context.timer.stop();options.context.model.collection.remove(options.context.model)}},show:function(){var that=this;var lifespan=5000;var textDiv=this.container.getElement(".RTnotif-span-Txt");this.timer=new Timer(function(){if(!that.isClosed){that.close({context:that});that.isClosed=true}},lifespan);this.container.addEventListener("mouseenter",function(){that.timer.stop()});this.container.addEventListener("mouseleave",function(){that.timer.resume(3000)});function Timer(callback,delay){var timerId,start,remaining=delay;this.stop=function(){window.clearTimeout(timerId);that.isClosed=false};this.resume=function(lifespan){start=new Date();window.clearTimeout(timerId);timerId=window.setTimeout(callback,lifespan)};this.resume(lifespan)}if(textDiv){this.cutText(textDiv)}},isSameApp:function(url1,url2){if(Utils.matchUrl(url1,url2)){return(Utils.parseUrl(url1).directoryPath||"/").split("/")[1]===(Utils.parseUrl(url2).directoryPath||"/").split("/")[1]}return false},post:function(options,action_label){var that=this;if(options&&options.url){WAFData.authenticatedRequest(options.url,{method:"POST",data:options.params,headers:options.headers,onComplete:function(res){UWA.log("Notification Post Action Completed !");var temp;if(res){try{temp=JSON.parse(res)}catch(e){UWA.log("Notification post Action Error for json parse"+e);if(that.model.get("isInNotifCenter")){that.updateActionedLabel(NLS.actionFailed,false)}that.model.dispatchEvent("updateLabel",[{id:that.model.get("id"),label:"NLS.actionFailed",flag:false}])}}if(temp&&temp.result&&temp.result.success){action_label=action_label||"NLS.actionLabel";if(that.model.get("isInNotifCenter")){that.updateActionedLabel(action_label,true)}that.model.dispatchEvent("updateLabel",[{id:that.model.get("id"),label:action_label,flag:true}])}else{if(that.model.get("isInNotifCenter")){that.updateActionedLabel(NLS.actionFailed,false)}that.model.dispatchEvent("updateLabel",[{id:that.model.get("id"),label:"NLS.actionFailed",flag:false}])}if(that.isMerge){that.model.dispatchEvent("buttonLabelforMainMerge",{})}},onFailure:function(evt){UWA.log("Notification Post Action Failed !");if(that.model.get("isInNotifCenter")){that.updateActionedLabel(NLS.actionFailed,false)}that.model.dispatchEvent("updateLabel",[{id:that.model.get("id"),label:"NLS.actionFailed",flag:false}])}})}else{UWA.log("Notification Post Failed some parameters are missing !")}},csrf:function(options,action_label){var that=this;if(options&&options.csrf){WAFData.authenticatedRequest(options.csrf,{method:"GET",onComplete:function(evt){UWA.log("Notification csrf Action Completed !");var rep;try{rep=JSON.parse(evt)}catch(e){UWA.log("Notification Csrf Action Error for json parse"+e);that.updateActionedLabel(NLS.actionFailed,false)}if(rep){options.headers={"X-DS-SWYM-CSRFTOKEN":rep.result.ServerToken};that.post(options,action_label)}}})}else{UWA.log("Notification Csrf Action Failed some parameters are missing !")}},cutText:function(div){this.oldText=div.innerHTML;var tooLarge=this.isTooLarge(div);while(div.innerText.length>3&&(this.countLines(div)>2||tooLarge)){var txt=div.innerText;div.innerText="";txt=txt.substring(0,txt.length-1-6);txt=txt+"...";div.innerText=txt;div.style.display="none";div.offsetHeight;div.style.display="";tooLarge=this.isTooLarge(div)}},countLines:function(div){var divHeight=div.offsetHeight;var lines=divHeight/20;return lines},isTooLarge:function(div){var parentDiv=this.container.getElement(".RTnotif-alertboxbody");var pWidth=parentDiv.offsetWidth-48;if(pWidth>div.offsetWidth){return false}return true},adaptText:function(){var rep=100;var textDiv=this.container.getElement(".RTnotif-span-Txt");var parentWidth=this.model.get("parentWidth");this.oldText=textDiv.innerHTML;var tooLarge=!(parentWidth>textDiv.offsetWidth);while(rep>0&&tooLarge){rep=rep-1;var txt=textDiv.innerText;var words=txt.split(" ");var replaceWord="";for(var i=0;i<words.length;i++){if(words[i].length>replaceWord.length){replaceWord=words[i]}}txt=textDiv.innerHTML.replace(replaceWord,replaceWord.substring(0,replaceWord.length/2)+" "+replaceWord.substring(replaceWord.length/2,replaceWord.length));textDiv.innerHTML=txt;tooLarge=!(parentWidth>textDiv.offsetWidth)}},getLocation:function(href){var match=href.match(/^(https?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)([\/]{0,1}[^?#]*)(\?[^#]*|)(#.*|)$/);return match&&{protocol:match[1],host:match[2],hostname:match[3],port:match[4],pathname:match[5],search:match[6],hash:match[7]}},anonymize:function(){var txtBody=this.container.getElement(".RTnotif-alertBody");txtBody.onclick=null;txtBody.onmouseover=null;if(this.container.getElement(".RTAlertActions")){this.container.getElement(".RTAlertActions").destroy()}this.dropdownMenuClose.items[0].elements.container.destroy()},merge:function(num){var that=this;var readState=this.model.get("readState");var read_status;if(!readState){read_status=NLS.markGroupAsRead}else{read_status=NLS.markGroupAsUnRead}that.dropdownMenuMerged=new DropdownMenu({target:that.container.getElement(".RTnotif-alertCenterOptions"),items:[{text:read_status,fonticon:"bell",handler:function(e){if(that.getReadstate()){for(var j=0;j<that.mergeList.length;j++){that.mergeList[j].setReadstate(false)}that.setReadstate(false)}else{for(var z=0;z<that.mergedWrapper.getElements(".RTMainNotifAlert").length;z++){that.mergeList[z].setReadstate(true)}that.setReadstate(true)}for(var i=that.mergedWrapper.getElements(".RTMainNotifAlert").length-1;i>=0;i--){that.model.dispatchEvent("readMerged",[{id:that.model.get("notifications")[i].ID,read:that.getReadstate()}])}that.model.dispatchEvent("read",[{id:that.model.get("id"),read:that.getReadstate()}])}},{text:NLS.unsubscribe,fonticon:"list-times",handler:function(){that.model.dispatchEvent("unsubscribe")}},{text:NLS.deleteGroup,fonticon:"trash",handler:function(){for(var j=that.mergedWrapper.getElements(".RTMainNotifAlert").length-1;j>=0;j--){that.mergedWrapper.getElements(".RTMainNotifAlert")[j].destroy();if(j!=0){that.model.dispatchEvent("deleteMerged",[{id:that.model.get("notifications")[j].ID}])}}that.model.dispatchEvent("delete",[{id:that.model.get("id"),read:that.getReadstate()}])}}],events:{onHide:function(){that.container.getElement(".RTnotif-alertCenterOptions").style.color="#b4b6ba"}}});that.countDiv=UWA.createElement("div",{"class":"RTnotif-Mergecount"}).inject(that.container.getElement(".RTnotif-alertIcon"));that.mergeIcon=UWA.createElement("span",{"class":"RTnotif-alertMergedImg fonticon fonticon-users"}).inject(that.countDiv);that.viewAllMerged=UWA.createElement("div",{"class":"RTnotif-viewAll"}).inject(that.mergedWrapper);that.viewAllIcon=UWA.createElement("span",{"class":"fonticon fonticon-expand-right"}).inject(that.viewAllMerged);that.viewAllspan=UWA.createElement("span",{text:NLS.viewAll,styles:{fontSize:"Arial regular 12pt",color:"#368ec4"}}).inject(that.viewAllMerged);that.viewAllMerged.onclick=function(){if(that.viewMerged){UWA.log("viewAllMerged "+alert.viewAllMerged);that.viewAllspan.textContent=NLS.hideAll;that.viewAllIcon.className="fonticon fonticon-expand-down";for(var i=1;i<that.mergedWrapper.children.length;i++){that.mergedWrapper.children[i].style.height="auto";that.mergedWrapper.children[i].style.display="block"}that.viewMerged=false}else{that.viewAllspan.textContent=NLS.viewAll;that.viewAllIcon.className="fonticon fonticon-expand-right";for(var i=1;i<that.mergedWrapper.children.length;i++){that.mergedWrapper.children[i].style.display="none"}that.viewMerged=true}}},updateActionedLabel:function(label,flag,actor_data){var actionsWrapper=this.container.getElement(".RTAlertActions");if(label&&label.toString().indexOf("NLS")!=-1){label=eval(label)}else{if(this.model.get("mergedCollection")){label=NLS.groupActionLabel}else{if(flag){var actor=" (by "+PlatformAPI.getUser().login+")";if(label){label=label+actor}}else{if(actor_data){label=label+" (by "+actor_data+")"}}}}if(actionsWrapper.children.length!=0){while(actionsWrapper.children.length!=0){actionsWrapper.removeChild(actionsWrapper.children[0])}}this.actionLabel=UWA.createElement("span",{"class":"item-text",styles:{color:"rgb(54, 142, 196)","font-weight":"bold",},text:label||NLS.actionLabel}).inject(actionsWrapper);actionsWrapper.style.display="block";actionsWrapper.style.marginLeft="48px";actionsWrapper.style.paddingLeft="5px";actionsWrapper.style.textAlign="initial"}});return iView});