define("DS/DMUBaseCommands/EXPCommand",["DS/ApplicationFrame/Command","DS/DMUBaseExperience/DMUContextManager"],function(f,d){var c,b,e;var a=f.extend({init:function(i,l,j){var h=(l)?l:"exclusive";var g=(j)?j:true;this._parent(i,{mode:h,isAsynchronous:g});var k=this;require(["DS/DMUBaseCommands/EXPToolsWUX","DS/DMUControls/EXPNotify","DS/DMUBaseExperience/EXPNls"],function(o,m,n){c=o;b=m;e=n});if(this.getFrameWindow&&this.getFrameWindow()){this._frmWindow=this.getFrameWindow();this._viewer=this._frmWindow.getViewer()}if(i.prereq){var k=this;require([i.prereq],function(m){k._prereq=m},function(){k._prereq=null})}},_performCallback:function(){return this._id+"has no treatment"},_delayedInitialization:function(){var g=d.getReviewContext({viewer:this.getFrameWindow().getViewer()});if(g){g.getUIManager().clearUI()}},beginExecute:function(){this._delayedInitialization()},execute:function(){if(this._prereq===null){this.sendNotify("warning",e.getNls("DMUBaseUI.CAT3DPlayProReview.notifynoavailability"))}else{this._delayedInitialization();this._performCallback()}this.end()},endExecute:function(){if(this._currentState){this.exitState(this._currentState)}},resumeExecute:function(){this._isRunning=true;this.execute()},addInCSO:function(g,h){c.addInCSO(g,h)},emptyCSO:function(){c.emptyCSO()},addInHSO:function(g,h){c.addInHSO(g,h)},emptyHSO:function(){c.emptyHSO()},sendNotify:function(g,h){return new b({body:this._frmWindow.getUIFrame(),type:g,messages:h})}});return a});define("DS/DMUBaseCommands/EXPToolsWUX",["DS/Selection/CSOManager","DS/Selection/HSOManager","DS/DMUMeasurable/DMUToolsSceneGraph"],function(a,c,d){var b={addInCSO:function(e,f){if(e){var g;if(e.path){g=e.path}else{if(e._nNode){g=d.buildPathElement(e._nNode)}}if(!f){a.empty()}a.add({pathElement:g})}},emptyCSO:function(){a.empty()},getCSO:function(){var g=a.get().slice();var h=[];var f=0;if(g){f=g.length;for(var e=0;e<f;e++){h.push(g[e].pathElement)}}return h},addInHSO:function(e,f){if(e){var g;if(e.path){g=e.path}else{if(e._nNode){g=d.buildPathElement(e._nNode)}}if(!f){c.empty()}c.add({pathElement:g})}},emptyHSO:function(){c.empty()}};return b});define("DS/DMUBaseCommands/EXPStateCommand",["DS/StateCommandEngine/StateCommand"],function(j){var a,g,h,c,i,b,e,d;var f=j.extend({init:function(k,n,l){this._parent(k,{mode:n,isAsynchronous:l});var m=this;require(["DS/DMUBaseCommands/EXPToolsWUX","DS/DMUControls/EXPNotify","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/EXPNls","DS/VisuEvents/EventsManager","DS/Gestures/ClickGesture","DS/VisuEvents/ScreenEvent"],function(v,r,q,p,w,o,u,s){a=v;g=r;h=q;c=p;i=w;b=o;e=u;d=s;if(m._frmWindow&&(m._frmWindow._bDMUClickEvent===undefined)){var t=new e(d.MouseButton.LEFT);b.addGestureRecognizer(t);m._frmWindow._bDMUClickEvent=true}});this._frmWindow=this.getFrameWindow();this._viewer=this._frmWindow.getViewer();this._evtTypes=[];if(k.prereq){var m=this;require([k.prereq],function(o){m._prereq=o},function(){m._prereq=null})}this._tokenRemove=null},beginExecute:function(){this._parent();var k=h.getContextViewer({viewer:this.getFrameWindow().getViewer()});if(k){var l=this;this._tokenRemove=k.subscribe({event:"onRootRemoved"},function(){l._onSessionReduced();l.end()})}},resumeExecute:function(){this._parent()},endExecute:function(){if(this._tokenRemove){var k=h.getContextViewer({viewer:this.getFrameWindow().getViewer()});if(k){this._tokenRemove=k.unsubscribe(this._tokenRemove)}this._tokenRemove=null}this._parent()},addEmptySelectionTransition:function(n,l,k){this._checkEmptySelection=function(q){var s=true;var p=q.from[0].event;if(p){this._object=c.getSelectedPathElement(this._viewer,p)}if(this._object){s=false}else{if(p.target.tagName!=="CANVAS"){s=false}else{if(p.path!==undefined){var r=p.path.length;for(var o=0;s&&(o<r);o++){if(p.path[o].id&&(p.path[o].id==="LevelSelector")){s=false}}}else{if((p.target!==undefined)&&(p.target.className!==undefined)){if(p.target.className==="levelSelector-canvas levelSelector-canvas-animation"){s=false}}}}}return s};var m={iEvent:"/VISU/onPrimaryPointerClick",iInitialState:n,iFinalState:l,iCondition:this._checkEmptySelection,iAction:k};this.addTransition(m)},computeEmptySelectionInformation:function(m){var k=[];var l=c.getPickingInfo(this._viewer,m.from[0].event);l.position=l.point;k.push(l);return k},_performExit:function(k){var l=i.getNls("DMUBaseUI.CAT3DPlayProReview.notifynoavailability");this.sendNotify("warning",l);k()},_onSessionReduced:function(){},addInCSO:function(k,l){a.addInCSO(k,l)},emptyCSO:function(){a.emptyCSO()},addInHSO:function(k,l){a.addInHSO(k,l)},emptyHSO:function(){a.emptyHSO()},dispatchEvent:function(l){if(l){for(var k=0;k<this._evtTypes.length;k++){if(this._evtTypes[k]===l){this._evtListeners[k]()}}}},addEventListener:function(m,n){if(m&&n){var l=false;for(var k=0;(!l)&&(k<this._evtTypes.length);k++){l=(this._evtTypes[k]===m)&&(this._evtListeners[k]===n)}if(!l){this._evtTypes.push(m);this._evtListeners.push(n)}}},removeEventListener:function(m,n){if(m&&n){var l=false;for(var k=0;(!l)&&(k<this._evtTypes.length);k++){if((this._evtTypes[k]===m)&&(this._evtListeners[k]===n)){l=true;this._evtTypes.splice(k,1);this._evtListeners.splice(k,1)}}}},sendNotify:function(k,l){return new g({body:this._frmWindow.getUIFrame(),type:k,messages:l,autoHide:false})},cleanNotify:function(k){if(k){k.destroy()}}});return f});define("DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation",["DS/DMUBaseCommands/EXPStateCommand","DS/DMUBaseExperience/EXPToolsVisualization","DS/StateCommandEngine/PathElementAgent","DS/VisuEvents/EventsManager","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/Visualization/ThreeJS_DS","i18n!DS/DMUBaseCommands/assets/nls/DMUBaseCommands"],function(h,b,g,f,a,d,c){var e=h.extend({init:function(k,j,i,l,m){this._parent(k,"exclusive",true);this._performOperation=j;this._sKeyHelpMessage=(i!==undefined)?i:c.defaultSelectLabel;this._agentOptions=(l!==undefined)?l:{};this._bAllowEmptySel=(m!==undefined)?m:false;this._dragEventCallback=this.options.dragEventCallback;this._selectedPathElement=null},beginExecute:function(){var j=this;this.tapCallback=function(n){j._clickEventData=n;var o=j._viewer.getMousePosition(n.from[0].getCurrentPosition(j._viewer.canvas));var m;var l=j._viewer.pick(o,"mesh",true);if(l!==undefined){if((l.position!==undefined)&&(l.position!==null)){m=l.position.clone();j._startpos=m;if(0===l.path.length){j._startpos=j._computePositionOnEmptySpace(n)}else{var k=l.path[0];if(k!==undefined){if(k.getLastElement().measurable){l=j._viewer.pick(o,"prim",true);if(l!==undefined){j._startpos=l.position.clone()}}}}}}};if(this._dragEventCallback){var i=null;this.dragCallback=function(m){if(m.from[0].view!==j.getFrameWindow().getViewer().canvas){return}if(m.from[0].event.type==="touchmove"&&!m.from[0].event.pageX&&!m.from[0].event.pageY){m.from[0].event.pageX=m.from[0].event.touches&&m.from[0].event.touches.length?m.from[0].event.touches[0].pageX:0;m.from[0].event.pageY=m.from[0].event.touches&&m.from[0].event.touches.length?m.from[0].event.touches[0].pageY:0}var p=b.getPickingInfo(j._viewer,m.from[0].event);if(m.state==="begin"){j.dragEnabled=true;if(j._startpos!==undefined){i=j._startpos}else{i=p.point}}var q=m.state==="end";var o=b.getLineFromWindowPosition(j._viewer,m.from[0].currentPosition.x,m.from[0].currentPosition.y);var k=b.getViewpointInfo(j._viewer.currentViewpoint);var l=a.computeLinePlaneDistance(o.position.toArray(),o.direction.toArray(),i.toArray(),k.sight.toArray());var n=new d.Vector3(l.aPosition[0],l.aPosition[1],l.aPosition[2]);if(j._clickEventData){j._selectedPathElement=j._viewer.pick(j._viewer.getMousePosition(m.from[0].getCurrentPosition(j._viewer.canvas)),"mesh",false).path[0]}else{j._selectedPathElement=j._viewer.pick(b.getMousePosition(j._viewer,m.from[0].event),"mesh",false).path[0]}j._dragEventCallback({iEventData:m,vStartPosition:i,vCurrentPosition:n,bLastUpdate:q});if(q){j.publish({event:"dragEnd"})}};if(!this._viewer.get2DMode()){this._touchRotationActiveFlag=this._viewer.currentViewpoint.control.getTouchRotationActive();if(this._touchRotationActiveFlag){this._viewer.currentViewpoint.control.setTouchRotationActive(false)}}this._savedTrapSelectionFlag=this._viewer.picking.trapSelection;if(this._savedTrapSelectionFlag){this._viewer.setPicking({trapSelection:false})}f.addEvent(this._viewer.canvas,"onDrag",this.dragCallback);f.addEvent(this._viewer.canvas,"onPrimaryPointerDownUnique",this.tapCallback)}this._agentOptions.agentId="_pathElementAgent";this._agentOptions.frameWindow=this._frmWindow;this._pathElementAgent=new g(this._agentOptions);this._frmWindow.getViewerFrame().setStyle("cursor","crosshair");this._parent();this._notify=this.sendNotify("info",this._sKeyHelpMessage)},endExecute:function(){this._parent();if(this._dragEventCallback){if(!this._viewer.get2DMode()&&this._touchRotationActiveFlag){this._viewer.currentViewpoint.control.setTouchRotationActive(true)}if(this._savedTrapSelectionFlag){this._viewer.setPicking({trapSelection:true})}f.removeEvent(this._viewer.canvas,"onDrag",this.dragCallback);f.removeEvent(this._viewer.canvas,"onPrimaryPointerDownUnique",this.tapCallback)}this._pathElementAgent=null;this.dragEnabled=null;this._frmWindow.getViewerFrame().setStyle("cursor","auto");this.cleanNotify(this._notify);this._notify=null},buildGraph:function(){var i=this.createInitialState("initialState");var m=this.getFinalState();var l={iEvent:this._pathElementAgent,iInitialState:i,iFinalState:m,iCondition:function(){return !this.dragEnabled},iAction:this._performSelectionCallback};this.addTransition(l);if(this._bAllowEmptySel){this.addEmptySelectionTransition(i,m,this._performEmptySelectionCallback)}var k={iSender:this,iEvent:"dragEnd",iInitialState:i,iFinalState:m,iCondition:null};this.addTransition(k);if(this._prereq===null){var j={iSender:this,iEvent:"Exit",iInitialState:i,iFinalState:m,iCondition:null,iAction:this._performExit};this.addTransition(j);var n=this;setTimeout(function(){n.publish({event:"Exit"})},0)}},_performSelectionCallback:function(j,i){if(this._startpos!==undefined){i[0].position=this._startpos}this._performOperation(i);j()},_performEmptySelectionCallback:function(j,i){var k=this.computeEmptySelectionInformation(i);k[0].position=this._computePositionOnEmptySpace(i);this._performOperation(k);j()},_computePositionOnEmptySpace:function(m){var j=new d.Vector3(10,10,10);var n=b.getLineFromWindowPosition(this._viewer,m.from[0].currentPosition.x,m.from[0].currentPosition.y);var i=b.getViewpointInfo(this._viewer.currentViewpoint);var l=a.computeLinePlaneDistance(n.position.toArray(),n.direction.toArray(),j.toArray(),i.sight.toArray());var k=new d.Vector3(l.aPosition[0],l.aPosition[1],l.aPosition[2]);return k}});return e});